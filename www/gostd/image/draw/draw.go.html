<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5564901">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5564957">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5565011">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5565062">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5565116">//</span><br>
<span class="lineno"></span><span class="comment" id="5565119">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5565191">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5565241">package</span>&nbsp;<span class="ident" id="5565249">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5565255">import</span>&nbsp;<span class="op" id="5565262">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5565265">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5565274">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5565288">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5565291">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5565353">const</span>&nbsp;<span class="ident" id="5565359">m</span>&nbsp;<span class="op" id="5565361">=</span>&nbsp;<span class="num" id="5565363">1</span><span class="op" id="5565364">&lt;&lt;</span><span class="num" id="5565366">16</span>&nbsp;<span class="op" id="5565369">-</span>&nbsp;<span class="num" id="5565371">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565374">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5565445">type</span>&nbsp;<span class="ident" id="5565450">Image</span>&nbsp;<span class="keyword" id="5565456">interface</span>&nbsp;<span class="op" id="5565466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565469">image</span><span class="op" id="5565474">.</span><span class="ident" id="5565475">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565482">Set</span><span class="op" id="5565485">(</span><span class="ident" id="5565486">x</span><span class="op" id="5565487">,</span>&nbsp;<span class="ident" id="5565489">y</span>&nbsp;<span class="builtintype" id="5565491">int</span><span class="op" id="5565494">,</span>&nbsp;<span class="ident" id="5565496">c</span>&nbsp;<span class="ident" id="5565498">color</span><span class="op" id="5565503">.</span><span class="ident" id="5565504">Color</span><span class="op" id="5565509">)</span><br>
<span class="lineno"></span><span class="op" id="5565511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5565514">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5565560">type</span>&nbsp;<span class="ident" id="5565565">Quantizer</span>&nbsp;<span class="keyword" id="5565575">interface</span>&nbsp;<span class="op" id="5565585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565588">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565659">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565726">Quantize</span><span class="op" id="5565734">(</span><span class="ident" id="5565735">p</span>&nbsp;<span class="ident" id="5565737">color</span><span class="op" id="5565742">.</span><span class="ident" id="5565743">Palette</span><span class="op" id="5565750">,</span>&nbsp;<span class="ident" id="5565752">m</span>&nbsp;<span class="ident" id="5565754">image</span><span class="op" id="5565759">.</span><span class="ident" id="5565760">Image</span><span class="op" id="5565765">)</span>&nbsp;<span class="ident" id="5565767">color</span><span class="op" id="5565772">.</span><span class="ident" id="5565773">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5565781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565784">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5565829">type</span>&nbsp;<span class="ident" id="5565834">Op</span>&nbsp;<span class="builtintype" id="5565837">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5565842">const</span>&nbsp;<span class="op" id="5565848">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565851">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565898">Over</span>&nbsp;<span class="ident" id="5565903">Op</span>&nbsp;<span class="op" id="5565906">=</span>&nbsp;<span class="ident" id="5565908">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5565914">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565949">Src</span><br>
<span class="lineno">40</span><span class="op" id="5565953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565956">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5566035">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5566042">func</span>&nbsp;<span class="op" id="5566047">(</span><span class="ident" id="5566048">op</span>&nbsp;<span class="ident" id="5566051">Op</span><span class="op" id="5566053">)</span>&nbsp;<span class="ident" id="5566055">Draw</span><span class="op" id="5566059">(</span><span class="ident" id="5566060">dst</span>&nbsp;<span class="ident" id="5566064">Image</span><span class="op" id="5566069">,</span>&nbsp;<span class="ident" id="5566071">r</span>&nbsp;<span class="ident" id="5566073">image</span><span class="op" id="5566078">.</span><span class="ident" id="5566079">Rectangle</span><span class="op" id="5566088">,</span>&nbsp;<span class="ident" id="5566090">src</span>&nbsp;<span class="ident" id="5566094">image</span><span class="op" id="5566099">.</span><span class="ident" id="5566100">Image</span><span class="op" id="5566105">,</span>&nbsp;<span class="ident" id="5566107">sp</span>&nbsp;<span class="ident" id="5566110">image</span><span class="op" id="5566115">.</span><span class="ident" id="5566116">Point</span><span class="op" id="5566121">)</span>&nbsp;<span class="op" id="5566123">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566126">DrawMask</span><span class="op" id="5566134">(</span><span class="ident" id="5566135">dst</span><span class="op" id="5566138">,</span>&nbsp;<span class="ident" id="5566140">r</span><span class="op" id="5566141">,</span>&nbsp;<span class="ident" id="5566143">src</span><span class="op" id="5566146">,</span>&nbsp;<span class="ident" id="5566148">sp</span><span class="op" id="5566150">,</span>&nbsp;<span class="ident" id="5566152">nil</span><span class="op" id="5566155">,</span>&nbsp;<span class="ident" id="5566157">image</span><span class="op" id="5566162">.</span><span class="ident" id="5566163">Point</span><span class="op" id="5566168">{</span><span class="op" id="5566169">}</span><span class="op" id="5566170">,</span>&nbsp;<span class="ident" id="5566172">op</span><span class="op" id="5566174">)</span><br>
<span class="lineno"></span><span class="op" id="5566176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5566179">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5566215">type</span>&nbsp;<span class="ident" id="5566220">Drawer</span>&nbsp;<span class="keyword" id="5566227">interface</span>&nbsp;<span class="op" id="5566237">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566240">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5566306">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566368">Draw</span><span class="op" id="5566372">(</span><span class="ident" id="5566373">dst</span>&nbsp;<span class="ident" id="5566377">Image</span><span class="op" id="5566382">,</span>&nbsp;<span class="ident" id="5566384">r</span>&nbsp;<span class="ident" id="5566386">image</span><span class="op" id="5566391">.</span><span class="ident" id="5566392">Rectangle</span><span class="op" id="5566401">,</span>&nbsp;<span class="ident" id="5566403">src</span>&nbsp;<span class="ident" id="5566407">image</span><span class="op" id="5566412">.</span><span class="ident" id="5566413">Image</span><span class="op" id="5566418">,</span>&nbsp;<span class="ident" id="5566420">sp</span>&nbsp;<span class="ident" id="5566423">image</span><span class="op" id="5566428">.</span><span class="ident" id="5566429">Point</span><span class="op" id="5566434">)</span><br>
<span class="lineno"></span><span class="op" id="5566436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5566439">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5566515">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5566529">var</span>&nbsp;<span class="ident" id="5566533">FloydSteinberg</span>&nbsp;<span class="ident" id="5566548">Drawer</span>&nbsp;<span class="op" id="5566555">=</span>&nbsp;<span class="ident" id="5566557">floydSteinberg</span><span class="op" id="5566571">{</span><span class="op" id="5566572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5566575">type</span>&nbsp;<span class="ident" id="5566580">floydSteinberg</span>&nbsp;<span class="keyword" id="5566595">struct</span><span class="op" id="5566601">{</span><span class="op" id="5566602">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5566605">func</span>&nbsp;<span class="op" id="5566610">(</span><span class="ident" id="5566611">floydSteinberg</span><span class="op" id="5566625">)</span>&nbsp;<span class="ident" id="5566627">Draw</span><span class="op" id="5566631">(</span><span class="ident" id="5566632">dst</span>&nbsp;<span class="ident" id="5566636">Image</span><span class="op" id="5566641">,</span>&nbsp;<span class="ident" id="5566643">r</span>&nbsp;<span class="ident" id="5566645">image</span><span class="op" id="5566650">.</span><span class="ident" id="5566651">Rectangle</span><span class="op" id="5566660">,</span>&nbsp;<span class="ident" id="5566662">src</span>&nbsp;<span class="ident" id="5566666">image</span><span class="op" id="5566671">.</span><span class="ident" id="5566672">Image</span><span class="op" id="5566677">,</span>&nbsp;<span class="ident" id="5566679">sp</span>&nbsp;<span class="ident" id="5566682">image</span><span class="op" id="5566687">.</span><span class="ident" id="5566688">Point</span><span class="op" id="5566693">)</span>&nbsp;<span class="op" id="5566695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566698">clip</span><span class="op" id="5566702">(</span><span class="ident" id="5566703">dst</span><span class="op" id="5566706">,</span>&nbsp;<span class="op" id="5566708">&amp;</span><span class="ident" id="5566709">r</span><span class="op" id="5566710">,</span>&nbsp;<span class="ident" id="5566712">src</span><span class="op" id="5566715">,</span>&nbsp;<span class="op" id="5566717">&amp;</span><span class="ident" id="5566718">sp</span><span class="op" id="5566720">,</span>&nbsp;<span class="ident" id="5566722">nil</span><span class="op" id="5566725">,</span>&nbsp;<span class="ident" id="5566727">nil</span><span class="op" id="5566730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566733">if</span>&nbsp;<span class="ident" id="5566736">r</span><span class="op" id="5566737">.</span><span class="ident" id="5566738">Empty</span><span class="op" id="5566743">(</span><span class="op" id="5566744">)</span>&nbsp;<span class="op" id="5566746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566750">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5566758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566761">drawPaletted</span><span class="op" id="5566773">(</span><span class="ident" id="5566774">dst</span><span class="op" id="5566777">,</span>&nbsp;<span class="ident" id="5566779">r</span><span class="op" id="5566780">,</span>&nbsp;<span class="ident" id="5566782">src</span><span class="op" id="5566785">,</span>&nbsp;<span class="ident" id="5566787">sp</span><span class="op" id="5566789">,</span>&nbsp;<span class="builtintype" id="5566791">true</span><span class="op" id="5566795">)</span><br>
<span class="lineno"></span><span class="op" id="5566797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5566800">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5566872">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5566949">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5566992">func</span>&nbsp;<span class="ident" id="5566997">clip</span><span class="op" id="5567001">(</span><span class="ident" id="5567002">dst</span>&nbsp;<span class="ident" id="5567006">Image</span><span class="op" id="5567011">,</span>&nbsp;<span class="ident" id="5567013">r</span>&nbsp;<span class="op" id="5567015">*</span><span class="ident" id="5567016">image</span><span class="op" id="5567021">.</span><span class="ident" id="5567022">Rectangle</span><span class="op" id="5567031">,</span>&nbsp;<span class="ident" id="5567033">src</span>&nbsp;<span class="ident" id="5567037">image</span><span class="op" id="5567042">.</span><span class="ident" id="5567043">Image</span><span class="op" id="5567048">,</span>&nbsp;<span class="ident" id="5567050">sp</span>&nbsp;<span class="op" id="5567053">*</span><span class="ident" id="5567054">image</span><span class="op" id="5567059">.</span><span class="ident" id="5567060">Point</span><span class="op" id="5567065">,</span>&nbsp;<span class="ident" id="5567067">mask</span>&nbsp;<span class="ident" id="5567072">image</span><span class="op" id="5567077">.</span><span class="ident" id="5567078">Image</span><span class="op" id="5567083">,</span>&nbsp;<span class="ident" id="5567085">mp</span>&nbsp;<span class="op" id="5567088">*</span><span class="ident" id="5567089">image</span><span class="op" id="5567094">.</span><span class="ident" id="5567095">Point</span><span class="op" id="5567100">)</span>&nbsp;<span class="op" id="5567102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5567105">orig</span>&nbsp;<span class="op" id="5567110">:=</span>&nbsp;<span class="ident" id="5567113">r</span><span class="op" id="5567114">.</span><span class="ident" id="5567115">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567120">*</span><span class="ident" id="5567121">r</span>&nbsp;<span class="op" id="5567123">=</span>&nbsp;<span class="ident" id="5567125">r</span><span class="op" id="5567126">.</span><span class="ident" id="5567127">Intersect</span><span class="op" id="5567136">(</span><span class="ident" id="5567137">dst</span><span class="op" id="5567140">.</span><span class="ident" id="5567141">Bounds</span><span class="op" id="5567147">(</span><span class="op" id="5567148">)</span><span class="op" id="5567149">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567152">*</span><span class="ident" id="5567153">r</span>&nbsp;<span class="op" id="5567155">=</span>&nbsp;<span class="ident" id="5567157">r</span><span class="op" id="5567158">.</span><span class="ident" id="5567159">Intersect</span><span class="op" id="5567168">(</span><span class="ident" id="5567169">src</span><span class="op" id="5567172">.</span><span class="ident" id="5567173">Bounds</span><span class="op" id="5567179">(</span><span class="op" id="5567180">)</span><span class="op" id="5567181">.</span><span class="ident" id="5567182">Add</span><span class="op" id="5567185">(</span><span class="ident" id="5567186">orig</span><span class="op" id="5567190">.</span><span class="ident" id="5567191">Sub</span><span class="op" id="5567194">(</span><span class="op" id="5567195">*</span><span class="ident" id="5567196">sp</span><span class="op" id="5567198">)</span><span class="op" id="5567199">)</span><span class="op" id="5567200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5567203">if</span>&nbsp;<span class="ident" id="5567206">mask</span>&nbsp;<span class="op" id="5567211">!=</span>&nbsp;<span class="ident" id="5567214">nil</span>&nbsp;<span class="op" id="5567218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567222">*</span><span class="ident" id="5567223">r</span>&nbsp;<span class="op" id="5567225">=</span>&nbsp;<span class="ident" id="5567227">r</span><span class="op" id="5567228">.</span><span class="ident" id="5567229">Intersect</span><span class="op" id="5567238">(</span><span class="ident" id="5567239">mask</span><span class="op" id="5567243">.</span><span class="ident" id="5567244">Bounds</span><span class="op" id="5567250">(</span><span class="op" id="5567251">)</span><span class="op" id="5567252">.</span><span class="ident" id="5567253">Add</span><span class="op" id="5567256">(</span><span class="ident" id="5567257">orig</span><span class="op" id="5567261">.</span><span class="ident" id="5567262">Sub</span><span class="op" id="5567265">(</span><span class="op" id="5567266">*</span><span class="ident" id="5567267">mp</span><span class="op" id="5567269">)</span><span class="op" id="5567270">)</span><span class="op" id="5567271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5567277">dx</span>&nbsp;<span class="op" id="5567280">:=</span>&nbsp;<span class="ident" id="5567283">r</span><span class="op" id="5567284">.</span><span class="ident" id="5567285">Min</span><span class="op" id="5567288">.</span><span class="ident" id="5567289">X</span>&nbsp;<span class="op" id="5567291">-</span>&nbsp;<span class="ident" id="5567293">orig</span><span class="op" id="5567297">.</span><span class="ident" id="5567298">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5567301">dy</span>&nbsp;<span class="op" id="5567304">:=</span>&nbsp;<span class="ident" id="5567307">r</span><span class="op" id="5567308">.</span><span class="ident" id="5567309">Min</span><span class="op" id="5567312">.</span><span class="ident" id="5567313">Y</span>&nbsp;<span class="op" id="5567315">-</span>&nbsp;<span class="ident" id="5567317">orig</span><span class="op" id="5567321">.</span><span class="ident" id="5567322">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5567325">if</span>&nbsp;<span class="ident" id="5567328">dx</span>&nbsp;<span class="op" id="5567331">==</span>&nbsp;<span class="num" id="5567334">0</span>&nbsp;<span class="op" id="5567336">&amp;&amp;</span>&nbsp;<span class="ident" id="5567339">dy</span>&nbsp;<span class="op" id="5567342">==</span>&nbsp;<span class="num" id="5567345">0</span>&nbsp;<span class="op" id="5567347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5567351">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567362">(</span><span class="op" id="5567363">*</span><span class="ident" id="5567364">sp</span><span class="op" id="5567366">)</span><span class="op" id="5567367">.</span><span class="ident" id="5567368">X</span>&nbsp;<span class="op" id="5567370">+=</span>&nbsp;<span class="ident" id="5567373">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567377">(</span><span class="op" id="5567378">*</span><span class="ident" id="5567379">sp</span><span class="op" id="5567381">)</span><span class="op" id="5567382">.</span><span class="ident" id="5567383">Y</span>&nbsp;<span class="op" id="5567385">+=</span>&nbsp;<span class="ident" id="5567388">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567392">(</span><span class="op" id="5567393">*</span><span class="ident" id="5567394">mp</span><span class="op" id="5567396">)</span><span class="op" id="5567397">.</span><span class="ident" id="5567398">X</span>&nbsp;<span class="op" id="5567400">+=</span>&nbsp;<span class="ident" id="5567403">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567407">(</span><span class="op" id="5567408">*</span><span class="ident" id="5567409">mp</span><span class="op" id="5567411">)</span><span class="op" id="5567412">.</span><span class="ident" id="5567413">Y</span>&nbsp;<span class="op" id="5567415">+=</span>&nbsp;<span class="ident" id="5567418">dy</span><br>
<span class="lineno"></span><span class="op" id="5567421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5567424">func</span>&nbsp;<span class="ident" id="5567429">processBackward</span><span class="op" id="5567444">(</span><span class="ident" id="5567445">dst</span>&nbsp;<span class="ident" id="5567449">Image</span><span class="op" id="5567454">,</span>&nbsp;<span class="ident" id="5567456">r</span>&nbsp;<span class="ident" id="5567458">image</span><span class="op" id="5567463">.</span><span class="ident" id="5567464">Rectangle</span><span class="op" id="5567473">,</span>&nbsp;<span class="ident" id="5567475">src</span>&nbsp;<span class="ident" id="5567479">image</span><span class="op" id="5567484">.</span><span class="ident" id="5567485">Image</span><span class="op" id="5567490">,</span>&nbsp;<span class="ident" id="5567492">sp</span>&nbsp;<span class="ident" id="5567495">image</span><span class="op" id="5567500">.</span><span class="ident" id="5567501">Point</span><span class="op" id="5567506">)</span>&nbsp;<span class="builtintype" id="5567508">bool</span>&nbsp;<span class="op" id="5567513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5567516">return</span>&nbsp;<span class="ident" id="5567523">image</span><span class="op" id="5567528">.</span><span class="ident" id="5567529">Image</span><span class="op" id="5567534">(</span><span class="ident" id="5567535">dst</span><span class="op" id="5567538">)</span>&nbsp;<span class="op" id="5567540">==</span>&nbsp;<span class="ident" id="5567543">src</span>&nbsp;<span class="op" id="5567547">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5567552">r</span><span class="op" id="5567553">.</span><span class="ident" id="5567554">Overlaps</span><span class="op" id="5567562">(</span><span class="ident" id="5567563">r</span><span class="op" id="5567564">.</span><span class="ident" id="5567565">Add</span><span class="op" id="5567568">(</span><span class="ident" id="5567569">sp</span><span class="op" id="5567571">.</span><span class="ident" id="5567572">Sub</span><span class="op" id="5567575">(</span><span class="ident" id="5567576">r</span><span class="op" id="5567577">.</span><span class="ident" id="5567578">Min</span><span class="op" id="5567581">)</span><span class="op" id="5567582">)</span><span class="op" id="5567583">)</span>&nbsp;<span class="op" id="5567585">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5567590">(</span><span class="ident" id="5567591">sp</span><span class="op" id="5567593">.</span><span class="ident" id="5567594">Y</span>&nbsp;<span class="op" id="5567596">&lt;</span>&nbsp;<span class="ident" id="5567598">r</span><span class="op" id="5567599">.</span><span class="ident" id="5567600">Min</span><span class="op" id="5567603">.</span><span class="ident" id="5567604">Y</span>&nbsp;<span class="op" id="5567606">||</span>&nbsp;<span class="op" id="5567609">(</span><span class="ident" id="5567610">sp</span><span class="op" id="5567612">.</span><span class="ident" id="5567613">Y</span>&nbsp;<span class="op" id="5567615">==</span>&nbsp;<span class="ident" id="5567618">r</span><span class="op" id="5567619">.</span><span class="ident" id="5567620">Min</span><span class="op" id="5567623">.</span><span class="ident" id="5567624">Y</span>&nbsp;<span class="op" id="5567626">&amp;&amp;</span>&nbsp;<span class="ident" id="5567629">sp</span><span class="op" id="5567631">.</span><span class="ident" id="5567632">X</span>&nbsp;<span class="op" id="5567634">&lt;</span>&nbsp;<span class="ident" id="5567636">r</span><span class="op" id="5567637">.</span><span class="ident" id="5567638">Min</span><span class="op" id="5567641">.</span><span class="ident" id="5567642">X</span><span class="op" id="5567643">)</span><span class="op" id="5567644">)</span><br>
<span class="lineno"></span><span class="op" id="5567646">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5567649">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5567689">func</span>&nbsp;<span class="ident" id="5567694">Draw</span><span class="op" id="5567698">(</span><span class="ident" id="5567699">dst</span>&nbsp;<span class="ident" id="5567703">Image</span><span class="op" id="5567708">,</span>&nbsp;<span class="ident" id="5567710">r</span>&nbsp;<span class="ident" id="5567712">image</span><span class="op" id="5567717">.</span><span class="ident" id="5567718">Rectangle</span><span class="op" id="5567727">,</span>&nbsp;<span class="ident" id="5567729">src</span>&nbsp;<span class="ident" id="5567733">image</span><span class="op" id="5567738">.</span><span class="ident" id="5567739">Image</span><span class="op" id="5567744">,</span>&nbsp;<span class="ident" id="5567746">sp</span>&nbsp;<span class="ident" id="5567749">image</span><span class="op" id="5567754">.</span><span class="ident" id="5567755">Point</span><span class="op" id="5567760">,</span>&nbsp;<span class="ident" id="5567762">op</span>&nbsp;<span class="ident" id="5567765">Op</span><span class="op" id="5567767">)</span>&nbsp;<span class="op" id="5567769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5567772">DrawMask</span><span class="op" id="5567780">(</span><span class="ident" id="5567781">dst</span><span class="op" id="5567784">,</span>&nbsp;<span class="ident" id="5567786">r</span><span class="op" id="5567787">,</span>&nbsp;<span class="ident" id="5567789">src</span><span class="op" id="5567792">,</span>&nbsp;<span class="ident" id="5567794">sp</span><span class="op" id="5567796">,</span>&nbsp;<span class="ident" id="5567798">nil</span><span class="op" id="5567801">,</span>&nbsp;<span class="ident" id="5567803">image</span><span class="op" id="5567808">.</span><span class="ident" id="5567809">Point</span><span class="op" id="5567814">{</span><span class="op" id="5567815">}</span><span class="op" id="5567816">,</span>&nbsp;<span class="ident" id="5567818">op</span><span class="op" id="5567820">)</span><br>
<span class="lineno"></span><span class="op" id="5567822">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5567825">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5567921">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5568010">func</span>&nbsp;<span class="ident" id="5568015">DrawMask</span><span class="op" id="5568023">(</span><span class="ident" id="5568024">dst</span>&nbsp;<span class="ident" id="5568028">Image</span><span class="op" id="5568033">,</span>&nbsp;<span class="ident" id="5568035">r</span>&nbsp;<span class="ident" id="5568037">image</span><span class="op" id="5568042">.</span><span class="ident" id="5568043">Rectangle</span><span class="op" id="5568052">,</span>&nbsp;<span class="ident" id="5568054">src</span>&nbsp;<span class="ident" id="5568058">image</span><span class="op" id="5568063">.</span><span class="ident" id="5568064">Image</span><span class="op" id="5568069">,</span>&nbsp;<span class="ident" id="5568071">sp</span>&nbsp;<span class="ident" id="5568074">image</span><span class="op" id="5568079">.</span><span class="ident" id="5568080">Point</span><span class="op" id="5568085">,</span>&nbsp;<span class="ident" id="5568087">mask</span>&nbsp;<span class="ident" id="5568092">image</span><span class="op" id="5568097">.</span><span class="ident" id="5568098">Image</span><span class="op" id="5568103">,</span>&nbsp;<span class="ident" id="5568105">mp</span>&nbsp;<span class="ident" id="5568108">image</span><span class="op" id="5568113">.</span><span class="ident" id="5568114">Point</span><span class="op" id="5568119">,</span>&nbsp;<span class="ident" id="5568121">op</span>&nbsp;<span class="ident" id="5568124">Op</span><span class="op" id="5568126">)</span>&nbsp;<span class="op" id="5568128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568131">clip</span><span class="op" id="5568135">(</span><span class="ident" id="5568136">dst</span><span class="op" id="5568139">,</span>&nbsp;<span class="op" id="5568141">&amp;</span><span class="ident" id="5568142">r</span><span class="op" id="5568143">,</span>&nbsp;<span class="ident" id="5568145">src</span><span class="op" id="5568148">,</span>&nbsp;<span class="op" id="5568150">&amp;</span><span class="ident" id="5568151">sp</span><span class="op" id="5568153">,</span>&nbsp;<span class="ident" id="5568155">mask</span><span class="op" id="5568159">,</span>&nbsp;<span class="op" id="5568161">&amp;</span><span class="ident" id="5568162">mp</span><span class="op" id="5568164">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568167">if</span>&nbsp;<span class="ident" id="5568170">r</span><span class="op" id="5568171">.</span><span class="ident" id="5568172">Empty</span><span class="op" id="5568177">(</span><span class="op" id="5568178">)</span>&nbsp;<span class="op" id="5568180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568184">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5568196">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568309">switch</span>&nbsp;<span class="ident" id="5568316">dst0</span>&nbsp;<span class="op" id="5568321">:=</span>&nbsp;<span class="ident" id="5568324">dst</span><span class="op" id="5568327">.</span><span class="op" id="5568328">(</span><span class="keyword" id="5568329">type</span><span class="op" id="5568333">)</span>&nbsp;<span class="op" id="5568335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568338">case</span>&nbsp;<span class="op" id="5568343">*</span><span class="ident" id="5568344">image</span><span class="op" id="5568349">.</span><span class="ident" id="5568350">RGBA</span><span class="op" id="5568354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568358">if</span>&nbsp;<span class="ident" id="5568361">op</span>&nbsp;<span class="op" id="5568364">==</span>&nbsp;<span class="ident" id="5568367">Over</span>&nbsp;<span class="op" id="5568372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568377">if</span>&nbsp;<span class="ident" id="5568380">mask</span>&nbsp;<span class="op" id="5568385">==</span>&nbsp;<span class="ident" id="5568388">nil</span>&nbsp;<span class="op" id="5568392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568398">switch</span>&nbsp;<span class="ident" id="5568405">src0</span>&nbsp;<span class="op" id="5568410">:=</span>&nbsp;<span class="ident" id="5568413">src</span><span class="op" id="5568416">.</span><span class="op" id="5568417">(</span><span class="keyword" id="5568418">type</span><span class="op" id="5568422">)</span>&nbsp;<span class="op" id="5568424">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568430">case</span>&nbsp;<span class="op" id="5568435">*</span><span class="ident" id="5568436">image</span><span class="op" id="5568441">.</span><span class="ident" id="5568442">Uniform</span><span class="op" id="5568449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568456">drawFillOver</span><span class="op" id="5568468">(</span><span class="ident" id="5568469">dst0</span><span class="op" id="5568473">,</span>&nbsp;<span class="ident" id="5568475">r</span><span class="op" id="5568476">,</span>&nbsp;<span class="ident" id="5568478">src0</span><span class="op" id="5568482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568489">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568500">case</span>&nbsp;<span class="op" id="5568505">*</span><span class="ident" id="5568506">image</span><span class="op" id="5568511">.</span><span class="ident" id="5568512">RGBA</span><span class="op" id="5568516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568523">drawCopyOver</span><span class="op" id="5568535">(</span><span class="ident" id="5568536">dst0</span><span class="op" id="5568540">,</span>&nbsp;<span class="ident" id="5568542">r</span><span class="op" id="5568543">,</span>&nbsp;<span class="ident" id="5568545">src0</span><span class="op" id="5568549">,</span>&nbsp;<span class="ident" id="5568551">sp</span><span class="op" id="5568553">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568560">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568571">case</span>&nbsp;<span class="op" id="5568576">*</span><span class="ident" id="5568577">image</span><span class="op" id="5568582">.</span><span class="ident" id="5568583">NRGBA</span><span class="op" id="5568588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568595">drawNRGBAOver</span><span class="op" id="5568608">(</span><span class="ident" id="5568609">dst0</span><span class="op" id="5568613">,</span>&nbsp;<span class="ident" id="5568615">r</span><span class="op" id="5568616">,</span>&nbsp;<span class="ident" id="5568618">src0</span><span class="op" id="5568622">,</span>&nbsp;<span class="ident" id="5568624">sp</span><span class="op" id="5568626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568633">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568644">case</span>&nbsp;<span class="op" id="5568649">*</span><span class="ident" id="5568650">image</span><span class="op" id="5568655">.</span><span class="ident" id="5568656">YCbCr</span><span class="op" id="5568661">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568668">if</span>&nbsp;<span class="ident" id="5568671">drawYCbCr</span><span class="op" id="5568680">(</span><span class="ident" id="5568681">dst0</span><span class="op" id="5568685">,</span>&nbsp;<span class="ident" id="5568687">r</span><span class="op" id="5568688">,</span>&nbsp;<span class="ident" id="5568690">src0</span><span class="op" id="5568694">,</span>&nbsp;<span class="ident" id="5568696">sp</span><span class="op" id="5568698">)</span>&nbsp;<span class="op" id="5568700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568731">}</span>&nbsp;<span class="keyword" id="5568733">else</span>&nbsp;<span class="keyword" id="5568738">if</span>&nbsp;<span class="ident" id="5568741">mask0</span><span class="op" id="5568746">,</span>&nbsp;<span class="ident" id="5568748">ok</span>&nbsp;<span class="op" id="5568751">:=</span>&nbsp;<span class="ident" id="5568754">mask</span><span class="op" id="5568758">.</span><span class="op" id="5568759">(</span><span class="op" id="5568760">*</span><span class="ident" id="5568761">image</span><span class="op" id="5568766">.</span><span class="ident" id="5568767">Alpha</span><span class="op" id="5568772">)</span><span class="op" id="5568773">;</span>&nbsp;<span class="ident" id="5568775">ok</span>&nbsp;<span class="op" id="5568778">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568784">switch</span>&nbsp;<span class="ident" id="5568791">src0</span>&nbsp;<span class="op" id="5568796">:=</span>&nbsp;<span class="ident" id="5568799">src</span><span class="op" id="5568802">.</span><span class="op" id="5568803">(</span><span class="keyword" id="5568804">type</span><span class="op" id="5568808">)</span>&nbsp;<span class="op" id="5568810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568816">case</span>&nbsp;<span class="op" id="5568821">*</span><span class="ident" id="5568822">image</span><span class="op" id="5568827">.</span><span class="ident" id="5568828">Uniform</span><span class="op" id="5568835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568842">drawGlyphOver</span><span class="op" id="5568855">(</span><span class="ident" id="5568856">dst0</span><span class="op" id="5568860">,</span>&nbsp;<span class="ident" id="5568862">r</span><span class="op" id="5568863">,</span>&nbsp;<span class="ident" id="5568865">src0</span><span class="op" id="5568869">,</span>&nbsp;<span class="ident" id="5568871">mask0</span><span class="op" id="5568876">,</span>&nbsp;<span class="ident" id="5568878">mp</span><span class="op" id="5568880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568887">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568898">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5568907">}</span>&nbsp;<span class="keyword" id="5568909">else</span>&nbsp;<span class="op" id="5568914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568919">if</span>&nbsp;<span class="ident" id="5568922">mask</span>&nbsp;<span class="op" id="5568927">==</span>&nbsp;<span class="ident" id="5568930">nil</span>&nbsp;<span class="op" id="5568934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568940">switch</span>&nbsp;<span class="ident" id="5568947">src0</span>&nbsp;<span class="op" id="5568952">:=</span>&nbsp;<span class="ident" id="5568955">src</span><span class="op" id="5568958">.</span><span class="op" id="5568959">(</span><span class="keyword" id="5568960">type</span><span class="op" id="5568964">)</span>&nbsp;<span class="op" id="5568966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5568972">case</span>&nbsp;<span class="op" id="5568977">*</span><span class="ident" id="5568978">image</span><span class="op" id="5568983">.</span><span class="ident" id="5568984">Uniform</span><span class="op" id="5568991">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5568998">drawFillSrc</span><span class="op" id="5569009">(</span><span class="ident" id="5569010">dst0</span><span class="op" id="5569014">,</span>&nbsp;<span class="ident" id="5569016">r</span><span class="op" id="5569017">,</span>&nbsp;<span class="ident" id="5569019">src0</span><span class="op" id="5569023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569030">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569041">case</span>&nbsp;<span class="op" id="5569046">*</span><span class="ident" id="5569047">image</span><span class="op" id="5569052">.</span><span class="ident" id="5569053">RGBA</span><span class="op" id="5569057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569064">drawCopySrc</span><span class="op" id="5569075">(</span><span class="ident" id="5569076">dst0</span><span class="op" id="5569080">,</span>&nbsp;<span class="ident" id="5569082">r</span><span class="op" id="5569083">,</span>&nbsp;<span class="ident" id="5569085">src0</span><span class="op" id="5569089">,</span>&nbsp;<span class="ident" id="5569091">sp</span><span class="op" id="5569093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569100">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569111">case</span>&nbsp;<span class="op" id="5569116">*</span><span class="ident" id="5569117">image</span><span class="op" id="5569122">.</span><span class="ident" id="5569123">NRGBA</span><span class="op" id="5569128">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569135">drawNRGBASrc</span><span class="op" id="5569147">(</span><span class="ident" id="5569148">dst0</span><span class="op" id="5569152">,</span>&nbsp;<span class="ident" id="5569154">r</span><span class="op" id="5569155">,</span>&nbsp;<span class="ident" id="5569157">src0</span><span class="op" id="5569161">,</span>&nbsp;<span class="ident" id="5569163">sp</span><span class="op" id="5569165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569172">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569183">case</span>&nbsp;<span class="op" id="5569188">*</span><span class="ident" id="5569189">image</span><span class="op" id="5569194">.</span><span class="ident" id="5569195">YCbCr</span><span class="op" id="5569200">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569207">if</span>&nbsp;<span class="ident" id="5569210">drawYCbCr</span><span class="op" id="5569219">(</span><span class="ident" id="5569220">dst0</span><span class="op" id="5569224">,</span>&nbsp;<span class="ident" id="5569226">r</span><span class="op" id="5569227">,</span>&nbsp;<span class="ident" id="5569229">src0</span><span class="op" id="5569233">,</span>&nbsp;<span class="ident" id="5569235">sp</span><span class="op" id="5569237">)</span>&nbsp;<span class="op" id="5569239">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569247">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569274">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569278">drawRGBA</span><span class="op" id="5569286">(</span><span class="ident" id="5569287">dst0</span><span class="op" id="5569291">,</span>&nbsp;<span class="ident" id="5569293">r</span><span class="op" id="5569294">,</span>&nbsp;<span class="ident" id="5569296">src</span><span class="op" id="5569299">,</span>&nbsp;<span class="ident" id="5569301">sp</span><span class="op" id="5569303">,</span>&nbsp;<span class="ident" id="5569305">mask</span><span class="op" id="5569309">,</span>&nbsp;<span class="ident" id="5569311">mp</span><span class="op" id="5569313">,</span>&nbsp;<span class="ident" id="5569315">op</span><span class="op" id="5569317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569321">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569329">case</span>&nbsp;<span class="op" id="5569334">*</span><span class="ident" id="5569335">image</span><span class="op" id="5569340">.</span><span class="ident" id="5569341">Paletted</span><span class="op" id="5569349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569353">if</span>&nbsp;<span class="ident" id="5569356">op</span>&nbsp;<span class="op" id="5569359">==</span>&nbsp;<span class="ident" id="5569362">Src</span>&nbsp;<span class="op" id="5569366">&amp;&amp;</span>&nbsp;<span class="ident" id="5569369">mask</span>&nbsp;<span class="op" id="5569374">==</span>&nbsp;<span class="ident" id="5569377">nil</span>&nbsp;<span class="op" id="5569381">&amp;&amp;</span>&nbsp;<span class="op" id="5569384">!</span><span class="ident" id="5569385">processBackward</span><span class="op" id="5569400">(</span><span class="ident" id="5569401">dst</span><span class="op" id="5569404">,</span>&nbsp;<span class="ident" id="5569406">r</span><span class="op" id="5569407">,</span>&nbsp;<span class="ident" id="5569409">src</span><span class="op" id="5569412">,</span>&nbsp;<span class="ident" id="5569414">sp</span><span class="op" id="5569416">)</span>&nbsp;<span class="op" id="5569418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569423">drawPaletted</span><span class="op" id="5569435">(</span><span class="ident" id="5569436">dst0</span><span class="op" id="5569440">,</span>&nbsp;<span class="ident" id="5569442">r</span><span class="op" id="5569443">,</span>&nbsp;<span class="ident" id="5569445">src</span><span class="op" id="5569448">,</span>&nbsp;<span class="ident" id="5569450">sp</span><span class="op" id="5569452">,</span>&nbsp;<span class="builtintype" id="5569454">false</span><span class="op" id="5569459">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569470">x0</span><span class="op" id="5569472">,</span>&nbsp;<span class="ident" id="5569474">x1</span><span class="op" id="5569476">,</span>&nbsp;<span class="ident" id="5569478">dx</span>&nbsp;<span class="op" id="5569481">:=</span>&nbsp;<span class="ident" id="5569484">r</span><span class="op" id="5569485">.</span><span class="ident" id="5569486">Min</span><span class="op" id="5569489">.</span><span class="ident" id="5569490">X</span><span class="op" id="5569491">,</span>&nbsp;<span class="ident" id="5569493">r</span><span class="op" id="5569494">.</span><span class="ident" id="5569495">Max</span><span class="op" id="5569498">.</span><span class="ident" id="5569499">X</span><span class="op" id="5569500">,</span>&nbsp;<span class="num" id="5569502">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569505">y0</span><span class="op" id="5569507">,</span>&nbsp;<span class="ident" id="5569509">y1</span><span class="op" id="5569511">,</span>&nbsp;<span class="ident" id="5569513">dy</span>&nbsp;<span class="op" id="5569516">:=</span>&nbsp;<span class="ident" id="5569519">r</span><span class="op" id="5569520">.</span><span class="ident" id="5569521">Min</span><span class="op" id="5569524">.</span><span class="ident" id="5569525">Y</span><span class="op" id="5569526">,</span>&nbsp;<span class="ident" id="5569528">r</span><span class="op" id="5569529">.</span><span class="ident" id="5569530">Max</span><span class="op" id="5569533">.</span><span class="ident" id="5569534">Y</span><span class="op" id="5569535">,</span>&nbsp;<span class="num" id="5569537">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569540">if</span>&nbsp;<span class="ident" id="5569543">processBackward</span><span class="op" id="5569558">(</span><span class="ident" id="5569559">dst</span><span class="op" id="5569562">,</span>&nbsp;<span class="ident" id="5569564">r</span><span class="op" id="5569565">,</span>&nbsp;<span class="ident" id="5569567">src</span><span class="op" id="5569570">,</span>&nbsp;<span class="ident" id="5569572">sp</span><span class="op" id="5569574">)</span>&nbsp;<span class="op" id="5569576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569580">x0</span><span class="op" id="5569582">,</span>&nbsp;<span class="ident" id="5569584">x1</span><span class="op" id="5569586">,</span>&nbsp;<span class="ident" id="5569588">dx</span>&nbsp;<span class="op" id="5569591">=</span>&nbsp;<span class="ident" id="5569593">x1</span><span class="op" id="5569595">-</span><span class="num" id="5569596">1</span><span class="op" id="5569597">,</span>&nbsp;<span class="ident" id="5569599">x0</span><span class="op" id="5569601">-</span><span class="num" id="5569602">1</span><span class="op" id="5569603">,</span>&nbsp;<span class="op" id="5569605">-</span><span class="num" id="5569606">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569610">y0</span><span class="op" id="5569612">,</span>&nbsp;<span class="ident" id="5569614">y1</span><span class="op" id="5569616">,</span>&nbsp;<span class="ident" id="5569618">dy</span>&nbsp;<span class="op" id="5569621">=</span>&nbsp;<span class="ident" id="5569623">y1</span><span class="op" id="5569625">-</span><span class="num" id="5569626">1</span><span class="op" id="5569627">,</span>&nbsp;<span class="ident" id="5569629">y0</span><span class="op" id="5569631">-</span><span class="num" id="5569632">1</span><span class="op" id="5569633">,</span>&nbsp;<span class="op" id="5569635">-</span><span class="num" id="5569636">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569643">var</span>&nbsp;<span class="ident" id="5569647">out</span>&nbsp;<span class="ident" id="5569651">color</span><span class="op" id="5569656">.</span><span class="ident" id="5569657">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569665">sy</span>&nbsp;<span class="op" id="5569668">:=</span>&nbsp;<span class="ident" id="5569671">sp</span><span class="op" id="5569673">.</span><span class="ident" id="5569674">Y</span>&nbsp;<span class="op" id="5569676">+</span>&nbsp;<span class="ident" id="5569678">y0</span>&nbsp;<span class="op" id="5569681">-</span>&nbsp;<span class="ident" id="5569683">r</span><span class="op" id="5569684">.</span><span class="ident" id="5569685">Min</span><span class="op" id="5569688">.</span><span class="ident" id="5569689">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569692">my</span>&nbsp;<span class="op" id="5569695">:=</span>&nbsp;<span class="ident" id="5569698">mp</span><span class="op" id="5569700">.</span><span class="ident" id="5569701">Y</span>&nbsp;<span class="op" id="5569703">+</span>&nbsp;<span class="ident" id="5569705">y0</span>&nbsp;<span class="op" id="5569708">-</span>&nbsp;<span class="ident" id="5569710">r</span><span class="op" id="5569711">.</span><span class="ident" id="5569712">Min</span><span class="op" id="5569715">.</span><span class="ident" id="5569716">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569719">for</span>&nbsp;<span class="ident" id="5569723">y</span>&nbsp;<span class="op" id="5569725">:=</span>&nbsp;<span class="ident" id="5569728">y0</span><span class="op" id="5569730">;</span>&nbsp;<span class="ident" id="5569732">y</span>&nbsp;<span class="op" id="5569734">!=</span>&nbsp;<span class="ident" id="5569737">y1</span><span class="op" id="5569739">;</span>&nbsp;<span class="ident" id="5569741">y</span><span class="op" id="5569742">,</span>&nbsp;<span class="ident" id="5569744">sy</span><span class="op" id="5569746">,</span>&nbsp;<span class="ident" id="5569748">my</span>&nbsp;<span class="op" id="5569751">=</span>&nbsp;<span class="ident" id="5569753">y</span><span class="op" id="5569754">+</span><span class="ident" id="5569755">dy</span><span class="op" id="5569757">,</span>&nbsp;<span class="ident" id="5569759">sy</span><span class="op" id="5569761">+</span><span class="ident" id="5569762">dy</span><span class="op" id="5569764">,</span>&nbsp;<span class="ident" id="5569766">my</span><span class="op" id="5569768">+</span><span class="ident" id="5569769">dy</span>&nbsp;<span class="op" id="5569772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569776">sx</span>&nbsp;<span class="op" id="5569779">:=</span>&nbsp;<span class="ident" id="5569782">sp</span><span class="op" id="5569784">.</span><span class="ident" id="5569785">X</span>&nbsp;<span class="op" id="5569787">+</span>&nbsp;<span class="ident" id="5569789">x0</span>&nbsp;<span class="op" id="5569792">-</span>&nbsp;<span class="ident" id="5569794">r</span><span class="op" id="5569795">.</span><span class="ident" id="5569796">Min</span><span class="op" id="5569799">.</span><span class="ident" id="5569800">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569804">mx</span>&nbsp;<span class="op" id="5569807">:=</span>&nbsp;<span class="ident" id="5569810">mp</span><span class="op" id="5569812">.</span><span class="ident" id="5569813">X</span>&nbsp;<span class="op" id="5569815">+</span>&nbsp;<span class="ident" id="5569817">x0</span>&nbsp;<span class="op" id="5569820">-</span>&nbsp;<span class="ident" id="5569822">r</span><span class="op" id="5569823">.</span><span class="ident" id="5569824">Min</span><span class="op" id="5569827">.</span><span class="ident" id="5569828">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569832">for</span>&nbsp;<span class="ident" id="5569836">x</span>&nbsp;<span class="op" id="5569838">:=</span>&nbsp;<span class="ident" id="5569841">x0</span><span class="op" id="5569843">;</span>&nbsp;<span class="ident" id="5569845">x</span>&nbsp;<span class="op" id="5569847">!=</span>&nbsp;<span class="ident" id="5569850">x1</span><span class="op" id="5569852">;</span>&nbsp;<span class="ident" id="5569854">x</span><span class="op" id="5569855">,</span>&nbsp;<span class="ident" id="5569857">sx</span><span class="op" id="5569859">,</span>&nbsp;<span class="ident" id="5569861">mx</span>&nbsp;<span class="op" id="5569864">=</span>&nbsp;<span class="ident" id="5569866">x</span><span class="op" id="5569867">+</span><span class="ident" id="5569868">dx</span><span class="op" id="5569870">,</span>&nbsp;<span class="ident" id="5569872">sx</span><span class="op" id="5569874">+</span><span class="ident" id="5569875">dx</span><span class="op" id="5569877">,</span>&nbsp;<span class="ident" id="5569879">mx</span><span class="op" id="5569881">+</span><span class="ident" id="5569882">dx</span>&nbsp;<span class="op" id="5569885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569890">ma</span>&nbsp;<span class="op" id="5569893">:=</span>&nbsp;<span class="builtintype" id="5569896">uint32</span><span class="op" id="5569902">(</span><span class="ident" id="5569903">m</span><span class="op" id="5569904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569909">if</span>&nbsp;<span class="ident" id="5569912">mask</span>&nbsp;<span class="op" id="5569917">!=</span>&nbsp;<span class="ident" id="5569920">nil</span>&nbsp;<span class="op" id="5569924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5569930">_</span><span class="op" id="5569931">,</span>&nbsp;<span class="ident" id="5569933">_</span><span class="op" id="5569934">,</span>&nbsp;<span class="ident" id="5569936">_</span><span class="op" id="5569937">,</span>&nbsp;<span class="ident" id="5569939">ma</span>&nbsp;<span class="op" id="5569942">=</span>&nbsp;<span class="ident" id="5569944">mask</span><span class="op" id="5569948">.</span><span class="ident" id="5569949">At</span><span class="op" id="5569951">(</span><span class="ident" id="5569952">mx</span><span class="op" id="5569954">,</span>&nbsp;<span class="ident" id="5569956">my</span><span class="op" id="5569958">)</span><span class="op" id="5569959">.</span><span class="ident" id="5569960">RGBA</span><span class="op" id="5569964">(</span><span class="op" id="5569965">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5569970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569975">switch</span>&nbsp;<span class="op" id="5569982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5569987">case</span>&nbsp;<span class="ident" id="5569992">ma</span>&nbsp;<span class="op" id="5569995">==</span>&nbsp;<span class="num" id="5569998">0</span><span class="op" id="5569999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5570005">if</span>&nbsp;<span class="ident" id="5570008">op</span>&nbsp;<span class="op" id="5570011">==</span>&nbsp;<span class="ident" id="5570014">Over</span>&nbsp;<span class="op" id="5570019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5570026">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570040">}</span>&nbsp;<span class="keyword" id="5570042">else</span>&nbsp;<span class="op" id="5570047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570054">dst</span><span class="op" id="5570057">.</span><span class="ident" id="5570058">Set</span><span class="op" id="5570061">(</span><span class="ident" id="5570062">x</span><span class="op" id="5570063">,</span>&nbsp;<span class="ident" id="5570065">y</span><span class="op" id="5570066">,</span>&nbsp;<span class="ident" id="5570068">color</span><span class="op" id="5570073">.</span><span class="ident" id="5570074">Transparent</span><span class="op" id="5570085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5570096">case</span>&nbsp;<span class="ident" id="5570101">ma</span>&nbsp;<span class="op" id="5570104">==</span>&nbsp;<span class="ident" id="5570107">m</span>&nbsp;<span class="op" id="5570109">&amp;&amp;</span>&nbsp;<span class="ident" id="5570112">op</span>&nbsp;<span class="op" id="5570115">==</span>&nbsp;<span class="ident" id="5570118">Src</span><span class="op" id="5570121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570127">dst</span><span class="op" id="5570130">.</span><span class="ident" id="5570131">Set</span><span class="op" id="5570134">(</span><span class="ident" id="5570135">x</span><span class="op" id="5570136">,</span>&nbsp;<span class="ident" id="5570138">y</span><span class="op" id="5570139">,</span>&nbsp;<span class="ident" id="5570141">src</span><span class="op" id="5570144">.</span><span class="ident" id="5570145">At</span><span class="op" id="5570147">(</span><span class="ident" id="5570148">sx</span><span class="op" id="5570150">,</span>&nbsp;<span class="ident" id="5570152">sy</span><span class="op" id="5570154">)</span><span class="op" id="5570155">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5570160">default</span><span class="op" id="5570167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570173">sr</span><span class="op" id="5570175">,</span>&nbsp;<span class="ident" id="5570177">sg</span><span class="op" id="5570179">,</span>&nbsp;<span class="ident" id="5570181">sb</span><span class="op" id="5570183">,</span>&nbsp;<span class="ident" id="5570185">sa</span>&nbsp;<span class="op" id="5570188">:=</span>&nbsp;<span class="ident" id="5570191">src</span><span class="op" id="5570194">.</span><span class="ident" id="5570195">At</span><span class="op" id="5570197">(</span><span class="ident" id="5570198">sx</span><span class="op" id="5570200">,</span>&nbsp;<span class="ident" id="5570202">sy</span><span class="op" id="5570204">)</span><span class="op" id="5570205">.</span><span class="ident" id="5570206">RGBA</span><span class="op" id="5570210">(</span><span class="op" id="5570211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5570217">if</span>&nbsp;<span class="ident" id="5570220">op</span>&nbsp;<span class="op" id="5570223">==</span>&nbsp;<span class="ident" id="5570226">Over</span>&nbsp;<span class="op" id="5570231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570238">dr</span><span class="op" id="5570240">,</span>&nbsp;<span class="ident" id="5570242">dg</span><span class="op" id="5570244">,</span>&nbsp;<span class="ident" id="5570246">db</span><span class="op" id="5570248">,</span>&nbsp;<span class="ident" id="5570250">da</span>&nbsp;<span class="op" id="5570253">:=</span>&nbsp;<span class="ident" id="5570256">dst</span><span class="op" id="5570259">.</span><span class="ident" id="5570260">At</span><span class="op" id="5570262">(</span><span class="ident" id="5570263">x</span><span class="op" id="5570264">,</span>&nbsp;<span class="ident" id="5570266">y</span><span class="op" id="5570267">)</span><span class="op" id="5570268">.</span><span class="ident" id="5570269">RGBA</span><span class="op" id="5570273">(</span><span class="op" id="5570274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570281">a</span>&nbsp;<span class="op" id="5570283">:=</span>&nbsp;<span class="ident" id="5570286">m</span>&nbsp;<span class="op" id="5570288">-</span>&nbsp;<span class="op" id="5570290">(</span><span class="ident" id="5570291">sa</span>&nbsp;<span class="op" id="5570294">*</span>&nbsp;<span class="ident" id="5570296">ma</span>&nbsp;<span class="op" id="5570299">/</span>&nbsp;<span class="ident" id="5570301">m</span><span class="op" id="5570302">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570309">out</span><span class="op" id="5570312">.</span><span class="ident" id="5570313">R</span>&nbsp;<span class="op" id="5570315">=</span>&nbsp;<span class="builtintype" id="5570317">uint16</span><span class="op" id="5570323">(</span><span class="op" id="5570324">(</span><span class="ident" id="5570325">dr</span><span class="op" id="5570327">*</span><span class="ident" id="5570328">a</span>&nbsp;<span class="op" id="5570330">+</span>&nbsp;<span class="ident" id="5570332">sr</span><span class="op" id="5570334">*</span><span class="ident" id="5570335">ma</span><span class="op" id="5570337">)</span>&nbsp;<span class="op" id="5570339">/</span>&nbsp;<span class="ident" id="5570341">m</span><span class="op" id="5570342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570349">out</span><span class="op" id="5570352">.</span><span class="ident" id="5570353">G</span>&nbsp;<span class="op" id="5570355">=</span>&nbsp;<span class="builtintype" id="5570357">uint16</span><span class="op" id="5570363">(</span><span class="op" id="5570364">(</span><span class="ident" id="5570365">dg</span><span class="op" id="5570367">*</span><span class="ident" id="5570368">a</span>&nbsp;<span class="op" id="5570370">+</span>&nbsp;<span class="ident" id="5570372">sg</span><span class="op" id="5570374">*</span><span class="ident" id="5570375">ma</span><span class="op" id="5570377">)</span>&nbsp;<span class="op" id="5570379">/</span>&nbsp;<span class="ident" id="5570381">m</span><span class="op" id="5570382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570389">out</span><span class="op" id="5570392">.</span><span class="ident" id="5570393">B</span>&nbsp;<span class="op" id="5570395">=</span>&nbsp;<span class="builtintype" id="5570397">uint16</span><span class="op" id="5570403">(</span><span class="op" id="5570404">(</span><span class="ident" id="5570405">db</span><span class="op" id="5570407">*</span><span class="ident" id="5570408">a</span>&nbsp;<span class="op" id="5570410">+</span>&nbsp;<span class="ident" id="5570412">sb</span><span class="op" id="5570414">*</span><span class="ident" id="5570415">ma</span><span class="op" id="5570417">)</span>&nbsp;<span class="op" id="5570419">/</span>&nbsp;<span class="ident" id="5570421">m</span><span class="op" id="5570422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570429">out</span><span class="op" id="5570432">.</span><span class="ident" id="5570433">A</span>&nbsp;<span class="op" id="5570435">=</span>&nbsp;<span class="builtintype" id="5570437">uint16</span><span class="op" id="5570443">(</span><span class="op" id="5570444">(</span><span class="ident" id="5570445">da</span><span class="op" id="5570447">*</span><span class="ident" id="5570448">a</span>&nbsp;<span class="op" id="5570450">+</span>&nbsp;<span class="ident" id="5570452">sa</span><span class="op" id="5570454">*</span><span class="ident" id="5570455">ma</span><span class="op" id="5570457">)</span>&nbsp;<span class="op" id="5570459">/</span>&nbsp;<span class="ident" id="5570461">m</span><span class="op" id="5570462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570468">}</span>&nbsp;<span class="keyword" id="5570470">else</span>&nbsp;<span class="op" id="5570475">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570482">out</span><span class="op" id="5570485">.</span><span class="ident" id="5570486">R</span>&nbsp;<span class="op" id="5570488">=</span>&nbsp;<span class="builtintype" id="5570490">uint16</span><span class="op" id="5570496">(</span><span class="ident" id="5570497">sr</span>&nbsp;<span class="op" id="5570500">*</span>&nbsp;<span class="ident" id="5570502">ma</span>&nbsp;<span class="op" id="5570505">/</span>&nbsp;<span class="ident" id="5570507">m</span><span class="op" id="5570508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570515">out</span><span class="op" id="5570518">.</span><span class="ident" id="5570519">G</span>&nbsp;<span class="op" id="5570521">=</span>&nbsp;<span class="builtintype" id="5570523">uint16</span><span class="op" id="5570529">(</span><span class="ident" id="5570530">sg</span>&nbsp;<span class="op" id="5570533">*</span>&nbsp;<span class="ident" id="5570535">ma</span>&nbsp;<span class="op" id="5570538">/</span>&nbsp;<span class="ident" id="5570540">m</span><span class="op" id="5570541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570548">out</span><span class="op" id="5570551">.</span><span class="ident" id="5570552">B</span>&nbsp;<span class="op" id="5570554">=</span>&nbsp;<span class="builtintype" id="5570556">uint16</span><span class="op" id="5570562">(</span><span class="ident" id="5570563">sb</span>&nbsp;<span class="op" id="5570566">*</span>&nbsp;<span class="ident" id="5570568">ma</span>&nbsp;<span class="op" id="5570571">/</span>&nbsp;<span class="ident" id="5570573">m</span><span class="op" id="5570574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570581">out</span><span class="op" id="5570584">.</span><span class="ident" id="5570585">A</span>&nbsp;<span class="op" id="5570587">=</span>&nbsp;<span class="builtintype" id="5570589">uint16</span><span class="op" id="5570595">(</span><span class="ident" id="5570596">sa</span>&nbsp;<span class="op" id="5570599">*</span>&nbsp;<span class="ident" id="5570601">ma</span>&nbsp;<span class="op" id="5570604">/</span>&nbsp;<span class="ident" id="5570606">m</span><span class="op" id="5570607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570613">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5570619">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5570680">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5570745">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5570808">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570869">dst</span><span class="op" id="5570872">.</span><span class="ident" id="5570873">Set</span><span class="op" id="5570876">(</span><span class="ident" id="5570877">x</span><span class="op" id="5570878">,</span>&nbsp;<span class="ident" id="5570880">y</span><span class="op" id="5570881">,</span>&nbsp;<span class="op" id="5570883">&amp;</span><span class="ident" id="5570884">out</span><span class="op" id="5570887">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5570899">}</span><br>
<span class="lineno"></span><span class="op" id="5570901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5570904">func</span>&nbsp;<span class="ident" id="5570909">drawFillOver</span><span class="op" id="5570921">(</span><span class="ident" id="5570922">dst</span>&nbsp;<span class="op" id="5570926">*</span><span class="ident" id="5570927">image</span><span class="op" id="5570932">.</span><span class="ident" id="5570933">RGBA</span><span class="op" id="5570937">,</span>&nbsp;<span class="ident" id="5570939">r</span>&nbsp;<span class="ident" id="5570941">image</span><span class="op" id="5570946">.</span><span class="ident" id="5570947">Rectangle</span><span class="op" id="5570956">,</span>&nbsp;<span class="ident" id="5570958">src</span>&nbsp;<span class="op" id="5570962">*</span><span class="ident" id="5570963">image</span><span class="op" id="5570968">.</span><span class="ident" id="5570969">Uniform</span><span class="op" id="5570976">)</span>&nbsp;<span class="op" id="5570978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5570981">sr</span><span class="op" id="5570983">,</span>&nbsp;<span class="ident" id="5570985">sg</span><span class="op" id="5570987">,</span>&nbsp;<span class="ident" id="5570989">sb</span><span class="op" id="5570991">,</span>&nbsp;<span class="ident" id="5570993">sa</span>&nbsp;<span class="op" id="5570996">:=</span>&nbsp;<span class="ident" id="5570999">src</span><span class="op" id="5571002">.</span><span class="ident" id="5571003">RGBA</span><span class="op" id="5571007">(</span><span class="op" id="5571008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5571011">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571069">a</span>&nbsp;<span class="op" id="5571071">:=</span>&nbsp;<span class="op" id="5571074">(</span><span class="ident" id="5571075">m</span>&nbsp;<span class="op" id="5571077">-</span>&nbsp;<span class="ident" id="5571079">sa</span><span class="op" id="5571081">)</span>&nbsp;<span class="op" id="5571083">*</span>&nbsp;<span class="num" id="5571085">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571092">i0</span>&nbsp;<span class="op" id="5571095">:=</span>&nbsp;<span class="ident" id="5571098">dst</span><span class="op" id="5571101">.</span><span class="ident" id="5571102">PixOffset</span><span class="op" id="5571111">(</span><span class="ident" id="5571112">r</span><span class="op" id="5571113">.</span><span class="ident" id="5571114">Min</span><span class="op" id="5571117">.</span><span class="ident" id="5571118">X</span><span class="op" id="5571119">,</span>&nbsp;<span class="ident" id="5571121">r</span><span class="op" id="5571122">.</span><span class="ident" id="5571123">Min</span><span class="op" id="5571126">.</span><span class="ident" id="5571127">Y</span><span class="op" id="5571128">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571131">i1</span>&nbsp;<span class="op" id="5571134">:=</span>&nbsp;<span class="ident" id="5571137">i0</span>&nbsp;<span class="op" id="5571140">+</span>&nbsp;<span class="ident" id="5571142">r</span><span class="op" id="5571143">.</span><span class="ident" id="5571144">Dx</span><span class="op" id="5571146">(</span><span class="op" id="5571147">)</span><span class="op" id="5571148">*</span><span class="num" id="5571149">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5571152">for</span>&nbsp;<span class="ident" id="5571156">y</span>&nbsp;<span class="op" id="5571158">:=</span>&nbsp;<span class="ident" id="5571161">r</span><span class="op" id="5571162">.</span><span class="ident" id="5571163">Min</span><span class="op" id="5571166">.</span><span class="ident" id="5571167">Y</span><span class="op" id="5571168">;</span>&nbsp;<span class="ident" id="5571170">y</span>&nbsp;<span class="op" id="5571172">!=</span>&nbsp;<span class="ident" id="5571175">r</span><span class="op" id="5571176">.</span><span class="ident" id="5571177">Max</span><span class="op" id="5571180">.</span><span class="ident" id="5571181">Y</span><span class="op" id="5571182">;</span>&nbsp;<span class="ident" id="5571184">y</span><span class="op" id="5571185">++</span>&nbsp;<span class="op" id="5571188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5571192">for</span>&nbsp;<span class="ident" id="5571196">i</span>&nbsp;<span class="op" id="5571198">:=</span>&nbsp;<span class="ident" id="5571201">i0</span><span class="op" id="5571203">;</span>&nbsp;<span class="ident" id="5571205">i</span>&nbsp;<span class="op" id="5571207">&lt;</span>&nbsp;<span class="ident" id="5571209">i1</span><span class="op" id="5571211">;</span>&nbsp;<span class="ident" id="5571213">i</span>&nbsp;<span class="op" id="5571215">+=</span>&nbsp;<span class="num" id="5571218">4</span>&nbsp;<span class="op" id="5571220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571225">dr</span>&nbsp;<span class="op" id="5571228">:=</span>&nbsp;<span class="builtintype" id="5571231">uint32</span><span class="op" id="5571237">(</span><span class="ident" id="5571238">dst</span><span class="op" id="5571241">.</span><span class="ident" id="5571242">Pix</span><span class="op" id="5571245">[</span><span class="ident" id="5571246">i</span><span class="op" id="5571247">+</span><span class="num" id="5571248">0</span><span class="op" id="5571249">]</span><span class="op" id="5571250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571255">dg</span>&nbsp;<span class="op" id="5571258">:=</span>&nbsp;<span class="builtintype" id="5571261">uint32</span><span class="op" id="5571267">(</span><span class="ident" id="5571268">dst</span><span class="op" id="5571271">.</span><span class="ident" id="5571272">Pix</span><span class="op" id="5571275">[</span><span class="ident" id="5571276">i</span><span class="op" id="5571277">+</span><span class="num" id="5571278">1</span><span class="op" id="5571279">]</span><span class="op" id="5571280">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571285">db</span>&nbsp;<span class="op" id="5571288">:=</span>&nbsp;<span class="builtintype" id="5571291">uint32</span><span class="op" id="5571297">(</span><span class="ident" id="5571298">dst</span><span class="op" id="5571301">.</span><span class="ident" id="5571302">Pix</span><span class="op" id="5571305">[</span><span class="ident" id="5571306">i</span><span class="op" id="5571307">+</span><span class="num" id="5571308">2</span><span class="op" id="5571309">]</span><span class="op" id="5571310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571315">da</span>&nbsp;<span class="op" id="5571318">:=</span>&nbsp;<span class="builtintype" id="5571321">uint32</span><span class="op" id="5571327">(</span><span class="ident" id="5571328">dst</span><span class="op" id="5571331">.</span><span class="ident" id="5571332">Pix</span><span class="op" id="5571335">[</span><span class="ident" id="5571336">i</span><span class="op" id="5571337">+</span><span class="num" id="5571338">3</span><span class="op" id="5571339">]</span><span class="op" id="5571340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571346">dst</span><span class="op" id="5571349">.</span><span class="ident" id="5571350">Pix</span><span class="op" id="5571353">[</span><span class="ident" id="5571354">i</span><span class="op" id="5571355">+</span><span class="num" id="5571356">0</span><span class="op" id="5571357">]</span>&nbsp;<span class="op" id="5571359">=</span>&nbsp;<span class="builtintype" id="5571361">uint8</span><span class="op" id="5571366">(</span><span class="op" id="5571367">(</span><span class="ident" id="5571368">dr</span><span class="op" id="5571370">*</span><span class="ident" id="5571371">a</span><span class="op" id="5571372">/</span><span class="ident" id="5571373">m</span>&nbsp;<span class="op" id="5571375">+</span>&nbsp;<span class="ident" id="5571377">sr</span><span class="op" id="5571379">)</span>&nbsp;<span class="op" id="5571381">&gt;&gt;</span>&nbsp;<span class="num" id="5571384">8</span><span class="op" id="5571385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571390">dst</span><span class="op" id="5571393">.</span><span class="ident" id="5571394">Pix</span><span class="op" id="5571397">[</span><span class="ident" id="5571398">i</span><span class="op" id="5571399">+</span><span class="num" id="5571400">1</span><span class="op" id="5571401">]</span>&nbsp;<span class="op" id="5571403">=</span>&nbsp;<span class="builtintype" id="5571405">uint8</span><span class="op" id="5571410">(</span><span class="op" id="5571411">(</span><span class="ident" id="5571412">dg</span><span class="op" id="5571414">*</span><span class="ident" id="5571415">a</span><span class="op" id="5571416">/</span><span class="ident" id="5571417">m</span>&nbsp;<span class="op" id="5571419">+</span>&nbsp;<span class="ident" id="5571421">sg</span><span class="op" id="5571423">)</span>&nbsp;<span class="op" id="5571425">&gt;&gt;</span>&nbsp;<span class="num" id="5571428">8</span><span class="op" id="5571429">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571434">dst</span><span class="op" id="5571437">.</span><span class="ident" id="5571438">Pix</span><span class="op" id="5571441">[</span><span class="ident" id="5571442">i</span><span class="op" id="5571443">+</span><span class="num" id="5571444">2</span><span class="op" id="5571445">]</span>&nbsp;<span class="op" id="5571447">=</span>&nbsp;<span class="builtintype" id="5571449">uint8</span><span class="op" id="5571454">(</span><span class="op" id="5571455">(</span><span class="ident" id="5571456">db</span><span class="op" id="5571458">*</span><span class="ident" id="5571459">a</span><span class="op" id="5571460">/</span><span class="ident" id="5571461">m</span>&nbsp;<span class="op" id="5571463">+</span>&nbsp;<span class="ident" id="5571465">sb</span><span class="op" id="5571467">)</span>&nbsp;<span class="op" id="5571469">&gt;&gt;</span>&nbsp;<span class="num" id="5571472">8</span><span class="op" id="5571473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571478">dst</span><span class="op" id="5571481">.</span><span class="ident" id="5571482">Pix</span><span class="op" id="5571485">[</span><span class="ident" id="5571486">i</span><span class="op" id="5571487">+</span><span class="num" id="5571488">3</span><span class="op" id="5571489">]</span>&nbsp;<span class="op" id="5571491">=</span>&nbsp;<span class="builtintype" id="5571493">uint8</span><span class="op" id="5571498">(</span><span class="op" id="5571499">(</span><span class="ident" id="5571500">da</span><span class="op" id="5571502">*</span><span class="ident" id="5571503">a</span><span class="op" id="5571504">/</span><span class="ident" id="5571505">m</span>&nbsp;<span class="op" id="5571507">+</span>&nbsp;<span class="ident" id="5571509">sa</span><span class="op" id="5571511">)</span>&nbsp;<span class="op" id="5571513">&gt;&gt;</span>&nbsp;<span class="num" id="5571516">8</span><span class="op" id="5571517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5571521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571525">i0</span>&nbsp;<span class="op" id="5571528">+=</span>&nbsp;<span class="ident" id="5571531">dst</span><span class="op" id="5571534">.</span><span class="ident" id="5571535">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571544">i1</span>&nbsp;<span class="op" id="5571547">+=</span>&nbsp;<span class="ident" id="5571550">dst</span><span class="op" id="5571553">.</span><span class="ident" id="5571554">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5571562">}</span><br>
<span class="lineno"></span><span class="op" id="5571564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5571567">func</span>&nbsp;<span class="ident" id="5571572">drawFillSrc</span><span class="op" id="5571583">(</span><span class="ident" id="5571584">dst</span>&nbsp;<span class="op" id="5571588">*</span><span class="ident" id="5571589">image</span><span class="op" id="5571594">.</span><span class="ident" id="5571595">RGBA</span><span class="op" id="5571599">,</span>&nbsp;<span class="ident" id="5571601">r</span>&nbsp;<span class="ident" id="5571603">image</span><span class="op" id="5571608">.</span><span class="ident" id="5571609">Rectangle</span><span class="op" id="5571618">,</span>&nbsp;<span class="ident" id="5571620">src</span>&nbsp;<span class="op" id="5571624">*</span><span class="ident" id="5571625">image</span><span class="op" id="5571630">.</span><span class="ident" id="5571631">Uniform</span><span class="op" id="5571638">)</span>&nbsp;<span class="op" id="5571640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571643">sr</span><span class="op" id="5571645">,</span>&nbsp;<span class="ident" id="5571647">sg</span><span class="op" id="5571649">,</span>&nbsp;<span class="ident" id="5571651">sb</span><span class="op" id="5571653">,</span>&nbsp;<span class="ident" id="5571655">sa</span>&nbsp;<span class="op" id="5571658">:=</span>&nbsp;<span class="ident" id="5571661">src</span><span class="op" id="5571664">.</span><span class="ident" id="5571665">RGBA</span><span class="op" id="5571669">(</span><span class="op" id="5571670">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5571673">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5571775">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5571879">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571950">i0</span>&nbsp;<span class="op" id="5571953">:=</span>&nbsp;<span class="ident" id="5571956">dst</span><span class="op" id="5571959">.</span><span class="ident" id="5571960">PixOffset</span><span class="op" id="5571969">(</span><span class="ident" id="5571970">r</span><span class="op" id="5571971">.</span><span class="ident" id="5571972">Min</span><span class="op" id="5571975">.</span><span class="ident" id="5571976">X</span><span class="op" id="5571977">,</span>&nbsp;<span class="ident" id="5571979">r</span><span class="op" id="5571980">.</span><span class="ident" id="5571981">Min</span><span class="op" id="5571984">.</span><span class="ident" id="5571985">Y</span><span class="op" id="5571986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5571989">i1</span>&nbsp;<span class="op" id="5571992">:=</span>&nbsp;<span class="ident" id="5571995">i0</span>&nbsp;<span class="op" id="5571998">+</span>&nbsp;<span class="ident" id="5572000">r</span><span class="op" id="5572001">.</span><span class="ident" id="5572002">Dx</span><span class="op" id="5572004">(</span><span class="op" id="5572005">)</span><span class="op" id="5572006">*</span><span class="num" id="5572007">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5572010">for</span>&nbsp;<span class="ident" id="5572014">i</span>&nbsp;<span class="op" id="5572016">:=</span>&nbsp;<span class="ident" id="5572019">i0</span><span class="op" id="5572021">;</span>&nbsp;<span class="ident" id="5572023">i</span>&nbsp;<span class="op" id="5572025">&lt;</span>&nbsp;<span class="ident" id="5572027">i1</span><span class="op" id="5572029">;</span>&nbsp;<span class="ident" id="5572031">i</span>&nbsp;<span class="op" id="5572033">+=</span>&nbsp;<span class="num" id="5572036">4</span>&nbsp;<span class="op" id="5572038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572042">dst</span><span class="op" id="5572045">.</span><span class="ident" id="5572046">Pix</span><span class="op" id="5572049">[</span><span class="ident" id="5572050">i</span><span class="op" id="5572051">+</span><span class="num" id="5572052">0</span><span class="op" id="5572053">]</span>&nbsp;<span class="op" id="5572055">=</span>&nbsp;<span class="builtintype" id="5572057">uint8</span><span class="op" id="5572062">(</span><span class="ident" id="5572063">sr</span>&nbsp;<span class="op" id="5572066">&gt;&gt;</span>&nbsp;<span class="num" id="5572069">8</span><span class="op" id="5572070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572074">dst</span><span class="op" id="5572077">.</span><span class="ident" id="5572078">Pix</span><span class="op" id="5572081">[</span><span class="ident" id="5572082">i</span><span class="op" id="5572083">+</span><span class="num" id="5572084">1</span><span class="op" id="5572085">]</span>&nbsp;<span class="op" id="5572087">=</span>&nbsp;<span class="builtintype" id="5572089">uint8</span><span class="op" id="5572094">(</span><span class="ident" id="5572095">sg</span>&nbsp;<span class="op" id="5572098">&gt;&gt;</span>&nbsp;<span class="num" id="5572101">8</span><span class="op" id="5572102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572106">dst</span><span class="op" id="5572109">.</span><span class="ident" id="5572110">Pix</span><span class="op" id="5572113">[</span><span class="ident" id="5572114">i</span><span class="op" id="5572115">+</span><span class="num" id="5572116">2</span><span class="op" id="5572117">]</span>&nbsp;<span class="op" id="5572119">=</span>&nbsp;<span class="builtintype" id="5572121">uint8</span><span class="op" id="5572126">(</span><span class="ident" id="5572127">sb</span>&nbsp;<span class="op" id="5572130">&gt;&gt;</span>&nbsp;<span class="num" id="5572133">8</span><span class="op" id="5572134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572138">dst</span><span class="op" id="5572141">.</span><span class="ident" id="5572142">Pix</span><span class="op" id="5572145">[</span><span class="ident" id="5572146">i</span><span class="op" id="5572147">+</span><span class="num" id="5572148">3</span><span class="op" id="5572149">]</span>&nbsp;<span class="op" id="5572151">=</span>&nbsp;<span class="builtintype" id="5572153">uint8</span><span class="op" id="5572158">(</span><span class="ident" id="5572159">sa</span>&nbsp;<span class="op" id="5572162">&gt;&gt;</span>&nbsp;<span class="num" id="5572165">8</span><span class="op" id="5572166">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5572169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572172">firstRow</span>&nbsp;<span class="op" id="5572181">:=</span>&nbsp;<span class="ident" id="5572184">dst</span><span class="op" id="5572187">.</span><span class="ident" id="5572188">Pix</span><span class="op" id="5572191">[</span><span class="ident" id="5572192">i0</span><span class="op" id="5572194">:</span><span class="ident" id="5572195">i1</span><span class="op" id="5572197">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5572200">for</span>&nbsp;<span class="ident" id="5572204">y</span>&nbsp;<span class="op" id="5572206">:=</span>&nbsp;<span class="ident" id="5572209">r</span><span class="op" id="5572210">.</span><span class="ident" id="5572211">Min</span><span class="op" id="5572214">.</span><span class="ident" id="5572215">Y</span>&nbsp;<span class="op" id="5572217">+</span>&nbsp;<span class="num" id="5572219">1</span><span class="op" id="5572220">;</span>&nbsp;<span class="ident" id="5572222">y</span>&nbsp;<span class="op" id="5572224">&lt;</span>&nbsp;<span class="ident" id="5572226">r</span><span class="op" id="5572227">.</span><span class="ident" id="5572228">Max</span><span class="op" id="5572231">.</span><span class="ident" id="5572232">Y</span><span class="op" id="5572233">;</span>&nbsp;<span class="ident" id="5572235">y</span><span class="op" id="5572236">++</span>&nbsp;<span class="op" id="5572239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572243">i0</span>&nbsp;<span class="op" id="5572246">+=</span>&nbsp;<span class="ident" id="5572249">dst</span><span class="op" id="5572252">.</span><span class="ident" id="5572253">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572262">i1</span>&nbsp;<span class="op" id="5572265">+=</span>&nbsp;<span class="ident" id="5572268">dst</span><span class="op" id="5572271">.</span><span class="ident" id="5572272">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5572281">copy</span><span class="op" id="5572285">(</span><span class="ident" id="5572286">dst</span><span class="op" id="5572289">.</span><span class="ident" id="5572290">Pix</span><span class="op" id="5572293">[</span><span class="ident" id="5572294">i0</span><span class="op" id="5572296">:</span><span class="ident" id="5572297">i1</span><span class="op" id="5572299">]</span><span class="op" id="5572300">,</span>&nbsp;<span class="ident" id="5572302">firstRow</span><span class="op" id="5572310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5572313">}</span><br>
<span class="lineno"></span><span class="op" id="5572315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5572318">func</span>&nbsp;<span class="ident" id="5572323">drawCopyOver</span><span class="op" id="5572335">(</span><span class="ident" id="5572336">dst</span>&nbsp;<span class="op" id="5572340">*</span><span class="ident" id="5572341">image</span><span class="op" id="5572346">.</span><span class="ident" id="5572347">RGBA</span><span class="op" id="5572351">,</span>&nbsp;<span class="ident" id="5572353">r</span>&nbsp;<span class="ident" id="5572355">image</span><span class="op" id="5572360">.</span><span class="ident" id="5572361">Rectangle</span><span class="op" id="5572370">,</span>&nbsp;<span class="ident" id="5572372">src</span>&nbsp;<span class="op" id="5572376">*</span><span class="ident" id="5572377">image</span><span class="op" id="5572382">.</span><span class="ident" id="5572383">RGBA</span><span class="op" id="5572387">,</span>&nbsp;<span class="ident" id="5572389">sp</span>&nbsp;<span class="ident" id="5572392">image</span><span class="op" id="5572397">.</span><span class="ident" id="5572398">Point</span><span class="op" id="5572403">)</span>&nbsp;<span class="op" id="5572405">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572408">dx</span><span class="op" id="5572410">,</span>&nbsp;<span class="ident" id="5572412">dy</span>&nbsp;<span class="op" id="5572415">:=</span>&nbsp;<span class="ident" id="5572418">r</span><span class="op" id="5572419">.</span><span class="ident" id="5572420">Dx</span><span class="op" id="5572422">(</span><span class="op" id="5572423">)</span><span class="op" id="5572424">,</span>&nbsp;<span class="ident" id="5572426">r</span><span class="op" id="5572427">.</span><span class="ident" id="5572428">Dy</span><span class="op" id="5572430">(</span><span class="op" id="5572431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572434">d0</span>&nbsp;<span class="op" id="5572437">:=</span>&nbsp;<span class="ident" id="5572440">dst</span><span class="op" id="5572443">.</span><span class="ident" id="5572444">PixOffset</span><span class="op" id="5572453">(</span><span class="ident" id="5572454">r</span><span class="op" id="5572455">.</span><span class="ident" id="5572456">Min</span><span class="op" id="5572459">.</span><span class="ident" id="5572460">X</span><span class="op" id="5572461">,</span>&nbsp;<span class="ident" id="5572463">r</span><span class="op" id="5572464">.</span><span class="ident" id="5572465">Min</span><span class="op" id="5572468">.</span><span class="ident" id="5572469">Y</span><span class="op" id="5572470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572473">s0</span>&nbsp;<span class="op" id="5572476">:=</span>&nbsp;<span class="ident" id="5572479">src</span><span class="op" id="5572482">.</span><span class="ident" id="5572483">PixOffset</span><span class="op" id="5572492">(</span><span class="ident" id="5572493">sp</span><span class="op" id="5572495">.</span><span class="ident" id="5572496">X</span><span class="op" id="5572497">,</span>&nbsp;<span class="ident" id="5572499">sp</span><span class="op" id="5572501">.</span><span class="ident" id="5572502">Y</span><span class="op" id="5572503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5572506">var</span>&nbsp;<span class="op" id="5572510">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572514">ddelta</span><span class="op" id="5572520">,</span>&nbsp;<span class="ident" id="5572522">sdelta</span>&nbsp;<span class="builtintype" id="5572529">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572535">i0</span><span class="op" id="5572537">,</span>&nbsp;<span class="ident" id="5572539">i1</span><span class="op" id="5572541">,</span>&nbsp;<span class="ident" id="5572543">idelta</span>&nbsp;<span class="builtintype" id="5572550">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5572555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5572558">if</span>&nbsp;<span class="ident" id="5572561">r</span><span class="op" id="5572562">.</span><span class="ident" id="5572563">Min</span><span class="op" id="5572566">.</span><span class="ident" id="5572567">Y</span>&nbsp;<span class="op" id="5572569">&lt;</span>&nbsp;<span class="ident" id="5572571">sp</span><span class="op" id="5572573">.</span><span class="ident" id="5572574">Y</span>&nbsp;<span class="op" id="5572576">||</span>&nbsp;<span class="ident" id="5572579">r</span><span class="op" id="5572580">.</span><span class="ident" id="5572581">Min</span><span class="op" id="5572584">.</span><span class="ident" id="5572585">Y</span>&nbsp;<span class="op" id="5572587">==</span>&nbsp;<span class="ident" id="5572590">sp</span><span class="op" id="5572592">.</span><span class="ident" id="5572593">Y</span>&nbsp;<span class="op" id="5572595">&amp;&amp;</span>&nbsp;<span class="ident" id="5572598">r</span><span class="op" id="5572599">.</span><span class="ident" id="5572600">Min</span><span class="op" id="5572603">.</span><span class="ident" id="5572604">X</span>&nbsp;<span class="op" id="5572606">&lt;=</span>&nbsp;<span class="ident" id="5572609">sp</span><span class="op" id="5572611">.</span><span class="ident" id="5572612">X</span>&nbsp;<span class="op" id="5572614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572618">ddelta</span>&nbsp;<span class="op" id="5572625">=</span>&nbsp;<span class="ident" id="5572627">dst</span><span class="op" id="5572630">.</span><span class="ident" id="5572631">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572640">sdelta</span>&nbsp;<span class="op" id="5572647">=</span>&nbsp;<span class="ident" id="5572649">src</span><span class="op" id="5572652">.</span><span class="ident" id="5572653">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572662">i0</span><span class="op" id="5572664">,</span>&nbsp;<span class="ident" id="5572666">i1</span><span class="op" id="5572668">,</span>&nbsp;<span class="ident" id="5572670">idelta</span>&nbsp;<span class="op" id="5572677">=</span>&nbsp;<span class="num" id="5572679">0</span><span class="op" id="5572680">,</span>&nbsp;<span class="ident" id="5572682">dx</span><span class="op" id="5572684">*</span><span class="num" id="5572685">4</span><span class="op" id="5572686">,</span>&nbsp;<span class="op" id="5572688">+</span><span class="num" id="5572689">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5572692">}</span>&nbsp;<span class="keyword" id="5572694">else</span>&nbsp;<span class="op" id="5572699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5572703">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5572811">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572911">d0</span>&nbsp;<span class="op" id="5572914">+=</span>&nbsp;<span class="op" id="5572917">(</span><span class="ident" id="5572918">dy</span>&nbsp;<span class="op" id="5572921">-</span>&nbsp;<span class="num" id="5572923">1</span><span class="op" id="5572924">)</span>&nbsp;<span class="op" id="5572926">*</span>&nbsp;<span class="ident" id="5572928">dst</span><span class="op" id="5572931">.</span><span class="ident" id="5572932">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572941">s0</span>&nbsp;<span class="op" id="5572944">+=</span>&nbsp;<span class="op" id="5572947">(</span><span class="ident" id="5572948">dy</span>&nbsp;<span class="op" id="5572951">-</span>&nbsp;<span class="num" id="5572953">1</span><span class="op" id="5572954">)</span>&nbsp;<span class="op" id="5572956">*</span>&nbsp;<span class="ident" id="5572958">src</span><span class="op" id="5572961">.</span><span class="ident" id="5572962">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572971">ddelta</span>&nbsp;<span class="op" id="5572978">=</span>&nbsp;<span class="op" id="5572980">-</span><span class="ident" id="5572981">dst</span><span class="op" id="5572984">.</span><span class="ident" id="5572985">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5572994">sdelta</span>&nbsp;<span class="op" id="5573001">=</span>&nbsp;<span class="op" id="5573003">-</span><span class="ident" id="5573004">src</span><span class="op" id="5573007">.</span><span class="ident" id="5573008">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573017">i0</span><span class="op" id="5573019">,</span>&nbsp;<span class="ident" id="5573021">i1</span><span class="op" id="5573023">,</span>&nbsp;<span class="ident" id="5573025">idelta</span>&nbsp;<span class="op" id="5573032">=</span>&nbsp;<span class="op" id="5573034">(</span><span class="ident" id="5573035">dx</span><span class="op" id="5573037">-</span><span class="num" id="5573038">1</span><span class="op" id="5573039">)</span><span class="op" id="5573040">*</span><span class="num" id="5573041">4</span><span class="op" id="5573042">,</span>&nbsp;<span class="op" id="5573044">-</span><span class="num" id="5573045">4</span><span class="op" id="5573046">,</span>&nbsp;<span class="op" id="5573048">-</span><span class="num" id="5573049">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5573052">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5573055">for</span>&nbsp;<span class="op" id="5573059">;</span>&nbsp;<span class="ident" id="5573061">dy</span>&nbsp;<span class="op" id="5573064">&gt;</span>&nbsp;<span class="num" id="5573066">0</span><span class="op" id="5573067">;</span>&nbsp;<span class="ident" id="5573069">dy</span><span class="op" id="5573071">--</span>&nbsp;<span class="op" id="5573074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573078">dpix</span>&nbsp;<span class="op" id="5573083">:=</span>&nbsp;<span class="ident" id="5573086">dst</span><span class="op" id="5573089">.</span><span class="ident" id="5573090">Pix</span><span class="op" id="5573093">[</span><span class="ident" id="5573094">d0</span><span class="op" id="5573096">:</span><span class="op" id="5573097">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573101">spix</span>&nbsp;<span class="op" id="5573106">:=</span>&nbsp;<span class="ident" id="5573109">src</span><span class="op" id="5573112">.</span><span class="ident" id="5573113">Pix</span><span class="op" id="5573116">[</span><span class="ident" id="5573117">s0</span><span class="op" id="5573119">:</span><span class="op" id="5573120">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5573124">for</span>&nbsp;<span class="ident" id="5573128">i</span>&nbsp;<span class="op" id="5573130">:=</span>&nbsp;<span class="ident" id="5573133">i0</span><span class="op" id="5573135">;</span>&nbsp;<span class="ident" id="5573137">i</span>&nbsp;<span class="op" id="5573139">!=</span>&nbsp;<span class="ident" id="5573142">i1</span><span class="op" id="5573144">;</span>&nbsp;<span class="ident" id="5573146">i</span>&nbsp;<span class="op" id="5573148">+=</span>&nbsp;<span class="ident" id="5573151">idelta</span>&nbsp;<span class="op" id="5573158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573163">sr</span>&nbsp;<span class="op" id="5573166">:=</span>&nbsp;<span class="builtintype" id="5573169">uint32</span><span class="op" id="5573175">(</span><span class="ident" id="5573176">spix</span><span class="op" id="5573180">[</span><span class="ident" id="5573181">i</span><span class="op" id="5573182">+</span><span class="num" id="5573183">0</span><span class="op" id="5573184">]</span><span class="op" id="5573185">)</span>&nbsp;<span class="op" id="5573187">*</span>&nbsp;<span class="num" id="5573189">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573198">sg</span>&nbsp;<span class="op" id="5573201">:=</span>&nbsp;<span class="builtintype" id="5573204">uint32</span><span class="op" id="5573210">(</span><span class="ident" id="5573211">spix</span><span class="op" id="5573215">[</span><span class="ident" id="5573216">i</span><span class="op" id="5573217">+</span><span class="num" id="5573218">1</span><span class="op" id="5573219">]</span><span class="op" id="5573220">)</span>&nbsp;<span class="op" id="5573222">*</span>&nbsp;<span class="num" id="5573224">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573233">sb</span>&nbsp;<span class="op" id="5573236">:=</span>&nbsp;<span class="builtintype" id="5573239">uint32</span><span class="op" id="5573245">(</span><span class="ident" id="5573246">spix</span><span class="op" id="5573250">[</span><span class="ident" id="5573251">i</span><span class="op" id="5573252">+</span><span class="num" id="5573253">2</span><span class="op" id="5573254">]</span><span class="op" id="5573255">)</span>&nbsp;<span class="op" id="5573257">*</span>&nbsp;<span class="num" id="5573259">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573268">sa</span>&nbsp;<span class="op" id="5573271">:=</span>&nbsp;<span class="builtintype" id="5573274">uint32</span><span class="op" id="5573280">(</span><span class="ident" id="5573281">spix</span><span class="op" id="5573285">[</span><span class="ident" id="5573286">i</span><span class="op" id="5573287">+</span><span class="num" id="5573288">3</span><span class="op" id="5573289">]</span><span class="op" id="5573290">)</span>&nbsp;<span class="op" id="5573292">*</span>&nbsp;<span class="num" id="5573294">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573304">dr</span>&nbsp;<span class="op" id="5573307">:=</span>&nbsp;<span class="builtintype" id="5573310">uint32</span><span class="op" id="5573316">(</span><span class="ident" id="5573317">dpix</span><span class="op" id="5573321">[</span><span class="ident" id="5573322">i</span><span class="op" id="5573323">+</span><span class="num" id="5573324">0</span><span class="op" id="5573325">]</span><span class="op" id="5573326">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573331">dg</span>&nbsp;<span class="op" id="5573334">:=</span>&nbsp;<span class="builtintype" id="5573337">uint32</span><span class="op" id="5573343">(</span><span class="ident" id="5573344">dpix</span><span class="op" id="5573348">[</span><span class="ident" id="5573349">i</span><span class="op" id="5573350">+</span><span class="num" id="5573351">1</span><span class="op" id="5573352">]</span><span class="op" id="5573353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573358">db</span>&nbsp;<span class="op" id="5573361">:=</span>&nbsp;<span class="builtintype" id="5573364">uint32</span><span class="op" id="5573370">(</span><span class="ident" id="5573371">dpix</span><span class="op" id="5573375">[</span><span class="ident" id="5573376">i</span><span class="op" id="5573377">+</span><span class="num" id="5573378">2</span><span class="op" id="5573379">]</span><span class="op" id="5573380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573385">da</span>&nbsp;<span class="op" id="5573388">:=</span>&nbsp;<span class="builtintype" id="5573391">uint32</span><span class="op" id="5573397">(</span><span class="ident" id="5573398">dpix</span><span class="op" id="5573402">[</span><span class="ident" id="5573403">i</span><span class="op" id="5573404">+</span><span class="num" id="5573405">3</span><span class="op" id="5573406">]</span><span class="op" id="5573407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5573413">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573473">a</span>&nbsp;<span class="op" id="5573475">:=</span>&nbsp;<span class="op" id="5573478">(</span><span class="ident" id="5573479">m</span>&nbsp;<span class="op" id="5573481">-</span>&nbsp;<span class="ident" id="5573483">sa</span><span class="op" id="5573485">)</span>&nbsp;<span class="op" id="5573487">*</span>&nbsp;<span class="num" id="5573489">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573499">dpix</span><span class="op" id="5573503">[</span><span class="ident" id="5573504">i</span><span class="op" id="5573505">+</span><span class="num" id="5573506">0</span><span class="op" id="5573507">]</span>&nbsp;<span class="op" id="5573509">=</span>&nbsp;<span class="builtintype" id="5573511">uint8</span><span class="op" id="5573516">(</span><span class="op" id="5573517">(</span><span class="ident" id="5573518">dr</span><span class="op" id="5573520">*</span><span class="ident" id="5573521">a</span><span class="op" id="5573522">/</span><span class="ident" id="5573523">m</span>&nbsp;<span class="op" id="5573525">+</span>&nbsp;<span class="ident" id="5573527">sr</span><span class="op" id="5573529">)</span>&nbsp;<span class="op" id="5573531">&gt;&gt;</span>&nbsp;<span class="num" id="5573534">8</span><span class="op" id="5573535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573540">dpix</span><span class="op" id="5573544">[</span><span class="ident" id="5573545">i</span><span class="op" id="5573546">+</span><span class="num" id="5573547">1</span><span class="op" id="5573548">]</span>&nbsp;<span class="op" id="5573550">=</span>&nbsp;<span class="builtintype" id="5573552">uint8</span><span class="op" id="5573557">(</span><span class="op" id="5573558">(</span><span class="ident" id="5573559">dg</span><span class="op" id="5573561">*</span><span class="ident" id="5573562">a</span><span class="op" id="5573563">/</span><span class="ident" id="5573564">m</span>&nbsp;<span class="op" id="5573566">+</span>&nbsp;<span class="ident" id="5573568">sg</span><span class="op" id="5573570">)</span>&nbsp;<span class="op" id="5573572">&gt;&gt;</span>&nbsp;<span class="num" id="5573575">8</span><span class="op" id="5573576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573581">dpix</span><span class="op" id="5573585">[</span><span class="ident" id="5573586">i</span><span class="op" id="5573587">+</span><span class="num" id="5573588">2</span><span class="op" id="5573589">]</span>&nbsp;<span class="op" id="5573591">=</span>&nbsp;<span class="builtintype" id="5573593">uint8</span><span class="op" id="5573598">(</span><span class="op" id="5573599">(</span><span class="ident" id="5573600">db</span><span class="op" id="5573602">*</span><span class="ident" id="5573603">a</span><span class="op" id="5573604">/</span><span class="ident" id="5573605">m</span>&nbsp;<span class="op" id="5573607">+</span>&nbsp;<span class="ident" id="5573609">sb</span><span class="op" id="5573611">)</span>&nbsp;<span class="op" id="5573613">&gt;&gt;</span>&nbsp;<span class="num" id="5573616">8</span><span class="op" id="5573617">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573622">dpix</span><span class="op" id="5573626">[</span><span class="ident" id="5573627">i</span><span class="op" id="5573628">+</span><span class="num" id="5573629">3</span><span class="op" id="5573630">]</span>&nbsp;<span class="op" id="5573632">=</span>&nbsp;<span class="builtintype" id="5573634">uint8</span><span class="op" id="5573639">(</span><span class="op" id="5573640">(</span><span class="ident" id="5573641">da</span><span class="op" id="5573643">*</span><span class="ident" id="5573644">a</span><span class="op" id="5573645">/</span><span class="ident" id="5573646">m</span>&nbsp;<span class="op" id="5573648">+</span>&nbsp;<span class="ident" id="5573650">sa</span><span class="op" id="5573652">)</span>&nbsp;<span class="op" id="5573654">&gt;&gt;</span>&nbsp;<span class="num" id="5573657">8</span><span class="op" id="5573658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5573662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573666">d0</span>&nbsp;<span class="op" id="5573669">+=</span>&nbsp;<span class="ident" id="5573672">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573681">s0</span>&nbsp;<span class="op" id="5573684">+=</span>&nbsp;<span class="ident" id="5573687">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5573695">}</span><br>
<span class="lineno">305</span><span class="op" id="5573697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5573700">func</span>&nbsp;<span class="ident" id="5573705">drawCopySrc</span><span class="op" id="5573716">(</span><span class="ident" id="5573717">dst</span>&nbsp;<span class="op" id="5573721">*</span><span class="ident" id="5573722">image</span><span class="op" id="5573727">.</span><span class="ident" id="5573728">RGBA</span><span class="op" id="5573732">,</span>&nbsp;<span class="ident" id="5573734">r</span>&nbsp;<span class="ident" id="5573736">image</span><span class="op" id="5573741">.</span><span class="ident" id="5573742">Rectangle</span><span class="op" id="5573751">,</span>&nbsp;<span class="ident" id="5573753">src</span>&nbsp;<span class="op" id="5573757">*</span><span class="ident" id="5573758">image</span><span class="op" id="5573763">.</span><span class="ident" id="5573764">RGBA</span><span class="op" id="5573768">,</span>&nbsp;<span class="ident" id="5573770">sp</span>&nbsp;<span class="ident" id="5573773">image</span><span class="op" id="5573778">.</span><span class="ident" id="5573779">Point</span><span class="op" id="5573784">)</span>&nbsp;<span class="op" id="5573786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573789">n</span><span class="op" id="5573790">,</span>&nbsp;<span class="ident" id="5573792">dy</span>&nbsp;<span class="op" id="5573795">:=</span>&nbsp;<span class="num" id="5573798">4</span><span class="op" id="5573799">*</span><span class="ident" id="5573800">r</span><span class="op" id="5573801">.</span><span class="ident" id="5573802">Dx</span><span class="op" id="5573804">(</span><span class="op" id="5573805">)</span><span class="op" id="5573806">,</span>&nbsp;<span class="ident" id="5573808">r</span><span class="op" id="5573809">.</span><span class="ident" id="5573810">Dy</span><span class="op" id="5573812">(</span><span class="op" id="5573813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573816">d0</span>&nbsp;<span class="op" id="5573819">:=</span>&nbsp;<span class="ident" id="5573822">dst</span><span class="op" id="5573825">.</span><span class="ident" id="5573826">PixOffset</span><span class="op" id="5573835">(</span><span class="ident" id="5573836">r</span><span class="op" id="5573837">.</span><span class="ident" id="5573838">Min</span><span class="op" id="5573841">.</span><span class="ident" id="5573842">X</span><span class="op" id="5573843">,</span>&nbsp;<span class="ident" id="5573845">r</span><span class="op" id="5573846">.</span><span class="ident" id="5573847">Min</span><span class="op" id="5573850">.</span><span class="ident" id="5573851">Y</span><span class="op" id="5573852">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573855">s0</span>&nbsp;<span class="op" id="5573858">:=</span>&nbsp;<span class="ident" id="5573861">src</span><span class="op" id="5573864">.</span><span class="ident" id="5573865">PixOffset</span><span class="op" id="5573874">(</span><span class="ident" id="5573875">sp</span><span class="op" id="5573877">.</span><span class="ident" id="5573878">X</span><span class="op" id="5573879">,</span>&nbsp;<span class="ident" id="5573881">sp</span><span class="op" id="5573883">.</span><span class="ident" id="5573884">Y</span><span class="op" id="5573885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5573888">var</span>&nbsp;<span class="ident" id="5573892">ddelta</span><span class="op" id="5573898">,</span>&nbsp;<span class="ident" id="5573900">sdelta</span>&nbsp;<span class="builtintype" id="5573907">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5573912">if</span>&nbsp;<span class="ident" id="5573915">r</span><span class="op" id="5573916">.</span><span class="ident" id="5573917">Min</span><span class="op" id="5573920">.</span><span class="ident" id="5573921">Y</span>&nbsp;<span class="op" id="5573923">&lt;=</span>&nbsp;<span class="ident" id="5573926">sp</span><span class="op" id="5573928">.</span><span class="ident" id="5573929">Y</span>&nbsp;<span class="op" id="5573931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573935">ddelta</span>&nbsp;<span class="op" id="5573942">=</span>&nbsp;<span class="ident" id="5573944">dst</span><span class="op" id="5573947">.</span><span class="ident" id="5573948">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5573957">sdelta</span>&nbsp;<span class="op" id="5573964">=</span>&nbsp;<span class="ident" id="5573966">src</span><span class="op" id="5573969">.</span><span class="ident" id="5573970">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5573978">}</span>&nbsp;<span class="keyword" id="5573980">else</span>&nbsp;<span class="op" id="5573985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5573989">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5574089">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5574185">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574281">d0</span>&nbsp;<span class="op" id="5574284">+=</span>&nbsp;<span class="op" id="5574287">(</span><span class="ident" id="5574288">dy</span>&nbsp;<span class="op" id="5574291">-</span>&nbsp;<span class="num" id="5574293">1</span><span class="op" id="5574294">)</span>&nbsp;<span class="op" id="5574296">*</span>&nbsp;<span class="ident" id="5574298">dst</span><span class="op" id="5574301">.</span><span class="ident" id="5574302">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574311">s0</span>&nbsp;<span class="op" id="5574314">+=</span>&nbsp;<span class="op" id="5574317">(</span><span class="ident" id="5574318">dy</span>&nbsp;<span class="op" id="5574321">-</span>&nbsp;<span class="num" id="5574323">1</span><span class="op" id="5574324">)</span>&nbsp;<span class="op" id="5574326">*</span>&nbsp;<span class="ident" id="5574328">src</span><span class="op" id="5574331">.</span><span class="ident" id="5574332">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574341">ddelta</span>&nbsp;<span class="op" id="5574348">=</span>&nbsp;<span class="op" id="5574350">-</span><span class="ident" id="5574351">dst</span><span class="op" id="5574354">.</span><span class="ident" id="5574355">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574364">sdelta</span>&nbsp;<span class="op" id="5574371">=</span>&nbsp;<span class="op" id="5574373">-</span><span class="ident" id="5574374">src</span><span class="op" id="5574377">.</span><span class="ident" id="5574378">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5574386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5574389">for</span>&nbsp;<span class="op" id="5574393">;</span>&nbsp;<span class="ident" id="5574395">dy</span>&nbsp;<span class="op" id="5574398">&gt;</span>&nbsp;<span class="num" id="5574400">0</span><span class="op" id="5574401">;</span>&nbsp;<span class="ident" id="5574403">dy</span><span class="op" id="5574405">--</span>&nbsp;<span class="op" id="5574408">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5574412">copy</span><span class="op" id="5574416">(</span><span class="ident" id="5574417">dst</span><span class="op" id="5574420">.</span><span class="ident" id="5574421">Pix</span><span class="op" id="5574424">[</span><span class="ident" id="5574425">d0</span><span class="op" id="5574427">:</span><span class="ident" id="5574428">d0</span><span class="op" id="5574430">+</span><span class="ident" id="5574431">n</span><span class="op" id="5574432">]</span><span class="op" id="5574433">,</span>&nbsp;<span class="ident" id="5574435">src</span><span class="op" id="5574438">.</span><span class="ident" id="5574439">Pix</span><span class="op" id="5574442">[</span><span class="ident" id="5574443">s0</span><span class="op" id="5574445">:</span><span class="ident" id="5574446">s0</span><span class="op" id="5574448">+</span><span class="ident" id="5574449">n</span><span class="op" id="5574450">]</span><span class="op" id="5574451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574455">d0</span>&nbsp;<span class="op" id="5574458">+=</span>&nbsp;<span class="ident" id="5574461">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574470">s0</span>&nbsp;<span class="op" id="5574473">+=</span>&nbsp;<span class="ident" id="5574476">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5574484">}</span><br>
<span class="lineno"></span><span class="op" id="5574486">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5574489">func</span>&nbsp;<span class="ident" id="5574494">drawNRGBAOver</span><span class="op" id="5574507">(</span><span class="ident" id="5574508">dst</span>&nbsp;<span class="op" id="5574512">*</span><span class="ident" id="5574513">image</span><span class="op" id="5574518">.</span><span class="ident" id="5574519">RGBA</span><span class="op" id="5574523">,</span>&nbsp;<span class="ident" id="5574525">r</span>&nbsp;<span class="ident" id="5574527">image</span><span class="op" id="5574532">.</span><span class="ident" id="5574533">Rectangle</span><span class="op" id="5574542">,</span>&nbsp;<span class="ident" id="5574544">src</span>&nbsp;<span class="op" id="5574548">*</span><span class="ident" id="5574549">image</span><span class="op" id="5574554">.</span><span class="ident" id="5574555">NRGBA</span><span class="op" id="5574560">,</span>&nbsp;<span class="ident" id="5574562">sp</span>&nbsp;<span class="ident" id="5574565">image</span><span class="op" id="5574570">.</span><span class="ident" id="5574571">Point</span><span class="op" id="5574576">)</span>&nbsp;<span class="op" id="5574578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574581">i0</span>&nbsp;<span class="op" id="5574584">:=</span>&nbsp;<span class="op" id="5574587">(</span><span class="ident" id="5574588">r</span><span class="op" id="5574589">.</span><span class="ident" id="5574590">Min</span><span class="op" id="5574593">.</span><span class="ident" id="5574594">X</span>&nbsp;<span class="op" id="5574596">-</span>&nbsp;<span class="ident" id="5574598">dst</span><span class="op" id="5574601">.</span><span class="ident" id="5574602">Rect</span><span class="op" id="5574606">.</span><span class="ident" id="5574607">Min</span><span class="op" id="5574610">.</span><span class="ident" id="5574611">X</span><span class="op" id="5574612">)</span>&nbsp;<span class="op" id="5574614">*</span>&nbsp;<span class="num" id="5574616">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574619">i1</span>&nbsp;<span class="op" id="5574622">:=</span>&nbsp;<span class="op" id="5574625">(</span><span class="ident" id="5574626">r</span><span class="op" id="5574627">.</span><span class="ident" id="5574628">Max</span><span class="op" id="5574631">.</span><span class="ident" id="5574632">X</span>&nbsp;<span class="op" id="5574634">-</span>&nbsp;<span class="ident" id="5574636">dst</span><span class="op" id="5574639">.</span><span class="ident" id="5574640">Rect</span><span class="op" id="5574644">.</span><span class="ident" id="5574645">Min</span><span class="op" id="5574648">.</span><span class="ident" id="5574649">X</span><span class="op" id="5574650">)</span>&nbsp;<span class="op" id="5574652">*</span>&nbsp;<span class="num" id="5574654">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574657">si0</span>&nbsp;<span class="op" id="5574661">:=</span>&nbsp;<span class="op" id="5574664">(</span><span class="ident" id="5574665">sp</span><span class="op" id="5574667">.</span><span class="ident" id="5574668">X</span>&nbsp;<span class="op" id="5574670">-</span>&nbsp;<span class="ident" id="5574672">src</span><span class="op" id="5574675">.</span><span class="ident" id="5574676">Rect</span><span class="op" id="5574680">.</span><span class="ident" id="5574681">Min</span><span class="op" id="5574684">.</span><span class="ident" id="5574685">X</span><span class="op" id="5574686">)</span>&nbsp;<span class="op" id="5574688">*</span>&nbsp;<span class="num" id="5574690">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574693">yMax</span>&nbsp;<span class="op" id="5574698">:=</span>&nbsp;<span class="ident" id="5574701">r</span><span class="op" id="5574702">.</span><span class="ident" id="5574703">Max</span><span class="op" id="5574706">.</span><span class="ident" id="5574707">Y</span>&nbsp;<span class="op" id="5574709">-</span>&nbsp;<span class="ident" id="5574711">dst</span><span class="op" id="5574714">.</span><span class="ident" id="5574715">Rect</span><span class="op" id="5574719">.</span><span class="ident" id="5574720">Min</span><span class="op" id="5574723">.</span><span class="ident" id="5574724">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574728">y</span>&nbsp;<span class="op" id="5574730">:=</span>&nbsp;<span class="ident" id="5574733">r</span><span class="op" id="5574734">.</span><span class="ident" id="5574735">Min</span><span class="op" id="5574738">.</span><span class="ident" id="5574739">Y</span>&nbsp;<span class="op" id="5574741">-</span>&nbsp;<span class="ident" id="5574743">dst</span><span class="op" id="5574746">.</span><span class="ident" id="5574747">Rect</span><span class="op" id="5574751">.</span><span class="ident" id="5574752">Min</span><span class="op" id="5574755">.</span><span class="ident" id="5574756">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574759">sy</span>&nbsp;<span class="op" id="5574762">:=</span>&nbsp;<span class="ident" id="5574765">sp</span><span class="op" id="5574767">.</span><span class="ident" id="5574768">Y</span>&nbsp;<span class="op" id="5574770">-</span>&nbsp;<span class="ident" id="5574772">src</span><span class="op" id="5574775">.</span><span class="ident" id="5574776">Rect</span><span class="op" id="5574780">.</span><span class="ident" id="5574781">Min</span><span class="op" id="5574784">.</span><span class="ident" id="5574785">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5574788">for</span>&nbsp;<span class="op" id="5574792">;</span>&nbsp;<span class="ident" id="5574794">y</span>&nbsp;<span class="op" id="5574796">!=</span>&nbsp;<span class="ident" id="5574799">yMax</span><span class="op" id="5574803">;</span>&nbsp;<span class="ident" id="5574805">y</span><span class="op" id="5574806">,</span>&nbsp;<span class="ident" id="5574808">sy</span>&nbsp;<span class="op" id="5574811">=</span>&nbsp;<span class="ident" id="5574813">y</span><span class="op" id="5574814">+</span><span class="num" id="5574815">1</span><span class="op" id="5574816">,</span>&nbsp;<span class="ident" id="5574818">sy</span><span class="op" id="5574820">+</span><span class="num" id="5574821">1</span>&nbsp;<span class="op" id="5574823">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574827">dpix</span>&nbsp;<span class="op" id="5574832">:=</span>&nbsp;<span class="ident" id="5574835">dst</span><span class="op" id="5574838">.</span><span class="ident" id="5574839">Pix</span><span class="op" id="5574842">[</span><span class="ident" id="5574843">y</span><span class="op" id="5574844">*</span><span class="ident" id="5574845">dst</span><span class="op" id="5574848">.</span><span class="ident" id="5574849">Stride</span><span class="op" id="5574855">:</span><span class="op" id="5574856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5574860">spix</span>&nbsp;<span class="op" id="5574865">:=</span>&nbsp;<span class="ident" id="5574868">src</span><span class="op" id="5574871">.</span><span class="ident" id="5574872">Pix</span><span class="op" id="5574875">[</span><span class="ident" id="5574876">sy</span><span class="op" id="5574878">*</span><span class="ident" id="5574879">src</span><span class="op" id="5574882">.</span><span class="ident" id="5574883">Stride</span><span class="op" id="5574889">:</span><span class="op" id="5574890">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5574895">for</span>&nbsp;<span class="ident" id="5574899">i</span><span class="op" id="5574900">,</span>&nbsp;<span class="ident" id="5574902">si</span>&nbsp;<span class="op" id="5574905">:=</span>&nbsp;<span class="ident" id="5574908">i0</span><span class="op" id="5574910">,</span>&nbsp;<span class="ident" id="5574912">si0</span><span class="op" id="5574915">;</span>&nbsp;<span class="ident" id="5574917">i</span>&nbsp;<span class="op" id="5574919">&lt;</span>&nbsp;<span class="ident" id="5574921">i1</span><span class="op" id="5574923">;</span>&nbsp;<span class="ident" id="5574925">i</span><span class="op" id="5574926">,</span>&nbsp;<span class="ident" id="5574928">si</span>&nbsp;<span class="op" id="5574931">=</span>&nbsp;<span class="ident" id="5574933">i</span><span class="op" id="5574934">+</span><span class="num" id="5574935">4</span><span class="op" id="5574936">,</span>&nbsp;<span class="ident" id="5574938">si</span><span class="op" id="5574940">+</span><span class="num" id="5574941">4</span>&nbsp;<span class="op" id="5574943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5574948">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575016">sa</span>&nbsp;<span class="op" id="5575019">:=</span>&nbsp;<span class="builtintype" id="5575022">uint32</span><span class="op" id="5575028">(</span><span class="ident" id="5575029">spix</span><span class="op" id="5575033">[</span><span class="ident" id="5575034">si</span><span class="op" id="5575036">+</span><span class="num" id="5575037">3</span><span class="op" id="5575038">]</span><span class="op" id="5575039">)</span>&nbsp;<span class="op" id="5575041">*</span>&nbsp;<span class="num" id="5575043">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575052">sr</span>&nbsp;<span class="op" id="5575055">:=</span>&nbsp;<span class="builtintype" id="5575058">uint32</span><span class="op" id="5575064">(</span><span class="ident" id="5575065">spix</span><span class="op" id="5575069">[</span><span class="ident" id="5575070">si</span><span class="op" id="5575072">+</span><span class="num" id="5575073">0</span><span class="op" id="5575074">]</span><span class="op" id="5575075">)</span>&nbsp;<span class="op" id="5575077">*</span>&nbsp;<span class="ident" id="5575079">sa</span>&nbsp;<span class="op" id="5575082">/</span>&nbsp;<span class="num" id="5575084">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575092">sg</span>&nbsp;<span class="op" id="5575095">:=</span>&nbsp;<span class="builtintype" id="5575098">uint32</span><span class="op" id="5575104">(</span><span class="ident" id="5575105">spix</span><span class="op" id="5575109">[</span><span class="ident" id="5575110">si</span><span class="op" id="5575112">+</span><span class="num" id="5575113">1</span><span class="op" id="5575114">]</span><span class="op" id="5575115">)</span>&nbsp;<span class="op" id="5575117">*</span>&nbsp;<span class="ident" id="5575119">sa</span>&nbsp;<span class="op" id="5575122">/</span>&nbsp;<span class="num" id="5575124">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575132">sb</span>&nbsp;<span class="op" id="5575135">:=</span>&nbsp;<span class="builtintype" id="5575138">uint32</span><span class="op" id="5575144">(</span><span class="ident" id="5575145">spix</span><span class="op" id="5575149">[</span><span class="ident" id="5575150">si</span><span class="op" id="5575152">+</span><span class="num" id="5575153">2</span><span class="op" id="5575154">]</span><span class="op" id="5575155">)</span>&nbsp;<span class="op" id="5575157">*</span>&nbsp;<span class="ident" id="5575159">sa</span>&nbsp;<span class="op" id="5575162">/</span>&nbsp;<span class="num" id="5575164">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575173">dr</span>&nbsp;<span class="op" id="5575176">:=</span>&nbsp;<span class="builtintype" id="5575179">uint32</span><span class="op" id="5575185">(</span><span class="ident" id="5575186">dpix</span><span class="op" id="5575190">[</span><span class="ident" id="5575191">i</span><span class="op" id="5575192">+</span><span class="num" id="5575193">0</span><span class="op" id="5575194">]</span><span class="op" id="5575195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575200">dg</span>&nbsp;<span class="op" id="5575203">:=</span>&nbsp;<span class="builtintype" id="5575206">uint32</span><span class="op" id="5575212">(</span><span class="ident" id="5575213">dpix</span><span class="op" id="5575217">[</span><span class="ident" id="5575218">i</span><span class="op" id="5575219">+</span><span class="num" id="5575220">1</span><span class="op" id="5575221">]</span><span class="op" id="5575222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575227">db</span>&nbsp;<span class="op" id="5575230">:=</span>&nbsp;<span class="builtintype" id="5575233">uint32</span><span class="op" id="5575239">(</span><span class="ident" id="5575240">dpix</span><span class="op" id="5575244">[</span><span class="ident" id="5575245">i</span><span class="op" id="5575246">+</span><span class="num" id="5575247">2</span><span class="op" id="5575248">]</span><span class="op" id="5575249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575254">da</span>&nbsp;<span class="op" id="5575257">:=</span>&nbsp;<span class="builtintype" id="5575260">uint32</span><span class="op" id="5575266">(</span><span class="ident" id="5575267">dpix</span><span class="op" id="5575271">[</span><span class="ident" id="5575272">i</span><span class="op" id="5575273">+</span><span class="num" id="5575274">3</span><span class="op" id="5575275">]</span><span class="op" id="5575276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5575282">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575342">a</span>&nbsp;<span class="op" id="5575344">:=</span>&nbsp;<span class="op" id="5575347">(</span><span class="ident" id="5575348">m</span>&nbsp;<span class="op" id="5575350">-</span>&nbsp;<span class="ident" id="5575352">sa</span><span class="op" id="5575354">)</span>&nbsp;<span class="op" id="5575356">*</span>&nbsp;<span class="num" id="5575358">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575368">dpix</span><span class="op" id="5575372">[</span><span class="ident" id="5575373">i</span><span class="op" id="5575374">+</span><span class="num" id="5575375">0</span><span class="op" id="5575376">]</span>&nbsp;<span class="op" id="5575378">=</span>&nbsp;<span class="builtintype" id="5575380">uint8</span><span class="op" id="5575385">(</span><span class="op" id="5575386">(</span><span class="ident" id="5575387">dr</span><span class="op" id="5575389">*</span><span class="ident" id="5575390">a</span><span class="op" id="5575391">/</span><span class="ident" id="5575392">m</span>&nbsp;<span class="op" id="5575394">+</span>&nbsp;<span class="ident" id="5575396">sr</span><span class="op" id="5575398">)</span>&nbsp;<span class="op" id="5575400">&gt;&gt;</span>&nbsp;<span class="num" id="5575403">8</span><span class="op" id="5575404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575409">dpix</span><span class="op" id="5575413">[</span><span class="ident" id="5575414">i</span><span class="op" id="5575415">+</span><span class="num" id="5575416">1</span><span class="op" id="5575417">]</span>&nbsp;<span class="op" id="5575419">=</span>&nbsp;<span class="builtintype" id="5575421">uint8</span><span class="op" id="5575426">(</span><span class="op" id="5575427">(</span><span class="ident" id="5575428">dg</span><span class="op" id="5575430">*</span><span class="ident" id="5575431">a</span><span class="op" id="5575432">/</span><span class="ident" id="5575433">m</span>&nbsp;<span class="op" id="5575435">+</span>&nbsp;<span class="ident" id="5575437">sg</span><span class="op" id="5575439">)</span>&nbsp;<span class="op" id="5575441">&gt;&gt;</span>&nbsp;<span class="num" id="5575444">8</span><span class="op" id="5575445">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575450">dpix</span><span class="op" id="5575454">[</span><span class="ident" id="5575455">i</span><span class="op" id="5575456">+</span><span class="num" id="5575457">2</span><span class="op" id="5575458">]</span>&nbsp;<span class="op" id="5575460">=</span>&nbsp;<span class="builtintype" id="5575462">uint8</span><span class="op" id="5575467">(</span><span class="op" id="5575468">(</span><span class="ident" id="5575469">db</span><span class="op" id="5575471">*</span><span class="ident" id="5575472">a</span><span class="op" id="5575473">/</span><span class="ident" id="5575474">m</span>&nbsp;<span class="op" id="5575476">+</span>&nbsp;<span class="ident" id="5575478">sb</span><span class="op" id="5575480">)</span>&nbsp;<span class="op" id="5575482">&gt;&gt;</span>&nbsp;<span class="num" id="5575485">8</span><span class="op" id="5575486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575491">dpix</span><span class="op" id="5575495">[</span><span class="ident" id="5575496">i</span><span class="op" id="5575497">+</span><span class="num" id="5575498">3</span><span class="op" id="5575499">]</span>&nbsp;<span class="op" id="5575501">=</span>&nbsp;<span class="builtintype" id="5575503">uint8</span><span class="op" id="5575508">(</span><span class="op" id="5575509">(</span><span class="ident" id="5575510">da</span><span class="op" id="5575512">*</span><span class="ident" id="5575513">a</span><span class="op" id="5575514">/</span><span class="ident" id="5575515">m</span>&nbsp;<span class="op" id="5575517">+</span>&nbsp;<span class="ident" id="5575519">sa</span><span class="op" id="5575521">)</span>&nbsp;<span class="op" id="5575523">&gt;&gt;</span>&nbsp;<span class="num" id="5575526">8</span><span class="op" id="5575527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5575531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5575534">}</span><br>
<span class="lineno"></span><span class="op" id="5575536">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5575539">func</span>&nbsp;<span class="ident" id="5575544">drawNRGBASrc</span><span class="op" id="5575556">(</span><span class="ident" id="5575557">dst</span>&nbsp;<span class="op" id="5575561">*</span><span class="ident" id="5575562">image</span><span class="op" id="5575567">.</span><span class="ident" id="5575568">RGBA</span><span class="op" id="5575572">,</span>&nbsp;<span class="ident" id="5575574">r</span>&nbsp;<span class="ident" id="5575576">image</span><span class="op" id="5575581">.</span><span class="ident" id="5575582">Rectangle</span><span class="op" id="5575591">,</span>&nbsp;<span class="ident" id="5575593">src</span>&nbsp;<span class="op" id="5575597">*</span><span class="ident" id="5575598">image</span><span class="op" id="5575603">.</span><span class="ident" id="5575604">NRGBA</span><span class="op" id="5575609">,</span>&nbsp;<span class="ident" id="5575611">sp</span>&nbsp;<span class="ident" id="5575614">image</span><span class="op" id="5575619">.</span><span class="ident" id="5575620">Point</span><span class="op" id="5575625">)</span>&nbsp;<span class="op" id="5575627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575630">i0</span>&nbsp;<span class="op" id="5575633">:=</span>&nbsp;<span class="op" id="5575636">(</span><span class="ident" id="5575637">r</span><span class="op" id="5575638">.</span><span class="ident" id="5575639">Min</span><span class="op" id="5575642">.</span><span class="ident" id="5575643">X</span>&nbsp;<span class="op" id="5575645">-</span>&nbsp;<span class="ident" id="5575647">dst</span><span class="op" id="5575650">.</span><span class="ident" id="5575651">Rect</span><span class="op" id="5575655">.</span><span class="ident" id="5575656">Min</span><span class="op" id="5575659">.</span><span class="ident" id="5575660">X</span><span class="op" id="5575661">)</span>&nbsp;<span class="op" id="5575663">*</span>&nbsp;<span class="num" id="5575665">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575668">i1</span>&nbsp;<span class="op" id="5575671">:=</span>&nbsp;<span class="op" id="5575674">(</span><span class="ident" id="5575675">r</span><span class="op" id="5575676">.</span><span class="ident" id="5575677">Max</span><span class="op" id="5575680">.</span><span class="ident" id="5575681">X</span>&nbsp;<span class="op" id="5575683">-</span>&nbsp;<span class="ident" id="5575685">dst</span><span class="op" id="5575688">.</span><span class="ident" id="5575689">Rect</span><span class="op" id="5575693">.</span><span class="ident" id="5575694">Min</span><span class="op" id="5575697">.</span><span class="ident" id="5575698">X</span><span class="op" id="5575699">)</span>&nbsp;<span class="op" id="5575701">*</span>&nbsp;<span class="num" id="5575703">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575706">si0</span>&nbsp;<span class="op" id="5575710">:=</span>&nbsp;<span class="op" id="5575713">(</span><span class="ident" id="5575714">sp</span><span class="op" id="5575716">.</span><span class="ident" id="5575717">X</span>&nbsp;<span class="op" id="5575719">-</span>&nbsp;<span class="ident" id="5575721">src</span><span class="op" id="5575724">.</span><span class="ident" id="5575725">Rect</span><span class="op" id="5575729">.</span><span class="ident" id="5575730">Min</span><span class="op" id="5575733">.</span><span class="ident" id="5575734">X</span><span class="op" id="5575735">)</span>&nbsp;<span class="op" id="5575737">*</span>&nbsp;<span class="num" id="5575739">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575742">yMax</span>&nbsp;<span class="op" id="5575747">:=</span>&nbsp;<span class="ident" id="5575750">r</span><span class="op" id="5575751">.</span><span class="ident" id="5575752">Max</span><span class="op" id="5575755">.</span><span class="ident" id="5575756">Y</span>&nbsp;<span class="op" id="5575758">-</span>&nbsp;<span class="ident" id="5575760">dst</span><span class="op" id="5575763">.</span><span class="ident" id="5575764">Rect</span><span class="op" id="5575768">.</span><span class="ident" id="5575769">Min</span><span class="op" id="5575772">.</span><span class="ident" id="5575773">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575777">y</span>&nbsp;<span class="op" id="5575779">:=</span>&nbsp;<span class="ident" id="5575782">r</span><span class="op" id="5575783">.</span><span class="ident" id="5575784">Min</span><span class="op" id="5575787">.</span><span class="ident" id="5575788">Y</span>&nbsp;<span class="op" id="5575790">-</span>&nbsp;<span class="ident" id="5575792">dst</span><span class="op" id="5575795">.</span><span class="ident" id="5575796">Rect</span><span class="op" id="5575800">.</span><span class="ident" id="5575801">Min</span><span class="op" id="5575804">.</span><span class="ident" id="5575805">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575808">sy</span>&nbsp;<span class="op" id="5575811">:=</span>&nbsp;<span class="ident" id="5575814">sp</span><span class="op" id="5575816">.</span><span class="ident" id="5575817">Y</span>&nbsp;<span class="op" id="5575819">-</span>&nbsp;<span class="ident" id="5575821">src</span><span class="op" id="5575824">.</span><span class="ident" id="5575825">Rect</span><span class="op" id="5575829">.</span><span class="ident" id="5575830">Min</span><span class="op" id="5575833">.</span><span class="ident" id="5575834">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5575837">for</span>&nbsp;<span class="op" id="5575841">;</span>&nbsp;<span class="ident" id="5575843">y</span>&nbsp;<span class="op" id="5575845">!=</span>&nbsp;<span class="ident" id="5575848">yMax</span><span class="op" id="5575852">;</span>&nbsp;<span class="ident" id="5575854">y</span><span class="op" id="5575855">,</span>&nbsp;<span class="ident" id="5575857">sy</span>&nbsp;<span class="op" id="5575860">=</span>&nbsp;<span class="ident" id="5575862">y</span><span class="op" id="5575863">+</span><span class="num" id="5575864">1</span><span class="op" id="5575865">,</span>&nbsp;<span class="ident" id="5575867">sy</span><span class="op" id="5575869">+</span><span class="num" id="5575870">1</span>&nbsp;<span class="op" id="5575872">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575876">dpix</span>&nbsp;<span class="op" id="5575881">:=</span>&nbsp;<span class="ident" id="5575884">dst</span><span class="op" id="5575887">.</span><span class="ident" id="5575888">Pix</span><span class="op" id="5575891">[</span><span class="ident" id="5575892">y</span><span class="op" id="5575893">*</span><span class="ident" id="5575894">dst</span><span class="op" id="5575897">.</span><span class="ident" id="5575898">Stride</span><span class="op" id="5575904">:</span><span class="op" id="5575905">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5575909">spix</span>&nbsp;<span class="op" id="5575914">:=</span>&nbsp;<span class="ident" id="5575917">src</span><span class="op" id="5575920">.</span><span class="ident" id="5575921">Pix</span><span class="op" id="5575924">[</span><span class="ident" id="5575925">sy</span><span class="op" id="5575927">*</span><span class="ident" id="5575928">src</span><span class="op" id="5575931">.</span><span class="ident" id="5575932">Stride</span><span class="op" id="5575938">:</span><span class="op" id="5575939">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5575944">for</span>&nbsp;<span class="ident" id="5575948">i</span><span class="op" id="5575949">,</span>&nbsp;<span class="ident" id="5575951">si</span>&nbsp;<span class="op" id="5575954">:=</span>&nbsp;<span class="ident" id="5575957">i0</span><span class="op" id="5575959">,</span>&nbsp;<span class="ident" id="5575961">si0</span><span class="op" id="5575964">;</span>&nbsp;<span class="ident" id="5575966">i</span>&nbsp;<span class="op" id="5575968">&lt;</span>&nbsp;<span class="ident" id="5575970">i1</span><span class="op" id="5575972">;</span>&nbsp;<span class="ident" id="5575974">i</span><span class="op" id="5575975">,</span>&nbsp;<span class="ident" id="5575977">si</span>&nbsp;<span class="op" id="5575980">=</span>&nbsp;<span class="ident" id="5575982">i</span><span class="op" id="5575983">+</span><span class="num" id="5575984">4</span><span class="op" id="5575985">,</span>&nbsp;<span class="ident" id="5575987">si</span><span class="op" id="5575989">+</span><span class="num" id="5575990">4</span>&nbsp;<span class="op" id="5575992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5575997">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576065">sa</span>&nbsp;<span class="op" id="5576068">:=</span>&nbsp;<span class="builtintype" id="5576071">uint32</span><span class="op" id="5576077">(</span><span class="ident" id="5576078">spix</span><span class="op" id="5576082">[</span><span class="ident" id="5576083">si</span><span class="op" id="5576085">+</span><span class="num" id="5576086">3</span><span class="op" id="5576087">]</span><span class="op" id="5576088">)</span>&nbsp;<span class="op" id="5576090">*</span>&nbsp;<span class="num" id="5576092">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576101">sr</span>&nbsp;<span class="op" id="5576104">:=</span>&nbsp;<span class="builtintype" id="5576107">uint32</span><span class="op" id="5576113">(</span><span class="ident" id="5576114">spix</span><span class="op" id="5576118">[</span><span class="ident" id="5576119">si</span><span class="op" id="5576121">+</span><span class="num" id="5576122">0</span><span class="op" id="5576123">]</span><span class="op" id="5576124">)</span>&nbsp;<span class="op" id="5576126">*</span>&nbsp;<span class="ident" id="5576128">sa</span>&nbsp;<span class="op" id="5576131">/</span>&nbsp;<span class="num" id="5576133">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576141">sg</span>&nbsp;<span class="op" id="5576144">:=</span>&nbsp;<span class="builtintype" id="5576147">uint32</span><span class="op" id="5576153">(</span><span class="ident" id="5576154">spix</span><span class="op" id="5576158">[</span><span class="ident" id="5576159">si</span><span class="op" id="5576161">+</span><span class="num" id="5576162">1</span><span class="op" id="5576163">]</span><span class="op" id="5576164">)</span>&nbsp;<span class="op" id="5576166">*</span>&nbsp;<span class="ident" id="5576168">sa</span>&nbsp;<span class="op" id="5576171">/</span>&nbsp;<span class="num" id="5576173">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576181">sb</span>&nbsp;<span class="op" id="5576184">:=</span>&nbsp;<span class="builtintype" id="5576187">uint32</span><span class="op" id="5576193">(</span><span class="ident" id="5576194">spix</span><span class="op" id="5576198">[</span><span class="ident" id="5576199">si</span><span class="op" id="5576201">+</span><span class="num" id="5576202">2</span><span class="op" id="5576203">]</span><span class="op" id="5576204">)</span>&nbsp;<span class="op" id="5576206">*</span>&nbsp;<span class="ident" id="5576208">sa</span>&nbsp;<span class="op" id="5576211">/</span>&nbsp;<span class="num" id="5576213">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576222">dpix</span><span class="op" id="5576226">[</span><span class="ident" id="5576227">i</span><span class="op" id="5576228">+</span><span class="num" id="5576229">0</span><span class="op" id="5576230">]</span>&nbsp;<span class="op" id="5576232">=</span>&nbsp;<span class="builtintype" id="5576234">uint8</span><span class="op" id="5576239">(</span><span class="ident" id="5576240">sr</span>&nbsp;<span class="op" id="5576243">&gt;&gt;</span>&nbsp;<span class="num" id="5576246">8</span><span class="op" id="5576247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576252">dpix</span><span class="op" id="5576256">[</span><span class="ident" id="5576257">i</span><span class="op" id="5576258">+</span><span class="num" id="5576259">1</span><span class="op" id="5576260">]</span>&nbsp;<span class="op" id="5576262">=</span>&nbsp;<span class="builtintype" id="5576264">uint8</span><span class="op" id="5576269">(</span><span class="ident" id="5576270">sg</span>&nbsp;<span class="op" id="5576273">&gt;&gt;</span>&nbsp;<span class="num" id="5576276">8</span><span class="op" id="5576277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576282">dpix</span><span class="op" id="5576286">[</span><span class="ident" id="5576287">i</span><span class="op" id="5576288">+</span><span class="num" id="5576289">2</span><span class="op" id="5576290">]</span>&nbsp;<span class="op" id="5576292">=</span>&nbsp;<span class="builtintype" id="5576294">uint8</span><span class="op" id="5576299">(</span><span class="ident" id="5576300">sb</span>&nbsp;<span class="op" id="5576303">&gt;&gt;</span>&nbsp;<span class="num" id="5576306">8</span><span class="op" id="5576307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576312">dpix</span><span class="op" id="5576316">[</span><span class="ident" id="5576317">i</span><span class="op" id="5576318">+</span><span class="num" id="5576319">3</span><span class="op" id="5576320">]</span>&nbsp;<span class="op" id="5576322">=</span>&nbsp;<span class="builtintype" id="5576324">uint8</span><span class="op" id="5576329">(</span><span class="ident" id="5576330">sa</span>&nbsp;<span class="op" id="5576333">&gt;&gt;</span>&nbsp;<span class="num" id="5576336">8</span><span class="op" id="5576337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5576341">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5576344">}</span><br>
<span class="lineno"></span><span class="op" id="5576346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5576349">func</span>&nbsp;<span class="ident" id="5576354">drawYCbCr</span><span class="op" id="5576363">(</span><span class="ident" id="5576364">dst</span>&nbsp;<span class="op" id="5576368">*</span><span class="ident" id="5576369">image</span><span class="op" id="5576374">.</span><span class="ident" id="5576375">RGBA</span><span class="op" id="5576379">,</span>&nbsp;<span class="ident" id="5576381">r</span>&nbsp;<span class="ident" id="5576383">image</span><span class="op" id="5576388">.</span><span class="ident" id="5576389">Rectangle</span><span class="op" id="5576398">,</span>&nbsp;<span class="ident" id="5576400">src</span>&nbsp;<span class="op" id="5576404">*</span><span class="ident" id="5576405">image</span><span class="op" id="5576410">.</span><span class="ident" id="5576411">YCbCr</span><span class="op" id="5576416">,</span>&nbsp;<span class="ident" id="5576418">sp</span>&nbsp;<span class="ident" id="5576421">image</span><span class="op" id="5576426">.</span><span class="ident" id="5576427">Point</span><span class="op" id="5576432">)</span>&nbsp;<span class="op" id="5576434">(</span><span class="ident" id="5576435">ok</span>&nbsp;<span class="builtintype" id="5576438">bool</span><span class="op" id="5576442">)</span>&nbsp;<span class="op" id="5576444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5576447">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5576527">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576590">x0</span>&nbsp;<span class="op" id="5576593">:=</span>&nbsp;<span class="op" id="5576596">(</span><span class="ident" id="5576597">r</span><span class="op" id="5576598">.</span><span class="ident" id="5576599">Min</span><span class="op" id="5576602">.</span><span class="ident" id="5576603">X</span>&nbsp;<span class="op" id="5576605">-</span>&nbsp;<span class="ident" id="5576607">dst</span><span class="op" id="5576610">.</span><span class="ident" id="5576611">Rect</span><span class="op" id="5576615">.</span><span class="ident" id="5576616">Min</span><span class="op" id="5576619">.</span><span class="ident" id="5576620">X</span><span class="op" id="5576621">)</span>&nbsp;<span class="op" id="5576623">*</span>&nbsp;<span class="num" id="5576625">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576628">x1</span>&nbsp;<span class="op" id="5576631">:=</span>&nbsp;<span class="op" id="5576634">(</span><span class="ident" id="5576635">r</span><span class="op" id="5576636">.</span><span class="ident" id="5576637">Max</span><span class="op" id="5576640">.</span><span class="ident" id="5576641">X</span>&nbsp;<span class="op" id="5576643">-</span>&nbsp;<span class="ident" id="5576645">dst</span><span class="op" id="5576648">.</span><span class="ident" id="5576649">Rect</span><span class="op" id="5576653">.</span><span class="ident" id="5576654">Min</span><span class="op" id="5576657">.</span><span class="ident" id="5576658">X</span><span class="op" id="5576659">)</span>&nbsp;<span class="op" id="5576661">*</span>&nbsp;<span class="num" id="5576663">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576666">y0</span>&nbsp;<span class="op" id="5576669">:=</span>&nbsp;<span class="ident" id="5576672">r</span><span class="op" id="5576673">.</span><span class="ident" id="5576674">Min</span><span class="op" id="5576677">.</span><span class="ident" id="5576678">Y</span>&nbsp;<span class="op" id="5576680">-</span>&nbsp;<span class="ident" id="5576682">dst</span><span class="op" id="5576685">.</span><span class="ident" id="5576686">Rect</span><span class="op" id="5576690">.</span><span class="ident" id="5576691">Min</span><span class="op" id="5576694">.</span><span class="ident" id="5576695">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576698">y1</span>&nbsp;<span class="op" id="5576701">:=</span>&nbsp;<span class="ident" id="5576704">r</span><span class="op" id="5576705">.</span><span class="ident" id="5576706">Max</span><span class="op" id="5576709">.</span><span class="ident" id="5576710">Y</span>&nbsp;<span class="op" id="5576712">-</span>&nbsp;<span class="ident" id="5576714">dst</span><span class="op" id="5576717">.</span><span class="ident" id="5576718">Rect</span><span class="op" id="5576722">.</span><span class="ident" id="5576723">Min</span><span class="op" id="5576726">.</span><span class="ident" id="5576727">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5576730">switch</span>&nbsp;<span class="ident" id="5576737">src</span><span class="op" id="5576740">.</span><span class="ident" id="5576741">SubsampleRatio</span>&nbsp;<span class="op" id="5576756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5576759">case</span>&nbsp;<span class="ident" id="5576764">image</span><span class="op" id="5576769">.</span><span class="ident" id="5576770">YCbCrSubsampleRatio444</span><span class="op" id="5576792">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5576796">for</span>&nbsp;<span class="ident" id="5576800">y</span><span class="op" id="5576801">,</span>&nbsp;<span class="ident" id="5576803">sy</span>&nbsp;<span class="op" id="5576806">:=</span>&nbsp;<span class="ident" id="5576809">y0</span><span class="op" id="5576811">,</span>&nbsp;<span class="ident" id="5576813">sp</span><span class="op" id="5576815">.</span><span class="ident" id="5576816">Y</span><span class="op" id="5576817">;</span>&nbsp;<span class="ident" id="5576819">y</span>&nbsp;<span class="op" id="5576821">!=</span>&nbsp;<span class="ident" id="5576824">y1</span><span class="op" id="5576826">;</span>&nbsp;<span class="ident" id="5576828">y</span><span class="op" id="5576829">,</span>&nbsp;<span class="ident" id="5576831">sy</span>&nbsp;<span class="op" id="5576834">=</span>&nbsp;<span class="ident" id="5576836">y</span><span class="op" id="5576837">+</span><span class="num" id="5576838">1</span><span class="op" id="5576839">,</span>&nbsp;<span class="ident" id="5576841">sy</span><span class="op" id="5576843">+</span><span class="num" id="5576844">1</span>&nbsp;<span class="op" id="5576846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576851">dpix</span>&nbsp;<span class="op" id="5576856">:=</span>&nbsp;<span class="ident" id="5576859">dst</span><span class="op" id="5576862">.</span><span class="ident" id="5576863">Pix</span><span class="op" id="5576866">[</span><span class="ident" id="5576867">y</span><span class="op" id="5576868">*</span><span class="ident" id="5576869">dst</span><span class="op" id="5576872">.</span><span class="ident" id="5576873">Stride</span><span class="op" id="5576879">:</span><span class="op" id="5576880">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576885">yi</span>&nbsp;<span class="op" id="5576888">:=</span>&nbsp;<span class="op" id="5576891">(</span><span class="ident" id="5576892">sy</span><span class="op" id="5576894">-</span><span class="ident" id="5576895">src</span><span class="op" id="5576898">.</span><span class="ident" id="5576899">Rect</span><span class="op" id="5576903">.</span><span class="ident" id="5576904">Min</span><span class="op" id="5576907">.</span><span class="ident" id="5576908">Y</span><span class="op" id="5576909">)</span><span class="op" id="5576910">*</span><span class="ident" id="5576911">src</span><span class="op" id="5576914">.</span><span class="ident" id="5576915">YStride</span>&nbsp;<span class="op" id="5576923">+</span>&nbsp;<span class="op" id="5576925">(</span><span class="ident" id="5576926">sp</span><span class="op" id="5576928">.</span><span class="ident" id="5576929">X</span>&nbsp;<span class="op" id="5576931">-</span>&nbsp;<span class="ident" id="5576933">src</span><span class="op" id="5576936">.</span><span class="ident" id="5576937">Rect</span><span class="op" id="5576941">.</span><span class="ident" id="5576942">Min</span><span class="op" id="5576945">.</span><span class="ident" id="5576946">X</span><span class="op" id="5576947">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5576952">ci</span>&nbsp;<span class="op" id="5576955">:=</span>&nbsp;<span class="op" id="5576958">(</span><span class="ident" id="5576959">sy</span><span class="op" id="5576961">-</span><span class="ident" id="5576962">src</span><span class="op" id="5576965">.</span><span class="ident" id="5576966">Rect</span><span class="op" id="5576970">.</span><span class="ident" id="5576971">Min</span><span class="op" id="5576974">.</span><span class="ident" id="5576975">Y</span><span class="op" id="5576976">)</span><span class="op" id="5576977">*</span><span class="ident" id="5576978">src</span><span class="op" id="5576981">.</span><span class="ident" id="5576982">CStride</span>&nbsp;<span class="op" id="5576990">+</span>&nbsp;<span class="op" id="5576992">(</span><span class="ident" id="5576993">sp</span><span class="op" id="5576995">.</span><span class="ident" id="5576996">X</span>&nbsp;<span class="op" id="5576998">-</span>&nbsp;<span class="ident" id="5577000">src</span><span class="op" id="5577003">.</span><span class="ident" id="5577004">Rect</span><span class="op" id="5577008">.</span><span class="ident" id="5577009">Min</span><span class="op" id="5577012">.</span><span class="ident" id="5577013">X</span><span class="op" id="5577014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577019">for</span>&nbsp;<span class="ident" id="5577023">x</span>&nbsp;<span class="op" id="5577025">:=</span>&nbsp;<span class="ident" id="5577028">x0</span><span class="op" id="5577030">;</span>&nbsp;<span class="ident" id="5577032">x</span>&nbsp;<span class="op" id="5577034">!=</span>&nbsp;<span class="ident" id="5577037">x1</span><span class="op" id="5577039">;</span>&nbsp;<span class="ident" id="5577041">x</span><span class="op" id="5577042">,</span>&nbsp;<span class="ident" id="5577044">yi</span><span class="op" id="5577046">,</span>&nbsp;<span class="ident" id="5577048">ci</span>&nbsp;<span class="op" id="5577051">=</span>&nbsp;<span class="ident" id="5577053">x</span><span class="op" id="5577054">+</span><span class="num" id="5577055">4</span><span class="op" id="5577056">,</span>&nbsp;<span class="ident" id="5577058">yi</span><span class="op" id="5577060">+</span><span class="num" id="5577061">1</span><span class="op" id="5577062">,</span>&nbsp;<span class="ident" id="5577064">ci</span><span class="op" id="5577066">+</span><span class="num" id="5577067">1</span>&nbsp;<span class="op" id="5577069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577075">rr</span><span class="op" id="5577077">,</span>&nbsp;<span class="ident" id="5577079">gg</span><span class="op" id="5577081">,</span>&nbsp;<span class="ident" id="5577083">bb</span>&nbsp;<span class="op" id="5577086">:=</span>&nbsp;<span class="ident" id="5577089">color</span><span class="op" id="5577094">.</span><span class="ident" id="5577095">YCbCrToRGB</span><span class="op" id="5577105">(</span><span class="ident" id="5577106">src</span><span class="op" id="5577109">.</span><span class="ident" id="5577110">Y</span><span class="op" id="5577111">[</span><span class="ident" id="5577112">yi</span><span class="op" id="5577114">]</span><span class="op" id="5577115">,</span>&nbsp;<span class="ident" id="5577117">src</span><span class="op" id="5577120">.</span><span class="ident" id="5577121">Cb</span><span class="op" id="5577123">[</span><span class="ident" id="5577124">ci</span><span class="op" id="5577126">]</span><span class="op" id="5577127">,</span>&nbsp;<span class="ident" id="5577129">src</span><span class="op" id="5577132">.</span><span class="ident" id="5577133">Cr</span><span class="op" id="5577135">[</span><span class="ident" id="5577136">ci</span><span class="op" id="5577138">]</span><span class="op" id="5577139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577145">dpix</span><span class="op" id="5577149">[</span><span class="ident" id="5577150">x</span><span class="op" id="5577151">+</span><span class="num" id="5577152">0</span><span class="op" id="5577153">]</span>&nbsp;<span class="op" id="5577155">=</span>&nbsp;<span class="ident" id="5577157">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577164">dpix</span><span class="op" id="5577168">[</span><span class="ident" id="5577169">x</span><span class="op" id="5577170">+</span><span class="num" id="5577171">1</span><span class="op" id="5577172">]</span>&nbsp;<span class="op" id="5577174">=</span>&nbsp;<span class="ident" id="5577176">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577183">dpix</span><span class="op" id="5577187">[</span><span class="ident" id="5577188">x</span><span class="op" id="5577189">+</span><span class="num" id="5577190">2</span><span class="op" id="5577191">]</span>&nbsp;<span class="op" id="5577193">=</span>&nbsp;<span class="ident" id="5577195">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577202">dpix</span><span class="op" id="5577206">[</span><span class="ident" id="5577207">x</span><span class="op" id="5577208">+</span><span class="num" id="5577209">3</span><span class="op" id="5577210">]</span>&nbsp;<span class="op" id="5577212">=</span>&nbsp;<span class="num" id="5577214">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5577221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5577225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577228">case</span>&nbsp;<span class="ident" id="5577233">image</span><span class="op" id="5577238">.</span><span class="ident" id="5577239">YCbCrSubsampleRatio422</span><span class="op" id="5577261">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577265">for</span>&nbsp;<span class="ident" id="5577269">y</span><span class="op" id="5577270">,</span>&nbsp;<span class="ident" id="5577272">sy</span>&nbsp;<span class="op" id="5577275">:=</span>&nbsp;<span class="ident" id="5577278">y0</span><span class="op" id="5577280">,</span>&nbsp;<span class="ident" id="5577282">sp</span><span class="op" id="5577284">.</span><span class="ident" id="5577285">Y</span><span class="op" id="5577286">;</span>&nbsp;<span class="ident" id="5577288">y</span>&nbsp;<span class="op" id="5577290">!=</span>&nbsp;<span class="ident" id="5577293">y1</span><span class="op" id="5577295">;</span>&nbsp;<span class="ident" id="5577297">y</span><span class="op" id="5577298">,</span>&nbsp;<span class="ident" id="5577300">sy</span>&nbsp;<span class="op" id="5577303">=</span>&nbsp;<span class="ident" id="5577305">y</span><span class="op" id="5577306">+</span><span class="num" id="5577307">1</span><span class="op" id="5577308">,</span>&nbsp;<span class="ident" id="5577310">sy</span><span class="op" id="5577312">+</span><span class="num" id="5577313">1</span>&nbsp;<span class="op" id="5577315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577320">dpix</span>&nbsp;<span class="op" id="5577325">:=</span>&nbsp;<span class="ident" id="5577328">dst</span><span class="op" id="5577331">.</span><span class="ident" id="5577332">Pix</span><span class="op" id="5577335">[</span><span class="ident" id="5577336">y</span><span class="op" id="5577337">*</span><span class="ident" id="5577338">dst</span><span class="op" id="5577341">.</span><span class="ident" id="5577342">Stride</span><span class="op" id="5577348">:</span><span class="op" id="5577349">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577354">yi</span>&nbsp;<span class="op" id="5577357">:=</span>&nbsp;<span class="op" id="5577360">(</span><span class="ident" id="5577361">sy</span><span class="op" id="5577363">-</span><span class="ident" id="5577364">src</span><span class="op" id="5577367">.</span><span class="ident" id="5577368">Rect</span><span class="op" id="5577372">.</span><span class="ident" id="5577373">Min</span><span class="op" id="5577376">.</span><span class="ident" id="5577377">Y</span><span class="op" id="5577378">)</span><span class="op" id="5577379">*</span><span class="ident" id="5577380">src</span><span class="op" id="5577383">.</span><span class="ident" id="5577384">YStride</span>&nbsp;<span class="op" id="5577392">+</span>&nbsp;<span class="op" id="5577394">(</span><span class="ident" id="5577395">sp</span><span class="op" id="5577397">.</span><span class="ident" id="5577398">X</span>&nbsp;<span class="op" id="5577400">-</span>&nbsp;<span class="ident" id="5577402">src</span><span class="op" id="5577405">.</span><span class="ident" id="5577406">Rect</span><span class="op" id="5577410">.</span><span class="ident" id="5577411">Min</span><span class="op" id="5577414">.</span><span class="ident" id="5577415">X</span><span class="op" id="5577416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577421">ciBase</span>&nbsp;<span class="op" id="5577428">:=</span>&nbsp;<span class="op" id="5577431">(</span><span class="ident" id="5577432">sy</span><span class="op" id="5577434">-</span><span class="ident" id="5577435">src</span><span class="op" id="5577438">.</span><span class="ident" id="5577439">Rect</span><span class="op" id="5577443">.</span><span class="ident" id="5577444">Min</span><span class="op" id="5577447">.</span><span class="ident" id="5577448">Y</span><span class="op" id="5577449">)</span><span class="op" id="5577450">*</span><span class="ident" id="5577451">src</span><span class="op" id="5577454">.</span><span class="ident" id="5577455">CStride</span>&nbsp;<span class="op" id="5577463">-</span>&nbsp;<span class="ident" id="5577465">src</span><span class="op" id="5577468">.</span><span class="ident" id="5577469">Rect</span><span class="op" id="5577473">.</span><span class="ident" id="5577474">Min</span><span class="op" id="5577477">.</span><span class="ident" id="5577478">X</span><span class="op" id="5577479">/</span><span class="num" id="5577480">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577485">for</span>&nbsp;<span class="ident" id="5577489">x</span><span class="op" id="5577490">,</span>&nbsp;<span class="ident" id="5577492">sx</span>&nbsp;<span class="op" id="5577495">:=</span>&nbsp;<span class="ident" id="5577498">x0</span><span class="op" id="5577500">,</span>&nbsp;<span class="ident" id="5577502">sp</span><span class="op" id="5577504">.</span><span class="ident" id="5577505">X</span><span class="op" id="5577506">;</span>&nbsp;<span class="ident" id="5577508">x</span>&nbsp;<span class="op" id="5577510">!=</span>&nbsp;<span class="ident" id="5577513">x1</span><span class="op" id="5577515">;</span>&nbsp;<span class="ident" id="5577517">x</span><span class="op" id="5577518">,</span>&nbsp;<span class="ident" id="5577520">sx</span><span class="op" id="5577522">,</span>&nbsp;<span class="ident" id="5577524">yi</span>&nbsp;<span class="op" id="5577527">=</span>&nbsp;<span class="ident" id="5577529">x</span><span class="op" id="5577530">+</span><span class="num" id="5577531">4</span><span class="op" id="5577532">,</span>&nbsp;<span class="ident" id="5577534">sx</span><span class="op" id="5577536">+</span><span class="num" id="5577537">1</span><span class="op" id="5577538">,</span>&nbsp;<span class="ident" id="5577540">yi</span><span class="op" id="5577542">+</span><span class="num" id="5577543">1</span>&nbsp;<span class="op" id="5577545">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577551">ci</span>&nbsp;<span class="op" id="5577554">:=</span>&nbsp;<span class="ident" id="5577557">ciBase</span>&nbsp;<span class="op" id="5577564">+</span>&nbsp;<span class="ident" id="5577566">sx</span><span class="op" id="5577568">/</span><span class="num" id="5577569">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577575">rr</span><span class="op" id="5577577">,</span>&nbsp;<span class="ident" id="5577579">gg</span><span class="op" id="5577581">,</span>&nbsp;<span class="ident" id="5577583">bb</span>&nbsp;<span class="op" id="5577586">:=</span>&nbsp;<span class="ident" id="5577589">color</span><span class="op" id="5577594">.</span><span class="ident" id="5577595">YCbCrToRGB</span><span class="op" id="5577605">(</span><span class="ident" id="5577606">src</span><span class="op" id="5577609">.</span><span class="ident" id="5577610">Y</span><span class="op" id="5577611">[</span><span class="ident" id="5577612">yi</span><span class="op" id="5577614">]</span><span class="op" id="5577615">,</span>&nbsp;<span class="ident" id="5577617">src</span><span class="op" id="5577620">.</span><span class="ident" id="5577621">Cb</span><span class="op" id="5577623">[</span><span class="ident" id="5577624">ci</span><span class="op" id="5577626">]</span><span class="op" id="5577627">,</span>&nbsp;<span class="ident" id="5577629">src</span><span class="op" id="5577632">.</span><span class="ident" id="5577633">Cr</span><span class="op" id="5577635">[</span><span class="ident" id="5577636">ci</span><span class="op" id="5577638">]</span><span class="op" id="5577639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577645">dpix</span><span class="op" id="5577649">[</span><span class="ident" id="5577650">x</span><span class="op" id="5577651">+</span><span class="num" id="5577652">0</span><span class="op" id="5577653">]</span>&nbsp;<span class="op" id="5577655">=</span>&nbsp;<span class="ident" id="5577657">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577664">dpix</span><span class="op" id="5577668">[</span><span class="ident" id="5577669">x</span><span class="op" id="5577670">+</span><span class="num" id="5577671">1</span><span class="op" id="5577672">]</span>&nbsp;<span class="op" id="5577674">=</span>&nbsp;<span class="ident" id="5577676">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577683">dpix</span><span class="op" id="5577687">[</span><span class="ident" id="5577688">x</span><span class="op" id="5577689">+</span><span class="num" id="5577690">2</span><span class="op" id="5577691">]</span>&nbsp;<span class="op" id="5577693">=</span>&nbsp;<span class="ident" id="5577695">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577702">dpix</span><span class="op" id="5577706">[</span><span class="ident" id="5577707">x</span><span class="op" id="5577708">+</span><span class="num" id="5577709">3</span><span class="op" id="5577710">]</span>&nbsp;<span class="op" id="5577712">=</span>&nbsp;<span class="num" id="5577714">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5577721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5577725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577728">case</span>&nbsp;<span class="ident" id="5577733">image</span><span class="op" id="5577738">.</span><span class="ident" id="5577739">YCbCrSubsampleRatio420</span><span class="op" id="5577761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577765">for</span>&nbsp;<span class="ident" id="5577769">y</span><span class="op" id="5577770">,</span>&nbsp;<span class="ident" id="5577772">sy</span>&nbsp;<span class="op" id="5577775">:=</span>&nbsp;<span class="ident" id="5577778">y0</span><span class="op" id="5577780">,</span>&nbsp;<span class="ident" id="5577782">sp</span><span class="op" id="5577784">.</span><span class="ident" id="5577785">Y</span><span class="op" id="5577786">;</span>&nbsp;<span class="ident" id="5577788">y</span>&nbsp;<span class="op" id="5577790">!=</span>&nbsp;<span class="ident" id="5577793">y1</span><span class="op" id="5577795">;</span>&nbsp;<span class="ident" id="5577797">y</span><span class="op" id="5577798">,</span>&nbsp;<span class="ident" id="5577800">sy</span>&nbsp;<span class="op" id="5577803">=</span>&nbsp;<span class="ident" id="5577805">y</span><span class="op" id="5577806">+</span><span class="num" id="5577807">1</span><span class="op" id="5577808">,</span>&nbsp;<span class="ident" id="5577810">sy</span><span class="op" id="5577812">+</span><span class="num" id="5577813">1</span>&nbsp;<span class="op" id="5577815">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577820">dpix</span>&nbsp;<span class="op" id="5577825">:=</span>&nbsp;<span class="ident" id="5577828">dst</span><span class="op" id="5577831">.</span><span class="ident" id="5577832">Pix</span><span class="op" id="5577835">[</span><span class="ident" id="5577836">y</span><span class="op" id="5577837">*</span><span class="ident" id="5577838">dst</span><span class="op" id="5577841">.</span><span class="ident" id="5577842">Stride</span><span class="op" id="5577848">:</span><span class="op" id="5577849">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577854">yi</span>&nbsp;<span class="op" id="5577857">:=</span>&nbsp;<span class="op" id="5577860">(</span><span class="ident" id="5577861">sy</span><span class="op" id="5577863">-</span><span class="ident" id="5577864">src</span><span class="op" id="5577867">.</span><span class="ident" id="5577868">Rect</span><span class="op" id="5577872">.</span><span class="ident" id="5577873">Min</span><span class="op" id="5577876">.</span><span class="ident" id="5577877">Y</span><span class="op" id="5577878">)</span><span class="op" id="5577879">*</span><span class="ident" id="5577880">src</span><span class="op" id="5577883">.</span><span class="ident" id="5577884">YStride</span>&nbsp;<span class="op" id="5577892">+</span>&nbsp;<span class="op" id="5577894">(</span><span class="ident" id="5577895">sp</span><span class="op" id="5577897">.</span><span class="ident" id="5577898">X</span>&nbsp;<span class="op" id="5577900">-</span>&nbsp;<span class="ident" id="5577902">src</span><span class="op" id="5577905">.</span><span class="ident" id="5577906">Rect</span><span class="op" id="5577910">.</span><span class="ident" id="5577911">Min</span><span class="op" id="5577914">.</span><span class="ident" id="5577915">X</span><span class="op" id="5577916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5577921">ciBase</span>&nbsp;<span class="op" id="5577928">:=</span>&nbsp;<span class="op" id="5577931">(</span><span class="ident" id="5577932">sy</span><span class="op" id="5577934">/</span><span class="num" id="5577935">2</span><span class="op" id="5577936">-</span><span class="ident" id="5577937">src</span><span class="op" id="5577940">.</span><span class="ident" id="5577941">Rect</span><span class="op" id="5577945">.</span><span class="ident" id="5577946">Min</span><span class="op" id="5577949">.</span><span class="ident" id="5577950">Y</span><span class="op" id="5577951">/</span><span class="num" id="5577952">2</span><span class="op" id="5577953">)</span><span class="op" id="5577954">*</span><span class="ident" id="5577955">src</span><span class="op" id="5577958">.</span><span class="ident" id="5577959">CStride</span>&nbsp;<span class="op" id="5577967">-</span>&nbsp;<span class="ident" id="5577969">src</span><span class="op" id="5577972">.</span><span class="ident" id="5577973">Rect</span><span class="op" id="5577977">.</span><span class="ident" id="5577978">Min</span><span class="op" id="5577981">.</span><span class="ident" id="5577982">X</span><span class="op" id="5577983">/</span><span class="num" id="5577984">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5577989">for</span>&nbsp;<span class="ident" id="5577993">x</span><span class="op" id="5577994">,</span>&nbsp;<span class="ident" id="5577996">sx</span>&nbsp;<span class="op" id="5577999">:=</span>&nbsp;<span class="ident" id="5578002">x0</span><span class="op" id="5578004">,</span>&nbsp;<span class="ident" id="5578006">sp</span><span class="op" id="5578008">.</span><span class="ident" id="5578009">X</span><span class="op" id="5578010">;</span>&nbsp;<span class="ident" id="5578012">x</span>&nbsp;<span class="op" id="5578014">!=</span>&nbsp;<span class="ident" id="5578017">x1</span><span class="op" id="5578019">;</span>&nbsp;<span class="ident" id="5578021">x</span><span class="op" id="5578022">,</span>&nbsp;<span class="ident" id="5578024">sx</span><span class="op" id="5578026">,</span>&nbsp;<span class="ident" id="5578028">yi</span>&nbsp;<span class="op" id="5578031">=</span>&nbsp;<span class="ident" id="5578033">x</span><span class="op" id="5578034">+</span><span class="num" id="5578035">4</span><span class="op" id="5578036">,</span>&nbsp;<span class="ident" id="5578038">sx</span><span class="op" id="5578040">+</span><span class="num" id="5578041">1</span><span class="op" id="5578042">,</span>&nbsp;<span class="ident" id="5578044">yi</span><span class="op" id="5578046">+</span><span class="num" id="5578047">1</span>&nbsp;<span class="op" id="5578049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578055">ci</span>&nbsp;<span class="op" id="5578058">:=</span>&nbsp;<span class="ident" id="5578061">ciBase</span>&nbsp;<span class="op" id="5578068">+</span>&nbsp;<span class="ident" id="5578070">sx</span><span class="op" id="5578072">/</span><span class="num" id="5578073">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578079">rr</span><span class="op" id="5578081">,</span>&nbsp;<span class="ident" id="5578083">gg</span><span class="op" id="5578085">,</span>&nbsp;<span class="ident" id="5578087">bb</span>&nbsp;<span class="op" id="5578090">:=</span>&nbsp;<span class="ident" id="5578093">color</span><span class="op" id="5578098">.</span><span class="ident" id="5578099">YCbCrToRGB</span><span class="op" id="5578109">(</span><span class="ident" id="5578110">src</span><span class="op" id="5578113">.</span><span class="ident" id="5578114">Y</span><span class="op" id="5578115">[</span><span class="ident" id="5578116">yi</span><span class="op" id="5578118">]</span><span class="op" id="5578119">,</span>&nbsp;<span class="ident" id="5578121">src</span><span class="op" id="5578124">.</span><span class="ident" id="5578125">Cb</span><span class="op" id="5578127">[</span><span class="ident" id="5578128">ci</span><span class="op" id="5578130">]</span><span class="op" id="5578131">,</span>&nbsp;<span class="ident" id="5578133">src</span><span class="op" id="5578136">.</span><span class="ident" id="5578137">Cr</span><span class="op" id="5578139">[</span><span class="ident" id="5578140">ci</span><span class="op" id="5578142">]</span><span class="op" id="5578143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578149">dpix</span><span class="op" id="5578153">[</span><span class="ident" id="5578154">x</span><span class="op" id="5578155">+</span><span class="num" id="5578156">0</span><span class="op" id="5578157">]</span>&nbsp;<span class="op" id="5578159">=</span>&nbsp;<span class="ident" id="5578161">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578168">dpix</span><span class="op" id="5578172">[</span><span class="ident" id="5578173">x</span><span class="op" id="5578174">+</span><span class="num" id="5578175">1</span><span class="op" id="5578176">]</span>&nbsp;<span class="op" id="5578178">=</span>&nbsp;<span class="ident" id="5578180">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578187">dpix</span><span class="op" id="5578191">[</span><span class="ident" id="5578192">x</span><span class="op" id="5578193">+</span><span class="num" id="5578194">2</span><span class="op" id="5578195">]</span>&nbsp;<span class="op" id="5578197">=</span>&nbsp;<span class="ident" id="5578199">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578206">dpix</span><span class="op" id="5578210">[</span><span class="ident" id="5578211">x</span><span class="op" id="5578212">+</span><span class="num" id="5578213">3</span><span class="op" id="5578214">]</span>&nbsp;<span class="op" id="5578216">=</span>&nbsp;<span class="num" id="5578218">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578232">case</span>&nbsp;<span class="ident" id="5578237">image</span><span class="op" id="5578242">.</span><span class="ident" id="5578243">YCbCrSubsampleRatio440</span><span class="op" id="5578265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578269">for</span>&nbsp;<span class="ident" id="5578273">y</span><span class="op" id="5578274">,</span>&nbsp;<span class="ident" id="5578276">sy</span>&nbsp;<span class="op" id="5578279">:=</span>&nbsp;<span class="ident" id="5578282">y0</span><span class="op" id="5578284">,</span>&nbsp;<span class="ident" id="5578286">sp</span><span class="op" id="5578288">.</span><span class="ident" id="5578289">Y</span><span class="op" id="5578290">;</span>&nbsp;<span class="ident" id="5578292">y</span>&nbsp;<span class="op" id="5578294">!=</span>&nbsp;<span class="ident" id="5578297">y1</span><span class="op" id="5578299">;</span>&nbsp;<span class="ident" id="5578301">y</span><span class="op" id="5578302">,</span>&nbsp;<span class="ident" id="5578304">sy</span>&nbsp;<span class="op" id="5578307">=</span>&nbsp;<span class="ident" id="5578309">y</span><span class="op" id="5578310">+</span><span class="num" id="5578311">1</span><span class="op" id="5578312">,</span>&nbsp;<span class="ident" id="5578314">sy</span><span class="op" id="5578316">+</span><span class="num" id="5578317">1</span>&nbsp;<span class="op" id="5578319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578324">dpix</span>&nbsp;<span class="op" id="5578329">:=</span>&nbsp;<span class="ident" id="5578332">dst</span><span class="op" id="5578335">.</span><span class="ident" id="5578336">Pix</span><span class="op" id="5578339">[</span><span class="ident" id="5578340">y</span><span class="op" id="5578341">*</span><span class="ident" id="5578342">dst</span><span class="op" id="5578345">.</span><span class="ident" id="5578346">Stride</span><span class="op" id="5578352">:</span><span class="op" id="5578353">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578358">yi</span>&nbsp;<span class="op" id="5578361">:=</span>&nbsp;<span class="op" id="5578364">(</span><span class="ident" id="5578365">sy</span><span class="op" id="5578367">-</span><span class="ident" id="5578368">src</span><span class="op" id="5578371">.</span><span class="ident" id="5578372">Rect</span><span class="op" id="5578376">.</span><span class="ident" id="5578377">Min</span><span class="op" id="5578380">.</span><span class="ident" id="5578381">Y</span><span class="op" id="5578382">)</span><span class="op" id="5578383">*</span><span class="ident" id="5578384">src</span><span class="op" id="5578387">.</span><span class="ident" id="5578388">YStride</span>&nbsp;<span class="op" id="5578396">+</span>&nbsp;<span class="op" id="5578398">(</span><span class="ident" id="5578399">sp</span><span class="op" id="5578401">.</span><span class="ident" id="5578402">X</span>&nbsp;<span class="op" id="5578404">-</span>&nbsp;<span class="ident" id="5578406">src</span><span class="op" id="5578409">.</span><span class="ident" id="5578410">Rect</span><span class="op" id="5578414">.</span><span class="ident" id="5578415">Min</span><span class="op" id="5578418">.</span><span class="ident" id="5578419">X</span><span class="op" id="5578420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578425">ci</span>&nbsp;<span class="op" id="5578428">:=</span>&nbsp;<span class="op" id="5578431">(</span><span class="ident" id="5578432">sy</span><span class="op" id="5578434">/</span><span class="num" id="5578435">2</span><span class="op" id="5578436">-</span><span class="ident" id="5578437">src</span><span class="op" id="5578440">.</span><span class="ident" id="5578441">Rect</span><span class="op" id="5578445">.</span><span class="ident" id="5578446">Min</span><span class="op" id="5578449">.</span><span class="ident" id="5578450">Y</span><span class="op" id="5578451">/</span><span class="num" id="5578452">2</span><span class="op" id="5578453">)</span><span class="op" id="5578454">*</span><span class="ident" id="5578455">src</span><span class="op" id="5578458">.</span><span class="ident" id="5578459">CStride</span>&nbsp;<span class="op" id="5578467">+</span>&nbsp;<span class="op" id="5578469">(</span><span class="ident" id="5578470">sp</span><span class="op" id="5578472">.</span><span class="ident" id="5578473">X</span>&nbsp;<span class="op" id="5578475">-</span>&nbsp;<span class="ident" id="5578477">src</span><span class="op" id="5578480">.</span><span class="ident" id="5578481">Rect</span><span class="op" id="5578485">.</span><span class="ident" id="5578486">Min</span><span class="op" id="5578489">.</span><span class="ident" id="5578490">X</span><span class="op" id="5578491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578496">for</span>&nbsp;<span class="ident" id="5578500">x</span>&nbsp;<span class="op" id="5578502">:=</span>&nbsp;<span class="ident" id="5578505">x0</span><span class="op" id="5578507">;</span>&nbsp;<span class="ident" id="5578509">x</span>&nbsp;<span class="op" id="5578511">!=</span>&nbsp;<span class="ident" id="5578514">x1</span><span class="op" id="5578516">;</span>&nbsp;<span class="ident" id="5578518">x</span><span class="op" id="5578519">,</span>&nbsp;<span class="ident" id="5578521">yi</span><span class="op" id="5578523">,</span>&nbsp;<span class="ident" id="5578525">ci</span>&nbsp;<span class="op" id="5578528">=</span>&nbsp;<span class="ident" id="5578530">x</span><span class="op" id="5578531">+</span><span class="num" id="5578532">4</span><span class="op" id="5578533">,</span>&nbsp;<span class="ident" id="5578535">yi</span><span class="op" id="5578537">+</span><span class="num" id="5578538">1</span><span class="op" id="5578539">,</span>&nbsp;<span class="ident" id="5578541">ci</span><span class="op" id="5578543">+</span><span class="num" id="5578544">1</span>&nbsp;<span class="op" id="5578546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578552">rr</span><span class="op" id="5578554">,</span>&nbsp;<span class="ident" id="5578556">gg</span><span class="op" id="5578558">,</span>&nbsp;<span class="ident" id="5578560">bb</span>&nbsp;<span class="op" id="5578563">:=</span>&nbsp;<span class="ident" id="5578566">color</span><span class="op" id="5578571">.</span><span class="ident" id="5578572">YCbCrToRGB</span><span class="op" id="5578582">(</span><span class="ident" id="5578583">src</span><span class="op" id="5578586">.</span><span class="ident" id="5578587">Y</span><span class="op" id="5578588">[</span><span class="ident" id="5578589">yi</span><span class="op" id="5578591">]</span><span class="op" id="5578592">,</span>&nbsp;<span class="ident" id="5578594">src</span><span class="op" id="5578597">.</span><span class="ident" id="5578598">Cb</span><span class="op" id="5578600">[</span><span class="ident" id="5578601">ci</span><span class="op" id="5578603">]</span><span class="op" id="5578604">,</span>&nbsp;<span class="ident" id="5578606">src</span><span class="op" id="5578609">.</span><span class="ident" id="5578610">Cr</span><span class="op" id="5578612">[</span><span class="ident" id="5578613">ci</span><span class="op" id="5578615">]</span><span class="op" id="5578616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578622">dpix</span><span class="op" id="5578626">[</span><span class="ident" id="5578627">x</span><span class="op" id="5578628">+</span><span class="num" id="5578629">0</span><span class="op" id="5578630">]</span>&nbsp;<span class="op" id="5578632">=</span>&nbsp;<span class="ident" id="5578634">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578641">dpix</span><span class="op" id="5578645">[</span><span class="ident" id="5578646">x</span><span class="op" id="5578647">+</span><span class="num" id="5578648">1</span><span class="op" id="5578649">]</span>&nbsp;<span class="op" id="5578651">=</span>&nbsp;<span class="ident" id="5578653">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578660">dpix</span><span class="op" id="5578664">[</span><span class="ident" id="5578665">x</span><span class="op" id="5578666">+</span><span class="num" id="5578667">2</span><span class="op" id="5578668">]</span>&nbsp;<span class="op" id="5578670">=</span>&nbsp;<span class="ident" id="5578672">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578679">dpix</span><span class="op" id="5578683">[</span><span class="ident" id="5578684">x</span><span class="op" id="5578685">+</span><span class="num" id="5578686">3</span><span class="op" id="5578687">]</span>&nbsp;<span class="op" id="5578689">=</span>&nbsp;<span class="num" id="5578691">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578702">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578705">default</span><span class="op" id="5578712">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578716">return</span>&nbsp;<span class="builtintype" id="5578723">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5578730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578733">return</span>&nbsp;<span class="builtintype" id="5578740">true</span><br>
<span class="lineno"></span><span class="op" id="5578745">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5578748">func</span>&nbsp;<span class="ident" id="5578753">drawGlyphOver</span><span class="op" id="5578766">(</span><span class="ident" id="5578767">dst</span>&nbsp;<span class="op" id="5578771">*</span><span class="ident" id="5578772">image</span><span class="op" id="5578777">.</span><span class="ident" id="5578778">RGBA</span><span class="op" id="5578782">,</span>&nbsp;<span class="ident" id="5578784">r</span>&nbsp;<span class="ident" id="5578786">image</span><span class="op" id="5578791">.</span><span class="ident" id="5578792">Rectangle</span><span class="op" id="5578801">,</span>&nbsp;<span class="ident" id="5578803">src</span>&nbsp;<span class="op" id="5578807">*</span><span class="ident" id="5578808">image</span><span class="op" id="5578813">.</span><span class="ident" id="5578814">Uniform</span><span class="op" id="5578821">,</span>&nbsp;<span class="ident" id="5578823">mask</span>&nbsp;<span class="op" id="5578828">*</span><span class="ident" id="5578829">image</span><span class="op" id="5578834">.</span><span class="ident" id="5578835">Alpha</span><span class="op" id="5578840">,</span>&nbsp;<span class="ident" id="5578842">mp</span>&nbsp;<span class="ident" id="5578845">image</span><span class="op" id="5578850">.</span><span class="ident" id="5578851">Point</span><span class="op" id="5578856">)</span>&nbsp;<span class="op" id="5578858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578861">i0</span>&nbsp;<span class="op" id="5578864">:=</span>&nbsp;<span class="ident" id="5578867">dst</span><span class="op" id="5578870">.</span><span class="ident" id="5578871">PixOffset</span><span class="op" id="5578880">(</span><span class="ident" id="5578881">r</span><span class="op" id="5578882">.</span><span class="ident" id="5578883">Min</span><span class="op" id="5578886">.</span><span class="ident" id="5578887">X</span><span class="op" id="5578888">,</span>&nbsp;<span class="ident" id="5578890">r</span><span class="op" id="5578891">.</span><span class="ident" id="5578892">Min</span><span class="op" id="5578895">.</span><span class="ident" id="5578896">Y</span><span class="op" id="5578897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578900">i1</span>&nbsp;<span class="op" id="5578903">:=</span>&nbsp;<span class="ident" id="5578906">i0</span>&nbsp;<span class="op" id="5578909">+</span>&nbsp;<span class="ident" id="5578911">r</span><span class="op" id="5578912">.</span><span class="ident" id="5578913">Dx</span><span class="op" id="5578915">(</span><span class="op" id="5578916">)</span><span class="op" id="5578917">*</span><span class="num" id="5578918">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578921">mi0</span>&nbsp;<span class="op" id="5578925">:=</span>&nbsp;<span class="ident" id="5578928">mask</span><span class="op" id="5578932">.</span><span class="ident" id="5578933">PixOffset</span><span class="op" id="5578942">(</span><span class="ident" id="5578943">mp</span><span class="op" id="5578945">.</span><span class="ident" id="5578946">X</span><span class="op" id="5578947">,</span>&nbsp;<span class="ident" id="5578949">mp</span><span class="op" id="5578951">.</span><span class="ident" id="5578952">Y</span><span class="op" id="5578953">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5578956">sr</span><span class="op" id="5578958">,</span>&nbsp;<span class="ident" id="5578960">sg</span><span class="op" id="5578962">,</span>&nbsp;<span class="ident" id="5578964">sb</span><span class="op" id="5578966">,</span>&nbsp;<span class="ident" id="5578968">sa</span>&nbsp;<span class="op" id="5578971">:=</span>&nbsp;<span class="ident" id="5578974">src</span><span class="op" id="5578977">.</span><span class="ident" id="5578978">RGBA</span><span class="op" id="5578982">(</span><span class="op" id="5578983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5578986">for</span>&nbsp;<span class="ident" id="5578990">y</span><span class="op" id="5578991">,</span>&nbsp;<span class="ident" id="5578993">my</span>&nbsp;<span class="op" id="5578996">:=</span>&nbsp;<span class="ident" id="5578999">r</span><span class="op" id="5579000">.</span><span class="ident" id="5579001">Min</span><span class="op" id="5579004">.</span><span class="ident" id="5579005">Y</span><span class="op" id="5579006">,</span>&nbsp;<span class="ident" id="5579008">mp</span><span class="op" id="5579010">.</span><span class="ident" id="5579011">Y</span><span class="op" id="5579012">;</span>&nbsp;<span class="ident" id="5579014">y</span>&nbsp;<span class="op" id="5579016">!=</span>&nbsp;<span class="ident" id="5579019">r</span><span class="op" id="5579020">.</span><span class="ident" id="5579021">Max</span><span class="op" id="5579024">.</span><span class="ident" id="5579025">Y</span><span class="op" id="5579026">;</span>&nbsp;<span class="ident" id="5579028">y</span><span class="op" id="5579029">,</span>&nbsp;<span class="ident" id="5579031">my</span>&nbsp;<span class="op" id="5579034">=</span>&nbsp;<span class="ident" id="5579036">y</span><span class="op" id="5579037">+</span><span class="num" id="5579038">1</span><span class="op" id="5579039">,</span>&nbsp;<span class="ident" id="5579041">my</span><span class="op" id="5579043">+</span><span class="num" id="5579044">1</span>&nbsp;<span class="op" id="5579046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579050">for</span>&nbsp;<span class="ident" id="5579054">i</span><span class="op" id="5579055">,</span>&nbsp;<span class="ident" id="5579057">mi</span>&nbsp;<span class="op" id="5579060">:=</span>&nbsp;<span class="ident" id="5579063">i0</span><span class="op" id="5579065">,</span>&nbsp;<span class="ident" id="5579067">mi0</span><span class="op" id="5579070">;</span>&nbsp;<span class="ident" id="5579072">i</span>&nbsp;<span class="op" id="5579074">&lt;</span>&nbsp;<span class="ident" id="5579076">i1</span><span class="op" id="5579078">;</span>&nbsp;<span class="ident" id="5579080">i</span><span class="op" id="5579081">,</span>&nbsp;<span class="ident" id="5579083">mi</span>&nbsp;<span class="op" id="5579086">=</span>&nbsp;<span class="ident" id="5579088">i</span><span class="op" id="5579089">+</span><span class="num" id="5579090">4</span><span class="op" id="5579091">,</span>&nbsp;<span class="ident" id="5579093">mi</span><span class="op" id="5579095">+</span><span class="num" id="5579096">1</span>&nbsp;<span class="op" id="5579098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579103">ma</span>&nbsp;<span class="op" id="5579106">:=</span>&nbsp;<span class="builtintype" id="5579109">uint32</span><span class="op" id="5579115">(</span><span class="ident" id="5579116">mask</span><span class="op" id="5579120">.</span><span class="ident" id="5579121">Pix</span><span class="op" id="5579124">[</span><span class="ident" id="5579125">mi</span><span class="op" id="5579127">]</span><span class="op" id="5579128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579133">if</span>&nbsp;<span class="ident" id="5579136">ma</span>&nbsp;<span class="op" id="5579139">==</span>&nbsp;<span class="num" id="5579142">0</span>&nbsp;<span class="op" id="5579144">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579150">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579167">ma</span>&nbsp;<span class="op" id="5579170">|=</span>&nbsp;<span class="ident" id="5579173">ma</span>&nbsp;<span class="op" id="5579176">&lt;&lt;</span>&nbsp;<span class="num" id="5579179">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579185">dr</span>&nbsp;<span class="op" id="5579188">:=</span>&nbsp;<span class="builtintype" id="5579191">uint32</span><span class="op" id="5579197">(</span><span class="ident" id="5579198">dst</span><span class="op" id="5579201">.</span><span class="ident" id="5579202">Pix</span><span class="op" id="5579205">[</span><span class="ident" id="5579206">i</span><span class="op" id="5579207">+</span><span class="num" id="5579208">0</span><span class="op" id="5579209">]</span><span class="op" id="5579210">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579215">dg</span>&nbsp;<span class="op" id="5579218">:=</span>&nbsp;<span class="builtintype" id="5579221">uint32</span><span class="op" id="5579227">(</span><span class="ident" id="5579228">dst</span><span class="op" id="5579231">.</span><span class="ident" id="5579232">Pix</span><span class="op" id="5579235">[</span><span class="ident" id="5579236">i</span><span class="op" id="5579237">+</span><span class="num" id="5579238">1</span><span class="op" id="5579239">]</span><span class="op" id="5579240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579245">db</span>&nbsp;<span class="op" id="5579248">:=</span>&nbsp;<span class="builtintype" id="5579251">uint32</span><span class="op" id="5579257">(</span><span class="ident" id="5579258">dst</span><span class="op" id="5579261">.</span><span class="ident" id="5579262">Pix</span><span class="op" id="5579265">[</span><span class="ident" id="5579266">i</span><span class="op" id="5579267">+</span><span class="num" id="5579268">2</span><span class="op" id="5579269">]</span><span class="op" id="5579270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579275">da</span>&nbsp;<span class="op" id="5579278">:=</span>&nbsp;<span class="builtintype" id="5579281">uint32</span><span class="op" id="5579287">(</span><span class="ident" id="5579288">dst</span><span class="op" id="5579291">.</span><span class="ident" id="5579292">Pix</span><span class="op" id="5579295">[</span><span class="ident" id="5579296">i</span><span class="op" id="5579297">+</span><span class="num" id="5579298">3</span><span class="op" id="5579299">]</span><span class="op" id="5579300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579306">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579366">a</span>&nbsp;<span class="op" id="5579368">:=</span>&nbsp;<span class="op" id="5579371">(</span><span class="ident" id="5579372">m</span>&nbsp;<span class="op" id="5579374">-</span>&nbsp;<span class="op" id="5579376">(</span><span class="ident" id="5579377">sa</span>&nbsp;<span class="op" id="5579380">*</span>&nbsp;<span class="ident" id="5579382">ma</span>&nbsp;<span class="op" id="5579385">/</span>&nbsp;<span class="ident" id="5579387">m</span><span class="op" id="5579388">)</span><span class="op" id="5579389">)</span>&nbsp;<span class="op" id="5579391">*</span>&nbsp;<span class="num" id="5579393">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579403">dst</span><span class="op" id="5579406">.</span><span class="ident" id="5579407">Pix</span><span class="op" id="5579410">[</span><span class="ident" id="5579411">i</span><span class="op" id="5579412">+</span><span class="num" id="5579413">0</span><span class="op" id="5579414">]</span>&nbsp;<span class="op" id="5579416">=</span>&nbsp;<span class="builtintype" id="5579418">uint8</span><span class="op" id="5579423">(</span><span class="op" id="5579424">(</span><span class="ident" id="5579425">dr</span><span class="op" id="5579427">*</span><span class="ident" id="5579428">a</span>&nbsp;<span class="op" id="5579430">+</span>&nbsp;<span class="ident" id="5579432">sr</span><span class="op" id="5579434">*</span><span class="ident" id="5579435">ma</span><span class="op" id="5579437">)</span>&nbsp;<span class="op" id="5579439">/</span>&nbsp;<span class="ident" id="5579441">m</span>&nbsp;<span class="op" id="5579443">&gt;&gt;</span>&nbsp;<span class="num" id="5579446">8</span><span class="op" id="5579447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579452">dst</span><span class="op" id="5579455">.</span><span class="ident" id="5579456">Pix</span><span class="op" id="5579459">[</span><span class="ident" id="5579460">i</span><span class="op" id="5579461">+</span><span class="num" id="5579462">1</span><span class="op" id="5579463">]</span>&nbsp;<span class="op" id="5579465">=</span>&nbsp;<span class="builtintype" id="5579467">uint8</span><span class="op" id="5579472">(</span><span class="op" id="5579473">(</span><span class="ident" id="5579474">dg</span><span class="op" id="5579476">*</span><span class="ident" id="5579477">a</span>&nbsp;<span class="op" id="5579479">+</span>&nbsp;<span class="ident" id="5579481">sg</span><span class="op" id="5579483">*</span><span class="ident" id="5579484">ma</span><span class="op" id="5579486">)</span>&nbsp;<span class="op" id="5579488">/</span>&nbsp;<span class="ident" id="5579490">m</span>&nbsp;<span class="op" id="5579492">&gt;&gt;</span>&nbsp;<span class="num" id="5579495">8</span><span class="op" id="5579496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579501">dst</span><span class="op" id="5579504">.</span><span class="ident" id="5579505">Pix</span><span class="op" id="5579508">[</span><span class="ident" id="5579509">i</span><span class="op" id="5579510">+</span><span class="num" id="5579511">2</span><span class="op" id="5579512">]</span>&nbsp;<span class="op" id="5579514">=</span>&nbsp;<span class="builtintype" id="5579516">uint8</span><span class="op" id="5579521">(</span><span class="op" id="5579522">(</span><span class="ident" id="5579523">db</span><span class="op" id="5579525">*</span><span class="ident" id="5579526">a</span>&nbsp;<span class="op" id="5579528">+</span>&nbsp;<span class="ident" id="5579530">sb</span><span class="op" id="5579532">*</span><span class="ident" id="5579533">ma</span><span class="op" id="5579535">)</span>&nbsp;<span class="op" id="5579537">/</span>&nbsp;<span class="ident" id="5579539">m</span>&nbsp;<span class="op" id="5579541">&gt;&gt;</span>&nbsp;<span class="num" id="5579544">8</span><span class="op" id="5579545">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579550">dst</span><span class="op" id="5579553">.</span><span class="ident" id="5579554">Pix</span><span class="op" id="5579557">[</span><span class="ident" id="5579558">i</span><span class="op" id="5579559">+</span><span class="num" id="5579560">3</span><span class="op" id="5579561">]</span>&nbsp;<span class="op" id="5579563">=</span>&nbsp;<span class="builtintype" id="5579565">uint8</span><span class="op" id="5579570">(</span><span class="op" id="5579571">(</span><span class="ident" id="5579572">da</span><span class="op" id="5579574">*</span><span class="ident" id="5579575">a</span>&nbsp;<span class="op" id="5579577">+</span>&nbsp;<span class="ident" id="5579579">sa</span><span class="op" id="5579581">*</span><span class="ident" id="5579582">ma</span><span class="op" id="5579584">)</span>&nbsp;<span class="op" id="5579586">/</span>&nbsp;<span class="ident" id="5579588">m</span>&nbsp;<span class="op" id="5579590">&gt;&gt;</span>&nbsp;<span class="num" id="5579593">8</span><span class="op" id="5579594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579602">i0</span>&nbsp;<span class="op" id="5579605">+=</span>&nbsp;<span class="ident" id="5579608">dst</span><span class="op" id="5579611">.</span><span class="ident" id="5579612">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579621">i1</span>&nbsp;<span class="op" id="5579624">+=</span>&nbsp;<span class="ident" id="5579627">dst</span><span class="op" id="5579630">.</span><span class="ident" id="5579631">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579640">mi0</span>&nbsp;<span class="op" id="5579644">+=</span>&nbsp;<span class="ident" id="5579647">mask</span><span class="op" id="5579651">.</span><span class="ident" id="5579652">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5579660">}</span><br>
<span class="lineno"></span><span class="op" id="5579662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5579665">func</span>&nbsp;<span class="ident" id="5579670">drawRGBA</span><span class="op" id="5579678">(</span><span class="ident" id="5579679">dst</span>&nbsp;<span class="op" id="5579683">*</span><span class="ident" id="5579684">image</span><span class="op" id="5579689">.</span><span class="ident" id="5579690">RGBA</span><span class="op" id="5579694">,</span>&nbsp;<span class="ident" id="5579696">r</span>&nbsp;<span class="ident" id="5579698">image</span><span class="op" id="5579703">.</span><span class="ident" id="5579704">Rectangle</span><span class="op" id="5579713">,</span>&nbsp;<span class="ident" id="5579715">src</span>&nbsp;<span class="ident" id="5579719">image</span><span class="op" id="5579724">.</span><span class="ident" id="5579725">Image</span><span class="op" id="5579730">,</span>&nbsp;<span class="ident" id="5579732">sp</span>&nbsp;<span class="ident" id="5579735">image</span><span class="op" id="5579740">.</span><span class="ident" id="5579741">Point</span><span class="op" id="5579746">,</span>&nbsp;<span class="ident" id="5579748">mask</span>&nbsp;<span class="ident" id="5579753">image</span><span class="op" id="5579758">.</span><span class="ident" id="5579759">Image</span><span class="op" id="5579764">,</span>&nbsp;<span class="ident" id="5579766">mp</span>&nbsp;<span class="ident" id="5579769">image</span><span class="op" id="5579774">.</span><span class="ident" id="5579775">Point</span><span class="op" id="5579780">,</span>&nbsp;<span class="ident" id="5579782">op</span>&nbsp;<span class="ident" id="5579785">Op</span><span class="op" id="5579787">)</span>&nbsp;<span class="op" id="5579789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579792">x0</span><span class="op" id="5579794">,</span>&nbsp;<span class="ident" id="5579796">x1</span><span class="op" id="5579798">,</span>&nbsp;<span class="ident" id="5579800">dx</span>&nbsp;<span class="op" id="5579803">:=</span>&nbsp;<span class="ident" id="5579806">r</span><span class="op" id="5579807">.</span><span class="ident" id="5579808">Min</span><span class="op" id="5579811">.</span><span class="ident" id="5579812">X</span><span class="op" id="5579813">,</span>&nbsp;<span class="ident" id="5579815">r</span><span class="op" id="5579816">.</span><span class="ident" id="5579817">Max</span><span class="op" id="5579820">.</span><span class="ident" id="5579821">X</span><span class="op" id="5579822">,</span>&nbsp;<span class="num" id="5579824">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579827">y0</span><span class="op" id="5579829">,</span>&nbsp;<span class="ident" id="5579831">y1</span><span class="op" id="5579833">,</span>&nbsp;<span class="ident" id="5579835">dy</span>&nbsp;<span class="op" id="5579838">:=</span>&nbsp;<span class="ident" id="5579841">r</span><span class="op" id="5579842">.</span><span class="ident" id="5579843">Min</span><span class="op" id="5579846">.</span><span class="ident" id="5579847">Y</span><span class="op" id="5579848">,</span>&nbsp;<span class="ident" id="5579850">r</span><span class="op" id="5579851">.</span><span class="ident" id="5579852">Max</span><span class="op" id="5579855">.</span><span class="ident" id="5579856">Y</span><span class="op" id="5579857">,</span>&nbsp;<span class="num" id="5579859">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579862">if</span>&nbsp;<span class="ident" id="5579865">image</span><span class="op" id="5579870">.</span><span class="ident" id="5579871">Image</span><span class="op" id="5579876">(</span><span class="ident" id="5579877">dst</span><span class="op" id="5579880">)</span>&nbsp;<span class="op" id="5579882">==</span>&nbsp;<span class="ident" id="5579885">src</span>&nbsp;<span class="op" id="5579889">&amp;&amp;</span>&nbsp;<span class="ident" id="5579892">r</span><span class="op" id="5579893">.</span><span class="ident" id="5579894">Overlaps</span><span class="op" id="5579902">(</span><span class="ident" id="5579903">r</span><span class="op" id="5579904">.</span><span class="ident" id="5579905">Add</span><span class="op" id="5579908">(</span><span class="ident" id="5579909">sp</span><span class="op" id="5579911">.</span><span class="ident" id="5579912">Sub</span><span class="op" id="5579915">(</span><span class="ident" id="5579916">r</span><span class="op" id="5579917">.</span><span class="ident" id="5579918">Min</span><span class="op" id="5579921">)</span><span class="op" id="5579922">)</span><span class="op" id="5579923">)</span>&nbsp;<span class="op" id="5579925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5579929">if</span>&nbsp;<span class="ident" id="5579932">sp</span><span class="op" id="5579934">.</span><span class="ident" id="5579935">Y</span>&nbsp;<span class="op" id="5579937">&lt;</span>&nbsp;<span class="ident" id="5579939">r</span><span class="op" id="5579940">.</span><span class="ident" id="5579941">Min</span><span class="op" id="5579944">.</span><span class="ident" id="5579945">Y</span>&nbsp;<span class="op" id="5579947">||</span>&nbsp;<span class="ident" id="5579950">sp</span><span class="op" id="5579952">.</span><span class="ident" id="5579953">Y</span>&nbsp;<span class="op" id="5579955">==</span>&nbsp;<span class="ident" id="5579958">r</span><span class="op" id="5579959">.</span><span class="ident" id="5579960">Min</span><span class="op" id="5579963">.</span><span class="ident" id="5579964">Y</span>&nbsp;<span class="op" id="5579966">&amp;&amp;</span>&nbsp;<span class="ident" id="5579969">sp</span><span class="op" id="5579971">.</span><span class="ident" id="5579972">X</span>&nbsp;<span class="op" id="5579974">&lt;</span>&nbsp;<span class="ident" id="5579976">r</span><span class="op" id="5579977">.</span><span class="ident" id="5579978">Min</span><span class="op" id="5579981">.</span><span class="ident" id="5579982">X</span>&nbsp;<span class="op" id="5579984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579989">x0</span><span class="op" id="5579991">,</span>&nbsp;<span class="ident" id="5579993">x1</span><span class="op" id="5579995">,</span>&nbsp;<span class="ident" id="5579997">dx</span>&nbsp;<span class="op" id="5580000">=</span>&nbsp;<span class="ident" id="5580002">x1</span><span class="op" id="5580004">-</span><span class="num" id="5580005">1</span><span class="op" id="5580006">,</span>&nbsp;<span class="ident" id="5580008">x0</span><span class="op" id="5580010">-</span><span class="num" id="5580011">1</span><span class="op" id="5580012">,</span>&nbsp;<span class="op" id="5580014">-</span><span class="num" id="5580015">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580020">y0</span><span class="op" id="5580022">,</span>&nbsp;<span class="ident" id="5580024">y1</span><span class="op" id="5580026">,</span>&nbsp;<span class="ident" id="5580028">dy</span>&nbsp;<span class="op" id="5580031">=</span>&nbsp;<span class="ident" id="5580033">y1</span><span class="op" id="5580035">-</span><span class="num" id="5580036">1</span><span class="op" id="5580037">,</span>&nbsp;<span class="ident" id="5580039">y0</span><span class="op" id="5580041">-</span><span class="num" id="5580042">1</span><span class="op" id="5580043">,</span>&nbsp;<span class="op" id="5580045">-</span><span class="num" id="5580046">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580057">sy</span>&nbsp;<span class="op" id="5580060">:=</span>&nbsp;<span class="ident" id="5580063">sp</span><span class="op" id="5580065">.</span><span class="ident" id="5580066">Y</span>&nbsp;<span class="op" id="5580068">+</span>&nbsp;<span class="ident" id="5580070">y0</span>&nbsp;<span class="op" id="5580073">-</span>&nbsp;<span class="ident" id="5580075">r</span><span class="op" id="5580076">.</span><span class="ident" id="5580077">Min</span><span class="op" id="5580080">.</span><span class="ident" id="5580081">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580084">my</span>&nbsp;<span class="op" id="5580087">:=</span>&nbsp;<span class="ident" id="5580090">mp</span><span class="op" id="5580092">.</span><span class="ident" id="5580093">Y</span>&nbsp;<span class="op" id="5580095">+</span>&nbsp;<span class="ident" id="5580097">y0</span>&nbsp;<span class="op" id="5580100">-</span>&nbsp;<span class="ident" id="5580102">r</span><span class="op" id="5580103">.</span><span class="ident" id="5580104">Min</span><span class="op" id="5580107">.</span><span class="ident" id="5580108">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580111">sx0</span>&nbsp;<span class="op" id="5580115">:=</span>&nbsp;<span class="ident" id="5580118">sp</span><span class="op" id="5580120">.</span><span class="ident" id="5580121">X</span>&nbsp;<span class="op" id="5580123">+</span>&nbsp;<span class="ident" id="5580125">x0</span>&nbsp;<span class="op" id="5580128">-</span>&nbsp;<span class="ident" id="5580130">r</span><span class="op" id="5580131">.</span><span class="ident" id="5580132">Min</span><span class="op" id="5580135">.</span><span class="ident" id="5580136">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580139">mx0</span>&nbsp;<span class="op" id="5580143">:=</span>&nbsp;<span class="ident" id="5580146">mp</span><span class="op" id="5580148">.</span><span class="ident" id="5580149">X</span>&nbsp;<span class="op" id="5580151">+</span>&nbsp;<span class="ident" id="5580153">x0</span>&nbsp;<span class="op" id="5580156">-</span>&nbsp;<span class="ident" id="5580158">r</span><span class="op" id="5580159">.</span><span class="ident" id="5580160">Min</span><span class="op" id="5580163">.</span><span class="ident" id="5580164">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580167">sx1</span>&nbsp;<span class="op" id="5580171">:=</span>&nbsp;<span class="ident" id="5580174">sx0</span>&nbsp;<span class="op" id="5580178">+</span>&nbsp;<span class="op" id="5580180">(</span><span class="ident" id="5580181">x1</span>&nbsp;<span class="op" id="5580184">-</span>&nbsp;<span class="ident" id="5580186">x0</span><span class="op" id="5580188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580191">i0</span>&nbsp;<span class="op" id="5580194">:=</span>&nbsp;<span class="ident" id="5580197">dst</span><span class="op" id="5580200">.</span><span class="ident" id="5580201">PixOffset</span><span class="op" id="5580210">(</span><span class="ident" id="5580211">x0</span><span class="op" id="5580213">,</span>&nbsp;<span class="ident" id="5580215">y0</span><span class="op" id="5580217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580220">di</span>&nbsp;<span class="op" id="5580223">:=</span>&nbsp;<span class="ident" id="5580226">dx</span>&nbsp;<span class="op" id="5580229">*</span>&nbsp;<span class="num" id="5580231">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580234">for</span>&nbsp;<span class="ident" id="5580238">y</span>&nbsp;<span class="op" id="5580240">:=</span>&nbsp;<span class="ident" id="5580243">y0</span><span class="op" id="5580245">;</span>&nbsp;<span class="ident" id="5580247">y</span>&nbsp;<span class="op" id="5580249">!=</span>&nbsp;<span class="ident" id="5580252">y1</span><span class="op" id="5580254">;</span>&nbsp;<span class="ident" id="5580256">y</span><span class="op" id="5580257">,</span>&nbsp;<span class="ident" id="5580259">sy</span><span class="op" id="5580261">,</span>&nbsp;<span class="ident" id="5580263">my</span>&nbsp;<span class="op" id="5580266">=</span>&nbsp;<span class="ident" id="5580268">y</span><span class="op" id="5580269">+</span><span class="ident" id="5580270">dy</span><span class="op" id="5580272">,</span>&nbsp;<span class="ident" id="5580274">sy</span><span class="op" id="5580276">+</span><span class="ident" id="5580277">dy</span><span class="op" id="5580279">,</span>&nbsp;<span class="ident" id="5580281">my</span><span class="op" id="5580283">+</span><span class="ident" id="5580284">dy</span>&nbsp;<span class="op" id="5580287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580291">for</span>&nbsp;<span class="ident" id="5580295">i</span><span class="op" id="5580296">,</span>&nbsp;<span class="ident" id="5580298">sx</span><span class="op" id="5580300">,</span>&nbsp;<span class="ident" id="5580302">mx</span>&nbsp;<span class="op" id="5580305">:=</span>&nbsp;<span class="ident" id="5580308">i0</span><span class="op" id="5580310">,</span>&nbsp;<span class="ident" id="5580312">sx0</span><span class="op" id="5580315">,</span>&nbsp;<span class="ident" id="5580317">mx0</span><span class="op" id="5580320">;</span>&nbsp;<span class="ident" id="5580322">sx</span>&nbsp;<span class="op" id="5580325">!=</span>&nbsp;<span class="ident" id="5580328">sx1</span><span class="op" id="5580331">;</span>&nbsp;<span class="ident" id="5580333">i</span><span class="op" id="5580334">,</span>&nbsp;<span class="ident" id="5580336">sx</span><span class="op" id="5580338">,</span>&nbsp;<span class="ident" id="5580340">mx</span>&nbsp;<span class="op" id="5580343">=</span>&nbsp;<span class="ident" id="5580345">i</span><span class="op" id="5580346">+</span><span class="ident" id="5580347">di</span><span class="op" id="5580349">,</span>&nbsp;<span class="ident" id="5580351">sx</span><span class="op" id="5580353">+</span><span class="ident" id="5580354">dx</span><span class="op" id="5580356">,</span>&nbsp;<span class="ident" id="5580358">mx</span><span class="op" id="5580360">+</span><span class="ident" id="5580361">dx</span>&nbsp;<span class="op" id="5580364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580369">ma</span>&nbsp;<span class="op" id="5580372">:=</span>&nbsp;<span class="builtintype" id="5580375">uint32</span><span class="op" id="5580381">(</span><span class="ident" id="5580382">m</span><span class="op" id="5580383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580388">if</span>&nbsp;<span class="ident" id="5580391">mask</span>&nbsp;<span class="op" id="5580396">!=</span>&nbsp;<span class="ident" id="5580399">nil</span>&nbsp;<span class="op" id="5580403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580409">_</span><span class="op" id="5580410">,</span>&nbsp;<span class="ident" id="5580412">_</span><span class="op" id="5580413">,</span>&nbsp;<span class="ident" id="5580415">_</span><span class="op" id="5580416">,</span>&nbsp;<span class="ident" id="5580418">ma</span>&nbsp;<span class="op" id="5580421">=</span>&nbsp;<span class="ident" id="5580423">mask</span><span class="op" id="5580427">.</span><span class="ident" id="5580428">At</span><span class="op" id="5580430">(</span><span class="ident" id="5580431">mx</span><span class="op" id="5580433">,</span>&nbsp;<span class="ident" id="5580435">my</span><span class="op" id="5580437">)</span><span class="op" id="5580438">.</span><span class="ident" id="5580439">RGBA</span><span class="op" id="5580443">(</span><span class="op" id="5580444">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580454">sr</span><span class="op" id="5580456">,</span>&nbsp;<span class="ident" id="5580458">sg</span><span class="op" id="5580460">,</span>&nbsp;<span class="ident" id="5580462">sb</span><span class="op" id="5580464">,</span>&nbsp;<span class="ident" id="5580466">sa</span>&nbsp;<span class="op" id="5580469">:=</span>&nbsp;<span class="ident" id="5580472">src</span><span class="op" id="5580475">.</span><span class="ident" id="5580476">At</span><span class="op" id="5580478">(</span><span class="ident" id="5580479">sx</span><span class="op" id="5580481">,</span>&nbsp;<span class="ident" id="5580483">sy</span><span class="op" id="5580485">)</span><span class="op" id="5580486">.</span><span class="ident" id="5580487">RGBA</span><span class="op" id="5580491">(</span><span class="op" id="5580492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580497">if</span>&nbsp;<span class="ident" id="5580500">op</span>&nbsp;<span class="op" id="5580503">==</span>&nbsp;<span class="ident" id="5580506">Over</span>&nbsp;<span class="op" id="5580511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580517">dr</span>&nbsp;<span class="op" id="5580520">:=</span>&nbsp;<span class="builtintype" id="5580523">uint32</span><span class="op" id="5580529">(</span><span class="ident" id="5580530">dst</span><span class="op" id="5580533">.</span><span class="ident" id="5580534">Pix</span><span class="op" id="5580537">[</span><span class="ident" id="5580538">i</span><span class="op" id="5580539">+</span><span class="num" id="5580540">0</span><span class="op" id="5580541">]</span><span class="op" id="5580542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580548">dg</span>&nbsp;<span class="op" id="5580551">:=</span>&nbsp;<span class="builtintype" id="5580554">uint32</span><span class="op" id="5580560">(</span><span class="ident" id="5580561">dst</span><span class="op" id="5580564">.</span><span class="ident" id="5580565">Pix</span><span class="op" id="5580568">[</span><span class="ident" id="5580569">i</span><span class="op" id="5580570">+</span><span class="num" id="5580571">1</span><span class="op" id="5580572">]</span><span class="op" id="5580573">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580579">db</span>&nbsp;<span class="op" id="5580582">:=</span>&nbsp;<span class="builtintype" id="5580585">uint32</span><span class="op" id="5580591">(</span><span class="ident" id="5580592">dst</span><span class="op" id="5580595">.</span><span class="ident" id="5580596">Pix</span><span class="op" id="5580599">[</span><span class="ident" id="5580600">i</span><span class="op" id="5580601">+</span><span class="num" id="5580602">2</span><span class="op" id="5580603">]</span><span class="op" id="5580604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580610">da</span>&nbsp;<span class="op" id="5580613">:=</span>&nbsp;<span class="builtintype" id="5580616">uint32</span><span class="op" id="5580622">(</span><span class="ident" id="5580623">dst</span><span class="op" id="5580626">.</span><span class="ident" id="5580627">Pix</span><span class="op" id="5580630">[</span><span class="ident" id="5580631">i</span><span class="op" id="5580632">+</span><span class="num" id="5580633">3</span><span class="op" id="5580634">]</span><span class="op" id="5580635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580642">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580722">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580780">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580801">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580867">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5580932">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581004">a</span>&nbsp;<span class="op" id="5581006">:=</span>&nbsp;<span class="op" id="5581009">(</span><span class="ident" id="5581010">m</span>&nbsp;<span class="op" id="5581012">-</span>&nbsp;<span class="op" id="5581014">(</span><span class="ident" id="5581015">sa</span>&nbsp;<span class="op" id="5581018">*</span>&nbsp;<span class="ident" id="5581020">ma</span>&nbsp;<span class="op" id="5581023">/</span>&nbsp;<span class="ident" id="5581025">m</span><span class="op" id="5581026">)</span><span class="op" id="5581027">)</span>&nbsp;<span class="op" id="5581029">*</span>&nbsp;<span class="num" id="5581031">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581042">dst</span><span class="op" id="5581045">.</span><span class="ident" id="5581046">Pix</span><span class="op" id="5581049">[</span><span class="ident" id="5581050">i</span><span class="op" id="5581051">+</span><span class="num" id="5581052">0</span><span class="op" id="5581053">]</span>&nbsp;<span class="op" id="5581055">=</span>&nbsp;<span class="builtintype" id="5581057">uint8</span><span class="op" id="5581062">(</span><span class="op" id="5581063">(</span><span class="ident" id="5581064">dr</span><span class="op" id="5581066">*</span><span class="ident" id="5581067">a</span>&nbsp;<span class="op" id="5581069">+</span>&nbsp;<span class="ident" id="5581071">sr</span><span class="op" id="5581073">*</span><span class="ident" id="5581074">ma</span><span class="op" id="5581076">)</span>&nbsp;<span class="op" id="5581078">/</span>&nbsp;<span class="ident" id="5581080">m</span>&nbsp;<span class="op" id="5581082">&gt;&gt;</span>&nbsp;<span class="num" id="5581085">8</span><span class="op" id="5581086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581092">dst</span><span class="op" id="5581095">.</span><span class="ident" id="5581096">Pix</span><span class="op" id="5581099">[</span><span class="ident" id="5581100">i</span><span class="op" id="5581101">+</span><span class="num" id="5581102">1</span><span class="op" id="5581103">]</span>&nbsp;<span class="op" id="5581105">=</span>&nbsp;<span class="builtintype" id="5581107">uint8</span><span class="op" id="5581112">(</span><span class="op" id="5581113">(</span><span class="ident" id="5581114">dg</span><span class="op" id="5581116">*</span><span class="ident" id="5581117">a</span>&nbsp;<span class="op" id="5581119">+</span>&nbsp;<span class="ident" id="5581121">sg</span><span class="op" id="5581123">*</span><span class="ident" id="5581124">ma</span><span class="op" id="5581126">)</span>&nbsp;<span class="op" id="5581128">/</span>&nbsp;<span class="ident" id="5581130">m</span>&nbsp;<span class="op" id="5581132">&gt;&gt;</span>&nbsp;<span class="num" id="5581135">8</span><span class="op" id="5581136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581142">dst</span><span class="op" id="5581145">.</span><span class="ident" id="5581146">Pix</span><span class="op" id="5581149">[</span><span class="ident" id="5581150">i</span><span class="op" id="5581151">+</span><span class="num" id="5581152">2</span><span class="op" id="5581153">]</span>&nbsp;<span class="op" id="5581155">=</span>&nbsp;<span class="builtintype" id="5581157">uint8</span><span class="op" id="5581162">(</span><span class="op" id="5581163">(</span><span class="ident" id="5581164">db</span><span class="op" id="5581166">*</span><span class="ident" id="5581167">a</span>&nbsp;<span class="op" id="5581169">+</span>&nbsp;<span class="ident" id="5581171">sb</span><span class="op" id="5581173">*</span><span class="ident" id="5581174">ma</span><span class="op" id="5581176">)</span>&nbsp;<span class="op" id="5581178">/</span>&nbsp;<span class="ident" id="5581180">m</span>&nbsp;<span class="op" id="5581182">&gt;&gt;</span>&nbsp;<span class="num" id="5581185">8</span><span class="op" id="5581186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581192">dst</span><span class="op" id="5581195">.</span><span class="ident" id="5581196">Pix</span><span class="op" id="5581199">[</span><span class="ident" id="5581200">i</span><span class="op" id="5581201">+</span><span class="num" id="5581202">3</span><span class="op" id="5581203">]</span>&nbsp;<span class="op" id="5581205">=</span>&nbsp;<span class="builtintype" id="5581207">uint8</span><span class="op" id="5581212">(</span><span class="op" id="5581213">(</span><span class="ident" id="5581214">da</span><span class="op" id="5581216">*</span><span class="ident" id="5581217">a</span>&nbsp;<span class="op" id="5581219">+</span>&nbsp;<span class="ident" id="5581221">sa</span><span class="op" id="5581223">*</span><span class="ident" id="5581224">ma</span><span class="op" id="5581226">)</span>&nbsp;<span class="op" id="5581228">/</span>&nbsp;<span class="ident" id="5581230">m</span>&nbsp;<span class="op" id="5581232">&gt;&gt;</span>&nbsp;<span class="num" id="5581235">8</span><span class="op" id="5581236">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581242">}</span>&nbsp;<span class="keyword" id="5581244">else</span>&nbsp;<span class="op" id="5581249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581255">dst</span><span class="op" id="5581258">.</span><span class="ident" id="5581259">Pix</span><span class="op" id="5581262">[</span><span class="ident" id="5581263">i</span><span class="op" id="5581264">+</span><span class="num" id="5581265">0</span><span class="op" id="5581266">]</span>&nbsp;<span class="op" id="5581268">=</span>&nbsp;<span class="builtintype" id="5581270">uint8</span><span class="op" id="5581275">(</span><span class="ident" id="5581276">sr</span>&nbsp;<span class="op" id="5581279">*</span>&nbsp;<span class="ident" id="5581281">ma</span>&nbsp;<span class="op" id="5581284">/</span>&nbsp;<span class="ident" id="5581286">m</span>&nbsp;<span class="op" id="5581288">&gt;&gt;</span>&nbsp;<span class="num" id="5581291">8</span><span class="op" id="5581292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581298">dst</span><span class="op" id="5581301">.</span><span class="ident" id="5581302">Pix</span><span class="op" id="5581305">[</span><span class="ident" id="5581306">i</span><span class="op" id="5581307">+</span><span class="num" id="5581308">1</span><span class="op" id="5581309">]</span>&nbsp;<span class="op" id="5581311">=</span>&nbsp;<span class="builtintype" id="5581313">uint8</span><span class="op" id="5581318">(</span><span class="ident" id="5581319">sg</span>&nbsp;<span class="op" id="5581322">*</span>&nbsp;<span class="ident" id="5581324">ma</span>&nbsp;<span class="op" id="5581327">/</span>&nbsp;<span class="ident" id="5581329">m</span>&nbsp;<span class="op" id="5581331">&gt;&gt;</span>&nbsp;<span class="num" id="5581334">8</span><span class="op" id="5581335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581341">dst</span><span class="op" id="5581344">.</span><span class="ident" id="5581345">Pix</span><span class="op" id="5581348">[</span><span class="ident" id="5581349">i</span><span class="op" id="5581350">+</span><span class="num" id="5581351">2</span><span class="op" id="5581352">]</span>&nbsp;<span class="op" id="5581354">=</span>&nbsp;<span class="builtintype" id="5581356">uint8</span><span class="op" id="5581361">(</span><span class="ident" id="5581362">sb</span>&nbsp;<span class="op" id="5581365">*</span>&nbsp;<span class="ident" id="5581367">ma</span>&nbsp;<span class="op" id="5581370">/</span>&nbsp;<span class="ident" id="5581372">m</span>&nbsp;<span class="op" id="5581374">&gt;&gt;</span>&nbsp;<span class="num" id="5581377">8</span><span class="op" id="5581378">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581384">dst</span><span class="op" id="5581387">.</span><span class="ident" id="5581388">Pix</span><span class="op" id="5581391">[</span><span class="ident" id="5581392">i</span><span class="op" id="5581393">+</span><span class="num" id="5581394">3</span><span class="op" id="5581395">]</span>&nbsp;<span class="op" id="5581397">=</span>&nbsp;<span class="builtintype" id="5581399">uint8</span><span class="op" id="5581404">(</span><span class="ident" id="5581405">sa</span>&nbsp;<span class="op" id="5581408">*</span>&nbsp;<span class="ident" id="5581410">ma</span>&nbsp;<span class="op" id="5581413">/</span>&nbsp;<span class="ident" id="5581415">m</span>&nbsp;<span class="op" id="5581417">&gt;&gt;</span>&nbsp;<span class="num" id="5581420">8</span><span class="op" id="5581421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581434">i0</span>&nbsp;<span class="op" id="5581437">+=</span>&nbsp;<span class="ident" id="5581440">dy</span>&nbsp;<span class="op" id="5581443">*</span>&nbsp;<span class="ident" id="5581445">dst</span><span class="op" id="5581448">.</span><span class="ident" id="5581449">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581457">}</span><br>
<span class="lineno">545</span><span class="op" id="5581459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5581462">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5581509">func</span>&nbsp;<span class="ident" id="5581514">clamp</span><span class="op" id="5581519">(</span><span class="ident" id="5581520">i</span>&nbsp;<span class="builtintype" id="5581522">int32</span><span class="op" id="5581527">)</span>&nbsp;<span class="builtintype" id="5581529">int32</span>&nbsp;<span class="op" id="5581535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581538">if</span>&nbsp;<span class="ident" id="5581541">i</span>&nbsp;<span class="op" id="5581543">&lt;</span>&nbsp;<span class="num" id="5581545">0</span>&nbsp;<span class="op" id="5581547">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581551">return</span>&nbsp;<span class="num" id="5581558">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581564">if</span>&nbsp;<span class="ident" id="5581567">i</span>&nbsp;<span class="op" id="5581569">&gt;</span>&nbsp;<span class="num" id="5581571">0xffff</span>&nbsp;<span class="op" id="5581578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581582">return</span>&nbsp;<span class="num" id="5581589">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581597">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581600">return</span>&nbsp;<span class="ident" id="5581607">i</span><br>
<span class="lineno"></span><span class="op" id="5581609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5581612">func</span>&nbsp;<span class="ident" id="5581617">drawPaletted</span><span class="op" id="5581629">(</span><span class="ident" id="5581630">dst</span>&nbsp;<span class="ident" id="5581634">Image</span><span class="op" id="5581639">,</span>&nbsp;<span class="ident" id="5581641">r</span>&nbsp;<span class="ident" id="5581643">image</span><span class="op" id="5581648">.</span><span class="ident" id="5581649">Rectangle</span><span class="op" id="5581658">,</span>&nbsp;<span class="ident" id="5581660">src</span>&nbsp;<span class="ident" id="5581664">image</span><span class="op" id="5581669">.</span><span class="ident" id="5581670">Image</span><span class="op" id="5581675">,</span>&nbsp;<span class="ident" id="5581677">sp</span>&nbsp;<span class="ident" id="5581680">image</span><span class="op" id="5581685">.</span><span class="ident" id="5581686">Point</span><span class="op" id="5581691">,</span>&nbsp;<span class="ident" id="5581693">floydSteinberg</span>&nbsp;<span class="builtintype" id="5581708">bool</span><span class="op" id="5581712">)</span>&nbsp;<span class="op" id="5581714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581717">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581784">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581849">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581912">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581982">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582053">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582124">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582170">palette</span><span class="op" id="5582177">,</span>&nbsp;<span class="ident" id="5582179">pix</span><span class="op" id="5582182">,</span>&nbsp;<span class="ident" id="5582184">stride</span>&nbsp;<span class="op" id="5582191">:=</span>&nbsp;<span class="op" id="5582194">[</span><span class="op" id="5582195">]</span><span class="op" id="5582196">[</span><span class="num" id="5582197">3</span><span class="op" id="5582198">]</span><span class="builtintype" id="5582199">int32</span><span class="op" id="5582204">(</span><span class="ident" id="5582205">nil</span><span class="op" id="5582208">)</span><span class="op" id="5582209">,</span>&nbsp;<span class="op" id="5582211">[</span><span class="op" id="5582212">]</span><span class="builtintype" id="5582213">byte</span><span class="op" id="5582217">(</span><span class="ident" id="5582218">nil</span><span class="op" id="5582221">)</span><span class="op" id="5582222">,</span>&nbsp;<span class="num" id="5582224">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582227">if</span>&nbsp;<span class="ident" id="5582230">p</span><span class="op" id="5582231">,</span>&nbsp;<span class="ident" id="5582233">ok</span>&nbsp;<span class="op" id="5582236">:=</span>&nbsp;<span class="ident" id="5582239">dst</span><span class="op" id="5582242">.</span><span class="op" id="5582243">(</span><span class="op" id="5582244">*</span><span class="ident" id="5582245">image</span><span class="op" id="5582250">.</span><span class="ident" id="5582251">Paletted</span><span class="op" id="5582259">)</span><span class="op" id="5582260">;</span>&nbsp;<span class="ident" id="5582262">ok</span>&nbsp;<span class="op" id="5582265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582269">palette</span>&nbsp;<span class="op" id="5582277">=</span>&nbsp;<span class="builtinfunc" id="5582279">make</span><span class="op" id="5582283">(</span><span class="op" id="5582284">[</span><span class="op" id="5582285">]</span><span class="op" id="5582286">[</span><span class="num" id="5582287">3</span><span class="op" id="5582288">]</span><span class="builtintype" id="5582289">int32</span><span class="op" id="5582294">,</span>&nbsp;<span class="builtinfunc" id="5582296">len</span><span class="op" id="5582299">(</span><span class="ident" id="5582300">p</span><span class="op" id="5582301">.</span><span class="ident" id="5582302">Palette</span><span class="op" id="5582309">)</span><span class="op" id="5582310">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582314">for</span>&nbsp;<span class="ident" id="5582318">i</span><span class="op" id="5582319">,</span>&nbsp;<span class="ident" id="5582321">col</span>&nbsp;<span class="op" id="5582325">:=</span>&nbsp;<span class="keyword" id="5582328">range</span>&nbsp;<span class="ident" id="5582334">p</span><span class="op" id="5582335">.</span><span class="ident" id="5582336">Palette</span>&nbsp;<span class="op" id="5582344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582349">r</span><span class="op" id="5582350">,</span>&nbsp;<span class="ident" id="5582352">g</span><span class="op" id="5582353">,</span>&nbsp;<span class="ident" id="5582355">b</span><span class="op" id="5582356">,</span>&nbsp;<span class="ident" id="5582358">_</span>&nbsp;<span class="op" id="5582360">:=</span>&nbsp;<span class="ident" id="5582363">col</span><span class="op" id="5582366">.</span><span class="ident" id="5582367">RGBA</span><span class="op" id="5582371">(</span><span class="op" id="5582372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582377">palette</span><span class="op" id="5582384">[</span><span class="ident" id="5582385">i</span><span class="op" id="5582386">]</span><span class="op" id="5582387">[</span><span class="num" id="5582388">0</span><span class="op" id="5582389">]</span>&nbsp;<span class="op" id="5582391">=</span>&nbsp;<span class="builtintype" id="5582393">int32</span><span class="op" id="5582398">(</span><span class="ident" id="5582399">r</span><span class="op" id="5582400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582405">palette</span><span class="op" id="5582412">[</span><span class="ident" id="5582413">i</span><span class="op" id="5582414">]</span><span class="op" id="5582415">[</span><span class="num" id="5582416">1</span><span class="op" id="5582417">]</span>&nbsp;<span class="op" id="5582419">=</span>&nbsp;<span class="builtintype" id="5582421">int32</span><span class="op" id="5582426">(</span><span class="ident" id="5582427">g</span><span class="op" id="5582428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582433">palette</span><span class="op" id="5582440">[</span><span class="ident" id="5582441">i</span><span class="op" id="5582442">]</span><span class="op" id="5582443">[</span><span class="num" id="5582444">2</span><span class="op" id="5582445">]</span>&nbsp;<span class="op" id="5582447">=</span>&nbsp;<span class="builtintype" id="5582449">int32</span><span class="op" id="5582454">(</span><span class="ident" id="5582455">b</span><span class="op" id="5582456">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582464">pix</span><span class="op" id="5582467">,</span>&nbsp;<span class="ident" id="5582469">stride</span>&nbsp;<span class="op" id="5582476">=</span>&nbsp;<span class="ident" id="5582478">p</span><span class="op" id="5582479">.</span><span class="ident" id="5582480">Pix</span><span class="op" id="5582483">[</span><span class="ident" id="5582484">p</span><span class="op" id="5582485">.</span><span class="ident" id="5582486">PixOffset</span><span class="op" id="5582495">(</span><span class="ident" id="5582496">r</span><span class="op" id="5582497">.</span><span class="ident" id="5582498">Min</span><span class="op" id="5582501">.</span><span class="ident" id="5582502">X</span><span class="op" id="5582503">,</span>&nbsp;<span class="ident" id="5582505">r</span><span class="op" id="5582506">.</span><span class="ident" id="5582507">Min</span><span class="op" id="5582510">.</span><span class="ident" id="5582511">Y</span><span class="op" id="5582512">)</span><span class="op" id="5582513">:</span><span class="op" id="5582514">]</span><span class="op" id="5582515">,</span>&nbsp;<span class="ident" id="5582517">p</span><span class="op" id="5582518">.</span><span class="ident" id="5582519">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582531">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582606">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582681">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582737">var</span>&nbsp;<span class="ident" id="5582741">quantErrorCurr</span><span class="op" id="5582755">,</span>&nbsp;<span class="ident" id="5582757">quantErrorNext</span>&nbsp;<span class="op" id="5582772">[</span><span class="op" id="5582773">]</span><span class="op" id="5582774">[</span><span class="num" id="5582775">3</span><span class="op" id="5582776">]</span><span class="builtintype" id="5582777">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582784">if</span>&nbsp;<span class="ident" id="5582787">floydSteinberg</span>&nbsp;<span class="op" id="5582802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582806">quantErrorCurr</span>&nbsp;<span class="op" id="5582821">=</span>&nbsp;<span class="builtinfunc" id="5582823">make</span><span class="op" id="5582827">(</span><span class="op" id="5582828">[</span><span class="op" id="5582829">]</span><span class="op" id="5582830">[</span><span class="num" id="5582831">3</span><span class="op" id="5582832">]</span><span class="builtintype" id="5582833">int32</span><span class="op" id="5582838">,</span>&nbsp;<span class="ident" id="5582840">r</span><span class="op" id="5582841">.</span><span class="ident" id="5582842">Dx</span><span class="op" id="5582844">(</span><span class="op" id="5582845">)</span><span class="op" id="5582846">+</span><span class="num" id="5582847">2</span><span class="op" id="5582848">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582852">quantErrorNext</span>&nbsp;<span class="op" id="5582867">=</span>&nbsp;<span class="builtinfunc" id="5582869">make</span><span class="op" id="5582873">(</span><span class="op" id="5582874">[</span><span class="op" id="5582875">]</span><span class="op" id="5582876">[</span><span class="num" id="5582877">3</span><span class="op" id="5582878">]</span><span class="builtintype" id="5582879">int32</span><span class="op" id="5582884">,</span>&nbsp;<span class="ident" id="5582886">r</span><span class="op" id="5582887">.</span><span class="ident" id="5582888">Dx</span><span class="op" id="5582890">(</span><span class="op" id="5582891">)</span><span class="op" id="5582892">+</span><span class="num" id="5582893">2</span><span class="op" id="5582894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5582901">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582934">out</span>&nbsp;<span class="op" id="5582938">:=</span>&nbsp;<span class="ident" id="5582941">color</span><span class="op" id="5582946">.</span><span class="ident" id="5582947">RGBA64</span><span class="op" id="5582953">{</span><span class="ident" id="5582954">A</span><span class="op" id="5582955">:</span>&nbsp;<span class="num" id="5582957">0xffff</span><span class="op" id="5582963">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582966">for</span>&nbsp;<span class="ident" id="5582970">y</span>&nbsp;<span class="op" id="5582972">:=</span>&nbsp;<span class="num" id="5582975">0</span><span class="op" id="5582976">;</span>&nbsp;<span class="ident" id="5582978">y</span>&nbsp;<span class="op" id="5582980">!=</span>&nbsp;<span class="ident" id="5582983">r</span><span class="op" id="5582984">.</span><span class="ident" id="5582985">Dy</span><span class="op" id="5582987">(</span><span class="op" id="5582988">)</span><span class="op" id="5582989">;</span>&nbsp;<span class="ident" id="5582991">y</span><span class="op" id="5582992">++</span>&nbsp;<span class="op" id="5582995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582999">for</span>&nbsp;<span class="ident" id="5583003">x</span>&nbsp;<span class="op" id="5583005">:=</span>&nbsp;<span class="num" id="5583008">0</span><span class="op" id="5583009">;</span>&nbsp;<span class="ident" id="5583011">x</span>&nbsp;<span class="op" id="5583013">!=</span>&nbsp;<span class="ident" id="5583016">r</span><span class="op" id="5583017">.</span><span class="ident" id="5583018">Dx</span><span class="op" id="5583020">(</span><span class="op" id="5583021">)</span><span class="op" id="5583022">;</span>&nbsp;<span class="ident" id="5583024">x</span><span class="op" id="5583025">++</span>&nbsp;<span class="op" id="5583028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583033">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583091">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583129">sr</span><span class="op" id="5583131">,</span>&nbsp;<span class="ident" id="5583133">sg</span><span class="op" id="5583135">,</span>&nbsp;<span class="ident" id="5583137">sb</span><span class="op" id="5583139">,</span>&nbsp;<span class="ident" id="5583141">_</span>&nbsp;<span class="op" id="5583143">:=</span>&nbsp;<span class="ident" id="5583146">src</span><span class="op" id="5583149">.</span><span class="ident" id="5583150">At</span><span class="op" id="5583152">(</span><span class="ident" id="5583153">sp</span><span class="op" id="5583155">.</span><span class="ident" id="5583156">X</span><span class="op" id="5583157">+</span><span class="ident" id="5583158">x</span><span class="op" id="5583159">,</span>&nbsp;<span class="ident" id="5583161">sp</span><span class="op" id="5583163">.</span><span class="ident" id="5583164">Y</span><span class="op" id="5583165">+</span><span class="ident" id="5583166">y</span><span class="op" id="5583167">)</span><span class="op" id="5583168">.</span><span class="ident" id="5583169">RGBA</span><span class="op" id="5583173">(</span><span class="op" id="5583174">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583179">er</span><span class="op" id="5583181">,</span>&nbsp;<span class="ident" id="5583183">eg</span><span class="op" id="5583185">,</span>&nbsp;<span class="ident" id="5583187">eb</span>&nbsp;<span class="op" id="5583190">:=</span>&nbsp;<span class="builtintype" id="5583193">int32</span><span class="op" id="5583198">(</span><span class="ident" id="5583199">sr</span><span class="op" id="5583201">)</span><span class="op" id="5583202">,</span>&nbsp;<span class="builtintype" id="5583204">int32</span><span class="op" id="5583209">(</span><span class="ident" id="5583210">sg</span><span class="op" id="5583212">)</span><span class="op" id="5583213">,</span>&nbsp;<span class="builtintype" id="5583215">int32</span><span class="op" id="5583220">(</span><span class="ident" id="5583221">sb</span><span class="op" id="5583223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583228">if</span>&nbsp;<span class="ident" id="5583231">floydSteinberg</span>&nbsp;<span class="op" id="5583246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583252">er</span>&nbsp;<span class="op" id="5583255">=</span>&nbsp;<span class="ident" id="5583257">clamp</span><span class="op" id="5583262">(</span><span class="ident" id="5583263">er</span>&nbsp;<span class="op" id="5583266">+</span>&nbsp;<span class="ident" id="5583268">quantErrorCurr</span><span class="op" id="5583282">[</span><span class="ident" id="5583283">x</span><span class="op" id="5583284">+</span><span class="num" id="5583285">1</span><span class="op" id="5583286">]</span><span class="op" id="5583287">[</span><span class="num" id="5583288">0</span><span class="op" id="5583289">]</span><span class="op" id="5583290">/</span><span class="num" id="5583291">16</span><span class="op" id="5583293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583299">eg</span>&nbsp;<span class="op" id="5583302">=</span>&nbsp;<span class="ident" id="5583304">clamp</span><span class="op" id="5583309">(</span><span class="ident" id="5583310">eg</span>&nbsp;<span class="op" id="5583313">+</span>&nbsp;<span class="ident" id="5583315">quantErrorCurr</span><span class="op" id="5583329">[</span><span class="ident" id="5583330">x</span><span class="op" id="5583331">+</span><span class="num" id="5583332">1</span><span class="op" id="5583333">]</span><span class="op" id="5583334">[</span><span class="num" id="5583335">1</span><span class="op" id="5583336">]</span><span class="op" id="5583337">/</span><span class="num" id="5583338">16</span><span class="op" id="5583340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583346">eb</span>&nbsp;<span class="op" id="5583349">=</span>&nbsp;<span class="ident" id="5583351">clamp</span><span class="op" id="5583356">(</span><span class="ident" id="5583357">eb</span>&nbsp;<span class="op" id="5583360">+</span>&nbsp;<span class="ident" id="5583362">quantErrorCurr</span><span class="op" id="5583376">[</span><span class="ident" id="5583377">x</span><span class="op" id="5583378">+</span><span class="num" id="5583379">1</span><span class="op" id="5583380">]</span><span class="op" id="5583381">[</span><span class="num" id="5583382">2</span><span class="op" id="5583383">]</span><span class="op" id="5583384">/</span><span class="num" id="5583385">16</span><span class="op" id="5583387">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583398">if</span>&nbsp;<span class="ident" id="5583401">palette</span>&nbsp;<span class="op" id="5583409">!=</span>&nbsp;<span class="ident" id="5583412">nil</span>&nbsp;<span class="op" id="5583416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583422">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583490">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583558">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583627">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583679">bestIndex</span><span class="op" id="5583688">,</span>&nbsp;<span class="ident" id="5583690">bestSSD</span>&nbsp;<span class="op" id="5583698">:=</span>&nbsp;<span class="num" id="5583701">0</span><span class="op" id="5583702">,</span>&nbsp;<span class="builtintype" id="5583704">uint32</span><span class="op" id="5583710">(</span><span class="num" id="5583711">1</span><span class="op" id="5583712">&lt;&lt;</span><span class="num" id="5583714">32</span><span class="op" id="5583716">-</span><span class="num" id="5583717">1</span><span class="op" id="5583718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583724">for</span>&nbsp;<span class="ident" id="5583728">index</span><span class="op" id="5583733">,</span>&nbsp;<span class="ident" id="5583735">p</span>&nbsp;<span class="op" id="5583737">:=</span>&nbsp;<span class="keyword" id="5583740">range</span>&nbsp;<span class="ident" id="5583746">palette</span>&nbsp;<span class="op" id="5583754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583761">delta</span>&nbsp;<span class="op" id="5583767">:=</span>&nbsp;<span class="op" id="5583770">(</span><span class="ident" id="5583771">er</span>&nbsp;<span class="op" id="5583774">-</span>&nbsp;<span class="ident" id="5583776">p</span><span class="op" id="5583777">[</span><span class="num" id="5583778">0</span><span class="op" id="5583779">]</span><span class="op" id="5583780">)</span>&nbsp;<span class="op" id="5583782">&gt;&gt;</span>&nbsp;<span class="num" id="5583785">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583792">ssd</span>&nbsp;<span class="op" id="5583796">:=</span>&nbsp;<span class="builtintype" id="5583799">uint32</span><span class="op" id="5583805">(</span><span class="ident" id="5583806">delta</span>&nbsp;<span class="op" id="5583812">*</span>&nbsp;<span class="ident" id="5583814">delta</span><span class="op" id="5583819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583826">delta</span>&nbsp;<span class="op" id="5583832">=</span>&nbsp;<span class="op" id="5583834">(</span><span class="ident" id="5583835">eg</span>&nbsp;<span class="op" id="5583838">-</span>&nbsp;<span class="ident" id="5583840">p</span><span class="op" id="5583841">[</span><span class="num" id="5583842">1</span><span class="op" id="5583843">]</span><span class="op" id="5583844">)</span>&nbsp;<span class="op" id="5583846">&gt;&gt;</span>&nbsp;<span class="num" id="5583849">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583856">ssd</span>&nbsp;<span class="op" id="5583860">+=</span>&nbsp;<span class="builtintype" id="5583863">uint32</span><span class="op" id="5583869">(</span><span class="ident" id="5583870">delta</span>&nbsp;<span class="op" id="5583876">*</span>&nbsp;<span class="ident" id="5583878">delta</span><span class="op" id="5583883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583890">delta</span>&nbsp;<span class="op" id="5583896">=</span>&nbsp;<span class="op" id="5583898">(</span><span class="ident" id="5583899">eb</span>&nbsp;<span class="op" id="5583902">-</span>&nbsp;<span class="ident" id="5583904">p</span><span class="op" id="5583905">[</span><span class="num" id="5583906">2</span><span class="op" id="5583907">]</span><span class="op" id="5583908">)</span>&nbsp;<span class="op" id="5583910">&gt;&gt;</span>&nbsp;<span class="num" id="5583913">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583920">ssd</span>&nbsp;<span class="op" id="5583924">+=</span>&nbsp;<span class="builtintype" id="5583927">uint32</span><span class="op" id="5583933">(</span><span class="ident" id="5583934">delta</span>&nbsp;<span class="op" id="5583940">*</span>&nbsp;<span class="ident" id="5583942">delta</span><span class="op" id="5583947">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583954">if</span>&nbsp;<span class="ident" id="5583957">ssd</span>&nbsp;<span class="op" id="5583961">&lt;</span>&nbsp;<span class="ident" id="5583963">bestSSD</span>&nbsp;<span class="op" id="5583971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583979">bestIndex</span><span class="op" id="5583988">,</span>&nbsp;<span class="ident" id="5583990">bestSSD</span>&nbsp;<span class="op" id="5583998">=</span>&nbsp;<span class="ident" id="5584000">index</span><span class="op" id="5584005">,</span>&nbsp;<span class="ident" id="5584007">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584017">if</span>&nbsp;<span class="ident" id="5584020">ssd</span>&nbsp;<span class="op" id="5584024">==</span>&nbsp;<span class="num" id="5584027">0</span>&nbsp;<span class="op" id="5584029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584038">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584050">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584069">pix</span><span class="op" id="5584072">[</span><span class="ident" id="5584073">y</span><span class="op" id="5584074">*</span><span class="ident" id="5584075">stride</span><span class="op" id="5584081">+</span><span class="ident" id="5584082">x</span><span class="op" id="5584083">]</span>&nbsp;<span class="op" id="5584085">=</span>&nbsp;<span class="builtintype" id="5584087">byte</span><span class="op" id="5584091">(</span><span class="ident" id="5584092">bestIndex</span><span class="op" id="5584101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584108">if</span>&nbsp;<span class="op" id="5584111">!</span><span class="ident" id="5584112">floydSteinberg</span>&nbsp;<span class="op" id="5584127">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584134">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584153">er</span>&nbsp;<span class="op" id="5584156">-=</span>&nbsp;<span class="builtintype" id="5584159">int32</span><span class="op" id="5584164">(</span><span class="ident" id="5584165">palette</span><span class="op" id="5584172">[</span><span class="ident" id="5584173">bestIndex</span><span class="op" id="5584182">]</span><span class="op" id="5584183">[</span><span class="num" id="5584184">0</span><span class="op" id="5584185">]</span><span class="op" id="5584186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584192">eg</span>&nbsp;<span class="op" id="5584195">-=</span>&nbsp;<span class="builtintype" id="5584198">int32</span><span class="op" id="5584203">(</span><span class="ident" id="5584204">palette</span><span class="op" id="5584211">[</span><span class="ident" id="5584212">bestIndex</span><span class="op" id="5584221">]</span><span class="op" id="5584222">[</span><span class="num" id="5584223">1</span><span class="op" id="5584224">]</span><span class="op" id="5584225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584231">eb</span>&nbsp;<span class="op" id="5584234">-=</span>&nbsp;<span class="builtintype" id="5584237">int32</span><span class="op" id="5584242">(</span><span class="ident" id="5584243">palette</span><span class="op" id="5584250">[</span><span class="ident" id="5584251">bestIndex</span><span class="op" id="5584260">]</span><span class="op" id="5584261">[</span><span class="num" id="5584262">2</span><span class="op" id="5584263">]</span><span class="op" id="5584264">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584270">}</span>&nbsp;<span class="keyword" id="5584272">else</span>&nbsp;<span class="op" id="5584277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584283">out</span><span class="op" id="5584286">.</span><span class="ident" id="5584287">R</span>&nbsp;<span class="op" id="5584289">=</span>&nbsp;<span class="builtintype" id="5584291">uint16</span><span class="op" id="5584297">(</span><span class="ident" id="5584298">er</span><span class="op" id="5584300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584306">out</span><span class="op" id="5584309">.</span><span class="ident" id="5584310">G</span>&nbsp;<span class="op" id="5584312">=</span>&nbsp;<span class="builtintype" id="5584314">uint16</span><span class="op" id="5584320">(</span><span class="ident" id="5584321">eg</span><span class="op" id="5584323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584329">out</span><span class="op" id="5584332">.</span><span class="ident" id="5584333">B</span>&nbsp;<span class="op" id="5584335">=</span>&nbsp;<span class="builtintype" id="5584337">uint16</span><span class="op" id="5584343">(</span><span class="ident" id="5584344">eb</span><span class="op" id="5584346">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584352">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584413">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584478">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584541">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584602">dst</span><span class="op" id="5584605">.</span><span class="ident" id="5584606">Set</span><span class="op" id="5584609">(</span><span class="ident" id="5584610">r</span><span class="op" id="5584611">.</span><span class="ident" id="5584612">Min</span><span class="op" id="5584615">.</span><span class="ident" id="5584616">X</span><span class="op" id="5584617">+</span><span class="ident" id="5584618">x</span><span class="op" id="5584619">,</span>&nbsp;<span class="ident" id="5584621">r</span><span class="op" id="5584622">.</span><span class="ident" id="5584623">Min</span><span class="op" id="5584626">.</span><span class="ident" id="5584627">Y</span><span class="op" id="5584628">+</span><span class="ident" id="5584629">y</span><span class="op" id="5584630">,</span>&nbsp;<span class="op" id="5584632">&amp;</span><span class="ident" id="5584633">out</span><span class="op" id="5584636">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584643">if</span>&nbsp;<span class="op" id="5584646">!</span><span class="ident" id="5584647">floydSteinberg</span>&nbsp;<span class="op" id="5584662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584669">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584688">sr</span><span class="op" id="5584690">,</span>&nbsp;<span class="ident" id="5584692">sg</span><span class="op" id="5584694">,</span>&nbsp;<span class="ident" id="5584696">sb</span><span class="op" id="5584698">,</span>&nbsp;<span class="ident" id="5584700">_</span>&nbsp;<span class="op" id="5584702">=</span>&nbsp;<span class="ident" id="5584704">dst</span><span class="op" id="5584707">.</span><span class="ident" id="5584708">At</span><span class="op" id="5584710">(</span><span class="ident" id="5584711">r</span><span class="op" id="5584712">.</span><span class="ident" id="5584713">Min</span><span class="op" id="5584716">.</span><span class="ident" id="5584717">X</span><span class="op" id="5584718">+</span><span class="ident" id="5584719">x</span><span class="op" id="5584720">,</span>&nbsp;<span class="ident" id="5584722">r</span><span class="op" id="5584723">.</span><span class="ident" id="5584724">Min</span><span class="op" id="5584727">.</span><span class="ident" id="5584728">Y</span><span class="op" id="5584729">+</span><span class="ident" id="5584730">y</span><span class="op" id="5584731">)</span><span class="op" id="5584732">.</span><span class="ident" id="5584733">RGBA</span><span class="op" id="5584737">(</span><span class="op" id="5584738">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584744">er</span>&nbsp;<span class="op" id="5584747">-=</span>&nbsp;<span class="builtintype" id="5584750">int32</span><span class="op" id="5584755">(</span><span class="ident" id="5584756">sr</span><span class="op" id="5584758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584764">eg</span>&nbsp;<span class="op" id="5584767">-=</span>&nbsp;<span class="builtintype" id="5584770">int32</span><span class="op" id="5584775">(</span><span class="ident" id="5584776">sg</span><span class="op" id="5584778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584784">eb</span>&nbsp;<span class="op" id="5584787">-=</span>&nbsp;<span class="builtintype" id="5584790">int32</span><span class="op" id="5584795">(</span><span class="ident" id="5584796">sb</span><span class="op" id="5584798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584809">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584865">quantErrorNext</span><span class="op" id="5584879">[</span><span class="ident" id="5584880">x</span><span class="op" id="5584881">+</span><span class="num" id="5584882">0</span><span class="op" id="5584883">]</span><span class="op" id="5584884">[</span><span class="num" id="5584885">0</span><span class="op" id="5584886">]</span>&nbsp;<span class="op" id="5584888">+=</span>&nbsp;<span class="ident" id="5584891">er</span>&nbsp;<span class="op" id="5584894">*</span>&nbsp;<span class="num" id="5584896">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584901">quantErrorNext</span><span class="op" id="5584915">[</span><span class="ident" id="5584916">x</span><span class="op" id="5584917">+</span><span class="num" id="5584918">0</span><span class="op" id="5584919">]</span><span class="op" id="5584920">[</span><span class="num" id="5584921">1</span><span class="op" id="5584922">]</span>&nbsp;<span class="op" id="5584924">+=</span>&nbsp;<span class="ident" id="5584927">eg</span>&nbsp;<span class="op" id="5584930">*</span>&nbsp;<span class="num" id="5584932">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584937">quantErrorNext</span><span class="op" id="5584951">[</span><span class="ident" id="5584952">x</span><span class="op" id="5584953">+</span><span class="num" id="5584954">0</span><span class="op" id="5584955">]</span><span class="op" id="5584956">[</span><span class="num" id="5584957">2</span><span class="op" id="5584958">]</span>&nbsp;<span class="op" id="5584960">+=</span>&nbsp;<span class="ident" id="5584963">eb</span>&nbsp;<span class="op" id="5584966">*</span>&nbsp;<span class="num" id="5584968">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584973">quantErrorNext</span><span class="op" id="5584987">[</span><span class="ident" id="5584988">x</span><span class="op" id="5584989">+</span><span class="num" id="5584990">1</span><span class="op" id="5584991">]</span><span class="op" id="5584992">[</span><span class="num" id="5584993">0</span><span class="op" id="5584994">]</span>&nbsp;<span class="op" id="5584996">+=</span>&nbsp;<span class="ident" id="5584999">er</span>&nbsp;<span class="op" id="5585002">*</span>&nbsp;<span class="num" id="5585004">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585009">quantErrorNext</span><span class="op" id="5585023">[</span><span class="ident" id="5585024">x</span><span class="op" id="5585025">+</span><span class="num" id="5585026">1</span><span class="op" id="5585027">]</span><span class="op" id="5585028">[</span><span class="num" id="5585029">1</span><span class="op" id="5585030">]</span>&nbsp;<span class="op" id="5585032">+=</span>&nbsp;<span class="ident" id="5585035">eg</span>&nbsp;<span class="op" id="5585038">*</span>&nbsp;<span class="num" id="5585040">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585045">quantErrorNext</span><span class="op" id="5585059">[</span><span class="ident" id="5585060">x</span><span class="op" id="5585061">+</span><span class="num" id="5585062">1</span><span class="op" id="5585063">]</span><span class="op" id="5585064">[</span><span class="num" id="5585065">2</span><span class="op" id="5585066">]</span>&nbsp;<span class="op" id="5585068">+=</span>&nbsp;<span class="ident" id="5585071">eb</span>&nbsp;<span class="op" id="5585074">*</span>&nbsp;<span class="num" id="5585076">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585081">quantErrorNext</span><span class="op" id="5585095">[</span><span class="ident" id="5585096">x</span><span class="op" id="5585097">+</span><span class="num" id="5585098">2</span><span class="op" id="5585099">]</span><span class="op" id="5585100">[</span><span class="num" id="5585101">0</span><span class="op" id="5585102">]</span>&nbsp;<span class="op" id="5585104">+=</span>&nbsp;<span class="ident" id="5585107">er</span>&nbsp;<span class="op" id="5585110">*</span>&nbsp;<span class="num" id="5585112">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585117">quantErrorNext</span><span class="op" id="5585131">[</span><span class="ident" id="5585132">x</span><span class="op" id="5585133">+</span><span class="num" id="5585134">2</span><span class="op" id="5585135">]</span><span class="op" id="5585136">[</span><span class="num" id="5585137">1</span><span class="op" id="5585138">]</span>&nbsp;<span class="op" id="5585140">+=</span>&nbsp;<span class="ident" id="5585143">eg</span>&nbsp;<span class="op" id="5585146">*</span>&nbsp;<span class="num" id="5585148">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585153">quantErrorNext</span><span class="op" id="5585167">[</span><span class="ident" id="5585168">x</span><span class="op" id="5585169">+</span><span class="num" id="5585170">2</span><span class="op" id="5585171">]</span><span class="op" id="5585172">[</span><span class="num" id="5585173">2</span><span class="op" id="5585174">]</span>&nbsp;<span class="op" id="5585176">+=</span>&nbsp;<span class="ident" id="5585179">eb</span>&nbsp;<span class="op" id="5585182">*</span>&nbsp;<span class="num" id="5585184">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585189">quantErrorCurr</span><span class="op" id="5585203">[</span><span class="ident" id="5585204">x</span><span class="op" id="5585205">+</span><span class="num" id="5585206">2</span><span class="op" id="5585207">]</span><span class="op" id="5585208">[</span><span class="num" id="5585209">0</span><span class="op" id="5585210">]</span>&nbsp;<span class="op" id="5585212">+=</span>&nbsp;<span class="ident" id="5585215">er</span>&nbsp;<span class="op" id="5585218">*</span>&nbsp;<span class="num" id="5585220">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585225">quantErrorCurr</span><span class="op" id="5585239">[</span><span class="ident" id="5585240">x</span><span class="op" id="5585241">+</span><span class="num" id="5585242">2</span><span class="op" id="5585243">]</span><span class="op" id="5585244">[</span><span class="num" id="5585245">1</span><span class="op" id="5585246">]</span>&nbsp;<span class="op" id="5585248">+=</span>&nbsp;<span class="ident" id="5585251">eg</span>&nbsp;<span class="op" id="5585254">*</span>&nbsp;<span class="num" id="5585256">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585261">quantErrorCurr</span><span class="op" id="5585275">[</span><span class="ident" id="5585276">x</span><span class="op" id="5585277">+</span><span class="num" id="5585278">2</span><span class="op" id="5585279">]</span><span class="op" id="5585280">[</span><span class="num" id="5585281">2</span><span class="op" id="5585282">]</span>&nbsp;<span class="op" id="5585284">+=</span>&nbsp;<span class="ident" id="5585287">eb</span>&nbsp;<span class="op" id="5585290">*</span>&nbsp;<span class="num" id="5585292">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5585301">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585346">if</span>&nbsp;<span class="ident" id="5585349">floydSteinberg</span>&nbsp;<span class="op" id="5585364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585369">quantErrorCurr</span><span class="op" id="5585383">,</span>&nbsp;<span class="ident" id="5585385">quantErrorNext</span>&nbsp;<span class="op" id="5585400">=</span>&nbsp;<span class="ident" id="5585402">quantErrorNext</span><span class="op" id="5585416">,</span>&nbsp;<span class="ident" id="5585418">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585436">for</span>&nbsp;<span class="ident" id="5585440">i</span>&nbsp;<span class="op" id="5585442">:=</span>&nbsp;<span class="keyword" id="5585445">range</span>&nbsp;<span class="ident" id="5585451">quantErrorNext</span>&nbsp;<span class="op" id="5585466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585472">quantErrorNext</span><span class="op" id="5585486">[</span><span class="ident" id="5585487">i</span><span class="op" id="5585488">]</span>&nbsp;<span class="op" id="5585490">=</span>&nbsp;<span class="op" id="5585492">[</span><span class="num" id="5585493">3</span><span class="op" id="5585494">]</span><span class="builtintype" id="5585495">int32</span><span class="op" id="5585500">{</span><span class="op" id="5585501">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585513">}</span><br>
<span class="lineno"></span><span class="op" id="5585515">}</span>
</div>
</body>
</html>
