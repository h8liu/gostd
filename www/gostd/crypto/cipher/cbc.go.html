<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3116039">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3116094">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3116148">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3116199">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116237">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3116311">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3116384">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3116418">package</span>&nbsp;<span class="ident" id="3116426">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3116434">type</span>&nbsp;<span class="ident" id="3116439">cbc</span>&nbsp;<span class="keyword" id="3116443">struct</span>&nbsp;<span class="op" id="3116450">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116453">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116463">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116470">blockSize</span>&nbsp;<span class="builtintype" id="3116480">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116485">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116495">[</span><span class="op" id="3116496">]</span><span class="builtintype" id="3116497">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116503">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116513">[</span><span class="op" id="3116514">]</span><span class="builtintype" id="3116515">byte</span><br>
<span class="lineno"></span><span class="op" id="3116520">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3116523">func</span>&nbsp;<span class="ident" id="3116528">newCBC</span><span class="op" id="3116534">(</span><span class="ident" id="3116535">b</span>&nbsp;<span class="ident" id="3116537">Block</span><span class="op" id="3116542">,</span>&nbsp;<span class="ident" id="3116544">iv</span>&nbsp;<span class="op" id="3116547">[</span><span class="op" id="3116548">]</span><span class="builtintype" id="3116549">byte</span><span class="op" id="3116553">)</span>&nbsp;<span class="op" id="3116555">*</span><span class="ident" id="3116556">cbc</span>&nbsp;<span class="op" id="3116560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116563">return</span>&nbsp;<span class="op" id="3116570">&amp;</span><span class="ident" id="3116571">cbc</span><span class="op" id="3116574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116578">b</span><span class="op" id="3116579">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116589">b</span><span class="op" id="3116590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116594">blockSize</span><span class="op" id="3116603">:</span>&nbsp;<span class="ident" id="3116605">b</span><span class="op" id="3116606">.</span><span class="ident" id="3116607">BlockSize</span><span class="op" id="3116616">(</span><span class="op" id="3116617">)</span><span class="op" id="3116618">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116622">iv</span><span class="op" id="3116624">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116633">dup</span><span class="op" id="3116636">(</span><span class="ident" id="3116637">iv</span><span class="op" id="3116639">)</span><span class="op" id="3116640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116644">tmp</span><span class="op" id="3116647">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3116655">make</span><span class="op" id="3116659">(</span><span class="op" id="3116660">[</span><span class="op" id="3116661">]</span><span class="builtintype" id="3116662">byte</span><span class="op" id="3116666">,</span>&nbsp;<span class="ident" id="3116668">b</span><span class="op" id="3116669">.</span><span class="ident" id="3116670">BlockSize</span><span class="op" id="3116679">(</span><span class="op" id="3116680">)</span><span class="op" id="3116681">)</span><span class="op" id="3116682">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116685">}</span><br>
<span class="lineno"></span><span class="op" id="3116687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3116690">type</span>&nbsp;<span class="ident" id="3116695">cbcEncrypter</span>&nbsp;<span class="ident" id="3116708">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116713">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3116792">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3116865">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3116888">func</span>&nbsp;<span class="ident" id="3116893">NewCBCEncrypter</span><span class="op" id="3116908">(</span><span class="ident" id="3116909">b</span>&nbsp;<span class="ident" id="3116911">Block</span><span class="op" id="3116916">,</span>&nbsp;<span class="ident" id="3116918">iv</span>&nbsp;<span class="op" id="3116921">[</span><span class="op" id="3116922">]</span><span class="builtintype" id="3116923">byte</span><span class="op" id="3116927">)</span>&nbsp;<span class="ident" id="3116929">BlockMode</span>&nbsp;<span class="op" id="3116939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116942">if</span>&nbsp;<span class="builtinfunc" id="3116945">len</span><span class="op" id="3116948">(</span><span class="ident" id="3116949">iv</span><span class="op" id="3116951">)</span>&nbsp;<span class="op" id="3116953">!=</span>&nbsp;<span class="ident" id="3116956">b</span><span class="op" id="3116957">.</span><span class="ident" id="3116958">BlockSize</span><span class="op" id="3116967">(</span><span class="op" id="3116968">)</span>&nbsp;<span class="op" id="3116970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3116974">panic</span><span class="op" id="3116979">(</span><span class="string" id="3116980">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3117037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117043">return</span>&nbsp;<span class="op" id="3117050">(</span><span class="op" id="3117051">*</span><span class="ident" id="3117052">cbcEncrypter</span><span class="op" id="3117064">)</span><span class="op" id="3117065">(</span><span class="ident" id="3117066">newCBC</span><span class="op" id="3117072">(</span><span class="ident" id="3117073">b</span><span class="op" id="3117074">,</span>&nbsp;<span class="ident" id="3117076">iv</span><span class="op" id="3117078">)</span><span class="op" id="3117079">)</span><br>
<span class="lineno">40</span><span class="op" id="3117081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3117084">func</span>&nbsp;<span class="op" id="3117089">(</span><span class="ident" id="3117090">x</span>&nbsp;<span class="op" id="3117092">*</span><span class="ident" id="3117093">cbcEncrypter</span><span class="op" id="3117105">)</span>&nbsp;<span class="ident" id="3117107">BlockSize</span><span class="op" id="3117116">(</span><span class="op" id="3117117">)</span>&nbsp;<span class="builtintype" id="3117119">int</span>&nbsp;<span class="op" id="3117123">{</span>&nbsp;<span class="keyword" id="3117125">return</span>&nbsp;<span class="ident" id="3117132">x</span><span class="op" id="3117133">.</span><span class="ident" id="3117134">blockSize</span>&nbsp;<span class="op" id="3117144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3117147">func</span>&nbsp;<span class="op" id="3117152">(</span><span class="ident" id="3117153">x</span>&nbsp;<span class="op" id="3117155">*</span><span class="ident" id="3117156">cbcEncrypter</span><span class="op" id="3117168">)</span>&nbsp;<span class="ident" id="3117170">CryptBlocks</span><span class="op" id="3117181">(</span><span class="ident" id="3117182">dst</span><span class="op" id="3117185">,</span>&nbsp;<span class="ident" id="3117187">src</span>&nbsp;<span class="op" id="3117191">[</span><span class="op" id="3117192">]</span><span class="builtintype" id="3117193">byte</span><span class="op" id="3117197">)</span>&nbsp;<span class="op" id="3117199">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117202">if</span>&nbsp;<span class="builtinfunc" id="3117205">len</span><span class="op" id="3117208">(</span><span class="ident" id="3117209">src</span><span class="op" id="3117212">)</span><span class="op" id="3117213">%</span><span class="ident" id="3117214">x</span><span class="op" id="3117215">.</span><span class="ident" id="3117216">blockSize</span>&nbsp;<span class="op" id="3117226">!=</span>&nbsp;<span class="num" id="3117229">0</span>&nbsp;<span class="op" id="3117231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3117235">panic</span><span class="op" id="3117240">(</span><span class="string" id="3117241">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3117279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117285">if</span>&nbsp;<span class="builtinfunc" id="3117288">len</span><span class="op" id="3117291">(</span><span class="ident" id="3117292">dst</span><span class="op" id="3117295">)</span>&nbsp;<span class="op" id="3117297">&lt;</span>&nbsp;<span class="builtinfunc" id="3117299">len</span><span class="op" id="3117302">(</span><span class="ident" id="3117303">src</span><span class="op" id="3117306">)</span>&nbsp;<span class="op" id="3117308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3117312">panic</span><span class="op" id="3117317">(</span><span class="string" id="3117318">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3117360">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117367">iv</span>&nbsp;<span class="op" id="3117370">:=</span>&nbsp;<span class="ident" id="3117373">x</span><span class="op" id="3117374">.</span><span class="ident" id="3117375">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117380">for</span>&nbsp;<span class="builtinfunc" id="3117384">len</span><span class="op" id="3117387">(</span><span class="ident" id="3117388">src</span><span class="op" id="3117391">)</span>&nbsp;<span class="op" id="3117393">&gt;</span>&nbsp;<span class="num" id="3117395">0</span>&nbsp;<span class="op" id="3117397">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3117401">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117451">xorBytes</span><span class="op" id="3117459">(</span><span class="ident" id="3117460">dst</span><span class="op" id="3117463">[</span><span class="op" id="3117464">:</span><span class="ident" id="3117465">x</span><span class="op" id="3117466">.</span><span class="ident" id="3117467">blockSize</span><span class="op" id="3117476">]</span><span class="op" id="3117477">,</span>&nbsp;<span class="ident" id="3117479">src</span><span class="op" id="3117482">[</span><span class="op" id="3117483">:</span><span class="ident" id="3117484">x</span><span class="op" id="3117485">.</span><span class="ident" id="3117486">blockSize</span><span class="op" id="3117495">]</span><span class="op" id="3117496">,</span>&nbsp;<span class="ident" id="3117498">iv</span><span class="op" id="3117500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117504">x</span><span class="op" id="3117505">.</span><span class="ident" id="3117506">b</span><span class="op" id="3117507">.</span><span class="ident" id="3117508">Encrypt</span><span class="op" id="3117515">(</span><span class="ident" id="3117516">dst</span><span class="op" id="3117519">[</span><span class="op" id="3117520">:</span><span class="ident" id="3117521">x</span><span class="op" id="3117522">.</span><span class="ident" id="3117523">blockSize</span><span class="op" id="3117532">]</span><span class="op" id="3117533">,</span>&nbsp;<span class="ident" id="3117535">dst</span><span class="op" id="3117538">[</span><span class="op" id="3117539">:</span><span class="ident" id="3117540">x</span><span class="op" id="3117541">.</span><span class="ident" id="3117542">blockSize</span><span class="op" id="3117551">]</span><span class="op" id="3117552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3117557">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117617">iv</span>&nbsp;<span class="op" id="3117620">=</span>&nbsp;<span class="ident" id="3117622">dst</span><span class="op" id="3117625">[</span><span class="op" id="3117626">:</span><span class="ident" id="3117627">x</span><span class="op" id="3117628">.</span><span class="ident" id="3117629">blockSize</span><span class="op" id="3117638">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117642">src</span>&nbsp;<span class="op" id="3117646">=</span>&nbsp;<span class="ident" id="3117648">src</span><span class="op" id="3117651">[</span><span class="ident" id="3117652">x</span><span class="op" id="3117653">.</span><span class="ident" id="3117654">blockSize</span><span class="op" id="3117663">:</span><span class="op" id="3117664">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117668">dst</span>&nbsp;<span class="op" id="3117672">=</span>&nbsp;<span class="ident" id="3117674">dst</span><span class="op" id="3117677">[</span><span class="ident" id="3117678">x</span><span class="op" id="3117679">.</span><span class="ident" id="3117680">blockSize</span><span class="op" id="3117689">:</span><span class="op" id="3117690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3117697">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3117744">copy</span><span class="op" id="3117748">(</span><span class="ident" id="3117749">x</span><span class="op" id="3117750">.</span><span class="ident" id="3117751">iv</span><span class="op" id="3117753">,</span>&nbsp;<span class="ident" id="3117755">iv</span><span class="op" id="3117757">)</span><br>
<span class="lineno"></span><span class="op" id="3117759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3117762">func</span>&nbsp;<span class="op" id="3117767">(</span><span class="ident" id="3117768">x</span>&nbsp;<span class="op" id="3117770">*</span><span class="ident" id="3117771">cbcEncrypter</span><span class="op" id="3117783">)</span>&nbsp;<span class="ident" id="3117785">SetIV</span><span class="op" id="3117790">(</span><span class="ident" id="3117791">iv</span>&nbsp;<span class="op" id="3117794">[</span><span class="op" id="3117795">]</span><span class="builtintype" id="3117796">byte</span><span class="op" id="3117800">)</span>&nbsp;<span class="op" id="3117802">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117805">if</span>&nbsp;<span class="builtinfunc" id="3117808">len</span><span class="op" id="3117811">(</span><span class="ident" id="3117812">iv</span><span class="op" id="3117814">)</span>&nbsp;<span class="op" id="3117816">!=</span>&nbsp;<span class="builtinfunc" id="3117819">len</span><span class="op" id="3117822">(</span><span class="ident" id="3117823">x</span><span class="op" id="3117824">.</span><span class="ident" id="3117825">iv</span><span class="op" id="3117827">)</span>&nbsp;<span class="op" id="3117829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3117833">panic</span><span class="op" id="3117838">(</span><span class="string" id="3117839">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3117868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3117874">copy</span><span class="op" id="3117878">(</span><span class="ident" id="3117879">x</span><span class="op" id="3117880">.</span><span class="ident" id="3117881">iv</span><span class="op" id="3117883">,</span>&nbsp;<span class="ident" id="3117885">iv</span><span class="op" id="3117887">)</span><br>
<span class="lineno"></span><span class="op" id="3117889">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3117892">type</span>&nbsp;<span class="ident" id="3117897">cbcDecrypter</span>&nbsp;<span class="ident" id="3117910">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3117915">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3117994">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3118067">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3118137">func</span>&nbsp;<span class="ident" id="3118142">NewCBCDecrypter</span><span class="op" id="3118157">(</span><span class="ident" id="3118158">b</span>&nbsp;<span class="ident" id="3118160">Block</span><span class="op" id="3118165">,</span>&nbsp;<span class="ident" id="3118167">iv</span>&nbsp;<span class="op" id="3118170">[</span><span class="op" id="3118171">]</span><span class="builtintype" id="3118172">byte</span><span class="op" id="3118176">)</span>&nbsp;<span class="ident" id="3118178">BlockMode</span>&nbsp;<span class="op" id="3118188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118191">if</span>&nbsp;<span class="builtinfunc" id="3118194">len</span><span class="op" id="3118197">(</span><span class="ident" id="3118198">iv</span><span class="op" id="3118200">)</span>&nbsp;<span class="op" id="3118202">!=</span>&nbsp;<span class="ident" id="3118205">b</span><span class="op" id="3118206">.</span><span class="ident" id="3118207">BlockSize</span><span class="op" id="3118216">(</span><span class="op" id="3118217">)</span>&nbsp;<span class="op" id="3118219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118223">panic</span><span class="op" id="3118228">(</span><span class="string" id="3118229">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3118286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118289">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118292">return</span>&nbsp;<span class="op" id="3118299">(</span><span class="op" id="3118300">*</span><span class="ident" id="3118301">cbcDecrypter</span><span class="op" id="3118313">)</span><span class="op" id="3118314">(</span><span class="ident" id="3118315">newCBC</span><span class="op" id="3118321">(</span><span class="ident" id="3118322">b</span><span class="op" id="3118323">,</span>&nbsp;<span class="ident" id="3118325">iv</span><span class="op" id="3118327">)</span><span class="op" id="3118328">)</span><br>
<span class="lineno"></span><span class="op" id="3118330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3118333">func</span>&nbsp;<span class="op" id="3118338">(</span><span class="ident" id="3118339">x</span>&nbsp;<span class="op" id="3118341">*</span><span class="ident" id="3118342">cbcDecrypter</span><span class="op" id="3118354">)</span>&nbsp;<span class="ident" id="3118356">BlockSize</span><span class="op" id="3118365">(</span><span class="op" id="3118366">)</span>&nbsp;<span class="builtintype" id="3118368">int</span>&nbsp;<span class="op" id="3118372">{</span>&nbsp;<span class="keyword" id="3118374">return</span>&nbsp;<span class="ident" id="3118381">x</span><span class="op" id="3118382">.</span><span class="ident" id="3118383">blockSize</span>&nbsp;<span class="op" id="3118393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3118396">func</span>&nbsp;<span class="op" id="3118401">(</span><span class="ident" id="3118402">x</span>&nbsp;<span class="op" id="3118404">*</span><span class="ident" id="3118405">cbcDecrypter</span><span class="op" id="3118417">)</span>&nbsp;<span class="ident" id="3118419">CryptBlocks</span><span class="op" id="3118430">(</span><span class="ident" id="3118431">dst</span><span class="op" id="3118434">,</span>&nbsp;<span class="ident" id="3118436">src</span>&nbsp;<span class="op" id="3118440">[</span><span class="op" id="3118441">]</span><span class="builtintype" id="3118442">byte</span><span class="op" id="3118446">)</span>&nbsp;<span class="op" id="3118448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118451">if</span>&nbsp;<span class="builtinfunc" id="3118454">len</span><span class="op" id="3118457">(</span><span class="ident" id="3118458">src</span><span class="op" id="3118461">)</span><span class="op" id="3118462">%</span><span class="ident" id="3118463">x</span><span class="op" id="3118464">.</span><span class="ident" id="3118465">blockSize</span>&nbsp;<span class="op" id="3118475">!=</span>&nbsp;<span class="num" id="3118478">0</span>&nbsp;<span class="op" id="3118480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118484">panic</span><span class="op" id="3118489">(</span><span class="string" id="3118490">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3118528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118534">if</span>&nbsp;<span class="builtinfunc" id="3118537">len</span><span class="op" id="3118540">(</span><span class="ident" id="3118541">dst</span><span class="op" id="3118544">)</span>&nbsp;<span class="op" id="3118546">&lt;</span>&nbsp;<span class="builtinfunc" id="3118548">len</span><span class="op" id="3118551">(</span><span class="ident" id="3118552">src</span><span class="op" id="3118555">)</span>&nbsp;<span class="op" id="3118557">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118561">panic</span><span class="op" id="3118566">(</span><span class="string" id="3118567">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3118609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118615">if</span>&nbsp;<span class="builtinfunc" id="3118618">len</span><span class="op" id="3118621">(</span><span class="ident" id="3118622">src</span><span class="op" id="3118625">)</span>&nbsp;<span class="op" id="3118627">==</span>&nbsp;<span class="num" id="3118630">0</span>&nbsp;<span class="op" id="3118632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118636">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118644">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118648">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118749">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118822">end</span>&nbsp;<span class="op" id="3118826">:=</span>&nbsp;<span class="builtinfunc" id="3118829">len</span><span class="op" id="3118832">(</span><span class="ident" id="3118833">src</span><span class="op" id="3118836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118839">start</span>&nbsp;<span class="op" id="3118845">:=</span>&nbsp;<span class="ident" id="3118848">end</span>&nbsp;<span class="op" id="3118852">-</span>&nbsp;<span class="ident" id="3118854">x</span><span class="op" id="3118855">.</span><span class="ident" id="3118856">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118867">prev</span>&nbsp;<span class="op" id="3118872">:=</span>&nbsp;<span class="ident" id="3118875">start</span>&nbsp;<span class="op" id="3118881">-</span>&nbsp;<span class="ident" id="3118883">x</span><span class="op" id="3118884">.</span><span class="ident" id="3118885">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118897">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118965">copy</span><span class="op" id="3118969">(</span><span class="ident" id="3118970">x</span><span class="op" id="3118971">.</span><span class="ident" id="3118972">tmp</span><span class="op" id="3118975">,</span>&nbsp;<span class="ident" id="3118977">src</span><span class="op" id="3118980">[</span><span class="ident" id="3118981">start</span><span class="op" id="3118986">:</span><span class="ident" id="3118987">end</span><span class="op" id="3118990">]</span><span class="op" id="3118991">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3118995">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119034">for</span>&nbsp;<span class="ident" id="3119038">start</span>&nbsp;<span class="op" id="3119044">&gt;</span>&nbsp;<span class="num" id="3119046">0</span>&nbsp;<span class="op" id="3119048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119052">x</span><span class="op" id="3119053">.</span><span class="ident" id="3119054">b</span><span class="op" id="3119055">.</span><span class="ident" id="3119056">Decrypt</span><span class="op" id="3119063">(</span><span class="ident" id="3119064">dst</span><span class="op" id="3119067">[</span><span class="ident" id="3119068">start</span><span class="op" id="3119073">:</span><span class="ident" id="3119074">end</span><span class="op" id="3119077">]</span><span class="op" id="3119078">,</span>&nbsp;<span class="ident" id="3119080">src</span><span class="op" id="3119083">[</span><span class="ident" id="3119084">start</span><span class="op" id="3119089">:</span><span class="ident" id="3119090">end</span><span class="op" id="3119093">]</span><span class="op" id="3119094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119098">xorBytes</span><span class="op" id="3119106">(</span><span class="ident" id="3119107">dst</span><span class="op" id="3119110">[</span><span class="ident" id="3119111">start</span><span class="op" id="3119116">:</span><span class="ident" id="3119117">end</span><span class="op" id="3119120">]</span><span class="op" id="3119121">,</span>&nbsp;<span class="ident" id="3119123">dst</span><span class="op" id="3119126">[</span><span class="ident" id="3119127">start</span><span class="op" id="3119132">:</span><span class="ident" id="3119133">end</span><span class="op" id="3119136">]</span><span class="op" id="3119137">,</span>&nbsp;<span class="ident" id="3119139">src</span><span class="op" id="3119142">[</span><span class="ident" id="3119143">prev</span><span class="op" id="3119147">:</span><span class="ident" id="3119148">start</span><span class="op" id="3119153">]</span><span class="op" id="3119154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119159">end</span>&nbsp;<span class="op" id="3119163">=</span>&nbsp;<span class="ident" id="3119165">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119173">start</span>&nbsp;<span class="op" id="3119179">=</span>&nbsp;<span class="ident" id="3119181">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119188">prev</span>&nbsp;<span class="op" id="3119193">-=</span>&nbsp;<span class="ident" id="3119196">x</span><span class="op" id="3119197">.</span><span class="ident" id="3119198">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119213">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119274">x</span><span class="op" id="3119275">.</span><span class="ident" id="3119276">b</span><span class="op" id="3119277">.</span><span class="ident" id="3119278">Decrypt</span><span class="op" id="3119285">(</span><span class="ident" id="3119286">dst</span><span class="op" id="3119289">[</span><span class="ident" id="3119290">start</span><span class="op" id="3119295">:</span><span class="ident" id="3119296">end</span><span class="op" id="3119299">]</span><span class="op" id="3119300">,</span>&nbsp;<span class="ident" id="3119302">src</span><span class="op" id="3119305">[</span><span class="ident" id="3119306">start</span><span class="op" id="3119311">:</span><span class="ident" id="3119312">end</span><span class="op" id="3119315">]</span><span class="op" id="3119316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119319">xorBytes</span><span class="op" id="3119327">(</span><span class="ident" id="3119328">dst</span><span class="op" id="3119331">[</span><span class="ident" id="3119332">start</span><span class="op" id="3119337">:</span><span class="ident" id="3119338">end</span><span class="op" id="3119341">]</span><span class="op" id="3119342">,</span>&nbsp;<span class="ident" id="3119344">dst</span><span class="op" id="3119347">[</span><span class="ident" id="3119348">start</span><span class="op" id="3119353">:</span><span class="ident" id="3119354">end</span><span class="op" id="3119357">]</span><span class="op" id="3119358">,</span>&nbsp;<span class="ident" id="3119360">x</span><span class="op" id="3119361">.</span><span class="ident" id="3119362">iv</span><span class="op" id="3119364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3119368">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119425">x</span><span class="op" id="3119426">.</span><span class="ident" id="3119427">iv</span><span class="op" id="3119429">,</span>&nbsp;<span class="ident" id="3119431">x</span><span class="op" id="3119432">.</span><span class="ident" id="3119433">tmp</span>&nbsp;<span class="op" id="3119437">=</span>&nbsp;<span class="ident" id="3119439">x</span><span class="op" id="3119440">.</span><span class="ident" id="3119441">tmp</span><span class="op" id="3119444">,</span>&nbsp;<span class="ident" id="3119446">x</span><span class="op" id="3119447">.</span><span class="ident" id="3119448">iv</span><br>
<span class="lineno"></span><span class="op" id="3119451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3119454">func</span>&nbsp;<span class="op" id="3119459">(</span><span class="ident" id="3119460">x</span>&nbsp;<span class="op" id="3119462">*</span><span class="ident" id="3119463">cbcDecrypter</span><span class="op" id="3119475">)</span>&nbsp;<span class="ident" id="3119477">SetIV</span><span class="op" id="3119482">(</span><span class="ident" id="3119483">iv</span>&nbsp;<span class="op" id="3119486">[</span><span class="op" id="3119487">]</span><span class="builtintype" id="3119488">byte</span><span class="op" id="3119492">)</span>&nbsp;<span class="op" id="3119494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119497">if</span>&nbsp;<span class="builtinfunc" id="3119500">len</span><span class="op" id="3119503">(</span><span class="ident" id="3119504">iv</span><span class="op" id="3119506">)</span>&nbsp;<span class="op" id="3119508">!=</span>&nbsp;<span class="builtinfunc" id="3119511">len</span><span class="op" id="3119514">(</span><span class="ident" id="3119515">x</span><span class="op" id="3119516">.</span><span class="ident" id="3119517">iv</span><span class="op" id="3119519">)</span>&nbsp;<span class="op" id="3119521">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3119525">panic</span><span class="op" id="3119530">(</span><span class="string" id="3119531">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3119560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3119566">copy</span><span class="op" id="3119570">(</span><span class="ident" id="3119571">x</span><span class="op" id="3119572">.</span><span class="ident" id="3119573">iv</span><span class="op" id="3119575">,</span>&nbsp;<span class="ident" id="3119577">iv</span><span class="op" id="3119579">)</span><br>
<span class="lineno"></span><span class="op" id="3119581">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
