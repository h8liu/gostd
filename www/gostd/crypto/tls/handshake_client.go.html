<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3669521">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3669576">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3669630">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3669681">package</span>&nbsp;<span class="ident" id="3669689">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3669694">import</span>&nbsp;<span class="op" id="3669701">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669704">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669713">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669723">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669739">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669753">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669770">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669785">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669795">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669802">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669808">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3669815">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3669825">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3669828">type</span>&nbsp;<span class="ident" id="3669833">clientHandshakeState</span>&nbsp;<span class="keyword" id="3669854">struct</span>&nbsp;<span class="op" id="3669861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669864">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669877">*</span><span class="ident" id="3669878">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669884">serverHello</span>&nbsp;&nbsp;<span class="op" id="3669897">*</span><span class="ident" id="3669898">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669914">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669927">*</span><span class="ident" id="3669928">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669944">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669957">*</span><span class="ident" id="3669958">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669971">finishedHash</span>&nbsp;<span class="ident" id="3669984">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669998">masterSecret</span>&nbsp;<span class="op" id="3670011">[</span><span class="op" id="3670012">]</span><span class="builtintype" id="3670013">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670019">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670032">*</span><span class="ident" id="3670033">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3670052">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3670055">func</span>&nbsp;<span class="op" id="3670060">(</span><span class="ident" id="3670061">c</span>&nbsp;<span class="op" id="3670063">*</span><span class="ident" id="3670064">Conn</span><span class="op" id="3670068">)</span>&nbsp;<span class="ident" id="3670070">clientHandshake</span><span class="op" id="3670085">(</span><span class="op" id="3670086">)</span>&nbsp;<span class="builtintype" id="3670088">error</span>&nbsp;<span class="op" id="3670094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670097">if</span>&nbsp;<span class="ident" id="3670100">c</span><span class="op" id="3670101">.</span><span class="ident" id="3670102">config</span>&nbsp;<span class="op" id="3670109">==</span>&nbsp;<span class="ident" id="3670112">nil</span>&nbsp;<span class="op" id="3670116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670120">c</span><span class="op" id="3670121">.</span><span class="ident" id="3670122">config</span>&nbsp;<span class="op" id="3670129">=</span>&nbsp;<span class="ident" id="3670131">defaultConfig</span><span class="op" id="3670144">(</span><span class="op" id="3670145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670148">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670152">if</span>&nbsp;<span class="builtinfunc" id="3670155">len</span><span class="op" id="3670158">(</span><span class="ident" id="3670159">c</span><span class="op" id="3670160">.</span><span class="ident" id="3670161">config</span><span class="op" id="3670167">.</span><span class="ident" id="3670168">ServerName</span><span class="op" id="3670178">)</span>&nbsp;<span class="op" id="3670180">==</span>&nbsp;<span class="num" id="3670183">0</span>&nbsp;<span class="op" id="3670185">&amp;&amp;</span>&nbsp;<span class="op" id="3670188">!</span><span class="ident" id="3670189">c</span><span class="op" id="3670190">.</span><span class="ident" id="3670191">config</span><span class="op" id="3670197">.</span><span class="ident" id="3670198">InsecureSkipVerify</span>&nbsp;<span class="op" id="3670217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670221">return</span>&nbsp;<span class="ident" id="3670228">errors</span><span class="op" id="3670234">.</span><span class="ident" id="3670235">New</span><span class="op" id="3670238">(</span><span class="string" id="3670239">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3670321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670328">nextProtosLength</span>&nbsp;<span class="op" id="3670345">:=</span>&nbsp;<span class="num" id="3670348">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670351">for</span>&nbsp;<span class="ident" id="3670355">_</span><span class="op" id="3670356">,</span>&nbsp;<span class="ident" id="3670358">proto</span>&nbsp;<span class="op" id="3670364">:=</span>&nbsp;<span class="keyword" id="3670367">range</span>&nbsp;<span class="ident" id="3670373">c</span><span class="op" id="3670374">.</span><span class="ident" id="3670375">config</span><span class="op" id="3670381">.</span><span class="ident" id="3670382">NextProtos</span>&nbsp;<span class="op" id="3670393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670397">if</span>&nbsp;<span class="ident" id="3670400">l</span>&nbsp;<span class="op" id="3670402">:=</span>&nbsp;<span class="builtinfunc" id="3670405">len</span><span class="op" id="3670408">(</span><span class="ident" id="3670409">proto</span><span class="op" id="3670414">)</span><span class="op" id="3670415">;</span>&nbsp;<span class="ident" id="3670417">l</span>&nbsp;<span class="op" id="3670419">==</span>&nbsp;<span class="num" id="3670422">0</span>&nbsp;<span class="op" id="3670424">||</span>&nbsp;<span class="ident" id="3670427">l</span>&nbsp;<span class="op" id="3670429">&gt;</span>&nbsp;<span class="num" id="3670431">255</span>&nbsp;<span class="op" id="3670435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670440">return</span>&nbsp;<span class="ident" id="3670447">errors</span><span class="op" id="3670453">.</span><span class="ident" id="3670454">New</span><span class="op" id="3670457">(</span><span class="string" id="3670458">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3670489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670493">}</span>&nbsp;<span class="keyword" id="3670495">else</span>&nbsp;<span class="op" id="3670500">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670505">nextProtosLength</span>&nbsp;<span class="op" id="3670522">+=</span>&nbsp;<span class="num" id="3670525">1</span>&nbsp;<span class="op" id="3670527">+</span>&nbsp;<span class="ident" id="3670529">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670539">if</span>&nbsp;<span class="ident" id="3670542">nextProtosLength</span>&nbsp;<span class="op" id="3670559">&gt;</span>&nbsp;<span class="num" id="3670561">0xffff</span>&nbsp;<span class="op" id="3670568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670572">return</span>&nbsp;<span class="ident" id="3670579">errors</span><span class="op" id="3670585">.</span><span class="ident" id="3670586">New</span><span class="op" id="3670589">(</span><span class="string" id="3670590">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3670624">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670631">hello</span>&nbsp;<span class="op" id="3670637">:=</span>&nbsp;<span class="op" id="3670640">&amp;</span><span class="ident" id="3670641">clientHelloMsg</span><span class="op" id="3670655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670659">vers</span><span class="op" id="3670663">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670680">c</span><span class="op" id="3670681">.</span><span class="ident" id="3670682">config</span><span class="op" id="3670688">.</span><span class="ident" id="3670689">maxVersion</span><span class="op" id="3670699">(</span><span class="op" id="3670700">)</span><span class="op" id="3670701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670705">compressionMethods</span><span class="op" id="3670723">:</span>&nbsp;&nbsp;<span class="op" id="3670726">[</span><span class="op" id="3670727">]</span><span class="builtintype" id="3670728">uint8</span><span class="op" id="3670733">{</span><span class="ident" id="3670734">compressionNone</span><span class="op" id="3670749">}</span><span class="op" id="3670750">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670754">random</span><span class="op" id="3670760">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3670775">make</span><span class="op" id="3670779">(</span><span class="op" id="3670780">[</span><span class="op" id="3670781">]</span><span class="builtintype" id="3670782">byte</span><span class="op" id="3670786">,</span>&nbsp;<span class="num" id="3670788">32</span><span class="op" id="3670790">)</span><span class="op" id="3670791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670795">ocspStapling</span><span class="op" id="3670807">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3670816">true</span><span class="op" id="3670820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670824">serverName</span><span class="op" id="3670834">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670845">c</span><span class="op" id="3670846">.</span><span class="ident" id="3670847">config</span><span class="op" id="3670853">.</span><span class="ident" id="3670854">ServerName</span><span class="op" id="3670864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670868">supportedCurves</span><span class="op" id="3670883">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670889">c</span><span class="op" id="3670890">.</span><span class="ident" id="3670891">config</span><span class="op" id="3670897">.</span><span class="ident" id="3670898">curvePreferences</span><span class="op" id="3670914">(</span><span class="op" id="3670915">)</span><span class="op" id="3670916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670920">supportedPoints</span><span class="op" id="3670935">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670941">[</span><span class="op" id="3670942">]</span><span class="builtintype" id="3670943">uint8</span><span class="op" id="3670948">{</span><span class="ident" id="3670949">pointFormatUncompressed</span><span class="op" id="3670972">}</span><span class="op" id="3670973">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670977">nextProtoNeg</span><span class="op" id="3670989">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3670998">len</span><span class="op" id="3671001">(</span><span class="ident" id="3671002">c</span><span class="op" id="3671003">.</span><span class="ident" id="3671004">config</span><span class="op" id="3671010">.</span><span class="ident" id="3671011">NextProtos</span><span class="op" id="3671021">)</span>&nbsp;<span class="op" id="3671023">&gt;</span>&nbsp;<span class="num" id="3671025">0</span><span class="op" id="3671026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671030">secureRenegotiation</span><span class="op" id="3671049">:</span>&nbsp;<span class="builtintype" id="3671051">true</span><span class="op" id="3671055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671059">alpnProtocols</span><span class="op" id="3671072">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671080">c</span><span class="op" id="3671081">.</span><span class="ident" id="3671082">config</span><span class="op" id="3671088">.</span><span class="ident" id="3671089">NextProtos</span><span class="op" id="3671099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671106">possibleCipherSuites</span>&nbsp;<span class="op" id="3671127">:=</span>&nbsp;<span class="ident" id="3671130">c</span><span class="op" id="3671131">.</span><span class="ident" id="3671132">config</span><span class="op" id="3671138">.</span><span class="ident" id="3671139">cipherSuites</span><span class="op" id="3671151">(</span><span class="op" id="3671152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671155">hello</span><span class="op" id="3671160">.</span><span class="ident" id="3671161">cipherSuites</span>&nbsp;<span class="op" id="3671174">=</span>&nbsp;<span class="builtinfunc" id="3671176">make</span><span class="op" id="3671180">(</span><span class="op" id="3671181">[</span><span class="op" id="3671182">]</span><span class="builtintype" id="3671183">uint16</span><span class="op" id="3671189">,</span>&nbsp;<span class="num" id="3671191">0</span><span class="op" id="3671192">,</span>&nbsp;<span class="builtinfunc" id="3671194">len</span><span class="op" id="3671197">(</span><span class="ident" id="3671198">possibleCipherSuites</span><span class="op" id="3671218">)</span><span class="op" id="3671219">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3671222">NextCipherSuite</span><span class="op" id="3671237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671240">for</span>&nbsp;<span class="ident" id="3671244">_</span><span class="op" id="3671245">,</span>&nbsp;<span class="ident" id="3671247">suiteId</span>&nbsp;<span class="op" id="3671255">:=</span>&nbsp;<span class="keyword" id="3671258">range</span>&nbsp;<span class="ident" id="3671264">possibleCipherSuites</span>&nbsp;<span class="op" id="3671285">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671289">for</span>&nbsp;<span class="ident" id="3671293">_</span><span class="op" id="3671294">,</span>&nbsp;<span class="ident" id="3671296">suite</span>&nbsp;<span class="op" id="3671302">:=</span>&nbsp;<span class="keyword" id="3671305">range</span>&nbsp;<span class="ident" id="3671311">cipherSuites</span>&nbsp;<span class="op" id="3671324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671329">if</span>&nbsp;<span class="ident" id="3671332">suite</span><span class="op" id="3671337">.</span><span class="ident" id="3671338">id</span>&nbsp;<span class="op" id="3671341">!=</span>&nbsp;<span class="ident" id="3671344">suiteId</span>&nbsp;<span class="op" id="3671352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671358">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3671375">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3671431">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671463">if</span>&nbsp;<span class="ident" id="3671466">hello</span><span class="op" id="3671471">.</span><span class="ident" id="3671472">vers</span>&nbsp;<span class="op" id="3671477">&lt;</span>&nbsp;<span class="ident" id="3671479">VersionTLS12</span>&nbsp;<span class="op" id="3671492">&amp;&amp;</span>&nbsp;<span class="ident" id="3671495">suite</span><span class="op" id="3671500">.</span><span class="ident" id="3671501">flags</span><span class="op" id="3671506">&amp;</span><span class="ident" id="3671507">suiteTLS12</span>&nbsp;<span class="op" id="3671518">!=</span>&nbsp;<span class="num" id="3671521">0</span>&nbsp;<span class="op" id="3671523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671529">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671546">hello</span><span class="op" id="3671551">.</span><span class="ident" id="3671552">cipherSuites</span>&nbsp;<span class="op" id="3671565">=</span>&nbsp;<span class="builtinfunc" id="3671567">append</span><span class="op" id="3671573">(</span><span class="ident" id="3671574">hello</span><span class="op" id="3671579">.</span><span class="ident" id="3671580">cipherSuites</span><span class="op" id="3671592">,</span>&nbsp;<span class="ident" id="3671594">suiteId</span><span class="op" id="3671601">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671606">continue</span>&nbsp;<span class="ident" id="3671615">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671640">_</span><span class="op" id="3671641">,</span>&nbsp;<span class="ident" id="3671643">err</span>&nbsp;<span class="op" id="3671647">:=</span>&nbsp;<span class="ident" id="3671650">io</span><span class="op" id="3671652">.</span><span class="ident" id="3671653">ReadFull</span><span class="op" id="3671661">(</span><span class="ident" id="3671662">c</span><span class="op" id="3671663">.</span><span class="ident" id="3671664">config</span><span class="op" id="3671670">.</span><span class="ident" id="3671671">rand</span><span class="op" id="3671675">(</span><span class="op" id="3671676">)</span><span class="op" id="3671677">,</span>&nbsp;<span class="ident" id="3671679">hello</span><span class="op" id="3671684">.</span><span class="ident" id="3671685">random</span><span class="op" id="3671691">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671694">if</span>&nbsp;<span class="ident" id="3671697">err</span>&nbsp;<span class="op" id="3671701">!=</span>&nbsp;<span class="ident" id="3671704">nil</span>&nbsp;<span class="op" id="3671708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671712">c</span><span class="op" id="3671713">.</span><span class="ident" id="3671714">sendAlert</span><span class="op" id="3671723">(</span><span class="ident" id="3671724">alertInternalError</span><span class="op" id="3671742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671746">return</span>&nbsp;<span class="ident" id="3671753">errors</span><span class="op" id="3671759">.</span><span class="ident" id="3671760">New</span><span class="op" id="3671763">(</span><span class="string" id="3671764">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3671794">+</span>&nbsp;<span class="ident" id="3671796">err</span><span class="op" id="3671799">.</span><span class="ident" id="3671800">Error</span><span class="op" id="3671805">(</span><span class="op" id="3671806">)</span><span class="op" id="3671807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671814">if</span>&nbsp;<span class="ident" id="3671817">hello</span><span class="op" id="3671822">.</span><span class="ident" id="3671823">vers</span>&nbsp;<span class="op" id="3671828">&gt;=</span>&nbsp;<span class="ident" id="3671831">VersionTLS12</span>&nbsp;<span class="op" id="3671844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671848">hello</span><span class="op" id="3671853">.</span><span class="ident" id="3671854">signatureAndHashes</span>&nbsp;<span class="op" id="3671873">=</span>&nbsp;<span class="ident" id="3671875">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671912">var</span>&nbsp;<span class="ident" id="3671916">session</span>&nbsp;<span class="op" id="3671924">*</span><span class="ident" id="3671925">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671945">var</span>&nbsp;<span class="ident" id="3671949">cacheKey</span>&nbsp;<span class="builtintype" id="3671958">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671966">sessionCache</span>&nbsp;<span class="op" id="3671979">:=</span>&nbsp;<span class="ident" id="3671982">c</span><span class="op" id="3671983">.</span><span class="ident" id="3671984">config</span><span class="op" id="3671990">.</span><span class="ident" id="3671991">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672011">if</span>&nbsp;<span class="ident" id="3672014">c</span><span class="op" id="3672015">.</span><span class="ident" id="3672016">config</span><span class="op" id="3672022">.</span><span class="ident" id="3672023">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3672046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672050">sessionCache</span>&nbsp;<span class="op" id="3672063">=</span>&nbsp;<span class="ident" id="3672065">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672070">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672074">if</span>&nbsp;<span class="ident" id="3672077">sessionCache</span>&nbsp;<span class="op" id="3672090">!=</span>&nbsp;<span class="ident" id="3672093">nil</span>&nbsp;<span class="op" id="3672097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672101">hello</span><span class="op" id="3672106">.</span><span class="ident" id="3672107">ticketSupported</span>&nbsp;<span class="op" id="3672123">=</span>&nbsp;<span class="builtintype" id="3672125">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672133">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672192">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672208">cacheKey</span>&nbsp;<span class="op" id="3672217">=</span>&nbsp;<span class="ident" id="3672219">clientSessionCacheKey</span><span class="op" id="3672240">(</span><span class="ident" id="3672241">c</span><span class="op" id="3672242">.</span><span class="ident" id="3672243">conn</span><span class="op" id="3672247">.</span><span class="ident" id="3672248">RemoteAddr</span><span class="op" id="3672258">(</span><span class="op" id="3672259">)</span><span class="op" id="3672260">,</span>&nbsp;<span class="ident" id="3672262">c</span><span class="op" id="3672263">.</span><span class="ident" id="3672264">config</span><span class="op" id="3672270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672274">candidateSession</span><span class="op" id="3672290">,</span>&nbsp;<span class="ident" id="3672292">ok</span>&nbsp;<span class="op" id="3672295">:=</span>&nbsp;<span class="ident" id="3672298">sessionCache</span><span class="op" id="3672310">.</span><span class="ident" id="3672311">Get</span><span class="op" id="3672314">(</span><span class="ident" id="3672315">cacheKey</span><span class="op" id="3672323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672327">if</span>&nbsp;<span class="ident" id="3672330">ok</span>&nbsp;<span class="op" id="3672333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672338">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672392">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672432">cipherSuiteOk</span>&nbsp;<span class="op" id="3672446">:=</span>&nbsp;<span class="builtintype" id="3672449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672458">for</span>&nbsp;<span class="ident" id="3672462">_</span><span class="op" id="3672463">,</span>&nbsp;<span class="ident" id="3672465">id</span>&nbsp;<span class="op" id="3672468">:=</span>&nbsp;<span class="keyword" id="3672471">range</span>&nbsp;<span class="ident" id="3672477">hello</span><span class="op" id="3672482">.</span><span class="ident" id="3672483">cipherSuites</span>&nbsp;<span class="op" id="3672496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672502">if</span>&nbsp;<span class="ident" id="3672505">id</span>&nbsp;<span class="op" id="3672508">==</span>&nbsp;<span class="ident" id="3672511">candidateSession</span><span class="op" id="3672527">.</span><span class="ident" id="3672528">cipherSuite</span>&nbsp;<span class="op" id="3672540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672547">cipherSuiteOk</span>&nbsp;<span class="op" id="3672561">=</span>&nbsp;<span class="builtintype" id="3672563">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672573">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672594">versOk</span>&nbsp;<span class="op" id="3672601">:=</span>&nbsp;<span class="ident" id="3672604">candidateSession</span><span class="op" id="3672620">.</span><span class="ident" id="3672621">vers</span>&nbsp;<span class="op" id="3672626">&gt;=</span>&nbsp;<span class="ident" id="3672629">c</span><span class="op" id="3672630">.</span><span class="ident" id="3672631">config</span><span class="op" id="3672637">.</span><span class="ident" id="3672638">minVersion</span><span class="op" id="3672648">(</span><span class="op" id="3672649">)</span>&nbsp;<span class="op" id="3672651">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672658">candidateSession</span><span class="op" id="3672674">.</span><span class="ident" id="3672675">vers</span>&nbsp;<span class="op" id="3672680">&lt;=</span>&nbsp;<span class="ident" id="3672683">c</span><span class="op" id="3672684">.</span><span class="ident" id="3672685">config</span><span class="op" id="3672691">.</span><span class="ident" id="3672692">maxVersion</span><span class="op" id="3672702">(</span><span class="op" id="3672703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672708">if</span>&nbsp;<span class="ident" id="3672711">versOk</span>&nbsp;<span class="op" id="3672718">&amp;&amp;</span>&nbsp;<span class="ident" id="3672721">cipherSuiteOk</span>&nbsp;<span class="op" id="3672735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672741">session</span>&nbsp;<span class="op" id="3672749">=</span>&nbsp;<span class="ident" id="3672751">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672775">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672782">if</span>&nbsp;<span class="ident" id="3672785">session</span>&nbsp;<span class="op" id="3672793">!=</span>&nbsp;<span class="ident" id="3672796">nil</span>&nbsp;<span class="op" id="3672800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672804">hello</span><span class="op" id="3672809">.</span><span class="ident" id="3672810">sessionTicket</span>&nbsp;<span class="op" id="3672824">=</span>&nbsp;<span class="ident" id="3672826">session</span><span class="op" id="3672833">.</span><span class="ident" id="3672834">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672850">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672902">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3672960">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672981">hello</span><span class="op" id="3672986">.</span><span class="ident" id="3672987">sessionId</span>&nbsp;<span class="op" id="3672997">=</span>&nbsp;<span class="builtinfunc" id="3672999">make</span><span class="op" id="3673003">(</span><span class="op" id="3673004">[</span><span class="op" id="3673005">]</span><span class="builtintype" id="3673006">byte</span><span class="op" id="3673010">,</span>&nbsp;<span class="num" id="3673012">16</span><span class="op" id="3673014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673018">if</span>&nbsp;<span class="ident" id="3673021">_</span><span class="op" id="3673022">,</span>&nbsp;<span class="ident" id="3673024">err</span>&nbsp;<span class="op" id="3673028">:=</span>&nbsp;<span class="ident" id="3673031">io</span><span class="op" id="3673033">.</span><span class="ident" id="3673034">ReadFull</span><span class="op" id="3673042">(</span><span class="ident" id="3673043">c</span><span class="op" id="3673044">.</span><span class="ident" id="3673045">config</span><span class="op" id="3673051">.</span><span class="ident" id="3673052">rand</span><span class="op" id="3673056">(</span><span class="op" id="3673057">)</span><span class="op" id="3673058">,</span>&nbsp;<span class="ident" id="3673060">hello</span><span class="op" id="3673065">.</span><span class="ident" id="3673066">sessionId</span><span class="op" id="3673075">)</span><span class="op" id="3673076">;</span>&nbsp;<span class="ident" id="3673078">err</span>&nbsp;<span class="op" id="3673082">!=</span>&nbsp;<span class="ident" id="3673085">nil</span>&nbsp;<span class="op" id="3673089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673094">c</span><span class="op" id="3673095">.</span><span class="ident" id="3673096">sendAlert</span><span class="op" id="3673105">(</span><span class="ident" id="3673106">alertInternalError</span><span class="op" id="3673124">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673129">return</span>&nbsp;<span class="ident" id="3673136">errors</span><span class="op" id="3673142">.</span><span class="ident" id="3673143">New</span><span class="op" id="3673146">(</span><span class="string" id="3673147">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3673177">+</span>&nbsp;<span class="ident" id="3673179">err</span><span class="op" id="3673182">.</span><span class="ident" id="3673183">Error</span><span class="op" id="3673188">(</span><span class="op" id="3673189">)</span><span class="op" id="3673190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673201">c</span><span class="op" id="3673202">.</span><span class="ident" id="3673203">writeRecord</span><span class="op" id="3673214">(</span><span class="ident" id="3673215">recordTypeHandshake</span><span class="op" id="3673234">,</span>&nbsp;<span class="ident" id="3673236">hello</span><span class="op" id="3673241">.</span><span class="ident" id="3673242">marshal</span><span class="op" id="3673249">(</span><span class="op" id="3673250">)</span><span class="op" id="3673251">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673255">msg</span><span class="op" id="3673258">,</span>&nbsp;<span class="ident" id="3673260">err</span>&nbsp;<span class="op" id="3673264">:=</span>&nbsp;<span class="ident" id="3673267">c</span><span class="op" id="3673268">.</span><span class="ident" id="3673269">readHandshake</span><span class="op" id="3673282">(</span><span class="op" id="3673283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673286">if</span>&nbsp;<span class="ident" id="3673289">err</span>&nbsp;<span class="op" id="3673293">!=</span>&nbsp;<span class="ident" id="3673296">nil</span>&nbsp;<span class="op" id="3673300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673304">return</span>&nbsp;<span class="ident" id="3673311">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673316">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673319">serverHello</span><span class="op" id="3673330">,</span>&nbsp;<span class="ident" id="3673332">ok</span>&nbsp;<span class="op" id="3673335">:=</span>&nbsp;<span class="ident" id="3673338">msg</span><span class="op" id="3673341">.</span><span class="op" id="3673342">(</span><span class="op" id="3673343">*</span><span class="ident" id="3673344">serverHelloMsg</span><span class="op" id="3673358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673361">if</span>&nbsp;<span class="op" id="3673364">!</span><span class="ident" id="3673365">ok</span>&nbsp;<span class="op" id="3673368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673372">c</span><span class="op" id="3673373">.</span><span class="ident" id="3673374">sendAlert</span><span class="op" id="3673383">(</span><span class="ident" id="3673384">alertUnexpectedMessage</span><span class="op" id="3673406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673410">return</span>&nbsp;<span class="ident" id="3673417">unexpectedMessageError</span><span class="op" id="3673439">(</span><span class="ident" id="3673440">serverHello</span><span class="op" id="3673451">,</span>&nbsp;<span class="ident" id="3673453">msg</span><span class="op" id="3673456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673459">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673463">vers</span><span class="op" id="3673467">,</span>&nbsp;<span class="ident" id="3673469">ok</span>&nbsp;<span class="op" id="3673472">:=</span>&nbsp;<span class="ident" id="3673475">c</span><span class="op" id="3673476">.</span><span class="ident" id="3673477">config</span><span class="op" id="3673483">.</span><span class="ident" id="3673484">mutualVersion</span><span class="op" id="3673497">(</span><span class="ident" id="3673498">serverHello</span><span class="op" id="3673509">.</span><span class="ident" id="3673510">vers</span><span class="op" id="3673514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673517">if</span>&nbsp;<span class="op" id="3673520">!</span><span class="ident" id="3673521">ok</span>&nbsp;<span class="op" id="3673524">||</span>&nbsp;<span class="ident" id="3673527">vers</span>&nbsp;<span class="op" id="3673532">&lt;</span>&nbsp;<span class="ident" id="3673534">VersionTLS10</span>&nbsp;<span class="op" id="3673547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673551">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673610">c</span><span class="op" id="3673611">.</span><span class="ident" id="3673612">sendAlert</span><span class="op" id="3673621">(</span><span class="ident" id="3673622">alertProtocolVersion</span><span class="op" id="3673642">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673646">return</span>&nbsp;<span class="ident" id="3673653">fmt</span><span class="op" id="3673656">.</span><span class="ident" id="3673657">Errorf</span><span class="op" id="3673663">(</span><span class="string" id="3673664">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3673718">,</span>&nbsp;<span class="ident" id="3673720">serverHello</span><span class="op" id="3673731">.</span><span class="ident" id="3673732">vers</span><span class="op" id="3673736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673742">c</span><span class="op" id="3673743">.</span><span class="ident" id="3673744">vers</span>&nbsp;<span class="op" id="3673749">=</span>&nbsp;<span class="ident" id="3673751">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673757">c</span><span class="op" id="3673758">.</span><span class="ident" id="3673759">haveVers</span>&nbsp;<span class="op" id="3673768">=</span>&nbsp;<span class="builtintype" id="3673770">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673777">suite</span>&nbsp;<span class="op" id="3673783">:=</span>&nbsp;<span class="ident" id="3673786">mutualCipherSuite</span><span class="op" id="3673803">(</span><span class="ident" id="3673804">c</span><span class="op" id="3673805">.</span><span class="ident" id="3673806">config</span><span class="op" id="3673812">.</span><span class="ident" id="3673813">cipherSuites</span><span class="op" id="3673825">(</span><span class="op" id="3673826">)</span><span class="op" id="3673827">,</span>&nbsp;<span class="ident" id="3673829">serverHello</span><span class="op" id="3673840">.</span><span class="ident" id="3673841">cipherSuite</span><span class="op" id="3673852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673855">if</span>&nbsp;<span class="ident" id="3673858">suite</span>&nbsp;<span class="op" id="3673864">==</span>&nbsp;<span class="ident" id="3673867">nil</span>&nbsp;<span class="op" id="3673871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673875">c</span><span class="op" id="3673876">.</span><span class="ident" id="3673877">sendAlert</span><span class="op" id="3673886">(</span><span class="ident" id="3673887">alertHandshakeFailure</span><span class="op" id="3673908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673912">return</span>&nbsp;<span class="ident" id="3673919">fmt</span><span class="op" id="3673922">.</span><span class="ident" id="3673923">Errorf</span><span class="op" id="3673929">(</span><span class="string" id="3673930">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3673980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673983">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673987">hs</span>&nbsp;<span class="op" id="3673990">:=</span>&nbsp;<span class="op" id="3673993">&amp;</span><span class="ident" id="3673994">clientHandshakeState</span><span class="op" id="3674014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674018">c</span><span class="op" id="3674019">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674032">c</span><span class="op" id="3674033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674037">serverHello</span><span class="op" id="3674048">:</span>&nbsp;&nbsp;<span class="ident" id="3674051">serverHello</span><span class="op" id="3674062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674066">hello</span><span class="op" id="3674071">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674080">hello</span><span class="op" id="3674085">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674089">suite</span><span class="op" id="3674094">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674103">suite</span><span class="op" id="3674108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674112">finishedHash</span><span class="op" id="3674124">:</span>&nbsp;<span class="ident" id="3674126">newFinishedHash</span><span class="op" id="3674141">(</span><span class="ident" id="3674142">c</span><span class="op" id="3674143">.</span><span class="ident" id="3674144">vers</span><span class="op" id="3674148">)</span><span class="op" id="3674149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674153">session</span><span class="op" id="3674160">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674167">session</span><span class="op" id="3674174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674181">hs</span><span class="op" id="3674183">.</span><span class="ident" id="3674184">finishedHash</span><span class="op" id="3674196">.</span><span class="ident" id="3674197">Write</span><span class="op" id="3674202">(</span><span class="ident" id="3674203">hs</span><span class="op" id="3674205">.</span><span class="ident" id="3674206">hello</span><span class="op" id="3674211">.</span><span class="ident" id="3674212">marshal</span><span class="op" id="3674219">(</span><span class="op" id="3674220">)</span><span class="op" id="3674221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674224">hs</span><span class="op" id="3674226">.</span><span class="ident" id="3674227">finishedHash</span><span class="op" id="3674239">.</span><span class="ident" id="3674240">Write</span><span class="op" id="3674245">(</span><span class="ident" id="3674246">hs</span><span class="op" id="3674248">.</span><span class="ident" id="3674249">serverHello</span><span class="op" id="3674260">.</span><span class="ident" id="3674261">marshal</span><span class="op" id="3674268">(</span><span class="op" id="3674269">)</span><span class="op" id="3674270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674274">isResume</span><span class="op" id="3674282">,</span>&nbsp;<span class="ident" id="3674284">err</span>&nbsp;<span class="op" id="3674288">:=</span>&nbsp;<span class="ident" id="3674291">hs</span><span class="op" id="3674293">.</span><span class="ident" id="3674294">processServerHello</span><span class="op" id="3674312">(</span><span class="op" id="3674313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674316">if</span>&nbsp;<span class="ident" id="3674319">err</span>&nbsp;<span class="op" id="3674323">!=</span>&nbsp;<span class="ident" id="3674326">nil</span>&nbsp;<span class="op" id="3674330">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674334">return</span>&nbsp;<span class="ident" id="3674341">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674350">if</span>&nbsp;<span class="ident" id="3674353">isResume</span>&nbsp;<span class="op" id="3674362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674366">if</span>&nbsp;<span class="ident" id="3674369">err</span>&nbsp;<span class="op" id="3674373">:=</span>&nbsp;<span class="ident" id="3674376">hs</span><span class="op" id="3674378">.</span><span class="ident" id="3674379">establishKeys</span><span class="op" id="3674392">(</span><span class="op" id="3674393">)</span><span class="op" id="3674394">;</span>&nbsp;<span class="ident" id="3674396">err</span>&nbsp;<span class="op" id="3674400">!=</span>&nbsp;<span class="ident" id="3674403">nil</span>&nbsp;<span class="op" id="3674407">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674412">return</span>&nbsp;<span class="ident" id="3674419">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674429">if</span>&nbsp;<span class="ident" id="3674432">err</span>&nbsp;<span class="op" id="3674436">:=</span>&nbsp;<span class="ident" id="3674439">hs</span><span class="op" id="3674441">.</span><span class="ident" id="3674442">readSessionTicket</span><span class="op" id="3674459">(</span><span class="op" id="3674460">)</span><span class="op" id="3674461">;</span>&nbsp;<span class="ident" id="3674463">err</span>&nbsp;<span class="op" id="3674467">!=</span>&nbsp;<span class="ident" id="3674470">nil</span>&nbsp;<span class="op" id="3674474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674479">return</span>&nbsp;<span class="ident" id="3674486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674492">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674496">if</span>&nbsp;<span class="ident" id="3674499">err</span>&nbsp;<span class="op" id="3674503">:=</span>&nbsp;<span class="ident" id="3674506">hs</span><span class="op" id="3674508">.</span><span class="ident" id="3674509">readFinished</span><span class="op" id="3674521">(</span><span class="ident" id="3674522">c</span><span class="op" id="3674523">.</span><span class="ident" id="3674524">firstFinished</span><span class="op" id="3674537">[</span><span class="op" id="3674538">:</span><span class="op" id="3674539">]</span><span class="op" id="3674540">)</span><span class="op" id="3674541">;</span>&nbsp;<span class="ident" id="3674543">err</span>&nbsp;<span class="op" id="3674547">!=</span>&nbsp;<span class="ident" id="3674550">nil</span>&nbsp;<span class="op" id="3674554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674559">return</span>&nbsp;<span class="ident" id="3674566">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674576">if</span>&nbsp;<span class="ident" id="3674579">err</span>&nbsp;<span class="op" id="3674583">:=</span>&nbsp;<span class="ident" id="3674586">hs</span><span class="op" id="3674588">.</span><span class="ident" id="3674589">sendFinished</span><span class="op" id="3674601">(</span><span class="ident" id="3674602">nil</span><span class="op" id="3674605">)</span><span class="op" id="3674606">;</span>&nbsp;<span class="ident" id="3674608">err</span>&nbsp;<span class="op" id="3674612">!=</span>&nbsp;<span class="ident" id="3674615">nil</span>&nbsp;<span class="op" id="3674619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674624">return</span>&nbsp;<span class="ident" id="3674631">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674640">}</span>&nbsp;<span class="keyword" id="3674642">else</span>&nbsp;<span class="op" id="3674647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674651">if</span>&nbsp;<span class="ident" id="3674654">err</span>&nbsp;<span class="op" id="3674658">:=</span>&nbsp;<span class="ident" id="3674661">hs</span><span class="op" id="3674663">.</span><span class="ident" id="3674664">doFullHandshake</span><span class="op" id="3674679">(</span><span class="op" id="3674680">)</span><span class="op" id="3674681">;</span>&nbsp;<span class="ident" id="3674683">err</span>&nbsp;<span class="op" id="3674687">!=</span>&nbsp;<span class="ident" id="3674690">nil</span>&nbsp;<span class="op" id="3674694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674699">return</span>&nbsp;<span class="ident" id="3674706">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674712">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674716">if</span>&nbsp;<span class="ident" id="3674719">err</span>&nbsp;<span class="op" id="3674723">:=</span>&nbsp;<span class="ident" id="3674726">hs</span><span class="op" id="3674728">.</span><span class="ident" id="3674729">establishKeys</span><span class="op" id="3674742">(</span><span class="op" id="3674743">)</span><span class="op" id="3674744">;</span>&nbsp;<span class="ident" id="3674746">err</span>&nbsp;<span class="op" id="3674750">!=</span>&nbsp;<span class="ident" id="3674753">nil</span>&nbsp;<span class="op" id="3674757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674762">return</span>&nbsp;<span class="ident" id="3674769">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674779">if</span>&nbsp;<span class="ident" id="3674782">err</span>&nbsp;<span class="op" id="3674786">:=</span>&nbsp;<span class="ident" id="3674789">hs</span><span class="op" id="3674791">.</span><span class="ident" id="3674792">sendFinished</span><span class="op" id="3674804">(</span><span class="ident" id="3674805">c</span><span class="op" id="3674806">.</span><span class="ident" id="3674807">firstFinished</span><span class="op" id="3674820">[</span><span class="op" id="3674821">:</span><span class="op" id="3674822">]</span><span class="op" id="3674823">)</span><span class="op" id="3674824">;</span>&nbsp;<span class="ident" id="3674826">err</span>&nbsp;<span class="op" id="3674830">!=</span>&nbsp;<span class="ident" id="3674833">nil</span>&nbsp;<span class="op" id="3674837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674842">return</span>&nbsp;<span class="ident" id="3674849">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674859">if</span>&nbsp;<span class="ident" id="3674862">err</span>&nbsp;<span class="op" id="3674866">:=</span>&nbsp;<span class="ident" id="3674869">hs</span><span class="op" id="3674871">.</span><span class="ident" id="3674872">readSessionTicket</span><span class="op" id="3674889">(</span><span class="op" id="3674890">)</span><span class="op" id="3674891">;</span>&nbsp;<span class="ident" id="3674893">err</span>&nbsp;<span class="op" id="3674897">!=</span>&nbsp;<span class="ident" id="3674900">nil</span>&nbsp;<span class="op" id="3674904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674909">return</span>&nbsp;<span class="ident" id="3674916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674926">if</span>&nbsp;<span class="ident" id="3674929">err</span>&nbsp;<span class="op" id="3674933">:=</span>&nbsp;<span class="ident" id="3674936">hs</span><span class="op" id="3674938">.</span><span class="ident" id="3674939">readFinished</span><span class="op" id="3674951">(</span><span class="ident" id="3674952">nil</span><span class="op" id="3674955">)</span><span class="op" id="3674956">;</span>&nbsp;<span class="ident" id="3674958">err</span>&nbsp;<span class="op" id="3674962">!=</span>&nbsp;<span class="ident" id="3674965">nil</span>&nbsp;<span class="op" id="3674969">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674974">return</span>&nbsp;<span class="ident" id="3674981">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674994">if</span>&nbsp;<span class="ident" id="3674997">sessionCache</span>&nbsp;<span class="op" id="3675010">!=</span>&nbsp;<span class="ident" id="3675013">nil</span>&nbsp;<span class="op" id="3675017">&amp;&amp;</span>&nbsp;<span class="ident" id="3675020">hs</span><span class="op" id="3675022">.</span><span class="ident" id="3675023">session</span>&nbsp;<span class="op" id="3675031">!=</span>&nbsp;<span class="ident" id="3675034">nil</span>&nbsp;<span class="op" id="3675038">&amp;&amp;</span>&nbsp;<span class="ident" id="3675041">session</span>&nbsp;<span class="op" id="3675049">!=</span>&nbsp;<span class="ident" id="3675052">hs</span><span class="op" id="3675054">.</span><span class="ident" id="3675055">session</span>&nbsp;<span class="op" id="3675063">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675067">sessionCache</span><span class="op" id="3675079">.</span><span class="ident" id="3675080">Put</span><span class="op" id="3675083">(</span><span class="ident" id="3675084">cacheKey</span><span class="op" id="3675092">,</span>&nbsp;<span class="ident" id="3675094">hs</span><span class="op" id="3675096">.</span><span class="ident" id="3675097">session</span><span class="op" id="3675104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675111">c</span><span class="op" id="3675112">.</span><span class="ident" id="3675113">didResume</span>&nbsp;<span class="op" id="3675123">=</span>&nbsp;<span class="ident" id="3675125">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675135">c</span><span class="op" id="3675136">.</span><span class="ident" id="3675137">handshakeComplete</span>&nbsp;<span class="op" id="3675155">=</span>&nbsp;<span class="builtintype" id="3675157">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675163">c</span><span class="op" id="3675164">.</span><span class="ident" id="3675165">cipherSuite</span>&nbsp;<span class="op" id="3675177">=</span>&nbsp;<span class="ident" id="3675179">suite</span><span class="op" id="3675184">.</span><span class="ident" id="3675185">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675189">return</span>&nbsp;<span class="ident" id="3675196">nil</span><br>
<span class="lineno"></span><span class="op" id="3675200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3675203">func</span>&nbsp;<span class="op" id="3675208">(</span><span class="ident" id="3675209">hs</span>&nbsp;<span class="op" id="3675212">*</span><span class="ident" id="3675213">clientHandshakeState</span><span class="op" id="3675233">)</span>&nbsp;<span class="ident" id="3675235">doFullHandshake</span><span class="op" id="3675250">(</span><span class="op" id="3675251">)</span>&nbsp;<span class="builtintype" id="3675253">error</span>&nbsp;<span class="op" id="3675259">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675262">c</span>&nbsp;<span class="op" id="3675264">:=</span>&nbsp;<span class="ident" id="3675267">hs</span><span class="op" id="3675269">.</span><span class="ident" id="3675270">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675274">msg</span><span class="op" id="3675277">,</span>&nbsp;<span class="ident" id="3675279">err</span>&nbsp;<span class="op" id="3675283">:=</span>&nbsp;<span class="ident" id="3675286">c</span><span class="op" id="3675287">.</span><span class="ident" id="3675288">readHandshake</span><span class="op" id="3675301">(</span><span class="op" id="3675302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675305">if</span>&nbsp;<span class="ident" id="3675308">err</span>&nbsp;<span class="op" id="3675312">!=</span>&nbsp;<span class="ident" id="3675315">nil</span>&nbsp;<span class="op" id="3675319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675323">return</span>&nbsp;<span class="ident" id="3675330">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675338">certMsg</span><span class="op" id="3675345">,</span>&nbsp;<span class="ident" id="3675347">ok</span>&nbsp;<span class="op" id="3675350">:=</span>&nbsp;<span class="ident" id="3675353">msg</span><span class="op" id="3675356">.</span><span class="op" id="3675357">(</span><span class="op" id="3675358">*</span><span class="ident" id="3675359">certificateMsg</span><span class="op" id="3675373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675376">if</span>&nbsp;<span class="op" id="3675379">!</span><span class="ident" id="3675380">ok</span>&nbsp;<span class="op" id="3675383">||</span>&nbsp;<span class="builtinfunc" id="3675386">len</span><span class="op" id="3675389">(</span><span class="ident" id="3675390">certMsg</span><span class="op" id="3675397">.</span><span class="ident" id="3675398">certificates</span><span class="op" id="3675410">)</span>&nbsp;<span class="op" id="3675412">==</span>&nbsp;<span class="num" id="3675415">0</span>&nbsp;<span class="op" id="3675417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675421">c</span><span class="op" id="3675422">.</span><span class="ident" id="3675423">sendAlert</span><span class="op" id="3675432">(</span><span class="ident" id="3675433">alertUnexpectedMessage</span><span class="op" id="3675455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675459">return</span>&nbsp;<span class="ident" id="3675466">unexpectedMessageError</span><span class="op" id="3675488">(</span><span class="ident" id="3675489">certMsg</span><span class="op" id="3675496">,</span>&nbsp;<span class="ident" id="3675498">msg</span><span class="op" id="3675501">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675507">hs</span><span class="op" id="3675509">.</span><span class="ident" id="3675510">finishedHash</span><span class="op" id="3675522">.</span><span class="ident" id="3675523">Write</span><span class="op" id="3675528">(</span><span class="ident" id="3675529">certMsg</span><span class="op" id="3675536">.</span><span class="ident" id="3675537">marshal</span><span class="op" id="3675544">(</span><span class="op" id="3675545">)</span><span class="op" id="3675546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675550">certs</span>&nbsp;<span class="op" id="3675556">:=</span>&nbsp;<span class="builtinfunc" id="3675559">make</span><span class="op" id="3675563">(</span><span class="op" id="3675564">[</span><span class="op" id="3675565">]</span><span class="op" id="3675566">*</span><span class="ident" id="3675567">x509</span><span class="op" id="3675571">.</span><span class="ident" id="3675572">Certificate</span><span class="op" id="3675583">,</span>&nbsp;<span class="builtinfunc" id="3675585">len</span><span class="op" id="3675588">(</span><span class="ident" id="3675589">certMsg</span><span class="op" id="3675596">.</span><span class="ident" id="3675597">certificates</span><span class="op" id="3675609">)</span><span class="op" id="3675610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675613">for</span>&nbsp;<span class="ident" id="3675617">i</span><span class="op" id="3675618">,</span>&nbsp;<span class="ident" id="3675620">asn1Data</span>&nbsp;<span class="op" id="3675629">:=</span>&nbsp;<span class="keyword" id="3675632">range</span>&nbsp;<span class="ident" id="3675638">certMsg</span><span class="op" id="3675645">.</span><span class="ident" id="3675646">certificates</span>&nbsp;<span class="op" id="3675659">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675663">cert</span><span class="op" id="3675667">,</span>&nbsp;<span class="ident" id="3675669">err</span>&nbsp;<span class="op" id="3675673">:=</span>&nbsp;<span class="ident" id="3675676">x509</span><span class="op" id="3675680">.</span><span class="ident" id="3675681">ParseCertificate</span><span class="op" id="3675697">(</span><span class="ident" id="3675698">asn1Data</span><span class="op" id="3675706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675710">if</span>&nbsp;<span class="ident" id="3675713">err</span>&nbsp;<span class="op" id="3675717">!=</span>&nbsp;<span class="ident" id="3675720">nil</span>&nbsp;<span class="op" id="3675724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675729">c</span><span class="op" id="3675730">.</span><span class="ident" id="3675731">sendAlert</span><span class="op" id="3675740">(</span><span class="ident" id="3675741">alertBadCertificate</span><span class="op" id="3675760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675765">return</span>&nbsp;<span class="ident" id="3675772">errors</span><span class="op" id="3675778">.</span><span class="ident" id="3675779">New</span><span class="op" id="3675782">(</span><span class="string" id="3675783">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3675832">+</span>&nbsp;<span class="ident" id="3675834">err</span><span class="op" id="3675837">.</span><span class="ident" id="3675838">Error</span><span class="op" id="3675843">(</span><span class="op" id="3675844">)</span><span class="op" id="3675845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675849">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675853">certs</span><span class="op" id="3675858">[</span><span class="ident" id="3675859">i</span><span class="op" id="3675860">]</span>&nbsp;<span class="op" id="3675862">=</span>&nbsp;<span class="ident" id="3675864">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675874">if</span>&nbsp;<span class="op" id="3675877">!</span><span class="ident" id="3675878">c</span><span class="op" id="3675879">.</span><span class="ident" id="3675880">config</span><span class="op" id="3675886">.</span><span class="ident" id="3675887">InsecureSkipVerify</span>&nbsp;<span class="op" id="3675906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675910">opts</span>&nbsp;<span class="op" id="3675915">:=</span>&nbsp;<span class="ident" id="3675918">x509</span><span class="op" id="3675922">.</span><span class="ident" id="3675923">VerifyOptions</span><span class="op" id="3675936">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675941">Roots</span><span class="op" id="3675946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3675956">c</span><span class="op" id="3675957">.</span><span class="ident" id="3675958">config</span><span class="op" id="3675964">.</span><span class="ident" id="3675965">RootCAs</span><span class="op" id="3675972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675977">CurrentTime</span><span class="op" id="3675988">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3675992">c</span><span class="op" id="3675993">.</span><span class="ident" id="3675994">config</span><span class="op" id="3676000">.</span><span class="ident" id="3676001">time</span><span class="op" id="3676005">(</span><span class="op" id="3676006">)</span><span class="op" id="3676007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676012">DNSName</span><span class="op" id="3676019">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3676027">c</span><span class="op" id="3676028">.</span><span class="ident" id="3676029">config</span><span class="op" id="3676035">.</span><span class="ident" id="3676036">ServerName</span><span class="op" id="3676046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676051">Intermediates</span><span class="op" id="3676064">:</span>&nbsp;<span class="ident" id="3676066">x509</span><span class="op" id="3676070">.</span><span class="ident" id="3676071">NewCertPool</span><span class="op" id="3676082">(</span><span class="op" id="3676083">)</span><span class="op" id="3676084">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676088">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676093">for</span>&nbsp;<span class="ident" id="3676097">i</span><span class="op" id="3676098">,</span>&nbsp;<span class="ident" id="3676100">cert</span>&nbsp;<span class="op" id="3676105">:=</span>&nbsp;<span class="keyword" id="3676108">range</span>&nbsp;<span class="ident" id="3676114">certs</span>&nbsp;<span class="op" id="3676120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676125">if</span>&nbsp;<span class="ident" id="3676128">i</span>&nbsp;<span class="op" id="3676130">==</span>&nbsp;<span class="num" id="3676133">0</span>&nbsp;<span class="op" id="3676135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676141">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676153">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676158">opts</span><span class="op" id="3676162">.</span><span class="ident" id="3676163">Intermediates</span><span class="op" id="3676176">.</span><span class="ident" id="3676177">AddCert</span><span class="op" id="3676184">(</span><span class="ident" id="3676185">cert</span><span class="op" id="3676189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676197">c</span><span class="op" id="3676198">.</span><span class="ident" id="3676199">verifiedChains</span><span class="op" id="3676213">,</span>&nbsp;<span class="ident" id="3676215">err</span>&nbsp;<span class="op" id="3676219">=</span>&nbsp;<span class="ident" id="3676221">certs</span><span class="op" id="3676226">[</span><span class="num" id="3676227">0</span><span class="op" id="3676228">]</span><span class="op" id="3676229">.</span><span class="ident" id="3676230">Verify</span><span class="op" id="3676236">(</span><span class="ident" id="3676237">opts</span><span class="op" id="3676241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676245">if</span>&nbsp;<span class="ident" id="3676248">err</span>&nbsp;<span class="op" id="3676252">!=</span>&nbsp;<span class="ident" id="3676255">nil</span>&nbsp;<span class="op" id="3676259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676264">c</span><span class="op" id="3676265">.</span><span class="ident" id="3676266">sendAlert</span><span class="op" id="3676275">(</span><span class="ident" id="3676276">alertBadCertificate</span><span class="op" id="3676295">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676300">return</span>&nbsp;<span class="ident" id="3676307">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676320">switch</span>&nbsp;<span class="ident" id="3676327">certs</span><span class="op" id="3676332">[</span><span class="num" id="3676333">0</span><span class="op" id="3676334">]</span><span class="op" id="3676335">.</span><span class="ident" id="3676336">PublicKey</span><span class="op" id="3676345">.</span><span class="op" id="3676346">(</span><span class="keyword" id="3676347">type</span><span class="op" id="3676351">)</span>&nbsp;<span class="op" id="3676353">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676356">case</span>&nbsp;<span class="op" id="3676361">*</span><span class="ident" id="3676362">rsa</span><span class="op" id="3676365">.</span><span class="ident" id="3676366">PublicKey</span><span class="op" id="3676375">,</span>&nbsp;<span class="op" id="3676377">*</span><span class="ident" id="3676378">ecdsa</span><span class="op" id="3676383">.</span><span class="ident" id="3676384">PublicKey</span><span class="op" id="3676393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676397">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676404">default</span><span class="op" id="3676411">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676415">c</span><span class="op" id="3676416">.</span><span class="ident" id="3676417">sendAlert</span><span class="op" id="3676426">(</span><span class="ident" id="3676427">alertUnsupportedCertificate</span><span class="op" id="3676454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676458">return</span>&nbsp;<span class="ident" id="3676465">fmt</span><span class="op" id="3676468">.</span><span class="ident" id="3676469">Errorf</span><span class="op" id="3676475">(</span><span class="string" id="3676476">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3676550">,</span>&nbsp;<span class="ident" id="3676552">certs</span><span class="op" id="3676557">[</span><span class="num" id="3676558">0</span><span class="op" id="3676559">]</span><span class="op" id="3676560">.</span><span class="ident" id="3676561">PublicKey</span><span class="op" id="3676570">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676577">c</span><span class="op" id="3676578">.</span><span class="ident" id="3676579">peerCertificates</span>&nbsp;<span class="op" id="3676596">=</span>&nbsp;<span class="ident" id="3676598">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676606">if</span>&nbsp;<span class="ident" id="3676609">hs</span><span class="op" id="3676611">.</span><span class="ident" id="3676612">serverHello</span><span class="op" id="3676623">.</span><span class="ident" id="3676624">ocspStapling</span>&nbsp;<span class="op" id="3676637">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676641">msg</span><span class="op" id="3676644">,</span>&nbsp;<span class="ident" id="3676646">err</span>&nbsp;<span class="op" id="3676650">=</span>&nbsp;<span class="ident" id="3676652">c</span><span class="op" id="3676653">.</span><span class="ident" id="3676654">readHandshake</span><span class="op" id="3676667">(</span><span class="op" id="3676668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676672">if</span>&nbsp;<span class="ident" id="3676675">err</span>&nbsp;<span class="op" id="3676679">!=</span>&nbsp;<span class="ident" id="3676682">nil</span>&nbsp;<span class="op" id="3676686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676691">return</span>&nbsp;<span class="ident" id="3676698">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676708">cs</span><span class="op" id="3676710">,</span>&nbsp;<span class="ident" id="3676712">ok</span>&nbsp;<span class="op" id="3676715">:=</span>&nbsp;<span class="ident" id="3676718">msg</span><span class="op" id="3676721">.</span><span class="op" id="3676722">(</span><span class="op" id="3676723">*</span><span class="ident" id="3676724">certificateStatusMsg</span><span class="op" id="3676744">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676748">if</span>&nbsp;<span class="op" id="3676751">!</span><span class="ident" id="3676752">ok</span>&nbsp;<span class="op" id="3676755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676760">c</span><span class="op" id="3676761">.</span><span class="ident" id="3676762">sendAlert</span><span class="op" id="3676771">(</span><span class="ident" id="3676772">alertUnexpectedMessage</span><span class="op" id="3676794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676799">return</span>&nbsp;<span class="ident" id="3676806">unexpectedMessageError</span><span class="op" id="3676828">(</span><span class="ident" id="3676829">cs</span><span class="op" id="3676831">,</span>&nbsp;<span class="ident" id="3676833">msg</span><span class="op" id="3676836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676844">hs</span><span class="op" id="3676846">.</span><span class="ident" id="3676847">finishedHash</span><span class="op" id="3676859">.</span><span class="ident" id="3676860">Write</span><span class="op" id="3676865">(</span><span class="ident" id="3676866">cs</span><span class="op" id="3676868">.</span><span class="ident" id="3676869">marshal</span><span class="op" id="3676876">(</span><span class="op" id="3676877">)</span><span class="op" id="3676878">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676883">if</span>&nbsp;<span class="ident" id="3676886">cs</span><span class="op" id="3676888">.</span><span class="ident" id="3676889">statusType</span>&nbsp;<span class="op" id="3676900">==</span>&nbsp;<span class="ident" id="3676903">statusTypeOCSP</span>&nbsp;<span class="op" id="3676918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676923">c</span><span class="op" id="3676924">.</span><span class="ident" id="3676925">ocspResponse</span>&nbsp;<span class="op" id="3676938">=</span>&nbsp;<span class="ident" id="3676940">cs</span><span class="op" id="3676942">.</span><span class="ident" id="3676943">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676957">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676961">msg</span><span class="op" id="3676964">,</span>&nbsp;<span class="ident" id="3676966">err</span>&nbsp;<span class="op" id="3676970">=</span>&nbsp;<span class="ident" id="3676972">c</span><span class="op" id="3676973">.</span><span class="ident" id="3676974">readHandshake</span><span class="op" id="3676987">(</span><span class="op" id="3676988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676991">if</span>&nbsp;<span class="ident" id="3676994">err</span>&nbsp;<span class="op" id="3676998">!=</span>&nbsp;<span class="ident" id="3677001">nil</span>&nbsp;<span class="op" id="3677005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677009">return</span>&nbsp;<span class="ident" id="3677016">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677021">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677025">keyAgreement</span>&nbsp;<span class="op" id="3677038">:=</span>&nbsp;<span class="ident" id="3677041">hs</span><span class="op" id="3677043">.</span><span class="ident" id="3677044">suite</span><span class="op" id="3677049">.</span><span class="ident" id="3677050">ka</span><span class="op" id="3677052">(</span><span class="ident" id="3677053">c</span><span class="op" id="3677054">.</span><span class="ident" id="3677055">vers</span><span class="op" id="3677059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677063">skx</span><span class="op" id="3677066">,</span>&nbsp;<span class="ident" id="3677068">ok</span>&nbsp;<span class="op" id="3677071">:=</span>&nbsp;<span class="ident" id="3677074">msg</span><span class="op" id="3677077">.</span><span class="op" id="3677078">(</span><span class="op" id="3677079">*</span><span class="ident" id="3677080">serverKeyExchangeMsg</span><span class="op" id="3677100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677103">if</span>&nbsp;<span class="ident" id="3677106">ok</span>&nbsp;<span class="op" id="3677109">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677113">hs</span><span class="op" id="3677115">.</span><span class="ident" id="3677116">finishedHash</span><span class="op" id="3677128">.</span><span class="ident" id="3677129">Write</span><span class="op" id="3677134">(</span><span class="ident" id="3677135">skx</span><span class="op" id="3677138">.</span><span class="ident" id="3677139">marshal</span><span class="op" id="3677146">(</span><span class="op" id="3677147">)</span><span class="op" id="3677148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677152">err</span>&nbsp;<span class="op" id="3677156">=</span>&nbsp;<span class="ident" id="3677158">keyAgreement</span><span class="op" id="3677170">.</span><span class="ident" id="3677171">processServerKeyExchange</span><span class="op" id="3677195">(</span><span class="ident" id="3677196">c</span><span class="op" id="3677197">.</span><span class="ident" id="3677198">config</span><span class="op" id="3677204">,</span>&nbsp;<span class="ident" id="3677206">hs</span><span class="op" id="3677208">.</span><span class="ident" id="3677209">hello</span><span class="op" id="3677214">,</span>&nbsp;<span class="ident" id="3677216">hs</span><span class="op" id="3677218">.</span><span class="ident" id="3677219">serverHello</span><span class="op" id="3677230">,</span>&nbsp;<span class="ident" id="3677232">certs</span><span class="op" id="3677237">[</span><span class="num" id="3677238">0</span><span class="op" id="3677239">]</span><span class="op" id="3677240">,</span>&nbsp;<span class="ident" id="3677242">skx</span><span class="op" id="3677245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677249">if</span>&nbsp;<span class="ident" id="3677252">err</span>&nbsp;<span class="op" id="3677256">!=</span>&nbsp;<span class="ident" id="3677259">nil</span>&nbsp;<span class="op" id="3677263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677268">c</span><span class="op" id="3677269">.</span><span class="ident" id="3677270">sendAlert</span><span class="op" id="3677279">(</span><span class="ident" id="3677280">alertUnexpectedMessage</span><span class="op" id="3677302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677307">return</span>&nbsp;<span class="ident" id="3677314">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677325">msg</span><span class="op" id="3677328">,</span>&nbsp;<span class="ident" id="3677330">err</span>&nbsp;<span class="op" id="3677334">=</span>&nbsp;<span class="ident" id="3677336">c</span><span class="op" id="3677337">.</span><span class="ident" id="3677338">readHandshake</span><span class="op" id="3677351">(</span><span class="op" id="3677352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677356">if</span>&nbsp;<span class="ident" id="3677359">err</span>&nbsp;<span class="op" id="3677363">!=</span>&nbsp;<span class="ident" id="3677366">nil</span>&nbsp;<span class="op" id="3677370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677375">return</span>&nbsp;<span class="ident" id="3677382">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677395">var</span>&nbsp;<span class="ident" id="3677399">chainToSend</span>&nbsp;<span class="op" id="3677411">*</span><span class="ident" id="3677412">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677425">var</span>&nbsp;<span class="ident" id="3677429">certRequested</span>&nbsp;<span class="builtintype" id="3677443">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677449">certReq</span><span class="op" id="3677456">,</span>&nbsp;<span class="ident" id="3677458">ok</span>&nbsp;<span class="op" id="3677461">:=</span>&nbsp;<span class="ident" id="3677464">msg</span><span class="op" id="3677467">.</span><span class="op" id="3677468">(</span><span class="op" id="3677469">*</span><span class="ident" id="3677470">certificateRequestMsg</span><span class="op" id="3677491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677494">if</span>&nbsp;<span class="ident" id="3677497">ok</span>&nbsp;<span class="op" id="3677500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677504">certRequested</span>&nbsp;<span class="op" id="3677518">=</span>&nbsp;<span class="builtintype" id="3677520">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677528">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677579">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677644">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677710">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677773">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677838">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677885">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677948">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677993">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678051">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678086">hs</span><span class="op" id="3678088">.</span><span class="ident" id="3678089">finishedHash</span><span class="op" id="3678101">.</span><span class="ident" id="3678102">Write</span><span class="op" id="3678107">(</span><span class="ident" id="3678108">certReq</span><span class="op" id="3678115">.</span><span class="ident" id="3678116">marshal</span><span class="op" id="3678123">(</span><span class="op" id="3678124">)</span><span class="op" id="3678125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678130">var</span>&nbsp;<span class="ident" id="3678134">rsaAvail</span><span class="op" id="3678142">,</span>&nbsp;<span class="ident" id="3678144">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3678155">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678162">for</span>&nbsp;<span class="ident" id="3678166">_</span><span class="op" id="3678167">,</span>&nbsp;<span class="ident" id="3678169">certType</span>&nbsp;<span class="op" id="3678178">:=</span>&nbsp;<span class="keyword" id="3678181">range</span>&nbsp;<span class="ident" id="3678187">certReq</span><span class="op" id="3678194">.</span><span class="ident" id="3678195">certificateTypes</span>&nbsp;<span class="op" id="3678212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678217">switch</span>&nbsp;<span class="ident" id="3678224">certType</span>&nbsp;<span class="op" id="3678233">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678238">case</span>&nbsp;<span class="ident" id="3678243">certTypeRSASign</span><span class="op" id="3678258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678264">rsaAvail</span>&nbsp;<span class="op" id="3678273">=</span>&nbsp;<span class="builtintype" id="3678275">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678283">case</span>&nbsp;<span class="ident" id="3678288">certTypeECDSASign</span><span class="op" id="3678305">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678311">ecdsaAvail</span>&nbsp;<span class="op" id="3678322">=</span>&nbsp;<span class="builtintype" id="3678324">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678332">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678341">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678397">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678463">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678511">findCert</span><span class="op" id="3678519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678523">for</span>&nbsp;<span class="ident" id="3678527">i</span><span class="op" id="3678528">,</span>&nbsp;<span class="ident" id="3678530">chain</span>&nbsp;<span class="op" id="3678536">:=</span>&nbsp;<span class="keyword" id="3678539">range</span>&nbsp;<span class="ident" id="3678545">c</span><span class="op" id="3678546">.</span><span class="ident" id="3678547">config</span><span class="op" id="3678553">.</span><span class="ident" id="3678554">Certificates</span>&nbsp;<span class="op" id="3678567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678572">if</span>&nbsp;<span class="op" id="3678575">!</span><span class="ident" id="3678576">rsaAvail</span>&nbsp;<span class="op" id="3678585">&amp;&amp;</span>&nbsp;<span class="op" id="3678588">!</span><span class="ident" id="3678589">ecdsaAvail</span>&nbsp;<span class="op" id="3678600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678606">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678618">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678624">for</span>&nbsp;<span class="ident" id="3678628">j</span><span class="op" id="3678629">,</span>&nbsp;<span class="ident" id="3678631">cert</span>&nbsp;<span class="op" id="3678636">:=</span>&nbsp;<span class="keyword" id="3678639">range</span>&nbsp;<span class="ident" id="3678645">chain</span><span class="op" id="3678650">.</span><span class="ident" id="3678651">Certificate</span>&nbsp;<span class="op" id="3678663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678669">x509Cert</span>&nbsp;<span class="op" id="3678678">:=</span>&nbsp;<span class="ident" id="3678681">chain</span><span class="op" id="3678686">.</span><span class="ident" id="3678687">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678696">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678748">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678786">if</span>&nbsp;<span class="ident" id="3678789">j</span>&nbsp;<span class="op" id="3678791">!=</span>&nbsp;<span class="num" id="3678794">0</span>&nbsp;<span class="op" id="3678796">||</span>&nbsp;<span class="ident" id="3678799">x509Cert</span>&nbsp;<span class="op" id="3678808">==</span>&nbsp;<span class="ident" id="3678811">nil</span>&nbsp;<span class="op" id="3678815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678822">if</span>&nbsp;<span class="ident" id="3678825">x509Cert</span><span class="op" id="3678833">,</span>&nbsp;<span class="ident" id="3678835">err</span>&nbsp;<span class="op" id="3678839">=</span>&nbsp;<span class="ident" id="3678841">x509</span><span class="op" id="3678845">.</span><span class="ident" id="3678846">ParseCertificate</span><span class="op" id="3678862">(</span><span class="ident" id="3678863">cert</span><span class="op" id="3678867">)</span><span class="op" id="3678868">;</span>&nbsp;<span class="ident" id="3678870">err</span>&nbsp;<span class="op" id="3678874">!=</span>&nbsp;<span class="ident" id="3678877">nil</span>&nbsp;<span class="op" id="3678881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678889">c</span><span class="op" id="3678890">.</span><span class="ident" id="3678891">sendAlert</span><span class="op" id="3678900">(</span><span class="ident" id="3678901">alertInternalError</span><span class="op" id="3678919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678927">return</span>&nbsp;<span class="ident" id="3678934">errors</span><span class="op" id="3678940">.</span><span class="ident" id="3678941">New</span><span class="op" id="3678944">(</span><span class="string" id="3678945">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3678989">+</span>&nbsp;<span class="ident" id="3678991">strconv</span><span class="op" id="3678998">.</span><span class="ident" id="3678999">Itoa</span><span class="op" id="3679003">(</span><span class="ident" id="3679004">i</span><span class="op" id="3679005">)</span>&nbsp;<span class="op" id="3679007">+</span>&nbsp;<span class="string" id="3679009">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3679014">+</span>&nbsp;<span class="ident" id="3679016">err</span><span class="op" id="3679019">.</span><span class="ident" id="3679020">Error</span><span class="op" id="3679025">(</span><span class="op" id="3679026">)</span><span class="op" id="3679027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679034">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679047">switch</span>&nbsp;<span class="op" id="3679054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679060">case</span>&nbsp;<span class="ident" id="3679065">rsaAvail</span>&nbsp;<span class="op" id="3679074">&amp;&amp;</span>&nbsp;<span class="ident" id="3679077">x509Cert</span><span class="op" id="3679085">.</span><span class="ident" id="3679086">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3679105">==</span>&nbsp;<span class="ident" id="3679108">x509</span><span class="op" id="3679112">.</span><span class="ident" id="3679113">RSA</span><span class="op" id="3679116">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679122">case</span>&nbsp;<span class="ident" id="3679127">ecdsaAvail</span>&nbsp;<span class="op" id="3679138">&amp;&amp;</span>&nbsp;<span class="ident" id="3679141">x509Cert</span><span class="op" id="3679149">.</span><span class="ident" id="3679150">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3679169">==</span>&nbsp;<span class="ident" id="3679172">x509</span><span class="op" id="3679176">.</span><span class="ident" id="3679177">ECDSA</span><span class="op" id="3679182">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679188">default</span><span class="op" id="3679195">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679202">continue</span>&nbsp;<span class="ident" id="3679211">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679231">if</span>&nbsp;<span class="builtinfunc" id="3679234">len</span><span class="op" id="3679237">(</span><span class="ident" id="3679238">certReq</span><span class="op" id="3679245">.</span><span class="ident" id="3679246">certificateAuthorities</span><span class="op" id="3679268">)</span>&nbsp;<span class="op" id="3679270">==</span>&nbsp;<span class="num" id="3679273">0</span>&nbsp;<span class="op" id="3679275">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679282">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679335">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679381">chainToSend</span>&nbsp;<span class="op" id="3679393">=</span>&nbsp;<span class="op" id="3679395">&amp;</span><span class="ident" id="3679396">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679407">break</span>&nbsp;<span class="ident" id="3679413">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679426">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679433">for</span>&nbsp;<span class="ident" id="3679437">_</span><span class="op" id="3679438">,</span>&nbsp;<span class="ident" id="3679440">ca</span>&nbsp;<span class="op" id="3679443">:=</span>&nbsp;<span class="keyword" id="3679446">range</span>&nbsp;<span class="ident" id="3679452">certReq</span><span class="op" id="3679459">.</span><span class="ident" id="3679460">certificateAuthorities</span>&nbsp;<span class="op" id="3679483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679490">if</span>&nbsp;<span class="ident" id="3679493">bytes</span><span class="op" id="3679498">.</span><span class="ident" id="3679499">Equal</span><span class="op" id="3679504">(</span><span class="ident" id="3679505">x509Cert</span><span class="op" id="3679513">.</span><span class="ident" id="3679514">RawIssuer</span><span class="op" id="3679523">,</span>&nbsp;<span class="ident" id="3679525">ca</span><span class="op" id="3679527">)</span>&nbsp;<span class="op" id="3679529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679537">chainToSend</span>&nbsp;<span class="op" id="3679549">=</span>&nbsp;<span class="op" id="3679551">&amp;</span><span class="ident" id="3679552">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679564">break</span>&nbsp;<span class="ident" id="3679570">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679604">msg</span><span class="op" id="3679607">,</span>&nbsp;<span class="ident" id="3679609">err</span>&nbsp;<span class="op" id="3679613">=</span>&nbsp;<span class="ident" id="3679615">c</span><span class="op" id="3679616">.</span><span class="ident" id="3679617">readHandshake</span><span class="op" id="3679630">(</span><span class="op" id="3679631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679635">if</span>&nbsp;<span class="ident" id="3679638">err</span>&nbsp;<span class="op" id="3679642">!=</span>&nbsp;<span class="ident" id="3679645">nil</span>&nbsp;<span class="op" id="3679649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679654">return</span>&nbsp;<span class="ident" id="3679661">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679670">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679674">shd</span><span class="op" id="3679677">,</span>&nbsp;<span class="ident" id="3679679">ok</span>&nbsp;<span class="op" id="3679682">:=</span>&nbsp;<span class="ident" id="3679685">msg</span><span class="op" id="3679688">.</span><span class="op" id="3679689">(</span><span class="op" id="3679690">*</span><span class="ident" id="3679691">serverHelloDoneMsg</span><span class="op" id="3679709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679712">if</span>&nbsp;<span class="op" id="3679715">!</span><span class="ident" id="3679716">ok</span>&nbsp;<span class="op" id="3679719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679723">c</span><span class="op" id="3679724">.</span><span class="ident" id="3679725">sendAlert</span><span class="op" id="3679734">(</span><span class="ident" id="3679735">alertUnexpectedMessage</span><span class="op" id="3679757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679761">return</span>&nbsp;<span class="ident" id="3679768">unexpectedMessageError</span><span class="op" id="3679790">(</span><span class="ident" id="3679791">shd</span><span class="op" id="3679794">,</span>&nbsp;<span class="ident" id="3679796">msg</span><span class="op" id="3679799">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679805">hs</span><span class="op" id="3679807">.</span><span class="ident" id="3679808">finishedHash</span><span class="op" id="3679820">.</span><span class="ident" id="3679821">Write</span><span class="op" id="3679826">(</span><span class="ident" id="3679827">shd</span><span class="op" id="3679830">.</span><span class="ident" id="3679831">marshal</span><span class="op" id="3679838">(</span><span class="op" id="3679839">)</span><span class="op" id="3679840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679844">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679909">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679977">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680002">if</span>&nbsp;<span class="ident" id="3680005">certRequested</span>&nbsp;<span class="op" id="3680019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680023">certMsg</span>&nbsp;<span class="op" id="3680031">=</span>&nbsp;<span class="builtinfunc" id="3680033">new</span><span class="op" id="3680036">(</span><span class="ident" id="3680037">certificateMsg</span><span class="op" id="3680051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680055">if</span>&nbsp;<span class="ident" id="3680058">chainToSend</span>&nbsp;<span class="op" id="3680070">!=</span>&nbsp;<span class="ident" id="3680073">nil</span>&nbsp;<span class="op" id="3680077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680082">certMsg</span><span class="op" id="3680089">.</span><span class="ident" id="3680090">certificates</span>&nbsp;<span class="op" id="3680103">=</span>&nbsp;<span class="ident" id="3680105">chainToSend</span><span class="op" id="3680116">.</span><span class="ident" id="3680117">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680135">hs</span><span class="op" id="3680137">.</span><span class="ident" id="3680138">finishedHash</span><span class="op" id="3680150">.</span><span class="ident" id="3680151">Write</span><span class="op" id="3680156">(</span><span class="ident" id="3680157">certMsg</span><span class="op" id="3680164">.</span><span class="ident" id="3680165">marshal</span><span class="op" id="3680172">(</span><span class="op" id="3680173">)</span><span class="op" id="3680174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680178">c</span><span class="op" id="3680179">.</span><span class="ident" id="3680180">writeRecord</span><span class="op" id="3680191">(</span><span class="ident" id="3680192">recordTypeHandshake</span><span class="op" id="3680211">,</span>&nbsp;<span class="ident" id="3680213">certMsg</span><span class="op" id="3680220">.</span><span class="ident" id="3680221">marshal</span><span class="op" id="3680228">(</span><span class="op" id="3680229">)</span><span class="op" id="3680230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680237">preMasterSecret</span><span class="op" id="3680252">,</span>&nbsp;<span class="ident" id="3680254">ckx</span><span class="op" id="3680257">,</span>&nbsp;<span class="ident" id="3680259">err</span>&nbsp;<span class="op" id="3680263">:=</span>&nbsp;<span class="ident" id="3680266">keyAgreement</span><span class="op" id="3680278">.</span><span class="ident" id="3680279">generateClientKeyExchange</span><span class="op" id="3680304">(</span><span class="ident" id="3680305">c</span><span class="op" id="3680306">.</span><span class="ident" id="3680307">config</span><span class="op" id="3680313">,</span>&nbsp;<span class="ident" id="3680315">hs</span><span class="op" id="3680317">.</span><span class="ident" id="3680318">hello</span><span class="op" id="3680323">,</span>&nbsp;<span class="ident" id="3680325">certs</span><span class="op" id="3680330">[</span><span class="num" id="3680331">0</span><span class="op" id="3680332">]</span><span class="op" id="3680333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680336">if</span>&nbsp;<span class="ident" id="3680339">err</span>&nbsp;<span class="op" id="3680343">!=</span>&nbsp;<span class="ident" id="3680346">nil</span>&nbsp;<span class="op" id="3680350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680354">c</span><span class="op" id="3680355">.</span><span class="ident" id="3680356">sendAlert</span><span class="op" id="3680365">(</span><span class="ident" id="3680366">alertInternalError</span><span class="op" id="3680384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680388">return</span>&nbsp;<span class="ident" id="3680395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680400">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680403">if</span>&nbsp;<span class="ident" id="3680406">ckx</span>&nbsp;<span class="op" id="3680410">!=</span>&nbsp;<span class="ident" id="3680413">nil</span>&nbsp;<span class="op" id="3680417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680421">hs</span><span class="op" id="3680423">.</span><span class="ident" id="3680424">finishedHash</span><span class="op" id="3680436">.</span><span class="ident" id="3680437">Write</span><span class="op" id="3680442">(</span><span class="ident" id="3680443">ckx</span><span class="op" id="3680446">.</span><span class="ident" id="3680447">marshal</span><span class="op" id="3680454">(</span><span class="op" id="3680455">)</span><span class="op" id="3680456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680460">c</span><span class="op" id="3680461">.</span><span class="ident" id="3680462">writeRecord</span><span class="op" id="3680473">(</span><span class="ident" id="3680474">recordTypeHandshake</span><span class="op" id="3680493">,</span>&nbsp;<span class="ident" id="3680495">ckx</span><span class="op" id="3680498">.</span><span class="ident" id="3680499">marshal</span><span class="op" id="3680506">(</span><span class="op" id="3680507">)</span><span class="op" id="3680508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680515">if</span>&nbsp;<span class="ident" id="3680518">chainToSend</span>&nbsp;<span class="op" id="3680530">!=</span>&nbsp;<span class="ident" id="3680533">nil</span>&nbsp;<span class="op" id="3680537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680541">var</span>&nbsp;<span class="ident" id="3680545">signed</span>&nbsp;<span class="op" id="3680552">[</span><span class="op" id="3680553">]</span><span class="builtintype" id="3680554">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680561">certVerify</span>&nbsp;<span class="op" id="3680572">:=</span>&nbsp;<span class="op" id="3680575">&amp;</span><span class="ident" id="3680576">certificateVerifyMsg</span><span class="op" id="3680596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680601">hasSignatureAndHash</span><span class="op" id="3680620">:</span>&nbsp;<span class="ident" id="3680622">c</span><span class="op" id="3680623">.</span><span class="ident" id="3680624">vers</span>&nbsp;<span class="op" id="3680629">&gt;=</span>&nbsp;<span class="ident" id="3680632">VersionTLS12</span><span class="op" id="3680644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680648">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680653">key</span><span class="op" id="3680656">,</span>&nbsp;<span class="ident" id="3680658">ok</span>&nbsp;<span class="op" id="3680661">:=</span>&nbsp;<span class="ident" id="3680664">chainToSend</span><span class="op" id="3680675">.</span><span class="ident" id="3680676">PrivateKey</span><span class="op" id="3680686">.</span><span class="op" id="3680687">(</span><span class="ident" id="3680688">crypto</span><span class="op" id="3680694">.</span><span class="ident" id="3680695">Signer</span><span class="op" id="3680701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680705">if</span>&nbsp;<span class="op" id="3680708">!</span><span class="ident" id="3680709">ok</span>&nbsp;<span class="op" id="3680712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680717">c</span><span class="op" id="3680718">.</span><span class="ident" id="3680719">sendAlert</span><span class="op" id="3680728">(</span><span class="ident" id="3680729">alertInternalError</span><span class="op" id="3680747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680752">return</span>&nbsp;<span class="ident" id="3680759">fmt</span><span class="op" id="3680762">.</span><span class="ident" id="3680763">Errorf</span><span class="op" id="3680769">(</span><span class="string" id="3680770">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3680851">,</span>&nbsp;<span class="ident" id="3680853">chainToSend</span><span class="op" id="3680864">.</span><span class="ident" id="3680865">PrivateKey</span><span class="op" id="3680875">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680883">switch</span>&nbsp;<span class="ident" id="3680890">key</span><span class="op" id="3680893">.</span><span class="ident" id="3680894">Public</span><span class="op" id="3680900">(</span><span class="op" id="3680901">)</span><span class="op" id="3680902">.</span><span class="op" id="3680903">(</span><span class="keyword" id="3680904">type</span><span class="op" id="3680908">)</span>&nbsp;<span class="op" id="3680910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680914">case</span>&nbsp;<span class="op" id="3680919">*</span><span class="ident" id="3680920">ecdsa</span><span class="op" id="3680925">.</span><span class="ident" id="3680926">PublicKey</span><span class="op" id="3680935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680940">digest</span><span class="op" id="3680946">,</span>&nbsp;<span class="ident" id="3680948">hashFunc</span><span class="op" id="3680956">,</span>&nbsp;<span class="ident" id="3680958">hashId</span>&nbsp;<span class="op" id="3680965">:=</span>&nbsp;<span class="ident" id="3680968">hs</span><span class="op" id="3680970">.</span><span class="ident" id="3680971">finishedHash</span><span class="op" id="3680983">.</span><span class="ident" id="3680984">hashForClientCertificate</span><span class="op" id="3681008">(</span><span class="ident" id="3681009">signatureECDSA</span><span class="op" id="3681023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681028">signed</span><span class="op" id="3681034">,</span>&nbsp;<span class="ident" id="3681036">err</span>&nbsp;<span class="op" id="3681040">=</span>&nbsp;<span class="ident" id="3681042">key</span><span class="op" id="3681045">.</span><span class="ident" id="3681046">Sign</span><span class="op" id="3681050">(</span><span class="ident" id="3681051">c</span><span class="op" id="3681052">.</span><span class="ident" id="3681053">config</span><span class="op" id="3681059">.</span><span class="ident" id="3681060">rand</span><span class="op" id="3681064">(</span><span class="op" id="3681065">)</span><span class="op" id="3681066">,</span>&nbsp;<span class="ident" id="3681068">digest</span><span class="op" id="3681074">,</span>&nbsp;<span class="ident" id="3681076">hashFunc</span><span class="op" id="3681084">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681089">certVerify</span><span class="op" id="3681099">.</span><span class="ident" id="3681100">signatureAndHash</span><span class="op" id="3681116">.</span><span class="ident" id="3681117">signature</span>&nbsp;<span class="op" id="3681127">=</span>&nbsp;<span class="ident" id="3681129">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681147">certVerify</span><span class="op" id="3681157">.</span><span class="ident" id="3681158">signatureAndHash</span><span class="op" id="3681174">.</span><span class="ident" id="3681175">hash</span>&nbsp;<span class="op" id="3681180">=</span>&nbsp;<span class="ident" id="3681182">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681191">case</span>&nbsp;<span class="op" id="3681196">*</span><span class="ident" id="3681197">rsa</span><span class="op" id="3681200">.</span><span class="ident" id="3681201">PublicKey</span><span class="op" id="3681210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681215">digest</span><span class="op" id="3681221">,</span>&nbsp;<span class="ident" id="3681223">hashFunc</span><span class="op" id="3681231">,</span>&nbsp;<span class="ident" id="3681233">hashId</span>&nbsp;<span class="op" id="3681240">:=</span>&nbsp;<span class="ident" id="3681243">hs</span><span class="op" id="3681245">.</span><span class="ident" id="3681246">finishedHash</span><span class="op" id="3681258">.</span><span class="ident" id="3681259">hashForClientCertificate</span><span class="op" id="3681283">(</span><span class="ident" id="3681284">signatureRSA</span><span class="op" id="3681296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681301">signed</span><span class="op" id="3681307">,</span>&nbsp;<span class="ident" id="3681309">err</span>&nbsp;<span class="op" id="3681313">=</span>&nbsp;<span class="ident" id="3681315">key</span><span class="op" id="3681318">.</span><span class="ident" id="3681319">Sign</span><span class="op" id="3681323">(</span><span class="ident" id="3681324">c</span><span class="op" id="3681325">.</span><span class="ident" id="3681326">config</span><span class="op" id="3681332">.</span><span class="ident" id="3681333">rand</span><span class="op" id="3681337">(</span><span class="op" id="3681338">)</span><span class="op" id="3681339">,</span>&nbsp;<span class="ident" id="3681341">digest</span><span class="op" id="3681347">,</span>&nbsp;<span class="ident" id="3681349">hashFunc</span><span class="op" id="3681357">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681362">certVerify</span><span class="op" id="3681372">.</span><span class="ident" id="3681373">signatureAndHash</span><span class="op" id="3681389">.</span><span class="ident" id="3681390">signature</span>&nbsp;<span class="op" id="3681400">=</span>&nbsp;<span class="ident" id="3681402">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681418">certVerify</span><span class="op" id="3681428">.</span><span class="ident" id="3681429">signatureAndHash</span><span class="op" id="3681445">.</span><span class="ident" id="3681446">hash</span>&nbsp;<span class="op" id="3681451">=</span>&nbsp;<span class="ident" id="3681453">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681462">default</span><span class="op" id="3681469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681474">err</span>&nbsp;<span class="op" id="3681478">=</span>&nbsp;<span class="ident" id="3681480">fmt</span><span class="op" id="3681483">.</span><span class="ident" id="3681484">Errorf</span><span class="op" id="3681490">(</span><span class="string" id="3681491">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3681537">,</span>&nbsp;<span class="ident" id="3681539">key</span><span class="op" id="3681542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681546">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681550">if</span>&nbsp;<span class="ident" id="3681553">err</span>&nbsp;<span class="op" id="3681557">!=</span>&nbsp;<span class="ident" id="3681560">nil</span>&nbsp;<span class="op" id="3681564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681569">c</span><span class="op" id="3681570">.</span><span class="ident" id="3681571">sendAlert</span><span class="op" id="3681580">(</span><span class="ident" id="3681581">alertInternalError</span><span class="op" id="3681599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681604">return</span>&nbsp;<span class="ident" id="3681611">errors</span><span class="op" id="3681617">.</span><span class="ident" id="3681618">New</span><span class="op" id="3681621">(</span><span class="string" id="3681622">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3681680">+</span>&nbsp;<span class="ident" id="3681682">err</span><span class="op" id="3681685">.</span><span class="ident" id="3681686">Error</span><span class="op" id="3681691">(</span><span class="op" id="3681692">)</span><span class="op" id="3681693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681701">certVerify</span><span class="op" id="3681711">.</span><span class="ident" id="3681712">signature</span>&nbsp;<span class="op" id="3681722">=</span>&nbsp;<span class="ident" id="3681724">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681734">hs</span><span class="op" id="3681736">.</span><span class="ident" id="3681737">finishedHash</span><span class="op" id="3681749">.</span><span class="ident" id="3681750">Write</span><span class="op" id="3681755">(</span><span class="ident" id="3681756">certVerify</span><span class="op" id="3681766">.</span><span class="ident" id="3681767">marshal</span><span class="op" id="3681774">(</span><span class="op" id="3681775">)</span><span class="op" id="3681776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681780">c</span><span class="op" id="3681781">.</span><span class="ident" id="3681782">writeRecord</span><span class="op" id="3681793">(</span><span class="ident" id="3681794">recordTypeHandshake</span><span class="op" id="3681813">,</span>&nbsp;<span class="ident" id="3681815">certVerify</span><span class="op" id="3681825">.</span><span class="ident" id="3681826">marshal</span><span class="op" id="3681833">(</span><span class="op" id="3681834">)</span><span class="op" id="3681835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681842">hs</span><span class="op" id="3681844">.</span><span class="ident" id="3681845">masterSecret</span>&nbsp;<span class="op" id="3681858">=</span>&nbsp;<span class="ident" id="3681860">masterFromPreMasterSecret</span><span class="op" id="3681885">(</span><span class="ident" id="3681886">c</span><span class="op" id="3681887">.</span><span class="ident" id="3681888">vers</span><span class="op" id="3681892">,</span>&nbsp;<span class="ident" id="3681894">preMasterSecret</span><span class="op" id="3681909">,</span>&nbsp;<span class="ident" id="3681911">hs</span><span class="op" id="3681913">.</span><span class="ident" id="3681914">hello</span><span class="op" id="3681919">.</span><span class="ident" id="3681920">random</span><span class="op" id="3681926">,</span>&nbsp;<span class="ident" id="3681928">hs</span><span class="op" id="3681930">.</span><span class="ident" id="3681931">serverHello</span><span class="op" id="3681942">.</span><span class="ident" id="3681943">random</span><span class="op" id="3681949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681952">return</span>&nbsp;<span class="ident" id="3681959">nil</span><br>
<span class="lineno"></span><span class="op" id="3681963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3681966">func</span>&nbsp;<span class="op" id="3681971">(</span><span class="ident" id="3681972">hs</span>&nbsp;<span class="op" id="3681975">*</span><span class="ident" id="3681976">clientHandshakeState</span><span class="op" id="3681996">)</span>&nbsp;<span class="ident" id="3681998">establishKeys</span><span class="op" id="3682011">(</span><span class="op" id="3682012">)</span>&nbsp;<span class="builtintype" id="3682014">error</span>&nbsp;<span class="op" id="3682020">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682023">c</span>&nbsp;<span class="op" id="3682025">:=</span>&nbsp;<span class="ident" id="3682028">hs</span><span class="op" id="3682030">.</span><span class="ident" id="3682031">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682035">clientMAC</span><span class="op" id="3682044">,</span>&nbsp;<span class="ident" id="3682046">serverMAC</span><span class="op" id="3682055">,</span>&nbsp;<span class="ident" id="3682057">clientKey</span><span class="op" id="3682066">,</span>&nbsp;<span class="ident" id="3682068">serverKey</span><span class="op" id="3682077">,</span>&nbsp;<span class="ident" id="3682079">clientIV</span><span class="op" id="3682087">,</span>&nbsp;<span class="ident" id="3682089">serverIV</span>&nbsp;<span class="op" id="3682098">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682103">keysFromMasterSecret</span><span class="op" id="3682123">(</span><span class="ident" id="3682124">c</span><span class="op" id="3682125">.</span><span class="ident" id="3682126">vers</span><span class="op" id="3682130">,</span>&nbsp;<span class="ident" id="3682132">hs</span><span class="op" id="3682134">.</span><span class="ident" id="3682135">masterSecret</span><span class="op" id="3682147">,</span>&nbsp;<span class="ident" id="3682149">hs</span><span class="op" id="3682151">.</span><span class="ident" id="3682152">hello</span><span class="op" id="3682157">.</span><span class="ident" id="3682158">random</span><span class="op" id="3682164">,</span>&nbsp;<span class="ident" id="3682166">hs</span><span class="op" id="3682168">.</span><span class="ident" id="3682169">serverHello</span><span class="op" id="3682180">.</span><span class="ident" id="3682181">random</span><span class="op" id="3682187">,</span>&nbsp;<span class="ident" id="3682189">hs</span><span class="op" id="3682191">.</span><span class="ident" id="3682192">suite</span><span class="op" id="3682197">.</span><span class="ident" id="3682198">macLen</span><span class="op" id="3682204">,</span>&nbsp;<span class="ident" id="3682206">hs</span><span class="op" id="3682208">.</span><span class="ident" id="3682209">suite</span><span class="op" id="3682214">.</span><span class="ident" id="3682215">keyLen</span><span class="op" id="3682221">,</span>&nbsp;<span class="ident" id="3682223">hs</span><span class="op" id="3682225">.</span><span class="ident" id="3682226">suite</span><span class="op" id="3682231">.</span><span class="ident" id="3682232">ivLen</span><span class="op" id="3682237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682240">var</span>&nbsp;<span class="ident" id="3682244">clientCipher</span><span class="op" id="3682256">,</span>&nbsp;<span class="ident" id="3682258">serverCipher</span>&nbsp;<span class="keyword" id="3682271">interface</span><span class="op" id="3682280">{</span><span class="op" id="3682281">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682284">var</span>&nbsp;<span class="ident" id="3682288">clientHash</span><span class="op" id="3682298">,</span>&nbsp;<span class="ident" id="3682300">serverHash</span>&nbsp;<span class="ident" id="3682311">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682324">if</span>&nbsp;<span class="ident" id="3682327">hs</span><span class="op" id="3682329">.</span><span class="ident" id="3682330">suite</span><span class="op" id="3682335">.</span><span class="ident" id="3682336">cipher</span>&nbsp;<span class="op" id="3682343">!=</span>&nbsp;<span class="ident" id="3682346">nil</span>&nbsp;<span class="op" id="3682350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682354">clientCipher</span>&nbsp;<span class="op" id="3682367">=</span>&nbsp;<span class="ident" id="3682369">hs</span><span class="op" id="3682371">.</span><span class="ident" id="3682372">suite</span><span class="op" id="3682377">.</span><span class="ident" id="3682378">cipher</span><span class="op" id="3682384">(</span><span class="ident" id="3682385">clientKey</span><span class="op" id="3682394">,</span>&nbsp;<span class="ident" id="3682396">clientIV</span><span class="op" id="3682404">,</span>&nbsp;<span class="builtintype" id="3682406">false</span>&nbsp;<span class="comment" id="3682412">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3682433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682437">clientHash</span>&nbsp;<span class="op" id="3682448">=</span>&nbsp;<span class="ident" id="3682450">hs</span><span class="op" id="3682452">.</span><span class="ident" id="3682453">suite</span><span class="op" id="3682458">.</span><span class="ident" id="3682459">mac</span><span class="op" id="3682462">(</span><span class="ident" id="3682463">c</span><span class="op" id="3682464">.</span><span class="ident" id="3682465">vers</span><span class="op" id="3682469">,</span>&nbsp;<span class="ident" id="3682471">clientMAC</span><span class="op" id="3682480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682484">serverCipher</span>&nbsp;<span class="op" id="3682497">=</span>&nbsp;<span class="ident" id="3682499">hs</span><span class="op" id="3682501">.</span><span class="ident" id="3682502">suite</span><span class="op" id="3682507">.</span><span class="ident" id="3682508">cipher</span><span class="op" id="3682514">(</span><span class="ident" id="3682515">serverKey</span><span class="op" id="3682524">,</span>&nbsp;<span class="ident" id="3682526">serverIV</span><span class="op" id="3682534">,</span>&nbsp;<span class="builtintype" id="3682536">true</span>&nbsp;<span class="comment" id="3682541">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3682558">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682562">serverHash</span>&nbsp;<span class="op" id="3682573">=</span>&nbsp;<span class="ident" id="3682575">hs</span><span class="op" id="3682577">.</span><span class="ident" id="3682578">suite</span><span class="op" id="3682583">.</span><span class="ident" id="3682584">mac</span><span class="op" id="3682587">(</span><span class="ident" id="3682588">c</span><span class="op" id="3682589">.</span><span class="ident" id="3682590">vers</span><span class="op" id="3682594">,</span>&nbsp;<span class="ident" id="3682596">serverMAC</span><span class="op" id="3682605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682608">}</span>&nbsp;<span class="keyword" id="3682610">else</span>&nbsp;<span class="op" id="3682615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682619">clientCipher</span>&nbsp;<span class="op" id="3682632">=</span>&nbsp;<span class="ident" id="3682634">hs</span><span class="op" id="3682636">.</span><span class="ident" id="3682637">suite</span><span class="op" id="3682642">.</span><span class="ident" id="3682643">aead</span><span class="op" id="3682647">(</span><span class="ident" id="3682648">clientKey</span><span class="op" id="3682657">,</span>&nbsp;<span class="ident" id="3682659">clientIV</span><span class="op" id="3682667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682671">serverCipher</span>&nbsp;<span class="op" id="3682684">=</span>&nbsp;<span class="ident" id="3682686">hs</span><span class="op" id="3682688">.</span><span class="ident" id="3682689">suite</span><span class="op" id="3682694">.</span><span class="ident" id="3682695">aead</span><span class="op" id="3682699">(</span><span class="ident" id="3682700">serverKey</span><span class="op" id="3682709">,</span>&nbsp;<span class="ident" id="3682711">serverIV</span><span class="op" id="3682719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682722">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682726">c</span><span class="op" id="3682727">.</span><span class="ident" id="3682728">in</span><span class="op" id="3682730">.</span><span class="ident" id="3682731">prepareCipherSpec</span><span class="op" id="3682748">(</span><span class="ident" id="3682749">c</span><span class="op" id="3682750">.</span><span class="ident" id="3682751">vers</span><span class="op" id="3682755">,</span>&nbsp;<span class="ident" id="3682757">serverCipher</span><span class="op" id="3682769">,</span>&nbsp;<span class="ident" id="3682771">serverHash</span><span class="op" id="3682781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682784">c</span><span class="op" id="3682785">.</span><span class="ident" id="3682786">out</span><span class="op" id="3682789">.</span><span class="ident" id="3682790">prepareCipherSpec</span><span class="op" id="3682807">(</span><span class="ident" id="3682808">c</span><span class="op" id="3682809">.</span><span class="ident" id="3682810">vers</span><span class="op" id="3682814">,</span>&nbsp;<span class="ident" id="3682816">clientCipher</span><span class="op" id="3682828">,</span>&nbsp;<span class="ident" id="3682830">clientHash</span><span class="op" id="3682840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682843">return</span>&nbsp;<span class="ident" id="3682850">nil</span><br>
<span class="lineno"></span><span class="op" id="3682854">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3682857">func</span>&nbsp;<span class="op" id="3682862">(</span><span class="ident" id="3682863">hs</span>&nbsp;<span class="op" id="3682866">*</span><span class="ident" id="3682867">clientHandshakeState</span><span class="op" id="3682887">)</span>&nbsp;<span class="ident" id="3682889">serverResumedSession</span><span class="op" id="3682909">(</span><span class="op" id="3682910">)</span>&nbsp;<span class="builtintype" id="3682912">bool</span>&nbsp;<span class="op" id="3682917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3682920">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3682990">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683047">return</span>&nbsp;<span class="ident" id="3683054">hs</span><span class="op" id="3683056">.</span><span class="ident" id="3683057">session</span>&nbsp;<span class="op" id="3683065">!=</span>&nbsp;<span class="ident" id="3683068">nil</span>&nbsp;<span class="op" id="3683072">&amp;&amp;</span>&nbsp;<span class="ident" id="3683075">hs</span><span class="op" id="3683077">.</span><span class="ident" id="3683078">hello</span><span class="op" id="3683083">.</span><span class="ident" id="3683084">sessionId</span>&nbsp;<span class="op" id="3683094">!=</span>&nbsp;<span class="ident" id="3683097">nil</span>&nbsp;<span class="op" id="3683101">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683106">bytes</span><span class="op" id="3683111">.</span><span class="ident" id="3683112">Equal</span><span class="op" id="3683117">(</span><span class="ident" id="3683118">hs</span><span class="op" id="3683120">.</span><span class="ident" id="3683121">serverHello</span><span class="op" id="3683132">.</span><span class="ident" id="3683133">sessionId</span><span class="op" id="3683142">,</span>&nbsp;<span class="ident" id="3683144">hs</span><span class="op" id="3683146">.</span><span class="ident" id="3683147">hello</span><span class="op" id="3683152">.</span><span class="ident" id="3683153">sessionId</span><span class="op" id="3683162">)</span><br>
<span class="lineno"></span><span class="op" id="3683164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3683167">func</span>&nbsp;<span class="op" id="3683172">(</span><span class="ident" id="3683173">hs</span>&nbsp;<span class="op" id="3683176">*</span><span class="ident" id="3683177">clientHandshakeState</span><span class="op" id="3683197">)</span>&nbsp;<span class="ident" id="3683199">processServerHello</span><span class="op" id="3683217">(</span><span class="op" id="3683218">)</span>&nbsp;<span class="op" id="3683220">(</span><span class="builtintype" id="3683221">bool</span><span class="op" id="3683225">,</span>&nbsp;<span class="builtintype" id="3683227">error</span><span class="op" id="3683232">)</span>&nbsp;<span class="op" id="3683234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683237">c</span>&nbsp;<span class="op" id="3683239">:=</span>&nbsp;<span class="ident" id="3683242">hs</span><span class="op" id="3683244">.</span><span class="ident" id="3683245">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683249">if</span>&nbsp;<span class="ident" id="3683252">hs</span><span class="op" id="3683254">.</span><span class="ident" id="3683255">serverHello</span><span class="op" id="3683266">.</span><span class="ident" id="3683267">compressionMethod</span>&nbsp;<span class="op" id="3683285">!=</span>&nbsp;<span class="ident" id="3683288">compressionNone</span>&nbsp;<span class="op" id="3683304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683308">c</span><span class="op" id="3683309">.</span><span class="ident" id="3683310">sendAlert</span><span class="op" id="3683319">(</span><span class="ident" id="3683320">alertUnexpectedMessage</span><span class="op" id="3683342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683346">return</span>&nbsp;<span class="builtintype" id="3683353">false</span><span class="op" id="3683358">,</span>&nbsp;<span class="ident" id="3683360">errors</span><span class="op" id="3683366">.</span><span class="ident" id="3683367">New</span><span class="op" id="3683370">(</span><span class="string" id="3683371">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3683424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683427">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683431">clientDidNPN</span>&nbsp;<span class="op" id="3683444">:=</span>&nbsp;<span class="ident" id="3683447">hs</span><span class="op" id="3683449">.</span><span class="ident" id="3683450">hello</span><span class="op" id="3683455">.</span><span class="ident" id="3683456">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683470">clientDidALPN</span>&nbsp;<span class="op" id="3683484">:=</span>&nbsp;<span class="builtinfunc" id="3683487">len</span><span class="op" id="3683490">(</span><span class="ident" id="3683491">hs</span><span class="op" id="3683493">.</span><span class="ident" id="3683494">hello</span><span class="op" id="3683499">.</span><span class="ident" id="3683500">alpnProtocols</span><span class="op" id="3683513">)</span>&nbsp;<span class="op" id="3683515">&gt;</span>&nbsp;<span class="num" id="3683517">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683520">serverHasNPN</span>&nbsp;<span class="op" id="3683533">:=</span>&nbsp;<span class="ident" id="3683536">hs</span><span class="op" id="3683538">.</span><span class="ident" id="3683539">serverHello</span><span class="op" id="3683550">.</span><span class="ident" id="3683551">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683565">serverHasALPN</span>&nbsp;<span class="op" id="3683579">:=</span>&nbsp;<span class="builtinfunc" id="3683582">len</span><span class="op" id="3683585">(</span><span class="ident" id="3683586">hs</span><span class="op" id="3683588">.</span><span class="ident" id="3683589">serverHello</span><span class="op" id="3683600">.</span><span class="ident" id="3683601">alpnProtocol</span><span class="op" id="3683613">)</span>&nbsp;<span class="op" id="3683615">&gt;</span>&nbsp;<span class="num" id="3683617">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683621">if</span>&nbsp;<span class="op" id="3683624">!</span><span class="ident" id="3683625">clientDidNPN</span>&nbsp;<span class="op" id="3683638">&amp;&amp;</span>&nbsp;<span class="ident" id="3683641">serverHasNPN</span>&nbsp;<span class="op" id="3683654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683658">c</span><span class="op" id="3683659">.</span><span class="ident" id="3683660">sendAlert</span><span class="op" id="3683669">(</span><span class="ident" id="3683670">alertHandshakeFailure</span><span class="op" id="3683691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683695">return</span>&nbsp;<span class="builtintype" id="3683702">false</span><span class="op" id="3683707">,</span>&nbsp;<span class="ident" id="3683709">errors</span><span class="op" id="3683715">.</span><span class="ident" id="3683716">New</span><span class="op" id="3683719">(</span><span class="string" id="3683720">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3683765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683768">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683772">if</span>&nbsp;<span class="op" id="3683775">!</span><span class="ident" id="3683776">clientDidALPN</span>&nbsp;<span class="op" id="3683790">&amp;&amp;</span>&nbsp;<span class="ident" id="3683793">serverHasALPN</span>&nbsp;<span class="op" id="3683807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683811">c</span><span class="op" id="3683812">.</span><span class="ident" id="3683813">sendAlert</span><span class="op" id="3683822">(</span><span class="ident" id="3683823">alertHandshakeFailure</span><span class="op" id="3683844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683848">return</span>&nbsp;<span class="builtintype" id="3683855">false</span><span class="op" id="3683860">,</span>&nbsp;<span class="ident" id="3683862">errors</span><span class="op" id="3683868">.</span><span class="ident" id="3683869">New</span><span class="op" id="3683872">(</span><span class="string" id="3683873">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3683919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683922">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683926">if</span>&nbsp;<span class="ident" id="3683929">serverHasNPN</span>&nbsp;<span class="op" id="3683942">&amp;&amp;</span>&nbsp;<span class="ident" id="3683945">serverHasALPN</span>&nbsp;<span class="op" id="3683959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683963">c</span><span class="op" id="3683964">.</span><span class="ident" id="3683965">sendAlert</span><span class="op" id="3683974">(</span><span class="ident" id="3683975">alertHandshakeFailure</span><span class="op" id="3683996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684000">return</span>&nbsp;<span class="builtintype" id="3684007">false</span><span class="op" id="3684012">,</span>&nbsp;<span class="ident" id="3684014">errors</span><span class="op" id="3684020">.</span><span class="ident" id="3684021">New</span><span class="op" id="3684024">(</span><span class="string" id="3684025">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3684073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684076">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684080">if</span>&nbsp;<span class="ident" id="3684083">serverHasALPN</span>&nbsp;<span class="op" id="3684097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684101">c</span><span class="op" id="3684102">.</span><span class="ident" id="3684103">clientProtocol</span>&nbsp;<span class="op" id="3684118">=</span>&nbsp;<span class="ident" id="3684120">hs</span><span class="op" id="3684122">.</span><span class="ident" id="3684123">serverHello</span><span class="op" id="3684134">.</span><span class="ident" id="3684135">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684150">c</span><span class="op" id="3684151">.</span><span class="ident" id="3684152">clientProtocolFallback</span>&nbsp;<span class="op" id="3684175">=</span>&nbsp;<span class="builtintype" id="3684177">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684184">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684188">if</span>&nbsp;<span class="ident" id="3684191">hs</span><span class="op" id="3684193">.</span><span class="ident" id="3684194">serverResumedSession</span><span class="op" id="3684214">(</span><span class="op" id="3684215">)</span>&nbsp;<span class="op" id="3684217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684221">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684281">hs</span><span class="op" id="3684283">.</span><span class="ident" id="3684284">masterSecret</span>&nbsp;<span class="op" id="3684297">=</span>&nbsp;<span class="ident" id="3684299">hs</span><span class="op" id="3684301">.</span><span class="ident" id="3684302">session</span><span class="op" id="3684309">.</span><span class="ident" id="3684310">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684325">c</span><span class="op" id="3684326">.</span><span class="ident" id="3684327">peerCertificates</span>&nbsp;<span class="op" id="3684344">=</span>&nbsp;<span class="ident" id="3684346">hs</span><span class="op" id="3684348">.</span><span class="ident" id="3684349">session</span><span class="op" id="3684356">.</span><span class="ident" id="3684357">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684378">return</span>&nbsp;<span class="builtintype" id="3684385">true</span><span class="op" id="3684389">,</span>&nbsp;<span class="ident" id="3684391">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684399">return</span>&nbsp;<span class="builtintype" id="3684406">false</span><span class="op" id="3684411">,</span>&nbsp;<span class="ident" id="3684413">nil</span><br>
<span class="lineno"></span><span class="op" id="3684417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3684420">func</span>&nbsp;<span class="op" id="3684425">(</span><span class="ident" id="3684426">hs</span>&nbsp;<span class="op" id="3684429">*</span><span class="ident" id="3684430">clientHandshakeState</span><span class="op" id="3684450">)</span>&nbsp;<span class="ident" id="3684452">readFinished</span><span class="op" id="3684464">(</span><span class="ident" id="3684465">out</span>&nbsp;<span class="op" id="3684469">[</span><span class="op" id="3684470">]</span><span class="builtintype" id="3684471">byte</span><span class="op" id="3684475">)</span>&nbsp;<span class="builtintype" id="3684477">error</span>&nbsp;<span class="op" id="3684483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684486">c</span>&nbsp;<span class="op" id="3684488">:=</span>&nbsp;<span class="ident" id="3684491">hs</span><span class="op" id="3684493">.</span><span class="ident" id="3684494">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684498">c</span><span class="op" id="3684499">.</span><span class="ident" id="3684500">readRecord</span><span class="op" id="3684510">(</span><span class="ident" id="3684511">recordTypeChangeCipherSpec</span><span class="op" id="3684537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684540">if</span>&nbsp;<span class="ident" id="3684543">err</span>&nbsp;<span class="op" id="3684547">:=</span>&nbsp;<span class="ident" id="3684550">c</span><span class="op" id="3684551">.</span><span class="ident" id="3684552">in</span><span class="op" id="3684554">.</span><span class="builtintype" id="3684555">error</span><span class="op" id="3684560">(</span><span class="op" id="3684561">)</span><span class="op" id="3684562">;</span>&nbsp;<span class="ident" id="3684564">err</span>&nbsp;<span class="op" id="3684568">!=</span>&nbsp;<span class="ident" id="3684571">nil</span>&nbsp;<span class="op" id="3684575">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684579">return</span>&nbsp;<span class="ident" id="3684586">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684595">msg</span><span class="op" id="3684598">,</span>&nbsp;<span class="ident" id="3684600">err</span>&nbsp;<span class="op" id="3684604">:=</span>&nbsp;<span class="ident" id="3684607">c</span><span class="op" id="3684608">.</span><span class="ident" id="3684609">readHandshake</span><span class="op" id="3684622">(</span><span class="op" id="3684623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684626">if</span>&nbsp;<span class="ident" id="3684629">err</span>&nbsp;<span class="op" id="3684633">!=</span>&nbsp;<span class="ident" id="3684636">nil</span>&nbsp;<span class="op" id="3684640">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684644">return</span>&nbsp;<span class="ident" id="3684651">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684659">serverFinished</span><span class="op" id="3684673">,</span>&nbsp;<span class="ident" id="3684675">ok</span>&nbsp;<span class="op" id="3684678">:=</span>&nbsp;<span class="ident" id="3684681">msg</span><span class="op" id="3684684">.</span><span class="op" id="3684685">(</span><span class="op" id="3684686">*</span><span class="ident" id="3684687">finishedMsg</span><span class="op" id="3684698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684701">if</span>&nbsp;<span class="op" id="3684704">!</span><span class="ident" id="3684705">ok</span>&nbsp;<span class="op" id="3684708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684712">c</span><span class="op" id="3684713">.</span><span class="ident" id="3684714">sendAlert</span><span class="op" id="3684723">(</span><span class="ident" id="3684724">alertUnexpectedMessage</span><span class="op" id="3684746">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684750">return</span>&nbsp;<span class="ident" id="3684757">unexpectedMessageError</span><span class="op" id="3684779">(</span><span class="ident" id="3684780">serverFinished</span><span class="op" id="3684794">,</span>&nbsp;<span class="ident" id="3684796">msg</span><span class="op" id="3684799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3684802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684806">verify</span>&nbsp;<span class="op" id="3684813">:=</span>&nbsp;<span class="ident" id="3684816">hs</span><span class="op" id="3684818">.</span><span class="ident" id="3684819">finishedHash</span><span class="op" id="3684831">.</span><span class="ident" id="3684832">serverSum</span><span class="op" id="3684841">(</span><span class="ident" id="3684842">hs</span><span class="op" id="3684844">.</span><span class="ident" id="3684845">masterSecret</span><span class="op" id="3684857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684860">if</span>&nbsp;<span class="builtinfunc" id="3684863">len</span><span class="op" id="3684866">(</span><span class="ident" id="3684867">verify</span><span class="op" id="3684873">)</span>&nbsp;<span class="op" id="3684875">!=</span>&nbsp;<span class="builtinfunc" id="3684878">len</span><span class="op" id="3684881">(</span><span class="ident" id="3684882">serverFinished</span><span class="op" id="3684896">.</span><span class="ident" id="3684897">verifyData</span><span class="op" id="3684907">)</span>&nbsp;<span class="op" id="3684909">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684914">subtle</span><span class="op" id="3684920">.</span><span class="ident" id="3684921">ConstantTimeCompare</span><span class="op" id="3684940">(</span><span class="ident" id="3684941">verify</span><span class="op" id="3684947">,</span>&nbsp;<span class="ident" id="3684949">serverFinished</span><span class="op" id="3684963">.</span><span class="ident" id="3684964">verifyData</span><span class="op" id="3684974">)</span>&nbsp;<span class="op" id="3684976">!=</span>&nbsp;<span class="num" id="3684979">1</span>&nbsp;<span class="op" id="3684981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684985">c</span><span class="op" id="3684986">.</span><span class="ident" id="3684987">sendAlert</span><span class="op" id="3684996">(</span><span class="ident" id="3684997">alertHandshakeFailure</span><span class="op" id="3685018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685022">return</span>&nbsp;<span class="ident" id="3685029">errors</span><span class="op" id="3685035">.</span><span class="ident" id="3685036">New</span><span class="op" id="3685039">(</span><span class="string" id="3685040">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3685086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685092">hs</span><span class="op" id="3685094">.</span><span class="ident" id="3685095">finishedHash</span><span class="op" id="3685107">.</span><span class="ident" id="3685108">Write</span><span class="op" id="3685113">(</span><span class="ident" id="3685114">serverFinished</span><span class="op" id="3685128">.</span><span class="ident" id="3685129">marshal</span><span class="op" id="3685136">(</span><span class="op" id="3685137">)</span><span class="op" id="3685138">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3685141">copy</span><span class="op" id="3685145">(</span><span class="ident" id="3685146">out</span><span class="op" id="3685149">,</span>&nbsp;<span class="ident" id="3685151">verify</span><span class="op" id="3685157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685160">return</span>&nbsp;<span class="ident" id="3685167">nil</span><br>
<span class="lineno"></span><span class="op" id="3685171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3685174">func</span>&nbsp;<span class="op" id="3685179">(</span><span class="ident" id="3685180">hs</span>&nbsp;<span class="op" id="3685183">*</span><span class="ident" id="3685184">clientHandshakeState</span><span class="op" id="3685204">)</span>&nbsp;<span class="ident" id="3685206">readSessionTicket</span><span class="op" id="3685223">(</span><span class="op" id="3685224">)</span>&nbsp;<span class="builtintype" id="3685226">error</span>&nbsp;<span class="op" id="3685232">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685235">if</span>&nbsp;<span class="op" id="3685238">!</span><span class="ident" id="3685239">hs</span><span class="op" id="3685241">.</span><span class="ident" id="3685242">serverHello</span><span class="op" id="3685253">.</span><span class="ident" id="3685254">ticketSupported</span>&nbsp;<span class="op" id="3685270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685274">return</span>&nbsp;<span class="ident" id="3685281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685290">c</span>&nbsp;<span class="op" id="3685292">:=</span>&nbsp;<span class="ident" id="3685295">hs</span><span class="op" id="3685297">.</span><span class="ident" id="3685298">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685301">msg</span><span class="op" id="3685304">,</span>&nbsp;<span class="ident" id="3685306">err</span>&nbsp;<span class="op" id="3685310">:=</span>&nbsp;<span class="ident" id="3685313">c</span><span class="op" id="3685314">.</span><span class="ident" id="3685315">readHandshake</span><span class="op" id="3685328">(</span><span class="op" id="3685329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685332">if</span>&nbsp;<span class="ident" id="3685335">err</span>&nbsp;<span class="op" id="3685339">!=</span>&nbsp;<span class="ident" id="3685342">nil</span>&nbsp;<span class="op" id="3685346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685350">return</span>&nbsp;<span class="ident" id="3685357">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685365">sessionTicketMsg</span><span class="op" id="3685381">,</span>&nbsp;<span class="ident" id="3685383">ok</span>&nbsp;<span class="op" id="3685386">:=</span>&nbsp;<span class="ident" id="3685389">msg</span><span class="op" id="3685392">.</span><span class="op" id="3685393">(</span><span class="op" id="3685394">*</span><span class="ident" id="3685395">newSessionTicketMsg</span><span class="op" id="3685414">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685417">if</span>&nbsp;<span class="op" id="3685420">!</span><span class="ident" id="3685421">ok</span>&nbsp;<span class="op" id="3685424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685428">c</span><span class="op" id="3685429">.</span><span class="ident" id="3685430">sendAlert</span><span class="op" id="3685439">(</span><span class="ident" id="3685440">alertUnexpectedMessage</span><span class="op" id="3685462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685466">return</span>&nbsp;<span class="ident" id="3685473">unexpectedMessageError</span><span class="op" id="3685495">(</span><span class="ident" id="3685496">sessionTicketMsg</span><span class="op" id="3685512">,</span>&nbsp;<span class="ident" id="3685514">msg</span><span class="op" id="3685517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685523">hs</span><span class="op" id="3685525">.</span><span class="ident" id="3685526">finishedHash</span><span class="op" id="3685538">.</span><span class="ident" id="3685539">Write</span><span class="op" id="3685544">(</span><span class="ident" id="3685545">sessionTicketMsg</span><span class="op" id="3685561">.</span><span class="ident" id="3685562">marshal</span><span class="op" id="3685569">(</span><span class="op" id="3685570">)</span><span class="op" id="3685571">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685575">hs</span><span class="op" id="3685577">.</span><span class="ident" id="3685578">session</span>&nbsp;<span class="op" id="3685586">=</span>&nbsp;<span class="op" id="3685588">&amp;</span><span class="ident" id="3685589">ClientSessionState</span><span class="op" id="3685607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685611">sessionTicket</span><span class="op" id="3685624">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3685631">sessionTicketMsg</span><span class="op" id="3685647">.</span><span class="ident" id="3685648">ticket</span><span class="op" id="3685654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685658">vers</span><span class="op" id="3685662">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3685678">c</span><span class="op" id="3685679">.</span><span class="ident" id="3685680">vers</span><span class="op" id="3685684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685688">cipherSuite</span><span class="op" id="3685699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3685708">hs</span><span class="op" id="3685710">.</span><span class="ident" id="3685711">suite</span><span class="op" id="3685716">.</span><span class="ident" id="3685717">id</span><span class="op" id="3685719">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685723">masterSecret</span><span class="op" id="3685735">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3685743">hs</span><span class="op" id="3685745">.</span><span class="ident" id="3685746">masterSecret</span><span class="op" id="3685758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685762">serverCertificates</span><span class="op" id="3685780">:</span>&nbsp;<span class="ident" id="3685782">c</span><span class="op" id="3685783">.</span><span class="ident" id="3685784">peerCertificates</span><span class="op" id="3685800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685807">return</span>&nbsp;<span class="ident" id="3685814">nil</span><br>
<span class="lineno">590</span><span class="op" id="3685818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3685821">func</span>&nbsp;<span class="op" id="3685826">(</span><span class="ident" id="3685827">hs</span>&nbsp;<span class="op" id="3685830">*</span><span class="ident" id="3685831">clientHandshakeState</span><span class="op" id="3685851">)</span>&nbsp;<span class="ident" id="3685853">sendFinished</span><span class="op" id="3685865">(</span><span class="ident" id="3685866">out</span>&nbsp;<span class="op" id="3685870">[</span><span class="op" id="3685871">]</span><span class="builtintype" id="3685872">byte</span><span class="op" id="3685876">)</span>&nbsp;<span class="builtintype" id="3685878">error</span>&nbsp;<span class="op" id="3685884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685887">c</span>&nbsp;<span class="op" id="3685889">:=</span>&nbsp;<span class="ident" id="3685892">hs</span><span class="op" id="3685894">.</span><span class="ident" id="3685895">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685899">c</span><span class="op" id="3685900">.</span><span class="ident" id="3685901">writeRecord</span><span class="op" id="3685912">(</span><span class="ident" id="3685913">recordTypeChangeCipherSpec</span><span class="op" id="3685939">,</span>&nbsp;<span class="op" id="3685941">[</span><span class="op" id="3685942">]</span><span class="builtintype" id="3685943">byte</span><span class="op" id="3685947">{</span><span class="num" id="3685948">1</span><span class="op" id="3685949">}</span><span class="op" id="3685950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685953">if</span>&nbsp;<span class="ident" id="3685956">hs</span><span class="op" id="3685958">.</span><span class="ident" id="3685959">serverHello</span><span class="op" id="3685970">.</span><span class="ident" id="3685971">nextProtoNeg</span>&nbsp;<span class="op" id="3685984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685988">nextProto</span>&nbsp;<span class="op" id="3685998">:=</span>&nbsp;<span class="builtinfunc" id="3686001">new</span><span class="op" id="3686004">(</span><span class="ident" id="3686005">nextProtoMsg</span><span class="op" id="3686017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686021">proto</span><span class="op" id="3686026">,</span>&nbsp;<span class="ident" id="3686028">fallback</span>&nbsp;<span class="op" id="3686037">:=</span>&nbsp;<span class="ident" id="3686040">mutualProtocol</span><span class="op" id="3686054">(</span><span class="ident" id="3686055">c</span><span class="op" id="3686056">.</span><span class="ident" id="3686057">config</span><span class="op" id="3686063">.</span><span class="ident" id="3686064">NextProtos</span><span class="op" id="3686074">,</span>&nbsp;<span class="ident" id="3686076">hs</span><span class="op" id="3686078">.</span><span class="ident" id="3686079">serverHello</span><span class="op" id="3686090">.</span><span class="ident" id="3686091">nextProtos</span><span class="op" id="3686101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686105">nextProto</span><span class="op" id="3686114">.</span><span class="ident" id="3686115">proto</span>&nbsp;<span class="op" id="3686121">=</span>&nbsp;<span class="ident" id="3686123">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686131">c</span><span class="op" id="3686132">.</span><span class="ident" id="3686133">clientProtocol</span>&nbsp;<span class="op" id="3686148">=</span>&nbsp;<span class="ident" id="3686150">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686158">c</span><span class="op" id="3686159">.</span><span class="ident" id="3686160">clientProtocolFallback</span>&nbsp;<span class="op" id="3686183">=</span>&nbsp;<span class="ident" id="3686185">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686197">hs</span><span class="op" id="3686199">.</span><span class="ident" id="3686200">finishedHash</span><span class="op" id="3686212">.</span><span class="ident" id="3686213">Write</span><span class="op" id="3686218">(</span><span class="ident" id="3686219">nextProto</span><span class="op" id="3686228">.</span><span class="ident" id="3686229">marshal</span><span class="op" id="3686236">(</span><span class="op" id="3686237">)</span><span class="op" id="3686238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686242">c</span><span class="op" id="3686243">.</span><span class="ident" id="3686244">writeRecord</span><span class="op" id="3686255">(</span><span class="ident" id="3686256">recordTypeHandshake</span><span class="op" id="3686275">,</span>&nbsp;<span class="ident" id="3686277">nextProto</span><span class="op" id="3686286">.</span><span class="ident" id="3686287">marshal</span><span class="op" id="3686294">(</span><span class="op" id="3686295">)</span><span class="op" id="3686296">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686303">finished</span>&nbsp;<span class="op" id="3686312">:=</span>&nbsp;<span class="builtinfunc" id="3686315">new</span><span class="op" id="3686318">(</span><span class="ident" id="3686319">finishedMsg</span><span class="op" id="3686330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686333">finished</span><span class="op" id="3686341">.</span><span class="ident" id="3686342">verifyData</span>&nbsp;<span class="op" id="3686353">=</span>&nbsp;<span class="ident" id="3686355">hs</span><span class="op" id="3686357">.</span><span class="ident" id="3686358">finishedHash</span><span class="op" id="3686370">.</span><span class="ident" id="3686371">clientSum</span><span class="op" id="3686380">(</span><span class="ident" id="3686381">hs</span><span class="op" id="3686383">.</span><span class="ident" id="3686384">masterSecret</span><span class="op" id="3686396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686399">hs</span><span class="op" id="3686401">.</span><span class="ident" id="3686402">finishedHash</span><span class="op" id="3686414">.</span><span class="ident" id="3686415">Write</span><span class="op" id="3686420">(</span><span class="ident" id="3686421">finished</span><span class="op" id="3686429">.</span><span class="ident" id="3686430">marshal</span><span class="op" id="3686437">(</span><span class="op" id="3686438">)</span><span class="op" id="3686439">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686442">c</span><span class="op" id="3686443">.</span><span class="ident" id="3686444">writeRecord</span><span class="op" id="3686455">(</span><span class="ident" id="3686456">recordTypeHandshake</span><span class="op" id="3686475">,</span>&nbsp;<span class="ident" id="3686477">finished</span><span class="op" id="3686485">.</span><span class="ident" id="3686486">marshal</span><span class="op" id="3686493">(</span><span class="op" id="3686494">)</span><span class="op" id="3686495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3686498">copy</span><span class="op" id="3686502">(</span><span class="ident" id="3686503">out</span><span class="op" id="3686506">,</span>&nbsp;<span class="ident" id="3686508">finished</span><span class="op" id="3686516">.</span><span class="ident" id="3686517">verifyData</span><span class="op" id="3686527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686530">return</span>&nbsp;<span class="ident" id="3686537">nil</span><br>
<span class="lineno"></span><span class="op" id="3686541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3686544">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3686623">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3686694">func</span>&nbsp;<span class="ident" id="3686699">clientSessionCacheKey</span><span class="op" id="3686720">(</span><span class="ident" id="3686721">serverAddr</span>&nbsp;<span class="ident" id="3686732">net</span><span class="op" id="3686735">.</span><span class="ident" id="3686736">Addr</span><span class="op" id="3686740">,</span>&nbsp;<span class="ident" id="3686742">config</span>&nbsp;<span class="op" id="3686749">*</span><span class="ident" id="3686750">Config</span><span class="op" id="3686756">)</span>&nbsp;<span class="builtintype" id="3686758">string</span>&nbsp;<span class="op" id="3686765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686768">if</span>&nbsp;<span class="builtinfunc" id="3686771">len</span><span class="op" id="3686774">(</span><span class="ident" id="3686775">config</span><span class="op" id="3686781">.</span><span class="ident" id="3686782">ServerName</span><span class="op" id="3686792">)</span>&nbsp;<span class="op" id="3686794">&gt;</span>&nbsp;<span class="num" id="3686796">0</span>&nbsp;<span class="op" id="3686798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686802">return</span>&nbsp;<span class="ident" id="3686809">config</span><span class="op" id="3686815">.</span><span class="ident" id="3686816">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686831">return</span>&nbsp;<span class="ident" id="3686838">serverAddr</span><span class="op" id="3686848">.</span><span class="ident" id="3686849">String</span><span class="op" id="3686855">(</span><span class="op" id="3686856">)</span><br>
<span class="lineno"></span><span class="op" id="3686858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3686861">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3686939">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3687015">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3687091">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3687139">func</span>&nbsp;<span class="ident" id="3687144">mutualProtocol</span><span class="op" id="3687158">(</span><span class="ident" id="3687159">protos</span><span class="op" id="3687165">,</span>&nbsp;<span class="ident" id="3687167">preferenceProtos</span>&nbsp;<span class="op" id="3687184">[</span><span class="op" id="3687185">]</span><span class="builtintype" id="3687186">string</span><span class="op" id="3687192">)</span>&nbsp;<span class="op" id="3687194">(</span><span class="builtintype" id="3687195">string</span><span class="op" id="3687201">,</span>&nbsp;<span class="builtintype" id="3687203">bool</span><span class="op" id="3687207">)</span>&nbsp;<span class="op" id="3687209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687212">for</span>&nbsp;<span class="ident" id="3687216">_</span><span class="op" id="3687217">,</span>&nbsp;<span class="ident" id="3687219">s</span>&nbsp;<span class="op" id="3687221">:=</span>&nbsp;<span class="keyword" id="3687224">range</span>&nbsp;<span class="ident" id="3687230">preferenceProtos</span>&nbsp;<span class="op" id="3687247">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687251">for</span>&nbsp;<span class="ident" id="3687255">_</span><span class="op" id="3687256">,</span>&nbsp;<span class="ident" id="3687258">c</span>&nbsp;<span class="op" id="3687260">:=</span>&nbsp;<span class="keyword" id="3687263">range</span>&nbsp;<span class="ident" id="3687269">protos</span>&nbsp;<span class="op" id="3687276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687281">if</span>&nbsp;<span class="ident" id="3687284">s</span>&nbsp;<span class="op" id="3687286">==</span>&nbsp;<span class="ident" id="3687289">c</span>&nbsp;<span class="op" id="3687291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687297">return</span>&nbsp;<span class="ident" id="3687304">s</span><span class="op" id="3687305">,</span>&nbsp;<span class="builtintype" id="3687307">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687320">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687327">return</span>&nbsp;<span class="ident" id="3687334">protos</span><span class="op" id="3687340">[</span><span class="num" id="3687341">0</span><span class="op" id="3687342">]</span><span class="op" id="3687343">,</span>&nbsp;<span class="builtintype" id="3687345">true</span><br>
<span class="lineno"></span><span class="op" id="3687350">}</span>
</div>
</body>
</html>
