<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="6073306">package</span>&nbsp;<span class="ident" id="6073314">link8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6073321">import</span>&nbsp;<span class="op" id="6073328">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6073331">&#34;math&#34;</span><br>
<span class="lineno">5</span><span class="op" id="6073338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6073341">//&nbsp;link&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;linking&nbsp;information&nbsp;for&nbsp;an&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="6073402">//&nbsp;in&nbsp;a&nbsp;code&nbsp;section&nbsp;at&nbsp;a&nbsp;particular&nbsp;offset.</span><br>
<span class="lineno"></span><span class="comment" id="6073447">//&nbsp;it&nbsp;uses&nbsp;the&nbsp;indices&nbsp;in&nbsp;the&nbsp;package&nbsp;for&nbsp;symbol&nbsp;lookup</span><br>
<span class="lineno">10</span><span class="keyword" id="6073503">type</span>&nbsp;<span class="ident" id="6073508">link</span>&nbsp;<span class="keyword" id="6073513">struct</span>&nbsp;<span class="op" id="6073520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073523">offset</span>&nbsp;<span class="builtintype" id="6073530">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073538">pkg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6073545">uint32</span>&nbsp;<span class="comment" id="6073552">//&nbsp;relative&nbsp;package&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073579">sym</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6073586">uint32</span><br>
<span class="lineno"></span><span class="op" id="6073593">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6073596">//&nbsp;Func&nbsp;is&nbsp;a&nbsp;relocatable&nbsp;code&nbsp;section</span><br>
<span class="lineno"></span><span class="keyword" id="6073634">type</span>&nbsp;<span class="ident" id="6073639">Func</span>&nbsp;<span class="keyword" id="6073644">struct</span>&nbsp;<span class="op" id="6073651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073654">insts</span>&nbsp;<span class="op" id="6073660">[</span><span class="op" id="6073661">]</span><span class="builtintype" id="6073662">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073670">links</span>&nbsp;<span class="op" id="6073676">[</span><span class="op" id="6073677">]</span><span class="op" id="6073678">*</span><span class="ident" id="6073679"><a href="/lonnie.io/e8vm/link8/func.go.html#6073508">link</a></span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073686">addr</span>&nbsp;<span class="builtintype" id="6073691">uint32</span><br>
<span class="lineno"></span><span class="op" id="6073698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6073701">//&nbsp;NewFunc&nbsp;creates&nbsp;a&nbsp;new&nbsp;relocatable&nbsp;code&nbsp;section.</span><br>
<span class="lineno">25</span><span class="keyword" id="6073752">func</span>&nbsp;<span class="ident" id="6073757">NewFunc</span><span class="op" id="6073764">(</span><span class="op" id="6073765">)</span>&nbsp;<span class="op" id="6073767">*</span><span class="ident" id="6073768"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span>&nbsp;<span class="op" id="6073773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6073776">return</span>&nbsp;<span class="builtinfunc" id="6073783">new</span><span class="op" id="6073786">(</span><span class="ident" id="6073787"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span><span class="op" id="6073791">)</span><br>
<span class="lineno"></span><span class="op" id="6073793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6073796">//&nbsp;AddInst&nbsp;appends&nbsp;an&nbsp;instruction&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">30</span><span class="keyword" id="6073858">func</span>&nbsp;<span class="op" id="6073863">(</span><span class="ident" id="6073864">f</span>&nbsp;<span class="op" id="6073866">*</span><span class="ident" id="6073867"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span><span class="op" id="6073871">)</span>&nbsp;<span class="ident" id="6073873">AddInst</span><span class="op" id="6073880">(</span><span class="ident" id="6073881">i</span>&nbsp;<span class="builtintype" id="6073883">uint32</span><span class="op" id="6073889">)</span>&nbsp;<span class="op" id="6073891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6073894"><a href="/lonnie.io/e8vm/link8/func.go.html#6073864">f</a></span><span class="op" id="6073895">.</span><span class="ident" id="6073896">insts</span>&nbsp;<span class="op" id="6073902">=</span>&nbsp;<span class="builtinfunc" id="6073904">append</span><span class="op" id="6073910">(</span><span class="ident" id="6073911"><a href="/lonnie.io/e8vm/link8/func.go.html#6073864">f</a></span><span class="op" id="6073912">.</span><span class="ident" id="6073913">insts</span><span class="op" id="6073918">,</span>&nbsp;<span class="ident" id="6073920"><a href="/lonnie.io/e8vm/link8/func.go.html#6073881">i</a></span><span class="op" id="6073921">)</span><br>
<span class="lineno"></span><span class="op" id="6073923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6073926">//&nbsp;TooLarge&nbsp;checks&nbsp;if&nbsp;the&nbsp;function&nbsp;size&nbsp;is&nbsp;larger&nbsp;than&nbsp;4GB.</span><br>
<span class="lineno">35</span><span class="keyword" id="6073986">func</span>&nbsp;<span class="op" id="6073991">(</span><span class="ident" id="6073992">f</span>&nbsp;<span class="op" id="6073994">*</span><span class="ident" id="6073995"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span><span class="op" id="6073999">)</span>&nbsp;<span class="ident" id="6074001">TooLarge</span><span class="op" id="6074009">(</span><span class="op" id="6074010">)</span>&nbsp;<span class="builtintype" id="6074012">bool</span>&nbsp;<span class="op" id="6074017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6074020">return</span>&nbsp;<span class="builtinfunc" id="6074027">len</span><span class="op" id="6074030">(</span><span class="ident" id="6074031"><a href="/lonnie.io/e8vm/link8/func.go.html#6073992">f</a></span><span class="op" id="6074032">.</span><span class="ident" id="6074033">insts</span><span class="op" id="6074038">)</span><span class="op" id="6074039">*</span><span class="num" id="6074040">4</span>&nbsp;<span class="op" id="6074042">&gt;=</span>&nbsp;<span class="ident" id="6074045"><a href="/lonnie.io/e8vm/link8/func.go.html#6073331">math</a></span><span class="op" id="6074049">.</span><span class="ident" id="6074050">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="6074059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6074062">//&nbsp;Size&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">40</span><span class="keyword" id="6074104">func</span>&nbsp;<span class="op" id="6074109">(</span><span class="ident" id="6074110">f</span>&nbsp;<span class="op" id="6074112">*</span><span class="ident" id="6074113"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span><span class="op" id="6074117">)</span>&nbsp;<span class="ident" id="6074119">Size</span><span class="op" id="6074123">(</span><span class="op" id="6074124">)</span>&nbsp;<span class="builtintype" id="6074126">uint32</span>&nbsp;<span class="op" id="6074133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6074136">return</span>&nbsp;<span class="builtintype" id="6074143">uint32</span><span class="op" id="6074149">(</span><span class="builtinfunc" id="6074150">len</span><span class="op" id="6074153">(</span><span class="ident" id="6074154"><a href="/lonnie.io/e8vm/link8/func.go.html#6074110">f</a></span><span class="op" id="6074155">.</span><span class="ident" id="6074156">insts</span><span class="op" id="6074161">)</span>&nbsp;<span class="op" id="6074163">*</span>&nbsp;<span class="num" id="6074165">4</span><span class="op" id="6074166">)</span><br>
<span class="lineno"></span><span class="op" id="6074168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6074171">//&nbsp;AddLink&nbsp;links&nbsp;the&nbsp;last&nbsp;instruction&nbsp;in&nbsp;inst&nbsp;to</span><br>
<span class="lineno">45</span><span class="comment" id="6074220">//&nbsp;the&nbsp;symbol&nbsp;pkg.sym,&nbsp;where&nbsp;pkg&nbsp;and&nbsp;sym&nbsp;are&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6074275">//&nbsp;indexing&nbsp;of&nbsp;the&nbsp;object&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="6074307">//&nbsp;fill&nbsp;field&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;4&nbsp;so&nbsp;that&nbsp;it&nbsp;fits&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6074364">//&nbsp;lowest&nbsp;2&nbsp;bits&nbsp;in&nbsp;the&nbsp;offset&nbsp;field.&nbsp;The&nbsp;other&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="6074417">//&nbsp;of&nbsp;the&nbsp;offset&nbsp;fields&nbsp;will&nbsp;be&nbsp;automatically&nbsp;calculated</span><br>
<span class="lineno">50</span><span class="comment" id="6074474">//&nbsp;based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;instructions&nbsp;in&nbsp;insts.</span><br>
<span class="lineno"></span><span class="keyword" id="6074523">func</span>&nbsp;<span class="op" id="6074528">(</span><span class="ident" id="6074529">f</span>&nbsp;<span class="op" id="6074531">*</span><span class="ident" id="6074532"><a href="/lonnie.io/e8vm/link8/func.go.html#6073639">Func</a></span><span class="op" id="6074536">)</span>&nbsp;<span class="ident" id="6074538">AddLink</span><span class="op" id="6074545">(</span><span class="ident" id="6074546">fill</span>&nbsp;<span class="builtintype" id="6074551">int</span><span class="op" id="6074554">,</span>&nbsp;<span class="ident" id="6074556">pkg</span><span class="op" id="6074559">,</span>&nbsp;<span class="ident" id="6074561">sym</span>&nbsp;<span class="builtintype" id="6074565">uint32</span><span class="op" id="6074571">)</span>&nbsp;<span class="op" id="6074573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6074576">if</span>&nbsp;<span class="builtinfunc" id="6074579">len</span><span class="op" id="6074582">(</span><span class="ident" id="6074583"><a href="/lonnie.io/e8vm/link8/func.go.html#6074529">f</a></span><span class="op" id="6074584">.</span><span class="ident" id="6074585">insts</span><span class="op" id="6074590">)</span>&nbsp;<span class="op" id="6074592">==</span>&nbsp;<span class="num" id="6074595">0</span>&nbsp;<span class="op" id="6074597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6074601">panic</span><span class="op" id="6074606">(</span><span class="string" id="6074607">&#34;no&nbsp;inst&nbsp;to&nbsp;link&#34;</span><span class="op" id="6074624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6074627">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6074630">if</span>&nbsp;<span class="op" id="6074633">!</span><span class="op" id="6074634">(</span><span class="ident" id="6074635"><a href="/lonnie.io/e8vm/link8/func.go.html#6074546">fill</a></span>&nbsp;<span class="op" id="6074640">&gt;</span>&nbsp;<span class="num" id="6074642">0</span>&nbsp;<span class="op" id="6074644">&amp;&amp;</span>&nbsp;<span class="ident" id="6074647"><a href="/lonnie.io/e8vm/link8/func.go.html#6074546">fill</a></span>&nbsp;<span class="op" id="6074652">&lt;=</span>&nbsp;<span class="num" id="6074655">3</span><span class="op" id="6074656">)</span>&nbsp;<span class="op" id="6074658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6074662">panic</span><span class="op" id="6074667">(</span><span class="string" id="6074668">&#34;invalid&nbsp;fill&#34;</span><span class="op" id="6074682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6074685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074689">offset</span>&nbsp;<span class="op" id="6074696">:=</span>&nbsp;<span class="builtintype" id="6074699">uint32</span><span class="op" id="6074705">(</span><span class="builtinfunc" id="6074706">len</span><span class="op" id="6074709">(</span><span class="ident" id="6074710"><a href="/lonnie.io/e8vm/link8/func.go.html#6074529">f</a></span><span class="op" id="6074711">.</span><span class="ident" id="6074712">insts</span><span class="op" id="6074717">)</span><span class="op" id="6074718">)</span><span class="op" id="6074719">*</span><span class="num" id="6074720">4</span>&nbsp;<span class="op" id="6074722">-</span>&nbsp;<span class="num" id="6074724">4</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074727"><a href="/lonnie.io/e8vm/link8/func.go.html#6074689">offset</a></span>&nbsp;<span class="op" id="6074734">|=</span>&nbsp;<span class="builtintype" id="6074737">uint32</span><span class="op" id="6074743">(</span><span class="ident" id="6074744"><a href="/lonnie.io/e8vm/link8/func.go.html#6074546">fill</a></span><span class="op" id="6074748">)</span>&nbsp;<span class="op" id="6074750">&amp;</span>&nbsp;<span class="num" id="6074752">0x3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074757">link</span>&nbsp;<span class="op" id="6074762">:=</span>&nbsp;<span class="op" id="6074765">&amp;</span><span class="ident" id="6074766"><a href="/lonnie.io/e8vm/link8/func.go.html#6073508">link</a></span><span class="op" id="6074770">{</span><span class="ident" id="6074771">offset</span><span class="op" id="6074777">:</span>&nbsp;<span class="ident" id="6074779"><a href="/lonnie.io/e8vm/link8/func.go.html#6074689">offset</a></span><span class="op" id="6074785">,</span>&nbsp;<span class="ident" id="6074787">pkg</span><span class="op" id="6074790">:</span>&nbsp;<span class="ident" id="6074792"><a href="/lonnie.io/e8vm/link8/func.go.html#6074556">pkg</a></span><span class="op" id="6074795">,</span>&nbsp;<span class="ident" id="6074797">sym</span><span class="op" id="6074800">:</span>&nbsp;<span class="ident" id="6074802"><a href="/lonnie.io/e8vm/link8/func.go.html#6074561">sym</a></span><span class="op" id="6074805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074808"><a href="/lonnie.io/e8vm/link8/func.go.html#6074529">f</a></span><span class="op" id="6074809">.</span><span class="ident" id="6074810">links</span>&nbsp;<span class="op" id="6074816">=</span>&nbsp;<span class="builtinfunc" id="6074818">append</span><span class="op" id="6074824">(</span><span class="ident" id="6074825"><a href="/lonnie.io/e8vm/link8/func.go.html#6074529">f</a></span><span class="op" id="6074826">.</span><span class="ident" id="6074827">links</span><span class="op" id="6074832">,</span>&nbsp;<span class="ident" id="6074834"><a href="/lonnie.io/e8vm/link8/func.go.html#6074757">link</a></span><span class="op" id="6074838">)</span><br>
<span class="lineno"></span><span class="op" id="6074840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="6074843">//&nbsp;Constant&nbsp;fill-later&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="6074875">const</span>&nbsp;<span class="op" id="6074881">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074884">FillNone</span>&nbsp;<span class="op" id="6074893">=</span>&nbsp;<span class="ident" id="6074895">iota</span>&nbsp;<span class="comment" id="6074900">//&nbsp;no&nbsp;fill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074912">FillLink</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6074928">//&nbsp;fill&nbsp;as&nbsp;linking&nbsp;offset&nbsp;for&nbsp;jump&nbsp;instructions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6074977">FillLow</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6074993">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6075025">FillHigh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6075041">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;higher&nbsp;16&nbsp;bits</span><br>
<span class="lineno"></span><span class="op" id="6075073">)</span>
</div>
</body>
</html>
