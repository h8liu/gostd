<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1871531">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1871586">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1871640">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1871691">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1871734">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1871780">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1871832">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1871872">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1871923">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1871961">//</span><br>
<span class="lineno"></span><span class="comment" id="1871964">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1872012">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1872068">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1872125">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1872188">//</span><br>
<span class="lineno"></span><span class="comment" id="1872191">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1872243">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1872278">package</span>&nbsp;<span class="ident" id="1872286">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1872295">import</span>&nbsp;<span class="string" id="1872302">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1872312">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1872355">type</span>&nbsp;<span class="ident" id="1872360">semaRoot</span>&nbsp;<span class="keyword" id="1872369">struct</span>&nbsp;<span class="op" id="1872376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872379">lock</span>&nbsp;&nbsp;<span class="ident" id="1872385">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872392">head</span>&nbsp;&nbsp;<span class="op" id="1872398">*</span><span class="ident" id="1872399">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872406">tail</span>&nbsp;&nbsp;<span class="op" id="1872412">*</span><span class="ident" id="1872413">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872420">nwait</span>&nbsp;<span class="builtintype" id="1872426">uint32</span>&nbsp;<span class="comment" id="1872433">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1872474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1872477">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1872527">const</span>&nbsp;<span class="ident" id="1872533">semTabSize</span>&nbsp;<span class="op" id="1872544">=</span>&nbsp;<span class="num" id="1872546">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1872551">var</span>&nbsp;<span class="ident" id="1872555">semtable</span>&nbsp;<span class="op" id="1872564">[</span><span class="ident" id="1872565">semTabSize</span><span class="op" id="1872575">]</span><span class="keyword" id="1872576">struct</span>&nbsp;<span class="op" id="1872583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872586">root</span>&nbsp;<span class="ident" id="1872591">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872601">pad</span>&nbsp;&nbsp;<span class="op" id="1872606">[</span><span class="ident" id="1872607">_CacheLineSize</span>&nbsp;<span class="op" id="1872622">-</span>&nbsp;<span class="ident" id="1872624">unsafe</span><span class="op" id="1872630">.</span><span class="ident" id="1872631">Sizeof</span><span class="op" id="1872637">(</span><span class="ident" id="1872638">semaRoot</span><span class="op" id="1872646">{</span><span class="op" id="1872647">}</span><span class="op" id="1872648">)</span><span class="op" id="1872649">]</span><span class="builtintype" id="1872650">byte</span><br>
<span class="lineno"></span><span class="op" id="1872655">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1872658">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1872692">func</span>&nbsp;<span class="ident" id="1872697">asyncsemacquire</span><span class="op" id="1872712">(</span><span class="ident" id="1872713">addr</span>&nbsp;<span class="op" id="1872718">*</span><span class="builtintype" id="1872719">uint32</span><span class="op" id="1872725">)</span>&nbsp;<span class="op" id="1872727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872730">semacquire</span><span class="op" id="1872740">(</span><span class="ident" id="1872741">addr</span><span class="op" id="1872745">,</span>&nbsp;<span class="builtintype" id="1872747">true</span><span class="op" id="1872751">)</span><br>
<span class="lineno"></span><span class="op" id="1872753">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1872756">func</span>&nbsp;<span class="ident" id="1872761">asyncsemrelease</span><span class="op" id="1872776">(</span><span class="ident" id="1872777">addr</span>&nbsp;<span class="op" id="1872782">*</span><span class="builtintype" id="1872783">uint32</span><span class="op" id="1872789">)</span>&nbsp;<span class="op" id="1872791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872794">semrelease</span><span class="op" id="1872804">(</span><span class="ident" id="1872805">addr</span><span class="op" id="1872809">)</span><br>
<span class="lineno"></span><span class="op" id="1872811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1872814">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1872838">func</span>&nbsp;<span class="ident" id="1872843">semacquire</span><span class="op" id="1872853">(</span><span class="ident" id="1872854">addr</span>&nbsp;<span class="op" id="1872859">*</span><span class="builtintype" id="1872860">uint32</span><span class="op" id="1872866">,</span>&nbsp;<span class="ident" id="1872868">profile</span>&nbsp;<span class="builtintype" id="1872876">bool</span><span class="op" id="1872880">)</span>&nbsp;<span class="op" id="1872882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872885">gp</span>&nbsp;<span class="op" id="1872888">:=</span>&nbsp;<span class="ident" id="1872891">getg</span><span class="op" id="1872895">(</span><span class="op" id="1872896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1872899">if</span>&nbsp;<span class="ident" id="1872902">gp</span>&nbsp;<span class="op" id="1872905">!=</span>&nbsp;<span class="ident" id="1872908">gp</span><span class="op" id="1872910">.</span><span class="ident" id="1872911">m</span><span class="op" id="1872912">.</span><span class="ident" id="1872913">curg</span>&nbsp;<span class="op" id="1872918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872922">gothrow</span><span class="op" id="1872929">(</span><span class="string" id="1872930">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1872961">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1872964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1872968">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1872983">if</span>&nbsp;<span class="ident" id="1872986">cansemacquire</span><span class="op" id="1872999">(</span><span class="ident" id="1873000">addr</span><span class="op" id="1873004">)</span>&nbsp;<span class="op" id="1873006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873010">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873022">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873039">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873066">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873123">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873154">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873164">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873212">s</span>&nbsp;<span class="op" id="1873214">:=</span>&nbsp;<span class="ident" id="1873217">acquireSudog</span><span class="op" id="1873229">(</span><span class="op" id="1873230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873233">root</span>&nbsp;<span class="op" id="1873238">:=</span>&nbsp;<span class="ident" id="1873241">semroot</span><span class="op" id="1873248">(</span><span class="ident" id="1873249">addr</span><span class="op" id="1873253">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873256">t0</span>&nbsp;<span class="op" id="1873259">:=</span>&nbsp;<span class="ident" id="1873262">int64</span><span class="op" id="1873267">(</span><span class="num" id="1873268">0</span><span class="op" id="1873269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873272">s</span><span class="op" id="1873273">.</span><span class="ident" id="1873274">releasetime</span>&nbsp;<span class="op" id="1873286">=</span>&nbsp;<span class="num" id="1873288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873291">if</span>&nbsp;<span class="ident" id="1873294">profile</span>&nbsp;<span class="op" id="1873302">&amp;&amp;</span>&nbsp;<span class="ident" id="1873305">blockprofilerate</span>&nbsp;<span class="op" id="1873322">&gt;</span>&nbsp;<span class="num" id="1873324">0</span>&nbsp;<span class="op" id="1873326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873330">t0</span>&nbsp;<span class="op" id="1873333">=</span>&nbsp;<span class="ident" id="1873335">cputicks</span><span class="op" id="1873343">(</span><span class="op" id="1873344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873348">s</span><span class="op" id="1873349">.</span><span class="ident" id="1873350">releasetime</span>&nbsp;<span class="op" id="1873362">=</span>&nbsp;<span class="op" id="1873364">-</span><span class="num" id="1873365">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873371">for</span>&nbsp;<span class="op" id="1873375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873379">lock</span><span class="op" id="1873383">(</span><span class="op" id="1873384">&amp;</span><span class="ident" id="1873385">root</span><span class="op" id="1873389">.</span><span class="ident" id="1873390">lock</span><span class="op" id="1873394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873398">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873464">xadd</span><span class="op" id="1873468">(</span><span class="op" id="1873469">&amp;</span><span class="ident" id="1873470">root</span><span class="op" id="1873474">.</span><span class="ident" id="1873475">nwait</span><span class="op" id="1873480">,</span>&nbsp;<span class="num" id="1873482">1</span><span class="op" id="1873483">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873487">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873536">if</span>&nbsp;<span class="ident" id="1873539">cansemacquire</span><span class="op" id="1873552">(</span><span class="ident" id="1873553">addr</span><span class="op" id="1873557">)</span>&nbsp;<span class="op" id="1873559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873564">xadd</span><span class="op" id="1873568">(</span><span class="op" id="1873569">&amp;</span><span class="ident" id="1873570">root</span><span class="op" id="1873574">.</span><span class="ident" id="1873575">nwait</span><span class="op" id="1873580">,</span>&nbsp;<span class="op" id="1873582">-</span><span class="num" id="1873583">1</span><span class="op" id="1873584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873589">unlock</span><span class="op" id="1873595">(</span><span class="op" id="1873596">&amp;</span><span class="ident" id="1873597">root</span><span class="op" id="1873601">.</span><span class="ident" id="1873602">lock</span><span class="op" id="1873606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873611">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873623">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873687">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873730">root</span><span class="op" id="1873734">.</span><span class="ident" id="1873735">queue</span><span class="op" id="1873740">(</span><span class="ident" id="1873741">addr</span><span class="op" id="1873745">,</span>&nbsp;<span class="ident" id="1873747">s</span><span class="op" id="1873748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873752">goparkunlock</span><span class="op" id="1873764">(</span><span class="op" id="1873765">&amp;</span><span class="ident" id="1873766">root</span><span class="op" id="1873770">.</span><span class="ident" id="1873771">lock</span><span class="op" id="1873775">,</span>&nbsp;<span class="string" id="1873777">&#34;semacquire&#34;</span><span class="op" id="1873789">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873793">if</span>&nbsp;<span class="ident" id="1873796">cansemacquire</span><span class="op" id="1873809">(</span><span class="ident" id="1873810">addr</span><span class="op" id="1873814">)</span>&nbsp;<span class="op" id="1873816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873821">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873835">if</span>&nbsp;<span class="ident" id="1873838">s</span><span class="op" id="1873839">.</span><span class="ident" id="1873840">releasetime</span>&nbsp;<span class="op" id="1873852">&gt;</span>&nbsp;<span class="num" id="1873854">0</span>&nbsp;<span class="op" id="1873856">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873860">blockevent</span><span class="op" id="1873870">(</span><span class="ident" id="1873871">int64</span><span class="op" id="1873876">(</span><span class="ident" id="1873877">s</span><span class="op" id="1873878">.</span><span class="ident" id="1873879">releasetime</span><span class="op" id="1873890">)</span><span class="op" id="1873891">-</span><span class="ident" id="1873892">t0</span><span class="op" id="1873894">,</span>&nbsp;<span class="num" id="1873896">3</span><span class="op" id="1873897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873903">releaseSudog</span><span class="op" id="1873915">(</span><span class="ident" id="1873916">s</span><span class="op" id="1873917">)</span><br>
<span class="lineno"></span><span class="op" id="1873919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1873922">func</span>&nbsp;<span class="ident" id="1873927">semrelease</span><span class="op" id="1873937">(</span><span class="ident" id="1873938">addr</span>&nbsp;<span class="op" id="1873943">*</span><span class="builtintype" id="1873944">uint32</span><span class="op" id="1873950">)</span>&nbsp;<span class="op" id="1873952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873955">root</span>&nbsp;<span class="op" id="1873960">:=</span>&nbsp;<span class="ident" id="1873963">semroot</span><span class="op" id="1873970">(</span><span class="ident" id="1873971">addr</span><span class="op" id="1873975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873978">xadd</span><span class="op" id="1873982">(</span><span class="ident" id="1873983">addr</span><span class="op" id="1873987">,</span>&nbsp;<span class="num" id="1873989">1</span><span class="op" id="1873990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873994">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874021">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874089">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874119">if</span>&nbsp;<span class="ident" id="1874122">atomicload</span><span class="op" id="1874132">(</span><span class="op" id="1874133">&amp;</span><span class="ident" id="1874134">root</span><span class="op" id="1874138">.</span><span class="ident" id="1874139">nwait</span><span class="op" id="1874144">)</span>&nbsp;<span class="op" id="1874146">==</span>&nbsp;<span class="num" id="1874149">0</span>&nbsp;<span class="op" id="1874151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874163">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874167">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874217">lock</span><span class="op" id="1874221">(</span><span class="op" id="1874222">&amp;</span><span class="ident" id="1874223">root</span><span class="op" id="1874227">.</span><span class="ident" id="1874228">lock</span><span class="op" id="1874232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874235">if</span>&nbsp;<span class="ident" id="1874238">atomicload</span><span class="op" id="1874248">(</span><span class="op" id="1874249">&amp;</span><span class="ident" id="1874250">root</span><span class="op" id="1874254">.</span><span class="ident" id="1874255">nwait</span><span class="op" id="1874260">)</span>&nbsp;<span class="op" id="1874262">==</span>&nbsp;<span class="num" id="1874265">0</span>&nbsp;<span class="op" id="1874267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874271">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874328">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874374">unlock</span><span class="op" id="1874380">(</span><span class="op" id="1874381">&amp;</span><span class="ident" id="1874382">root</span><span class="op" id="1874386">.</span><span class="ident" id="1874387">lock</span><span class="op" id="1874391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874406">s</span>&nbsp;<span class="op" id="1874408">:=</span>&nbsp;<span class="ident" id="1874411">root</span><span class="op" id="1874415">.</span><span class="ident" id="1874416">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874422">for</span>&nbsp;<span class="op" id="1874426">;</span>&nbsp;<span class="ident" id="1874428">s</span>&nbsp;<span class="op" id="1874430">!=</span>&nbsp;<span class="ident" id="1874433">nil</span><span class="op" id="1874436">;</span>&nbsp;<span class="ident" id="1874438">s</span>&nbsp;<span class="op" id="1874440">=</span>&nbsp;<span class="ident" id="1874442">s</span><span class="op" id="1874443">.</span><span class="ident" id="1874444">next</span>&nbsp;<span class="op" id="1874449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874453">if</span>&nbsp;<span class="ident" id="1874456">s</span><span class="op" id="1874457">.</span><span class="ident" id="1874458">elem</span>&nbsp;<span class="op" id="1874463">==</span>&nbsp;<span class="ident" id="1874466">unsafe</span><span class="op" id="1874472">.</span><span class="ident" id="1874473">Pointer</span><span class="op" id="1874480">(</span><span class="ident" id="1874481">addr</span><span class="op" id="1874485">)</span>&nbsp;<span class="op" id="1874487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874492">xadd</span><span class="op" id="1874496">(</span><span class="op" id="1874497">&amp;</span><span class="ident" id="1874498">root</span><span class="op" id="1874502">.</span><span class="ident" id="1874503">nwait</span><span class="op" id="1874508">,</span>&nbsp;<span class="op" id="1874510">-</span><span class="num" id="1874511">1</span><span class="op" id="1874512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874517">root</span><span class="op" id="1874521">.</span><span class="ident" id="1874522">dequeue</span><span class="op" id="1874529">(</span><span class="ident" id="1874530">s</span><span class="op" id="1874531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874536">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874550">unlock</span><span class="op" id="1874556">(</span><span class="op" id="1874557">&amp;</span><span class="ident" id="1874558">root</span><span class="op" id="1874562">.</span><span class="ident" id="1874563">lock</span><span class="op" id="1874567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874570">if</span>&nbsp;<span class="ident" id="1874573">s</span>&nbsp;<span class="op" id="1874575">!=</span>&nbsp;<span class="ident" id="1874578">nil</span>&nbsp;<span class="op" id="1874582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874586">if</span>&nbsp;<span class="ident" id="1874589">s</span><span class="op" id="1874590">.</span><span class="ident" id="1874591">releasetime</span>&nbsp;<span class="op" id="1874603">!=</span>&nbsp;<span class="num" id="1874606">0</span>&nbsp;<span class="op" id="1874608">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874613">s</span><span class="op" id="1874614">.</span><span class="ident" id="1874615">releasetime</span>&nbsp;<span class="op" id="1874627">=</span>&nbsp;<span class="ident" id="1874629">cputicks</span><span class="op" id="1874637">(</span><span class="op" id="1874638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874646">goready</span><span class="op" id="1874653">(</span><span class="ident" id="1874654">s</span><span class="op" id="1874655">.</span><span class="ident" id="1874656">g</span><span class="op" id="1874657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874660">}</span><br>
<span class="lineno"></span><span class="op" id="1874662">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1874665">func</span>&nbsp;<span class="ident" id="1874670">semroot</span><span class="op" id="1874677">(</span><span class="ident" id="1874678">addr</span>&nbsp;<span class="op" id="1874683">*</span><span class="builtintype" id="1874684">uint32</span><span class="op" id="1874690">)</span>&nbsp;<span class="op" id="1874692">*</span><span class="ident" id="1874693">semaRoot</span>&nbsp;<span class="op" id="1874702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874705">return</span>&nbsp;<span class="op" id="1874712">&amp;</span><span class="ident" id="1874713">semtable</span><span class="op" id="1874721">[</span><span class="op" id="1874722">(</span><span class="builtintype" id="1874723">uintptr</span><span class="op" id="1874730">(</span><span class="ident" id="1874731">unsafe</span><span class="op" id="1874737">.</span><span class="ident" id="1874738">Pointer</span><span class="op" id="1874745">(</span><span class="ident" id="1874746">addr</span><span class="op" id="1874750">)</span><span class="op" id="1874751">)</span><span class="op" id="1874752">&gt;&gt;</span><span class="num" id="1874754">3</span><span class="op" id="1874755">)</span><span class="op" id="1874756">%</span><span class="ident" id="1874757">semTabSize</span><span class="op" id="1874767">]</span><span class="op" id="1874768">.</span><span class="ident" id="1874769">root</span><br>
<span class="lineno"></span><span class="op" id="1874774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1874777">func</span>&nbsp;<span class="ident" id="1874782">cansemacquire</span><span class="op" id="1874795">(</span><span class="ident" id="1874796">addr</span>&nbsp;<span class="op" id="1874801">*</span><span class="builtintype" id="1874802">uint32</span><span class="op" id="1874808">)</span>&nbsp;<span class="builtintype" id="1874810">bool</span>&nbsp;<span class="op" id="1874815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874818">for</span>&nbsp;<span class="op" id="1874822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874826">v</span>&nbsp;<span class="op" id="1874828">:=</span>&nbsp;<span class="ident" id="1874831">atomicload</span><span class="op" id="1874841">(</span><span class="ident" id="1874842">addr</span><span class="op" id="1874846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874850">if</span>&nbsp;<span class="ident" id="1874853">v</span>&nbsp;<span class="op" id="1874855">==</span>&nbsp;<span class="num" id="1874858">0</span>&nbsp;<span class="op" id="1874860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874865">return</span>&nbsp;<span class="builtintype" id="1874872">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874884">if</span>&nbsp;<span class="ident" id="1874887">cas</span><span class="op" id="1874890">(</span><span class="ident" id="1874891">addr</span><span class="op" id="1874895">,</span>&nbsp;<span class="ident" id="1874897">v</span><span class="op" id="1874898">,</span>&nbsp;<span class="ident" id="1874900">v</span><span class="op" id="1874901">-</span><span class="num" id="1874902">1</span><span class="op" id="1874903">)</span>&nbsp;<span class="op" id="1874905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874910">return</span>&nbsp;<span class="builtintype" id="1874917">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874927">}</span><br>
<span class="lineno">150</span><span class="op" id="1874929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1874932">func</span>&nbsp;<span class="op" id="1874937">(</span><span class="ident" id="1874938">root</span>&nbsp;<span class="op" id="1874943">*</span><span class="ident" id="1874944">semaRoot</span><span class="op" id="1874952">)</span>&nbsp;<span class="ident" id="1874954">queue</span><span class="op" id="1874959">(</span><span class="ident" id="1874960">addr</span>&nbsp;<span class="op" id="1874965">*</span><span class="builtintype" id="1874966">uint32</span><span class="op" id="1874972">,</span>&nbsp;<span class="ident" id="1874974">s</span>&nbsp;<span class="op" id="1874976">*</span><span class="ident" id="1874977">sudog</span><span class="op" id="1874982">)</span>&nbsp;<span class="op" id="1874984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874987">s</span><span class="op" id="1874988">.</span><span class="ident" id="1874989">g</span>&nbsp;<span class="op" id="1874991">=</span>&nbsp;<span class="ident" id="1874993">getg</span><span class="op" id="1874997">(</span><span class="op" id="1874998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875001">s</span><span class="op" id="1875002">.</span><span class="ident" id="1875003">elem</span>&nbsp;<span class="op" id="1875008">=</span>&nbsp;<span class="ident" id="1875010">unsafe</span><span class="op" id="1875016">.</span><span class="ident" id="1875017">Pointer</span><span class="op" id="1875024">(</span><span class="ident" id="1875025">addr</span><span class="op" id="1875029">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875032">s</span><span class="op" id="1875033">.</span><span class="ident" id="1875034">next</span>&nbsp;<span class="op" id="1875039">=</span>&nbsp;<span class="ident" id="1875041">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875046">s</span><span class="op" id="1875047">.</span><span class="ident" id="1875048">prev</span>&nbsp;<span class="op" id="1875053">=</span>&nbsp;<span class="ident" id="1875055">root</span><span class="op" id="1875059">.</span><span class="ident" id="1875060">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875066">if</span>&nbsp;<span class="ident" id="1875069">root</span><span class="op" id="1875073">.</span><span class="ident" id="1875074">tail</span>&nbsp;<span class="op" id="1875079">!=</span>&nbsp;<span class="ident" id="1875082">nil</span>&nbsp;<span class="op" id="1875086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875090">root</span><span class="op" id="1875094">.</span><span class="ident" id="1875095">tail</span><span class="op" id="1875099">.</span><span class="ident" id="1875100">next</span>&nbsp;<span class="op" id="1875105">=</span>&nbsp;<span class="ident" id="1875107">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875110">}</span>&nbsp;<span class="keyword" id="1875112">else</span>&nbsp;<span class="op" id="1875117">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875121">root</span><span class="op" id="1875125">.</span><span class="ident" id="1875126">head</span>&nbsp;<span class="op" id="1875131">=</span>&nbsp;<span class="ident" id="1875133">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875139">root</span><span class="op" id="1875143">.</span><span class="ident" id="1875144">tail</span>&nbsp;<span class="op" id="1875149">=</span>&nbsp;<span class="ident" id="1875151">s</span><br>
<span class="lineno"></span><span class="op" id="1875153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1875156">func</span>&nbsp;<span class="op" id="1875161">(</span><span class="ident" id="1875162">root</span>&nbsp;<span class="op" id="1875167">*</span><span class="ident" id="1875168">semaRoot</span><span class="op" id="1875176">)</span>&nbsp;<span class="ident" id="1875178">dequeue</span><span class="op" id="1875185">(</span><span class="ident" id="1875186">s</span>&nbsp;<span class="op" id="1875188">*</span><span class="ident" id="1875189">sudog</span><span class="op" id="1875194">)</span>&nbsp;<span class="op" id="1875196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875199">if</span>&nbsp;<span class="ident" id="1875202">s</span><span class="op" id="1875203">.</span><span class="ident" id="1875204">next</span>&nbsp;<span class="op" id="1875209">!=</span>&nbsp;<span class="ident" id="1875212">nil</span>&nbsp;<span class="op" id="1875216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875220">s</span><span class="op" id="1875221">.</span><span class="ident" id="1875222">next</span><span class="op" id="1875226">.</span><span class="ident" id="1875227">prev</span>&nbsp;<span class="op" id="1875232">=</span>&nbsp;<span class="ident" id="1875234">s</span><span class="op" id="1875235">.</span><span class="ident" id="1875236">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875242">}</span>&nbsp;<span class="keyword" id="1875244">else</span>&nbsp;<span class="op" id="1875249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875253">root</span><span class="op" id="1875257">.</span><span class="ident" id="1875258">tail</span>&nbsp;<span class="op" id="1875263">=</span>&nbsp;<span class="ident" id="1875265">s</span><span class="op" id="1875266">.</span><span class="ident" id="1875267">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875276">if</span>&nbsp;<span class="ident" id="1875279">s</span><span class="op" id="1875280">.</span><span class="ident" id="1875281">prev</span>&nbsp;<span class="op" id="1875286">!=</span>&nbsp;<span class="ident" id="1875289">nil</span>&nbsp;<span class="op" id="1875293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875297">s</span><span class="op" id="1875298">.</span><span class="ident" id="1875299">prev</span><span class="op" id="1875303">.</span><span class="ident" id="1875304">next</span>&nbsp;<span class="op" id="1875309">=</span>&nbsp;<span class="ident" id="1875311">s</span><span class="op" id="1875312">.</span><span class="ident" id="1875313">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875319">}</span>&nbsp;<span class="keyword" id="1875321">else</span>&nbsp;<span class="op" id="1875326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875330">root</span><span class="op" id="1875334">.</span><span class="ident" id="1875335">head</span>&nbsp;<span class="op" id="1875340">=</span>&nbsp;<span class="ident" id="1875342">s</span><span class="op" id="1875343">.</span><span class="ident" id="1875344">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875353">s</span><span class="op" id="1875354">.</span><span class="ident" id="1875355">elem</span>&nbsp;<span class="op" id="1875360">=</span>&nbsp;<span class="ident" id="1875362">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875367">s</span><span class="op" id="1875368">.</span><span class="ident" id="1875369">next</span>&nbsp;<span class="op" id="1875374">=</span>&nbsp;<span class="ident" id="1875376">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875381">s</span><span class="op" id="1875382">.</span><span class="ident" id="1875383">prev</span>&nbsp;<span class="op" id="1875388">=</span>&nbsp;<span class="ident" id="1875390">nil</span><br>
<span class="lineno"></span><span class="op" id="1875394">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1875397">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1875437">type</span>&nbsp;<span class="ident" id="1875442">syncSema</span>&nbsp;<span class="keyword" id="1875451">struct</span>&nbsp;<span class="op" id="1875458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875461">lock</span>&nbsp;<span class="ident" id="1875466">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875473">head</span>&nbsp;<span class="op" id="1875478">*</span><span class="ident" id="1875479">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875486">tail</span>&nbsp;<span class="op" id="1875491">*</span><span class="ident" id="1875492">sudog</span><br>
<span class="lineno"></span><span class="op" id="1875498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1875501">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1875579">func</span>&nbsp;<span class="ident" id="1875584">syncsemacquire</span><span class="op" id="1875598">(</span><span class="ident" id="1875599">s</span>&nbsp;<span class="op" id="1875601">*</span><span class="ident" id="1875602">syncSema</span><span class="op" id="1875610">)</span>&nbsp;<span class="op" id="1875612">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875615">lock</span><span class="op" id="1875619">(</span><span class="op" id="1875620">&amp;</span><span class="ident" id="1875621">s</span><span class="op" id="1875622">.</span><span class="ident" id="1875623">lock</span><span class="op" id="1875627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875630">if</span>&nbsp;<span class="ident" id="1875633">s</span><span class="op" id="1875634">.</span><span class="ident" id="1875635">head</span>&nbsp;<span class="op" id="1875640">!=</span>&nbsp;<span class="ident" id="1875643">nil</span>&nbsp;<span class="op" id="1875647">&amp;&amp;</span>&nbsp;<span class="ident" id="1875650">s</span><span class="op" id="1875651">.</span><span class="ident" id="1875652">head</span><span class="op" id="1875656">.</span><span class="ident" id="1875657">nrelease</span>&nbsp;<span class="op" id="1875666">&gt;</span>&nbsp;<span class="num" id="1875668">0</span>&nbsp;<span class="op" id="1875670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1875674">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875713">var</span>&nbsp;<span class="ident" id="1875717">wake</span>&nbsp;<span class="op" id="1875722">*</span><span class="ident" id="1875723">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875731">s</span><span class="op" id="1875732">.</span><span class="ident" id="1875733">head</span><span class="op" id="1875737">.</span><span class="ident" id="1875738">nrelease</span><span class="op" id="1875746">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875751">if</span>&nbsp;<span class="ident" id="1875754">s</span><span class="op" id="1875755">.</span><span class="ident" id="1875756">head</span><span class="op" id="1875760">.</span><span class="ident" id="1875761">nrelease</span>&nbsp;<span class="op" id="1875770">==</span>&nbsp;<span class="num" id="1875773">0</span>&nbsp;<span class="op" id="1875775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875780">wake</span>&nbsp;<span class="op" id="1875785">=</span>&nbsp;<span class="ident" id="1875787">s</span><span class="op" id="1875788">.</span><span class="ident" id="1875789">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875797">s</span><span class="op" id="1875798">.</span><span class="ident" id="1875799">head</span>&nbsp;<span class="op" id="1875804">=</span>&nbsp;<span class="ident" id="1875806">wake</span><span class="op" id="1875810">.</span><span class="ident" id="1875811">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875819">if</span>&nbsp;<span class="ident" id="1875822">s</span><span class="op" id="1875823">.</span><span class="ident" id="1875824">head</span>&nbsp;<span class="op" id="1875829">==</span>&nbsp;<span class="ident" id="1875832">nil</span>&nbsp;<span class="op" id="1875836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875842">s</span><span class="op" id="1875843">.</span><span class="ident" id="1875844">tail</span>&nbsp;<span class="op" id="1875849">=</span>&nbsp;<span class="ident" id="1875851">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875866">unlock</span><span class="op" id="1875872">(</span><span class="op" id="1875873">&amp;</span><span class="ident" id="1875874">s</span><span class="op" id="1875875">.</span><span class="ident" id="1875876">lock</span><span class="op" id="1875880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875884">if</span>&nbsp;<span class="ident" id="1875887">wake</span>&nbsp;<span class="op" id="1875892">!=</span>&nbsp;<span class="ident" id="1875895">nil</span>&nbsp;<span class="op" id="1875899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875904">wake</span><span class="op" id="1875908">.</span><span class="ident" id="1875909">next</span>&nbsp;<span class="op" id="1875914">=</span>&nbsp;<span class="ident" id="1875916">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875923">goready</span><span class="op" id="1875930">(</span><span class="ident" id="1875931">wake</span><span class="op" id="1875935">.</span><span class="ident" id="1875936">g</span><span class="op" id="1875937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875944">}</span>&nbsp;<span class="keyword" id="1875946">else</span>&nbsp;<span class="op" id="1875951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1875955">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875976">w</span>&nbsp;<span class="op" id="1875978">:=</span>&nbsp;<span class="ident" id="1875981">acquireSudog</span><span class="op" id="1875993">(</span><span class="op" id="1875994">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875998">w</span><span class="op" id="1875999">.</span><span class="ident" id="1876000">g</span>&nbsp;<span class="op" id="1876002">=</span>&nbsp;<span class="ident" id="1876004">getg</span><span class="op" id="1876008">(</span><span class="op" id="1876009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876013">w</span><span class="op" id="1876014">.</span><span class="ident" id="1876015">nrelease</span>&nbsp;<span class="op" id="1876024">=</span>&nbsp;<span class="op" id="1876026">-</span><span class="num" id="1876027">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876031">w</span><span class="op" id="1876032">.</span><span class="ident" id="1876033">next</span>&nbsp;<span class="op" id="1876038">=</span>&nbsp;<span class="ident" id="1876040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876046">w</span><span class="op" id="1876047">.</span><span class="ident" id="1876048">releasetime</span>&nbsp;<span class="op" id="1876060">=</span>&nbsp;<span class="num" id="1876062">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876066">t0</span>&nbsp;<span class="op" id="1876069">:=</span>&nbsp;<span class="ident" id="1876072">int64</span><span class="op" id="1876077">(</span><span class="num" id="1876078">0</span><span class="op" id="1876079">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876083">if</span>&nbsp;<span class="ident" id="1876086">blockprofilerate</span>&nbsp;<span class="op" id="1876103">&gt;</span>&nbsp;<span class="num" id="1876105">0</span>&nbsp;<span class="op" id="1876107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876112">t0</span>&nbsp;<span class="op" id="1876115">=</span>&nbsp;<span class="ident" id="1876117">cputicks</span><span class="op" id="1876125">(</span><span class="op" id="1876126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876131">w</span><span class="op" id="1876132">.</span><span class="ident" id="1876133">releasetime</span>&nbsp;<span class="op" id="1876145">=</span>&nbsp;<span class="op" id="1876147">-</span><span class="num" id="1876148">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876156">if</span>&nbsp;<span class="ident" id="1876159">s</span><span class="op" id="1876160">.</span><span class="ident" id="1876161">tail</span>&nbsp;<span class="op" id="1876166">==</span>&nbsp;<span class="ident" id="1876169">nil</span>&nbsp;<span class="op" id="1876173">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876178">s</span><span class="op" id="1876179">.</span><span class="ident" id="1876180">head</span>&nbsp;<span class="op" id="1876185">=</span>&nbsp;<span class="ident" id="1876187">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876191">}</span>&nbsp;<span class="keyword" id="1876193">else</span>&nbsp;<span class="op" id="1876198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876203">s</span><span class="op" id="1876204">.</span><span class="ident" id="1876205">tail</span><span class="op" id="1876209">.</span><span class="ident" id="1876210">next</span>&nbsp;<span class="op" id="1876215">=</span>&nbsp;<span class="ident" id="1876217">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876225">s</span><span class="op" id="1876226">.</span><span class="ident" id="1876227">tail</span>&nbsp;<span class="op" id="1876232">=</span>&nbsp;<span class="ident" id="1876234">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876238">goparkunlock</span><span class="op" id="1876250">(</span><span class="op" id="1876251">&amp;</span><span class="ident" id="1876252">s</span><span class="op" id="1876253">.</span><span class="ident" id="1876254">lock</span><span class="op" id="1876258">,</span>&nbsp;<span class="string" id="1876260">&#34;semacquire&#34;</span><span class="op" id="1876272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876276">if</span>&nbsp;<span class="ident" id="1876279">t0</span>&nbsp;<span class="op" id="1876282">!=</span>&nbsp;<span class="num" id="1876285">0</span>&nbsp;<span class="op" id="1876287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876292">blockevent</span><span class="op" id="1876302">(</span><span class="ident" id="1876303">int64</span><span class="op" id="1876308">(</span><span class="ident" id="1876309">w</span><span class="op" id="1876310">.</span><span class="ident" id="1876311">releasetime</span><span class="op" id="1876322">)</span><span class="op" id="1876323">-</span><span class="ident" id="1876324">t0</span><span class="op" id="1876326">,</span>&nbsp;<span class="num" id="1876328">2</span><span class="op" id="1876329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876337">releaseSudog</span><span class="op" id="1876349">(</span><span class="ident" id="1876350">w</span><span class="op" id="1876351">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876354">}</span><br>
<span class="lineno"></span><span class="op" id="1876356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1876359">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1876437">func</span>&nbsp;<span class="ident" id="1876442">syncsemrelease</span><span class="op" id="1876456">(</span><span class="ident" id="1876457">s</span>&nbsp;<span class="op" id="1876459">*</span><span class="ident" id="1876460">syncSema</span><span class="op" id="1876468">,</span>&nbsp;<span class="ident" id="1876470">n</span>&nbsp;<span class="builtintype" id="1876472">uint32</span><span class="op" id="1876478">)</span>&nbsp;<span class="op" id="1876480">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876483">lock</span><span class="op" id="1876487">(</span><span class="op" id="1876488">&amp;</span><span class="ident" id="1876489">s</span><span class="op" id="1876490">.</span><span class="ident" id="1876491">lock</span><span class="op" id="1876495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876498">for</span>&nbsp;<span class="ident" id="1876502">n</span>&nbsp;<span class="op" id="1876504">&gt;</span>&nbsp;<span class="num" id="1876506">0</span>&nbsp;<span class="op" id="1876508">&amp;&amp;</span>&nbsp;<span class="ident" id="1876511">s</span><span class="op" id="1876512">.</span><span class="ident" id="1876513">head</span>&nbsp;<span class="op" id="1876518">!=</span>&nbsp;<span class="ident" id="1876521">nil</span>&nbsp;<span class="op" id="1876525">&amp;&amp;</span>&nbsp;<span class="ident" id="1876528">s</span><span class="op" id="1876529">.</span><span class="ident" id="1876530">head</span><span class="op" id="1876534">.</span><span class="ident" id="1876535">nrelease</span>&nbsp;<span class="op" id="1876544">&lt;</span>&nbsp;<span class="num" id="1876546">0</span>&nbsp;<span class="op" id="1876548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1876552">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876591">wake</span>&nbsp;<span class="op" id="1876596">:=</span>&nbsp;<span class="ident" id="1876599">s</span><span class="op" id="1876600">.</span><span class="ident" id="1876601">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876608">s</span><span class="op" id="1876609">.</span><span class="ident" id="1876610">head</span>&nbsp;<span class="op" id="1876615">=</span>&nbsp;<span class="ident" id="1876617">wake</span><span class="op" id="1876621">.</span><span class="ident" id="1876622">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876629">if</span>&nbsp;<span class="ident" id="1876632">s</span><span class="op" id="1876633">.</span><span class="ident" id="1876634">head</span>&nbsp;<span class="op" id="1876639">==</span>&nbsp;<span class="ident" id="1876642">nil</span>&nbsp;<span class="op" id="1876646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876651">s</span><span class="op" id="1876652">.</span><span class="ident" id="1876653">tail</span>&nbsp;<span class="op" id="1876658">=</span>&nbsp;<span class="ident" id="1876660">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876670">if</span>&nbsp;<span class="ident" id="1876673">wake</span><span class="op" id="1876677">.</span><span class="ident" id="1876678">releasetime</span>&nbsp;<span class="op" id="1876690">!=</span>&nbsp;<span class="num" id="1876693">0</span>&nbsp;<span class="op" id="1876695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876700">wake</span><span class="op" id="1876704">.</span><span class="ident" id="1876705">releasetime</span>&nbsp;<span class="op" id="1876717">=</span>&nbsp;<span class="ident" id="1876719">cputicks</span><span class="op" id="1876727">(</span><span class="op" id="1876728">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876736">wake</span><span class="op" id="1876740">.</span><span class="ident" id="1876741">next</span>&nbsp;<span class="op" id="1876746">=</span>&nbsp;<span class="ident" id="1876748">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876754">goready</span><span class="op" id="1876761">(</span><span class="ident" id="1876762">wake</span><span class="op" id="1876766">.</span><span class="ident" id="1876767">g</span><span class="op" id="1876768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876772">n</span><span class="op" id="1876773">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876777">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876780">if</span>&nbsp;<span class="ident" id="1876783">n</span>&nbsp;<span class="op" id="1876785">&gt;</span>&nbsp;<span class="num" id="1876787">0</span>&nbsp;<span class="op" id="1876789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1876793">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876813">w</span>&nbsp;<span class="op" id="1876815">:=</span>&nbsp;<span class="ident" id="1876818">acquireSudog</span><span class="op" id="1876830">(</span><span class="op" id="1876831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876835">w</span><span class="op" id="1876836">.</span><span class="ident" id="1876837">g</span>&nbsp;<span class="op" id="1876839">=</span>&nbsp;<span class="ident" id="1876841">getg</span><span class="op" id="1876845">(</span><span class="op" id="1876846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876850">w</span><span class="op" id="1876851">.</span><span class="ident" id="1876852">nrelease</span>&nbsp;<span class="op" id="1876861">=</span>&nbsp;<span class="builtintype" id="1876863">int32</span><span class="op" id="1876868">(</span><span class="ident" id="1876869">n</span><span class="op" id="1876870">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876874">w</span><span class="op" id="1876875">.</span><span class="ident" id="1876876">next</span>&nbsp;<span class="op" id="1876881">=</span>&nbsp;<span class="ident" id="1876883">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876889">w</span><span class="op" id="1876890">.</span><span class="ident" id="1876891">releasetime</span>&nbsp;<span class="op" id="1876903">=</span>&nbsp;<span class="num" id="1876905">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876909">if</span>&nbsp;<span class="ident" id="1876912">s</span><span class="op" id="1876913">.</span><span class="ident" id="1876914">tail</span>&nbsp;<span class="op" id="1876919">==</span>&nbsp;<span class="ident" id="1876922">nil</span>&nbsp;<span class="op" id="1876926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876931">s</span><span class="op" id="1876932">.</span><span class="ident" id="1876933">head</span>&nbsp;<span class="op" id="1876938">=</span>&nbsp;<span class="ident" id="1876940">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876944">}</span>&nbsp;<span class="keyword" id="1876946">else</span>&nbsp;<span class="op" id="1876951">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876956">s</span><span class="op" id="1876957">.</span><span class="ident" id="1876958">tail</span><span class="op" id="1876962">.</span><span class="ident" id="1876963">next</span>&nbsp;<span class="op" id="1876968">=</span>&nbsp;<span class="ident" id="1876970">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876978">s</span><span class="op" id="1876979">.</span><span class="ident" id="1876980">tail</span>&nbsp;<span class="op" id="1876985">=</span>&nbsp;<span class="ident" id="1876987">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876991">goparkunlock</span><span class="op" id="1877003">(</span><span class="op" id="1877004">&amp;</span><span class="ident" id="1877005">s</span><span class="op" id="1877006">.</span><span class="ident" id="1877007">lock</span><span class="op" id="1877011">,</span>&nbsp;<span class="string" id="1877013">&#34;semarelease&#34;</span><span class="op" id="1877026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877030">releaseSudog</span><span class="op" id="1877042">(</span><span class="ident" id="1877043">w</span><span class="op" id="1877044">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877047">}</span>&nbsp;<span class="keyword" id="1877049">else</span>&nbsp;<span class="op" id="1877054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877058">unlock</span><span class="op" id="1877064">(</span><span class="op" id="1877065">&amp;</span><span class="ident" id="1877066">s</span><span class="op" id="1877067">.</span><span class="ident" id="1877068">lock</span><span class="op" id="1877072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877075">}</span><br>
<span class="lineno"></span><span class="op" id="1877077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1877080">func</span>&nbsp;<span class="ident" id="1877085">syncsemcheck</span><span class="op" id="1877097">(</span><span class="ident" id="1877098">sz</span>&nbsp;<span class="builtintype" id="1877101">uintptr</span><span class="op" id="1877108">)</span>&nbsp;<span class="op" id="1877110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877113">if</span>&nbsp;<span class="ident" id="1877116">sz</span>&nbsp;<span class="op" id="1877119">!=</span>&nbsp;<span class="ident" id="1877122">unsafe</span><span class="op" id="1877128">.</span><span class="ident" id="1877129">Sizeof</span><span class="op" id="1877135">(</span><span class="ident" id="1877136">syncSema</span><span class="op" id="1877144">{</span><span class="op" id="1877145">}</span><span class="op" id="1877146">)</span>&nbsp;<span class="op" id="1877148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1877152">print</span><span class="op" id="1877157">(</span><span class="string" id="1877158">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1877194">,</span>&nbsp;<span class="ident" id="1877196">sz</span><span class="op" id="1877198">,</span>&nbsp;<span class="string" id="1877200">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1877211">,</span>&nbsp;<span class="ident" id="1877213">unsafe</span><span class="op" id="1877219">.</span><span class="ident" id="1877220">Sizeof</span><span class="op" id="1877226">(</span><span class="ident" id="1877227">syncSema</span><span class="op" id="1877235">{</span><span class="op" id="1877236">}</span><span class="op" id="1877237">)</span><span class="op" id="1877238">,</span>&nbsp;<span class="string" id="1877240">&#34;\n&#34;</span><span class="op" id="1877244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877248">gothrow</span><span class="op" id="1877255">(</span><span class="string" id="1877256">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1877275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877278">}</span><br>
<span class="lineno">275</span><span class="op" id="1877280">}</span>
</div>
</body>
</html>
