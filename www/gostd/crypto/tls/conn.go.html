<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3744871">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3744926">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3744980">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3745031">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3745077">package</span>&nbsp;<span class="ident" id="3745085">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3745090">import</span>&nbsp;<span class="op" id="3745097">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745100">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745109">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745126">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745143">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745158">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745168">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745175">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745181">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745188">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3745196">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3745203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3745206">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3745249">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3745290">type</span>&nbsp;<span class="ident" id="3745295">Conn</span>&nbsp;<span class="keyword" id="3745300">struct</span>&nbsp;<span class="op" id="3745307">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745310">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745323">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745332">net</span><span class="op" id="3745335">.</span><span class="ident" id="3745336">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745342">isClient</span>&nbsp;<span class="builtintype" id="3745351">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745358">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745416">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745434">sync</span><span class="op" id="3745438">.</span><span class="ident" id="3745439">Mutex</span>&nbsp;<span class="comment" id="3745445">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745496">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3745514">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745525">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745560">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3745578">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745589">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745605">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3745623">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745634">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745666">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3745684">*</span><span class="ident" id="3745685">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745695">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745735">handshakeComplete</span>&nbsp;<span class="builtintype" id="3745753">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745759">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3745777">bool</span>&nbsp;<span class="comment" id="3745782">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745835">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3745853">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745861">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3745879">[</span><span class="op" id="3745880">]</span><span class="builtintype" id="3745881">byte</span>&nbsp;<span class="comment" id="3745886">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3745912">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3745930">[</span><span class="op" id="3745931">]</span><span class="op" id="3745932">*</span><span class="ident" id="3745933">x509</span><span class="op" id="3745937">.</span><span class="ident" id="3745938">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745951">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746020">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746069">verifiedChains</span>&nbsp;<span class="op" id="3746084">[</span><span class="op" id="3746085">]</span><span class="op" id="3746086">[</span><span class="op" id="3746087">]</span><span class="op" id="3746088">*</span><span class="ident" id="3746089">x509</span><span class="op" id="3746093">.</span><span class="ident" id="3746094">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746107">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746180">serverName</span>&nbsp;<span class="builtintype" id="3746191">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746199">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746266">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746329">firstFinished</span>&nbsp;<span class="op" id="3746343">[</span><span class="num" id="3746344">12</span><span class="op" id="3746346">]</span><span class="builtintype" id="3746347">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746354">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3746377">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746385">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3746408">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746415">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746432">in</span><span class="op" id="3746434">,</span>&nbsp;<span class="ident" id="3746436">out</span>&nbsp;&nbsp;<span class="ident" id="3746441">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746454">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746479">rawInput</span>&nbsp;<span class="op" id="3746488">*</span><span class="ident" id="3746489">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746501">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746535">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3746544">*</span><span class="ident" id="3746545">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3746557">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746597">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746606">bytes</span><span class="op" id="3746611">.</span><span class="ident" id="3746612">Buffer</span>&nbsp;<span class="comment" id="3746619">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3746658">tmp</span>&nbsp;<span class="op" id="3746662">[</span><span class="num" id="3746663">16</span><span class="op" id="3746665">]</span><span class="builtintype" id="3746666">byte</span><br>
<span class="lineno"></span><span class="op" id="3746671">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3746674">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3746705">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3746754">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3746787">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3746835">func</span>&nbsp;<span class="op" id="3746840">(</span><span class="ident" id="3746841">c</span>&nbsp;<span class="op" id="3746843">*</span><span class="ident" id="3746844">Conn</span><span class="op" id="3746848">)</span>&nbsp;<span class="ident" id="3746850">LocalAddr</span><span class="op" id="3746859">(</span><span class="op" id="3746860">)</span>&nbsp;<span class="ident" id="3746862">net</span><span class="op" id="3746865">.</span><span class="ident" id="3746866">Addr</span>&nbsp;<span class="op" id="3746871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3746874">return</span>&nbsp;<span class="ident" id="3746881">c</span><span class="op" id="3746882">.</span><span class="ident" id="3746883">conn</span><span class="op" id="3746887">.</span><span class="ident" id="3746888">LocalAddr</span><span class="op" id="3746897">(</span><span class="op" id="3746898">)</span><br>
<span class="lineno"></span><span class="op" id="3746900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3746903">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3746953">func</span>&nbsp;<span class="op" id="3746958">(</span><span class="ident" id="3746959">c</span>&nbsp;<span class="op" id="3746961">*</span><span class="ident" id="3746962">Conn</span><span class="op" id="3746966">)</span>&nbsp;<span class="ident" id="3746968">RemoteAddr</span><span class="op" id="3746978">(</span><span class="op" id="3746979">)</span>&nbsp;<span class="ident" id="3746981">net</span><span class="op" id="3746984">.</span><span class="ident" id="3746985">Addr</span>&nbsp;<span class="op" id="3746990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3746993">return</span>&nbsp;<span class="ident" id="3747000">c</span><span class="op" id="3747001">.</span><span class="ident" id="3747002">conn</span><span class="op" id="3747006">.</span><span class="ident" id="3747007">RemoteAddr</span><span class="op" id="3747017">(</span><span class="op" id="3747018">)</span><br>
<span class="lineno"></span><span class="op" id="3747020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3747023">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3747104">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3747166">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3747273">func</span>&nbsp;<span class="op" id="3747278">(</span><span class="ident" id="3747279">c</span>&nbsp;<span class="op" id="3747281">*</span><span class="ident" id="3747282">Conn</span><span class="op" id="3747286">)</span>&nbsp;<span class="ident" id="3747288">SetDeadline</span><span class="op" id="3747299">(</span><span class="ident" id="3747300">t</span>&nbsp;<span class="ident" id="3747302">time</span><span class="op" id="3747306">.</span><span class="ident" id="3747307">Time</span><span class="op" id="3747311">)</span>&nbsp;<span class="builtintype" id="3747313">error</span>&nbsp;<span class="op" id="3747319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3747322">return</span>&nbsp;<span class="ident" id="3747329">c</span><span class="op" id="3747330">.</span><span class="ident" id="3747331">conn</span><span class="op" id="3747335">.</span><span class="ident" id="3747336">SetDeadline</span><span class="op" id="3747347">(</span><span class="ident" id="3747348">t</span><span class="op" id="3747349">)</span><br>
<span class="lineno">80</span><span class="op" id="3747351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3747354">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3747426">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3747478">func</span>&nbsp;<span class="op" id="3747483">(</span><span class="ident" id="3747484">c</span>&nbsp;<span class="op" id="3747486">*</span><span class="ident" id="3747487">Conn</span><span class="op" id="3747491">)</span>&nbsp;<span class="ident" id="3747493">SetReadDeadline</span><span class="op" id="3747508">(</span><span class="ident" id="3747509">t</span>&nbsp;<span class="ident" id="3747511">time</span><span class="op" id="3747515">.</span><span class="ident" id="3747516">Time</span><span class="op" id="3747520">)</span>&nbsp;<span class="builtintype" id="3747522">error</span>&nbsp;<span class="op" id="3747528">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3747531">return</span>&nbsp;<span class="ident" id="3747538">c</span><span class="op" id="3747539">.</span><span class="ident" id="3747540">conn</span><span class="op" id="3747544">.</span><span class="ident" id="3747545">SetReadDeadline</span><span class="op" id="3747560">(</span><span class="ident" id="3747561">t</span><span class="op" id="3747562">)</span><br>
<span class="lineno"></span><span class="op" id="3747564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3747567">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3747641">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3747694">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3747801">func</span>&nbsp;<span class="op" id="3747806">(</span><span class="ident" id="3747807">c</span>&nbsp;<span class="op" id="3747809">*</span><span class="ident" id="3747810">Conn</span><span class="op" id="3747814">)</span>&nbsp;<span class="ident" id="3747816">SetWriteDeadline</span><span class="op" id="3747832">(</span><span class="ident" id="3747833">t</span>&nbsp;<span class="ident" id="3747835">time</span><span class="op" id="3747839">.</span><span class="ident" id="3747840">Time</span><span class="op" id="3747844">)</span>&nbsp;<span class="builtintype" id="3747846">error</span>&nbsp;<span class="op" id="3747852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3747855">return</span>&nbsp;<span class="ident" id="3747862">c</span><span class="op" id="3747863">.</span><span class="ident" id="3747864">conn</span><span class="op" id="3747868">.</span><span class="ident" id="3747869">SetWriteDeadline</span><span class="op" id="3747885">(</span><span class="ident" id="3747886">t</span><span class="op" id="3747887">)</span><br>
<span class="lineno"></span><span class="op" id="3747889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3747892">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3747951">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3747995">type</span>&nbsp;<span class="ident" id="3748000">halfConn</span>&nbsp;<span class="keyword" id="3748009">struct</span>&nbsp;<span class="op" id="3748016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748019">sync</span><span class="op" id="3748023">.</span><span class="ident" id="3748024">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748032">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3748040">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3748052">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748078">version</span>&nbsp;<span class="builtintype" id="3748086">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3748098">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748119">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3748127">interface</span><span class="op" id="3748136">{</span><span class="op" id="3748137">}</span>&nbsp;<span class="comment" id="3748139">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748160">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748168">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748181">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3748189">[</span><span class="num" id="3748190">8</span><span class="op" id="3748191">]</span><span class="builtintype" id="3748192">byte</span>&nbsp;<span class="comment" id="3748197">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748224">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3748232">*</span><span class="ident" id="3748233">block</span>&nbsp;&nbsp;<span class="comment" id="3748240">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748265">nextCipher</span>&nbsp;<span class="keyword" id="3748276">interface</span><span class="op" id="3748285">{</span><span class="op" id="3748286">}</span>&nbsp;<span class="comment" id="3748288">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748314">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748325">macFunction</span>&nbsp;<span class="comment" id="3748337">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3748361">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748416">inDigestBuf</span><span class="op" id="3748427">,</span>&nbsp;<span class="ident" id="3748429">outDigestBuf</span>&nbsp;<span class="op" id="3748442">[</span><span class="op" id="3748443">]</span><span class="builtintype" id="3748444">byte</span><br>
<span class="lineno"></span><span class="op" id="3748449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3748452">func</span>&nbsp;<span class="op" id="3748457">(</span><span class="ident" id="3748458">hc</span>&nbsp;<span class="op" id="3748461">*</span><span class="ident" id="3748462">halfConn</span><span class="op" id="3748470">)</span>&nbsp;<span class="ident" id="3748472">setErrorLocked</span><span class="op" id="3748486">(</span><span class="ident" id="3748487">err</span>&nbsp;<span class="builtintype" id="3748491">error</span><span class="op" id="3748496">)</span>&nbsp;<span class="builtintype" id="3748498">error</span>&nbsp;<span class="op" id="3748504">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748507">hc</span><span class="op" id="3748509">.</span><span class="ident" id="3748510">err</span>&nbsp;<span class="op" id="3748514">=</span>&nbsp;<span class="ident" id="3748516">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3748521">return</span>&nbsp;<span class="ident" id="3748528">err</span><br>
<span class="lineno"></span><span class="op" id="3748532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3748535">func</span>&nbsp;<span class="op" id="3748540">(</span><span class="ident" id="3748541">hc</span>&nbsp;<span class="op" id="3748544">*</span><span class="ident" id="3748545">halfConn</span><span class="op" id="3748553">)</span>&nbsp;<span class="builtintype" id="3748555">error</span><span class="op" id="3748560">(</span><span class="op" id="3748561">)</span>&nbsp;<span class="builtintype" id="3748563">error</span>&nbsp;<span class="op" id="3748569">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748572">hc</span><span class="op" id="3748574">.</span><span class="ident" id="3748575">Lock</span><span class="op" id="3748579">(</span><span class="op" id="3748580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748583">err</span>&nbsp;<span class="op" id="3748587">:=</span>&nbsp;<span class="ident" id="3748590">hc</span><span class="op" id="3748592">.</span><span class="ident" id="3748593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748598">hc</span><span class="op" id="3748600">.</span><span class="ident" id="3748601">Unlock</span><span class="op" id="3748607">(</span><span class="op" id="3748608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3748611">return</span>&nbsp;<span class="ident" id="3748618">err</span><br>
<span class="lineno"></span><span class="op" id="3748622">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3748625">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3748681">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3748729">func</span>&nbsp;<span class="op" id="3748734">(</span><span class="ident" id="3748735">hc</span>&nbsp;<span class="op" id="3748738">*</span><span class="ident" id="3748739">halfConn</span><span class="op" id="3748747">)</span>&nbsp;<span class="ident" id="3748749">prepareCipherSpec</span><span class="op" id="3748766">(</span><span class="ident" id="3748767">version</span>&nbsp;<span class="builtintype" id="3748775">uint16</span><span class="op" id="3748781">,</span>&nbsp;<span class="ident" id="3748783">cipher</span>&nbsp;<span class="keyword" id="3748790">interface</span><span class="op" id="3748799">{</span><span class="op" id="3748800">}</span><span class="op" id="3748801">,</span>&nbsp;<span class="ident" id="3748803">mac</span>&nbsp;<span class="ident" id="3748807">macFunction</span><span class="op" id="3748818">)</span>&nbsp;<span class="op" id="3748820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748823">hc</span><span class="op" id="3748825">.</span><span class="ident" id="3748826">version</span>&nbsp;<span class="op" id="3748834">=</span>&nbsp;<span class="ident" id="3748836">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748845">hc</span><span class="op" id="3748847">.</span><span class="ident" id="3748848">nextCipher</span>&nbsp;<span class="op" id="3748859">=</span>&nbsp;<span class="ident" id="3748861">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3748869">hc</span><span class="op" id="3748871">.</span><span class="ident" id="3748872">nextMac</span>&nbsp;<span class="op" id="3748880">=</span>&nbsp;<span class="ident" id="3748882">mac</span><br>
<span class="lineno"></span><span class="op" id="3748886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3748889">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3748947">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3749002">func</span>&nbsp;<span class="op" id="3749007">(</span><span class="ident" id="3749008">hc</span>&nbsp;<span class="op" id="3749011">*</span><span class="ident" id="3749012">halfConn</span><span class="op" id="3749020">)</span>&nbsp;<span class="ident" id="3749022">changeCipherSpec</span><span class="op" id="3749038">(</span><span class="op" id="3749039">)</span>&nbsp;<span class="builtintype" id="3749041">error</span>&nbsp;<span class="op" id="3749047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749050">if</span>&nbsp;<span class="ident" id="3749053">hc</span><span class="op" id="3749055">.</span><span class="ident" id="3749056">nextCipher</span>&nbsp;<span class="op" id="3749067">==</span>&nbsp;<span class="builtintype" id="3749070">nil</span>&nbsp;<span class="op" id="3749074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749078">return</span>&nbsp;<span class="ident" id="3749085">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3749105">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749108">hc</span><span class="op" id="3749110">.</span><span class="ident" id="3749111">cipher</span>&nbsp;<span class="op" id="3749118">=</span>&nbsp;<span class="ident" id="3749120">hc</span><span class="op" id="3749122">.</span><span class="ident" id="3749123">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749135">hc</span><span class="op" id="3749137">.</span><span class="ident" id="3749138">mac</span>&nbsp;<span class="op" id="3749142">=</span>&nbsp;<span class="ident" id="3749144">hc</span><span class="op" id="3749146">.</span><span class="ident" id="3749147">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749156">hc</span><span class="op" id="3749158">.</span><span class="ident" id="3749159">nextCipher</span>&nbsp;<span class="op" id="3749170">=</span>&nbsp;<span class="builtintype" id="3749172">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749177">hc</span><span class="op" id="3749179">.</span><span class="ident" id="3749180">nextMac</span>&nbsp;<span class="op" id="3749188">=</span>&nbsp;<span class="builtintype" id="3749190">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749195">for</span>&nbsp;<span class="ident" id="3749199">i</span>&nbsp;<span class="op" id="3749201">:=</span>&nbsp;<span class="keyword" id="3749204">range</span>&nbsp;<span class="ident" id="3749210">hc</span><span class="op" id="3749212">.</span><span class="ident" id="3749213">seq</span>&nbsp;<span class="op" id="3749217">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749221">hc</span><span class="op" id="3749223">.</span><span class="ident" id="3749224">seq</span><span class="op" id="3749227">[</span><span class="ident" id="3749228">i</span><span class="op" id="3749229">]</span>&nbsp;<span class="op" id="3749231">=</span>&nbsp;<span class="num" id="3749233">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3749236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749239">return</span>&nbsp;<span class="builtintype" id="3749246">nil</span><br>
<span class="lineno"></span><span class="op" id="3749250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3749253">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3749295">func</span>&nbsp;<span class="op" id="3749300">(</span><span class="ident" id="3749301">hc</span>&nbsp;<span class="op" id="3749304">*</span><span class="ident" id="3749305">halfConn</span><span class="op" id="3749313">)</span>&nbsp;<span class="ident" id="3749315">incSeq</span><span class="op" id="3749321">(</span><span class="op" id="3749322">)</span>&nbsp;<span class="op" id="3749324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749327">for</span>&nbsp;<span class="ident" id="3749331">i</span>&nbsp;<span class="op" id="3749333">:=</span>&nbsp;<span class="num" id="3749336">7</span><span class="op" id="3749337">;</span>&nbsp;<span class="ident" id="3749339">i</span>&nbsp;<span class="op" id="3749341">&gt;=</span>&nbsp;<span class="num" id="3749344">0</span><span class="op" id="3749345">;</span>&nbsp;<span class="ident" id="3749347">i</span><span class="op" id="3749348">--</span>&nbsp;<span class="op" id="3749351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749355">hc</span><span class="op" id="3749357">.</span><span class="ident" id="3749358">seq</span><span class="op" id="3749361">[</span><span class="ident" id="3749362">i</span><span class="op" id="3749363">]</span><span class="op" id="3749364">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749369">if</span>&nbsp;<span class="ident" id="3749372">hc</span><span class="op" id="3749374">.</span><span class="ident" id="3749375">seq</span><span class="op" id="3749378">[</span><span class="ident" id="3749379">i</span><span class="op" id="3749380">]</span>&nbsp;<span class="op" id="3749382">!=</span>&nbsp;<span class="num" id="3749385">0</span>&nbsp;<span class="op" id="3749387">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749392">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3749401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3749404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3749408">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3749453">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3749499">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3749532">panic</span><span class="op" id="3749537">(</span><span class="string" id="3749538">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3749571">)</span><br>
<span class="lineno"></span><span class="op" id="3749573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3749576">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3749624">func</span>&nbsp;<span class="op" id="3749629">(</span><span class="ident" id="3749630">hc</span>&nbsp;<span class="op" id="3749633">*</span><span class="ident" id="3749634">halfConn</span><span class="op" id="3749642">)</span>&nbsp;<span class="ident" id="3749644">resetSeq</span><span class="op" id="3749652">(</span><span class="op" id="3749653">)</span>&nbsp;<span class="op" id="3749655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749658">for</span>&nbsp;<span class="ident" id="3749662">i</span>&nbsp;<span class="op" id="3749664">:=</span>&nbsp;<span class="keyword" id="3749667">range</span>&nbsp;<span class="ident" id="3749673">hc</span><span class="op" id="3749675">.</span><span class="ident" id="3749676">seq</span>&nbsp;<span class="op" id="3749680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3749684">hc</span><span class="op" id="3749686">.</span><span class="ident" id="3749687">seq</span><span class="op" id="3749690">[</span><span class="ident" id="3749691">i</span><span class="op" id="3749692">]</span>&nbsp;<span class="op" id="3749694">=</span>&nbsp;<span class="num" id="3749696">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3749699">}</span><br>
<span class="lineno">170</span><span class="op" id="3749701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3749704">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3749784">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3749861">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3749921">func</span>&nbsp;<span class="ident" id="3749926">removePadding</span><span class="op" id="3749939">(</span><span class="ident" id="3749940">payload</span>&nbsp;<span class="op" id="3749948">[</span><span class="op" id="3749949">]</span><span class="builtintype" id="3749950">byte</span><span class="op" id="3749954">)</span>&nbsp;<span class="op" id="3749956">(</span><span class="op" id="3749957">[</span><span class="op" id="3749958">]</span><span class="builtintype" id="3749959">byte</span><span class="op" id="3749963">,</span>&nbsp;<span class="builtintype" id="3749965">byte</span><span class="op" id="3749969">)</span>&nbsp;<span class="op" id="3749971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749974">if</span>&nbsp;<span class="builtinfunc" id="3749977">len</span><span class="op" id="3749980">(</span><span class="ident" id="3749981">payload</span><span class="op" id="3749988">)</span>&nbsp;<span class="op" id="3749990">&lt;</span>&nbsp;<span class="num" id="3749992">1</span>&nbsp;<span class="op" id="3749994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3749998">return</span>&nbsp;<span class="ident" id="3750005">payload</span><span class="op" id="3750012">,</span>&nbsp;<span class="num" id="3750014">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3750017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750021">paddingLen</span>&nbsp;<span class="op" id="3750032">:=</span>&nbsp;<span class="ident" id="3750035">payload</span><span class="op" id="3750042">[</span><span class="builtinfunc" id="3750043">len</span><span class="op" id="3750046">(</span><span class="ident" id="3750047">payload</span><span class="op" id="3750054">)</span><span class="op" id="3750055">-</span><span class="num" id="3750056">1</span><span class="op" id="3750057">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750060">t</span>&nbsp;<span class="op" id="3750062">:=</span>&nbsp;<span class="builtintype" id="3750065">uint</span><span class="op" id="3750069">(</span><span class="builtinfunc" id="3750070">len</span><span class="op" id="3750073">(</span><span class="ident" id="3750074">payload</span><span class="op" id="3750081">)</span><span class="op" id="3750082">-</span><span class="num" id="3750083">1</span><span class="op" id="3750084">)</span>&nbsp;<span class="op" id="3750086">-</span>&nbsp;<span class="builtintype" id="3750088">uint</span><span class="op" id="3750092">(</span><span class="ident" id="3750093">paddingLen</span><span class="op" id="3750103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3750106">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750172">good</span>&nbsp;<span class="op" id="3750177">:=</span>&nbsp;<span class="builtintype" id="3750180">byte</span><span class="op" id="3750184">(</span><span class="builtintype" id="3750185">int32</span><span class="op" id="3750190">(</span><span class="op" id="3750191">^</span><span class="ident" id="3750192">t</span><span class="op" id="3750193">)</span>&nbsp;<span class="op" id="3750195">&gt;&gt;</span>&nbsp;<span class="num" id="3750198">31</span><span class="op" id="3750200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750204">toCheck</span>&nbsp;<span class="op" id="3750212">:=</span>&nbsp;<span class="num" id="3750215">255</span>&nbsp;<span class="comment" id="3750219">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3750259">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3750329">if</span>&nbsp;<span class="ident" id="3750332">toCheck</span><span class="op" id="3750339">+</span><span class="num" id="3750340">1</span>&nbsp;<span class="op" id="3750342">&gt;</span>&nbsp;<span class="builtinfunc" id="3750344">len</span><span class="op" id="3750347">(</span><span class="ident" id="3750348">payload</span><span class="op" id="3750355">)</span>&nbsp;<span class="op" id="3750357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750361">toCheck</span>&nbsp;<span class="op" id="3750369">=</span>&nbsp;<span class="builtinfunc" id="3750371">len</span><span class="op" id="3750374">(</span><span class="ident" id="3750375">payload</span><span class="op" id="3750382">)</span>&nbsp;<span class="op" id="3750384">-</span>&nbsp;<span class="num" id="3750386">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3750389">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3750393">for</span>&nbsp;<span class="ident" id="3750397">i</span>&nbsp;<span class="op" id="3750399">:=</span>&nbsp;<span class="num" id="3750402">0</span><span class="op" id="3750403">;</span>&nbsp;<span class="ident" id="3750405">i</span>&nbsp;<span class="op" id="3750407">&lt;</span>&nbsp;<span class="ident" id="3750409">toCheck</span><span class="op" id="3750416">;</span>&nbsp;<span class="ident" id="3750418">i</span><span class="op" id="3750419">++</span>&nbsp;<span class="op" id="3750422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750426">t</span>&nbsp;<span class="op" id="3750428">:=</span>&nbsp;<span class="builtintype" id="3750431">uint</span><span class="op" id="3750435">(</span><span class="ident" id="3750436">paddingLen</span><span class="op" id="3750446">)</span>&nbsp;<span class="op" id="3750448">-</span>&nbsp;<span class="builtintype" id="3750450">uint</span><span class="op" id="3750454">(</span><span class="ident" id="3750455">i</span><span class="op" id="3750456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3750460">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750510">mask</span>&nbsp;<span class="op" id="3750515">:=</span>&nbsp;<span class="builtintype" id="3750518">byte</span><span class="op" id="3750522">(</span><span class="builtintype" id="3750523">int32</span><span class="op" id="3750528">(</span><span class="op" id="3750529">^</span><span class="ident" id="3750530">t</span><span class="op" id="3750531">)</span>&nbsp;<span class="op" id="3750533">&gt;&gt;</span>&nbsp;<span class="num" id="3750536">31</span><span class="op" id="3750538">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750542">b</span>&nbsp;<span class="op" id="3750544">:=</span>&nbsp;<span class="ident" id="3750547">payload</span><span class="op" id="3750554">[</span><span class="builtinfunc" id="3750555">len</span><span class="op" id="3750558">(</span><span class="ident" id="3750559">payload</span><span class="op" id="3750566">)</span><span class="op" id="3750567">-</span><span class="num" id="3750568">1</span><span class="op" id="3750569">-</span><span class="ident" id="3750570">i</span><span class="op" id="3750571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750575">good</span>&nbsp;<span class="op" id="3750580">&amp;^=</span>&nbsp;<span class="ident" id="3750584">mask</span><span class="op" id="3750588">&amp;</span><span class="ident" id="3750589">paddingLen</span>&nbsp;<span class="op" id="3750600">^</span>&nbsp;<span class="ident" id="3750602">mask</span><span class="op" id="3750606">&amp;</span><span class="ident" id="3750607">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3750610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3750614">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3750683">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750701">good</span>&nbsp;<span class="op" id="3750706">&amp;=</span>&nbsp;<span class="ident" id="3750709">good</span>&nbsp;<span class="op" id="3750714">&lt;&lt;</span>&nbsp;<span class="num" id="3750717">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750720">good</span>&nbsp;<span class="op" id="3750725">&amp;=</span>&nbsp;<span class="ident" id="3750728">good</span>&nbsp;<span class="op" id="3750733">&lt;&lt;</span>&nbsp;<span class="num" id="3750736">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750739">good</span>&nbsp;<span class="op" id="3750744">&amp;=</span>&nbsp;<span class="ident" id="3750747">good</span>&nbsp;<span class="op" id="3750752">&lt;&lt;</span>&nbsp;<span class="num" id="3750755">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750758">good</span>&nbsp;<span class="op" id="3750763">=</span>&nbsp;<span class="builtintype" id="3750765">uint8</span><span class="op" id="3750770">(</span><span class="builtintype" id="3750771">int8</span><span class="op" id="3750775">(</span><span class="ident" id="3750776">good</span><span class="op" id="3750780">)</span>&nbsp;<span class="op" id="3750782">&gt;&gt;</span>&nbsp;<span class="num" id="3750785">7</span><span class="op" id="3750786">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3750790">toRemove</span>&nbsp;<span class="op" id="3750799">:=</span>&nbsp;<span class="ident" id="3750802">good</span><span class="op" id="3750806">&amp;</span><span class="ident" id="3750807">paddingLen</span>&nbsp;<span class="op" id="3750818">+</span>&nbsp;<span class="num" id="3750820">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3750823">return</span>&nbsp;<span class="ident" id="3750830">payload</span><span class="op" id="3750837">[</span><span class="op" id="3750838">:</span><span class="builtinfunc" id="3750839">len</span><span class="op" id="3750842">(</span><span class="ident" id="3750843">payload</span><span class="op" id="3750850">)</span><span class="op" id="3750851">-</span><span class="builtintype" id="3750852">int</span><span class="op" id="3750855">(</span><span class="ident" id="3750856">toRemove</span><span class="op" id="3750864">)</span><span class="op" id="3750865">]</span><span class="op" id="3750866">,</span>&nbsp;<span class="ident" id="3750868">good</span><br>
<span class="lineno"></span><span class="op" id="3750873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3750876">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3750954">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3751029">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3751066">func</span>&nbsp;<span class="ident" id="3751071">removePaddingSSL30</span><span class="op" id="3751089">(</span><span class="ident" id="3751090">payload</span>&nbsp;<span class="op" id="3751098">[</span><span class="op" id="3751099">]</span><span class="builtintype" id="3751100">byte</span><span class="op" id="3751104">)</span>&nbsp;<span class="op" id="3751106">(</span><span class="op" id="3751107">[</span><span class="op" id="3751108">]</span><span class="builtintype" id="3751109">byte</span><span class="op" id="3751113">,</span>&nbsp;<span class="builtintype" id="3751115">byte</span><span class="op" id="3751119">)</span>&nbsp;<span class="op" id="3751121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751124">if</span>&nbsp;<span class="builtinfunc" id="3751127">len</span><span class="op" id="3751130">(</span><span class="ident" id="3751131">payload</span><span class="op" id="3751138">)</span>&nbsp;<span class="op" id="3751140">&lt;</span>&nbsp;<span class="num" id="3751142">1</span>&nbsp;<span class="op" id="3751144">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751148">return</span>&nbsp;<span class="ident" id="3751155">payload</span><span class="op" id="3751162">,</span>&nbsp;<span class="num" id="3751164">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3751167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751171">paddingLen</span>&nbsp;<span class="op" id="3751182">:=</span>&nbsp;<span class="builtintype" id="3751185">int</span><span class="op" id="3751188">(</span><span class="ident" id="3751189">payload</span><span class="op" id="3751196">[</span><span class="builtinfunc" id="3751197">len</span><span class="op" id="3751200">(</span><span class="ident" id="3751201">payload</span><span class="op" id="3751208">)</span><span class="op" id="3751209">-</span><span class="num" id="3751210">1</span><span class="op" id="3751211">]</span><span class="op" id="3751212">)</span>&nbsp;<span class="op" id="3751214">+</span>&nbsp;<span class="num" id="3751216">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751219">if</span>&nbsp;<span class="ident" id="3751222">paddingLen</span>&nbsp;<span class="op" id="3751233">&gt;</span>&nbsp;<span class="builtinfunc" id="3751235">len</span><span class="op" id="3751238">(</span><span class="ident" id="3751239">payload</span><span class="op" id="3751246">)</span>&nbsp;<span class="op" id="3751248">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751252">return</span>&nbsp;<span class="ident" id="3751259">payload</span><span class="op" id="3751266">,</span>&nbsp;<span class="num" id="3751268">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3751271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751275">return</span>&nbsp;<span class="ident" id="3751282">payload</span><span class="op" id="3751289">[</span><span class="op" id="3751290">:</span><span class="builtinfunc" id="3751291">len</span><span class="op" id="3751294">(</span><span class="ident" id="3751295">payload</span><span class="op" id="3751302">)</span><span class="op" id="3751303">-</span><span class="ident" id="3751304">paddingLen</span><span class="op" id="3751314">]</span><span class="op" id="3751315">,</span>&nbsp;<span class="num" id="3751317">255</span><br>
<span class="lineno"></span><span class="op" id="3751321">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3751324">func</span>&nbsp;<span class="ident" id="3751329">roundUp</span><span class="op" id="3751336">(</span><span class="ident" id="3751337">a</span><span class="op" id="3751338">,</span>&nbsp;<span class="ident" id="3751340">b</span>&nbsp;<span class="builtintype" id="3751342">int</span><span class="op" id="3751345">)</span>&nbsp;<span class="builtintype" id="3751347">int</span>&nbsp;<span class="op" id="3751351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751354">return</span>&nbsp;<span class="ident" id="3751361">a</span>&nbsp;<span class="op" id="3751363">+</span>&nbsp;<span class="op" id="3751365">(</span><span class="ident" id="3751366">b</span><span class="op" id="3751367">-</span><span class="ident" id="3751368">a</span><span class="op" id="3751369">%</span><span class="ident" id="3751370">b</span><span class="op" id="3751371">)</span><span class="op" id="3751372">%</span><span class="ident" id="3751373">b</span><br>
<span class="lineno"></span><span class="op" id="3751375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3751378">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3751452">type</span>&nbsp;<span class="ident" id="3751457">cbcMode</span>&nbsp;<span class="keyword" id="3751465">interface</span>&nbsp;<span class="op" id="3751475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751478">cipher</span><span class="op" id="3751484">.</span><span class="ident" id="3751485">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751496">SetIV</span><span class="op" id="3751501">(</span><span class="op" id="3751502">[</span><span class="op" id="3751503">]</span><span class="builtintype" id="3751504">byte</span><span class="op" id="3751508">)</span><br>
<span class="lineno"></span><span class="op" id="3751510">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3751513">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3751588">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3751668">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3751738">func</span>&nbsp;<span class="op" id="3751743">(</span><span class="ident" id="3751744">hc</span>&nbsp;<span class="op" id="3751747">*</span><span class="ident" id="3751748">halfConn</span><span class="op" id="3751756">)</span>&nbsp;<span class="ident" id="3751758">decrypt</span><span class="op" id="3751765">(</span><span class="ident" id="3751766">b</span>&nbsp;<span class="op" id="3751768">*</span><span class="ident" id="3751769">block</span><span class="op" id="3751774">)</span>&nbsp;<span class="op" id="3751776">(</span><span class="ident" id="3751777">ok</span>&nbsp;<span class="builtintype" id="3751780">bool</span><span class="op" id="3751784">,</span>&nbsp;<span class="ident" id="3751786">prefixLen</span>&nbsp;<span class="builtintype" id="3751796">int</span><span class="op" id="3751799">,</span>&nbsp;<span class="ident" id="3751801">alertValue</span>&nbsp;<span class="ident" id="3751812">alert</span><span class="op" id="3751817">)</span>&nbsp;<span class="op" id="3751819">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3751822">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751843">payload</span>&nbsp;<span class="op" id="3751851">:=</span>&nbsp;<span class="ident" id="3751854">b</span><span class="op" id="3751855">.</span><span class="ident" id="3751856">data</span><span class="op" id="3751860">[</span><span class="ident" id="3751861">recordHeaderLen</span><span class="op" id="3751876">:</span><span class="op" id="3751877">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751881">macSize</span>&nbsp;<span class="op" id="3751889">:=</span>&nbsp;<span class="num" id="3751892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3751895">if</span>&nbsp;<span class="ident" id="3751898">hc</span><span class="op" id="3751900">.</span><span class="ident" id="3751901">mac</span>&nbsp;<span class="op" id="3751905">!=</span>&nbsp;<span class="builtintype" id="3751908">nil</span>&nbsp;<span class="op" id="3751912">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751916">macSize</span>&nbsp;<span class="op" id="3751924">=</span>&nbsp;<span class="ident" id="3751926">hc</span><span class="op" id="3751928">.</span><span class="ident" id="3751929">mac</span><span class="op" id="3751932">.</span><span class="ident" id="3751933">Size</span><span class="op" id="3751937">(</span><span class="op" id="3751938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3751941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751945">paddingGood</span>&nbsp;<span class="op" id="3751957">:=</span>&nbsp;<span class="builtintype" id="3751960">byte</span><span class="op" id="3751964">(</span><span class="num" id="3751965">255</span><span class="op" id="3751968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751971">explicitIVLen</span>&nbsp;<span class="op" id="3751985">:=</span>&nbsp;<span class="num" id="3751988">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3751992">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752004">if</span>&nbsp;<span class="ident" id="3752007">hc</span><span class="op" id="3752009">.</span><span class="ident" id="3752010">cipher</span>&nbsp;<span class="op" id="3752017">!=</span>&nbsp;<span class="builtintype" id="3752020">nil</span>&nbsp;<span class="op" id="3752024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752028">switch</span>&nbsp;<span class="ident" id="3752035">c</span>&nbsp;<span class="op" id="3752037">:=</span>&nbsp;<span class="ident" id="3752040">hc</span><span class="op" id="3752042">.</span><span class="ident" id="3752043">cipher</span><span class="op" id="3752049">.</span><span class="op" id="3752050">(</span><span class="keyword" id="3752051">type</span><span class="op" id="3752055">)</span>&nbsp;<span class="op" id="3752057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752061">case</span>&nbsp;<span class="ident" id="3752066">cipher</span><span class="op" id="3752072">.</span><span class="ident" id="3752073">Stream</span><span class="op" id="3752079">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752084">c</span><span class="op" id="3752085">.</span><span class="ident" id="3752086">XORKeyStream</span><span class="op" id="3752098">(</span><span class="ident" id="3752099">payload</span><span class="op" id="3752106">,</span>&nbsp;<span class="ident" id="3752108">payload</span><span class="op" id="3752115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752119">case</span>&nbsp;<span class="ident" id="3752124">cipher</span><span class="op" id="3752130">.</span><span class="ident" id="3752131">AEAD</span><span class="op" id="3752135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752140">explicitIVLen</span>&nbsp;<span class="op" id="3752154">=</span>&nbsp;<span class="num" id="3752156">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752161">if</span>&nbsp;<span class="builtinfunc" id="3752164">len</span><span class="op" id="3752167">(</span><span class="ident" id="3752168">payload</span><span class="op" id="3752175">)</span>&nbsp;<span class="op" id="3752177">&lt;</span>&nbsp;<span class="ident" id="3752179">explicitIVLen</span>&nbsp;<span class="op" id="3752193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752199">return</span>&nbsp;<span class="builtintype" id="3752206">false</span><span class="op" id="3752211">,</span>&nbsp;<span class="num" id="3752213">0</span><span class="op" id="3752214">,</span>&nbsp;<span class="ident" id="3752216">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752242">nonce</span>&nbsp;<span class="op" id="3752248">:=</span>&nbsp;<span class="ident" id="3752251">payload</span><span class="op" id="3752258">[</span><span class="op" id="3752259">:</span><span class="num" id="3752260">8</span><span class="op" id="3752261">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752266">payload</span>&nbsp;<span class="op" id="3752274">=</span>&nbsp;<span class="ident" id="3752276">payload</span><span class="op" id="3752283">[</span><span class="num" id="3752284">8</span><span class="op" id="3752285">:</span><span class="op" id="3752286">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752292">var</span>&nbsp;<span class="ident" id="3752296">additionalData</span>&nbsp;<span class="op" id="3752311">[</span><span class="num" id="3752312">13</span><span class="op" id="3752314">]</span><span class="builtintype" id="3752315">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752323">copy</span><span class="op" id="3752327">(</span><span class="ident" id="3752328">additionalData</span><span class="op" id="3752342">[</span><span class="op" id="3752343">:</span><span class="op" id="3752344">]</span><span class="op" id="3752345">,</span>&nbsp;<span class="ident" id="3752347">hc</span><span class="op" id="3752349">.</span><span class="ident" id="3752350">seq</span><span class="op" id="3752353">[</span><span class="op" id="3752354">:</span><span class="op" id="3752355">]</span><span class="op" id="3752356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752361">copy</span><span class="op" id="3752365">(</span><span class="ident" id="3752366">additionalData</span><span class="op" id="3752380">[</span><span class="num" id="3752381">8</span><span class="op" id="3752382">:</span><span class="op" id="3752383">]</span><span class="op" id="3752384">,</span>&nbsp;<span class="ident" id="3752386">b</span><span class="op" id="3752387">.</span><span class="ident" id="3752388">data</span><span class="op" id="3752392">[</span><span class="op" id="3752393">:</span><span class="num" id="3752394">3</span><span class="op" id="3752395">]</span><span class="op" id="3752396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752401">n</span>&nbsp;<span class="op" id="3752403">:=</span>&nbsp;<span class="builtinfunc" id="3752406">len</span><span class="op" id="3752409">(</span><span class="ident" id="3752410">payload</span><span class="op" id="3752417">)</span>&nbsp;<span class="op" id="3752419">-</span>&nbsp;<span class="ident" id="3752421">c</span><span class="op" id="3752422">.</span><span class="ident" id="3752423">Overhead</span><span class="op" id="3752431">(</span><span class="op" id="3752432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752437">additionalData</span><span class="op" id="3752451">[</span><span class="num" id="3752452">11</span><span class="op" id="3752454">]</span>&nbsp;<span class="op" id="3752456">=</span>&nbsp;<span class="builtintype" id="3752458">byte</span><span class="op" id="3752462">(</span><span class="ident" id="3752463">n</span>&nbsp;<span class="op" id="3752465">&gt;&gt;</span>&nbsp;<span class="num" id="3752468">8</span><span class="op" id="3752469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752474">additionalData</span><span class="op" id="3752488">[</span><span class="num" id="3752489">12</span><span class="op" id="3752491">]</span>&nbsp;<span class="op" id="3752493">=</span>&nbsp;<span class="builtintype" id="3752495">byte</span><span class="op" id="3752499">(</span><span class="ident" id="3752500">n</span><span class="op" id="3752501">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752506">var</span>&nbsp;<span class="ident" id="3752510">err</span>&nbsp;<span class="builtintype" id="3752514">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752523">payload</span><span class="op" id="3752530">,</span>&nbsp;<span class="ident" id="3752532">err</span>&nbsp;<span class="op" id="3752536">=</span>&nbsp;<span class="ident" id="3752538">c</span><span class="op" id="3752539">.</span><span class="ident" id="3752540">Open</span><span class="op" id="3752544">(</span><span class="ident" id="3752545">payload</span><span class="op" id="3752552">[</span><span class="op" id="3752553">:</span><span class="num" id="3752554">0</span><span class="op" id="3752555">]</span><span class="op" id="3752556">,</span>&nbsp;<span class="ident" id="3752558">nonce</span><span class="op" id="3752563">,</span>&nbsp;<span class="ident" id="3752565">payload</span><span class="op" id="3752572">,</span>&nbsp;<span class="ident" id="3752574">additionalData</span><span class="op" id="3752588">[</span><span class="op" id="3752589">:</span><span class="op" id="3752590">]</span><span class="op" id="3752591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752596">if</span>&nbsp;<span class="ident" id="3752599">err</span>&nbsp;<span class="op" id="3752603">!=</span>&nbsp;<span class="builtintype" id="3752606">nil</span>&nbsp;<span class="op" id="3752610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752616">return</span>&nbsp;<span class="builtintype" id="3752623">false</span><span class="op" id="3752628">,</span>&nbsp;<span class="num" id="3752630">0</span><span class="op" id="3752631">,</span>&nbsp;<span class="ident" id="3752633">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752654">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752659">b</span><span class="op" id="3752660">.</span><span class="ident" id="3752661">resize</span><span class="op" id="3752667">(</span><span class="ident" id="3752668">recordHeaderLen</span>&nbsp;<span class="op" id="3752684">+</span>&nbsp;<span class="ident" id="3752686">explicitIVLen</span>&nbsp;<span class="op" id="3752700">+</span>&nbsp;<span class="builtinfunc" id="3752702">len</span><span class="op" id="3752705">(</span><span class="ident" id="3752706">payload</span><span class="op" id="3752713">)</span><span class="op" id="3752714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752718">case</span>&nbsp;<span class="ident" id="3752723">cbcMode</span><span class="op" id="3752730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752735">blockSize</span>&nbsp;<span class="op" id="3752745">:=</span>&nbsp;<span class="ident" id="3752748">c</span><span class="op" id="3752749">.</span><span class="ident" id="3752750">BlockSize</span><span class="op" id="3752759">(</span><span class="op" id="3752760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752765">if</span>&nbsp;<span class="ident" id="3752768">hc</span><span class="op" id="3752770">.</span><span class="ident" id="3752771">version</span>&nbsp;<span class="op" id="3752779">&gt;=</span>&nbsp;<span class="ident" id="3752782">VersionTLS11</span>&nbsp;<span class="op" id="3752795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752801">explicitIVLen</span>&nbsp;<span class="op" id="3752815">=</span>&nbsp;<span class="ident" id="3752817">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752836">if</span>&nbsp;<span class="builtinfunc" id="3752839">len</span><span class="op" id="3752842">(</span><span class="ident" id="3752843">payload</span><span class="op" id="3752850">)</span><span class="op" id="3752851">%</span><span class="ident" id="3752852">blockSize</span>&nbsp;<span class="op" id="3752862">!=</span>&nbsp;<span class="num" id="3752865">0</span>&nbsp;<span class="op" id="3752867">||</span>&nbsp;<span class="builtinfunc" id="3752870">len</span><span class="op" id="3752873">(</span><span class="ident" id="3752874">payload</span><span class="op" id="3752881">)</span>&nbsp;<span class="op" id="3752883">&lt;</span>&nbsp;<span class="ident" id="3752885">roundUp</span><span class="op" id="3752892">(</span><span class="ident" id="3752893">explicitIVLen</span><span class="op" id="3752906">+</span><span class="ident" id="3752907">macSize</span><span class="op" id="3752914">+</span><span class="num" id="3752915">1</span><span class="op" id="3752916">,</span>&nbsp;<span class="ident" id="3752918">blockSize</span><span class="op" id="3752927">)</span>&nbsp;<span class="op" id="3752929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752935">return</span>&nbsp;<span class="builtintype" id="3752942">false</span><span class="op" id="3752947">,</span>&nbsp;<span class="num" id="3752949">0</span><span class="op" id="3752950">,</span>&nbsp;<span class="ident" id="3752952">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752973">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752979">if</span>&nbsp;<span class="ident" id="3752982">explicitIVLen</span>&nbsp;<span class="op" id="3752996">&gt;</span>&nbsp;<span class="num" id="3752998">0</span>&nbsp;<span class="op" id="3753000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753006">c</span><span class="op" id="3753007">.</span><span class="ident" id="3753008">SetIV</span><span class="op" id="3753013">(</span><span class="ident" id="3753014">payload</span><span class="op" id="3753021">[</span><span class="op" id="3753022">:</span><span class="ident" id="3753023">explicitIVLen</span><span class="op" id="3753036">]</span><span class="op" id="3753037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753043">payload</span>&nbsp;<span class="op" id="3753051">=</span>&nbsp;<span class="ident" id="3753053">payload</span><span class="op" id="3753060">[</span><span class="ident" id="3753061">explicitIVLen</span><span class="op" id="3753074">:</span><span class="op" id="3753075">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753080">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753085">c</span><span class="op" id="3753086">.</span><span class="ident" id="3753087">CryptBlocks</span><span class="op" id="3753098">(</span><span class="ident" id="3753099">payload</span><span class="op" id="3753106">,</span>&nbsp;<span class="ident" id="3753108">payload</span><span class="op" id="3753115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3753120">if</span>&nbsp;<span class="ident" id="3753123">hc</span><span class="op" id="3753125">.</span><span class="ident" id="3753126">version</span>&nbsp;<span class="op" id="3753134">==</span>&nbsp;<span class="ident" id="3753137">VersionSSL30</span>&nbsp;<span class="op" id="3753150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753156">payload</span><span class="op" id="3753163">,</span>&nbsp;<span class="ident" id="3753165">paddingGood</span>&nbsp;<span class="op" id="3753177">=</span>&nbsp;<span class="ident" id="3753179">removePaddingSSL30</span><span class="op" id="3753197">(</span><span class="ident" id="3753198">payload</span><span class="op" id="3753205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753210">}</span>&nbsp;<span class="keyword" id="3753212">else</span>&nbsp;<span class="op" id="3753217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753223">payload</span><span class="op" id="3753230">,</span>&nbsp;<span class="ident" id="3753232">paddingGood</span>&nbsp;<span class="op" id="3753244">=</span>&nbsp;<span class="ident" id="3753246">removePadding</span><span class="op" id="3753259">(</span><span class="ident" id="3753260">payload</span><span class="op" id="3753267">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753277">b</span><span class="op" id="3753278">.</span><span class="ident" id="3753279">resize</span><span class="op" id="3753285">(</span><span class="ident" id="3753286">recordHeaderLen</span>&nbsp;<span class="op" id="3753302">+</span>&nbsp;<span class="ident" id="3753304">explicitIVLen</span>&nbsp;<span class="op" id="3753318">+</span>&nbsp;<span class="builtinfunc" id="3753320">len</span><span class="op" id="3753323">(</span><span class="ident" id="3753324">payload</span><span class="op" id="3753331">)</span><span class="op" id="3753332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753338">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753397">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753454">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753511">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753567">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753617">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753675">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753695">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753701">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753757">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3753787">default</span><span class="op" id="3753794">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3753799">panic</span><span class="op" id="3753804">(</span><span class="string" id="3753805">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3753826">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753837">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3753858">if</span>&nbsp;<span class="ident" id="3753861">hc</span><span class="op" id="3753863">.</span><span class="ident" id="3753864">mac</span>&nbsp;<span class="op" id="3753868">!=</span>&nbsp;<span class="builtintype" id="3753871">nil</span>&nbsp;<span class="op" id="3753875">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3753879">if</span>&nbsp;<span class="builtinfunc" id="3753882">len</span><span class="op" id="3753885">(</span><span class="ident" id="3753886">payload</span><span class="op" id="3753893">)</span>&nbsp;<span class="op" id="3753895">&lt;</span>&nbsp;<span class="ident" id="3753897">macSize</span>&nbsp;<span class="op" id="3753905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3753910">return</span>&nbsp;<span class="builtintype" id="3753917">false</span><span class="op" id="3753922">,</span>&nbsp;<span class="num" id="3753924">0</span><span class="op" id="3753925">,</span>&nbsp;<span class="ident" id="3753927">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3753947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3753952">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3753987">n</span>&nbsp;<span class="op" id="3753989">:=</span>&nbsp;<span class="builtinfunc" id="3753992">len</span><span class="op" id="3753995">(</span><span class="ident" id="3753996">payload</span><span class="op" id="3754003">)</span>&nbsp;<span class="op" id="3754005">-</span>&nbsp;<span class="ident" id="3754007">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754017">b</span><span class="op" id="3754018">.</span><span class="ident" id="3754019">data</span><span class="op" id="3754023">[</span><span class="num" id="3754024">3</span><span class="op" id="3754025">]</span>&nbsp;<span class="op" id="3754027">=</span>&nbsp;<span class="builtintype" id="3754029">byte</span><span class="op" id="3754033">(</span><span class="ident" id="3754034">n</span>&nbsp;<span class="op" id="3754036">&gt;&gt;</span>&nbsp;<span class="num" id="3754039">8</span><span class="op" id="3754040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754044">b</span><span class="op" id="3754045">.</span><span class="ident" id="3754046">data</span><span class="op" id="3754050">[</span><span class="num" id="3754051">4</span><span class="op" id="3754052">]</span>&nbsp;<span class="op" id="3754054">=</span>&nbsp;<span class="builtintype" id="3754056">byte</span><span class="op" id="3754060">(</span><span class="ident" id="3754061">n</span><span class="op" id="3754062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754066">b</span><span class="op" id="3754067">.</span><span class="ident" id="3754068">resize</span><span class="op" id="3754074">(</span><span class="ident" id="3754075">recordHeaderLen</span>&nbsp;<span class="op" id="3754091">+</span>&nbsp;<span class="ident" id="3754093">explicitIVLen</span>&nbsp;<span class="op" id="3754107">+</span>&nbsp;<span class="ident" id="3754109">n</span><span class="op" id="3754110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754114">remoteMAC</span>&nbsp;<span class="op" id="3754124">:=</span>&nbsp;<span class="ident" id="3754127">payload</span><span class="op" id="3754134">[</span><span class="ident" id="3754135">n</span><span class="op" id="3754136">:</span><span class="op" id="3754137">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754141">localMAC</span>&nbsp;<span class="op" id="3754150">:=</span>&nbsp;<span class="ident" id="3754153">hc</span><span class="op" id="3754155">.</span><span class="ident" id="3754156">mac</span><span class="op" id="3754159">.</span><span class="ident" id="3754160">MAC</span><span class="op" id="3754163">(</span><span class="ident" id="3754164">hc</span><span class="op" id="3754166">.</span><span class="ident" id="3754167">inDigestBuf</span><span class="op" id="3754178">,</span>&nbsp;<span class="ident" id="3754180">hc</span><span class="op" id="3754182">.</span><span class="ident" id="3754183">seq</span><span class="op" id="3754186">[</span><span class="num" id="3754187">0</span><span class="op" id="3754188">:</span><span class="op" id="3754189">]</span><span class="op" id="3754190">,</span>&nbsp;<span class="ident" id="3754192">b</span><span class="op" id="3754193">.</span><span class="ident" id="3754194">data</span><span class="op" id="3754198">[</span><span class="op" id="3754199">:</span><span class="ident" id="3754200">recordHeaderLen</span><span class="op" id="3754215">]</span><span class="op" id="3754216">,</span>&nbsp;<span class="ident" id="3754218">payload</span><span class="op" id="3754225">[</span><span class="op" id="3754226">:</span><span class="ident" id="3754227">n</span><span class="op" id="3754228">]</span><span class="op" id="3754229">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3754234">if</span>&nbsp;<span class="ident" id="3754237">subtle</span><span class="op" id="3754243">.</span><span class="ident" id="3754244">ConstantTimeCompare</span><span class="op" id="3754263">(</span><span class="ident" id="3754264">localMAC</span><span class="op" id="3754272">,</span>&nbsp;<span class="ident" id="3754274">remoteMAC</span><span class="op" id="3754283">)</span>&nbsp;<span class="op" id="3754285">!=</span>&nbsp;<span class="num" id="3754288">1</span>&nbsp;<span class="op" id="3754290">||</span>&nbsp;<span class="ident" id="3754293">paddingGood</span>&nbsp;<span class="op" id="3754305">!=</span>&nbsp;<span class="num" id="3754308">255</span>&nbsp;<span class="op" id="3754312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3754317">return</span>&nbsp;<span class="builtintype" id="3754324">false</span><span class="op" id="3754329">,</span>&nbsp;<span class="num" id="3754331">0</span><span class="op" id="3754332">,</span>&nbsp;<span class="ident" id="3754334">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3754354">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754358">hc</span><span class="op" id="3754360">.</span><span class="ident" id="3754361">inDigestBuf</span>&nbsp;<span class="op" id="3754373">=</span>&nbsp;<span class="ident" id="3754375">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3754385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754388">hc</span><span class="op" id="3754390">.</span><span class="ident" id="3754391">incSeq</span><span class="op" id="3754397">(</span><span class="op" id="3754398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3754402">return</span>&nbsp;<span class="builtintype" id="3754409">true</span><span class="op" id="3754413">,</span>&nbsp;<span class="ident" id="3754415">recordHeaderLen</span>&nbsp;<span class="op" id="3754431">+</span>&nbsp;<span class="ident" id="3754433">explicitIVLen</span><span class="op" id="3754446">,</span>&nbsp;<span class="num" id="3754448">0</span><br>
<span class="lineno">335</span><span class="op" id="3754450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3754453">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3754531">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3754606">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3754686">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3754762">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3754777">func</span>&nbsp;<span class="ident" id="3754782">padToBlockSize</span><span class="op" id="3754796">(</span><span class="ident" id="3754797">payload</span>&nbsp;<span class="op" id="3754805">[</span><span class="op" id="3754806">]</span><span class="builtintype" id="3754807">byte</span><span class="op" id="3754811">,</span>&nbsp;<span class="ident" id="3754813">blockSize</span>&nbsp;<span class="builtintype" id="3754823">int</span><span class="op" id="3754826">)</span>&nbsp;<span class="op" id="3754828">(</span><span class="ident" id="3754829">prefix</span><span class="op" id="3754835">,</span>&nbsp;<span class="ident" id="3754837">finalBlock</span>&nbsp;<span class="op" id="3754848">[</span><span class="op" id="3754849">]</span><span class="builtintype" id="3754850">byte</span><span class="op" id="3754854">)</span>&nbsp;<span class="op" id="3754856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754859">overrun</span>&nbsp;<span class="op" id="3754867">:=</span>&nbsp;<span class="builtinfunc" id="3754870">len</span><span class="op" id="3754873">(</span><span class="ident" id="3754874">payload</span><span class="op" id="3754881">)</span>&nbsp;<span class="op" id="3754883">%</span>&nbsp;<span class="ident" id="3754885">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754896">paddingLen</span>&nbsp;<span class="op" id="3754907">:=</span>&nbsp;<span class="ident" id="3754910">blockSize</span>&nbsp;<span class="op" id="3754920">-</span>&nbsp;<span class="ident" id="3754922">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754931">prefix</span>&nbsp;<span class="op" id="3754938">=</span>&nbsp;<span class="ident" id="3754940">payload</span><span class="op" id="3754947">[</span><span class="op" id="3754948">:</span><span class="builtinfunc" id="3754949">len</span><span class="op" id="3754952">(</span><span class="ident" id="3754953">payload</span><span class="op" id="3754960">)</span><span class="op" id="3754961">-</span><span class="ident" id="3754962">overrun</span><span class="op" id="3754969">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754972">finalBlock</span>&nbsp;<span class="op" id="3754983">=</span>&nbsp;<span class="builtinfunc" id="3754985">make</span><span class="op" id="3754989">(</span><span class="op" id="3754990">[</span><span class="op" id="3754991">]</span><span class="builtintype" id="3754992">byte</span><span class="op" id="3754996">,</span>&nbsp;<span class="ident" id="3754998">blockSize</span><span class="op" id="3755007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3755010">copy</span><span class="op" id="3755014">(</span><span class="ident" id="3755015">finalBlock</span><span class="op" id="3755025">,</span>&nbsp;<span class="ident" id="3755027">payload</span><span class="op" id="3755034">[</span><span class="builtinfunc" id="3755035">len</span><span class="op" id="3755038">(</span><span class="ident" id="3755039">payload</span><span class="op" id="3755046">)</span><span class="op" id="3755047">-</span><span class="ident" id="3755048">overrun</span><span class="op" id="3755055">:</span><span class="op" id="3755056">]</span><span class="op" id="3755057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755060">for</span>&nbsp;<span class="ident" id="3755064">i</span>&nbsp;<span class="op" id="3755066">:=</span>&nbsp;<span class="ident" id="3755069">overrun</span><span class="op" id="3755076">;</span>&nbsp;<span class="ident" id="3755078">i</span>&nbsp;<span class="op" id="3755080">&lt;</span>&nbsp;<span class="ident" id="3755082">blockSize</span><span class="op" id="3755091">;</span>&nbsp;<span class="ident" id="3755093">i</span><span class="op" id="3755094">++</span>&nbsp;<span class="op" id="3755097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755101">finalBlock</span><span class="op" id="3755111">[</span><span class="ident" id="3755112">i</span><span class="op" id="3755113">]</span>&nbsp;<span class="op" id="3755115">=</span>&nbsp;<span class="builtintype" id="3755117">byte</span><span class="op" id="3755121">(</span><span class="ident" id="3755122">paddingLen</span>&nbsp;<span class="op" id="3755133">-</span>&nbsp;<span class="num" id="3755135">1</span><span class="op" id="3755136">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3755139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755142">return</span><br>
<span class="lineno"></span><span class="op" id="3755149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3755152">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3755196">func</span>&nbsp;<span class="op" id="3755201">(</span><span class="ident" id="3755202">hc</span>&nbsp;<span class="op" id="3755205">*</span><span class="ident" id="3755206">halfConn</span><span class="op" id="3755214">)</span>&nbsp;<span class="ident" id="3755216">encrypt</span><span class="op" id="3755223">(</span><span class="ident" id="3755224">b</span>&nbsp;<span class="op" id="3755226">*</span><span class="ident" id="3755227">block</span><span class="op" id="3755232">,</span>&nbsp;<span class="ident" id="3755234">explicitIVLen</span>&nbsp;<span class="builtintype" id="3755248">int</span><span class="op" id="3755251">)</span>&nbsp;<span class="op" id="3755253">(</span><span class="builtintype" id="3755254">bool</span><span class="op" id="3755258">,</span>&nbsp;<span class="ident" id="3755260">alert</span><span class="op" id="3755265">)</span>&nbsp;<span class="op" id="3755267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3755270">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755278">if</span>&nbsp;<span class="ident" id="3755281">hc</span><span class="op" id="3755283">.</span><span class="ident" id="3755284">mac</span>&nbsp;<span class="op" id="3755288">!=</span>&nbsp;<span class="builtintype" id="3755291">nil</span>&nbsp;<span class="op" id="3755295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755299">mac</span>&nbsp;<span class="op" id="3755303">:=</span>&nbsp;<span class="ident" id="3755306">hc</span><span class="op" id="3755308">.</span><span class="ident" id="3755309">mac</span><span class="op" id="3755312">.</span><span class="ident" id="3755313">MAC</span><span class="op" id="3755316">(</span><span class="ident" id="3755317">hc</span><span class="op" id="3755319">.</span><span class="ident" id="3755320">outDigestBuf</span><span class="op" id="3755332">,</span>&nbsp;<span class="ident" id="3755334">hc</span><span class="op" id="3755336">.</span><span class="ident" id="3755337">seq</span><span class="op" id="3755340">[</span><span class="num" id="3755341">0</span><span class="op" id="3755342">:</span><span class="op" id="3755343">]</span><span class="op" id="3755344">,</span>&nbsp;<span class="ident" id="3755346">b</span><span class="op" id="3755347">.</span><span class="ident" id="3755348">data</span><span class="op" id="3755352">[</span><span class="op" id="3755353">:</span><span class="ident" id="3755354">recordHeaderLen</span><span class="op" id="3755369">]</span><span class="op" id="3755370">,</span>&nbsp;<span class="ident" id="3755372">b</span><span class="op" id="3755373">.</span><span class="ident" id="3755374">data</span><span class="op" id="3755378">[</span><span class="ident" id="3755379">recordHeaderLen</span><span class="op" id="3755394">+</span><span class="ident" id="3755395">explicitIVLen</span><span class="op" id="3755408">:</span><span class="op" id="3755409">]</span><span class="op" id="3755410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755415">n</span>&nbsp;<span class="op" id="3755417">:=</span>&nbsp;<span class="builtinfunc" id="3755420">len</span><span class="op" id="3755423">(</span><span class="ident" id="3755424">b</span><span class="op" id="3755425">.</span><span class="ident" id="3755426">data</span><span class="op" id="3755430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755434">b</span><span class="op" id="3755435">.</span><span class="ident" id="3755436">resize</span><span class="op" id="3755442">(</span><span class="ident" id="3755443">n</span>&nbsp;<span class="op" id="3755445">+</span>&nbsp;<span class="builtinfunc" id="3755447">len</span><span class="op" id="3755450">(</span><span class="ident" id="3755451">mac</span><span class="op" id="3755454">)</span><span class="op" id="3755455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3755459">copy</span><span class="op" id="3755463">(</span><span class="ident" id="3755464">b</span><span class="op" id="3755465">.</span><span class="ident" id="3755466">data</span><span class="op" id="3755470">[</span><span class="ident" id="3755471">n</span><span class="op" id="3755472">:</span><span class="op" id="3755473">]</span><span class="op" id="3755474">,</span>&nbsp;<span class="ident" id="3755476">mac</span><span class="op" id="3755479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755483">hc</span><span class="op" id="3755485">.</span><span class="ident" id="3755486">outDigestBuf</span>&nbsp;<span class="op" id="3755499">=</span>&nbsp;<span class="ident" id="3755501">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3755506">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755510">payload</span>&nbsp;<span class="op" id="3755518">:=</span>&nbsp;<span class="ident" id="3755521">b</span><span class="op" id="3755522">.</span><span class="ident" id="3755523">data</span><span class="op" id="3755527">[</span><span class="ident" id="3755528">recordHeaderLen</span><span class="op" id="3755543">:</span><span class="op" id="3755544">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3755548">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755560">if</span>&nbsp;<span class="ident" id="3755563">hc</span><span class="op" id="3755565">.</span><span class="ident" id="3755566">cipher</span>&nbsp;<span class="op" id="3755573">!=</span>&nbsp;<span class="builtintype" id="3755576">nil</span>&nbsp;<span class="op" id="3755580">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755584">switch</span>&nbsp;<span class="ident" id="3755591">c</span>&nbsp;<span class="op" id="3755593">:=</span>&nbsp;<span class="ident" id="3755596">hc</span><span class="op" id="3755598">.</span><span class="ident" id="3755599">cipher</span><span class="op" id="3755605">.</span><span class="op" id="3755606">(</span><span class="keyword" id="3755607">type</span><span class="op" id="3755611">)</span>&nbsp;<span class="op" id="3755613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755617">case</span>&nbsp;<span class="ident" id="3755622">cipher</span><span class="op" id="3755628">.</span><span class="ident" id="3755629">Stream</span><span class="op" id="3755635">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755640">c</span><span class="op" id="3755641">.</span><span class="ident" id="3755642">XORKeyStream</span><span class="op" id="3755654">(</span><span class="ident" id="3755655">payload</span><span class="op" id="3755662">,</span>&nbsp;<span class="ident" id="3755664">payload</span><span class="op" id="3755671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755675">case</span>&nbsp;<span class="ident" id="3755680">cipher</span><span class="op" id="3755686">.</span><span class="ident" id="3755687">AEAD</span><span class="op" id="3755691">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755696">payloadLen</span>&nbsp;<span class="op" id="3755707">:=</span>&nbsp;<span class="builtinfunc" id="3755710">len</span><span class="op" id="3755713">(</span><span class="ident" id="3755714">b</span><span class="op" id="3755715">.</span><span class="ident" id="3755716">data</span><span class="op" id="3755720">)</span>&nbsp;<span class="op" id="3755722">-</span>&nbsp;<span class="ident" id="3755724">recordHeaderLen</span>&nbsp;<span class="op" id="3755740">-</span>&nbsp;<span class="ident" id="3755742">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755759">b</span><span class="op" id="3755760">.</span><span class="ident" id="3755761">resize</span><span class="op" id="3755767">(</span><span class="builtinfunc" id="3755768">len</span><span class="op" id="3755771">(</span><span class="ident" id="3755772">b</span><span class="op" id="3755773">.</span><span class="ident" id="3755774">data</span><span class="op" id="3755778">)</span>&nbsp;<span class="op" id="3755780">+</span>&nbsp;<span class="ident" id="3755782">c</span><span class="op" id="3755783">.</span><span class="ident" id="3755784">Overhead</span><span class="op" id="3755792">(</span><span class="op" id="3755793">)</span><span class="op" id="3755794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755799">nonce</span>&nbsp;<span class="op" id="3755805">:=</span>&nbsp;<span class="ident" id="3755808">b</span><span class="op" id="3755809">.</span><span class="ident" id="3755810">data</span><span class="op" id="3755814">[</span><span class="ident" id="3755815">recordHeaderLen</span>&nbsp;<span class="op" id="3755831">:</span>&nbsp;<span class="ident" id="3755833">recordHeaderLen</span><span class="op" id="3755848">+</span><span class="ident" id="3755849">explicitIVLen</span><span class="op" id="3755862">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755867">payload</span>&nbsp;<span class="op" id="3755875">:=</span>&nbsp;<span class="ident" id="3755878">b</span><span class="op" id="3755879">.</span><span class="ident" id="3755880">data</span><span class="op" id="3755884">[</span><span class="ident" id="3755885">recordHeaderLen</span><span class="op" id="3755900">+</span><span class="ident" id="3755901">explicitIVLen</span><span class="op" id="3755914">:</span><span class="op" id="3755915">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3755920">payload</span>&nbsp;<span class="op" id="3755928">=</span>&nbsp;<span class="ident" id="3755930">payload</span><span class="op" id="3755937">[</span><span class="op" id="3755938">:</span><span class="ident" id="3755939">payloadLen</span><span class="op" id="3755949">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3755955">var</span>&nbsp;<span class="ident" id="3755959">additionalData</span>&nbsp;<span class="op" id="3755974">[</span><span class="num" id="3755975">13</span><span class="op" id="3755977">]</span><span class="builtintype" id="3755978">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3755986">copy</span><span class="op" id="3755990">(</span><span class="ident" id="3755991">additionalData</span><span class="op" id="3756005">[</span><span class="op" id="3756006">:</span><span class="op" id="3756007">]</span><span class="op" id="3756008">,</span>&nbsp;<span class="ident" id="3756010">hc</span><span class="op" id="3756012">.</span><span class="ident" id="3756013">seq</span><span class="op" id="3756016">[</span><span class="op" id="3756017">:</span><span class="op" id="3756018">]</span><span class="op" id="3756019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3756024">copy</span><span class="op" id="3756028">(</span><span class="ident" id="3756029">additionalData</span><span class="op" id="3756043">[</span><span class="num" id="3756044">8</span><span class="op" id="3756045">:</span><span class="op" id="3756046">]</span><span class="op" id="3756047">,</span>&nbsp;<span class="ident" id="3756049">b</span><span class="op" id="3756050">.</span><span class="ident" id="3756051">data</span><span class="op" id="3756055">[</span><span class="op" id="3756056">:</span><span class="num" id="3756057">3</span><span class="op" id="3756058">]</span><span class="op" id="3756059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756064">additionalData</span><span class="op" id="3756078">[</span><span class="num" id="3756079">11</span><span class="op" id="3756081">]</span>&nbsp;<span class="op" id="3756083">=</span>&nbsp;<span class="builtintype" id="3756085">byte</span><span class="op" id="3756089">(</span><span class="ident" id="3756090">payloadLen</span>&nbsp;<span class="op" id="3756101">&gt;&gt;</span>&nbsp;<span class="num" id="3756104">8</span><span class="op" id="3756105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756110">additionalData</span><span class="op" id="3756124">[</span><span class="num" id="3756125">12</span><span class="op" id="3756127">]</span>&nbsp;<span class="op" id="3756129">=</span>&nbsp;<span class="builtintype" id="3756131">byte</span><span class="op" id="3756135">(</span><span class="ident" id="3756136">payloadLen</span><span class="op" id="3756146">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756152">c</span><span class="op" id="3756153">.</span><span class="ident" id="3756154">Seal</span><span class="op" id="3756158">(</span><span class="ident" id="3756159">payload</span><span class="op" id="3756166">[</span><span class="op" id="3756167">:</span><span class="num" id="3756168">0</span><span class="op" id="3756169">]</span><span class="op" id="3756170">,</span>&nbsp;<span class="ident" id="3756172">nonce</span><span class="op" id="3756177">,</span>&nbsp;<span class="ident" id="3756179">payload</span><span class="op" id="3756186">,</span>&nbsp;<span class="ident" id="3756188">additionalData</span><span class="op" id="3756202">[</span><span class="op" id="3756203">:</span><span class="op" id="3756204">]</span><span class="op" id="3756205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3756209">case</span>&nbsp;<span class="ident" id="3756214">cbcMode</span><span class="op" id="3756221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756226">blockSize</span>&nbsp;<span class="op" id="3756236">:=</span>&nbsp;<span class="ident" id="3756239">c</span><span class="op" id="3756240">.</span><span class="ident" id="3756241">BlockSize</span><span class="op" id="3756250">(</span><span class="op" id="3756251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3756256">if</span>&nbsp;<span class="ident" id="3756259">explicitIVLen</span>&nbsp;<span class="op" id="3756273">&gt;</span>&nbsp;<span class="num" id="3756275">0</span>&nbsp;<span class="op" id="3756277">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756283">c</span><span class="op" id="3756284">.</span><span class="ident" id="3756285">SetIV</span><span class="op" id="3756290">(</span><span class="ident" id="3756291">payload</span><span class="op" id="3756298">[</span><span class="op" id="3756299">:</span><span class="ident" id="3756300">explicitIVLen</span><span class="op" id="3756313">]</span><span class="op" id="3756314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756320">payload</span>&nbsp;<span class="op" id="3756328">=</span>&nbsp;<span class="ident" id="3756330">payload</span><span class="op" id="3756337">[</span><span class="ident" id="3756338">explicitIVLen</span><span class="op" id="3756351">:</span><span class="op" id="3756352">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3756357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756362">prefix</span><span class="op" id="3756368">,</span>&nbsp;<span class="ident" id="3756370">finalBlock</span>&nbsp;<span class="op" id="3756381">:=</span>&nbsp;<span class="ident" id="3756384">padToBlockSize</span><span class="op" id="3756398">(</span><span class="ident" id="3756399">payload</span><span class="op" id="3756406">,</span>&nbsp;<span class="ident" id="3756408">blockSize</span><span class="op" id="3756417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756422">b</span><span class="op" id="3756423">.</span><span class="ident" id="3756424">resize</span><span class="op" id="3756430">(</span><span class="ident" id="3756431">recordHeaderLen</span>&nbsp;<span class="op" id="3756447">+</span>&nbsp;<span class="ident" id="3756449">explicitIVLen</span>&nbsp;<span class="op" id="3756463">+</span>&nbsp;<span class="builtinfunc" id="3756465">len</span><span class="op" id="3756468">(</span><span class="ident" id="3756469">prefix</span><span class="op" id="3756475">)</span>&nbsp;<span class="op" id="3756477">+</span>&nbsp;<span class="builtinfunc" id="3756479">len</span><span class="op" id="3756482">(</span><span class="ident" id="3756483">finalBlock</span><span class="op" id="3756493">)</span><span class="op" id="3756494">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756499">c</span><span class="op" id="3756500">.</span><span class="ident" id="3756501">CryptBlocks</span><span class="op" id="3756512">(</span><span class="ident" id="3756513">b</span><span class="op" id="3756514">.</span><span class="ident" id="3756515">data</span><span class="op" id="3756519">[</span><span class="ident" id="3756520">recordHeaderLen</span><span class="op" id="3756535">+</span><span class="ident" id="3756536">explicitIVLen</span><span class="op" id="3756549">:</span><span class="op" id="3756550">]</span><span class="op" id="3756551">,</span>&nbsp;<span class="ident" id="3756553">prefix</span><span class="op" id="3756559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756564">c</span><span class="op" id="3756565">.</span><span class="ident" id="3756566">CryptBlocks</span><span class="op" id="3756577">(</span><span class="ident" id="3756578">b</span><span class="op" id="3756579">.</span><span class="ident" id="3756580">data</span><span class="op" id="3756584">[</span><span class="ident" id="3756585">recordHeaderLen</span><span class="op" id="3756600">+</span><span class="ident" id="3756601">explicitIVLen</span><span class="op" id="3756614">+</span><span class="builtinfunc" id="3756615">len</span><span class="op" id="3756618">(</span><span class="ident" id="3756619">prefix</span><span class="op" id="3756625">)</span><span class="op" id="3756626">:</span><span class="op" id="3756627">]</span><span class="op" id="3756628">,</span>&nbsp;<span class="ident" id="3756630">finalBlock</span><span class="op" id="3756640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3756644">default</span><span class="op" id="3756651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3756656">panic</span><span class="op" id="3756661">(</span><span class="string" id="3756662">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3756683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3756687">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3756690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3756694">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756757">n</span>&nbsp;<span class="op" id="3756759">:=</span>&nbsp;<span class="builtinfunc" id="3756762">len</span><span class="op" id="3756765">(</span><span class="ident" id="3756766">b</span><span class="op" id="3756767">.</span><span class="ident" id="3756768">data</span><span class="op" id="3756772">)</span>&nbsp;<span class="op" id="3756774">-</span>&nbsp;<span class="ident" id="3756776">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756793">b</span><span class="op" id="3756794">.</span><span class="ident" id="3756795">data</span><span class="op" id="3756799">[</span><span class="num" id="3756800">3</span><span class="op" id="3756801">]</span>&nbsp;<span class="op" id="3756803">=</span>&nbsp;<span class="builtintype" id="3756805">byte</span><span class="op" id="3756809">(</span><span class="ident" id="3756810">n</span>&nbsp;<span class="op" id="3756812">&gt;&gt;</span>&nbsp;<span class="num" id="3756815">8</span><span class="op" id="3756816">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756819">b</span><span class="op" id="3756820">.</span><span class="ident" id="3756821">data</span><span class="op" id="3756825">[</span><span class="num" id="3756826">4</span><span class="op" id="3756827">]</span>&nbsp;<span class="op" id="3756829">=</span>&nbsp;<span class="builtintype" id="3756831">byte</span><span class="op" id="3756835">(</span><span class="ident" id="3756836">n</span><span class="op" id="3756837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756840">hc</span><span class="op" id="3756842">.</span><span class="ident" id="3756843">incSeq</span><span class="op" id="3756849">(</span><span class="op" id="3756850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3756854">return</span>&nbsp;<span class="builtintype" id="3756861">true</span><span class="op" id="3756865">,</span>&nbsp;<span class="num" id="3756867">0</span><br>
<span class="lineno"></span><span class="op" id="3756869">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3756872">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3756908">type</span>&nbsp;<span class="ident" id="3756913">block</span>&nbsp;<span class="keyword" id="3756919">struct</span>&nbsp;<span class="op" id="3756926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756929">data</span>&nbsp;<span class="op" id="3756934">[</span><span class="op" id="3756935">]</span><span class="builtintype" id="3756936">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756942">off</span>&nbsp;&nbsp;<span class="builtintype" id="3756947">int</span>&nbsp;<span class="comment" id="3756951">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3756970">link</span>&nbsp;<span class="op" id="3756975">*</span><span class="ident" id="3756976">block</span><br>
<span class="lineno"></span><span class="op" id="3756982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3756985">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3757046">func</span>&nbsp;<span class="op" id="3757051">(</span><span class="ident" id="3757052">b</span>&nbsp;<span class="op" id="3757054">*</span><span class="ident" id="3757055">block</span><span class="op" id="3757060">)</span>&nbsp;<span class="ident" id="3757062">resize</span><span class="op" id="3757068">(</span><span class="ident" id="3757069">n</span>&nbsp;<span class="builtintype" id="3757071">int</span><span class="op" id="3757074">)</span>&nbsp;<span class="op" id="3757076">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757079">if</span>&nbsp;<span class="ident" id="3757082">n</span>&nbsp;<span class="op" id="3757084">&gt;</span>&nbsp;<span class="builtinfunc" id="3757086">cap</span><span class="op" id="3757089">(</span><span class="ident" id="3757090">b</span><span class="op" id="3757091">.</span><span class="ident" id="3757092">data</span><span class="op" id="3757096">)</span>&nbsp;<span class="op" id="3757098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757102">b</span><span class="op" id="3757103">.</span><span class="ident" id="3757104">reserve</span><span class="op" id="3757111">(</span><span class="ident" id="3757112">n</span><span class="op" id="3757113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757119">b</span><span class="op" id="3757120">.</span><span class="ident" id="3757121">data</span>&nbsp;<span class="op" id="3757126">=</span>&nbsp;<span class="ident" id="3757128">b</span><span class="op" id="3757129">.</span><span class="ident" id="3757130">data</span><span class="op" id="3757134">[</span><span class="num" id="3757135">0</span><span class="op" id="3757136">:</span><span class="ident" id="3757137">n</span><span class="op" id="3757138">]</span><br>
<span class="lineno"></span><span class="op" id="3757140">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3757143">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3757217">func</span>&nbsp;<span class="op" id="3757222">(</span><span class="ident" id="3757223">b</span>&nbsp;<span class="op" id="3757225">*</span><span class="ident" id="3757226">block</span><span class="op" id="3757231">)</span>&nbsp;<span class="ident" id="3757233">reserve</span><span class="op" id="3757240">(</span><span class="ident" id="3757241">n</span>&nbsp;<span class="builtintype" id="3757243">int</span><span class="op" id="3757246">)</span>&nbsp;<span class="op" id="3757248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757251">if</span>&nbsp;<span class="builtinfunc" id="3757254">cap</span><span class="op" id="3757257">(</span><span class="ident" id="3757258">b</span><span class="op" id="3757259">.</span><span class="ident" id="3757260">data</span><span class="op" id="3757264">)</span>&nbsp;<span class="op" id="3757266">&gt;=</span>&nbsp;<span class="ident" id="3757269">n</span>&nbsp;<span class="op" id="3757271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757275">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757286">m</span>&nbsp;<span class="op" id="3757288">:=</span>&nbsp;<span class="builtinfunc" id="3757291">cap</span><span class="op" id="3757294">(</span><span class="ident" id="3757295">b</span><span class="op" id="3757296">.</span><span class="ident" id="3757297">data</span><span class="op" id="3757301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757304">if</span>&nbsp;<span class="ident" id="3757307">m</span>&nbsp;<span class="op" id="3757309">==</span>&nbsp;<span class="num" id="3757312">0</span>&nbsp;<span class="op" id="3757314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757318">m</span>&nbsp;<span class="op" id="3757320">=</span>&nbsp;<span class="num" id="3757322">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757328">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757331">for</span>&nbsp;<span class="ident" id="3757335">m</span>&nbsp;<span class="op" id="3757337">&lt;</span>&nbsp;<span class="ident" id="3757339">n</span>&nbsp;<span class="op" id="3757341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757345">m</span>&nbsp;<span class="op" id="3757347">*=</span>&nbsp;<span class="num" id="3757350">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757356">data</span>&nbsp;<span class="op" id="3757361">:=</span>&nbsp;<span class="builtinfunc" id="3757364">make</span><span class="op" id="3757368">(</span><span class="op" id="3757369">[</span><span class="op" id="3757370">]</span><span class="builtintype" id="3757371">byte</span><span class="op" id="3757375">,</span>&nbsp;<span class="builtinfunc" id="3757377">len</span><span class="op" id="3757380">(</span><span class="ident" id="3757381">b</span><span class="op" id="3757382">.</span><span class="ident" id="3757383">data</span><span class="op" id="3757387">)</span><span class="op" id="3757388">,</span>&nbsp;<span class="ident" id="3757390">m</span><span class="op" id="3757391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3757394">copy</span><span class="op" id="3757398">(</span><span class="ident" id="3757399">data</span><span class="op" id="3757403">,</span>&nbsp;<span class="ident" id="3757405">b</span><span class="op" id="3757406">.</span><span class="ident" id="3757407">data</span><span class="op" id="3757411">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757414">b</span><span class="op" id="3757415">.</span><span class="ident" id="3757416">data</span>&nbsp;<span class="op" id="3757421">=</span>&nbsp;<span class="ident" id="3757423">data</span><br>
<span class="lineno"></span><span class="op" id="3757428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3757431">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3757502">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3757531">func</span>&nbsp;<span class="op" id="3757536">(</span><span class="ident" id="3757537">b</span>&nbsp;<span class="op" id="3757539">*</span><span class="ident" id="3757540">block</span><span class="op" id="3757545">)</span>&nbsp;<span class="ident" id="3757547">readFromUntil</span><span class="op" id="3757560">(</span><span class="ident" id="3757561">r</span>&nbsp;<span class="ident" id="3757563">io</span><span class="op" id="3757565">.</span><span class="ident" id="3757566">Reader</span><span class="op" id="3757572">,</span>&nbsp;<span class="ident" id="3757574">n</span>&nbsp;<span class="builtintype" id="3757576">int</span><span class="op" id="3757579">)</span>&nbsp;<span class="builtintype" id="3757581">error</span>&nbsp;<span class="op" id="3757587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3757590">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757605">if</span>&nbsp;<span class="builtinfunc" id="3757608">len</span><span class="op" id="3757611">(</span><span class="ident" id="3757612">b</span><span class="op" id="3757613">.</span><span class="ident" id="3757614">data</span><span class="op" id="3757618">)</span>&nbsp;<span class="op" id="3757620">&gt;=</span>&nbsp;<span class="ident" id="3757623">n</span>&nbsp;<span class="op" id="3757625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757629">return</span>&nbsp;<span class="builtintype" id="3757636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757641">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3757645">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757673">b</span><span class="op" id="3757674">.</span><span class="ident" id="3757675">reserve</span><span class="op" id="3757682">(</span><span class="ident" id="3757683">n</span><span class="op" id="3757684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757687">for</span>&nbsp;<span class="op" id="3757691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757695">m</span><span class="op" id="3757696">,</span>&nbsp;<span class="ident" id="3757698">err</span>&nbsp;<span class="op" id="3757702">:=</span>&nbsp;<span class="ident" id="3757705">r</span><span class="op" id="3757706">.</span><span class="ident" id="3757707">Read</span><span class="op" id="3757711">(</span><span class="ident" id="3757712">b</span><span class="op" id="3757713">.</span><span class="ident" id="3757714">data</span><span class="op" id="3757718">[</span><span class="builtinfunc" id="3757719">len</span><span class="op" id="3757722">(</span><span class="ident" id="3757723">b</span><span class="op" id="3757724">.</span><span class="ident" id="3757725">data</span><span class="op" id="3757729">)</span><span class="op" id="3757730">:</span><span class="builtinfunc" id="3757731">cap</span><span class="op" id="3757734">(</span><span class="ident" id="3757735">b</span><span class="op" id="3757736">.</span><span class="ident" id="3757737">data</span><span class="op" id="3757741">)</span><span class="op" id="3757742">]</span><span class="op" id="3757743">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3757747">b</span><span class="op" id="3757748">.</span><span class="ident" id="3757749">data</span>&nbsp;<span class="op" id="3757754">=</span>&nbsp;<span class="ident" id="3757756">b</span><span class="op" id="3757757">.</span><span class="ident" id="3757758">data</span><span class="op" id="3757762">[</span><span class="num" id="3757763">0</span>&nbsp;<span class="op" id="3757765">:</span>&nbsp;<span class="builtinfunc" id="3757767">len</span><span class="op" id="3757770">(</span><span class="ident" id="3757771">b</span><span class="op" id="3757772">.</span><span class="ident" id="3757773">data</span><span class="op" id="3757777">)</span><span class="op" id="3757778">+</span><span class="ident" id="3757779">m</span><span class="op" id="3757780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757784">if</span>&nbsp;<span class="builtinfunc" id="3757787">len</span><span class="op" id="3757790">(</span><span class="ident" id="3757791">b</span><span class="op" id="3757792">.</span><span class="ident" id="3757793">data</span><span class="op" id="3757797">)</span>&nbsp;<span class="op" id="3757799">&gt;=</span>&nbsp;<span class="ident" id="3757802">n</span>&nbsp;<span class="op" id="3757804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3757809">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3757855">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757905">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757917">if</span>&nbsp;<span class="ident" id="3757920">err</span>&nbsp;<span class="op" id="3757924">!=</span>&nbsp;<span class="builtintype" id="3757927">nil</span>&nbsp;<span class="op" id="3757931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757936">return</span>&nbsp;<span class="ident" id="3757943">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3757952">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3757955">return</span>&nbsp;<span class="builtintype" id="3757962">nil</span><br>
<span class="lineno"></span><span class="op" id="3757966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3757969">func</span>&nbsp;<span class="op" id="3757974">(</span><span class="ident" id="3757975">b</span>&nbsp;<span class="op" id="3757977">*</span><span class="ident" id="3757978">block</span><span class="op" id="3757983">)</span>&nbsp;<span class="ident" id="3757985">Read</span><span class="op" id="3757989">(</span><span class="ident" id="3757990">p</span>&nbsp;<span class="op" id="3757992">[</span><span class="op" id="3757993">]</span><span class="builtintype" id="3757994">byte</span><span class="op" id="3757998">)</span>&nbsp;<span class="op" id="3758000">(</span><span class="ident" id="3758001">n</span>&nbsp;<span class="builtintype" id="3758003">int</span><span class="op" id="3758006">,</span>&nbsp;<span class="ident" id="3758008">err</span>&nbsp;<span class="builtintype" id="3758012">error</span><span class="op" id="3758017">)</span>&nbsp;<span class="op" id="3758019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758022">n</span>&nbsp;<span class="op" id="3758024">=</span>&nbsp;<span class="builtinfunc" id="3758026">copy</span><span class="op" id="3758030">(</span><span class="ident" id="3758031">p</span><span class="op" id="3758032">,</span>&nbsp;<span class="ident" id="3758034">b</span><span class="op" id="3758035">.</span><span class="ident" id="3758036">data</span><span class="op" id="3758040">[</span><span class="ident" id="3758041">b</span><span class="op" id="3758042">.</span><span class="ident" id="3758043">off</span><span class="op" id="3758046">:</span><span class="op" id="3758047">]</span><span class="op" id="3758048">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758051">b</span><span class="op" id="3758052">.</span><span class="ident" id="3758053">off</span>&nbsp;<span class="op" id="3758057">+=</span>&nbsp;<span class="ident" id="3758060">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758063">return</span><br>
<span class="lineno"></span><span class="op" id="3758070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3758073">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3758141">func</span>&nbsp;<span class="op" id="3758146">(</span><span class="ident" id="3758147">hc</span>&nbsp;<span class="op" id="3758150">*</span><span class="ident" id="3758151">halfConn</span><span class="op" id="3758159">)</span>&nbsp;<span class="ident" id="3758161">newBlock</span><span class="op" id="3758169">(</span><span class="op" id="3758170">)</span>&nbsp;<span class="op" id="3758172">*</span><span class="ident" id="3758173">block</span>&nbsp;<span class="op" id="3758179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758182">b</span>&nbsp;<span class="op" id="3758184">:=</span>&nbsp;<span class="ident" id="3758187">hc</span><span class="op" id="3758189">.</span><span class="ident" id="3758190">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758197">if</span>&nbsp;<span class="ident" id="3758200">b</span>&nbsp;<span class="op" id="3758202">==</span>&nbsp;<span class="builtintype" id="3758205">nil</span>&nbsp;<span class="op" id="3758209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758213">return</span>&nbsp;<span class="builtinfunc" id="3758220">new</span><span class="op" id="3758223">(</span><span class="ident" id="3758224">block</span><span class="op" id="3758229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3758232">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758235">hc</span><span class="op" id="3758237">.</span><span class="ident" id="3758238">bfree</span>&nbsp;<span class="op" id="3758244">=</span>&nbsp;<span class="ident" id="3758246">b</span><span class="op" id="3758247">.</span><span class="ident" id="3758248">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758254">b</span><span class="op" id="3758255">.</span><span class="ident" id="3758256">link</span>&nbsp;<span class="op" id="3758261">=</span>&nbsp;<span class="builtintype" id="3758263">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758268">b</span><span class="op" id="3758269">.</span><span class="ident" id="3758270">resize</span><span class="op" id="3758276">(</span><span class="num" id="3758277">0</span><span class="op" id="3758278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758281">return</span>&nbsp;<span class="ident" id="3758288">b</span><br>
<span class="lineno"></span><span class="op" id="3758290">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3758293">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3758341">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3758407">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3758469">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3758496">func</span>&nbsp;<span class="op" id="3758501">(</span><span class="ident" id="3758502">hc</span>&nbsp;<span class="op" id="3758505">*</span><span class="ident" id="3758506">halfConn</span><span class="op" id="3758514">)</span>&nbsp;<span class="ident" id="3758516">freeBlock</span><span class="op" id="3758525">(</span><span class="ident" id="3758526">b</span>&nbsp;<span class="op" id="3758528">*</span><span class="ident" id="3758529">block</span><span class="op" id="3758534">)</span>&nbsp;<span class="op" id="3758536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758539">b</span><span class="op" id="3758540">.</span><span class="ident" id="3758541">link</span>&nbsp;<span class="op" id="3758546">=</span>&nbsp;<span class="ident" id="3758548">hc</span><span class="op" id="3758550">.</span><span class="ident" id="3758551">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758558">hc</span><span class="op" id="3758560">.</span><span class="ident" id="3758561">bfree</span>&nbsp;<span class="op" id="3758567">=</span>&nbsp;<span class="ident" id="3758569">b</span><br>
<span class="lineno"></span><span class="op" id="3758571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3758574">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3758628">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3758674">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3758727">func</span>&nbsp;<span class="op" id="3758732">(</span><span class="ident" id="3758733">hc</span>&nbsp;<span class="op" id="3758736">*</span><span class="ident" id="3758737">halfConn</span><span class="op" id="3758745">)</span>&nbsp;<span class="ident" id="3758747">splitBlock</span><span class="op" id="3758757">(</span><span class="ident" id="3758758">b</span>&nbsp;<span class="op" id="3758760">*</span><span class="ident" id="3758761">block</span><span class="op" id="3758766">,</span>&nbsp;<span class="ident" id="3758768">n</span>&nbsp;<span class="builtintype" id="3758770">int</span><span class="op" id="3758773">)</span>&nbsp;<span class="op" id="3758775">(</span><span class="op" id="3758776">*</span><span class="ident" id="3758777">block</span><span class="op" id="3758782">,</span>&nbsp;<span class="op" id="3758784">*</span><span class="ident" id="3758785">block</span><span class="op" id="3758790">)</span>&nbsp;<span class="op" id="3758792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758795">if</span>&nbsp;<span class="builtinfunc" id="3758798">len</span><span class="op" id="3758801">(</span><span class="ident" id="3758802">b</span><span class="op" id="3758803">.</span><span class="ident" id="3758804">data</span><span class="op" id="3758808">)</span>&nbsp;<span class="op" id="3758810">&lt;=</span>&nbsp;<span class="ident" id="3758813">n</span>&nbsp;<span class="op" id="3758815">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758819">return</span>&nbsp;<span class="ident" id="3758826">b</span><span class="op" id="3758827">,</span>&nbsp;<span class="builtintype" id="3758829">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3758834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758837">bb</span>&nbsp;<span class="op" id="3758840">:=</span>&nbsp;<span class="ident" id="3758843">hc</span><span class="op" id="3758845">.</span><span class="ident" id="3758846">newBlock</span><span class="op" id="3758854">(</span><span class="op" id="3758855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758858">bb</span><span class="op" id="3758860">.</span><span class="ident" id="3758861">resize</span><span class="op" id="3758867">(</span><span class="builtinfunc" id="3758868">len</span><span class="op" id="3758871">(</span><span class="ident" id="3758872">b</span><span class="op" id="3758873">.</span><span class="ident" id="3758874">data</span><span class="op" id="3758878">)</span>&nbsp;<span class="op" id="3758880">-</span>&nbsp;<span class="ident" id="3758882">n</span><span class="op" id="3758883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3758886">copy</span><span class="op" id="3758890">(</span><span class="ident" id="3758891">bb</span><span class="op" id="3758893">.</span><span class="ident" id="3758894">data</span><span class="op" id="3758898">,</span>&nbsp;<span class="ident" id="3758900">b</span><span class="op" id="3758901">.</span><span class="ident" id="3758902">data</span><span class="op" id="3758906">[</span><span class="ident" id="3758907">n</span><span class="op" id="3758908">:</span><span class="op" id="3758909">]</span><span class="op" id="3758910">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3758913">b</span><span class="op" id="3758914">.</span><span class="ident" id="3758915">data</span>&nbsp;<span class="op" id="3758920">=</span>&nbsp;<span class="ident" id="3758922">b</span><span class="op" id="3758923">.</span><span class="ident" id="3758924">data</span><span class="op" id="3758928">[</span><span class="num" id="3758929">0</span><span class="op" id="3758930">:</span><span class="ident" id="3758931">n</span><span class="op" id="3758932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3758935">return</span>&nbsp;<span class="ident" id="3758942">b</span><span class="op" id="3758943">,</span>&nbsp;<span class="ident" id="3758945">bb</span><br>
<span class="lineno"></span><span class="op" id="3758948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3758951">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3759011">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3759050">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3759086">func</span>&nbsp;<span class="op" id="3759091">(</span><span class="ident" id="3759092">c</span>&nbsp;<span class="op" id="3759094">*</span><span class="ident" id="3759095">Conn</span><span class="op" id="3759099">)</span>&nbsp;<span class="ident" id="3759101">readRecord</span><span class="op" id="3759111">(</span><span class="ident" id="3759112">want</span>&nbsp;<span class="ident" id="3759117">recordType</span><span class="op" id="3759127">)</span>&nbsp;<span class="builtintype" id="3759129">error</span>&nbsp;<span class="op" id="3759135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3759138">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3759182">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3759233">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759295">switch</span>&nbsp;<span class="ident" id="3759302">want</span>&nbsp;<span class="op" id="3759307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759310">default</span><span class="op" id="3759317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3759321">c</span><span class="op" id="3759322">.</span><span class="ident" id="3759323">sendAlert</span><span class="op" id="3759332">(</span><span class="ident" id="3759333">alertInternalError</span><span class="op" id="3759351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759355">return</span>&nbsp;<span class="ident" id="3759362">c</span><span class="op" id="3759363">.</span><span class="ident" id="3759364">in</span><span class="op" id="3759366">.</span><span class="ident" id="3759367">setErrorLocked</span><span class="op" id="3759381">(</span><span class="ident" id="3759382">errors</span><span class="op" id="3759388">.</span><span class="ident" id="3759389">New</span><span class="op" id="3759392">(</span><span class="string" id="3759393">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3759429">)</span><span class="op" id="3759430">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759433">case</span>&nbsp;<span class="ident" id="3759438">recordTypeHandshake</span><span class="op" id="3759457">,</span>&nbsp;<span class="ident" id="3759459">recordTypeChangeCipherSpec</span><span class="op" id="3759485">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759489">if</span>&nbsp;<span class="ident" id="3759492">c</span><span class="op" id="3759493">.</span><span class="ident" id="3759494">handshakeComplete</span>&nbsp;<span class="op" id="3759512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3759517">c</span><span class="op" id="3759518">.</span><span class="ident" id="3759519">sendAlert</span><span class="op" id="3759528">(</span><span class="ident" id="3759529">alertInternalError</span><span class="op" id="3759547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759552">return</span>&nbsp;<span class="ident" id="3759559">c</span><span class="op" id="3759560">.</span><span class="ident" id="3759561">in</span><span class="op" id="3759563">.</span><span class="ident" id="3759564">setErrorLocked</span><span class="op" id="3759578">(</span><span class="ident" id="3759579">errors</span><span class="op" id="3759585">.</span><span class="ident" id="3759586">New</span><span class="op" id="3759589">(</span><span class="string" id="3759590">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3759661">)</span><span class="op" id="3759662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3759666">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759669">case</span>&nbsp;<span class="ident" id="3759674">recordTypeApplicationData</span><span class="op" id="3759699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759703">if</span>&nbsp;<span class="op" id="3759706">!</span><span class="ident" id="3759707">c</span><span class="op" id="3759708">.</span><span class="ident" id="3759709">handshakeComplete</span>&nbsp;<span class="op" id="3759727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3759732">c</span><span class="op" id="3759733">.</span><span class="ident" id="3759734">sendAlert</span><span class="op" id="3759743">(</span><span class="ident" id="3759744">alertInternalError</span><span class="op" id="3759762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759767">return</span>&nbsp;<span class="ident" id="3759774">c</span><span class="op" id="3759775">.</span><span class="ident" id="3759776">in</span><span class="op" id="3759778">.</span><span class="ident" id="3759779">setErrorLocked</span><span class="op" id="3759793">(</span><span class="ident" id="3759794">errors</span><span class="op" id="3759800">.</span><span class="ident" id="3759801">New</span><span class="op" id="3759804">(</span><span class="string" id="3759805">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3759871">)</span><span class="op" id="3759872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3759876">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3759879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3759882">Again</span><span class="op" id="3759887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759890">if</span>&nbsp;<span class="ident" id="3759893">c</span><span class="op" id="3759894">.</span><span class="ident" id="3759895">rawInput</span>&nbsp;<span class="op" id="3759904">==</span>&nbsp;<span class="builtintype" id="3759907">nil</span>&nbsp;<span class="op" id="3759911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3759915">c</span><span class="op" id="3759916">.</span><span class="ident" id="3759917">rawInput</span>&nbsp;<span class="op" id="3759926">=</span>&nbsp;<span class="ident" id="3759928">c</span><span class="op" id="3759929">.</span><span class="ident" id="3759930">in</span><span class="op" id="3759932">.</span><span class="ident" id="3759933">newBlock</span><span class="op" id="3759941">(</span><span class="op" id="3759942">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3759945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3759948">b</span>&nbsp;<span class="op" id="3759950">:=</span>&nbsp;<span class="ident" id="3759953">c</span><span class="op" id="3759954">.</span><span class="ident" id="3759955">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3759966">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3759992">if</span>&nbsp;<span class="ident" id="3759995">err</span>&nbsp;<span class="op" id="3759999">:=</span>&nbsp;<span class="ident" id="3760002">b</span><span class="op" id="3760003">.</span><span class="ident" id="3760004">readFromUntil</span><span class="op" id="3760017">(</span><span class="ident" id="3760018">c</span><span class="op" id="3760019">.</span><span class="ident" id="3760020">conn</span><span class="op" id="3760024">,</span>&nbsp;<span class="ident" id="3760026">recordHeaderLen</span><span class="op" id="3760041">)</span><span class="op" id="3760042">;</span>&nbsp;<span class="ident" id="3760044">err</span>&nbsp;<span class="op" id="3760048">!=</span>&nbsp;<span class="builtintype" id="3760051">nil</span>&nbsp;<span class="op" id="3760055">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760059">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760117">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760171">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760206">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760230">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760262">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760269">if</span>&nbsp;<span class="ident" id="3760272">e</span><span class="op" id="3760273">,</span>&nbsp;<span class="ident" id="3760275">ok</span>&nbsp;<span class="op" id="3760278">:=</span>&nbsp;<span class="ident" id="3760281">err</span><span class="op" id="3760284">.</span><span class="op" id="3760285">(</span><span class="ident" id="3760286">net</span><span class="op" id="3760289">.</span><span class="ident" id="3760290">Error</span><span class="op" id="3760295">)</span><span class="op" id="3760296">;</span>&nbsp;<span class="op" id="3760298">!</span><span class="ident" id="3760299">ok</span>&nbsp;<span class="op" id="3760302">||</span>&nbsp;<span class="op" id="3760305">!</span><span class="ident" id="3760306">e</span><span class="op" id="3760307">.</span><span class="ident" id="3760308">Temporary</span><span class="op" id="3760317">(</span><span class="op" id="3760318">)</span>&nbsp;<span class="op" id="3760320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760325">c</span><span class="op" id="3760326">.</span><span class="ident" id="3760327">in</span><span class="op" id="3760329">.</span><span class="ident" id="3760330">setErrorLocked</span><span class="op" id="3760344">(</span><span class="ident" id="3760345">err</span><span class="op" id="3760348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3760352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760356">return</span>&nbsp;<span class="ident" id="3760363">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3760368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760371">typ</span>&nbsp;<span class="op" id="3760375">:=</span>&nbsp;<span class="ident" id="3760378">recordType</span><span class="op" id="3760388">(</span><span class="ident" id="3760389">b</span><span class="op" id="3760390">.</span><span class="ident" id="3760391">data</span><span class="op" id="3760395">[</span><span class="num" id="3760396">0</span><span class="op" id="3760397">]</span><span class="op" id="3760398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760402">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760471">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760544">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3760616">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760637">if</span>&nbsp;<span class="ident" id="3760640">want</span>&nbsp;<span class="op" id="3760645">==</span>&nbsp;<span class="ident" id="3760648">recordTypeHandshake</span>&nbsp;<span class="op" id="3760668">&amp;&amp;</span>&nbsp;<span class="ident" id="3760671">typ</span>&nbsp;<span class="op" id="3760675">==</span>&nbsp;<span class="num" id="3760678">0x80</span>&nbsp;<span class="op" id="3760683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760687">c</span><span class="op" id="3760688">.</span><span class="ident" id="3760689">sendAlert</span><span class="op" id="3760698">(</span><span class="ident" id="3760699">alertProtocolVersion</span><span class="op" id="3760719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760723">return</span>&nbsp;<span class="ident" id="3760730">c</span><span class="op" id="3760731">.</span><span class="ident" id="3760732">in</span><span class="op" id="3760734">.</span><span class="ident" id="3760735">setErrorLocked</span><span class="op" id="3760749">(</span><span class="ident" id="3760750">errors</span><span class="op" id="3760756">.</span><span class="ident" id="3760757">New</span><span class="op" id="3760760">(</span><span class="string" id="3760761">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3760804">)</span><span class="op" id="3760805">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3760808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760812">vers</span>&nbsp;<span class="op" id="3760817">:=</span>&nbsp;<span class="builtintype" id="3760820">uint16</span><span class="op" id="3760826">(</span><span class="ident" id="3760827">b</span><span class="op" id="3760828">.</span><span class="ident" id="3760829">data</span><span class="op" id="3760833">[</span><span class="num" id="3760834">1</span><span class="op" id="3760835">]</span><span class="op" id="3760836">)</span><span class="op" id="3760837">&lt;&lt;</span><span class="num" id="3760839">8</span>&nbsp;<span class="op" id="3760841">|</span>&nbsp;<span class="builtintype" id="3760843">uint16</span><span class="op" id="3760849">(</span><span class="ident" id="3760850">b</span><span class="op" id="3760851">.</span><span class="ident" id="3760852">data</span><span class="op" id="3760856">[</span><span class="num" id="3760857">2</span><span class="op" id="3760858">]</span><span class="op" id="3760859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760862">n</span>&nbsp;<span class="op" id="3760864">:=</span>&nbsp;<span class="builtintype" id="3760867">int</span><span class="op" id="3760870">(</span><span class="ident" id="3760871">b</span><span class="op" id="3760872">.</span><span class="ident" id="3760873">data</span><span class="op" id="3760877">[</span><span class="num" id="3760878">3</span><span class="op" id="3760879">]</span><span class="op" id="3760880">)</span><span class="op" id="3760881">&lt;&lt;</span><span class="num" id="3760883">8</span>&nbsp;<span class="op" id="3760885">|</span>&nbsp;<span class="builtintype" id="3760887">int</span><span class="op" id="3760890">(</span><span class="ident" id="3760891">b</span><span class="op" id="3760892">.</span><span class="ident" id="3760893">data</span><span class="op" id="3760897">[</span><span class="num" id="3760898">4</span><span class="op" id="3760899">]</span><span class="op" id="3760900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760903">if</span>&nbsp;<span class="ident" id="3760906">c</span><span class="op" id="3760907">.</span><span class="ident" id="3760908">haveVers</span>&nbsp;<span class="op" id="3760917">&amp;&amp;</span>&nbsp;<span class="ident" id="3760920">vers</span>&nbsp;<span class="op" id="3760925">!=</span>&nbsp;<span class="ident" id="3760928">c</span><span class="op" id="3760929">.</span><span class="ident" id="3760930">vers</span>&nbsp;<span class="op" id="3760935">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3760939">c</span><span class="op" id="3760940">.</span><span class="ident" id="3760941">sendAlert</span><span class="op" id="3760950">(</span><span class="ident" id="3760951">alertProtocolVersion</span><span class="op" id="3760971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3760975">return</span>&nbsp;<span class="ident" id="3760982">c</span><span class="op" id="3760983">.</span><span class="ident" id="3760984">in</span><span class="op" id="3760986">.</span><span class="ident" id="3760987">setErrorLocked</span><span class="op" id="3761001">(</span><span class="ident" id="3761002">fmt</span><span class="op" id="3761005">.</span><span class="ident" id="3761006">Errorf</span><span class="op" id="3761012">(</span><span class="string" id="3761013">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3761077">,</span>&nbsp;<span class="ident" id="3761079">vers</span><span class="op" id="3761083">,</span>&nbsp;<span class="ident" id="3761085">c</span><span class="op" id="3761086">.</span><span class="ident" id="3761087">vers</span><span class="op" id="3761091">)</span><span class="op" id="3761092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3761095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761098">if</span>&nbsp;<span class="ident" id="3761101">n</span>&nbsp;<span class="op" id="3761103">&gt;</span>&nbsp;<span class="ident" id="3761105">maxCiphertext</span>&nbsp;<span class="op" id="3761119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3761123">c</span><span class="op" id="3761124">.</span><span class="ident" id="3761125">sendAlert</span><span class="op" id="3761134">(</span><span class="ident" id="3761135">alertRecordOverflow</span><span class="op" id="3761154">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761158">return</span>&nbsp;<span class="ident" id="3761165">c</span><span class="op" id="3761166">.</span><span class="ident" id="3761167">in</span><span class="op" id="3761169">.</span><span class="ident" id="3761170">setErrorLocked</span><span class="op" id="3761184">(</span><span class="ident" id="3761185">fmt</span><span class="op" id="3761188">.</span><span class="ident" id="3761189">Errorf</span><span class="op" id="3761195">(</span><span class="string" id="3761196">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3761243">,</span>&nbsp;<span class="ident" id="3761245">n</span><span class="op" id="3761246">)</span><span class="op" id="3761247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3761250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761253">if</span>&nbsp;<span class="op" id="3761256">!</span><span class="ident" id="3761257">c</span><span class="op" id="3761258">.</span><span class="ident" id="3761259">haveVers</span>&nbsp;<span class="op" id="3761268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761272">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761313">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761350">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761407">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761444">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761500">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761549">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3761605">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761634">if</span>&nbsp;<span class="op" id="3761637">(</span><span class="ident" id="3761638">typ</span>&nbsp;<span class="op" id="3761642">!=</span>&nbsp;<span class="ident" id="3761645">recordTypeAlert</span>&nbsp;<span class="op" id="3761661">&amp;&amp;</span>&nbsp;<span class="ident" id="3761664">typ</span>&nbsp;<span class="op" id="3761668">!=</span>&nbsp;<span class="ident" id="3761671">want</span><span class="op" id="3761675">)</span>&nbsp;<span class="op" id="3761677">||</span>&nbsp;<span class="ident" id="3761680">vers</span>&nbsp;<span class="op" id="3761685">&gt;=</span>&nbsp;<span class="num" id="3761688">0x1000</span>&nbsp;<span class="op" id="3761695">||</span>&nbsp;<span class="ident" id="3761698">n</span>&nbsp;<span class="op" id="3761700">&gt;=</span>&nbsp;<span class="num" id="3761703">0x3000</span>&nbsp;<span class="op" id="3761710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3761715">c</span><span class="op" id="3761716">.</span><span class="ident" id="3761717">sendAlert</span><span class="op" id="3761726">(</span><span class="ident" id="3761727">alertUnexpectedMessage</span><span class="op" id="3761749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761754">return</span>&nbsp;<span class="ident" id="3761761">c</span><span class="op" id="3761762">.</span><span class="ident" id="3761763">in</span><span class="op" id="3761765">.</span><span class="ident" id="3761766">setErrorLocked</span><span class="op" id="3761780">(</span><span class="ident" id="3761781">fmt</span><span class="op" id="3761784">.</span><span class="ident" id="3761785">Errorf</span><span class="op" id="3761791">(</span><span class="string" id="3761792">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3761846">)</span><span class="op" id="3761847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3761851">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3761854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761857">if</span>&nbsp;<span class="ident" id="3761860">err</span>&nbsp;<span class="op" id="3761864">:=</span>&nbsp;<span class="ident" id="3761867">b</span><span class="op" id="3761868">.</span><span class="ident" id="3761869">readFromUntil</span><span class="op" id="3761882">(</span><span class="ident" id="3761883">c</span><span class="op" id="3761884">.</span><span class="ident" id="3761885">conn</span><span class="op" id="3761889">,</span>&nbsp;<span class="ident" id="3761891">recordHeaderLen</span><span class="op" id="3761906">+</span><span class="ident" id="3761907">n</span><span class="op" id="3761908">)</span><span class="op" id="3761909">;</span>&nbsp;<span class="ident" id="3761911">err</span>&nbsp;<span class="op" id="3761915">!=</span>&nbsp;<span class="builtintype" id="3761918">nil</span>&nbsp;<span class="op" id="3761922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761926">if</span>&nbsp;<span class="ident" id="3761929">err</span>&nbsp;<span class="op" id="3761933">==</span>&nbsp;<span class="ident" id="3761936">io</span><span class="op" id="3761938">.</span><span class="ident" id="3761939">EOF</span>&nbsp;<span class="op" id="3761943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3761948">err</span>&nbsp;<span class="op" id="3761952">=</span>&nbsp;<span class="ident" id="3761954">io</span><span class="op" id="3761956">.</span><span class="ident" id="3761957">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3761976">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3761980">if</span>&nbsp;<span class="ident" id="3761983">e</span><span class="op" id="3761984">,</span>&nbsp;<span class="ident" id="3761986">ok</span>&nbsp;<span class="op" id="3761989">:=</span>&nbsp;<span class="ident" id="3761992">err</span><span class="op" id="3761995">.</span><span class="op" id="3761996">(</span><span class="ident" id="3761997">net</span><span class="op" id="3762000">.</span><span class="ident" id="3762001">Error</span><span class="op" id="3762006">)</span><span class="op" id="3762007">;</span>&nbsp;<span class="op" id="3762009">!</span><span class="ident" id="3762010">ok</span>&nbsp;<span class="op" id="3762013">||</span>&nbsp;<span class="op" id="3762016">!</span><span class="ident" id="3762017">e</span><span class="op" id="3762018">.</span><span class="ident" id="3762019">Temporary</span><span class="op" id="3762028">(</span><span class="op" id="3762029">)</span>&nbsp;<span class="op" id="3762031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762036">c</span><span class="op" id="3762037">.</span><span class="ident" id="3762038">in</span><span class="op" id="3762040">.</span><span class="ident" id="3762041">setErrorLocked</span><span class="op" id="3762055">(</span><span class="ident" id="3762056">err</span><span class="op" id="3762059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762067">return</span>&nbsp;<span class="ident" id="3762074">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762079">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3762083">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762104">b</span><span class="op" id="3762105">,</span>&nbsp;<span class="ident" id="3762107">c</span><span class="op" id="3762108">.</span><span class="ident" id="3762109">rawInput</span>&nbsp;<span class="op" id="3762118">=</span>&nbsp;<span class="ident" id="3762120">c</span><span class="op" id="3762121">.</span><span class="ident" id="3762122">in</span><span class="op" id="3762124">.</span><span class="ident" id="3762125">splitBlock</span><span class="op" id="3762135">(</span><span class="ident" id="3762136">b</span><span class="op" id="3762137">,</span>&nbsp;<span class="ident" id="3762139">recordHeaderLen</span><span class="op" id="3762154">+</span><span class="ident" id="3762155">n</span><span class="op" id="3762156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762159">ok</span><span class="op" id="3762161">,</span>&nbsp;<span class="ident" id="3762163">off</span><span class="op" id="3762166">,</span>&nbsp;<span class="ident" id="3762168">err</span>&nbsp;<span class="op" id="3762172">:=</span>&nbsp;<span class="ident" id="3762175">c</span><span class="op" id="3762176">.</span><span class="ident" id="3762177">in</span><span class="op" id="3762179">.</span><span class="ident" id="3762180">decrypt</span><span class="op" id="3762187">(</span><span class="ident" id="3762188">b</span><span class="op" id="3762189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762192">if</span>&nbsp;<span class="op" id="3762195">!</span><span class="ident" id="3762196">ok</span>&nbsp;<span class="op" id="3762199">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762203">c</span><span class="op" id="3762204">.</span><span class="ident" id="3762205">in</span><span class="op" id="3762207">.</span><span class="ident" id="3762208">setErrorLocked</span><span class="op" id="3762222">(</span><span class="ident" id="3762223">c</span><span class="op" id="3762224">.</span><span class="ident" id="3762225">sendAlert</span><span class="op" id="3762234">(</span><span class="ident" id="3762235">err</span><span class="op" id="3762238">)</span><span class="op" id="3762239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762245">b</span><span class="op" id="3762246">.</span><span class="ident" id="3762247">off</span>&nbsp;<span class="op" id="3762251">=</span>&nbsp;<span class="ident" id="3762253">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762258">data</span>&nbsp;<span class="op" id="3762263">:=</span>&nbsp;<span class="ident" id="3762266">b</span><span class="op" id="3762267">.</span><span class="ident" id="3762268">data</span><span class="op" id="3762272">[</span><span class="ident" id="3762273">b</span><span class="op" id="3762274">.</span><span class="ident" id="3762275">off</span><span class="op" id="3762278">:</span><span class="op" id="3762279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762282">if</span>&nbsp;<span class="builtinfunc" id="3762285">len</span><span class="op" id="3762288">(</span><span class="ident" id="3762289">data</span><span class="op" id="3762293">)</span>&nbsp;<span class="op" id="3762295">&gt;</span>&nbsp;<span class="ident" id="3762297">maxPlaintext</span>&nbsp;<span class="op" id="3762310">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762314">err</span>&nbsp;<span class="op" id="3762318">:=</span>&nbsp;<span class="ident" id="3762321">c</span><span class="op" id="3762322">.</span><span class="ident" id="3762323">sendAlert</span><span class="op" id="3762332">(</span><span class="ident" id="3762333">alertRecordOverflow</span><span class="op" id="3762352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762356">c</span><span class="op" id="3762357">.</span><span class="ident" id="3762358">in</span><span class="op" id="3762360">.</span><span class="ident" id="3762361">freeBlock</span><span class="op" id="3762370">(</span><span class="ident" id="3762371">b</span><span class="op" id="3762372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762376">return</span>&nbsp;<span class="ident" id="3762383">c</span><span class="op" id="3762384">.</span><span class="ident" id="3762385">in</span><span class="op" id="3762387">.</span><span class="ident" id="3762388">setErrorLocked</span><span class="op" id="3762402">(</span><span class="ident" id="3762403">err</span><span class="op" id="3762406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762413">switch</span>&nbsp;<span class="ident" id="3762420">typ</span>&nbsp;<span class="op" id="3762424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762427">default</span><span class="op" id="3762434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762438">c</span><span class="op" id="3762439">.</span><span class="ident" id="3762440">in</span><span class="op" id="3762442">.</span><span class="ident" id="3762443">setErrorLocked</span><span class="op" id="3762457">(</span><span class="ident" id="3762458">c</span><span class="op" id="3762459">.</span><span class="ident" id="3762460">sendAlert</span><span class="op" id="3762469">(</span><span class="ident" id="3762470">alertUnexpectedMessage</span><span class="op" id="3762492">)</span><span class="op" id="3762493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762497">case</span>&nbsp;<span class="ident" id="3762502">recordTypeAlert</span><span class="op" id="3762517">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762521">if</span>&nbsp;<span class="builtinfunc" id="3762524">len</span><span class="op" id="3762527">(</span><span class="ident" id="3762528">data</span><span class="op" id="3762532">)</span>&nbsp;<span class="op" id="3762534">!=</span>&nbsp;<span class="num" id="3762537">2</span>&nbsp;<span class="op" id="3762539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762544">c</span><span class="op" id="3762545">.</span><span class="ident" id="3762546">in</span><span class="op" id="3762548">.</span><span class="ident" id="3762549">setErrorLocked</span><span class="op" id="3762563">(</span><span class="ident" id="3762564">c</span><span class="op" id="3762565">.</span><span class="ident" id="3762566">sendAlert</span><span class="op" id="3762575">(</span><span class="ident" id="3762576">alertUnexpectedMessage</span><span class="op" id="3762598">)</span><span class="op" id="3762599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762604">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762616">if</span>&nbsp;<span class="ident" id="3762619">alert</span><span class="op" id="3762624">(</span><span class="ident" id="3762625">data</span><span class="op" id="3762629">[</span><span class="num" id="3762630">1</span><span class="op" id="3762631">]</span><span class="op" id="3762632">)</span>&nbsp;<span class="op" id="3762634">==</span>&nbsp;<span class="ident" id="3762637">alertCloseNotify</span>&nbsp;<span class="op" id="3762654">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762659">c</span><span class="op" id="3762660">.</span><span class="ident" id="3762661">in</span><span class="op" id="3762663">.</span><span class="ident" id="3762664">setErrorLocked</span><span class="op" id="3762678">(</span><span class="ident" id="3762679">io</span><span class="op" id="3762681">.</span><span class="ident" id="3762682">EOF</span><span class="op" id="3762685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762690">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762702">switch</span>&nbsp;<span class="ident" id="3762709">data</span><span class="op" id="3762713">[</span><span class="num" id="3762714">0</span><span class="op" id="3762715">]</span>&nbsp;<span class="op" id="3762717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762721">case</span>&nbsp;<span class="ident" id="3762726">alertLevelWarning</span><span class="op" id="3762743">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3762748">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762772">c</span><span class="op" id="3762773">.</span><span class="ident" id="3762774">in</span><span class="op" id="3762776">.</span><span class="ident" id="3762777">freeBlock</span><span class="op" id="3762786">(</span><span class="ident" id="3762787">b</span><span class="op" id="3762788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762793">goto</span>&nbsp;<span class="ident" id="3762798">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762806">case</span>&nbsp;<span class="ident" id="3762811">alertLevelError</span><span class="op" id="3762826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762831">c</span><span class="op" id="3762832">.</span><span class="ident" id="3762833">in</span><span class="op" id="3762835">.</span><span class="ident" id="3762836">setErrorLocked</span><span class="op" id="3762850">(</span><span class="op" id="3762851">&amp;</span><span class="ident" id="3762852">net</span><span class="op" id="3762855">.</span><span class="ident" id="3762856">OpError</span><span class="op" id="3762863">{</span><span class="ident" id="3762864">Op</span><span class="op" id="3762866">:</span>&nbsp;<span class="string" id="3762868">&#34;remote&nbsp;error&#34;</span><span class="op" id="3762882">,</span>&nbsp;<span class="ident" id="3762884">Err</span><span class="op" id="3762887">:</span>&nbsp;<span class="ident" id="3762889">alert</span><span class="op" id="3762894">(</span><span class="ident" id="3762895">data</span><span class="op" id="3762899">[</span><span class="num" id="3762900">1</span><span class="op" id="3762901">]</span><span class="op" id="3762902">)</span><span class="op" id="3762903">}</span><span class="op" id="3762904">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762908">default</span><span class="op" id="3762915">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3762920">c</span><span class="op" id="3762921">.</span><span class="ident" id="3762922">in</span><span class="op" id="3762924">.</span><span class="ident" id="3762925">setErrorLocked</span><span class="op" id="3762939">(</span><span class="ident" id="3762940">c</span><span class="op" id="3762941">.</span><span class="ident" id="3762942">sendAlert</span><span class="op" id="3762951">(</span><span class="ident" id="3762952">alertUnexpectedMessage</span><span class="op" id="3762974">)</span><span class="op" id="3762975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3762979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3762983">case</span>&nbsp;<span class="ident" id="3762988">recordTypeChangeCipherSpec</span><span class="op" id="3763014">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763018">if</span>&nbsp;<span class="ident" id="3763021">typ</span>&nbsp;<span class="op" id="3763025">!=</span>&nbsp;<span class="ident" id="3763028">want</span>&nbsp;<span class="op" id="3763033">||</span>&nbsp;<span class="builtinfunc" id="3763036">len</span><span class="op" id="3763039">(</span><span class="ident" id="3763040">data</span><span class="op" id="3763044">)</span>&nbsp;<span class="op" id="3763046">!=</span>&nbsp;<span class="num" id="3763049">1</span>&nbsp;<span class="op" id="3763051">||</span>&nbsp;<span class="ident" id="3763054">data</span><span class="op" id="3763058">[</span><span class="num" id="3763059">0</span><span class="op" id="3763060">]</span>&nbsp;<span class="op" id="3763062">!=</span>&nbsp;<span class="num" id="3763065">1</span>&nbsp;<span class="op" id="3763067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763072">c</span><span class="op" id="3763073">.</span><span class="ident" id="3763074">in</span><span class="op" id="3763076">.</span><span class="ident" id="3763077">setErrorLocked</span><span class="op" id="3763091">(</span><span class="ident" id="3763092">c</span><span class="op" id="3763093">.</span><span class="ident" id="3763094">sendAlert</span><span class="op" id="3763103">(</span><span class="ident" id="3763104">alertUnexpectedMessage</span><span class="op" id="3763126">)</span><span class="op" id="3763127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763132">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763144">err</span>&nbsp;<span class="op" id="3763148">:=</span>&nbsp;<span class="ident" id="3763151">c</span><span class="op" id="3763152">.</span><span class="ident" id="3763153">in</span><span class="op" id="3763155">.</span><span class="ident" id="3763156">changeCipherSpec</span><span class="op" id="3763172">(</span><span class="op" id="3763173">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763177">if</span>&nbsp;<span class="ident" id="3763180">err</span>&nbsp;<span class="op" id="3763184">!=</span>&nbsp;<span class="builtintype" id="3763187">nil</span>&nbsp;<span class="op" id="3763191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763196">c</span><span class="op" id="3763197">.</span><span class="ident" id="3763198">in</span><span class="op" id="3763200">.</span><span class="ident" id="3763201">setErrorLocked</span><span class="op" id="3763215">(</span><span class="ident" id="3763216">c</span><span class="op" id="3763217">.</span><span class="ident" id="3763218">sendAlert</span><span class="op" id="3763227">(</span><span class="ident" id="3763228">err</span><span class="op" id="3763231">.</span><span class="op" id="3763232">(</span><span class="ident" id="3763233">alert</span><span class="op" id="3763238">)</span><span class="op" id="3763239">)</span><span class="op" id="3763240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763248">case</span>&nbsp;<span class="ident" id="3763253">recordTypeApplicationData</span><span class="op" id="3763278">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763282">if</span>&nbsp;<span class="ident" id="3763285">typ</span>&nbsp;<span class="op" id="3763289">!=</span>&nbsp;<span class="ident" id="3763292">want</span>&nbsp;<span class="op" id="3763297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763302">c</span><span class="op" id="3763303">.</span><span class="ident" id="3763304">in</span><span class="op" id="3763306">.</span><span class="ident" id="3763307">setErrorLocked</span><span class="op" id="3763321">(</span><span class="ident" id="3763322">c</span><span class="op" id="3763323">.</span><span class="ident" id="3763324">sendAlert</span><span class="op" id="3763333">(</span><span class="ident" id="3763334">alertUnexpectedMessage</span><span class="op" id="3763356">)</span><span class="op" id="3763357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763362">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763374">c</span><span class="op" id="3763375">.</span><span class="ident" id="3763376">input</span>&nbsp;<span class="op" id="3763382">=</span>&nbsp;<span class="ident" id="3763384">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763388">b</span>&nbsp;<span class="op" id="3763390">=</span>&nbsp;<span class="builtintype" id="3763392">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763398">case</span>&nbsp;<span class="ident" id="3763403">recordTypeHandshake</span><span class="op" id="3763422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3763426">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763485">if</span>&nbsp;<span class="ident" id="3763488">typ</span>&nbsp;<span class="op" id="3763492">!=</span>&nbsp;<span class="ident" id="3763495">want</span>&nbsp;<span class="op" id="3763500">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763505">return</span>&nbsp;<span class="ident" id="3763512">c</span><span class="op" id="3763513">.</span><span class="ident" id="3763514">in</span><span class="op" id="3763516">.</span><span class="ident" id="3763517">setErrorLocked</span><span class="op" id="3763531">(</span><span class="ident" id="3763532">c</span><span class="op" id="3763533">.</span><span class="ident" id="3763534">sendAlert</span><span class="op" id="3763543">(</span><span class="ident" id="3763544">alertNoRenegotiation</span><span class="op" id="3763564">)</span><span class="op" id="3763565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763573">c</span><span class="op" id="3763574">.</span><span class="ident" id="3763575">hand</span><span class="op" id="3763579">.</span><span class="ident" id="3763580">Write</span><span class="op" id="3763585">(</span><span class="ident" id="3763586">data</span><span class="op" id="3763590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763597">if</span>&nbsp;<span class="ident" id="3763600">b</span>&nbsp;<span class="op" id="3763602">!=</span>&nbsp;<span class="builtintype" id="3763605">nil</span>&nbsp;<span class="op" id="3763609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763613">c</span><span class="op" id="3763614">.</span><span class="ident" id="3763615">in</span><span class="op" id="3763617">.</span><span class="ident" id="3763618">freeBlock</span><span class="op" id="3763627">(</span><span class="ident" id="3763628">b</span><span class="op" id="3763629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763635">return</span>&nbsp;<span class="ident" id="3763642">c</span><span class="op" id="3763643">.</span><span class="ident" id="3763644">in</span><span class="op" id="3763646">.</span><span class="ident" id="3763647">err</span><br>
<span class="lineno"></span><span class="op" id="3763651">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3763654">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3763694">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3763715">func</span>&nbsp;<span class="op" id="3763720">(</span><span class="ident" id="3763721">c</span>&nbsp;<span class="op" id="3763723">*</span><span class="ident" id="3763724">Conn</span><span class="op" id="3763728">)</span>&nbsp;<span class="ident" id="3763730">sendAlertLocked</span><span class="op" id="3763745">(</span><span class="ident" id="3763746">err</span>&nbsp;<span class="ident" id="3763750">alert</span><span class="op" id="3763755">)</span>&nbsp;<span class="builtintype" id="3763757">error</span>&nbsp;<span class="op" id="3763763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763766">switch</span>&nbsp;<span class="ident" id="3763773">err</span>&nbsp;<span class="op" id="3763777">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763780">case</span>&nbsp;<span class="ident" id="3763785">alertNoRenegotiation</span><span class="op" id="3763805">,</span>&nbsp;<span class="ident" id="3763807">alertCloseNotify</span><span class="op" id="3763823">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763827">c</span><span class="op" id="3763828">.</span><span class="ident" id="3763829">tmp</span><span class="op" id="3763832">[</span><span class="num" id="3763833">0</span><span class="op" id="3763834">]</span>&nbsp;<span class="op" id="3763836">=</span>&nbsp;<span class="ident" id="3763838">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3763857">default</span><span class="op" id="3763864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763868">c</span><span class="op" id="3763869">.</span><span class="ident" id="3763870">tmp</span><span class="op" id="3763873">[</span><span class="num" id="3763874">0</span><span class="op" id="3763875">]</span>&nbsp;<span class="op" id="3763877">=</span>&nbsp;<span class="ident" id="3763879">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3763896">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763899">c</span><span class="op" id="3763900">.</span><span class="ident" id="3763901">tmp</span><span class="op" id="3763904">[</span><span class="num" id="3763905">1</span><span class="op" id="3763906">]</span>&nbsp;<span class="op" id="3763908">=</span>&nbsp;<span class="builtintype" id="3763910">byte</span><span class="op" id="3763914">(</span><span class="ident" id="3763915">err</span><span class="op" id="3763918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3763921">c</span><span class="op" id="3763922">.</span><span class="ident" id="3763923">writeRecord</span><span class="op" id="3763934">(</span><span class="ident" id="3763935">recordTypeAlert</span><span class="op" id="3763950">,</span>&nbsp;<span class="ident" id="3763952">c</span><span class="op" id="3763953">.</span><span class="ident" id="3763954">tmp</span><span class="op" id="3763957">[</span><span class="num" id="3763958">0</span><span class="op" id="3763959">:</span><span class="num" id="3763960">2</span><span class="op" id="3763961">]</span><span class="op" id="3763962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3763965">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764026">if</span>&nbsp;<span class="ident" id="3764029">err</span>&nbsp;<span class="op" id="3764033">!=</span>&nbsp;<span class="ident" id="3764036">alertCloseNotify</span>&nbsp;<span class="op" id="3764053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764057">return</span>&nbsp;<span class="ident" id="3764064">c</span><span class="op" id="3764065">.</span><span class="ident" id="3764066">out</span><span class="op" id="3764069">.</span><span class="ident" id="3764070">setErrorLocked</span><span class="op" id="3764084">(</span><span class="op" id="3764085">&amp;</span><span class="ident" id="3764086">net</span><span class="op" id="3764089">.</span><span class="ident" id="3764090">OpError</span><span class="op" id="3764097">{</span><span class="ident" id="3764098">Op</span><span class="op" id="3764100">:</span>&nbsp;<span class="string" id="3764102">&#34;local&nbsp;error&#34;</span><span class="op" id="3764115">,</span>&nbsp;<span class="ident" id="3764117">Err</span><span class="op" id="3764120">:</span>&nbsp;<span class="ident" id="3764122">err</span><span class="op" id="3764125">}</span><span class="op" id="3764126">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3764129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764132">return</span>&nbsp;<span class="builtintype" id="3764139">nil</span><br>
<span class="lineno"></span><span class="op" id="3764143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3764146">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3764186">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3764206">func</span>&nbsp;<span class="op" id="3764211">(</span><span class="ident" id="3764212">c</span>&nbsp;<span class="op" id="3764214">*</span><span class="ident" id="3764215">Conn</span><span class="op" id="3764219">)</span>&nbsp;<span class="ident" id="3764221">sendAlert</span><span class="op" id="3764230">(</span><span class="ident" id="3764231">err</span>&nbsp;<span class="ident" id="3764235">alert</span><span class="op" id="3764240">)</span>&nbsp;<span class="builtintype" id="3764242">error</span>&nbsp;<span class="op" id="3764248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764251">c</span><span class="op" id="3764252">.</span><span class="ident" id="3764253">out</span><span class="op" id="3764256">.</span><span class="ident" id="3764257">Lock</span><span class="op" id="3764261">(</span><span class="op" id="3764262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764265">defer</span>&nbsp;<span class="ident" id="3764271">c</span><span class="op" id="3764272">.</span><span class="ident" id="3764273">out</span><span class="op" id="3764276">.</span><span class="ident" id="3764277">Unlock</span><span class="op" id="3764283">(</span><span class="op" id="3764284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764287">return</span>&nbsp;<span class="ident" id="3764294">c</span><span class="op" id="3764295">.</span><span class="ident" id="3764296">sendAlertLocked</span><span class="op" id="3764311">(</span><span class="ident" id="3764312">err</span><span class="op" id="3764315">)</span><br>
<span class="lineno">690</span><span class="op" id="3764317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3764320">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3764387">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3764444">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3764465">func</span>&nbsp;<span class="op" id="3764470">(</span><span class="ident" id="3764471">c</span>&nbsp;<span class="op" id="3764473">*</span><span class="ident" id="3764474">Conn</span><span class="op" id="3764478">)</span>&nbsp;<span class="ident" id="3764480">writeRecord</span><span class="op" id="3764491">(</span><span class="ident" id="3764492">typ</span>&nbsp;<span class="ident" id="3764496">recordType</span><span class="op" id="3764506">,</span>&nbsp;<span class="ident" id="3764508">data</span>&nbsp;<span class="op" id="3764513">[</span><span class="op" id="3764514">]</span><span class="builtintype" id="3764515">byte</span><span class="op" id="3764519">)</span>&nbsp;<span class="op" id="3764521">(</span><span class="ident" id="3764522">n</span>&nbsp;<span class="builtintype" id="3764524">int</span><span class="op" id="3764527">,</span>&nbsp;<span class="ident" id="3764529">err</span>&nbsp;<span class="builtintype" id="3764533">error</span><span class="op" id="3764538">)</span>&nbsp;<span class="op" id="3764540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764543">b</span>&nbsp;<span class="op" id="3764545">:=</span>&nbsp;<span class="ident" id="3764548">c</span><span class="op" id="3764549">.</span><span class="ident" id="3764550">out</span><span class="op" id="3764553">.</span><span class="ident" id="3764554">newBlock</span><span class="op" id="3764562">(</span><span class="op" id="3764563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764566">for</span>&nbsp;<span class="builtinfunc" id="3764570">len</span><span class="op" id="3764573">(</span><span class="ident" id="3764574">data</span><span class="op" id="3764578">)</span>&nbsp;<span class="op" id="3764580">&gt;</span>&nbsp;<span class="num" id="3764582">0</span>&nbsp;<span class="op" id="3764584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764588">m</span>&nbsp;<span class="op" id="3764590">:=</span>&nbsp;<span class="builtinfunc" id="3764593">len</span><span class="op" id="3764596">(</span><span class="ident" id="3764597">data</span><span class="op" id="3764601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764605">if</span>&nbsp;<span class="ident" id="3764608">m</span>&nbsp;<span class="op" id="3764610">&gt;</span>&nbsp;<span class="ident" id="3764612">maxPlaintext</span>&nbsp;<span class="op" id="3764625">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764630">m</span>&nbsp;<span class="op" id="3764632">=</span>&nbsp;<span class="ident" id="3764634">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3764649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764653">explicitIVLen</span>&nbsp;<span class="op" id="3764667">:=</span>&nbsp;<span class="num" id="3764670">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764674">explicitIVIsSeq</span>&nbsp;<span class="op" id="3764690">:=</span>&nbsp;<span class="builtintype" id="3764693">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764702">var</span>&nbsp;<span class="ident" id="3764706">cbc</span>&nbsp;<span class="ident" id="3764710">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764720">if</span>&nbsp;<span class="ident" id="3764723">c</span><span class="op" id="3764724">.</span><span class="ident" id="3764725">out</span><span class="op" id="3764728">.</span><span class="ident" id="3764729">version</span>&nbsp;<span class="op" id="3764737">&gt;=</span>&nbsp;<span class="ident" id="3764740">VersionTLS11</span>&nbsp;<span class="op" id="3764753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764758">var</span>&nbsp;<span class="ident" id="3764762">ok</span>&nbsp;<span class="builtintype" id="3764765">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764773">if</span>&nbsp;<span class="ident" id="3764776">cbc</span><span class="op" id="3764779">,</span>&nbsp;<span class="ident" id="3764781">ok</span>&nbsp;<span class="op" id="3764784">=</span>&nbsp;<span class="ident" id="3764786">c</span><span class="op" id="3764787">.</span><span class="ident" id="3764788">out</span><span class="op" id="3764791">.</span><span class="ident" id="3764792">cipher</span><span class="op" id="3764798">.</span><span class="op" id="3764799">(</span><span class="ident" id="3764800">cbcMode</span><span class="op" id="3764807">)</span><span class="op" id="3764808">;</span>&nbsp;<span class="ident" id="3764810">ok</span>&nbsp;<span class="op" id="3764813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764819">explicitIVLen</span>&nbsp;<span class="op" id="3764833">=</span>&nbsp;<span class="ident" id="3764835">cbc</span><span class="op" id="3764838">.</span><span class="ident" id="3764839">BlockSize</span><span class="op" id="3764848">(</span><span class="op" id="3764849">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3764854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3764858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764862">if</span>&nbsp;<span class="ident" id="3764865">explicitIVLen</span>&nbsp;<span class="op" id="3764879">==</span>&nbsp;<span class="num" id="3764882">0</span>&nbsp;<span class="op" id="3764884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3764889">if</span>&nbsp;<span class="ident" id="3764892">_</span><span class="op" id="3764893">,</span>&nbsp;<span class="ident" id="3764895">ok</span>&nbsp;<span class="op" id="3764898">:=</span>&nbsp;<span class="ident" id="3764901">c</span><span class="op" id="3764902">.</span><span class="ident" id="3764903">out</span><span class="op" id="3764906">.</span><span class="ident" id="3764907">cipher</span><span class="op" id="3764913">.</span><span class="op" id="3764914">(</span><span class="ident" id="3764915">cipher</span><span class="op" id="3764921">.</span><span class="ident" id="3764922">AEAD</span><span class="op" id="3764926">)</span><span class="op" id="3764927">;</span>&nbsp;<span class="ident" id="3764929">ok</span>&nbsp;<span class="op" id="3764932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3764938">explicitIVLen</span>&nbsp;<span class="op" id="3764952">=</span>&nbsp;<span class="num" id="3764954">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3764960">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765006">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765053">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765103">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765150">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765201">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765222">explicitIVIsSeq</span>&nbsp;<span class="op" id="3765238">=</span>&nbsp;<span class="builtintype" id="3765240">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765256">b</span><span class="op" id="3765257">.</span><span class="ident" id="3765258">resize</span><span class="op" id="3765264">(</span><span class="ident" id="3765265">recordHeaderLen</span>&nbsp;<span class="op" id="3765281">+</span>&nbsp;<span class="ident" id="3765283">explicitIVLen</span>&nbsp;<span class="op" id="3765297">+</span>&nbsp;<span class="ident" id="3765299">m</span><span class="op" id="3765300">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765304">b</span><span class="op" id="3765305">.</span><span class="ident" id="3765306">data</span><span class="op" id="3765310">[</span><span class="num" id="3765311">0</span><span class="op" id="3765312">]</span>&nbsp;<span class="op" id="3765314">=</span>&nbsp;<span class="builtintype" id="3765316">byte</span><span class="op" id="3765320">(</span><span class="ident" id="3765321">typ</span><span class="op" id="3765324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765328">vers</span>&nbsp;<span class="op" id="3765333">:=</span>&nbsp;<span class="ident" id="3765336">c</span><span class="op" id="3765337">.</span><span class="ident" id="3765338">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765345">if</span>&nbsp;<span class="ident" id="3765348">vers</span>&nbsp;<span class="op" id="3765353">==</span>&nbsp;<span class="num" id="3765356">0</span>&nbsp;<span class="op" id="3765358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765363">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3765416">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765472">vers</span>&nbsp;<span class="op" id="3765477">=</span>&nbsp;<span class="ident" id="3765479">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765498">b</span><span class="op" id="3765499">.</span><span class="ident" id="3765500">data</span><span class="op" id="3765504">[</span><span class="num" id="3765505">1</span><span class="op" id="3765506">]</span>&nbsp;<span class="op" id="3765508">=</span>&nbsp;<span class="builtintype" id="3765510">byte</span><span class="op" id="3765514">(</span><span class="ident" id="3765515">vers</span>&nbsp;<span class="op" id="3765520">&gt;&gt;</span>&nbsp;<span class="num" id="3765523">8</span><span class="op" id="3765524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765528">b</span><span class="op" id="3765529">.</span><span class="ident" id="3765530">data</span><span class="op" id="3765534">[</span><span class="num" id="3765535">2</span><span class="op" id="3765536">]</span>&nbsp;<span class="op" id="3765538">=</span>&nbsp;<span class="builtintype" id="3765540">byte</span><span class="op" id="3765544">(</span><span class="ident" id="3765545">vers</span><span class="op" id="3765549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765553">b</span><span class="op" id="3765554">.</span><span class="ident" id="3765555">data</span><span class="op" id="3765559">[</span><span class="num" id="3765560">3</span><span class="op" id="3765561">]</span>&nbsp;<span class="op" id="3765563">=</span>&nbsp;<span class="builtintype" id="3765565">byte</span><span class="op" id="3765569">(</span><span class="ident" id="3765570">m</span>&nbsp;<span class="op" id="3765572">&gt;&gt;</span>&nbsp;<span class="num" id="3765575">8</span><span class="op" id="3765576">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765580">b</span><span class="op" id="3765581">.</span><span class="ident" id="3765582">data</span><span class="op" id="3765586">[</span><span class="num" id="3765587">4</span><span class="op" id="3765588">]</span>&nbsp;<span class="op" id="3765590">=</span>&nbsp;<span class="builtintype" id="3765592">byte</span><span class="op" id="3765596">(</span><span class="ident" id="3765597">m</span><span class="op" id="3765598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765602">if</span>&nbsp;<span class="ident" id="3765605">explicitIVLen</span>&nbsp;<span class="op" id="3765619">&gt;</span>&nbsp;<span class="num" id="3765621">0</span>&nbsp;<span class="op" id="3765623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765628">explicitIV</span>&nbsp;<span class="op" id="3765639">:=</span>&nbsp;<span class="ident" id="3765642">b</span><span class="op" id="3765643">.</span><span class="ident" id="3765644">data</span><span class="op" id="3765648">[</span><span class="ident" id="3765649">recordHeaderLen</span>&nbsp;<span class="op" id="3765665">:</span>&nbsp;<span class="ident" id="3765667">recordHeaderLen</span><span class="op" id="3765682">+</span><span class="ident" id="3765683">explicitIVLen</span><span class="op" id="3765696">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765701">if</span>&nbsp;<span class="ident" id="3765704">explicitIVIsSeq</span>&nbsp;<span class="op" id="3765720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3765726">copy</span><span class="op" id="3765730">(</span><span class="ident" id="3765731">explicitIV</span><span class="op" id="3765741">,</span>&nbsp;<span class="ident" id="3765743">c</span><span class="op" id="3765744">.</span><span class="ident" id="3765745">out</span><span class="op" id="3765748">.</span><span class="ident" id="3765749">seq</span><span class="op" id="3765752">[</span><span class="op" id="3765753">:</span><span class="op" id="3765754">]</span><span class="op" id="3765755">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765760">}</span>&nbsp;<span class="keyword" id="3765762">else</span>&nbsp;<span class="op" id="3765767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765773">if</span>&nbsp;<span class="ident" id="3765776">_</span><span class="op" id="3765777">,</span>&nbsp;<span class="ident" id="3765779">err</span>&nbsp;<span class="op" id="3765783">=</span>&nbsp;<span class="ident" id="3765785">io</span><span class="op" id="3765787">.</span><span class="ident" id="3765788">ReadFull</span><span class="op" id="3765796">(</span><span class="ident" id="3765797">c</span><span class="op" id="3765798">.</span><span class="ident" id="3765799">config</span><span class="op" id="3765805">.</span><span class="ident" id="3765806">rand</span><span class="op" id="3765810">(</span><span class="op" id="3765811">)</span><span class="op" id="3765812">,</span>&nbsp;<span class="ident" id="3765814">explicitIV</span><span class="op" id="3765824">)</span><span class="op" id="3765825">;</span>&nbsp;<span class="ident" id="3765827">err</span>&nbsp;<span class="op" id="3765831">!=</span>&nbsp;<span class="builtintype" id="3765834">nil</span>&nbsp;<span class="op" id="3765838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765845">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765860">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3765864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3765868">copy</span><span class="op" id="3765872">(</span><span class="ident" id="3765873">b</span><span class="op" id="3765874">.</span><span class="ident" id="3765875">data</span><span class="op" id="3765879">[</span><span class="ident" id="3765880">recordHeaderLen</span><span class="op" id="3765895">+</span><span class="ident" id="3765896">explicitIVLen</span><span class="op" id="3765909">:</span><span class="op" id="3765910">]</span><span class="op" id="3765911">,</span>&nbsp;<span class="ident" id="3765913">data</span><span class="op" id="3765917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765921">c</span><span class="op" id="3765922">.</span><span class="ident" id="3765923">out</span><span class="op" id="3765926">.</span><span class="ident" id="3765927">encrypt</span><span class="op" id="3765934">(</span><span class="ident" id="3765935">b</span><span class="op" id="3765936">,</span>&nbsp;<span class="ident" id="3765938">explicitIVLen</span><span class="op" id="3765951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3765955">_</span><span class="op" id="3765956">,</span>&nbsp;<span class="ident" id="3765958">err</span>&nbsp;<span class="op" id="3765962">=</span>&nbsp;<span class="ident" id="3765964">c</span><span class="op" id="3765965">.</span><span class="ident" id="3765966">conn</span><span class="op" id="3765970">.</span><span class="ident" id="3765971">Write</span><span class="op" id="3765976">(</span><span class="ident" id="3765977">b</span><span class="op" id="3765978">.</span><span class="ident" id="3765979">data</span><span class="op" id="3765983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3765987">if</span>&nbsp;<span class="ident" id="3765990">err</span>&nbsp;<span class="op" id="3765994">!=</span>&nbsp;<span class="builtintype" id="3765997">nil</span>&nbsp;<span class="op" id="3766001">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766006">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766018">n</span>&nbsp;<span class="op" id="3766020">+=</span>&nbsp;<span class="ident" id="3766023">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766027">data</span>&nbsp;<span class="op" id="3766032">=</span>&nbsp;<span class="ident" id="3766034">data</span><span class="op" id="3766038">[</span><span class="ident" id="3766039">m</span><span class="op" id="3766040">:</span><span class="op" id="3766041">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766044">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766047">c</span><span class="op" id="3766048">.</span><span class="ident" id="3766049">out</span><span class="op" id="3766052">.</span><span class="ident" id="3766053">freeBlock</span><span class="op" id="3766062">(</span><span class="ident" id="3766063">b</span><span class="op" id="3766064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766068">if</span>&nbsp;<span class="ident" id="3766071">typ</span>&nbsp;<span class="op" id="3766075">==</span>&nbsp;<span class="ident" id="3766078">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3766105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766109">err</span>&nbsp;<span class="op" id="3766113">=</span>&nbsp;<span class="ident" id="3766115">c</span><span class="op" id="3766116">.</span><span class="ident" id="3766117">out</span><span class="op" id="3766120">.</span><span class="ident" id="3766121">changeCipherSpec</span><span class="op" id="3766137">(</span><span class="op" id="3766138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766142">if</span>&nbsp;<span class="ident" id="3766145">err</span>&nbsp;<span class="op" id="3766149">!=</span>&nbsp;<span class="builtintype" id="3766152">nil</span>&nbsp;<span class="op" id="3766156">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3766161">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3766199">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766242">c</span><span class="op" id="3766243">.</span><span class="ident" id="3766244">tmp</span><span class="op" id="3766247">[</span><span class="num" id="3766248">0</span><span class="op" id="3766249">]</span>&nbsp;<span class="op" id="3766251">=</span>&nbsp;<span class="ident" id="3766253">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766272">c</span><span class="op" id="3766273">.</span><span class="ident" id="3766274">tmp</span><span class="op" id="3766277">[</span><span class="num" id="3766278">1</span><span class="op" id="3766279">]</span>&nbsp;<span class="op" id="3766281">=</span>&nbsp;<span class="builtintype" id="3766283">byte</span><span class="op" id="3766287">(</span><span class="ident" id="3766288">err</span><span class="op" id="3766291">.</span><span class="op" id="3766292">(</span><span class="ident" id="3766293">alert</span><span class="op" id="3766298">)</span><span class="op" id="3766299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766304">c</span><span class="op" id="3766305">.</span><span class="ident" id="3766306">writeRecord</span><span class="op" id="3766317">(</span><span class="ident" id="3766318">recordTypeAlert</span><span class="op" id="3766333">,</span>&nbsp;<span class="ident" id="3766335">c</span><span class="op" id="3766336">.</span><span class="ident" id="3766337">tmp</span><span class="op" id="3766340">[</span><span class="num" id="3766341">0</span><span class="op" id="3766342">:</span><span class="num" id="3766343">2</span><span class="op" id="3766344">]</span><span class="op" id="3766345">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766350">return</span>&nbsp;<span class="ident" id="3766357">n</span><span class="op" id="3766358">,</span>&nbsp;<span class="ident" id="3766360">c</span><span class="op" id="3766361">.</span><span class="ident" id="3766362">out</span><span class="op" id="3766365">.</span><span class="ident" id="3766366">setErrorLocked</span><span class="op" id="3766380">(</span><span class="op" id="3766381">&amp;</span><span class="ident" id="3766382">net</span><span class="op" id="3766385">.</span><span class="ident" id="3766386">OpError</span><span class="op" id="3766393">{</span><span class="ident" id="3766394">Op</span><span class="op" id="3766396">:</span>&nbsp;<span class="string" id="3766398">&#34;local&nbsp;error&#34;</span><span class="op" id="3766411">,</span>&nbsp;<span class="ident" id="3766413">Err</span><span class="op" id="3766416">:</span>&nbsp;<span class="ident" id="3766418">err</span><span class="op" id="3766421">}</span><span class="op" id="3766422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766432">return</span><br>
<span class="lineno"></span><span class="op" id="3766439">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3766442">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3766497">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3766518">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3766554">func</span>&nbsp;<span class="op" id="3766559">(</span><span class="ident" id="3766560">c</span>&nbsp;<span class="op" id="3766562">*</span><span class="ident" id="3766563">Conn</span><span class="op" id="3766567">)</span>&nbsp;<span class="ident" id="3766569">readHandshake</span><span class="op" id="3766582">(</span><span class="op" id="3766583">)</span>&nbsp;<span class="op" id="3766585">(</span><span class="keyword" id="3766586">interface</span><span class="op" id="3766595">{</span><span class="op" id="3766596">}</span><span class="op" id="3766597">,</span>&nbsp;<span class="builtintype" id="3766599">error</span><span class="op" id="3766604">)</span>&nbsp;<span class="op" id="3766606">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766609">for</span>&nbsp;<span class="ident" id="3766613">c</span><span class="op" id="3766614">.</span><span class="ident" id="3766615">hand</span><span class="op" id="3766619">.</span><span class="ident" id="3766620">Len</span><span class="op" id="3766623">(</span><span class="op" id="3766624">)</span>&nbsp;<span class="op" id="3766626">&lt;</span>&nbsp;<span class="num" id="3766628">4</span>&nbsp;<span class="op" id="3766630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766634">if</span>&nbsp;<span class="ident" id="3766637">err</span>&nbsp;<span class="op" id="3766641">:=</span>&nbsp;<span class="ident" id="3766644">c</span><span class="op" id="3766645">.</span><span class="ident" id="3766646">in</span><span class="op" id="3766648">.</span><span class="ident" id="3766649">err</span><span class="op" id="3766652">;</span>&nbsp;<span class="ident" id="3766654">err</span>&nbsp;<span class="op" id="3766658">!=</span>&nbsp;<span class="builtintype" id="3766661">nil</span>&nbsp;<span class="op" id="3766665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766670">return</span>&nbsp;<span class="builtintype" id="3766677">nil</span><span class="op" id="3766680">,</span>&nbsp;<span class="ident" id="3766682">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766692">if</span>&nbsp;<span class="ident" id="3766695">err</span>&nbsp;<span class="op" id="3766699">:=</span>&nbsp;<span class="ident" id="3766702">c</span><span class="op" id="3766703">.</span><span class="ident" id="3766704">readRecord</span><span class="op" id="3766714">(</span><span class="ident" id="3766715">recordTypeHandshake</span><span class="op" id="3766734">)</span><span class="op" id="3766735">;</span>&nbsp;<span class="ident" id="3766737">err</span>&nbsp;<span class="op" id="3766741">!=</span>&nbsp;<span class="builtintype" id="3766744">nil</span>&nbsp;<span class="op" id="3766748">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766753">return</span>&nbsp;<span class="builtintype" id="3766760">nil</span><span class="op" id="3766763">,</span>&nbsp;<span class="ident" id="3766765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766778">data</span>&nbsp;<span class="op" id="3766783">:=</span>&nbsp;<span class="ident" id="3766786">c</span><span class="op" id="3766787">.</span><span class="ident" id="3766788">hand</span><span class="op" id="3766792">.</span><span class="ident" id="3766793">Bytes</span><span class="op" id="3766798">(</span><span class="op" id="3766799">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3766802">n</span>&nbsp;<span class="op" id="3766804">:=</span>&nbsp;<span class="builtintype" id="3766807">int</span><span class="op" id="3766810">(</span><span class="ident" id="3766811">data</span><span class="op" id="3766815">[</span><span class="num" id="3766816">1</span><span class="op" id="3766817">]</span><span class="op" id="3766818">)</span><span class="op" id="3766819">&lt;&lt;</span><span class="num" id="3766821">16</span>&nbsp;<span class="op" id="3766824">|</span>&nbsp;<span class="builtintype" id="3766826">int</span><span class="op" id="3766829">(</span><span class="ident" id="3766830">data</span><span class="op" id="3766834">[</span><span class="num" id="3766835">2</span><span class="op" id="3766836">]</span><span class="op" id="3766837">)</span><span class="op" id="3766838">&lt;&lt;</span><span class="num" id="3766840">8</span>&nbsp;<span class="op" id="3766842">|</span>&nbsp;<span class="builtintype" id="3766844">int</span><span class="op" id="3766847">(</span><span class="ident" id="3766848">data</span><span class="op" id="3766852">[</span><span class="num" id="3766853">3</span><span class="op" id="3766854">]</span><span class="op" id="3766855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766858">if</span>&nbsp;<span class="ident" id="3766861">n</span>&nbsp;<span class="op" id="3766863">&gt;</span>&nbsp;<span class="ident" id="3766865">maxHandshake</span>&nbsp;<span class="op" id="3766878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766882">return</span>&nbsp;<span class="builtintype" id="3766889">nil</span><span class="op" id="3766892">,</span>&nbsp;<span class="ident" id="3766894">c</span><span class="op" id="3766895">.</span><span class="ident" id="3766896">in</span><span class="op" id="3766898">.</span><span class="ident" id="3766899">setErrorLocked</span><span class="op" id="3766913">(</span><span class="ident" id="3766914">c</span><span class="op" id="3766915">.</span><span class="ident" id="3766916">sendAlert</span><span class="op" id="3766925">(</span><span class="ident" id="3766926">alertInternalError</span><span class="op" id="3766944">)</span><span class="op" id="3766945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3766948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766951">for</span>&nbsp;<span class="ident" id="3766955">c</span><span class="op" id="3766956">.</span><span class="ident" id="3766957">hand</span><span class="op" id="3766961">.</span><span class="ident" id="3766962">Len</span><span class="op" id="3766965">(</span><span class="op" id="3766966">)</span>&nbsp;<span class="op" id="3766968">&lt;</span>&nbsp;<span class="num" id="3766970">4</span><span class="op" id="3766971">+</span><span class="ident" id="3766972">n</span>&nbsp;<span class="op" id="3766974">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3766978">if</span>&nbsp;<span class="ident" id="3766981">err</span>&nbsp;<span class="op" id="3766985">:=</span>&nbsp;<span class="ident" id="3766988">c</span><span class="op" id="3766989">.</span><span class="ident" id="3766990">in</span><span class="op" id="3766992">.</span><span class="ident" id="3766993">err</span><span class="op" id="3766996">;</span>&nbsp;<span class="ident" id="3766998">err</span>&nbsp;<span class="op" id="3767002">!=</span>&nbsp;<span class="builtintype" id="3767005">nil</span>&nbsp;<span class="op" id="3767009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767014">return</span>&nbsp;<span class="builtintype" id="3767021">nil</span><span class="op" id="3767024">,</span>&nbsp;<span class="ident" id="3767026">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3767032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767036">if</span>&nbsp;<span class="ident" id="3767039">err</span>&nbsp;<span class="op" id="3767043">:=</span>&nbsp;<span class="ident" id="3767046">c</span><span class="op" id="3767047">.</span><span class="ident" id="3767048">readRecord</span><span class="op" id="3767058">(</span><span class="ident" id="3767059">recordTypeHandshake</span><span class="op" id="3767078">)</span><span class="op" id="3767079">;</span>&nbsp;<span class="ident" id="3767081">err</span>&nbsp;<span class="op" id="3767085">!=</span>&nbsp;<span class="builtintype" id="3767088">nil</span>&nbsp;<span class="op" id="3767092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767097">return</span>&nbsp;<span class="builtintype" id="3767104">nil</span><span class="op" id="3767107">,</span>&nbsp;<span class="ident" id="3767109">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3767115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3767118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767121">data</span>&nbsp;<span class="op" id="3767126">=</span>&nbsp;<span class="ident" id="3767128">c</span><span class="op" id="3767129">.</span><span class="ident" id="3767130">hand</span><span class="op" id="3767134">.</span><span class="ident" id="3767135">Next</span><span class="op" id="3767139">(</span><span class="num" id="3767140">4</span>&nbsp;<span class="op" id="3767142">+</span>&nbsp;<span class="ident" id="3767144">n</span><span class="op" id="3767145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767148">var</span>&nbsp;<span class="ident" id="3767152">m</span>&nbsp;<span class="ident" id="3767154">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767172">switch</span>&nbsp;<span class="ident" id="3767179">data</span><span class="op" id="3767183">[</span><span class="num" id="3767184">0</span><span class="op" id="3767185">]</span>&nbsp;<span class="op" id="3767187">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767190">case</span>&nbsp;<span class="ident" id="3767195">typeClientHello</span><span class="op" id="3767210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767214">m</span>&nbsp;<span class="op" id="3767216">=</span>&nbsp;<span class="builtinfunc" id="3767218">new</span><span class="op" id="3767221">(</span><span class="ident" id="3767222">clientHelloMsg</span><span class="op" id="3767236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767239">case</span>&nbsp;<span class="ident" id="3767244">typeServerHello</span><span class="op" id="3767259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767263">m</span>&nbsp;<span class="op" id="3767265">=</span>&nbsp;<span class="builtinfunc" id="3767267">new</span><span class="op" id="3767270">(</span><span class="ident" id="3767271">serverHelloMsg</span><span class="op" id="3767285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767288">case</span>&nbsp;<span class="ident" id="3767293">typeNewSessionTicket</span><span class="op" id="3767313">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767317">m</span>&nbsp;<span class="op" id="3767319">=</span>&nbsp;<span class="builtinfunc" id="3767321">new</span><span class="op" id="3767324">(</span><span class="ident" id="3767325">newSessionTicketMsg</span><span class="op" id="3767344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767347">case</span>&nbsp;<span class="ident" id="3767352">typeCertificate</span><span class="op" id="3767367">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767371">m</span>&nbsp;<span class="op" id="3767373">=</span>&nbsp;<span class="builtinfunc" id="3767375">new</span><span class="op" id="3767378">(</span><span class="ident" id="3767379">certificateMsg</span><span class="op" id="3767393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767396">case</span>&nbsp;<span class="ident" id="3767401">typeCertificateRequest</span><span class="op" id="3767423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767427">m</span>&nbsp;<span class="op" id="3767429">=</span>&nbsp;<span class="op" id="3767431">&amp;</span><span class="ident" id="3767432">certificateRequestMsg</span><span class="op" id="3767453">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767458">hasSignatureAndHash</span><span class="op" id="3767477">:</span>&nbsp;<span class="ident" id="3767479">c</span><span class="op" id="3767480">.</span><span class="ident" id="3767481">vers</span>&nbsp;<span class="op" id="3767486">&gt;=</span>&nbsp;<span class="ident" id="3767489">VersionTLS12</span><span class="op" id="3767501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3767505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767508">case</span>&nbsp;<span class="ident" id="3767513">typeCertificateStatus</span><span class="op" id="3767534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767538">m</span>&nbsp;<span class="op" id="3767540">=</span>&nbsp;<span class="builtinfunc" id="3767542">new</span><span class="op" id="3767545">(</span><span class="ident" id="3767546">certificateStatusMsg</span><span class="op" id="3767566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767569">case</span>&nbsp;<span class="ident" id="3767574">typeServerKeyExchange</span><span class="op" id="3767595">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767599">m</span>&nbsp;<span class="op" id="3767601">=</span>&nbsp;<span class="builtinfunc" id="3767603">new</span><span class="op" id="3767606">(</span><span class="ident" id="3767607">serverKeyExchangeMsg</span><span class="op" id="3767627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767630">case</span>&nbsp;<span class="ident" id="3767635">typeServerHelloDone</span><span class="op" id="3767654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767658">m</span>&nbsp;<span class="op" id="3767660">=</span>&nbsp;<span class="builtinfunc" id="3767662">new</span><span class="op" id="3767665">(</span><span class="ident" id="3767666">serverHelloDoneMsg</span><span class="op" id="3767684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767687">case</span>&nbsp;<span class="ident" id="3767692">typeClientKeyExchange</span><span class="op" id="3767713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767717">m</span>&nbsp;<span class="op" id="3767719">=</span>&nbsp;<span class="builtinfunc" id="3767721">new</span><span class="op" id="3767724">(</span><span class="ident" id="3767725">clientKeyExchangeMsg</span><span class="op" id="3767745">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767748">case</span>&nbsp;<span class="ident" id="3767753">typeCertificateVerify</span><span class="op" id="3767774">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767778">m</span>&nbsp;<span class="op" id="3767780">=</span>&nbsp;<span class="op" id="3767782">&amp;</span><span class="ident" id="3767783">certificateVerifyMsg</span><span class="op" id="3767803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767808">hasSignatureAndHash</span><span class="op" id="3767827">:</span>&nbsp;<span class="ident" id="3767829">c</span><span class="op" id="3767830">.</span><span class="ident" id="3767831">vers</span>&nbsp;<span class="op" id="3767836">&gt;=</span>&nbsp;<span class="ident" id="3767839">VersionTLS12</span><span class="op" id="3767851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3767855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767858">case</span>&nbsp;<span class="ident" id="3767863">typeNextProtocol</span><span class="op" id="3767879">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767883">m</span>&nbsp;<span class="op" id="3767885">=</span>&nbsp;<span class="builtinfunc" id="3767887">new</span><span class="op" id="3767890">(</span><span class="ident" id="3767891">nextProtoMsg</span><span class="op" id="3767903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767906">case</span>&nbsp;<span class="ident" id="3767911">typeFinished</span><span class="op" id="3767923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3767927">m</span>&nbsp;<span class="op" id="3767929">=</span>&nbsp;<span class="builtinfunc" id="3767931">new</span><span class="op" id="3767934">(</span><span class="ident" id="3767935">finishedMsg</span><span class="op" id="3767946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767949">default</span><span class="op" id="3767956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3767960">return</span>&nbsp;<span class="builtintype" id="3767967">nil</span><span class="op" id="3767970">,</span>&nbsp;<span class="ident" id="3767972">c</span><span class="op" id="3767973">.</span><span class="ident" id="3767974">in</span><span class="op" id="3767976">.</span><span class="ident" id="3767977">setErrorLocked</span><span class="op" id="3767991">(</span><span class="ident" id="3767992">c</span><span class="op" id="3767993">.</span><span class="ident" id="3767994">sendAlert</span><span class="op" id="3768003">(</span><span class="ident" id="3768004">alertUnexpectedMessage</span><span class="op" id="3768026">)</span><span class="op" id="3768027">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3768030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768034">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768074">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768124">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3768179">data</span>&nbsp;<span class="op" id="3768184">=</span>&nbsp;<span class="builtinfunc" id="3768186">append</span><span class="op" id="3768192">(</span><span class="op" id="3768193">[</span><span class="op" id="3768194">]</span><span class="builtintype" id="3768195">byte</span><span class="op" id="3768199">(</span><span class="builtintype" id="3768200">nil</span><span class="op" id="3768203">)</span><span class="op" id="3768204">,</span>&nbsp;<span class="ident" id="3768206">data</span><span class="op" id="3768210">...</span><span class="op" id="3768213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768217">if</span>&nbsp;<span class="op" id="3768220">!</span><span class="ident" id="3768221">m</span><span class="op" id="3768222">.</span><span class="ident" id="3768223">unmarshal</span><span class="op" id="3768232">(</span><span class="ident" id="3768233">data</span><span class="op" id="3768237">)</span>&nbsp;<span class="op" id="3768239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768243">return</span>&nbsp;<span class="builtintype" id="3768250">nil</span><span class="op" id="3768253">,</span>&nbsp;<span class="ident" id="3768255">c</span><span class="op" id="3768256">.</span><span class="ident" id="3768257">in</span><span class="op" id="3768259">.</span><span class="ident" id="3768260">setErrorLocked</span><span class="op" id="3768274">(</span><span class="ident" id="3768275">c</span><span class="op" id="3768276">.</span><span class="ident" id="3768277">sendAlert</span><span class="op" id="3768286">(</span><span class="ident" id="3768287">alertUnexpectedMessage</span><span class="op" id="3768309">)</span><span class="op" id="3768310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3768313">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768316">return</span>&nbsp;<span class="ident" id="3768323">m</span><span class="op" id="3768324">,</span>&nbsp;<span class="builtintype" id="3768326">nil</span><br>
<span class="lineno"></span><span class="op" id="3768330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3768333">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3768373">func</span>&nbsp;<span class="op" id="3768378">(</span><span class="ident" id="3768379">c</span>&nbsp;<span class="op" id="3768381">*</span><span class="ident" id="3768382">Conn</span><span class="op" id="3768386">)</span>&nbsp;<span class="ident" id="3768388">Write</span><span class="op" id="3768393">(</span><span class="ident" id="3768394">b</span>&nbsp;<span class="op" id="3768396">[</span><span class="op" id="3768397">]</span><span class="builtintype" id="3768398">byte</span><span class="op" id="3768402">)</span>&nbsp;<span class="op" id="3768404">(</span><span class="builtintype" id="3768405">int</span><span class="op" id="3768408">,</span>&nbsp;<span class="builtintype" id="3768410">error</span><span class="op" id="3768415">)</span>&nbsp;<span class="op" id="3768417">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768420">if</span>&nbsp;<span class="ident" id="3768423">err</span>&nbsp;<span class="op" id="3768427">:=</span>&nbsp;<span class="ident" id="3768430">c</span><span class="op" id="3768431">.</span><span class="ident" id="3768432">Handshake</span><span class="op" id="3768441">(</span><span class="op" id="3768442">)</span><span class="op" id="3768443">;</span>&nbsp;<span class="ident" id="3768445">err</span>&nbsp;<span class="op" id="3768449">!=</span>&nbsp;<span class="builtintype" id="3768452">nil</span>&nbsp;<span class="op" id="3768456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768460">return</span>&nbsp;<span class="num" id="3768467">0</span><span class="op" id="3768468">,</span>&nbsp;<span class="ident" id="3768470">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3768475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3768479">c</span><span class="op" id="3768480">.</span><span class="ident" id="3768481">out</span><span class="op" id="3768484">.</span><span class="ident" id="3768485">Lock</span><span class="op" id="3768489">(</span><span class="op" id="3768490">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768493">defer</span>&nbsp;<span class="ident" id="3768499">c</span><span class="op" id="3768500">.</span><span class="ident" id="3768501">out</span><span class="op" id="3768504">.</span><span class="ident" id="3768505">Unlock</span><span class="op" id="3768511">(</span><span class="op" id="3768512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768516">if</span>&nbsp;<span class="ident" id="3768519">err</span>&nbsp;<span class="op" id="3768523">:=</span>&nbsp;<span class="ident" id="3768526">c</span><span class="op" id="3768527">.</span><span class="ident" id="3768528">out</span><span class="op" id="3768531">.</span><span class="ident" id="3768532">err</span><span class="op" id="3768535">;</span>&nbsp;<span class="ident" id="3768537">err</span>&nbsp;<span class="op" id="3768541">!=</span>&nbsp;<span class="builtintype" id="3768544">nil</span>&nbsp;<span class="op" id="3768548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768552">return</span>&nbsp;<span class="num" id="3768559">0</span><span class="op" id="3768560">,</span>&nbsp;<span class="ident" id="3768562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3768567">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768571">if</span>&nbsp;<span class="op" id="3768574">!</span><span class="ident" id="3768575">c</span><span class="op" id="3768576">.</span><span class="ident" id="3768577">handshakeComplete</span>&nbsp;<span class="op" id="3768595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3768599">return</span>&nbsp;<span class="num" id="3768606">0</span><span class="op" id="3768607">,</span>&nbsp;<span class="ident" id="3768609">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3768629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768633">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768695">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768760">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768821">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768882">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768886">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768931">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3768987">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769052">var</span>&nbsp;<span class="ident" id="3769056">m</span>&nbsp;<span class="builtintype" id="3769058">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769063">if</span>&nbsp;<span class="builtinfunc" id="3769066">len</span><span class="op" id="3769069">(</span><span class="ident" id="3769070">b</span><span class="op" id="3769071">)</span>&nbsp;<span class="op" id="3769073">&gt;</span>&nbsp;<span class="num" id="3769075">1</span>&nbsp;<span class="op" id="3769077">&amp;&amp;</span>&nbsp;<span class="ident" id="3769080">c</span><span class="op" id="3769081">.</span><span class="ident" id="3769082">vers</span>&nbsp;<span class="op" id="3769087">&lt;=</span>&nbsp;<span class="ident" id="3769090">VersionTLS10</span>&nbsp;<span class="op" id="3769103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769107">if</span>&nbsp;<span class="ident" id="3769110">_</span><span class="op" id="3769111">,</span>&nbsp;<span class="ident" id="3769113">ok</span>&nbsp;<span class="op" id="3769116">:=</span>&nbsp;<span class="ident" id="3769119">c</span><span class="op" id="3769120">.</span><span class="ident" id="3769121">out</span><span class="op" id="3769124">.</span><span class="ident" id="3769125">cipher</span><span class="op" id="3769131">.</span><span class="op" id="3769132">(</span><span class="ident" id="3769133">cipher</span><span class="op" id="3769139">.</span><span class="ident" id="3769140">BlockMode</span><span class="op" id="3769149">)</span><span class="op" id="3769150">;</span>&nbsp;<span class="ident" id="3769152">ok</span>&nbsp;<span class="op" id="3769155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3769160">n</span><span class="op" id="3769161">,</span>&nbsp;<span class="ident" id="3769163">err</span>&nbsp;<span class="op" id="3769167">:=</span>&nbsp;<span class="ident" id="3769170">c</span><span class="op" id="3769171">.</span><span class="ident" id="3769172">writeRecord</span><span class="op" id="3769183">(</span><span class="ident" id="3769184">recordTypeApplicationData</span><span class="op" id="3769209">,</span>&nbsp;<span class="ident" id="3769211">b</span><span class="op" id="3769212">[</span><span class="op" id="3769213">:</span><span class="num" id="3769214">1</span><span class="op" id="3769215">]</span><span class="op" id="3769216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769221">if</span>&nbsp;<span class="ident" id="3769224">err</span>&nbsp;<span class="op" id="3769228">!=</span>&nbsp;<span class="builtintype" id="3769231">nil</span>&nbsp;<span class="op" id="3769235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769241">return</span>&nbsp;<span class="ident" id="3769248">n</span><span class="op" id="3769249">,</span>&nbsp;<span class="ident" id="3769251">c</span><span class="op" id="3769252">.</span><span class="ident" id="3769253">out</span><span class="op" id="3769256">.</span><span class="ident" id="3769257">setErrorLocked</span><span class="op" id="3769271">(</span><span class="ident" id="3769272">err</span><span class="op" id="3769275">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3769280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3769285">m</span><span class="op" id="3769286">,</span>&nbsp;<span class="ident" id="3769288">b</span>&nbsp;<span class="op" id="3769290">=</span>&nbsp;<span class="num" id="3769292">1</span><span class="op" id="3769293">,</span>&nbsp;<span class="ident" id="3769295">b</span><span class="op" id="3769296">[</span><span class="num" id="3769297">1</span><span class="op" id="3769298">:</span><span class="op" id="3769299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3769303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3769306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3769310">n</span><span class="op" id="3769311">,</span>&nbsp;<span class="ident" id="3769313">err</span>&nbsp;<span class="op" id="3769317">:=</span>&nbsp;<span class="ident" id="3769320">c</span><span class="op" id="3769321">.</span><span class="ident" id="3769322">writeRecord</span><span class="op" id="3769333">(</span><span class="ident" id="3769334">recordTypeApplicationData</span><span class="op" id="3769359">,</span>&nbsp;<span class="ident" id="3769361">b</span><span class="op" id="3769362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769365">return</span>&nbsp;<span class="ident" id="3769372">n</span>&nbsp;<span class="op" id="3769374">+</span>&nbsp;<span class="ident" id="3769376">m</span><span class="op" id="3769377">,</span>&nbsp;<span class="ident" id="3769379">c</span><span class="op" id="3769380">.</span><span class="ident" id="3769381">out</span><span class="op" id="3769384">.</span><span class="ident" id="3769385">setErrorLocked</span><span class="op" id="3769399">(</span><span class="ident" id="3769400">err</span><span class="op" id="3769403">)</span><br>
<span class="lineno"></span><span class="op" id="3769405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3769408">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3769486">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3769552">func</span>&nbsp;<span class="op" id="3769557">(</span><span class="ident" id="3769558">c</span>&nbsp;<span class="op" id="3769560">*</span><span class="ident" id="3769561">Conn</span><span class="op" id="3769565">)</span>&nbsp;<span class="ident" id="3769567">Read</span><span class="op" id="3769571">(</span><span class="ident" id="3769572">b</span>&nbsp;<span class="op" id="3769574">[</span><span class="op" id="3769575">]</span><span class="builtintype" id="3769576">byte</span><span class="op" id="3769580">)</span>&nbsp;<span class="op" id="3769582">(</span><span class="ident" id="3769583">n</span>&nbsp;<span class="builtintype" id="3769585">int</span><span class="op" id="3769588">,</span>&nbsp;<span class="ident" id="3769590">err</span>&nbsp;<span class="builtintype" id="3769594">error</span><span class="op" id="3769599">)</span>&nbsp;<span class="op" id="3769601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769604">if</span>&nbsp;<span class="ident" id="3769607">err</span>&nbsp;<span class="op" id="3769611">=</span>&nbsp;<span class="ident" id="3769613">c</span><span class="op" id="3769614">.</span><span class="ident" id="3769615">Handshake</span><span class="op" id="3769624">(</span><span class="op" id="3769625">)</span><span class="op" id="3769626">;</span>&nbsp;<span class="ident" id="3769628">err</span>&nbsp;<span class="op" id="3769632">!=</span>&nbsp;<span class="builtintype" id="3769635">nil</span>&nbsp;<span class="op" id="3769639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769643">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3769651">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769654">if</span>&nbsp;<span class="builtinfunc" id="3769657">len</span><span class="op" id="3769660">(</span><span class="ident" id="3769661">b</span><span class="op" id="3769662">)</span>&nbsp;<span class="op" id="3769664">==</span>&nbsp;<span class="num" id="3769667">0</span>&nbsp;<span class="op" id="3769669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3769673">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3769732">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3769793">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3769797">c</span><span class="op" id="3769798">.</span><span class="ident" id="3769799">in</span><span class="op" id="3769801">.</span><span class="ident" id="3769802">Lock</span><span class="op" id="3769806">(</span><span class="op" id="3769807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769810">defer</span>&nbsp;<span class="ident" id="3769816">c</span><span class="op" id="3769817">.</span><span class="ident" id="3769818">in</span><span class="op" id="3769820">.</span><span class="ident" id="3769821">Unlock</span><span class="op" id="3769827">(</span><span class="op" id="3769828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3769832">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3769902">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3769970">const</span>&nbsp;<span class="ident" id="3769976">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3770003">=</span>&nbsp;<span class="num" id="3770005">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770010">for</span>&nbsp;<span class="ident" id="3770014">emptyRecordCount</span>&nbsp;<span class="op" id="3770031">:=</span>&nbsp;<span class="num" id="3770034">0</span><span class="op" id="3770035">;</span>&nbsp;<span class="ident" id="3770037">emptyRecordCount</span>&nbsp;<span class="op" id="3770054">&lt;=</span>&nbsp;<span class="ident" id="3770057">maxConsecutiveEmptyRecords</span><span class="op" id="3770083">;</span>&nbsp;<span class="ident" id="3770085">emptyRecordCount</span><span class="op" id="3770101">++</span>&nbsp;<span class="op" id="3770104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770108">for</span>&nbsp;<span class="ident" id="3770112">c</span><span class="op" id="3770113">.</span><span class="ident" id="3770114">input</span>&nbsp;<span class="op" id="3770120">==</span>&nbsp;<span class="builtintype" id="3770123">nil</span>&nbsp;<span class="op" id="3770127">&amp;&amp;</span>&nbsp;<span class="ident" id="3770130">c</span><span class="op" id="3770131">.</span><span class="ident" id="3770132">in</span><span class="op" id="3770134">.</span><span class="ident" id="3770135">err</span>&nbsp;<span class="op" id="3770139">==</span>&nbsp;<span class="builtintype" id="3770142">nil</span>&nbsp;<span class="op" id="3770146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770151">if</span>&nbsp;<span class="ident" id="3770154">err</span>&nbsp;<span class="op" id="3770158">:=</span>&nbsp;<span class="ident" id="3770161">c</span><span class="op" id="3770162">.</span><span class="ident" id="3770163">readRecord</span><span class="op" id="3770173">(</span><span class="ident" id="3770174">recordTypeApplicationData</span><span class="op" id="3770199">)</span><span class="op" id="3770200">;</span>&nbsp;<span class="ident" id="3770202">err</span>&nbsp;<span class="op" id="3770206">!=</span>&nbsp;<span class="builtintype" id="3770209">nil</span>&nbsp;<span class="op" id="3770213">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770219">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770250">return</span>&nbsp;<span class="num" id="3770257">0</span><span class="op" id="3770258">,</span>&nbsp;<span class="ident" id="3770260">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3770267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3770271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770275">if</span>&nbsp;<span class="ident" id="3770278">err</span>&nbsp;<span class="op" id="3770282">:=</span>&nbsp;<span class="ident" id="3770285">c</span><span class="op" id="3770286">.</span><span class="ident" id="3770287">in</span><span class="op" id="3770289">.</span><span class="ident" id="3770290">err</span><span class="op" id="3770293">;</span>&nbsp;<span class="ident" id="3770295">err</span>&nbsp;<span class="op" id="3770299">!=</span>&nbsp;<span class="builtintype" id="3770302">nil</span>&nbsp;<span class="op" id="3770306">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770311">return</span>&nbsp;<span class="num" id="3770318">0</span><span class="op" id="3770319">,</span>&nbsp;<span class="ident" id="3770321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3770327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3770332">n</span><span class="op" id="3770333">,</span>&nbsp;<span class="ident" id="3770335">err</span>&nbsp;<span class="op" id="3770339">=</span>&nbsp;<span class="ident" id="3770341">c</span><span class="op" id="3770342">.</span><span class="ident" id="3770343">input</span><span class="op" id="3770348">.</span><span class="ident" id="3770349">Read</span><span class="op" id="3770353">(</span><span class="ident" id="3770354">b</span><span class="op" id="3770355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770359">if</span>&nbsp;<span class="ident" id="3770362">c</span><span class="op" id="3770363">.</span><span class="ident" id="3770364">input</span><span class="op" id="3770369">.</span><span class="ident" id="3770370">off</span>&nbsp;<span class="op" id="3770374">&gt;=</span>&nbsp;<span class="builtinfunc" id="3770377">len</span><span class="op" id="3770380">(</span><span class="ident" id="3770381">c</span><span class="op" id="3770382">.</span><span class="ident" id="3770383">input</span><span class="op" id="3770388">.</span><span class="ident" id="3770389">data</span><span class="op" id="3770393">)</span>&nbsp;<span class="op" id="3770395">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3770400">c</span><span class="op" id="3770401">.</span><span class="ident" id="3770402">in</span><span class="op" id="3770404">.</span><span class="ident" id="3770405">freeBlock</span><span class="op" id="3770414">(</span><span class="ident" id="3770415">c</span><span class="op" id="3770416">.</span><span class="ident" id="3770417">input</span><span class="op" id="3770422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3770427">c</span><span class="op" id="3770428">.</span><span class="ident" id="3770429">input</span>&nbsp;<span class="op" id="3770435">=</span>&nbsp;<span class="builtintype" id="3770437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3770443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770448">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770505">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770564">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770617">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770671">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770724">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770780">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770837">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770887">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770901">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3770950">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3770988">if</span>&nbsp;<span class="ident" id="3770991">ri</span>&nbsp;<span class="op" id="3770994">:=</span>&nbsp;<span class="ident" id="3770997">c</span><span class="op" id="3770998">.</span><span class="ident" id="3770999">rawInput</span><span class="op" id="3771007">;</span>&nbsp;<span class="ident" id="3771009">ri</span>&nbsp;<span class="op" id="3771012">!=</span>&nbsp;<span class="builtintype" id="3771015">nil</span>&nbsp;<span class="op" id="3771019">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771025">n</span>&nbsp;<span class="op" id="3771027">!=</span>&nbsp;<span class="num" id="3771030">0</span>&nbsp;<span class="op" id="3771032">&amp;&amp;</span>&nbsp;<span class="ident" id="3771035">err</span>&nbsp;<span class="op" id="3771039">==</span>&nbsp;<span class="builtintype" id="3771042">nil</span>&nbsp;<span class="op" id="3771046">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771052">c</span><span class="op" id="3771053">.</span><span class="ident" id="3771054">input</span>&nbsp;<span class="op" id="3771060">==</span>&nbsp;<span class="builtintype" id="3771063">nil</span>&nbsp;<span class="op" id="3771067">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3771070">len</span><span class="op" id="3771073">(</span><span class="ident" id="3771074">ri</span><span class="op" id="3771076">.</span><span class="ident" id="3771077">data</span><span class="op" id="3771081">)</span>&nbsp;<span class="op" id="3771083">&gt;</span>&nbsp;<span class="num" id="3771085">0</span>&nbsp;<span class="op" id="3771087">&amp;&amp;</span>&nbsp;<span class="ident" id="3771090">recordType</span><span class="op" id="3771100">(</span><span class="ident" id="3771101">ri</span><span class="op" id="3771103">.</span><span class="ident" id="3771104">data</span><span class="op" id="3771108">[</span><span class="num" id="3771109">0</span><span class="op" id="3771110">]</span><span class="op" id="3771111">)</span>&nbsp;<span class="op" id="3771113">==</span>&nbsp;<span class="ident" id="3771116">recordTypeAlert</span>&nbsp;<span class="op" id="3771132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771137">if</span>&nbsp;<span class="ident" id="3771140">recErr</span>&nbsp;<span class="op" id="3771147">:=</span>&nbsp;<span class="ident" id="3771150">c</span><span class="op" id="3771151">.</span><span class="ident" id="3771152">readRecord</span><span class="op" id="3771162">(</span><span class="ident" id="3771163">recordTypeApplicationData</span><span class="op" id="3771188">)</span><span class="op" id="3771189">;</span>&nbsp;<span class="ident" id="3771191">recErr</span>&nbsp;<span class="op" id="3771198">!=</span>&nbsp;<span class="builtintype" id="3771201">nil</span>&nbsp;<span class="op" id="3771205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771211">err</span>&nbsp;<span class="op" id="3771215">=</span>&nbsp;<span class="ident" id="3771217">recErr</span>&nbsp;<span class="comment" id="3771224">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771269">if</span>&nbsp;<span class="ident" id="3771272">n</span>&nbsp;<span class="op" id="3771274">!=</span>&nbsp;<span class="num" id="3771277">0</span>&nbsp;<span class="op" id="3771279">||</span>&nbsp;<span class="ident" id="3771282">err</span>&nbsp;<span class="op" id="3771286">!=</span>&nbsp;<span class="builtintype" id="3771289">nil</span>&nbsp;<span class="op" id="3771293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771298">return</span>&nbsp;<span class="ident" id="3771305">n</span><span class="op" id="3771306">,</span>&nbsp;<span class="ident" id="3771308">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771321">return</span>&nbsp;<span class="num" id="3771328">0</span><span class="op" id="3771329">,</span>&nbsp;<span class="ident" id="3771331">io</span><span class="op" id="3771333">.</span><span class="ident" id="3771334">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3771348">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3771351">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3771383">func</span>&nbsp;<span class="op" id="3771388">(</span><span class="ident" id="3771389">c</span>&nbsp;<span class="op" id="3771391">*</span><span class="ident" id="3771392">Conn</span><span class="op" id="3771396">)</span>&nbsp;<span class="ident" id="3771398">Close</span><span class="op" id="3771403">(</span><span class="op" id="3771404">)</span>&nbsp;<span class="builtintype" id="3771406">error</span>&nbsp;<span class="op" id="3771412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771415">var</span>&nbsp;<span class="ident" id="3771419">alertErr</span>&nbsp;<span class="builtintype" id="3771428">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771436">c</span><span class="op" id="3771437">.</span><span class="ident" id="3771438">handshakeMutex</span><span class="op" id="3771452">.</span><span class="ident" id="3771453">Lock</span><span class="op" id="3771457">(</span><span class="op" id="3771458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771461">defer</span>&nbsp;<span class="ident" id="3771467">c</span><span class="op" id="3771468">.</span><span class="ident" id="3771469">handshakeMutex</span><span class="op" id="3771483">.</span><span class="ident" id="3771484">Unlock</span><span class="op" id="3771490">(</span><span class="op" id="3771491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771494">if</span>&nbsp;<span class="ident" id="3771497">c</span><span class="op" id="3771498">.</span><span class="ident" id="3771499">handshakeComplete</span>&nbsp;<span class="op" id="3771517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771521">alertErr</span>&nbsp;<span class="op" id="3771530">=</span>&nbsp;<span class="ident" id="3771532">c</span><span class="op" id="3771533">.</span><span class="ident" id="3771534">sendAlert</span><span class="op" id="3771543">(</span><span class="ident" id="3771544">alertCloseNotify</span><span class="op" id="3771560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771563">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771567">if</span>&nbsp;<span class="ident" id="3771570">err</span>&nbsp;<span class="op" id="3771574">:=</span>&nbsp;<span class="ident" id="3771577">c</span><span class="op" id="3771578">.</span><span class="ident" id="3771579">conn</span><span class="op" id="3771583">.</span><span class="ident" id="3771584">Close</span><span class="op" id="3771589">(</span><span class="op" id="3771590">)</span><span class="op" id="3771591">;</span>&nbsp;<span class="ident" id="3771593">err</span>&nbsp;<span class="op" id="3771597">!=</span>&nbsp;<span class="builtintype" id="3771600">nil</span>&nbsp;<span class="op" id="3771604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771608">return</span>&nbsp;<span class="ident" id="3771615">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771623">return</span>&nbsp;<span class="ident" id="3771630">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3771639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3771642">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3771691">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3771731">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3771784">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3771851">func</span>&nbsp;<span class="op" id="3771856">(</span><span class="ident" id="3771857">c</span>&nbsp;<span class="op" id="3771859">*</span><span class="ident" id="3771860">Conn</span><span class="op" id="3771864">)</span>&nbsp;<span class="ident" id="3771866">Handshake</span><span class="op" id="3771875">(</span><span class="op" id="3771876">)</span>&nbsp;<span class="builtintype" id="3771878">error</span>&nbsp;<span class="op" id="3771884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3771887">c</span><span class="op" id="3771888">.</span><span class="ident" id="3771889">handshakeMutex</span><span class="op" id="3771903">.</span><span class="ident" id="3771904">Lock</span><span class="op" id="3771908">(</span><span class="op" id="3771909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771912">defer</span>&nbsp;<span class="ident" id="3771918">c</span><span class="op" id="3771919">.</span><span class="ident" id="3771920">handshakeMutex</span><span class="op" id="3771934">.</span><span class="ident" id="3771935">Unlock</span><span class="op" id="3771941">(</span><span class="op" id="3771942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771945">if</span>&nbsp;<span class="ident" id="3771948">err</span>&nbsp;<span class="op" id="3771952">:=</span>&nbsp;<span class="ident" id="3771955">c</span><span class="op" id="3771956">.</span><span class="ident" id="3771957">handshakeErr</span><span class="op" id="3771969">;</span>&nbsp;<span class="ident" id="3771971">err</span>&nbsp;<span class="op" id="3771975">!=</span>&nbsp;<span class="builtintype" id="3771978">nil</span>&nbsp;<span class="op" id="3771982">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3771986">return</span>&nbsp;<span class="ident" id="3771993">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3771998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772001">if</span>&nbsp;<span class="ident" id="3772004">c</span><span class="op" id="3772005">.</span><span class="ident" id="3772006">handshakeComplete</span>&nbsp;<span class="op" id="3772024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772028">return</span>&nbsp;<span class="builtintype" id="3772035">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3772040">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772044">if</span>&nbsp;<span class="ident" id="3772047">c</span><span class="op" id="3772048">.</span><span class="ident" id="3772049">isClient</span>&nbsp;<span class="op" id="3772058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772062">c</span><span class="op" id="3772063">.</span><span class="ident" id="3772064">handshakeErr</span>&nbsp;<span class="op" id="3772077">=</span>&nbsp;<span class="ident" id="3772079">c</span><span class="op" id="3772080">.</span><span class="ident" id="3772081">clientHandshake</span><span class="op" id="3772096">(</span><span class="op" id="3772097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3772100">}</span>&nbsp;<span class="keyword" id="3772102">else</span>&nbsp;<span class="op" id="3772107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772111">c</span><span class="op" id="3772112">.</span><span class="ident" id="3772113">handshakeErr</span>&nbsp;<span class="op" id="3772126">=</span>&nbsp;<span class="ident" id="3772128">c</span><span class="op" id="3772129">.</span><span class="ident" id="3772130">serverHandshake</span><span class="op" id="3772145">(</span><span class="op" id="3772146">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3772149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772152">return</span>&nbsp;<span class="ident" id="3772159">c</span><span class="op" id="3772160">.</span><span class="ident" id="3772161">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3772174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3772177">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3772244">func</span>&nbsp;<span class="op" id="3772249">(</span><span class="ident" id="3772250">c</span>&nbsp;<span class="op" id="3772252">*</span><span class="ident" id="3772253">Conn</span><span class="op" id="3772257">)</span>&nbsp;<span class="ident" id="3772259">ConnectionState</span><span class="op" id="3772274">(</span><span class="op" id="3772275">)</span>&nbsp;<span class="ident" id="3772277">ConnectionState</span>&nbsp;<span class="op" id="3772293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772296">c</span><span class="op" id="3772297">.</span><span class="ident" id="3772298">handshakeMutex</span><span class="op" id="3772312">.</span><span class="ident" id="3772313">Lock</span><span class="op" id="3772317">(</span><span class="op" id="3772318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772321">defer</span>&nbsp;<span class="ident" id="3772327">c</span><span class="op" id="3772328">.</span><span class="ident" id="3772329">handshakeMutex</span><span class="op" id="3772343">.</span><span class="ident" id="3772344">Unlock</span><span class="op" id="3772350">(</span><span class="op" id="3772351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772355">var</span>&nbsp;<span class="ident" id="3772359">state</span>&nbsp;<span class="ident" id="3772365">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772382">state</span><span class="op" id="3772387">.</span><span class="ident" id="3772388">HandshakeComplete</span>&nbsp;<span class="op" id="3772406">=</span>&nbsp;<span class="ident" id="3772408">c</span><span class="op" id="3772409">.</span><span class="ident" id="3772410">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772429">if</span>&nbsp;<span class="ident" id="3772432">c</span><span class="op" id="3772433">.</span><span class="ident" id="3772434">handshakeComplete</span>&nbsp;<span class="op" id="3772452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772456">state</span><span class="op" id="3772461">.</span><span class="ident" id="3772462">Version</span>&nbsp;<span class="op" id="3772470">=</span>&nbsp;<span class="ident" id="3772472">c</span><span class="op" id="3772473">.</span><span class="ident" id="3772474">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772481">state</span><span class="op" id="3772486">.</span><span class="ident" id="3772487">NegotiatedProtocol</span>&nbsp;<span class="op" id="3772506">=</span>&nbsp;<span class="ident" id="3772508">c</span><span class="op" id="3772509">.</span><span class="ident" id="3772510">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772527">state</span><span class="op" id="3772532">.</span><span class="ident" id="3772533">DidResume</span>&nbsp;<span class="op" id="3772543">=</span>&nbsp;<span class="ident" id="3772545">c</span><span class="op" id="3772546">.</span><span class="ident" id="3772547">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772559">state</span><span class="op" id="3772564">.</span><span class="ident" id="3772565">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3772592">=</span>&nbsp;<span class="op" id="3772594">!</span><span class="ident" id="3772595">c</span><span class="op" id="3772596">.</span><span class="ident" id="3772597">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772622">state</span><span class="op" id="3772627">.</span><span class="ident" id="3772628">CipherSuite</span>&nbsp;<span class="op" id="3772640">=</span>&nbsp;<span class="ident" id="3772642">c</span><span class="op" id="3772643">.</span><span class="ident" id="3772644">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772658">state</span><span class="op" id="3772663">.</span><span class="ident" id="3772664">PeerCertificates</span>&nbsp;<span class="op" id="3772681">=</span>&nbsp;<span class="ident" id="3772683">c</span><span class="op" id="3772684">.</span><span class="ident" id="3772685">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772704">state</span><span class="op" id="3772709">.</span><span class="ident" id="3772710">VerifiedChains</span>&nbsp;<span class="op" id="3772725">=</span>&nbsp;<span class="ident" id="3772727">c</span><span class="op" id="3772728">.</span><span class="ident" id="3772729">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772746">state</span><span class="op" id="3772751">.</span><span class="ident" id="3772752">ServerName</span>&nbsp;<span class="op" id="3772763">=</span>&nbsp;<span class="ident" id="3772765">c</span><span class="op" id="3772766">.</span><span class="ident" id="3772767">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772780">if</span>&nbsp;<span class="op" id="3772783">!</span><span class="ident" id="3772784">c</span><span class="op" id="3772785">.</span><span class="ident" id="3772786">didResume</span>&nbsp;<span class="op" id="3772796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3772801">state</span><span class="op" id="3772806">.</span><span class="ident" id="3772807">TLSUnique</span>&nbsp;<span class="op" id="3772817">=</span>&nbsp;<span class="ident" id="3772819">c</span><span class="op" id="3772820">.</span><span class="ident" id="3772821">firstFinished</span><span class="op" id="3772834">[</span><span class="op" id="3772835">:</span><span class="op" id="3772836">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3772840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3772843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3772847">return</span>&nbsp;<span class="ident" id="3772854">state</span><br>
<span class="lineno"></span><span class="op" id="3772860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3772863">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3772937">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3772982">func</span>&nbsp;<span class="op" id="3772987">(</span><span class="ident" id="3772988">c</span>&nbsp;<span class="op" id="3772990">*</span><span class="ident" id="3772991">Conn</span><span class="op" id="3772995">)</span>&nbsp;<span class="ident" id="3772997">OCSPResponse</span><span class="op" id="3773009">(</span><span class="op" id="3773010">)</span>&nbsp;<span class="op" id="3773012">[</span><span class="op" id="3773013">]</span><span class="builtintype" id="3773014">byte</span>&nbsp;<span class="op" id="3773019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3773022">c</span><span class="op" id="3773023">.</span><span class="ident" id="3773024">handshakeMutex</span><span class="op" id="3773038">.</span><span class="ident" id="3773039">Lock</span><span class="op" id="3773043">(</span><span class="op" id="3773044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773047">defer</span>&nbsp;<span class="ident" id="3773053">c</span><span class="op" id="3773054">.</span><span class="ident" id="3773055">handshakeMutex</span><span class="op" id="3773069">.</span><span class="ident" id="3773070">Unlock</span><span class="op" id="3773076">(</span><span class="op" id="3773077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773081">return</span>&nbsp;<span class="ident" id="3773088">c</span><span class="op" id="3773089">.</span><span class="ident" id="3773090">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3773103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3773106">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3773176">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3773251">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3773278">func</span>&nbsp;<span class="op" id="3773283">(</span><span class="ident" id="3773284">c</span>&nbsp;<span class="op" id="3773286">*</span><span class="ident" id="3773287">Conn</span><span class="op" id="3773291">)</span>&nbsp;<span class="ident" id="3773293">VerifyHostname</span><span class="op" id="3773307">(</span><span class="ident" id="3773308">host</span>&nbsp;<span class="builtintype" id="3773313">string</span><span class="op" id="3773319">)</span>&nbsp;<span class="builtintype" id="3773321">error</span>&nbsp;<span class="op" id="3773327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3773330">c</span><span class="op" id="3773331">.</span><span class="ident" id="3773332">handshakeMutex</span><span class="op" id="3773346">.</span><span class="ident" id="3773347">Lock</span><span class="op" id="3773351">(</span><span class="op" id="3773352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773355">defer</span>&nbsp;<span class="ident" id="3773361">c</span><span class="op" id="3773362">.</span><span class="ident" id="3773363">handshakeMutex</span><span class="op" id="3773377">.</span><span class="ident" id="3773378">Unlock</span><span class="op" id="3773384">(</span><span class="op" id="3773385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773388">if</span>&nbsp;<span class="op" id="3773391">!</span><span class="ident" id="3773392">c</span><span class="op" id="3773393">.</span><span class="ident" id="3773394">isClient</span>&nbsp;<span class="op" id="3773403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773407">return</span>&nbsp;<span class="ident" id="3773414">errors</span><span class="op" id="3773420">.</span><span class="ident" id="3773421">New</span><span class="op" id="3773424">(</span><span class="string" id="3773425">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3773478">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3773481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773484">if</span>&nbsp;<span class="op" id="3773487">!</span><span class="ident" id="3773488">c</span><span class="op" id="3773489">.</span><span class="ident" id="3773490">handshakeComplete</span>&nbsp;<span class="op" id="3773508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773512">return</span>&nbsp;<span class="ident" id="3773519">errors</span><span class="op" id="3773525">.</span><span class="ident" id="3773526">New</span><span class="op" id="3773529">(</span><span class="string" id="3773530">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3773573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3773576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3773579">return</span>&nbsp;<span class="ident" id="3773586">c</span><span class="op" id="3773587">.</span><span class="ident" id="3773588">peerCertificates</span><span class="op" id="3773604">[</span><span class="num" id="3773605">0</span><span class="op" id="3773606">]</span><span class="op" id="3773607">.</span><span class="ident" id="3773608">VerifyHostname</span><span class="op" id="3773622">(</span><span class="ident" id="3773623">host</span><span class="op" id="3773627">)</span><br>
<span class="lineno">1030</span><span class="op" id="3773629">}</span>
</div>
</body>
</html>
