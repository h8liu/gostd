<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4678623">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4678678">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4678732">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4678783">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="4678861">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="4678940">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4679016">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4679045">package</span>&nbsp;<span class="ident" id="4679053">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4679060">import</span>&nbsp;<span class="op" id="4679067">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4679070">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4679079">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4679086">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4679097">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4679108">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4679118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4679121">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="4679180">type</span>&nbsp;<span class="ident" id="4679185">Tree</span>&nbsp;<span class="keyword" id="4679190">struct</span>&nbsp;<span class="op" id="4679197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679200">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4679210">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4679220">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679270">ParseName</span>&nbsp;<span class="builtintype" id="4679280">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4679290">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679361">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4679371">*</span><span class="ident" id="4679372">ListNode</span>&nbsp;<span class="comment" id="4679381">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679413">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4679423">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4679433">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4679488">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679527">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4679537">[</span><span class="op" id="4679538">]</span><span class="keyword" id="4679539">map</span><span class="op" id="4679542">[</span><span class="builtintype" id="4679543">string</span><span class="op" id="4679549">]</span><span class="keyword" id="4679550">interface</span><span class="op" id="4679559">{</span><span class="op" id="4679560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679563">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4679573">*</span><span class="ident" id="4679574">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679581">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4679591">[</span><span class="num" id="4679592">3</span><span class="op" id="4679593">]</span><span class="ident" id="4679594">item</span>&nbsp;<span class="comment" id="4679599">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679637">peekCount</span>&nbsp;<span class="builtintype" id="4679647">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679652">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4679662">[</span><span class="op" id="4679663">]</span><span class="builtintype" id="4679664">string</span>&nbsp;<span class="comment" id="4679671">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="4679707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4679710">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4679778">func</span>&nbsp;<span class="op" id="4679783">(</span><span class="ident" id="4679784">t</span>&nbsp;<span class="op" id="4679786">*</span><span class="ident" id="4679787">Tree</span><span class="op" id="4679791">)</span>&nbsp;<span class="ident" id="4679793">Copy</span><span class="op" id="4679797">(</span><span class="op" id="4679798">)</span>&nbsp;<span class="op" id="4679800">*</span><span class="ident" id="4679801">Tree</span>&nbsp;<span class="op" id="4679806">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4679809">if</span>&nbsp;<span class="ident" id="4679812">t</span>&nbsp;<span class="op" id="4679814">==</span>&nbsp;<span class="ident" id="4679817">nil</span>&nbsp;<span class="op" id="4679821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4679825">return</span>&nbsp;<span class="ident" id="4679832">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4679837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4679840">return</span>&nbsp;<span class="op" id="4679847">&amp;</span><span class="ident" id="4679848">Tree</span><span class="op" id="4679852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679856">Name</span><span class="op" id="4679860">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4679867">t</span><span class="op" id="4679868">.</span><span class="ident" id="4679869">Name</span><span class="op" id="4679873">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679877">ParseName</span><span class="op" id="4679886">:</span>&nbsp;<span class="ident" id="4679888">t</span><span class="op" id="4679889">.</span><span class="ident" id="4679890">ParseName</span><span class="op" id="4679899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679903">Root</span><span class="op" id="4679907">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4679914">t</span><span class="op" id="4679915">.</span><span class="ident" id="4679916">Root</span><span class="op" id="4679920">.</span><span class="ident" id="4679921">CopyList</span><span class="op" id="4679929">(</span><span class="op" id="4679930">)</span><span class="op" id="4679931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4679935">text</span><span class="op" id="4679939">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4679946">t</span><span class="op" id="4679947">.</span><span class="ident" id="4679948">text</span><span class="op" id="4679952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4679955">}</span><br>
<span class="lineno"></span><span class="op" id="4679957">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4679960">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4680040">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4680118">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4680196">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="4680237">func</span>&nbsp;<span class="ident" id="4680242">Parse</span><span class="op" id="4680247">(</span><span class="ident" id="4680248">name</span><span class="op" id="4680252">,</span>&nbsp;<span class="ident" id="4680254">text</span><span class="op" id="4680258">,</span>&nbsp;<span class="ident" id="4680260">leftDelim</span><span class="op" id="4680269">,</span>&nbsp;<span class="ident" id="4680271">rightDelim</span>&nbsp;<span class="builtintype" id="4680282">string</span><span class="op" id="4680288">,</span>&nbsp;<span class="ident" id="4680290">funcs</span>&nbsp;<span class="op" id="4680296">...</span><span class="keyword" id="4680299">map</span><span class="op" id="4680302">[</span><span class="builtintype" id="4680303">string</span><span class="op" id="4680309">]</span><span class="keyword" id="4680310">interface</span><span class="op" id="4680319">{</span><span class="op" id="4680320">}</span><span class="op" id="4680321">)</span>&nbsp;<span class="op" id="4680323">(</span><span class="ident" id="4680324">treeSet</span>&nbsp;<span class="keyword" id="4680332">map</span><span class="op" id="4680335">[</span><span class="builtintype" id="4680336">string</span><span class="op" id="4680342">]</span><span class="op" id="4680343">*</span><span class="ident" id="4680344">Tree</span><span class="op" id="4680348">,</span>&nbsp;<span class="ident" id="4680350">err</span>&nbsp;<span class="builtintype" id="4680354">error</span><span class="op" id="4680359">)</span>&nbsp;<span class="op" id="4680361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680364">treeSet</span>&nbsp;<span class="op" id="4680372">=</span>&nbsp;<span class="builtinfunc" id="4680374">make</span><span class="op" id="4680378">(</span><span class="keyword" id="4680379">map</span><span class="op" id="4680382">[</span><span class="builtintype" id="4680383">string</span><span class="op" id="4680389">]</span><span class="op" id="4680390">*</span><span class="ident" id="4680391">Tree</span><span class="op" id="4680395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680398">t</span>&nbsp;<span class="op" id="4680400">:=</span>&nbsp;<span class="ident" id="4680403">New</span><span class="op" id="4680406">(</span><span class="ident" id="4680407">name</span><span class="op" id="4680411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680414">t</span><span class="op" id="4680415">.</span><span class="ident" id="4680416">text</span>&nbsp;<span class="op" id="4680421">=</span>&nbsp;<span class="ident" id="4680423">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680429">_</span><span class="op" id="4680430">,</span>&nbsp;<span class="ident" id="4680432">err</span>&nbsp;<span class="op" id="4680436">=</span>&nbsp;<span class="ident" id="4680438">t</span><span class="op" id="4680439">.</span><span class="ident" id="4680440">Parse</span><span class="op" id="4680445">(</span><span class="ident" id="4680446">text</span><span class="op" id="4680450">,</span>&nbsp;<span class="ident" id="4680452">leftDelim</span><span class="op" id="4680461">,</span>&nbsp;<span class="ident" id="4680463">rightDelim</span><span class="op" id="4680473">,</span>&nbsp;<span class="ident" id="4680475">treeSet</span><span class="op" id="4680482">,</span>&nbsp;<span class="ident" id="4680484">funcs</span><span class="op" id="4680489">...</span><span class="op" id="4680492">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4680495">return</span><br>
<span class="lineno"></span><span class="op" id="4680502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4680505">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4680537">func</span>&nbsp;<span class="op" id="4680542">(</span><span class="ident" id="4680543">t</span>&nbsp;<span class="op" id="4680545">*</span><span class="ident" id="4680546">Tree</span><span class="op" id="4680550">)</span>&nbsp;<span class="ident" id="4680552">next</span><span class="op" id="4680556">(</span><span class="op" id="4680557">)</span>&nbsp;<span class="ident" id="4680559">item</span>&nbsp;<span class="op" id="4680564">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4680567">if</span>&nbsp;<span class="ident" id="4680570">t</span><span class="op" id="4680571">.</span><span class="ident" id="4680572">peekCount</span>&nbsp;<span class="op" id="4680582">&gt;</span>&nbsp;<span class="num" id="4680584">0</span>&nbsp;<span class="op" id="4680586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680590">t</span><span class="op" id="4680591">.</span><span class="ident" id="4680592">peekCount</span><span class="op" id="4680601">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4680605">}</span>&nbsp;<span class="keyword" id="4680607">else</span>&nbsp;<span class="op" id="4680612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680616">t</span><span class="op" id="4680617">.</span><span class="ident" id="4680618">token</span><span class="op" id="4680623">[</span><span class="num" id="4680624">0</span><span class="op" id="4680625">]</span>&nbsp;<span class="op" id="4680627">=</span>&nbsp;<span class="ident" id="4680629">t</span><span class="op" id="4680630">.</span><span class="ident" id="4680631">lex</span><span class="op" id="4680634">.</span><span class="ident" id="4680635">nextItem</span><span class="op" id="4680643">(</span><span class="op" id="4680644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4680647">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4680650">return</span>&nbsp;<span class="ident" id="4680657">t</span><span class="op" id="4680658">.</span><span class="ident" id="4680659">token</span><span class="op" id="4680664">[</span><span class="ident" id="4680665">t</span><span class="op" id="4680666">.</span><span class="ident" id="4680667">peekCount</span><span class="op" id="4680676">]</span><br>
<span class="lineno"></span><span class="op" id="4680678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4680681">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4680728">func</span>&nbsp;<span class="op" id="4680733">(</span><span class="ident" id="4680734">t</span>&nbsp;<span class="op" id="4680736">*</span><span class="ident" id="4680737">Tree</span><span class="op" id="4680741">)</span>&nbsp;<span class="ident" id="4680743">backup</span><span class="op" id="4680749">(</span><span class="op" id="4680750">)</span>&nbsp;<span class="op" id="4680752">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680755">t</span><span class="op" id="4680756">.</span><span class="ident" id="4680757">peekCount</span><span class="op" id="4680766">++</span><br>
<span class="lineno"></span><span class="op" id="4680769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4680772">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="4680821">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="4680859">func</span>&nbsp;<span class="op" id="4680864">(</span><span class="ident" id="4680865">t</span>&nbsp;<span class="op" id="4680867">*</span><span class="ident" id="4680868">Tree</span><span class="op" id="4680872">)</span>&nbsp;<span class="ident" id="4680874">backup2</span><span class="op" id="4680881">(</span><span class="ident" id="4680882">t1</span>&nbsp;<span class="ident" id="4680885">item</span><span class="op" id="4680889">)</span>&nbsp;<span class="op" id="4680891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680894">t</span><span class="op" id="4680895">.</span><span class="ident" id="4680896">token</span><span class="op" id="4680901">[</span><span class="num" id="4680902">1</span><span class="op" id="4680903">]</span>&nbsp;<span class="op" id="4680905">=</span>&nbsp;<span class="ident" id="4680907">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4680911">t</span><span class="op" id="4680912">.</span><span class="ident" id="4680913">peekCount</span>&nbsp;<span class="op" id="4680923">=</span>&nbsp;<span class="num" id="4680925">2</span><br>
<span class="lineno"></span><span class="op" id="4680927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4680930">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="4680980">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="4681018">func</span>&nbsp;<span class="op" id="4681023">(</span><span class="ident" id="4681024">t</span>&nbsp;<span class="op" id="4681026">*</span><span class="ident" id="4681027">Tree</span><span class="op" id="4681031">)</span>&nbsp;<span class="ident" id="4681033">backup3</span><span class="op" id="4681040">(</span><span class="ident" id="4681041">t2</span><span class="op" id="4681043">,</span>&nbsp;<span class="ident" id="4681045">t1</span>&nbsp;<span class="ident" id="4681048">item</span><span class="op" id="4681052">)</span>&nbsp;<span class="op" id="4681054">{</span>&nbsp;<span class="comment" id="4681056">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681095">t</span><span class="op" id="4681096">.</span><span class="ident" id="4681097">token</span><span class="op" id="4681102">[</span><span class="num" id="4681103">1</span><span class="op" id="4681104">]</span>&nbsp;<span class="op" id="4681106">=</span>&nbsp;<span class="ident" id="4681108">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681112">t</span><span class="op" id="4681113">.</span><span class="ident" id="4681114">token</span><span class="op" id="4681119">[</span><span class="num" id="4681120">2</span><span class="op" id="4681121">]</span>&nbsp;<span class="op" id="4681123">=</span>&nbsp;<span class="ident" id="4681125">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681129">t</span><span class="op" id="4681130">.</span><span class="ident" id="4681131">peekCount</span>&nbsp;<span class="op" id="4681141">=</span>&nbsp;<span class="num" id="4681143">3</span><br>
<span class="lineno"></span><span class="op" id="4681145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4681148">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4681201">func</span>&nbsp;<span class="op" id="4681206">(</span><span class="ident" id="4681207">t</span>&nbsp;<span class="op" id="4681209">*</span><span class="ident" id="4681210">Tree</span><span class="op" id="4681214">)</span>&nbsp;<span class="ident" id="4681216">peek</span><span class="op" id="4681220">(</span><span class="op" id="4681221">)</span>&nbsp;<span class="ident" id="4681223">item</span>&nbsp;<span class="op" id="4681228">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681231">if</span>&nbsp;<span class="ident" id="4681234">t</span><span class="op" id="4681235">.</span><span class="ident" id="4681236">peekCount</span>&nbsp;<span class="op" id="4681246">&gt;</span>&nbsp;<span class="num" id="4681248">0</span>&nbsp;<span class="op" id="4681250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681254">return</span>&nbsp;<span class="ident" id="4681261">t</span><span class="op" id="4681262">.</span><span class="ident" id="4681263">token</span><span class="op" id="4681268">[</span><span class="ident" id="4681269">t</span><span class="op" id="4681270">.</span><span class="ident" id="4681271">peekCount</span><span class="op" id="4681280">-</span><span class="num" id="4681281">1</span><span class="op" id="4681282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681288">t</span><span class="op" id="4681289">.</span><span class="ident" id="4681290">peekCount</span>&nbsp;<span class="op" id="4681300">=</span>&nbsp;<span class="num" id="4681302">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681305">t</span><span class="op" id="4681306">.</span><span class="ident" id="4681307">token</span><span class="op" id="4681312">[</span><span class="num" id="4681313">0</span><span class="op" id="4681314">]</span>&nbsp;<span class="op" id="4681316">=</span>&nbsp;<span class="ident" id="4681318">t</span><span class="op" id="4681319">.</span><span class="ident" id="4681320">lex</span><span class="op" id="4681323">.</span><span class="ident" id="4681324">nextItem</span><span class="op" id="4681332">(</span><span class="op" id="4681333">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681336">return</span>&nbsp;<span class="ident" id="4681343">t</span><span class="op" id="4681344">.</span><span class="ident" id="4681345">token</span><span class="op" id="4681350">[</span><span class="num" id="4681351">0</span><span class="op" id="4681352">]</span><br>
<span class="lineno"></span><span class="op" id="4681354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4681357">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4681407">func</span>&nbsp;<span class="op" id="4681412">(</span><span class="ident" id="4681413">t</span>&nbsp;<span class="op" id="4681415">*</span><span class="ident" id="4681416">Tree</span><span class="op" id="4681420">)</span>&nbsp;<span class="ident" id="4681422">nextNonSpace</span><span class="op" id="4681434">(</span><span class="op" id="4681435">)</span>&nbsp;<span class="op" id="4681437">(</span><span class="ident" id="4681438">token</span>&nbsp;<span class="ident" id="4681444">item</span><span class="op" id="4681448">)</span>&nbsp;<span class="op" id="4681450">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681453">for</span>&nbsp;<span class="op" id="4681457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681461">token</span>&nbsp;<span class="op" id="4681467">=</span>&nbsp;<span class="ident" id="4681469">t</span><span class="op" id="4681470">.</span><span class="ident" id="4681471">next</span><span class="op" id="4681475">(</span><span class="op" id="4681476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681480">if</span>&nbsp;<span class="ident" id="4681483">token</span><span class="op" id="4681488">.</span><span class="ident" id="4681489">typ</span>&nbsp;<span class="op" id="4681493">!=</span>&nbsp;<span class="ident" id="4681496">itemSpace</span>&nbsp;<span class="op" id="4681506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681511">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681519">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681525">return</span>&nbsp;<span class="ident" id="4681532">token</span><br>
<span class="lineno"></span><span class="op" id="4681538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4681541">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="4681612">func</span>&nbsp;<span class="op" id="4681617">(</span><span class="ident" id="4681618">t</span>&nbsp;<span class="op" id="4681620">*</span><span class="ident" id="4681621">Tree</span><span class="op" id="4681625">)</span>&nbsp;<span class="ident" id="4681627">peekNonSpace</span><span class="op" id="4681639">(</span><span class="op" id="4681640">)</span>&nbsp;<span class="op" id="4681642">(</span><span class="ident" id="4681643">token</span>&nbsp;<span class="ident" id="4681649">item</span><span class="op" id="4681653">)</span>&nbsp;<span class="op" id="4681655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681658">for</span>&nbsp;<span class="op" id="4681662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681666">token</span>&nbsp;<span class="op" id="4681672">=</span>&nbsp;<span class="ident" id="4681674">t</span><span class="op" id="4681675">.</span><span class="ident" id="4681676">next</span><span class="op" id="4681680">(</span><span class="op" id="4681681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681685">if</span>&nbsp;<span class="ident" id="4681688">token</span><span class="op" id="4681693">.</span><span class="ident" id="4681694">typ</span>&nbsp;<span class="op" id="4681698">!=</span>&nbsp;<span class="ident" id="4681701">itemSpace</span>&nbsp;<span class="op" id="4681711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681716">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681730">t</span><span class="op" id="4681731">.</span><span class="ident" id="4681732">backup</span><span class="op" id="4681738">(</span><span class="op" id="4681739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681742">return</span>&nbsp;<span class="ident" id="4681749">token</span><br>
<span class="lineno"></span><span class="op" id="4681755">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4681758">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4681771">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4681826">func</span>&nbsp;<span class="ident" id="4681831">New</span><span class="op" id="4681834">(</span><span class="ident" id="4681835">name</span>&nbsp;<span class="builtintype" id="4681840">string</span><span class="op" id="4681846">,</span>&nbsp;<span class="ident" id="4681848">funcs</span>&nbsp;<span class="op" id="4681854">...</span><span class="keyword" id="4681857">map</span><span class="op" id="4681860">[</span><span class="builtintype" id="4681861">string</span><span class="op" id="4681867">]</span><span class="keyword" id="4681868">interface</span><span class="op" id="4681877">{</span><span class="op" id="4681878">}</span><span class="op" id="4681879">)</span>&nbsp;<span class="op" id="4681881">*</span><span class="ident" id="4681882">Tree</span>&nbsp;<span class="op" id="4681887">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4681890">return</span>&nbsp;<span class="op" id="4681897">&amp;</span><span class="ident" id="4681898">Tree</span><span class="op" id="4681902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681906">Name</span><span class="op" id="4681910">:</span>&nbsp;&nbsp;<span class="ident" id="4681913">name</span><span class="op" id="4681917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4681921">funcs</span><span class="op" id="4681926">:</span>&nbsp;<span class="ident" id="4681928">funcs</span><span class="op" id="4681933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4681936">}</span><br>
<span class="lineno"></span><span class="op" id="4681938">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4681941">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="4682037">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="4682124">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="4682156">func</span>&nbsp;<span class="op" id="4682161">(</span><span class="ident" id="4682162">t</span>&nbsp;<span class="op" id="4682164">*</span><span class="ident" id="4682165">Tree</span><span class="op" id="4682169">)</span>&nbsp;<span class="ident" id="4682171">ErrorContext</span><span class="op" id="4682183">(</span><span class="ident" id="4682184">n</span>&nbsp;<span class="ident" id="4682186">Node</span><span class="op" id="4682190">)</span>&nbsp;<span class="op" id="4682192">(</span><span class="ident" id="4682193">location</span><span class="op" id="4682201">,</span>&nbsp;<span class="ident" id="4682203">context</span>&nbsp;<span class="builtintype" id="4682211">string</span><span class="op" id="4682217">)</span>&nbsp;<span class="op" id="4682219">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682222">pos</span>&nbsp;<span class="op" id="4682226">:=</span>&nbsp;<span class="builtintype" id="4682229">int</span><span class="op" id="4682232">(</span><span class="ident" id="4682233">n</span><span class="op" id="4682234">.</span><span class="ident" id="4682235">Position</span><span class="op" id="4682243">(</span><span class="op" id="4682244">)</span><span class="op" id="4682245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682248">tree</span>&nbsp;<span class="op" id="4682253">:=</span>&nbsp;<span class="ident" id="4682256">n</span><span class="op" id="4682257">.</span><span class="ident" id="4682258">tree</span><span class="op" id="4682262">(</span><span class="op" id="4682263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4682266">if</span>&nbsp;<span class="ident" id="4682269">tree</span>&nbsp;<span class="op" id="4682274">==</span>&nbsp;<span class="ident" id="4682277">nil</span>&nbsp;<span class="op" id="4682281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682285">tree</span>&nbsp;<span class="op" id="4682290">=</span>&nbsp;<span class="ident" id="4682292">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4682295">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682298">text</span>&nbsp;<span class="op" id="4682303">:=</span>&nbsp;<span class="ident" id="4682306">tree</span><span class="op" id="4682310">.</span><span class="ident" id="4682311">text</span><span class="op" id="4682315">[</span><span class="op" id="4682316">:</span><span class="ident" id="4682317">pos</span><span class="op" id="4682320">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682323">byteNum</span>&nbsp;<span class="op" id="4682331">:=</span>&nbsp;<span class="ident" id="4682334">strings</span><span class="op" id="4682341">.</span><span class="ident" id="4682342">LastIndex</span><span class="op" id="4682351">(</span><span class="ident" id="4682352">text</span><span class="op" id="4682356">,</span>&nbsp;<span class="string" id="4682358">&#34;\n&#34;</span><span class="op" id="4682362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4682365">if</span>&nbsp;<span class="ident" id="4682368">byteNum</span>&nbsp;<span class="op" id="4682376">==</span>&nbsp;<span class="op" id="4682379">-</span><span class="num" id="4682380">1</span>&nbsp;<span class="op" id="4682382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682386">byteNum</span>&nbsp;<span class="op" id="4682394">=</span>&nbsp;<span class="ident" id="4682396">pos</span>&nbsp;<span class="comment" id="4682400">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4682419">}</span>&nbsp;<span class="keyword" id="4682421">else</span>&nbsp;<span class="op" id="4682426">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682430">byteNum</span><span class="op" id="4682437">++</span>&nbsp;<span class="comment" id="4682440">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682464">byteNum</span>&nbsp;<span class="op" id="4682472">=</span>&nbsp;<span class="ident" id="4682474">pos</span>&nbsp;<span class="op" id="4682478">-</span>&nbsp;<span class="ident" id="4682480">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4682489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682492">lineNum</span>&nbsp;<span class="op" id="4682500">:=</span>&nbsp;<span class="num" id="4682503">1</span>&nbsp;<span class="op" id="4682505">+</span>&nbsp;<span class="ident" id="4682507">strings</span><span class="op" id="4682514">.</span><span class="ident" id="4682515">Count</span><span class="op" id="4682520">(</span><span class="ident" id="4682521">text</span><span class="op" id="4682525">,</span>&nbsp;<span class="string" id="4682527">&#34;\n&#34;</span><span class="op" id="4682531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682534">context</span>&nbsp;<span class="op" id="4682542">=</span>&nbsp;<span class="ident" id="4682544">n</span><span class="op" id="4682545">.</span><span class="ident" id="4682546">String</span><span class="op" id="4682552">(</span><span class="op" id="4682553">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4682556">if</span>&nbsp;<span class="builtinfunc" id="4682559">len</span><span class="op" id="4682562">(</span><span class="ident" id="4682563">context</span><span class="op" id="4682570">)</span>&nbsp;<span class="op" id="4682572">&gt;</span>&nbsp;<span class="num" id="4682574">20</span>&nbsp;<span class="op" id="4682577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682581">context</span>&nbsp;<span class="op" id="4682589">=</span>&nbsp;<span class="ident" id="4682591">fmt</span><span class="op" id="4682594">.</span><span class="ident" id="4682595">Sprintf</span><span class="op" id="4682602">(</span><span class="string" id="4682603">&#34;%.20s...&#34;</span><span class="op" id="4682613">,</span>&nbsp;<span class="ident" id="4682615">context</span><span class="op" id="4682622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4682625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4682628">return</span>&nbsp;<span class="ident" id="4682635">fmt</span><span class="op" id="4682638">.</span><span class="ident" id="4682639">Sprintf</span><span class="op" id="4682646">(</span><span class="string" id="4682647">&#34;%s:%d:%d&#34;</span><span class="op" id="4682657">,</span>&nbsp;<span class="ident" id="4682659">tree</span><span class="op" id="4682663">.</span><span class="ident" id="4682664">ParseName</span><span class="op" id="4682673">,</span>&nbsp;<span class="ident" id="4682675">lineNum</span><span class="op" id="4682682">,</span>&nbsp;<span class="ident" id="4682684">byteNum</span><span class="op" id="4682691">)</span><span class="op" id="4682692">,</span>&nbsp;<span class="ident" id="4682694">context</span><br>
<span class="lineno"></span><span class="op" id="4682702">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4682705">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4682760">func</span>&nbsp;<span class="op" id="4682765">(</span><span class="ident" id="4682766">t</span>&nbsp;<span class="op" id="4682768">*</span><span class="ident" id="4682769">Tree</span><span class="op" id="4682773">)</span>&nbsp;<span class="ident" id="4682775">errorf</span><span class="op" id="4682781">(</span><span class="ident" id="4682782">format</span>&nbsp;<span class="builtintype" id="4682789">string</span><span class="op" id="4682795">,</span>&nbsp;<span class="ident" id="4682797">args</span>&nbsp;<span class="op" id="4682802">...</span><span class="keyword" id="4682805">interface</span><span class="op" id="4682814">{</span><span class="op" id="4682815">}</span><span class="op" id="4682816">)</span>&nbsp;<span class="op" id="4682818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682821">t</span><span class="op" id="4682822">.</span><span class="ident" id="4682823">Root</span>&nbsp;<span class="op" id="4682828">=</span>&nbsp;<span class="ident" id="4682830">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4682835">format</span>&nbsp;<span class="op" id="4682842">=</span>&nbsp;<span class="ident" id="4682844">fmt</span><span class="op" id="4682847">.</span><span class="ident" id="4682848">Sprintf</span><span class="op" id="4682855">(</span><span class="string" id="4682856">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="4682877">,</span>&nbsp;<span class="ident" id="4682879">t</span><span class="op" id="4682880">.</span><span class="ident" id="4682881">ParseName</span><span class="op" id="4682890">,</span>&nbsp;<span class="ident" id="4682892">t</span><span class="op" id="4682893">.</span><span class="ident" id="4682894">lex</span><span class="op" id="4682897">.</span><span class="ident" id="4682898">lineNumber</span><span class="op" id="4682908">(</span><span class="op" id="4682909">)</span><span class="op" id="4682910">,</span>&nbsp;<span class="ident" id="4682912">format</span><span class="op" id="4682918">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4682921">panic</span><span class="op" id="4682926">(</span><span class="ident" id="4682927">fmt</span><span class="op" id="4682930">.</span><span class="ident" id="4682931">Errorf</span><span class="op" id="4682937">(</span><span class="ident" id="4682938">format</span><span class="op" id="4682944">,</span>&nbsp;<span class="ident" id="4682946">args</span><span class="op" id="4682950">...</span><span class="op" id="4682953">)</span><span class="op" id="4682954">)</span><br>
<span class="lineno"></span><span class="op" id="4682956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4682959">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4682991">func</span>&nbsp;<span class="op" id="4682996">(</span><span class="ident" id="4682997">t</span>&nbsp;<span class="op" id="4682999">*</span><span class="ident" id="4683000">Tree</span><span class="op" id="4683004">)</span>&nbsp;<span class="builtintype" id="4683006">error</span><span class="op" id="4683011">(</span><span class="ident" id="4683012">err</span>&nbsp;<span class="builtintype" id="4683016">error</span><span class="op" id="4683021">)</span>&nbsp;<span class="op" id="4683023">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683026">t</span><span class="op" id="4683027">.</span><span class="ident" id="4683028">errorf</span><span class="op" id="4683034">(</span><span class="string" id="4683035">&#34;%s&#34;</span><span class="op" id="4683039">,</span>&nbsp;<span class="ident" id="4683041">err</span><span class="op" id="4683044">)</span><br>
<span class="lineno"></span><span class="op" id="4683046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4683049">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4683124">func</span>&nbsp;<span class="op" id="4683129">(</span><span class="ident" id="4683130">t</span>&nbsp;<span class="op" id="4683132">*</span><span class="ident" id="4683133">Tree</span><span class="op" id="4683137">)</span>&nbsp;<span class="ident" id="4683139">expect</span><span class="op" id="4683145">(</span><span class="ident" id="4683146">expected</span>&nbsp;<span class="ident" id="4683155">itemType</span><span class="op" id="4683163">,</span>&nbsp;<span class="ident" id="4683165">context</span>&nbsp;<span class="builtintype" id="4683173">string</span><span class="op" id="4683179">)</span>&nbsp;<span class="ident" id="4683181">item</span>&nbsp;<span class="op" id="4683186">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683189">token</span>&nbsp;<span class="op" id="4683195">:=</span>&nbsp;<span class="ident" id="4683198">t</span><span class="op" id="4683199">.</span><span class="ident" id="4683200">nextNonSpace</span><span class="op" id="4683212">(</span><span class="op" id="4683213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683216">if</span>&nbsp;<span class="ident" id="4683219">token</span><span class="op" id="4683224">.</span><span class="ident" id="4683225">typ</span>&nbsp;<span class="op" id="4683229">!=</span>&nbsp;<span class="ident" id="4683232">expected</span>&nbsp;<span class="op" id="4683241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683245">t</span><span class="op" id="4683246">.</span><span class="ident" id="4683247">unexpected</span><span class="op" id="4683257">(</span><span class="ident" id="4683258">token</span><span class="op" id="4683263">,</span>&nbsp;<span class="ident" id="4683265">context</span><span class="op" id="4683272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4683275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683278">return</span>&nbsp;<span class="ident" id="4683285">token</span><br>
<span class="lineno">175</span><span class="op" id="4683291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4683294">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="4683382">func</span>&nbsp;<span class="op" id="4683387">(</span><span class="ident" id="4683388">t</span>&nbsp;<span class="op" id="4683390">*</span><span class="ident" id="4683391">Tree</span><span class="op" id="4683395">)</span>&nbsp;<span class="ident" id="4683397">expectOneOf</span><span class="op" id="4683408">(</span><span class="ident" id="4683409">expected1</span><span class="op" id="4683418">,</span>&nbsp;<span class="ident" id="4683420">expected2</span>&nbsp;<span class="ident" id="4683430">itemType</span><span class="op" id="4683438">,</span>&nbsp;<span class="ident" id="4683440">context</span>&nbsp;<span class="builtintype" id="4683448">string</span><span class="op" id="4683454">)</span>&nbsp;<span class="ident" id="4683456">item</span>&nbsp;<span class="op" id="4683461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683464">token</span>&nbsp;<span class="op" id="4683470">:=</span>&nbsp;<span class="ident" id="4683473">t</span><span class="op" id="4683474">.</span><span class="ident" id="4683475">nextNonSpace</span><span class="op" id="4683487">(</span><span class="op" id="4683488">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683491">if</span>&nbsp;<span class="ident" id="4683494">token</span><span class="op" id="4683499">.</span><span class="ident" id="4683500">typ</span>&nbsp;<span class="op" id="4683504">!=</span>&nbsp;<span class="ident" id="4683507">expected1</span>&nbsp;<span class="op" id="4683517">&amp;&amp;</span>&nbsp;<span class="ident" id="4683520">token</span><span class="op" id="4683525">.</span><span class="ident" id="4683526">typ</span>&nbsp;<span class="op" id="4683530">!=</span>&nbsp;<span class="ident" id="4683533">expected2</span>&nbsp;<span class="op" id="4683543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683547">t</span><span class="op" id="4683548">.</span><span class="ident" id="4683549">unexpected</span><span class="op" id="4683559">(</span><span class="ident" id="4683560">token</span><span class="op" id="4683565">,</span>&nbsp;<span class="ident" id="4683567">context</span><span class="op" id="4683574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4683577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683580">return</span>&nbsp;<span class="ident" id="4683587">token</span><br>
<span class="lineno"></span><span class="op" id="4683593">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="4683596">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4683663">func</span>&nbsp;<span class="op" id="4683668">(</span><span class="ident" id="4683669">t</span>&nbsp;<span class="op" id="4683671">*</span><span class="ident" id="4683672">Tree</span><span class="op" id="4683676">)</span>&nbsp;<span class="ident" id="4683678">unexpected</span><span class="op" id="4683688">(</span><span class="ident" id="4683689">token</span>&nbsp;<span class="ident" id="4683695">item</span><span class="op" id="4683699">,</span>&nbsp;<span class="ident" id="4683701">context</span>&nbsp;<span class="builtintype" id="4683709">string</span><span class="op" id="4683715">)</span>&nbsp;<span class="op" id="4683717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683720">t</span><span class="op" id="4683721">.</span><span class="ident" id="4683722">errorf</span><span class="op" id="4683728">(</span><span class="string" id="4683729">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4683750">,</span>&nbsp;<span class="ident" id="4683752">token</span><span class="op" id="4683757">,</span>&nbsp;<span class="ident" id="4683759">context</span><span class="op" id="4683766">)</span><br>
<span class="lineno"></span><span class="op" id="4683768">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4683771">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="4683857">func</span>&nbsp;<span class="op" id="4683862">(</span><span class="ident" id="4683863">t</span>&nbsp;<span class="op" id="4683865">*</span><span class="ident" id="4683866">Tree</span><span class="op" id="4683870">)</span>&nbsp;<span class="builtinfunc" id="4683872">recover</span><span class="op" id="4683879">(</span><span class="ident" id="4683880">errp</span>&nbsp;<span class="op" id="4683885">*</span><span class="builtintype" id="4683886">error</span><span class="op" id="4683891">)</span>&nbsp;<span class="op" id="4683893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683896">e</span>&nbsp;<span class="op" id="4683898">:=</span>&nbsp;<span class="builtinfunc" id="4683901">recover</span><span class="op" id="4683908">(</span><span class="op" id="4683909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683912">if</span>&nbsp;<span class="ident" id="4683915">e</span>&nbsp;<span class="op" id="4683917">!=</span>&nbsp;<span class="ident" id="4683920">nil</span>&nbsp;<span class="op" id="4683924">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683928">if</span>&nbsp;<span class="ident" id="4683931">_</span><span class="op" id="4683932">,</span>&nbsp;<span class="ident" id="4683934">ok</span>&nbsp;<span class="op" id="4683937">:=</span>&nbsp;<span class="ident" id="4683940">e</span><span class="op" id="4683941">.</span><span class="op" id="4683942">(</span><span class="ident" id="4683943">runtime</span><span class="op" id="4683950">.</span><span class="ident" id="4683951">Error</span><span class="op" id="4683956">)</span><span class="op" id="4683957">;</span>&nbsp;<span class="ident" id="4683959">ok</span>&nbsp;<span class="op" id="4683962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4683967">panic</span><span class="op" id="4683972">(</span><span class="ident" id="4683973">e</span><span class="op" id="4683974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4683978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4683982">if</span>&nbsp;<span class="ident" id="4683985">t</span>&nbsp;<span class="op" id="4683987">!=</span>&nbsp;<span class="ident" id="4683990">nil</span>&nbsp;<span class="op" id="4683994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4683999">t</span><span class="op" id="4684000">.</span><span class="ident" id="4684001">stopParse</span><span class="op" id="4684010">(</span><span class="op" id="4684011">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4684015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4684019">*</span><span class="ident" id="4684020">errp</span>&nbsp;<span class="op" id="4684025">=</span>&nbsp;<span class="ident" id="4684027">e</span><span class="op" id="4684028">.</span><span class="op" id="4684029">(</span><span class="builtintype" id="4684030">error</span><span class="op" id="4684035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4684038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4684041">return</span><br>
<span class="lineno"></span><span class="op" id="4684048">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="4684051">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="4684106">func</span>&nbsp;<span class="op" id="4684111">(</span><span class="ident" id="4684112">t</span>&nbsp;<span class="op" id="4684114">*</span><span class="ident" id="4684115">Tree</span><span class="op" id="4684119">)</span>&nbsp;<span class="ident" id="4684121">startParse</span><span class="op" id="4684131">(</span><span class="ident" id="4684132">funcs</span>&nbsp;<span class="op" id="4684138">[</span><span class="op" id="4684139">]</span><span class="keyword" id="4684140">map</span><span class="op" id="4684143">[</span><span class="builtintype" id="4684144">string</span><span class="op" id="4684150">]</span><span class="keyword" id="4684151">interface</span><span class="op" id="4684160">{</span><span class="op" id="4684161">}</span><span class="op" id="4684162">,</span>&nbsp;<span class="ident" id="4684164">lex</span>&nbsp;<span class="op" id="4684168">*</span><span class="ident" id="4684169">lexer</span><span class="op" id="4684174">)</span>&nbsp;<span class="op" id="4684176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684179">t</span><span class="op" id="4684180">.</span><span class="ident" id="4684181">Root</span>&nbsp;<span class="op" id="4684186">=</span>&nbsp;<span class="ident" id="4684188">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684193">t</span><span class="op" id="4684194">.</span><span class="ident" id="4684195">lex</span>&nbsp;<span class="op" id="4684199">=</span>&nbsp;<span class="ident" id="4684201">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684206">t</span><span class="op" id="4684207">.</span><span class="ident" id="4684208">vars</span>&nbsp;<span class="op" id="4684213">=</span>&nbsp;<span class="op" id="4684215">[</span><span class="op" id="4684216">]</span><span class="builtintype" id="4684217">string</span><span class="op" id="4684223">{</span><span class="string" id="4684224">&#34;$&#34;</span><span class="op" id="4684227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684230">t</span><span class="op" id="4684231">.</span><span class="ident" id="4684232">funcs</span>&nbsp;<span class="op" id="4684238">=</span>&nbsp;<span class="ident" id="4684240">funcs</span><br>
<span class="lineno"></span><span class="op" id="4684246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4684249">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="4684282">func</span>&nbsp;<span class="op" id="4684287">(</span><span class="ident" id="4684288">t</span>&nbsp;<span class="op" id="4684290">*</span><span class="ident" id="4684291">Tree</span><span class="op" id="4684295">)</span>&nbsp;<span class="ident" id="4684297">stopParse</span><span class="op" id="4684306">(</span><span class="op" id="4684307">)</span>&nbsp;<span class="op" id="4684309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684312">t</span><span class="op" id="4684313">.</span><span class="ident" id="4684314">lex</span>&nbsp;<span class="op" id="4684318">=</span>&nbsp;<span class="ident" id="4684320">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684325">t</span><span class="op" id="4684326">.</span><span class="ident" id="4684327">vars</span>&nbsp;<span class="op" id="4684332">=</span>&nbsp;<span class="ident" id="4684334">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684339">t</span><span class="op" id="4684340">.</span><span class="ident" id="4684341">funcs</span>&nbsp;<span class="op" id="4684347">=</span>&nbsp;<span class="ident" id="4684349">nil</span><br>
<span class="lineno"></span><span class="op" id="4684353">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4684356">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4684436">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4684515">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4684593">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="4684613">func</span>&nbsp;<span class="op" id="4684618">(</span><span class="ident" id="4684619">t</span>&nbsp;<span class="op" id="4684621">*</span><span class="ident" id="4684622">Tree</span><span class="op" id="4684626">)</span>&nbsp;<span class="ident" id="4684628">Parse</span><span class="op" id="4684633">(</span><span class="ident" id="4684634">text</span><span class="op" id="4684638">,</span>&nbsp;<span class="ident" id="4684640">leftDelim</span><span class="op" id="4684649">,</span>&nbsp;<span class="ident" id="4684651">rightDelim</span>&nbsp;<span class="builtintype" id="4684662">string</span><span class="op" id="4684668">,</span>&nbsp;<span class="ident" id="4684670">treeSet</span>&nbsp;<span class="keyword" id="4684678">map</span><span class="op" id="4684681">[</span><span class="builtintype" id="4684682">string</span><span class="op" id="4684688">]</span><span class="op" id="4684689">*</span><span class="ident" id="4684690">Tree</span><span class="op" id="4684694">,</span>&nbsp;<span class="ident" id="4684696">funcs</span>&nbsp;<span class="op" id="4684702">...</span><span class="keyword" id="4684705">map</span><span class="op" id="4684708">[</span><span class="builtintype" id="4684709">string</span><span class="op" id="4684715">]</span><span class="keyword" id="4684716">interface</span><span class="op" id="4684725">{</span><span class="op" id="4684726">}</span><span class="op" id="4684727">)</span>&nbsp;<span class="op" id="4684729">(</span><span class="ident" id="4684730">tree</span>&nbsp;<span class="op" id="4684735">*</span><span class="ident" id="4684736">Tree</span><span class="op" id="4684740">,</span>&nbsp;<span class="ident" id="4684742">err</span>&nbsp;<span class="builtintype" id="4684746">error</span><span class="op" id="4684751">)</span>&nbsp;<span class="op" id="4684753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4684756">defer</span>&nbsp;<span class="ident" id="4684762">t</span><span class="op" id="4684763">.</span><span class="builtinfunc" id="4684764">recover</span><span class="op" id="4684771">(</span><span class="op" id="4684772">&amp;</span><span class="ident" id="4684773">err</span><span class="op" id="4684776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684779">t</span><span class="op" id="4684780">.</span><span class="ident" id="4684781">ParseName</span>&nbsp;<span class="op" id="4684791">=</span>&nbsp;<span class="ident" id="4684793">t</span><span class="op" id="4684794">.</span><span class="ident" id="4684795">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684801">t</span><span class="op" id="4684802">.</span><span class="ident" id="4684803">startParse</span><span class="op" id="4684813">(</span><span class="ident" id="4684814">funcs</span><span class="op" id="4684819">,</span>&nbsp;<span class="ident" id="4684821">lex</span><span class="op" id="4684824">(</span><span class="ident" id="4684825">t</span><span class="op" id="4684826">.</span><span class="ident" id="4684827">Name</span><span class="op" id="4684831">,</span>&nbsp;<span class="ident" id="4684833">text</span><span class="op" id="4684837">,</span>&nbsp;<span class="ident" id="4684839">leftDelim</span><span class="op" id="4684848">,</span>&nbsp;<span class="ident" id="4684850">rightDelim</span><span class="op" id="4684860">)</span><span class="op" id="4684861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684864">t</span><span class="op" id="4684865">.</span><span class="ident" id="4684866">text</span>&nbsp;<span class="op" id="4684871">=</span>&nbsp;<span class="ident" id="4684873">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684879">t</span><span class="op" id="4684880">.</span><span class="ident" id="4684881">parse</span><span class="op" id="4684886">(</span><span class="ident" id="4684887">treeSet</span><span class="op" id="4684894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684897">t</span><span class="op" id="4684898">.</span><span class="ident" id="4684899">add</span><span class="op" id="4684902">(</span><span class="ident" id="4684903">treeSet</span><span class="op" id="4684910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4684913">t</span><span class="op" id="4684914">.</span><span class="ident" id="4684915">stopParse</span><span class="op" id="4684924">(</span><span class="op" id="4684925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4684928">return</span>&nbsp;<span class="ident" id="4684935">t</span><span class="op" id="4684936">,</span>&nbsp;<span class="ident" id="4684938">nil</span><br>
<span class="lineno"></span><span class="op" id="4684942">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4684945">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="4684978">func</span>&nbsp;<span class="op" id="4684983">(</span><span class="ident" id="4684984">t</span>&nbsp;<span class="op" id="4684986">*</span><span class="ident" id="4684987">Tree</span><span class="op" id="4684991">)</span>&nbsp;<span class="ident" id="4684993">add</span><span class="op" id="4684996">(</span><span class="ident" id="4684997">treeSet</span>&nbsp;<span class="keyword" id="4685005">map</span><span class="op" id="4685008">[</span><span class="builtintype" id="4685009">string</span><span class="op" id="4685015">]</span><span class="op" id="4685016">*</span><span class="ident" id="4685017">Tree</span><span class="op" id="4685021">)</span>&nbsp;<span class="op" id="4685023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4685026">tree</span>&nbsp;<span class="op" id="4685031">:=</span>&nbsp;<span class="ident" id="4685034">treeSet</span><span class="op" id="4685041">[</span><span class="ident" id="4685042">t</span><span class="op" id="4685043">.</span><span class="ident" id="4685044">Name</span><span class="op" id="4685048">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685051">if</span>&nbsp;<span class="ident" id="4685054">tree</span>&nbsp;<span class="op" id="4685059">==</span>&nbsp;<span class="ident" id="4685062">nil</span>&nbsp;<span class="op" id="4685066">||</span>&nbsp;<span class="ident" id="4685069">IsEmptyTree</span><span class="op" id="4685080">(</span><span class="ident" id="4685081">tree</span><span class="op" id="4685085">.</span><span class="ident" id="4685086">Root</span><span class="op" id="4685090">)</span>&nbsp;<span class="op" id="4685092">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4685096">treeSet</span><span class="op" id="4685103">[</span><span class="ident" id="4685104">t</span><span class="op" id="4685105">.</span><span class="ident" id="4685106">Name</span><span class="op" id="4685110">]</span>&nbsp;<span class="op" id="4685112">=</span>&nbsp;<span class="ident" id="4685114">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685118">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4685126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685129">if</span>&nbsp;<span class="op" id="4685132">!</span><span class="ident" id="4685133">IsEmptyTree</span><span class="op" id="4685144">(</span><span class="ident" id="4685145">t</span><span class="op" id="4685146">.</span><span class="ident" id="4685147">Root</span><span class="op" id="4685151">)</span>&nbsp;<span class="op" id="4685153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4685157">t</span><span class="op" id="4685158">.</span><span class="ident" id="4685159">errorf</span><span class="op" id="4685165">(</span><span class="string" id="4685166">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4685212">,</span>&nbsp;<span class="ident" id="4685214">t</span><span class="op" id="4685215">.</span><span class="ident" id="4685216">Name</span><span class="op" id="4685220">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4685223">}</span><br>
<span class="lineno"></span><span class="op" id="4685225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4685228">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="4685310">func</span>&nbsp;<span class="ident" id="4685315">IsEmptyTree</span><span class="op" id="4685326">(</span><span class="ident" id="4685327">n</span>&nbsp;<span class="ident" id="4685329">Node</span><span class="op" id="4685333">)</span>&nbsp;<span class="builtintype" id="4685335">bool</span>&nbsp;<span class="op" id="4685340">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685343">switch</span>&nbsp;<span class="ident" id="4685350">n</span>&nbsp;<span class="op" id="4685352">:=</span>&nbsp;<span class="ident" id="4685355">n</span><span class="op" id="4685356">.</span><span class="op" id="4685357">(</span><span class="keyword" id="4685358">type</span><span class="op" id="4685362">)</span>&nbsp;<span class="op" id="4685364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685367">case</span>&nbsp;<span class="ident" id="4685372">nil</span><span class="op" id="4685375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685379">return</span>&nbsp;<span class="builtintype" id="4685386">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685392">case</span>&nbsp;<span class="op" id="4685397">*</span><span class="ident" id="4685398">ActionNode</span><span class="op" id="4685408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685411">case</span>&nbsp;<span class="op" id="4685416">*</span><span class="ident" id="4685417">IfNode</span><span class="op" id="4685423">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685426">case</span>&nbsp;<span class="op" id="4685431">*</span><span class="ident" id="4685432">ListNode</span><span class="op" id="4685440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685444">for</span>&nbsp;<span class="ident" id="4685448">_</span><span class="op" id="4685449">,</span>&nbsp;<span class="ident" id="4685451">node</span>&nbsp;<span class="op" id="4685456">:=</span>&nbsp;<span class="keyword" id="4685459">range</span>&nbsp;<span class="ident" id="4685465">n</span><span class="op" id="4685466">.</span><span class="ident" id="4685467">Nodes</span>&nbsp;<span class="op" id="4685473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685478">if</span>&nbsp;<span class="op" id="4685481">!</span><span class="ident" id="4685482">IsEmptyTree</span><span class="op" id="4685493">(</span><span class="ident" id="4685494">node</span><span class="op" id="4685498">)</span>&nbsp;<span class="op" id="4685500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685506">return</span>&nbsp;<span class="builtintype" id="4685513">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4685522">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4685526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685530">return</span>&nbsp;<span class="builtintype" id="4685537">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685543">case</span>&nbsp;<span class="op" id="4685548">*</span><span class="ident" id="4685549">RangeNode</span><span class="op" id="4685558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685561">case</span>&nbsp;<span class="op" id="4685566">*</span><span class="ident" id="4685567">TemplateNode</span><span class="op" id="4685579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685582">case</span>&nbsp;<span class="op" id="4685587">*</span><span class="ident" id="4685588">TextNode</span><span class="op" id="4685596">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685600">return</span>&nbsp;<span class="builtinfunc" id="4685607">len</span><span class="op" id="4685610">(</span><span class="ident" id="4685611">bytes</span><span class="op" id="4685616">.</span><span class="ident" id="4685617">TrimSpace</span><span class="op" id="4685626">(</span><span class="ident" id="4685627">n</span><span class="op" id="4685628">.</span><span class="ident" id="4685629">Text</span><span class="op" id="4685633">)</span><span class="op" id="4685634">)</span>&nbsp;<span class="op" id="4685636">==</span>&nbsp;<span class="num" id="4685639">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685642">case</span>&nbsp;<span class="op" id="4685647">*</span><span class="ident" id="4685648">WithNode</span><span class="op" id="4685656">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685659">default</span><span class="op" id="4685666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4685670">panic</span><span class="op" id="4685675">(</span><span class="string" id="4685676">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="4685693">+</span>&nbsp;<span class="ident" id="4685695">n</span><span class="op" id="4685696">.</span><span class="ident" id="4685697">String</span><span class="op" id="4685703">(</span><span class="op" id="4685704">)</span><span class="op" id="4685705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4685708">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685711">return</span>&nbsp;<span class="builtintype" id="4685718">false</span><br>
<span class="lineno"></span><span class="op" id="4685724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4685727">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4685797">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="4685854">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="4685873">func</span>&nbsp;<span class="op" id="4685878">(</span><span class="ident" id="4685879">t</span>&nbsp;<span class="op" id="4685881">*</span><span class="ident" id="4685882">Tree</span><span class="op" id="4685886">)</span>&nbsp;<span class="ident" id="4685888">parse</span><span class="op" id="4685893">(</span><span class="ident" id="4685894">treeSet</span>&nbsp;<span class="keyword" id="4685902">map</span><span class="op" id="4685905">[</span><span class="builtintype" id="4685906">string</span><span class="op" id="4685912">]</span><span class="op" id="4685913">*</span><span class="ident" id="4685914">Tree</span><span class="op" id="4685918">)</span>&nbsp;<span class="op" id="4685920">(</span><span class="ident" id="4685921">next</span>&nbsp;<span class="ident" id="4685926">Node</span><span class="op" id="4685930">)</span>&nbsp;<span class="op" id="4685932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4685935">t</span><span class="op" id="4685936">.</span><span class="ident" id="4685937">Root</span>&nbsp;<span class="op" id="4685942">=</span>&nbsp;<span class="ident" id="4685944">t</span><span class="op" id="4685945">.</span><span class="ident" id="4685946">newList</span><span class="op" id="4685953">(</span><span class="ident" id="4685954">t</span><span class="op" id="4685955">.</span><span class="ident" id="4685956">peek</span><span class="op" id="4685960">(</span><span class="op" id="4685961">)</span><span class="op" id="4685962">.</span><span class="ident" id="4685963">pos</span><span class="op" id="4685966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4685969">for</span>&nbsp;<span class="ident" id="4685973">t</span><span class="op" id="4685974">.</span><span class="ident" id="4685975">peek</span><span class="op" id="4685979">(</span><span class="op" id="4685980">)</span><span class="op" id="4685981">.</span><span class="ident" id="4685982">typ</span>&nbsp;<span class="op" id="4685986">!=</span>&nbsp;<span class="ident" id="4685989">itemEOF</span>&nbsp;<span class="op" id="4685997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686001">if</span>&nbsp;<span class="ident" id="4686004">t</span><span class="op" id="4686005">.</span><span class="ident" id="4686006">peek</span><span class="op" id="4686010">(</span><span class="op" id="4686011">)</span><span class="op" id="4686012">.</span><span class="ident" id="4686013">typ</span>&nbsp;<span class="op" id="4686017">==</span>&nbsp;<span class="ident" id="4686020">itemLeftDelim</span>&nbsp;<span class="op" id="4686034">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686039">delim</span>&nbsp;<span class="op" id="4686045">:=</span>&nbsp;<span class="ident" id="4686048">t</span><span class="op" id="4686049">.</span><span class="ident" id="4686050">next</span><span class="op" id="4686054">(</span><span class="op" id="4686055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686060">if</span>&nbsp;<span class="ident" id="4686063">t</span><span class="op" id="4686064">.</span><span class="ident" id="4686065">nextNonSpace</span><span class="op" id="4686077">(</span><span class="op" id="4686078">)</span><span class="op" id="4686079">.</span><span class="ident" id="4686080">typ</span>&nbsp;<span class="op" id="4686084">==</span>&nbsp;<span class="ident" id="4686087">itemDefine</span>&nbsp;<span class="op" id="4686098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686104">newT</span>&nbsp;<span class="op" id="4686109">:=</span>&nbsp;<span class="ident" id="4686112">New</span><span class="op" id="4686115">(</span><span class="string" id="4686116">&#34;definition&#34;</span><span class="op" id="4686128">)</span>&nbsp;<span class="comment" id="4686130">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686175">newT</span><span class="op" id="4686179">.</span><span class="ident" id="4686180">text</span>&nbsp;<span class="op" id="4686185">=</span>&nbsp;<span class="ident" id="4686187">t</span><span class="op" id="4686188">.</span><span class="ident" id="4686189">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686198">newT</span><span class="op" id="4686202">.</span><span class="ident" id="4686203">ParseName</span>&nbsp;<span class="op" id="4686213">=</span>&nbsp;<span class="ident" id="4686215">t</span><span class="op" id="4686216">.</span><span class="ident" id="4686217">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686231">newT</span><span class="op" id="4686235">.</span><span class="ident" id="4686236">startParse</span><span class="op" id="4686246">(</span><span class="ident" id="4686247">t</span><span class="op" id="4686248">.</span><span class="ident" id="4686249">funcs</span><span class="op" id="4686254">,</span>&nbsp;<span class="ident" id="4686256">t</span><span class="op" id="4686257">.</span><span class="ident" id="4686258">lex</span><span class="op" id="4686261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686267">newT</span><span class="op" id="4686271">.</span><span class="ident" id="4686272">parseDefinition</span><span class="op" id="4686287">(</span><span class="ident" id="4686288">treeSet</span><span class="op" id="4686295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686301">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4686313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686318">t</span><span class="op" id="4686319">.</span><span class="ident" id="4686320">backup2</span><span class="op" id="4686327">(</span><span class="ident" id="4686328">delim</span><span class="op" id="4686333">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4686337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686341">n</span>&nbsp;<span class="op" id="4686343">:=</span>&nbsp;<span class="ident" id="4686346">t</span><span class="op" id="4686347">.</span><span class="ident" id="4686348">textOrAction</span><span class="op" id="4686360">(</span><span class="op" id="4686361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686365">if</span>&nbsp;<span class="ident" id="4686368">n</span><span class="op" id="4686369">.</span><span class="ident" id="4686370">Type</span><span class="op" id="4686374">(</span><span class="op" id="4686375">)</span>&nbsp;<span class="op" id="4686377">==</span>&nbsp;<span class="ident" id="4686380">nodeEnd</span>&nbsp;<span class="op" id="4686388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686393">t</span><span class="op" id="4686394">.</span><span class="ident" id="4686395">errorf</span><span class="op" id="4686401">(</span><span class="string" id="4686402">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="4686417">,</span>&nbsp;<span class="ident" id="4686419">n</span><span class="op" id="4686420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4686424">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686428">t</span><span class="op" id="4686429">.</span><span class="ident" id="4686430">Root</span><span class="op" id="4686434">.</span><span class="builtinfunc" id="4686435">append</span><span class="op" id="4686441">(</span><span class="ident" id="4686442">n</span><span class="op" id="4686443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4686446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686449">return</span>&nbsp;<span class="ident" id="4686456">nil</span><br>
<span class="lineno"></span><span class="op" id="4686460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="4686463">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4686539">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="4686620">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="4686637">func</span>&nbsp;<span class="op" id="4686642">(</span><span class="ident" id="4686643">t</span>&nbsp;<span class="op" id="4686645">*</span><span class="ident" id="4686646">Tree</span><span class="op" id="4686650">)</span>&nbsp;<span class="ident" id="4686652">parseDefinition</span><span class="op" id="4686667">(</span><span class="ident" id="4686668">treeSet</span>&nbsp;<span class="keyword" id="4686676">map</span><span class="op" id="4686679">[</span><span class="builtintype" id="4686680">string</span><span class="op" id="4686686">]</span><span class="op" id="4686687">*</span><span class="ident" id="4686688">Tree</span><span class="op" id="4686692">)</span>&nbsp;<span class="op" id="4686694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686697">const</span>&nbsp;<span class="ident" id="4686703">context</span>&nbsp;<span class="op" id="4686711">=</span>&nbsp;<span class="string" id="4686713">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686730">name</span>&nbsp;<span class="op" id="4686735">:=</span>&nbsp;<span class="ident" id="4686738">t</span><span class="op" id="4686739">.</span><span class="ident" id="4686740">expectOneOf</span><span class="op" id="4686751">(</span><span class="ident" id="4686752">itemString</span><span class="op" id="4686762">,</span>&nbsp;<span class="ident" id="4686764">itemRawString</span><span class="op" id="4686777">,</span>&nbsp;<span class="ident" id="4686779">context</span><span class="op" id="4686786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686789">var</span>&nbsp;<span class="ident" id="4686793">err</span>&nbsp;<span class="builtintype" id="4686797">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686804">t</span><span class="op" id="4686805">.</span><span class="ident" id="4686806">Name</span><span class="op" id="4686810">,</span>&nbsp;<span class="ident" id="4686812">err</span>&nbsp;<span class="op" id="4686816">=</span>&nbsp;<span class="ident" id="4686818">strconv</span><span class="op" id="4686825">.</span><span class="ident" id="4686826">Unquote</span><span class="op" id="4686833">(</span><span class="ident" id="4686834">name</span><span class="op" id="4686838">.</span><span class="ident" id="4686839">val</span><span class="op" id="4686842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686845">if</span>&nbsp;<span class="ident" id="4686848">err</span>&nbsp;<span class="op" id="4686852">!=</span>&nbsp;<span class="ident" id="4686855">nil</span>&nbsp;<span class="op" id="4686859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686863">t</span><span class="op" id="4686864">.</span><span class="builtintype" id="4686865">error</span><span class="op" id="4686870">(</span><span class="ident" id="4686871">err</span><span class="op" id="4686874">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4686877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686880">t</span><span class="op" id="4686881">.</span><span class="ident" id="4686882">expect</span><span class="op" id="4686888">(</span><span class="ident" id="4686889">itemRightDelim</span><span class="op" id="4686903">,</span>&nbsp;<span class="ident" id="4686905">context</span><span class="op" id="4686912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686915">var</span>&nbsp;<span class="ident" id="4686919">end</span>&nbsp;<span class="ident" id="4686923">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686929">t</span><span class="op" id="4686930">.</span><span class="ident" id="4686931">Root</span><span class="op" id="4686935">,</span>&nbsp;<span class="ident" id="4686937">end</span>&nbsp;<span class="op" id="4686941">=</span>&nbsp;<span class="ident" id="4686943">t</span><span class="op" id="4686944">.</span><span class="ident" id="4686945">itemList</span><span class="op" id="4686953">(</span><span class="op" id="4686954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4686957">if</span>&nbsp;<span class="ident" id="4686960">end</span><span class="op" id="4686963">.</span><span class="ident" id="4686964">Type</span><span class="op" id="4686968">(</span><span class="op" id="4686969">)</span>&nbsp;<span class="op" id="4686971">!=</span>&nbsp;<span class="ident" id="4686974">nodeEnd</span>&nbsp;<span class="op" id="4686982">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4686986">t</span><span class="op" id="4686987">.</span><span class="ident" id="4686988">errorf</span><span class="op" id="4686994">(</span><span class="string" id="4686995">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4687016">,</span>&nbsp;<span class="ident" id="4687018">end</span><span class="op" id="4687021">,</span>&nbsp;<span class="ident" id="4687023">context</span><span class="op" id="4687030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4687033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687036">t</span><span class="op" id="4687037">.</span><span class="ident" id="4687038">add</span><span class="op" id="4687041">(</span><span class="ident" id="4687042">treeSet</span><span class="op" id="4687049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687052">t</span><span class="op" id="4687053">.</span><span class="ident" id="4687054">stopParse</span><span class="op" id="4687063">(</span><span class="op" id="4687064">)</span><br>
<span class="lineno"></span><span class="op" id="4687066">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="4687069">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="4687082">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="4687099">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="4687158">func</span>&nbsp;<span class="op" id="4687163">(</span><span class="ident" id="4687164">t</span>&nbsp;<span class="op" id="4687166">*</span><span class="ident" id="4687167">Tree</span><span class="op" id="4687171">)</span>&nbsp;<span class="ident" id="4687173">itemList</span><span class="op" id="4687181">(</span><span class="op" id="4687182">)</span>&nbsp;<span class="op" id="4687184">(</span><span class="ident" id="4687185">list</span>&nbsp;<span class="op" id="4687190">*</span><span class="ident" id="4687191">ListNode</span><span class="op" id="4687199">,</span>&nbsp;<span class="ident" id="4687201">next</span>&nbsp;<span class="ident" id="4687206">Node</span><span class="op" id="4687210">)</span>&nbsp;<span class="op" id="4687212">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687215">list</span>&nbsp;<span class="op" id="4687220">=</span>&nbsp;<span class="ident" id="4687222">t</span><span class="op" id="4687223">.</span><span class="ident" id="4687224">newList</span><span class="op" id="4687231">(</span><span class="ident" id="4687232">t</span><span class="op" id="4687233">.</span><span class="ident" id="4687234">peekNonSpace</span><span class="op" id="4687246">(</span><span class="op" id="4687247">)</span><span class="op" id="4687248">.</span><span class="ident" id="4687249">pos</span><span class="op" id="4687252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687255">for</span>&nbsp;<span class="ident" id="4687259">t</span><span class="op" id="4687260">.</span><span class="ident" id="4687261">peekNonSpace</span><span class="op" id="4687273">(</span><span class="op" id="4687274">)</span><span class="op" id="4687275">.</span><span class="ident" id="4687276">typ</span>&nbsp;<span class="op" id="4687280">!=</span>&nbsp;<span class="ident" id="4687283">itemEOF</span>&nbsp;<span class="op" id="4687291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687295">n</span>&nbsp;<span class="op" id="4687297">:=</span>&nbsp;<span class="ident" id="4687300">t</span><span class="op" id="4687301">.</span><span class="ident" id="4687302">textOrAction</span><span class="op" id="4687314">(</span><span class="op" id="4687315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687319">switch</span>&nbsp;<span class="ident" id="4687326">n</span><span class="op" id="4687327">.</span><span class="ident" id="4687328">Type</span><span class="op" id="4687332">(</span><span class="op" id="4687333">)</span>&nbsp;<span class="op" id="4687335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687339">case</span>&nbsp;<span class="ident" id="4687344">nodeEnd</span><span class="op" id="4687351">,</span>&nbsp;<span class="ident" id="4687353">nodeElse</span><span class="op" id="4687361">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687366">return</span>&nbsp;<span class="ident" id="4687373">list</span><span class="op" id="4687377">,</span>&nbsp;<span class="ident" id="4687379">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4687383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687387">list</span><span class="op" id="4687391">.</span><span class="builtinfunc" id="4687392">append</span><span class="op" id="4687398">(</span><span class="ident" id="4687399">n</span><span class="op" id="4687400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4687403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687406">t</span><span class="op" id="4687407">.</span><span class="ident" id="4687408">errorf</span><span class="op" id="4687414">(</span><span class="string" id="4687415">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="4687431">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687434">return</span><br>
<span class="lineno"></span><span class="op" id="4687441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4687444">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="4687461">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="4687478">func</span>&nbsp;<span class="op" id="4687483">(</span><span class="ident" id="4687484">t</span>&nbsp;<span class="op" id="4687486">*</span><span class="ident" id="4687487">Tree</span><span class="op" id="4687491">)</span>&nbsp;<span class="ident" id="4687493">textOrAction</span><span class="op" id="4687505">(</span><span class="op" id="4687506">)</span>&nbsp;<span class="ident" id="4687508">Node</span>&nbsp;<span class="op" id="4687513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687516">switch</span>&nbsp;<span class="ident" id="4687523">token</span>&nbsp;<span class="op" id="4687529">:=</span>&nbsp;<span class="ident" id="4687532">t</span><span class="op" id="4687533">.</span><span class="ident" id="4687534">nextNonSpace</span><span class="op" id="4687546">(</span><span class="op" id="4687547">)</span><span class="op" id="4687548">;</span>&nbsp;<span class="ident" id="4687550">token</span><span class="op" id="4687555">.</span><span class="ident" id="4687556">typ</span>&nbsp;<span class="op" id="4687560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687563">case</span>&nbsp;<span class="ident" id="4687568">itemText</span><span class="op" id="4687576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687580">return</span>&nbsp;<span class="ident" id="4687587">t</span><span class="op" id="4687588">.</span><span class="ident" id="4687589">newText</span><span class="op" id="4687596">(</span><span class="ident" id="4687597">token</span><span class="op" id="4687602">.</span><span class="ident" id="4687603">pos</span><span class="op" id="4687606">,</span>&nbsp;<span class="ident" id="4687608">token</span><span class="op" id="4687613">.</span><span class="ident" id="4687614">val</span><span class="op" id="4687617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687620">case</span>&nbsp;<span class="ident" id="4687625">itemLeftDelim</span><span class="op" id="4687638">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687642">return</span>&nbsp;<span class="ident" id="4687649">t</span><span class="op" id="4687650">.</span><span class="ident" id="4687651">action</span><span class="op" id="4687657">(</span><span class="op" id="4687658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687661">default</span><span class="op" id="4687668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4687672">t</span><span class="op" id="4687673">.</span><span class="ident" id="4687674">unexpected</span><span class="op" id="4687684">(</span><span class="ident" id="4687685">token</span><span class="op" id="4687690">,</span>&nbsp;<span class="string" id="4687692">&#34;input&#34;</span><span class="op" id="4687699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4687702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687705">return</span>&nbsp;<span class="ident" id="4687712">nil</span><br>
<span class="lineno">350</span><span class="op" id="4687716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4687719">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="4687730">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="4687741">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="4687767">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="4687807">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="4687855">func</span>&nbsp;<span class="op" id="4687860">(</span><span class="ident" id="4687861">t</span>&nbsp;<span class="op" id="4687863">*</span><span class="ident" id="4687864">Tree</span><span class="op" id="4687868">)</span>&nbsp;<span class="ident" id="4687870">action</span><span class="op" id="4687876">(</span><span class="op" id="4687877">)</span>&nbsp;<span class="op" id="4687879">(</span><span class="ident" id="4687880">n</span>&nbsp;<span class="ident" id="4687882">Node</span><span class="op" id="4687886">)</span>&nbsp;<span class="op" id="4687888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687891">switch</span>&nbsp;<span class="ident" id="4687898">token</span>&nbsp;<span class="op" id="4687904">:=</span>&nbsp;<span class="ident" id="4687907">t</span><span class="op" id="4687908">.</span><span class="ident" id="4687909">nextNonSpace</span><span class="op" id="4687921">(</span><span class="op" id="4687922">)</span><span class="op" id="4687923">;</span>&nbsp;<span class="ident" id="4687925">token</span><span class="op" id="4687930">.</span><span class="ident" id="4687931">typ</span>&nbsp;<span class="op" id="4687935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687938">case</span>&nbsp;<span class="ident" id="4687943">itemElse</span><span class="op" id="4687951">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687955">return</span>&nbsp;<span class="ident" id="4687962">t</span><span class="op" id="4687963">.</span><span class="ident" id="4687964">elseControl</span><span class="op" id="4687975">(</span><span class="op" id="4687976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687979">case</span>&nbsp;<span class="ident" id="4687984">itemEnd</span><span class="op" id="4687991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4687995">return</span>&nbsp;<span class="ident" id="4688002">t</span><span class="op" id="4688003">.</span><span class="ident" id="4688004">endControl</span><span class="op" id="4688014">(</span><span class="op" id="4688015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688018">case</span>&nbsp;<span class="ident" id="4688023">itemIf</span><span class="op" id="4688029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688033">return</span>&nbsp;<span class="ident" id="4688040">t</span><span class="op" id="4688041">.</span><span class="ident" id="4688042">ifControl</span><span class="op" id="4688051">(</span><span class="op" id="4688052">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688055">case</span>&nbsp;<span class="ident" id="4688060">itemRange</span><span class="op" id="4688069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688073">return</span>&nbsp;<span class="ident" id="4688080">t</span><span class="op" id="4688081">.</span><span class="ident" id="4688082">rangeControl</span><span class="op" id="4688094">(</span><span class="op" id="4688095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688098">case</span>&nbsp;<span class="ident" id="4688103">itemTemplate</span><span class="op" id="4688115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688119">return</span>&nbsp;<span class="ident" id="4688126">t</span><span class="op" id="4688127">.</span><span class="ident" id="4688128">templateControl</span><span class="op" id="4688143">(</span><span class="op" id="4688144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688147">case</span>&nbsp;<span class="ident" id="4688152">itemWith</span><span class="op" id="4688160">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688164">return</span>&nbsp;<span class="ident" id="4688171">t</span><span class="op" id="4688172">.</span><span class="ident" id="4688173">withControl</span><span class="op" id="4688184">(</span><span class="op" id="4688185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4688188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688191">t</span><span class="op" id="4688192">.</span><span class="ident" id="4688193">backup</span><span class="op" id="4688199">(</span><span class="op" id="4688200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688203">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688255">return</span>&nbsp;<span class="ident" id="4688262">t</span><span class="op" id="4688263">.</span><span class="ident" id="4688264">newAction</span><span class="op" id="4688273">(</span><span class="ident" id="4688274">t</span><span class="op" id="4688275">.</span><span class="ident" id="4688276">peek</span><span class="op" id="4688280">(</span><span class="op" id="4688281">)</span><span class="op" id="4688282">.</span><span class="ident" id="4688283">pos</span><span class="op" id="4688286">,</span>&nbsp;<span class="ident" id="4688288">t</span><span class="op" id="4688289">.</span><span class="ident" id="4688290">lex</span><span class="op" id="4688293">.</span><span class="ident" id="4688294">lineNumber</span><span class="op" id="4688304">(</span><span class="op" id="4688305">)</span><span class="op" id="4688306">,</span>&nbsp;<span class="ident" id="4688308">t</span><span class="op" id="4688309">.</span><span class="ident" id="4688310">pipeline</span><span class="op" id="4688318">(</span><span class="string" id="4688319">&#34;command&#34;</span><span class="op" id="4688328">)</span><span class="op" id="4688329">)</span><br>
<span class="lineno">375</span><span class="op" id="4688331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4688334">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="4688347">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="4688387">func</span>&nbsp;<span class="op" id="4688392">(</span><span class="ident" id="4688393">t</span>&nbsp;<span class="op" id="4688395">*</span><span class="ident" id="4688396">Tree</span><span class="op" id="4688400">)</span>&nbsp;<span class="ident" id="4688402">pipeline</span><span class="op" id="4688410">(</span><span class="ident" id="4688411">context</span>&nbsp;<span class="builtintype" id="4688419">string</span><span class="op" id="4688425">)</span>&nbsp;<span class="op" id="4688427">(</span><span class="ident" id="4688428">pipe</span>&nbsp;<span class="op" id="4688433">*</span><span class="ident" id="4688434">PipeNode</span><span class="op" id="4688442">)</span>&nbsp;<span class="op" id="4688444">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688447">var</span>&nbsp;<span class="ident" id="4688451">decl</span>&nbsp;<span class="op" id="4688456">[</span><span class="op" id="4688457">]</span><span class="op" id="4688458">*</span><span class="ident" id="4688459">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688473">pos</span>&nbsp;<span class="op" id="4688477">:=</span>&nbsp;<span class="ident" id="4688480">t</span><span class="op" id="4688481">.</span><span class="ident" id="4688482">peekNonSpace</span><span class="op" id="4688494">(</span><span class="op" id="4688495">)</span><span class="op" id="4688496">.</span><span class="ident" id="4688497">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688502">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688530">for</span>&nbsp;<span class="op" id="4688534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688538">if</span>&nbsp;<span class="ident" id="4688541">v</span>&nbsp;<span class="op" id="4688543">:=</span>&nbsp;<span class="ident" id="4688546">t</span><span class="op" id="4688547">.</span><span class="ident" id="4688548">peekNonSpace</span><span class="op" id="4688560">(</span><span class="op" id="4688561">)</span><span class="op" id="4688562">;</span>&nbsp;<span class="ident" id="4688564">v</span><span class="op" id="4688565">.</span><span class="ident" id="4688566">typ</span>&nbsp;<span class="op" id="4688570">==</span>&nbsp;<span class="ident" id="4688573">itemVariable</span>&nbsp;<span class="op" id="4688586">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688591">t</span><span class="op" id="4688592">.</span><span class="ident" id="4688593">next</span><span class="op" id="4688597">(</span><span class="op" id="4688598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688603">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688684">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688767">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4688840">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4688908">tokenAfterVariable</span>&nbsp;<span class="op" id="4688927">:=</span>&nbsp;<span class="ident" id="4688930">t</span><span class="op" id="4688931">.</span><span class="ident" id="4688932">peek</span><span class="op" id="4688936">(</span><span class="op" id="4688937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4688942">if</span>&nbsp;<span class="ident" id="4688945">next</span>&nbsp;<span class="op" id="4688950">:=</span>&nbsp;<span class="ident" id="4688953">t</span><span class="op" id="4688954">.</span><span class="ident" id="4688955">peekNonSpace</span><span class="op" id="4688967">(</span><span class="op" id="4688968">)</span><span class="op" id="4688969">;</span>&nbsp;<span class="ident" id="4688971">next</span><span class="op" id="4688975">.</span><span class="ident" id="4688976">typ</span>&nbsp;<span class="op" id="4688980">==</span>&nbsp;<span class="ident" id="4688983">itemColonEquals</span>&nbsp;<span class="op" id="4688999">||</span>&nbsp;<span class="op" id="4689002">(</span><span class="ident" id="4689003">next</span><span class="op" id="4689007">.</span><span class="ident" id="4689008">typ</span>&nbsp;<span class="op" id="4689012">==</span>&nbsp;<span class="ident" id="4689015">itemChar</span>&nbsp;<span class="op" id="4689024">&amp;&amp;</span>&nbsp;<span class="ident" id="4689027">next</span><span class="op" id="4689031">.</span><span class="ident" id="4689032">val</span>&nbsp;<span class="op" id="4689036">==</span>&nbsp;<span class="string" id="4689039">&#34;,&#34;</span><span class="op" id="4689042">)</span>&nbsp;<span class="op" id="4689044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689050">t</span><span class="op" id="4689051">.</span><span class="ident" id="4689052">nextNonSpace</span><span class="op" id="4689064">(</span><span class="op" id="4689065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689071">variable</span>&nbsp;<span class="op" id="4689080">:=</span>&nbsp;<span class="ident" id="4689083">t</span><span class="op" id="4689084">.</span><span class="ident" id="4689085">newVariable</span><span class="op" id="4689096">(</span><span class="ident" id="4689097">v</span><span class="op" id="4689098">.</span><span class="ident" id="4689099">pos</span><span class="op" id="4689102">,</span>&nbsp;<span class="ident" id="4689104">v</span><span class="op" id="4689105">.</span><span class="ident" id="4689106">val</span><span class="op" id="4689109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689115">decl</span>&nbsp;<span class="op" id="4689120">=</span>&nbsp;<span class="builtinfunc" id="4689122">append</span><span class="op" id="4689128">(</span><span class="ident" id="4689129">decl</span><span class="op" id="4689133">,</span>&nbsp;<span class="ident" id="4689135">variable</span><span class="op" id="4689143">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689149">t</span><span class="op" id="4689150">.</span><span class="ident" id="4689151">vars</span>&nbsp;<span class="op" id="4689156">=</span>&nbsp;<span class="builtinfunc" id="4689158">append</span><span class="op" id="4689164">(</span><span class="ident" id="4689165">t</span><span class="op" id="4689166">.</span><span class="ident" id="4689167">vars</span><span class="op" id="4689171">,</span>&nbsp;<span class="ident" id="4689173">v</span><span class="op" id="4689174">.</span><span class="ident" id="4689175">val</span><span class="op" id="4689178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689184">if</span>&nbsp;<span class="ident" id="4689187">next</span><span class="op" id="4689191">.</span><span class="ident" id="4689192">typ</span>&nbsp;<span class="op" id="4689196">==</span>&nbsp;<span class="ident" id="4689199">itemChar</span>&nbsp;<span class="op" id="4689208">&amp;&amp;</span>&nbsp;<span class="ident" id="4689211">next</span><span class="op" id="4689215">.</span><span class="ident" id="4689216">val</span>&nbsp;<span class="op" id="4689220">==</span>&nbsp;<span class="string" id="4689223">&#34;,&#34;</span>&nbsp;<span class="op" id="4689227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689234">if</span>&nbsp;<span class="ident" id="4689237">context</span>&nbsp;<span class="op" id="4689245">==</span>&nbsp;<span class="string" id="4689248">&#34;range&#34;</span>&nbsp;<span class="op" id="4689256">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4689259">len</span><span class="op" id="4689262">(</span><span class="ident" id="4689263">decl</span><span class="op" id="4689267">)</span>&nbsp;<span class="op" id="4689269">&lt;</span>&nbsp;<span class="num" id="4689271">2</span>&nbsp;<span class="op" id="4689273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689281">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689295">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689302">t</span><span class="op" id="4689303">.</span><span class="ident" id="4689304">errorf</span><span class="op" id="4689310">(</span><span class="string" id="4689311">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4689340">,</span>&nbsp;<span class="ident" id="4689342">context</span><span class="op" id="4689349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689360">}</span>&nbsp;<span class="keyword" id="4689362">else</span>&nbsp;<span class="keyword" id="4689367">if</span>&nbsp;<span class="ident" id="4689370">tokenAfterVariable</span><span class="op" id="4689388">.</span><span class="ident" id="4689389">typ</span>&nbsp;<span class="op" id="4689393">==</span>&nbsp;<span class="ident" id="4689396">itemSpace</span>&nbsp;<span class="op" id="4689406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689412">t</span><span class="op" id="4689413">.</span><span class="ident" id="4689414">backup3</span><span class="op" id="4689421">(</span><span class="ident" id="4689422">v</span><span class="op" id="4689423">,</span>&nbsp;<span class="ident" id="4689425">tokenAfterVariable</span><span class="op" id="4689443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689448">}</span>&nbsp;<span class="keyword" id="4689450">else</span>&nbsp;<span class="op" id="4689455">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689461">t</span><span class="op" id="4689462">.</span><span class="ident" id="4689463">backup2</span><span class="op" id="4689470">(</span><span class="ident" id="4689471">v</span><span class="op" id="4689472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689492">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689495">pipe</span>&nbsp;<span class="op" id="4689500">=</span>&nbsp;<span class="ident" id="4689502">t</span><span class="op" id="4689503">.</span><span class="ident" id="4689504">newPipeline</span><span class="op" id="4689515">(</span><span class="ident" id="4689516">pos</span><span class="op" id="4689519">,</span>&nbsp;<span class="ident" id="4689521">t</span><span class="op" id="4689522">.</span><span class="ident" id="4689523">lex</span><span class="op" id="4689526">.</span><span class="ident" id="4689527">lineNumber</span><span class="op" id="4689537">(</span><span class="op" id="4689538">)</span><span class="op" id="4689539">,</span>&nbsp;<span class="ident" id="4689541">decl</span><span class="op" id="4689545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689548">for</span>&nbsp;<span class="op" id="4689552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689556">switch</span>&nbsp;<span class="ident" id="4689563">token</span>&nbsp;<span class="op" id="4689569">:=</span>&nbsp;<span class="ident" id="4689572">t</span><span class="op" id="4689573">.</span><span class="ident" id="4689574">nextNonSpace</span><span class="op" id="4689586">(</span><span class="op" id="4689587">)</span><span class="op" id="4689588">;</span>&nbsp;<span class="ident" id="4689590">token</span><span class="op" id="4689595">.</span><span class="ident" id="4689596">typ</span>&nbsp;<span class="op" id="4689600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689604">case</span>&nbsp;<span class="ident" id="4689609">itemRightDelim</span><span class="op" id="4689623">,</span>&nbsp;<span class="ident" id="4689625">itemRightParen</span><span class="op" id="4689639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689644">if</span>&nbsp;<span class="builtinfunc" id="4689647">len</span><span class="op" id="4689650">(</span><span class="ident" id="4689651">pipe</span><span class="op" id="4689655">.</span><span class="ident" id="4689656">Cmds</span><span class="op" id="4689660">)</span>&nbsp;<span class="op" id="4689662">==</span>&nbsp;<span class="num" id="4689665">0</span>&nbsp;<span class="op" id="4689667">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689673">t</span><span class="op" id="4689674">.</span><span class="ident" id="4689675">errorf</span><span class="op" id="4689681">(</span><span class="string" id="4689682">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4689704">,</span>&nbsp;<span class="ident" id="4689706">context</span><span class="op" id="4689713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689723">if</span>&nbsp;<span class="ident" id="4689726">token</span><span class="op" id="4689731">.</span><span class="ident" id="4689732">typ</span>&nbsp;<span class="op" id="4689736">==</span>&nbsp;<span class="ident" id="4689739">itemRightParen</span>&nbsp;<span class="op" id="4689754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689760">t</span><span class="op" id="4689761">.</span><span class="ident" id="4689762">backup</span><span class="op" id="4689768">(</span><span class="op" id="4689769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4689774">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689779">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689788">case</span>&nbsp;<span class="ident" id="4689793">itemBool</span><span class="op" id="4689801">,</span>&nbsp;<span class="ident" id="4689803">itemCharConstant</span><span class="op" id="4689819">,</span>&nbsp;<span class="ident" id="4689821">itemComplex</span><span class="op" id="4689832">,</span>&nbsp;<span class="ident" id="4689834">itemDot</span><span class="op" id="4689841">,</span>&nbsp;<span class="ident" id="4689843">itemField</span><span class="op" id="4689852">,</span>&nbsp;<span class="ident" id="4689854">itemIdentifier</span><span class="op" id="4689868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689873">itemNumber</span><span class="op" id="4689883">,</span>&nbsp;<span class="ident" id="4689885">itemNil</span><span class="op" id="4689892">,</span>&nbsp;<span class="ident" id="4689894">itemRawString</span><span class="op" id="4689907">,</span>&nbsp;<span class="ident" id="4689909">itemString</span><span class="op" id="4689919">,</span>&nbsp;<span class="ident" id="4689921">itemVariable</span><span class="op" id="4689933">,</span>&nbsp;<span class="ident" id="4689935">itemLeftParen</span><span class="op" id="4689948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689953">t</span><span class="op" id="4689954">.</span><span class="ident" id="4689955">backup</span><span class="op" id="4689961">(</span><span class="op" id="4689962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689967">pipe</span><span class="op" id="4689971">.</span><span class="builtinfunc" id="4689972">append</span><span class="op" id="4689978">(</span><span class="ident" id="4689979">t</span><span class="op" id="4689980">.</span><span class="ident" id="4689981">command</span><span class="op" id="4689988">(</span><span class="op" id="4689989">)</span><span class="op" id="4689990">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4689994">default</span><span class="op" id="4690001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690006">t</span><span class="op" id="4690007">.</span><span class="ident" id="4690008">unexpected</span><span class="op" id="4690018">(</span><span class="ident" id="4690019">token</span><span class="op" id="4690024">,</span>&nbsp;<span class="ident" id="4690026">context</span><span class="op" id="4690033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690040">}</span><br>
<span class="lineno"></span><span class="op" id="4690042">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4690045">func</span>&nbsp;<span class="op" id="4690050">(</span><span class="ident" id="4690051">t</span>&nbsp;<span class="op" id="4690053">*</span><span class="ident" id="4690054">Tree</span><span class="op" id="4690058">)</span>&nbsp;<span class="ident" id="4690060">parseControl</span><span class="op" id="4690072">(</span><span class="ident" id="4690073">allowElseIf</span>&nbsp;<span class="builtintype" id="4690085">bool</span><span class="op" id="4690089">,</span>&nbsp;<span class="ident" id="4690091">context</span>&nbsp;<span class="builtintype" id="4690099">string</span><span class="op" id="4690105">)</span>&nbsp;<span class="op" id="4690107">(</span><span class="ident" id="4690108">pos</span>&nbsp;<span class="ident" id="4690112">Pos</span><span class="op" id="4690115">,</span>&nbsp;<span class="ident" id="4690117">line</span>&nbsp;<span class="builtintype" id="4690122">int</span><span class="op" id="4690125">,</span>&nbsp;<span class="ident" id="4690127">pipe</span>&nbsp;<span class="op" id="4690132">*</span><span class="ident" id="4690133">PipeNode</span><span class="op" id="4690141">,</span>&nbsp;<span class="ident" id="4690143">list</span><span class="op" id="4690147">,</span>&nbsp;<span class="ident" id="4690149">elseList</span>&nbsp;<span class="op" id="4690158">*</span><span class="ident" id="4690159">ListNode</span><span class="op" id="4690167">)</span>&nbsp;<span class="op" id="4690169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690172">defer</span>&nbsp;<span class="ident" id="4690178">t</span><span class="op" id="4690179">.</span><span class="ident" id="4690180">popVars</span><span class="op" id="4690187">(</span><span class="builtinfunc" id="4690188">len</span><span class="op" id="4690191">(</span><span class="ident" id="4690192">t</span><span class="op" id="4690193">.</span><span class="ident" id="4690194">vars</span><span class="op" id="4690198">)</span><span class="op" id="4690199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690202">line</span>&nbsp;<span class="op" id="4690207">=</span>&nbsp;<span class="ident" id="4690209">t</span><span class="op" id="4690210">.</span><span class="ident" id="4690211">lex</span><span class="op" id="4690214">.</span><span class="ident" id="4690215">lineNumber</span><span class="op" id="4690225">(</span><span class="op" id="4690226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690229">pipe</span>&nbsp;<span class="op" id="4690234">=</span>&nbsp;<span class="ident" id="4690236">t</span><span class="op" id="4690237">.</span><span class="ident" id="4690238">pipeline</span><span class="op" id="4690246">(</span><span class="ident" id="4690247">context</span><span class="op" id="4690254">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690257">var</span>&nbsp;<span class="ident" id="4690261">next</span>&nbsp;<span class="ident" id="4690266">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690272">list</span><span class="op" id="4690276">,</span>&nbsp;<span class="ident" id="4690278">next</span>&nbsp;<span class="op" id="4690283">=</span>&nbsp;<span class="ident" id="4690285">t</span><span class="op" id="4690286">.</span><span class="ident" id="4690287">itemList</span><span class="op" id="4690295">(</span><span class="op" id="4690296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690299">switch</span>&nbsp;<span class="ident" id="4690306">next</span><span class="op" id="4690310">.</span><span class="ident" id="4690311">Type</span><span class="op" id="4690315">(</span><span class="op" id="4690316">)</span>&nbsp;<span class="op" id="4690318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690321">case</span>&nbsp;<span class="ident" id="4690326">nodeEnd</span><span class="op" id="4690333">:</span>&nbsp;<span class="comment" id="4690335">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690343">case</span>&nbsp;<span class="ident" id="4690348">nodeElse</span><span class="op" id="4690356">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690360">if</span>&nbsp;<span class="ident" id="4690363">allowElseIf</span>&nbsp;<span class="op" id="4690375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690380">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690464">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690531">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690568">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690577">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690625">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690711">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690783">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690838">if</span>&nbsp;<span class="ident" id="4690841">t</span><span class="op" id="4690842">.</span><span class="ident" id="4690843">peek</span><span class="op" id="4690847">(</span><span class="op" id="4690848">)</span><span class="op" id="4690849">.</span><span class="ident" id="4690850">typ</span>&nbsp;<span class="op" id="4690854">==</span>&nbsp;<span class="ident" id="4690857">itemIf</span>&nbsp;<span class="op" id="4690864">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690870">t</span><span class="op" id="4690871">.</span><span class="ident" id="4690872">next</span><span class="op" id="4690876">(</span><span class="op" id="4690877">)</span>&nbsp;<span class="comment" id="4690879">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690910">elseList</span>&nbsp;<span class="op" id="4690919">=</span>&nbsp;<span class="ident" id="4690921">t</span><span class="op" id="4690922">.</span><span class="ident" id="4690923">newList</span><span class="op" id="4690930">(</span><span class="ident" id="4690931">next</span><span class="op" id="4690935">.</span><span class="ident" id="4690936">Position</span><span class="op" id="4690944">(</span><span class="op" id="4690945">)</span><span class="op" id="4690946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690952">elseList</span><span class="op" id="4690960">.</span><span class="builtinfunc" id="4690961">append</span><span class="op" id="4690967">(</span><span class="ident" id="4690968">t</span><span class="op" id="4690969">.</span><span class="ident" id="4690970">ifControl</span><span class="op" id="4690979">(</span><span class="op" id="4690980">)</span><span class="op" id="4690981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4690987">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691052">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691069">elseList</span><span class="op" id="4691077">,</span>&nbsp;<span class="ident" id="4691079">next</span>&nbsp;<span class="op" id="4691084">=</span>&nbsp;<span class="ident" id="4691086">t</span><span class="op" id="4691087">.</span><span class="ident" id="4691088">itemList</span><span class="op" id="4691096">(</span><span class="op" id="4691097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691101">if</span>&nbsp;<span class="ident" id="4691104">next</span><span class="op" id="4691108">.</span><span class="ident" id="4691109">Type</span><span class="op" id="4691113">(</span><span class="op" id="4691114">)</span>&nbsp;<span class="op" id="4691116">!=</span>&nbsp;<span class="ident" id="4691119">nodeEnd</span>&nbsp;<span class="op" id="4691127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691132">t</span><span class="op" id="4691133">.</span><span class="ident" id="4691134">errorf</span><span class="op" id="4691140">(</span><span class="string" id="4691141">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="4691165">,</span>&nbsp;<span class="ident" id="4691167">next</span><span class="op" id="4691171">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691181">return</span>&nbsp;<span class="ident" id="4691188">pipe</span><span class="op" id="4691192">.</span><span class="ident" id="4691193">Position</span><span class="op" id="4691201">(</span><span class="op" id="4691202">)</span><span class="op" id="4691203">,</span>&nbsp;<span class="ident" id="4691205">line</span><span class="op" id="4691209">,</span>&nbsp;<span class="ident" id="4691211">pipe</span><span class="op" id="4691215">,</span>&nbsp;<span class="ident" id="4691217">list</span><span class="op" id="4691221">,</span>&nbsp;<span class="ident" id="4691223">elseList</span><br>
<span class="lineno"></span><span class="op" id="4691232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="4691235">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="4691242">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691278">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691332">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4691355">func</span>&nbsp;<span class="op" id="4691360">(</span><span class="ident" id="4691361">t</span>&nbsp;<span class="op" id="4691363">*</span><span class="ident" id="4691364">Tree</span><span class="op" id="4691368">)</span>&nbsp;<span class="ident" id="4691370">ifControl</span><span class="op" id="4691379">(</span><span class="op" id="4691380">)</span>&nbsp;<span class="ident" id="4691382">Node</span>&nbsp;<span class="op" id="4691387">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691390">return</span>&nbsp;<span class="ident" id="4691397">t</span><span class="op" id="4691398">.</span><span class="ident" id="4691399">newIf</span><span class="op" id="4691404">(</span><span class="ident" id="4691405">t</span><span class="op" id="4691406">.</span><span class="ident" id="4691407">parseControl</span><span class="op" id="4691419">(</span><span class="builtintype" id="4691420">true</span><span class="op" id="4691424">,</span>&nbsp;<span class="string" id="4691426">&#34;if&#34;</span><span class="op" id="4691430">)</span><span class="op" id="4691431">)</span><br>
<span class="lineno"></span><span class="op" id="4691433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4691436">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="4691446">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="4691485">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691542">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4691568">func</span>&nbsp;<span class="op" id="4691573">(</span><span class="ident" id="4691574">t</span>&nbsp;<span class="op" id="4691576">*</span><span class="ident" id="4691577">Tree</span><span class="op" id="4691581">)</span>&nbsp;<span class="ident" id="4691583">rangeControl</span><span class="op" id="4691595">(</span><span class="op" id="4691596">)</span>&nbsp;<span class="ident" id="4691598">Node</span>&nbsp;<span class="op" id="4691603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691606">return</span>&nbsp;<span class="ident" id="4691613">t</span><span class="op" id="4691614">.</span><span class="ident" id="4691615">newRange</span><span class="op" id="4691623">(</span><span class="ident" id="4691624">t</span><span class="op" id="4691625">.</span><span class="ident" id="4691626">parseControl</span><span class="op" id="4691638">(</span><span class="builtintype" id="4691639">false</span><span class="op" id="4691644">,</span>&nbsp;<span class="string" id="4691646">&#34;range&#34;</span><span class="op" id="4691653">)</span><span class="op" id="4691654">)</span><br>
<span class="lineno"></span><span class="op" id="4691656">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4691659">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="4691668">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691706">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691762">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="4691785">func</span>&nbsp;<span class="op" id="4691790">(</span><span class="ident" id="4691791">t</span>&nbsp;<span class="op" id="4691793">*</span><span class="ident" id="4691794">Tree</span><span class="op" id="4691798">)</span>&nbsp;<span class="ident" id="4691800">withControl</span><span class="op" id="4691811">(</span><span class="op" id="4691812">)</span>&nbsp;<span class="ident" id="4691814">Node</span>&nbsp;<span class="op" id="4691819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691822">return</span>&nbsp;<span class="ident" id="4691829">t</span><span class="op" id="4691830">.</span><span class="ident" id="4691831">newWith</span><span class="op" id="4691838">(</span><span class="ident" id="4691839">t</span><span class="op" id="4691840">.</span><span class="ident" id="4691841">parseControl</span><span class="op" id="4691853">(</span><span class="builtintype" id="4691854">false</span><span class="op" id="4691859">,</span>&nbsp;<span class="string" id="4691861">&#34;with&#34;</span><span class="op" id="4691867">)</span><span class="op" id="4691868">)</span><br>
<span class="lineno"></span><span class="op" id="4691870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4691873">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="4691881">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4691892">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4691916">func</span>&nbsp;<span class="op" id="4691921">(</span><span class="ident" id="4691922">t</span>&nbsp;<span class="op" id="4691924">*</span><span class="ident" id="4691925">Tree</span><span class="op" id="4691929">)</span>&nbsp;<span class="ident" id="4691931">endControl</span><span class="op" id="4691941">(</span><span class="op" id="4691942">)</span>&nbsp;<span class="ident" id="4691944">Node</span>&nbsp;<span class="op" id="4691949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691952">return</span>&nbsp;<span class="ident" id="4691959">t</span><span class="op" id="4691960">.</span><span class="ident" id="4691961">newEnd</span><span class="op" id="4691967">(</span><span class="ident" id="4691968">t</span><span class="op" id="4691969">.</span><span class="ident" id="4691970">expect</span><span class="op" id="4691976">(</span><span class="ident" id="4691977">itemRightDelim</span><span class="op" id="4691991">,</span>&nbsp;<span class="string" id="4691993">&#34;end&#34;</span><span class="op" id="4691998">)</span><span class="op" id="4691999">.</span><span class="ident" id="4692000">pos</span><span class="op" id="4692003">)</span><br>
<span class="lineno"></span><span class="op" id="4692005">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="4692008">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="4692017">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="4692029">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4692054">func</span>&nbsp;<span class="op" id="4692059">(</span><span class="ident" id="4692060">t</span>&nbsp;<span class="op" id="4692062">*</span><span class="ident" id="4692063">Tree</span><span class="op" id="4692067">)</span>&nbsp;<span class="ident" id="4692069">elseControl</span><span class="op" id="4692080">(</span><span class="op" id="4692081">)</span>&nbsp;<span class="ident" id="4692083">Node</span>&nbsp;<span class="op" id="4692088">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692091">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692123">peek</span>&nbsp;<span class="op" id="4692128">:=</span>&nbsp;<span class="ident" id="4692131">t</span><span class="op" id="4692132">.</span><span class="ident" id="4692133">peekNonSpace</span><span class="op" id="4692145">(</span><span class="op" id="4692146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692149">if</span>&nbsp;<span class="ident" id="4692152">peek</span><span class="op" id="4692156">.</span><span class="ident" id="4692157">typ</span>&nbsp;<span class="op" id="4692161">==</span>&nbsp;<span class="ident" id="4692164">itemIf</span>&nbsp;<span class="op" id="4692171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692175">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692252">return</span>&nbsp;<span class="ident" id="4692259">t</span><span class="op" id="4692260">.</span><span class="ident" id="4692261">newElse</span><span class="op" id="4692268">(</span><span class="ident" id="4692269">peek</span><span class="op" id="4692273">.</span><span class="ident" id="4692274">pos</span><span class="op" id="4692277">,</span>&nbsp;<span class="ident" id="4692279">t</span><span class="op" id="4692280">.</span><span class="ident" id="4692281">lex</span><span class="op" id="4692284">.</span><span class="ident" id="4692285">lineNumber</span><span class="op" id="4692295">(</span><span class="op" id="4692296">)</span><span class="op" id="4692297">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692303">return</span>&nbsp;<span class="ident" id="4692310">t</span><span class="op" id="4692311">.</span><span class="ident" id="4692312">newElse</span><span class="op" id="4692319">(</span><span class="ident" id="4692320">t</span><span class="op" id="4692321">.</span><span class="ident" id="4692322">expect</span><span class="op" id="4692328">(</span><span class="ident" id="4692329">itemRightDelim</span><span class="op" id="4692343">,</span>&nbsp;<span class="string" id="4692345">&#34;else&#34;</span><span class="op" id="4692351">)</span><span class="op" id="4692352">.</span><span class="ident" id="4692353">pos</span><span class="op" id="4692356">,</span>&nbsp;<span class="ident" id="4692358">t</span><span class="op" id="4692359">.</span><span class="ident" id="4692360">lex</span><span class="op" id="4692363">.</span><span class="ident" id="4692364">lineNumber</span><span class="op" id="4692374">(</span><span class="op" id="4692375">)</span><span class="op" id="4692376">)</span><br>
<span class="lineno"></span><span class="op" id="4692378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4692381">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="4692394">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="4692431">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="4692506">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4692522">func</span>&nbsp;<span class="op" id="4692527">(</span><span class="ident" id="4692528">t</span>&nbsp;<span class="op" id="4692530">*</span><span class="ident" id="4692531">Tree</span><span class="op" id="4692535">)</span>&nbsp;<span class="ident" id="4692537">templateControl</span><span class="op" id="4692552">(</span><span class="op" id="4692553">)</span>&nbsp;<span class="ident" id="4692555">Node</span>&nbsp;<span class="op" id="4692560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692563">var</span>&nbsp;<span class="ident" id="4692567">name</span>&nbsp;<span class="builtintype" id="4692572">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692580">token</span>&nbsp;<span class="op" id="4692586">:=</span>&nbsp;<span class="ident" id="4692589">t</span><span class="op" id="4692590">.</span><span class="ident" id="4692591">nextNonSpace</span><span class="op" id="4692603">(</span><span class="op" id="4692604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692607">switch</span>&nbsp;<span class="ident" id="4692614">token</span><span class="op" id="4692619">.</span><span class="ident" id="4692620">typ</span>&nbsp;<span class="op" id="4692624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692627">case</span>&nbsp;<span class="ident" id="4692632">itemString</span><span class="op" id="4692642">,</span>&nbsp;<span class="ident" id="4692644">itemRawString</span><span class="op" id="4692657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692661">s</span><span class="op" id="4692662">,</span>&nbsp;<span class="ident" id="4692664">err</span>&nbsp;<span class="op" id="4692668">:=</span>&nbsp;<span class="ident" id="4692671">strconv</span><span class="op" id="4692678">.</span><span class="ident" id="4692679">Unquote</span><span class="op" id="4692686">(</span><span class="ident" id="4692687">token</span><span class="op" id="4692692">.</span><span class="ident" id="4692693">val</span><span class="op" id="4692696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692700">if</span>&nbsp;<span class="ident" id="4692703">err</span>&nbsp;<span class="op" id="4692707">!=</span>&nbsp;<span class="ident" id="4692710">nil</span>&nbsp;<span class="op" id="4692714">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692719">t</span><span class="op" id="4692720">.</span><span class="builtintype" id="4692721">error</span><span class="op" id="4692726">(</span><span class="ident" id="4692727">err</span><span class="op" id="4692730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692738">name</span>&nbsp;<span class="op" id="4692743">=</span>&nbsp;<span class="ident" id="4692745">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692748">default</span><span class="op" id="4692755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692759">t</span><span class="op" id="4692760">.</span><span class="ident" id="4692761">unexpected</span><span class="op" id="4692771">(</span><span class="ident" id="4692772">token</span><span class="op" id="4692777">,</span>&nbsp;<span class="string" id="4692779">&#34;template&nbsp;invocation&#34;</span><span class="op" id="4692800">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692806">var</span>&nbsp;<span class="ident" id="4692810">pipe</span>&nbsp;<span class="op" id="4692815">*</span><span class="ident" id="4692816">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692826">if</span>&nbsp;<span class="ident" id="4692829">t</span><span class="op" id="4692830">.</span><span class="ident" id="4692831">nextNonSpace</span><span class="op" id="4692843">(</span><span class="op" id="4692844">)</span><span class="op" id="4692845">.</span><span class="ident" id="4692846">typ</span>&nbsp;<span class="op" id="4692850">!=</span>&nbsp;<span class="ident" id="4692853">itemRightDelim</span>&nbsp;<span class="op" id="4692868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692872">t</span><span class="op" id="4692873">.</span><span class="ident" id="4692874">backup</span><span class="op" id="4692880">(</span><span class="op" id="4692881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4692885">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692938">pipe</span>&nbsp;<span class="op" id="4692943">=</span>&nbsp;<span class="ident" id="4692945">t</span><span class="op" id="4692946">.</span><span class="ident" id="4692947">pipeline</span><span class="op" id="4692955">(</span><span class="string" id="4692956">&#34;template&#34;</span><span class="op" id="4692966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692972">return</span>&nbsp;<span class="ident" id="4692979">t</span><span class="op" id="4692980">.</span><span class="ident" id="4692981">newTemplate</span><span class="op" id="4692992">(</span><span class="ident" id="4692993">token</span><span class="op" id="4692998">.</span><span class="ident" id="4692999">pos</span><span class="op" id="4693002">,</span>&nbsp;<span class="ident" id="4693004">t</span><span class="op" id="4693005">.</span><span class="ident" id="4693006">lex</span><span class="op" id="4693009">.</span><span class="ident" id="4693010">lineNumber</span><span class="op" id="4693020">(</span><span class="op" id="4693021">)</span><span class="op" id="4693022">,</span>&nbsp;<span class="ident" id="4693024">name</span><span class="op" id="4693028">,</span>&nbsp;<span class="ident" id="4693030">pipe</span><span class="op" id="4693034">)</span><br>
<span class="lineno"></span><span class="op" id="4693036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="4693039">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="4693051">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="4693079">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="4693155">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="4693239">func</span>&nbsp;<span class="op" id="4693244">(</span><span class="ident" id="4693245">t</span>&nbsp;<span class="op" id="4693247">*</span><span class="ident" id="4693248">Tree</span><span class="op" id="4693252">)</span>&nbsp;<span class="ident" id="4693254">command</span><span class="op" id="4693261">(</span><span class="op" id="4693262">)</span>&nbsp;<span class="op" id="4693264">*</span><span class="ident" id="4693265">CommandNode</span>&nbsp;<span class="op" id="4693277">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693280">cmd</span>&nbsp;<span class="op" id="4693284">:=</span>&nbsp;<span class="ident" id="4693287">t</span><span class="op" id="4693288">.</span><span class="ident" id="4693289">newCommand</span><span class="op" id="4693299">(</span><span class="ident" id="4693300">t</span><span class="op" id="4693301">.</span><span class="ident" id="4693302">peekNonSpace</span><span class="op" id="4693314">(</span><span class="op" id="4693315">)</span><span class="op" id="4693316">.</span><span class="ident" id="4693317">pos</span><span class="op" id="4693320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693323">for</span>&nbsp;<span class="op" id="4693327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693331">t</span><span class="op" id="4693332">.</span><span class="ident" id="4693333">peekNonSpace</span><span class="op" id="4693345">(</span><span class="op" id="4693346">)</span>&nbsp;<span class="comment" id="4693348">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693374">operand</span>&nbsp;<span class="op" id="4693382">:=</span>&nbsp;<span class="ident" id="4693385">t</span><span class="op" id="4693386">.</span><span class="ident" id="4693387">operand</span><span class="op" id="4693394">(</span><span class="op" id="4693395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693399">if</span>&nbsp;<span class="ident" id="4693402">operand</span>&nbsp;<span class="op" id="4693410">!=</span>&nbsp;<span class="ident" id="4693413">nil</span>&nbsp;<span class="op" id="4693417">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693422">cmd</span><span class="op" id="4693425">.</span><span class="builtinfunc" id="4693426">append</span><span class="op" id="4693432">(</span><span class="ident" id="4693433">operand</span><span class="op" id="4693440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693448">switch</span>&nbsp;<span class="ident" id="4693455">token</span>&nbsp;<span class="op" id="4693461">:=</span>&nbsp;<span class="ident" id="4693464">t</span><span class="op" id="4693465">.</span><span class="ident" id="4693466">next</span><span class="op" id="4693470">(</span><span class="op" id="4693471">)</span><span class="op" id="4693472">;</span>&nbsp;<span class="ident" id="4693474">token</span><span class="op" id="4693479">.</span><span class="ident" id="4693480">typ</span>&nbsp;<span class="op" id="4693484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693488">case</span>&nbsp;<span class="ident" id="4693493">itemSpace</span><span class="op" id="4693502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693507">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693518">case</span>&nbsp;<span class="ident" id="4693523">itemError</span><span class="op" id="4693532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693537">t</span><span class="op" id="4693538">.</span><span class="ident" id="4693539">errorf</span><span class="op" id="4693545">(</span><span class="string" id="4693546">&#34;%s&#34;</span><span class="op" id="4693550">,</span>&nbsp;<span class="ident" id="4693552">token</span><span class="op" id="4693557">.</span><span class="ident" id="4693558">val</span><span class="op" id="4693561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693565">case</span>&nbsp;<span class="ident" id="4693570">itemRightDelim</span><span class="op" id="4693584">,</span>&nbsp;<span class="ident" id="4693586">itemRightParen</span><span class="op" id="4693600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693605">t</span><span class="op" id="4693606">.</span><span class="ident" id="4693607">backup</span><span class="op" id="4693613">(</span><span class="op" id="4693614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693618">case</span>&nbsp;<span class="ident" id="4693623">itemPipe</span><span class="op" id="4693631">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693635">default</span><span class="op" id="4693642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693647">t</span><span class="op" id="4693648">.</span><span class="ident" id="4693649">errorf</span><span class="op" id="4693655">(</span><span class="string" id="4693656">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="4693698">,</span>&nbsp;<span class="ident" id="4693700">token</span><span class="op" id="4693705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693713">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693720">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693723">if</span>&nbsp;<span class="builtinfunc" id="4693726">len</span><span class="op" id="4693729">(</span><span class="ident" id="4693730">cmd</span><span class="op" id="4693733">.</span><span class="ident" id="4693734">Args</span><span class="op" id="4693738">)</span>&nbsp;<span class="op" id="4693740">==</span>&nbsp;<span class="num" id="4693743">0</span>&nbsp;<span class="op" id="4693745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4693749">t</span><span class="op" id="4693750">.</span><span class="ident" id="4693751">errorf</span><span class="op" id="4693757">(</span><span class="string" id="4693758">&#34;empty&nbsp;command&#34;</span><span class="op" id="4693773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4693776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4693779">return</span>&nbsp;<span class="ident" id="4693786">cmd</span><br>
<span class="lineno"></span><span class="op" id="4693790">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="4693793">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="4693805">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="4693821">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="4693880">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="4693927">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="4693982">func</span>&nbsp;<span class="op" id="4693987">(</span><span class="ident" id="4693988">t</span>&nbsp;<span class="op" id="4693990">*</span><span class="ident" id="4693991">Tree</span><span class="op" id="4693995">)</span>&nbsp;<span class="ident" id="4693997">operand</span><span class="op" id="4694004">(</span><span class="op" id="4694005">)</span>&nbsp;<span class="ident" id="4694007">Node</span>&nbsp;<span class="op" id="4694012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694015">node</span>&nbsp;<span class="op" id="4694020">:=</span>&nbsp;<span class="ident" id="4694023">t</span><span class="op" id="4694024">.</span><span class="ident" id="4694025">term</span><span class="op" id="4694029">(</span><span class="op" id="4694030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694033">if</span>&nbsp;<span class="ident" id="4694036">node</span>&nbsp;<span class="op" id="4694041">==</span>&nbsp;<span class="ident" id="4694044">nil</span>&nbsp;<span class="op" id="4694048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694052">return</span>&nbsp;<span class="ident" id="4694059">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694067">if</span>&nbsp;<span class="ident" id="4694070">t</span><span class="op" id="4694071">.</span><span class="ident" id="4694072">peek</span><span class="op" id="4694076">(</span><span class="op" id="4694077">)</span><span class="op" id="4694078">.</span><span class="ident" id="4694079">typ</span>&nbsp;<span class="op" id="4694083">==</span>&nbsp;<span class="ident" id="4694086">itemField</span>&nbsp;<span class="op" id="4694096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694100">chain</span>&nbsp;<span class="op" id="4694106">:=</span>&nbsp;<span class="ident" id="4694109">t</span><span class="op" id="4694110">.</span><span class="ident" id="4694111">newChain</span><span class="op" id="4694119">(</span><span class="ident" id="4694120">t</span><span class="op" id="4694121">.</span><span class="ident" id="4694122">peek</span><span class="op" id="4694126">(</span><span class="op" id="4694127">)</span><span class="op" id="4694128">.</span><span class="ident" id="4694129">pos</span><span class="op" id="4694132">,</span>&nbsp;<span class="ident" id="4694134">node</span><span class="op" id="4694138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694142">for</span>&nbsp;<span class="ident" id="4694146">t</span><span class="op" id="4694147">.</span><span class="ident" id="4694148">peek</span><span class="op" id="4694152">(</span><span class="op" id="4694153">)</span><span class="op" id="4694154">.</span><span class="ident" id="4694155">typ</span>&nbsp;<span class="op" id="4694159">==</span>&nbsp;<span class="ident" id="4694162">itemField</span>&nbsp;<span class="op" id="4694172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694177">chain</span><span class="op" id="4694182">.</span><span class="ident" id="4694183">Add</span><span class="op" id="4694186">(</span><span class="ident" id="4694187">t</span><span class="op" id="4694188">.</span><span class="ident" id="4694189">next</span><span class="op" id="4694193">(</span><span class="op" id="4694194">)</span><span class="op" id="4694195">.</span><span class="ident" id="4694196">val</span><span class="op" id="4694199">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694207">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694278">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694338">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4694375">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694423">switch</span>&nbsp;<span class="ident" id="4694430">node</span><span class="op" id="4694434">.</span><span class="ident" id="4694435">Type</span><span class="op" id="4694439">(</span><span class="op" id="4694440">)</span>&nbsp;<span class="op" id="4694442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694446">case</span>&nbsp;<span class="ident" id="4694451">NodeField</span><span class="op" id="4694460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694465">node</span>&nbsp;<span class="op" id="4694470">=</span>&nbsp;<span class="ident" id="4694472">t</span><span class="op" id="4694473">.</span><span class="ident" id="4694474">newField</span><span class="op" id="4694482">(</span><span class="ident" id="4694483">chain</span><span class="op" id="4694488">.</span><span class="ident" id="4694489">Position</span><span class="op" id="4694497">(</span><span class="op" id="4694498">)</span><span class="op" id="4694499">,</span>&nbsp;<span class="ident" id="4694501">chain</span><span class="op" id="4694506">.</span><span class="ident" id="4694507">String</span><span class="op" id="4694513">(</span><span class="op" id="4694514">)</span><span class="op" id="4694515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694519">case</span>&nbsp;<span class="ident" id="4694524">NodeVariable</span><span class="op" id="4694536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694541">node</span>&nbsp;<span class="op" id="4694546">=</span>&nbsp;<span class="ident" id="4694548">t</span><span class="op" id="4694549">.</span><span class="ident" id="4694550">newVariable</span><span class="op" id="4694561">(</span><span class="ident" id="4694562">chain</span><span class="op" id="4694567">.</span><span class="ident" id="4694568">Position</span><span class="op" id="4694576">(</span><span class="op" id="4694577">)</span><span class="op" id="4694578">,</span>&nbsp;<span class="ident" id="4694580">chain</span><span class="op" id="4694585">.</span><span class="ident" id="4694586">String</span><span class="op" id="4694592">(</span><span class="op" id="4694593">)</span><span class="op" id="4694594">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694598">default</span><span class="op" id="4694605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694610">node</span>&nbsp;<span class="op" id="4694615">=</span>&nbsp;<span class="ident" id="4694617">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4694628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694631">return</span>&nbsp;<span class="ident" id="4694638">node</span><br>
<span class="lineno">595</span><span class="op" id="4694643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4694646">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="4694655">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="4694697">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="4694722">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="4694727">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="4694737">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="4694742">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="4694762">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="4694798">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="4694849">func</span>&nbsp;<span class="op" id="4694854">(</span><span class="ident" id="4694855">t</span>&nbsp;<span class="op" id="4694857">*</span><span class="ident" id="4694858">Tree</span><span class="op" id="4694862">)</span>&nbsp;<span class="ident" id="4694864">term</span><span class="op" id="4694868">(</span><span class="op" id="4694869">)</span>&nbsp;<span class="ident" id="4694871">Node</span>&nbsp;<span class="op" id="4694876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694879">switch</span>&nbsp;<span class="ident" id="4694886">token</span>&nbsp;<span class="op" id="4694892">:=</span>&nbsp;<span class="ident" id="4694895">t</span><span class="op" id="4694896">.</span><span class="ident" id="4694897">nextNonSpace</span><span class="op" id="4694909">(</span><span class="op" id="4694910">)</span><span class="op" id="4694911">;</span>&nbsp;<span class="ident" id="4694913">token</span><span class="op" id="4694918">.</span><span class="ident" id="4694919">typ</span>&nbsp;<span class="op" id="4694923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694926">case</span>&nbsp;<span class="ident" id="4694931">itemError</span><span class="op" id="4694940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4694944">t</span><span class="op" id="4694945">.</span><span class="ident" id="4694946">errorf</span><span class="op" id="4694952">(</span><span class="string" id="4694953">&#34;%s&#34;</span><span class="op" id="4694957">,</span>&nbsp;<span class="ident" id="4694959">token</span><span class="op" id="4694964">.</span><span class="ident" id="4694965">val</span><span class="op" id="4694968">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694971">case</span>&nbsp;<span class="ident" id="4694976">itemIdentifier</span><span class="op" id="4694990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4694994">if</span>&nbsp;<span class="op" id="4694997">!</span><span class="ident" id="4694998">t</span><span class="op" id="4694999">.</span><span class="ident" id="4695000">hasFunction</span><span class="op" id="4695011">(</span><span class="ident" id="4695012">token</span><span class="op" id="4695017">.</span><span class="ident" id="4695018">val</span><span class="op" id="4695021">)</span>&nbsp;<span class="op" id="4695023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695028">t</span><span class="op" id="4695029">.</span><span class="ident" id="4695030">errorf</span><span class="op" id="4695036">(</span><span class="string" id="4695037">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="4695062">,</span>&nbsp;<span class="ident" id="4695064">token</span><span class="op" id="4695069">.</span><span class="ident" id="4695070">val</span><span class="op" id="4695073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695081">return</span>&nbsp;<span class="ident" id="4695088">NewIdentifier</span><span class="op" id="4695101">(</span><span class="ident" id="4695102">token</span><span class="op" id="4695107">.</span><span class="ident" id="4695108">val</span><span class="op" id="4695111">)</span><span class="op" id="4695112">.</span><span class="ident" id="4695113">SetTree</span><span class="op" id="4695120">(</span><span class="ident" id="4695121">t</span><span class="op" id="4695122">)</span><span class="op" id="4695123">.</span><span class="ident" id="4695124">SetPos</span><span class="op" id="4695130">(</span><span class="ident" id="4695131">token</span><span class="op" id="4695136">.</span><span class="ident" id="4695137">pos</span><span class="op" id="4695140">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695143">case</span>&nbsp;<span class="ident" id="4695148">itemDot</span><span class="op" id="4695155">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695159">return</span>&nbsp;<span class="ident" id="4695166">t</span><span class="op" id="4695167">.</span><span class="ident" id="4695168">newDot</span><span class="op" id="4695174">(</span><span class="ident" id="4695175">token</span><span class="op" id="4695180">.</span><span class="ident" id="4695181">pos</span><span class="op" id="4695184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695187">case</span>&nbsp;<span class="ident" id="4695192">itemNil</span><span class="op" id="4695199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695203">return</span>&nbsp;<span class="ident" id="4695210">t</span><span class="op" id="4695211">.</span><span class="ident" id="4695212">newNil</span><span class="op" id="4695218">(</span><span class="ident" id="4695219">token</span><span class="op" id="4695224">.</span><span class="ident" id="4695225">pos</span><span class="op" id="4695228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695231">case</span>&nbsp;<span class="ident" id="4695236">itemVariable</span><span class="op" id="4695248">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695252">return</span>&nbsp;<span class="ident" id="4695259">t</span><span class="op" id="4695260">.</span><span class="ident" id="4695261">useVar</span><span class="op" id="4695267">(</span><span class="ident" id="4695268">token</span><span class="op" id="4695273">.</span><span class="ident" id="4695274">pos</span><span class="op" id="4695277">,</span>&nbsp;<span class="ident" id="4695279">token</span><span class="op" id="4695284">.</span><span class="ident" id="4695285">val</span><span class="op" id="4695288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695291">case</span>&nbsp;<span class="ident" id="4695296">itemField</span><span class="op" id="4695305">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695309">return</span>&nbsp;<span class="ident" id="4695316">t</span><span class="op" id="4695317">.</span><span class="ident" id="4695318">newField</span><span class="op" id="4695326">(</span><span class="ident" id="4695327">token</span><span class="op" id="4695332">.</span><span class="ident" id="4695333">pos</span><span class="op" id="4695336">,</span>&nbsp;<span class="ident" id="4695338">token</span><span class="op" id="4695343">.</span><span class="ident" id="4695344">val</span><span class="op" id="4695347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695350">case</span>&nbsp;<span class="ident" id="4695355">itemBool</span><span class="op" id="4695363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695367">return</span>&nbsp;<span class="ident" id="4695374">t</span><span class="op" id="4695375">.</span><span class="ident" id="4695376">newBool</span><span class="op" id="4695383">(</span><span class="ident" id="4695384">token</span><span class="op" id="4695389">.</span><span class="ident" id="4695390">pos</span><span class="op" id="4695393">,</span>&nbsp;<span class="ident" id="4695395">token</span><span class="op" id="4695400">.</span><span class="ident" id="4695401">val</span>&nbsp;<span class="op" id="4695405">==</span>&nbsp;<span class="string" id="4695408">&#34;true&#34;</span><span class="op" id="4695414">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695417">case</span>&nbsp;<span class="ident" id="4695422">itemCharConstant</span><span class="op" id="4695438">,</span>&nbsp;<span class="ident" id="4695440">itemComplex</span><span class="op" id="4695451">,</span>&nbsp;<span class="ident" id="4695453">itemNumber</span><span class="op" id="4695463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695467">number</span><span class="op" id="4695473">,</span>&nbsp;<span class="ident" id="4695475">err</span>&nbsp;<span class="op" id="4695479">:=</span>&nbsp;<span class="ident" id="4695482">t</span><span class="op" id="4695483">.</span><span class="ident" id="4695484">newNumber</span><span class="op" id="4695493">(</span><span class="ident" id="4695494">token</span><span class="op" id="4695499">.</span><span class="ident" id="4695500">pos</span><span class="op" id="4695503">,</span>&nbsp;<span class="ident" id="4695505">token</span><span class="op" id="4695510">.</span><span class="ident" id="4695511">val</span><span class="op" id="4695514">,</span>&nbsp;<span class="ident" id="4695516">token</span><span class="op" id="4695521">.</span><span class="ident" id="4695522">typ</span><span class="op" id="4695525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695529">if</span>&nbsp;<span class="ident" id="4695532">err</span>&nbsp;<span class="op" id="4695536">!=</span>&nbsp;<span class="ident" id="4695539">nil</span>&nbsp;<span class="op" id="4695543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695548">t</span><span class="op" id="4695549">.</span><span class="builtintype" id="4695550">error</span><span class="op" id="4695555">(</span><span class="ident" id="4695556">err</span><span class="op" id="4695559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695563">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695567">return</span>&nbsp;<span class="ident" id="4695574">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695582">case</span>&nbsp;<span class="ident" id="4695587">itemLeftParen</span><span class="op" id="4695600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695604">pipe</span>&nbsp;<span class="op" id="4695609">:=</span>&nbsp;<span class="ident" id="4695612">t</span><span class="op" id="4695613">.</span><span class="ident" id="4695614">pipeline</span><span class="op" id="4695622">(</span><span class="string" id="4695623">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="4695647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695651">if</span>&nbsp;<span class="ident" id="4695654">token</span>&nbsp;<span class="op" id="4695660">:=</span>&nbsp;<span class="ident" id="4695663">t</span><span class="op" id="4695664">.</span><span class="ident" id="4695665">next</span><span class="op" id="4695669">(</span><span class="op" id="4695670">)</span><span class="op" id="4695671">;</span>&nbsp;<span class="ident" id="4695673">token</span><span class="op" id="4695678">.</span><span class="ident" id="4695679">typ</span>&nbsp;<span class="op" id="4695683">!=</span>&nbsp;<span class="ident" id="4695686">itemRightParen</span>&nbsp;<span class="op" id="4695701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695706">t</span><span class="op" id="4695707">.</span><span class="ident" id="4695708">errorf</span><span class="op" id="4695714">(</span><span class="string" id="4695715">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="4695752">,</span>&nbsp;<span class="ident" id="4695754">token</span><span class="op" id="4695759">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695767">return</span>&nbsp;<span class="ident" id="4695774">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695780">case</span>&nbsp;<span class="ident" id="4695785">itemString</span><span class="op" id="4695795">,</span>&nbsp;<span class="ident" id="4695797">itemRawString</span><span class="op" id="4695810">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695814">s</span><span class="op" id="4695815">,</span>&nbsp;<span class="ident" id="4695817">err</span>&nbsp;<span class="op" id="4695821">:=</span>&nbsp;<span class="ident" id="4695824">strconv</span><span class="op" id="4695831">.</span><span class="ident" id="4695832">Unquote</span><span class="op" id="4695839">(</span><span class="ident" id="4695840">token</span><span class="op" id="4695845">.</span><span class="ident" id="4695846">val</span><span class="op" id="4695849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695853">if</span>&nbsp;<span class="ident" id="4695856">err</span>&nbsp;<span class="op" id="4695860">!=</span>&nbsp;<span class="ident" id="4695863">nil</span>&nbsp;<span class="op" id="4695867">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695872">t</span><span class="op" id="4695873">.</span><span class="builtintype" id="4695874">error</span><span class="op" id="4695879">(</span><span class="ident" id="4695880">err</span><span class="op" id="4695883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695891">return</span>&nbsp;<span class="ident" id="4695898">t</span><span class="op" id="4695899">.</span><span class="ident" id="4695900">newString</span><span class="op" id="4695909">(</span><span class="ident" id="4695910">token</span><span class="op" id="4695915">.</span><span class="ident" id="4695916">pos</span><span class="op" id="4695919">,</span>&nbsp;<span class="ident" id="4695921">token</span><span class="op" id="4695926">.</span><span class="ident" id="4695927">val</span><span class="op" id="4695930">,</span>&nbsp;<span class="ident" id="4695932">s</span><span class="op" id="4695933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4695936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4695939">t</span><span class="op" id="4695940">.</span><span class="ident" id="4695941">backup</span><span class="op" id="4695947">(</span><span class="op" id="4695948">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4695951">return</span>&nbsp;<span class="ident" id="4695958">nil</span><br>
<span class="lineno"></span><span class="op" id="4695962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4695965">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="4696034">func</span>&nbsp;<span class="op" id="4696039">(</span><span class="ident" id="4696040">t</span>&nbsp;<span class="op" id="4696042">*</span><span class="ident" id="4696043">Tree</span><span class="op" id="4696047">)</span>&nbsp;<span class="ident" id="4696049">hasFunction</span><span class="op" id="4696060">(</span><span class="ident" id="4696061">name</span>&nbsp;<span class="builtintype" id="4696066">string</span><span class="op" id="4696072">)</span>&nbsp;<span class="builtintype" id="4696074">bool</span>&nbsp;<span class="op" id="4696079">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696082">for</span>&nbsp;<span class="ident" id="4696086">_</span><span class="op" id="4696087">,</span>&nbsp;<span class="ident" id="4696089">funcMap</span>&nbsp;<span class="op" id="4696097">:=</span>&nbsp;<span class="keyword" id="4696100">range</span>&nbsp;<span class="ident" id="4696106">t</span><span class="op" id="4696107">.</span><span class="ident" id="4696108">funcs</span>&nbsp;<span class="op" id="4696114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696118">if</span>&nbsp;<span class="ident" id="4696121">funcMap</span>&nbsp;<span class="op" id="4696129">==</span>&nbsp;<span class="ident" id="4696132">nil</span>&nbsp;<span class="op" id="4696136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696141">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696156">if</span>&nbsp;<span class="ident" id="4696159">funcMap</span><span class="op" id="4696166">[</span><span class="ident" id="4696167">name</span><span class="op" id="4696171">]</span>&nbsp;<span class="op" id="4696173">!=</span>&nbsp;<span class="ident" id="4696176">nil</span>&nbsp;<span class="op" id="4696180">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696185">return</span>&nbsp;<span class="builtintype" id="4696192">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696205">return</span>&nbsp;<span class="builtintype" id="4696212">false</span><br>
<span class="lineno"></span><span class="op" id="4696218">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="4696221">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="4696280">func</span>&nbsp;<span class="op" id="4696285">(</span><span class="ident" id="4696286">t</span>&nbsp;<span class="op" id="4696288">*</span><span class="ident" id="4696289">Tree</span><span class="op" id="4696293">)</span>&nbsp;<span class="ident" id="4696295">popVars</span><span class="op" id="4696302">(</span><span class="ident" id="4696303">n</span>&nbsp;<span class="builtintype" id="4696305">int</span><span class="op" id="4696308">)</span>&nbsp;<span class="op" id="4696310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696313">t</span><span class="op" id="4696314">.</span><span class="ident" id="4696315">vars</span>&nbsp;<span class="op" id="4696320">=</span>&nbsp;<span class="ident" id="4696322">t</span><span class="op" id="4696323">.</span><span class="ident" id="4696324">vars</span><span class="op" id="4696328">[</span><span class="op" id="4696329">:</span><span class="ident" id="4696330">n</span><span class="op" id="4696331">]</span><br>
<span class="lineno"></span><span class="op" id="4696333">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4696336">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4696404">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4696432">func</span>&nbsp;<span class="op" id="4696437">(</span><span class="ident" id="4696438">t</span>&nbsp;<span class="op" id="4696440">*</span><span class="ident" id="4696441">Tree</span><span class="op" id="4696445">)</span>&nbsp;<span class="ident" id="4696447">useVar</span><span class="op" id="4696453">(</span><span class="ident" id="4696454">pos</span>&nbsp;<span class="ident" id="4696458">Pos</span><span class="op" id="4696461">,</span>&nbsp;<span class="ident" id="4696463">name</span>&nbsp;<span class="builtintype" id="4696468">string</span><span class="op" id="4696474">)</span>&nbsp;<span class="ident" id="4696476">Node</span>&nbsp;<span class="op" id="4696481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696484">v</span>&nbsp;<span class="op" id="4696486">:=</span>&nbsp;<span class="ident" id="4696489">t</span><span class="op" id="4696490">.</span><span class="ident" id="4696491">newVariable</span><span class="op" id="4696502">(</span><span class="ident" id="4696503">pos</span><span class="op" id="4696506">,</span>&nbsp;<span class="ident" id="4696508">name</span><span class="op" id="4696512">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696515">for</span>&nbsp;<span class="ident" id="4696519">_</span><span class="op" id="4696520">,</span>&nbsp;<span class="ident" id="4696522">varName</span>&nbsp;<span class="op" id="4696530">:=</span>&nbsp;<span class="keyword" id="4696533">range</span>&nbsp;<span class="ident" id="4696539">t</span><span class="op" id="4696540">.</span><span class="ident" id="4696541">vars</span>&nbsp;<span class="op" id="4696546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696550">if</span>&nbsp;<span class="ident" id="4696553">varName</span>&nbsp;<span class="op" id="4696561">==</span>&nbsp;<span class="ident" id="4696564">v</span><span class="op" id="4696565">.</span><span class="ident" id="4696566">Ident</span><span class="op" id="4696571">[</span><span class="num" id="4696572">0</span><span class="op" id="4696573">]</span>&nbsp;<span class="op" id="4696575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696580">return</span>&nbsp;<span class="ident" id="4696587">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4696594">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4696597">t</span><span class="op" id="4696598">.</span><span class="ident" id="4696599">errorf</span><span class="op" id="4696605">(</span><span class="string" id="4696606">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="4696629">,</span>&nbsp;<span class="ident" id="4696631">v</span><span class="op" id="4696632">.</span><span class="ident" id="4696633">Ident</span><span class="op" id="4696638">[</span><span class="num" id="4696639">0</span><span class="op" id="4696640">]</span><span class="op" id="4696641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4696644">return</span>&nbsp;<span class="ident" id="4696651">nil</span><br>
<span class="lineno"></span><span class="op" id="4696655">}</span>
</div>
</body>
</html>
