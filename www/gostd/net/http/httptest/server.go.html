<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5639695">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5639750">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5639804">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5639855">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5639884">package</span>&nbsp;<span class="ident" id="5639892">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5639902">import</span>&nbsp;<span class="op" id="5639909">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639912">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639926">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639934">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639941">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639948">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639960">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5639966">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5639973">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5639976">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5640047">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5640110">type</span>&nbsp;<span class="ident" id="5640115">Server</span>&nbsp;<span class="keyword" id="5640122">struct</span>&nbsp;<span class="op" id="5640129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640132">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5640141">string</span>&nbsp;<span class="comment" id="5640148">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640211">Listener</span>&nbsp;<span class="ident" id="5640220">net</span><span class="op" id="5640223">.</span><span class="ident" id="5640224">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640235">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640306">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640378">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640441">TLS</span>&nbsp;<span class="op" id="5640445">*</span><span class="ident" id="5640446">tls</span><span class="op" id="5640449">.</span><span class="ident" id="5640450">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640459">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640522">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640552">Config</span>&nbsp;<span class="op" id="5640559">*</span><span class="ident" id="5640560">http</span><span class="op" id="5640564">.</span><span class="ident" id="5640565">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640574">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640644">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640694">wg</span>&nbsp;<span class="ident" id="5640697">sync</span><span class="op" id="5640701">.</span><span class="ident" id="5640702">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5640712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5640715">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5640780">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5640793">type</span>&nbsp;<span class="ident" id="5640798">historyListener</span>&nbsp;<span class="keyword" id="5640814">struct</span>&nbsp;<span class="op" id="5640821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640824">net</span><span class="op" id="5640827">.</span><span class="ident" id="5640828">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640838">sync</span><span class="op" id="5640842">.</span><span class="ident" id="5640843">Mutex</span>&nbsp;<span class="comment" id="5640849">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640870">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640881">[</span><span class="op" id="5640882">]</span><span class="ident" id="5640883">net</span><span class="op" id="5640886">.</span><span class="ident" id="5640887">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5640892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5640895">func</span>&nbsp;<span class="op" id="5640900">(</span><span class="ident" id="5640901">hs</span>&nbsp;<span class="op" id="5640904">*</span><span class="ident" id="5640905">historyListener</span><span class="op" id="5640920">)</span>&nbsp;<span class="ident" id="5640922">Accept</span><span class="op" id="5640928">(</span><span class="op" id="5640929">)</span>&nbsp;<span class="op" id="5640931">(</span><span class="ident" id="5640932">c</span>&nbsp;<span class="ident" id="5640934">net</span><span class="op" id="5640937">.</span><span class="ident" id="5640938">Conn</span><span class="op" id="5640942">,</span>&nbsp;<span class="ident" id="5640944">err</span>&nbsp;<span class="builtintype" id="5640948">error</span><span class="op" id="5640953">)</span>&nbsp;<span class="op" id="5640955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640958">c</span><span class="op" id="5640959">,</span>&nbsp;<span class="ident" id="5640961">err</span>&nbsp;<span class="op" id="5640965">=</span>&nbsp;<span class="ident" id="5640967">hs</span><span class="op" id="5640969">.</span><span class="ident" id="5640970">Listener</span><span class="op" id="5640978">.</span><span class="ident" id="5640979">Accept</span><span class="op" id="5640985">(</span><span class="op" id="5640986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640989">if</span>&nbsp;<span class="ident" id="5640992">err</span>&nbsp;<span class="op" id="5640996">==</span>&nbsp;<span class="ident" id="5640999">nil</span>&nbsp;<span class="op" id="5641003">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641007">hs</span><span class="op" id="5641009">.</span><span class="ident" id="5641010">Lock</span><span class="op" id="5641014">(</span><span class="op" id="5641015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641019">hs</span><span class="op" id="5641021">.</span><span class="ident" id="5641022">history</span>&nbsp;<span class="op" id="5641030">=</span>&nbsp;<span class="builtinfunc" id="5641032">append</span><span class="op" id="5641038">(</span><span class="ident" id="5641039">hs</span><span class="op" id="5641041">.</span><span class="ident" id="5641042">history</span><span class="op" id="5641049">,</span>&nbsp;<span class="ident" id="5641051">c</span><span class="op" id="5641052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641056">hs</span><span class="op" id="5641058">.</span><span class="ident" id="5641059">Unlock</span><span class="op" id="5641065">(</span><span class="op" id="5641066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641072">return</span><br>
<span class="lineno">55</span><span class="op" id="5641079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5641082">func</span>&nbsp;<span class="ident" id="5641087">newLocalListener</span><span class="op" id="5641103">(</span><span class="op" id="5641104">)</span>&nbsp;<span class="ident" id="5641106">net</span><span class="op" id="5641109">.</span><span class="ident" id="5641110">Listener</span>&nbsp;<span class="op" id="5641119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641122">if</span>&nbsp;<span class="op" id="5641125">*</span><span class="ident" id="5641126">serve</span>&nbsp;<span class="op" id="5641132">!=</span>&nbsp;<span class="string" id="5641135">&#34;&#34;</span>&nbsp;<span class="op" id="5641138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641142">l</span><span class="op" id="5641143">,</span>&nbsp;<span class="ident" id="5641145">err</span>&nbsp;<span class="op" id="5641149">:=</span>&nbsp;<span class="ident" id="5641152">net</span><span class="op" id="5641155">.</span><span class="ident" id="5641156">Listen</span><span class="op" id="5641162">(</span><span class="string" id="5641163">&#34;tcp&#34;</span><span class="op" id="5641168">,</span>&nbsp;<span class="op" id="5641170">*</span><span class="ident" id="5641171">serve</span><span class="op" id="5641176">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641180">if</span>&nbsp;<span class="ident" id="5641183">err</span>&nbsp;<span class="op" id="5641187">!=</span>&nbsp;<span class="ident" id="5641190">nil</span>&nbsp;<span class="op" id="5641194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5641199">panic</span><span class="op" id="5641204">(</span><span class="ident" id="5641205">fmt</span><span class="op" id="5641208">.</span><span class="ident" id="5641209">Sprintf</span><span class="op" id="5641216">(</span><span class="string" id="5641217">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5641255">,</span>&nbsp;<span class="op" id="5641257">*</span><span class="ident" id="5641258">serve</span><span class="op" id="5641263">,</span>&nbsp;<span class="ident" id="5641265">err</span><span class="op" id="5641268">)</span><span class="op" id="5641269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641277">return</span>&nbsp;<span class="ident" id="5641284">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641287">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641290">l</span><span class="op" id="5641291">,</span>&nbsp;<span class="ident" id="5641293">err</span>&nbsp;<span class="op" id="5641297">:=</span>&nbsp;<span class="ident" id="5641300">net</span><span class="op" id="5641303">.</span><span class="ident" id="5641304">Listen</span><span class="op" id="5641310">(</span><span class="string" id="5641311">&#34;tcp&#34;</span><span class="op" id="5641316">,</span>&nbsp;<span class="string" id="5641318">&#34;127.0.0.1:0&#34;</span><span class="op" id="5641331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641334">if</span>&nbsp;<span class="ident" id="5641337">err</span>&nbsp;<span class="op" id="5641341">!=</span>&nbsp;<span class="ident" id="5641344">nil</span>&nbsp;<span class="op" id="5641348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641352">if</span>&nbsp;<span class="ident" id="5641355">l</span><span class="op" id="5641356">,</span>&nbsp;<span class="ident" id="5641358">err</span>&nbsp;<span class="op" id="5641362">=</span>&nbsp;<span class="ident" id="5641364">net</span><span class="op" id="5641367">.</span><span class="ident" id="5641368">Listen</span><span class="op" id="5641374">(</span><span class="string" id="5641375">&#34;tcp6&#34;</span><span class="op" id="5641381">,</span>&nbsp;<span class="string" id="5641383">&#34;[::1]:0&#34;</span><span class="op" id="5641392">)</span><span class="op" id="5641393">;</span>&nbsp;<span class="ident" id="5641395">err</span>&nbsp;<span class="op" id="5641399">!=</span>&nbsp;<span class="ident" id="5641402">nil</span>&nbsp;<span class="op" id="5641406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5641411">panic</span><span class="op" id="5641416">(</span><span class="ident" id="5641417">fmt</span><span class="op" id="5641420">.</span><span class="ident" id="5641421">Sprintf</span><span class="op" id="5641428">(</span><span class="string" id="5641429">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5641471">,</span>&nbsp;<span class="ident" id="5641473">err</span><span class="op" id="5641476">)</span><span class="op" id="5641477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641481">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641487">return</span>&nbsp;<span class="ident" id="5641494">l</span><br>
<span class="lineno"></span><span class="op" id="5641496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5641499">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5641554">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5641580">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5641638">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5641706">var</span>&nbsp;<span class="ident" id="5641710">serve</span>&nbsp;<span class="op" id="5641716">=</span>&nbsp;<span class="ident" id="5641718">flag</span><span class="op" id="5641722">.</span><span class="ident" id="5641723">String</span><span class="op" id="5641729">(</span><span class="string" id="5641730">&#34;httptest.serve&#34;</span><span class="op" id="5641746">,</span>&nbsp;<span class="string" id="5641748">&#34;&#34;</span><span class="op" id="5641750">,</span>&nbsp;<span class="string" id="5641752">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5641820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5641823">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5641869">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5641933">func</span>&nbsp;<span class="ident" id="5641938">NewServer</span><span class="op" id="5641947">(</span><span class="ident" id="5641948">handler</span>&nbsp;<span class="ident" id="5641956">http</span><span class="op" id="5641960">.</span><span class="ident" id="5641961">Handler</span><span class="op" id="5641968">)</span>&nbsp;<span class="op" id="5641970">*</span><span class="ident" id="5641971">Server</span>&nbsp;<span class="op" id="5641978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641981">ts</span>&nbsp;<span class="op" id="5641984">:=</span>&nbsp;<span class="ident" id="5641987">NewUnstartedServer</span><span class="op" id="5642005">(</span><span class="ident" id="5642006">handler</span><span class="op" id="5642013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642016">ts</span><span class="op" id="5642018">.</span><span class="ident" id="5642019">Start</span><span class="op" id="5642024">(</span><span class="op" id="5642025">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642028">return</span>&nbsp;<span class="ident" id="5642035">ts</span><br>
<span class="lineno"></span><span class="op" id="5642038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5642041">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5642106">//</span><br>
<span class="lineno">90</span><span class="comment" id="5642109">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5642178">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5642191">//</span><br>
<span class="lineno"></span><span class="comment" id="5642194">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5642258">func</span>&nbsp;<span class="ident" id="5642263">NewUnstartedServer</span><span class="op" id="5642281">(</span><span class="ident" id="5642282">handler</span>&nbsp;<span class="ident" id="5642290">http</span><span class="op" id="5642294">.</span><span class="ident" id="5642295">Handler</span><span class="op" id="5642302">)</span>&nbsp;<span class="op" id="5642304">*</span><span class="ident" id="5642305">Server</span>&nbsp;<span class="op" id="5642312">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642315">return</span>&nbsp;<span class="op" id="5642322">&amp;</span><span class="ident" id="5642323">Server</span><span class="op" id="5642329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642333">Listener</span><span class="op" id="5642341">:</span>&nbsp;<span class="ident" id="5642343">newLocalListener</span><span class="op" id="5642359">(</span><span class="op" id="5642360">)</span><span class="op" id="5642361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642365">Config</span><span class="op" id="5642371">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5642375">&amp;</span><span class="ident" id="5642376">http</span><span class="op" id="5642380">.</span><span class="ident" id="5642381">Server</span><span class="op" id="5642387">{</span><span class="ident" id="5642388">Handler</span><span class="op" id="5642395">:</span>&nbsp;<span class="ident" id="5642397">handler</span><span class="op" id="5642404">}</span><span class="op" id="5642405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642408">}</span><br>
<span class="lineno"></span><span class="op" id="5642410">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5642413">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5642463">func</span>&nbsp;<span class="op" id="5642468">(</span><span class="ident" id="5642469">s</span>&nbsp;<span class="op" id="5642471">*</span><span class="ident" id="5642472">Server</span><span class="op" id="5642478">)</span>&nbsp;<span class="ident" id="5642480">Start</span><span class="op" id="5642485">(</span><span class="op" id="5642486">)</span>&nbsp;<span class="op" id="5642488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642491">if</span>&nbsp;<span class="ident" id="5642494">s</span><span class="op" id="5642495">.</span><span class="ident" id="5642496">URL</span>&nbsp;<span class="op" id="5642500">!=</span>&nbsp;<span class="string" id="5642503">&#34;&#34;</span>&nbsp;<span class="op" id="5642506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5642510">panic</span><span class="op" id="5642515">(</span><span class="string" id="5642516">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5642540">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642546">s</span><span class="op" id="5642547">.</span><span class="ident" id="5642548">Listener</span>&nbsp;<span class="op" id="5642557">=</span>&nbsp;<span class="op" id="5642559">&amp;</span><span class="ident" id="5642560">historyListener</span><span class="op" id="5642575">{</span><span class="ident" id="5642576">Listener</span><span class="op" id="5642584">:</span>&nbsp;<span class="ident" id="5642586">s</span><span class="op" id="5642587">.</span><span class="ident" id="5642588">Listener</span><span class="op" id="5642596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642599">s</span><span class="op" id="5642600">.</span><span class="ident" id="5642601">URL</span>&nbsp;<span class="op" id="5642605">=</span>&nbsp;<span class="string" id="5642607">&#34;http://&#34;</span>&nbsp;<span class="op" id="5642617">+</span>&nbsp;<span class="ident" id="5642619">s</span><span class="op" id="5642620">.</span><span class="ident" id="5642621">Listener</span><span class="op" id="5642629">.</span><span class="ident" id="5642630">Addr</span><span class="op" id="5642634">(</span><span class="op" id="5642635">)</span><span class="op" id="5642636">.</span><span class="ident" id="5642637">String</span><span class="op" id="5642643">(</span><span class="op" id="5642644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642647">s</span><span class="op" id="5642648">.</span><span class="ident" id="5642649">wrapHandler</span><span class="op" id="5642660">(</span><span class="op" id="5642661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642664">go</span>&nbsp;<span class="ident" id="5642667">s</span><span class="op" id="5642668">.</span><span class="ident" id="5642669">Config</span><span class="op" id="5642675">.</span><span class="ident" id="5642676">Serve</span><span class="op" id="5642681">(</span><span class="ident" id="5642682">s</span><span class="op" id="5642683">.</span><span class="ident" id="5642684">Listener</span><span class="op" id="5642692">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642695">if</span>&nbsp;<span class="op" id="5642698">*</span><span class="ident" id="5642699">serve</span>&nbsp;<span class="op" id="5642705">!=</span>&nbsp;<span class="string" id="5642708">&#34;&#34;</span>&nbsp;<span class="op" id="5642711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642715">fmt</span><span class="op" id="5642718">.</span><span class="ident" id="5642719">Fprintln</span><span class="op" id="5642727">(</span><span class="ident" id="5642728">os</span><span class="op" id="5642730">.</span><span class="ident" id="5642731">Stderr</span><span class="op" id="5642737">,</span>&nbsp;<span class="string" id="5642739">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5642761">,</span>&nbsp;<span class="ident" id="5642763">s</span><span class="op" id="5642764">.</span><span class="ident" id="5642765">URL</span><span class="op" id="5642768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642772">select</span>&nbsp;<span class="op" id="5642779">{</span><span class="op" id="5642780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642783">}</span><br>
<span class="lineno"></span><span class="op" id="5642785">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5642788">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5642848">func</span>&nbsp;<span class="op" id="5642853">(</span><span class="ident" id="5642854">s</span>&nbsp;<span class="op" id="5642856">*</span><span class="ident" id="5642857">Server</span><span class="op" id="5642863">)</span>&nbsp;<span class="ident" id="5642865">StartTLS</span><span class="op" id="5642873">(</span><span class="op" id="5642874">)</span>&nbsp;<span class="op" id="5642876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642879">if</span>&nbsp;<span class="ident" id="5642882">s</span><span class="op" id="5642883">.</span><span class="ident" id="5642884">URL</span>&nbsp;<span class="op" id="5642888">!=</span>&nbsp;<span class="string" id="5642891">&#34;&#34;</span>&nbsp;<span class="op" id="5642894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5642898">panic</span><span class="op" id="5642903">(</span><span class="string" id="5642904">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5642928">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642934">cert</span><span class="op" id="5642938">,</span>&nbsp;<span class="ident" id="5642940">err</span>&nbsp;<span class="op" id="5642944">:=</span>&nbsp;<span class="ident" id="5642947">tls</span><span class="op" id="5642950">.</span><span class="ident" id="5642951">X509KeyPair</span><span class="op" id="5642962">(</span><span class="ident" id="5642963">localhostCert</span><span class="op" id="5642976">,</span>&nbsp;<span class="ident" id="5642978">localhostKey</span><span class="op" id="5642990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642993">if</span>&nbsp;<span class="ident" id="5642996">err</span>&nbsp;<span class="op" id="5643000">!=</span>&nbsp;<span class="ident" id="5643003">nil</span>&nbsp;<span class="op" id="5643007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5643011">panic</span><span class="op" id="5643016">(</span><span class="ident" id="5643017">fmt</span><span class="op" id="5643020">.</span><span class="ident" id="5643021">Sprintf</span><span class="op" id="5643028">(</span><span class="string" id="5643029">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5643057">,</span>&nbsp;<span class="ident" id="5643059">err</span><span class="op" id="5643062">)</span><span class="op" id="5643063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643066">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643070">existingConfig</span>&nbsp;<span class="op" id="5643085">:=</span>&nbsp;<span class="ident" id="5643088">s</span><span class="op" id="5643089">.</span><span class="ident" id="5643090">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643095">s</span><span class="op" id="5643096">.</span><span class="ident" id="5643097">TLS</span>&nbsp;<span class="op" id="5643101">=</span>&nbsp;<span class="builtinfunc" id="5643103">new</span><span class="op" id="5643106">(</span><span class="ident" id="5643107">tls</span><span class="op" id="5643110">.</span><span class="ident" id="5643111">Config</span><span class="op" id="5643117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643120">if</span>&nbsp;<span class="ident" id="5643123">existingConfig</span>&nbsp;<span class="op" id="5643138">!=</span>&nbsp;<span class="ident" id="5643141">nil</span>&nbsp;<span class="op" id="5643145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643149">*</span><span class="ident" id="5643150">s</span><span class="op" id="5643151">.</span><span class="ident" id="5643152">TLS</span>&nbsp;<span class="op" id="5643156">=</span>&nbsp;<span class="op" id="5643158">*</span><span class="ident" id="5643159">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643178">if</span>&nbsp;<span class="ident" id="5643181">s</span><span class="op" id="5643182">.</span><span class="ident" id="5643183">TLS</span><span class="op" id="5643186">.</span><span class="ident" id="5643187">NextProtos</span>&nbsp;<span class="op" id="5643198">==</span>&nbsp;<span class="ident" id="5643201">nil</span>&nbsp;<span class="op" id="5643205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643209">s</span><span class="op" id="5643210">.</span><span class="ident" id="5643211">TLS</span><span class="op" id="5643214">.</span><span class="ident" id="5643215">NextProtos</span>&nbsp;<span class="op" id="5643226">=</span>&nbsp;<span class="op" id="5643228">[</span><span class="op" id="5643229">]</span><span class="builtintype" id="5643230">string</span><span class="op" id="5643236">{</span><span class="string" id="5643237">&#34;http/1.1&#34;</span><span class="op" id="5643247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643253">if</span>&nbsp;<span class="builtinfunc" id="5643256">len</span><span class="op" id="5643259">(</span><span class="ident" id="5643260">s</span><span class="op" id="5643261">.</span><span class="ident" id="5643262">TLS</span><span class="op" id="5643265">.</span><span class="ident" id="5643266">Certificates</span><span class="op" id="5643278">)</span>&nbsp;<span class="op" id="5643280">==</span>&nbsp;<span class="num" id="5643283">0</span>&nbsp;<span class="op" id="5643285">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643289">s</span><span class="op" id="5643290">.</span><span class="ident" id="5643291">TLS</span><span class="op" id="5643294">.</span><span class="ident" id="5643295">Certificates</span>&nbsp;<span class="op" id="5643308">=</span>&nbsp;<span class="op" id="5643310">[</span><span class="op" id="5643311">]</span><span class="ident" id="5643312">tls</span><span class="op" id="5643315">.</span><span class="ident" id="5643316">Certificate</span><span class="op" id="5643327">{</span><span class="ident" id="5643328">cert</span><span class="op" id="5643332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643338">tlsListener</span>&nbsp;<span class="op" id="5643350">:=</span>&nbsp;<span class="ident" id="5643353">tls</span><span class="op" id="5643356">.</span><span class="ident" id="5643357">NewListener</span><span class="op" id="5643368">(</span><span class="ident" id="5643369">s</span><span class="op" id="5643370">.</span><span class="ident" id="5643371">Listener</span><span class="op" id="5643379">,</span>&nbsp;<span class="ident" id="5643381">s</span><span class="op" id="5643382">.</span><span class="ident" id="5643383">TLS</span><span class="op" id="5643386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643390">s</span><span class="op" id="5643391">.</span><span class="ident" id="5643392">Listener</span>&nbsp;<span class="op" id="5643401">=</span>&nbsp;<span class="op" id="5643403">&amp;</span><span class="ident" id="5643404">historyListener</span><span class="op" id="5643419">{</span><span class="ident" id="5643420">Listener</span><span class="op" id="5643428">:</span>&nbsp;<span class="ident" id="5643430">tlsListener</span><span class="op" id="5643441">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643444">s</span><span class="op" id="5643445">.</span><span class="ident" id="5643446">URL</span>&nbsp;<span class="op" id="5643450">=</span>&nbsp;<span class="string" id="5643452">&#34;https://&#34;</span>&nbsp;<span class="op" id="5643463">+</span>&nbsp;<span class="ident" id="5643465">s</span><span class="op" id="5643466">.</span><span class="ident" id="5643467">Listener</span><span class="op" id="5643475">.</span><span class="ident" id="5643476">Addr</span><span class="op" id="5643480">(</span><span class="op" id="5643481">)</span><span class="op" id="5643482">.</span><span class="ident" id="5643483">String</span><span class="op" id="5643489">(</span><span class="op" id="5643490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643493">s</span><span class="op" id="5643494">.</span><span class="ident" id="5643495">wrapHandler</span><span class="op" id="5643506">(</span><span class="op" id="5643507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643510">go</span>&nbsp;<span class="ident" id="5643513">s</span><span class="op" id="5643514">.</span><span class="ident" id="5643515">Config</span><span class="op" id="5643521">.</span><span class="ident" id="5643522">Serve</span><span class="op" id="5643527">(</span><span class="ident" id="5643528">s</span><span class="op" id="5643529">.</span><span class="ident" id="5643530">Listener</span><span class="op" id="5643538">)</span><br>
<span class="lineno"></span><span class="op" id="5643540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5643543">func</span>&nbsp;<span class="op" id="5643548">(</span><span class="ident" id="5643549">s</span>&nbsp;<span class="op" id="5643551">*</span><span class="ident" id="5643552">Server</span><span class="op" id="5643558">)</span>&nbsp;<span class="ident" id="5643560">wrapHandler</span><span class="op" id="5643571">(</span><span class="op" id="5643572">)</span>&nbsp;<span class="op" id="5643574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643577">h</span>&nbsp;<span class="op" id="5643579">:=</span>&nbsp;<span class="ident" id="5643582">s</span><span class="op" id="5643583">.</span><span class="ident" id="5643584">Config</span><span class="op" id="5643590">.</span><span class="ident" id="5643591">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643600">if</span>&nbsp;<span class="ident" id="5643603">h</span>&nbsp;<span class="op" id="5643605">==</span>&nbsp;<span class="ident" id="5643608">nil</span>&nbsp;<span class="op" id="5643612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643616">h</span>&nbsp;<span class="op" id="5643618">=</span>&nbsp;<span class="ident" id="5643620">http</span><span class="op" id="5643624">.</span><span class="ident" id="5643625">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643642">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643645">s</span><span class="op" id="5643646">.</span><span class="ident" id="5643647">Config</span><span class="op" id="5643653">.</span><span class="ident" id="5643654">Handler</span>&nbsp;<span class="op" id="5643662">=</span>&nbsp;<span class="op" id="5643664">&amp;</span><span class="ident" id="5643665">waitGroupHandler</span><span class="op" id="5643681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643685">s</span><span class="op" id="5643686">:</span>&nbsp;<span class="ident" id="5643688">s</span><span class="op" id="5643689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643693">h</span><span class="op" id="5643694">:</span>&nbsp;<span class="ident" id="5643696">h</span><span class="op" id="5643697">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5643700">}</span><br>
<span class="lineno"></span><span class="op" id="5643702">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5643705">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5643764">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5643828">func</span>&nbsp;<span class="ident" id="5643833">NewTLSServer</span><span class="op" id="5643845">(</span><span class="ident" id="5643846">handler</span>&nbsp;<span class="ident" id="5643854">http</span><span class="op" id="5643858">.</span><span class="ident" id="5643859">Handler</span><span class="op" id="5643866">)</span>&nbsp;<span class="op" id="5643868">*</span><span class="ident" id="5643869">Server</span>&nbsp;<span class="op" id="5643876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643879">ts</span>&nbsp;<span class="op" id="5643882">:=</span>&nbsp;<span class="ident" id="5643885">NewUnstartedServer</span><span class="op" id="5643903">(</span><span class="ident" id="5643904">handler</span><span class="op" id="5643911">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643914">ts</span><span class="op" id="5643916">.</span><span class="ident" id="5643917">StartTLS</span><span class="op" id="5643925">(</span><span class="op" id="5643926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5643929">return</span>&nbsp;<span class="ident" id="5643936">ts</span><br>
<span class="lineno"></span><span class="op" id="5643939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5643942">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5644006">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5644049">func</span>&nbsp;<span class="op" id="5644054">(</span><span class="ident" id="5644055">s</span>&nbsp;<span class="op" id="5644057">*</span><span class="ident" id="5644058">Server</span><span class="op" id="5644064">)</span>&nbsp;<span class="ident" id="5644066">Close</span><span class="op" id="5644071">(</span><span class="op" id="5644072">)</span>&nbsp;<span class="op" id="5644074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644077">s</span><span class="op" id="5644078">.</span><span class="ident" id="5644079">Listener</span><span class="op" id="5644087">.</span><span class="ident" id="5644088">Close</span><span class="op" id="5644093">(</span><span class="op" id="5644094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644097">s</span><span class="op" id="5644098">.</span><span class="ident" id="5644099">wg</span><span class="op" id="5644101">.</span><span class="ident" id="5644102">Wait</span><span class="op" id="5644106">(</span><span class="op" id="5644107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644110">s</span><span class="op" id="5644111">.</span><span class="ident" id="5644112">CloseClientConnections</span><span class="op" id="5644134">(</span><span class="op" id="5644135">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5644138">if</span>&nbsp;<span class="ident" id="5644141">t</span><span class="op" id="5644142">,</span>&nbsp;<span class="ident" id="5644144">ok</span>&nbsp;<span class="op" id="5644147">:=</span>&nbsp;<span class="ident" id="5644150">http</span><span class="op" id="5644154">.</span><span class="ident" id="5644155">DefaultTransport</span><span class="op" id="5644171">.</span><span class="op" id="5644172">(</span><span class="op" id="5644173">*</span><span class="ident" id="5644174">http</span><span class="op" id="5644178">.</span><span class="ident" id="5644179">Transport</span><span class="op" id="5644188">)</span><span class="op" id="5644189">;</span>&nbsp;<span class="ident" id="5644191">ok</span>&nbsp;<span class="op" id="5644194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644198">t</span><span class="op" id="5644199">.</span><span class="ident" id="5644200">CloseIdleConnections</span><span class="op" id="5644220">(</span><span class="op" id="5644221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5644224">}</span><br>
<span class="lineno"></span><span class="op" id="5644226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5644229">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5644298">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5644321">func</span>&nbsp;<span class="op" id="5644326">(</span><span class="ident" id="5644327">s</span>&nbsp;<span class="op" id="5644329">*</span><span class="ident" id="5644330">Server</span><span class="op" id="5644336">)</span>&nbsp;<span class="ident" id="5644338">CloseClientConnections</span><span class="op" id="5644360">(</span><span class="op" id="5644361">)</span>&nbsp;<span class="op" id="5644363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644366">hl</span><span class="op" id="5644368">,</span>&nbsp;<span class="ident" id="5644370">ok</span>&nbsp;<span class="op" id="5644373">:=</span>&nbsp;<span class="ident" id="5644376">s</span><span class="op" id="5644377">.</span><span class="ident" id="5644378">Listener</span><span class="op" id="5644386">.</span><span class="op" id="5644387">(</span><span class="op" id="5644388">*</span><span class="ident" id="5644389">historyListener</span><span class="op" id="5644404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5644407">if</span>&nbsp;<span class="op" id="5644410">!</span><span class="ident" id="5644411">ok</span>&nbsp;<span class="op" id="5644414">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5644418">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5644426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644429">hl</span><span class="op" id="5644431">.</span><span class="ident" id="5644432">Lock</span><span class="op" id="5644436">(</span><span class="op" id="5644437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5644440">for</span>&nbsp;<span class="ident" id="5644444">_</span><span class="op" id="5644445">,</span>&nbsp;<span class="ident" id="5644447">conn</span>&nbsp;<span class="op" id="5644452">:=</span>&nbsp;<span class="keyword" id="5644455">range</span>&nbsp;<span class="ident" id="5644461">hl</span><span class="op" id="5644463">.</span><span class="ident" id="5644464">history</span>&nbsp;<span class="op" id="5644472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644476">conn</span><span class="op" id="5644480">.</span><span class="ident" id="5644481">Close</span><span class="op" id="5644486">(</span><span class="op" id="5644487">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5644490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644493">hl</span><span class="op" id="5644495">.</span><span class="ident" id="5644496">Unlock</span><span class="op" id="5644502">(</span><span class="op" id="5644503">)</span><br>
<span class="lineno"></span><span class="op" id="5644505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5644508">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5644577">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5644644">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5644688">type</span>&nbsp;<span class="ident" id="5644693">waitGroupHandler</span>&nbsp;<span class="keyword" id="5644710">struct</span>&nbsp;<span class="op" id="5644717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644720">s</span>&nbsp;<span class="op" id="5644722">*</span><span class="ident" id="5644723">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644731">h</span>&nbsp;<span class="ident" id="5644733">http</span><span class="op" id="5644737">.</span><span class="ident" id="5644738">Handler</span>&nbsp;<span class="comment" id="5644746">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5644757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5644760">func</span>&nbsp;<span class="op" id="5644765">(</span><span class="ident" id="5644766">h</span>&nbsp;<span class="op" id="5644768">*</span><span class="ident" id="5644769">waitGroupHandler</span><span class="op" id="5644785">)</span>&nbsp;<span class="ident" id="5644787">ServeHTTP</span><span class="op" id="5644796">(</span><span class="ident" id="5644797">w</span>&nbsp;<span class="ident" id="5644799">http</span><span class="op" id="5644803">.</span><span class="ident" id="5644804">ResponseWriter</span><span class="op" id="5644818">,</span>&nbsp;<span class="ident" id="5644820">r</span>&nbsp;<span class="op" id="5644822">*</span><span class="ident" id="5644823">http</span><span class="op" id="5644827">.</span><span class="ident" id="5644828">Request</span><span class="op" id="5644835">)</span>&nbsp;<span class="op" id="5644837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644840">h</span><span class="op" id="5644841">.</span><span class="ident" id="5644842">s</span><span class="op" id="5644843">.</span><span class="ident" id="5644844">wg</span><span class="op" id="5644846">.</span><span class="ident" id="5644847">Add</span><span class="op" id="5644850">(</span><span class="num" id="5644851">1</span><span class="op" id="5644852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5644855">defer</span>&nbsp;<span class="ident" id="5644861">h</span><span class="op" id="5644862">.</span><span class="ident" id="5644863">s</span><span class="op" id="5644864">.</span><span class="ident" id="5644865">wg</span><span class="op" id="5644867">.</span><span class="ident" id="5644868">Done</span><span class="op" id="5644872">(</span><span class="op" id="5644873">)</span>&nbsp;<span class="comment" id="5644875">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5644919">h</span><span class="op" id="5644920">.</span><span class="ident" id="5644921">h</span><span class="op" id="5644922">.</span><span class="ident" id="5644923">ServeHTTP</span><span class="op" id="5644932">(</span><span class="ident" id="5644933">w</span><span class="op" id="5644934">,</span>&nbsp;<span class="ident" id="5644936">r</span><span class="op" id="5644937">)</span><br>
<span class="lineno"></span><span class="op" id="5644939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5644942">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5644998">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5645071">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5645090">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5645124">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5645260">var</span>&nbsp;<span class="ident" id="5645264">localhostCert</span>&nbsp;<span class="op" id="5645278">=</span>&nbsp;<span class="op" id="5645280">[</span><span class="op" id="5645281">]</span><span class="builtintype" id="5645282">byte</span><span class="op" id="5645286">(</span><span class="string" id="5645287">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5645858">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5645861">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5645915">var</span>&nbsp;<span class="ident" id="5645919">localhostKey</span>&nbsp;<span class="op" id="5645932">=</span>&nbsp;<span class="op" id="5645934">[</span><span class="op" id="5645935">]</span><span class="builtintype" id="5645936">byte</span><span class="op" id="5645940">(</span><span class="string" id="5645941">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5646439">)</span>
</div>
</body>
</html>
