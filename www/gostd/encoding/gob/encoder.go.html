<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4936206">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4936261">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4936315">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4936366">package</span>&nbsp;<span class="ident" id="4936374">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4936379">import</span>&nbsp;<span class="op" id="4936386">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4936389">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4936395">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4936406">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4936413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4936416">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4936491">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="4936522">type</span>&nbsp;<span class="ident" id="4936527">Encoder</span>&nbsp;<span class="keyword" id="4936535">struct</span>&nbsp;<span class="op" id="4936542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936545">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4936556">sync</span><span class="op" id="4936560">.</span><span class="ident" id="4936561">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4936580">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936618">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4936629">[</span><span class="op" id="4936630">]</span><span class="ident" id="4936631">io</span><span class="op" id="4936633">.</span><span class="ident" id="4936634">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4936653">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936680">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4936691">map</span><span class="op" id="4936694">[</span><span class="ident" id="4936695">reflect</span><span class="op" id="4936702">.</span><span class="ident" id="4936703">Type</span><span class="op" id="4936707">]</span><span class="ident" id="4936708">typeId</span>&nbsp;<span class="comment" id="4936715">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936750">countState</span>&nbsp;<span class="op" id="4936761">*</span><span class="ident" id="4936762">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4936785">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936814">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4936825">*</span><span class="ident" id="4936826">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4936849">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936901">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4936912">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4936936">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936974">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4936985">error</span><br>
<span class="lineno"></span><span class="op" id="4936991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4936994">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4937061">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4937128">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4937190">const</span>&nbsp;<span class="ident" id="4937196">maxLength</span>&nbsp;<span class="op" id="4937206">=</span>&nbsp;<span class="num" id="4937208">9</span>&nbsp;<span class="comment" id="4937210">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4937248">var</span>&nbsp;<span class="ident" id="4937252">spaceForLength</span>&nbsp;<span class="op" id="4937267">=</span>&nbsp;<span class="builtinfunc" id="4937269">make</span><span class="op" id="4937273">(</span><span class="op" id="4937274">[</span><span class="op" id="4937275">]</span><span class="builtintype" id="4937276">byte</span><span class="op" id="4937280">,</span>&nbsp;<span class="ident" id="4937282">maxLength</span><span class="op" id="4937291">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4937294">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4937367">func</span>&nbsp;<span class="ident" id="4937372">NewEncoder</span><span class="op" id="4937382">(</span><span class="ident" id="4937383">w</span>&nbsp;<span class="ident" id="4937385">io</span><span class="op" id="4937387">.</span><span class="ident" id="4937388">Writer</span><span class="op" id="4937394">)</span>&nbsp;<span class="op" id="4937396">*</span><span class="ident" id="4937397">Encoder</span>&nbsp;<span class="op" id="4937405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937408">enc</span>&nbsp;<span class="op" id="4937412">:=</span>&nbsp;<span class="builtinfunc" id="4937415">new</span><span class="op" id="4937418">(</span><span class="ident" id="4937419">Encoder</span><span class="op" id="4937426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937429">enc</span><span class="op" id="4937432">.</span><span class="ident" id="4937433">w</span>&nbsp;<span class="op" id="4937435">=</span>&nbsp;<span class="op" id="4937437">[</span><span class="op" id="4937438">]</span><span class="ident" id="4937439">io</span><span class="op" id="4937441">.</span><span class="ident" id="4937442">Writer</span><span class="op" id="4937448">{</span><span class="ident" id="4937449">w</span><span class="op" id="4937450">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937453">enc</span><span class="op" id="4937456">.</span><span class="ident" id="4937457">sent</span>&nbsp;<span class="op" id="4937462">=</span>&nbsp;<span class="builtinfunc" id="4937464">make</span><span class="op" id="4937468">(</span><span class="keyword" id="4937469">map</span><span class="op" id="4937472">[</span><span class="ident" id="4937473">reflect</span><span class="op" id="4937480">.</span><span class="ident" id="4937481">Type</span><span class="op" id="4937485">]</span><span class="ident" id="4937486">typeId</span><span class="op" id="4937492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937495">enc</span><span class="op" id="4937498">.</span><span class="ident" id="4937499">countState</span>&nbsp;<span class="op" id="4937510">=</span>&nbsp;<span class="ident" id="4937512">enc</span><span class="op" id="4937515">.</span><span class="ident" id="4937516">newEncoderState</span><span class="op" id="4937531">(</span><span class="builtinfunc" id="4937532">new</span><span class="op" id="4937535">(</span><span class="ident" id="4937536">encBuffer</span><span class="op" id="4937545">)</span><span class="op" id="4937546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937549">return</span>&nbsp;<span class="ident" id="4937556">enc</span><br>
<span class="lineno"></span><span class="op" id="4937560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4937563">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="4937625">func</span>&nbsp;<span class="op" id="4937630">(</span><span class="ident" id="4937631">enc</span>&nbsp;<span class="op" id="4937635">*</span><span class="ident" id="4937636">Encoder</span><span class="op" id="4937643">)</span>&nbsp;<span class="ident" id="4937645">writer</span><span class="op" id="4937651">(</span><span class="op" id="4937652">)</span>&nbsp;<span class="ident" id="4937654">io</span><span class="op" id="4937656">.</span><span class="ident" id="4937657">Writer</span>&nbsp;<span class="op" id="4937664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937667">return</span>&nbsp;<span class="ident" id="4937674">enc</span><span class="op" id="4937677">.</span><span class="ident" id="4937678">w</span><span class="op" id="4937679">[</span><span class="builtinfunc" id="4937680">len</span><span class="op" id="4937683">(</span><span class="ident" id="4937684">enc</span><span class="op" id="4937687">.</span><span class="ident" id="4937688">w</span><span class="op" id="4937689">)</span><span class="op" id="4937690">-</span><span class="num" id="4937691">1</span><span class="op" id="4937692">]</span><br>
<span class="lineno"></span><span class="op" id="4937694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4937697">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4937741">func</span>&nbsp;<span class="op" id="4937746">(</span><span class="ident" id="4937747">enc</span>&nbsp;<span class="op" id="4937751">*</span><span class="ident" id="4937752">Encoder</span><span class="op" id="4937759">)</span>&nbsp;<span class="ident" id="4937761">pushWriter</span><span class="op" id="4937771">(</span><span class="ident" id="4937772">w</span>&nbsp;<span class="ident" id="4937774">io</span><span class="op" id="4937776">.</span><span class="ident" id="4937777">Writer</span><span class="op" id="4937783">)</span>&nbsp;<span class="op" id="4937785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937788">enc</span><span class="op" id="4937791">.</span><span class="ident" id="4937792">w</span>&nbsp;<span class="op" id="4937794">=</span>&nbsp;<span class="builtinfunc" id="4937796">append</span><span class="op" id="4937802">(</span><span class="ident" id="4937803">enc</span><span class="op" id="4937806">.</span><span class="ident" id="4937807">w</span><span class="op" id="4937808">,</span>&nbsp;<span class="ident" id="4937810">w</span><span class="op" id="4937811">)</span><br>
<span class="lineno"></span><span class="op" id="4937813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4937816">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4937856">func</span>&nbsp;<span class="op" id="4937861">(</span><span class="ident" id="4937862">enc</span>&nbsp;<span class="op" id="4937866">*</span><span class="ident" id="4937867">Encoder</span><span class="op" id="4937874">)</span>&nbsp;<span class="ident" id="4937876">popWriter</span><span class="op" id="4937885">(</span><span class="op" id="4937886">)</span>&nbsp;<span class="op" id="4937888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4937891">enc</span><span class="op" id="4937894">.</span><span class="ident" id="4937895">w</span>&nbsp;<span class="op" id="4937897">=</span>&nbsp;<span class="ident" id="4937899">enc</span><span class="op" id="4937902">.</span><span class="ident" id="4937903">w</span><span class="op" id="4937904">[</span><span class="num" id="4937905">0</span>&nbsp;<span class="op" id="4937907">:</span>&nbsp;<span class="builtinfunc" id="4937909">len</span><span class="op" id="4937912">(</span><span class="ident" id="4937913">enc</span><span class="op" id="4937916">.</span><span class="ident" id="4937917">w</span><span class="op" id="4937918">)</span><span class="op" id="4937919">-</span><span class="num" id="4937920">1</span><span class="op" id="4937921">]</span><br>
<span class="lineno"></span><span class="op" id="4937923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4937926">func</span>&nbsp;<span class="op" id="4937931">(</span><span class="ident" id="4937932">enc</span>&nbsp;<span class="op" id="4937936">*</span><span class="ident" id="4937937">Encoder</span><span class="op" id="4937944">)</span>&nbsp;<span class="ident" id="4937946">setError</span><span class="op" id="4937954">(</span><span class="ident" id="4937955">err</span>&nbsp;<span class="builtintype" id="4937959">error</span><span class="op" id="4937964">)</span>&nbsp;<span class="op" id="4937966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4937969">if</span>&nbsp;<span class="ident" id="4937972">enc</span><span class="op" id="4937975">.</span><span class="ident" id="4937976">err</span>&nbsp;<span class="op" id="4937980">==</span>&nbsp;<span class="ident" id="4937983">nil</span>&nbsp;<span class="op" id="4937987">{</span>&nbsp;<span class="comment" id="4937989">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938014">enc</span><span class="op" id="4938017">.</span><span class="ident" id="4938018">err</span>&nbsp;<span class="op" id="4938022">=</span>&nbsp;<span class="ident" id="4938024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938029">}</span><br>
<span class="lineno"></span><span class="op" id="4938031">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4938034">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4938114">func</span>&nbsp;<span class="op" id="4938119">(</span><span class="ident" id="4938120">enc</span>&nbsp;<span class="op" id="4938124">*</span><span class="ident" id="4938125">Encoder</span><span class="op" id="4938132">)</span>&nbsp;<span class="ident" id="4938134">writeMessage</span><span class="op" id="4938146">(</span><span class="ident" id="4938147">w</span>&nbsp;<span class="ident" id="4938149">io</span><span class="op" id="4938151">.</span><span class="ident" id="4938152">Writer</span><span class="op" id="4938158">,</span>&nbsp;<span class="ident" id="4938160">b</span>&nbsp;<span class="op" id="4938162">*</span><span class="ident" id="4938163">encBuffer</span><span class="op" id="4938172">)</span>&nbsp;<span class="op" id="4938174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938177">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938248">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938328">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938344">message</span>&nbsp;<span class="op" id="4938352">:=</span>&nbsp;<span class="ident" id="4938355">b</span><span class="op" id="4938356">.</span><span class="ident" id="4938357">Bytes</span><span class="op" id="4938362">(</span><span class="op" id="4938363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938366">messageLen</span>&nbsp;<span class="op" id="4938377">:=</span>&nbsp;<span class="builtinfunc" id="4938380">len</span><span class="op" id="4938383">(</span><span class="ident" id="4938384">message</span><span class="op" id="4938391">)</span>&nbsp;<span class="op" id="4938393">-</span>&nbsp;<span class="ident" id="4938395">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938406">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938429">enc</span><span class="op" id="4938432">.</span><span class="ident" id="4938433">countState</span><span class="op" id="4938443">.</span><span class="ident" id="4938444">b</span><span class="op" id="4938445">.</span><span class="ident" id="4938446">Reset</span><span class="op" id="4938451">(</span><span class="op" id="4938452">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938455">enc</span><span class="op" id="4938458">.</span><span class="ident" id="4938459">countState</span><span class="op" id="4938469">.</span><span class="ident" id="4938470">encodeUint</span><span class="op" id="4938480">(</span><span class="ident" id="4938481">uint64</span><span class="op" id="4938487">(</span><span class="ident" id="4938488">messageLen</span><span class="op" id="4938498">)</span><span class="op" id="4938499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938502">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938553">offset</span>&nbsp;<span class="op" id="4938560">:=</span>&nbsp;<span class="ident" id="4938563">maxLength</span>&nbsp;<span class="op" id="4938573">-</span>&nbsp;<span class="ident" id="4938575">enc</span><span class="op" id="4938578">.</span><span class="ident" id="4938579">countState</span><span class="op" id="4938589">.</span><span class="ident" id="4938590">b</span><span class="op" id="4938591">.</span><span class="ident" id="4938592">Len</span><span class="op" id="4938595">(</span><span class="op" id="4938596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4938599">copy</span><span class="op" id="4938603">(</span><span class="ident" id="4938604">message</span><span class="op" id="4938611">[</span><span class="ident" id="4938612">offset</span><span class="op" id="4938618">:</span><span class="op" id="4938619">]</span><span class="op" id="4938620">,</span>&nbsp;<span class="ident" id="4938622">enc</span><span class="op" id="4938625">.</span><span class="ident" id="4938626">countState</span><span class="op" id="4938636">.</span><span class="ident" id="4938637">b</span><span class="op" id="4938638">.</span><span class="ident" id="4938639">Bytes</span><span class="op" id="4938644">(</span><span class="op" id="4938645">)</span><span class="op" id="4938646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938649">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938669">_</span><span class="op" id="4938670">,</span>&nbsp;<span class="ident" id="4938672">err</span>&nbsp;<span class="op" id="4938676">:=</span>&nbsp;<span class="ident" id="4938679">w</span><span class="op" id="4938680">.</span><span class="ident" id="4938681">Write</span><span class="op" id="4938686">(</span><span class="ident" id="4938687">message</span><span class="op" id="4938694">[</span><span class="ident" id="4938695">offset</span><span class="op" id="4938701">:</span><span class="op" id="4938702">]</span><span class="op" id="4938703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4938706">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938797">b</span><span class="op" id="4938798">.</span><span class="ident" id="4938799">Reset</span><span class="op" id="4938804">(</span><span class="op" id="4938805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938808">b</span><span class="op" id="4938809">.</span><span class="ident" id="4938810">Write</span><span class="op" id="4938815">(</span><span class="ident" id="4938816">spaceForLength</span><span class="op" id="4938830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4938833">if</span>&nbsp;<span class="ident" id="4938836">err</span>&nbsp;<span class="op" id="4938840">!=</span>&nbsp;<span class="ident" id="4938843">nil</span>&nbsp;<span class="op" id="4938847">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4938851">enc</span><span class="op" id="4938854">.</span><span class="ident" id="4938855">setError</span><span class="op" id="4938863">(</span><span class="ident" id="4938864">err</span><span class="op" id="4938867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4938870">}</span><br>
<span class="lineno"></span><span class="op" id="4938872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4938875">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="4938957">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="4938983">func</span>&nbsp;<span class="op" id="4938988">(</span><span class="ident" id="4938989">enc</span>&nbsp;<span class="op" id="4938993">*</span><span class="ident" id="4938994">Encoder</span><span class="op" id="4939001">)</span>&nbsp;<span class="ident" id="4939003">sendActualType</span><span class="op" id="4939017">(</span><span class="ident" id="4939018">w</span>&nbsp;<span class="ident" id="4939020">io</span><span class="op" id="4939022">.</span><span class="ident" id="4939023">Writer</span><span class="op" id="4939029">,</span>&nbsp;<span class="ident" id="4939031">state</span>&nbsp;<span class="op" id="4939037">*</span><span class="ident" id="4939038">encoderState</span><span class="op" id="4939050">,</span>&nbsp;<span class="ident" id="4939052">ut</span>&nbsp;<span class="op" id="4939055">*</span><span class="ident" id="4939056">userTypeInfo</span><span class="op" id="4939068">,</span>&nbsp;<span class="ident" id="4939070">actual</span>&nbsp;<span class="ident" id="4939077">reflect</span><span class="op" id="4939084">.</span><span class="ident" id="4939085">Type</span><span class="op" id="4939089">)</span>&nbsp;<span class="op" id="4939091">(</span><span class="ident" id="4939092">sent</span>&nbsp;<span class="builtintype" id="4939097">bool</span><span class="op" id="4939101">)</span>&nbsp;<span class="op" id="4939103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939106">if</span>&nbsp;<span class="ident" id="4939109">_</span><span class="op" id="4939110">,</span>&nbsp;<span class="ident" id="4939112">alreadySent</span>&nbsp;<span class="op" id="4939124">:=</span>&nbsp;<span class="ident" id="4939127">enc</span><span class="op" id="4939130">.</span><span class="ident" id="4939131">sent</span><span class="op" id="4939135">[</span><span class="ident" id="4939136">actual</span><span class="op" id="4939142">]</span><span class="op" id="4939143">;</span>&nbsp;<span class="ident" id="4939145">alreadySent</span>&nbsp;<span class="op" id="4939157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939161">return</span>&nbsp;<span class="builtintype" id="4939168">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939175">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939178">info</span><span class="op" id="4939182">,</span>&nbsp;<span class="ident" id="4939184">err</span>&nbsp;<span class="op" id="4939188">:=</span>&nbsp;<span class="ident" id="4939191">getTypeInfo</span><span class="op" id="4939202">(</span><span class="ident" id="4939203">ut</span><span class="op" id="4939205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939208">if</span>&nbsp;<span class="ident" id="4939211">err</span>&nbsp;<span class="op" id="4939215">!=</span>&nbsp;<span class="ident" id="4939218">nil</span>&nbsp;<span class="op" id="4939222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939226">enc</span><span class="op" id="4939229">.</span><span class="ident" id="4939230">setError</span><span class="op" id="4939238">(</span><span class="ident" id="4939239">err</span><span class="op" id="4939242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939246">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939254">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939257">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939287">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939295">state</span><span class="op" id="4939300">.</span><span class="ident" id="4939301">encodeInt</span><span class="op" id="4939310">(</span><span class="op" id="4939311">-</span><span class="ident" id="4939312">int64</span><span class="op" id="4939317">(</span><span class="ident" id="4939318">info</span><span class="op" id="4939322">.</span><span class="ident" id="4939323">id</span><span class="op" id="4939325">)</span><span class="op" id="4939326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939329">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939339">enc</span><span class="op" id="4939342">.</span><span class="ident" id="4939343">encode</span><span class="op" id="4939349">(</span><span class="ident" id="4939350">state</span><span class="op" id="4939355">.</span><span class="ident" id="4939356">b</span><span class="op" id="4939357">,</span>&nbsp;<span class="ident" id="4939359">reflect</span><span class="op" id="4939366">.</span><span class="ident" id="4939367">ValueOf</span><span class="op" id="4939374">(</span><span class="ident" id="4939375">info</span><span class="op" id="4939379">.</span><span class="ident" id="4939380">wire</span><span class="op" id="4939384">)</span><span class="op" id="4939385">,</span>&nbsp;<span class="ident" id="4939387">wireTypeUserInfo</span><span class="op" id="4939403">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939406">enc</span><span class="op" id="4939409">.</span><span class="ident" id="4939410">writeMessage</span><span class="op" id="4939422">(</span><span class="ident" id="4939423">w</span><span class="op" id="4939424">,</span>&nbsp;<span class="ident" id="4939426">state</span><span class="op" id="4939431">.</span><span class="ident" id="4939432">b</span><span class="op" id="4939433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939436">if</span>&nbsp;<span class="ident" id="4939439">enc</span><span class="op" id="4939442">.</span><span class="ident" id="4939443">err</span>&nbsp;<span class="op" id="4939447">!=</span>&nbsp;<span class="ident" id="4939450">nil</span>&nbsp;<span class="op" id="4939454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939458">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939470">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939551">enc</span><span class="op" id="4939554">.</span><span class="ident" id="4939555">sent</span><span class="op" id="4939559">[</span><span class="ident" id="4939560">ut</span><span class="op" id="4939562">.</span><span class="ident" id="4939563">base</span><span class="op" id="4939567">]</span>&nbsp;<span class="op" id="4939569">=</span>&nbsp;<span class="ident" id="4939571">info</span><span class="op" id="4939575">.</span><span class="ident" id="4939576">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939580">if</span>&nbsp;<span class="ident" id="4939583">ut</span><span class="op" id="4939585">.</span><span class="ident" id="4939586">user</span>&nbsp;<span class="op" id="4939591">!=</span>&nbsp;<span class="ident" id="4939594">ut</span><span class="op" id="4939596">.</span><span class="ident" id="4939597">base</span>&nbsp;<span class="op" id="4939602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939606">enc</span><span class="op" id="4939609">.</span><span class="ident" id="4939610">sent</span><span class="op" id="4939614">[</span><span class="ident" id="4939615">ut</span><span class="op" id="4939617">.</span><span class="ident" id="4939618">user</span><span class="op" id="4939622">]</span>&nbsp;<span class="op" id="4939624">=</span>&nbsp;<span class="ident" id="4939626">info</span><span class="op" id="4939630">.</span><span class="ident" id="4939631">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939635">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4939638">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939667">switch</span>&nbsp;<span class="ident" id="4939674">st</span>&nbsp;<span class="op" id="4939677">:=</span>&nbsp;<span class="ident" id="4939680">actual</span><span class="op" id="4939686">;</span>&nbsp;<span class="ident" id="4939688">st</span><span class="op" id="4939690">.</span><span class="ident" id="4939691">Kind</span><span class="op" id="4939695">(</span><span class="op" id="4939696">)</span>&nbsp;<span class="op" id="4939698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939701">case</span>&nbsp;<span class="ident" id="4939706">reflect</span><span class="op" id="4939713">.</span><span class="ident" id="4939714">Struct</span><span class="op" id="4939720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939724">for</span>&nbsp;<span class="ident" id="4939728">i</span>&nbsp;<span class="op" id="4939730">:=</span>&nbsp;<span class="num" id="4939733">0</span><span class="op" id="4939734">;</span>&nbsp;<span class="ident" id="4939736">i</span>&nbsp;<span class="op" id="4939738">&lt;</span>&nbsp;<span class="ident" id="4939740">st</span><span class="op" id="4939742">.</span><span class="ident" id="4939743">NumField</span><span class="op" id="4939751">(</span><span class="op" id="4939752">)</span><span class="op" id="4939753">;</span>&nbsp;<span class="ident" id="4939755">i</span><span class="op" id="4939756">++</span>&nbsp;<span class="op" id="4939759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939764">if</span>&nbsp;<span class="ident" id="4939767">isExported</span><span class="op" id="4939777">(</span><span class="ident" id="4939778">st</span><span class="op" id="4939780">.</span><span class="ident" id="4939781">Field</span><span class="op" id="4939786">(</span><span class="ident" id="4939787">i</span><span class="op" id="4939788">)</span><span class="op" id="4939789">.</span><span class="ident" id="4939790">Name</span><span class="op" id="4939794">)</span>&nbsp;<span class="op" id="4939796">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939802">enc</span><span class="op" id="4939805">.</span><span class="ident" id="4939806">sendType</span><span class="op" id="4939814">(</span><span class="ident" id="4939815">w</span><span class="op" id="4939816">,</span>&nbsp;<span class="ident" id="4939818">state</span><span class="op" id="4939823">,</span>&nbsp;<span class="ident" id="4939825">st</span><span class="op" id="4939827">.</span><span class="ident" id="4939828">Field</span><span class="op" id="4939833">(</span><span class="ident" id="4939834">i</span><span class="op" id="4939835">)</span><span class="op" id="4939836">.</span><span class="ident" id="4939837">Type</span><span class="op" id="4939841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4939850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939853">case</span>&nbsp;<span class="ident" id="4939858">reflect</span><span class="op" id="4939865">.</span><span class="ident" id="4939866">Array</span><span class="op" id="4939871">,</span>&nbsp;<span class="ident" id="4939873">reflect</span><span class="op" id="4939880">.</span><span class="ident" id="4939881">Slice</span><span class="op" id="4939886">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939890">enc</span><span class="op" id="4939893">.</span><span class="ident" id="4939894">sendType</span><span class="op" id="4939902">(</span><span class="ident" id="4939903">w</span><span class="op" id="4939904">,</span>&nbsp;<span class="ident" id="4939906">state</span><span class="op" id="4939911">,</span>&nbsp;<span class="ident" id="4939913">st</span><span class="op" id="4939915">.</span><span class="ident" id="4939916">Elem</span><span class="op" id="4939920">(</span><span class="op" id="4939921">)</span><span class="op" id="4939922">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4939925">case</span>&nbsp;<span class="ident" id="4939930">reflect</span><span class="op" id="4939937">.</span><span class="ident" id="4939938">Map</span><span class="op" id="4939941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939945">enc</span><span class="op" id="4939948">.</span><span class="ident" id="4939949">sendType</span><span class="op" id="4939957">(</span><span class="ident" id="4939958">w</span><span class="op" id="4939959">,</span>&nbsp;<span class="ident" id="4939961">state</span><span class="op" id="4939966">,</span>&nbsp;<span class="ident" id="4939968">st</span><span class="op" id="4939970">.</span><span class="ident" id="4939971">Key</span><span class="op" id="4939974">(</span><span class="op" id="4939975">)</span><span class="op" id="4939976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4939980">enc</span><span class="op" id="4939983">.</span><span class="ident" id="4939984">sendType</span><span class="op" id="4939992">(</span><span class="ident" id="4939993">w</span><span class="op" id="4939994">,</span>&nbsp;<span class="ident" id="4939996">state</span><span class="op" id="4940001">,</span>&nbsp;<span class="ident" id="4940003">st</span><span class="op" id="4940005">.</span><span class="ident" id="4940006">Elem</span><span class="op" id="4940010">(</span><span class="op" id="4940011">)</span><span class="op" id="4940012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940018">return</span>&nbsp;<span class="builtintype" id="4940025">true</span><br>
<span class="lineno">125</span><span class="op" id="4940030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4940033">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4940098">func</span>&nbsp;<span class="op" id="4940103">(</span><span class="ident" id="4940104">enc</span>&nbsp;<span class="op" id="4940108">*</span><span class="ident" id="4940109">Encoder</span><span class="op" id="4940116">)</span>&nbsp;<span class="ident" id="4940118">sendType</span><span class="op" id="4940126">(</span><span class="ident" id="4940127">w</span>&nbsp;<span class="ident" id="4940129">io</span><span class="op" id="4940131">.</span><span class="ident" id="4940132">Writer</span><span class="op" id="4940138">,</span>&nbsp;<span class="ident" id="4940140">state</span>&nbsp;<span class="op" id="4940146">*</span><span class="ident" id="4940147">encoderState</span><span class="op" id="4940159">,</span>&nbsp;<span class="ident" id="4940161">origt</span>&nbsp;<span class="ident" id="4940167">reflect</span><span class="op" id="4940174">.</span><span class="ident" id="4940175">Type</span><span class="op" id="4940179">)</span>&nbsp;<span class="op" id="4940181">(</span><span class="ident" id="4940182">sent</span>&nbsp;<span class="builtintype" id="4940187">bool</span><span class="op" id="4940191">)</span>&nbsp;<span class="op" id="4940193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4940196">ut</span>&nbsp;<span class="op" id="4940199">:=</span>&nbsp;<span class="ident" id="4940202">userType</span><span class="op" id="4940210">(</span><span class="ident" id="4940211">origt</span><span class="op" id="4940216">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940219">if</span>&nbsp;<span class="ident" id="4940222">ut</span><span class="op" id="4940224">.</span><span class="ident" id="4940225">externalEnc</span>&nbsp;<span class="op" id="4940237">!=</span>&nbsp;<span class="num" id="4940240">0</span>&nbsp;<span class="op" id="4940242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940246">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940328">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940400">return</span>&nbsp;<span class="ident" id="4940407">enc</span><span class="op" id="4940410">.</span><span class="ident" id="4940411">sendActualType</span><span class="op" id="4940425">(</span><span class="ident" id="4940426">w</span><span class="op" id="4940427">,</span>&nbsp;<span class="ident" id="4940429">state</span><span class="op" id="4940434">,</span>&nbsp;<span class="ident" id="4940436">ut</span><span class="op" id="4940438">,</span>&nbsp;<span class="ident" id="4940440">ut</span><span class="op" id="4940442">.</span><span class="ident" id="4940443">base</span><span class="op" id="4940447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940450">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940454">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940513">switch</span>&nbsp;<span class="ident" id="4940520">rt</span>&nbsp;<span class="op" id="4940523">:=</span>&nbsp;<span class="ident" id="4940526">ut</span><span class="op" id="4940528">.</span><span class="ident" id="4940529">base</span><span class="op" id="4940533">;</span>&nbsp;<span class="ident" id="4940535">rt</span><span class="op" id="4940537">.</span><span class="ident" id="4940538">Kind</span><span class="op" id="4940542">(</span><span class="op" id="4940543">)</span>&nbsp;<span class="op" id="4940545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940548">default</span><span class="op" id="4940555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940559">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940620">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940628">case</span>&nbsp;<span class="ident" id="4940633">reflect</span><span class="op" id="4940640">.</span><span class="ident" id="4940641">Slice</span><span class="op" id="4940646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940650">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940707">if</span>&nbsp;<span class="ident" id="4940710">rt</span><span class="op" id="4940712">.</span><span class="ident" id="4940713">Elem</span><span class="op" id="4940717">(</span><span class="op" id="4940718">)</span><span class="op" id="4940719">.</span><span class="ident" id="4940720">Kind</span><span class="op" id="4940724">(</span><span class="op" id="4940725">)</span>&nbsp;<span class="op" id="4940727">==</span>&nbsp;<span class="ident" id="4940730">reflect</span><span class="op" id="4940737">.</span><span class="ident" id="4940738">Uint8</span>&nbsp;<span class="op" id="4940744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940749">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4940758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940762">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940789">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940796">case</span>&nbsp;<span class="ident" id="4940801">reflect</span><span class="op" id="4940808">.</span><span class="ident" id="4940809">Array</span><span class="op" id="4940814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940818">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940887">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940894">case</span>&nbsp;<span class="ident" id="4940899">reflect</span><span class="op" id="4940906">.</span><span class="ident" id="4940907">Map</span><span class="op" id="4940910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4940914">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940983">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4940990">case</span>&nbsp;<span class="ident" id="4940995">reflect</span><span class="op" id="4941002">.</span><span class="ident" id="4941003">Struct</span><span class="op" id="4941009">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4941013">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941064">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941071">case</span>&nbsp;<span class="ident" id="4941076">reflect</span><span class="op" id="4941083">.</span><span class="ident" id="4941084">Chan</span><span class="op" id="4941088">,</span>&nbsp;<span class="ident" id="4941090">reflect</span><span class="op" id="4941097">.</span><span class="ident" id="4941098">Func</span><span class="op" id="4941102">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4941106">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941164">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941176">return</span>&nbsp;<span class="ident" id="4941183">enc</span><span class="op" id="4941186">.</span><span class="ident" id="4941187">sendActualType</span><span class="op" id="4941201">(</span><span class="ident" id="4941202">w</span><span class="op" id="4941203">,</span>&nbsp;<span class="ident" id="4941205">state</span><span class="op" id="4941210">,</span>&nbsp;<span class="ident" id="4941212">ut</span><span class="op" id="4941214">,</span>&nbsp;<span class="ident" id="4941216">ut</span><span class="op" id="4941218">.</span><span class="ident" id="4941219">base</span><span class="op" id="4941223">)</span><br>
<span class="lineno"></span><span class="op" id="4941225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4941228">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4941304">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4941384">func</span>&nbsp;<span class="op" id="4941389">(</span><span class="ident" id="4941390">enc</span>&nbsp;<span class="op" id="4941394">*</span><span class="ident" id="4941395">Encoder</span><span class="op" id="4941402">)</span>&nbsp;<span class="ident" id="4941404">Encode</span><span class="op" id="4941410">(</span><span class="ident" id="4941411">e</span>&nbsp;<span class="keyword" id="4941413">interface</span><span class="op" id="4941422">{</span><span class="op" id="4941423">}</span><span class="op" id="4941424">)</span>&nbsp;<span class="builtintype" id="4941426">error</span>&nbsp;<span class="op" id="4941432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941435">return</span>&nbsp;<span class="ident" id="4941442">enc</span><span class="op" id="4941445">.</span><span class="ident" id="4941446">EncodeValue</span><span class="op" id="4941457">(</span><span class="ident" id="4941458">reflect</span><span class="op" id="4941465">.</span><span class="ident" id="4941466">ValueOf</span><span class="op" id="4941473">(</span><span class="ident" id="4941474">e</span><span class="op" id="4941475">)</span><span class="op" id="4941476">)</span><br>
<span class="lineno"></span><span class="op" id="4941478">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4941481">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4941553">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="4941626">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4941635">func</span>&nbsp;<span class="op" id="4941640">(</span><span class="ident" id="4941641">enc</span>&nbsp;<span class="op" id="4941645">*</span><span class="ident" id="4941646">Encoder</span><span class="op" id="4941653">)</span>&nbsp;<span class="ident" id="4941655">sendTypeDescriptor</span><span class="op" id="4941673">(</span><span class="ident" id="4941674">w</span>&nbsp;<span class="ident" id="4941676">io</span><span class="op" id="4941678">.</span><span class="ident" id="4941679">Writer</span><span class="op" id="4941685">,</span>&nbsp;<span class="ident" id="4941687">state</span>&nbsp;<span class="op" id="4941693">*</span><span class="ident" id="4941694">encoderState</span><span class="op" id="4941706">,</span>&nbsp;<span class="ident" id="4941708">ut</span>&nbsp;<span class="op" id="4941711">*</span><span class="ident" id="4941712">userTypeInfo</span><span class="op" id="4941724">)</span>&nbsp;<span class="op" id="4941726">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4941729">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4941780">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941823">rt</span>&nbsp;<span class="op" id="4941826">:=</span>&nbsp;<span class="ident" id="4941829">ut</span><span class="op" id="4941831">.</span><span class="ident" id="4941832">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941838">if</span>&nbsp;<span class="ident" id="4941841">ut</span><span class="op" id="4941843">.</span><span class="ident" id="4941844">externalEnc</span>&nbsp;<span class="op" id="4941856">!=</span>&nbsp;<span class="num" id="4941859">0</span>&nbsp;<span class="op" id="4941861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941865">rt</span>&nbsp;<span class="op" id="4941868">=</span>&nbsp;<span class="ident" id="4941870">ut</span><span class="op" id="4941872">.</span><span class="ident" id="4941873">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4941879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941882">if</span>&nbsp;<span class="ident" id="4941885">_</span><span class="op" id="4941886">,</span>&nbsp;<span class="ident" id="4941888">alreadySent</span>&nbsp;<span class="op" id="4941900">:=</span>&nbsp;<span class="ident" id="4941903">enc</span><span class="op" id="4941906">.</span><span class="ident" id="4941907">sent</span><span class="op" id="4941911">[</span><span class="ident" id="4941912">rt</span><span class="op" id="4941914">]</span><span class="op" id="4941915">;</span>&nbsp;<span class="op" id="4941917">!</span><span class="ident" id="4941918">alreadySent</span>&nbsp;<span class="op" id="4941930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4941934">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4941955">sent</span>&nbsp;<span class="op" id="4941960">:=</span>&nbsp;<span class="ident" id="4941963">enc</span><span class="op" id="4941966">.</span><span class="ident" id="4941967">sendType</span><span class="op" id="4941975">(</span><span class="ident" id="4941976">w</span><span class="op" id="4941977">,</span>&nbsp;<span class="ident" id="4941979">state</span><span class="op" id="4941984">,</span>&nbsp;<span class="ident" id="4941986">rt</span><span class="op" id="4941988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4941992">if</span>&nbsp;<span class="ident" id="4941995">enc</span><span class="op" id="4941998">.</span><span class="ident" id="4941999">err</span>&nbsp;<span class="op" id="4942003">!=</span>&nbsp;<span class="ident" id="4942006">nil</span>&nbsp;<span class="op" id="4942010">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942015">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942028">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942099">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942170">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942237">if</span>&nbsp;<span class="op" id="4942240">!</span><span class="ident" id="4942241">sent</span>&nbsp;<span class="op" id="4942246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942251">info</span><span class="op" id="4942255">,</span>&nbsp;<span class="ident" id="4942257">err</span>&nbsp;<span class="op" id="4942261">:=</span>&nbsp;<span class="ident" id="4942264">getTypeInfo</span><span class="op" id="4942275">(</span><span class="ident" id="4942276">ut</span><span class="op" id="4942278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942283">if</span>&nbsp;<span class="ident" id="4942286">err</span>&nbsp;<span class="op" id="4942290">!=</span>&nbsp;<span class="ident" id="4942293">nil</span>&nbsp;<span class="op" id="4942297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942303">enc</span><span class="op" id="4942306">.</span><span class="ident" id="4942307">setError</span><span class="op" id="4942315">(</span><span class="ident" id="4942316">err</span><span class="op" id="4942319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942325">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942340">enc</span><span class="op" id="4942343">.</span><span class="ident" id="4942344">sent</span><span class="op" id="4942348">[</span><span class="ident" id="4942349">rt</span><span class="op" id="4942351">]</span>&nbsp;<span class="op" id="4942353">=</span>&nbsp;<span class="ident" id="4942355">info</span><span class="op" id="4942359">.</span><span class="ident" id="4942360">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4942368">}</span><br>
<span class="lineno"></span><span class="op" id="4942370">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4942373">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4942439">func</span>&nbsp;<span class="op" id="4942444">(</span><span class="ident" id="4942445">enc</span>&nbsp;<span class="op" id="4942449">*</span><span class="ident" id="4942450">Encoder</span><span class="op" id="4942457">)</span>&nbsp;<span class="ident" id="4942459">sendTypeId</span><span class="op" id="4942469">(</span><span class="ident" id="4942470">state</span>&nbsp;<span class="op" id="4942476">*</span><span class="ident" id="4942477">encoderState</span><span class="op" id="4942489">,</span>&nbsp;<span class="ident" id="4942491">ut</span>&nbsp;<span class="op" id="4942494">*</span><span class="ident" id="4942495">userTypeInfo</span><span class="op" id="4942507">)</span>&nbsp;<span class="op" id="4942509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942512">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4942559">state</span><span class="op" id="4942564">.</span><span class="ident" id="4942565">encodeInt</span><span class="op" id="4942574">(</span><span class="ident" id="4942575">int64</span><span class="op" id="4942580">(</span><span class="ident" id="4942581">enc</span><span class="op" id="4942584">.</span><span class="ident" id="4942585">sent</span><span class="op" id="4942589">[</span><span class="ident" id="4942590">ut</span><span class="op" id="4942592">.</span><span class="ident" id="4942593">base</span><span class="op" id="4942597">]</span><span class="op" id="4942598">)</span><span class="op" id="4942599">)</span><br>
<span class="lineno">205</span><span class="op" id="4942601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4942604">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4942680">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4942760">func</span>&nbsp;<span class="op" id="4942765">(</span><span class="ident" id="4942766">enc</span>&nbsp;<span class="op" id="4942770">*</span><span class="ident" id="4942771">Encoder</span><span class="op" id="4942778">)</span>&nbsp;<span class="ident" id="4942780">EncodeValue</span><span class="op" id="4942791">(</span><span class="ident" id="4942792">value</span>&nbsp;<span class="ident" id="4942798">reflect</span><span class="op" id="4942805">.</span><span class="ident" id="4942806">Value</span><span class="op" id="4942811">)</span>&nbsp;<span class="builtintype" id="4942813">error</span>&nbsp;<span class="op" id="4942819">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942822">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4942889">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4942918">if</span>&nbsp;<span class="ident" id="4942921">value</span><span class="op" id="4942926">.</span><span class="ident" id="4942927">Kind</span><span class="op" id="4942931">(</span><span class="op" id="4942932">)</span>&nbsp;<span class="op" id="4942934">==</span>&nbsp;<span class="ident" id="4942937">reflect</span><span class="op" id="4942944">.</span><span class="ident" id="4942945">Ptr</span>&nbsp;<span class="op" id="4942949">&amp;&amp;</span>&nbsp;<span class="ident" id="4942952">value</span><span class="op" id="4942957">.</span><span class="ident" id="4942958">IsNil</span><span class="op" id="4942963">(</span><span class="op" id="4942964">)</span>&nbsp;<span class="op" id="4942966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4942970">panic</span><span class="op" id="4942975">(</span><span class="string" id="4942976">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4943018">+</span>&nbsp;<span class="ident" id="4943020">value</span><span class="op" id="4943025">.</span><span class="ident" id="4943026">Type</span><span class="op" id="4943030">(</span><span class="op" id="4943031">)</span><span class="op" id="4943032">.</span><span class="ident" id="4943033">String</span><span class="op" id="4943039">(</span><span class="op" id="4943040">)</span><span class="op" id="4943041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943044">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943048">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943110">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943147">enc</span><span class="op" id="4943150">.</span><span class="ident" id="4943151">mutex</span><span class="op" id="4943156">.</span><span class="ident" id="4943157">Lock</span><span class="op" id="4943161">(</span><span class="op" id="4943162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943165">defer</span>&nbsp;<span class="ident" id="4943171">enc</span><span class="op" id="4943174">.</span><span class="ident" id="4943175">mutex</span><span class="op" id="4943180">.</span><span class="ident" id="4943181">Unlock</span><span class="op" id="4943187">(</span><span class="op" id="4943188">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943192">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943256">enc</span><span class="op" id="4943259">.</span><span class="ident" id="4943260">w</span>&nbsp;<span class="op" id="4943262">=</span>&nbsp;<span class="ident" id="4943264">enc</span><span class="op" id="4943267">.</span><span class="ident" id="4943268">w</span><span class="op" id="4943269">[</span><span class="num" id="4943270">0</span><span class="op" id="4943271">:</span><span class="num" id="4943272">1</span><span class="op" id="4943273">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943277">ut</span><span class="op" id="4943279">,</span>&nbsp;<span class="ident" id="4943281">err</span>&nbsp;<span class="op" id="4943285">:=</span>&nbsp;<span class="ident" id="4943288">validUserType</span><span class="op" id="4943301">(</span><span class="ident" id="4943302">value</span><span class="op" id="4943307">.</span><span class="ident" id="4943308">Type</span><span class="op" id="4943312">(</span><span class="op" id="4943313">)</span><span class="op" id="4943314">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943317">if</span>&nbsp;<span class="ident" id="4943320">err</span>&nbsp;<span class="op" id="4943324">!=</span>&nbsp;<span class="ident" id="4943327">nil</span>&nbsp;<span class="op" id="4943331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943335">return</span>&nbsp;<span class="ident" id="4943342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943351">enc</span><span class="op" id="4943354">.</span><span class="ident" id="4943355">err</span>&nbsp;<span class="op" id="4943359">=</span>&nbsp;<span class="ident" id="4943361">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943366">enc</span><span class="op" id="4943369">.</span><span class="ident" id="4943370">byteBuf</span><span class="op" id="4943377">.</span><span class="ident" id="4943378">Reset</span><span class="op" id="4943383">(</span><span class="op" id="4943384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943387">enc</span><span class="op" id="4943390">.</span><span class="ident" id="4943391">byteBuf</span><span class="op" id="4943398">.</span><span class="ident" id="4943399">Write</span><span class="op" id="4943404">(</span><span class="ident" id="4943405">spaceForLength</span><span class="op" id="4943419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943422">state</span>&nbsp;<span class="op" id="4943428">:=</span>&nbsp;<span class="ident" id="4943431">enc</span><span class="op" id="4943434">.</span><span class="ident" id="4943435">newEncoderState</span><span class="op" id="4943450">(</span><span class="op" id="4943451">&amp;</span><span class="ident" id="4943452">enc</span><span class="op" id="4943455">.</span><span class="ident" id="4943456">byteBuf</span><span class="op" id="4943463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943467">enc</span><span class="op" id="4943470">.</span><span class="ident" id="4943471">sendTypeDescriptor</span><span class="op" id="4943489">(</span><span class="ident" id="4943490">enc</span><span class="op" id="4943493">.</span><span class="ident" id="4943494">writer</span><span class="op" id="4943500">(</span><span class="op" id="4943501">)</span><span class="op" id="4943502">,</span>&nbsp;<span class="ident" id="4943504">state</span><span class="op" id="4943509">,</span>&nbsp;<span class="ident" id="4943511">ut</span><span class="op" id="4943513">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943516">enc</span><span class="op" id="4943519">.</span><span class="ident" id="4943520">sendTypeId</span><span class="op" id="4943530">(</span><span class="ident" id="4943531">state</span><span class="op" id="4943536">,</span>&nbsp;<span class="ident" id="4943538">ut</span><span class="op" id="4943540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943543">if</span>&nbsp;<span class="ident" id="4943546">enc</span><span class="op" id="4943549">.</span><span class="ident" id="4943550">err</span>&nbsp;<span class="op" id="4943554">!=</span>&nbsp;<span class="ident" id="4943557">nil</span>&nbsp;<span class="op" id="4943561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943565">return</span>&nbsp;<span class="ident" id="4943572">enc</span><span class="op" id="4943575">.</span><span class="ident" id="4943576">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4943585">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943608">enc</span><span class="op" id="4943611">.</span><span class="ident" id="4943612">encode</span><span class="op" id="4943618">(</span><span class="ident" id="4943619">state</span><span class="op" id="4943624">.</span><span class="ident" id="4943625">b</span><span class="op" id="4943626">,</span>&nbsp;<span class="ident" id="4943628">value</span><span class="op" id="4943633">,</span>&nbsp;<span class="ident" id="4943635">ut</span><span class="op" id="4943637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943640">if</span>&nbsp;<span class="ident" id="4943643">enc</span><span class="op" id="4943646">.</span><span class="ident" id="4943647">err</span>&nbsp;<span class="op" id="4943651">==</span>&nbsp;<span class="ident" id="4943654">nil</span>&nbsp;<span class="op" id="4943658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943662">enc</span><span class="op" id="4943665">.</span><span class="ident" id="4943666">writeMessage</span><span class="op" id="4943678">(</span><span class="ident" id="4943679">enc</span><span class="op" id="4943682">.</span><span class="ident" id="4943683">writer</span><span class="op" id="4943689">(</span><span class="op" id="4943690">)</span><span class="op" id="4943691">,</span>&nbsp;<span class="ident" id="4943693">state</span><span class="op" id="4943698">.</span><span class="ident" id="4943699">b</span><span class="op" id="4943700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4943703">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4943707">enc</span><span class="op" id="4943710">.</span><span class="ident" id="4943711">freeEncoderState</span><span class="op" id="4943727">(</span><span class="ident" id="4943728">state</span><span class="op" id="4943733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4943736">return</span>&nbsp;<span class="ident" id="4943743">enc</span><span class="op" id="4943746">.</span><span class="ident" id="4943747">err</span><br>
<span class="lineno"></span><span class="op" id="4943751">}</span>
</div>
</body>
</html>
