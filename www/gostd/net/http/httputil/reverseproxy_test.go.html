<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7516897">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7516952">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7517006">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7517057">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7517082">package</span>&nbsp;<span class="ident" id="7517090">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7517100">import</span>&nbsp;<span class="op" id="7517107">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517110">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517123">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517135">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517156">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517167">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517178">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7517189">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7517196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7517199">const</span>&nbsp;<span class="ident" id="7517205">fakeHopHeader</span>&nbsp;<span class="op" id="7517219">=</span>&nbsp;<span class="string" id="7517221">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7517251">func</span>&nbsp;<span class="ident" id="7517256">init</span><span class="op" id="7517260">(</span><span class="op" id="7517261">)</span>&nbsp;<span class="op" id="7517263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517266">hopHeaders</span>&nbsp;<span class="op" id="7517277">=</span>&nbsp;<span class="builtinfunc" id="7517279">append</span><span class="op" id="7517285">(</span><span class="ident" id="7517286">hopHeaders</span><span class="op" id="7517296">,</span>&nbsp;<span class="ident" id="7517298">fakeHopHeader</span><span class="op" id="7517311">)</span><br>
<span class="lineno"></span><span class="op" id="7517313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7517316">func</span>&nbsp;<span class="ident" id="7517321">TestReverseProxy</span><span class="op" id="7517337">(</span><span class="ident" id="7517338">t</span>&nbsp;<span class="op" id="7517340">*</span><span class="ident" id="7517341">testing</span><span class="op" id="7517348">.</span><span class="ident" id="7517349">T</span><span class="op" id="7517350">)</span>&nbsp;<span class="op" id="7517352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517355">const</span>&nbsp;<span class="ident" id="7517361">backendResponse</span>&nbsp;<span class="op" id="7517377">=</span>&nbsp;<span class="string" id="7517379">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517399">const</span>&nbsp;<span class="ident" id="7517405">backendStatus</span>&nbsp;<span class="op" id="7517419">=</span>&nbsp;<span class="num" id="7517421">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517426">backend</span>&nbsp;<span class="op" id="7517434">:=</span>&nbsp;<span class="ident" id="7517437">httptest</span><span class="op" id="7517445">.</span><span class="ident" id="7517446">NewServer</span><span class="op" id="7517455">(</span><span class="ident" id="7517456">http</span><span class="op" id="7517460">.</span><span class="ident" id="7517461">HandlerFunc</span><span class="op" id="7517472">(</span><span class="keyword" id="7517473">func</span><span class="op" id="7517477">(</span><span class="ident" id="7517478">w</span>&nbsp;<span class="ident" id="7517480">http</span><span class="op" id="7517484">.</span><span class="ident" id="7517485">ResponseWriter</span><span class="op" id="7517499">,</span>&nbsp;<span class="ident" id="7517501">r</span>&nbsp;<span class="op" id="7517503">*</span><span class="ident" id="7517504">http</span><span class="op" id="7517508">.</span><span class="ident" id="7517509">Request</span><span class="op" id="7517516">)</span>&nbsp;<span class="op" id="7517518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517522">if</span>&nbsp;<span class="builtinfunc" id="7517525">len</span><span class="op" id="7517528">(</span><span class="ident" id="7517529">r</span><span class="op" id="7517530">.</span><span class="ident" id="7517531">TransferEncoding</span><span class="op" id="7517547">)</span>&nbsp;<span class="op" id="7517549">&gt;</span>&nbsp;<span class="num" id="7517551">0</span>&nbsp;<span class="op" id="7517553">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517558">t</span><span class="op" id="7517559">.</span><span class="ident" id="7517560">Errorf</span><span class="op" id="7517566">(</span><span class="string" id="7517567">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7517612">,</span>&nbsp;<span class="ident" id="7517614">r</span><span class="op" id="7517615">.</span><span class="ident" id="7517616">TransferEncoding</span><span class="op" id="7517632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7517636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517640">if</span>&nbsp;<span class="ident" id="7517643">r</span><span class="op" id="7517644">.</span><span class="ident" id="7517645">Header</span><span class="op" id="7517651">.</span><span class="ident" id="7517652">Get</span><span class="op" id="7517655">(</span><span class="string" id="7517656">&#34;X-Forwarded-For&#34;</span><span class="op" id="7517673">)</span>&nbsp;<span class="op" id="7517675">==</span>&nbsp;<span class="string" id="7517678">&#34;&#34;</span>&nbsp;<span class="op" id="7517681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517686">t</span><span class="op" id="7517687">.</span><span class="ident" id="7517688">Errorf</span><span class="op" id="7517694">(</span><span class="string" id="7517695">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7517730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7517734">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517738">if</span>&nbsp;<span class="ident" id="7517741">c</span>&nbsp;<span class="op" id="7517743">:=</span>&nbsp;<span class="ident" id="7517746">r</span><span class="op" id="7517747">.</span><span class="ident" id="7517748">Header</span><span class="op" id="7517754">.</span><span class="ident" id="7517755">Get</span><span class="op" id="7517758">(</span><span class="string" id="7517759">&#34;Connection&#34;</span><span class="op" id="7517771">)</span><span class="op" id="7517772">;</span>&nbsp;<span class="ident" id="7517774">c</span>&nbsp;<span class="op" id="7517776">!=</span>&nbsp;<span class="string" id="7517779">&#34;&#34;</span>&nbsp;<span class="op" id="7517782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517787">t</span><span class="op" id="7517788">.</span><span class="ident" id="7517789">Errorf</span><span class="op" id="7517795">(</span><span class="string" id="7517796">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7517836">,</span>&nbsp;<span class="ident" id="7517838">c</span><span class="op" id="7517839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7517843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517847">if</span>&nbsp;<span class="ident" id="7517850">c</span>&nbsp;<span class="op" id="7517852">:=</span>&nbsp;<span class="ident" id="7517855">r</span><span class="op" id="7517856">.</span><span class="ident" id="7517857">Header</span><span class="op" id="7517863">.</span><span class="ident" id="7517864">Get</span><span class="op" id="7517867">(</span><span class="string" id="7517868">&#34;Upgrade&#34;</span><span class="op" id="7517877">)</span><span class="op" id="7517878">;</span>&nbsp;<span class="ident" id="7517880">c</span>&nbsp;<span class="op" id="7517882">!=</span>&nbsp;<span class="string" id="7517885">&#34;&#34;</span>&nbsp;<span class="op" id="7517888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517893">t</span><span class="op" id="7517894">.</span><span class="ident" id="7517895">Errorf</span><span class="op" id="7517901">(</span><span class="string" id="7517902">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7517939">,</span>&nbsp;<span class="ident" id="7517941">c</span><span class="op" id="7517942">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7517946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7517950">if</span>&nbsp;<span class="ident" id="7517953">g</span><span class="op" id="7517954">,</span>&nbsp;<span class="ident" id="7517956">e</span>&nbsp;<span class="op" id="7517958">:=</span>&nbsp;<span class="ident" id="7517961">r</span><span class="op" id="7517962">.</span><span class="ident" id="7517963">Host</span><span class="op" id="7517967">,</span>&nbsp;<span class="string" id="7517969">&#34;some-name&#34;</span><span class="op" id="7517980">;</span>&nbsp;<span class="ident" id="7517982">g</span>&nbsp;<span class="op" id="7517984">!=</span>&nbsp;<span class="ident" id="7517987">e</span>&nbsp;<span class="op" id="7517989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7517994">t</span><span class="op" id="7517995">.</span><span class="ident" id="7517996">Errorf</span><span class="op" id="7518002">(</span><span class="string" id="7518003">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7518040">,</span>&nbsp;<span class="ident" id="7518042">g</span><span class="op" id="7518043">,</span>&nbsp;<span class="ident" id="7518045">e</span><span class="op" id="7518046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7518050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518054">w</span><span class="op" id="7518055">.</span><span class="ident" id="7518056">Header</span><span class="op" id="7518062">(</span><span class="op" id="7518063">)</span><span class="op" id="7518064">.</span><span class="ident" id="7518065">Set</span><span class="op" id="7518068">(</span><span class="string" id="7518069">&#34;X-Foo&#34;</span><span class="op" id="7518076">,</span>&nbsp;<span class="string" id="7518078">&#34;bar&#34;</span><span class="op" id="7518083">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518087">w</span><span class="op" id="7518088">.</span><span class="ident" id="7518089">Header</span><span class="op" id="7518095">(</span><span class="op" id="7518096">)</span><span class="op" id="7518097">.</span><span class="ident" id="7518098">Set</span><span class="op" id="7518101">(</span><span class="string" id="7518102">&#34;Upgrade&#34;</span><span class="op" id="7518111">,</span>&nbsp;<span class="string" id="7518113">&#34;foo&#34;</span><span class="op" id="7518118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518122">w</span><span class="op" id="7518123">.</span><span class="ident" id="7518124">Header</span><span class="op" id="7518130">(</span><span class="op" id="7518131">)</span><span class="op" id="7518132">.</span><span class="ident" id="7518133">Set</span><span class="op" id="7518136">(</span><span class="ident" id="7518137">fakeHopHeader</span><span class="op" id="7518150">,</span>&nbsp;<span class="string" id="7518152">&#34;foo&#34;</span><span class="op" id="7518157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518161">w</span><span class="op" id="7518162">.</span><span class="ident" id="7518163">Header</span><span class="op" id="7518169">(</span><span class="op" id="7518170">)</span><span class="op" id="7518171">.</span><span class="ident" id="7518172">Add</span><span class="op" id="7518175">(</span><span class="string" id="7518176">&#34;X-Multi-Value&#34;</span><span class="op" id="7518191">,</span>&nbsp;<span class="string" id="7518193">&#34;foo&#34;</span><span class="op" id="7518198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518202">w</span><span class="op" id="7518203">.</span><span class="ident" id="7518204">Header</span><span class="op" id="7518210">(</span><span class="op" id="7518211">)</span><span class="op" id="7518212">.</span><span class="ident" id="7518213">Add</span><span class="op" id="7518216">(</span><span class="string" id="7518217">&#34;X-Multi-Value&#34;</span><span class="op" id="7518232">,</span>&nbsp;<span class="string" id="7518234">&#34;bar&#34;</span><span class="op" id="7518239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518243">http</span><span class="op" id="7518247">.</span><span class="ident" id="7518248">SetCookie</span><span class="op" id="7518257">(</span><span class="ident" id="7518258">w</span><span class="op" id="7518259">,</span>&nbsp;<span class="op" id="7518261">&amp;</span><span class="ident" id="7518262">http</span><span class="op" id="7518266">.</span><span class="ident" id="7518267">Cookie</span><span class="op" id="7518273">{</span><span class="ident" id="7518274">Name</span><span class="op" id="7518278">:</span>&nbsp;<span class="string" id="7518280">&#34;flavor&#34;</span><span class="op" id="7518288">,</span>&nbsp;<span class="ident" id="7518290">Value</span><span class="op" id="7518295">:</span>&nbsp;<span class="string" id="7518297">&#34;chocolateChip&#34;</span><span class="op" id="7518312">}</span><span class="op" id="7518313">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518317">w</span><span class="op" id="7518318">.</span><span class="ident" id="7518319">WriteHeader</span><span class="op" id="7518330">(</span><span class="ident" id="7518331">backendStatus</span><span class="op" id="7518344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518348">w</span><span class="op" id="7518349">.</span><span class="ident" id="7518350">Write</span><span class="op" id="7518355">(</span><span class="op" id="7518356">[</span><span class="op" id="7518357">]</span><span class="builtintype" id="7518358">byte</span><span class="op" id="7518362">(</span><span class="ident" id="7518363">backendResponse</span><span class="op" id="7518378">)</span><span class="op" id="7518379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7518382">}</span><span class="op" id="7518383">)</span><span class="op" id="7518384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518387">defer</span>&nbsp;<span class="ident" id="7518393">backend</span><span class="op" id="7518400">.</span><span class="ident" id="7518401">Close</span><span class="op" id="7518406">(</span><span class="op" id="7518407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518410">backendURL</span><span class="op" id="7518420">,</span>&nbsp;<span class="ident" id="7518422">err</span>&nbsp;<span class="op" id="7518426">:=</span>&nbsp;<span class="ident" id="7518429">url</span><span class="op" id="7518432">.</span><span class="ident" id="7518433">Parse</span><span class="op" id="7518438">(</span><span class="ident" id="7518439">backend</span><span class="op" id="7518446">.</span><span class="ident" id="7518447">URL</span><span class="op" id="7518450">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518453">if</span>&nbsp;<span class="ident" id="7518456">err</span>&nbsp;<span class="op" id="7518460">!=</span>&nbsp;<span class="ident" id="7518463">nil</span>&nbsp;<span class="op" id="7518467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518471">t</span><span class="op" id="7518472">.</span><span class="ident" id="7518473">Fatal</span><span class="op" id="7518478">(</span><span class="ident" id="7518479">err</span><span class="op" id="7518482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7518485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518488">proxyHandler</span>&nbsp;<span class="op" id="7518501">:=</span>&nbsp;<span class="ident" id="7518504">NewSingleHostReverseProxy</span><span class="op" id="7518529">(</span><span class="ident" id="7518530">backendURL</span><span class="op" id="7518540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518543">frontend</span>&nbsp;<span class="op" id="7518552">:=</span>&nbsp;<span class="ident" id="7518555">httptest</span><span class="op" id="7518563">.</span><span class="ident" id="7518564">NewServer</span><span class="op" id="7518573">(</span><span class="ident" id="7518574">proxyHandler</span><span class="op" id="7518586">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518589">defer</span>&nbsp;<span class="ident" id="7518595">frontend</span><span class="op" id="7518603">.</span><span class="ident" id="7518604">Close</span><span class="op" id="7518609">(</span><span class="op" id="7518610">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518614">getReq</span><span class="op" id="7518620">,</span>&nbsp;<span class="ident" id="7518622">_</span>&nbsp;<span class="op" id="7518624">:=</span>&nbsp;<span class="ident" id="7518627">http</span><span class="op" id="7518631">.</span><span class="ident" id="7518632">NewRequest</span><span class="op" id="7518642">(</span><span class="string" id="7518643">&#34;GET&#34;</span><span class="op" id="7518648">,</span>&nbsp;<span class="ident" id="7518650">frontend</span><span class="op" id="7518658">.</span><span class="ident" id="7518659">URL</span><span class="op" id="7518662">,</span>&nbsp;<span class="ident" id="7518664">nil</span><span class="op" id="7518667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518670">getReq</span><span class="op" id="7518676">.</span><span class="ident" id="7518677">Host</span>&nbsp;<span class="op" id="7518682">=</span>&nbsp;<span class="string" id="7518684">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518697">getReq</span><span class="op" id="7518703">.</span><span class="ident" id="7518704">Header</span><span class="op" id="7518710">.</span><span class="ident" id="7518711">Set</span><span class="op" id="7518714">(</span><span class="string" id="7518715">&#34;Connection&#34;</span><span class="op" id="7518727">,</span>&nbsp;<span class="string" id="7518729">&#34;close&#34;</span><span class="op" id="7518736">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518739">getReq</span><span class="op" id="7518745">.</span><span class="ident" id="7518746">Header</span><span class="op" id="7518752">.</span><span class="ident" id="7518753">Set</span><span class="op" id="7518756">(</span><span class="string" id="7518757">&#34;Upgrade&#34;</span><span class="op" id="7518766">,</span>&nbsp;<span class="string" id="7518768">&#34;foo&#34;</span><span class="op" id="7518773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518776">getReq</span><span class="op" id="7518782">.</span><span class="ident" id="7518783">Close</span>&nbsp;<span class="op" id="7518789">=</span>&nbsp;<span class="builtintype" id="7518791">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518797">res</span><span class="op" id="7518800">,</span>&nbsp;<span class="ident" id="7518802">err</span>&nbsp;<span class="op" id="7518806">:=</span>&nbsp;<span class="ident" id="7518809">http</span><span class="op" id="7518813">.</span><span class="ident" id="7518814">DefaultClient</span><span class="op" id="7518827">.</span><span class="ident" id="7518828">Do</span><span class="op" id="7518830">(</span><span class="ident" id="7518831">getReq</span><span class="op" id="7518837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518840">if</span>&nbsp;<span class="ident" id="7518843">err</span>&nbsp;<span class="op" id="7518847">!=</span>&nbsp;<span class="ident" id="7518850">nil</span>&nbsp;<span class="op" id="7518854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518858">t</span><span class="op" id="7518859">.</span><span class="ident" id="7518860">Fatalf</span><span class="op" id="7518866">(</span><span class="string" id="7518867">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7518876">,</span>&nbsp;<span class="ident" id="7518878">err</span><span class="op" id="7518881">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7518884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518887">if</span>&nbsp;<span class="ident" id="7518890">g</span><span class="op" id="7518891">,</span>&nbsp;<span class="ident" id="7518893">e</span>&nbsp;<span class="op" id="7518895">:=</span>&nbsp;<span class="ident" id="7518898">res</span><span class="op" id="7518901">.</span><span class="ident" id="7518902">StatusCode</span><span class="op" id="7518912">,</span>&nbsp;<span class="ident" id="7518914">backendStatus</span><span class="op" id="7518927">;</span>&nbsp;<span class="ident" id="7518929">g</span>&nbsp;<span class="op" id="7518931">!=</span>&nbsp;<span class="ident" id="7518934">e</span>&nbsp;<span class="op" id="7518936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7518940">t</span><span class="op" id="7518941">.</span><span class="ident" id="7518942">Errorf</span><span class="op" id="7518948">(</span><span class="string" id="7518949">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7518985">,</span>&nbsp;<span class="ident" id="7518987">g</span><span class="op" id="7518988">,</span>&nbsp;<span class="ident" id="7518990">e</span><span class="op" id="7518991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7518994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7518997">if</span>&nbsp;<span class="ident" id="7519000">g</span><span class="op" id="7519001">,</span>&nbsp;<span class="ident" id="7519003">e</span>&nbsp;<span class="op" id="7519005">:=</span>&nbsp;<span class="ident" id="7519008">res</span><span class="op" id="7519011">.</span><span class="ident" id="7519012">Header</span><span class="op" id="7519018">.</span><span class="ident" id="7519019">Get</span><span class="op" id="7519022">(</span><span class="string" id="7519023">&#34;X-Foo&#34;</span><span class="op" id="7519030">)</span><span class="op" id="7519031">,</span>&nbsp;<span class="string" id="7519033">&#34;bar&#34;</span><span class="op" id="7519038">;</span>&nbsp;<span class="ident" id="7519040">g</span>&nbsp;<span class="op" id="7519042">!=</span>&nbsp;<span class="ident" id="7519045">e</span>&nbsp;<span class="op" id="7519047">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519051">t</span><span class="op" id="7519052">.</span><span class="ident" id="7519053">Errorf</span><span class="op" id="7519059">(</span><span class="string" id="7519060">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7519087">,</span>&nbsp;<span class="ident" id="7519089">g</span><span class="op" id="7519090">,</span>&nbsp;<span class="ident" id="7519092">e</span><span class="op" id="7519093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519099">if</span>&nbsp;<span class="ident" id="7519102">c</span>&nbsp;<span class="op" id="7519104">:=</span>&nbsp;<span class="ident" id="7519107">res</span><span class="op" id="7519110">.</span><span class="ident" id="7519111">Header</span><span class="op" id="7519117">.</span><span class="ident" id="7519118">Get</span><span class="op" id="7519121">(</span><span class="ident" id="7519122">fakeHopHeader</span><span class="op" id="7519135">)</span><span class="op" id="7519136">;</span>&nbsp;<span class="ident" id="7519138">c</span>&nbsp;<span class="op" id="7519140">!=</span>&nbsp;<span class="string" id="7519143">&#34;&#34;</span>&nbsp;<span class="op" id="7519146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519150">t</span><span class="op" id="7519151">.</span><span class="ident" id="7519152">Errorf</span><span class="op" id="7519158">(</span><span class="string" id="7519159">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7519183">,</span>&nbsp;<span class="ident" id="7519185">fakeHopHeader</span><span class="op" id="7519198">,</span>&nbsp;<span class="ident" id="7519200">c</span><span class="op" id="7519201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519204">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519207">if</span>&nbsp;<span class="ident" id="7519210">g</span><span class="op" id="7519211">,</span>&nbsp;<span class="ident" id="7519213">e</span>&nbsp;<span class="op" id="7519215">:=</span>&nbsp;<span class="builtinfunc" id="7519218">len</span><span class="op" id="7519221">(</span><span class="ident" id="7519222">res</span><span class="op" id="7519225">.</span><span class="ident" id="7519226">Header</span><span class="op" id="7519232">[</span><span class="string" id="7519233">&#34;X-Multi-Value&#34;</span><span class="op" id="7519248">]</span><span class="op" id="7519249">)</span><span class="op" id="7519250">,</span>&nbsp;<span class="num" id="7519252">2</span><span class="op" id="7519253">;</span>&nbsp;<span class="ident" id="7519255">g</span>&nbsp;<span class="op" id="7519257">!=</span>&nbsp;<span class="ident" id="7519260">e</span>&nbsp;<span class="op" id="7519262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519266">t</span><span class="op" id="7519267">.</span><span class="ident" id="7519268">Errorf</span><span class="op" id="7519274">(</span><span class="string" id="7519275">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7519324">,</span>&nbsp;<span class="ident" id="7519326">g</span><span class="op" id="7519327">,</span>&nbsp;<span class="ident" id="7519329">e</span><span class="op" id="7519330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519336">if</span>&nbsp;<span class="ident" id="7519339">g</span><span class="op" id="7519340">,</span>&nbsp;<span class="ident" id="7519342">e</span>&nbsp;<span class="op" id="7519344">:=</span>&nbsp;<span class="builtinfunc" id="7519347">len</span><span class="op" id="7519350">(</span><span class="ident" id="7519351">res</span><span class="op" id="7519354">.</span><span class="ident" id="7519355">Header</span><span class="op" id="7519361">[</span><span class="string" id="7519362">&#34;Set-Cookie&#34;</span><span class="op" id="7519374">]</span><span class="op" id="7519375">)</span><span class="op" id="7519376">,</span>&nbsp;<span class="num" id="7519378">1</span><span class="op" id="7519379">;</span>&nbsp;<span class="ident" id="7519381">g</span>&nbsp;<span class="op" id="7519383">!=</span>&nbsp;<span class="ident" id="7519386">e</span>&nbsp;<span class="op" id="7519388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519392">t</span><span class="op" id="7519393">.</span><span class="ident" id="7519394">Fatalf</span><span class="op" id="7519400">(</span><span class="string" id="7519401">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7519429">,</span>&nbsp;<span class="ident" id="7519431">g</span><span class="op" id="7519432">,</span>&nbsp;<span class="ident" id="7519434">e</span><span class="op" id="7519435">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519441">if</span>&nbsp;<span class="ident" id="7519444">cookie</span>&nbsp;<span class="op" id="7519451">:=</span>&nbsp;<span class="ident" id="7519454">res</span><span class="op" id="7519457">.</span><span class="ident" id="7519458">Cookies</span><span class="op" id="7519465">(</span><span class="op" id="7519466">)</span><span class="op" id="7519467">[</span><span class="num" id="7519468">0</span><span class="op" id="7519469">]</span><span class="op" id="7519470">;</span>&nbsp;<span class="ident" id="7519472">cookie</span><span class="op" id="7519478">.</span><span class="ident" id="7519479">Name</span>&nbsp;<span class="op" id="7519484">!=</span>&nbsp;<span class="string" id="7519487">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7519496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519500">t</span><span class="op" id="7519501">.</span><span class="ident" id="7519502">Errorf</span><span class="op" id="7519508">(</span><span class="string" id="7519509">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7519531">,</span>&nbsp;<span class="ident" id="7519533">cookie</span><span class="op" id="7519539">.</span><span class="ident" id="7519540">Name</span><span class="op" id="7519544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519550">bodyBytes</span><span class="op" id="7519559">,</span>&nbsp;<span class="ident" id="7519561">_</span>&nbsp;<span class="op" id="7519563">:=</span>&nbsp;<span class="ident" id="7519566">ioutil</span><span class="op" id="7519572">.</span><span class="ident" id="7519573">ReadAll</span><span class="op" id="7519580">(</span><span class="ident" id="7519581">res</span><span class="op" id="7519584">.</span><span class="ident" id="7519585">Body</span><span class="op" id="7519589">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519592">if</span>&nbsp;<span class="ident" id="7519595">g</span><span class="op" id="7519596">,</span>&nbsp;<span class="ident" id="7519598">e</span>&nbsp;<span class="op" id="7519600">:=</span>&nbsp;<span class="builtintype" id="7519603">string</span><span class="op" id="7519609">(</span><span class="ident" id="7519610">bodyBytes</span><span class="op" id="7519619">)</span><span class="op" id="7519620">,</span>&nbsp;<span class="ident" id="7519622">backendResponse</span><span class="op" id="7519637">;</span>&nbsp;<span class="ident" id="7519639">g</span>&nbsp;<span class="op" id="7519641">!=</span>&nbsp;<span class="ident" id="7519644">e</span>&nbsp;<span class="op" id="7519646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519650">t</span><span class="op" id="7519651">.</span><span class="ident" id="7519652">Errorf</span><span class="op" id="7519658">(</span><span class="string" id="7519659">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7519685">,</span>&nbsp;<span class="ident" id="7519687">g</span><span class="op" id="7519688">,</span>&nbsp;<span class="ident" id="7519690">e</span><span class="op" id="7519691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7519694">}</span><br>
<span class="lineno"></span><span class="op" id="7519696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7519699">func</span>&nbsp;<span class="ident" id="7519704">TestXForwardedFor</span><span class="op" id="7519721">(</span><span class="ident" id="7519722">t</span>&nbsp;<span class="op" id="7519724">*</span><span class="ident" id="7519725">testing</span><span class="op" id="7519732">.</span><span class="ident" id="7519733">T</span><span class="op" id="7519734">)</span>&nbsp;<span class="op" id="7519736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519739">const</span>&nbsp;<span class="ident" id="7519745">prevForwardedFor</span>&nbsp;<span class="op" id="7519762">=</span>&nbsp;<span class="string" id="7519764">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519777">const</span>&nbsp;<span class="ident" id="7519783">backendResponse</span>&nbsp;<span class="op" id="7519799">=</span>&nbsp;<span class="string" id="7519801">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519821">const</span>&nbsp;<span class="ident" id="7519827">backendStatus</span>&nbsp;<span class="op" id="7519841">=</span>&nbsp;<span class="num" id="7519843">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519848">backend</span>&nbsp;<span class="op" id="7519856">:=</span>&nbsp;<span class="ident" id="7519859">httptest</span><span class="op" id="7519867">.</span><span class="ident" id="7519868">NewServer</span><span class="op" id="7519877">(</span><span class="ident" id="7519878">http</span><span class="op" id="7519882">.</span><span class="ident" id="7519883">HandlerFunc</span><span class="op" id="7519894">(</span><span class="keyword" id="7519895">func</span><span class="op" id="7519899">(</span><span class="ident" id="7519900">w</span>&nbsp;<span class="ident" id="7519902">http</span><span class="op" id="7519906">.</span><span class="ident" id="7519907">ResponseWriter</span><span class="op" id="7519921">,</span>&nbsp;<span class="ident" id="7519923">r</span>&nbsp;<span class="op" id="7519925">*</span><span class="ident" id="7519926">http</span><span class="op" id="7519930">.</span><span class="ident" id="7519931">Request</span><span class="op" id="7519938">)</span>&nbsp;<span class="op" id="7519940">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7519944">if</span>&nbsp;<span class="ident" id="7519947">r</span><span class="op" id="7519948">.</span><span class="ident" id="7519949">Header</span><span class="op" id="7519955">.</span><span class="ident" id="7519956">Get</span><span class="op" id="7519959">(</span><span class="string" id="7519960">&#34;X-Forwarded-For&#34;</span><span class="op" id="7519977">)</span>&nbsp;<span class="op" id="7519979">==</span>&nbsp;<span class="string" id="7519982">&#34;&#34;</span>&nbsp;<span class="op" id="7519985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7519990">t</span><span class="op" id="7519991">.</span><span class="ident" id="7519992">Errorf</span><span class="op" id="7519998">(</span><span class="string" id="7519999">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7520034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520042">if</span>&nbsp;<span class="op" id="7520045">!</span><span class="ident" id="7520046">strings</span><span class="op" id="7520053">.</span><span class="ident" id="7520054">Contains</span><span class="op" id="7520062">(</span><span class="ident" id="7520063">r</span><span class="op" id="7520064">.</span><span class="ident" id="7520065">Header</span><span class="op" id="7520071">.</span><span class="ident" id="7520072">Get</span><span class="op" id="7520075">(</span><span class="string" id="7520076">&#34;X-Forwarded-For&#34;</span><span class="op" id="7520093">)</span><span class="op" id="7520094">,</span>&nbsp;<span class="ident" id="7520096">prevForwardedFor</span><span class="op" id="7520112">)</span>&nbsp;<span class="op" id="7520114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520119">t</span><span class="op" id="7520120">.</span><span class="ident" id="7520121">Errorf</span><span class="op" id="7520127">(</span><span class="string" id="7520128">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7520171">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520179">w</span><span class="op" id="7520180">.</span><span class="ident" id="7520181">WriteHeader</span><span class="op" id="7520192">(</span><span class="ident" id="7520193">backendStatus</span><span class="op" id="7520206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520210">w</span><span class="op" id="7520211">.</span><span class="ident" id="7520212">Write</span><span class="op" id="7520217">(</span><span class="op" id="7520218">[</span><span class="op" id="7520219">]</span><span class="builtintype" id="7520220">byte</span><span class="op" id="7520224">(</span><span class="ident" id="7520225">backendResponse</span><span class="op" id="7520240">)</span><span class="op" id="7520241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520244">}</span><span class="op" id="7520245">)</span><span class="op" id="7520246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520249">defer</span>&nbsp;<span class="ident" id="7520255">backend</span><span class="op" id="7520262">.</span><span class="ident" id="7520263">Close</span><span class="op" id="7520268">(</span><span class="op" id="7520269">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520272">backendURL</span><span class="op" id="7520282">,</span>&nbsp;<span class="ident" id="7520284">err</span>&nbsp;<span class="op" id="7520288">:=</span>&nbsp;<span class="ident" id="7520291">url</span><span class="op" id="7520294">.</span><span class="ident" id="7520295">Parse</span><span class="op" id="7520300">(</span><span class="ident" id="7520301">backend</span><span class="op" id="7520308">.</span><span class="ident" id="7520309">URL</span><span class="op" id="7520312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520315">if</span>&nbsp;<span class="ident" id="7520318">err</span>&nbsp;<span class="op" id="7520322">!=</span>&nbsp;<span class="ident" id="7520325">nil</span>&nbsp;<span class="op" id="7520329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520333">t</span><span class="op" id="7520334">.</span><span class="ident" id="7520335">Fatal</span><span class="op" id="7520340">(</span><span class="ident" id="7520341">err</span><span class="op" id="7520344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520350">proxyHandler</span>&nbsp;<span class="op" id="7520363">:=</span>&nbsp;<span class="ident" id="7520366">NewSingleHostReverseProxy</span><span class="op" id="7520391">(</span><span class="ident" id="7520392">backendURL</span><span class="op" id="7520402">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520405">frontend</span>&nbsp;<span class="op" id="7520414">:=</span>&nbsp;<span class="ident" id="7520417">httptest</span><span class="op" id="7520425">.</span><span class="ident" id="7520426">NewServer</span><span class="op" id="7520435">(</span><span class="ident" id="7520436">proxyHandler</span><span class="op" id="7520448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520451">defer</span>&nbsp;<span class="ident" id="7520457">frontend</span><span class="op" id="7520465">.</span><span class="ident" id="7520466">Close</span><span class="op" id="7520471">(</span><span class="op" id="7520472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520476">getReq</span><span class="op" id="7520482">,</span>&nbsp;<span class="ident" id="7520484">_</span>&nbsp;<span class="op" id="7520486">:=</span>&nbsp;<span class="ident" id="7520489">http</span><span class="op" id="7520493">.</span><span class="ident" id="7520494">NewRequest</span><span class="op" id="7520504">(</span><span class="string" id="7520505">&#34;GET&#34;</span><span class="op" id="7520510">,</span>&nbsp;<span class="ident" id="7520512">frontend</span><span class="op" id="7520520">.</span><span class="ident" id="7520521">URL</span><span class="op" id="7520524">,</span>&nbsp;<span class="ident" id="7520526">nil</span><span class="op" id="7520529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520532">getReq</span><span class="op" id="7520538">.</span><span class="ident" id="7520539">Host</span>&nbsp;<span class="op" id="7520544">=</span>&nbsp;<span class="string" id="7520546">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520559">getReq</span><span class="op" id="7520565">.</span><span class="ident" id="7520566">Header</span><span class="op" id="7520572">.</span><span class="ident" id="7520573">Set</span><span class="op" id="7520576">(</span><span class="string" id="7520577">&#34;Connection&#34;</span><span class="op" id="7520589">,</span>&nbsp;<span class="string" id="7520591">&#34;close&#34;</span><span class="op" id="7520598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520601">getReq</span><span class="op" id="7520607">.</span><span class="ident" id="7520608">Header</span><span class="op" id="7520614">.</span><span class="ident" id="7520615">Set</span><span class="op" id="7520618">(</span><span class="string" id="7520619">&#34;X-Forwarded-For&#34;</span><span class="op" id="7520636">,</span>&nbsp;<span class="ident" id="7520638">prevForwardedFor</span><span class="op" id="7520654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520657">getReq</span><span class="op" id="7520663">.</span><span class="ident" id="7520664">Close</span>&nbsp;<span class="op" id="7520670">=</span>&nbsp;<span class="builtintype" id="7520672">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520678">res</span><span class="op" id="7520681">,</span>&nbsp;<span class="ident" id="7520683">err</span>&nbsp;<span class="op" id="7520687">:=</span>&nbsp;<span class="ident" id="7520690">http</span><span class="op" id="7520694">.</span><span class="ident" id="7520695">DefaultClient</span><span class="op" id="7520708">.</span><span class="ident" id="7520709">Do</span><span class="op" id="7520711">(</span><span class="ident" id="7520712">getReq</span><span class="op" id="7520718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520721">if</span>&nbsp;<span class="ident" id="7520724">err</span>&nbsp;<span class="op" id="7520728">!=</span>&nbsp;<span class="ident" id="7520731">nil</span>&nbsp;<span class="op" id="7520735">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520739">t</span><span class="op" id="7520740">.</span><span class="ident" id="7520741">Fatalf</span><span class="op" id="7520747">(</span><span class="string" id="7520748">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7520757">,</span>&nbsp;<span class="ident" id="7520759">err</span><span class="op" id="7520762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520768">if</span>&nbsp;<span class="ident" id="7520771">g</span><span class="op" id="7520772">,</span>&nbsp;<span class="ident" id="7520774">e</span>&nbsp;<span class="op" id="7520776">:=</span>&nbsp;<span class="ident" id="7520779">res</span><span class="op" id="7520782">.</span><span class="ident" id="7520783">StatusCode</span><span class="op" id="7520793">,</span>&nbsp;<span class="ident" id="7520795">backendStatus</span><span class="op" id="7520808">;</span>&nbsp;<span class="ident" id="7520810">g</span>&nbsp;<span class="op" id="7520812">!=</span>&nbsp;<span class="ident" id="7520815">e</span>&nbsp;<span class="op" id="7520817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520821">t</span><span class="op" id="7520822">.</span><span class="ident" id="7520823">Errorf</span><span class="op" id="7520829">(</span><span class="string" id="7520830">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7520866">,</span>&nbsp;<span class="ident" id="7520868">g</span><span class="op" id="7520869">,</span>&nbsp;<span class="ident" id="7520871">e</span><span class="op" id="7520872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7520875">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520878">bodyBytes</span><span class="op" id="7520887">,</span>&nbsp;<span class="ident" id="7520889">_</span>&nbsp;<span class="op" id="7520891">:=</span>&nbsp;<span class="ident" id="7520894">ioutil</span><span class="op" id="7520900">.</span><span class="ident" id="7520901">ReadAll</span><span class="op" id="7520908">(</span><span class="ident" id="7520909">res</span><span class="op" id="7520912">.</span><span class="ident" id="7520913">Body</span><span class="op" id="7520917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7520920">if</span>&nbsp;<span class="ident" id="7520923">g</span><span class="op" id="7520924">,</span>&nbsp;<span class="ident" id="7520926">e</span>&nbsp;<span class="op" id="7520928">:=</span>&nbsp;<span class="builtintype" id="7520931">string</span><span class="op" id="7520937">(</span><span class="ident" id="7520938">bodyBytes</span><span class="op" id="7520947">)</span><span class="op" id="7520948">,</span>&nbsp;<span class="ident" id="7520950">backendResponse</span><span class="op" id="7520965">;</span>&nbsp;<span class="ident" id="7520967">g</span>&nbsp;<span class="op" id="7520969">!=</span>&nbsp;<span class="ident" id="7520972">e</span>&nbsp;<span class="op" id="7520974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7520978">t</span><span class="op" id="7520979">.</span><span class="ident" id="7520980">Errorf</span><span class="op" id="7520986">(</span><span class="string" id="7520987">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7521013">,</span>&nbsp;<span class="ident" id="7521015">g</span><span class="op" id="7521016">,</span>&nbsp;<span class="ident" id="7521018">e</span><span class="op" id="7521019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521022">}</span><br>
<span class="lineno"></span><span class="op" id="7521024">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7521027">var</span>&nbsp;<span class="ident" id="7521031">proxyQueryTests</span>&nbsp;<span class="op" id="7521047">=</span>&nbsp;<span class="op" id="7521049">[</span><span class="op" id="7521050">]</span><span class="keyword" id="7521051">struct</span>&nbsp;<span class="op" id="7521058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521061">baseSuffix</span>&nbsp;<span class="builtintype" id="7521072">string</span>&nbsp;<span class="comment" id="7521079">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521112">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7521123">string</span>&nbsp;<span class="comment" id="7521130">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521174">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7521185">string</span>&nbsp;<span class="comment" id="7521192">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7521253">}</span><span class="op" id="7521254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521257">{</span><span class="string" id="7521258">&#34;&#34;</span><span class="op" id="7521260">,</span>&nbsp;<span class="string" id="7521262">&#34;&#34;</span><span class="op" id="7521264">,</span>&nbsp;<span class="string" id="7521266">&#34;&#34;</span><span class="op" id="7521268">}</span><span class="op" id="7521269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521272">{</span><span class="string" id="7521273">&#34;?sta=tic&#34;</span><span class="op" id="7521283">,</span>&nbsp;<span class="string" id="7521285">&#34;?us=er&#34;</span><span class="op" id="7521293">,</span>&nbsp;<span class="string" id="7521295">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7521310">}</span><span class="op" id="7521311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521314">{</span><span class="string" id="7521315">&#34;&#34;</span><span class="op" id="7521317">,</span>&nbsp;<span class="string" id="7521319">&#34;?us=er&#34;</span><span class="op" id="7521327">,</span>&nbsp;<span class="string" id="7521329">&#34;us=er&#34;</span><span class="op" id="7521336">}</span><span class="op" id="7521337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521340">{</span><span class="string" id="7521341">&#34;?sta=tic&#34;</span><span class="op" id="7521351">,</span>&nbsp;<span class="string" id="7521353">&#34;&#34;</span><span class="op" id="7521355">,</span>&nbsp;<span class="string" id="7521357">&#34;sta=tic&#34;</span><span class="op" id="7521366">}</span><span class="op" id="7521367">,</span><br>
<span class="lineno">145</span><span class="op" id="7521369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7521372">func</span>&nbsp;<span class="ident" id="7521377">TestReverseProxyQuery</span><span class="op" id="7521398">(</span><span class="ident" id="7521399">t</span>&nbsp;<span class="op" id="7521401">*</span><span class="ident" id="7521402">testing</span><span class="op" id="7521409">.</span><span class="ident" id="7521410">T</span><span class="op" id="7521411">)</span>&nbsp;<span class="op" id="7521413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521416">backend</span>&nbsp;<span class="op" id="7521424">:=</span>&nbsp;<span class="ident" id="7521427">httptest</span><span class="op" id="7521435">.</span><span class="ident" id="7521436">NewServer</span><span class="op" id="7521445">(</span><span class="ident" id="7521446">http</span><span class="op" id="7521450">.</span><span class="ident" id="7521451">HandlerFunc</span><span class="op" id="7521462">(</span><span class="keyword" id="7521463">func</span><span class="op" id="7521467">(</span><span class="ident" id="7521468">w</span>&nbsp;<span class="ident" id="7521470">http</span><span class="op" id="7521474">.</span><span class="ident" id="7521475">ResponseWriter</span><span class="op" id="7521489">,</span>&nbsp;<span class="ident" id="7521491">r</span>&nbsp;<span class="op" id="7521493">*</span><span class="ident" id="7521494">http</span><span class="op" id="7521498">.</span><span class="ident" id="7521499">Request</span><span class="op" id="7521506">)</span>&nbsp;<span class="op" id="7521508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521512">w</span><span class="op" id="7521513">.</span><span class="ident" id="7521514">Header</span><span class="op" id="7521520">(</span><span class="op" id="7521521">)</span><span class="op" id="7521522">.</span><span class="ident" id="7521523">Set</span><span class="op" id="7521526">(</span><span class="string" id="7521527">&#34;X-Got-Query&#34;</span><span class="op" id="7521540">,</span>&nbsp;<span class="ident" id="7521542">r</span><span class="op" id="7521543">.</span><span class="ident" id="7521544">URL</span><span class="op" id="7521547">.</span><span class="ident" id="7521548">RawQuery</span><span class="op" id="7521556">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521560">w</span><span class="op" id="7521561">.</span><span class="ident" id="7521562">Write</span><span class="op" id="7521567">(</span><span class="op" id="7521568">[</span><span class="op" id="7521569">]</span><span class="builtintype" id="7521570">byte</span><span class="op" id="7521574">(</span><span class="string" id="7521575">&#34;hi&#34;</span><span class="op" id="7521579">)</span><span class="op" id="7521580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521583">}</span><span class="op" id="7521584">)</span><span class="op" id="7521585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7521588">defer</span>&nbsp;<span class="ident" id="7521594">backend</span><span class="op" id="7521601">.</span><span class="ident" id="7521602">Close</span><span class="op" id="7521607">(</span><span class="op" id="7521608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7521612">for</span>&nbsp;<span class="ident" id="7521616">i</span><span class="op" id="7521617">,</span>&nbsp;<span class="ident" id="7521619">tt</span>&nbsp;<span class="op" id="7521622">:=</span>&nbsp;<span class="keyword" id="7521625">range</span>&nbsp;<span class="ident" id="7521631">proxyQueryTests</span>&nbsp;<span class="op" id="7521647">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521651">backendURL</span><span class="op" id="7521661">,</span>&nbsp;<span class="ident" id="7521663">err</span>&nbsp;<span class="op" id="7521667">:=</span>&nbsp;<span class="ident" id="7521670">url</span><span class="op" id="7521673">.</span><span class="ident" id="7521674">Parse</span><span class="op" id="7521679">(</span><span class="ident" id="7521680">backend</span><span class="op" id="7521687">.</span><span class="ident" id="7521688">URL</span>&nbsp;<span class="op" id="7521692">+</span>&nbsp;<span class="ident" id="7521694">tt</span><span class="op" id="7521696">.</span><span class="ident" id="7521697">baseSuffix</span><span class="op" id="7521707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7521711">if</span>&nbsp;<span class="ident" id="7521714">err</span>&nbsp;<span class="op" id="7521718">!=</span>&nbsp;<span class="ident" id="7521721">nil</span>&nbsp;<span class="op" id="7521725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521730">t</span><span class="op" id="7521731">.</span><span class="ident" id="7521732">Fatal</span><span class="op" id="7521737">(</span><span class="ident" id="7521738">err</span><span class="op" id="7521741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7521745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521749">frontend</span>&nbsp;<span class="op" id="7521758">:=</span>&nbsp;<span class="ident" id="7521761">httptest</span><span class="op" id="7521769">.</span><span class="ident" id="7521770">NewServer</span><span class="op" id="7521779">(</span><span class="ident" id="7521780">NewSingleHostReverseProxy</span><span class="op" id="7521805">(</span><span class="ident" id="7521806">backendURL</span><span class="op" id="7521816">)</span><span class="op" id="7521817">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521821">req</span><span class="op" id="7521824">,</span>&nbsp;<span class="ident" id="7521826">_</span>&nbsp;<span class="op" id="7521828">:=</span>&nbsp;<span class="ident" id="7521831">http</span><span class="op" id="7521835">.</span><span class="ident" id="7521836">NewRequest</span><span class="op" id="7521846">(</span><span class="string" id="7521847">&#34;GET&#34;</span><span class="op" id="7521852">,</span>&nbsp;<span class="ident" id="7521854">frontend</span><span class="op" id="7521862">.</span><span class="ident" id="7521863">URL</span><span class="op" id="7521866">+</span><span class="ident" id="7521867">tt</span><span class="op" id="7521869">.</span><span class="ident" id="7521870">reqSuffix</span><span class="op" id="7521879">,</span>&nbsp;<span class="ident" id="7521881">nil</span><span class="op" id="7521884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521888">req</span><span class="op" id="7521891">.</span><span class="ident" id="7521892">Close</span>&nbsp;<span class="op" id="7521898">=</span>&nbsp;<span class="builtintype" id="7521900">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521907">res</span><span class="op" id="7521910">,</span>&nbsp;<span class="ident" id="7521912">err</span>&nbsp;<span class="op" id="7521916">:=</span>&nbsp;<span class="ident" id="7521919">http</span><span class="op" id="7521923">.</span><span class="ident" id="7521924">DefaultClient</span><span class="op" id="7521937">.</span><span class="ident" id="7521938">Do</span><span class="op" id="7521940">(</span><span class="ident" id="7521941">req</span><span class="op" id="7521944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7521948">if</span>&nbsp;<span class="ident" id="7521951">err</span>&nbsp;<span class="op" id="7521955">!=</span>&nbsp;<span class="ident" id="7521958">nil</span>&nbsp;<span class="op" id="7521962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7521967">t</span><span class="op" id="7521968">.</span><span class="ident" id="7521969">Fatalf</span><span class="op" id="7521975">(</span><span class="string" id="7521976">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7521989">,</span>&nbsp;<span class="ident" id="7521991">i</span><span class="op" id="7521992">,</span>&nbsp;<span class="ident" id="7521994">err</span><span class="op" id="7521997">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522005">if</span>&nbsp;<span class="ident" id="7522008">g</span><span class="op" id="7522009">,</span>&nbsp;<span class="ident" id="7522011">e</span>&nbsp;<span class="op" id="7522013">:=</span>&nbsp;<span class="ident" id="7522016">res</span><span class="op" id="7522019">.</span><span class="ident" id="7522020">Header</span><span class="op" id="7522026">.</span><span class="ident" id="7522027">Get</span><span class="op" id="7522030">(</span><span class="string" id="7522031">&#34;X-Got-Query&#34;</span><span class="op" id="7522044">)</span><span class="op" id="7522045">,</span>&nbsp;<span class="ident" id="7522047">tt</span><span class="op" id="7522049">.</span><span class="ident" id="7522050">want</span><span class="op" id="7522054">;</span>&nbsp;<span class="ident" id="7522056">g</span>&nbsp;<span class="op" id="7522058">!=</span>&nbsp;<span class="ident" id="7522061">e</span>&nbsp;<span class="op" id="7522063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522068">t</span><span class="op" id="7522069">.</span><span class="ident" id="7522070">Errorf</span><span class="op" id="7522076">(</span><span class="string" id="7522077">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7522108">,</span>&nbsp;<span class="ident" id="7522110">i</span><span class="op" id="7522111">,</span>&nbsp;<span class="ident" id="7522113">g</span><span class="op" id="7522114">,</span>&nbsp;<span class="ident" id="7522116">e</span><span class="op" id="7522117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522125">res</span><span class="op" id="7522128">.</span><span class="ident" id="7522129">Body</span><span class="op" id="7522133">.</span><span class="ident" id="7522134">Close</span><span class="op" id="7522139">(</span><span class="op" id="7522140">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522144">frontend</span><span class="op" id="7522152">.</span><span class="ident" id="7522153">Close</span><span class="op" id="7522158">(</span><span class="op" id="7522159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522162">}</span><br>
<span class="lineno"></span><span class="op" id="7522164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7522167">func</span>&nbsp;<span class="ident" id="7522172">TestReverseProxyFlushInterval</span><span class="op" id="7522201">(</span><span class="ident" id="7522202">t</span>&nbsp;<span class="op" id="7522204">*</span><span class="ident" id="7522205">testing</span><span class="op" id="7522212">.</span><span class="ident" id="7522213">T</span><span class="op" id="7522214">)</span>&nbsp;<span class="op" id="7522216">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522219">const</span>&nbsp;<span class="ident" id="7522225">expected</span>&nbsp;<span class="op" id="7522234">=</span>&nbsp;<span class="string" id="7522236">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522242">backend</span>&nbsp;<span class="op" id="7522250">:=</span>&nbsp;<span class="ident" id="7522253">httptest</span><span class="op" id="7522261">.</span><span class="ident" id="7522262">NewServer</span><span class="op" id="7522271">(</span><span class="ident" id="7522272">http</span><span class="op" id="7522276">.</span><span class="ident" id="7522277">HandlerFunc</span><span class="op" id="7522288">(</span><span class="keyword" id="7522289">func</span><span class="op" id="7522293">(</span><span class="ident" id="7522294">w</span>&nbsp;<span class="ident" id="7522296">http</span><span class="op" id="7522300">.</span><span class="ident" id="7522301">ResponseWriter</span><span class="op" id="7522315">,</span>&nbsp;<span class="ident" id="7522317">r</span>&nbsp;<span class="op" id="7522319">*</span><span class="ident" id="7522320">http</span><span class="op" id="7522324">.</span><span class="ident" id="7522325">Request</span><span class="op" id="7522332">)</span>&nbsp;<span class="op" id="7522334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522338">w</span><span class="op" id="7522339">.</span><span class="ident" id="7522340">Write</span><span class="op" id="7522345">(</span><span class="op" id="7522346">[</span><span class="op" id="7522347">]</span><span class="builtintype" id="7522348">byte</span><span class="op" id="7522352">(</span><span class="ident" id="7522353">expected</span><span class="op" id="7522361">)</span><span class="op" id="7522362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522365">}</span><span class="op" id="7522366">)</span><span class="op" id="7522367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522370">defer</span>&nbsp;<span class="ident" id="7522376">backend</span><span class="op" id="7522383">.</span><span class="ident" id="7522384">Close</span><span class="op" id="7522389">(</span><span class="op" id="7522390">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522394">backendURL</span><span class="op" id="7522404">,</span>&nbsp;<span class="ident" id="7522406">err</span>&nbsp;<span class="op" id="7522410">:=</span>&nbsp;<span class="ident" id="7522413">url</span><span class="op" id="7522416">.</span><span class="ident" id="7522417">Parse</span><span class="op" id="7522422">(</span><span class="ident" id="7522423">backend</span><span class="op" id="7522430">.</span><span class="ident" id="7522431">URL</span><span class="op" id="7522434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522437">if</span>&nbsp;<span class="ident" id="7522440">err</span>&nbsp;<span class="op" id="7522444">!=</span>&nbsp;<span class="ident" id="7522447">nil</span>&nbsp;<span class="op" id="7522451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522455">t</span><span class="op" id="7522456">.</span><span class="ident" id="7522457">Fatal</span><span class="op" id="7522462">(</span><span class="ident" id="7522463">err</span><span class="op" id="7522466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522469">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522473">proxyHandler</span>&nbsp;<span class="op" id="7522486">:=</span>&nbsp;<span class="ident" id="7522489">NewSingleHostReverseProxy</span><span class="op" id="7522514">(</span><span class="ident" id="7522515">backendURL</span><span class="op" id="7522525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522528">proxyHandler</span><span class="op" id="7522540">.</span><span class="ident" id="7522541">FlushInterval</span>&nbsp;<span class="op" id="7522555">=</span>&nbsp;<span class="ident" id="7522557">time</span><span class="op" id="7522561">.</span><span class="ident" id="7522562">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522576">done</span>&nbsp;<span class="op" id="7522581">:=</span>&nbsp;<span class="builtinfunc" id="7522584">make</span><span class="op" id="7522588">(</span><span class="keyword" id="7522589">chan</span>&nbsp;<span class="builtintype" id="7522594">bool</span><span class="op" id="7522598">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522601">onExitFlushLoop</span>&nbsp;<span class="op" id="7522617">=</span>&nbsp;<span class="keyword" id="7522619">func</span><span class="op" id="7522623">(</span><span class="op" id="7522624">)</span>&nbsp;<span class="op" id="7522626">{</span>&nbsp;<span class="ident" id="7522628">done</span>&nbsp;<span class="op" id="7522633">&lt;-</span>&nbsp;<span class="builtintype" id="7522636">true</span>&nbsp;<span class="op" id="7522641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522644">defer</span>&nbsp;<span class="keyword" id="7522650">func</span><span class="op" id="7522654">(</span><span class="op" id="7522655">)</span>&nbsp;<span class="op" id="7522657">{</span>&nbsp;<span class="ident" id="7522659">onExitFlushLoop</span>&nbsp;<span class="op" id="7522675">=</span>&nbsp;<span class="ident" id="7522677">nil</span>&nbsp;<span class="op" id="7522681">}</span><span class="op" id="7522682">(</span><span class="op" id="7522683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522687">frontend</span>&nbsp;<span class="op" id="7522696">:=</span>&nbsp;<span class="ident" id="7522699">httptest</span><span class="op" id="7522707">.</span><span class="ident" id="7522708">NewServer</span><span class="op" id="7522717">(</span><span class="ident" id="7522718">proxyHandler</span><span class="op" id="7522730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522733">defer</span>&nbsp;<span class="ident" id="7522739">frontend</span><span class="op" id="7522747">.</span><span class="ident" id="7522748">Close</span><span class="op" id="7522753">(</span><span class="op" id="7522754">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522758">req</span><span class="op" id="7522761">,</span>&nbsp;<span class="ident" id="7522763">_</span>&nbsp;<span class="op" id="7522765">:=</span>&nbsp;<span class="ident" id="7522768">http</span><span class="op" id="7522772">.</span><span class="ident" id="7522773">NewRequest</span><span class="op" id="7522783">(</span><span class="string" id="7522784">&#34;GET&#34;</span><span class="op" id="7522789">,</span>&nbsp;<span class="ident" id="7522791">frontend</span><span class="op" id="7522799">.</span><span class="ident" id="7522800">URL</span><span class="op" id="7522803">,</span>&nbsp;<span class="ident" id="7522805">nil</span><span class="op" id="7522808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522811">req</span><span class="op" id="7522814">.</span><span class="ident" id="7522815">Close</span>&nbsp;<span class="op" id="7522821">=</span>&nbsp;<span class="builtintype" id="7522823">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522829">res</span><span class="op" id="7522832">,</span>&nbsp;<span class="ident" id="7522834">err</span>&nbsp;<span class="op" id="7522838">:=</span>&nbsp;<span class="ident" id="7522841">http</span><span class="op" id="7522845">.</span><span class="ident" id="7522846">DefaultClient</span><span class="op" id="7522859">.</span><span class="ident" id="7522860">Do</span><span class="op" id="7522862">(</span><span class="ident" id="7522863">req</span><span class="op" id="7522866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522869">if</span>&nbsp;<span class="ident" id="7522872">err</span>&nbsp;<span class="op" id="7522876">!=</span>&nbsp;<span class="ident" id="7522879">nil</span>&nbsp;<span class="op" id="7522883">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7522887">t</span><span class="op" id="7522888">.</span><span class="ident" id="7522889">Fatalf</span><span class="op" id="7522895">(</span><span class="string" id="7522896">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7522905">,</span>&nbsp;<span class="ident" id="7522907">err</span><span class="op" id="7522910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7522913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522916">defer</span>&nbsp;<span class="ident" id="7522922">res</span><span class="op" id="7522925">.</span><span class="ident" id="7522926">Body</span><span class="op" id="7522930">.</span><span class="ident" id="7522931">Close</span><span class="op" id="7522936">(</span><span class="op" id="7522937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7522940">if</span>&nbsp;<span class="ident" id="7522943">bodyBytes</span><span class="op" id="7522952">,</span>&nbsp;<span class="ident" id="7522954">_</span>&nbsp;<span class="op" id="7522956">:=</span>&nbsp;<span class="ident" id="7522959">ioutil</span><span class="op" id="7522965">.</span><span class="ident" id="7522966">ReadAll</span><span class="op" id="7522973">(</span><span class="ident" id="7522974">res</span><span class="op" id="7522977">.</span><span class="ident" id="7522978">Body</span><span class="op" id="7522982">)</span><span class="op" id="7522983">;</span>&nbsp;<span class="builtintype" id="7522985">string</span><span class="op" id="7522991">(</span><span class="ident" id="7522992">bodyBytes</span><span class="op" id="7523001">)</span>&nbsp;<span class="op" id="7523003">!=</span>&nbsp;<span class="ident" id="7523006">expected</span>&nbsp;<span class="op" id="7523015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7523019">t</span><span class="op" id="7523020">.</span><span class="ident" id="7523021">Errorf</span><span class="op" id="7523027">(</span><span class="string" id="7523028">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7523054">,</span>&nbsp;<span class="ident" id="7523056">bodyBytes</span><span class="op" id="7523065">,</span>&nbsp;<span class="ident" id="7523067">expected</span><span class="op" id="7523075">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7523078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7523082">select</span>&nbsp;<span class="op" id="7523089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7523092">case</span>&nbsp;<span class="op" id="7523097">&lt;-</span><span class="ident" id="7523099">done</span><span class="op" id="7523103">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7523107">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7523114">case</span>&nbsp;<span class="op" id="7523119">&lt;-</span><span class="ident" id="7523121">time</span><span class="op" id="7523125">.</span><span class="ident" id="7523126">After</span><span class="op" id="7523131">(</span><span class="num" id="7523132">5</span>&nbsp;<span class="op" id="7523134">*</span>&nbsp;<span class="ident" id="7523136">time</span><span class="op" id="7523140">.</span><span class="ident" id="7523141">Second</span><span class="op" id="7523147">)</span><span class="op" id="7523148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7523152">t</span><span class="op" id="7523153">.</span><span class="ident" id="7523154">Error</span><span class="op" id="7523159">(</span><span class="string" id="7523160">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7523203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7523206">}</span><br>
<span class="lineno"></span><span class="op" id="7523208">}</span>
</div>
</body>
</html>
