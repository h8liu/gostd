<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4990952">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4991007">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4991061">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4991112">package</span>&nbsp;<span class="ident" id="4991120">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4991127">import</span>&nbsp;<span class="op" id="4991134">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4991137">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4991144">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4991150">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4991157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4991160">const</span>&nbsp;<span class="op" id="4991166">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991169">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991188">=</span>&nbsp;<span class="num" id="4991190">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991193">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991212">=</span>&nbsp;<span class="num" id="4991214">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991217">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991236">=</span>&nbsp;<span class="num" id="4991238">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991241">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991260">=</span>&nbsp;<span class="num" id="4991262">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991265">DefaultCompression</span>&nbsp;<span class="op" id="4991284">=</span>&nbsp;<span class="op" id="4991286">-</span><span class="num" id="4991287">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991290">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991309">=</span>&nbsp;<span class="num" id="4991311">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991315">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991334">=</span>&nbsp;<span class="num" id="4991336">1</span>&nbsp;<span class="op" id="4991338">&lt;&lt;</span>&nbsp;<span class="ident" id="4991341">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991356">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991375">=</span>&nbsp;<span class="ident" id="4991377">windowSize</span>&nbsp;<span class="op" id="4991388">-</span>&nbsp;<span class="num" id="4991390">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991393">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4991412">=</span>&nbsp;<span class="num" id="4991414">15</span>&nbsp;&nbsp;<span class="comment" id="4991418">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991439">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991458">=</span>&nbsp;<span class="num" id="4991460">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4991464">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991517">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991536">=</span>&nbsp;<span class="num" id="4991538">258</span>&nbsp;<span class="comment" id="4991542">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991583">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991602">=</span>&nbsp;<span class="num" id="4991604">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4991608">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991654">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991729">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991769">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4991789">=</span>&nbsp;<span class="num" id="4991791">1</span>&nbsp;<span class="op" id="4991793">&lt;&lt;</span>&nbsp;<span class="num" id="4991796">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991800">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4991820">=</span>&nbsp;<span class="num" id="4991822">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991829">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991849">=</span>&nbsp;<span class="num" id="4991851">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991855">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991875">=</span>&nbsp;<span class="num" id="4991877">1</span>&nbsp;<span class="op" id="4991879">&lt;&lt;</span>&nbsp;<span class="ident" id="4991882">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991892">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991912">=</span>&nbsp;<span class="op" id="4991914">(</span><span class="num" id="4991915">1</span>&nbsp;<span class="op" id="4991917">&lt;&lt;</span>&nbsp;<span class="ident" id="4991920">hashBits</span><span class="op" id="4991928">)</span>&nbsp;<span class="op" id="4991930">-</span>&nbsp;<span class="num" id="4991932">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991935">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991955">=</span>&nbsp;<span class="op" id="4991957">(</span><span class="ident" id="4991958">hashBits</span>&nbsp;<span class="op" id="4991967">+</span>&nbsp;<span class="ident" id="4991969">minMatchLength</span>&nbsp;<span class="op" id="4991984">-</span>&nbsp;<span class="num" id="4991986">1</span><span class="op" id="4991987">)</span>&nbsp;<span class="op" id="4991989">/</span>&nbsp;<span class="ident" id="4991991">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992007">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4992027">=</span>&nbsp;<span class="num" id="4992029">1</span>&nbsp;<span class="op" id="4992031">&lt;&lt;</span>&nbsp;<span class="num" id="4992034">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992039">skipNever</span>&nbsp;<span class="op" id="4992049">=</span>&nbsp;<span class="ident" id="4992051">math</span><span class="op" id="4992055">.</span><span class="ident" id="4992056">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4992065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4992068">type</span>&nbsp;<span class="ident" id="4992073">compressionLevel</span>&nbsp;<span class="keyword" id="4992090">struct</span>&nbsp;<span class="op" id="4992097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992100">good</span><span class="op" id="4992104">,</span>&nbsp;<span class="ident" id="4992106">lazy</span><span class="op" id="4992110">,</span>&nbsp;<span class="ident" id="4992112">nice</span><span class="op" id="4992116">,</span>&nbsp;<span class="ident" id="4992118">chain</span><span class="op" id="4992123">,</span>&nbsp;<span class="ident" id="4992125">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4992141">int</span><br>
<span class="lineno"></span><span class="op" id="4992145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4992148">var</span>&nbsp;<span class="ident" id="4992152">levels</span>&nbsp;<span class="op" id="4992159">=</span>&nbsp;<span class="op" id="4992161">[</span><span class="op" id="4992162">]</span><span class="ident" id="4992163">compressionLevel</span><span class="op" id="4992179">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992182">{</span><span class="op" id="4992183">}</span><span class="op" id="4992184">,</span>&nbsp;<span class="comment" id="4992186">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992192">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992252">{</span><span class="num" id="4992253">3</span><span class="op" id="4992254">,</span>&nbsp;<span class="num" id="4992256">0</span><span class="op" id="4992257">,</span>&nbsp;<span class="num" id="4992259">8</span><span class="op" id="4992260">,</span>&nbsp;<span class="num" id="4992262">4</span><span class="op" id="4992263">,</span>&nbsp;<span class="num" id="4992265">4</span><span class="op" id="4992266">}</span><span class="op" id="4992267">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992270">{</span><span class="num" id="4992271">3</span><span class="op" id="4992272">,</span>&nbsp;<span class="num" id="4992274">0</span><span class="op" id="4992275">,</span>&nbsp;<span class="num" id="4992277">16</span><span class="op" id="4992279">,</span>&nbsp;<span class="num" id="4992281">8</span><span class="op" id="4992282">,</span>&nbsp;<span class="num" id="4992284">5</span><span class="op" id="4992285">}</span><span class="op" id="4992286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992289">{</span><span class="num" id="4992290">3</span><span class="op" id="4992291">,</span>&nbsp;<span class="num" id="4992293">0</span><span class="op" id="4992294">,</span>&nbsp;<span class="num" id="4992296">32</span><span class="op" id="4992298">,</span>&nbsp;<span class="num" id="4992300">32</span><span class="op" id="4992302">,</span>&nbsp;<span class="num" id="4992304">6</span><span class="op" id="4992305">}</span><span class="op" id="4992306">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992309">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992360">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992421">{</span><span class="num" id="4992422">4</span><span class="op" id="4992423">,</span>&nbsp;<span class="num" id="4992425">4</span><span class="op" id="4992426">,</span>&nbsp;<span class="num" id="4992428">16</span><span class="op" id="4992430">,</span>&nbsp;<span class="num" id="4992432">16</span><span class="op" id="4992434">,</span>&nbsp;<span class="ident" id="4992436">skipNever</span><span class="op" id="4992445">}</span><span class="op" id="4992446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992449">{</span><span class="num" id="4992450">8</span><span class="op" id="4992451">,</span>&nbsp;<span class="num" id="4992453">16</span><span class="op" id="4992455">,</span>&nbsp;<span class="num" id="4992457">32</span><span class="op" id="4992459">,</span>&nbsp;<span class="num" id="4992461">32</span><span class="op" id="4992463">,</span>&nbsp;<span class="ident" id="4992465">skipNever</span><span class="op" id="4992474">}</span><span class="op" id="4992475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992478">{</span><span class="num" id="4992479">8</span><span class="op" id="4992480">,</span>&nbsp;<span class="num" id="4992482">16</span><span class="op" id="4992484">,</span>&nbsp;<span class="num" id="4992486">128</span><span class="op" id="4992489">,</span>&nbsp;<span class="num" id="4992491">128</span><span class="op" id="4992494">,</span>&nbsp;<span class="ident" id="4992496">skipNever</span><span class="op" id="4992505">}</span><span class="op" id="4992506">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992509">{</span><span class="num" id="4992510">8</span><span class="op" id="4992511">,</span>&nbsp;<span class="num" id="4992513">32</span><span class="op" id="4992515">,</span>&nbsp;<span class="num" id="4992517">128</span><span class="op" id="4992520">,</span>&nbsp;<span class="num" id="4992522">256</span><span class="op" id="4992525">,</span>&nbsp;<span class="ident" id="4992527">skipNever</span><span class="op" id="4992536">}</span><span class="op" id="4992537">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992540">{</span><span class="num" id="4992541">32</span><span class="op" id="4992543">,</span>&nbsp;<span class="num" id="4992545">128</span><span class="op" id="4992548">,</span>&nbsp;<span class="num" id="4992550">258</span><span class="op" id="4992553">,</span>&nbsp;<span class="num" id="4992555">1024</span><span class="op" id="4992559">,</span>&nbsp;<span class="ident" id="4992561">skipNever</span><span class="op" id="4992570">}</span><span class="op" id="4992571">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992574">{</span><span class="num" id="4992575">32</span><span class="op" id="4992577">,</span>&nbsp;<span class="num" id="4992579">258</span><span class="op" id="4992582">,</span>&nbsp;<span class="num" id="4992584">258</span><span class="op" id="4992587">,</span>&nbsp;<span class="num" id="4992589">4096</span><span class="op" id="4992593">,</span>&nbsp;<span class="ident" id="4992595">skipNever</span><span class="op" id="4992604">}</span><span class="op" id="4992605">,</span><br>
<span class="lineno"></span><span class="op" id="4992607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4992610">type</span>&nbsp;<span class="ident" id="4992615">compressor</span>&nbsp;<span class="keyword" id="4992626">struct</span>&nbsp;<span class="op" id="4992633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992636">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992655">w</span>&nbsp;<span class="op" id="4992657">*</span><span class="ident" id="4992658">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992677">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992703">fill</span>&nbsp;<span class="keyword" id="4992708">func</span><span class="op" id="4992712">(</span><span class="op" id="4992713">*</span><span class="ident" id="4992714">compressor</span><span class="op" id="4992724">,</span>&nbsp;<span class="op" id="4992726">[</span><span class="op" id="4992727">]</span><span class="builtintype" id="4992728">byte</span><span class="op" id="4992732">)</span>&nbsp;<span class="builtintype" id="4992734">int</span>&nbsp;<span class="comment" id="4992738">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992762">step</span>&nbsp;<span class="keyword" id="4992767">func</span><span class="op" id="4992771">(</span><span class="op" id="4992772">*</span><span class="ident" id="4992773">compressor</span><span class="op" id="4992783">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4992797">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992816">sync</span>&nbsp;<span class="builtintype" id="4992821">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4992851">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992873">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992895">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992981">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993043">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993118">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993148">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4993159">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993164">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4993175">[</span><span class="op" id="4993176">]</span><span class="builtintype" id="4993177">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993182">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4993193">[</span><span class="op" id="4993194">]</span><span class="builtintype" id="4993195">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993200">hashOffset</span>&nbsp;<span class="builtintype" id="4993211">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993217">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993279">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993293">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993298">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993312">[</span><span class="op" id="4993313">]</span><span class="builtintype" id="4993314">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993320">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993334">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993339">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993353">int</span>&nbsp;&nbsp;<span class="comment" id="4993358">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993402">byteAvailable</span>&nbsp;<span class="builtintype" id="4993416">bool</span>&nbsp;<span class="comment" id="4993421">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993474">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993499">tokens</span>&nbsp;<span class="op" id="4993506">[</span><span class="op" id="4993507">]</span><span class="ident" id="4993508">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993516">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993534">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993549">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993554">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993569">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993574">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993589">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993594">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4993609">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993614">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4993629">error</span><br>
<span class="lineno"></span><span class="op" id="4993635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4993638">func</span>&nbsp;<span class="op" id="4993643">(</span><span class="ident" id="4993644">d</span>&nbsp;<span class="op" id="4993646">*</span><span class="ident" id="4993647">compressor</span><span class="op" id="4993657">)</span>&nbsp;<span class="ident" id="4993659">fillDeflate</span><span class="op" id="4993670">(</span><span class="ident" id="4993671">b</span>&nbsp;<span class="op" id="4993673">[</span><span class="op" id="4993674">]</span><span class="builtintype" id="4993675">byte</span><span class="op" id="4993679">)</span>&nbsp;<span class="builtintype" id="4993681">int</span>&nbsp;<span class="op" id="4993685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993688">if</span>&nbsp;<span class="ident" id="4993691">d</span><span class="op" id="4993692">.</span><span class="ident" id="4993693">index</span>&nbsp;<span class="op" id="4993699">&gt;=</span>&nbsp;<span class="num" id="4993702">2</span><span class="op" id="4993703">*</span><span class="ident" id="4993704">windowSize</span><span class="op" id="4993714">-</span><span class="op" id="4993715">(</span><span class="ident" id="4993716">minMatchLength</span><span class="op" id="4993730">+</span><span class="ident" id="4993731">maxMatchLength</span><span class="op" id="4993745">)</span>&nbsp;<span class="op" id="4993747">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993751">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4993787">copy</span><span class="op" id="4993791">(</span><span class="ident" id="4993792">d</span><span class="op" id="4993793">.</span><span class="ident" id="4993794">window</span><span class="op" id="4993800">,</span>&nbsp;<span class="ident" id="4993802">d</span><span class="op" id="4993803">.</span><span class="ident" id="4993804">window</span><span class="op" id="4993810">[</span><span class="ident" id="4993811">windowSize</span><span class="op" id="4993821">:</span><span class="num" id="4993822">2</span><span class="op" id="4993823">*</span><span class="ident" id="4993824">windowSize</span><span class="op" id="4993834">]</span><span class="op" id="4993835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993839">d</span><span class="op" id="4993840">.</span><span class="ident" id="4993841">index</span>&nbsp;<span class="op" id="4993847">-=</span>&nbsp;<span class="ident" id="4993850">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993863">d</span><span class="op" id="4993864">.</span><span class="ident" id="4993865">windowEnd</span>&nbsp;<span class="op" id="4993875">-=</span>&nbsp;<span class="ident" id="4993878">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993891">if</span>&nbsp;<span class="ident" id="4993894">d</span><span class="op" id="4993895">.</span><span class="ident" id="4993896">blockStart</span>&nbsp;<span class="op" id="4993907">&gt;=</span>&nbsp;<span class="ident" id="4993910">windowSize</span>&nbsp;<span class="op" id="4993921">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993926">d</span><span class="op" id="4993927">.</span><span class="ident" id="4993928">blockStart</span>&nbsp;<span class="op" id="4993939">-=</span>&nbsp;<span class="ident" id="4993942">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993955">}</span>&nbsp;<span class="keyword" id="4993957">else</span>&nbsp;<span class="op" id="4993962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993967">d</span><span class="op" id="4993968">.</span><span class="ident" id="4993969">blockStart</span>&nbsp;<span class="op" id="4993980">=</span>&nbsp;<span class="ident" id="4993982">math</span><span class="op" id="4993986">.</span><span class="ident" id="4993987">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994002">d</span><span class="op" id="4994003">.</span><span class="ident" id="4994004">hashOffset</span>&nbsp;<span class="op" id="4994015">+=</span>&nbsp;<span class="ident" id="4994018">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994031">if</span>&nbsp;<span class="ident" id="4994034">d</span><span class="op" id="4994035">.</span><span class="ident" id="4994036">hashOffset</span>&nbsp;<span class="op" id="4994047">&gt;</span>&nbsp;<span class="ident" id="4994049">maxHashOffset</span>&nbsp;<span class="op" id="4994063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994068">delta</span>&nbsp;<span class="op" id="4994074">:=</span>&nbsp;<span class="ident" id="4994077">d</span><span class="op" id="4994078">.</span><span class="ident" id="4994079">hashOffset</span>&nbsp;<span class="op" id="4994090">-</span>&nbsp;<span class="num" id="4994092">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994097">d</span><span class="op" id="4994098">.</span><span class="ident" id="4994099">hashOffset</span>&nbsp;<span class="op" id="4994110">-=</span>&nbsp;<span class="ident" id="4994113">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994122">d</span><span class="op" id="4994123">.</span><span class="ident" id="4994124">chainHead</span>&nbsp;<span class="op" id="4994134">-=</span>&nbsp;<span class="ident" id="4994137">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994146">for</span>&nbsp;<span class="ident" id="4994150">i</span><span class="op" id="4994151">,</span>&nbsp;<span class="ident" id="4994153">v</span>&nbsp;<span class="op" id="4994155">:=</span>&nbsp;<span class="keyword" id="4994158">range</span>&nbsp;<span class="ident" id="4994164">d</span><span class="op" id="4994165">.</span><span class="ident" id="4994166">hashPrev</span>&nbsp;<span class="op" id="4994175">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994181">if</span>&nbsp;<span class="ident" id="4994184">v</span>&nbsp;<span class="op" id="4994186">&gt;</span>&nbsp;<span class="ident" id="4994188">delta</span>&nbsp;<span class="op" id="4994194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994201">d</span><span class="op" id="4994202">.</span><span class="ident" id="4994203">hashPrev</span><span class="op" id="4994211">[</span><span class="ident" id="4994212">i</span><span class="op" id="4994213">]</span>&nbsp;<span class="op" id="4994215">-=</span>&nbsp;<span class="ident" id="4994218">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994228">}</span>&nbsp;<span class="keyword" id="4994230">else</span>&nbsp;<span class="op" id="4994235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994242">d</span><span class="op" id="4994243">.</span><span class="ident" id="4994244">hashPrev</span><span class="op" id="4994252">[</span><span class="ident" id="4994253">i</span><span class="op" id="4994254">]</span>&nbsp;<span class="op" id="4994256">=</span>&nbsp;<span class="num" id="4994258">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994264">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994274">for</span>&nbsp;<span class="ident" id="4994278">i</span><span class="op" id="4994279">,</span>&nbsp;<span class="ident" id="4994281">v</span>&nbsp;<span class="op" id="4994283">:=</span>&nbsp;<span class="keyword" id="4994286">range</span>&nbsp;<span class="ident" id="4994292">d</span><span class="op" id="4994293">.</span><span class="ident" id="4994294">hashHead</span>&nbsp;<span class="op" id="4994303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994309">if</span>&nbsp;<span class="ident" id="4994312">v</span>&nbsp;<span class="op" id="4994314">&gt;</span>&nbsp;<span class="ident" id="4994316">delta</span>&nbsp;<span class="op" id="4994322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994329">d</span><span class="op" id="4994330">.</span><span class="ident" id="4994331">hashHead</span><span class="op" id="4994339">[</span><span class="ident" id="4994340">i</span><span class="op" id="4994341">]</span>&nbsp;<span class="op" id="4994343">-=</span>&nbsp;<span class="ident" id="4994346">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994356">}</span>&nbsp;<span class="keyword" id="4994358">else</span>&nbsp;<span class="op" id="4994363">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994370">d</span><span class="op" id="4994371">.</span><span class="ident" id="4994372">hashHead</span><span class="op" id="4994380">[</span><span class="ident" id="4994381">i</span><span class="op" id="4994382">]</span>&nbsp;<span class="op" id="4994384">=</span>&nbsp;<span class="num" id="4994386">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994404">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994407">n</span>&nbsp;<span class="op" id="4994409">:=</span>&nbsp;<span class="builtinfunc" id="4994412">copy</span><span class="op" id="4994416">(</span><span class="ident" id="4994417">d</span><span class="op" id="4994418">.</span><span class="ident" id="4994419">window</span><span class="op" id="4994425">[</span><span class="ident" id="4994426">d</span><span class="op" id="4994427">.</span><span class="ident" id="4994428">windowEnd</span><span class="op" id="4994437">:</span><span class="op" id="4994438">]</span><span class="op" id="4994439">,</span>&nbsp;<span class="ident" id="4994441">b</span><span class="op" id="4994442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994445">d</span><span class="op" id="4994446">.</span><span class="ident" id="4994447">windowEnd</span>&nbsp;<span class="op" id="4994457">+=</span>&nbsp;<span class="ident" id="4994460">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994463">return</span>&nbsp;<span class="ident" id="4994470">n</span><br>
<span class="lineno"></span><span class="op" id="4994472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4994475">func</span>&nbsp;<span class="op" id="4994480">(</span><span class="ident" id="4994481">d</span>&nbsp;<span class="op" id="4994483">*</span><span class="ident" id="4994484">compressor</span><span class="op" id="4994494">)</span>&nbsp;<span class="ident" id="4994496">writeBlock</span><span class="op" id="4994506">(</span><span class="ident" id="4994507">tokens</span>&nbsp;<span class="op" id="4994514">[</span><span class="op" id="4994515">]</span><span class="ident" id="4994516">token</span><span class="op" id="4994521">,</span>&nbsp;<span class="ident" id="4994523">index</span>&nbsp;<span class="builtintype" id="4994529">int</span><span class="op" id="4994532">,</span>&nbsp;<span class="ident" id="4994534">eof</span>&nbsp;<span class="builtintype" id="4994538">bool</span><span class="op" id="4994542">)</span>&nbsp;<span class="builtintype" id="4994544">error</span>&nbsp;<span class="op" id="4994550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994553">if</span>&nbsp;<span class="ident" id="4994556">index</span>&nbsp;<span class="op" id="4994562">&gt;</span>&nbsp;<span class="num" id="4994564">0</span>&nbsp;<span class="op" id="4994566">||</span>&nbsp;<span class="ident" id="4994569">eof</span>&nbsp;<span class="op" id="4994573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994577">var</span>&nbsp;<span class="ident" id="4994581">window</span>&nbsp;<span class="op" id="4994588">[</span><span class="op" id="4994589">]</span><span class="builtintype" id="4994590">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994597">if</span>&nbsp;<span class="ident" id="4994600">d</span><span class="op" id="4994601">.</span><span class="ident" id="4994602">blockStart</span>&nbsp;<span class="op" id="4994613">&lt;=</span>&nbsp;<span class="ident" id="4994616">index</span>&nbsp;<span class="op" id="4994622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994627">window</span>&nbsp;<span class="op" id="4994634">=</span>&nbsp;<span class="ident" id="4994636">d</span><span class="op" id="4994637">.</span><span class="ident" id="4994638">window</span><span class="op" id="4994644">[</span><span class="ident" id="4994645">d</span><span class="op" id="4994646">.</span><span class="ident" id="4994647">blockStart</span><span class="op" id="4994657">:</span><span class="ident" id="4994658">index</span><span class="op" id="4994663">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994671">d</span><span class="op" id="4994672">.</span><span class="ident" id="4994673">blockStart</span>&nbsp;<span class="op" id="4994684">=</span>&nbsp;<span class="ident" id="4994686">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994694">d</span><span class="op" id="4994695">.</span><span class="ident" id="4994696">w</span><span class="op" id="4994697">.</span><span class="ident" id="4994698">writeBlock</span><span class="op" id="4994708">(</span><span class="ident" id="4994709">tokens</span><span class="op" id="4994715">,</span>&nbsp;<span class="ident" id="4994717">eof</span><span class="op" id="4994720">,</span>&nbsp;<span class="ident" id="4994722">window</span><span class="op" id="4994728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994732">return</span>&nbsp;<span class="ident" id="4994739">d</span><span class="op" id="4994740">.</span><span class="ident" id="4994741">w</span><span class="op" id="4994742">.</span><span class="ident" id="4994743">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994748">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994751">return</span>&nbsp;<span class="ident" id="4994758">nil</span><br>
<span class="lineno"></span><span class="op" id="4994762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994765">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4994845">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4994907">func</span>&nbsp;<span class="op" id="4994912">(</span><span class="ident" id="4994913">d</span>&nbsp;<span class="op" id="4994915">*</span><span class="ident" id="4994916">compressor</span><span class="op" id="4994926">)</span>&nbsp;<span class="ident" id="4994928">findMatch</span><span class="op" id="4994937">(</span><span class="ident" id="4994938">pos</span>&nbsp;<span class="builtintype" id="4994942">int</span><span class="op" id="4994945">,</span>&nbsp;<span class="ident" id="4994947">prevHead</span>&nbsp;<span class="builtintype" id="4994956">int</span><span class="op" id="4994959">,</span>&nbsp;<span class="ident" id="4994961">prevLength</span>&nbsp;<span class="builtintype" id="4994972">int</span><span class="op" id="4994975">,</span>&nbsp;<span class="ident" id="4994977">lookahead</span>&nbsp;<span class="builtintype" id="4994987">int</span><span class="op" id="4994990">)</span>&nbsp;<span class="op" id="4994992">(</span><span class="ident" id="4994993">length</span><span class="op" id="4994999">,</span>&nbsp;<span class="ident" id="4995001">offset</span>&nbsp;<span class="builtintype" id="4995008">int</span><span class="op" id="4995011">,</span>&nbsp;<span class="ident" id="4995013">ok</span>&nbsp;<span class="builtintype" id="4995016">bool</span><span class="op" id="4995020">)</span>&nbsp;<span class="op" id="4995022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995025">minMatchLook</span>&nbsp;<span class="op" id="4995038">:=</span>&nbsp;<span class="ident" id="4995041">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995057">if</span>&nbsp;<span class="ident" id="4995060">lookahead</span>&nbsp;<span class="op" id="4995070">&lt;</span>&nbsp;<span class="ident" id="4995072">minMatchLook</span>&nbsp;<span class="op" id="4995085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995089">minMatchLook</span>&nbsp;<span class="op" id="4995102">=</span>&nbsp;<span class="ident" id="4995104">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995115">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995119">win</span>&nbsp;<span class="op" id="4995123">:=</span>&nbsp;<span class="ident" id="4995126">d</span><span class="op" id="4995127">.</span><span class="ident" id="4995128">window</span><span class="op" id="4995134">[</span><span class="num" id="4995135">0</span>&nbsp;<span class="op" id="4995137">:</span>&nbsp;<span class="ident" id="4995139">pos</span><span class="op" id="4995142">+</span><span class="ident" id="4995143">minMatchLook</span><span class="op" id="4995155">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995159">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995217">nice</span>&nbsp;<span class="op" id="4995222">:=</span>&nbsp;<span class="builtinfunc" id="4995225">len</span><span class="op" id="4995228">(</span><span class="ident" id="4995229">win</span><span class="op" id="4995232">)</span>&nbsp;<span class="op" id="4995234">-</span>&nbsp;<span class="ident" id="4995236">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995241">if</span>&nbsp;<span class="ident" id="4995244">d</span><span class="op" id="4995245">.</span><span class="ident" id="4995246">nice</span>&nbsp;<span class="op" id="4995251">&lt;</span>&nbsp;<span class="ident" id="4995253">nice</span>&nbsp;<span class="op" id="4995258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995262">nice</span>&nbsp;<span class="op" id="4995267">=</span>&nbsp;<span class="ident" id="4995269">d</span><span class="op" id="4995270">.</span><span class="ident" id="4995271">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995281">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995354">tries</span>&nbsp;<span class="op" id="4995360">:=</span>&nbsp;<span class="ident" id="4995363">d</span><span class="op" id="4995364">.</span><span class="ident" id="4995365">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995372">length</span>&nbsp;<span class="op" id="4995379">=</span>&nbsp;<span class="ident" id="4995381">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995393">if</span>&nbsp;<span class="ident" id="4995396">length</span>&nbsp;<span class="op" id="4995403">&gt;=</span>&nbsp;<span class="ident" id="4995406">d</span><span class="op" id="4995407">.</span><span class="ident" id="4995408">good</span>&nbsp;<span class="op" id="4995413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995417">tries</span>&nbsp;<span class="op" id="4995423">&gt;&gt;=</span>&nbsp;<span class="num" id="4995427">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995430">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995434">w0</span>&nbsp;<span class="op" id="4995437">:=</span>&nbsp;<span class="ident" id="4995440">win</span><span class="op" id="4995443">[</span><span class="ident" id="4995444">pos</span><span class="op" id="4995447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995450">w1</span>&nbsp;<span class="op" id="4995453">:=</span>&nbsp;<span class="ident" id="4995456">win</span><span class="op" id="4995459">[</span><span class="ident" id="4995460">pos</span><span class="op" id="4995463">+</span><span class="num" id="4995464">1</span><span class="op" id="4995465">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995468">wEnd</span>&nbsp;<span class="op" id="4995473">:=</span>&nbsp;<span class="ident" id="4995476">win</span><span class="op" id="4995479">[</span><span class="ident" id="4995480">pos</span><span class="op" id="4995483">+</span><span class="ident" id="4995484">length</span><span class="op" id="4995490">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995493">minIndex</span>&nbsp;<span class="op" id="4995502">:=</span>&nbsp;<span class="ident" id="4995505">pos</span>&nbsp;<span class="op" id="4995509">-</span>&nbsp;<span class="ident" id="4995511">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995524">for</span>&nbsp;<span class="ident" id="4995528">i</span>&nbsp;<span class="op" id="4995530">:=</span>&nbsp;<span class="ident" id="4995533">prevHead</span><span class="op" id="4995541">;</span>&nbsp;<span class="ident" id="4995543">tries</span>&nbsp;<span class="op" id="4995549">&gt;</span>&nbsp;<span class="num" id="4995551">0</span><span class="op" id="4995552">;</span>&nbsp;<span class="ident" id="4995554">tries</span><span class="op" id="4995559">--</span>&nbsp;<span class="op" id="4995562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995566">if</span>&nbsp;<span class="ident" id="4995569">w0</span>&nbsp;<span class="op" id="4995572">==</span>&nbsp;<span class="ident" id="4995575">win</span><span class="op" id="4995578">[</span><span class="ident" id="4995579">i</span><span class="op" id="4995580">]</span>&nbsp;<span class="op" id="4995582">&amp;&amp;</span>&nbsp;<span class="ident" id="4995585">w1</span>&nbsp;<span class="op" id="4995588">==</span>&nbsp;<span class="ident" id="4995591">win</span><span class="op" id="4995594">[</span><span class="ident" id="4995595">i</span><span class="op" id="4995596">+</span><span class="num" id="4995597">1</span><span class="op" id="4995598">]</span>&nbsp;<span class="op" id="4995600">&amp;&amp;</span>&nbsp;<span class="ident" id="4995603">wEnd</span>&nbsp;<span class="op" id="4995608">==</span>&nbsp;<span class="ident" id="4995611">win</span><span class="op" id="4995614">[</span><span class="ident" id="4995615">i</span><span class="op" id="4995616">+</span><span class="ident" id="4995617">length</span><span class="op" id="4995623">]</span>&nbsp;<span class="op" id="4995625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995630">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995715">n</span>&nbsp;<span class="op" id="4995717">:=</span>&nbsp;<span class="num" id="4995720">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995725">for</span>&nbsp;<span class="ident" id="4995729">pos</span><span class="op" id="4995732">+</span><span class="ident" id="4995733">n</span>&nbsp;<span class="op" id="4995735">&lt;</span>&nbsp;<span class="builtinfunc" id="4995737">len</span><span class="op" id="4995740">(</span><span class="ident" id="4995741">win</span><span class="op" id="4995744">)</span>&nbsp;<span class="op" id="4995746">&amp;&amp;</span>&nbsp;<span class="ident" id="4995749">win</span><span class="op" id="4995752">[</span><span class="ident" id="4995753">i</span><span class="op" id="4995754">+</span><span class="ident" id="4995755">n</span><span class="op" id="4995756">]</span>&nbsp;<span class="op" id="4995758">==</span>&nbsp;<span class="ident" id="4995761">win</span><span class="op" id="4995764">[</span><span class="ident" id="4995765">pos</span><span class="op" id="4995768">+</span><span class="ident" id="4995769">n</span><span class="op" id="4995770">]</span>&nbsp;<span class="op" id="4995772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995778">n</span><span class="op" id="4995779">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995790">if</span>&nbsp;<span class="ident" id="4995793">n</span>&nbsp;<span class="op" id="4995795">&gt;</span>&nbsp;<span class="ident" id="4995797">length</span>&nbsp;<span class="op" id="4995804">&amp;&amp;</span>&nbsp;<span class="op" id="4995807">(</span><span class="ident" id="4995808">n</span>&nbsp;<span class="op" id="4995810">&gt;</span>&nbsp;<span class="num" id="4995812">3</span>&nbsp;<span class="op" id="4995814">||</span>&nbsp;<span class="ident" id="4995817">pos</span><span class="op" id="4995820">-</span><span class="ident" id="4995821">i</span>&nbsp;<span class="op" id="4995823">&lt;=</span>&nbsp;<span class="num" id="4995826">4096</span><span class="op" id="4995830">)</span>&nbsp;<span class="op" id="4995832">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995838">length</span>&nbsp;<span class="op" id="4995845">=</span>&nbsp;<span class="ident" id="4995847">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995853">offset</span>&nbsp;<span class="op" id="4995860">=</span>&nbsp;<span class="ident" id="4995862">pos</span>&nbsp;<span class="op" id="4995866">-</span>&nbsp;<span class="ident" id="4995868">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995874">ok</span>&nbsp;<span class="op" id="4995877">=</span>&nbsp;<span class="builtintype" id="4995879">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995888">if</span>&nbsp;<span class="ident" id="4995891">n</span>&nbsp;<span class="op" id="4995893">&gt;=</span>&nbsp;<span class="ident" id="4995896">nice</span>&nbsp;<span class="op" id="4995901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995908">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995981">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995997">wEnd</span>&nbsp;<span class="op" id="4996002">=</span>&nbsp;<span class="ident" id="4996004">win</span><span class="op" id="4996007">[</span><span class="ident" id="4996008">pos</span><span class="op" id="4996011">+</span><span class="ident" id="4996012">n</span><span class="op" id="4996013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996022">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996026">if</span>&nbsp;<span class="ident" id="4996029">i</span>&nbsp;<span class="op" id="4996031">==</span>&nbsp;<span class="ident" id="4996034">minIndex</span>&nbsp;<span class="op" id="4996043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996048">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996122">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996134">if</span>&nbsp;<span class="ident" id="4996137">i</span>&nbsp;<span class="op" id="4996139">=</span>&nbsp;<span class="ident" id="4996141">d</span><span class="op" id="4996142">.</span><span class="ident" id="4996143">hashPrev</span><span class="op" id="4996151">[</span><span class="ident" id="4996152">i</span><span class="op" id="4996153">&amp;</span><span class="ident" id="4996154">windowMask</span><span class="op" id="4996164">]</span>&nbsp;<span class="op" id="4996166">-</span>&nbsp;<span class="ident" id="4996168">d</span><span class="op" id="4996169">.</span><span class="ident" id="4996170">hashOffset</span><span class="op" id="4996180">;</span>&nbsp;<span class="ident" id="4996182">i</span>&nbsp;<span class="op" id="4996184">&lt;</span>&nbsp;<span class="ident" id="4996186">minIndex</span>&nbsp;<span class="op" id="4996195">||</span>&nbsp;<span class="ident" id="4996198">i</span>&nbsp;<span class="op" id="4996200">&lt;</span>&nbsp;<span class="num" id="4996202">0</span>&nbsp;<span class="op" id="4996204">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996209">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996223">return</span><br>
<span class="lineno"></span><span class="op" id="4996230">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4996233">func</span>&nbsp;<span class="op" id="4996238">(</span><span class="ident" id="4996239">d</span>&nbsp;<span class="op" id="4996241">*</span><span class="ident" id="4996242">compressor</span><span class="op" id="4996252">)</span>&nbsp;<span class="ident" id="4996254">writeStoredBlock</span><span class="op" id="4996270">(</span><span class="ident" id="4996271">buf</span>&nbsp;<span class="op" id="4996275">[</span><span class="op" id="4996276">]</span><span class="builtintype" id="4996277">byte</span><span class="op" id="4996281">)</span>&nbsp;<span class="builtintype" id="4996283">error</span>&nbsp;<span class="op" id="4996289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996292">if</span>&nbsp;<span class="ident" id="4996295">d</span><span class="op" id="4996296">.</span><span class="ident" id="4996297">w</span><span class="op" id="4996298">.</span><span class="ident" id="4996299">writeStoredHeader</span><span class="op" id="4996316">(</span><span class="builtinfunc" id="4996317">len</span><span class="op" id="4996320">(</span><span class="ident" id="4996321">buf</span><span class="op" id="4996324">)</span><span class="op" id="4996325">,</span>&nbsp;<span class="builtintype" id="4996327">false</span><span class="op" id="4996332">)</span><span class="op" id="4996333">;</span>&nbsp;<span class="ident" id="4996335">d</span><span class="op" id="4996336">.</span><span class="ident" id="4996337">w</span><span class="op" id="4996338">.</span><span class="ident" id="4996339">err</span>&nbsp;<span class="op" id="4996343">!=</span>&nbsp;<span class="ident" id="4996346">nil</span>&nbsp;<span class="op" id="4996350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996354">return</span>&nbsp;<span class="ident" id="4996361">d</span><span class="op" id="4996362">.</span><span class="ident" id="4996363">w</span><span class="op" id="4996364">.</span><span class="ident" id="4996365">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996370">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996373">d</span><span class="op" id="4996374">.</span><span class="ident" id="4996375">w</span><span class="op" id="4996376">.</span><span class="ident" id="4996377">writeBytes</span><span class="op" id="4996387">(</span><span class="ident" id="4996388">buf</span><span class="op" id="4996391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996394">return</span>&nbsp;<span class="ident" id="4996401">d</span><span class="op" id="4996402">.</span><span class="ident" id="4996403">w</span><span class="op" id="4996404">.</span><span class="ident" id="4996405">err</span><br>
<span class="lineno"></span><span class="op" id="4996409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996412">func</span>&nbsp;<span class="op" id="4996417">(</span><span class="ident" id="4996418">d</span>&nbsp;<span class="op" id="4996420">*</span><span class="ident" id="4996421">compressor</span><span class="op" id="4996431">)</span>&nbsp;<span class="ident" id="4996433">initDeflate</span><span class="op" id="4996444">(</span><span class="op" id="4996445">)</span>&nbsp;<span class="op" id="4996447">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996450">d</span><span class="op" id="4996451">.</span><span class="ident" id="4996452">hashHead</span>&nbsp;<span class="op" id="4996461">=</span>&nbsp;<span class="builtinfunc" id="4996463">make</span><span class="op" id="4996467">(</span><span class="op" id="4996468">[</span><span class="op" id="4996469">]</span><span class="builtintype" id="4996470">int</span><span class="op" id="4996473">,</span>&nbsp;<span class="ident" id="4996475">hashSize</span><span class="op" id="4996483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996486">d</span><span class="op" id="4996487">.</span><span class="ident" id="4996488">hashPrev</span>&nbsp;<span class="op" id="4996497">=</span>&nbsp;<span class="builtinfunc" id="4996499">make</span><span class="op" id="4996503">(</span><span class="op" id="4996504">[</span><span class="op" id="4996505">]</span><span class="builtintype" id="4996506">int</span><span class="op" id="4996509">,</span>&nbsp;<span class="ident" id="4996511">windowSize</span><span class="op" id="4996521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996524">d</span><span class="op" id="4996525">.</span><span class="ident" id="4996526">window</span>&nbsp;<span class="op" id="4996533">=</span>&nbsp;<span class="builtinfunc" id="4996535">make</span><span class="op" id="4996539">(</span><span class="op" id="4996540">[</span><span class="op" id="4996541">]</span><span class="builtintype" id="4996542">byte</span><span class="op" id="4996546">,</span>&nbsp;<span class="num" id="4996548">2</span><span class="op" id="4996549">*</span><span class="ident" id="4996550">windowSize</span><span class="op" id="4996560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996563">d</span><span class="op" id="4996564">.</span><span class="ident" id="4996565">hashOffset</span>&nbsp;<span class="op" id="4996576">=</span>&nbsp;<span class="num" id="4996578">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996581">d</span><span class="op" id="4996582">.</span><span class="ident" id="4996583">tokens</span>&nbsp;<span class="op" id="4996590">=</span>&nbsp;<span class="builtinfunc" id="4996592">make</span><span class="op" id="4996596">(</span><span class="op" id="4996597">[</span><span class="op" id="4996598">]</span><span class="ident" id="4996599">token</span><span class="op" id="4996604">,</span>&nbsp;<span class="num" id="4996606">0</span><span class="op" id="4996607">,</span>&nbsp;<span class="ident" id="4996609">maxFlateBlockTokens</span><span class="op" id="4996628">+</span><span class="num" id="4996629">1</span><span class="op" id="4996630">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996633">d</span><span class="op" id="4996634">.</span><span class="ident" id="4996635">length</span>&nbsp;<span class="op" id="4996642">=</span>&nbsp;<span class="ident" id="4996644">minMatchLength</span>&nbsp;<span class="op" id="4996659">-</span>&nbsp;<span class="num" id="4996661">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996664">d</span><span class="op" id="4996665">.</span><span class="ident" id="4996666">offset</span>&nbsp;<span class="op" id="4996673">=</span>&nbsp;<span class="num" id="4996675">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996678">d</span><span class="op" id="4996679">.</span><span class="ident" id="4996680">byteAvailable</span>&nbsp;<span class="op" id="4996694">=</span>&nbsp;<span class="builtintype" id="4996696">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996703">d</span><span class="op" id="4996704">.</span><span class="ident" id="4996705">index</span>&nbsp;<span class="op" id="4996711">=</span>&nbsp;<span class="num" id="4996713">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996716">d</span><span class="op" id="4996717">.</span><span class="ident" id="4996718">hash</span>&nbsp;<span class="op" id="4996723">=</span>&nbsp;<span class="num" id="4996725">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996728">d</span><span class="op" id="4996729">.</span><span class="ident" id="4996730">chainHead</span>&nbsp;<span class="op" id="4996740">=</span>&nbsp;<span class="op" id="4996742">-</span><span class="num" id="4996743">1</span><br>
<span class="lineno"></span><span class="op" id="4996745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996748">func</span>&nbsp;<span class="op" id="4996753">(</span><span class="ident" id="4996754">d</span>&nbsp;<span class="op" id="4996756">*</span><span class="ident" id="4996757">compressor</span><span class="op" id="4996767">)</span>&nbsp;<span class="ident" id="4996769">deflate</span><span class="op" id="4996776">(</span><span class="op" id="4996777">)</span>&nbsp;<span class="op" id="4996779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996782">if</span>&nbsp;<span class="ident" id="4996785">d</span><span class="op" id="4996786">.</span><span class="ident" id="4996787">windowEnd</span><span class="op" id="4996796">-</span><span class="ident" id="4996797">d</span><span class="op" id="4996798">.</span><span class="ident" id="4996799">index</span>&nbsp;<span class="op" id="4996805">&lt;</span>&nbsp;<span class="ident" id="4996807">minMatchLength</span><span class="op" id="4996821">+</span><span class="ident" id="4996822">maxMatchLength</span>&nbsp;<span class="op" id="4996837">&amp;&amp;</span>&nbsp;<span class="op" id="4996840">!</span><span class="ident" id="4996841">d</span><span class="op" id="4996842">.</span><span class="ident" id="4996843">sync</span>&nbsp;<span class="op" id="4996848">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996852">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996864">d</span><span class="op" id="4996865">.</span><span class="ident" id="4996866">maxInsertIndex</span>&nbsp;<span class="op" id="4996881">=</span>&nbsp;<span class="ident" id="4996883">d</span><span class="op" id="4996884">.</span><span class="ident" id="4996885">windowEnd</span>&nbsp;<span class="op" id="4996895">-</span>&nbsp;<span class="op" id="4996897">(</span><span class="ident" id="4996898">minMatchLength</span>&nbsp;<span class="op" id="4996913">-</span>&nbsp;<span class="num" id="4996915">1</span><span class="op" id="4996916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996919">if</span>&nbsp;<span class="ident" id="4996922">d</span><span class="op" id="4996923">.</span><span class="ident" id="4996924">index</span>&nbsp;<span class="op" id="4996930">&lt;</span>&nbsp;<span class="ident" id="4996932">d</span><span class="op" id="4996933">.</span><span class="ident" id="4996934">maxInsertIndex</span>&nbsp;<span class="op" id="4996949">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996953">d</span><span class="op" id="4996954">.</span><span class="ident" id="4996955">hash</span>&nbsp;<span class="op" id="4996960">=</span>&nbsp;<span class="builtintype" id="4996962">int</span><span class="op" id="4996965">(</span><span class="ident" id="4996966">d</span><span class="op" id="4996967">.</span><span class="ident" id="4996968">window</span><span class="op" id="4996974">[</span><span class="ident" id="4996975">d</span><span class="op" id="4996976">.</span><span class="ident" id="4996977">index</span><span class="op" id="4996982">]</span><span class="op" id="4996983">)</span><span class="op" id="4996984">&lt;&lt;</span><span class="ident" id="4996986">hashShift</span>&nbsp;<span class="op" id="4996996">+</span>&nbsp;<span class="builtintype" id="4996998">int</span><span class="op" id="4997001">(</span><span class="ident" id="4997002">d</span><span class="op" id="4997003">.</span><span class="ident" id="4997004">window</span><span class="op" id="4997010">[</span><span class="ident" id="4997011">d</span><span class="op" id="4997012">.</span><span class="ident" id="4997013">index</span><span class="op" id="4997018">+</span><span class="num" id="4997019">1</span><span class="op" id="4997020">]</span><span class="op" id="4997021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4997027">Loop</span><span class="op" id="4997031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997034">for</span>&nbsp;<span class="op" id="4997038">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997042">if</span>&nbsp;<span class="ident" id="4997045">d</span><span class="op" id="4997046">.</span><span class="ident" id="4997047">index</span>&nbsp;<span class="op" id="4997053">&gt;</span>&nbsp;<span class="ident" id="4997055">d</span><span class="op" id="4997056">.</span><span class="ident" id="4997057">windowEnd</span>&nbsp;<span class="op" id="4997067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4997072">panic</span><span class="op" id="4997077">(</span><span class="string" id="4997078">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4997097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997105">lookahead</span>&nbsp;<span class="op" id="4997115">:=</span>&nbsp;<span class="ident" id="4997118">d</span><span class="op" id="4997119">.</span><span class="ident" id="4997120">windowEnd</span>&nbsp;<span class="op" id="4997130">-</span>&nbsp;<span class="ident" id="4997132">d</span><span class="op" id="4997133">.</span><span class="ident" id="4997134">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997142">if</span>&nbsp;<span class="ident" id="4997145">lookahead</span>&nbsp;<span class="op" id="4997155">&lt;</span>&nbsp;<span class="ident" id="4997157">minMatchLength</span><span class="op" id="4997171">+</span><span class="ident" id="4997172">maxMatchLength</span>&nbsp;<span class="op" id="4997187">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997192">if</span>&nbsp;<span class="op" id="4997195">!</span><span class="ident" id="4997196">d</span><span class="op" id="4997197">.</span><span class="ident" id="4997198">sync</span>&nbsp;<span class="op" id="4997203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997209">break</span>&nbsp;<span class="ident" id="4997215">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997228">if</span>&nbsp;<span class="ident" id="4997231">d</span><span class="op" id="4997232">.</span><span class="ident" id="4997233">index</span>&nbsp;<span class="op" id="4997239">&gt;</span>&nbsp;<span class="ident" id="4997241">d</span><span class="op" id="4997242">.</span><span class="ident" id="4997243">windowEnd</span>&nbsp;<span class="op" id="4997253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4997259">panic</span><span class="op" id="4997264">(</span><span class="string" id="4997265">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4997284">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997294">if</span>&nbsp;<span class="ident" id="4997297">lookahead</span>&nbsp;<span class="op" id="4997307">==</span>&nbsp;<span class="num" id="4997310">0</span>&nbsp;<span class="op" id="4997312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997318">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997360">if</span>&nbsp;<span class="ident" id="4997363">d</span><span class="op" id="4997364">.</span><span class="ident" id="4997365">byteAvailable</span>&nbsp;<span class="op" id="4997379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997386">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997452">d</span><span class="op" id="4997453">.</span><span class="ident" id="4997454">tokens</span>&nbsp;<span class="op" id="4997461">=</span>&nbsp;<span class="builtinfunc" id="4997463">append</span><span class="op" id="4997469">(</span><span class="ident" id="4997470">d</span><span class="op" id="4997471">.</span><span class="ident" id="4997472">tokens</span><span class="op" id="4997478">,</span>&nbsp;<span class="ident" id="4997480">literalToken</span><span class="op" id="4997492">(</span><span class="builtintype" id="4997493">uint32</span><span class="op" id="4997499">(</span><span class="ident" id="4997500">d</span><span class="op" id="4997501">.</span><span class="ident" id="4997502">window</span><span class="op" id="4997508">[</span><span class="ident" id="4997509">d</span><span class="op" id="4997510">.</span><span class="ident" id="4997511">index</span><span class="op" id="4997516">-</span><span class="num" id="4997517">1</span><span class="op" id="4997518">]</span><span class="op" id="4997519">)</span><span class="op" id="4997520">)</span><span class="op" id="4997521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997528">d</span><span class="op" id="4997529">.</span><span class="ident" id="4997530">byteAvailable</span>&nbsp;<span class="op" id="4997544">=</span>&nbsp;<span class="builtintype" id="4997546">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997562">if</span>&nbsp;<span class="builtinfunc" id="4997565">len</span><span class="op" id="4997568">(</span><span class="ident" id="4997569">d</span><span class="op" id="4997570">.</span><span class="ident" id="4997571">tokens</span><span class="op" id="4997577">)</span>&nbsp;<span class="op" id="4997579">&gt;</span>&nbsp;<span class="num" id="4997581">0</span>&nbsp;<span class="op" id="4997583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997590">if</span>&nbsp;<span class="ident" id="4997593">d</span><span class="op" id="4997594">.</span><span class="ident" id="4997595">err</span>&nbsp;<span class="op" id="4997599">=</span>&nbsp;<span class="ident" id="4997601">d</span><span class="op" id="4997602">.</span><span class="ident" id="4997603">writeBlock</span><span class="op" id="4997613">(</span><span class="ident" id="4997614">d</span><span class="op" id="4997615">.</span><span class="ident" id="4997616">tokens</span><span class="op" id="4997622">,</span>&nbsp;<span class="ident" id="4997624">d</span><span class="op" id="4997625">.</span><span class="ident" id="4997626">index</span><span class="op" id="4997631">,</span>&nbsp;<span class="builtintype" id="4997633">false</span><span class="op" id="4997638">)</span><span class="op" id="4997639">;</span>&nbsp;<span class="ident" id="4997641">d</span><span class="op" id="4997642">.</span><span class="ident" id="4997643">err</span>&nbsp;<span class="op" id="4997647">!=</span>&nbsp;<span class="ident" id="4997650">nil</span>&nbsp;<span class="op" id="4997654">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997662">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997681">d</span><span class="op" id="4997682">.</span><span class="ident" id="4997683">tokens</span>&nbsp;<span class="op" id="4997690">=</span>&nbsp;<span class="ident" id="4997692">d</span><span class="op" id="4997693">.</span><span class="ident" id="4997694">tokens</span><span class="op" id="4997700">[</span><span class="op" id="4997701">:</span><span class="num" id="4997702">0</span><span class="op" id="4997703">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997715">break</span>&nbsp;<span class="ident" id="4997721">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997737">if</span>&nbsp;<span class="ident" id="4997740">d</span><span class="op" id="4997741">.</span><span class="ident" id="4997742">index</span>&nbsp;<span class="op" id="4997748">&lt;</span>&nbsp;<span class="ident" id="4997750">d</span><span class="op" id="4997751">.</span><span class="ident" id="4997752">maxInsertIndex</span>&nbsp;<span class="op" id="4997767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997772">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997794">d</span><span class="op" id="4997795">.</span><span class="ident" id="4997796">hash</span>&nbsp;<span class="op" id="4997801">=</span>&nbsp;<span class="op" id="4997803">(</span><span class="ident" id="4997804">d</span><span class="op" id="4997805">.</span><span class="ident" id="4997806">hash</span><span class="op" id="4997810">&lt;&lt;</span><span class="ident" id="4997812">hashShift</span>&nbsp;<span class="op" id="4997822">+</span>&nbsp;<span class="builtintype" id="4997824">int</span><span class="op" id="4997827">(</span><span class="ident" id="4997828">d</span><span class="op" id="4997829">.</span><span class="ident" id="4997830">window</span><span class="op" id="4997836">[</span><span class="ident" id="4997837">d</span><span class="op" id="4997838">.</span><span class="ident" id="4997839">index</span><span class="op" id="4997844">+</span><span class="num" id="4997845">2</span><span class="op" id="4997846">]</span><span class="op" id="4997847">)</span><span class="op" id="4997848">)</span>&nbsp;<span class="op" id="4997850">&amp;</span>&nbsp;<span class="ident" id="4997852">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997864">d</span><span class="op" id="4997865">.</span><span class="ident" id="4997866">chainHead</span>&nbsp;<span class="op" id="4997876">=</span>&nbsp;<span class="ident" id="4997878">d</span><span class="op" id="4997879">.</span><span class="ident" id="4997880">hashHead</span><span class="op" id="4997888">[</span><span class="ident" id="4997889">d</span><span class="op" id="4997890">.</span><span class="ident" id="4997891">hash</span><span class="op" id="4997895">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997900">d</span><span class="op" id="4997901">.</span><span class="ident" id="4997902">hashPrev</span><span class="op" id="4997910">[</span><span class="ident" id="4997911">d</span><span class="op" id="4997912">.</span><span class="ident" id="4997913">index</span><span class="op" id="4997918">&amp;</span><span class="ident" id="4997919">windowMask</span><span class="op" id="4997929">]</span>&nbsp;<span class="op" id="4997931">=</span>&nbsp;<span class="ident" id="4997933">d</span><span class="op" id="4997934">.</span><span class="ident" id="4997935">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997948">d</span><span class="op" id="4997949">.</span><span class="ident" id="4997950">hashHead</span><span class="op" id="4997958">[</span><span class="ident" id="4997959">d</span><span class="op" id="4997960">.</span><span class="ident" id="4997961">hash</span><span class="op" id="4997965">]</span>&nbsp;<span class="op" id="4997967">=</span>&nbsp;<span class="ident" id="4997969">d</span><span class="op" id="4997970">.</span><span class="ident" id="4997971">index</span>&nbsp;<span class="op" id="4997977">+</span>&nbsp;<span class="ident" id="4997979">d</span><span class="op" id="4997980">.</span><span class="ident" id="4997981">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997998">prevLength</span>&nbsp;<span class="op" id="4998009">:=</span>&nbsp;<span class="ident" id="4998012">d</span><span class="op" id="4998013">.</span><span class="ident" id="4998014">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998023">prevOffset</span>&nbsp;<span class="op" id="4998034">:=</span>&nbsp;<span class="ident" id="4998037">d</span><span class="op" id="4998038">.</span><span class="ident" id="4998039">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998048">d</span><span class="op" id="4998049">.</span><span class="ident" id="4998050">length</span>&nbsp;<span class="op" id="4998057">=</span>&nbsp;<span class="ident" id="4998059">minMatchLength</span>&nbsp;<span class="op" id="4998074">-</span>&nbsp;<span class="num" id="4998076">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998080">d</span><span class="op" id="4998081">.</span><span class="ident" id="4998082">offset</span>&nbsp;<span class="op" id="4998089">=</span>&nbsp;<span class="num" id="4998091">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998095">minIndex</span>&nbsp;<span class="op" id="4998104">:=</span>&nbsp;<span class="ident" id="4998107">d</span><span class="op" id="4998108">.</span><span class="ident" id="4998109">index</span>&nbsp;<span class="op" id="4998115">-</span>&nbsp;<span class="ident" id="4998117">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998130">if</span>&nbsp;<span class="ident" id="4998133">minIndex</span>&nbsp;<span class="op" id="4998142">&lt;</span>&nbsp;<span class="num" id="4998144">0</span>&nbsp;<span class="op" id="4998146">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998151">minIndex</span>&nbsp;<span class="op" id="4998160">=</span>&nbsp;<span class="num" id="4998162">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998171">if</span>&nbsp;<span class="ident" id="4998174">d</span><span class="op" id="4998175">.</span><span class="ident" id="4998176">chainHead</span><span class="op" id="4998185">-</span><span class="ident" id="4998186">d</span><span class="op" id="4998187">.</span><span class="ident" id="4998188">hashOffset</span>&nbsp;<span class="op" id="4998199">&gt;=</span>&nbsp;<span class="ident" id="4998202">minIndex</span>&nbsp;<span class="op" id="4998211">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998217">(</span><span class="ident" id="4998218">d</span><span class="op" id="4998219">.</span><span class="ident" id="4998220">fastSkipHashing</span>&nbsp;<span class="op" id="4998236">!=</span>&nbsp;<span class="ident" id="4998239">skipNever</span>&nbsp;<span class="op" id="4998249">&amp;&amp;</span>&nbsp;<span class="ident" id="4998252">lookahead</span>&nbsp;<span class="op" id="4998262">&gt;</span>&nbsp;<span class="ident" id="4998264">minMatchLength</span><span class="op" id="4998278">-</span><span class="num" id="4998279">1</span>&nbsp;<span class="op" id="4998281">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998288">d</span><span class="op" id="4998289">.</span><span class="ident" id="4998290">fastSkipHashing</span>&nbsp;<span class="op" id="4998306">==</span>&nbsp;<span class="ident" id="4998309">skipNever</span>&nbsp;<span class="op" id="4998319">&amp;&amp;</span>&nbsp;<span class="ident" id="4998322">lookahead</span>&nbsp;<span class="op" id="4998332">&gt;</span>&nbsp;<span class="ident" id="4998334">prevLength</span>&nbsp;<span class="op" id="4998345">&amp;&amp;</span>&nbsp;<span class="ident" id="4998348">prevLength</span>&nbsp;<span class="op" id="4998359">&lt;</span>&nbsp;<span class="ident" id="4998361">d</span><span class="op" id="4998362">.</span><span class="ident" id="4998363">lazy</span><span class="op" id="4998367">)</span>&nbsp;<span class="op" id="4998369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998374">if</span>&nbsp;<span class="ident" id="4998377">newLength</span><span class="op" id="4998386">,</span>&nbsp;<span class="ident" id="4998388">newOffset</span><span class="op" id="4998397">,</span>&nbsp;<span class="ident" id="4998399">ok</span>&nbsp;<span class="op" id="4998402">:=</span>&nbsp;<span class="ident" id="4998405">d</span><span class="op" id="4998406">.</span><span class="ident" id="4998407">findMatch</span><span class="op" id="4998416">(</span><span class="ident" id="4998417">d</span><span class="op" id="4998418">.</span><span class="ident" id="4998419">index</span><span class="op" id="4998424">,</span>&nbsp;<span class="ident" id="4998426">d</span><span class="op" id="4998427">.</span><span class="ident" id="4998428">chainHead</span><span class="op" id="4998437">-</span><span class="ident" id="4998438">d</span><span class="op" id="4998439">.</span><span class="ident" id="4998440">hashOffset</span><span class="op" id="4998450">,</span>&nbsp;<span class="ident" id="4998452">minMatchLength</span><span class="op" id="4998466">-</span><span class="num" id="4998467">1</span><span class="op" id="4998468">,</span>&nbsp;<span class="ident" id="4998470">lookahead</span><span class="op" id="4998479">)</span><span class="op" id="4998480">;</span>&nbsp;<span class="ident" id="4998482">ok</span>&nbsp;<span class="op" id="4998485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998491">d</span><span class="op" id="4998492">.</span><span class="ident" id="4998493">length</span>&nbsp;<span class="op" id="4998500">=</span>&nbsp;<span class="ident" id="4998502">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998516">d</span><span class="op" id="4998517">.</span><span class="ident" id="4998518">offset</span>&nbsp;<span class="op" id="4998525">=</span>&nbsp;<span class="ident" id="4998527">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998540">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998548">if</span>&nbsp;<span class="ident" id="4998551">d</span><span class="op" id="4998552">.</span><span class="ident" id="4998553">fastSkipHashing</span>&nbsp;<span class="op" id="4998569">!=</span>&nbsp;<span class="ident" id="4998572">skipNever</span>&nbsp;<span class="op" id="4998582">&amp;&amp;</span>&nbsp;<span class="ident" id="4998585">d</span><span class="op" id="4998586">.</span><span class="ident" id="4998587">length</span>&nbsp;<span class="op" id="4998594">&gt;=</span>&nbsp;<span class="ident" id="4998597">minMatchLength</span>&nbsp;<span class="op" id="4998612">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998618">d</span><span class="op" id="4998619">.</span><span class="ident" id="4998620">fastSkipHashing</span>&nbsp;<span class="op" id="4998636">==</span>&nbsp;<span class="ident" id="4998639">skipNever</span>&nbsp;<span class="op" id="4998649">&amp;&amp;</span>&nbsp;<span class="ident" id="4998652">prevLength</span>&nbsp;<span class="op" id="4998663">&gt;=</span>&nbsp;<span class="ident" id="4998666">minMatchLength</span>&nbsp;<span class="op" id="4998681">&amp;&amp;</span>&nbsp;<span class="ident" id="4998684">d</span><span class="op" id="4998685">.</span><span class="ident" id="4998686">length</span>&nbsp;<span class="op" id="4998693">&lt;=</span>&nbsp;<span class="ident" id="4998696">prevLength</span>&nbsp;<span class="op" id="4998707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998712">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998783">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998828">if</span>&nbsp;<span class="ident" id="4998831">d</span><span class="op" id="4998832">.</span><span class="ident" id="4998833">fastSkipHashing</span>&nbsp;<span class="op" id="4998849">!=</span>&nbsp;<span class="ident" id="4998852">skipNever</span>&nbsp;<span class="op" id="4998862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998868">d</span><span class="op" id="4998869">.</span><span class="ident" id="4998870">tokens</span>&nbsp;<span class="op" id="4998877">=</span>&nbsp;<span class="builtinfunc" id="4998879">append</span><span class="op" id="4998885">(</span><span class="ident" id="4998886">d</span><span class="op" id="4998887">.</span><span class="ident" id="4998888">tokens</span><span class="op" id="4998894">,</span>&nbsp;<span class="ident" id="4998896">matchToken</span><span class="op" id="4998906">(</span><span class="builtintype" id="4998907">uint32</span><span class="op" id="4998913">(</span><span class="ident" id="4998914">d</span><span class="op" id="4998915">.</span><span class="ident" id="4998916">length</span><span class="op" id="4998922">-</span><span class="ident" id="4998923">minMatchLength</span><span class="op" id="4998937">)</span><span class="op" id="4998938">,</span>&nbsp;<span class="builtintype" id="4998940">uint32</span><span class="op" id="4998946">(</span><span class="ident" id="4998947">d</span><span class="op" id="4998948">.</span><span class="ident" id="4998949">offset</span><span class="op" id="4998955">-</span><span class="ident" id="4998956">minOffsetSize</span><span class="op" id="4998969">)</span><span class="op" id="4998970">)</span><span class="op" id="4998971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998976">}</span>&nbsp;<span class="keyword" id="4998978">else</span>&nbsp;<span class="op" id="4998983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998989">d</span><span class="op" id="4998990">.</span><span class="ident" id="4998991">tokens</span>&nbsp;<span class="op" id="4998998">=</span>&nbsp;<span class="builtinfunc" id="4999000">append</span><span class="op" id="4999006">(</span><span class="ident" id="4999007">d</span><span class="op" id="4999008">.</span><span class="ident" id="4999009">tokens</span><span class="op" id="4999015">,</span>&nbsp;<span class="ident" id="4999017">matchToken</span><span class="op" id="4999027">(</span><span class="builtintype" id="4999028">uint32</span><span class="op" id="4999034">(</span><span class="ident" id="4999035">prevLength</span><span class="op" id="4999045">-</span><span class="ident" id="4999046">minMatchLength</span><span class="op" id="4999060">)</span><span class="op" id="4999061">,</span>&nbsp;<span class="builtintype" id="4999063">uint32</span><span class="op" id="4999069">(</span><span class="ident" id="4999070">prevOffset</span><span class="op" id="4999080">-</span><span class="ident" id="4999081">minOffsetSize</span><span class="op" id="4999094">)</span><span class="op" id="4999095">)</span><span class="op" id="4999096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999101">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999106">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999177">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999246">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999315">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999328">if</span>&nbsp;<span class="ident" id="4999331">d</span><span class="op" id="4999332">.</span><span class="ident" id="4999333">length</span>&nbsp;<span class="op" id="4999340">&lt;=</span>&nbsp;<span class="ident" id="4999343">d</span><span class="op" id="4999344">.</span><span class="ident" id="4999345">fastSkipHashing</span>&nbsp;<span class="op" id="4999361">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999367">var</span>&nbsp;<span class="ident" id="4999371">newIndex</span>&nbsp;<span class="builtintype" id="4999380">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999388">if</span>&nbsp;<span class="ident" id="4999391">d</span><span class="op" id="4999392">.</span><span class="ident" id="4999393">fastSkipHashing</span>&nbsp;<span class="op" id="4999409">!=</span>&nbsp;<span class="ident" id="4999412">skipNever</span>&nbsp;<span class="op" id="4999422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999429">newIndex</span>&nbsp;<span class="op" id="4999438">=</span>&nbsp;<span class="ident" id="4999440">d</span><span class="op" id="4999441">.</span><span class="ident" id="4999442">index</span>&nbsp;<span class="op" id="4999448">+</span>&nbsp;<span class="ident" id="4999450">d</span><span class="op" id="4999451">.</span><span class="ident" id="4999452">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999463">}</span>&nbsp;<span class="keyword" id="4999465">else</span>&nbsp;<span class="op" id="4999470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999477">newIndex</span>&nbsp;<span class="op" id="4999486">=</span>&nbsp;<span class="ident" id="4999488">d</span><span class="op" id="4999489">.</span><span class="ident" id="4999490">index</span>&nbsp;<span class="op" id="4999496">+</span>&nbsp;<span class="ident" id="4999498">prevLength</span>&nbsp;<span class="op" id="4999509">-</span>&nbsp;<span class="num" id="4999511">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999523">for</span>&nbsp;<span class="ident" id="4999527">d</span><span class="op" id="4999528">.</span><span class="ident" id="4999529">index</span><span class="op" id="4999534">++</span><span class="op" id="4999536">;</span>&nbsp;<span class="ident" id="4999538">d</span><span class="op" id="4999539">.</span><span class="ident" id="4999540">index</span>&nbsp;<span class="op" id="4999546">&lt;</span>&nbsp;<span class="ident" id="4999548">newIndex</span><span class="op" id="4999556">;</span>&nbsp;<span class="ident" id="4999558">d</span><span class="op" id="4999559">.</span><span class="ident" id="4999560">index</span><span class="op" id="4999565">++</span>&nbsp;<span class="op" id="4999568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999575">if</span>&nbsp;<span class="ident" id="4999578">d</span><span class="op" id="4999579">.</span><span class="ident" id="4999580">index</span>&nbsp;<span class="op" id="4999586">&lt;</span>&nbsp;<span class="ident" id="4999588">d</span><span class="op" id="4999589">.</span><span class="ident" id="4999590">maxInsertIndex</span>&nbsp;<span class="op" id="4999605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999613">d</span><span class="op" id="4999614">.</span><span class="ident" id="4999615">hash</span>&nbsp;<span class="op" id="4999620">=</span>&nbsp;<span class="op" id="4999622">(</span><span class="ident" id="4999623">d</span><span class="op" id="4999624">.</span><span class="ident" id="4999625">hash</span><span class="op" id="4999629">&lt;&lt;</span><span class="ident" id="4999631">hashShift</span>&nbsp;<span class="op" id="4999641">+</span>&nbsp;<span class="builtintype" id="4999643">int</span><span class="op" id="4999646">(</span><span class="ident" id="4999647">d</span><span class="op" id="4999648">.</span><span class="ident" id="4999649">window</span><span class="op" id="4999655">[</span><span class="ident" id="4999656">d</span><span class="op" id="4999657">.</span><span class="ident" id="4999658">index</span><span class="op" id="4999663">+</span><span class="num" id="4999664">2</span><span class="op" id="4999665">]</span><span class="op" id="4999666">)</span><span class="op" id="4999667">)</span>&nbsp;<span class="op" id="4999669">&amp;</span>&nbsp;<span class="ident" id="4999671">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999686">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999734">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999789">d</span><span class="op" id="4999790">.</span><span class="ident" id="4999791">hashPrev</span><span class="op" id="4999799">[</span><span class="ident" id="4999800">d</span><span class="op" id="4999801">.</span><span class="ident" id="4999802">index</span><span class="op" id="4999807">&amp;</span><span class="ident" id="4999808">windowMask</span><span class="op" id="4999818">]</span>&nbsp;<span class="op" id="4999820">=</span>&nbsp;<span class="ident" id="4999822">d</span><span class="op" id="4999823">.</span><span class="ident" id="4999824">hashHead</span><span class="op" id="4999832">[</span><span class="ident" id="4999833">d</span><span class="op" id="4999834">.</span><span class="ident" id="4999835">hash</span><span class="op" id="4999839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999847">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999894">d</span><span class="op" id="4999895">.</span><span class="ident" id="4999896">hashHead</span><span class="op" id="4999904">[</span><span class="ident" id="4999905">d</span><span class="op" id="4999906">.</span><span class="ident" id="4999907">hash</span><span class="op" id="4999911">]</span>&nbsp;<span class="op" id="4999913">=</span>&nbsp;<span class="ident" id="4999915">d</span><span class="op" id="4999916">.</span><span class="ident" id="4999917">index</span>&nbsp;<span class="op" id="4999923">+</span>&nbsp;<span class="ident" id="4999925">d</span><span class="op" id="4999926">.</span><span class="ident" id="4999927">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999943">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999955">if</span>&nbsp;<span class="ident" id="4999958">d</span><span class="op" id="4999959">.</span><span class="ident" id="4999960">fastSkipHashing</span>&nbsp;<span class="op" id="4999976">==</span>&nbsp;<span class="ident" id="4999979">skipNever</span>&nbsp;<span class="op" id="4999989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999996">d</span><span class="op" id="4999997">.</span><span class="ident" id="4999998">byteAvailable</span>&nbsp;<span class="op" id="5000012">=</span>&nbsp;<span class="builtintype" id="5000014">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000025">d</span><span class="op" id="5000026">.</span><span class="ident" id="5000027">length</span>&nbsp;<span class="op" id="5000034">=</span>&nbsp;<span class="ident" id="5000036">minMatchLength</span>&nbsp;<span class="op" id="5000051">-</span>&nbsp;<span class="num" id="5000053">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000059">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000064">}</span>&nbsp;<span class="keyword" id="5000066">else</span>&nbsp;<span class="op" id="5000071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000077">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000149">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000177">d</span><span class="op" id="5000178">.</span><span class="ident" id="5000179">index</span>&nbsp;<span class="op" id="5000185">+=</span>&nbsp;<span class="ident" id="5000188">d</span><span class="op" id="5000189">.</span><span class="ident" id="5000190">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000201">if</span>&nbsp;<span class="ident" id="5000204">d</span><span class="op" id="5000205">.</span><span class="ident" id="5000206">index</span>&nbsp;<span class="op" id="5000212">&lt;</span>&nbsp;<span class="ident" id="5000214">d</span><span class="op" id="5000215">.</span><span class="ident" id="5000216">maxInsertIndex</span>&nbsp;<span class="op" id="5000231">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000238">d</span><span class="op" id="5000239">.</span><span class="ident" id="5000240">hash</span>&nbsp;<span class="op" id="5000245">=</span>&nbsp;<span class="op" id="5000247">(</span><span class="builtintype" id="5000248">int</span><span class="op" id="5000251">(</span><span class="ident" id="5000252">d</span><span class="op" id="5000253">.</span><span class="ident" id="5000254">window</span><span class="op" id="5000260">[</span><span class="ident" id="5000261">d</span><span class="op" id="5000262">.</span><span class="ident" id="5000263">index</span><span class="op" id="5000268">]</span><span class="op" id="5000269">)</span><span class="op" id="5000270">&lt;&lt;</span><span class="ident" id="5000272">hashShift</span>&nbsp;<span class="op" id="5000282">+</span>&nbsp;<span class="builtintype" id="5000284">int</span><span class="op" id="5000287">(</span><span class="ident" id="5000288">d</span><span class="op" id="5000289">.</span><span class="ident" id="5000290">window</span><span class="op" id="5000296">[</span><span class="ident" id="5000297">d</span><span class="op" id="5000298">.</span><span class="ident" id="5000299">index</span><span class="op" id="5000304">+</span><span class="num" id="5000305">1</span><span class="op" id="5000306">]</span><span class="op" id="5000307">)</span><span class="op" id="5000308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000324">if</span>&nbsp;<span class="builtinfunc" id="5000327">len</span><span class="op" id="5000330">(</span><span class="ident" id="5000331">d</span><span class="op" id="5000332">.</span><span class="ident" id="5000333">tokens</span><span class="op" id="5000339">)</span>&nbsp;<span class="op" id="5000341">==</span>&nbsp;<span class="ident" id="5000344">maxFlateBlockTokens</span>&nbsp;<span class="op" id="5000364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000370">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000418">if</span>&nbsp;<span class="ident" id="5000421">d</span><span class="op" id="5000422">.</span><span class="ident" id="5000423">err</span>&nbsp;<span class="op" id="5000427">=</span>&nbsp;<span class="ident" id="5000429">d</span><span class="op" id="5000430">.</span><span class="ident" id="5000431">writeBlock</span><span class="op" id="5000441">(</span><span class="ident" id="5000442">d</span><span class="op" id="5000443">.</span><span class="ident" id="5000444">tokens</span><span class="op" id="5000450">,</span>&nbsp;<span class="ident" id="5000452">d</span><span class="op" id="5000453">.</span><span class="ident" id="5000454">index</span><span class="op" id="5000459">,</span>&nbsp;<span class="builtintype" id="5000461">false</span><span class="op" id="5000466">)</span><span class="op" id="5000467">;</span>&nbsp;<span class="ident" id="5000469">d</span><span class="op" id="5000470">.</span><span class="ident" id="5000471">err</span>&nbsp;<span class="op" id="5000475">!=</span>&nbsp;<span class="ident" id="5000478">nil</span>&nbsp;<span class="op" id="5000482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000489">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000506">d</span><span class="op" id="5000507">.</span><span class="ident" id="5000508">tokens</span>&nbsp;<span class="op" id="5000515">=</span>&nbsp;<span class="ident" id="5000517">d</span><span class="op" id="5000518">.</span><span class="ident" id="5000519">tokens</span><span class="op" id="5000525">[</span><span class="op" id="5000526">:</span><span class="num" id="5000527">0</span><span class="op" id="5000528">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000533">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000537">}</span>&nbsp;<span class="keyword" id="5000539">else</span>&nbsp;<span class="op" id="5000544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000549">if</span>&nbsp;<span class="ident" id="5000552">d</span><span class="op" id="5000553">.</span><span class="ident" id="5000554">fastSkipHashing</span>&nbsp;<span class="op" id="5000570">!=</span>&nbsp;<span class="ident" id="5000573">skipNever</span>&nbsp;<span class="op" id="5000583">||</span>&nbsp;<span class="ident" id="5000586">d</span><span class="op" id="5000587">.</span><span class="ident" id="5000588">byteAvailable</span>&nbsp;<span class="op" id="5000602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000608">i</span>&nbsp;<span class="op" id="5000610">:=</span>&nbsp;<span class="ident" id="5000613">d</span><span class="op" id="5000614">.</span><span class="ident" id="5000615">index</span>&nbsp;<span class="op" id="5000621">-</span>&nbsp;<span class="num" id="5000623">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000629">if</span>&nbsp;<span class="ident" id="5000632">d</span><span class="op" id="5000633">.</span><span class="ident" id="5000634">fastSkipHashing</span>&nbsp;<span class="op" id="5000650">!=</span>&nbsp;<span class="ident" id="5000653">skipNever</span>&nbsp;<span class="op" id="5000663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000670">i</span>&nbsp;<span class="op" id="5000672">=</span>&nbsp;<span class="ident" id="5000674">d</span><span class="op" id="5000675">.</span><span class="ident" id="5000676">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000692">d</span><span class="op" id="5000693">.</span><span class="ident" id="5000694">tokens</span>&nbsp;<span class="op" id="5000701">=</span>&nbsp;<span class="builtinfunc" id="5000703">append</span><span class="op" id="5000709">(</span><span class="ident" id="5000710">d</span><span class="op" id="5000711">.</span><span class="ident" id="5000712">tokens</span><span class="op" id="5000718">,</span>&nbsp;<span class="ident" id="5000720">literalToken</span><span class="op" id="5000732">(</span><span class="builtintype" id="5000733">uint32</span><span class="op" id="5000739">(</span><span class="ident" id="5000740">d</span><span class="op" id="5000741">.</span><span class="ident" id="5000742">window</span><span class="op" id="5000748">[</span><span class="ident" id="5000749">i</span><span class="op" id="5000750">]</span><span class="op" id="5000751">)</span><span class="op" id="5000752">)</span><span class="op" id="5000753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000759">if</span>&nbsp;<span class="builtinfunc" id="5000762">len</span><span class="op" id="5000765">(</span><span class="ident" id="5000766">d</span><span class="op" id="5000767">.</span><span class="ident" id="5000768">tokens</span><span class="op" id="5000774">)</span>&nbsp;<span class="op" id="5000776">==</span>&nbsp;<span class="ident" id="5000779">maxFlateBlockTokens</span>&nbsp;<span class="op" id="5000799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000806">if</span>&nbsp;<span class="ident" id="5000809">d</span><span class="op" id="5000810">.</span><span class="ident" id="5000811">err</span>&nbsp;<span class="op" id="5000815">=</span>&nbsp;<span class="ident" id="5000817">d</span><span class="op" id="5000818">.</span><span class="ident" id="5000819">writeBlock</span><span class="op" id="5000829">(</span><span class="ident" id="5000830">d</span><span class="op" id="5000831">.</span><span class="ident" id="5000832">tokens</span><span class="op" id="5000838">,</span>&nbsp;<span class="ident" id="5000840">i</span><span class="op" id="5000841">+</span><span class="num" id="5000842">1</span><span class="op" id="5000843">,</span>&nbsp;<span class="builtintype" id="5000845">false</span><span class="op" id="5000850">)</span><span class="op" id="5000851">;</span>&nbsp;<span class="ident" id="5000853">d</span><span class="op" id="5000854">.</span><span class="ident" id="5000855">err</span>&nbsp;<span class="op" id="5000859">!=</span>&nbsp;<span class="ident" id="5000862">nil</span>&nbsp;<span class="op" id="5000866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000874">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000893">d</span><span class="op" id="5000894">.</span><span class="ident" id="5000895">tokens</span>&nbsp;<span class="op" id="5000902">=</span>&nbsp;<span class="ident" id="5000904">d</span><span class="op" id="5000905">.</span><span class="ident" id="5000906">tokens</span><span class="op" id="5000912">[</span><span class="op" id="5000913">:</span><span class="num" id="5000914">0</span><span class="op" id="5000915">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000931">d</span><span class="op" id="5000932">.</span><span class="ident" id="5000933">index</span><span class="op" id="5000938">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000944">if</span>&nbsp;<span class="ident" id="5000947">d</span><span class="op" id="5000948">.</span><span class="ident" id="5000949">fastSkipHashing</span>&nbsp;<span class="op" id="5000965">==</span>&nbsp;<span class="ident" id="5000968">skipNever</span>&nbsp;<span class="op" id="5000978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000984">d</span><span class="op" id="5000985">.</span><span class="ident" id="5000986">byteAvailable</span>&nbsp;<span class="op" id="5001000">=</span>&nbsp;<span class="builtintype" id="5001002">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001017">}</span><br>
<span class="lineno">360</span><span class="op" id="5001019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5001022">func</span>&nbsp;<span class="op" id="5001027">(</span><span class="ident" id="5001028">d</span>&nbsp;<span class="op" id="5001030">*</span><span class="ident" id="5001031">compressor</span><span class="op" id="5001041">)</span>&nbsp;<span class="ident" id="5001043">fillStore</span><span class="op" id="5001052">(</span><span class="ident" id="5001053">b</span>&nbsp;<span class="op" id="5001055">[</span><span class="op" id="5001056">]</span><span class="builtintype" id="5001057">byte</span><span class="op" id="5001061">)</span>&nbsp;<span class="builtintype" id="5001063">int</span>&nbsp;<span class="op" id="5001067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001070">n</span>&nbsp;<span class="op" id="5001072">:=</span>&nbsp;<span class="builtinfunc" id="5001075">copy</span><span class="op" id="5001079">(</span><span class="ident" id="5001080">d</span><span class="op" id="5001081">.</span><span class="ident" id="5001082">window</span><span class="op" id="5001088">[</span><span class="ident" id="5001089">d</span><span class="op" id="5001090">.</span><span class="ident" id="5001091">windowEnd</span><span class="op" id="5001100">:</span><span class="op" id="5001101">]</span><span class="op" id="5001102">,</span>&nbsp;<span class="ident" id="5001104">b</span><span class="op" id="5001105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001108">d</span><span class="op" id="5001109">.</span><span class="ident" id="5001110">windowEnd</span>&nbsp;<span class="op" id="5001120">+=</span>&nbsp;<span class="ident" id="5001123">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001126">return</span>&nbsp;<span class="ident" id="5001133">n</span><br>
<span class="lineno"></span><span class="op" id="5001135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5001138">func</span>&nbsp;<span class="op" id="5001143">(</span><span class="ident" id="5001144">d</span>&nbsp;<span class="op" id="5001146">*</span><span class="ident" id="5001147">compressor</span><span class="op" id="5001157">)</span>&nbsp;<span class="ident" id="5001159">store</span><span class="op" id="5001164">(</span><span class="op" id="5001165">)</span>&nbsp;<span class="op" id="5001167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001170">if</span>&nbsp;<span class="ident" id="5001173">d</span><span class="op" id="5001174">.</span><span class="ident" id="5001175">windowEnd</span>&nbsp;<span class="op" id="5001185">&gt;</span>&nbsp;<span class="num" id="5001187">0</span>&nbsp;<span class="op" id="5001189">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001193">d</span><span class="op" id="5001194">.</span><span class="ident" id="5001195">err</span>&nbsp;<span class="op" id="5001199">=</span>&nbsp;<span class="ident" id="5001201">d</span><span class="op" id="5001202">.</span><span class="ident" id="5001203">writeStoredBlock</span><span class="op" id="5001219">(</span><span class="ident" id="5001220">d</span><span class="op" id="5001221">.</span><span class="ident" id="5001222">window</span><span class="op" id="5001228">[</span><span class="op" id="5001229">:</span><span class="ident" id="5001230">d</span><span class="op" id="5001231">.</span><span class="ident" id="5001232">windowEnd</span><span class="op" id="5001241">]</span><span class="op" id="5001242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001248">d</span><span class="op" id="5001249">.</span><span class="ident" id="5001250">windowEnd</span>&nbsp;<span class="op" id="5001260">=</span>&nbsp;<span class="num" id="5001262">0</span><br>
<span class="lineno"></span><span class="op" id="5001264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="5001267">func</span>&nbsp;<span class="op" id="5001272">(</span><span class="ident" id="5001273">d</span>&nbsp;<span class="op" id="5001275">*</span><span class="ident" id="5001276">compressor</span><span class="op" id="5001286">)</span>&nbsp;<span class="ident" id="5001288">write</span><span class="op" id="5001293">(</span><span class="ident" id="5001294">b</span>&nbsp;<span class="op" id="5001296">[</span><span class="op" id="5001297">]</span><span class="builtintype" id="5001298">byte</span><span class="op" id="5001302">)</span>&nbsp;<span class="op" id="5001304">(</span><span class="ident" id="5001305">n</span>&nbsp;<span class="builtintype" id="5001307">int</span><span class="op" id="5001310">,</span>&nbsp;<span class="ident" id="5001312">err</span>&nbsp;<span class="builtintype" id="5001316">error</span><span class="op" id="5001321">)</span>&nbsp;<span class="op" id="5001323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001326">n</span>&nbsp;<span class="op" id="5001328">=</span>&nbsp;<span class="builtinfunc" id="5001330">len</span><span class="op" id="5001333">(</span><span class="ident" id="5001334">b</span><span class="op" id="5001335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001338">b</span>&nbsp;<span class="op" id="5001340">=</span>&nbsp;<span class="ident" id="5001342">b</span><span class="op" id="5001343">[</span><span class="ident" id="5001344">d</span><span class="op" id="5001345">.</span><span class="ident" id="5001346">fill</span><span class="op" id="5001350">(</span><span class="ident" id="5001351">d</span><span class="op" id="5001352">,</span>&nbsp;<span class="ident" id="5001354">b</span><span class="op" id="5001355">)</span><span class="op" id="5001356">:</span><span class="op" id="5001357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001360">for</span>&nbsp;<span class="builtinfunc" id="5001364">len</span><span class="op" id="5001367">(</span><span class="ident" id="5001368">b</span><span class="op" id="5001369">)</span>&nbsp;<span class="op" id="5001371">&gt;</span>&nbsp;<span class="num" id="5001373">0</span>&nbsp;<span class="op" id="5001375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001379">d</span><span class="op" id="5001380">.</span><span class="ident" id="5001381">step</span><span class="op" id="5001385">(</span><span class="ident" id="5001386">d</span><span class="op" id="5001387">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001391">b</span>&nbsp;<span class="op" id="5001393">=</span>&nbsp;<span class="ident" id="5001395">b</span><span class="op" id="5001396">[</span><span class="ident" id="5001397">d</span><span class="op" id="5001398">.</span><span class="ident" id="5001399">fill</span><span class="op" id="5001403">(</span><span class="ident" id="5001404">d</span><span class="op" id="5001405">,</span>&nbsp;<span class="ident" id="5001407">b</span><span class="op" id="5001408">)</span><span class="op" id="5001409">:</span><span class="op" id="5001410">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001416">return</span>&nbsp;<span class="ident" id="5001423">n</span><span class="op" id="5001424">,</span>&nbsp;<span class="ident" id="5001426">d</span><span class="op" id="5001427">.</span><span class="ident" id="5001428">err</span><br>
<span class="lineno"></span><span class="op" id="5001432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="5001435">func</span>&nbsp;<span class="op" id="5001440">(</span><span class="ident" id="5001441">d</span>&nbsp;<span class="op" id="5001443">*</span><span class="ident" id="5001444">compressor</span><span class="op" id="5001454">)</span>&nbsp;<span class="ident" id="5001456">syncFlush</span><span class="op" id="5001465">(</span><span class="op" id="5001466">)</span>&nbsp;<span class="builtintype" id="5001468">error</span>&nbsp;<span class="op" id="5001474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001477">d</span><span class="op" id="5001478">.</span><span class="ident" id="5001479">sync</span>&nbsp;<span class="op" id="5001484">=</span>&nbsp;<span class="builtintype" id="5001486">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001492">d</span><span class="op" id="5001493">.</span><span class="ident" id="5001494">step</span><span class="op" id="5001498">(</span><span class="ident" id="5001499">d</span><span class="op" id="5001500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001503">if</span>&nbsp;<span class="ident" id="5001506">d</span><span class="op" id="5001507">.</span><span class="ident" id="5001508">err</span>&nbsp;<span class="op" id="5001512">==</span>&nbsp;<span class="ident" id="5001515">nil</span>&nbsp;<span class="op" id="5001519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001523">d</span><span class="op" id="5001524">.</span><span class="ident" id="5001525">w</span><span class="op" id="5001526">.</span><span class="ident" id="5001527">writeStoredHeader</span><span class="op" id="5001544">(</span><span class="num" id="5001545">0</span><span class="op" id="5001546">,</span>&nbsp;<span class="builtintype" id="5001548">false</span><span class="op" id="5001553">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001557">d</span><span class="op" id="5001558">.</span><span class="ident" id="5001559">w</span><span class="op" id="5001560">.</span><span class="ident" id="5001561">flush</span><span class="op" id="5001566">(</span><span class="op" id="5001567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001571">d</span><span class="op" id="5001572">.</span><span class="ident" id="5001573">err</span>&nbsp;<span class="op" id="5001577">=</span>&nbsp;<span class="ident" id="5001579">d</span><span class="op" id="5001580">.</span><span class="ident" id="5001581">w</span><span class="op" id="5001582">.</span><span class="ident" id="5001583">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001591">d</span><span class="op" id="5001592">.</span><span class="ident" id="5001593">sync</span>&nbsp;<span class="op" id="5001598">=</span>&nbsp;<span class="builtintype" id="5001600">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001607">return</span>&nbsp;<span class="ident" id="5001614">d</span><span class="op" id="5001615">.</span><span class="ident" id="5001616">err</span><br>
<span class="lineno">395</span><span class="op" id="5001620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5001623">func</span>&nbsp;<span class="op" id="5001628">(</span><span class="ident" id="5001629">d</span>&nbsp;<span class="op" id="5001631">*</span><span class="ident" id="5001632">compressor</span><span class="op" id="5001642">)</span>&nbsp;<span class="ident" id="5001644">init</span><span class="op" id="5001648">(</span><span class="ident" id="5001649">w</span>&nbsp;<span class="ident" id="5001651">io</span><span class="op" id="5001653">.</span><span class="ident" id="5001654">Writer</span><span class="op" id="5001660">,</span>&nbsp;<span class="ident" id="5001662">level</span>&nbsp;<span class="builtintype" id="5001668">int</span><span class="op" id="5001671">)</span>&nbsp;<span class="op" id="5001673">(</span><span class="ident" id="5001674">err</span>&nbsp;<span class="builtintype" id="5001678">error</span><span class="op" id="5001683">)</span>&nbsp;<span class="op" id="5001685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001688">d</span><span class="op" id="5001689">.</span><span class="ident" id="5001690">w</span>&nbsp;<span class="op" id="5001692">=</span>&nbsp;<span class="ident" id="5001694">newHuffmanBitWriter</span><span class="op" id="5001713">(</span><span class="ident" id="5001714">w</span><span class="op" id="5001715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001719">switch</span>&nbsp;<span class="op" id="5001726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001729">case</span>&nbsp;<span class="ident" id="5001734">level</span>&nbsp;<span class="op" id="5001740">==</span>&nbsp;<span class="ident" id="5001743">NoCompression</span><span class="op" id="5001756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001760">d</span><span class="op" id="5001761">.</span><span class="ident" id="5001762">window</span>&nbsp;<span class="op" id="5001769">=</span>&nbsp;<span class="builtinfunc" id="5001771">make</span><span class="op" id="5001775">(</span><span class="op" id="5001776">[</span><span class="op" id="5001777">]</span><span class="builtintype" id="5001778">byte</span><span class="op" id="5001782">,</span>&nbsp;<span class="ident" id="5001784">maxStoreBlockSize</span><span class="op" id="5001801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001805">d</span><span class="op" id="5001806">.</span><span class="ident" id="5001807">fill</span>&nbsp;<span class="op" id="5001812">=</span>&nbsp;<span class="op" id="5001814">(</span><span class="op" id="5001815">*</span><span class="ident" id="5001816">compressor</span><span class="op" id="5001826">)</span><span class="op" id="5001827">.</span><span class="ident" id="5001828">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001840">d</span><span class="op" id="5001841">.</span><span class="ident" id="5001842">step</span>&nbsp;<span class="op" id="5001847">=</span>&nbsp;<span class="op" id="5001849">(</span><span class="op" id="5001850">*</span><span class="ident" id="5001851">compressor</span><span class="op" id="5001861">)</span><span class="op" id="5001862">.</span><span class="ident" id="5001863">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001870">case</span>&nbsp;<span class="ident" id="5001875">level</span>&nbsp;<span class="op" id="5001881">==</span>&nbsp;<span class="ident" id="5001884">DefaultCompression</span><span class="op" id="5001902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001906">level</span>&nbsp;<span class="op" id="5001912">=</span>&nbsp;<span class="num" id="5001914">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001918">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001931">case</span>&nbsp;<span class="num" id="5001936">1</span>&nbsp;<span class="op" id="5001938">&lt;=</span>&nbsp;<span class="ident" id="5001941">level</span>&nbsp;<span class="op" id="5001947">&amp;&amp;</span>&nbsp;<span class="ident" id="5001950">level</span>&nbsp;<span class="op" id="5001956">&lt;=</span>&nbsp;<span class="num" id="5001959">9</span><span class="op" id="5001960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001964">d</span><span class="op" id="5001965">.</span><span class="ident" id="5001966">compressionLevel</span>&nbsp;<span class="op" id="5001983">=</span>&nbsp;<span class="ident" id="5001985">levels</span><span class="op" id="5001991">[</span><span class="ident" id="5001992">level</span><span class="op" id="5001997">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002001">d</span><span class="op" id="5002002">.</span><span class="ident" id="5002003">initDeflate</span><span class="op" id="5002014">(</span><span class="op" id="5002015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002019">d</span><span class="op" id="5002020">.</span><span class="ident" id="5002021">fill</span>&nbsp;<span class="op" id="5002026">=</span>&nbsp;<span class="op" id="5002028">(</span><span class="op" id="5002029">*</span><span class="ident" id="5002030">compressor</span><span class="op" id="5002040">)</span><span class="op" id="5002041">.</span><span class="ident" id="5002042">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002056">d</span><span class="op" id="5002057">.</span><span class="ident" id="5002058">step</span>&nbsp;<span class="op" id="5002063">=</span>&nbsp;<span class="op" id="5002065">(</span><span class="op" id="5002066">*</span><span class="ident" id="5002067">compressor</span><span class="op" id="5002077">)</span><span class="op" id="5002078">.</span><span class="ident" id="5002079">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002088">default</span><span class="op" id="5002095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002099">return</span>&nbsp;<span class="ident" id="5002106">fmt</span><span class="op" id="5002109">.</span><span class="ident" id="5002110">Errorf</span><span class="op" id="5002116">(</span><span class="string" id="5002117">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="5002183">,</span>&nbsp;<span class="ident" id="5002185">level</span><span class="op" id="5002190">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002196">return</span>&nbsp;<span class="ident" id="5002203">nil</span><br>
<span class="lineno"></span><span class="op" id="5002207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002210">var</span>&nbsp;<span class="ident" id="5002214">zeroes</span>&nbsp;<span class="op" id="5002221">[</span><span class="num" id="5002222">32</span><span class="op" id="5002224">]</span><span class="builtintype" id="5002225">int</span><br>
<span class="lineno">420</span><span class="keyword" id="5002229">var</span>&nbsp;<span class="ident" id="5002233">bzeroes</span>&nbsp;<span class="op" id="5002241">[</span><span class="num" id="5002242">256</span><span class="op" id="5002245">]</span><span class="builtintype" id="5002246">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002252">func</span>&nbsp;<span class="op" id="5002257">(</span><span class="ident" id="5002258">d</span>&nbsp;<span class="op" id="5002260">*</span><span class="ident" id="5002261">compressor</span><span class="op" id="5002271">)</span>&nbsp;<span class="ident" id="5002273">reset</span><span class="op" id="5002278">(</span><span class="ident" id="5002279">w</span>&nbsp;<span class="ident" id="5002281">io</span><span class="op" id="5002283">.</span><span class="ident" id="5002284">Writer</span><span class="op" id="5002290">)</span>&nbsp;<span class="op" id="5002292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002295">d</span><span class="op" id="5002296">.</span><span class="ident" id="5002297">w</span><span class="op" id="5002298">.</span><span class="ident" id="5002299">reset</span><span class="op" id="5002304">(</span><span class="ident" id="5002305">w</span><span class="op" id="5002306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002309">d</span><span class="op" id="5002310">.</span><span class="ident" id="5002311">sync</span>&nbsp;<span class="op" id="5002316">=</span>&nbsp;<span class="builtintype" id="5002318">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002325">d</span><span class="op" id="5002326">.</span><span class="ident" id="5002327">err</span>&nbsp;<span class="op" id="5002331">=</span>&nbsp;<span class="ident" id="5002333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002338">switch</span>&nbsp;<span class="ident" id="5002345">d</span><span class="op" id="5002346">.</span><span class="ident" id="5002347">compressionLevel</span><span class="op" id="5002363">.</span><span class="ident" id="5002364">chain</span>&nbsp;<span class="op" id="5002370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002373">case</span>&nbsp;<span class="num" id="5002378">0</span><span class="op" id="5002379">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002383">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002413">for</span>&nbsp;<span class="ident" id="5002417">i</span>&nbsp;<span class="op" id="5002419">:=</span>&nbsp;<span class="keyword" id="5002422">range</span>&nbsp;<span class="ident" id="5002428">d</span><span class="op" id="5002429">.</span><span class="ident" id="5002430">window</span>&nbsp;<span class="op" id="5002437">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002442">d</span><span class="op" id="5002443">.</span><span class="ident" id="5002444">window</span><span class="op" id="5002450">[</span><span class="ident" id="5002451">i</span><span class="op" id="5002452">]</span>&nbsp;<span class="op" id="5002454">=</span>&nbsp;<span class="num" id="5002456">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002464">d</span><span class="op" id="5002465">.</span><span class="ident" id="5002466">windowEnd</span>&nbsp;<span class="op" id="5002476">=</span>&nbsp;<span class="num" id="5002478">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002481">default</span><span class="op" id="5002488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002492">d</span><span class="op" id="5002493">.</span><span class="ident" id="5002494">chainHead</span>&nbsp;<span class="op" id="5002504">=</span>&nbsp;<span class="op" id="5002506">-</span><span class="num" id="5002507">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002511">for</span>&nbsp;<span class="ident" id="5002515">s</span>&nbsp;<span class="op" id="5002517">:=</span>&nbsp;<span class="ident" id="5002520">d</span><span class="op" id="5002521">.</span><span class="ident" id="5002522">hashHead</span><span class="op" id="5002530">;</span>&nbsp;<span class="builtinfunc" id="5002532">len</span><span class="op" id="5002535">(</span><span class="ident" id="5002536">s</span><span class="op" id="5002537">)</span>&nbsp;<span class="op" id="5002539">&gt;</span>&nbsp;<span class="num" id="5002541">0</span><span class="op" id="5002542">;</span>&nbsp;<span class="op" id="5002544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002549">n</span>&nbsp;<span class="op" id="5002551">:=</span>&nbsp;<span class="builtinfunc" id="5002554">copy</span><span class="op" id="5002558">(</span><span class="ident" id="5002559">s</span><span class="op" id="5002560">,</span>&nbsp;<span class="ident" id="5002562">zeroes</span><span class="op" id="5002568">[</span><span class="op" id="5002569">:</span><span class="op" id="5002570">]</span><span class="op" id="5002571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002576">s</span>&nbsp;<span class="op" id="5002578">=</span>&nbsp;<span class="ident" id="5002580">s</span><span class="op" id="5002581">[</span><span class="ident" id="5002582">n</span><span class="op" id="5002583">:</span><span class="op" id="5002584">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002592">for</span>&nbsp;<span class="ident" id="5002596">s</span>&nbsp;<span class="op" id="5002598">:=</span>&nbsp;<span class="ident" id="5002601">d</span><span class="op" id="5002602">.</span><span class="ident" id="5002603">hashPrev</span><span class="op" id="5002611">;</span>&nbsp;<span class="builtinfunc" id="5002613">len</span><span class="op" id="5002616">(</span><span class="ident" id="5002617">s</span><span class="op" id="5002618">)</span>&nbsp;<span class="op" id="5002620">&gt;</span>&nbsp;<span class="num" id="5002622">0</span><span class="op" id="5002623">;</span>&nbsp;<span class="ident" id="5002625">s</span>&nbsp;<span class="op" id="5002627">=</span>&nbsp;<span class="ident" id="5002629">s</span><span class="op" id="5002630">[</span><span class="builtinfunc" id="5002631">len</span><span class="op" id="5002634">(</span><span class="ident" id="5002635">zeroes</span><span class="op" id="5002641">)</span><span class="op" id="5002642">:</span><span class="op" id="5002643">]</span>&nbsp;<span class="op" id="5002645">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5002650">copy</span><span class="op" id="5002654">(</span><span class="ident" id="5002655">s</span><span class="op" id="5002656">,</span>&nbsp;<span class="ident" id="5002658">zeroes</span><span class="op" id="5002664">[</span><span class="op" id="5002665">:</span><span class="op" id="5002666">]</span><span class="op" id="5002667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002675">d</span><span class="op" id="5002676">.</span><span class="ident" id="5002677">hashOffset</span>&nbsp;<span class="op" id="5002688">=</span>&nbsp;<span class="num" id="5002690">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002695">d</span><span class="op" id="5002696">.</span><span class="ident" id="5002697">index</span><span class="op" id="5002702">,</span>&nbsp;<span class="ident" id="5002704">d</span><span class="op" id="5002705">.</span><span class="ident" id="5002706">windowEnd</span>&nbsp;<span class="op" id="5002716">=</span>&nbsp;<span class="num" id="5002718">0</span><span class="op" id="5002719">,</span>&nbsp;<span class="num" id="5002721">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002725">for</span>&nbsp;<span class="ident" id="5002729">s</span>&nbsp;<span class="op" id="5002731">:=</span>&nbsp;<span class="ident" id="5002734">d</span><span class="op" id="5002735">.</span><span class="ident" id="5002736">window</span><span class="op" id="5002742">;</span>&nbsp;<span class="builtinfunc" id="5002744">len</span><span class="op" id="5002747">(</span><span class="ident" id="5002748">s</span><span class="op" id="5002749">)</span>&nbsp;<span class="op" id="5002751">&gt;</span>&nbsp;<span class="num" id="5002753">0</span><span class="op" id="5002754">;</span>&nbsp;<span class="op" id="5002756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002761">n</span>&nbsp;<span class="op" id="5002763">:=</span>&nbsp;<span class="builtinfunc" id="5002766">copy</span><span class="op" id="5002770">(</span><span class="ident" id="5002771">s</span><span class="op" id="5002772">,</span>&nbsp;<span class="ident" id="5002774">bzeroes</span><span class="op" id="5002781">[</span><span class="op" id="5002782">:</span><span class="op" id="5002783">]</span><span class="op" id="5002784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002789">s</span>&nbsp;<span class="op" id="5002791">=</span>&nbsp;<span class="ident" id="5002793">s</span><span class="op" id="5002794">[</span><span class="ident" id="5002795">n</span><span class="op" id="5002796">:</span><span class="op" id="5002797">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002805">d</span><span class="op" id="5002806">.</span><span class="ident" id="5002807">blockStart</span><span class="op" id="5002817">,</span>&nbsp;<span class="ident" id="5002819">d</span><span class="op" id="5002820">.</span><span class="ident" id="5002821">byteAvailable</span>&nbsp;<span class="op" id="5002835">=</span>&nbsp;<span class="num" id="5002837">0</span><span class="op" id="5002838">,</span>&nbsp;<span class="builtintype" id="5002840">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002849">d</span><span class="op" id="5002850">.</span><span class="ident" id="5002851">tokens</span>&nbsp;<span class="op" id="5002858">=</span>&nbsp;<span class="ident" id="5002860">d</span><span class="op" id="5002861">.</span><span class="ident" id="5002862">tokens</span><span class="op" id="5002868">[</span><span class="op" id="5002869">:</span><span class="ident" id="5002870">maxFlateBlockTokens</span><span class="op" id="5002889">+</span><span class="num" id="5002890">1</span><span class="op" id="5002891">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002895">for</span>&nbsp;<span class="ident" id="5002899">i</span>&nbsp;<span class="op" id="5002901">:=</span>&nbsp;<span class="num" id="5002904">0</span><span class="op" id="5002905">;</span>&nbsp;<span class="ident" id="5002907">i</span>&nbsp;<span class="op" id="5002909">&lt;=</span>&nbsp;<span class="ident" id="5002912">maxFlateBlockTokens</span><span class="op" id="5002931">;</span>&nbsp;<span class="ident" id="5002933">i</span><span class="op" id="5002934">++</span>&nbsp;<span class="op" id="5002937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002942">d</span><span class="op" id="5002943">.</span><span class="ident" id="5002944">tokens</span><span class="op" id="5002950">[</span><span class="ident" id="5002951">i</span><span class="op" id="5002952">]</span>&nbsp;<span class="op" id="5002954">=</span>&nbsp;<span class="num" id="5002956">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002960">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002964">d</span><span class="op" id="5002965">.</span><span class="ident" id="5002966">tokens</span>&nbsp;<span class="op" id="5002973">=</span>&nbsp;<span class="ident" id="5002975">d</span><span class="op" id="5002976">.</span><span class="ident" id="5002977">tokens</span><span class="op" id="5002983">[</span><span class="op" id="5002984">:</span><span class="num" id="5002985">0</span><span class="op" id="5002986">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002990">d</span><span class="op" id="5002991">.</span><span class="ident" id="5002992">length</span>&nbsp;<span class="op" id="5002999">=</span>&nbsp;<span class="ident" id="5003001">minMatchLength</span>&nbsp;<span class="op" id="5003016">-</span>&nbsp;<span class="num" id="5003018">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003022">d</span><span class="op" id="5003023">.</span><span class="ident" id="5003024">offset</span>&nbsp;<span class="op" id="5003031">=</span>&nbsp;<span class="num" id="5003033">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003037">d</span><span class="op" id="5003038">.</span><span class="ident" id="5003039">hash</span>&nbsp;<span class="op" id="5003044">=</span>&nbsp;<span class="num" id="5003046">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003050">d</span><span class="op" id="5003051">.</span><span class="ident" id="5003052">maxInsertIndex</span>&nbsp;<span class="op" id="5003067">=</span>&nbsp;<span class="num" id="5003069">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003072">}</span><br>
<span class="lineno"></span><span class="op" id="5003074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5003077">func</span>&nbsp;<span class="op" id="5003082">(</span><span class="ident" id="5003083">d</span>&nbsp;<span class="op" id="5003085">*</span><span class="ident" id="5003086">compressor</span><span class="op" id="5003096">)</span>&nbsp;<span class="builtinfunc" id="5003098">close</span><span class="op" id="5003103">(</span><span class="op" id="5003104">)</span>&nbsp;<span class="builtintype" id="5003106">error</span>&nbsp;<span class="op" id="5003112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003115">d</span><span class="op" id="5003116">.</span><span class="ident" id="5003117">sync</span>&nbsp;<span class="op" id="5003122">=</span>&nbsp;<span class="builtintype" id="5003124">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003130">d</span><span class="op" id="5003131">.</span><span class="ident" id="5003132">step</span><span class="op" id="5003136">(</span><span class="ident" id="5003137">d</span><span class="op" id="5003138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003141">if</span>&nbsp;<span class="ident" id="5003144">d</span><span class="op" id="5003145">.</span><span class="ident" id="5003146">err</span>&nbsp;<span class="op" id="5003150">!=</span>&nbsp;<span class="ident" id="5003153">nil</span>&nbsp;<span class="op" id="5003157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003161">return</span>&nbsp;<span class="ident" id="5003168">d</span><span class="op" id="5003169">.</span><span class="ident" id="5003170">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003178">if</span>&nbsp;<span class="ident" id="5003181">d</span><span class="op" id="5003182">.</span><span class="ident" id="5003183">w</span><span class="op" id="5003184">.</span><span class="ident" id="5003185">writeStoredHeader</span><span class="op" id="5003202">(</span><span class="num" id="5003203">0</span><span class="op" id="5003204">,</span>&nbsp;<span class="builtintype" id="5003206">true</span><span class="op" id="5003210">)</span><span class="op" id="5003211">;</span>&nbsp;<span class="ident" id="5003213">d</span><span class="op" id="5003214">.</span><span class="ident" id="5003215">w</span><span class="op" id="5003216">.</span><span class="ident" id="5003217">err</span>&nbsp;<span class="op" id="5003221">!=</span>&nbsp;<span class="ident" id="5003224">nil</span>&nbsp;<span class="op" id="5003228">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003232">return</span>&nbsp;<span class="ident" id="5003239">d</span><span class="op" id="5003240">.</span><span class="ident" id="5003241">w</span><span class="op" id="5003242">.</span><span class="ident" id="5003243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003251">d</span><span class="op" id="5003252">.</span><span class="ident" id="5003253">w</span><span class="op" id="5003254">.</span><span class="ident" id="5003255">flush</span><span class="op" id="5003260">(</span><span class="op" id="5003261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003264">return</span>&nbsp;<span class="ident" id="5003271">d</span><span class="op" id="5003272">.</span><span class="ident" id="5003273">w</span><span class="op" id="5003274">.</span><span class="ident" id="5003275">err</span><br>
<span class="lineno"></span><span class="op" id="5003279">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="5003282">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="5003353">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="5003428">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="5003493">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="5003563">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="5003640">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="5003662">//</span><br>
<span class="lineno"></span><span class="comment" id="5003665">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5003738">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="5003787">func</span>&nbsp;<span class="ident" id="5003792">NewWriter</span><span class="op" id="5003801">(</span><span class="ident" id="5003802">w</span>&nbsp;<span class="ident" id="5003804">io</span><span class="op" id="5003806">.</span><span class="ident" id="5003807">Writer</span><span class="op" id="5003813">,</span>&nbsp;<span class="ident" id="5003815">level</span>&nbsp;<span class="builtintype" id="5003821">int</span><span class="op" id="5003824">)</span>&nbsp;<span class="op" id="5003826">(</span><span class="op" id="5003827">*</span><span class="ident" id="5003828">Writer</span><span class="op" id="5003834">,</span>&nbsp;<span class="builtintype" id="5003836">error</span><span class="op" id="5003841">)</span>&nbsp;<span class="op" id="5003843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003846">var</span>&nbsp;<span class="ident" id="5003850">dw</span>&nbsp;<span class="ident" id="5003853">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003861">if</span>&nbsp;<span class="ident" id="5003864">err</span>&nbsp;<span class="op" id="5003868">:=</span>&nbsp;<span class="ident" id="5003871">dw</span><span class="op" id="5003873">.</span><span class="ident" id="5003874">d</span><span class="op" id="5003875">.</span><span class="ident" id="5003876">init</span><span class="op" id="5003880">(</span><span class="ident" id="5003881">w</span><span class="op" id="5003882">,</span>&nbsp;<span class="ident" id="5003884">level</span><span class="op" id="5003889">)</span><span class="op" id="5003890">;</span>&nbsp;<span class="ident" id="5003892">err</span>&nbsp;<span class="op" id="5003896">!=</span>&nbsp;<span class="ident" id="5003899">nil</span>&nbsp;<span class="op" id="5003903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003907">return</span>&nbsp;<span class="ident" id="5003914">nil</span><span class="op" id="5003917">,</span>&nbsp;<span class="ident" id="5003919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003924">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003927">return</span>&nbsp;<span class="op" id="5003934">&amp;</span><span class="ident" id="5003935">dw</span><span class="op" id="5003937">,</span>&nbsp;<span class="ident" id="5003939">nil</span><br>
<span class="lineno"></span><span class="op" id="5003943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003946">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5004005">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="5004070">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="5004135">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="5004195">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5004256">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="5004276">func</span>&nbsp;<span class="ident" id="5004281">NewWriterDict</span><span class="op" id="5004294">(</span><span class="ident" id="5004295">w</span>&nbsp;<span class="ident" id="5004297">io</span><span class="op" id="5004299">.</span><span class="ident" id="5004300">Writer</span><span class="op" id="5004306">,</span>&nbsp;<span class="ident" id="5004308">level</span>&nbsp;<span class="builtintype" id="5004314">int</span><span class="op" id="5004317">,</span>&nbsp;<span class="ident" id="5004319">dict</span>&nbsp;<span class="op" id="5004324">[</span><span class="op" id="5004325">]</span><span class="builtintype" id="5004326">byte</span><span class="op" id="5004330">)</span>&nbsp;<span class="op" id="5004332">(</span><span class="op" id="5004333">*</span><span class="ident" id="5004334">Writer</span><span class="op" id="5004340">,</span>&nbsp;<span class="builtintype" id="5004342">error</span><span class="op" id="5004347">)</span>&nbsp;<span class="op" id="5004349">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004352">dw</span>&nbsp;<span class="op" id="5004355">:=</span>&nbsp;<span class="op" id="5004358">&amp;</span><span class="ident" id="5004359">dictWriter</span><span class="op" id="5004369">{</span><span class="ident" id="5004370">w</span><span class="op" id="5004371">,</span>&nbsp;<span class="builtintype" id="5004373">false</span><span class="op" id="5004378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004381">zw</span><span class="op" id="5004383">,</span>&nbsp;<span class="ident" id="5004385">err</span>&nbsp;<span class="op" id="5004389">:=</span>&nbsp;<span class="ident" id="5004392">NewWriter</span><span class="op" id="5004401">(</span><span class="ident" id="5004402">dw</span><span class="op" id="5004404">,</span>&nbsp;<span class="ident" id="5004406">level</span><span class="op" id="5004411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004414">if</span>&nbsp;<span class="ident" id="5004417">err</span>&nbsp;<span class="op" id="5004421">!=</span>&nbsp;<span class="ident" id="5004424">nil</span>&nbsp;<span class="op" id="5004428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004432">return</span>&nbsp;<span class="ident" id="5004439">nil</span><span class="op" id="5004442">,</span>&nbsp;<span class="ident" id="5004444">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004449">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004452">zw</span><span class="op" id="5004454">.</span><span class="ident" id="5004455">Write</span><span class="op" id="5004460">(</span><span class="ident" id="5004461">dict</span><span class="op" id="5004465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004468">zw</span><span class="op" id="5004470">.</span><span class="ident" id="5004471">Flush</span><span class="op" id="5004476">(</span><span class="op" id="5004477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004480">dw</span><span class="op" id="5004482">.</span><span class="ident" id="5004483">enabled</span>&nbsp;<span class="op" id="5004491">=</span>&nbsp;<span class="builtintype" id="5004493">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004499">zw</span><span class="op" id="5004501">.</span><span class="ident" id="5004502">dict</span>&nbsp;<span class="op" id="5004507">=</span>&nbsp;<span class="builtinfunc" id="5004509">append</span><span class="op" id="5004515">(</span><span class="ident" id="5004516">zw</span><span class="op" id="5004518">.</span><span class="ident" id="5004519">dict</span><span class="op" id="5004523">,</span>&nbsp;<span class="ident" id="5004525">dict</span><span class="op" id="5004529">...</span><span class="op" id="5004532">)</span>&nbsp;<span class="comment" id="5004534">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004577">return</span>&nbsp;<span class="ident" id="5004584">zw</span><span class="op" id="5004586">,</span>&nbsp;<span class="ident" id="5004588">err</span><br>
<span class="lineno">510</span><span class="op" id="5004592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5004595">type</span>&nbsp;<span class="ident" id="5004600">dictWriter</span>&nbsp;<span class="keyword" id="5004611">struct</span>&nbsp;<span class="op" id="5004618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004621">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004629">io</span><span class="op" id="5004631">.</span><span class="ident" id="5004632">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004640">enabled</span>&nbsp;<span class="builtintype" id="5004648">bool</span><br>
<span class="lineno">515</span><span class="op" id="5004653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5004656">func</span>&nbsp;<span class="op" id="5004661">(</span><span class="ident" id="5004662">w</span>&nbsp;<span class="op" id="5004664">*</span><span class="ident" id="5004665">dictWriter</span><span class="op" id="5004675">)</span>&nbsp;<span class="ident" id="5004677">Write</span><span class="op" id="5004682">(</span><span class="ident" id="5004683">b</span>&nbsp;<span class="op" id="5004685">[</span><span class="op" id="5004686">]</span><span class="builtintype" id="5004687">byte</span><span class="op" id="5004691">)</span>&nbsp;<span class="op" id="5004693">(</span><span class="ident" id="5004694">n</span>&nbsp;<span class="builtintype" id="5004696">int</span><span class="op" id="5004699">,</span>&nbsp;<span class="ident" id="5004701">err</span>&nbsp;<span class="builtintype" id="5004705">error</span><span class="op" id="5004710">)</span>&nbsp;<span class="op" id="5004712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004715">if</span>&nbsp;<span class="ident" id="5004718">w</span><span class="op" id="5004719">.</span><span class="ident" id="5004720">enabled</span>&nbsp;<span class="op" id="5004728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004732">return</span>&nbsp;<span class="ident" id="5004739">w</span><span class="op" id="5004740">.</span><span class="ident" id="5004741">w</span><span class="op" id="5004742">.</span><span class="ident" id="5004743">Write</span><span class="op" id="5004748">(</span><span class="ident" id="5004749">b</span><span class="op" id="5004750">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5004753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004756">return</span>&nbsp;<span class="builtinfunc" id="5004763">len</span><span class="op" id="5004766">(</span><span class="ident" id="5004767">b</span><span class="op" id="5004768">)</span><span class="op" id="5004769">,</span>&nbsp;<span class="ident" id="5004771">nil</span><br>
<span class="lineno"></span><span class="op" id="5004775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5004778">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="5004841">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="5004903">type</span>&nbsp;<span class="ident" id="5004908">Writer</span>&nbsp;<span class="keyword" id="5004915">struct</span>&nbsp;<span class="op" id="5004922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004925">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004930">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004942">dict</span>&nbsp;<span class="op" id="5004947">[</span><span class="op" id="5004948">]</span><span class="builtintype" id="5004949">byte</span><br>
<span class="lineno"></span><span class="op" id="5004954">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="5004957">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5005016">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5005069">func</span>&nbsp;<span class="op" id="5005074">(</span><span class="ident" id="5005075">w</span>&nbsp;<span class="op" id="5005077">*</span><span class="ident" id="5005078">Writer</span><span class="op" id="5005084">)</span>&nbsp;<span class="ident" id="5005086">Write</span><span class="op" id="5005091">(</span><span class="ident" id="5005092">data</span>&nbsp;<span class="op" id="5005097">[</span><span class="op" id="5005098">]</span><span class="builtintype" id="5005099">byte</span><span class="op" id="5005103">)</span>&nbsp;<span class="op" id="5005105">(</span><span class="ident" id="5005106">n</span>&nbsp;<span class="builtintype" id="5005108">int</span><span class="op" id="5005111">,</span>&nbsp;<span class="ident" id="5005113">err</span>&nbsp;<span class="builtintype" id="5005117">error</span><span class="op" id="5005122">)</span>&nbsp;<span class="op" id="5005124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005127">return</span>&nbsp;<span class="ident" id="5005134">w</span><span class="op" id="5005135">.</span><span class="ident" id="5005136">d</span><span class="op" id="5005137">.</span><span class="ident" id="5005138">write</span><span class="op" id="5005143">(</span><span class="ident" id="5005144">data</span><span class="op" id="5005148">)</span><br>
<span class="lineno">535</span><span class="op" id="5005150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5005153">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="5005224">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5005295">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="5005355">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="5005413">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5005485">//</span><br>
<span class="lineno"></span><span class="comment" id="5005488">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="5005568">func</span>&nbsp;<span class="op" id="5005573">(</span><span class="ident" id="5005574">w</span>&nbsp;<span class="op" id="5005576">*</span><span class="ident" id="5005577">Writer</span><span class="op" id="5005583">)</span>&nbsp;<span class="ident" id="5005585">Flush</span><span class="op" id="5005590">(</span><span class="op" id="5005591">)</span>&nbsp;<span class="builtintype" id="5005593">error</span>&nbsp;<span class="op" id="5005599">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005602">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005631">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005683">return</span>&nbsp;<span class="ident" id="5005690">w</span><span class="op" id="5005691">.</span><span class="ident" id="5005692">d</span><span class="op" id="5005693">.</span><span class="ident" id="5005694">syncFlush</span><span class="op" id="5005703">(</span><span class="op" id="5005704">)</span><br>
<span class="lineno"></span><span class="op" id="5005706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="5005709">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5005749">func</span>&nbsp;<span class="op" id="5005754">(</span><span class="ident" id="5005755">w</span>&nbsp;<span class="op" id="5005757">*</span><span class="ident" id="5005758">Writer</span><span class="op" id="5005764">)</span>&nbsp;<span class="ident" id="5005766">Close</span><span class="op" id="5005771">(</span><span class="op" id="5005772">)</span>&nbsp;<span class="builtintype" id="5005774">error</span>&nbsp;<span class="op" id="5005780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005783">return</span>&nbsp;<span class="ident" id="5005790">w</span><span class="op" id="5005791">.</span><span class="ident" id="5005792">d</span><span class="op" id="5005793">.</span><span class="builtinfunc" id="5005794">close</span><span class="op" id="5005799">(</span><span class="op" id="5005800">)</span><br>
<span class="lineno"></span><span class="op" id="5005802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="5005805">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5005869">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="5005929">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="5005962">func</span>&nbsp;<span class="op" id="5005967">(</span><span class="ident" id="5005968">w</span>&nbsp;<span class="op" id="5005970">*</span><span class="ident" id="5005971">Writer</span><span class="op" id="5005977">)</span>&nbsp;<span class="ident" id="5005979">Reset</span><span class="op" id="5005984">(</span><span class="ident" id="5005985">dst</span>&nbsp;<span class="ident" id="5005989">io</span><span class="op" id="5005991">.</span><span class="ident" id="5005992">Writer</span><span class="op" id="5005998">)</span>&nbsp;<span class="op" id="5006000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5006003">if</span>&nbsp;<span class="ident" id="5006006">dw</span><span class="op" id="5006008">,</span>&nbsp;<span class="ident" id="5006010">ok</span>&nbsp;<span class="op" id="5006013">:=</span>&nbsp;<span class="ident" id="5006016">w</span><span class="op" id="5006017">.</span><span class="ident" id="5006018">d</span><span class="op" id="5006019">.</span><span class="ident" id="5006020">w</span><span class="op" id="5006021">.</span><span class="ident" id="5006022">w</span><span class="op" id="5006023">.</span><span class="op" id="5006024">(</span><span class="op" id="5006025">*</span><span class="ident" id="5006026">dictWriter</span><span class="op" id="5006036">)</span><span class="op" id="5006037">;</span>&nbsp;<span class="ident" id="5006039">ok</span>&nbsp;<span class="op" id="5006042">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006046">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006084">dw</span><span class="op" id="5006086">.</span><span class="ident" id="5006087">w</span>&nbsp;<span class="op" id="5006089">=</span>&nbsp;<span class="ident" id="5006091">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006097">w</span><span class="op" id="5006098">.</span><span class="ident" id="5006099">d</span><span class="op" id="5006100">.</span><span class="ident" id="5006101">reset</span><span class="op" id="5006106">(</span><span class="ident" id="5006107">dw</span><span class="op" id="5006109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006113">dw</span><span class="op" id="5006115">.</span><span class="ident" id="5006116">enabled</span>&nbsp;<span class="op" id="5006124">=</span>&nbsp;<span class="builtintype" id="5006126">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006134">w</span><span class="op" id="5006135">.</span><span class="ident" id="5006136">Write</span><span class="op" id="5006141">(</span><span class="ident" id="5006142">w</span><span class="op" id="5006143">.</span><span class="ident" id="5006144">dict</span><span class="op" id="5006148">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006152">w</span><span class="op" id="5006153">.</span><span class="ident" id="5006154">Flush</span><span class="op" id="5006159">(</span><span class="op" id="5006160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006164">dw</span><span class="op" id="5006166">.</span><span class="ident" id="5006167">enabled</span>&nbsp;<span class="op" id="5006175">=</span>&nbsp;<span class="builtintype" id="5006177">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5006183">}</span>&nbsp;<span class="keyword" id="5006185">else</span>&nbsp;<span class="op" id="5006190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006194">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006228">w</span><span class="op" id="5006229">.</span><span class="ident" id="5006230">d</span><span class="op" id="5006231">.</span><span class="ident" id="5006232">reset</span><span class="op" id="5006237">(</span><span class="ident" id="5006238">dst</span><span class="op" id="5006241">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5006244">}</span><br>
<span class="lineno"></span><span class="op" id="5006246">}</span>
</div>
</body>
</html>
