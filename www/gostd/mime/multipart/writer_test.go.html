<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7459493">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7459548">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7459602">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7459653">package</span>&nbsp;<span class="ident" id="7459661">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7459672">import</span>&nbsp;<span class="op" id="7459679">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7459682">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7459691">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7459704">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7459715">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7459725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7459728">func</span>&nbsp;<span class="ident" id="7459733">TestWriter</span><span class="op" id="7459743">(</span><span class="ident" id="7459744">t</span>&nbsp;<span class="op" id="7459746">*</span><span class="ident" id="7459747">testing</span><span class="op" id="7459754">.</span><span class="ident" id="7459755">T</span><span class="op" id="7459756">)</span>&nbsp;<span class="op" id="7459758">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459761">fileContents</span>&nbsp;<span class="op" id="7459774">:=</span>&nbsp;<span class="op" id="7459777">[</span><span class="op" id="7459778">]</span><span class="builtintype" id="7459779">byte</span><span class="op" id="7459783">(</span><span class="string" id="7459784">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="7459802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7459806">var</span>&nbsp;<span class="ident" id="7459810">b</span>&nbsp;<span class="ident" id="7459812">bytes</span><span class="op" id="7459817">.</span><span class="ident" id="7459818">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459826">w</span>&nbsp;<span class="op" id="7459828">:=</span>&nbsp;<span class="ident" id="7459831">NewWriter</span><span class="op" id="7459840">(</span><span class="op" id="7459841">&amp;</span><span class="ident" id="7459842">b</span><span class="op" id="7459843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7459846">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459850">part</span><span class="op" id="7459854">,</span>&nbsp;<span class="ident" id="7459856">err</span>&nbsp;<span class="op" id="7459860">:=</span>&nbsp;<span class="ident" id="7459863">w</span><span class="op" id="7459864">.</span><span class="ident" id="7459865">CreateFormFile</span><span class="op" id="7459879">(</span><span class="string" id="7459880">&#34;myfile&#34;</span><span class="op" id="7459888">,</span>&nbsp;<span class="string" id="7459890">&#34;my-file.txt&#34;</span><span class="op" id="7459903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7459907">if</span>&nbsp;<span class="ident" id="7459910">err</span>&nbsp;<span class="op" id="7459914">!=</span>&nbsp;<span class="ident" id="7459917">nil</span>&nbsp;<span class="op" id="7459921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459926">t</span><span class="op" id="7459927">.</span><span class="ident" id="7459928">Fatalf</span><span class="op" id="7459934">(</span><span class="string" id="7459935">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="7459955">,</span>&nbsp;<span class="ident" id="7459957">err</span><span class="op" id="7459960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7459964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459968">part</span><span class="op" id="7459972">.</span><span class="ident" id="7459973">Write</span><span class="op" id="7459978">(</span><span class="ident" id="7459979">fileContents</span><span class="op" id="7459991">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7459995">err</span>&nbsp;<span class="op" id="7459999">=</span>&nbsp;<span class="ident" id="7460001">w</span><span class="op" id="7460002">.</span><span class="ident" id="7460003">WriteField</span><span class="op" id="7460013">(</span><span class="string" id="7460014">&#34;key&#34;</span><span class="op" id="7460019">,</span>&nbsp;<span class="string" id="7460021">&#34;val&#34;</span><span class="op" id="7460026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460030">if</span>&nbsp;<span class="ident" id="7460033">err</span>&nbsp;<span class="op" id="7460037">!=</span>&nbsp;<span class="ident" id="7460040">nil</span>&nbsp;<span class="op" id="7460044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460049">t</span><span class="op" id="7460050">.</span><span class="ident" id="7460051">Fatalf</span><span class="op" id="7460057">(</span><span class="string" id="7460058">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="7460074">,</span>&nbsp;<span class="ident" id="7460076">err</span><span class="op" id="7460079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460087">part</span><span class="op" id="7460091">.</span><span class="ident" id="7460092">Write</span><span class="op" id="7460097">(</span><span class="op" id="7460098">[</span><span class="op" id="7460099">]</span><span class="builtintype" id="7460100">byte</span><span class="op" id="7460104">(</span><span class="string" id="7460105">&#34;val&#34;</span><span class="op" id="7460110">)</span><span class="op" id="7460111">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460115">err</span>&nbsp;<span class="op" id="7460119">=</span>&nbsp;<span class="ident" id="7460121">w</span><span class="op" id="7460122">.</span><span class="ident" id="7460123">Close</span><span class="op" id="7460128">(</span><span class="op" id="7460129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460133">if</span>&nbsp;<span class="ident" id="7460136">err</span>&nbsp;<span class="op" id="7460140">!=</span>&nbsp;<span class="ident" id="7460143">nil</span>&nbsp;<span class="op" id="7460147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460152">t</span><span class="op" id="7460153">.</span><span class="ident" id="7460154">Fatalf</span><span class="op" id="7460160">(</span><span class="string" id="7460161">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7460172">,</span>&nbsp;<span class="ident" id="7460174">err</span><span class="op" id="7460177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460185">s</span>&nbsp;<span class="op" id="7460187">:=</span>&nbsp;<span class="ident" id="7460190">b</span><span class="op" id="7460191">.</span><span class="ident" id="7460192">String</span><span class="op" id="7460198">(</span><span class="op" id="7460199">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460203">if</span>&nbsp;<span class="builtinfunc" id="7460206">len</span><span class="op" id="7460209">(</span><span class="ident" id="7460210">s</span><span class="op" id="7460211">)</span>&nbsp;<span class="op" id="7460213">==</span>&nbsp;<span class="num" id="7460216">0</span>&nbsp;<span class="op" id="7460218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460223">t</span><span class="op" id="7460224">.</span><span class="ident" id="7460225">Fatal</span><span class="op" id="7460230">(</span><span class="string" id="7460231">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="7460264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460272">if</span>&nbsp;<span class="ident" id="7460275">s</span><span class="op" id="7460276">[</span><span class="num" id="7460277">0</span><span class="op" id="7460278">]</span>&nbsp;<span class="op" id="7460280">==</span>&nbsp;<span class="string" id="7460283">&#39;\r&#39;</span>&nbsp;<span class="op" id="7460288">||</span>&nbsp;<span class="ident" id="7460291">s</span><span class="op" id="7460292">[</span><span class="num" id="7460293">0</span><span class="op" id="7460294">]</span>&nbsp;<span class="op" id="7460296">==</span>&nbsp;<span class="string" id="7460299">&#39;\n&#39;</span>&nbsp;<span class="op" id="7460304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460309">t</span><span class="op" id="7460310">.</span><span class="ident" id="7460311">Fatal</span><span class="op" id="7460316">(</span><span class="string" id="7460317">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="7460345">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460356">r</span>&nbsp;<span class="op" id="7460358">:=</span>&nbsp;<span class="ident" id="7460361">NewReader</span><span class="op" id="7460370">(</span><span class="op" id="7460371">&amp;</span><span class="ident" id="7460372">b</span><span class="op" id="7460373">,</span>&nbsp;<span class="ident" id="7460375">w</span><span class="op" id="7460376">.</span><span class="ident" id="7460377">Boundary</span><span class="op" id="7460385">(</span><span class="op" id="7460386">)</span><span class="op" id="7460387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460391">part</span><span class="op" id="7460395">,</span>&nbsp;<span class="ident" id="7460397">err</span>&nbsp;<span class="op" id="7460401">:=</span>&nbsp;<span class="ident" id="7460404">r</span><span class="op" id="7460405">.</span><span class="ident" id="7460406">NextPart</span><span class="op" id="7460414">(</span><span class="op" id="7460415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460418">if</span>&nbsp;<span class="ident" id="7460421">err</span>&nbsp;<span class="op" id="7460425">!=</span>&nbsp;<span class="ident" id="7460428">nil</span>&nbsp;<span class="op" id="7460432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460436">t</span><span class="op" id="7460437">.</span><span class="ident" id="7460438">Fatalf</span><span class="op" id="7460444">(</span><span class="string" id="7460445">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="7460457">,</span>&nbsp;<span class="ident" id="7460459">err</span><span class="op" id="7460462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460468">if</span>&nbsp;<span class="ident" id="7460471">g</span><span class="op" id="7460472">,</span>&nbsp;<span class="ident" id="7460474">e</span>&nbsp;<span class="op" id="7460476">:=</span>&nbsp;<span class="ident" id="7460479">part</span><span class="op" id="7460483">.</span><span class="ident" id="7460484">FormName</span><span class="op" id="7460492">(</span><span class="op" id="7460493">)</span><span class="op" id="7460494">,</span>&nbsp;<span class="string" id="7460496">&#34;myfile&#34;</span><span class="op" id="7460504">;</span>&nbsp;<span class="ident" id="7460506">g</span>&nbsp;<span class="op" id="7460508">!=</span>&nbsp;<span class="ident" id="7460511">e</span>&nbsp;<span class="op" id="7460513">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460517">t</span><span class="op" id="7460518">.</span><span class="ident" id="7460519">Errorf</span><span class="op" id="7460525">(</span><span class="string" id="7460526">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7460561">,</span>&nbsp;<span class="ident" id="7460563">e</span><span class="op" id="7460564">,</span>&nbsp;<span class="ident" id="7460566">g</span><span class="op" id="7460567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460573">slurp</span><span class="op" id="7460578">,</span>&nbsp;<span class="ident" id="7460580">err</span>&nbsp;<span class="op" id="7460584">:=</span>&nbsp;<span class="ident" id="7460587">ioutil</span><span class="op" id="7460593">.</span><span class="ident" id="7460594">ReadAll</span><span class="op" id="7460601">(</span><span class="ident" id="7460602">part</span><span class="op" id="7460606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460609">if</span>&nbsp;<span class="ident" id="7460612">err</span>&nbsp;<span class="op" id="7460616">!=</span>&nbsp;<span class="ident" id="7460619">nil</span>&nbsp;<span class="op" id="7460623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460627">t</span><span class="op" id="7460628">.</span><span class="ident" id="7460629">Fatalf</span><span class="op" id="7460635">(</span><span class="string" id="7460636">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7460657">,</span>&nbsp;<span class="ident" id="7460659">err</span><span class="op" id="7460662">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460668">if</span>&nbsp;<span class="ident" id="7460671">e</span><span class="op" id="7460672">,</span>&nbsp;<span class="ident" id="7460674">g</span>&nbsp;<span class="op" id="7460676">:=</span>&nbsp;<span class="builtintype" id="7460679">string</span><span class="op" id="7460685">(</span><span class="ident" id="7460686">fileContents</span><span class="op" id="7460698">)</span><span class="op" id="7460699">,</span>&nbsp;<span class="builtintype" id="7460701">string</span><span class="op" id="7460707">(</span><span class="ident" id="7460708">slurp</span><span class="op" id="7460713">)</span><span class="op" id="7460714">;</span>&nbsp;<span class="ident" id="7460716">e</span>&nbsp;<span class="op" id="7460718">!=</span>&nbsp;<span class="ident" id="7460721">g</span>&nbsp;<span class="op" id="7460723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460727">t</span><span class="op" id="7460728">.</span><span class="ident" id="7460729">Errorf</span><span class="op" id="7460735">(</span><span class="string" id="7460736">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7460770">,</span>&nbsp;<span class="ident" id="7460772">e</span><span class="op" id="7460773">,</span>&nbsp;<span class="ident" id="7460775">g</span><span class="op" id="7460776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460783">part</span><span class="op" id="7460787">,</span>&nbsp;<span class="ident" id="7460789">err</span>&nbsp;<span class="op" id="7460793">=</span>&nbsp;<span class="ident" id="7460795">r</span><span class="op" id="7460796">.</span><span class="ident" id="7460797">NextPart</span><span class="op" id="7460805">(</span><span class="op" id="7460806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460809">if</span>&nbsp;<span class="ident" id="7460812">err</span>&nbsp;<span class="op" id="7460816">!=</span>&nbsp;<span class="ident" id="7460819">nil</span>&nbsp;<span class="op" id="7460823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460827">t</span><span class="op" id="7460828">.</span><span class="ident" id="7460829">Fatalf</span><span class="op" id="7460835">(</span><span class="string" id="7460836">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="7460848">,</span>&nbsp;<span class="ident" id="7460850">err</span><span class="op" id="7460853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460859">if</span>&nbsp;<span class="ident" id="7460862">g</span><span class="op" id="7460863">,</span>&nbsp;<span class="ident" id="7460865">e</span>&nbsp;<span class="op" id="7460867">:=</span>&nbsp;<span class="ident" id="7460870">part</span><span class="op" id="7460874">.</span><span class="ident" id="7460875">FormName</span><span class="op" id="7460883">(</span><span class="op" id="7460884">)</span><span class="op" id="7460885">,</span>&nbsp;<span class="string" id="7460887">&#34;key&#34;</span><span class="op" id="7460892">;</span>&nbsp;<span class="ident" id="7460894">g</span>&nbsp;<span class="op" id="7460896">!=</span>&nbsp;<span class="ident" id="7460899">e</span>&nbsp;<span class="op" id="7460901">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460905">t</span><span class="op" id="7460906">.</span><span class="ident" id="7460907">Errorf</span><span class="op" id="7460913">(</span><span class="string" id="7460914">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7460949">,</span>&nbsp;<span class="ident" id="7460951">e</span><span class="op" id="7460952">,</span>&nbsp;<span class="ident" id="7460954">g</span><span class="op" id="7460955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7460958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7460961">slurp</span><span class="op" id="7460966">,</span>&nbsp;<span class="ident" id="7460968">err</span>&nbsp;<span class="op" id="7460972">=</span>&nbsp;<span class="ident" id="7460974">ioutil</span><span class="op" id="7460980">.</span><span class="ident" id="7460981">ReadAll</span><span class="op" id="7460988">(</span><span class="ident" id="7460989">part</span><span class="op" id="7460993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7460996">if</span>&nbsp;<span class="ident" id="7460999">err</span>&nbsp;<span class="op" id="7461003">!=</span>&nbsp;<span class="ident" id="7461006">nil</span>&nbsp;<span class="op" id="7461010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461014">t</span><span class="op" id="7461015">.</span><span class="ident" id="7461016">Fatalf</span><span class="op" id="7461022">(</span><span class="string" id="7461023">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7461044">,</span>&nbsp;<span class="ident" id="7461046">err</span><span class="op" id="7461049">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461055">if</span>&nbsp;<span class="ident" id="7461058">e</span><span class="op" id="7461059">,</span>&nbsp;<span class="ident" id="7461061">g</span>&nbsp;<span class="op" id="7461063">:=</span>&nbsp;<span class="string" id="7461066">&#34;val&#34;</span><span class="op" id="7461071">,</span>&nbsp;<span class="builtintype" id="7461073">string</span><span class="op" id="7461079">(</span><span class="ident" id="7461080">slurp</span><span class="op" id="7461085">)</span><span class="op" id="7461086">;</span>&nbsp;<span class="ident" id="7461088">e</span>&nbsp;<span class="op" id="7461090">!=</span>&nbsp;<span class="ident" id="7461093">g</span>&nbsp;<span class="op" id="7461095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461099">t</span><span class="op" id="7461100">.</span><span class="ident" id="7461101">Errorf</span><span class="op" id="7461107">(</span><span class="string" id="7461108">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7461142">,</span>&nbsp;<span class="ident" id="7461144">e</span><span class="op" id="7461145">,</span>&nbsp;<span class="ident" id="7461147">g</span><span class="op" id="7461148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461155">part</span><span class="op" id="7461159">,</span>&nbsp;<span class="ident" id="7461161">err</span>&nbsp;<span class="op" id="7461165">=</span>&nbsp;<span class="ident" id="7461167">r</span><span class="op" id="7461168">.</span><span class="ident" id="7461169">NextPart</span><span class="op" id="7461177">(</span><span class="op" id="7461178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461181">if</span>&nbsp;<span class="ident" id="7461184">part</span>&nbsp;<span class="op" id="7461189">!=</span>&nbsp;<span class="ident" id="7461192">nil</span>&nbsp;<span class="op" id="7461196">||</span>&nbsp;<span class="ident" id="7461199">err</span>&nbsp;<span class="op" id="7461203">==</span>&nbsp;<span class="ident" id="7461206">nil</span>&nbsp;<span class="op" id="7461210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461214">t</span><span class="op" id="7461215">.</span><span class="ident" id="7461216">Fatalf</span><span class="op" id="7461222">(</span><span class="string" id="7461223">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7461258">,</span>&nbsp;<span class="ident" id="7461260">part</span><span class="op" id="7461264">,</span>&nbsp;<span class="ident" id="7461266">err</span><span class="op" id="7461269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461272">}</span><br>
<span class="lineno"></span><span class="op" id="7461274">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7461277">func</span>&nbsp;<span class="ident" id="7461282">TestWriterSetBoundary</span><span class="op" id="7461303">(</span><span class="ident" id="7461304">t</span>&nbsp;<span class="op" id="7461306">*</span><span class="ident" id="7461307">testing</span><span class="op" id="7461314">.</span><span class="ident" id="7461315">T</span><span class="op" id="7461316">)</span>&nbsp;<span class="op" id="7461318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461321">var</span>&nbsp;<span class="ident" id="7461325">b</span>&nbsp;<span class="ident" id="7461327">bytes</span><span class="op" id="7461332">.</span><span class="ident" id="7461333">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461341">w</span>&nbsp;<span class="op" id="7461343">:=</span>&nbsp;<span class="ident" id="7461346">NewWriter</span><span class="op" id="7461355">(</span><span class="op" id="7461356">&amp;</span><span class="ident" id="7461357">b</span><span class="op" id="7461358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461361">tests</span>&nbsp;<span class="op" id="7461367">:=</span>&nbsp;<span class="op" id="7461370">[</span><span class="op" id="7461371">]</span><span class="keyword" id="7461372">struct</span>&nbsp;<span class="op" id="7461379">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461383">b</span>&nbsp;&nbsp;<span class="builtintype" id="7461386">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461395">ok</span>&nbsp;<span class="builtintype" id="7461398">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461404">}</span><span class="op" id="7461405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461409">{</span><span class="string" id="7461410">&#34;abc&#34;</span><span class="op" id="7461415">,</span>&nbsp;<span class="builtintype" id="7461417">true</span><span class="op" id="7461421">}</span><span class="op" id="7461422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461426">{</span><span class="string" id="7461427">&#34;&#34;</span><span class="op" id="7461429">,</span>&nbsp;<span class="builtintype" id="7461431">false</span><span class="op" id="7461436">}</span><span class="op" id="7461437">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461441">{</span><span class="string" id="7461442">&#34;ung√ºltig&#34;</span><span class="op" id="7461453">,</span>&nbsp;<span class="builtintype" id="7461455">false</span><span class="op" id="7461460">}</span><span class="op" id="7461461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461465">{</span><span class="string" id="7461466">&#34;!&#34;</span><span class="op" id="7461469">,</span>&nbsp;<span class="builtintype" id="7461471">false</span><span class="op" id="7461476">}</span><span class="op" id="7461477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461481">{</span><span class="ident" id="7461482">strings</span><span class="op" id="7461489">.</span><span class="ident" id="7461490">Repeat</span><span class="op" id="7461496">(</span><span class="string" id="7461497">&#34;x&#34;</span><span class="op" id="7461500">,</span>&nbsp;<span class="num" id="7461502">69</span><span class="op" id="7461504">)</span><span class="op" id="7461505">,</span>&nbsp;<span class="builtintype" id="7461507">true</span><span class="op" id="7461511">}</span><span class="op" id="7461512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461516">{</span><span class="ident" id="7461517">strings</span><span class="op" id="7461524">.</span><span class="ident" id="7461525">Repeat</span><span class="op" id="7461531">(</span><span class="string" id="7461532">&#34;x&#34;</span><span class="op" id="7461535">,</span>&nbsp;<span class="num" id="7461537">70</span><span class="op" id="7461539">)</span><span class="op" id="7461540">,</span>&nbsp;<span class="builtintype" id="7461542">false</span><span class="op" id="7461547">}</span><span class="op" id="7461548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461552">{</span><span class="string" id="7461553">&#34;bad!ascii!&#34;</span><span class="op" id="7461565">,</span>&nbsp;<span class="builtintype" id="7461567">false</span><span class="op" id="7461572">}</span><span class="op" id="7461573">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461577">{</span><span class="string" id="7461578">&#34;my-separator&#34;</span><span class="op" id="7461592">,</span>&nbsp;<span class="builtintype" id="7461594">true</span><span class="op" id="7461598">}</span><span class="op" id="7461599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461605">for</span>&nbsp;<span class="ident" id="7461609">i</span><span class="op" id="7461610">,</span>&nbsp;<span class="ident" id="7461612">tt</span>&nbsp;<span class="op" id="7461615">:=</span>&nbsp;<span class="keyword" id="7461618">range</span>&nbsp;<span class="ident" id="7461624">tests</span>&nbsp;<span class="op" id="7461630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461634">err</span>&nbsp;<span class="op" id="7461638">:=</span>&nbsp;<span class="ident" id="7461641">w</span><span class="op" id="7461642">.</span><span class="ident" id="7461643">SetBoundary</span><span class="op" id="7461654">(</span><span class="ident" id="7461655">tt</span><span class="op" id="7461657">.</span><span class="ident" id="7461658">b</span><span class="op" id="7461659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461663">got</span>&nbsp;<span class="op" id="7461667">:=</span>&nbsp;<span class="ident" id="7461670">err</span>&nbsp;<span class="op" id="7461674">==</span>&nbsp;<span class="ident" id="7461677">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461683">if</span>&nbsp;<span class="ident" id="7461686">got</span>&nbsp;<span class="op" id="7461690">!=</span>&nbsp;<span class="ident" id="7461693">tt</span><span class="op" id="7461695">.</span><span class="ident" id="7461696">ok</span>&nbsp;<span class="op" id="7461699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461704">t</span><span class="op" id="7461705">.</span><span class="ident" id="7461706">Errorf</span><span class="op" id="7461712">(</span><span class="string" id="7461713">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7461749">,</span>&nbsp;<span class="ident" id="7461751">i</span><span class="op" id="7461752">,</span>&nbsp;<span class="ident" id="7461754">tt</span><span class="op" id="7461756">.</span><span class="ident" id="7461757">b</span><span class="op" id="7461758">,</span>&nbsp;<span class="ident" id="7461760">got</span><span class="op" id="7461763">,</span>&nbsp;<span class="ident" id="7461765">err</span><span class="op" id="7461768">,</span>&nbsp;<span class="ident" id="7461770">tt</span><span class="op" id="7461772">.</span><span class="ident" id="7461773">ok</span><span class="op" id="7461775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461779">}</span>&nbsp;<span class="keyword" id="7461781">else</span>&nbsp;<span class="keyword" id="7461786">if</span>&nbsp;<span class="ident" id="7461789">tt</span><span class="op" id="7461791">.</span><span class="ident" id="7461792">ok</span>&nbsp;<span class="op" id="7461795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461800">got</span>&nbsp;<span class="op" id="7461804">:=</span>&nbsp;<span class="ident" id="7461807">w</span><span class="op" id="7461808">.</span><span class="ident" id="7461809">Boundary</span><span class="op" id="7461817">(</span><span class="op" id="7461818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461823">if</span>&nbsp;<span class="ident" id="7461826">got</span>&nbsp;<span class="op" id="7461830">!=</span>&nbsp;<span class="ident" id="7461833">tt</span><span class="op" id="7461835">.</span><span class="ident" id="7461836">b</span>&nbsp;<span class="op" id="7461838">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461844">t</span><span class="op" id="7461845">.</span><span class="ident" id="7461846">Errorf</span><span class="op" id="7461852">(</span><span class="string" id="7461853">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7461877">,</span>&nbsp;<span class="ident" id="7461879">got</span><span class="op" id="7461882">,</span>&nbsp;<span class="ident" id="7461884">tt</span><span class="op" id="7461886">.</span><span class="ident" id="7461887">b</span><span class="op" id="7461888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7461900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461903">w</span><span class="op" id="7461904">.</span><span class="ident" id="7461905">Close</span><span class="op" id="7461910">(</span><span class="op" id="7461911">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7461914">if</span>&nbsp;<span class="ident" id="7461917">got</span>&nbsp;<span class="op" id="7461921">:=</span>&nbsp;<span class="ident" id="7461924">b</span><span class="op" id="7461925">.</span><span class="ident" id="7461926">String</span><span class="op" id="7461932">(</span><span class="op" id="7461933">)</span><span class="op" id="7461934">;</span>&nbsp;<span class="op" id="7461936">!</span><span class="ident" id="7461937">strings</span><span class="op" id="7461944">.</span><span class="ident" id="7461945">Contains</span><span class="op" id="7461953">(</span><span class="ident" id="7461954">got</span><span class="op" id="7461957">,</span>&nbsp;<span class="string" id="7461959">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="7461985">)</span>&nbsp;<span class="op" id="7461987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7461991">t</span><span class="op" id="7461992">.</span><span class="ident" id="7461993">Errorf</span><span class="op" id="7461999">(</span><span class="string" id="7462000">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7462042">,</span>&nbsp;<span class="ident" id="7462044">got</span><span class="op" id="7462047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7462050">}</span><br>
<span class="lineno"></span><span class="op" id="7462052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7462055">func</span>&nbsp;<span class="ident" id="7462060">TestWriterBoundaryGoroutines</span><span class="op" id="7462088">(</span><span class="ident" id="7462089">t</span>&nbsp;<span class="op" id="7462091">*</span><span class="ident" id="7462092">testing</span><span class="op" id="7462099">.</span><span class="ident" id="7462100">T</span><span class="op" id="7462101">)</span>&nbsp;<span class="op" id="7462103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7462106">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7462182">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7462238">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7462299">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7462345">w</span>&nbsp;<span class="op" id="7462347">:=</span>&nbsp;<span class="ident" id="7462350">NewWriter</span><span class="op" id="7462359">(</span><span class="ident" id="7462360">ioutil</span><span class="op" id="7462366">.</span><span class="ident" id="7462367">Discard</span><span class="op" id="7462374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7462377">done</span>&nbsp;<span class="op" id="7462382">:=</span>&nbsp;<span class="builtinfunc" id="7462385">make</span><span class="op" id="7462389">(</span><span class="keyword" id="7462390">chan</span>&nbsp;<span class="builtintype" id="7462395">int</span><span class="op" id="7462398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7462401">go</span>&nbsp;<span class="keyword" id="7462404">func</span><span class="op" id="7462408">(</span><span class="op" id="7462409">)</span>&nbsp;<span class="op" id="7462411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7462415">w</span><span class="op" id="7462416">.</span><span class="ident" id="7462417">CreateFormField</span><span class="op" id="7462432">(</span><span class="string" id="7462433">&#34;foo&#34;</span><span class="op" id="7462438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7462442">done</span>&nbsp;<span class="op" id="7462447">&lt;-</span>&nbsp;<span class="num" id="7462450">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7462453">}</span><span class="op" id="7462454">(</span><span class="op" id="7462455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7462458">w</span><span class="op" id="7462459">.</span><span class="ident" id="7462460">Boundary</span><span class="op" id="7462468">(</span><span class="op" id="7462469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7462472">&lt;-</span><span class="ident" id="7462474">done</span><br>
<span class="lineno"></span><span class="op" id="7462479">}</span>
</div>
</body>
</html>
