<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1438470">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1438525">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1438579">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1438630">package</span>&nbsp;<span class="ident" id="1438638">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1438647">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1438705">import</span>&nbsp;<span class="string" id="1438712">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1438722">const</span>&nbsp;<span class="op" id="1438728">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1438731">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1438741">=</span>&nbsp;<span class="num" id="1438743">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1438746">hchanSize</span>&nbsp;<span class="op" id="1438756">=</span>&nbsp;<span class="ident" id="1438758">unsafe</span><span class="op" id="1438764">.</span><span class="ident" id="1438765">Sizeof</span><span class="op" id="1438771">(</span><span class="ident" id="1438772">hchan</span><span class="op" id="1438777">{</span><span class="op" id="1438778">}</span><span class="op" id="1438779">)</span>&nbsp;<span class="op" id="1438781">+</span>&nbsp;<span class="builtintype" id="1438783">uintptr</span><span class="op" id="1438790">(</span><span class="op" id="1438791">-</span><span class="builtintype" id="1438792">int</span><span class="op" id="1438795">(</span><span class="ident" id="1438796">unsafe</span><span class="op" id="1438802">.</span><span class="ident" id="1438803">Sizeof</span><span class="op" id="1438809">(</span><span class="ident" id="1438810">hchan</span><span class="op" id="1438815">{</span><span class="op" id="1438816">}</span><span class="op" id="1438817">)</span><span class="op" id="1438818">)</span><span class="op" id="1438819">&amp;</span><span class="op" id="1438820">(</span><span class="ident" id="1438821">maxAlign</span><span class="op" id="1438829">-</span><span class="num" id="1438830">1</span><span class="op" id="1438831">)</span><span class="op" id="1438832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1438835">debugChan</span>&nbsp;<span class="op" id="1438845">=</span>&nbsp;<span class="builtintype" id="1438847">false</span><br>
<span class="lineno">15</span><span class="op" id="1438853">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1438856">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1438918">func</span>&nbsp;<span class="ident" id="1438923">makechan</span><span class="op" id="1438931">(</span><span class="ident" id="1438932">t</span>&nbsp;<span class="op" id="1438934">*</span><span class="ident" id="1438935">chantype</span><span class="op" id="1438943">,</span>&nbsp;<span class="ident" id="1438945">size</span>&nbsp;<span class="ident" id="1438950">int64</span><span class="op" id="1438955">)</span>&nbsp;<span class="op" id="1438957">*</span><span class="ident" id="1438958">hchan</span>&nbsp;<span class="op" id="1438964">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1438967">elem</span>&nbsp;<span class="op" id="1438972">:=</span>&nbsp;<span class="ident" id="1438975">t</span><span class="op" id="1438976">.</span><span class="ident" id="1438977">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1438984">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439022">if</span>&nbsp;<span class="ident" id="1439025">elem</span><span class="op" id="1439029">.</span><span class="ident" id="1439030">size</span>&nbsp;<span class="op" id="1439035">&gt;=</span>&nbsp;<span class="num" id="1439038">1</span><span class="op" id="1439039">&lt;&lt;</span><span class="num" id="1439041">16</span>&nbsp;<span class="op" id="1439044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1439048">gothrow</span><span class="op" id="1439055">(</span><span class="string" id="1439056">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1439096">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1439099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439102">if</span>&nbsp;<span class="ident" id="1439105">hchanSize</span><span class="op" id="1439114">%</span><span class="ident" id="1439115">maxAlign</span>&nbsp;<span class="op" id="1439124">!=</span>&nbsp;<span class="num" id="1439127">0</span>&nbsp;<span class="op" id="1439129">||</span>&nbsp;<span class="ident" id="1439132">elem</span><span class="op" id="1439136">.</span><span class="ident" id="1439137">align</span>&nbsp;<span class="op" id="1439143">&gt;</span>&nbsp;<span class="ident" id="1439145">maxAlign</span>&nbsp;<span class="op" id="1439154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1439158">gothrow</span><span class="op" id="1439165">(</span><span class="string" id="1439166">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1439191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1439194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439197">if</span>&nbsp;<span class="ident" id="1439200">size</span>&nbsp;<span class="op" id="1439205">&lt;</span>&nbsp;<span class="num" id="1439207">0</span>&nbsp;<span class="op" id="1439209">||</span>&nbsp;<span class="ident" id="1439212">int64</span><span class="op" id="1439217">(</span><span class="builtintype" id="1439218">uintptr</span><span class="op" id="1439225">(</span><span class="ident" id="1439226">size</span><span class="op" id="1439230">)</span><span class="op" id="1439231">)</span>&nbsp;<span class="op" id="1439233">!=</span>&nbsp;<span class="ident" id="1439236">size</span>&nbsp;<span class="op" id="1439241">||</span>&nbsp;<span class="op" id="1439244">(</span><span class="ident" id="1439245">elem</span><span class="op" id="1439249">.</span><span class="ident" id="1439250">size</span>&nbsp;<span class="op" id="1439255">&gt;</span>&nbsp;<span class="num" id="1439257">0</span>&nbsp;<span class="op" id="1439259">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1439262">uintptr</span><span class="op" id="1439269">(</span><span class="ident" id="1439270">size</span><span class="op" id="1439274">)</span>&nbsp;<span class="op" id="1439276">&gt;</span>&nbsp;<span class="op" id="1439278">(</span><span class="ident" id="1439279">maxmem</span><span class="op" id="1439285">-</span><span class="ident" id="1439286">hchanSize</span><span class="op" id="1439295">)</span><span class="op" id="1439296">/</span><span class="builtintype" id="1439297">uintptr</span><span class="op" id="1439304">(</span><span class="ident" id="1439305">elem</span><span class="op" id="1439309">.</span><span class="ident" id="1439310">size</span><span class="op" id="1439314">)</span><span class="op" id="1439315">)</span>&nbsp;<span class="op" id="1439317">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1439321">panic</span><span class="op" id="1439326">(</span><span class="string" id="1439327">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1439356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1439359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439363">var</span>&nbsp;<span class="ident" id="1439367">c</span>&nbsp;<span class="op" id="1439369">*</span><span class="ident" id="1439370">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439377">if</span>&nbsp;<span class="ident" id="1439380">elem</span><span class="op" id="1439384">.</span><span class="ident" id="1439385">kind</span><span class="op" id="1439389">&amp;</span><span class="ident" id="1439390">kindNoPointers</span>&nbsp;<span class="op" id="1439405">!=</span>&nbsp;<span class="num" id="1439408">0</span>&nbsp;<span class="op" id="1439410">||</span>&nbsp;<span class="ident" id="1439413">size</span>&nbsp;<span class="op" id="1439418">==</span>&nbsp;<span class="num" id="1439421">0</span>&nbsp;<span class="op" id="1439423">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439427">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439461">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439531">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439597">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439678">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1439753">c</span>&nbsp;<span class="op" id="1439755">=</span>&nbsp;<span class="op" id="1439757">(</span><span class="op" id="1439758">*</span><span class="ident" id="1439759">hchan</span><span class="op" id="1439764">)</span><span class="op" id="1439765">(</span><span class="ident" id="1439766">mallocgc</span><span class="op" id="1439774">(</span><span class="ident" id="1439775">hchanSize</span><span class="op" id="1439784">+</span><span class="builtintype" id="1439785">uintptr</span><span class="op" id="1439792">(</span><span class="ident" id="1439793">size</span><span class="op" id="1439797">)</span><span class="op" id="1439798">*</span><span class="builtintype" id="1439799">uintptr</span><span class="op" id="1439806">(</span><span class="ident" id="1439807">elem</span><span class="op" id="1439811">.</span><span class="ident" id="1439812">size</span><span class="op" id="1439816">)</span><span class="op" id="1439817">,</span>&nbsp;<span class="ident" id="1439819">nil</span><span class="op" id="1439822">,</span>&nbsp;<span class="ident" id="1439824">flagNoScan</span><span class="op" id="1439834">)</span><span class="op" id="1439835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1439839">if</span>&nbsp;<span class="ident" id="1439842">size</span>&nbsp;<span class="op" id="1439847">&gt;</span>&nbsp;<span class="num" id="1439849">0</span>&nbsp;<span class="op" id="1439851">&amp;&amp;</span>&nbsp;<span class="ident" id="1439854">elem</span><span class="op" id="1439858">.</span><span class="ident" id="1439859">size</span>&nbsp;<span class="op" id="1439864">!=</span>&nbsp;<span class="num" id="1439867">0</span>&nbsp;<span class="op" id="1439869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1439874">c</span><span class="op" id="1439875">.</span><span class="ident" id="1439876">buf</span>&nbsp;<span class="op" id="1439880">=</span>&nbsp;<span class="op" id="1439882">(</span><span class="op" id="1439883">*</span><span class="builtintype" id="1439884">uint8</span><span class="op" id="1439889">)</span><span class="op" id="1439890">(</span><span class="ident" id="1439891">add</span><span class="op" id="1439894">(</span><span class="ident" id="1439895">unsafe</span><span class="op" id="1439901">.</span><span class="ident" id="1439902">Pointer</span><span class="op" id="1439909">(</span><span class="ident" id="1439910">c</span><span class="op" id="1439911">)</span><span class="op" id="1439912">,</span>&nbsp;<span class="ident" id="1439914">hchanSize</span><span class="op" id="1439923">)</span><span class="op" id="1439924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1439928">}</span>&nbsp;<span class="keyword" id="1439930">else</span>&nbsp;<span class="op" id="1439935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1439940">c</span><span class="op" id="1439941">.</span><span class="ident" id="1439942">buf</span>&nbsp;<span class="op" id="1439946">=</span>&nbsp;<span class="op" id="1439948">(</span><span class="op" id="1439949">*</span><span class="builtintype" id="1439950">uint8</span><span class="op" id="1439955">)</span><span class="op" id="1439956">(</span><span class="ident" id="1439957">unsafe</span><span class="op" id="1439963">.</span><span class="ident" id="1439964">Pointer</span><span class="op" id="1439971">(</span><span class="ident" id="1439972">c</span><span class="op" id="1439973">)</span><span class="op" id="1439974">)</span>&nbsp;<span class="comment" id="1439976">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1440034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1440037">}</span>&nbsp;<span class="keyword" id="1440039">else</span>&nbsp;<span class="op" id="1440044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440048">c</span>&nbsp;<span class="op" id="1440050">=</span>&nbsp;<span class="builtinfunc" id="1440052">new</span><span class="op" id="1440055">(</span><span class="ident" id="1440056">hchan</span><span class="op" id="1440061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440065">c</span><span class="op" id="1440066">.</span><span class="ident" id="1440067">buf</span>&nbsp;<span class="op" id="1440071">=</span>&nbsp;<span class="op" id="1440073">(</span><span class="op" id="1440074">*</span><span class="builtintype" id="1440075">uint8</span><span class="op" id="1440080">)</span><span class="op" id="1440081">(</span><span class="ident" id="1440082">newarray</span><span class="op" id="1440090">(</span><span class="ident" id="1440091">elem</span><span class="op" id="1440095">,</span>&nbsp;<span class="builtintype" id="1440097">uintptr</span><span class="op" id="1440104">(</span><span class="ident" id="1440105">size</span><span class="op" id="1440109">)</span><span class="op" id="1440110">)</span><span class="op" id="1440111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1440114">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440117">c</span><span class="op" id="1440118">.</span><span class="ident" id="1440119">elemsize</span>&nbsp;<span class="op" id="1440128">=</span>&nbsp;<span class="builtintype" id="1440130">uint16</span><span class="op" id="1440136">(</span><span class="ident" id="1440137">elem</span><span class="op" id="1440141">.</span><span class="ident" id="1440142">size</span><span class="op" id="1440146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440149">c</span><span class="op" id="1440150">.</span><span class="ident" id="1440151">elemtype</span>&nbsp;<span class="op" id="1440160">=</span>&nbsp;<span class="ident" id="1440162">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440168">c</span><span class="op" id="1440169">.</span><span class="ident" id="1440170">dataqsiz</span>&nbsp;<span class="op" id="1440179">=</span>&nbsp;<span class="builtintype" id="1440181">uint</span><span class="op" id="1440185">(</span><span class="ident" id="1440186">size</span><span class="op" id="1440190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1440194">if</span>&nbsp;<span class="ident" id="1440197">debugChan</span>&nbsp;<span class="op" id="1440207">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1440211">print</span><span class="op" id="1440216">(</span><span class="string" id="1440217">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1440234">,</span>&nbsp;<span class="ident" id="1440236">c</span><span class="op" id="1440237">,</span>&nbsp;<span class="string" id="1440239">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1440252">,</span>&nbsp;<span class="ident" id="1440254">elem</span><span class="op" id="1440258">.</span><span class="ident" id="1440259">size</span><span class="op" id="1440263">,</span>&nbsp;<span class="string" id="1440265">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1440277">,</span>&nbsp;<span class="ident" id="1440279">elem</span><span class="op" id="1440283">.</span><span class="ident" id="1440284">alg</span><span class="op" id="1440287">,</span>&nbsp;<span class="string" id="1440289">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1440302">,</span>&nbsp;<span class="ident" id="1440304">size</span><span class="op" id="1440308">,</span>&nbsp;<span class="string" id="1440310">&#34;\n&#34;</span><span class="op" id="1440314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1440317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1440320">return</span>&nbsp;<span class="ident" id="1440327">c</span><br>
<span class="lineno"></span><span class="op" id="1440329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1440332">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1440392">func</span>&nbsp;<span class="ident" id="1440397">chanbuf</span><span class="op" id="1440404">(</span><span class="ident" id="1440405">c</span>&nbsp;<span class="op" id="1440407">*</span><span class="ident" id="1440408">hchan</span><span class="op" id="1440413">,</span>&nbsp;<span class="ident" id="1440415">i</span>&nbsp;<span class="builtintype" id="1440417">uint</span><span class="op" id="1440421">)</span>&nbsp;<span class="ident" id="1440423">unsafe</span><span class="op" id="1440429">.</span><span class="ident" id="1440430">Pointer</span>&nbsp;<span class="op" id="1440438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1440441">return</span>&nbsp;<span class="ident" id="1440448">add</span><span class="op" id="1440451">(</span><span class="ident" id="1440452">unsafe</span><span class="op" id="1440458">.</span><span class="ident" id="1440459">Pointer</span><span class="op" id="1440466">(</span><span class="ident" id="1440467">c</span><span class="op" id="1440468">.</span><span class="ident" id="1440469">buf</span><span class="op" id="1440472">)</span><span class="op" id="1440473">,</span>&nbsp;<span class="builtintype" id="1440475">uintptr</span><span class="op" id="1440482">(</span><span class="ident" id="1440483">i</span><span class="op" id="1440484">)</span><span class="op" id="1440485">*</span><span class="builtintype" id="1440486">uintptr</span><span class="op" id="1440493">(</span><span class="ident" id="1440494">c</span><span class="op" id="1440495">.</span><span class="ident" id="1440496">elemsize</span><span class="op" id="1440504">)</span><span class="op" id="1440505">)</span><br>
<span class="lineno"></span><span class="op" id="1440507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1440510">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1440555">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1440568">func</span>&nbsp;<span class="ident" id="1440573">chansend1</span><span class="op" id="1440582">(</span><span class="ident" id="1440583">t</span>&nbsp;<span class="op" id="1440585">*</span><span class="ident" id="1440586">chantype</span><span class="op" id="1440594">,</span>&nbsp;<span class="ident" id="1440596">c</span>&nbsp;<span class="op" id="1440598">*</span><span class="ident" id="1440599">hchan</span><span class="op" id="1440604">,</span>&nbsp;<span class="ident" id="1440606">elem</span>&nbsp;<span class="ident" id="1440611">unsafe</span><span class="op" id="1440617">.</span><span class="ident" id="1440618">Pointer</span><span class="op" id="1440625">)</span>&nbsp;<span class="op" id="1440627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1440630">chansend</span><span class="op" id="1440638">(</span><span class="ident" id="1440639">t</span><span class="op" id="1440640">,</span>&nbsp;<span class="ident" id="1440642">c</span><span class="op" id="1440643">,</span>&nbsp;<span class="ident" id="1440645">elem</span><span class="op" id="1440649">,</span>&nbsp;<span class="builtintype" id="1440651">true</span><span class="op" id="1440655">,</span>&nbsp;<span class="ident" id="1440657">getcallerpc</span><span class="op" id="1440668">(</span><span class="ident" id="1440669">unsafe</span><span class="op" id="1440675">.</span><span class="ident" id="1440676">Pointer</span><span class="op" id="1440683">(</span><span class="op" id="1440684">&amp;</span><span class="ident" id="1440685">t</span><span class="op" id="1440686">)</span><span class="op" id="1440687">)</span><span class="op" id="1440688">)</span><br>
<span class="lineno"></span><span class="op" id="1440690">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1440693">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1441027">func</span>&nbsp;<span class="ident" id="1441032">chansend</span><span class="op" id="1441040">(</span><span class="ident" id="1441041">t</span>&nbsp;<span class="op" id="1441043">*</span><span class="ident" id="1441044">chantype</span><span class="op" id="1441052">,</span>&nbsp;<span class="ident" id="1441054">c</span>&nbsp;<span class="op" id="1441056">*</span><span class="ident" id="1441057">hchan</span><span class="op" id="1441062">,</span>&nbsp;<span class="ident" id="1441064">ep</span>&nbsp;<span class="ident" id="1441067">unsafe</span><span class="op" id="1441073">.</span><span class="ident" id="1441074">Pointer</span><span class="op" id="1441081">,</span>&nbsp;<span class="ident" id="1441083">block</span>&nbsp;<span class="builtintype" id="1441089">bool</span><span class="op" id="1441093">,</span>&nbsp;<span class="ident" id="1441095">callerpc</span>&nbsp;<span class="builtintype" id="1441104">uintptr</span><span class="op" id="1441111">)</span>&nbsp;<span class="builtintype" id="1441113">bool</span>&nbsp;<span class="op" id="1441118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441121">if</span>&nbsp;<span class="ident" id="1441124">raceenabled</span>&nbsp;<span class="op" id="1441136">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1441140">raceReadObjectPC</span><span class="op" id="1441156">(</span><span class="ident" id="1441157">t</span><span class="op" id="1441158">.</span><span class="ident" id="1441159">elem</span><span class="op" id="1441163">,</span>&nbsp;<span class="ident" id="1441165">ep</span><span class="op" id="1441167">,</span>&nbsp;<span class="ident" id="1441169">callerpc</span><span class="op" id="1441177">,</span>&nbsp;<span class="ident" id="1441179">funcPC</span><span class="op" id="1441185">(</span><span class="ident" id="1441186">chansend</span><span class="op" id="1441194">)</span><span class="op" id="1441195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1441198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441202">if</span>&nbsp;<span class="ident" id="1441205">c</span>&nbsp;<span class="op" id="1441207">==</span>&nbsp;<span class="ident" id="1441210">nil</span>&nbsp;<span class="op" id="1441214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441218">if</span>&nbsp;<span class="op" id="1441221">!</span><span class="ident" id="1441222">block</span>&nbsp;<span class="op" id="1441228">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441233">return</span>&nbsp;<span class="builtintype" id="1441240">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1441248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1441252">gopark</span><span class="op" id="1441258">(</span><span class="ident" id="1441259">nil</span><span class="op" id="1441262">,</span>&nbsp;<span class="ident" id="1441264">nil</span><span class="op" id="1441267">,</span>&nbsp;<span class="string" id="1441269">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1441291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1441295">gothrow</span><span class="op" id="1441302">(</span><span class="string" id="1441303">&#34;unreachable&#34;</span><span class="op" id="1441316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1441319">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441323">if</span>&nbsp;<span class="ident" id="1441326">debugChan</span>&nbsp;<span class="op" id="1441336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1441340">print</span><span class="op" id="1441345">(</span><span class="string" id="1441346">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1441363">,</span>&nbsp;<span class="ident" id="1441365">c</span><span class="op" id="1441366">,</span>&nbsp;<span class="string" id="1441368">&#34;\n&#34;</span><span class="op" id="1441372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1441375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1441379">if</span>&nbsp;<span class="ident" id="1441382">raceenabled</span>&nbsp;<span class="op" id="1441394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1441398">racereadpc</span><span class="op" id="1441408">(</span><span class="ident" id="1441409">unsafe</span><span class="op" id="1441415">.</span><span class="ident" id="1441416">Pointer</span><span class="op" id="1441423">(</span><span class="ident" id="1441424">c</span><span class="op" id="1441425">)</span><span class="op" id="1441426">,</span>&nbsp;<span class="ident" id="1441428">callerpc</span><span class="op" id="1441436">,</span>&nbsp;<span class="ident" id="1441438">funcPC</span><span class="op" id="1441444">(</span><span class="ident" id="1441445">chansend</span><span class="op" id="1441453">)</span><span class="op" id="1441454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1441457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441461">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441544">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441548">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441631">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441713">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441801">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441876">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441965">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442046">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442133">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442178">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442182">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442268">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442352">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442408">if</span>&nbsp;<span class="op" id="1442411">!</span><span class="ident" id="1442412">block</span>&nbsp;<span class="op" id="1442418">&amp;&amp;</span>&nbsp;<span class="ident" id="1442421">c</span><span class="op" id="1442422">.</span><span class="ident" id="1442423">closed</span>&nbsp;<span class="op" id="1442430">==</span>&nbsp;<span class="num" id="1442433">0</span>&nbsp;<span class="op" id="1442435">&amp;&amp;</span>&nbsp;<span class="op" id="1442438">(</span><span class="op" id="1442439">(</span><span class="ident" id="1442440">c</span><span class="op" id="1442441">.</span><span class="ident" id="1442442">dataqsiz</span>&nbsp;<span class="op" id="1442451">==</span>&nbsp;<span class="num" id="1442454">0</span>&nbsp;<span class="op" id="1442456">&amp;&amp;</span>&nbsp;<span class="ident" id="1442459">c</span><span class="op" id="1442460">.</span><span class="ident" id="1442461">recvq</span><span class="op" id="1442466">.</span><span class="ident" id="1442467">first</span>&nbsp;<span class="op" id="1442473">==</span>&nbsp;<span class="ident" id="1442476">nil</span><span class="op" id="1442479">)</span>&nbsp;<span class="op" id="1442481">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1442486">(</span><span class="ident" id="1442487">c</span><span class="op" id="1442488">.</span><span class="ident" id="1442489">dataqsiz</span>&nbsp;<span class="op" id="1442498">&gt;</span>&nbsp;<span class="num" id="1442500">0</span>&nbsp;<span class="op" id="1442502">&amp;&amp;</span>&nbsp;<span class="ident" id="1442505">c</span><span class="op" id="1442506">.</span><span class="ident" id="1442507">qcount</span>&nbsp;<span class="op" id="1442514">==</span>&nbsp;<span class="ident" id="1442517">c</span><span class="op" id="1442518">.</span><span class="ident" id="1442519">dataqsiz</span><span class="op" id="1442527">)</span><span class="op" id="1442528">)</span>&nbsp;<span class="op" id="1442530">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442534">return</span>&nbsp;<span class="builtintype" id="1442541">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1442548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442552">var</span>&nbsp;<span class="ident" id="1442556">t0</span>&nbsp;<span class="ident" id="1442559">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442566">if</span>&nbsp;<span class="ident" id="1442569">blockprofilerate</span>&nbsp;<span class="op" id="1442586">&gt;</span>&nbsp;<span class="num" id="1442588">0</span>&nbsp;<span class="op" id="1442590">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442594">t0</span>&nbsp;<span class="op" id="1442597">=</span>&nbsp;<span class="ident" id="1442599">cputicks</span><span class="op" id="1442607">(</span><span class="op" id="1442608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1442611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442615">lock</span><span class="op" id="1442619">(</span><span class="op" id="1442620">&amp;</span><span class="ident" id="1442621">c</span><span class="op" id="1442622">.</span><span class="ident" id="1442623">lock</span><span class="op" id="1442627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442630">if</span>&nbsp;<span class="ident" id="1442633">c</span><span class="op" id="1442634">.</span><span class="ident" id="1442635">closed</span>&nbsp;<span class="op" id="1442642">!=</span>&nbsp;<span class="num" id="1442645">0</span>&nbsp;<span class="op" id="1442647">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442651">unlock</span><span class="op" id="1442657">(</span><span class="op" id="1442658">&amp;</span><span class="ident" id="1442659">c</span><span class="op" id="1442660">.</span><span class="ident" id="1442661">lock</span><span class="op" id="1442665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1442669">panic</span><span class="op" id="1442674">(</span><span class="string" id="1442675">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1442699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1442702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442706">if</span>&nbsp;<span class="ident" id="1442709">c</span><span class="op" id="1442710">.</span><span class="ident" id="1442711">dataqsiz</span>&nbsp;<span class="op" id="1442720">==</span>&nbsp;<span class="num" id="1442723">0</span>&nbsp;<span class="op" id="1442725">{</span>&nbsp;<span class="comment" id="1442727">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442752">sg</span>&nbsp;<span class="op" id="1442755">:=</span>&nbsp;<span class="ident" id="1442758">c</span><span class="op" id="1442759">.</span><span class="ident" id="1442760">recvq</span><span class="op" id="1442765">.</span><span class="ident" id="1442766">dequeue</span><span class="op" id="1442773">(</span><span class="op" id="1442774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442778">if</span>&nbsp;<span class="ident" id="1442781">sg</span>&nbsp;<span class="op" id="1442784">!=</span>&nbsp;<span class="ident" id="1442787">nil</span>&nbsp;<span class="op" id="1442791">{</span>&nbsp;<span class="comment" id="1442793">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442824">if</span>&nbsp;<span class="ident" id="1442827">raceenabled</span>&nbsp;<span class="op" id="1442839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442845">racesync</span><span class="op" id="1442853">(</span><span class="ident" id="1442854">c</span><span class="op" id="1442855">,</span>&nbsp;<span class="ident" id="1442857">sg</span><span class="op" id="1442859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1442864">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442869">unlock</span><span class="op" id="1442875">(</span><span class="op" id="1442876">&amp;</span><span class="ident" id="1442877">c</span><span class="op" id="1442878">.</span><span class="ident" id="1442879">lock</span><span class="op" id="1442883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442889">recvg</span>&nbsp;<span class="op" id="1442895">:=</span>&nbsp;<span class="ident" id="1442898">sg</span><span class="op" id="1442900">.</span><span class="ident" id="1442901">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1442906">if</span>&nbsp;<span class="ident" id="1442909">sg</span><span class="op" id="1442911">.</span><span class="ident" id="1442912">elem</span>&nbsp;<span class="op" id="1442917">!=</span>&nbsp;<span class="ident" id="1442920">nil</span>&nbsp;<span class="op" id="1442924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442930">memmove</span><span class="op" id="1442937">(</span><span class="ident" id="1442938">unsafe</span><span class="op" id="1442944">.</span><span class="ident" id="1442945">Pointer</span><span class="op" id="1442952">(</span><span class="ident" id="1442953">sg</span><span class="op" id="1442955">.</span><span class="ident" id="1442956">elem</span><span class="op" id="1442960">)</span><span class="op" id="1442961">,</span>&nbsp;<span class="ident" id="1442963">ep</span><span class="op" id="1442965">,</span>&nbsp;<span class="builtintype" id="1442967">uintptr</span><span class="op" id="1442974">(</span><span class="ident" id="1442975">c</span><span class="op" id="1442976">.</span><span class="ident" id="1442977">elemsize</span><span class="op" id="1442985">)</span><span class="op" id="1442986">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1442992">sg</span><span class="op" id="1442994">.</span><span class="ident" id="1442995">elem</span>&nbsp;<span class="op" id="1443000">=</span>&nbsp;<span class="ident" id="1443002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443014">recvg</span><span class="op" id="1443019">.</span><span class="ident" id="1443020">param</span>&nbsp;<span class="op" id="1443026">=</span>&nbsp;<span class="ident" id="1443028">unsafe</span><span class="op" id="1443034">.</span><span class="ident" id="1443035">Pointer</span><span class="op" id="1443042">(</span><span class="ident" id="1443043">sg</span><span class="op" id="1443045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443050">if</span>&nbsp;<span class="ident" id="1443053">sg</span><span class="op" id="1443055">.</span><span class="ident" id="1443056">releasetime</span>&nbsp;<span class="op" id="1443068">!=</span>&nbsp;<span class="num" id="1443071">0</span>&nbsp;<span class="op" id="1443073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443079">sg</span><span class="op" id="1443081">.</span><span class="ident" id="1443082">releasetime</span>&nbsp;<span class="op" id="1443094">=</span>&nbsp;<span class="ident" id="1443096">cputicks</span><span class="op" id="1443104">(</span><span class="op" id="1443105">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443115">goready</span><span class="op" id="1443122">(</span><span class="ident" id="1443123">recvg</span><span class="op" id="1443128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443133">return</span>&nbsp;<span class="builtintype" id="1443140">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443152">if</span>&nbsp;<span class="op" id="1443155">!</span><span class="ident" id="1443156">block</span>&nbsp;<span class="op" id="1443162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443167">unlock</span><span class="op" id="1443173">(</span><span class="op" id="1443174">&amp;</span><span class="ident" id="1443175">c</span><span class="op" id="1443176">.</span><span class="ident" id="1443177">lock</span><span class="op" id="1443181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443186">return</span>&nbsp;<span class="builtintype" id="1443193">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1443206">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443257">gp</span>&nbsp;<span class="op" id="1443260">:=</span>&nbsp;<span class="ident" id="1443263">getg</span><span class="op" id="1443267">(</span><span class="op" id="1443268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443272">mysg</span>&nbsp;<span class="op" id="1443277">:=</span>&nbsp;<span class="ident" id="1443280">acquireSudog</span><span class="op" id="1443292">(</span><span class="op" id="1443293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443297">mysg</span><span class="op" id="1443301">.</span><span class="ident" id="1443302">releasetime</span>&nbsp;<span class="op" id="1443314">=</span>&nbsp;<span class="num" id="1443316">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443320">if</span>&nbsp;<span class="ident" id="1443323">t0</span>&nbsp;<span class="op" id="1443326">!=</span>&nbsp;<span class="num" id="1443329">0</span>&nbsp;<span class="op" id="1443331">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443336">mysg</span><span class="op" id="1443340">.</span><span class="ident" id="1443341">releasetime</span>&nbsp;<span class="op" id="1443353">=</span>&nbsp;<span class="op" id="1443355">-</span><span class="num" id="1443356">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443364">mysg</span><span class="op" id="1443368">.</span><span class="ident" id="1443369">elem</span>&nbsp;<span class="op" id="1443374">=</span>&nbsp;<span class="ident" id="1443376">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443381">mysg</span><span class="op" id="1443385">.</span><span class="ident" id="1443386">waitlink</span>&nbsp;<span class="op" id="1443395">=</span>&nbsp;<span class="ident" id="1443397">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443403">gp</span><span class="op" id="1443405">.</span><span class="ident" id="1443406">waiting</span>&nbsp;<span class="op" id="1443414">=</span>&nbsp;<span class="ident" id="1443416">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443423">mysg</span><span class="op" id="1443427">.</span><span class="ident" id="1443428">g</span>&nbsp;<span class="op" id="1443430">=</span>&nbsp;<span class="ident" id="1443432">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443437">mysg</span><span class="op" id="1443441">.</span><span class="ident" id="1443442">selectdone</span>&nbsp;<span class="op" id="1443453">=</span>&nbsp;<span class="ident" id="1443455">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443461">gp</span><span class="op" id="1443463">.</span><span class="ident" id="1443464">param</span>&nbsp;<span class="op" id="1443470">=</span>&nbsp;<span class="ident" id="1443472">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443478">c</span><span class="op" id="1443479">.</span><span class="ident" id="1443480">sendq</span><span class="op" id="1443485">.</span><span class="ident" id="1443486">enqueue</span><span class="op" id="1443493">(</span><span class="ident" id="1443494">mysg</span><span class="op" id="1443498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443502">goparkunlock</span><span class="op" id="1443514">(</span><span class="op" id="1443515">&amp;</span><span class="ident" id="1443516">c</span><span class="op" id="1443517">.</span><span class="ident" id="1443518">lock</span><span class="op" id="1443522">,</span>&nbsp;<span class="string" id="1443524">&#34;chan&nbsp;send&#34;</span><span class="op" id="1443535">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1443540">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443565">if</span>&nbsp;<span class="ident" id="1443568">mysg</span>&nbsp;<span class="op" id="1443573">!=</span>&nbsp;<span class="ident" id="1443576">gp</span><span class="op" id="1443578">.</span><span class="ident" id="1443579">waiting</span>&nbsp;<span class="op" id="1443587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443592">gothrow</span><span class="op" id="1443599">(</span><span class="string" id="1443600">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1443630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443634">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443638">gp</span><span class="op" id="1443640">.</span><span class="ident" id="1443641">waiting</span>&nbsp;<span class="op" id="1443649">=</span>&nbsp;<span class="ident" id="1443651">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443657">if</span>&nbsp;<span class="ident" id="1443660">gp</span><span class="op" id="1443662">.</span><span class="ident" id="1443663">param</span>&nbsp;<span class="op" id="1443669">==</span>&nbsp;<span class="ident" id="1443672">nil</span>&nbsp;<span class="op" id="1443676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443681">if</span>&nbsp;<span class="ident" id="1443684">c</span><span class="op" id="1443685">.</span><span class="ident" id="1443686">closed</span>&nbsp;<span class="op" id="1443693">==</span>&nbsp;<span class="num" id="1443696">0</span>&nbsp;<span class="op" id="1443698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443704">gothrow</span><span class="op" id="1443711">(</span><span class="string" id="1443712">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1443739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443744">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1443749">panic</span><span class="op" id="1443754">(</span><span class="string" id="1443755">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1443779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443787">gp</span><span class="op" id="1443789">.</span><span class="ident" id="1443790">param</span>&nbsp;<span class="op" id="1443796">=</span>&nbsp;<span class="ident" id="1443798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443804">if</span>&nbsp;<span class="ident" id="1443807">mysg</span><span class="op" id="1443811">.</span><span class="ident" id="1443812">releasetime</span>&nbsp;<span class="op" id="1443824">&gt;</span>&nbsp;<span class="num" id="1443826">0</span>&nbsp;<span class="op" id="1443828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443833">blockevent</span><span class="op" id="1443843">(</span><span class="ident" id="1443844">int64</span><span class="op" id="1443849">(</span><span class="ident" id="1443850">mysg</span><span class="op" id="1443854">.</span><span class="ident" id="1443855">releasetime</span><span class="op" id="1443866">)</span><span class="op" id="1443867">-</span><span class="ident" id="1443868">t0</span><span class="op" id="1443870">,</span>&nbsp;<span class="num" id="1443872">2</span><span class="op" id="1443873">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443881">releaseSudog</span><span class="op" id="1443893">(</span><span class="ident" id="1443894">mysg</span><span class="op" id="1443898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443902">return</span>&nbsp;<span class="builtintype" id="1443909">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1443915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1443919">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1443944">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1443986">var</span>&nbsp;<span class="ident" id="1443990">t1</span>&nbsp;<span class="ident" id="1443993">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444000">for</span>&nbsp;<span class="ident" id="1444004">c</span><span class="op" id="1444005">.</span><span class="ident" id="1444006">qcount</span>&nbsp;<span class="op" id="1444013">&gt;=</span>&nbsp;<span class="ident" id="1444016">c</span><span class="op" id="1444017">.</span><span class="ident" id="1444018">dataqsiz</span>&nbsp;<span class="op" id="1444027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444031">if</span>&nbsp;<span class="op" id="1444034">!</span><span class="ident" id="1444035">block</span>&nbsp;<span class="op" id="1444041">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444046">unlock</span><span class="op" id="1444052">(</span><span class="op" id="1444053">&amp;</span><span class="ident" id="1444054">c</span><span class="op" id="1444055">.</span><span class="ident" id="1444056">lock</span><span class="op" id="1444060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444065">return</span>&nbsp;<span class="builtintype" id="1444072">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444084">gp</span>&nbsp;<span class="op" id="1444087">:=</span>&nbsp;<span class="ident" id="1444090">getg</span><span class="op" id="1444094">(</span><span class="op" id="1444095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444099">mysg</span>&nbsp;<span class="op" id="1444104">:=</span>&nbsp;<span class="ident" id="1444107">acquireSudog</span><span class="op" id="1444119">(</span><span class="op" id="1444120">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444124">mysg</span><span class="op" id="1444128">.</span><span class="ident" id="1444129">releasetime</span>&nbsp;<span class="op" id="1444141">=</span>&nbsp;<span class="num" id="1444143">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444147">if</span>&nbsp;<span class="ident" id="1444150">t0</span>&nbsp;<span class="op" id="1444153">!=</span>&nbsp;<span class="num" id="1444156">0</span>&nbsp;<span class="op" id="1444158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444163">mysg</span><span class="op" id="1444167">.</span><span class="ident" id="1444168">releasetime</span>&nbsp;<span class="op" id="1444180">=</span>&nbsp;<span class="op" id="1444182">-</span><span class="num" id="1444183">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444191">mysg</span><span class="op" id="1444195">.</span><span class="ident" id="1444196">g</span>&nbsp;<span class="op" id="1444198">=</span>&nbsp;<span class="ident" id="1444200">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444205">mysg</span><span class="op" id="1444209">.</span><span class="ident" id="1444210">elem</span>&nbsp;<span class="op" id="1444215">=</span>&nbsp;<span class="ident" id="1444217">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444223">mysg</span><span class="op" id="1444227">.</span><span class="ident" id="1444228">selectdone</span>&nbsp;<span class="op" id="1444239">=</span>&nbsp;<span class="ident" id="1444241">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444247">c</span><span class="op" id="1444248">.</span><span class="ident" id="1444249">sendq</span><span class="op" id="1444254">.</span><span class="ident" id="1444255">enqueue</span><span class="op" id="1444262">(</span><span class="ident" id="1444263">mysg</span><span class="op" id="1444267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444271">goparkunlock</span><span class="op" id="1444283">(</span><span class="op" id="1444284">&amp;</span><span class="ident" id="1444285">c</span><span class="op" id="1444286">.</span><span class="ident" id="1444287">lock</span><span class="op" id="1444291">,</span>&nbsp;<span class="string" id="1444293">&#34;chan&nbsp;send&#34;</span><span class="op" id="1444304">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1444309">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444345">if</span>&nbsp;<span class="ident" id="1444348">mysg</span><span class="op" id="1444352">.</span><span class="ident" id="1444353">releasetime</span>&nbsp;<span class="op" id="1444365">&gt;</span>&nbsp;<span class="num" id="1444367">0</span>&nbsp;<span class="op" id="1444369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444374">t1</span>&nbsp;<span class="op" id="1444377">=</span>&nbsp;<span class="ident" id="1444379">mysg</span><span class="op" id="1444383">.</span><span class="ident" id="1444384">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444402">releaseSudog</span><span class="op" id="1444414">(</span><span class="ident" id="1444415">mysg</span><span class="op" id="1444419">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444423">lock</span><span class="op" id="1444427">(</span><span class="op" id="1444428">&amp;</span><span class="ident" id="1444429">c</span><span class="op" id="1444430">.</span><span class="ident" id="1444431">lock</span><span class="op" id="1444435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444439">if</span>&nbsp;<span class="ident" id="1444442">c</span><span class="op" id="1444443">.</span><span class="ident" id="1444444">closed</span>&nbsp;<span class="op" id="1444451">!=</span>&nbsp;<span class="num" id="1444454">0</span>&nbsp;<span class="op" id="1444456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444461">unlock</span><span class="op" id="1444467">(</span><span class="op" id="1444468">&amp;</span><span class="ident" id="1444469">c</span><span class="op" id="1444470">.</span><span class="ident" id="1444471">lock</span><span class="op" id="1444475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1444480">panic</span><span class="op" id="1444485">(</span><span class="string" id="1444486">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1444510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444514">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1444521">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444564">if</span>&nbsp;<span class="ident" id="1444567">raceenabled</span>&nbsp;<span class="op" id="1444579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444583">raceacquire</span><span class="op" id="1444594">(</span><span class="ident" id="1444595">chanbuf</span><span class="op" id="1444602">(</span><span class="ident" id="1444603">c</span><span class="op" id="1444604">,</span>&nbsp;<span class="ident" id="1444606">c</span><span class="op" id="1444607">.</span><span class="ident" id="1444608">sendx</span><span class="op" id="1444613">)</span><span class="op" id="1444614">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444618">racerelease</span><span class="op" id="1444629">(</span><span class="ident" id="1444630">chanbuf</span><span class="op" id="1444637">(</span><span class="ident" id="1444638">c</span><span class="op" id="1444639">,</span>&nbsp;<span class="ident" id="1444641">c</span><span class="op" id="1444642">.</span><span class="ident" id="1444643">sendx</span><span class="op" id="1444648">)</span><span class="op" id="1444649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444655">memmove</span><span class="op" id="1444662">(</span><span class="ident" id="1444663">chanbuf</span><span class="op" id="1444670">(</span><span class="ident" id="1444671">c</span><span class="op" id="1444672">,</span>&nbsp;<span class="ident" id="1444674">c</span><span class="op" id="1444675">.</span><span class="ident" id="1444676">sendx</span><span class="op" id="1444681">)</span><span class="op" id="1444682">,</span>&nbsp;<span class="ident" id="1444684">ep</span><span class="op" id="1444686">,</span>&nbsp;<span class="builtintype" id="1444688">uintptr</span><span class="op" id="1444695">(</span><span class="ident" id="1444696">c</span><span class="op" id="1444697">.</span><span class="ident" id="1444698">elemsize</span><span class="op" id="1444706">)</span><span class="op" id="1444707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444710">c</span><span class="op" id="1444711">.</span><span class="ident" id="1444712">sendx</span><span class="op" id="1444717">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444721">if</span>&nbsp;<span class="ident" id="1444724">c</span><span class="op" id="1444725">.</span><span class="ident" id="1444726">sendx</span>&nbsp;<span class="op" id="1444732">==</span>&nbsp;<span class="ident" id="1444735">c</span><span class="op" id="1444736">.</span><span class="ident" id="1444737">dataqsiz</span>&nbsp;<span class="op" id="1444746">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444750">c</span><span class="op" id="1444751">.</span><span class="ident" id="1444752">sendx</span>&nbsp;<span class="op" id="1444758">=</span>&nbsp;<span class="num" id="1444760">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444766">c</span><span class="op" id="1444767">.</span><span class="ident" id="1444768">qcount</span><span class="op" id="1444774">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1444779">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444810">sg</span>&nbsp;<span class="op" id="1444813">:=</span>&nbsp;<span class="ident" id="1444816">c</span><span class="op" id="1444817">.</span><span class="ident" id="1444818">recvq</span><span class="op" id="1444823">.</span><span class="ident" id="1444824">dequeue</span><span class="op" id="1444831">(</span><span class="op" id="1444832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444835">if</span>&nbsp;<span class="ident" id="1444838">sg</span>&nbsp;<span class="op" id="1444841">!=</span>&nbsp;<span class="ident" id="1444844">nil</span>&nbsp;<span class="op" id="1444848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444852">recvg</span>&nbsp;<span class="op" id="1444858">:=</span>&nbsp;<span class="ident" id="1444861">sg</span><span class="op" id="1444863">.</span><span class="ident" id="1444864">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444868">unlock</span><span class="op" id="1444874">(</span><span class="op" id="1444875">&amp;</span><span class="ident" id="1444876">c</span><span class="op" id="1444877">.</span><span class="ident" id="1444878">lock</span><span class="op" id="1444882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444886">if</span>&nbsp;<span class="ident" id="1444889">sg</span><span class="op" id="1444891">.</span><span class="ident" id="1444892">releasetime</span>&nbsp;<span class="op" id="1444904">!=</span>&nbsp;<span class="num" id="1444907">0</span>&nbsp;<span class="op" id="1444909">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444914">sg</span><span class="op" id="1444916">.</span><span class="ident" id="1444917">releasetime</span>&nbsp;<span class="op" id="1444929">=</span>&nbsp;<span class="ident" id="1444931">cputicks</span><span class="op" id="1444939">(</span><span class="op" id="1444940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444948">goready</span><span class="op" id="1444955">(</span><span class="ident" id="1444956">recvg</span><span class="op" id="1444961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444964">}</span>&nbsp;<span class="keyword" id="1444966">else</span>&nbsp;<span class="op" id="1444971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444975">unlock</span><span class="op" id="1444981">(</span><span class="op" id="1444982">&amp;</span><span class="ident" id="1444983">c</span><span class="op" id="1444984">.</span><span class="ident" id="1444985">lock</span><span class="op" id="1444989">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1444995">if</span>&nbsp;<span class="ident" id="1444998">t1</span>&nbsp;<span class="op" id="1445001">&gt;</span>&nbsp;<span class="num" id="1445003">0</span>&nbsp;<span class="op" id="1445005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445009">blockevent</span><span class="op" id="1445019">(</span><span class="ident" id="1445020">t1</span><span class="op" id="1445022">-</span><span class="ident" id="1445023">t0</span><span class="op" id="1445025">,</span>&nbsp;<span class="num" id="1445027">2</span><span class="op" id="1445028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445034">return</span>&nbsp;<span class="builtintype" id="1445041">true</span><br>
<span class="lineno">255</span><span class="op" id="1445046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1445049">func</span>&nbsp;<span class="ident" id="1445054">closechan</span><span class="op" id="1445063">(</span><span class="ident" id="1445064">c</span>&nbsp;<span class="op" id="1445066">*</span><span class="ident" id="1445067">hchan</span><span class="op" id="1445072">)</span>&nbsp;<span class="op" id="1445074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445077">if</span>&nbsp;<span class="ident" id="1445080">c</span>&nbsp;<span class="op" id="1445082">==</span>&nbsp;<span class="ident" id="1445085">nil</span>&nbsp;<span class="op" id="1445089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1445093">panic</span><span class="op" id="1445098">(</span><span class="string" id="1445099">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1445121">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445128">lock</span><span class="op" id="1445132">(</span><span class="op" id="1445133">&amp;</span><span class="ident" id="1445134">c</span><span class="op" id="1445135">.</span><span class="ident" id="1445136">lock</span><span class="op" id="1445140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445143">if</span>&nbsp;<span class="ident" id="1445146">c</span><span class="op" id="1445147">.</span><span class="ident" id="1445148">closed</span>&nbsp;<span class="op" id="1445155">!=</span>&nbsp;<span class="num" id="1445158">0</span>&nbsp;<span class="op" id="1445160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445164">unlock</span><span class="op" id="1445170">(</span><span class="op" id="1445171">&amp;</span><span class="ident" id="1445172">c</span><span class="op" id="1445173">.</span><span class="ident" id="1445174">lock</span><span class="op" id="1445178">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1445182">panic</span><span class="op" id="1445187">(</span><span class="string" id="1445188">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1445213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445220">if</span>&nbsp;<span class="ident" id="1445223">raceenabled</span>&nbsp;<span class="op" id="1445235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445239">callerpc</span>&nbsp;<span class="op" id="1445248">:=</span>&nbsp;<span class="ident" id="1445251">getcallerpc</span><span class="op" id="1445262">(</span><span class="ident" id="1445263">unsafe</span><span class="op" id="1445269">.</span><span class="ident" id="1445270">Pointer</span><span class="op" id="1445277">(</span><span class="op" id="1445278">&amp;</span><span class="ident" id="1445279">c</span><span class="op" id="1445280">)</span><span class="op" id="1445281">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445285">racewritepc</span><span class="op" id="1445296">(</span><span class="ident" id="1445297">unsafe</span><span class="op" id="1445303">.</span><span class="ident" id="1445304">Pointer</span><span class="op" id="1445311">(</span><span class="ident" id="1445312">c</span><span class="op" id="1445313">)</span><span class="op" id="1445314">,</span>&nbsp;<span class="ident" id="1445316">callerpc</span><span class="op" id="1445324">,</span>&nbsp;<span class="ident" id="1445326">funcPC</span><span class="op" id="1445332">(</span><span class="ident" id="1445333">closechan</span><span class="op" id="1445342">)</span><span class="op" id="1445343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445347">racerelease</span><span class="op" id="1445358">(</span><span class="ident" id="1445359">unsafe</span><span class="op" id="1445365">.</span><span class="ident" id="1445366">Pointer</span><span class="op" id="1445373">(</span><span class="ident" id="1445374">c</span><span class="op" id="1445375">)</span><span class="op" id="1445376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445383">c</span><span class="op" id="1445384">.</span><span class="ident" id="1445385">closed</span>&nbsp;<span class="op" id="1445392">=</span>&nbsp;<span class="num" id="1445394">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1445398">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445422">for</span>&nbsp;<span class="op" id="1445426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445430">sg</span>&nbsp;<span class="op" id="1445433">:=</span>&nbsp;<span class="ident" id="1445436">c</span><span class="op" id="1445437">.</span><span class="ident" id="1445438">recvq</span><span class="op" id="1445443">.</span><span class="ident" id="1445444">dequeue</span><span class="op" id="1445451">(</span><span class="op" id="1445452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445456">if</span>&nbsp;<span class="ident" id="1445459">sg</span>&nbsp;<span class="op" id="1445462">==</span>&nbsp;<span class="ident" id="1445465">nil</span>&nbsp;<span class="op" id="1445469">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445474">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445486">gp</span>&nbsp;<span class="op" id="1445489">:=</span>&nbsp;<span class="ident" id="1445492">sg</span><span class="op" id="1445494">.</span><span class="ident" id="1445495">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445499">sg</span><span class="op" id="1445501">.</span><span class="ident" id="1445502">elem</span>&nbsp;<span class="op" id="1445507">=</span>&nbsp;<span class="ident" id="1445509">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445515">gp</span><span class="op" id="1445517">.</span><span class="ident" id="1445518">param</span>&nbsp;<span class="op" id="1445524">=</span>&nbsp;<span class="ident" id="1445526">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445532">if</span>&nbsp;<span class="ident" id="1445535">sg</span><span class="op" id="1445537">.</span><span class="ident" id="1445538">releasetime</span>&nbsp;<span class="op" id="1445550">!=</span>&nbsp;<span class="num" id="1445553">0</span>&nbsp;<span class="op" id="1445555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445560">sg</span><span class="op" id="1445562">.</span><span class="ident" id="1445563">releasetime</span>&nbsp;<span class="op" id="1445575">=</span>&nbsp;<span class="ident" id="1445577">cputicks</span><span class="op" id="1445585">(</span><span class="op" id="1445586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445594">goready</span><span class="op" id="1445601">(</span><span class="ident" id="1445602">gp</span><span class="op" id="1445604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445607">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1445611">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445635">for</span>&nbsp;<span class="op" id="1445639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445643">sg</span>&nbsp;<span class="op" id="1445646">:=</span>&nbsp;<span class="ident" id="1445649">c</span><span class="op" id="1445650">.</span><span class="ident" id="1445651">sendq</span><span class="op" id="1445656">.</span><span class="ident" id="1445657">dequeue</span><span class="op" id="1445664">(</span><span class="op" id="1445665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445669">if</span>&nbsp;<span class="ident" id="1445672">sg</span>&nbsp;<span class="op" id="1445675">==</span>&nbsp;<span class="ident" id="1445678">nil</span>&nbsp;<span class="op" id="1445682">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445687">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445699">gp</span>&nbsp;<span class="op" id="1445702">:=</span>&nbsp;<span class="ident" id="1445705">sg</span><span class="op" id="1445707">.</span><span class="ident" id="1445708">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445712">sg</span><span class="op" id="1445714">.</span><span class="ident" id="1445715">elem</span>&nbsp;<span class="op" id="1445720">=</span>&nbsp;<span class="ident" id="1445722">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445728">gp</span><span class="op" id="1445730">.</span><span class="ident" id="1445731">param</span>&nbsp;<span class="op" id="1445737">=</span>&nbsp;<span class="ident" id="1445739">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1445745">if</span>&nbsp;<span class="ident" id="1445748">sg</span><span class="op" id="1445750">.</span><span class="ident" id="1445751">releasetime</span>&nbsp;<span class="op" id="1445763">!=</span>&nbsp;<span class="num" id="1445766">0</span>&nbsp;<span class="op" id="1445768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445773">sg</span><span class="op" id="1445775">.</span><span class="ident" id="1445776">releasetime</span>&nbsp;<span class="op" id="1445788">=</span>&nbsp;<span class="ident" id="1445790">cputicks</span><span class="op" id="1445798">(</span><span class="op" id="1445799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445807">goready</span><span class="op" id="1445814">(</span><span class="ident" id="1445815">gp</span><span class="op" id="1445817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1445820">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445823">unlock</span><span class="op" id="1445829">(</span><span class="op" id="1445830">&amp;</span><span class="ident" id="1445831">c</span><span class="op" id="1445832">.</span><span class="ident" id="1445833">lock</span><span class="op" id="1445837">)</span><br>
<span class="lineno"></span><span class="op" id="1445839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445842">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1445886">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1445899">func</span>&nbsp;<span class="ident" id="1445904">chanrecv1</span><span class="op" id="1445913">(</span><span class="ident" id="1445914">t</span>&nbsp;<span class="op" id="1445916">*</span><span class="ident" id="1445917">chantype</span><span class="op" id="1445925">,</span>&nbsp;<span class="ident" id="1445927">c</span>&nbsp;<span class="op" id="1445929">*</span><span class="ident" id="1445930">hchan</span><span class="op" id="1445935">,</span>&nbsp;<span class="ident" id="1445937">elem</span>&nbsp;<span class="ident" id="1445942">unsafe</span><span class="op" id="1445948">.</span><span class="ident" id="1445949">Pointer</span><span class="op" id="1445956">)</span>&nbsp;<span class="op" id="1445958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445961">chanrecv</span><span class="op" id="1445969">(</span><span class="ident" id="1445970">t</span><span class="op" id="1445971">,</span>&nbsp;<span class="ident" id="1445973">c</span><span class="op" id="1445974">,</span>&nbsp;<span class="ident" id="1445976">elem</span><span class="op" id="1445980">,</span>&nbsp;<span class="builtintype" id="1445982">true</span><span class="op" id="1445986">)</span><br>
<span class="lineno"></span><span class="op" id="1445988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445991">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1446004">func</span>&nbsp;<span class="ident" id="1446009">chanrecv2</span><span class="op" id="1446018">(</span><span class="ident" id="1446019">t</span>&nbsp;<span class="op" id="1446021">*</span><span class="ident" id="1446022">chantype</span><span class="op" id="1446030">,</span>&nbsp;<span class="ident" id="1446032">c</span>&nbsp;<span class="op" id="1446034">*</span><span class="ident" id="1446035">hchan</span><span class="op" id="1446040">,</span>&nbsp;<span class="ident" id="1446042">elem</span>&nbsp;<span class="ident" id="1446047">unsafe</span><span class="op" id="1446053">.</span><span class="ident" id="1446054">Pointer</span><span class="op" id="1446061">)</span>&nbsp;<span class="op" id="1446063">(</span><span class="ident" id="1446064">received</span>&nbsp;<span class="builtintype" id="1446073">bool</span><span class="op" id="1446077">)</span>&nbsp;<span class="op" id="1446079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1446082">_</span><span class="op" id="1446083">,</span>&nbsp;<span class="ident" id="1446085">received</span>&nbsp;<span class="op" id="1446094">=</span>&nbsp;<span class="ident" id="1446096">chanrecv</span><span class="op" id="1446104">(</span><span class="ident" id="1446105">t</span><span class="op" id="1446106">,</span>&nbsp;<span class="ident" id="1446108">c</span><span class="op" id="1446109">,</span>&nbsp;<span class="ident" id="1446111">elem</span><span class="op" id="1446115">,</span>&nbsp;<span class="builtintype" id="1446117">true</span><span class="op" id="1446121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1446124">return</span><br>
<span class="lineno"></span><span class="op" id="1446131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1446134">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1446204">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1446262">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1446338">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1446405">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1446474">func</span>&nbsp;<span class="ident" id="1446479">chanrecv</span><span class="op" id="1446487">(</span><span class="ident" id="1446488">t</span>&nbsp;<span class="op" id="1446490">*</span><span class="ident" id="1446491">chantype</span><span class="op" id="1446499">,</span>&nbsp;<span class="ident" id="1446501">c</span>&nbsp;<span class="op" id="1446503">*</span><span class="ident" id="1446504">hchan</span><span class="op" id="1446509">,</span>&nbsp;<span class="ident" id="1446511">ep</span>&nbsp;<span class="ident" id="1446514">unsafe</span><span class="op" id="1446520">.</span><span class="ident" id="1446521">Pointer</span><span class="op" id="1446528">,</span>&nbsp;<span class="ident" id="1446530">block</span>&nbsp;<span class="builtintype" id="1446536">bool</span><span class="op" id="1446540">)</span>&nbsp;<span class="op" id="1446542">(</span><span class="ident" id="1446543">selected</span><span class="op" id="1446551">,</span>&nbsp;<span class="ident" id="1446553">received</span>&nbsp;<span class="builtintype" id="1446562">bool</span><span class="op" id="1446566">)</span>&nbsp;<span class="op" id="1446568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446571">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1446643">if</span>&nbsp;<span class="ident" id="1446646">debugChan</span>&nbsp;<span class="op" id="1446656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1446660">print</span><span class="op" id="1446665">(</span><span class="string" id="1446666">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1446683">,</span>&nbsp;<span class="ident" id="1446685">c</span><span class="op" id="1446686">,</span>&nbsp;<span class="string" id="1446688">&#34;\n&#34;</span><span class="op" id="1446692">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1446695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1446699">if</span>&nbsp;<span class="ident" id="1446702">c</span>&nbsp;<span class="op" id="1446704">==</span>&nbsp;<span class="ident" id="1446707">nil</span>&nbsp;<span class="op" id="1446711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1446715">if</span>&nbsp;<span class="op" id="1446718">!</span><span class="ident" id="1446719">block</span>&nbsp;<span class="op" id="1446725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1446730">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1446739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1446743">gopark</span><span class="op" id="1446749">(</span><span class="ident" id="1446750">nil</span><span class="op" id="1446753">,</span>&nbsp;<span class="ident" id="1446755">nil</span><span class="op" id="1446758">,</span>&nbsp;<span class="string" id="1446760">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1446785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1446789">gothrow</span><span class="op" id="1446796">(</span><span class="string" id="1446797">&#34;unreachable&#34;</span><span class="op" id="1446810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1446813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446817">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446900">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446904">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446989">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447071">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447131">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447210">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447288">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447366">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447414">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447418">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447502">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447551">if</span>&nbsp;<span class="op" id="1447554">!</span><span class="ident" id="1447555">block</span>&nbsp;<span class="op" id="1447561">&amp;&amp;</span>&nbsp;<span class="op" id="1447564">(</span><span class="ident" id="1447565">c</span><span class="op" id="1447566">.</span><span class="ident" id="1447567">dataqsiz</span>&nbsp;<span class="op" id="1447576">==</span>&nbsp;<span class="num" id="1447579">0</span>&nbsp;<span class="op" id="1447581">&amp;&amp;</span>&nbsp;<span class="ident" id="1447584">c</span><span class="op" id="1447585">.</span><span class="ident" id="1447586">sendq</span><span class="op" id="1447591">.</span><span class="ident" id="1447592">first</span>&nbsp;<span class="op" id="1447598">==</span>&nbsp;<span class="ident" id="1447601">nil</span>&nbsp;<span class="op" id="1447605">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447610">c</span><span class="op" id="1447611">.</span><span class="ident" id="1447612">dataqsiz</span>&nbsp;<span class="op" id="1447621">&gt;</span>&nbsp;<span class="num" id="1447623">0</span>&nbsp;<span class="op" id="1447625">&amp;&amp;</span>&nbsp;<span class="ident" id="1447628">atomicloaduint</span><span class="op" id="1447642">(</span><span class="op" id="1447643">&amp;</span><span class="ident" id="1447644">c</span><span class="op" id="1447645">.</span><span class="ident" id="1447646">qcount</span><span class="op" id="1447652">)</span>&nbsp;<span class="op" id="1447654">==</span>&nbsp;<span class="num" id="1447657">0</span><span class="op" id="1447658">)</span>&nbsp;<span class="op" id="1447660">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447665">atomicload</span><span class="op" id="1447675">(</span><span class="op" id="1447676">&amp;</span><span class="ident" id="1447677">c</span><span class="op" id="1447678">.</span><span class="ident" id="1447679">closed</span><span class="op" id="1447685">)</span>&nbsp;<span class="op" id="1447687">==</span>&nbsp;<span class="num" id="1447690">0</span>&nbsp;<span class="op" id="1447692">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447696">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1447704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447708">var</span>&nbsp;<span class="ident" id="1447712">t0</span>&nbsp;<span class="ident" id="1447715">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447722">if</span>&nbsp;<span class="ident" id="1447725">blockprofilerate</span>&nbsp;<span class="op" id="1447742">&gt;</span>&nbsp;<span class="num" id="1447744">0</span>&nbsp;<span class="op" id="1447746">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447750">t0</span>&nbsp;<span class="op" id="1447753">=</span>&nbsp;<span class="ident" id="1447755">cputicks</span><span class="op" id="1447763">(</span><span class="op" id="1447764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1447767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447771">lock</span><span class="op" id="1447775">(</span><span class="op" id="1447776">&amp;</span><span class="ident" id="1447777">c</span><span class="op" id="1447778">.</span><span class="ident" id="1447779">lock</span><span class="op" id="1447783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447786">if</span>&nbsp;<span class="ident" id="1447789">c</span><span class="op" id="1447790">.</span><span class="ident" id="1447791">dataqsiz</span>&nbsp;<span class="op" id="1447800">==</span>&nbsp;<span class="num" id="1447803">0</span>&nbsp;<span class="op" id="1447805">{</span>&nbsp;<span class="comment" id="1447807">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447832">if</span>&nbsp;<span class="ident" id="1447835">c</span><span class="op" id="1447836">.</span><span class="ident" id="1447837">closed</span>&nbsp;<span class="op" id="1447844">!=</span>&nbsp;<span class="num" id="1447847">0</span>&nbsp;<span class="op" id="1447849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447854">return</span>&nbsp;<span class="ident" id="1447861">recvclosed</span><span class="op" id="1447871">(</span><span class="ident" id="1447872">c</span><span class="op" id="1447873">,</span>&nbsp;<span class="ident" id="1447875">ep</span><span class="op" id="1447877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1447881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447886">sg</span>&nbsp;<span class="op" id="1447889">:=</span>&nbsp;<span class="ident" id="1447892">c</span><span class="op" id="1447893">.</span><span class="ident" id="1447894">sendq</span><span class="op" id="1447899">.</span><span class="ident" id="1447900">dequeue</span><span class="op" id="1447907">(</span><span class="op" id="1447908">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447912">if</span>&nbsp;<span class="ident" id="1447915">sg</span>&nbsp;<span class="op" id="1447918">!=</span>&nbsp;<span class="ident" id="1447921">nil</span>&nbsp;<span class="op" id="1447925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447930">if</span>&nbsp;<span class="ident" id="1447933">raceenabled</span>&nbsp;<span class="op" id="1447945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447951">racesync</span><span class="op" id="1447959">(</span><span class="ident" id="1447960">c</span><span class="op" id="1447961">,</span>&nbsp;<span class="ident" id="1447963">sg</span><span class="op" id="1447965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1447970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1447975">unlock</span><span class="op" id="1447981">(</span><span class="op" id="1447982">&amp;</span><span class="ident" id="1447983">c</span><span class="op" id="1447984">.</span><span class="ident" id="1447985">lock</span><span class="op" id="1447989">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1447995">if</span>&nbsp;<span class="ident" id="1447998">ep</span>&nbsp;<span class="op" id="1448001">!=</span>&nbsp;<span class="ident" id="1448004">nil</span>&nbsp;<span class="op" id="1448008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448014">memmove</span><span class="op" id="1448021">(</span><span class="ident" id="1448022">ep</span><span class="op" id="1448024">,</span>&nbsp;<span class="ident" id="1448026">sg</span><span class="op" id="1448028">.</span><span class="ident" id="1448029">elem</span><span class="op" id="1448033">,</span>&nbsp;<span class="builtintype" id="1448035">uintptr</span><span class="op" id="1448042">(</span><span class="ident" id="1448043">c</span><span class="op" id="1448044">.</span><span class="ident" id="1448045">elemsize</span><span class="op" id="1448053">)</span><span class="op" id="1448054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448064">sg</span><span class="op" id="1448066">.</span><span class="ident" id="1448067">elem</span>&nbsp;<span class="op" id="1448072">=</span>&nbsp;<span class="ident" id="1448074">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448081">gp</span>&nbsp;<span class="op" id="1448084">:=</span>&nbsp;<span class="ident" id="1448087">sg</span><span class="op" id="1448089">.</span><span class="ident" id="1448090">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448095">gp</span><span class="op" id="1448097">.</span><span class="ident" id="1448098">param</span>&nbsp;<span class="op" id="1448104">=</span>&nbsp;<span class="ident" id="1448106">unsafe</span><span class="op" id="1448112">.</span><span class="ident" id="1448113">Pointer</span><span class="op" id="1448120">(</span><span class="ident" id="1448121">sg</span><span class="op" id="1448123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448128">if</span>&nbsp;<span class="ident" id="1448131">sg</span><span class="op" id="1448133">.</span><span class="ident" id="1448134">releasetime</span>&nbsp;<span class="op" id="1448146">!=</span>&nbsp;<span class="num" id="1448149">0</span>&nbsp;<span class="op" id="1448151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448157">sg</span><span class="op" id="1448159">.</span><span class="ident" id="1448160">releasetime</span>&nbsp;<span class="op" id="1448172">=</span>&nbsp;<span class="ident" id="1448174">cputicks</span><span class="op" id="1448182">(</span><span class="op" id="1448183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448188">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448193">goready</span><span class="op" id="1448200">(</span><span class="ident" id="1448201">gp</span><span class="op" id="1448203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448208">selected</span>&nbsp;<span class="op" id="1448217">=</span>&nbsp;<span class="builtintype" id="1448219">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448227">received</span>&nbsp;<span class="op" id="1448236">=</span>&nbsp;<span class="builtintype" id="1448238">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448246">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448255">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448260">if</span>&nbsp;<span class="op" id="1448263">!</span><span class="ident" id="1448264">block</span>&nbsp;<span class="op" id="1448270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448275">unlock</span><span class="op" id="1448281">(</span><span class="op" id="1448282">&amp;</span><span class="ident" id="1448283">c</span><span class="op" id="1448284">.</span><span class="ident" id="1448285">lock</span><span class="op" id="1448289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448294">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448303">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1448308">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448357">gp</span>&nbsp;<span class="op" id="1448360">:=</span>&nbsp;<span class="ident" id="1448363">getg</span><span class="op" id="1448367">(</span><span class="op" id="1448368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448372">mysg</span>&nbsp;<span class="op" id="1448377">:=</span>&nbsp;<span class="ident" id="1448380">acquireSudog</span><span class="op" id="1448392">(</span><span class="op" id="1448393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448397">mysg</span><span class="op" id="1448401">.</span><span class="ident" id="1448402">releasetime</span>&nbsp;<span class="op" id="1448414">=</span>&nbsp;<span class="num" id="1448416">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448420">if</span>&nbsp;<span class="ident" id="1448423">t0</span>&nbsp;<span class="op" id="1448426">!=</span>&nbsp;<span class="num" id="1448429">0</span>&nbsp;<span class="op" id="1448431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448436">mysg</span><span class="op" id="1448440">.</span><span class="ident" id="1448441">releasetime</span>&nbsp;<span class="op" id="1448453">=</span>&nbsp;<span class="op" id="1448455">-</span><span class="num" id="1448456">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448464">mysg</span><span class="op" id="1448468">.</span><span class="ident" id="1448469">elem</span>&nbsp;<span class="op" id="1448474">=</span>&nbsp;<span class="ident" id="1448476">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448481">mysg</span><span class="op" id="1448485">.</span><span class="ident" id="1448486">waitlink</span>&nbsp;<span class="op" id="1448495">=</span>&nbsp;<span class="ident" id="1448497">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448503">gp</span><span class="op" id="1448505">.</span><span class="ident" id="1448506">waiting</span>&nbsp;<span class="op" id="1448514">=</span>&nbsp;<span class="ident" id="1448516">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448523">mysg</span><span class="op" id="1448527">.</span><span class="ident" id="1448528">g</span>&nbsp;<span class="op" id="1448530">=</span>&nbsp;<span class="ident" id="1448532">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448537">mysg</span><span class="op" id="1448541">.</span><span class="ident" id="1448542">selectdone</span>&nbsp;<span class="op" id="1448553">=</span>&nbsp;<span class="ident" id="1448555">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448561">gp</span><span class="op" id="1448563">.</span><span class="ident" id="1448564">param</span>&nbsp;<span class="op" id="1448570">=</span>&nbsp;<span class="ident" id="1448572">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448578">c</span><span class="op" id="1448579">.</span><span class="ident" id="1448580">recvq</span><span class="op" id="1448585">.</span><span class="ident" id="1448586">enqueue</span><span class="op" id="1448593">(</span><span class="ident" id="1448594">mysg</span><span class="op" id="1448598">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448602">goparkunlock</span><span class="op" id="1448614">(</span><span class="op" id="1448615">&amp;</span><span class="ident" id="1448616">c</span><span class="op" id="1448617">.</span><span class="ident" id="1448618">lock</span><span class="op" id="1448622">,</span>&nbsp;<span class="string" id="1448624">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1448638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1448643">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448667">if</span>&nbsp;<span class="ident" id="1448670">mysg</span>&nbsp;<span class="op" id="1448675">!=</span>&nbsp;<span class="ident" id="1448678">gp</span><span class="op" id="1448680">.</span><span class="ident" id="1448681">waiting</span>&nbsp;<span class="op" id="1448689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448694">gothrow</span><span class="op" id="1448701">(</span><span class="string" id="1448702">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1448732">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448740">gp</span><span class="op" id="1448742">.</span><span class="ident" id="1448743">waiting</span>&nbsp;<span class="op" id="1448751">=</span>&nbsp;<span class="ident" id="1448753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448759">if</span>&nbsp;<span class="ident" id="1448762">mysg</span><span class="op" id="1448766">.</span><span class="ident" id="1448767">releasetime</span>&nbsp;<span class="op" id="1448779">&gt;</span>&nbsp;<span class="num" id="1448781">0</span>&nbsp;<span class="op" id="1448783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448788">blockevent</span><span class="op" id="1448798">(</span><span class="ident" id="1448799">mysg</span><span class="op" id="1448803">.</span><span class="ident" id="1448804">releasetime</span><span class="op" id="1448815">-</span><span class="ident" id="1448816">t0</span><span class="op" id="1448818">,</span>&nbsp;<span class="num" id="1448820">2</span><span class="op" id="1448821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1448825">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448829">haveData</span>&nbsp;<span class="op" id="1448838">:=</span>&nbsp;<span class="ident" id="1448841">gp</span><span class="op" id="1448843">.</span><span class="ident" id="1448844">param</span>&nbsp;<span class="op" id="1448850">!=</span>&nbsp;<span class="ident" id="1448853">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448859">gp</span><span class="op" id="1448861">.</span><span class="ident" id="1448862">param</span>&nbsp;<span class="op" id="1448868">=</span>&nbsp;<span class="ident" id="1448870">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448876">releaseSudog</span><span class="op" id="1448888">(</span><span class="ident" id="1448889">mysg</span><span class="op" id="1448893">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1448898">if</span>&nbsp;<span class="ident" id="1448901">haveData</span>&nbsp;<span class="op" id="1448910">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1448915">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448973">selected</span>&nbsp;<span class="op" id="1448982">=</span>&nbsp;<span class="builtintype" id="1448984">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1448992">received</span>&nbsp;<span class="op" id="1449001">=</span>&nbsp;<span class="builtintype" id="1449003">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449020">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449025">lock</span><span class="op" id="1449029">(</span><span class="op" id="1449030">&amp;</span><span class="ident" id="1449031">c</span><span class="op" id="1449032">.</span><span class="ident" id="1449033">lock</span><span class="op" id="1449037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449041">if</span>&nbsp;<span class="ident" id="1449044">c</span><span class="op" id="1449045">.</span><span class="ident" id="1449046">closed</span>&nbsp;<span class="op" id="1449053">==</span>&nbsp;<span class="num" id="1449056">0</span>&nbsp;<span class="op" id="1449058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449063">gothrow</span><span class="op" id="1449070">(</span><span class="string" id="1449071">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1449098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449102">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449106">return</span>&nbsp;<span class="ident" id="1449113">recvclosed</span><span class="op" id="1449123">(</span><span class="ident" id="1449124">c</span><span class="op" id="1449125">,</span>&nbsp;<span class="ident" id="1449127">ep</span><span class="op" id="1449129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449136">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449161">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449194">var</span>&nbsp;<span class="ident" id="1449198">t1</span>&nbsp;<span class="ident" id="1449201">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449208">for</span>&nbsp;<span class="ident" id="1449212">c</span><span class="op" id="1449213">.</span><span class="ident" id="1449214">qcount</span>&nbsp;<span class="op" id="1449221">&lt;=</span>&nbsp;<span class="num" id="1449224">0</span>&nbsp;<span class="op" id="1449226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449230">if</span>&nbsp;<span class="ident" id="1449233">c</span><span class="op" id="1449234">.</span><span class="ident" id="1449235">closed</span>&nbsp;<span class="op" id="1449242">!=</span>&nbsp;<span class="num" id="1449245">0</span>&nbsp;<span class="op" id="1449247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449252">selected</span><span class="op" id="1449260">,</span>&nbsp;<span class="ident" id="1449262">received</span>&nbsp;<span class="op" id="1449271">=</span>&nbsp;<span class="ident" id="1449273">recvclosed</span><span class="op" id="1449283">(</span><span class="ident" id="1449284">c</span><span class="op" id="1449285">,</span>&nbsp;<span class="ident" id="1449287">ep</span><span class="op" id="1449289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449294">if</span>&nbsp;<span class="ident" id="1449297">t1</span>&nbsp;<span class="op" id="1449300">&gt;</span>&nbsp;<span class="num" id="1449302">0</span>&nbsp;<span class="op" id="1449304">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449310">blockevent</span><span class="op" id="1449320">(</span><span class="ident" id="1449321">t1</span><span class="op" id="1449323">-</span><span class="ident" id="1449324">t0</span><span class="op" id="1449326">,</span>&nbsp;<span class="num" id="1449328">2</span><span class="op" id="1449329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449339">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449353">if</span>&nbsp;<span class="op" id="1449356">!</span><span class="ident" id="1449357">block</span>&nbsp;<span class="op" id="1449363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449368">unlock</span><span class="op" id="1449374">(</span><span class="op" id="1449375">&amp;</span><span class="ident" id="1449376">c</span><span class="op" id="1449377">.</span><span class="ident" id="1449378">lock</span><span class="op" id="1449382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449401">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449442">gp</span>&nbsp;<span class="op" id="1449445">:=</span>&nbsp;<span class="ident" id="1449448">getg</span><span class="op" id="1449452">(</span><span class="op" id="1449453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449457">mysg</span>&nbsp;<span class="op" id="1449462">:=</span>&nbsp;<span class="ident" id="1449465">acquireSudog</span><span class="op" id="1449477">(</span><span class="op" id="1449478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449482">mysg</span><span class="op" id="1449486">.</span><span class="ident" id="1449487">releasetime</span>&nbsp;<span class="op" id="1449499">=</span>&nbsp;<span class="num" id="1449501">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449505">if</span>&nbsp;<span class="ident" id="1449508">t0</span>&nbsp;<span class="op" id="1449511">!=</span>&nbsp;<span class="num" id="1449514">0</span>&nbsp;<span class="op" id="1449516">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449521">mysg</span><span class="op" id="1449525">.</span><span class="ident" id="1449526">releasetime</span>&nbsp;<span class="op" id="1449538">=</span>&nbsp;<span class="op" id="1449540">-</span><span class="num" id="1449541">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449549">mysg</span><span class="op" id="1449553">.</span><span class="ident" id="1449554">elem</span>&nbsp;<span class="op" id="1449559">=</span>&nbsp;<span class="ident" id="1449561">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449567">mysg</span><span class="op" id="1449571">.</span><span class="ident" id="1449572">g</span>&nbsp;<span class="op" id="1449574">=</span>&nbsp;<span class="ident" id="1449576">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449581">mysg</span><span class="op" id="1449585">.</span><span class="ident" id="1449586">selectdone</span>&nbsp;<span class="op" id="1449597">=</span>&nbsp;<span class="ident" id="1449599">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449606">c</span><span class="op" id="1449607">.</span><span class="ident" id="1449608">recvq</span><span class="op" id="1449613">.</span><span class="ident" id="1449614">enqueue</span><span class="op" id="1449621">(</span><span class="ident" id="1449622">mysg</span><span class="op" id="1449626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449630">goparkunlock</span><span class="op" id="1449642">(</span><span class="op" id="1449643">&amp;</span><span class="ident" id="1449644">c</span><span class="op" id="1449645">.</span><span class="ident" id="1449646">lock</span><span class="op" id="1449650">,</span>&nbsp;<span class="string" id="1449652">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1449666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449671">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449707">if</span>&nbsp;<span class="ident" id="1449710">mysg</span><span class="op" id="1449714">.</span><span class="ident" id="1449715">releasetime</span>&nbsp;<span class="op" id="1449727">&gt;</span>&nbsp;<span class="num" id="1449729">0</span>&nbsp;<span class="op" id="1449731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449736">t1</span>&nbsp;<span class="op" id="1449739">=</span>&nbsp;<span class="ident" id="1449741">mysg</span><span class="op" id="1449745">.</span><span class="ident" id="1449746">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449764">releaseSudog</span><span class="op" id="1449776">(</span><span class="ident" id="1449777">mysg</span><span class="op" id="1449781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449785">lock</span><span class="op" id="1449789">(</span><span class="op" id="1449790">&amp;</span><span class="ident" id="1449791">c</span><span class="op" id="1449792">.</span><span class="ident" id="1449793">lock</span><span class="op" id="1449797">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449804">if</span>&nbsp;<span class="ident" id="1449807">raceenabled</span>&nbsp;<span class="op" id="1449819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449823">raceacquire</span><span class="op" id="1449834">(</span><span class="ident" id="1449835">chanbuf</span><span class="op" id="1449842">(</span><span class="ident" id="1449843">c</span><span class="op" id="1449844">,</span>&nbsp;<span class="ident" id="1449846">c</span><span class="op" id="1449847">.</span><span class="ident" id="1449848">recvx</span><span class="op" id="1449853">)</span><span class="op" id="1449854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449858">racerelease</span><span class="op" id="1449869">(</span><span class="ident" id="1449870">chanbuf</span><span class="op" id="1449877">(</span><span class="ident" id="1449878">c</span><span class="op" id="1449879">,</span>&nbsp;<span class="ident" id="1449881">c</span><span class="op" id="1449882">.</span><span class="ident" id="1449883">recvx</span><span class="op" id="1449888">)</span><span class="op" id="1449889">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1449895">if</span>&nbsp;<span class="ident" id="1449898">ep</span>&nbsp;<span class="op" id="1449901">!=</span>&nbsp;<span class="ident" id="1449904">nil</span>&nbsp;<span class="op" id="1449908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449912">memmove</span><span class="op" id="1449919">(</span><span class="ident" id="1449920">ep</span><span class="op" id="1449922">,</span>&nbsp;<span class="ident" id="1449924">chanbuf</span><span class="op" id="1449931">(</span><span class="ident" id="1449932">c</span><span class="op" id="1449933">,</span>&nbsp;<span class="ident" id="1449935">c</span><span class="op" id="1449936">.</span><span class="ident" id="1449937">recvx</span><span class="op" id="1449942">)</span><span class="op" id="1449943">,</span>&nbsp;<span class="builtintype" id="1449945">uintptr</span><span class="op" id="1449952">(</span><span class="ident" id="1449953">c</span><span class="op" id="1449954">.</span><span class="ident" id="1449955">elemsize</span><span class="op" id="1449963">)</span><span class="op" id="1449964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1449967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1449970">memclr</span><span class="op" id="1449976">(</span><span class="ident" id="1449977">chanbuf</span><span class="op" id="1449984">(</span><span class="ident" id="1449985">c</span><span class="op" id="1449986">,</span>&nbsp;<span class="ident" id="1449988">c</span><span class="op" id="1449989">.</span><span class="ident" id="1449990">recvx</span><span class="op" id="1449995">)</span><span class="op" id="1449996">,</span>&nbsp;<span class="builtintype" id="1449998">uintptr</span><span class="op" id="1450005">(</span><span class="ident" id="1450006">c</span><span class="op" id="1450007">.</span><span class="ident" id="1450008">elemsize</span><span class="op" id="1450016">)</span><span class="op" id="1450017">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450021">c</span><span class="op" id="1450022">.</span><span class="ident" id="1450023">recvx</span><span class="op" id="1450028">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450032">if</span>&nbsp;<span class="ident" id="1450035">c</span><span class="op" id="1450036">.</span><span class="ident" id="1450037">recvx</span>&nbsp;<span class="op" id="1450043">==</span>&nbsp;<span class="ident" id="1450046">c</span><span class="op" id="1450047">.</span><span class="ident" id="1450048">dataqsiz</span>&nbsp;<span class="op" id="1450057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450061">c</span><span class="op" id="1450062">.</span><span class="ident" id="1450063">recvx</span>&nbsp;<span class="op" id="1450069">=</span>&nbsp;<span class="num" id="1450071">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450074">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450077">c</span><span class="op" id="1450078">.</span><span class="ident" id="1450079">qcount</span><span class="op" id="1450085">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1450090">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450132">sg</span>&nbsp;<span class="op" id="1450135">:=</span>&nbsp;<span class="ident" id="1450138">c</span><span class="op" id="1450139">.</span><span class="ident" id="1450140">sendq</span><span class="op" id="1450145">.</span><span class="ident" id="1450146">dequeue</span><span class="op" id="1450153">(</span><span class="op" id="1450154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450157">if</span>&nbsp;<span class="ident" id="1450160">sg</span>&nbsp;<span class="op" id="1450163">!=</span>&nbsp;<span class="ident" id="1450166">nil</span>&nbsp;<span class="op" id="1450170">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450174">gp</span>&nbsp;<span class="op" id="1450177">:=</span>&nbsp;<span class="ident" id="1450180">sg</span><span class="op" id="1450182">.</span><span class="ident" id="1450183">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450187">unlock</span><span class="op" id="1450193">(</span><span class="op" id="1450194">&amp;</span><span class="ident" id="1450195">c</span><span class="op" id="1450196">.</span><span class="ident" id="1450197">lock</span><span class="op" id="1450201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450205">if</span>&nbsp;<span class="ident" id="1450208">sg</span><span class="op" id="1450210">.</span><span class="ident" id="1450211">releasetime</span>&nbsp;<span class="op" id="1450223">!=</span>&nbsp;<span class="num" id="1450226">0</span>&nbsp;<span class="op" id="1450228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450233">sg</span><span class="op" id="1450235">.</span><span class="ident" id="1450236">releasetime</span>&nbsp;<span class="op" id="1450248">=</span>&nbsp;<span class="ident" id="1450250">cputicks</span><span class="op" id="1450258">(</span><span class="op" id="1450259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450263">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450267">goready</span><span class="op" id="1450274">(</span><span class="ident" id="1450275">gp</span><span class="op" id="1450277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450280">}</span>&nbsp;<span class="keyword" id="1450282">else</span>&nbsp;<span class="op" id="1450287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450291">unlock</span><span class="op" id="1450297">(</span><span class="op" id="1450298">&amp;</span><span class="ident" id="1450299">c</span><span class="op" id="1450300">.</span><span class="ident" id="1450301">lock</span><span class="op" id="1450305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450312">if</span>&nbsp;<span class="ident" id="1450315">t1</span>&nbsp;<span class="op" id="1450318">&gt;</span>&nbsp;<span class="num" id="1450320">0</span>&nbsp;<span class="op" id="1450322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450326">blockevent</span><span class="op" id="1450336">(</span><span class="ident" id="1450337">t1</span><span class="op" id="1450339">-</span><span class="ident" id="1450340">t0</span><span class="op" id="1450342">,</span>&nbsp;<span class="num" id="1450344">2</span><span class="op" id="1450345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450351">selected</span>&nbsp;<span class="op" id="1450360">=</span>&nbsp;<span class="builtintype" id="1450362">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450368">received</span>&nbsp;<span class="op" id="1450377">=</span>&nbsp;<span class="builtintype" id="1450379">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450385">return</span><br>
<span class="lineno"></span><span class="op" id="1450392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1450395">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1450461">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1450511">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1450573">func</span>&nbsp;<span class="ident" id="1450578">recvclosed</span><span class="op" id="1450588">(</span><span class="ident" id="1450589">c</span>&nbsp;<span class="op" id="1450591">*</span><span class="ident" id="1450592">hchan</span><span class="op" id="1450597">,</span>&nbsp;<span class="ident" id="1450599">ep</span>&nbsp;<span class="ident" id="1450602">unsafe</span><span class="op" id="1450608">.</span><span class="ident" id="1450609">Pointer</span><span class="op" id="1450616">)</span>&nbsp;<span class="op" id="1450618">(</span><span class="ident" id="1450619">selected</span><span class="op" id="1450627">,</span>&nbsp;<span class="ident" id="1450629">recevied</span>&nbsp;<span class="builtintype" id="1450638">bool</span><span class="op" id="1450642">)</span>&nbsp;<span class="op" id="1450644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450647">if</span>&nbsp;<span class="ident" id="1450650">raceenabled</span>&nbsp;<span class="op" id="1450662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450666">raceacquire</span><span class="op" id="1450677">(</span><span class="ident" id="1450678">unsafe</span><span class="op" id="1450684">.</span><span class="ident" id="1450685">Pointer</span><span class="op" id="1450692">(</span><span class="ident" id="1450693">c</span><span class="op" id="1450694">)</span><span class="op" id="1450695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450698">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450701">unlock</span><span class="op" id="1450707">(</span><span class="op" id="1450708">&amp;</span><span class="ident" id="1450709">c</span><span class="op" id="1450710">.</span><span class="ident" id="1450711">lock</span><span class="op" id="1450715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450718">if</span>&nbsp;<span class="ident" id="1450721">ep</span>&nbsp;<span class="op" id="1450724">!=</span>&nbsp;<span class="ident" id="1450727">nil</span>&nbsp;<span class="op" id="1450731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1450735">memclr</span><span class="op" id="1450741">(</span><span class="ident" id="1450742">ep</span><span class="op" id="1450744">,</span>&nbsp;<span class="builtintype" id="1450746">uintptr</span><span class="op" id="1450753">(</span><span class="ident" id="1450754">c</span><span class="op" id="1450755">.</span><span class="ident" id="1450756">elemsize</span><span class="op" id="1450764">)</span><span class="op" id="1450765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1450768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1450771">return</span>&nbsp;<span class="builtintype" id="1450778">true</span><span class="op" id="1450782">,</span>&nbsp;<span class="builtintype" id="1450784">false</span><br>
<span class="lineno">525</span><span class="op" id="1450790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1450793">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1450816">//</span><br>
<span class="lineno"></span><span class="comment" id="1450819">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1450831">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1450847">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1450859">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1450871">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1450883">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">535</span><span class="comment" id="1450888">//</span><br>
<span class="lineno"></span><span class="comment" id="1450891">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1450897">//</span><br>
<span class="lineno"></span><span class="comment" id="1450900">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1450927">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1450939">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1450951">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1450963">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1450968">//</span><br>
<span class="lineno"></span><span class="keyword" id="1450971">func</span>&nbsp;<span class="ident" id="1450976">selectnbsend</span><span class="op" id="1450988">(</span><span class="ident" id="1450989">t</span>&nbsp;<span class="op" id="1450991">*</span><span class="ident" id="1450992">chantype</span><span class="op" id="1451000">,</span>&nbsp;<span class="ident" id="1451002">c</span>&nbsp;<span class="op" id="1451004">*</span><span class="ident" id="1451005">hchan</span><span class="op" id="1451010">,</span>&nbsp;<span class="ident" id="1451012">elem</span>&nbsp;<span class="ident" id="1451017">unsafe</span><span class="op" id="1451023">.</span><span class="ident" id="1451024">Pointer</span><span class="op" id="1451031">)</span>&nbsp;<span class="op" id="1451033">(</span><span class="ident" id="1451034">selected</span>&nbsp;<span class="builtintype" id="1451043">bool</span><span class="op" id="1451047">)</span>&nbsp;<span class="op" id="1451049">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451052">return</span>&nbsp;<span class="ident" id="1451059">chansend</span><span class="op" id="1451067">(</span><span class="ident" id="1451068">t</span><span class="op" id="1451069">,</span>&nbsp;<span class="ident" id="1451071">c</span><span class="op" id="1451072">,</span>&nbsp;<span class="ident" id="1451074">elem</span><span class="op" id="1451078">,</span>&nbsp;<span class="builtintype" id="1451080">false</span><span class="op" id="1451085">,</span>&nbsp;<span class="ident" id="1451087">getcallerpc</span><span class="op" id="1451098">(</span><span class="ident" id="1451099">unsafe</span><span class="op" id="1451105">.</span><span class="ident" id="1451106">Pointer</span><span class="op" id="1451113">(</span><span class="op" id="1451114">&amp;</span><span class="ident" id="1451115">t</span><span class="op" id="1451116">)</span><span class="op" id="1451117">)</span><span class="op" id="1451118">)</span><br>
<span class="lineno"></span><span class="op" id="1451120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451123">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1451146">//</span><br>
<span class="lineno">550</span><span class="comment" id="1451149">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1451161">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1451178">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1451190">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1451202">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1451214">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1451219">//</span><br>
<span class="lineno"></span><span class="comment" id="1451222">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1451228">//</span><br>
<span class="lineno"></span><span class="comment" id="1451231">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1451259">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1451271">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1451283">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1451295">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1451300">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1451303">func</span>&nbsp;<span class="ident" id="1451308">selectnbrecv</span><span class="op" id="1451320">(</span><span class="ident" id="1451321">t</span>&nbsp;<span class="op" id="1451323">*</span><span class="ident" id="1451324">chantype</span><span class="op" id="1451332">,</span>&nbsp;<span class="ident" id="1451334">elem</span>&nbsp;<span class="ident" id="1451339">unsafe</span><span class="op" id="1451345">.</span><span class="ident" id="1451346">Pointer</span><span class="op" id="1451353">,</span>&nbsp;<span class="ident" id="1451355">c</span>&nbsp;<span class="op" id="1451357">*</span><span class="ident" id="1451358">hchan</span><span class="op" id="1451363">)</span>&nbsp;<span class="op" id="1451365">(</span><span class="ident" id="1451366">selected</span>&nbsp;<span class="builtintype" id="1451375">bool</span><span class="op" id="1451379">)</span>&nbsp;<span class="op" id="1451381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451384">selected</span><span class="op" id="1451392">,</span>&nbsp;<span class="ident" id="1451394">_</span>&nbsp;<span class="op" id="1451396">=</span>&nbsp;<span class="ident" id="1451398">chanrecv</span><span class="op" id="1451406">(</span><span class="ident" id="1451407">t</span><span class="op" id="1451408">,</span>&nbsp;<span class="ident" id="1451410">c</span><span class="op" id="1451411">,</span>&nbsp;<span class="ident" id="1451413">elem</span><span class="op" id="1451417">,</span>&nbsp;<span class="builtintype" id="1451419">false</span><span class="op" id="1451424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451427">return</span><br>
<span class="lineno"></span><span class="op" id="1451434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1451437">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1451460">//</span><br>
<span class="lineno"></span><span class="comment" id="1451463">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1451475">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1451496">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1451508">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1451520">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1451532">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1451537">//</span><br>
<span class="lineno"></span><span class="comment" id="1451540">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1451546">//</span><br>
<span class="lineno"></span><span class="comment" id="1451549">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1451595">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1451607">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1451619">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1451631">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1451636">//</span><br>
<span class="lineno"></span><span class="keyword" id="1451639">func</span>&nbsp;<span class="ident" id="1451644">selectnbrecv2</span><span class="op" id="1451657">(</span><span class="ident" id="1451658">t</span>&nbsp;<span class="op" id="1451660">*</span><span class="ident" id="1451661">chantype</span><span class="op" id="1451669">,</span>&nbsp;<span class="ident" id="1451671">elem</span>&nbsp;<span class="ident" id="1451676">unsafe</span><span class="op" id="1451682">.</span><span class="ident" id="1451683">Pointer</span><span class="op" id="1451690">,</span>&nbsp;<span class="ident" id="1451692">received</span>&nbsp;<span class="op" id="1451701">*</span><span class="builtintype" id="1451702">bool</span><span class="op" id="1451706">,</span>&nbsp;<span class="ident" id="1451708">c</span>&nbsp;<span class="op" id="1451710">*</span><span class="ident" id="1451711">hchan</span><span class="op" id="1451716">)</span>&nbsp;<span class="op" id="1451718">(</span><span class="ident" id="1451719">selected</span>&nbsp;<span class="builtintype" id="1451728">bool</span><span class="op" id="1451732">)</span>&nbsp;<span class="op" id="1451734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451737">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451815">selected</span><span class="op" id="1451823">,</span>&nbsp;<span class="op" id="1451825">*</span><span class="ident" id="1451826">received</span>&nbsp;<span class="op" id="1451835">=</span>&nbsp;<span class="ident" id="1451837">chanrecv</span><span class="op" id="1451845">(</span><span class="ident" id="1451846">t</span><span class="op" id="1451847">,</span>&nbsp;<span class="ident" id="1451849">c</span><span class="op" id="1451850">,</span>&nbsp;<span class="ident" id="1451852">elem</span><span class="op" id="1451856">,</span>&nbsp;<span class="builtintype" id="1451858">false</span><span class="op" id="1451863">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451866">return</span><br>
<span class="lineno"></span><span class="op" id="1451873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1451876">func</span>&nbsp;<span class="ident" id="1451881">reflect_chansend</span><span class="op" id="1451897">(</span><span class="ident" id="1451898">t</span>&nbsp;<span class="op" id="1451900">*</span><span class="ident" id="1451901">chantype</span><span class="op" id="1451909">,</span>&nbsp;<span class="ident" id="1451911">c</span>&nbsp;<span class="op" id="1451913">*</span><span class="ident" id="1451914">hchan</span><span class="op" id="1451919">,</span>&nbsp;<span class="ident" id="1451921">elem</span>&nbsp;<span class="ident" id="1451926">unsafe</span><span class="op" id="1451932">.</span><span class="ident" id="1451933">Pointer</span><span class="op" id="1451940">,</span>&nbsp;<span class="ident" id="1451942">nb</span>&nbsp;<span class="builtintype" id="1451945">bool</span><span class="op" id="1451949">)</span>&nbsp;<span class="op" id="1451951">(</span><span class="ident" id="1451952">selected</span>&nbsp;<span class="builtintype" id="1451961">bool</span><span class="op" id="1451965">)</span>&nbsp;<span class="op" id="1451967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451970">return</span>&nbsp;<span class="ident" id="1451977">chansend</span><span class="op" id="1451985">(</span><span class="ident" id="1451986">t</span><span class="op" id="1451987">,</span>&nbsp;<span class="ident" id="1451989">c</span><span class="op" id="1451990">,</span>&nbsp;<span class="ident" id="1451992">elem</span><span class="op" id="1451996">,</span>&nbsp;<span class="op" id="1451998">!</span><span class="ident" id="1451999">nb</span><span class="op" id="1452001">,</span>&nbsp;<span class="ident" id="1452003">getcallerpc</span><span class="op" id="1452014">(</span><span class="ident" id="1452015">unsafe</span><span class="op" id="1452021">.</span><span class="ident" id="1452022">Pointer</span><span class="op" id="1452029">(</span><span class="op" id="1452030">&amp;</span><span class="ident" id="1452031">t</span><span class="op" id="1452032">)</span><span class="op" id="1452033">)</span><span class="op" id="1452034">)</span><br>
<span class="lineno">595</span><span class="op" id="1452036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1452039">func</span>&nbsp;<span class="ident" id="1452044">reflect_chanrecv</span><span class="op" id="1452060">(</span><span class="ident" id="1452061">t</span>&nbsp;<span class="op" id="1452063">*</span><span class="ident" id="1452064">chantype</span><span class="op" id="1452072">,</span>&nbsp;<span class="ident" id="1452074">c</span>&nbsp;<span class="op" id="1452076">*</span><span class="ident" id="1452077">hchan</span><span class="op" id="1452082">,</span>&nbsp;<span class="ident" id="1452084">nb</span>&nbsp;<span class="builtintype" id="1452087">bool</span><span class="op" id="1452091">,</span>&nbsp;<span class="ident" id="1452093">elem</span>&nbsp;<span class="ident" id="1452098">unsafe</span><span class="op" id="1452104">.</span><span class="ident" id="1452105">Pointer</span><span class="op" id="1452112">)</span>&nbsp;<span class="op" id="1452114">(</span><span class="ident" id="1452115">selected</span>&nbsp;<span class="builtintype" id="1452124">bool</span><span class="op" id="1452128">,</span>&nbsp;<span class="ident" id="1452130">received</span>&nbsp;<span class="builtintype" id="1452139">bool</span><span class="op" id="1452143">)</span>&nbsp;<span class="op" id="1452145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452148">return</span>&nbsp;<span class="ident" id="1452155">chanrecv</span><span class="op" id="1452163">(</span><span class="ident" id="1452164">t</span><span class="op" id="1452165">,</span>&nbsp;<span class="ident" id="1452167">c</span><span class="op" id="1452168">,</span>&nbsp;<span class="ident" id="1452170">elem</span><span class="op" id="1452174">,</span>&nbsp;<span class="op" id="1452176">!</span><span class="ident" id="1452177">nb</span><span class="op" id="1452179">)</span><br>
<span class="lineno"></span><span class="op" id="1452181">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1452184">func</span>&nbsp;<span class="ident" id="1452189">reflect_chanlen</span><span class="op" id="1452204">(</span><span class="ident" id="1452205">c</span>&nbsp;<span class="op" id="1452207">*</span><span class="ident" id="1452208">hchan</span><span class="op" id="1452213">)</span>&nbsp;<span class="builtintype" id="1452215">int</span>&nbsp;<span class="op" id="1452219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452222">if</span>&nbsp;<span class="ident" id="1452225">c</span>&nbsp;<span class="op" id="1452227">==</span>&nbsp;<span class="ident" id="1452230">nil</span>&nbsp;<span class="op" id="1452234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452238">return</span>&nbsp;<span class="num" id="1452245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452248">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452251">return</span>&nbsp;<span class="builtintype" id="1452258">int</span><span class="op" id="1452261">(</span><span class="ident" id="1452262">c</span><span class="op" id="1452263">.</span><span class="ident" id="1452264">qcount</span><span class="op" id="1452270">)</span><br>
<span class="lineno"></span><span class="op" id="1452272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1452275">func</span>&nbsp;<span class="ident" id="1452280">reflect_chancap</span><span class="op" id="1452295">(</span><span class="ident" id="1452296">c</span>&nbsp;<span class="op" id="1452298">*</span><span class="ident" id="1452299">hchan</span><span class="op" id="1452304">)</span>&nbsp;<span class="builtintype" id="1452306">int</span>&nbsp;<span class="op" id="1452310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452313">if</span>&nbsp;<span class="ident" id="1452316">c</span>&nbsp;<span class="op" id="1452318">==</span>&nbsp;<span class="ident" id="1452321">nil</span>&nbsp;<span class="op" id="1452325">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452329">return</span>&nbsp;<span class="num" id="1452336">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452342">return</span>&nbsp;<span class="builtintype" id="1452349">int</span><span class="op" id="1452352">(</span><span class="ident" id="1452353">c</span><span class="op" id="1452354">.</span><span class="ident" id="1452355">dataqsiz</span><span class="op" id="1452363">)</span><br>
<span class="lineno"></span><span class="op" id="1452365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1452368">func</span>&nbsp;<span class="op" id="1452373">(</span><span class="ident" id="1452374">q</span>&nbsp;<span class="op" id="1452376">*</span><span class="ident" id="1452377">waitq</span><span class="op" id="1452382">)</span>&nbsp;<span class="ident" id="1452384">enqueue</span><span class="op" id="1452391">(</span><span class="ident" id="1452392">sgp</span>&nbsp;<span class="op" id="1452396">*</span><span class="ident" id="1452397">sudog</span><span class="op" id="1452402">)</span>&nbsp;<span class="op" id="1452404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452407">sgp</span><span class="op" id="1452410">.</span><span class="ident" id="1452411">next</span>&nbsp;<span class="op" id="1452416">=</span>&nbsp;<span class="ident" id="1452418">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452423">if</span>&nbsp;<span class="ident" id="1452426">q</span><span class="op" id="1452427">.</span><span class="ident" id="1452428">first</span>&nbsp;<span class="op" id="1452434">==</span>&nbsp;<span class="ident" id="1452437">nil</span>&nbsp;<span class="op" id="1452441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452445">q</span><span class="op" id="1452446">.</span><span class="ident" id="1452447">first</span>&nbsp;<span class="op" id="1452453">=</span>&nbsp;<span class="ident" id="1452455">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452461">q</span><span class="op" id="1452462">.</span><span class="ident" id="1452463">last</span>&nbsp;<span class="op" id="1452468">=</span>&nbsp;<span class="ident" id="1452470">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452476">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452487">q</span><span class="op" id="1452488">.</span><span class="ident" id="1452489">last</span><span class="op" id="1452493">.</span><span class="ident" id="1452494">next</span>&nbsp;<span class="op" id="1452499">=</span>&nbsp;<span class="ident" id="1452501">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452506">q</span><span class="op" id="1452507">.</span><span class="ident" id="1452508">last</span>&nbsp;<span class="op" id="1452513">=</span>&nbsp;<span class="ident" id="1452515">sgp</span><br>
<span class="lineno"></span><span class="op" id="1452519">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1452522">func</span>&nbsp;<span class="op" id="1452527">(</span><span class="ident" id="1452528">q</span>&nbsp;<span class="op" id="1452530">*</span><span class="ident" id="1452531">waitq</span><span class="op" id="1452536">)</span>&nbsp;<span class="ident" id="1452538">dequeue</span><span class="op" id="1452545">(</span><span class="op" id="1452546">)</span>&nbsp;<span class="op" id="1452548">*</span><span class="ident" id="1452549">sudog</span>&nbsp;<span class="op" id="1452555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452558">for</span>&nbsp;<span class="op" id="1452562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452566">sgp</span>&nbsp;<span class="op" id="1452570">:=</span>&nbsp;<span class="ident" id="1452573">q</span><span class="op" id="1452574">.</span><span class="ident" id="1452575">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452583">if</span>&nbsp;<span class="ident" id="1452586">sgp</span>&nbsp;<span class="op" id="1452590">==</span>&nbsp;<span class="ident" id="1452593">nil</span>&nbsp;<span class="op" id="1452597">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452602">return</span>&nbsp;<span class="ident" id="1452609">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452619">q</span><span class="op" id="1452620">.</span><span class="ident" id="1452621">first</span>&nbsp;<span class="op" id="1452627">=</span>&nbsp;<span class="ident" id="1452629">sgp</span><span class="op" id="1452632">.</span><span class="ident" id="1452633">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452640">sgp</span><span class="op" id="1452643">.</span><span class="ident" id="1452644">next</span>&nbsp;<span class="op" id="1452649">=</span>&nbsp;<span class="ident" id="1452651">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452657">if</span>&nbsp;<span class="ident" id="1452660">q</span><span class="op" id="1452661">.</span><span class="ident" id="1452662">last</span>&nbsp;<span class="op" id="1452667">==</span>&nbsp;<span class="ident" id="1452670">sgp</span>&nbsp;<span class="op" id="1452674">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452679">q</span><span class="op" id="1452680">.</span><span class="ident" id="1452681">last</span>&nbsp;<span class="op" id="1452686">=</span>&nbsp;<span class="ident" id="1452688">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452699">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452771">if</span>&nbsp;<span class="ident" id="1452774">sgp</span><span class="op" id="1452777">.</span><span class="ident" id="1452778">selectdone</span>&nbsp;<span class="op" id="1452789">!=</span>&nbsp;<span class="ident" id="1452792">nil</span>&nbsp;<span class="op" id="1452796">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452801">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452833">if</span>&nbsp;<span class="op" id="1452836">*</span><span class="ident" id="1452837">sgp</span><span class="op" id="1452840">.</span><span class="ident" id="1452841">selectdone</span>&nbsp;<span class="op" id="1452852">!=</span>&nbsp;<span class="num" id="1452855">0</span>&nbsp;<span class="op" id="1452857">||</span>&nbsp;<span class="op" id="1452860">!</span><span class="ident" id="1452861">cas</span><span class="op" id="1452864">(</span><span class="ident" id="1452865">sgp</span><span class="op" id="1452868">.</span><span class="ident" id="1452869">selectdone</span><span class="op" id="1452879">,</span>&nbsp;<span class="num" id="1452881">0</span><span class="op" id="1452882">,</span>&nbsp;<span class="num" id="1452884">1</span><span class="op" id="1452885">)</span>&nbsp;<span class="op" id="1452887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452893">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452909">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452914">return</span>&nbsp;<span class="ident" id="1452921">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452926">}</span><br>
<span class="lineno"></span><span class="op" id="1452928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1452931">func</span>&nbsp;<span class="ident" id="1452936">racesync</span><span class="op" id="1452944">(</span><span class="ident" id="1452945">c</span>&nbsp;<span class="op" id="1452947">*</span><span class="ident" id="1452948">hchan</span><span class="op" id="1452953">,</span>&nbsp;<span class="ident" id="1452955">sg</span>&nbsp;<span class="op" id="1452958">*</span><span class="ident" id="1452959">sudog</span><span class="op" id="1452964">)</span>&nbsp;<span class="op" id="1452966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452969">racerelease</span><span class="op" id="1452980">(</span><span class="ident" id="1452981">chanbuf</span><span class="op" id="1452988">(</span><span class="ident" id="1452989">c</span><span class="op" id="1452990">,</span>&nbsp;<span class="num" id="1452992">0</span><span class="op" id="1452993">)</span><span class="op" id="1452994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452997">raceacquireg</span><span class="op" id="1453009">(</span><span class="ident" id="1453010">sg</span><span class="op" id="1453012">.</span><span class="ident" id="1453013">g</span><span class="op" id="1453014">,</span>&nbsp;<span class="ident" id="1453016">chanbuf</span><span class="op" id="1453023">(</span><span class="ident" id="1453024">c</span><span class="op" id="1453025">,</span>&nbsp;<span class="num" id="1453027">0</span><span class="op" id="1453028">)</span><span class="op" id="1453029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453032">racereleaseg</span><span class="op" id="1453044">(</span><span class="ident" id="1453045">sg</span><span class="op" id="1453047">.</span><span class="ident" id="1453048">g</span><span class="op" id="1453049">,</span>&nbsp;<span class="ident" id="1453051">chanbuf</span><span class="op" id="1453058">(</span><span class="ident" id="1453059">c</span><span class="op" id="1453060">,</span>&nbsp;<span class="num" id="1453062">0</span><span class="op" id="1453063">)</span><span class="op" id="1453064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453067">raceacquire</span><span class="op" id="1453078">(</span><span class="ident" id="1453079">chanbuf</span><span class="op" id="1453086">(</span><span class="ident" id="1453087">c</span><span class="op" id="1453088">,</span>&nbsp;<span class="num" id="1453090">0</span><span class="op" id="1453091">)</span><span class="op" id="1453092">)</span><br>
<span class="lineno">655</span><span class="op" id="1453094">}</span>
</div>
</body>
</html>
