<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2373887">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2373942">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2373996">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2374047">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2374112">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2374139">package</span>&nbsp;<span class="ident" id="2374147">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2374156">import</span>&nbsp;<span class="op" id="2374163">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2374166">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2374177">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2374185">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2374194">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2374197">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2374263">//</span><br>
<span class="lineno"></span><span class="comment" id="2374266">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2374331">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2374392">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2374456">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2374512">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2374576">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2374638">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2374705">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2374769">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2374814">//</span><br>
<span class="lineno"></span><span class="comment" id="2374817">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2374885">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2374956">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2375025">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2375058">//</span><br>
<span class="lineno"></span><span class="comment" id="2375061">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2375125">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2375191">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2375257">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2375294">//</span><br>
<span class="lineno"></span><span class="comment" id="2375297">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2375358">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2375431">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2375499">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2375565">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2375634">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2375699">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2375741">//</span><br>
<span class="lineno"></span><span class="comment" id="2375744">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2375808">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2375875">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2375938">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2375991">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2376058">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2376086">//</span><br>
<span class="lineno"></span><span class="comment" id="2376089">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2376139">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2376189">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2376250">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2376296">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2376359">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2376405">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2376455">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2376512">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2376579">var</span>&nbsp;<span class="ident" id="2376583">ForkLock</span>&nbsp;<span class="ident" id="2376592">sync</span><span class="op" id="2376596">.</span><span class="ident" id="2376597">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2376606">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2376672">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2376738">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2376764">func</span>&nbsp;<span class="ident" id="2376769">StringSlicePtr</span><span class="op" id="2376783">(</span><span class="ident" id="2376784">ss</span>&nbsp;<span class="op" id="2376787">[</span><span class="op" id="2376788">]</span><span class="builtintype" id="2376789">string</span><span class="op" id="2376795">)</span>&nbsp;<span class="op" id="2376797">[</span><span class="op" id="2376798">]</span><span class="op" id="2376799">*</span><span class="builtintype" id="2376800">byte</span>&nbsp;<span class="op" id="2376805">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376808">bb</span>&nbsp;<span class="op" id="2376811">:=</span>&nbsp;<span class="builtinfunc" id="2376814">make</span><span class="op" id="2376818">(</span><span class="op" id="2376819">[</span><span class="op" id="2376820">]</span><span class="op" id="2376821">*</span><span class="builtintype" id="2376822">byte</span><span class="op" id="2376826">,</span>&nbsp;<span class="builtinfunc" id="2376828">len</span><span class="op" id="2376831">(</span><span class="ident" id="2376832">ss</span><span class="op" id="2376834">)</span><span class="op" id="2376835">+</span><span class="num" id="2376836">1</span><span class="op" id="2376837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376840">for</span>&nbsp;<span class="ident" id="2376844">i</span>&nbsp;<span class="op" id="2376846">:=</span>&nbsp;<span class="num" id="2376849">0</span><span class="op" id="2376850">;</span>&nbsp;<span class="ident" id="2376852">i</span>&nbsp;<span class="op" id="2376854">&lt;</span>&nbsp;<span class="builtinfunc" id="2376856">len</span><span class="op" id="2376859">(</span><span class="ident" id="2376860">ss</span><span class="op" id="2376862">)</span><span class="op" id="2376863">;</span>&nbsp;<span class="ident" id="2376865">i</span><span class="op" id="2376866">++</span>&nbsp;<span class="op" id="2376869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376873">bb</span><span class="op" id="2376875">[</span><span class="ident" id="2376876">i</span><span class="op" id="2376877">]</span>&nbsp;<span class="op" id="2376879">=</span>&nbsp;<span class="ident" id="2376881">StringBytePtr</span><span class="op" id="2376894">(</span><span class="ident" id="2376895">ss</span><span class="op" id="2376897">[</span><span class="ident" id="2376898">i</span><span class="op" id="2376899">]</span><span class="op" id="2376900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376906">bb</span><span class="op" id="2376908">[</span><span class="builtinfunc" id="2376909">len</span><span class="op" id="2376912">(</span><span class="ident" id="2376913">ss</span><span class="op" id="2376915">)</span><span class="op" id="2376916">]</span>&nbsp;<span class="op" id="2376918">=</span>&nbsp;<span class="ident" id="2376920">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376925">return</span>&nbsp;<span class="ident" id="2376932">bb</span><br>
<span class="lineno"></span><span class="op" id="2376935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2376938">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2377003">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2377069">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2377110">func</span>&nbsp;<span class="ident" id="2377115">SlicePtrFromStrings</span><span class="op" id="2377134">(</span><span class="ident" id="2377135">ss</span>&nbsp;<span class="op" id="2377138">[</span><span class="op" id="2377139">]</span><span class="builtintype" id="2377140">string</span><span class="op" id="2377146">)</span>&nbsp;<span class="op" id="2377148">(</span><span class="op" id="2377149">[</span><span class="op" id="2377150">]</span><span class="op" id="2377151">*</span><span class="builtintype" id="2377152">byte</span><span class="op" id="2377156">,</span>&nbsp;<span class="builtintype" id="2377158">error</span><span class="op" id="2377163">)</span>&nbsp;<span class="op" id="2377165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377168">var</span>&nbsp;<span class="ident" id="2377172">err</span>&nbsp;<span class="builtintype" id="2377176">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377183">bb</span>&nbsp;<span class="op" id="2377186">:=</span>&nbsp;<span class="builtinfunc" id="2377189">make</span><span class="op" id="2377193">(</span><span class="op" id="2377194">[</span><span class="op" id="2377195">]</span><span class="op" id="2377196">*</span><span class="builtintype" id="2377197">byte</span><span class="op" id="2377201">,</span>&nbsp;<span class="builtinfunc" id="2377203">len</span><span class="op" id="2377206">(</span><span class="ident" id="2377207">ss</span><span class="op" id="2377209">)</span><span class="op" id="2377210">+</span><span class="num" id="2377211">1</span><span class="op" id="2377212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377215">for</span>&nbsp;<span class="ident" id="2377219">i</span>&nbsp;<span class="op" id="2377221">:=</span>&nbsp;<span class="num" id="2377224">0</span><span class="op" id="2377225">;</span>&nbsp;<span class="ident" id="2377227">i</span>&nbsp;<span class="op" id="2377229">&lt;</span>&nbsp;<span class="builtinfunc" id="2377231">len</span><span class="op" id="2377234">(</span><span class="ident" id="2377235">ss</span><span class="op" id="2377237">)</span><span class="op" id="2377238">;</span>&nbsp;<span class="ident" id="2377240">i</span><span class="op" id="2377241">++</span>&nbsp;<span class="op" id="2377244">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377248">bb</span><span class="op" id="2377250">[</span><span class="ident" id="2377251">i</span><span class="op" id="2377252">]</span><span class="op" id="2377253">,</span>&nbsp;<span class="ident" id="2377255">err</span>&nbsp;<span class="op" id="2377259">=</span>&nbsp;<span class="ident" id="2377261">BytePtrFromString</span><span class="op" id="2377278">(</span><span class="ident" id="2377279">ss</span><span class="op" id="2377281">[</span><span class="ident" id="2377282">i</span><span class="op" id="2377283">]</span><span class="op" id="2377284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377288">if</span>&nbsp;<span class="ident" id="2377291">err</span>&nbsp;<span class="op" id="2377295">!=</span>&nbsp;<span class="ident" id="2377298">nil</span>&nbsp;<span class="op" id="2377302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377307">return</span>&nbsp;<span class="ident" id="2377314">nil</span><span class="op" id="2377317">,</span>&nbsp;<span class="ident" id="2377319">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377328">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377331">bb</span><span class="op" id="2377333">[</span><span class="builtinfunc" id="2377334">len</span><span class="op" id="2377337">(</span><span class="ident" id="2377338">ss</span><span class="op" id="2377340">)</span><span class="op" id="2377341">]</span>&nbsp;<span class="op" id="2377343">=</span>&nbsp;<span class="ident" id="2377345">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377350">return</span>&nbsp;<span class="ident" id="2377357">bb</span><span class="op" id="2377359">,</span>&nbsp;<span class="ident" id="2377361">nil</span><br>
<span class="lineno"></span><span class="op" id="2377365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2377368">func</span>&nbsp;<span class="ident" id="2377373">CloseOnExec</span><span class="op" id="2377384">(</span><span class="ident" id="2377385">fd</span>&nbsp;<span class="builtintype" id="2377388">int</span><span class="op" id="2377391">)</span>&nbsp;<span class="op" id="2377393">{</span>&nbsp;<span class="ident" id="2377395">fcntl</span><span class="op" id="2377400">(</span><span class="ident" id="2377401">fd</span><span class="op" id="2377403">,</span>&nbsp;<span class="ident" id="2377405">F_SETFD</span><span class="op" id="2377412">,</span>&nbsp;<span class="ident" id="2377414">FD_CLOEXEC</span><span class="op" id="2377424">)</span>&nbsp;<span class="op" id="2377426">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2377429">func</span>&nbsp;<span class="ident" id="2377434">SetNonblock</span><span class="op" id="2377445">(</span><span class="ident" id="2377446">fd</span>&nbsp;<span class="builtintype" id="2377449">int</span><span class="op" id="2377452">,</span>&nbsp;<span class="ident" id="2377454">nonblocking</span>&nbsp;<span class="builtintype" id="2377466">bool</span><span class="op" id="2377470">)</span>&nbsp;<span class="op" id="2377472">(</span><span class="ident" id="2377473">err</span>&nbsp;<span class="builtintype" id="2377477">error</span><span class="op" id="2377482">)</span>&nbsp;<span class="op" id="2377484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377487">flag</span><span class="op" id="2377491">,</span>&nbsp;<span class="ident" id="2377493">err</span>&nbsp;<span class="op" id="2377497">:=</span>&nbsp;<span class="ident" id="2377500">fcntl</span><span class="op" id="2377505">(</span><span class="ident" id="2377506">fd</span><span class="op" id="2377508">,</span>&nbsp;<span class="ident" id="2377510">F_GETFL</span><span class="op" id="2377517">,</span>&nbsp;<span class="num" id="2377519">0</span><span class="op" id="2377520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377523">if</span>&nbsp;<span class="ident" id="2377526">err</span>&nbsp;<span class="op" id="2377530">!=</span>&nbsp;<span class="ident" id="2377533">nil</span>&nbsp;<span class="op" id="2377537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377541">return</span>&nbsp;<span class="ident" id="2377548">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377556">if</span>&nbsp;<span class="ident" id="2377559">nonblocking</span>&nbsp;<span class="op" id="2377571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377575">flag</span>&nbsp;<span class="op" id="2377580">|=</span>&nbsp;<span class="ident" id="2377583">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377595">}</span>&nbsp;<span class="keyword" id="2377597">else</span>&nbsp;<span class="op" id="2377602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377606">flag</span>&nbsp;<span class="op" id="2377611">&amp;=</span>&nbsp;<span class="op" id="2377614">^</span><span class="ident" id="2377615">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377630">_</span><span class="op" id="2377631">,</span>&nbsp;<span class="ident" id="2377633">err</span>&nbsp;<span class="op" id="2377637">=</span>&nbsp;<span class="ident" id="2377639">fcntl</span><span class="op" id="2377644">(</span><span class="ident" id="2377645">fd</span><span class="op" id="2377647">,</span>&nbsp;<span class="ident" id="2377649">F_SETFL</span><span class="op" id="2377656">,</span>&nbsp;<span class="ident" id="2377658">flag</span><span class="op" id="2377662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377665">return</span>&nbsp;<span class="ident" id="2377672">err</span><br>
<span class="lineno"></span><span class="op" id="2377676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2377679">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2377739">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2377786">type</span>&nbsp;<span class="ident" id="2377791">Credential</span>&nbsp;<span class="keyword" id="2377802">struct</span>&nbsp;<span class="op" id="2377809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377812">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2377819">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2377828">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377841">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2377848">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2377857">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377871">Groups</span>&nbsp;<span class="op" id="2377878">[</span><span class="op" id="2377879">]</span><span class="builtintype" id="2377880">uint32</span>&nbsp;<span class="comment" id="2377887">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2377915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2377918">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2377993">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2378013">type</span>&nbsp;<span class="ident" id="2378018">ProcAttr</span>&nbsp;<span class="keyword" id="2378027">struct</span>&nbsp;<span class="op" id="2378034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378037">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2378043">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2378053">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378084">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2378090">[</span><span class="op" id="2378091">]</span><span class="builtintype" id="2378092">string</span>&nbsp;&nbsp;<span class="comment" id="2378100">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378117">Files</span>&nbsp;<span class="op" id="2378123">[</span><span class="op" id="2378124">]</span><span class="builtintype" id="2378125">uintptr</span>&nbsp;<span class="comment" id="2378133">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378155">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2378161">*</span><span class="ident" id="2378162">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2378174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2378177">var</span>&nbsp;<span class="ident" id="2378181">zeroProcAttr</span>&nbsp;<span class="ident" id="2378194">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2378203">var</span>&nbsp;<span class="ident" id="2378207">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2378223">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2378236">func</span>&nbsp;<span class="ident" id="2378241">forkExec</span><span class="op" id="2378249">(</span><span class="ident" id="2378250">argv0</span>&nbsp;<span class="builtintype" id="2378256">string</span><span class="op" id="2378262">,</span>&nbsp;<span class="ident" id="2378264">argv</span>&nbsp;<span class="op" id="2378269">[</span><span class="op" id="2378270">]</span><span class="builtintype" id="2378271">string</span><span class="op" id="2378277">,</span>&nbsp;<span class="ident" id="2378279">attr</span>&nbsp;<span class="op" id="2378284">*</span><span class="ident" id="2378285">ProcAttr</span><span class="op" id="2378293">)</span>&nbsp;<span class="op" id="2378295">(</span><span class="ident" id="2378296">pid</span>&nbsp;<span class="builtintype" id="2378300">int</span><span class="op" id="2378303">,</span>&nbsp;<span class="ident" id="2378305">err</span>&nbsp;<span class="builtintype" id="2378309">error</span><span class="op" id="2378314">)</span>&nbsp;<span class="op" id="2378316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378319">var</span>&nbsp;<span class="ident" id="2378323">p</span>&nbsp;<span class="op" id="2378325">[</span><span class="num" id="2378326">2</span><span class="op" id="2378327">]</span><span class="builtintype" id="2378328">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378333">var</span>&nbsp;<span class="ident" id="2378337">n</span>&nbsp;<span class="builtintype" id="2378339">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378344">var</span>&nbsp;<span class="ident" id="2378348">err1</span>&nbsp;<span class="ident" id="2378353">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378360">var</span>&nbsp;<span class="ident" id="2378364">wstatus</span>&nbsp;<span class="ident" id="2378372">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378385">if</span>&nbsp;<span class="ident" id="2378388">attr</span>&nbsp;<span class="op" id="2378393">==</span>&nbsp;<span class="ident" id="2378396">nil</span>&nbsp;<span class="op" id="2378400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378404">attr</span>&nbsp;<span class="op" id="2378409">=</span>&nbsp;<span class="op" id="2378411">&amp;</span><span class="ident" id="2378412">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378429">sys</span>&nbsp;<span class="op" id="2378433">:=</span>&nbsp;<span class="ident" id="2378436">attr</span><span class="op" id="2378440">.</span><span class="ident" id="2378441">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378446">if</span>&nbsp;<span class="ident" id="2378449">sys</span>&nbsp;<span class="op" id="2378453">==</span>&nbsp;<span class="ident" id="2378456">nil</span>&nbsp;<span class="op" id="2378460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378464">sys</span>&nbsp;<span class="op" id="2378468">=</span>&nbsp;<span class="op" id="2378470">&amp;</span><span class="ident" id="2378471">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378492">p</span><span class="op" id="2378493">[</span><span class="num" id="2378494">0</span><span class="op" id="2378495">]</span>&nbsp;<span class="op" id="2378497">=</span>&nbsp;<span class="op" id="2378499">-</span><span class="num" id="2378500">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378503">p</span><span class="op" id="2378504">[</span><span class="num" id="2378505">1</span><span class="op" id="2378506">]</span>&nbsp;<span class="op" id="2378508">=</span>&nbsp;<span class="op" id="2378510">-</span><span class="num" id="2378511">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2378515">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378543">argv0p</span><span class="op" id="2378549">,</span>&nbsp;<span class="ident" id="2378551">err</span>&nbsp;<span class="op" id="2378555">:=</span>&nbsp;<span class="ident" id="2378558">BytePtrFromString</span><span class="op" id="2378575">(</span><span class="ident" id="2378576">argv0</span><span class="op" id="2378581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378584">if</span>&nbsp;<span class="ident" id="2378587">err</span>&nbsp;<span class="op" id="2378591">!=</span>&nbsp;<span class="ident" id="2378594">nil</span>&nbsp;<span class="op" id="2378598">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378602">return</span>&nbsp;<span class="num" id="2378609">0</span><span class="op" id="2378610">,</span>&nbsp;<span class="ident" id="2378612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378620">argvp</span><span class="op" id="2378625">,</span>&nbsp;<span class="ident" id="2378627">err</span>&nbsp;<span class="op" id="2378631">:=</span>&nbsp;<span class="ident" id="2378634">SlicePtrFromStrings</span><span class="op" id="2378653">(</span><span class="ident" id="2378654">argv</span><span class="op" id="2378658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378661">if</span>&nbsp;<span class="ident" id="2378664">err</span>&nbsp;<span class="op" id="2378668">!=</span>&nbsp;<span class="ident" id="2378671">nil</span>&nbsp;<span class="op" id="2378675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378679">return</span>&nbsp;<span class="num" id="2378686">0</span><span class="op" id="2378687">,</span>&nbsp;<span class="ident" id="2378689">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378697">envvp</span><span class="op" id="2378702">,</span>&nbsp;<span class="ident" id="2378704">err</span>&nbsp;<span class="op" id="2378708">:=</span>&nbsp;<span class="ident" id="2378711">SlicePtrFromStrings</span><span class="op" id="2378730">(</span><span class="ident" id="2378731">attr</span><span class="op" id="2378735">.</span><span class="ident" id="2378736">Env</span><span class="op" id="2378739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378742">if</span>&nbsp;<span class="ident" id="2378745">err</span>&nbsp;<span class="op" id="2378749">!=</span>&nbsp;<span class="ident" id="2378752">nil</span>&nbsp;<span class="op" id="2378756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378760">return</span>&nbsp;<span class="num" id="2378767">0</span><span class="op" id="2378768">,</span>&nbsp;<span class="ident" id="2378770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378775">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378779">if</span>&nbsp;<span class="op" id="2378782">(</span><span class="ident" id="2378783">runtime</span><span class="op" id="2378790">.</span><span class="ident" id="2378791">GOOS</span>&nbsp;<span class="op" id="2378796">==</span>&nbsp;<span class="string" id="2378799">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2378809">||</span>&nbsp;<span class="ident" id="2378812">runtime</span><span class="op" id="2378819">.</span><span class="ident" id="2378820">GOOS</span>&nbsp;<span class="op" id="2378825">==</span>&nbsp;<span class="string" id="2378828">&#34;dragonfly&#34;</span><span class="op" id="2378839">)</span>&nbsp;<span class="op" id="2378841">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2378844">len</span><span class="op" id="2378847">(</span><span class="ident" id="2378848">argv</span><span class="op" id="2378852">[</span><span class="num" id="2378853">0</span><span class="op" id="2378854">]</span><span class="op" id="2378855">)</span>&nbsp;<span class="op" id="2378857">&gt;</span>&nbsp;<span class="builtinfunc" id="2378859">len</span><span class="op" id="2378862">(</span><span class="ident" id="2378863">argv0</span><span class="op" id="2378868">)</span>&nbsp;<span class="op" id="2378870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378874">argvp</span><span class="op" id="2378879">[</span><span class="num" id="2378880">0</span><span class="op" id="2378881">]</span>&nbsp;<span class="op" id="2378883">=</span>&nbsp;<span class="ident" id="2378885">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378897">var</span>&nbsp;<span class="ident" id="2378901">chroot</span>&nbsp;<span class="op" id="2378908">*</span><span class="builtintype" id="2378909">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378915">if</span>&nbsp;<span class="ident" id="2378918">sys</span><span class="op" id="2378921">.</span><span class="ident" id="2378922">Chroot</span>&nbsp;<span class="op" id="2378929">!=</span>&nbsp;<span class="string" id="2378932">&#34;&#34;</span>&nbsp;<span class="op" id="2378935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378939">chroot</span><span class="op" id="2378945">,</span>&nbsp;<span class="ident" id="2378947">err</span>&nbsp;<span class="op" id="2378951">=</span>&nbsp;<span class="ident" id="2378953">BytePtrFromString</span><span class="op" id="2378970">(</span><span class="ident" id="2378971">sys</span><span class="op" id="2378974">.</span><span class="ident" id="2378975">Chroot</span><span class="op" id="2378981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378985">if</span>&nbsp;<span class="ident" id="2378988">err</span>&nbsp;<span class="op" id="2378992">!=</span>&nbsp;<span class="ident" id="2378995">nil</span>&nbsp;<span class="op" id="2378999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379004">return</span>&nbsp;<span class="num" id="2379011">0</span><span class="op" id="2379012">,</span>&nbsp;<span class="ident" id="2379014">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379026">var</span>&nbsp;<span class="ident" id="2379030">dir</span>&nbsp;<span class="op" id="2379034">*</span><span class="builtintype" id="2379035">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379041">if</span>&nbsp;<span class="ident" id="2379044">attr</span><span class="op" id="2379048">.</span><span class="ident" id="2379049">Dir</span>&nbsp;<span class="op" id="2379053">!=</span>&nbsp;<span class="string" id="2379056">&#34;&#34;</span>&nbsp;<span class="op" id="2379059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379063">dir</span><span class="op" id="2379066">,</span>&nbsp;<span class="ident" id="2379068">err</span>&nbsp;<span class="op" id="2379072">=</span>&nbsp;<span class="ident" id="2379074">BytePtrFromString</span><span class="op" id="2379091">(</span><span class="ident" id="2379092">attr</span><span class="op" id="2379096">.</span><span class="ident" id="2379097">Dir</span><span class="op" id="2379100">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379104">if</span>&nbsp;<span class="ident" id="2379107">err</span>&nbsp;<span class="op" id="2379111">!=</span>&nbsp;<span class="ident" id="2379114">nil</span>&nbsp;<span class="op" id="2379118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379123">return</span>&nbsp;<span class="num" id="2379130">0</span><span class="op" id="2379131">,</span>&nbsp;<span class="ident" id="2379133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379146">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379197">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379247">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379267">ForkLock</span><span class="op" id="2379275">.</span><span class="ident" id="2379276">Lock</span><span class="op" id="2379280">(</span><span class="op" id="2379281">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379285">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379331">if</span>&nbsp;<span class="ident" id="2379334">err</span>&nbsp;<span class="op" id="2379338">=</span>&nbsp;<span class="ident" id="2379340">forkExecPipe</span><span class="op" id="2379352">(</span><span class="ident" id="2379353">p</span><span class="op" id="2379354">[</span><span class="op" id="2379355">:</span><span class="op" id="2379356">]</span><span class="op" id="2379357">)</span><span class="op" id="2379358">;</span>&nbsp;<span class="ident" id="2379360">err</span>&nbsp;<span class="op" id="2379364">!=</span>&nbsp;<span class="ident" id="2379367">nil</span>&nbsp;<span class="op" id="2379371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379375">goto</span>&nbsp;<span class="builtintype" id="2379380">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379391">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379411">pid</span><span class="op" id="2379414">,</span>&nbsp;<span class="ident" id="2379416">err1</span>&nbsp;<span class="op" id="2379421">=</span>&nbsp;<span class="ident" id="2379423">forkAndExecInChild</span><span class="op" id="2379441">(</span><span class="ident" id="2379442">argv0p</span><span class="op" id="2379448">,</span>&nbsp;<span class="ident" id="2379450">argvp</span><span class="op" id="2379455">,</span>&nbsp;<span class="ident" id="2379457">envvp</span><span class="op" id="2379462">,</span>&nbsp;<span class="ident" id="2379464">chroot</span><span class="op" id="2379470">,</span>&nbsp;<span class="ident" id="2379472">dir</span><span class="op" id="2379475">,</span>&nbsp;<span class="ident" id="2379477">attr</span><span class="op" id="2379481">,</span>&nbsp;<span class="ident" id="2379483">sys</span><span class="op" id="2379486">,</span>&nbsp;<span class="ident" id="2379488">p</span><span class="op" id="2379489">[</span><span class="num" id="2379490">1</span><span class="op" id="2379491">]</span><span class="op" id="2379492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379495">if</span>&nbsp;<span class="ident" id="2379498">err1</span>&nbsp;<span class="op" id="2379503">!=</span>&nbsp;<span class="num" id="2379506">0</span>&nbsp;<span class="op" id="2379508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379512">err</span>&nbsp;<span class="op" id="2379516">=</span>&nbsp;<span class="ident" id="2379518">Errno</span><span class="op" id="2379523">(</span><span class="ident" id="2379524">err1</span><span class="op" id="2379528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379532">goto</span>&nbsp;<span class="builtintype" id="2379537">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379547">ForkLock</span><span class="op" id="2379555">.</span><span class="ident" id="2379556">Unlock</span><span class="op" id="2379562">(</span><span class="op" id="2379563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379567">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379606">Close</span><span class="op" id="2379611">(</span><span class="ident" id="2379612">p</span><span class="op" id="2379613">[</span><span class="num" id="2379614">1</span><span class="op" id="2379615">]</span><span class="op" id="2379616">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379619">n</span><span class="op" id="2379620">,</span>&nbsp;<span class="ident" id="2379622">err</span>&nbsp;<span class="op" id="2379626">=</span>&nbsp;<span class="ident" id="2379628">readlen</span><span class="op" id="2379635">(</span><span class="ident" id="2379636">p</span><span class="op" id="2379637">[</span><span class="num" id="2379638">0</span><span class="op" id="2379639">]</span><span class="op" id="2379640">,</span>&nbsp;<span class="op" id="2379642">(</span><span class="op" id="2379643">*</span><span class="builtintype" id="2379644">byte</span><span class="op" id="2379648">)</span><span class="op" id="2379649">(</span><span class="ident" id="2379650">unsafe</span><span class="op" id="2379656">.</span><span class="ident" id="2379657">Pointer</span><span class="op" id="2379664">(</span><span class="op" id="2379665">&amp;</span><span class="ident" id="2379666">err1</span><span class="op" id="2379670">)</span><span class="op" id="2379671">)</span><span class="op" id="2379672">,</span>&nbsp;<span class="builtintype" id="2379674">int</span><span class="op" id="2379677">(</span><span class="ident" id="2379678">unsafe</span><span class="op" id="2379684">.</span><span class="ident" id="2379685">Sizeof</span><span class="op" id="2379691">(</span><span class="ident" id="2379692">err1</span><span class="op" id="2379696">)</span><span class="op" id="2379697">)</span><span class="op" id="2379698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379701">Close</span><span class="op" id="2379706">(</span><span class="ident" id="2379707">p</span><span class="op" id="2379708">[</span><span class="num" id="2379709">0</span><span class="op" id="2379710">]</span><span class="op" id="2379711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379714">if</span>&nbsp;<span class="ident" id="2379717">err</span>&nbsp;<span class="op" id="2379721">!=</span>&nbsp;<span class="ident" id="2379724">nil</span>&nbsp;<span class="op" id="2379728">||</span>&nbsp;<span class="ident" id="2379731">n</span>&nbsp;<span class="op" id="2379733">!=</span>&nbsp;<span class="num" id="2379736">0</span>&nbsp;<span class="op" id="2379738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379742">if</span>&nbsp;<span class="ident" id="2379745">n</span>&nbsp;<span class="op" id="2379747">==</span>&nbsp;<span class="builtintype" id="2379750">int</span><span class="op" id="2379753">(</span><span class="ident" id="2379754">unsafe</span><span class="op" id="2379760">.</span><span class="ident" id="2379761">Sizeof</span><span class="op" id="2379767">(</span><span class="ident" id="2379768">err1</span><span class="op" id="2379772">)</span><span class="op" id="2379773">)</span>&nbsp;<span class="op" id="2379775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379780">err</span>&nbsp;<span class="op" id="2379784">=</span>&nbsp;<span class="ident" id="2379786">Errno</span><span class="op" id="2379791">(</span><span class="ident" id="2379792">err1</span><span class="op" id="2379796">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379804">if</span>&nbsp;<span class="ident" id="2379807">err</span>&nbsp;<span class="op" id="2379811">==</span>&nbsp;<span class="ident" id="2379814">nil</span>&nbsp;<span class="op" id="2379818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379823">err</span>&nbsp;<span class="op" id="2379827">=</span>&nbsp;<span class="ident" id="2379829">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379842">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2379895">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379930">_</span><span class="op" id="2379931">,</span>&nbsp;<span class="ident" id="2379933">err1</span>&nbsp;<span class="op" id="2379938">:=</span>&nbsp;<span class="ident" id="2379941">Wait4</span><span class="op" id="2379946">(</span><span class="ident" id="2379947">pid</span><span class="op" id="2379950">,</span>&nbsp;<span class="op" id="2379952">&amp;</span><span class="ident" id="2379953">wstatus</span><span class="op" id="2379960">,</span>&nbsp;<span class="num" id="2379962">0</span><span class="op" id="2379963">,</span>&nbsp;<span class="ident" id="2379965">nil</span><span class="op" id="2379968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379972">for</span>&nbsp;<span class="ident" id="2379976">err1</span>&nbsp;<span class="op" id="2379981">==</span>&nbsp;<span class="ident" id="2379984">EINTR</span>&nbsp;<span class="op" id="2379990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379995">_</span><span class="op" id="2379996">,</span>&nbsp;<span class="ident" id="2379998">err1</span>&nbsp;<span class="op" id="2380003">=</span>&nbsp;<span class="ident" id="2380005">Wait4</span><span class="op" id="2380010">(</span><span class="ident" id="2380011">pid</span><span class="op" id="2380014">,</span>&nbsp;<span class="op" id="2380016">&amp;</span><span class="ident" id="2380017">wstatus</span><span class="op" id="2380024">,</span>&nbsp;<span class="num" id="2380026">0</span><span class="op" id="2380027">,</span>&nbsp;<span class="ident" id="2380029">nil</span><span class="op" id="2380032">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380040">return</span>&nbsp;<span class="num" id="2380047">0</span><span class="op" id="2380048">,</span>&nbsp;<span class="ident" id="2380050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2380059">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380120">return</span>&nbsp;<span class="ident" id="2380127">pid</span><span class="op" id="2380130">,</span>&nbsp;<span class="ident" id="2380132">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2380137">error</span><span class="op" id="2380142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380145">if</span>&nbsp;<span class="ident" id="2380148">p</span><span class="op" id="2380149">[</span><span class="num" id="2380150">0</span><span class="op" id="2380151">]</span>&nbsp;<span class="op" id="2380153">&gt;=</span>&nbsp;<span class="num" id="2380156">0</span>&nbsp;<span class="op" id="2380158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380162">Close</span><span class="op" id="2380167">(</span><span class="ident" id="2380168">p</span><span class="op" id="2380169">[</span><span class="num" id="2380170">0</span><span class="op" id="2380171">]</span><span class="op" id="2380172">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380176">Close</span><span class="op" id="2380181">(</span><span class="ident" id="2380182">p</span><span class="op" id="2380183">[</span><span class="num" id="2380184">1</span><span class="op" id="2380185">]</span><span class="op" id="2380186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380192">ForkLock</span><span class="op" id="2380200">.</span><span class="ident" id="2380201">Unlock</span><span class="op" id="2380207">(</span><span class="op" id="2380208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380211">return</span>&nbsp;<span class="num" id="2380218">0</span><span class="op" id="2380219">,</span>&nbsp;<span class="ident" id="2380221">err</span><br>
<span class="lineno"></span><span class="op" id="2380225">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2380228">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2380288">func</span>&nbsp;<span class="ident" id="2380293">ForkExec</span><span class="op" id="2380301">(</span><span class="ident" id="2380302">argv0</span>&nbsp;<span class="builtintype" id="2380308">string</span><span class="op" id="2380314">,</span>&nbsp;<span class="ident" id="2380316">argv</span>&nbsp;<span class="op" id="2380321">[</span><span class="op" id="2380322">]</span><span class="builtintype" id="2380323">string</span><span class="op" id="2380329">,</span>&nbsp;<span class="ident" id="2380331">attr</span>&nbsp;<span class="op" id="2380336">*</span><span class="ident" id="2380337">ProcAttr</span><span class="op" id="2380345">)</span>&nbsp;<span class="op" id="2380347">(</span><span class="ident" id="2380348">pid</span>&nbsp;<span class="builtintype" id="2380352">int</span><span class="op" id="2380355">,</span>&nbsp;<span class="ident" id="2380357">err</span>&nbsp;<span class="builtintype" id="2380361">error</span><span class="op" id="2380366">)</span>&nbsp;<span class="op" id="2380368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380371">return</span>&nbsp;<span class="ident" id="2380378">forkExec</span><span class="op" id="2380386">(</span><span class="ident" id="2380387">argv0</span><span class="op" id="2380392">,</span>&nbsp;<span class="ident" id="2380394">argv</span><span class="op" id="2380398">,</span>&nbsp;<span class="ident" id="2380400">attr</span><span class="op" id="2380404">)</span><br>
<span class="lineno"></span><span class="op" id="2380406">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2380409">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2380456">func</span>&nbsp;<span class="ident" id="2380461">StartProcess</span><span class="op" id="2380473">(</span><span class="ident" id="2380474">argv0</span>&nbsp;<span class="builtintype" id="2380480">string</span><span class="op" id="2380486">,</span>&nbsp;<span class="ident" id="2380488">argv</span>&nbsp;<span class="op" id="2380493">[</span><span class="op" id="2380494">]</span><span class="builtintype" id="2380495">string</span><span class="op" id="2380501">,</span>&nbsp;<span class="ident" id="2380503">attr</span>&nbsp;<span class="op" id="2380508">*</span><span class="ident" id="2380509">ProcAttr</span><span class="op" id="2380517">)</span>&nbsp;<span class="op" id="2380519">(</span><span class="ident" id="2380520">pid</span>&nbsp;<span class="builtintype" id="2380524">int</span><span class="op" id="2380527">,</span>&nbsp;<span class="ident" id="2380529">handle</span>&nbsp;<span class="builtintype" id="2380536">uintptr</span><span class="op" id="2380543">,</span>&nbsp;<span class="ident" id="2380545">err</span>&nbsp;<span class="builtintype" id="2380549">error</span><span class="op" id="2380554">)</span>&nbsp;<span class="op" id="2380556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380559">pid</span><span class="op" id="2380562">,</span>&nbsp;<span class="ident" id="2380564">err</span>&nbsp;<span class="op" id="2380568">=</span>&nbsp;<span class="ident" id="2380570">forkExec</span><span class="op" id="2380578">(</span><span class="ident" id="2380579">argv0</span><span class="op" id="2380584">,</span>&nbsp;<span class="ident" id="2380586">argv</span><span class="op" id="2380590">,</span>&nbsp;<span class="ident" id="2380592">attr</span><span class="op" id="2380596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380599">return</span>&nbsp;<span class="ident" id="2380606">pid</span><span class="op" id="2380609">,</span>&nbsp;<span class="num" id="2380611">0</span><span class="op" id="2380612">,</span>&nbsp;<span class="ident" id="2380614">err</span><br>
<span class="lineno">240</span><span class="op" id="2380618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2380621">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2380639">func</span>&nbsp;<span class="ident" id="2380644">Exec</span><span class="op" id="2380648">(</span><span class="ident" id="2380649">argv0</span>&nbsp;<span class="builtintype" id="2380655">string</span><span class="op" id="2380661">,</span>&nbsp;<span class="ident" id="2380663">argv</span>&nbsp;<span class="op" id="2380668">[</span><span class="op" id="2380669">]</span><span class="builtintype" id="2380670">string</span><span class="op" id="2380676">,</span>&nbsp;<span class="ident" id="2380678">envv</span>&nbsp;<span class="op" id="2380683">[</span><span class="op" id="2380684">]</span><span class="builtintype" id="2380685">string</span><span class="op" id="2380691">)</span>&nbsp;<span class="op" id="2380693">(</span><span class="ident" id="2380694">err</span>&nbsp;<span class="builtintype" id="2380698">error</span><span class="op" id="2380703">)</span>&nbsp;<span class="op" id="2380705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380708">argv0p</span><span class="op" id="2380714">,</span>&nbsp;<span class="ident" id="2380716">err</span>&nbsp;<span class="op" id="2380720">:=</span>&nbsp;<span class="ident" id="2380723">BytePtrFromString</span><span class="op" id="2380740">(</span><span class="ident" id="2380741">argv0</span><span class="op" id="2380746">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380749">if</span>&nbsp;<span class="ident" id="2380752">err</span>&nbsp;<span class="op" id="2380756">!=</span>&nbsp;<span class="ident" id="2380759">nil</span>&nbsp;<span class="op" id="2380763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380767">return</span>&nbsp;<span class="ident" id="2380774">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380782">argvp</span><span class="op" id="2380787">,</span>&nbsp;<span class="ident" id="2380789">err</span>&nbsp;<span class="op" id="2380793">:=</span>&nbsp;<span class="ident" id="2380796">SlicePtrFromStrings</span><span class="op" id="2380815">(</span><span class="ident" id="2380816">argv</span><span class="op" id="2380820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380823">if</span>&nbsp;<span class="ident" id="2380826">err</span>&nbsp;<span class="op" id="2380830">!=</span>&nbsp;<span class="ident" id="2380833">nil</span>&nbsp;<span class="op" id="2380837">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380841">return</span>&nbsp;<span class="ident" id="2380848">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380856">envvp</span><span class="op" id="2380861">,</span>&nbsp;<span class="ident" id="2380863">err</span>&nbsp;<span class="op" id="2380867">:=</span>&nbsp;<span class="ident" id="2380870">SlicePtrFromStrings</span><span class="op" id="2380889">(</span><span class="ident" id="2380890">envv</span><span class="op" id="2380894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380897">if</span>&nbsp;<span class="ident" id="2380900">err</span>&nbsp;<span class="op" id="2380904">!=</span>&nbsp;<span class="ident" id="2380907">nil</span>&nbsp;<span class="op" id="2380911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2380915">return</span>&nbsp;<span class="ident" id="2380922">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2380927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2380930">_</span><span class="op" id="2380931">,</span>&nbsp;<span class="ident" id="2380933">_</span><span class="op" id="2380934">,</span>&nbsp;<span class="ident" id="2380936">err1</span>&nbsp;<span class="op" id="2380941">:=</span>&nbsp;<span class="ident" id="2380944">RawSyscall</span><span class="op" id="2380954">(</span><span class="ident" id="2380955">SYS_EXECVE</span><span class="op" id="2380965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2380969">uintptr</span><span class="op" id="2380976">(</span><span class="ident" id="2380977">unsafe</span><span class="op" id="2380983">.</span><span class="ident" id="2380984">Pointer</span><span class="op" id="2380991">(</span><span class="ident" id="2380992">argv0p</span><span class="op" id="2380998">)</span><span class="op" id="2380999">)</span><span class="op" id="2381000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2381004">uintptr</span><span class="op" id="2381011">(</span><span class="ident" id="2381012">unsafe</span><span class="op" id="2381018">.</span><span class="ident" id="2381019">Pointer</span><span class="op" id="2381026">(</span><span class="op" id="2381027">&amp;</span><span class="ident" id="2381028">argvp</span><span class="op" id="2381033">[</span><span class="num" id="2381034">0</span><span class="op" id="2381035">]</span><span class="op" id="2381036">)</span><span class="op" id="2381037">)</span><span class="op" id="2381038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2381042">uintptr</span><span class="op" id="2381049">(</span><span class="ident" id="2381050">unsafe</span><span class="op" id="2381056">.</span><span class="ident" id="2381057">Pointer</span><span class="op" id="2381064">(</span><span class="op" id="2381065">&amp;</span><span class="ident" id="2381066">envvp</span><span class="op" id="2381071">[</span><span class="num" id="2381072">0</span><span class="op" id="2381073">]</span><span class="op" id="2381074">)</span><span class="op" id="2381075">)</span><span class="op" id="2381076">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2381079">return</span>&nbsp;<span class="ident" id="2381086">Errno</span><span class="op" id="2381091">(</span><span class="ident" id="2381092">err1</span><span class="op" id="2381096">)</span><br>
<span class="lineno"></span><span class="op" id="2381098">}</span>
</div>
</body>
</html>
