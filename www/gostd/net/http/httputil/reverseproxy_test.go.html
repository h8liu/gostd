<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8261748">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8261803">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8261857">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8261908">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8261933">package</span>&nbsp;<span class="ident" id="8261941">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8261951">import</span>&nbsp;<span class="op" id="8261958">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8261961">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8261974">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8261986">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262007">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262018">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262029">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262040">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8262047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8262050">const</span>&nbsp;<span class="ident" id="8262056">fakeHopHeader</span>&nbsp;<span class="op" id="8262070">=</span>&nbsp;<span class="string" id="8262072">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8262102">func</span>&nbsp;<span class="ident" id="8262107">init</span><span class="op" id="8262111">(</span><span class="op" id="8262112">)</span>&nbsp;<span class="op" id="8262114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262117">hopHeaders</span>&nbsp;<span class="op" id="8262128">=</span>&nbsp;<span class="builtinfunc" id="8262130">append</span><span class="op" id="8262136">(</span><span class="ident" id="8262137">hopHeaders</span><span class="op" id="8262147">,</span>&nbsp;<span class="ident" id="8262149">fakeHopHeader</span><span class="op" id="8262162">)</span><br>
<span class="lineno"></span><span class="op" id="8262164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8262167">func</span>&nbsp;<span class="ident" id="8262172">TestReverseProxy</span><span class="op" id="8262188">(</span><span class="ident" id="8262189">t</span>&nbsp;<span class="op" id="8262191">*</span><span class="ident" id="8262192">testing</span><span class="op" id="8262199">.</span><span class="ident" id="8262200">T</span><span class="op" id="8262201">)</span>&nbsp;<span class="op" id="8262203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262206">const</span>&nbsp;<span class="ident" id="8262212">backendResponse</span>&nbsp;<span class="op" id="8262228">=</span>&nbsp;<span class="string" id="8262230">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262250">const</span>&nbsp;<span class="ident" id="8262256">backendStatus</span>&nbsp;<span class="op" id="8262270">=</span>&nbsp;<span class="num" id="8262272">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262277">backend</span>&nbsp;<span class="op" id="8262285">:=</span>&nbsp;<span class="ident" id="8262288">httptest</span><span class="op" id="8262296">.</span><span class="ident" id="8262297">NewServer</span><span class="op" id="8262306">(</span><span class="ident" id="8262307">http</span><span class="op" id="8262311">.</span><span class="ident" id="8262312">HandlerFunc</span><span class="op" id="8262323">(</span><span class="keyword" id="8262324">func</span><span class="op" id="8262328">(</span><span class="ident" id="8262329">w</span>&nbsp;<span class="ident" id="8262331">http</span><span class="op" id="8262335">.</span><span class="ident" id="8262336">ResponseWriter</span><span class="op" id="8262350">,</span>&nbsp;<span class="ident" id="8262352">r</span>&nbsp;<span class="op" id="8262354">*</span><span class="ident" id="8262355">http</span><span class="op" id="8262359">.</span><span class="ident" id="8262360">Request</span><span class="op" id="8262367">)</span>&nbsp;<span class="op" id="8262369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262373">if</span>&nbsp;<span class="builtinfunc" id="8262376">len</span><span class="op" id="8262379">(</span><span class="ident" id="8262380">r</span><span class="op" id="8262381">.</span><span class="ident" id="8262382">TransferEncoding</span><span class="op" id="8262398">)</span>&nbsp;<span class="op" id="8262400">&gt;</span>&nbsp;<span class="num" id="8262402">0</span>&nbsp;<span class="op" id="8262404">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262409">t</span><span class="op" id="8262410">.</span><span class="ident" id="8262411">Errorf</span><span class="op" id="8262417">(</span><span class="string" id="8262418">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="8262463">,</span>&nbsp;<span class="ident" id="8262465">r</span><span class="op" id="8262466">.</span><span class="ident" id="8262467">TransferEncoding</span><span class="op" id="8262483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8262487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262491">if</span>&nbsp;<span class="ident" id="8262494">r</span><span class="op" id="8262495">.</span><span class="ident" id="8262496">Header</span><span class="op" id="8262502">.</span><span class="ident" id="8262503">Get</span><span class="op" id="8262506">(</span><span class="string" id="8262507">&#34;X-Forwarded-For&#34;</span><span class="op" id="8262524">)</span>&nbsp;<span class="op" id="8262526">==</span>&nbsp;<span class="string" id="8262529">&#34;&#34;</span>&nbsp;<span class="op" id="8262532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262537">t</span><span class="op" id="8262538">.</span><span class="ident" id="8262539">Errorf</span><span class="op" id="8262545">(</span><span class="string" id="8262546">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8262581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8262585">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262589">if</span>&nbsp;<span class="ident" id="8262592">c</span>&nbsp;<span class="op" id="8262594">:=</span>&nbsp;<span class="ident" id="8262597">r</span><span class="op" id="8262598">.</span><span class="ident" id="8262599">Header</span><span class="op" id="8262605">.</span><span class="ident" id="8262606">Get</span><span class="op" id="8262609">(</span><span class="string" id="8262610">&#34;Connection&#34;</span><span class="op" id="8262622">)</span><span class="op" id="8262623">;</span>&nbsp;<span class="ident" id="8262625">c</span>&nbsp;<span class="op" id="8262627">!=</span>&nbsp;<span class="string" id="8262630">&#34;&#34;</span>&nbsp;<span class="op" id="8262633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262638">t</span><span class="op" id="8262639">.</span><span class="ident" id="8262640">Errorf</span><span class="op" id="8262646">(</span><span class="string" id="8262647">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8262687">,</span>&nbsp;<span class="ident" id="8262689">c</span><span class="op" id="8262690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8262694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262698">if</span>&nbsp;<span class="ident" id="8262701">c</span>&nbsp;<span class="op" id="8262703">:=</span>&nbsp;<span class="ident" id="8262706">r</span><span class="op" id="8262707">.</span><span class="ident" id="8262708">Header</span><span class="op" id="8262714">.</span><span class="ident" id="8262715">Get</span><span class="op" id="8262718">(</span><span class="string" id="8262719">&#34;Upgrade&#34;</span><span class="op" id="8262728">)</span><span class="op" id="8262729">;</span>&nbsp;<span class="ident" id="8262731">c</span>&nbsp;<span class="op" id="8262733">!=</span>&nbsp;<span class="string" id="8262736">&#34;&#34;</span>&nbsp;<span class="op" id="8262739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262744">t</span><span class="op" id="8262745">.</span><span class="ident" id="8262746">Errorf</span><span class="op" id="8262752">(</span><span class="string" id="8262753">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8262790">,</span>&nbsp;<span class="ident" id="8262792">c</span><span class="op" id="8262793">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8262797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8262801">if</span>&nbsp;<span class="ident" id="8262804">g</span><span class="op" id="8262805">,</span>&nbsp;<span class="ident" id="8262807">e</span>&nbsp;<span class="op" id="8262809">:=</span>&nbsp;<span class="ident" id="8262812">r</span><span class="op" id="8262813">.</span><span class="ident" id="8262814">Host</span><span class="op" id="8262818">,</span>&nbsp;<span class="string" id="8262820">&#34;some-name&#34;</span><span class="op" id="8262831">;</span>&nbsp;<span class="ident" id="8262833">g</span>&nbsp;<span class="op" id="8262835">!=</span>&nbsp;<span class="ident" id="8262838">e</span>&nbsp;<span class="op" id="8262840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262845">t</span><span class="op" id="8262846">.</span><span class="ident" id="8262847">Errorf</span><span class="op" id="8262853">(</span><span class="string" id="8262854">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8262891">,</span>&nbsp;<span class="ident" id="8262893">g</span><span class="op" id="8262894">,</span>&nbsp;<span class="ident" id="8262896">e</span><span class="op" id="8262897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8262901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262905">w</span><span class="op" id="8262906">.</span><span class="ident" id="8262907">Header</span><span class="op" id="8262913">(</span><span class="op" id="8262914">)</span><span class="op" id="8262915">.</span><span class="ident" id="8262916">Set</span><span class="op" id="8262919">(</span><span class="string" id="8262920">&#34;X-Foo&#34;</span><span class="op" id="8262927">,</span>&nbsp;<span class="string" id="8262929">&#34;bar&#34;</span><span class="op" id="8262934">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262938">w</span><span class="op" id="8262939">.</span><span class="ident" id="8262940">Header</span><span class="op" id="8262946">(</span><span class="op" id="8262947">)</span><span class="op" id="8262948">.</span><span class="ident" id="8262949">Set</span><span class="op" id="8262952">(</span><span class="string" id="8262953">&#34;Upgrade&#34;</span><span class="op" id="8262962">,</span>&nbsp;<span class="string" id="8262964">&#34;foo&#34;</span><span class="op" id="8262969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8262973">w</span><span class="op" id="8262974">.</span><span class="ident" id="8262975">Header</span><span class="op" id="8262981">(</span><span class="op" id="8262982">)</span><span class="op" id="8262983">.</span><span class="ident" id="8262984">Set</span><span class="op" id="8262987">(</span><span class="ident" id="8262988">fakeHopHeader</span><span class="op" id="8263001">,</span>&nbsp;<span class="string" id="8263003">&#34;foo&#34;</span><span class="op" id="8263008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263012">w</span><span class="op" id="8263013">.</span><span class="ident" id="8263014">Header</span><span class="op" id="8263020">(</span><span class="op" id="8263021">)</span><span class="op" id="8263022">.</span><span class="ident" id="8263023">Add</span><span class="op" id="8263026">(</span><span class="string" id="8263027">&#34;X-Multi-Value&#34;</span><span class="op" id="8263042">,</span>&nbsp;<span class="string" id="8263044">&#34;foo&#34;</span><span class="op" id="8263049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263053">w</span><span class="op" id="8263054">.</span><span class="ident" id="8263055">Header</span><span class="op" id="8263061">(</span><span class="op" id="8263062">)</span><span class="op" id="8263063">.</span><span class="ident" id="8263064">Add</span><span class="op" id="8263067">(</span><span class="string" id="8263068">&#34;X-Multi-Value&#34;</span><span class="op" id="8263083">,</span>&nbsp;<span class="string" id="8263085">&#34;bar&#34;</span><span class="op" id="8263090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263094">http</span><span class="op" id="8263098">.</span><span class="ident" id="8263099">SetCookie</span><span class="op" id="8263108">(</span><span class="ident" id="8263109">w</span><span class="op" id="8263110">,</span>&nbsp;<span class="op" id="8263112">&amp;</span><span class="ident" id="8263113">http</span><span class="op" id="8263117">.</span><span class="ident" id="8263118">Cookie</span><span class="op" id="8263124">{</span><span class="ident" id="8263125">Name</span><span class="op" id="8263129">:</span>&nbsp;<span class="string" id="8263131">&#34;flavor&#34;</span><span class="op" id="8263139">,</span>&nbsp;<span class="ident" id="8263141">Value</span><span class="op" id="8263146">:</span>&nbsp;<span class="string" id="8263148">&#34;chocolateChip&#34;</span><span class="op" id="8263163">}</span><span class="op" id="8263164">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263168">w</span><span class="op" id="8263169">.</span><span class="ident" id="8263170">WriteHeader</span><span class="op" id="8263181">(</span><span class="ident" id="8263182">backendStatus</span><span class="op" id="8263195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263199">w</span><span class="op" id="8263200">.</span><span class="ident" id="8263201">Write</span><span class="op" id="8263206">(</span><span class="op" id="8263207">[</span><span class="op" id="8263208">]</span><span class="builtintype" id="8263209">byte</span><span class="op" id="8263213">(</span><span class="ident" id="8263214">backendResponse</span><span class="op" id="8263229">)</span><span class="op" id="8263230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263233">}</span><span class="op" id="8263234">)</span><span class="op" id="8263235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263238">defer</span>&nbsp;<span class="ident" id="8263244">backend</span><span class="op" id="8263251">.</span><span class="ident" id="8263252">Close</span><span class="op" id="8263257">(</span><span class="op" id="8263258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263261">backendURL</span><span class="op" id="8263271">,</span>&nbsp;<span class="ident" id="8263273">err</span>&nbsp;<span class="op" id="8263277">:=</span>&nbsp;<span class="ident" id="8263280">url</span><span class="op" id="8263283">.</span><span class="ident" id="8263284">Parse</span><span class="op" id="8263289">(</span><span class="ident" id="8263290">backend</span><span class="op" id="8263297">.</span><span class="ident" id="8263298">URL</span><span class="op" id="8263301">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263304">if</span>&nbsp;<span class="ident" id="8263307">err</span>&nbsp;<span class="op" id="8263311">!=</span>&nbsp;<span class="ident" id="8263314">nil</span>&nbsp;<span class="op" id="8263318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263322">t</span><span class="op" id="8263323">.</span><span class="ident" id="8263324">Fatal</span><span class="op" id="8263329">(</span><span class="ident" id="8263330">err</span><span class="op" id="8263333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263339">proxyHandler</span>&nbsp;<span class="op" id="8263352">:=</span>&nbsp;<span class="ident" id="8263355">NewSingleHostReverseProxy</span><span class="op" id="8263380">(</span><span class="ident" id="8263381">backendURL</span><span class="op" id="8263391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263394">frontend</span>&nbsp;<span class="op" id="8263403">:=</span>&nbsp;<span class="ident" id="8263406">httptest</span><span class="op" id="8263414">.</span><span class="ident" id="8263415">NewServer</span><span class="op" id="8263424">(</span><span class="ident" id="8263425">proxyHandler</span><span class="op" id="8263437">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263440">defer</span>&nbsp;<span class="ident" id="8263446">frontend</span><span class="op" id="8263454">.</span><span class="ident" id="8263455">Close</span><span class="op" id="8263460">(</span><span class="op" id="8263461">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263465">getReq</span><span class="op" id="8263471">,</span>&nbsp;<span class="ident" id="8263473">_</span>&nbsp;<span class="op" id="8263475">:=</span>&nbsp;<span class="ident" id="8263478">http</span><span class="op" id="8263482">.</span><span class="ident" id="8263483">NewRequest</span><span class="op" id="8263493">(</span><span class="string" id="8263494">&#34;GET&#34;</span><span class="op" id="8263499">,</span>&nbsp;<span class="ident" id="8263501">frontend</span><span class="op" id="8263509">.</span><span class="ident" id="8263510">URL</span><span class="op" id="8263513">,</span>&nbsp;<span class="ident" id="8263515">nil</span><span class="op" id="8263518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263521">getReq</span><span class="op" id="8263527">.</span><span class="ident" id="8263528">Host</span>&nbsp;<span class="op" id="8263533">=</span>&nbsp;<span class="string" id="8263535">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263548">getReq</span><span class="op" id="8263554">.</span><span class="ident" id="8263555">Header</span><span class="op" id="8263561">.</span><span class="ident" id="8263562">Set</span><span class="op" id="8263565">(</span><span class="string" id="8263566">&#34;Connection&#34;</span><span class="op" id="8263578">,</span>&nbsp;<span class="string" id="8263580">&#34;close&#34;</span><span class="op" id="8263587">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263590">getReq</span><span class="op" id="8263596">.</span><span class="ident" id="8263597">Header</span><span class="op" id="8263603">.</span><span class="ident" id="8263604">Set</span><span class="op" id="8263607">(</span><span class="string" id="8263608">&#34;Upgrade&#34;</span><span class="op" id="8263617">,</span>&nbsp;<span class="string" id="8263619">&#34;foo&#34;</span><span class="op" id="8263624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263627">getReq</span><span class="op" id="8263633">.</span><span class="ident" id="8263634">Close</span>&nbsp;<span class="op" id="8263640">=</span>&nbsp;<span class="builtintype" id="8263642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263648">res</span><span class="op" id="8263651">,</span>&nbsp;<span class="ident" id="8263653">err</span>&nbsp;<span class="op" id="8263657">:=</span>&nbsp;<span class="ident" id="8263660">http</span><span class="op" id="8263664">.</span><span class="ident" id="8263665">DefaultClient</span><span class="op" id="8263678">.</span><span class="ident" id="8263679">Do</span><span class="op" id="8263681">(</span><span class="ident" id="8263682">getReq</span><span class="op" id="8263688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263691">if</span>&nbsp;<span class="ident" id="8263694">err</span>&nbsp;<span class="op" id="8263698">!=</span>&nbsp;<span class="ident" id="8263701">nil</span>&nbsp;<span class="op" id="8263705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263709">t</span><span class="op" id="8263710">.</span><span class="ident" id="8263711">Fatalf</span><span class="op" id="8263717">(</span><span class="string" id="8263718">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8263727">,</span>&nbsp;<span class="ident" id="8263729">err</span><span class="op" id="8263732">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263738">if</span>&nbsp;<span class="ident" id="8263741">g</span><span class="op" id="8263742">,</span>&nbsp;<span class="ident" id="8263744">e</span>&nbsp;<span class="op" id="8263746">:=</span>&nbsp;<span class="ident" id="8263749">res</span><span class="op" id="8263752">.</span><span class="ident" id="8263753">StatusCode</span><span class="op" id="8263763">,</span>&nbsp;<span class="ident" id="8263765">backendStatus</span><span class="op" id="8263778">;</span>&nbsp;<span class="ident" id="8263780">g</span>&nbsp;<span class="op" id="8263782">!=</span>&nbsp;<span class="ident" id="8263785">e</span>&nbsp;<span class="op" id="8263787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263791">t</span><span class="op" id="8263792">.</span><span class="ident" id="8263793">Errorf</span><span class="op" id="8263799">(</span><span class="string" id="8263800">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8263836">,</span>&nbsp;<span class="ident" id="8263838">g</span><span class="op" id="8263839">,</span>&nbsp;<span class="ident" id="8263841">e</span><span class="op" id="8263842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263848">if</span>&nbsp;<span class="ident" id="8263851">g</span><span class="op" id="8263852">,</span>&nbsp;<span class="ident" id="8263854">e</span>&nbsp;<span class="op" id="8263856">:=</span>&nbsp;<span class="ident" id="8263859">res</span><span class="op" id="8263862">.</span><span class="ident" id="8263863">Header</span><span class="op" id="8263869">.</span><span class="ident" id="8263870">Get</span><span class="op" id="8263873">(</span><span class="string" id="8263874">&#34;X-Foo&#34;</span><span class="op" id="8263881">)</span><span class="op" id="8263882">,</span>&nbsp;<span class="string" id="8263884">&#34;bar&#34;</span><span class="op" id="8263889">;</span>&nbsp;<span class="ident" id="8263891">g</span>&nbsp;<span class="op" id="8263893">!=</span>&nbsp;<span class="ident" id="8263896">e</span>&nbsp;<span class="op" id="8263898">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263902">t</span><span class="op" id="8263903">.</span><span class="ident" id="8263904">Errorf</span><span class="op" id="8263910">(</span><span class="string" id="8263911">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8263938">,</span>&nbsp;<span class="ident" id="8263940">g</span><span class="op" id="8263941">,</span>&nbsp;<span class="ident" id="8263943">e</span><span class="op" id="8263944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263950">if</span>&nbsp;<span class="ident" id="8263953">c</span>&nbsp;<span class="op" id="8263955">:=</span>&nbsp;<span class="ident" id="8263958">res</span><span class="op" id="8263961">.</span><span class="ident" id="8263962">Header</span><span class="op" id="8263968">.</span><span class="ident" id="8263969">Get</span><span class="op" id="8263972">(</span><span class="ident" id="8263973">fakeHopHeader</span><span class="op" id="8263986">)</span><span class="op" id="8263987">;</span>&nbsp;<span class="ident" id="8263989">c</span>&nbsp;<span class="op" id="8263991">!=</span>&nbsp;<span class="string" id="8263994">&#34;&#34;</span>&nbsp;<span class="op" id="8263997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264001">t</span><span class="op" id="8264002">.</span><span class="ident" id="8264003">Errorf</span><span class="op" id="8264009">(</span><span class="string" id="8264010">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8264034">,</span>&nbsp;<span class="ident" id="8264036">fakeHopHeader</span><span class="op" id="8264049">,</span>&nbsp;<span class="ident" id="8264051">c</span><span class="op" id="8264052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264055">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264058">if</span>&nbsp;<span class="ident" id="8264061">g</span><span class="op" id="8264062">,</span>&nbsp;<span class="ident" id="8264064">e</span>&nbsp;<span class="op" id="8264066">:=</span>&nbsp;<span class="builtinfunc" id="8264069">len</span><span class="op" id="8264072">(</span><span class="ident" id="8264073">res</span><span class="op" id="8264076">.</span><span class="ident" id="8264077">Header</span><span class="op" id="8264083">[</span><span class="string" id="8264084">&#34;X-Multi-Value&#34;</span><span class="op" id="8264099">]</span><span class="op" id="8264100">)</span><span class="op" id="8264101">,</span>&nbsp;<span class="num" id="8264103">2</span><span class="op" id="8264104">;</span>&nbsp;<span class="ident" id="8264106">g</span>&nbsp;<span class="op" id="8264108">!=</span>&nbsp;<span class="ident" id="8264111">e</span>&nbsp;<span class="op" id="8264113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264117">t</span><span class="op" id="8264118">.</span><span class="ident" id="8264119">Errorf</span><span class="op" id="8264125">(</span><span class="string" id="8264126">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8264175">,</span>&nbsp;<span class="ident" id="8264177">g</span><span class="op" id="8264178">,</span>&nbsp;<span class="ident" id="8264180">e</span><span class="op" id="8264181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264187">if</span>&nbsp;<span class="ident" id="8264190">g</span><span class="op" id="8264191">,</span>&nbsp;<span class="ident" id="8264193">e</span>&nbsp;<span class="op" id="8264195">:=</span>&nbsp;<span class="builtinfunc" id="8264198">len</span><span class="op" id="8264201">(</span><span class="ident" id="8264202">res</span><span class="op" id="8264205">.</span><span class="ident" id="8264206">Header</span><span class="op" id="8264212">[</span><span class="string" id="8264213">&#34;Set-Cookie&#34;</span><span class="op" id="8264225">]</span><span class="op" id="8264226">)</span><span class="op" id="8264227">,</span>&nbsp;<span class="num" id="8264229">1</span><span class="op" id="8264230">;</span>&nbsp;<span class="ident" id="8264232">g</span>&nbsp;<span class="op" id="8264234">!=</span>&nbsp;<span class="ident" id="8264237">e</span>&nbsp;<span class="op" id="8264239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264243">t</span><span class="op" id="8264244">.</span><span class="ident" id="8264245">Fatalf</span><span class="op" id="8264251">(</span><span class="string" id="8264252">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8264280">,</span>&nbsp;<span class="ident" id="8264282">g</span><span class="op" id="8264283">,</span>&nbsp;<span class="ident" id="8264285">e</span><span class="op" id="8264286">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264292">if</span>&nbsp;<span class="ident" id="8264295">cookie</span>&nbsp;<span class="op" id="8264302">:=</span>&nbsp;<span class="ident" id="8264305">res</span><span class="op" id="8264308">.</span><span class="ident" id="8264309">Cookies</span><span class="op" id="8264316">(</span><span class="op" id="8264317">)</span><span class="op" id="8264318">[</span><span class="num" id="8264319">0</span><span class="op" id="8264320">]</span><span class="op" id="8264321">;</span>&nbsp;<span class="ident" id="8264323">cookie</span><span class="op" id="8264329">.</span><span class="ident" id="8264330">Name</span>&nbsp;<span class="op" id="8264335">!=</span>&nbsp;<span class="string" id="8264338">&#34;flavor&#34;</span>&nbsp;<span class="op" id="8264347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264351">t</span><span class="op" id="8264352">.</span><span class="ident" id="8264353">Errorf</span><span class="op" id="8264359">(</span><span class="string" id="8264360">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="8264382">,</span>&nbsp;<span class="ident" id="8264384">cookie</span><span class="op" id="8264390">.</span><span class="ident" id="8264391">Name</span><span class="op" id="8264395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264401">bodyBytes</span><span class="op" id="8264410">,</span>&nbsp;<span class="ident" id="8264412">_</span>&nbsp;<span class="op" id="8264414">:=</span>&nbsp;<span class="ident" id="8264417">ioutil</span><span class="op" id="8264423">.</span><span class="ident" id="8264424">ReadAll</span><span class="op" id="8264431">(</span><span class="ident" id="8264432">res</span><span class="op" id="8264435">.</span><span class="ident" id="8264436">Body</span><span class="op" id="8264440">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264443">if</span>&nbsp;<span class="ident" id="8264446">g</span><span class="op" id="8264447">,</span>&nbsp;<span class="ident" id="8264449">e</span>&nbsp;<span class="op" id="8264451">:=</span>&nbsp;<span class="builtintype" id="8264454">string</span><span class="op" id="8264460">(</span><span class="ident" id="8264461">bodyBytes</span><span class="op" id="8264470">)</span><span class="op" id="8264471">,</span>&nbsp;<span class="ident" id="8264473">backendResponse</span><span class="op" id="8264488">;</span>&nbsp;<span class="ident" id="8264490">g</span>&nbsp;<span class="op" id="8264492">!=</span>&nbsp;<span class="ident" id="8264495">e</span>&nbsp;<span class="op" id="8264497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264501">t</span><span class="op" id="8264502">.</span><span class="ident" id="8264503">Errorf</span><span class="op" id="8264509">(</span><span class="string" id="8264510">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8264536">,</span>&nbsp;<span class="ident" id="8264538">g</span><span class="op" id="8264539">,</span>&nbsp;<span class="ident" id="8264541">e</span><span class="op" id="8264542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264545">}</span><br>
<span class="lineno"></span><span class="op" id="8264547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8264550">func</span>&nbsp;<span class="ident" id="8264555">TestXForwardedFor</span><span class="op" id="8264572">(</span><span class="ident" id="8264573">t</span>&nbsp;<span class="op" id="8264575">*</span><span class="ident" id="8264576">testing</span><span class="op" id="8264583">.</span><span class="ident" id="8264584">T</span><span class="op" id="8264585">)</span>&nbsp;<span class="op" id="8264587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264590">const</span>&nbsp;<span class="ident" id="8264596">prevForwardedFor</span>&nbsp;<span class="op" id="8264613">=</span>&nbsp;<span class="string" id="8264615">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264628">const</span>&nbsp;<span class="ident" id="8264634">backendResponse</span>&nbsp;<span class="op" id="8264650">=</span>&nbsp;<span class="string" id="8264652">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264672">const</span>&nbsp;<span class="ident" id="8264678">backendStatus</span>&nbsp;<span class="op" id="8264692">=</span>&nbsp;<span class="num" id="8264694">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264699">backend</span>&nbsp;<span class="op" id="8264707">:=</span>&nbsp;<span class="ident" id="8264710">httptest</span><span class="op" id="8264718">.</span><span class="ident" id="8264719">NewServer</span><span class="op" id="8264728">(</span><span class="ident" id="8264729">http</span><span class="op" id="8264733">.</span><span class="ident" id="8264734">HandlerFunc</span><span class="op" id="8264745">(</span><span class="keyword" id="8264746">func</span><span class="op" id="8264750">(</span><span class="ident" id="8264751">w</span>&nbsp;<span class="ident" id="8264753">http</span><span class="op" id="8264757">.</span><span class="ident" id="8264758">ResponseWriter</span><span class="op" id="8264772">,</span>&nbsp;<span class="ident" id="8264774">r</span>&nbsp;<span class="op" id="8264776">*</span><span class="ident" id="8264777">http</span><span class="op" id="8264781">.</span><span class="ident" id="8264782">Request</span><span class="op" id="8264789">)</span>&nbsp;<span class="op" id="8264791">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264795">if</span>&nbsp;<span class="ident" id="8264798">r</span><span class="op" id="8264799">.</span><span class="ident" id="8264800">Header</span><span class="op" id="8264806">.</span><span class="ident" id="8264807">Get</span><span class="op" id="8264810">(</span><span class="string" id="8264811">&#34;X-Forwarded-For&#34;</span><span class="op" id="8264828">)</span>&nbsp;<span class="op" id="8264830">==</span>&nbsp;<span class="string" id="8264833">&#34;&#34;</span>&nbsp;<span class="op" id="8264836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264841">t</span><span class="op" id="8264842">.</span><span class="ident" id="8264843">Errorf</span><span class="op" id="8264849">(</span><span class="string" id="8264850">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8264885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264893">if</span>&nbsp;<span class="op" id="8264896">!</span><span class="ident" id="8264897">strings</span><span class="op" id="8264904">.</span><span class="ident" id="8264905">Contains</span><span class="op" id="8264913">(</span><span class="ident" id="8264914">r</span><span class="op" id="8264915">.</span><span class="ident" id="8264916">Header</span><span class="op" id="8264922">.</span><span class="ident" id="8264923">Get</span><span class="op" id="8264926">(</span><span class="string" id="8264927">&#34;X-Forwarded-For&#34;</span><span class="op" id="8264944">)</span><span class="op" id="8264945">,</span>&nbsp;<span class="ident" id="8264947">prevForwardedFor</span><span class="op" id="8264963">)</span>&nbsp;<span class="op" id="8264965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264970">t</span><span class="op" id="8264971">.</span><span class="ident" id="8264972">Errorf</span><span class="op" id="8264978">(</span><span class="string" id="8264979">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="8265022">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265030">w</span><span class="op" id="8265031">.</span><span class="ident" id="8265032">WriteHeader</span><span class="op" id="8265043">(</span><span class="ident" id="8265044">backendStatus</span><span class="op" id="8265057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265061">w</span><span class="op" id="8265062">.</span><span class="ident" id="8265063">Write</span><span class="op" id="8265068">(</span><span class="op" id="8265069">[</span><span class="op" id="8265070">]</span><span class="builtintype" id="8265071">byte</span><span class="op" id="8265075">(</span><span class="ident" id="8265076">backendResponse</span><span class="op" id="8265091">)</span><span class="op" id="8265092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265095">}</span><span class="op" id="8265096">)</span><span class="op" id="8265097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265100">defer</span>&nbsp;<span class="ident" id="8265106">backend</span><span class="op" id="8265113">.</span><span class="ident" id="8265114">Close</span><span class="op" id="8265119">(</span><span class="op" id="8265120">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265123">backendURL</span><span class="op" id="8265133">,</span>&nbsp;<span class="ident" id="8265135">err</span>&nbsp;<span class="op" id="8265139">:=</span>&nbsp;<span class="ident" id="8265142">url</span><span class="op" id="8265145">.</span><span class="ident" id="8265146">Parse</span><span class="op" id="8265151">(</span><span class="ident" id="8265152">backend</span><span class="op" id="8265159">.</span><span class="ident" id="8265160">URL</span><span class="op" id="8265163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265166">if</span>&nbsp;<span class="ident" id="8265169">err</span>&nbsp;<span class="op" id="8265173">!=</span>&nbsp;<span class="ident" id="8265176">nil</span>&nbsp;<span class="op" id="8265180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265184">t</span><span class="op" id="8265185">.</span><span class="ident" id="8265186">Fatal</span><span class="op" id="8265191">(</span><span class="ident" id="8265192">err</span><span class="op" id="8265195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265201">proxyHandler</span>&nbsp;<span class="op" id="8265214">:=</span>&nbsp;<span class="ident" id="8265217">NewSingleHostReverseProxy</span><span class="op" id="8265242">(</span><span class="ident" id="8265243">backendURL</span><span class="op" id="8265253">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265256">frontend</span>&nbsp;<span class="op" id="8265265">:=</span>&nbsp;<span class="ident" id="8265268">httptest</span><span class="op" id="8265276">.</span><span class="ident" id="8265277">NewServer</span><span class="op" id="8265286">(</span><span class="ident" id="8265287">proxyHandler</span><span class="op" id="8265299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265302">defer</span>&nbsp;<span class="ident" id="8265308">frontend</span><span class="op" id="8265316">.</span><span class="ident" id="8265317">Close</span><span class="op" id="8265322">(</span><span class="op" id="8265323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265327">getReq</span><span class="op" id="8265333">,</span>&nbsp;<span class="ident" id="8265335">_</span>&nbsp;<span class="op" id="8265337">:=</span>&nbsp;<span class="ident" id="8265340">http</span><span class="op" id="8265344">.</span><span class="ident" id="8265345">NewRequest</span><span class="op" id="8265355">(</span><span class="string" id="8265356">&#34;GET&#34;</span><span class="op" id="8265361">,</span>&nbsp;<span class="ident" id="8265363">frontend</span><span class="op" id="8265371">.</span><span class="ident" id="8265372">URL</span><span class="op" id="8265375">,</span>&nbsp;<span class="ident" id="8265377">nil</span><span class="op" id="8265380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265383">getReq</span><span class="op" id="8265389">.</span><span class="ident" id="8265390">Host</span>&nbsp;<span class="op" id="8265395">=</span>&nbsp;<span class="string" id="8265397">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265410">getReq</span><span class="op" id="8265416">.</span><span class="ident" id="8265417">Header</span><span class="op" id="8265423">.</span><span class="ident" id="8265424">Set</span><span class="op" id="8265427">(</span><span class="string" id="8265428">&#34;Connection&#34;</span><span class="op" id="8265440">,</span>&nbsp;<span class="string" id="8265442">&#34;close&#34;</span><span class="op" id="8265449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265452">getReq</span><span class="op" id="8265458">.</span><span class="ident" id="8265459">Header</span><span class="op" id="8265465">.</span><span class="ident" id="8265466">Set</span><span class="op" id="8265469">(</span><span class="string" id="8265470">&#34;X-Forwarded-For&#34;</span><span class="op" id="8265487">,</span>&nbsp;<span class="ident" id="8265489">prevForwardedFor</span><span class="op" id="8265505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265508">getReq</span><span class="op" id="8265514">.</span><span class="ident" id="8265515">Close</span>&nbsp;<span class="op" id="8265521">=</span>&nbsp;<span class="builtintype" id="8265523">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265529">res</span><span class="op" id="8265532">,</span>&nbsp;<span class="ident" id="8265534">err</span>&nbsp;<span class="op" id="8265538">:=</span>&nbsp;<span class="ident" id="8265541">http</span><span class="op" id="8265545">.</span><span class="ident" id="8265546">DefaultClient</span><span class="op" id="8265559">.</span><span class="ident" id="8265560">Do</span><span class="op" id="8265562">(</span><span class="ident" id="8265563">getReq</span><span class="op" id="8265569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265572">if</span>&nbsp;<span class="ident" id="8265575">err</span>&nbsp;<span class="op" id="8265579">!=</span>&nbsp;<span class="ident" id="8265582">nil</span>&nbsp;<span class="op" id="8265586">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265590">t</span><span class="op" id="8265591">.</span><span class="ident" id="8265592">Fatalf</span><span class="op" id="8265598">(</span><span class="string" id="8265599">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8265608">,</span>&nbsp;<span class="ident" id="8265610">err</span><span class="op" id="8265613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265619">if</span>&nbsp;<span class="ident" id="8265622">g</span><span class="op" id="8265623">,</span>&nbsp;<span class="ident" id="8265625">e</span>&nbsp;<span class="op" id="8265627">:=</span>&nbsp;<span class="ident" id="8265630">res</span><span class="op" id="8265633">.</span><span class="ident" id="8265634">StatusCode</span><span class="op" id="8265644">,</span>&nbsp;<span class="ident" id="8265646">backendStatus</span><span class="op" id="8265659">;</span>&nbsp;<span class="ident" id="8265661">g</span>&nbsp;<span class="op" id="8265663">!=</span>&nbsp;<span class="ident" id="8265666">e</span>&nbsp;<span class="op" id="8265668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265672">t</span><span class="op" id="8265673">.</span><span class="ident" id="8265674">Errorf</span><span class="op" id="8265680">(</span><span class="string" id="8265681">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8265717">,</span>&nbsp;<span class="ident" id="8265719">g</span><span class="op" id="8265720">,</span>&nbsp;<span class="ident" id="8265722">e</span><span class="op" id="8265723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265726">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265729">bodyBytes</span><span class="op" id="8265738">,</span>&nbsp;<span class="ident" id="8265740">_</span>&nbsp;<span class="op" id="8265742">:=</span>&nbsp;<span class="ident" id="8265745">ioutil</span><span class="op" id="8265751">.</span><span class="ident" id="8265752">ReadAll</span><span class="op" id="8265759">(</span><span class="ident" id="8265760">res</span><span class="op" id="8265763">.</span><span class="ident" id="8265764">Body</span><span class="op" id="8265768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265771">if</span>&nbsp;<span class="ident" id="8265774">g</span><span class="op" id="8265775">,</span>&nbsp;<span class="ident" id="8265777">e</span>&nbsp;<span class="op" id="8265779">:=</span>&nbsp;<span class="builtintype" id="8265782">string</span><span class="op" id="8265788">(</span><span class="ident" id="8265789">bodyBytes</span><span class="op" id="8265798">)</span><span class="op" id="8265799">,</span>&nbsp;<span class="ident" id="8265801">backendResponse</span><span class="op" id="8265816">;</span>&nbsp;<span class="ident" id="8265818">g</span>&nbsp;<span class="op" id="8265820">!=</span>&nbsp;<span class="ident" id="8265823">e</span>&nbsp;<span class="op" id="8265825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265829">t</span><span class="op" id="8265830">.</span><span class="ident" id="8265831">Errorf</span><span class="op" id="8265837">(</span><span class="string" id="8265838">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8265864">,</span>&nbsp;<span class="ident" id="8265866">g</span><span class="op" id="8265867">,</span>&nbsp;<span class="ident" id="8265869">e</span><span class="op" id="8265870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265873">}</span><br>
<span class="lineno"></span><span class="op" id="8265875">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="8265878">var</span>&nbsp;<span class="ident" id="8265882">proxyQueryTests</span>&nbsp;<span class="op" id="8265898">=</span>&nbsp;<span class="op" id="8265900">[</span><span class="op" id="8265901">]</span><span class="keyword" id="8265902">struct</span>&nbsp;<span class="op" id="8265909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265912">baseSuffix</span>&nbsp;<span class="builtintype" id="8265923">string</span>&nbsp;<span class="comment" id="8265930">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265963">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="8265974">string</span>&nbsp;<span class="comment" id="8265981">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266025">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8266036">string</span>&nbsp;<span class="comment" id="8266043">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="8266104">}</span><span class="op" id="8266105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266108">{</span><span class="string" id="8266109">&#34;&#34;</span><span class="op" id="8266111">,</span>&nbsp;<span class="string" id="8266113">&#34;&#34;</span><span class="op" id="8266115">,</span>&nbsp;<span class="string" id="8266117">&#34;&#34;</span><span class="op" id="8266119">}</span><span class="op" id="8266120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266123">{</span><span class="string" id="8266124">&#34;?sta=tic&#34;</span><span class="op" id="8266134">,</span>&nbsp;<span class="string" id="8266136">&#34;?us=er&#34;</span><span class="op" id="8266144">,</span>&nbsp;<span class="string" id="8266146">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="8266161">}</span><span class="op" id="8266162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266165">{</span><span class="string" id="8266166">&#34;&#34;</span><span class="op" id="8266168">,</span>&nbsp;<span class="string" id="8266170">&#34;?us=er&#34;</span><span class="op" id="8266178">,</span>&nbsp;<span class="string" id="8266180">&#34;us=er&#34;</span><span class="op" id="8266187">}</span><span class="op" id="8266188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266191">{</span><span class="string" id="8266192">&#34;?sta=tic&#34;</span><span class="op" id="8266202">,</span>&nbsp;<span class="string" id="8266204">&#34;&#34;</span><span class="op" id="8266206">,</span>&nbsp;<span class="string" id="8266208">&#34;sta=tic&#34;</span><span class="op" id="8266217">}</span><span class="op" id="8266218">,</span><br>
<span class="lineno">145</span><span class="op" id="8266220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8266223">func</span>&nbsp;<span class="ident" id="8266228">TestReverseProxyQuery</span><span class="op" id="8266249">(</span><span class="ident" id="8266250">t</span>&nbsp;<span class="op" id="8266252">*</span><span class="ident" id="8266253">testing</span><span class="op" id="8266260">.</span><span class="ident" id="8266261">T</span><span class="op" id="8266262">)</span>&nbsp;<span class="op" id="8266264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266267">backend</span>&nbsp;<span class="op" id="8266275">:=</span>&nbsp;<span class="ident" id="8266278">httptest</span><span class="op" id="8266286">.</span><span class="ident" id="8266287">NewServer</span><span class="op" id="8266296">(</span><span class="ident" id="8266297">http</span><span class="op" id="8266301">.</span><span class="ident" id="8266302">HandlerFunc</span><span class="op" id="8266313">(</span><span class="keyword" id="8266314">func</span><span class="op" id="8266318">(</span><span class="ident" id="8266319">w</span>&nbsp;<span class="ident" id="8266321">http</span><span class="op" id="8266325">.</span><span class="ident" id="8266326">ResponseWriter</span><span class="op" id="8266340">,</span>&nbsp;<span class="ident" id="8266342">r</span>&nbsp;<span class="op" id="8266344">*</span><span class="ident" id="8266345">http</span><span class="op" id="8266349">.</span><span class="ident" id="8266350">Request</span><span class="op" id="8266357">)</span>&nbsp;<span class="op" id="8266359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266363">w</span><span class="op" id="8266364">.</span><span class="ident" id="8266365">Header</span><span class="op" id="8266371">(</span><span class="op" id="8266372">)</span><span class="op" id="8266373">.</span><span class="ident" id="8266374">Set</span><span class="op" id="8266377">(</span><span class="string" id="8266378">&#34;X-Got-Query&#34;</span><span class="op" id="8266391">,</span>&nbsp;<span class="ident" id="8266393">r</span><span class="op" id="8266394">.</span><span class="ident" id="8266395">URL</span><span class="op" id="8266398">.</span><span class="ident" id="8266399">RawQuery</span><span class="op" id="8266407">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266411">w</span><span class="op" id="8266412">.</span><span class="ident" id="8266413">Write</span><span class="op" id="8266418">(</span><span class="op" id="8266419">[</span><span class="op" id="8266420">]</span><span class="builtintype" id="8266421">byte</span><span class="op" id="8266425">(</span><span class="string" id="8266426">&#34;hi&#34;</span><span class="op" id="8266430">)</span><span class="op" id="8266431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266434">}</span><span class="op" id="8266435">)</span><span class="op" id="8266436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266439">defer</span>&nbsp;<span class="ident" id="8266445">backend</span><span class="op" id="8266452">.</span><span class="ident" id="8266453">Close</span><span class="op" id="8266458">(</span><span class="op" id="8266459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266463">for</span>&nbsp;<span class="ident" id="8266467">i</span><span class="op" id="8266468">,</span>&nbsp;<span class="ident" id="8266470">tt</span>&nbsp;<span class="op" id="8266473">:=</span>&nbsp;<span class="keyword" id="8266476">range</span>&nbsp;<span class="ident" id="8266482">proxyQueryTests</span>&nbsp;<span class="op" id="8266498">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266502">backendURL</span><span class="op" id="8266512">,</span>&nbsp;<span class="ident" id="8266514">err</span>&nbsp;<span class="op" id="8266518">:=</span>&nbsp;<span class="ident" id="8266521">url</span><span class="op" id="8266524">.</span><span class="ident" id="8266525">Parse</span><span class="op" id="8266530">(</span><span class="ident" id="8266531">backend</span><span class="op" id="8266538">.</span><span class="ident" id="8266539">URL</span>&nbsp;<span class="op" id="8266543">+</span>&nbsp;<span class="ident" id="8266545">tt</span><span class="op" id="8266547">.</span><span class="ident" id="8266548">baseSuffix</span><span class="op" id="8266558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266562">if</span>&nbsp;<span class="ident" id="8266565">err</span>&nbsp;<span class="op" id="8266569">!=</span>&nbsp;<span class="ident" id="8266572">nil</span>&nbsp;<span class="op" id="8266576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266581">t</span><span class="op" id="8266582">.</span><span class="ident" id="8266583">Fatal</span><span class="op" id="8266588">(</span><span class="ident" id="8266589">err</span><span class="op" id="8266592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266600">frontend</span>&nbsp;<span class="op" id="8266609">:=</span>&nbsp;<span class="ident" id="8266612">httptest</span><span class="op" id="8266620">.</span><span class="ident" id="8266621">NewServer</span><span class="op" id="8266630">(</span><span class="ident" id="8266631">NewSingleHostReverseProxy</span><span class="op" id="8266656">(</span><span class="ident" id="8266657">backendURL</span><span class="op" id="8266667">)</span><span class="op" id="8266668">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266672">req</span><span class="op" id="8266675">,</span>&nbsp;<span class="ident" id="8266677">_</span>&nbsp;<span class="op" id="8266679">:=</span>&nbsp;<span class="ident" id="8266682">http</span><span class="op" id="8266686">.</span><span class="ident" id="8266687">NewRequest</span><span class="op" id="8266697">(</span><span class="string" id="8266698">&#34;GET&#34;</span><span class="op" id="8266703">,</span>&nbsp;<span class="ident" id="8266705">frontend</span><span class="op" id="8266713">.</span><span class="ident" id="8266714">URL</span><span class="op" id="8266717">+</span><span class="ident" id="8266718">tt</span><span class="op" id="8266720">.</span><span class="ident" id="8266721">reqSuffix</span><span class="op" id="8266730">,</span>&nbsp;<span class="ident" id="8266732">nil</span><span class="op" id="8266735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266739">req</span><span class="op" id="8266742">.</span><span class="ident" id="8266743">Close</span>&nbsp;<span class="op" id="8266749">=</span>&nbsp;<span class="builtintype" id="8266751">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266758">res</span><span class="op" id="8266761">,</span>&nbsp;<span class="ident" id="8266763">err</span>&nbsp;<span class="op" id="8266767">:=</span>&nbsp;<span class="ident" id="8266770">http</span><span class="op" id="8266774">.</span><span class="ident" id="8266775">DefaultClient</span><span class="op" id="8266788">.</span><span class="ident" id="8266789">Do</span><span class="op" id="8266791">(</span><span class="ident" id="8266792">req</span><span class="op" id="8266795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266799">if</span>&nbsp;<span class="ident" id="8266802">err</span>&nbsp;<span class="op" id="8266806">!=</span>&nbsp;<span class="ident" id="8266809">nil</span>&nbsp;<span class="op" id="8266813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266818">t</span><span class="op" id="8266819">.</span><span class="ident" id="8266820">Fatalf</span><span class="op" id="8266826">(</span><span class="string" id="8266827">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="8266840">,</span>&nbsp;<span class="ident" id="8266842">i</span><span class="op" id="8266843">,</span>&nbsp;<span class="ident" id="8266845">err</span><span class="op" id="8266848">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266856">if</span>&nbsp;<span class="ident" id="8266859">g</span><span class="op" id="8266860">,</span>&nbsp;<span class="ident" id="8266862">e</span>&nbsp;<span class="op" id="8266864">:=</span>&nbsp;<span class="ident" id="8266867">res</span><span class="op" id="8266870">.</span><span class="ident" id="8266871">Header</span><span class="op" id="8266877">.</span><span class="ident" id="8266878">Get</span><span class="op" id="8266881">(</span><span class="string" id="8266882">&#34;X-Got-Query&#34;</span><span class="op" id="8266895">)</span><span class="op" id="8266896">,</span>&nbsp;<span class="ident" id="8266898">tt</span><span class="op" id="8266900">.</span><span class="ident" id="8266901">want</span><span class="op" id="8266905">;</span>&nbsp;<span class="ident" id="8266907">g</span>&nbsp;<span class="op" id="8266909">!=</span>&nbsp;<span class="ident" id="8266912">e</span>&nbsp;<span class="op" id="8266914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266919">t</span><span class="op" id="8266920">.</span><span class="ident" id="8266921">Errorf</span><span class="op" id="8266927">(</span><span class="string" id="8266928">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8266959">,</span>&nbsp;<span class="ident" id="8266961">i</span><span class="op" id="8266962">,</span>&nbsp;<span class="ident" id="8266964">g</span><span class="op" id="8266965">,</span>&nbsp;<span class="ident" id="8266967">e</span><span class="op" id="8266968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266976">res</span><span class="op" id="8266979">.</span><span class="ident" id="8266980">Body</span><span class="op" id="8266984">.</span><span class="ident" id="8266985">Close</span><span class="op" id="8266990">(</span><span class="op" id="8266991">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266995">frontend</span><span class="op" id="8267003">.</span><span class="ident" id="8267004">Close</span><span class="op" id="8267009">(</span><span class="op" id="8267010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267013">}</span><br>
<span class="lineno"></span><span class="op" id="8267015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8267018">func</span>&nbsp;<span class="ident" id="8267023">TestReverseProxyFlushInterval</span><span class="op" id="8267052">(</span><span class="ident" id="8267053">t</span>&nbsp;<span class="op" id="8267055">*</span><span class="ident" id="8267056">testing</span><span class="op" id="8267063">.</span><span class="ident" id="8267064">T</span><span class="op" id="8267065">)</span>&nbsp;<span class="op" id="8267067">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267070">const</span>&nbsp;<span class="ident" id="8267076">expected</span>&nbsp;<span class="op" id="8267085">=</span>&nbsp;<span class="string" id="8267087">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267093">backend</span>&nbsp;<span class="op" id="8267101">:=</span>&nbsp;<span class="ident" id="8267104">httptest</span><span class="op" id="8267112">.</span><span class="ident" id="8267113">NewServer</span><span class="op" id="8267122">(</span><span class="ident" id="8267123">http</span><span class="op" id="8267127">.</span><span class="ident" id="8267128">HandlerFunc</span><span class="op" id="8267139">(</span><span class="keyword" id="8267140">func</span><span class="op" id="8267144">(</span><span class="ident" id="8267145">w</span>&nbsp;<span class="ident" id="8267147">http</span><span class="op" id="8267151">.</span><span class="ident" id="8267152">ResponseWriter</span><span class="op" id="8267166">,</span>&nbsp;<span class="ident" id="8267168">r</span>&nbsp;<span class="op" id="8267170">*</span><span class="ident" id="8267171">http</span><span class="op" id="8267175">.</span><span class="ident" id="8267176">Request</span><span class="op" id="8267183">)</span>&nbsp;<span class="op" id="8267185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267189">w</span><span class="op" id="8267190">.</span><span class="ident" id="8267191">Write</span><span class="op" id="8267196">(</span><span class="op" id="8267197">[</span><span class="op" id="8267198">]</span><span class="builtintype" id="8267199">byte</span><span class="op" id="8267203">(</span><span class="ident" id="8267204">expected</span><span class="op" id="8267212">)</span><span class="op" id="8267213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267216">}</span><span class="op" id="8267217">)</span><span class="op" id="8267218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267221">defer</span>&nbsp;<span class="ident" id="8267227">backend</span><span class="op" id="8267234">.</span><span class="ident" id="8267235">Close</span><span class="op" id="8267240">(</span><span class="op" id="8267241">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267245">backendURL</span><span class="op" id="8267255">,</span>&nbsp;<span class="ident" id="8267257">err</span>&nbsp;<span class="op" id="8267261">:=</span>&nbsp;<span class="ident" id="8267264">url</span><span class="op" id="8267267">.</span><span class="ident" id="8267268">Parse</span><span class="op" id="8267273">(</span><span class="ident" id="8267274">backend</span><span class="op" id="8267281">.</span><span class="ident" id="8267282">URL</span><span class="op" id="8267285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267288">if</span>&nbsp;<span class="ident" id="8267291">err</span>&nbsp;<span class="op" id="8267295">!=</span>&nbsp;<span class="ident" id="8267298">nil</span>&nbsp;<span class="op" id="8267302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267306">t</span><span class="op" id="8267307">.</span><span class="ident" id="8267308">Fatal</span><span class="op" id="8267313">(</span><span class="ident" id="8267314">err</span><span class="op" id="8267317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267320">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267324">proxyHandler</span>&nbsp;<span class="op" id="8267337">:=</span>&nbsp;<span class="ident" id="8267340">NewSingleHostReverseProxy</span><span class="op" id="8267365">(</span><span class="ident" id="8267366">backendURL</span><span class="op" id="8267376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267379">proxyHandler</span><span class="op" id="8267391">.</span><span class="ident" id="8267392">FlushInterval</span>&nbsp;<span class="op" id="8267406">=</span>&nbsp;<span class="ident" id="8267408">time</span><span class="op" id="8267412">.</span><span class="ident" id="8267413">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267427">done</span>&nbsp;<span class="op" id="8267432">:=</span>&nbsp;<span class="builtinfunc" id="8267435">make</span><span class="op" id="8267439">(</span><span class="keyword" id="8267440">chan</span>&nbsp;<span class="builtintype" id="8267445">bool</span><span class="op" id="8267449">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267452">onExitFlushLoop</span>&nbsp;<span class="op" id="8267468">=</span>&nbsp;<span class="keyword" id="8267470">func</span><span class="op" id="8267474">(</span><span class="op" id="8267475">)</span>&nbsp;<span class="op" id="8267477">{</span>&nbsp;<span class="ident" id="8267479">done</span>&nbsp;<span class="op" id="8267484">&lt;-</span>&nbsp;<span class="builtintype" id="8267487">true</span>&nbsp;<span class="op" id="8267492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267495">defer</span>&nbsp;<span class="keyword" id="8267501">func</span><span class="op" id="8267505">(</span><span class="op" id="8267506">)</span>&nbsp;<span class="op" id="8267508">{</span>&nbsp;<span class="ident" id="8267510">onExitFlushLoop</span>&nbsp;<span class="op" id="8267526">=</span>&nbsp;<span class="ident" id="8267528">nil</span>&nbsp;<span class="op" id="8267532">}</span><span class="op" id="8267533">(</span><span class="op" id="8267534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267538">frontend</span>&nbsp;<span class="op" id="8267547">:=</span>&nbsp;<span class="ident" id="8267550">httptest</span><span class="op" id="8267558">.</span><span class="ident" id="8267559">NewServer</span><span class="op" id="8267568">(</span><span class="ident" id="8267569">proxyHandler</span><span class="op" id="8267581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267584">defer</span>&nbsp;<span class="ident" id="8267590">frontend</span><span class="op" id="8267598">.</span><span class="ident" id="8267599">Close</span><span class="op" id="8267604">(</span><span class="op" id="8267605">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267609">req</span><span class="op" id="8267612">,</span>&nbsp;<span class="ident" id="8267614">_</span>&nbsp;<span class="op" id="8267616">:=</span>&nbsp;<span class="ident" id="8267619">http</span><span class="op" id="8267623">.</span><span class="ident" id="8267624">NewRequest</span><span class="op" id="8267634">(</span><span class="string" id="8267635">&#34;GET&#34;</span><span class="op" id="8267640">,</span>&nbsp;<span class="ident" id="8267642">frontend</span><span class="op" id="8267650">.</span><span class="ident" id="8267651">URL</span><span class="op" id="8267654">,</span>&nbsp;<span class="ident" id="8267656">nil</span><span class="op" id="8267659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267662">req</span><span class="op" id="8267665">.</span><span class="ident" id="8267666">Close</span>&nbsp;<span class="op" id="8267672">=</span>&nbsp;<span class="builtintype" id="8267674">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267680">res</span><span class="op" id="8267683">,</span>&nbsp;<span class="ident" id="8267685">err</span>&nbsp;<span class="op" id="8267689">:=</span>&nbsp;<span class="ident" id="8267692">http</span><span class="op" id="8267696">.</span><span class="ident" id="8267697">DefaultClient</span><span class="op" id="8267710">.</span><span class="ident" id="8267711">Do</span><span class="op" id="8267713">(</span><span class="ident" id="8267714">req</span><span class="op" id="8267717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267720">if</span>&nbsp;<span class="ident" id="8267723">err</span>&nbsp;<span class="op" id="8267727">!=</span>&nbsp;<span class="ident" id="8267730">nil</span>&nbsp;<span class="op" id="8267734">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267738">t</span><span class="op" id="8267739">.</span><span class="ident" id="8267740">Fatalf</span><span class="op" id="8267746">(</span><span class="string" id="8267747">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8267756">,</span>&nbsp;<span class="ident" id="8267758">err</span><span class="op" id="8267761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267767">defer</span>&nbsp;<span class="ident" id="8267773">res</span><span class="op" id="8267776">.</span><span class="ident" id="8267777">Body</span><span class="op" id="8267781">.</span><span class="ident" id="8267782">Close</span><span class="op" id="8267787">(</span><span class="op" id="8267788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267791">if</span>&nbsp;<span class="ident" id="8267794">bodyBytes</span><span class="op" id="8267803">,</span>&nbsp;<span class="ident" id="8267805">_</span>&nbsp;<span class="op" id="8267807">:=</span>&nbsp;<span class="ident" id="8267810">ioutil</span><span class="op" id="8267816">.</span><span class="ident" id="8267817">ReadAll</span><span class="op" id="8267824">(</span><span class="ident" id="8267825">res</span><span class="op" id="8267828">.</span><span class="ident" id="8267829">Body</span><span class="op" id="8267833">)</span><span class="op" id="8267834">;</span>&nbsp;<span class="builtintype" id="8267836">string</span><span class="op" id="8267842">(</span><span class="ident" id="8267843">bodyBytes</span><span class="op" id="8267852">)</span>&nbsp;<span class="op" id="8267854">!=</span>&nbsp;<span class="ident" id="8267857">expected</span>&nbsp;<span class="op" id="8267866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267870">t</span><span class="op" id="8267871">.</span><span class="ident" id="8267872">Errorf</span><span class="op" id="8267878">(</span><span class="string" id="8267879">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8267905">,</span>&nbsp;<span class="ident" id="8267907">bodyBytes</span><span class="op" id="8267916">,</span>&nbsp;<span class="ident" id="8267918">expected</span><span class="op" id="8267926">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267933">select</span>&nbsp;<span class="op" id="8267940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267943">case</span>&nbsp;<span class="op" id="8267948">&lt;-</span><span class="ident" id="8267950">done</span><span class="op" id="8267954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267958">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267965">case</span>&nbsp;<span class="op" id="8267970">&lt;-</span><span class="ident" id="8267972">time</span><span class="op" id="8267976">.</span><span class="ident" id="8267977">After</span><span class="op" id="8267982">(</span><span class="num" id="8267983">5</span>&nbsp;<span class="op" id="8267985">*</span>&nbsp;<span class="ident" id="8267987">time</span><span class="op" id="8267991">.</span><span class="ident" id="8267992">Second</span><span class="op" id="8267998">)</span><span class="op" id="8267999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8268003">t</span><span class="op" id="8268004">.</span><span class="ident" id="8268005">Error</span><span class="op" id="8268010">(</span><span class="string" id="8268011">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="8268054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8268057">}</span><br>
<span class="lineno"></span><span class="op" id="8268059">}</span>
</div>
</body>
</html>
