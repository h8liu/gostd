<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1575832">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1575887">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1575941">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1575992">package</span>&nbsp;<span class="ident" id="1576000">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576009">import</span>&nbsp;<span class="op" id="1576016">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1576019">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1576028">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1576031">const</span>&nbsp;<span class="op" id="1576037">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576040">debugMalloc</span>&nbsp;<span class="op" id="1576052">=</span>&nbsp;<span class="ident" id="1576054">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576062">flagNoScan</span>&nbsp;<span class="op" id="1576073">=</span>&nbsp;<span class="ident" id="1576075">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576088">flagNoZero</span>&nbsp;<span class="op" id="1576099">=</span>&nbsp;<span class="ident" id="1576101">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576115">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1576129">=</span>&nbsp;<span class="ident" id="1576131">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576142">tinySizeClass</span>&nbsp;<span class="op" id="1576156">=</span>&nbsp;<span class="ident" id="1576158">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576174">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1576188">=</span>&nbsp;<span class="ident" id="1576190">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576206">pageShift</span>&nbsp;<span class="op" id="1576216">=</span>&nbsp;<span class="ident" id="1576218">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576230">pageSize</span>&nbsp;&nbsp;<span class="op" id="1576240">=</span>&nbsp;<span class="ident" id="1576242">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576253">pageMask</span>&nbsp;&nbsp;<span class="op" id="1576263">=</span>&nbsp;<span class="ident" id="1576265">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576277">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1576293">=</span>&nbsp;<span class="ident" id="1576295">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576312">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576328">=</span>&nbsp;<span class="ident" id="1576330">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576341">pointersPerByte</span>&nbsp;<span class="op" id="1576357">=</span>&nbsp;<span class="ident" id="1576359">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576377">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576393">=</span>&nbsp;<span class="ident" id="1576395">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576407">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576423">=</span>&nbsp;<span class="ident" id="1576425">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576436">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576452">=</span>&nbsp;<span class="ident" id="1576454">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576469">mSpanInUse</span>&nbsp;<span class="op" id="1576480">=</span>&nbsp;<span class="ident" id="1576482">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576496">concurrentSweep</span>&nbsp;<span class="op" id="1576512">=</span>&nbsp;<span class="ident" id="1576514">_ConcurrentSweep</span>&nbsp;<span class="op" id="1576531">!=</span>&nbsp;<span class="num" id="1576534">0</span><br>
<span class="lineno">35</span><span class="op" id="1576536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576539">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1576575">type</span>&nbsp;<span class="ident" id="1576580">pageID</span>&nbsp;<span class="builtintype" id="1576587">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1576596">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1576639">var</span>&nbsp;<span class="ident" id="1576643">zerobase</span>&nbsp;<span class="builtintype" id="1576652">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576661">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1576698">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1576764">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1576829">func</span>&nbsp;<span class="ident" id="1576834">mallocgc</span><span class="op" id="1576842">(</span><span class="ident" id="1576843">size</span>&nbsp;<span class="builtintype" id="1576848">uintptr</span><span class="op" id="1576855">,</span>&nbsp;<span class="ident" id="1576857">typ</span>&nbsp;<span class="op" id="1576861">*</span><span class="ident" id="1576862">_type</span><span class="op" id="1576867">,</span>&nbsp;<span class="ident" id="1576869">flags</span>&nbsp;<span class="builtintype" id="1576875">uint32</span><span class="op" id="1576881">)</span>&nbsp;<span class="ident" id="1576883">unsafe</span><span class="op" id="1576889">.</span><span class="ident" id="1576890">Pointer</span>&nbsp;<span class="op" id="1576898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576901">if</span>&nbsp;<span class="ident" id="1576904">size</span>&nbsp;<span class="op" id="1576909">==</span>&nbsp;<span class="num" id="1576912">0</span>&nbsp;<span class="op" id="1576914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576918">return</span>&nbsp;<span class="ident" id="1576925">unsafe</span><span class="op" id="1576931">.</span><span class="ident" id="1576932">Pointer</span><span class="op" id="1576939">(</span><span class="op" id="1576940">&amp;</span><span class="ident" id="1576941">zerobase</span><span class="op" id="1576949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576952">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576955">size0</span>&nbsp;<span class="op" id="1576961">:=</span>&nbsp;<span class="ident" id="1576964">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576971">if</span>&nbsp;<span class="ident" id="1576974">flags</span><span class="op" id="1576979">&amp;</span><span class="ident" id="1576980">flagNoScan</span>&nbsp;<span class="op" id="1576991">==</span>&nbsp;<span class="num" id="1576994">0</span>&nbsp;<span class="op" id="1576996">&amp;&amp;</span>&nbsp;<span class="ident" id="1576999">typ</span>&nbsp;<span class="op" id="1577003">==</span>&nbsp;<span class="ident" id="1577006">nil</span>&nbsp;<span class="op" id="1577010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577014">gothrow</span><span class="op" id="1577021">(</span><span class="string" id="1577022">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1577043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577046">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577050">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577119">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577193">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577249">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577325">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577389">if</span>&nbsp;<span class="ident" id="1577392">debugMalloc</span>&nbsp;<span class="op" id="1577404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577408">mp</span>&nbsp;<span class="op" id="1577411">:=</span>&nbsp;<span class="ident" id="1577414">acquirem</span><span class="op" id="1577422">(</span><span class="op" id="1577423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577427">if</span>&nbsp;<span class="ident" id="1577430">mp</span><span class="op" id="1577432">.</span><span class="ident" id="1577433">mallocing</span>&nbsp;<span class="op" id="1577443">!=</span>&nbsp;<span class="num" id="1577446">0</span>&nbsp;<span class="op" id="1577448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577453">gothrow</span><span class="op" id="1577460">(</span><span class="string" id="1577461">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1577478">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577486">mp</span><span class="op" id="1577488">.</span><span class="ident" id="1577489">mallocing</span>&nbsp;<span class="op" id="1577499">=</span>&nbsp;<span class="num" id="1577501">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577505">if</span>&nbsp;<span class="ident" id="1577508">mp</span><span class="op" id="1577510">.</span><span class="ident" id="1577511">curg</span>&nbsp;<span class="op" id="1577516">!=</span>&nbsp;<span class="ident" id="1577519">nil</span>&nbsp;<span class="op" id="1577523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577528">mp</span><span class="op" id="1577530">.</span><span class="ident" id="1577531">curg</span><span class="op" id="1577535">.</span><span class="ident" id="1577536">stackguard0</span>&nbsp;<span class="op" id="1577548">=</span>&nbsp;<span class="op" id="1577550">^</span><span class="builtintype" id="1577551">uintptr</span><span class="op" id="1577558">(</span><span class="num" id="1577559">0xfff</span><span class="op" id="1577564">)</span>&nbsp;<span class="op" id="1577566">|</span>&nbsp;<span class="num" id="1577568">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577576">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577583">c</span>&nbsp;<span class="op" id="1577585">:=</span>&nbsp;<span class="ident" id="1577588">gomcache</span><span class="op" id="1577596">(</span><span class="op" id="1577597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577600">var</span>&nbsp;<span class="ident" id="1577604">s</span>&nbsp;<span class="op" id="1577606">*</span><span class="ident" id="1577607">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577614">var</span>&nbsp;<span class="ident" id="1577618">x</span>&nbsp;<span class="ident" id="1577620">unsafe</span><span class="op" id="1577626">.</span><span class="ident" id="1577627">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577636">if</span>&nbsp;<span class="ident" id="1577639">size</span>&nbsp;<span class="op" id="1577644">&lt;=</span>&nbsp;<span class="ident" id="1577647">maxSmallSize</span>&nbsp;<span class="op" id="1577660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577664">if</span>&nbsp;<span class="ident" id="1577667">flags</span><span class="op" id="1577672">&amp;</span><span class="ident" id="1577673">flagNoScan</span>&nbsp;<span class="op" id="1577684">!=</span>&nbsp;<span class="num" id="1577687">0</span>&nbsp;<span class="op" id="1577689">&amp;&amp;</span>&nbsp;<span class="ident" id="1577692">size</span>&nbsp;<span class="op" id="1577697">&lt;</span>&nbsp;<span class="ident" id="1577699">maxTinySize</span>&nbsp;<span class="op" id="1577711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577716">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577738">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577744">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577807">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577868">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577935">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578001">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578059">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578065">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578141">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578214">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578275">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578342">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578377">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578435">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578480">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578540">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578546">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578619">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578684">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578715">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578721">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578790">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578858">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578901">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578907">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578970">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579027">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579089">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579122">tinysize</span>&nbsp;<span class="op" id="1579131">:=</span>&nbsp;<span class="builtintype" id="1579134">uintptr</span><span class="op" id="1579141">(</span><span class="ident" id="1579142">c</span><span class="op" id="1579143">.</span><span class="ident" id="1579144">tinysize</span><span class="op" id="1579152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579157">if</span>&nbsp;<span class="ident" id="1579160">size</span>&nbsp;<span class="op" id="1579165">&lt;=</span>&nbsp;<span class="ident" id="1579168">tinysize</span>&nbsp;<span class="op" id="1579177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579183">tiny</span>&nbsp;<span class="op" id="1579188">:=</span>&nbsp;<span class="ident" id="1579191">unsafe</span><span class="op" id="1579197">.</span><span class="ident" id="1579198">Pointer</span><span class="op" id="1579205">(</span><span class="ident" id="1579206">c</span><span class="op" id="1579207">.</span><span class="ident" id="1579208">tiny</span><span class="op" id="1579212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579218">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579283">if</span>&nbsp;<span class="ident" id="1579286">size</span><span class="op" id="1579290">&amp;</span><span class="num" id="1579291">7</span>&nbsp;<span class="op" id="1579293">==</span>&nbsp;<span class="num" id="1579296">0</span>&nbsp;<span class="op" id="1579298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579305">tiny</span>&nbsp;<span class="op" id="1579310">=</span>&nbsp;<span class="ident" id="1579312">roundup</span><span class="op" id="1579319">(</span><span class="ident" id="1579320">tiny</span><span class="op" id="1579324">,</span>&nbsp;<span class="num" id="1579326">8</span><span class="op" id="1579327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579333">}</span>&nbsp;<span class="keyword" id="1579335">else</span>&nbsp;<span class="keyword" id="1579340">if</span>&nbsp;<span class="ident" id="1579343">size</span><span class="op" id="1579347">&amp;</span><span class="num" id="1579348">3</span>&nbsp;<span class="op" id="1579350">==</span>&nbsp;<span class="num" id="1579353">0</span>&nbsp;<span class="op" id="1579355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579362">tiny</span>&nbsp;<span class="op" id="1579367">=</span>&nbsp;<span class="ident" id="1579369">roundup</span><span class="op" id="1579376">(</span><span class="ident" id="1579377">tiny</span><span class="op" id="1579381">,</span>&nbsp;<span class="num" id="1579383">4</span><span class="op" id="1579384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579390">}</span>&nbsp;<span class="keyword" id="1579392">else</span>&nbsp;<span class="keyword" id="1579397">if</span>&nbsp;<span class="ident" id="1579400">size</span><span class="op" id="1579404">&amp;</span><span class="num" id="1579405">1</span>&nbsp;<span class="op" id="1579407">==</span>&nbsp;<span class="num" id="1579410">0</span>&nbsp;<span class="op" id="1579412">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579419">tiny</span>&nbsp;<span class="op" id="1579424">=</span>&nbsp;<span class="ident" id="1579426">roundup</span><span class="op" id="1579433">(</span><span class="ident" id="1579434">tiny</span><span class="op" id="1579438">,</span>&nbsp;<span class="num" id="1579440">2</span><span class="op" id="1579441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579453">size1</span>&nbsp;<span class="op" id="1579459">:=</span>&nbsp;<span class="ident" id="1579462">size</span>&nbsp;<span class="op" id="1579467">+</span>&nbsp;<span class="op" id="1579469">(</span><span class="builtintype" id="1579470">uintptr</span><span class="op" id="1579477">(</span><span class="ident" id="1579478">tiny</span><span class="op" id="1579482">)</span>&nbsp;<span class="op" id="1579484">-</span>&nbsp;<span class="builtintype" id="1579486">uintptr</span><span class="op" id="1579493">(</span><span class="ident" id="1579494">unsafe</span><span class="op" id="1579500">.</span><span class="ident" id="1579501">Pointer</span><span class="op" id="1579508">(</span><span class="ident" id="1579509">c</span><span class="op" id="1579510">.</span><span class="ident" id="1579511">tiny</span><span class="op" id="1579515">)</span><span class="op" id="1579516">)</span><span class="op" id="1579517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579523">if</span>&nbsp;<span class="ident" id="1579526">size1</span>&nbsp;<span class="op" id="1579532">&lt;=</span>&nbsp;<span class="ident" id="1579535">tinysize</span>&nbsp;<span class="op" id="1579544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579551">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579601">x</span>&nbsp;<span class="op" id="1579603">=</span>&nbsp;<span class="ident" id="1579605">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579615">c</span><span class="op" id="1579616">.</span><span class="ident" id="1579617">tiny</span>&nbsp;<span class="op" id="1579622">=</span>&nbsp;<span class="op" id="1579624">(</span><span class="op" id="1579625">*</span><span class="builtintype" id="1579626">byte</span><span class="op" id="1579630">)</span><span class="op" id="1579631">(</span><span class="ident" id="1579632">add</span><span class="op" id="1579635">(</span><span class="ident" id="1579636">x</span><span class="op" id="1579637">,</span>&nbsp;<span class="ident" id="1579639">size</span><span class="op" id="1579643">)</span><span class="op" id="1579644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579651">c</span><span class="op" id="1579652">.</span><span class="ident" id="1579653">tinysize</span>&nbsp;<span class="op" id="1579662">-=</span>&nbsp;<span class="builtintype" id="1579665">uintptr</span><span class="op" id="1579672">(</span><span class="ident" id="1579673">size1</span><span class="op" id="1579678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579685">c</span><span class="op" id="1579686">.</span><span class="ident" id="1579687">local_tinyallocs</span><span class="op" id="1579703">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579711">if</span>&nbsp;<span class="ident" id="1579714">debugMalloc</span>&nbsp;<span class="op" id="1579726">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579734">mp</span>&nbsp;<span class="op" id="1579737">:=</span>&nbsp;<span class="ident" id="1579740">acquirem</span><span class="op" id="1579748">(</span><span class="op" id="1579749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579757">if</span>&nbsp;<span class="ident" id="1579760">mp</span><span class="op" id="1579762">.</span><span class="ident" id="1579763">mallocing</span>&nbsp;<span class="op" id="1579773">==</span>&nbsp;<span class="num" id="1579776">0</span>&nbsp;<span class="op" id="1579778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579787">gothrow</span><span class="op" id="1579794">(</span><span class="string" id="1579795">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1579807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579823">mp</span><span class="op" id="1579825">.</span><span class="ident" id="1579826">mallocing</span>&nbsp;<span class="op" id="1579836">=</span>&nbsp;<span class="num" id="1579838">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579846">if</span>&nbsp;<span class="ident" id="1579849">mp</span><span class="op" id="1579851">.</span><span class="ident" id="1579852">curg</span>&nbsp;<span class="op" id="1579857">!=</span>&nbsp;<span class="ident" id="1579860">nil</span>&nbsp;<span class="op" id="1579864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579873">mp</span><span class="op" id="1579875">.</span><span class="ident" id="1579876">curg</span><span class="op" id="1579880">.</span><span class="ident" id="1579881">stackguard0</span>&nbsp;<span class="op" id="1579893">=</span>&nbsp;<span class="ident" id="1579895">mp</span><span class="op" id="1579897">.</span><span class="ident" id="1579898">curg</span><span class="op" id="1579902">.</span><span class="ident" id="1579903">stack</span><span class="op" id="1579908">.</span><span class="ident" id="1579909">lo</span>&nbsp;<span class="op" id="1579912">+</span>&nbsp;<span class="ident" id="1579914">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579940">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579997">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580053">releasem</span><span class="op" id="1580061">(</span><span class="ident" id="1580062">mp</span><span class="op" id="1580064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580072">releasem</span><span class="op" id="1580080">(</span><span class="ident" id="1580081">mp</span><span class="op" id="1580083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580097">return</span>&nbsp;<span class="ident" id="1580104">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580110">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580120">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580160">s</span>&nbsp;<span class="op" id="1580162">=</span>&nbsp;<span class="ident" id="1580164">c</span><span class="op" id="1580165">.</span><span class="ident" id="1580166">alloc</span><span class="op" id="1580171">[</span><span class="ident" id="1580172">tinySizeClass</span><span class="op" id="1580185">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580190">v</span>&nbsp;<span class="op" id="1580192">:=</span>&nbsp;<span class="ident" id="1580195">s</span><span class="op" id="1580196">.</span><span class="ident" id="1580197">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580209">if</span>&nbsp;<span class="ident" id="1580212">v</span>&nbsp;<span class="op" id="1580214">==</span>&nbsp;<span class="ident" id="1580217">nil</span>&nbsp;<span class="op" id="1580221">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580227">mp</span>&nbsp;<span class="op" id="1580230">:=</span>&nbsp;<span class="ident" id="1580233">acquirem</span><span class="op" id="1580241">(</span><span class="op" id="1580242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580248">mp</span><span class="op" id="1580250">.</span><span class="ident" id="1580251">scalararg</span><span class="op" id="1580260">[</span><span class="num" id="1580261">0</span><span class="op" id="1580262">]</span>&nbsp;<span class="op" id="1580264">=</span>&nbsp;<span class="ident" id="1580266">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580284">onM</span><span class="op" id="1580287">(</span><span class="ident" id="1580288">mcacheRefill_m</span><span class="op" id="1580302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580308">releasem</span><span class="op" id="1580316">(</span><span class="ident" id="1580317">mp</span><span class="op" id="1580319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580325">s</span>&nbsp;<span class="op" id="1580327">=</span>&nbsp;<span class="ident" id="1580329">c</span><span class="op" id="1580330">.</span><span class="ident" id="1580331">alloc</span><span class="op" id="1580336">[</span><span class="ident" id="1580337">tinySizeClass</span><span class="op" id="1580350">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580356">v</span>&nbsp;<span class="op" id="1580358">=</span>&nbsp;<span class="ident" id="1580360">s</span><span class="op" id="1580361">.</span><span class="ident" id="1580362">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580379">s</span><span class="op" id="1580380">.</span><span class="ident" id="1580381">freelist</span>&nbsp;<span class="op" id="1580390">=</span>&nbsp;<span class="ident" id="1580392">v</span><span class="op" id="1580393">.</span><span class="ident" id="1580394">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580402">s</span><span class="op" id="1580403">.</span><span class="ident" id="1580404">ref</span><span class="op" id="1580407">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580413">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580440">x</span>&nbsp;<span class="op" id="1580442">=</span>&nbsp;<span class="ident" id="1580444">unsafe</span><span class="op" id="1580450">.</span><span class="ident" id="1580451">Pointer</span><span class="op" id="1580458">(</span><span class="ident" id="1580459">v</span><span class="op" id="1580460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580465">(</span><span class="op" id="1580466">*</span><span class="op" id="1580467">[</span><span class="num" id="1580468">2</span><span class="op" id="1580469">]</span><span class="ident" id="1580470">uint64</span><span class="op" id="1580476">)</span><span class="op" id="1580477">(</span><span class="ident" id="1580478">x</span><span class="op" id="1580479">)</span><span class="op" id="1580480">[</span><span class="num" id="1580481">0</span><span class="op" id="1580482">]</span>&nbsp;<span class="op" id="1580484">=</span>&nbsp;<span class="num" id="1580486">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580491">(</span><span class="op" id="1580492">*</span><span class="op" id="1580493">[</span><span class="num" id="1580494">2</span><span class="op" id="1580495">]</span><span class="ident" id="1580496">uint64</span><span class="op" id="1580502">)</span><span class="op" id="1580503">(</span><span class="ident" id="1580504">x</span><span class="op" id="1580505">)</span><span class="op" id="1580506">[</span><span class="num" id="1580507">1</span><span class="op" id="1580508">]</span>&nbsp;<span class="op" id="1580510">=</span>&nbsp;<span class="num" id="1580512">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580517">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580590">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580637">if</span>&nbsp;<span class="ident" id="1580640">maxTinySize</span><span class="op" id="1580651">-</span><span class="ident" id="1580652">size</span>&nbsp;<span class="op" id="1580657">&gt;</span>&nbsp;<span class="ident" id="1580659">tinysize</span>&nbsp;<span class="op" id="1580668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580674">c</span><span class="op" id="1580675">.</span><span class="ident" id="1580676">tiny</span>&nbsp;<span class="op" id="1580681">=</span>&nbsp;<span class="op" id="1580683">(</span><span class="op" id="1580684">*</span><span class="builtintype" id="1580685">byte</span><span class="op" id="1580689">)</span><span class="op" id="1580690">(</span><span class="ident" id="1580691">add</span><span class="op" id="1580694">(</span><span class="ident" id="1580695">x</span><span class="op" id="1580696">,</span>&nbsp;<span class="ident" id="1580698">size</span><span class="op" id="1580702">)</span><span class="op" id="1580703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580709">c</span><span class="op" id="1580710">.</span><span class="ident" id="1580711">tinysize</span>&nbsp;<span class="op" id="1580720">=</span>&nbsp;<span class="builtintype" id="1580722">uintptr</span><span class="op" id="1580729">(</span><span class="ident" id="1580730">maxTinySize</span>&nbsp;<span class="op" id="1580742">-</span>&nbsp;<span class="ident" id="1580744">size</span><span class="op" id="1580748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580758">size</span>&nbsp;<span class="op" id="1580763">=</span>&nbsp;<span class="ident" id="1580765">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580779">}</span>&nbsp;<span class="keyword" id="1580781">else</span>&nbsp;<span class="op" id="1580786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580791">var</span>&nbsp;<span class="ident" id="1580795">sizeclass</span>&nbsp;<span class="builtintype" id="1580805">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580813">if</span>&nbsp;<span class="ident" id="1580816">size</span>&nbsp;<span class="op" id="1580821">&lt;=</span>&nbsp;<span class="num" id="1580824">1024</span><span class="op" id="1580828">-</span><span class="num" id="1580829">8</span>&nbsp;<span class="op" id="1580831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580837">sizeclass</span>&nbsp;<span class="op" id="1580847">=</span>&nbsp;<span class="ident" id="1580849">size_to_class8</span><span class="op" id="1580863">[</span><span class="op" id="1580864">(</span><span class="ident" id="1580865">size</span><span class="op" id="1580869">+</span><span class="num" id="1580870">7</span><span class="op" id="1580871">)</span><span class="op" id="1580872">&gt;&gt;</span><span class="num" id="1580874">3</span><span class="op" id="1580875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580880">}</span>&nbsp;<span class="keyword" id="1580882">else</span>&nbsp;<span class="op" id="1580887">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580893">sizeclass</span>&nbsp;<span class="op" id="1580903">=</span>&nbsp;<span class="ident" id="1580905">size_to_class128</span><span class="op" id="1580921">[</span><span class="op" id="1580922">(</span><span class="ident" id="1580923">size</span><span class="op" id="1580927">-</span><span class="num" id="1580928">1024</span><span class="op" id="1580932">+</span><span class="num" id="1580933">127</span><span class="op" id="1580936">)</span><span class="op" id="1580937">&gt;&gt;</span><span class="num" id="1580939">7</span><span class="op" id="1580940">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580950">size</span>&nbsp;<span class="op" id="1580955">=</span>&nbsp;<span class="builtintype" id="1580957">uintptr</span><span class="op" id="1580964">(</span><span class="ident" id="1580965">class_to_size</span><span class="op" id="1580978">[</span><span class="ident" id="1580979">sizeclass</span><span class="op" id="1580988">]</span><span class="op" id="1580989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580994">s</span>&nbsp;<span class="op" id="1580996">=</span>&nbsp;<span class="ident" id="1580998">c</span><span class="op" id="1580999">.</span><span class="ident" id="1581000">alloc</span><span class="op" id="1581005">[</span><span class="ident" id="1581006">sizeclass</span><span class="op" id="1581015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581020">v</span>&nbsp;<span class="op" id="1581022">:=</span>&nbsp;<span class="ident" id="1581025">s</span><span class="op" id="1581026">.</span><span class="ident" id="1581027">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581039">if</span>&nbsp;<span class="ident" id="1581042">v</span>&nbsp;<span class="op" id="1581044">==</span>&nbsp;<span class="ident" id="1581047">nil</span>&nbsp;<span class="op" id="1581051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581057">mp</span>&nbsp;<span class="op" id="1581060">:=</span>&nbsp;<span class="ident" id="1581063">acquirem</span><span class="op" id="1581071">(</span><span class="op" id="1581072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581078">mp</span><span class="op" id="1581080">.</span><span class="ident" id="1581081">scalararg</span><span class="op" id="1581090">[</span><span class="num" id="1581091">0</span><span class="op" id="1581092">]</span>&nbsp;<span class="op" id="1581094">=</span>&nbsp;<span class="builtintype" id="1581096">uintptr</span><span class="op" id="1581103">(</span><span class="ident" id="1581104">sizeclass</span><span class="op" id="1581113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581119">onM</span><span class="op" id="1581122">(</span><span class="ident" id="1581123">mcacheRefill_m</span><span class="op" id="1581137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581143">releasem</span><span class="op" id="1581151">(</span><span class="ident" id="1581152">mp</span><span class="op" id="1581154">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581160">s</span>&nbsp;<span class="op" id="1581162">=</span>&nbsp;<span class="ident" id="1581164">c</span><span class="op" id="1581165">.</span><span class="ident" id="1581166">alloc</span><span class="op" id="1581171">[</span><span class="ident" id="1581172">sizeclass</span><span class="op" id="1581181">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581187">v</span>&nbsp;<span class="op" id="1581189">=</span>&nbsp;<span class="ident" id="1581191">s</span><span class="op" id="1581192">.</span><span class="ident" id="1581193">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581210">s</span><span class="op" id="1581211">.</span><span class="ident" id="1581212">freelist</span>&nbsp;<span class="op" id="1581221">=</span>&nbsp;<span class="ident" id="1581223">v</span><span class="op" id="1581224">.</span><span class="ident" id="1581225">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581233">s</span><span class="op" id="1581234">.</span><span class="ident" id="1581235">ref</span><span class="op" id="1581238">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581244">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581264">x</span>&nbsp;<span class="op" id="1581266">=</span>&nbsp;<span class="ident" id="1581268">unsafe</span><span class="op" id="1581274">.</span><span class="ident" id="1581275">Pointer</span><span class="op" id="1581282">(</span><span class="ident" id="1581283">v</span><span class="op" id="1581284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581289">if</span>&nbsp;<span class="ident" id="1581292">flags</span><span class="op" id="1581297">&amp;</span><span class="ident" id="1581298">flagNoZero</span>&nbsp;<span class="op" id="1581309">==</span>&nbsp;<span class="num" id="1581312">0</span>&nbsp;<span class="op" id="1581314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581320">v</span><span class="op" id="1581321">.</span><span class="ident" id="1581322">next</span>&nbsp;<span class="op" id="1581327">=</span>&nbsp;<span class="ident" id="1581329">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581337">if</span>&nbsp;<span class="ident" id="1581340">size</span>&nbsp;<span class="op" id="1581345">&gt;</span>&nbsp;<span class="num" id="1581347">2</span><span class="op" id="1581348">*</span><span class="ident" id="1581349">ptrSize</span>&nbsp;<span class="op" id="1581357">&amp;&amp;</span>&nbsp;<span class="op" id="1581360">(</span><span class="op" id="1581361">(</span><span class="op" id="1581362">*</span><span class="op" id="1581363">[</span><span class="num" id="1581364">2</span><span class="op" id="1581365">]</span><span class="builtintype" id="1581366">uintptr</span><span class="op" id="1581373">)</span><span class="op" id="1581374">(</span><span class="ident" id="1581375">x</span><span class="op" id="1581376">)</span><span class="op" id="1581377">)</span><span class="op" id="1581378">[</span><span class="num" id="1581379">1</span><span class="op" id="1581380">]</span>&nbsp;<span class="op" id="1581382">!=</span>&nbsp;<span class="num" id="1581385">0</span>&nbsp;<span class="op" id="1581387">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581394">memclr</span><span class="op" id="1581400">(</span><span class="ident" id="1581401">unsafe</span><span class="op" id="1581407">.</span><span class="ident" id="1581408">Pointer</span><span class="op" id="1581415">(</span><span class="ident" id="1581416">v</span><span class="op" id="1581417">)</span><span class="op" id="1581418">,</span>&nbsp;<span class="ident" id="1581420">size</span><span class="op" id="1581424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581443">c</span><span class="op" id="1581444">.</span><span class="ident" id="1581445">local_cachealloc</span>&nbsp;<span class="op" id="1581462">+=</span>&nbsp;<span class="ident" id="1581465">intptr</span><span class="op" id="1581471">(</span><span class="ident" id="1581472">size</span><span class="op" id="1581476">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581479">}</span>&nbsp;<span class="keyword" id="1581481">else</span>&nbsp;<span class="op" id="1581486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581490">mp</span>&nbsp;<span class="op" id="1581493">:=</span>&nbsp;<span class="ident" id="1581496">acquirem</span><span class="op" id="1581504">(</span><span class="op" id="1581505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581509">mp</span><span class="op" id="1581511">.</span><span class="ident" id="1581512">scalararg</span><span class="op" id="1581521">[</span><span class="num" id="1581522">0</span><span class="op" id="1581523">]</span>&nbsp;<span class="op" id="1581525">=</span>&nbsp;<span class="builtintype" id="1581527">uintptr</span><span class="op" id="1581534">(</span><span class="ident" id="1581535">size</span><span class="op" id="1581539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581543">mp</span><span class="op" id="1581545">.</span><span class="ident" id="1581546">scalararg</span><span class="op" id="1581555">[</span><span class="num" id="1581556">1</span><span class="op" id="1581557">]</span>&nbsp;<span class="op" id="1581559">=</span>&nbsp;<span class="builtintype" id="1581561">uintptr</span><span class="op" id="1581568">(</span><span class="ident" id="1581569">flags</span><span class="op" id="1581574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581578">onM</span><span class="op" id="1581581">(</span><span class="ident" id="1581582">largeAlloc_m</span><span class="op" id="1581594">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581598">s</span>&nbsp;<span class="op" id="1581600">=</span>&nbsp;<span class="op" id="1581602">(</span><span class="op" id="1581603">*</span><span class="ident" id="1581604">mspan</span><span class="op" id="1581609">)</span><span class="op" id="1581610">(</span><span class="ident" id="1581611">mp</span><span class="op" id="1581613">.</span><span class="ident" id="1581614">ptrarg</span><span class="op" id="1581620">[</span><span class="num" id="1581621">0</span><span class="op" id="1581622">]</span><span class="op" id="1581623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581627">mp</span><span class="op" id="1581629">.</span><span class="ident" id="1581630">ptrarg</span><span class="op" id="1581636">[</span><span class="num" id="1581637">0</span><span class="op" id="1581638">]</span>&nbsp;<span class="op" id="1581640">=</span>&nbsp;<span class="ident" id="1581642">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581648">releasem</span><span class="op" id="1581656">(</span><span class="ident" id="1581657">mp</span><span class="op" id="1581659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581663">x</span>&nbsp;<span class="op" id="1581665">=</span>&nbsp;<span class="ident" id="1581667">unsafe</span><span class="op" id="1581673">.</span><span class="ident" id="1581674">Pointer</span><span class="op" id="1581681">(</span><span class="builtintype" id="1581682">uintptr</span><span class="op" id="1581689">(</span><span class="ident" id="1581690">s</span><span class="op" id="1581691">.</span><span class="ident" id="1581692">start</span>&nbsp;<span class="op" id="1581698">&lt;&lt;</span>&nbsp;<span class="ident" id="1581701">pageShift</span><span class="op" id="1581710">)</span><span class="op" id="1581711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581715">size</span>&nbsp;<span class="op" id="1581720">=</span>&nbsp;<span class="builtintype" id="1581722">uintptr</span><span class="op" id="1581729">(</span><span class="ident" id="1581730">s</span><span class="op" id="1581731">.</span><span class="ident" id="1581732">elemsize</span><span class="op" id="1581740">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581747">if</span>&nbsp;<span class="ident" id="1581750">flags</span><span class="op" id="1581755">&amp;</span><span class="ident" id="1581756">flagNoScan</span>&nbsp;<span class="op" id="1581767">!=</span>&nbsp;<span class="num" id="1581770">0</span>&nbsp;<span class="op" id="1581772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581776">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581819">goto</span>&nbsp;<span class="ident" id="1581824">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581836">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581909">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581979">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582054">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582129">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582174">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582232">if</span>&nbsp;<span class="ident" id="1582235">typ</span>&nbsp;<span class="op" id="1582239">==</span>&nbsp;<span class="ident" id="1582242">deferType</span>&nbsp;<span class="op" id="1582252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582256">size0</span>&nbsp;<span class="op" id="1582262">=</span>&nbsp;<span class="ident" id="1582264">unsafe</span><span class="op" id="1582270">.</span><span class="ident" id="1582271">Sizeof</span><span class="op" id="1582277">(</span><span class="ident" id="1582278">_defer</span><span class="op" id="1582284">{</span><span class="op" id="1582285">}</span><span class="op" id="1582286">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582293">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582357">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582401">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582405">arena_start</span>&nbsp;<span class="op" id="1582417">:=</span>&nbsp;<span class="builtintype" id="1582420">uintptr</span><span class="op" id="1582427">(</span><span class="ident" id="1582428">unsafe</span><span class="op" id="1582434">.</span><span class="ident" id="1582435">Pointer</span><span class="op" id="1582442">(</span><span class="ident" id="1582443">mheap_</span><span class="op" id="1582449">.</span><span class="ident" id="1582450">arena_start</span><span class="op" id="1582461">)</span><span class="op" id="1582462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582466">off</span>&nbsp;<span class="op" id="1582470">:=</span>&nbsp;<span class="op" id="1582473">(</span><span class="builtintype" id="1582474">uintptr</span><span class="op" id="1582481">(</span><span class="ident" id="1582482">x</span><span class="op" id="1582483">)</span>&nbsp;<span class="op" id="1582485">-</span>&nbsp;<span class="ident" id="1582487">arena_start</span><span class="op" id="1582498">)</span>&nbsp;<span class="op" id="1582500">/</span>&nbsp;<span class="ident" id="1582502">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582512">xbits</span>&nbsp;<span class="op" id="1582518">:=</span>&nbsp;<span class="op" id="1582521">(</span><span class="op" id="1582522">*</span><span class="builtintype" id="1582523">uint8</span><span class="op" id="1582528">)</span><span class="op" id="1582529">(</span><span class="ident" id="1582530">unsafe</span><span class="op" id="1582536">.</span><span class="ident" id="1582537">Pointer</span><span class="op" id="1582544">(</span><span class="ident" id="1582545">arena_start</span>&nbsp;<span class="op" id="1582557">-</span>&nbsp;<span class="ident" id="1582559">off</span><span class="op" id="1582562">/</span><span class="ident" id="1582563">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1582582">-</span>&nbsp;<span class="num" id="1582584">1</span><span class="op" id="1582585">)</span><span class="op" id="1582586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582590">shift</span>&nbsp;<span class="op" id="1582596">:=</span>&nbsp;<span class="op" id="1582599">(</span><span class="ident" id="1582600">off</span>&nbsp;<span class="op" id="1582604">%</span>&nbsp;<span class="ident" id="1582606">wordsPerBitmapByte</span><span class="op" id="1582624">)</span>&nbsp;<span class="op" id="1582626">*</span>&nbsp;<span class="ident" id="1582628">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582637">if</span>&nbsp;<span class="ident" id="1582640">debugMalloc</span>&nbsp;<span class="op" id="1582652">&amp;&amp;</span>&nbsp;<span class="op" id="1582655">(</span><span class="op" id="1582656">(</span><span class="op" id="1582657">*</span><span class="ident" id="1582658">xbits</span><span class="op" id="1582663">&gt;&gt;</span><span class="ident" id="1582665">shift</span><span class="op" id="1582670">)</span><span class="op" id="1582671">&amp;</span><span class="op" id="1582672">(</span><span class="ident" id="1582673">bitMask</span><span class="op" id="1582680">|</span><span class="ident" id="1582681">bitPtrMask</span><span class="op" id="1582691">)</span><span class="op" id="1582692">)</span>&nbsp;<span class="op" id="1582694">!=</span>&nbsp;<span class="ident" id="1582697">bitBoundary</span>&nbsp;<span class="op" id="1582709">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1582714">println</span><span class="op" id="1582721">(</span><span class="string" id="1582722">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1582739">,</span>&nbsp;<span class="op" id="1582741">(</span><span class="op" id="1582742">*</span><span class="ident" id="1582743">xbits</span><span class="op" id="1582748">&gt;&gt;</span><span class="ident" id="1582750">shift</span><span class="op" id="1582755">)</span><span class="op" id="1582756">&amp;</span><span class="op" id="1582757">(</span><span class="ident" id="1582758">bitMask</span><span class="op" id="1582765">|</span><span class="ident" id="1582766">bitPtrMask</span><span class="op" id="1582776">)</span><span class="op" id="1582777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582782">gothrow</span><span class="op" id="1582789">(</span><span class="string" id="1582790">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1582817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582826">var</span>&nbsp;<span class="ident" id="1582830">ti</span><span class="op" id="1582832">,</span>&nbsp;<span class="ident" id="1582834">te</span>&nbsp;<span class="builtintype" id="1582837">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582847">var</span>&nbsp;<span class="ident" id="1582851">ptrmask</span>&nbsp;<span class="op" id="1582859">*</span><span class="builtintype" id="1582860">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582868">if</span>&nbsp;<span class="ident" id="1582871">size</span>&nbsp;<span class="op" id="1582876">==</span>&nbsp;<span class="ident" id="1582879">ptrSize</span>&nbsp;<span class="op" id="1582887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582892">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582955">*</span><span class="ident" id="1582956">xbits</span>&nbsp;<span class="op" id="1582962">|=</span>&nbsp;<span class="op" id="1582965">(</span><span class="ident" id="1582966">bitsPointer</span>&nbsp;<span class="op" id="1582978">&lt;&lt;</span>&nbsp;<span class="num" id="1582981">2</span><span class="op" id="1582982">)</span>&nbsp;<span class="op" id="1582984">&lt;&lt;</span>&nbsp;<span class="ident" id="1582987">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582996">goto</span>&nbsp;<span class="ident" id="1583001">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583014">if</span>&nbsp;<span class="ident" id="1583017">typ</span><span class="op" id="1583020">.</span><span class="ident" id="1583021">kind</span><span class="op" id="1583025">&amp;</span><span class="ident" id="1583026">kindGCProg</span>&nbsp;<span class="op" id="1583037">!=</span>&nbsp;<span class="num" id="1583040">0</span>&nbsp;<span class="op" id="1583042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583047">nptr</span>&nbsp;<span class="op" id="1583052">:=</span>&nbsp;<span class="op" id="1583055">(</span><span class="builtintype" id="1583056">uintptr</span><span class="op" id="1583063">(</span><span class="ident" id="1583064">typ</span><span class="op" id="1583067">.</span><span class="ident" id="1583068">size</span><span class="op" id="1583072">)</span>&nbsp;<span class="op" id="1583074">+</span>&nbsp;<span class="ident" id="1583076">ptrSize</span>&nbsp;<span class="op" id="1583084">-</span>&nbsp;<span class="num" id="1583086">1</span><span class="op" id="1583087">)</span>&nbsp;<span class="op" id="1583089">/</span>&nbsp;<span class="ident" id="1583091">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583102">masksize</span>&nbsp;<span class="op" id="1583111">:=</span>&nbsp;<span class="ident" id="1583114">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583122">if</span>&nbsp;<span class="ident" id="1583125">masksize</span><span class="op" id="1583133">%</span><span class="num" id="1583134">2</span>&nbsp;<span class="op" id="1583136">!=</span>&nbsp;<span class="num" id="1583139">0</span>&nbsp;<span class="op" id="1583141">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583147">masksize</span>&nbsp;<span class="op" id="1583156">*=</span>&nbsp;<span class="num" id="1583159">2</span>&nbsp;<span class="comment" id="1583161">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583181">masksize</span>&nbsp;<span class="op" id="1583190">=</span>&nbsp;<span class="ident" id="1583192">masksize</span>&nbsp;<span class="op" id="1583201">*</span>&nbsp;<span class="ident" id="1583203">pointersPerByte</span>&nbsp;<span class="op" id="1583219">/</span>&nbsp;<span class="num" id="1583221">8</span>&nbsp;<span class="comment" id="1583223">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583245">masksize</span><span class="op" id="1583253">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583287">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583322">if</span>&nbsp;<span class="ident" id="1583325">masksize</span>&nbsp;<span class="op" id="1583334">&gt;</span>&nbsp;<span class="ident" id="1583336">maxGCMask</span>&nbsp;<span class="op" id="1583346">&amp;&amp;</span>&nbsp;<span class="ident" id="1583349">typ</span><span class="op" id="1583352">.</span><span class="ident" id="1583353">gc</span><span class="op" id="1583355">[</span><span class="num" id="1583356">1</span><span class="op" id="1583357">]</span>&nbsp;<span class="op" id="1583359">!=</span>&nbsp;<span class="num" id="1583362">0</span>&nbsp;<span class="op" id="1583364">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583370">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583431">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583491">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583554">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583582">mp</span>&nbsp;<span class="op" id="1583585">:=</span>&nbsp;<span class="ident" id="1583588">acquirem</span><span class="op" id="1583596">(</span><span class="op" id="1583597">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583603">mp</span><span class="op" id="1583605">.</span><span class="ident" id="1583606">ptrarg</span><span class="op" id="1583612">[</span><span class="num" id="1583613">0</span><span class="op" id="1583614">]</span>&nbsp;<span class="op" id="1583616">=</span>&nbsp;<span class="ident" id="1583618">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583624">mp</span><span class="op" id="1583626">.</span><span class="ident" id="1583627">ptrarg</span><span class="op" id="1583633">[</span><span class="num" id="1583634">1</span><span class="op" id="1583635">]</span>&nbsp;<span class="op" id="1583637">=</span>&nbsp;<span class="ident" id="1583639">unsafe</span><span class="op" id="1583645">.</span><span class="ident" id="1583646">Pointer</span><span class="op" id="1583653">(</span><span class="ident" id="1583654">typ</span><span class="op" id="1583657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583663">mp</span><span class="op" id="1583665">.</span><span class="ident" id="1583666">scalararg</span><span class="op" id="1583675">[</span><span class="num" id="1583676">0</span><span class="op" id="1583677">]</span>&nbsp;<span class="op" id="1583679">=</span>&nbsp;<span class="builtintype" id="1583681">uintptr</span><span class="op" id="1583688">(</span><span class="ident" id="1583689">size</span><span class="op" id="1583693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583699">mp</span><span class="op" id="1583701">.</span><span class="ident" id="1583702">scalararg</span><span class="op" id="1583711">[</span><span class="num" id="1583712">1</span><span class="op" id="1583713">]</span>&nbsp;<span class="op" id="1583715">=</span>&nbsp;<span class="builtintype" id="1583717">uintptr</span><span class="op" id="1583724">(</span><span class="ident" id="1583725">size0</span><span class="op" id="1583730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583736">onM</span><span class="op" id="1583739">(</span><span class="ident" id="1583740">unrollgcproginplace_m</span><span class="op" id="1583761">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583767">releasem</span><span class="op" id="1583775">(</span><span class="ident" id="1583776">mp</span><span class="op" id="1583778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583784">goto</span>&nbsp;<span class="ident" id="1583789">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583804">ptrmask</span>&nbsp;<span class="op" id="1583812">=</span>&nbsp;<span class="op" id="1583814">(</span><span class="op" id="1583815">*</span><span class="builtintype" id="1583816">uint8</span><span class="op" id="1583821">)</span><span class="op" id="1583822">(</span><span class="ident" id="1583823">unsafe</span><span class="op" id="1583829">.</span><span class="ident" id="1583830">Pointer</span><span class="op" id="1583837">(</span><span class="builtintype" id="1583838">uintptr</span><span class="op" id="1583845">(</span><span class="ident" id="1583846">typ</span><span class="op" id="1583849">.</span><span class="ident" id="1583850">gc</span><span class="op" id="1583852">[</span><span class="num" id="1583853">0</span><span class="op" id="1583854">]</span><span class="op" id="1583855">)</span><span class="op" id="1583856">)</span><span class="op" id="1583857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583862">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583915">if</span>&nbsp;<span class="builtintype" id="1583918">uintptr</span><span class="op" id="1583925">(</span><span class="ident" id="1583926">atomicloadp</span><span class="op" id="1583937">(</span><span class="ident" id="1583938">unsafe</span><span class="op" id="1583944">.</span><span class="ident" id="1583945">Pointer</span><span class="op" id="1583952">(</span><span class="ident" id="1583953">ptrmask</span><span class="op" id="1583960">)</span><span class="op" id="1583961">)</span><span class="op" id="1583962">)</span><span class="op" id="1583963">&amp;</span><span class="num" id="1583964">0xff</span>&nbsp;<span class="op" id="1583969">==</span>&nbsp;<span class="num" id="1583972">0</span>&nbsp;<span class="op" id="1583974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583980">mp</span>&nbsp;<span class="op" id="1583983">:=</span>&nbsp;<span class="ident" id="1583986">acquirem</span><span class="op" id="1583994">(</span><span class="op" id="1583995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584001">mp</span><span class="op" id="1584003">.</span><span class="ident" id="1584004">ptrarg</span><span class="op" id="1584010">[</span><span class="num" id="1584011">0</span><span class="op" id="1584012">]</span>&nbsp;<span class="op" id="1584014">=</span>&nbsp;<span class="ident" id="1584016">unsafe</span><span class="op" id="1584022">.</span><span class="ident" id="1584023">Pointer</span><span class="op" id="1584030">(</span><span class="ident" id="1584031">typ</span><span class="op" id="1584034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584040">onM</span><span class="op" id="1584043">(</span><span class="ident" id="1584044">unrollgcprog_m</span><span class="op" id="1584058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584064">releasem</span><span class="op" id="1584072">(</span><span class="ident" id="1584073">mp</span><span class="op" id="1584075">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584085">ptrmask</span>&nbsp;<span class="op" id="1584093">=</span>&nbsp;<span class="op" id="1584095">(</span><span class="op" id="1584096">*</span><span class="builtintype" id="1584097">uint8</span><span class="op" id="1584102">)</span><span class="op" id="1584103">(</span><span class="ident" id="1584104">add</span><span class="op" id="1584107">(</span><span class="ident" id="1584108">unsafe</span><span class="op" id="1584114">.</span><span class="ident" id="1584115">Pointer</span><span class="op" id="1584122">(</span><span class="ident" id="1584123">ptrmask</span><span class="op" id="1584130">)</span><span class="op" id="1584131">,</span>&nbsp;<span class="num" id="1584133">1</span><span class="op" id="1584134">)</span><span class="op" id="1584135">)</span>&nbsp;<span class="comment" id="1584137">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584168">}</span>&nbsp;<span class="keyword" id="1584170">else</span>&nbsp;<span class="op" id="1584175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584180">ptrmask</span>&nbsp;<span class="op" id="1584188">=</span>&nbsp;<span class="op" id="1584190">(</span><span class="op" id="1584191">*</span><span class="builtintype" id="1584192">uint8</span><span class="op" id="1584197">)</span><span class="op" id="1584198">(</span><span class="ident" id="1584199">unsafe</span><span class="op" id="1584205">.</span><span class="ident" id="1584206">Pointer</span><span class="op" id="1584213">(</span><span class="ident" id="1584214">typ</span><span class="op" id="1584217">.</span><span class="ident" id="1584218">gc</span><span class="op" id="1584220">[</span><span class="num" id="1584221">0</span><span class="op" id="1584222">]</span><span class="op" id="1584223">)</span><span class="op" id="1584224">)</span>&nbsp;<span class="comment" id="1584226">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584256">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584260">if</span>&nbsp;<span class="ident" id="1584263">size</span>&nbsp;<span class="op" id="1584268">==</span>&nbsp;<span class="num" id="1584271">2</span><span class="op" id="1584272">*</span><span class="ident" id="1584273">ptrSize</span>&nbsp;<span class="op" id="1584281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584286">*</span><span class="ident" id="1584287">xbits</span>&nbsp;<span class="op" id="1584293">=</span>&nbsp;<span class="op" id="1584295">*</span><span class="ident" id="1584296">ptrmask</span>&nbsp;<span class="op" id="1584304">|</span>&nbsp;<span class="ident" id="1584306">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584321">goto</span>&nbsp;<span class="ident" id="1584326">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584339">te</span>&nbsp;<span class="op" id="1584342">=</span>&nbsp;<span class="builtintype" id="1584344">uintptr</span><span class="op" id="1584351">(</span><span class="ident" id="1584352">typ</span><span class="op" id="1584355">.</span><span class="ident" id="1584356">size</span><span class="op" id="1584360">)</span>&nbsp;<span class="op" id="1584362">/</span>&nbsp;<span class="ident" id="1584364">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584374">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584443">if</span>&nbsp;<span class="ident" id="1584446">te</span><span class="op" id="1584448">%</span><span class="num" id="1584449">2</span>&nbsp;<span class="op" id="1584451">==</span>&nbsp;<span class="num" id="1584454">0</span>&nbsp;<span class="op" id="1584456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584461">te</span>&nbsp;<span class="op" id="1584464">/=</span>&nbsp;<span class="num" id="1584467">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584475">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584518">for</span>&nbsp;<span class="ident" id="1584522">i</span>&nbsp;<span class="op" id="1584524">:=</span>&nbsp;<span class="builtintype" id="1584527">uintptr</span><span class="op" id="1584534">(</span><span class="num" id="1584535">0</span><span class="op" id="1584536">)</span><span class="op" id="1584537">;</span>&nbsp;<span class="ident" id="1584539">i</span>&nbsp;<span class="op" id="1584541">&lt;</span>&nbsp;<span class="ident" id="1584543">size0</span><span class="op" id="1584548">;</span>&nbsp;<span class="ident" id="1584550">i</span>&nbsp;<span class="op" id="1584552">+=</span>&nbsp;<span class="num" id="1584555">2</span>&nbsp;<span class="op" id="1584557">*</span>&nbsp;<span class="ident" id="1584559">ptrSize</span>&nbsp;<span class="op" id="1584567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584572">v</span>&nbsp;<span class="op" id="1584574">:=</span>&nbsp;<span class="op" id="1584577">*</span><span class="op" id="1584578">(</span><span class="op" id="1584579">*</span><span class="builtintype" id="1584580">uint8</span><span class="op" id="1584585">)</span><span class="op" id="1584586">(</span><span class="ident" id="1584587">add</span><span class="op" id="1584590">(</span><span class="ident" id="1584591">unsafe</span><span class="op" id="1584597">.</span><span class="ident" id="1584598">Pointer</span><span class="op" id="1584605">(</span><span class="ident" id="1584606">ptrmask</span><span class="op" id="1584613">)</span><span class="op" id="1584614">,</span>&nbsp;<span class="ident" id="1584616">ti</span><span class="op" id="1584618">)</span><span class="op" id="1584619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584624">ti</span><span class="op" id="1584626">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584632">if</span>&nbsp;<span class="ident" id="1584635">ti</span>&nbsp;<span class="op" id="1584638">==</span>&nbsp;<span class="ident" id="1584641">te</span>&nbsp;<span class="op" id="1584644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584650">ti</span>&nbsp;<span class="op" id="1584653">=</span>&nbsp;<span class="num" id="1584655">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584665">if</span>&nbsp;<span class="ident" id="1584668">i</span>&nbsp;<span class="op" id="1584670">==</span>&nbsp;<span class="num" id="1584673">0</span>&nbsp;<span class="op" id="1584675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584681">v</span>&nbsp;<span class="op" id="1584683">|=</span>&nbsp;<span class="ident" id="1584686">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584706">if</span>&nbsp;<span class="ident" id="1584709">i</span><span class="op" id="1584710">+</span><span class="ident" id="1584711">ptrSize</span>&nbsp;<span class="op" id="1584719">==</span>&nbsp;<span class="ident" id="1584722">size0</span>&nbsp;<span class="op" id="1584728">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584734">v</span>&nbsp;<span class="op" id="1584736">&amp;^=</span>&nbsp;<span class="builtintype" id="1584740">uint8</span><span class="op" id="1584745">(</span><span class="ident" id="1584746">bitPtrMask</span>&nbsp;<span class="op" id="1584757">&lt;&lt;</span>&nbsp;<span class="num" id="1584760">4</span><span class="op" id="1584761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584772">*</span><span class="ident" id="1584773">xbits</span>&nbsp;<span class="op" id="1584779">=</span>&nbsp;<span class="ident" id="1584781">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584786">xbits</span>&nbsp;<span class="op" id="1584792">=</span>&nbsp;<span class="op" id="1584794">(</span><span class="op" id="1584795">*</span><span class="builtintype" id="1584796">byte</span><span class="op" id="1584800">)</span><span class="op" id="1584801">(</span><span class="ident" id="1584802">add</span><span class="op" id="1584805">(</span><span class="ident" id="1584806">unsafe</span><span class="op" id="1584812">.</span><span class="ident" id="1584813">Pointer</span><span class="op" id="1584820">(</span><span class="ident" id="1584821">xbits</span><span class="op" id="1584826">)</span><span class="op" id="1584827">,</span>&nbsp;<span class="op" id="1584829">^</span><span class="builtintype" id="1584830">uintptr</span><span class="op" id="1584837">(</span><span class="num" id="1584838">0</span><span class="op" id="1584839">)</span><span class="op" id="1584840">)</span><span class="op" id="1584841">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584849">if</span>&nbsp;<span class="ident" id="1584852">size0</span><span class="op" id="1584857">%</span><span class="op" id="1584858">(</span><span class="num" id="1584859">2</span><span class="op" id="1584860">*</span><span class="ident" id="1584861">ptrSize</span><span class="op" id="1584868">)</span>&nbsp;<span class="op" id="1584870">==</span>&nbsp;<span class="num" id="1584873">0</span>&nbsp;<span class="op" id="1584875">&amp;&amp;</span>&nbsp;<span class="ident" id="1584878">size0</span>&nbsp;<span class="op" id="1584884">&lt;</span>&nbsp;<span class="ident" id="1584886">size</span>&nbsp;<span class="op" id="1584891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584896">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584954">*</span><span class="ident" id="1584955">xbits</span>&nbsp;<span class="op" id="1584961">=</span>&nbsp;<span class="ident" id="1584963">bitsDead</span>&nbsp;<span class="op" id="1584972">&lt;&lt;</span>&nbsp;<span class="num" id="1584975">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584979">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584982">}</span><br>
<span class="lineno"></span><span class="ident" id="1584984">marked</span><span class="op" id="1584990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584993">if</span>&nbsp;<span class="ident" id="1584996">raceenabled</span>&nbsp;<span class="op" id="1585008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585012">racemalloc</span><span class="op" id="1585022">(</span><span class="ident" id="1585023">x</span><span class="op" id="1585024">,</span>&nbsp;<span class="ident" id="1585026">size</span><span class="op" id="1585030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585033">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585037">if</span>&nbsp;<span class="ident" id="1585040">debugMalloc</span>&nbsp;<span class="op" id="1585052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585056">mp</span>&nbsp;<span class="op" id="1585059">:=</span>&nbsp;<span class="ident" id="1585062">acquirem</span><span class="op" id="1585070">(</span><span class="op" id="1585071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585075">if</span>&nbsp;<span class="ident" id="1585078">mp</span><span class="op" id="1585080">.</span><span class="ident" id="1585081">mallocing</span>&nbsp;<span class="op" id="1585091">==</span>&nbsp;<span class="num" id="1585094">0</span>&nbsp;<span class="op" id="1585096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585101">gothrow</span><span class="op" id="1585108">(</span><span class="string" id="1585109">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1585121">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585129">mp</span><span class="op" id="1585131">.</span><span class="ident" id="1585132">mallocing</span>&nbsp;<span class="op" id="1585142">=</span>&nbsp;<span class="num" id="1585144">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585148">if</span>&nbsp;<span class="ident" id="1585151">mp</span><span class="op" id="1585153">.</span><span class="ident" id="1585154">curg</span>&nbsp;<span class="op" id="1585159">!=</span>&nbsp;<span class="ident" id="1585162">nil</span>&nbsp;<span class="op" id="1585166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585171">mp</span><span class="op" id="1585173">.</span><span class="ident" id="1585174">curg</span><span class="op" id="1585178">.</span><span class="ident" id="1585179">stackguard0</span>&nbsp;<span class="op" id="1585191">=</span>&nbsp;<span class="ident" id="1585193">mp</span><span class="op" id="1585195">.</span><span class="ident" id="1585196">curg</span><span class="op" id="1585200">.</span><span class="ident" id="1585201">stack</span><span class="op" id="1585206">.</span><span class="ident" id="1585207">lo</span>&nbsp;<span class="op" id="1585210">+</span>&nbsp;<span class="ident" id="1585212">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585226">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585230">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585283">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585335">releasem</span><span class="op" id="1585343">(</span><span class="ident" id="1585344">mp</span><span class="op" id="1585346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585350">releasem</span><span class="op" id="1585358">(</span><span class="ident" id="1585359">mp</span><span class="op" id="1585361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585364">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585368">if</span>&nbsp;<span class="ident" id="1585371">debug</span><span class="op" id="1585376">.</span><span class="ident" id="1585377">allocfreetrace</span>&nbsp;<span class="op" id="1585392">!=</span>&nbsp;<span class="num" id="1585395">0</span>&nbsp;<span class="op" id="1585397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585401">tracealloc</span><span class="op" id="1585411">(</span><span class="ident" id="1585412">x</span><span class="op" id="1585413">,</span>&nbsp;<span class="ident" id="1585415">size</span><span class="op" id="1585419">,</span>&nbsp;<span class="ident" id="1585421">typ</span><span class="op" id="1585424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585431">if</span>&nbsp;<span class="ident" id="1585434">rate</span>&nbsp;<span class="op" id="1585439">:=</span>&nbsp;<span class="ident" id="1585442">MemProfileRate</span><span class="op" id="1585456">;</span>&nbsp;<span class="ident" id="1585458">rate</span>&nbsp;<span class="op" id="1585463">&gt;</span>&nbsp;<span class="num" id="1585465">0</span>&nbsp;<span class="op" id="1585467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585471">if</span>&nbsp;<span class="ident" id="1585474">size</span>&nbsp;<span class="op" id="1585479">&lt;</span>&nbsp;<span class="builtintype" id="1585481">uintptr</span><span class="op" id="1585488">(</span><span class="ident" id="1585489">rate</span><span class="op" id="1585493">)</span>&nbsp;<span class="op" id="1585495">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1585498">int32</span><span class="op" id="1585503">(</span><span class="ident" id="1585504">size</span><span class="op" id="1585508">)</span>&nbsp;<span class="op" id="1585510">&lt;</span>&nbsp;<span class="ident" id="1585512">c</span><span class="op" id="1585513">.</span><span class="ident" id="1585514">next_sample</span>&nbsp;<span class="op" id="1585526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585531">c</span><span class="op" id="1585532">.</span><span class="ident" id="1585533">next_sample</span>&nbsp;<span class="op" id="1585545">-=</span>&nbsp;<span class="builtintype" id="1585548">int32</span><span class="op" id="1585553">(</span><span class="ident" id="1585554">size</span><span class="op" id="1585558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585562">}</span>&nbsp;<span class="keyword" id="1585564">else</span>&nbsp;<span class="op" id="1585569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585574">mp</span>&nbsp;<span class="op" id="1585577">:=</span>&nbsp;<span class="ident" id="1585580">acquirem</span><span class="op" id="1585588">(</span><span class="op" id="1585589">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585594">profilealloc</span><span class="op" id="1585606">(</span><span class="ident" id="1585607">mp</span><span class="op" id="1585609">,</span>&nbsp;<span class="ident" id="1585611">x</span><span class="op" id="1585612">,</span>&nbsp;<span class="ident" id="1585614">size</span><span class="op" id="1585618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585623">releasem</span><span class="op" id="1585631">(</span><span class="ident" id="1585632">mp</span><span class="op" id="1585634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585645">if</span>&nbsp;<span class="ident" id="1585648">memstats</span><span class="op" id="1585656">.</span><span class="ident" id="1585657">heap_alloc</span>&nbsp;<span class="op" id="1585668">&gt;=</span>&nbsp;<span class="ident" id="1585671">memstats</span><span class="op" id="1585679">.</span><span class="ident" id="1585680">next_gc</span>&nbsp;<span class="op" id="1585688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585692">gogc</span><span class="op" id="1585696">(</span><span class="num" id="1585697">0</span><span class="op" id="1585698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585705">return</span>&nbsp;<span class="ident" id="1585712">x</span><br>
<span class="lineno">345</span><span class="op" id="1585714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585717">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1585750">func</span>&nbsp;<span class="ident" id="1585755">newobject</span><span class="op" id="1585764">(</span><span class="ident" id="1585765">typ</span>&nbsp;<span class="op" id="1585769">*</span><span class="ident" id="1585770">_type</span><span class="op" id="1585775">)</span>&nbsp;<span class="ident" id="1585777">unsafe</span><span class="op" id="1585783">.</span><span class="ident" id="1585784">Pointer</span>&nbsp;<span class="op" id="1585792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585795">flags</span>&nbsp;<span class="op" id="1585801">:=</span>&nbsp;<span class="builtintype" id="1585804">uint32</span><span class="op" id="1585810">(</span><span class="num" id="1585811">0</span><span class="op" id="1585812">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585815">if</span>&nbsp;<span class="ident" id="1585818">typ</span><span class="op" id="1585821">.</span><span class="ident" id="1585822">kind</span><span class="op" id="1585826">&amp;</span><span class="ident" id="1585827">kindNoPointers</span>&nbsp;<span class="op" id="1585842">!=</span>&nbsp;<span class="num" id="1585845">0</span>&nbsp;<span class="op" id="1585847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585851">flags</span>&nbsp;<span class="op" id="1585857">|=</span>&nbsp;<span class="ident" id="1585860">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585875">return</span>&nbsp;<span class="ident" id="1585882">mallocgc</span><span class="op" id="1585890">(</span><span class="builtintype" id="1585891">uintptr</span><span class="op" id="1585898">(</span><span class="ident" id="1585899">typ</span><span class="op" id="1585902">.</span><span class="ident" id="1585903">size</span><span class="op" id="1585907">)</span><span class="op" id="1585908">,</span>&nbsp;<span class="ident" id="1585910">typ</span><span class="op" id="1585913">,</span>&nbsp;<span class="ident" id="1585915">flags</span><span class="op" id="1585920">)</span><br>
<span class="lineno"></span><span class="op" id="1585922">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1585925">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1585970">func</span>&nbsp;<span class="ident" id="1585975">newarray</span><span class="op" id="1585983">(</span><span class="ident" id="1585984">typ</span>&nbsp;<span class="op" id="1585988">*</span><span class="ident" id="1585989">_type</span><span class="op" id="1585994">,</span>&nbsp;<span class="ident" id="1585996">n</span>&nbsp;<span class="builtintype" id="1585998">uintptr</span><span class="op" id="1586005">)</span>&nbsp;<span class="ident" id="1586007">unsafe</span><span class="op" id="1586013">.</span><span class="ident" id="1586014">Pointer</span>&nbsp;<span class="op" id="1586022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586025">flags</span>&nbsp;<span class="op" id="1586031">:=</span>&nbsp;<span class="builtintype" id="1586034">uint32</span><span class="op" id="1586040">(</span><span class="num" id="1586041">0</span><span class="op" id="1586042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586045">if</span>&nbsp;<span class="ident" id="1586048">typ</span><span class="op" id="1586051">.</span><span class="ident" id="1586052">kind</span><span class="op" id="1586056">&amp;</span><span class="ident" id="1586057">kindNoPointers</span>&nbsp;<span class="op" id="1586072">!=</span>&nbsp;<span class="num" id="1586075">0</span>&nbsp;<span class="op" id="1586077">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586081">flags</span>&nbsp;<span class="op" id="1586087">|=</span>&nbsp;<span class="ident" id="1586090">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586105">if</span>&nbsp;<span class="builtintype" id="1586108">int</span><span class="op" id="1586111">(</span><span class="ident" id="1586112">n</span><span class="op" id="1586113">)</span>&nbsp;<span class="op" id="1586115">&lt;</span>&nbsp;<span class="num" id="1586117">0</span>&nbsp;<span class="op" id="1586119">||</span>&nbsp;<span class="op" id="1586122">(</span><span class="ident" id="1586123">typ</span><span class="op" id="1586126">.</span><span class="ident" id="1586127">size</span>&nbsp;<span class="op" id="1586132">&gt;</span>&nbsp;<span class="num" id="1586134">0</span>&nbsp;<span class="op" id="1586136">&amp;&amp;</span>&nbsp;<span class="ident" id="1586139">n</span>&nbsp;<span class="op" id="1586141">&gt;</span>&nbsp;<span class="ident" id="1586143">maxmem</span><span class="op" id="1586149">/</span><span class="builtintype" id="1586150">uintptr</span><span class="op" id="1586157">(</span><span class="ident" id="1586158">typ</span><span class="op" id="1586161">.</span><span class="ident" id="1586162">size</span><span class="op" id="1586166">)</span><span class="op" id="1586167">)</span>&nbsp;<span class="op" id="1586169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1586173">panic</span><span class="op" id="1586178">(</span><span class="string" id="1586179">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1586218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586221">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586224">return</span>&nbsp;<span class="ident" id="1586231">mallocgc</span><span class="op" id="1586239">(</span><span class="builtintype" id="1586240">uintptr</span><span class="op" id="1586247">(</span><span class="ident" id="1586248">typ</span><span class="op" id="1586251">.</span><span class="ident" id="1586252">size</span><span class="op" id="1586256">)</span><span class="op" id="1586257">*</span><span class="ident" id="1586258">n</span><span class="op" id="1586259">,</span>&nbsp;<span class="ident" id="1586261">typ</span><span class="op" id="1586264">,</span>&nbsp;<span class="ident" id="1586266">flags</span><span class="op" id="1586271">)</span><br>
<span class="lineno"></span><span class="op" id="1586273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586276">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1586332">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1586347">func</span>&nbsp;<span class="ident" id="1586352">rawmem</span><span class="op" id="1586358">(</span><span class="ident" id="1586359">size</span>&nbsp;<span class="builtintype" id="1586364">uintptr</span><span class="op" id="1586371">)</span>&nbsp;<span class="ident" id="1586373">unsafe</span><span class="op" id="1586379">.</span><span class="ident" id="1586380">Pointer</span>&nbsp;<span class="op" id="1586388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586391">return</span>&nbsp;<span class="ident" id="1586398">mallocgc</span><span class="op" id="1586406">(</span><span class="ident" id="1586407">size</span><span class="op" id="1586411">,</span>&nbsp;<span class="ident" id="1586413">nil</span><span class="op" id="1586416">,</span>&nbsp;<span class="ident" id="1586418">flagNoScan</span><span class="op" id="1586428">|</span><span class="ident" id="1586429">flagNoZero</span><span class="op" id="1586439">)</span><br>
<span class="lineno"></span><span class="op" id="1586441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586444">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1586480">func</span>&nbsp;<span class="ident" id="1586485">goroundupsize</span><span class="op" id="1586498">(</span><span class="ident" id="1586499">size</span>&nbsp;<span class="builtintype" id="1586504">uintptr</span><span class="op" id="1586511">)</span>&nbsp;<span class="builtintype" id="1586513">uintptr</span>&nbsp;<span class="op" id="1586521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586524">if</span>&nbsp;<span class="ident" id="1586527">size</span>&nbsp;<span class="op" id="1586532">&lt;</span>&nbsp;<span class="ident" id="1586534">maxSmallSize</span>&nbsp;<span class="op" id="1586547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586551">if</span>&nbsp;<span class="ident" id="1586554">size</span>&nbsp;<span class="op" id="1586559">&lt;=</span>&nbsp;<span class="num" id="1586562">1024</span><span class="op" id="1586566">-</span><span class="num" id="1586567">8</span>&nbsp;<span class="op" id="1586569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586574">return</span>&nbsp;<span class="builtintype" id="1586581">uintptr</span><span class="op" id="1586588">(</span><span class="ident" id="1586589">class_to_size</span><span class="op" id="1586602">[</span><span class="ident" id="1586603">size_to_class8</span><span class="op" id="1586617">[</span><span class="op" id="1586618">(</span><span class="ident" id="1586619">size</span><span class="op" id="1586623">+</span><span class="num" id="1586624">7</span><span class="op" id="1586625">)</span><span class="op" id="1586626">&gt;&gt;</span><span class="num" id="1586628">3</span><span class="op" id="1586629">]</span><span class="op" id="1586630">]</span><span class="op" id="1586631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586635">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586639">return</span>&nbsp;<span class="builtintype" id="1586646">uintptr</span><span class="op" id="1586653">(</span><span class="ident" id="1586654">class_to_size</span><span class="op" id="1586667">[</span><span class="ident" id="1586668">size_to_class128</span><span class="op" id="1586684">[</span><span class="op" id="1586685">(</span><span class="ident" id="1586686">size</span><span class="op" id="1586690">-</span><span class="num" id="1586691">1024</span><span class="op" id="1586695">+</span><span class="num" id="1586696">127</span><span class="op" id="1586699">)</span><span class="op" id="1586700">&gt;&gt;</span><span class="num" id="1586702">7</span><span class="op" id="1586703">]</span><span class="op" id="1586704">]</span><span class="op" id="1586705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586711">if</span>&nbsp;<span class="ident" id="1586714">size</span><span class="op" id="1586718">+</span><span class="ident" id="1586719">pageSize</span>&nbsp;<span class="op" id="1586728">&lt;</span>&nbsp;<span class="ident" id="1586730">size</span>&nbsp;<span class="op" id="1586735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586739">return</span>&nbsp;<span class="ident" id="1586746">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586752">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586755">return</span>&nbsp;<span class="op" id="1586762">(</span><span class="ident" id="1586763">size</span>&nbsp;<span class="op" id="1586768">+</span>&nbsp;<span class="ident" id="1586770">pageSize</span>&nbsp;<span class="op" id="1586779">-</span>&nbsp;<span class="num" id="1586781">1</span><span class="op" id="1586782">)</span>&nbsp;<span class="op" id="1586784">&amp;^</span>&nbsp;<span class="ident" id="1586787">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1586796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1586799">func</span>&nbsp;<span class="ident" id="1586804">profilealloc</span><span class="op" id="1586816">(</span><span class="ident" id="1586817">mp</span>&nbsp;<span class="op" id="1586820">*</span><span class="ident" id="1586821">m</span><span class="op" id="1586822">,</span>&nbsp;<span class="ident" id="1586824">x</span>&nbsp;<span class="ident" id="1586826">unsafe</span><span class="op" id="1586832">.</span><span class="ident" id="1586833">Pointer</span><span class="op" id="1586840">,</span>&nbsp;<span class="ident" id="1586842">size</span>&nbsp;<span class="builtintype" id="1586847">uintptr</span><span class="op" id="1586854">)</span>&nbsp;<span class="op" id="1586856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586859">c</span>&nbsp;<span class="op" id="1586861">:=</span>&nbsp;<span class="ident" id="1586864">mp</span><span class="op" id="1586866">.</span><span class="ident" id="1586867">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586875">rate</span>&nbsp;<span class="op" id="1586880">:=</span>&nbsp;<span class="ident" id="1586883">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586899">if</span>&nbsp;<span class="ident" id="1586902">size</span>&nbsp;<span class="op" id="1586907">&lt;</span>&nbsp;<span class="builtintype" id="1586909">uintptr</span><span class="op" id="1586916">(</span><span class="ident" id="1586917">rate</span><span class="op" id="1586921">)</span>&nbsp;<span class="op" id="1586923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586927">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586955">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587005">if</span>&nbsp;<span class="ident" id="1587008">rate</span>&nbsp;<span class="op" id="1587013">&gt;</span>&nbsp;<span class="num" id="1587015">0x3fffffff</span>&nbsp;<span class="op" id="1587026">{</span>&nbsp;<span class="comment" id="1587028">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587059">rate</span>&nbsp;<span class="op" id="1587064">=</span>&nbsp;<span class="num" id="1587066">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587083">next</span>&nbsp;<span class="op" id="1587088">:=</span>&nbsp;<span class="builtintype" id="1587091">int32</span><span class="op" id="1587096">(</span><span class="ident" id="1587097">fastrand1</span><span class="op" id="1587106">(</span><span class="op" id="1587107">)</span><span class="op" id="1587108">)</span>&nbsp;<span class="op" id="1587110">%</span>&nbsp;<span class="op" id="1587112">(</span><span class="num" id="1587113">2</span>&nbsp;<span class="op" id="1587115">*</span>&nbsp;<span class="builtintype" id="1587117">int32</span><span class="op" id="1587122">(</span><span class="ident" id="1587123">rate</span><span class="op" id="1587127">)</span><span class="op" id="1587128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587132">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587189">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587252">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587328">next</span>&nbsp;<span class="op" id="1587333">-=</span>&nbsp;<span class="op" id="1587336">(</span><span class="builtintype" id="1587337">int32</span><span class="op" id="1587342">(</span><span class="ident" id="1587343">size</span><span class="op" id="1587347">)</span>&nbsp;<span class="op" id="1587349">-</span>&nbsp;<span class="ident" id="1587351">c</span><span class="op" id="1587352">.</span><span class="ident" id="1587353">next_sample</span><span class="op" id="1587364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587368">if</span>&nbsp;<span class="ident" id="1587371">next</span>&nbsp;<span class="op" id="1587376">&lt;</span>&nbsp;<span class="num" id="1587378">0</span>&nbsp;<span class="op" id="1587380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587385">next</span>&nbsp;<span class="op" id="1587390">=</span>&nbsp;<span class="num" id="1587392">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587396">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587400">c</span><span class="op" id="1587401">.</span><span class="ident" id="1587402">next_sample</span>&nbsp;<span class="op" id="1587414">=</span>&nbsp;<span class="ident" id="1587416">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587426">mProf_Malloc</span><span class="op" id="1587438">(</span><span class="ident" id="1587439">x</span><span class="op" id="1587440">,</span>&nbsp;<span class="ident" id="1587442">size</span><span class="op" id="1587446">)</span><br>
<span class="lineno"></span><span class="op" id="1587448">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1587451">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1587505">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1587542">func</span>&nbsp;<span class="ident" id="1587547">gogc</span><span class="op" id="1587551">(</span><span class="ident" id="1587552">force</span>&nbsp;<span class="builtintype" id="1587558">int32</span><span class="op" id="1587563">)</span>&nbsp;<span class="op" id="1587565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587568">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587643">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587723">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587795">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587871">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587899">mp</span>&nbsp;<span class="op" id="1587902">:=</span>&nbsp;<span class="ident" id="1587905">acquirem</span><span class="op" id="1587913">(</span><span class="op" id="1587914">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587917">if</span>&nbsp;<span class="ident" id="1587920">gp</span>&nbsp;<span class="op" id="1587923">:=</span>&nbsp;<span class="ident" id="1587926">getg</span><span class="op" id="1587930">(</span><span class="op" id="1587931">)</span><span class="op" id="1587932">;</span>&nbsp;<span class="ident" id="1587934">gp</span>&nbsp;<span class="op" id="1587937">==</span>&nbsp;<span class="ident" id="1587940">mp</span><span class="op" id="1587942">.</span><span class="ident" id="1587943">g0</span>&nbsp;<span class="op" id="1587946">||</span>&nbsp;<span class="ident" id="1587949">mp</span><span class="op" id="1587951">.</span><span class="ident" id="1587952">locks</span>&nbsp;<span class="op" id="1587958">&gt;</span>&nbsp;<span class="num" id="1587960">1</span>&nbsp;<span class="op" id="1587962">||</span>&nbsp;<span class="op" id="1587965">!</span><span class="ident" id="1587966">memstats</span><span class="op" id="1587974">.</span><span class="ident" id="1587975">enablegc</span>&nbsp;<span class="op" id="1587984">||</span>&nbsp;<span class="ident" id="1587987">panicking</span>&nbsp;<span class="op" id="1587997">!=</span>&nbsp;<span class="num" id="1588000">0</span>&nbsp;<span class="op" id="1588002">||</span>&nbsp;<span class="ident" id="1588005">gcpercent</span>&nbsp;<span class="op" id="1588015">&lt;</span>&nbsp;<span class="num" id="1588017">0</span>&nbsp;<span class="op" id="1588019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588023">releasem</span><span class="op" id="1588031">(</span><span class="ident" id="1588032">mp</span><span class="op" id="1588034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588038">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588049">releasem</span><span class="op" id="1588057">(</span><span class="ident" id="1588058">mp</span><span class="op" id="1588060">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588063">mp</span>&nbsp;<span class="op" id="1588066">=</span>&nbsp;<span class="ident" id="1588068">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588074">semacquire</span><span class="op" id="1588084">(</span><span class="op" id="1588085">&amp;</span><span class="ident" id="1588086">worldsema</span><span class="op" id="1588095">,</span>&nbsp;<span class="ident" id="1588097">false</span><span class="op" id="1588102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588106">if</span>&nbsp;<span class="ident" id="1588109">force</span>&nbsp;<span class="op" id="1588115">==</span>&nbsp;<span class="num" id="1588118">0</span>&nbsp;<span class="op" id="1588120">&amp;&amp;</span>&nbsp;<span class="ident" id="1588123">memstats</span><span class="op" id="1588131">.</span><span class="ident" id="1588132">heap_alloc</span>&nbsp;<span class="op" id="1588143">&lt;</span>&nbsp;<span class="ident" id="1588145">memstats</span><span class="op" id="1588153">.</span><span class="ident" id="1588154">next_gc</span>&nbsp;<span class="op" id="1588162">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588166">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588217">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588259">semrelease</span><span class="op" id="1588269">(</span><span class="op" id="1588270">&amp;</span><span class="ident" id="1588271">worldsema</span><span class="op" id="1588280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588284">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588292">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588296">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588341">startTime</span>&nbsp;<span class="op" id="1588351">:=</span>&nbsp;<span class="ident" id="1588354">nanotime</span><span class="op" id="1588362">(</span><span class="op" id="1588363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588366">mp</span>&nbsp;<span class="op" id="1588369">=</span>&nbsp;<span class="ident" id="1588371">acquirem</span><span class="op" id="1588379">(</span><span class="op" id="1588380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588383">mp</span><span class="op" id="1588385">.</span><span class="ident" id="1588386">gcing</span>&nbsp;<span class="op" id="1588392">=</span>&nbsp;<span class="num" id="1588394">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588397">releasem</span><span class="op" id="1588405">(</span><span class="ident" id="1588406">mp</span><span class="op" id="1588408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588411">onM</span><span class="op" id="1588414">(</span><span class="ident" id="1588415">stoptheworld</span><span class="op" id="1588427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588430">if</span>&nbsp;<span class="ident" id="1588433">mp</span>&nbsp;<span class="op" id="1588436">!=</span>&nbsp;<span class="ident" id="1588439">acquirem</span><span class="op" id="1588447">(</span><span class="op" id="1588448">)</span>&nbsp;<span class="op" id="1588450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588454">gothrow</span><span class="op" id="1588461">(</span><span class="string" id="1588462">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1588481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588484">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588488">clearpools</span><span class="op" id="1588498">(</span><span class="op" id="1588499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588503">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588563">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588623">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588683">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588740">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588793">n</span>&nbsp;<span class="op" id="1588795">:=</span>&nbsp;<span class="num" id="1588798">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588801">if</span>&nbsp;<span class="ident" id="1588804">debug</span><span class="op" id="1588809">.</span><span class="ident" id="1588810">gctrace</span>&nbsp;<span class="op" id="1588818">&gt;</span>&nbsp;<span class="num" id="1588820">1</span>&nbsp;<span class="op" id="1588822">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588826">n</span>&nbsp;<span class="op" id="1588828">=</span>&nbsp;<span class="num" id="1588830">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588836">for</span>&nbsp;<span class="ident" id="1588840">i</span>&nbsp;<span class="op" id="1588842">:=</span>&nbsp;<span class="num" id="1588845">0</span><span class="op" id="1588846">;</span>&nbsp;<span class="ident" id="1588848">i</span>&nbsp;<span class="op" id="1588850">&lt;</span>&nbsp;<span class="ident" id="1588852">n</span><span class="op" id="1588853">;</span>&nbsp;<span class="ident" id="1588855">i</span><span class="op" id="1588856">++</span>&nbsp;<span class="op" id="1588859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588863">if</span>&nbsp;<span class="ident" id="1588866">i</span>&nbsp;<span class="op" id="1588868">&gt;</span>&nbsp;<span class="num" id="1588870">0</span>&nbsp;<span class="op" id="1588872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588877">startTime</span>&nbsp;<span class="op" id="1588887">=</span>&nbsp;<span class="ident" id="1588889">nanotime</span><span class="op" id="1588897">(</span><span class="op" id="1588898">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588906">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588951">mp</span><span class="op" id="1588953">.</span><span class="ident" id="1588954">scalararg</span><span class="op" id="1588963">[</span><span class="num" id="1588964">0</span><span class="op" id="1588965">]</span>&nbsp;<span class="op" id="1588967">=</span>&nbsp;<span class="builtintype" id="1588969">uintptr</span><span class="op" id="1588976">(</span><span class="builtintype" id="1588977">uint32</span><span class="op" id="1588983">(</span><span class="ident" id="1588984">startTime</span><span class="op" id="1588993">)</span><span class="op" id="1588994">)</span>&nbsp;<span class="comment" id="1588996">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589013">mp</span><span class="op" id="1589015">.</span><span class="ident" id="1589016">scalararg</span><span class="op" id="1589025">[</span><span class="num" id="1589026">1</span><span class="op" id="1589027">]</span>&nbsp;<span class="op" id="1589029">=</span>&nbsp;<span class="builtintype" id="1589031">uintptr</span><span class="op" id="1589038">(</span><span class="ident" id="1589039">startTime</span>&nbsp;<span class="op" id="1589049">&gt;&gt;</span>&nbsp;<span class="num" id="1589052">32</span><span class="op" id="1589054">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1589058">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589076">if</span>&nbsp;<span class="ident" id="1589079">force</span>&nbsp;<span class="op" id="1589085">&gt;=</span>&nbsp;<span class="num" id="1589088">2</span>&nbsp;<span class="op" id="1589090">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589095">mp</span><span class="op" id="1589097">.</span><span class="ident" id="1589098">scalararg</span><span class="op" id="1589107">[</span><span class="num" id="1589108">2</span><span class="op" id="1589109">]</span>&nbsp;<span class="op" id="1589111">=</span>&nbsp;<span class="num" id="1589113">1</span>&nbsp;<span class="comment" id="1589115">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589131">}</span>&nbsp;<span class="keyword" id="1589133">else</span>&nbsp;<span class="op" id="1589138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589143">mp</span><span class="op" id="1589145">.</span><span class="ident" id="1589146">scalararg</span><span class="op" id="1589155">[</span><span class="num" id="1589156">2</span><span class="op" id="1589157">]</span>&nbsp;<span class="op" id="1589159">=</span>&nbsp;<span class="num" id="1589161">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589169">onM</span><span class="op" id="1589172">(</span><span class="ident" id="1589173">gc_m</span><span class="op" id="1589177">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589184">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589197">mp</span><span class="op" id="1589199">.</span><span class="ident" id="1589200">gcing</span>&nbsp;<span class="op" id="1589206">=</span>&nbsp;<span class="num" id="1589208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589211">semrelease</span><span class="op" id="1589221">(</span><span class="op" id="1589222">&amp;</span><span class="ident" id="1589223">worldsema</span><span class="op" id="1589232">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589235">onM</span><span class="op" id="1589238">(</span><span class="ident" id="1589239">starttheworld</span><span class="op" id="1589252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589255">releasem</span><span class="op" id="1589263">(</span><span class="ident" id="1589264">mp</span><span class="op" id="1589266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589269">mp</span>&nbsp;<span class="op" id="1589272">=</span>&nbsp;<span class="ident" id="1589274">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589280">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589341">if</span>&nbsp;<span class="op" id="1589344">!</span><span class="ident" id="1589345">concurrentSweep</span>&nbsp;<span class="op" id="1589361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589365">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589422">Gosched</span><span class="op" id="1589429">(</span><span class="op" id="1589430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589433">}</span><br>
<span class="lineno"></span><span class="op" id="1589435">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1589438">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1589471">func</span>&nbsp;<span class="ident" id="1589476">GC</span><span class="op" id="1589478">(</span><span class="op" id="1589479">)</span>&nbsp;<span class="op" id="1589481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589484">gogc</span><span class="op" id="1589488">(</span><span class="num" id="1589489">2</span><span class="op" id="1589490">)</span><br>
<span class="lineno"></span><span class="op" id="1589492">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1589495">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1589514">var</span>&nbsp;<span class="ident" id="1589518">noptrdata</span>&nbsp;<span class="keyword" id="1589528">struct</span><span class="op" id="1589534">{</span><span class="op" id="1589535">}</span><br>
<span class="lineno"></span><span class="keyword" id="1589537">var</span>&nbsp;<span class="ident" id="1589541">enoptrdata</span>&nbsp;<span class="keyword" id="1589552">struct</span><span class="op" id="1589558">{</span><span class="op" id="1589559">}</span><br>
<span class="lineno"></span><span class="keyword" id="1589561">var</span>&nbsp;<span class="ident" id="1589565">noptrbss</span>&nbsp;<span class="keyword" id="1589574">struct</span><span class="op" id="1589580">{</span><span class="op" id="1589581">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1589583">var</span>&nbsp;<span class="ident" id="1589587">enoptrbss</span>&nbsp;<span class="keyword" id="1589597">struct</span><span class="op" id="1589603">{</span><span class="op" id="1589604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1589607">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1589666">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1589723">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1589791">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1589859">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1589927">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1589992">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1590034">//</span><br>
<span class="lineno">505</span><span class="comment" id="1590037">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1590101">//</span><br>
<span class="lineno"></span><span class="comment" id="1590104">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1590166">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1590230">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1590296">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1590372">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1590439">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1590451">//</span><br>
<span class="lineno"></span><span class="comment" id="1590454">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1590525">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1590595">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1590656">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1590721">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1590790">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1590853">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1590883">//</span><br>
<span class="lineno"></span><span class="comment" id="1590886">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1590958">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1590984">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1591058">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1591130">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1591190">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1591259">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1591330">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1591393">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1591464">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1591538">//</span><br>
<span class="lineno"></span><span class="comment" id="1591541">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1591612">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1591627">//</span><br>
<span class="lineno"></span><span class="comment" id="1591630">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1591702">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1591770">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1591811">//</span><br>
<span class="lineno">540</span><span class="comment" id="1591814">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1591885">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1591957">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1591977">func</span>&nbsp;<span class="ident" id="1591982">SetFinalizer</span><span class="op" id="1591994">(</span><span class="ident" id="1591995">obj</span>&nbsp;<span class="keyword" id="1591999">interface</span><span class="op" id="1592008">{</span><span class="op" id="1592009">}</span><span class="op" id="1592010">,</span>&nbsp;<span class="ident" id="1592012">finalizer</span>&nbsp;<span class="keyword" id="1592022">interface</span><span class="op" id="1592031">{</span><span class="op" id="1592032">}</span><span class="op" id="1592033">)</span>&nbsp;<span class="op" id="1592035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592038">e</span>&nbsp;<span class="op" id="1592040">:=</span>&nbsp;<span class="op" id="1592043">(</span><span class="op" id="1592044">*</span><span class="ident" id="1592045">eface</span><span class="op" id="1592050">)</span><span class="op" id="1592051">(</span><span class="ident" id="1592052">unsafe</span><span class="op" id="1592058">.</span><span class="ident" id="1592059">Pointer</span><span class="op" id="1592066">(</span><span class="op" id="1592067">&amp;</span><span class="ident" id="1592068">obj</span><span class="op" id="1592071">)</span><span class="op" id="1592072">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592075">etyp</span>&nbsp;<span class="op" id="1592080">:=</span>&nbsp;<span class="ident" id="1592083">e</span><span class="op" id="1592084">.</span><span class="ident" id="1592085">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592092">if</span>&nbsp;<span class="ident" id="1592095">etyp</span>&nbsp;<span class="op" id="1592100">==</span>&nbsp;<span class="ident" id="1592103">nil</span>&nbsp;<span class="op" id="1592107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592111">gothrow</span><span class="op" id="1592118">(</span><span class="string" id="1592119">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1592164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592170">if</span>&nbsp;<span class="ident" id="1592173">etyp</span><span class="op" id="1592177">.</span><span class="ident" id="1592178">kind</span><span class="op" id="1592182">&amp;</span><span class="ident" id="1592183">kindMask</span>&nbsp;<span class="op" id="1592192">!=</span>&nbsp;<span class="ident" id="1592195">kindPtr</span>&nbsp;<span class="op" id="1592203">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592207">gothrow</span><span class="op" id="1592214">(</span><span class="string" id="1592215">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1592258">+</span>&nbsp;<span class="op" id="1592260">*</span><span class="ident" id="1592261">etyp</span><span class="op" id="1592265">.</span><span class="ident" id="1592266">_string</span>&nbsp;<span class="op" id="1592274">+</span>&nbsp;<span class="string" id="1592276">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1592291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592297">ot</span>&nbsp;<span class="op" id="1592300">:=</span>&nbsp;<span class="op" id="1592303">(</span><span class="op" id="1592304">*</span><span class="ident" id="1592305">ptrtype</span><span class="op" id="1592312">)</span><span class="op" id="1592313">(</span><span class="ident" id="1592314">unsafe</span><span class="op" id="1592320">.</span><span class="ident" id="1592321">Pointer</span><span class="op" id="1592328">(</span><span class="ident" id="1592329">etyp</span><span class="op" id="1592333">)</span><span class="op" id="1592334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592337">if</span>&nbsp;<span class="ident" id="1592340">ot</span><span class="op" id="1592342">.</span><span class="ident" id="1592343">elem</span>&nbsp;<span class="op" id="1592348">==</span>&nbsp;<span class="ident" id="1592351">nil</span>&nbsp;<span class="op" id="1592355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592359">gothrow</span><span class="op" id="1592366">(</span><span class="string" id="1592367">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1592383">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592390">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592421">_</span><span class="op" id="1592422">,</span>&nbsp;<span class="ident" id="1592424">base</span><span class="op" id="1592428">,</span>&nbsp;<span class="ident" id="1592430">_</span>&nbsp;<span class="op" id="1592432">:=</span>&nbsp;<span class="ident" id="1592435">findObject</span><span class="op" id="1592445">(</span><span class="ident" id="1592446">e</span><span class="op" id="1592447">.</span><span class="ident" id="1592448">data</span><span class="op" id="1592452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592456">if</span>&nbsp;<span class="ident" id="1592459">base</span>&nbsp;<span class="op" id="1592464">==</span>&nbsp;<span class="ident" id="1592467">nil</span>&nbsp;<span class="op" id="1592471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592475">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592507">if</span>&nbsp;<span class="ident" id="1592510">e</span><span class="op" id="1592511">.</span><span class="ident" id="1592512">data</span>&nbsp;<span class="op" id="1592517">==</span>&nbsp;<span class="ident" id="1592520">unsafe</span><span class="op" id="1592526">.</span><span class="ident" id="1592527">Pointer</span><span class="op" id="1592534">(</span><span class="op" id="1592535">&amp;</span><span class="ident" id="1592536">zerobase</span><span class="op" id="1592544">)</span>&nbsp;<span class="op" id="1592546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592551">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592560">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592565">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592617">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592642">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592661">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592698">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592705">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592769">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592833">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592863">if</span>&nbsp;<span class="builtintype" id="1592866">uintptr</span><span class="op" id="1592873">(</span><span class="ident" id="1592874">unsafe</span><span class="op" id="1592880">.</span><span class="ident" id="1592881">Pointer</span><span class="op" id="1592888">(</span><span class="op" id="1592889">&amp;</span><span class="ident" id="1592890">noptrdata</span><span class="op" id="1592899">)</span><span class="op" id="1592900">)</span>&nbsp;<span class="op" id="1592902">&lt;=</span>&nbsp;<span class="builtintype" id="1592905">uintptr</span><span class="op" id="1592912">(</span><span class="ident" id="1592913">e</span><span class="op" id="1592914">.</span><span class="ident" id="1592915">data</span><span class="op" id="1592919">)</span>&nbsp;<span class="op" id="1592921">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1592924">uintptr</span><span class="op" id="1592931">(</span><span class="ident" id="1592932">e</span><span class="op" id="1592933">.</span><span class="ident" id="1592934">data</span><span class="op" id="1592938">)</span>&nbsp;<span class="op" id="1592940">&lt;</span>&nbsp;<span class="builtintype" id="1592942">uintptr</span><span class="op" id="1592949">(</span><span class="ident" id="1592950">unsafe</span><span class="op" id="1592956">.</span><span class="ident" id="1592957">Pointer</span><span class="op" id="1592964">(</span><span class="op" id="1592965">&amp;</span><span class="ident" id="1592966">enoptrdata</span><span class="op" id="1592976">)</span><span class="op" id="1592977">)</span>&nbsp;<span class="op" id="1592979">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1592985">uintptr</span><span class="op" id="1592992">(</span><span class="ident" id="1592993">unsafe</span><span class="op" id="1592999">.</span><span class="ident" id="1593000">Pointer</span><span class="op" id="1593007">(</span><span class="op" id="1593008">&amp;</span><span class="ident" id="1593009">data</span><span class="op" id="1593013">)</span><span class="op" id="1593014">)</span>&nbsp;<span class="op" id="1593016">&lt;=</span>&nbsp;<span class="builtintype" id="1593019">uintptr</span><span class="op" id="1593026">(</span><span class="ident" id="1593027">e</span><span class="op" id="1593028">.</span><span class="ident" id="1593029">data</span><span class="op" id="1593033">)</span>&nbsp;<span class="op" id="1593035">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1593038">uintptr</span><span class="op" id="1593045">(</span><span class="ident" id="1593046">e</span><span class="op" id="1593047">.</span><span class="ident" id="1593048">data</span><span class="op" id="1593052">)</span>&nbsp;<span class="op" id="1593054">&lt;</span>&nbsp;<span class="builtintype" id="1593056">uintptr</span><span class="op" id="1593063">(</span><span class="ident" id="1593064">unsafe</span><span class="op" id="1593070">.</span><span class="ident" id="1593071">Pointer</span><span class="op" id="1593078">(</span><span class="op" id="1593079">&amp;</span><span class="ident" id="1593080">edata</span><span class="op" id="1593085">)</span><span class="op" id="1593086">)</span>&nbsp;<span class="op" id="1593088">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1593094">uintptr</span><span class="op" id="1593101">(</span><span class="ident" id="1593102">unsafe</span><span class="op" id="1593108">.</span><span class="ident" id="1593109">Pointer</span><span class="op" id="1593116">(</span><span class="op" id="1593117">&amp;</span><span class="ident" id="1593118">bss</span><span class="op" id="1593121">)</span><span class="op" id="1593122">)</span>&nbsp;<span class="op" id="1593124">&lt;=</span>&nbsp;<span class="builtintype" id="1593127">uintptr</span><span class="op" id="1593134">(</span><span class="ident" id="1593135">e</span><span class="op" id="1593136">.</span><span class="ident" id="1593137">data</span><span class="op" id="1593141">)</span>&nbsp;<span class="op" id="1593143">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1593146">uintptr</span><span class="op" id="1593153">(</span><span class="ident" id="1593154">e</span><span class="op" id="1593155">.</span><span class="ident" id="1593156">data</span><span class="op" id="1593160">)</span>&nbsp;<span class="op" id="1593162">&lt;</span>&nbsp;<span class="builtintype" id="1593164">uintptr</span><span class="op" id="1593171">(</span><span class="ident" id="1593172">unsafe</span><span class="op" id="1593178">.</span><span class="ident" id="1593179">Pointer</span><span class="op" id="1593186">(</span><span class="op" id="1593187">&amp;</span><span class="ident" id="1593188">ebss</span><span class="op" id="1593192">)</span><span class="op" id="1593193">)</span>&nbsp;<span class="op" id="1593195">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1593201">uintptr</span><span class="op" id="1593208">(</span><span class="ident" id="1593209">unsafe</span><span class="op" id="1593215">.</span><span class="ident" id="1593216">Pointer</span><span class="op" id="1593223">(</span><span class="op" id="1593224">&amp;</span><span class="ident" id="1593225">noptrbss</span><span class="op" id="1593233">)</span><span class="op" id="1593234">)</span>&nbsp;<span class="op" id="1593236">&lt;=</span>&nbsp;<span class="builtintype" id="1593239">uintptr</span><span class="op" id="1593246">(</span><span class="ident" id="1593247">e</span><span class="op" id="1593248">.</span><span class="ident" id="1593249">data</span><span class="op" id="1593253">)</span>&nbsp;<span class="op" id="1593255">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1593258">uintptr</span><span class="op" id="1593265">(</span><span class="ident" id="1593266">e</span><span class="op" id="1593267">.</span><span class="ident" id="1593268">data</span><span class="op" id="1593272">)</span>&nbsp;<span class="op" id="1593274">&lt;</span>&nbsp;<span class="builtintype" id="1593276">uintptr</span><span class="op" id="1593283">(</span><span class="ident" id="1593284">unsafe</span><span class="op" id="1593290">.</span><span class="ident" id="1593291">Pointer</span><span class="op" id="1593298">(</span><span class="op" id="1593299">&amp;</span><span class="ident" id="1593300">enoptrbss</span><span class="op" id="1593309">)</span><span class="op" id="1593310">)</span>&nbsp;<span class="op" id="1593312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593317">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593326">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593330">gothrow</span><span class="op" id="1593337">(</span><span class="string" id="1593338">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1593392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593399">if</span>&nbsp;<span class="ident" id="1593402">e</span><span class="op" id="1593403">.</span><span class="ident" id="1593404">data</span>&nbsp;<span class="op" id="1593409">!=</span>&nbsp;<span class="ident" id="1593412">base</span>&nbsp;<span class="op" id="1593417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593421">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593499">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593578">if</span>&nbsp;<span class="ident" id="1593581">ot</span><span class="op" id="1593583">.</span><span class="ident" id="1593584">elem</span>&nbsp;<span class="op" id="1593589">==</span>&nbsp;<span class="ident" id="1593592">nil</span>&nbsp;<span class="op" id="1593596">||</span>&nbsp;<span class="ident" id="1593599">ot</span><span class="op" id="1593601">.</span><span class="ident" id="1593602">elem</span><span class="op" id="1593606">.</span><span class="ident" id="1593607">kind</span><span class="op" id="1593611">&amp;</span><span class="ident" id="1593612">kindNoPointers</span>&nbsp;<span class="op" id="1593627">==</span>&nbsp;<span class="num" id="1593630">0</span>&nbsp;<span class="op" id="1593632">||</span>&nbsp;<span class="ident" id="1593635">ot</span><span class="op" id="1593637">.</span><span class="ident" id="1593638">elem</span><span class="op" id="1593642">.</span><span class="ident" id="1593643">size</span>&nbsp;<span class="op" id="1593648">&gt;=</span>&nbsp;<span class="ident" id="1593651">maxTinySize</span>&nbsp;<span class="op" id="1593663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593668">gothrow</span><span class="op" id="1593675">(</span><span class="string" id="1593676">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1593743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593750">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593754">f</span>&nbsp;<span class="op" id="1593756">:=</span>&nbsp;<span class="op" id="1593759">(</span><span class="op" id="1593760">*</span><span class="ident" id="1593761">eface</span><span class="op" id="1593766">)</span><span class="op" id="1593767">(</span><span class="ident" id="1593768">unsafe</span><span class="op" id="1593774">.</span><span class="ident" id="1593775">Pointer</span><span class="op" id="1593782">(</span><span class="op" id="1593783">&amp;</span><span class="ident" id="1593784">finalizer</span><span class="op" id="1593793">)</span><span class="op" id="1593794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593797">ftyp</span>&nbsp;<span class="op" id="1593802">:=</span>&nbsp;<span class="ident" id="1593805">f</span><span class="op" id="1593806">.</span><span class="ident" id="1593807">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593814">if</span>&nbsp;<span class="ident" id="1593817">ftyp</span>&nbsp;<span class="op" id="1593822">==</span>&nbsp;<span class="ident" id="1593825">nil</span>&nbsp;<span class="op" id="1593829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593833">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593877">mp</span>&nbsp;<span class="op" id="1593880">:=</span>&nbsp;<span class="ident" id="1593883">acquirem</span><span class="op" id="1593891">(</span><span class="op" id="1593892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593896">mp</span><span class="op" id="1593898">.</span><span class="ident" id="1593899">ptrarg</span><span class="op" id="1593905">[</span><span class="num" id="1593906">0</span><span class="op" id="1593907">]</span>&nbsp;<span class="op" id="1593909">=</span>&nbsp;<span class="ident" id="1593911">e</span><span class="op" id="1593912">.</span><span class="ident" id="1593913">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593920">onM</span><span class="op" id="1593923">(</span><span class="ident" id="1593924">removeFinalizer_m</span><span class="op" id="1593941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593945">releasem</span><span class="op" id="1593953">(</span><span class="ident" id="1593954">mp</span><span class="op" id="1593956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593960">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593972">if</span>&nbsp;<span class="ident" id="1593975">ftyp</span><span class="op" id="1593979">.</span><span class="ident" id="1593980">kind</span><span class="op" id="1593984">&amp;</span><span class="ident" id="1593985">kindMask</span>&nbsp;<span class="op" id="1593994">!=</span>&nbsp;<span class="ident" id="1593997">kindFunc</span>&nbsp;<span class="op" id="1594006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594010">gothrow</span><span class="op" id="1594017">(</span><span class="string" id="1594018">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1594062">+</span>&nbsp;<span class="op" id="1594064">*</span><span class="ident" id="1594065">ftyp</span><span class="op" id="1594069">.</span><span class="ident" id="1594070">_string</span>&nbsp;<span class="op" id="1594078">+</span>&nbsp;<span class="string" id="1594080">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1594098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594101">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594104">ft</span>&nbsp;<span class="op" id="1594107">:=</span>&nbsp;<span class="op" id="1594110">(</span><span class="op" id="1594111">*</span><span class="ident" id="1594112">functype</span><span class="op" id="1594120">)</span><span class="op" id="1594121">(</span><span class="ident" id="1594122">unsafe</span><span class="op" id="1594128">.</span><span class="ident" id="1594129">Pointer</span><span class="op" id="1594136">(</span><span class="ident" id="1594137">ftyp</span><span class="op" id="1594141">)</span><span class="op" id="1594142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594145">ins</span>&nbsp;<span class="op" id="1594149">:=</span>&nbsp;<span class="op" id="1594152">*</span><span class="op" id="1594153">(</span><span class="op" id="1594154">*</span><span class="op" id="1594155">[</span><span class="op" id="1594156">]</span><span class="op" id="1594157">*</span><span class="ident" id="1594158">_type</span><span class="op" id="1594163">)</span><span class="op" id="1594164">(</span><span class="ident" id="1594165">unsafe</span><span class="op" id="1594171">.</span><span class="ident" id="1594172">Pointer</span><span class="op" id="1594179">(</span><span class="op" id="1594180">&amp;</span><span class="ident" id="1594181">ft</span><span class="op" id="1594183">.</span><span class="ident" id="1594184">in</span><span class="op" id="1594186">)</span><span class="op" id="1594187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594190">if</span>&nbsp;<span class="ident" id="1594193">ft</span><span class="op" id="1594195">.</span><span class="ident" id="1594196">dotdotdot</span>&nbsp;<span class="op" id="1594206">||</span>&nbsp;<span class="builtinfunc" id="1594209">len</span><span class="op" id="1594212">(</span><span class="ident" id="1594213">ins</span><span class="op" id="1594216">)</span>&nbsp;<span class="op" id="1594218">!=</span>&nbsp;<span class="num" id="1594221">1</span>&nbsp;<span class="op" id="1594223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594227">gothrow</span><span class="op" id="1594234">(</span><span class="string" id="1594235">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1594272">+</span>&nbsp;<span class="op" id="1594274">*</span><span class="ident" id="1594275">etyp</span><span class="op" id="1594279">.</span><span class="ident" id="1594280">_string</span>&nbsp;<span class="op" id="1594288">+</span>&nbsp;<span class="string" id="1594290">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1594307">+</span>&nbsp;<span class="op" id="1594309">*</span><span class="ident" id="1594310">ftyp</span><span class="op" id="1594314">.</span><span class="ident" id="1594315">_string</span><span class="op" id="1594322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594325">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594328">fint</span>&nbsp;<span class="op" id="1594333">:=</span>&nbsp;<span class="ident" id="1594336">ins</span><span class="op" id="1594339">[</span><span class="num" id="1594340">0</span><span class="op" id="1594341">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594344">switch</span>&nbsp;<span class="op" id="1594351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594354">case</span>&nbsp;<span class="ident" id="1594359">fint</span>&nbsp;<span class="op" id="1594364">==</span>&nbsp;<span class="ident" id="1594367">etyp</span><span class="op" id="1594371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594375">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594395">goto</span>&nbsp;<span class="ident" id="1594400">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594407">case</span>&nbsp;<span class="ident" id="1594412">fint</span><span class="op" id="1594416">.</span><span class="ident" id="1594417">kind</span><span class="op" id="1594421">&amp;</span><span class="ident" id="1594422">kindMask</span>&nbsp;<span class="op" id="1594431">==</span>&nbsp;<span class="ident" id="1594434">kindPtr</span><span class="op" id="1594441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594445">if</span>&nbsp;<span class="op" id="1594448">(</span><span class="ident" id="1594449">fint</span><span class="op" id="1594453">.</span><span class="ident" id="1594454">x</span>&nbsp;<span class="op" id="1594456">==</span>&nbsp;<span class="ident" id="1594459">nil</span>&nbsp;<span class="op" id="1594463">||</span>&nbsp;<span class="ident" id="1594466">fint</span><span class="op" id="1594470">.</span><span class="ident" id="1594471">x</span><span class="op" id="1594472">.</span><span class="ident" id="1594473">name</span>&nbsp;<span class="op" id="1594478">==</span>&nbsp;<span class="ident" id="1594481">nil</span>&nbsp;<span class="op" id="1594485">||</span>&nbsp;<span class="ident" id="1594488">etyp</span><span class="op" id="1594492">.</span><span class="ident" id="1594493">x</span>&nbsp;<span class="op" id="1594495">==</span>&nbsp;<span class="ident" id="1594498">nil</span>&nbsp;<span class="op" id="1594502">||</span>&nbsp;<span class="ident" id="1594505">etyp</span><span class="op" id="1594509">.</span><span class="ident" id="1594510">x</span><span class="op" id="1594511">.</span><span class="ident" id="1594512">name</span>&nbsp;<span class="op" id="1594517">==</span>&nbsp;<span class="ident" id="1594520">nil</span><span class="op" id="1594523">)</span>&nbsp;<span class="op" id="1594525">&amp;&amp;</span>&nbsp;<span class="op" id="1594528">(</span><span class="op" id="1594529">*</span><span class="ident" id="1594530">ptrtype</span><span class="op" id="1594537">)</span><span class="op" id="1594538">(</span><span class="ident" id="1594539">unsafe</span><span class="op" id="1594545">.</span><span class="ident" id="1594546">Pointer</span><span class="op" id="1594553">(</span><span class="ident" id="1594554">fint</span><span class="op" id="1594558">)</span><span class="op" id="1594559">)</span><span class="op" id="1594560">.</span><span class="ident" id="1594561">elem</span>&nbsp;<span class="op" id="1594566">==</span>&nbsp;<span class="ident" id="1594569">ot</span><span class="op" id="1594571">.</span><span class="ident" id="1594572">elem</span>&nbsp;<span class="op" id="1594577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594582">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594627">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594700">goto</span>&nbsp;<span class="ident" id="1594705">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594716">case</span>&nbsp;<span class="ident" id="1594721">fint</span><span class="op" id="1594725">.</span><span class="ident" id="1594726">kind</span><span class="op" id="1594730">&amp;</span><span class="ident" id="1594731">kindMask</span>&nbsp;<span class="op" id="1594740">==</span>&nbsp;<span class="ident" id="1594743">kindInterface</span><span class="op" id="1594756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594760">ityp</span>&nbsp;<span class="op" id="1594765">:=</span>&nbsp;<span class="op" id="1594768">(</span><span class="op" id="1594769">*</span><span class="ident" id="1594770">interfacetype</span><span class="op" id="1594783">)</span><span class="op" id="1594784">(</span><span class="ident" id="1594785">unsafe</span><span class="op" id="1594791">.</span><span class="ident" id="1594792">Pointer</span><span class="op" id="1594799">(</span><span class="ident" id="1594800">fint</span><span class="op" id="1594804">)</span><span class="op" id="1594805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594809">if</span>&nbsp;<span class="builtinfunc" id="1594812">len</span><span class="op" id="1594815">(</span><span class="ident" id="1594816">ityp</span><span class="op" id="1594820">.</span><span class="ident" id="1594821">mhdr</span><span class="op" id="1594825">)</span>&nbsp;<span class="op" id="1594827">==</span>&nbsp;<span class="num" id="1594830">0</span>&nbsp;<span class="op" id="1594832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594837">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594874">goto</span>&nbsp;<span class="ident" id="1594879">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594891">if</span>&nbsp;<span class="ident" id="1594894">_</span><span class="op" id="1594895">,</span>&nbsp;<span class="ident" id="1594897">ok</span>&nbsp;<span class="op" id="1594900">:=</span>&nbsp;<span class="ident" id="1594903">assertE2I2</span><span class="op" id="1594913">(</span><span class="ident" id="1594914">ityp</span><span class="op" id="1594918">,</span>&nbsp;<span class="ident" id="1594920">obj</span><span class="op" id="1594923">)</span><span class="op" id="1594924">;</span>&nbsp;<span class="ident" id="1594926">ok</span>&nbsp;<span class="op" id="1594929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594934">goto</span>&nbsp;<span class="ident" id="1594939">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594947">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594953">gothrow</span><span class="op" id="1594960">(</span><span class="string" id="1594961">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1594998">+</span>&nbsp;<span class="op" id="1595000">*</span><span class="ident" id="1595001">etyp</span><span class="op" id="1595005">.</span><span class="ident" id="1595006">_string</span>&nbsp;<span class="op" id="1595014">+</span>&nbsp;<span class="string" id="1595016">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1595033">+</span>&nbsp;<span class="op" id="1595035">*</span><span class="ident" id="1595036">ftyp</span><span class="op" id="1595040">.</span><span class="ident" id="1595041">_string</span><span class="op" id="1595048">)</span><br>
<span class="lineno"></span><span class="ident" id="1595050">okarg</span><span class="op" id="1595055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595058">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595104">nret</span>&nbsp;<span class="op" id="1595109">:=</span>&nbsp;<span class="builtintype" id="1595112">uintptr</span><span class="op" id="1595119">(</span><span class="num" id="1595120">0</span><span class="op" id="1595121">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595124">for</span>&nbsp;<span class="ident" id="1595128">_</span><span class="op" id="1595129">,</span>&nbsp;<span class="ident" id="1595131">t</span>&nbsp;<span class="op" id="1595133">:=</span>&nbsp;<span class="keyword" id="1595136">range</span>&nbsp;<span class="op" id="1595142">*</span><span class="op" id="1595143">(</span><span class="op" id="1595144">*</span><span class="op" id="1595145">[</span><span class="op" id="1595146">]</span><span class="op" id="1595147">*</span><span class="ident" id="1595148">_type</span><span class="op" id="1595153">)</span><span class="op" id="1595154">(</span><span class="ident" id="1595155">unsafe</span><span class="op" id="1595161">.</span><span class="ident" id="1595162">Pointer</span><span class="op" id="1595169">(</span><span class="op" id="1595170">&amp;</span><span class="ident" id="1595171">ft</span><span class="op" id="1595173">.</span><span class="ident" id="1595174">out</span><span class="op" id="1595177">)</span><span class="op" id="1595178">)</span>&nbsp;<span class="op" id="1595180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595184">nret</span>&nbsp;<span class="op" id="1595189">=</span>&nbsp;<span class="ident" id="1595191">round</span><span class="op" id="1595196">(</span><span class="ident" id="1595197">nret</span><span class="op" id="1595201">,</span>&nbsp;<span class="builtintype" id="1595203">uintptr</span><span class="op" id="1595210">(</span><span class="ident" id="1595211">t</span><span class="op" id="1595212">.</span><span class="ident" id="1595213">align</span><span class="op" id="1595218">)</span><span class="op" id="1595219">)</span>&nbsp;<span class="op" id="1595221">+</span>&nbsp;<span class="builtintype" id="1595223">uintptr</span><span class="op" id="1595230">(</span><span class="ident" id="1595231">t</span><span class="op" id="1595232">.</span><span class="ident" id="1595233">size</span><span class="op" id="1595237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595243">nret</span>&nbsp;<span class="op" id="1595248">=</span>&nbsp;<span class="ident" id="1595250">round</span><span class="op" id="1595255">(</span><span class="ident" id="1595256">nret</span><span class="op" id="1595260">,</span>&nbsp;<span class="ident" id="1595262">ptrSize</span><span class="op" id="1595269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595273">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595317">createfing</span><span class="op" id="1595327">(</span><span class="op" id="1595328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595332">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595378">mp</span>&nbsp;<span class="op" id="1595381">:=</span>&nbsp;<span class="ident" id="1595384">acquirem</span><span class="op" id="1595392">(</span><span class="op" id="1595393">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595396">mp</span><span class="op" id="1595398">.</span><span class="ident" id="1595399">ptrarg</span><span class="op" id="1595405">[</span><span class="num" id="1595406">0</span><span class="op" id="1595407">]</span>&nbsp;<span class="op" id="1595409">=</span>&nbsp;<span class="ident" id="1595411">f</span><span class="op" id="1595412">.</span><span class="ident" id="1595413">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595419">mp</span><span class="op" id="1595421">.</span><span class="ident" id="1595422">ptrarg</span><span class="op" id="1595428">[</span><span class="num" id="1595429">1</span><span class="op" id="1595430">]</span>&nbsp;<span class="op" id="1595432">=</span>&nbsp;<span class="ident" id="1595434">e</span><span class="op" id="1595435">.</span><span class="ident" id="1595436">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595442">mp</span><span class="op" id="1595444">.</span><span class="ident" id="1595445">scalararg</span><span class="op" id="1595454">[</span><span class="num" id="1595455">0</span><span class="op" id="1595456">]</span>&nbsp;<span class="op" id="1595458">=</span>&nbsp;<span class="ident" id="1595460">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595466">mp</span><span class="op" id="1595468">.</span><span class="ident" id="1595469">ptrarg</span><span class="op" id="1595475">[</span><span class="num" id="1595476">2</span><span class="op" id="1595477">]</span>&nbsp;<span class="op" id="1595479">=</span>&nbsp;<span class="ident" id="1595481">unsafe</span><span class="op" id="1595487">.</span><span class="ident" id="1595488">Pointer</span><span class="op" id="1595495">(</span><span class="ident" id="1595496">fint</span><span class="op" id="1595500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595503">mp</span><span class="op" id="1595505">.</span><span class="ident" id="1595506">ptrarg</span><span class="op" id="1595512">[</span><span class="num" id="1595513">3</span><span class="op" id="1595514">]</span>&nbsp;<span class="op" id="1595516">=</span>&nbsp;<span class="ident" id="1595518">unsafe</span><span class="op" id="1595524">.</span><span class="ident" id="1595525">Pointer</span><span class="op" id="1595532">(</span><span class="ident" id="1595533">ot</span><span class="op" id="1595535">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595538">onM</span><span class="op" id="1595541">(</span><span class="ident" id="1595542">setFinalizer_m</span><span class="op" id="1595556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595559">if</span>&nbsp;<span class="ident" id="1595562">mp</span><span class="op" id="1595564">.</span><span class="ident" id="1595565">scalararg</span><span class="op" id="1595574">[</span><span class="num" id="1595575">0</span><span class="op" id="1595576">]</span>&nbsp;<span class="op" id="1595578">!=</span>&nbsp;<span class="num" id="1595581">1</span>&nbsp;<span class="op" id="1595583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595587">gothrow</span><span class="op" id="1595594">(</span><span class="string" id="1595595">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1595640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595646">releasem</span><span class="op" id="1595654">(</span><span class="ident" id="1595655">mp</span><span class="op" id="1595657">)</span><br>
<span class="lineno">655</span><span class="op" id="1595659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1595662">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1595721">func</span>&nbsp;<span class="ident" id="1595726">round</span><span class="op" id="1595731">(</span><span class="ident" id="1595732">n</span><span class="op" id="1595733">,</span>&nbsp;<span class="ident" id="1595735">a</span>&nbsp;<span class="builtintype" id="1595737">uintptr</span><span class="op" id="1595744">)</span>&nbsp;<span class="builtintype" id="1595746">uintptr</span>&nbsp;<span class="op" id="1595754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595757">return</span>&nbsp;<span class="op" id="1595764">(</span><span class="ident" id="1595765">n</span>&nbsp;<span class="op" id="1595767">+</span>&nbsp;<span class="ident" id="1595769">a</span>&nbsp;<span class="op" id="1595771">-</span>&nbsp;<span class="num" id="1595773">1</span><span class="op" id="1595774">)</span>&nbsp;<span class="op" id="1595776">&amp;^</span>&nbsp;<span class="op" id="1595779">(</span><span class="ident" id="1595780">a</span>&nbsp;<span class="op" id="1595782">-</span>&nbsp;<span class="num" id="1595784">1</span><span class="op" id="1595785">)</span><br>
<span class="lineno">660</span><span class="op" id="1595787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1595790">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1595860">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1595931">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1595970">func</span>&nbsp;<span class="ident" id="1595975">findObject</span><span class="op" id="1595985">(</span><span class="ident" id="1595986">v</span>&nbsp;<span class="ident" id="1595988">unsafe</span><span class="op" id="1595994">.</span><span class="ident" id="1595995">Pointer</span><span class="op" id="1596002">)</span>&nbsp;<span class="op" id="1596004">(</span><span class="ident" id="1596005">s</span>&nbsp;<span class="op" id="1596007">*</span><span class="ident" id="1596008">mspan</span><span class="op" id="1596013">,</span>&nbsp;<span class="ident" id="1596015">x</span>&nbsp;<span class="ident" id="1596017">unsafe</span><span class="op" id="1596023">.</span><span class="ident" id="1596024">Pointer</span><span class="op" id="1596031">,</span>&nbsp;<span class="ident" id="1596033">n</span>&nbsp;<span class="builtintype" id="1596035">uintptr</span><span class="op" id="1596042">)</span>&nbsp;<span class="op" id="1596044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596047">c</span>&nbsp;<span class="op" id="1596049">:=</span>&nbsp;<span class="ident" id="1596052">gomcache</span><span class="op" id="1596060">(</span><span class="op" id="1596061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596064">c</span><span class="op" id="1596065">.</span><span class="ident" id="1596066">local_nlookup</span><span class="op" id="1596079">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596083">if</span>&nbsp;<span class="ident" id="1596086">ptrSize</span>&nbsp;<span class="op" id="1596094">==</span>&nbsp;<span class="num" id="1596097">4</span>&nbsp;<span class="op" id="1596099">&amp;&amp;</span>&nbsp;<span class="ident" id="1596102">c</span><span class="op" id="1596103">.</span><span class="ident" id="1596104">local_nlookup</span>&nbsp;<span class="op" id="1596118">&gt;=</span>&nbsp;<span class="num" id="1596121">1</span><span class="op" id="1596122">&lt;&lt;</span><span class="num" id="1596124">30</span>&nbsp;<span class="op" id="1596127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596131">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596174">lock</span><span class="op" id="1596178">(</span><span class="op" id="1596179">&amp;</span><span class="ident" id="1596180">mheap_</span><span class="op" id="1596186">.</span><span class="ident" id="1596187">lock</span><span class="op" id="1596191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596195">purgecachedstats</span><span class="op" id="1596211">(</span><span class="ident" id="1596212">c</span><span class="op" id="1596213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596217">unlock</span><span class="op" id="1596223">(</span><span class="op" id="1596224">&amp;</span><span class="ident" id="1596225">mheap_</span><span class="op" id="1596231">.</span><span class="ident" id="1596232">lock</span><span class="op" id="1596236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596243">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596257">arena_start</span>&nbsp;<span class="op" id="1596269">:=</span>&nbsp;<span class="builtintype" id="1596272">uintptr</span><span class="op" id="1596279">(</span><span class="ident" id="1596280">unsafe</span><span class="op" id="1596286">.</span><span class="ident" id="1596287">Pointer</span><span class="op" id="1596294">(</span><span class="ident" id="1596295">mheap_</span><span class="op" id="1596301">.</span><span class="ident" id="1596302">arena_start</span><span class="op" id="1596313">)</span><span class="op" id="1596314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596317">arena_used</span>&nbsp;<span class="op" id="1596328">:=</span>&nbsp;<span class="builtintype" id="1596331">uintptr</span><span class="op" id="1596338">(</span><span class="ident" id="1596339">unsafe</span><span class="op" id="1596345">.</span><span class="ident" id="1596346">Pointer</span><span class="op" id="1596353">(</span><span class="ident" id="1596354">mheap_</span><span class="op" id="1596360">.</span><span class="ident" id="1596361">arena_used</span><span class="op" id="1596371">)</span><span class="op" id="1596372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596375">if</span>&nbsp;<span class="builtintype" id="1596378">uintptr</span><span class="op" id="1596385">(</span><span class="ident" id="1596386">v</span><span class="op" id="1596387">)</span>&nbsp;<span class="op" id="1596389">&lt;</span>&nbsp;<span class="ident" id="1596391">arena_start</span>&nbsp;<span class="op" id="1596403">||</span>&nbsp;<span class="builtintype" id="1596406">uintptr</span><span class="op" id="1596413">(</span><span class="ident" id="1596414">v</span><span class="op" id="1596415">)</span>&nbsp;<span class="op" id="1596417">&gt;=</span>&nbsp;<span class="ident" id="1596420">arena_used</span>&nbsp;<span class="op" id="1596431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596435">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596446">p</span>&nbsp;<span class="op" id="1596448">:=</span>&nbsp;<span class="builtintype" id="1596451">uintptr</span><span class="op" id="1596458">(</span><span class="ident" id="1596459">v</span><span class="op" id="1596460">)</span>&nbsp;<span class="op" id="1596462">&gt;&gt;</span>&nbsp;<span class="ident" id="1596465">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596476">q</span>&nbsp;<span class="op" id="1596478">:=</span>&nbsp;<span class="ident" id="1596481">p</span>&nbsp;<span class="op" id="1596483">-</span>&nbsp;<span class="ident" id="1596485">arena_start</span><span class="op" id="1596496">&gt;&gt;</span><span class="ident" id="1596498">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596509">s</span>&nbsp;<span class="op" id="1596511">=</span>&nbsp;<span class="op" id="1596513">*</span><span class="op" id="1596514">(</span><span class="op" id="1596515">*</span><span class="op" id="1596516">*</span><span class="ident" id="1596517">mspan</span><span class="op" id="1596522">)</span><span class="op" id="1596523">(</span><span class="ident" id="1596524">add</span><span class="op" id="1596527">(</span><span class="ident" id="1596528">unsafe</span><span class="op" id="1596534">.</span><span class="ident" id="1596535">Pointer</span><span class="op" id="1596542">(</span><span class="ident" id="1596543">mheap_</span><span class="op" id="1596549">.</span><span class="ident" id="1596550">spans</span><span class="op" id="1596555">)</span><span class="op" id="1596556">,</span>&nbsp;<span class="ident" id="1596558">q</span><span class="op" id="1596559">*</span><span class="ident" id="1596560">ptrSize</span><span class="op" id="1596567">)</span><span class="op" id="1596568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596571">if</span>&nbsp;<span class="ident" id="1596574">s</span>&nbsp;<span class="op" id="1596576">==</span>&nbsp;<span class="ident" id="1596579">nil</span>&nbsp;<span class="op" id="1596583">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596587">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596598">x</span>&nbsp;<span class="op" id="1596600">=</span>&nbsp;<span class="ident" id="1596602">unsafe</span><span class="op" id="1596608">.</span><span class="ident" id="1596609">Pointer</span><span class="op" id="1596616">(</span><span class="builtintype" id="1596617">uintptr</span><span class="op" id="1596624">(</span><span class="ident" id="1596625">s</span><span class="op" id="1596626">.</span><span class="ident" id="1596627">start</span><span class="op" id="1596632">)</span>&nbsp;<span class="op" id="1596634">&lt;&lt;</span>&nbsp;<span class="ident" id="1596637">pageShift</span><span class="op" id="1596646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596650">if</span>&nbsp;<span class="builtintype" id="1596653">uintptr</span><span class="op" id="1596660">(</span><span class="ident" id="1596661">v</span><span class="op" id="1596662">)</span>&nbsp;<span class="op" id="1596664">&lt;</span>&nbsp;<span class="builtintype" id="1596666">uintptr</span><span class="op" id="1596673">(</span><span class="ident" id="1596674">x</span><span class="op" id="1596675">)</span>&nbsp;<span class="op" id="1596677">||</span>&nbsp;<span class="builtintype" id="1596680">uintptr</span><span class="op" id="1596687">(</span><span class="ident" id="1596688">v</span><span class="op" id="1596689">)</span>&nbsp;<span class="op" id="1596691">&gt;=</span>&nbsp;<span class="builtintype" id="1596694">uintptr</span><span class="op" id="1596701">(</span><span class="ident" id="1596702">unsafe</span><span class="op" id="1596708">.</span><span class="ident" id="1596709">Pointer</span><span class="op" id="1596716">(</span><span class="ident" id="1596717">s</span><span class="op" id="1596718">.</span><span class="ident" id="1596719">limit</span><span class="op" id="1596724">)</span><span class="op" id="1596725">)</span>&nbsp;<span class="op" id="1596727">||</span>&nbsp;<span class="ident" id="1596730">s</span><span class="op" id="1596731">.</span><span class="ident" id="1596732">state</span>&nbsp;<span class="op" id="1596738">!=</span>&nbsp;<span class="ident" id="1596741">mSpanInUse</span>&nbsp;<span class="op" id="1596752">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596756">s</span>&nbsp;<span class="op" id="1596758">=</span>&nbsp;<span class="ident" id="1596760">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596766">x</span>&nbsp;<span class="op" id="1596768">=</span>&nbsp;<span class="ident" id="1596770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596776">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596788">n</span>&nbsp;<span class="op" id="1596790">=</span>&nbsp;<span class="builtintype" id="1596792">uintptr</span><span class="op" id="1596799">(</span><span class="ident" id="1596800">s</span><span class="op" id="1596801">.</span><span class="ident" id="1596802">elemsize</span><span class="op" id="1596810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596813">if</span>&nbsp;<span class="ident" id="1596816">s</span><span class="op" id="1596817">.</span><span class="ident" id="1596818">sizeclass</span>&nbsp;<span class="op" id="1596828">!=</span>&nbsp;<span class="num" id="1596831">0</span>&nbsp;<span class="op" id="1596833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596837">x</span>&nbsp;<span class="op" id="1596839">=</span>&nbsp;<span class="ident" id="1596841">add</span><span class="op" id="1596844">(</span><span class="ident" id="1596845">x</span><span class="op" id="1596846">,</span>&nbsp;<span class="op" id="1596848">(</span><span class="builtintype" id="1596849">uintptr</span><span class="op" id="1596856">(</span><span class="ident" id="1596857">v</span><span class="op" id="1596858">)</span><span class="op" id="1596859">-</span><span class="builtintype" id="1596860">uintptr</span><span class="op" id="1596867">(</span><span class="ident" id="1596868">x</span><span class="op" id="1596869">)</span><span class="op" id="1596870">)</span><span class="op" id="1596871">/</span><span class="ident" id="1596872">n</span><span class="op" id="1596873">*</span><span class="ident" id="1596874">n</span><span class="op" id="1596875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596881">return</span><br>
<span class="lineno">700</span><span class="op" id="1596888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596891">var</span>&nbsp;<span class="ident" id="1596895">fingCreate</span>&nbsp;<span class="builtintype" id="1596906">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596914">func</span>&nbsp;<span class="ident" id="1596919">createfing</span><span class="op" id="1596929">(</span><span class="op" id="1596930">)</span>&nbsp;<span class="op" id="1596932">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596935">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596982">if</span>&nbsp;<span class="ident" id="1596985">fingCreate</span>&nbsp;<span class="op" id="1596996">==</span>&nbsp;<span class="num" id="1596999">0</span>&nbsp;<span class="op" id="1597001">&amp;&amp;</span>&nbsp;<span class="ident" id="1597004">cas</span><span class="op" id="1597007">(</span><span class="op" id="1597008">&amp;</span><span class="ident" id="1597009">fingCreate</span><span class="op" id="1597019">,</span>&nbsp;<span class="num" id="1597021">0</span><span class="op" id="1597022">,</span>&nbsp;<span class="num" id="1597024">1</span><span class="op" id="1597025">)</span>&nbsp;<span class="op" id="1597027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597031">go</span>&nbsp;<span class="ident" id="1597034">runfinq</span><span class="op" id="1597041">(</span><span class="op" id="1597042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597045">}</span><br>
<span class="lineno"></span><span class="op" id="1597047">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1597050">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1597107">func</span>&nbsp;<span class="ident" id="1597112">runfinq</span><span class="op" id="1597119">(</span><span class="op" id="1597120">)</span>&nbsp;<span class="op" id="1597122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597125">var</span>&nbsp;<span class="op" id="1597129">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597133">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597142">unsafe</span><span class="op" id="1597148">.</span><span class="ident" id="1597149">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597159">framecap</span>&nbsp;<span class="builtintype" id="1597168">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597181">for</span>&nbsp;<span class="op" id="1597185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597189">lock</span><span class="op" id="1597193">(</span><span class="op" id="1597194">&amp;</span><span class="ident" id="1597195">finlock</span><span class="op" id="1597202">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597206">fb</span>&nbsp;<span class="op" id="1597209">:=</span>&nbsp;<span class="ident" id="1597212">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597219">finq</span>&nbsp;<span class="op" id="1597224">=</span>&nbsp;<span class="ident" id="1597226">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597232">if</span>&nbsp;<span class="ident" id="1597235">fb</span>&nbsp;<span class="op" id="1597238">==</span>&nbsp;<span class="ident" id="1597241">nil</span>&nbsp;<span class="op" id="1597245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597250">gp</span>&nbsp;<span class="op" id="1597253">:=</span>&nbsp;<span class="ident" id="1597256">getg</span><span class="op" id="1597260">(</span><span class="op" id="1597261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597266">fing</span>&nbsp;<span class="op" id="1597271">=</span>&nbsp;<span class="ident" id="1597273">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597279">fingwait</span>&nbsp;<span class="op" id="1597288">=</span>&nbsp;<span class="ident" id="1597290">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597298">gp</span><span class="op" id="1597300">.</span><span class="ident" id="1597301">issystem</span>&nbsp;<span class="op" id="1597310">=</span>&nbsp;<span class="ident" id="1597312">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597320">goparkunlock</span><span class="op" id="1597332">(</span><span class="op" id="1597333">&amp;</span><span class="ident" id="1597334">finlock</span><span class="op" id="1597341">,</span>&nbsp;<span class="string" id="1597343">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1597359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597364">gp</span><span class="op" id="1597366">.</span><span class="ident" id="1597367">issystem</span>&nbsp;<span class="op" id="1597376">=</span>&nbsp;<span class="ident" id="1597378">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597387">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597402">unlock</span><span class="op" id="1597408">(</span><span class="op" id="1597409">&amp;</span><span class="ident" id="1597410">finlock</span><span class="op" id="1597417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597421">if</span>&nbsp;<span class="ident" id="1597424">raceenabled</span>&nbsp;<span class="op" id="1597436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597441">racefingo</span><span class="op" id="1597450">(</span><span class="op" id="1597451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597455">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597459">for</span>&nbsp;<span class="ident" id="1597463">fb</span>&nbsp;<span class="op" id="1597466">!=</span>&nbsp;<span class="ident" id="1597469">nil</span>&nbsp;<span class="op" id="1597473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597478">for</span>&nbsp;<span class="ident" id="1597482">i</span>&nbsp;<span class="op" id="1597484">:=</span>&nbsp;<span class="builtintype" id="1597487">int32</span><span class="op" id="1597492">(</span><span class="num" id="1597493">0</span><span class="op" id="1597494">)</span><span class="op" id="1597495">;</span>&nbsp;<span class="ident" id="1597497">i</span>&nbsp;<span class="op" id="1597499">&lt;</span>&nbsp;<span class="ident" id="1597501">fb</span><span class="op" id="1597503">.</span><span class="ident" id="1597504">cnt</span><span class="op" id="1597507">;</span>&nbsp;<span class="ident" id="1597509">i</span><span class="op" id="1597510">++</span>&nbsp;<span class="op" id="1597513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597519">f</span>&nbsp;<span class="op" id="1597521">:=</span>&nbsp;<span class="op" id="1597524">(</span><span class="op" id="1597525">*</span><span class="ident" id="1597526">finalizer</span><span class="op" id="1597535">)</span><span class="op" id="1597536">(</span><span class="ident" id="1597537">add</span><span class="op" id="1597540">(</span><span class="ident" id="1597541">unsafe</span><span class="op" id="1597547">.</span><span class="ident" id="1597548">Pointer</span><span class="op" id="1597555">(</span><span class="op" id="1597556">&amp;</span><span class="ident" id="1597557">fb</span><span class="op" id="1597559">.</span><span class="ident" id="1597560">fin</span><span class="op" id="1597563">)</span><span class="op" id="1597564">,</span>&nbsp;<span class="builtintype" id="1597566">uintptr</span><span class="op" id="1597573">(</span><span class="ident" id="1597574">i</span><span class="op" id="1597575">)</span><span class="op" id="1597576">*</span><span class="ident" id="1597577">unsafe</span><span class="op" id="1597583">.</span><span class="ident" id="1597584">Sizeof</span><span class="op" id="1597590">(</span><span class="ident" id="1597591">finalizer</span><span class="op" id="1597600">{</span><span class="op" id="1597601">}</span><span class="op" id="1597602">)</span><span class="op" id="1597603">)</span><span class="op" id="1597604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597611">framesz</span>&nbsp;<span class="op" id="1597619">:=</span>&nbsp;<span class="ident" id="1597622">unsafe</span><span class="op" id="1597628">.</span><span class="ident" id="1597629">Sizeof</span><span class="op" id="1597635">(</span><span class="op" id="1597636">(</span><span class="keyword" id="1597637">interface</span><span class="op" id="1597646">{</span><span class="op" id="1597647">}</span><span class="op" id="1597648">)</span><span class="op" id="1597649">(</span><span class="ident" id="1597650">nil</span><span class="op" id="1597653">)</span><span class="op" id="1597654">)</span>&nbsp;<span class="op" id="1597656">+</span>&nbsp;<span class="builtintype" id="1597658">uintptr</span><span class="op" id="1597665">(</span><span class="ident" id="1597666">f</span><span class="op" id="1597667">.</span><span class="ident" id="1597668">nret</span><span class="op" id="1597672">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597678">if</span>&nbsp;<span class="ident" id="1597681">framecap</span>&nbsp;<span class="op" id="1597690">&lt;</span>&nbsp;<span class="ident" id="1597692">framesz</span>&nbsp;<span class="op" id="1597700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597707">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597771">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597829">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597873">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597925">frame</span>&nbsp;<span class="op" id="1597931">=</span>&nbsp;<span class="ident" id="1597933">mallocgc</span><span class="op" id="1597941">(</span><span class="ident" id="1597942">framesz</span><span class="op" id="1597949">,</span>&nbsp;<span class="ident" id="1597951">nil</span><span class="op" id="1597954">,</span>&nbsp;<span class="ident" id="1597956">flagNoScan</span><span class="op" id="1597966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597973">framecap</span>&nbsp;<span class="op" id="1597982">=</span>&nbsp;<span class="ident" id="1597984">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598003">if</span>&nbsp;<span class="ident" id="1598006">f</span><span class="op" id="1598007">.</span><span class="ident" id="1598008">fint</span>&nbsp;<span class="op" id="1598013">==</span>&nbsp;<span class="ident" id="1598016">nil</span>&nbsp;<span class="op" id="1598020">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598027">gothrow</span><span class="op" id="1598034">(</span><span class="string" id="1598035">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1598060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598072">switch</span>&nbsp;<span class="ident" id="1598079">f</span><span class="op" id="1598080">.</span><span class="ident" id="1598081">fint</span><span class="op" id="1598085">.</span><span class="ident" id="1598086">kind</span>&nbsp;<span class="op" id="1598091">&amp;</span>&nbsp;<span class="ident" id="1598093">kindMask</span>&nbsp;<span class="op" id="1598102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598108">case</span>&nbsp;<span class="ident" id="1598113">kindPtr</span><span class="op" id="1598120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598127">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598157">*</span><span class="op" id="1598158">(</span><span class="op" id="1598159">*</span><span class="ident" id="1598160">unsafe</span><span class="op" id="1598166">.</span><span class="ident" id="1598167">Pointer</span><span class="op" id="1598174">)</span><span class="op" id="1598175">(</span><span class="ident" id="1598176">frame</span><span class="op" id="1598181">)</span>&nbsp;<span class="op" id="1598183">=</span>&nbsp;<span class="ident" id="1598185">f</span><span class="op" id="1598186">.</span><span class="ident" id="1598187">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598195">case</span>&nbsp;<span class="ident" id="1598200">kindInterface</span><span class="op" id="1598213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598220">ityp</span>&nbsp;<span class="op" id="1598225">:=</span>&nbsp;<span class="op" id="1598228">(</span><span class="op" id="1598229">*</span><span class="ident" id="1598230">interfacetype</span><span class="op" id="1598243">)</span><span class="op" id="1598244">(</span><span class="ident" id="1598245">unsafe</span><span class="op" id="1598251">.</span><span class="ident" id="1598252">Pointer</span><span class="op" id="1598259">(</span><span class="ident" id="1598260">f</span><span class="op" id="1598261">.</span><span class="ident" id="1598262">fint</span><span class="op" id="1598266">)</span><span class="op" id="1598267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598274">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598310">(</span><span class="op" id="1598311">*</span><span class="ident" id="1598312">eface</span><span class="op" id="1598317">)</span><span class="op" id="1598318">(</span><span class="ident" id="1598319">frame</span><span class="op" id="1598324">)</span><span class="op" id="1598325">.</span><span class="ident" id="1598326">_type</span>&nbsp;<span class="op" id="1598332">=</span>&nbsp;<span class="op" id="1598334">&amp;</span><span class="ident" id="1598335">f</span><span class="op" id="1598336">.</span><span class="ident" id="1598337">ot</span><span class="op" id="1598339">.</span><span class="ident" id="1598340">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598349">(</span><span class="op" id="1598350">*</span><span class="ident" id="1598351">eface</span><span class="op" id="1598356">)</span><span class="op" id="1598357">(</span><span class="ident" id="1598358">frame</span><span class="op" id="1598363">)</span><span class="op" id="1598364">.</span><span class="ident" id="1598365">data</span>&nbsp;<span class="op" id="1598370">=</span>&nbsp;<span class="ident" id="1598372">f</span><span class="op" id="1598373">.</span><span class="ident" id="1598374">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598383">if</span>&nbsp;<span class="builtinfunc" id="1598386">len</span><span class="op" id="1598389">(</span><span class="ident" id="1598390">ityp</span><span class="op" id="1598394">.</span><span class="ident" id="1598395">mhdr</span><span class="op" id="1598399">)</span>&nbsp;<span class="op" id="1598401">!=</span>&nbsp;<span class="num" id="1598404">0</span>&nbsp;<span class="op" id="1598406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598414">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598457">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598536">*</span><span class="op" id="1598537">(</span><span class="op" id="1598538">*</span><span class="ident" id="1598539">fInterface</span><span class="op" id="1598549">)</span><span class="op" id="1598550">(</span><span class="ident" id="1598551">frame</span><span class="op" id="1598556">)</span>&nbsp;<span class="op" id="1598558">=</span>&nbsp;<span class="ident" id="1598560">assertE2I</span><span class="op" id="1598569">(</span><span class="ident" id="1598570">ityp</span><span class="op" id="1598574">,</span>&nbsp;<span class="op" id="1598576">*</span><span class="op" id="1598577">(</span><span class="op" id="1598578">*</span><span class="keyword" id="1598579">interface</span><span class="op" id="1598588">{</span><span class="op" id="1598589">}</span><span class="op" id="1598590">)</span><span class="op" id="1598591">(</span><span class="ident" id="1598592">frame</span><span class="op" id="1598597">)</span><span class="op" id="1598598">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598611">default</span><span class="op" id="1598618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598625">gothrow</span><span class="op" id="1598632">(</span><span class="string" id="1598633">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1598654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598666">reflectcall</span><span class="op" id="1598677">(</span><span class="ident" id="1598678">unsafe</span><span class="op" id="1598684">.</span><span class="ident" id="1598685">Pointer</span><span class="op" id="1598692">(</span><span class="ident" id="1598693">f</span><span class="op" id="1598694">.</span><span class="ident" id="1598695">fn</span><span class="op" id="1598697">)</span><span class="op" id="1598698">,</span>&nbsp;<span class="ident" id="1598700">frame</span><span class="op" id="1598705">,</span>&nbsp;<span class="builtintype" id="1598707">uint32</span><span class="op" id="1598713">(</span><span class="ident" id="1598714">framesz</span><span class="op" id="1598721">)</span><span class="op" id="1598722">,</span>&nbsp;<span class="builtintype" id="1598724">uint32</span><span class="op" id="1598730">(</span><span class="ident" id="1598731">framesz</span><span class="op" id="1598738">)</span><span class="op" id="1598739">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598746">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598805">f</span><span class="op" id="1598806">.</span><span class="ident" id="1598807">fn</span>&nbsp;<span class="op" id="1598810">=</span>&nbsp;<span class="ident" id="1598812">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598820">f</span><span class="op" id="1598821">.</span><span class="ident" id="1598822">arg</span>&nbsp;<span class="op" id="1598826">=</span>&nbsp;<span class="ident" id="1598828">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598836">f</span><span class="op" id="1598837">.</span><span class="ident" id="1598838">ot</span>&nbsp;<span class="op" id="1598841">=</span>&nbsp;<span class="ident" id="1598843">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598855">fb</span><span class="op" id="1598857">.</span><span class="ident" id="1598858">cnt</span>&nbsp;<span class="op" id="1598862">=</span>&nbsp;<span class="num" id="1598864">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598869">next</span>&nbsp;<span class="op" id="1598874">:=</span>&nbsp;<span class="ident" id="1598877">fb</span><span class="op" id="1598879">.</span><span class="ident" id="1598880">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598888">lock</span><span class="op" id="1598892">(</span><span class="op" id="1598893">&amp;</span><span class="ident" id="1598894">finlock</span><span class="op" id="1598901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598906">fb</span><span class="op" id="1598908">.</span><span class="ident" id="1598909">next</span>&nbsp;<span class="op" id="1598914">=</span>&nbsp;<span class="ident" id="1598916">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598924">finc</span>&nbsp;<span class="op" id="1598929">=</span>&nbsp;<span class="ident" id="1598931">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598937">unlock</span><span class="op" id="1598943">(</span><span class="op" id="1598944">&amp;</span><span class="ident" id="1598945">finlock</span><span class="op" id="1598952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598957">fb</span>&nbsp;<span class="op" id="1598960">=</span>&nbsp;<span class="ident" id="1598962">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598972">}</span><br>
<span class="lineno">785</span><span class="op" id="1598974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598977">var</span>&nbsp;<span class="ident" id="1598981">persistent</span>&nbsp;<span class="keyword" id="1598992">struct</span>&nbsp;<span class="op" id="1598999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599002">lock</span>&nbsp;<span class="ident" id="1599007">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599014">pos</span>&nbsp;&nbsp;<span class="ident" id="1599019">unsafe</span><span class="op" id="1599025">.</span><span class="ident" id="1599026">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599035">end</span>&nbsp;&nbsp;<span class="ident" id="1599040">unsafe</span><span class="op" id="1599046">.</span><span class="ident" id="1599047">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1599055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599058">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1599117">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1599159">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1599232">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1599284">func</span>&nbsp;<span class="ident" id="1599289">persistentalloc</span><span class="op" id="1599304">(</span><span class="ident" id="1599305">size</span><span class="op" id="1599309">,</span>&nbsp;<span class="ident" id="1599311">align</span>&nbsp;<span class="builtintype" id="1599317">uintptr</span><span class="op" id="1599324">,</span>&nbsp;<span class="ident" id="1599326">stat</span>&nbsp;<span class="op" id="1599331">*</span><span class="ident" id="1599332">uint64</span><span class="op" id="1599338">)</span>&nbsp;<span class="ident" id="1599340">unsafe</span><span class="op" id="1599346">.</span><span class="ident" id="1599347">Pointer</span>&nbsp;<span class="op" id="1599355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599358">const</span>&nbsp;<span class="op" id="1599364">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599368">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599377">=</span>&nbsp;<span class="num" id="1599379">256</span>&nbsp;<span class="op" id="1599383">&lt;&lt;</span>&nbsp;<span class="num" id="1599386">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599391">maxBlock</span>&nbsp;<span class="op" id="1599400">=</span>&nbsp;<span class="num" id="1599402">64</span>&nbsp;<span class="op" id="1599405">&lt;&lt;</span>&nbsp;<span class="num" id="1599408">10</span>&nbsp;<span class="comment" id="1599411">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599460">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599464">if</span>&nbsp;<span class="ident" id="1599467">align</span>&nbsp;<span class="op" id="1599473">!=</span>&nbsp;<span class="num" id="1599476">0</span>&nbsp;<span class="op" id="1599478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599482">if</span>&nbsp;<span class="ident" id="1599485">align</span><span class="op" id="1599490">&amp;</span><span class="op" id="1599491">(</span><span class="ident" id="1599492">align</span><span class="op" id="1599497">-</span><span class="num" id="1599498">1</span><span class="op" id="1599499">)</span>&nbsp;<span class="op" id="1599501">!=</span>&nbsp;<span class="num" id="1599504">0</span>&nbsp;<span class="op" id="1599506">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599511">gothrow</span><span class="op" id="1599518">(</span><span class="string" id="1599519">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1599563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599571">if</span>&nbsp;<span class="ident" id="1599574">align</span>&nbsp;<span class="op" id="1599580">&gt;</span>&nbsp;<span class="ident" id="1599582">_PageSize</span>&nbsp;<span class="op" id="1599592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599597">gothrow</span><span class="op" id="1599604">(</span><span class="string" id="1599605">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1599642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599646">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599649">}</span>&nbsp;<span class="keyword" id="1599651">else</span>&nbsp;<span class="op" id="1599656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599660">align</span>&nbsp;<span class="op" id="1599666">=</span>&nbsp;<span class="num" id="1599668">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599675">if</span>&nbsp;<span class="ident" id="1599678">size</span>&nbsp;<span class="op" id="1599683">&gt;=</span>&nbsp;<span class="ident" id="1599686">maxBlock</span>&nbsp;<span class="op" id="1599695">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599699">return</span>&nbsp;<span class="ident" id="1599706">sysAlloc</span><span class="op" id="1599714">(</span><span class="ident" id="1599715">size</span><span class="op" id="1599719">,</span>&nbsp;<span class="ident" id="1599721">stat</span><span class="op" id="1599725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599732">lock</span><span class="op" id="1599736">(</span><span class="op" id="1599737">&amp;</span><span class="ident" id="1599738">persistent</span><span class="op" id="1599748">.</span><span class="ident" id="1599749">lock</span><span class="op" id="1599753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599756">persistent</span><span class="op" id="1599766">.</span><span class="ident" id="1599767">pos</span>&nbsp;<span class="op" id="1599771">=</span>&nbsp;<span class="ident" id="1599773">roundup</span><span class="op" id="1599780">(</span><span class="ident" id="1599781">persistent</span><span class="op" id="1599791">.</span><span class="ident" id="1599792">pos</span><span class="op" id="1599795">,</span>&nbsp;<span class="ident" id="1599797">align</span><span class="op" id="1599802">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599805">if</span>&nbsp;<span class="builtintype" id="1599808">uintptr</span><span class="op" id="1599815">(</span><span class="ident" id="1599816">persistent</span><span class="op" id="1599826">.</span><span class="ident" id="1599827">pos</span><span class="op" id="1599830">)</span><span class="op" id="1599831">+</span><span class="ident" id="1599832">size</span>&nbsp;<span class="op" id="1599837">&gt;</span>&nbsp;<span class="builtintype" id="1599839">uintptr</span><span class="op" id="1599846">(</span><span class="ident" id="1599847">persistent</span><span class="op" id="1599857">.</span><span class="ident" id="1599858">end</span><span class="op" id="1599861">)</span>&nbsp;<span class="op" id="1599863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599867">persistent</span><span class="op" id="1599877">.</span><span class="ident" id="1599878">pos</span>&nbsp;<span class="op" id="1599882">=</span>&nbsp;<span class="ident" id="1599884">sysAlloc</span><span class="op" id="1599892">(</span><span class="ident" id="1599893">chunk</span><span class="op" id="1599898">,</span>&nbsp;<span class="op" id="1599900">&amp;</span><span class="ident" id="1599901">memstats</span><span class="op" id="1599909">.</span><span class="ident" id="1599910">other_sys</span><span class="op" id="1599919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599923">if</span>&nbsp;<span class="ident" id="1599926">persistent</span><span class="op" id="1599936">.</span><span class="ident" id="1599937">pos</span>&nbsp;<span class="op" id="1599941">==</span>&nbsp;<span class="ident" id="1599944">nil</span>&nbsp;<span class="op" id="1599948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599953">unlock</span><span class="op" id="1599959">(</span><span class="op" id="1599960">&amp;</span><span class="ident" id="1599961">persistent</span><span class="op" id="1599971">.</span><span class="ident" id="1599972">lock</span><span class="op" id="1599976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599981">gothrow</span><span class="op" id="1599988">(</span><span class="string" id="1599989">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1600022">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600030">persistent</span><span class="op" id="1600040">.</span><span class="ident" id="1600041">end</span>&nbsp;<span class="op" id="1600045">=</span>&nbsp;<span class="ident" id="1600047">add</span><span class="op" id="1600050">(</span><span class="ident" id="1600051">persistent</span><span class="op" id="1600061">.</span><span class="ident" id="1600062">pos</span><span class="op" id="1600065">,</span>&nbsp;<span class="ident" id="1600067">chunk</span><span class="op" id="1600072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600078">p</span>&nbsp;<span class="op" id="1600080">:=</span>&nbsp;<span class="ident" id="1600083">persistent</span><span class="op" id="1600093">.</span><span class="ident" id="1600094">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600099">persistent</span><span class="op" id="1600109">.</span><span class="ident" id="1600110">pos</span>&nbsp;<span class="op" id="1600114">=</span>&nbsp;<span class="ident" id="1600116">add</span><span class="op" id="1600119">(</span><span class="ident" id="1600120">persistent</span><span class="op" id="1600130">.</span><span class="ident" id="1600131">pos</span><span class="op" id="1600134">,</span>&nbsp;<span class="ident" id="1600136">size</span><span class="op" id="1600140">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600143">unlock</span><span class="op" id="1600149">(</span><span class="op" id="1600150">&amp;</span><span class="ident" id="1600151">persistent</span><span class="op" id="1600161">.</span><span class="ident" id="1600162">lock</span><span class="op" id="1600166">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600170">if</span>&nbsp;<span class="ident" id="1600173">stat</span>&nbsp;<span class="op" id="1600178">!=</span>&nbsp;<span class="op" id="1600181">&amp;</span><span class="ident" id="1600182">memstats</span><span class="op" id="1600190">.</span><span class="ident" id="1600191">other_sys</span>&nbsp;<span class="op" id="1600201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600205">xadd64</span><span class="op" id="1600211">(</span><span class="ident" id="1600212">stat</span><span class="op" id="1600216">,</span>&nbsp;<span class="ident" id="1600218">int64</span><span class="op" id="1600223">(</span><span class="ident" id="1600224">size</span><span class="op" id="1600228">)</span><span class="op" id="1600229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600233">xadd64</span><span class="op" id="1600239">(</span><span class="op" id="1600240">&amp;</span><span class="ident" id="1600241">memstats</span><span class="op" id="1600249">.</span><span class="ident" id="1600250">other_sys</span><span class="op" id="1600259">,</span>&nbsp;<span class="op" id="1600261">-</span><span class="ident" id="1600262">int64</span><span class="op" id="1600267">(</span><span class="ident" id="1600268">size</span><span class="op" id="1600272">)</span><span class="op" id="1600273">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600279">return</span>&nbsp;<span class="ident" id="1600286">p</span><br>
<span class="lineno"></span><span class="op" id="1600288">}</span>
</div>
</body>
</html>
