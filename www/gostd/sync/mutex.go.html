<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html" class="current">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1613202">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1613257">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1613311">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1613362">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1613435">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1613515">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1613590">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1613637">//</span><br>
<span class="lineno">10</span><span class="comment" id="1613640">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1613717">package</span>&nbsp;<span class="ident" id="1613725">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1613731">import</span>&nbsp;<span class="op" id="1613738">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1613741">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1613756">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1613765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1613768">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1613807">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1613862">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1613914">type</span>&nbsp;<span class="ident" id="1613919">Mutex</span>&nbsp;<span class="keyword" id="1613925">struct</span>&nbsp;<span class="op" id="1613932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613935">state</span>&nbsp;<span class="builtintype" id="1613941">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613948">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1613954">uint32</span><br>
<span class="lineno"></span><span class="op" id="1613961">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1613964">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1614030">type</span>&nbsp;<span class="ident" id="1614035">Locker</span>&nbsp;<span class="keyword" id="1614042">interface</span>&nbsp;<span class="op" id="1614052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614055">Lock</span><span class="op" id="1614059">(</span><span class="op" id="1614060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614063">Unlock</span><span class="op" id="1614069">(</span><span class="op" id="1614070">)</span><br>
<span class="lineno">30</span><span class="op" id="1614072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1614075">const</span>&nbsp;<span class="op" id="1614081">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614084">mutexLocked</span>&nbsp;<span class="op" id="1614096">=</span>&nbsp;<span class="num" id="1614098">1</span>&nbsp;<span class="op" id="1614100">&lt;&lt;</span>&nbsp;<span class="ident" id="1614103">iota</span>&nbsp;<span class="comment" id="1614108">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614128">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614140">mutexWaiterShift</span>&nbsp;<span class="op" id="1614157">=</span>&nbsp;<span class="ident" id="1614159">iota</span><br>
<span class="lineno"></span><span class="op" id="1614164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614167">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1614184">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1614240">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1614280">func</span>&nbsp;<span class="op" id="1614285">(</span><span class="ident" id="1614286">m</span>&nbsp;<span class="op" id="1614288">*</span><span class="ident" id="1614289">Mutex</span><span class="op" id="1614294">)</span>&nbsp;<span class="ident" id="1614296">Lock</span><span class="op" id="1614300">(</span><span class="op" id="1614301">)</span>&nbsp;<span class="op" id="1614303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614306">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614342">if</span>&nbsp;<span class="ident" id="1614345">atomic</span><span class="op" id="1614351">.</span><span class="ident" id="1614352">CompareAndSwapInt32</span><span class="op" id="1614371">(</span><span class="op" id="1614372">&amp;</span><span class="ident" id="1614373">m</span><span class="op" id="1614374">.</span><span class="ident" id="1614375">state</span><span class="op" id="1614380">,</span>&nbsp;<span class="num" id="1614382">0</span><span class="op" id="1614383">,</span>&nbsp;<span class="ident" id="1614385">mutexLocked</span><span class="op" id="1614396">)</span>&nbsp;<span class="op" id="1614398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614402">if</span>&nbsp;<span class="ident" id="1614405">raceenabled</span>&nbsp;<span class="op" id="1614417">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614422">raceAcquire</span><span class="op" id="1614433">(</span><span class="ident" id="1614434">unsafe</span><span class="op" id="1614440">.</span><span class="ident" id="1614441">Pointer</span><span class="op" id="1614448">(</span><span class="ident" id="1614449">m</span><span class="op" id="1614450">)</span><span class="op" id="1614451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614459">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614471">awoke</span>&nbsp;<span class="op" id="1614477">:=</span>&nbsp;<span class="builtintype" id="1614480">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614487">for</span>&nbsp;<span class="op" id="1614491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614495">old</span>&nbsp;<span class="op" id="1614499">:=</span>&nbsp;<span class="ident" id="1614502">m</span><span class="op" id="1614503">.</span><span class="ident" id="1614504">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1614512">new</span>&nbsp;<span class="op" id="1614516">:=</span>&nbsp;<span class="ident" id="1614519">old</span>&nbsp;<span class="op" id="1614523">|</span>&nbsp;<span class="ident" id="1614525">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614539">if</span>&nbsp;<span class="ident" id="1614542">old</span><span class="op" id="1614545">&amp;</span><span class="ident" id="1614546">mutexLocked</span>&nbsp;<span class="op" id="1614558">!=</span>&nbsp;<span class="num" id="1614561">0</span>&nbsp;<span class="op" id="1614563">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1614568">new</span>&nbsp;<span class="op" id="1614572">=</span>&nbsp;<span class="ident" id="1614574">old</span>&nbsp;<span class="op" id="1614578">+</span>&nbsp;<span class="num" id="1614580">1</span><span class="op" id="1614581">&lt;&lt;</span><span class="ident" id="1614583">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614606">if</span>&nbsp;<span class="ident" id="1614609">awoke</span>&nbsp;<span class="op" id="1614615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614620">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614667">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1614718">new</span>&nbsp;<span class="op" id="1614722">&amp;^=</span>&nbsp;<span class="ident" id="1614726">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614743">if</span>&nbsp;<span class="ident" id="1614746">atomic</span><span class="op" id="1614752">.</span><span class="ident" id="1614753">CompareAndSwapInt32</span><span class="op" id="1614772">(</span><span class="op" id="1614773">&amp;</span><span class="ident" id="1614774">m</span><span class="op" id="1614775">.</span><span class="ident" id="1614776">state</span><span class="op" id="1614781">,</span>&nbsp;<span class="ident" id="1614783">old</span><span class="op" id="1614786">,</span>&nbsp;<span class="builtinfunc" id="1614788">new</span><span class="op" id="1614791">)</span>&nbsp;<span class="op" id="1614793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614798">if</span>&nbsp;<span class="ident" id="1614801">old</span><span class="op" id="1614804">&amp;</span><span class="ident" id="1614805">mutexLocked</span>&nbsp;<span class="op" id="1614817">==</span>&nbsp;<span class="num" id="1614820">0</span>&nbsp;<span class="op" id="1614822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614828">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614842">runtime_Semacquire</span><span class="op" id="1614860">(</span><span class="op" id="1614861">&amp;</span><span class="ident" id="1614862">m</span><span class="op" id="1614863">.</span><span class="ident" id="1614864">sema</span><span class="op" id="1614868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614873">awoke</span>&nbsp;<span class="op" id="1614879">=</span>&nbsp;<span class="builtintype" id="1614881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614891">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614895">if</span>&nbsp;<span class="ident" id="1614898">raceenabled</span>&nbsp;<span class="op" id="1614910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614914">raceAcquire</span><span class="op" id="1614925">(</span><span class="ident" id="1614926">unsafe</span><span class="op" id="1614932">.</span><span class="ident" id="1614933">Pointer</span><span class="op" id="1614940">(</span><span class="ident" id="1614941">m</span><span class="op" id="1614942">)</span><span class="op" id="1614943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614946">}</span><br>
<span class="lineno"></span><span class="op" id="1614948">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1614951">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1614972">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1615037">//</span><br>
<span class="lineno"></span><span class="comment" id="1615040">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1615105">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1615165">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1615212">func</span>&nbsp;<span class="op" id="1615217">(</span><span class="ident" id="1615218">m</span>&nbsp;<span class="op" id="1615220">*</span><span class="ident" id="1615221">Mutex</span><span class="op" id="1615226">)</span>&nbsp;<span class="ident" id="1615228">Unlock</span><span class="op" id="1615234">(</span><span class="op" id="1615235">)</span>&nbsp;<span class="op" id="1615237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615240">if</span>&nbsp;<span class="ident" id="1615243">raceenabled</span>&nbsp;<span class="op" id="1615255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615259">_</span>&nbsp;<span class="op" id="1615261">=</span>&nbsp;<span class="ident" id="1615263">m</span><span class="op" id="1615264">.</span><span class="ident" id="1615265">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615273">raceRelease</span><span class="op" id="1615284">(</span><span class="ident" id="1615285">unsafe</span><span class="op" id="1615291">.</span><span class="ident" id="1615292">Pointer</span><span class="op" id="1615299">(</span><span class="ident" id="1615300">m</span><span class="op" id="1615301">)</span><span class="op" id="1615302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615309">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615339">new</span>&nbsp;<span class="op" id="1615343">:=</span>&nbsp;<span class="ident" id="1615346">atomic</span><span class="op" id="1615352">.</span><span class="ident" id="1615353">AddInt32</span><span class="op" id="1615361">(</span><span class="op" id="1615362">&amp;</span><span class="ident" id="1615363">m</span><span class="op" id="1615364">.</span><span class="ident" id="1615365">state</span><span class="op" id="1615370">,</span>&nbsp;<span class="op" id="1615372">-</span><span class="ident" id="1615373">mutexLocked</span><span class="op" id="1615384">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615387">if</span>&nbsp;<span class="op" id="1615390">(</span><span class="builtinfunc" id="1615391">new</span><span class="op" id="1615394">+</span><span class="ident" id="1615395">mutexLocked</span><span class="op" id="1615406">)</span><span class="op" id="1615407">&amp;</span><span class="ident" id="1615408">mutexLocked</span>&nbsp;<span class="op" id="1615420">==</span>&nbsp;<span class="num" id="1615423">0</span>&nbsp;<span class="op" id="1615425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615429">panic</span><span class="op" id="1615434">(</span><span class="string" id="1615435">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1615467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615474">old</span>&nbsp;<span class="op" id="1615478">:=</span>&nbsp;<span class="builtinfunc" id="1615481">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615486">for</span>&nbsp;<span class="op" id="1615490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615494">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615550">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615611">if</span>&nbsp;<span class="ident" id="1615614">old</span><span class="op" id="1615617">&gt;&gt;</span><span class="ident" id="1615619">mutexWaiterShift</span>&nbsp;<span class="op" id="1615636">==</span>&nbsp;<span class="num" id="1615639">0</span>&nbsp;<span class="op" id="1615641">||</span>&nbsp;<span class="ident" id="1615644">old</span><span class="op" id="1615647">&amp;</span><span class="op" id="1615648">(</span><span class="ident" id="1615649">mutexLocked</span><span class="op" id="1615660">|</span><span class="ident" id="1615661">mutexWoken</span><span class="op" id="1615671">)</span>&nbsp;<span class="op" id="1615673">!=</span>&nbsp;<span class="num" id="1615676">0</span>&nbsp;<span class="op" id="1615678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615683">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615696">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615733">new</span>&nbsp;<span class="op" id="1615737">=</span>&nbsp;<span class="op" id="1615739">(</span><span class="ident" id="1615740">old</span>&nbsp;<span class="op" id="1615744">-</span>&nbsp;<span class="num" id="1615746">1</span><span class="op" id="1615747">&lt;&lt;</span><span class="ident" id="1615749">mutexWaiterShift</span><span class="op" id="1615765">)</span>&nbsp;<span class="op" id="1615767">|</span>&nbsp;<span class="ident" id="1615769">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615782">if</span>&nbsp;<span class="ident" id="1615785">atomic</span><span class="op" id="1615791">.</span><span class="ident" id="1615792">CompareAndSwapInt32</span><span class="op" id="1615811">(</span><span class="op" id="1615812">&amp;</span><span class="ident" id="1615813">m</span><span class="op" id="1615814">.</span><span class="ident" id="1615815">state</span><span class="op" id="1615820">,</span>&nbsp;<span class="ident" id="1615822">old</span><span class="op" id="1615825">,</span>&nbsp;<span class="builtinfunc" id="1615827">new</span><span class="op" id="1615830">)</span>&nbsp;<span class="op" id="1615832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615837">runtime_Semrelease</span><span class="op" id="1615855">(</span><span class="op" id="1615856">&amp;</span><span class="ident" id="1615857">m</span><span class="op" id="1615858">.</span><span class="ident" id="1615859">sema</span><span class="op" id="1615863">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615881">old</span>&nbsp;<span class="op" id="1615885">=</span>&nbsp;<span class="ident" id="1615887">m</span><span class="op" id="1615888">.</span><span class="ident" id="1615889">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615896">}</span><br>
<span class="lineno"></span><span class="op" id="1615898">}</span>
</div>
</body>
</html>
