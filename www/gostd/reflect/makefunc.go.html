<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2658672">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2658728">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2658782">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2658833">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2658862">package</span>&nbsp;<span class="ident" id="2658870">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2658879">import</span>&nbsp;<span class="op" id="2658886">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2658889">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2658898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2658901">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2658964">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2658989">type</span>&nbsp;<span class="ident" id="2658994">makeFuncImpl</span>&nbsp;<span class="keyword" id="2659007">struct</span>&nbsp;<span class="op" id="2659014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2659017">code</span>&nbsp;&nbsp;<span class="builtintype" id="2659023">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2659032">stack</span>&nbsp;<span class="op" id="2659038">*</span><span class="ident" id="2659039">bitVector</span>&nbsp;<span class="comment" id="2659049">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2659101">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2659107">*</span><span class="ident" id="2659108">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2659118">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2659124">func</span><span class="op" id="2659128">(</span><span class="op" id="2659129">[</span><span class="op" id="2659130">]</span><span class="ident" id="2659131">Value</span><span class="op" id="2659136">)</span>&nbsp;<span class="op" id="2659138">[</span><span class="op" id="2659139">]</span><span class="ident" id="2659140">Value</span><br>
<span class="lineno">20</span><span class="op" id="2659146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2659149">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2659202">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2659264">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2659287">//</span><br>
<span class="lineno"></span><span class="comment" id="2659290">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2659340">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2659371">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2659441">//</span><br>
<span class="lineno">30</span><span class="comment" id="2659444">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2659510">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2659564">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2659631">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2659689">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2659759">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2659817">//</span><br>
<span class="lineno"></span><span class="comment" id="2659820">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2659890">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2659966">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2660006">//</span><br>
<span class="lineno"></span><span class="comment" id="2660009">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2660079">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2660151">//</span><br>
<span class="lineno"></span><span class="keyword" id="2660154">func</span>&nbsp;<span class="ident" id="2660159">MakeFunc</span><span class="op" id="2660167">(</span><span class="ident" id="2660168">typ</span>&nbsp;<span class="ident" id="2660172">Type</span><span class="op" id="2660176">,</span>&nbsp;<span class="ident" id="2660178">fn</span>&nbsp;<span class="keyword" id="2660181">func</span><span class="op" id="2660185">(</span><span class="ident" id="2660186">args</span>&nbsp;<span class="op" id="2660191">[</span><span class="op" id="2660192">]</span><span class="ident" id="2660193">Value</span><span class="op" id="2660198">)</span>&nbsp;<span class="op" id="2660200">(</span><span class="ident" id="2660201">results</span>&nbsp;<span class="op" id="2660209">[</span><span class="op" id="2660210">]</span><span class="ident" id="2660211">Value</span><span class="op" id="2660216">)</span><span class="op" id="2660217">)</span>&nbsp;<span class="ident" id="2660219">Value</span>&nbsp;<span class="op" id="2660225">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2660228">if</span>&nbsp;<span class="ident" id="2660231">typ</span><span class="op" id="2660234">.</span><span class="ident" id="2660235">Kind</span><span class="op" id="2660239">(</span><span class="op" id="2660240">)</span>&nbsp;<span class="op" id="2660242">!=</span>&nbsp;<span class="ident" id="2660245">Func</span>&nbsp;<span class="op" id="2660250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2660254">panic</span><span class="op" id="2660259">(</span><span class="string" id="2660260">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2660306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2660309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660313">t</span>&nbsp;<span class="op" id="2660315">:=</span>&nbsp;<span class="ident" id="2660318">typ</span><span class="op" id="2660321">.</span><span class="ident" id="2660322">common</span><span class="op" id="2660328">(</span><span class="op" id="2660329">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660332">ftyp</span>&nbsp;<span class="op" id="2660337">:=</span>&nbsp;<span class="op" id="2660340">(</span><span class="op" id="2660341">*</span><span class="ident" id="2660342">funcType</span><span class="op" id="2660350">)</span><span class="op" id="2660351">(</span><span class="ident" id="2660352">unsafe</span><span class="op" id="2660358">.</span><span class="ident" id="2660359">Pointer</span><span class="op" id="2660366">(</span><span class="ident" id="2660367">t</span><span class="op" id="2660368">)</span><span class="op" id="2660369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2660373">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2660418">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2660473">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660533">dummy</span>&nbsp;<span class="op" id="2660539">:=</span>&nbsp;<span class="ident" id="2660542">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660556">code</span>&nbsp;<span class="op" id="2660561">:=</span>&nbsp;<span class="op" id="2660564">*</span><span class="op" id="2660565">*</span><span class="op" id="2660566">(</span><span class="op" id="2660567">*</span><span class="op" id="2660568">*</span><span class="builtintype" id="2660569">uintptr</span><span class="op" id="2660576">)</span><span class="op" id="2660577">(</span><span class="ident" id="2660578">unsafe</span><span class="op" id="2660584">.</span><span class="ident" id="2660585">Pointer</span><span class="op" id="2660592">(</span><span class="op" id="2660593">&amp;</span><span class="ident" id="2660594">dummy</span><span class="op" id="2660599">)</span><span class="op" id="2660600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2660604">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660665">_</span><span class="op" id="2660666">,</span>&nbsp;<span class="ident" id="2660668">_</span><span class="op" id="2660669">,</span>&nbsp;<span class="ident" id="2660671">_</span><span class="op" id="2660672">,</span>&nbsp;<span class="ident" id="2660674">stack</span>&nbsp;<span class="op" id="2660680">:=</span>&nbsp;<span class="ident" id="2660683">funcLayout</span><span class="op" id="2660693">(</span><span class="ident" id="2660694">t</span><span class="op" id="2660695">,</span>&nbsp;<span class="ident" id="2660697">nil</span><span class="op" id="2660700">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660704">impl</span>&nbsp;<span class="op" id="2660709">:=</span>&nbsp;<span class="op" id="2660712">&amp;</span><span class="ident" id="2660713">makeFuncImpl</span><span class="op" id="2660725">{</span><span class="ident" id="2660726">code</span><span class="op" id="2660730">:</span>&nbsp;<span class="ident" id="2660732">code</span><span class="op" id="2660736">,</span>&nbsp;<span class="ident" id="2660738">stack</span><span class="op" id="2660743">:</span>&nbsp;<span class="ident" id="2660745">stack</span><span class="op" id="2660750">,</span>&nbsp;<span class="ident" id="2660752">typ</span><span class="op" id="2660755">:</span>&nbsp;<span class="ident" id="2660757">ftyp</span><span class="op" id="2660761">,</span>&nbsp;<span class="ident" id="2660763">fn</span><span class="op" id="2660765">:</span>&nbsp;<span class="ident" id="2660767">fn</span><span class="op" id="2660769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2660773">return</span>&nbsp;<span class="ident" id="2660780">Value</span><span class="op" id="2660785">{</span><span class="ident" id="2660786">t</span><span class="op" id="2660787">,</span>&nbsp;<span class="ident" id="2660789">unsafe</span><span class="op" id="2660795">.</span><span class="ident" id="2660796">Pointer</span><span class="op" id="2660803">(</span><span class="ident" id="2660804">impl</span><span class="op" id="2660808">)</span><span class="op" id="2660809">,</span>&nbsp;<span class="ident" id="2660811">flag</span><span class="op" id="2660815">(</span><span class="ident" id="2660816">Func</span><span class="op" id="2660820">)</span><span class="op" id="2660821">}</span><br>
<span class="lineno"></span><span class="op" id="2660823">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2660826">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2660891">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2660961">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2661039">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2661113">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2661154">func</span>&nbsp;<span class="ident" id="2661159">makeFuncStub</span><span class="op" id="2661171">(</span><span class="op" id="2661172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2661175">type</span>&nbsp;<span class="ident" id="2661180">methodValue</span>&nbsp;<span class="keyword" id="2661192">struct</span>&nbsp;<span class="op" id="2661199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2661202">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2661209">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2661218">stack</span>&nbsp;&nbsp;<span class="op" id="2661225">*</span><span class="ident" id="2661226">bitVector</span>&nbsp;<span class="comment" id="2661236">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2661288">method</span>&nbsp;<span class="builtintype" id="2661295">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2661300">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2661307">Value</span><br>
<span class="lineno"></span><span class="op" id="2661313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2661316">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2661388">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2661450">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2661518">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2661580">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2661650">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2661719">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2661769">func</span>&nbsp;<span class="ident" id="2661774">makeMethodValue</span><span class="op" id="2661789">(</span><span class="ident" id="2661790">op</span>&nbsp;<span class="builtintype" id="2661793">string</span><span class="op" id="2661799">,</span>&nbsp;<span class="ident" id="2661801">v</span>&nbsp;<span class="ident" id="2661803">Value</span><span class="op" id="2661808">)</span>&nbsp;<span class="ident" id="2661810">Value</span>&nbsp;<span class="op" id="2661816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2661819">if</span>&nbsp;<span class="ident" id="2661822">v</span><span class="op" id="2661823">.</span><span class="ident" id="2661824">flag</span><span class="op" id="2661828">&amp;</span><span class="ident" id="2661829">flagMethod</span>&nbsp;<span class="op" id="2661840">==</span>&nbsp;<span class="num" id="2661843">0</span>&nbsp;<span class="op" id="2661845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2661849">panic</span><span class="op" id="2661854">(</span><span class="string" id="2661855">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2661912">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2661915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2661919">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2661999">fl</span>&nbsp;<span class="op" id="2662002">:=</span>&nbsp;<span class="ident" id="2662005">v</span><span class="op" id="2662006">.</span><span class="ident" id="2662007">flag</span>&nbsp;<span class="op" id="2662012">&amp;</span>&nbsp;<span class="op" id="2662014">(</span><span class="ident" id="2662015">flagRO</span>&nbsp;<span class="op" id="2662022">|</span>&nbsp;<span class="ident" id="2662024">flagAddr</span>&nbsp;<span class="op" id="2662033">|</span>&nbsp;<span class="ident" id="2662035">flagIndir</span><span class="op" id="2662044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662047">fl</span>&nbsp;<span class="op" id="2662050">|=</span>&nbsp;<span class="ident" id="2662053">flag</span><span class="op" id="2662057">(</span><span class="ident" id="2662058">v</span><span class="op" id="2662059">.</span><span class="ident" id="2662060">typ</span><span class="op" id="2662063">.</span><span class="ident" id="2662064">Kind</span><span class="op" id="2662068">(</span><span class="op" id="2662069">)</span><span class="op" id="2662070">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662073">rcvr</span>&nbsp;<span class="op" id="2662078">:=</span>&nbsp;<span class="ident" id="2662081">Value</span><span class="op" id="2662086">{</span><span class="ident" id="2662087">v</span><span class="op" id="2662088">.</span><span class="ident" id="2662089">typ</span><span class="op" id="2662092">,</span>&nbsp;<span class="ident" id="2662094">v</span><span class="op" id="2662095">.</span><span class="ident" id="2662096">ptr</span><span class="op" id="2662099">,</span>&nbsp;<span class="ident" id="2662101">fl</span><span class="op" id="2662103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662107">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662163">funcType</span>&nbsp;<span class="op" id="2662172">:=</span>&nbsp;<span class="ident" id="2662175">v</span><span class="op" id="2662176">.</span><span class="ident" id="2662177">Type</span><span class="op" id="2662181">(</span><span class="op" id="2662182">)</span><span class="op" id="2662183">.</span><span class="op" id="2662184">(</span><span class="op" id="2662185">*</span><span class="ident" id="2662186">rtype</span><span class="op" id="2662191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662195">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662240">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662295">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662355">dummy</span>&nbsp;<span class="op" id="2662361">:=</span>&nbsp;<span class="ident" id="2662364">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662381">code</span>&nbsp;<span class="op" id="2662386">:=</span>&nbsp;<span class="op" id="2662389">*</span><span class="op" id="2662390">*</span><span class="op" id="2662391">(</span><span class="op" id="2662392">*</span><span class="op" id="2662393">*</span><span class="builtintype" id="2662394">uintptr</span><span class="op" id="2662401">)</span><span class="op" id="2662402">(</span><span class="ident" id="2662403">unsafe</span><span class="op" id="2662409">.</span><span class="ident" id="2662410">Pointer</span><span class="op" id="2662417">(</span><span class="op" id="2662418">&amp;</span><span class="ident" id="2662419">dummy</span><span class="op" id="2662424">)</span><span class="op" id="2662425">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662429">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662489">_</span><span class="op" id="2662490">,</span>&nbsp;<span class="ident" id="2662492">_</span><span class="op" id="2662493">,</span>&nbsp;<span class="ident" id="2662495">_</span><span class="op" id="2662496">,</span>&nbsp;<span class="ident" id="2662498">stack</span>&nbsp;<span class="op" id="2662504">:=</span>&nbsp;<span class="ident" id="2662507">funcLayout</span><span class="op" id="2662517">(</span><span class="ident" id="2662518">funcType</span><span class="op" id="2662526">,</span>&nbsp;<span class="ident" id="2662528">nil</span><span class="op" id="2662531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662535">fv</span>&nbsp;<span class="op" id="2662538">:=</span>&nbsp;<span class="op" id="2662541">&amp;</span><span class="ident" id="2662542">methodValue</span><span class="op" id="2662553">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662557">fn</span><span class="op" id="2662559">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2662565">code</span><span class="op" id="2662569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662573">stack</span><span class="op" id="2662578">:</span>&nbsp;&nbsp;<span class="ident" id="2662581">stack</span><span class="op" id="2662586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662590">method</span><span class="op" id="2662596">:</span>&nbsp;<span class="builtintype" id="2662598">int</span><span class="op" id="2662601">(</span><span class="ident" id="2662602">v</span><span class="op" id="2662603">.</span><span class="ident" id="2662604">flag</span><span class="op" id="2662608">)</span>&nbsp;<span class="op" id="2662610">&gt;&gt;</span>&nbsp;<span class="ident" id="2662613">flagMethodShift</span><span class="op" id="2662628">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662632">rcvr</span><span class="op" id="2662636">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2662640">rcvr</span><span class="op" id="2662644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2662647">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662651">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662697">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662763">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662827">methodReceiver</span><span class="op" id="2662841">(</span><span class="ident" id="2662842">op</span><span class="op" id="2662844">,</span>&nbsp;<span class="ident" id="2662846">fv</span><span class="op" id="2662848">.</span><span class="ident" id="2662849">rcvr</span><span class="op" id="2662853">,</span>&nbsp;<span class="ident" id="2662855">fv</span><span class="op" id="2662857">.</span><span class="ident" id="2662858">method</span><span class="op" id="2662864">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2662868">return</span>&nbsp;<span class="ident" id="2662875">Value</span><span class="op" id="2662880">{</span><span class="ident" id="2662881">funcType</span><span class="op" id="2662889">,</span>&nbsp;<span class="ident" id="2662891">unsafe</span><span class="op" id="2662897">.</span><span class="ident" id="2662898">Pointer</span><span class="op" id="2662905">(</span><span class="ident" id="2662906">fv</span><span class="op" id="2662908">)</span><span class="op" id="2662909">,</span>&nbsp;<span class="ident" id="2662911">v</span><span class="op" id="2662912">.</span><span class="ident" id="2662913">flag</span><span class="op" id="2662917">&amp;</span><span class="ident" id="2662918">flagRO</span>&nbsp;<span class="op" id="2662925">|</span>&nbsp;<span class="ident" id="2662927">flag</span><span class="op" id="2662931">(</span><span class="ident" id="2662932">Func</span><span class="op" id="2662936">)</span><span class="op" id="2662937">}</span><br>
<span class="lineno"></span><span class="op" id="2662939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2662942">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2663010">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2663083">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2663160">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2663234">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2663275">func</span>&nbsp;<span class="ident" id="2663280">methodValueCall</span><span class="op" id="2663295">(</span><span class="op" id="2663296">)</span>
</div>
</body>
</html>
