<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8403003">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8403058">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8403112">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8403163">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8403189">package</span>&nbsp;<span class="ident" id="8403197">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8403202">import</span>&nbsp;<span class="op" id="8403209">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403212">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403221">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403228">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403234">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403241">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403253">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403274">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403280">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403291">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403308">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403319">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403330">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403341">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8403352">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8403359">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="8403362">func</span>&nbsp;<span class="ident" id="8403367">newRequest</span><span class="op" id="8403377">(</span><span class="ident" id="8403378">httpreq</span>&nbsp;<span class="builtintype" id="8403386">string</span><span class="op" id="8403392">)</span>&nbsp;<span class="op" id="8403394">*</span><span class="ident" id="8403395">http</span><span class="op" id="8403399">.</span><span class="ident" id="8403400">Request</span>&nbsp;<span class="op" id="8403408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403411">buf</span>&nbsp;<span class="op" id="8403415">:=</span>&nbsp;<span class="ident" id="8403418">bufio</span><span class="op" id="8403423">.</span><span class="ident" id="8403424">NewReader</span><span class="op" id="8403433">(</span><span class="ident" id="8403434">strings</span><span class="op" id="8403441">.</span><span class="ident" id="8403442">NewReader</span><span class="op" id="8403451">(</span><span class="ident" id="8403452">httpreq</span><span class="op" id="8403459">)</span><span class="op" id="8403460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403463">req</span><span class="op" id="8403466">,</span>&nbsp;<span class="ident" id="8403468">err</span>&nbsp;<span class="op" id="8403472">:=</span>&nbsp;<span class="ident" id="8403475">http</span><span class="op" id="8403479">.</span><span class="ident" id="8403480">ReadRequest</span><span class="op" id="8403491">(</span><span class="ident" id="8403492">buf</span><span class="op" id="8403495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403498">if</span>&nbsp;<span class="ident" id="8403501">err</span>&nbsp;<span class="op" id="8403505">!=</span>&nbsp;<span class="ident" id="8403508">nil</span>&nbsp;<span class="op" id="8403512">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8403516">panic</span><span class="op" id="8403521">(</span><span class="string" id="8403522">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="8403558">+</span>&nbsp;<span class="ident" id="8403560">httpreq</span><span class="op" id="8403567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8403570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403573">req</span><span class="op" id="8403576">.</span><span class="ident" id="8403577">RemoteAddr</span>&nbsp;<span class="op" id="8403588">=</span>&nbsp;<span class="string" id="8403590">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403601">return</span>&nbsp;<span class="ident" id="8403608">req</span><br>
<span class="lineno"></span><span class="op" id="8403612">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="8403615">func</span>&nbsp;<span class="ident" id="8403620">runCgiTest</span><span class="op" id="8403630">(</span><span class="ident" id="8403631">t</span>&nbsp;<span class="op" id="8403633">*</span><span class="ident" id="8403634">testing</span><span class="op" id="8403641">.</span><span class="ident" id="8403642">T</span><span class="op" id="8403643">,</span>&nbsp;<span class="ident" id="8403645">h</span>&nbsp;<span class="op" id="8403647">*</span><span class="ident" id="8403648">Handler</span><span class="op" id="8403655">,</span>&nbsp;<span class="ident" id="8403657">httpreq</span>&nbsp;<span class="builtintype" id="8403665">string</span><span class="op" id="8403671">,</span>&nbsp;<span class="ident" id="8403673">expectedMap</span>&nbsp;<span class="keyword" id="8403685">map</span><span class="op" id="8403688">[</span><span class="builtintype" id="8403689">string</span><span class="op" id="8403695">]</span><span class="builtintype" id="8403696">string</span><span class="op" id="8403702">)</span>&nbsp;<span class="op" id="8403704">*</span><span class="ident" id="8403705">httptest</span><span class="op" id="8403713">.</span><span class="ident" id="8403714">ResponseRecorder</span>&nbsp;<span class="op" id="8403731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403734">rw</span>&nbsp;<span class="op" id="8403737">:=</span>&nbsp;<span class="ident" id="8403740">httptest</span><span class="op" id="8403748">.</span><span class="ident" id="8403749">NewRecorder</span><span class="op" id="8403760">(</span><span class="op" id="8403761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403764">req</span>&nbsp;<span class="op" id="8403768">:=</span>&nbsp;<span class="ident" id="8403771">newRequest</span><span class="op" id="8403781">(</span><span class="ident" id="8403782">httpreq</span><span class="op" id="8403789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403792">h</span><span class="op" id="8403793">.</span><span class="ident" id="8403794">ServeHTTP</span><span class="op" id="8403803">(</span><span class="ident" id="8403804">rw</span><span class="op" id="8403806">,</span>&nbsp;<span class="ident" id="8403808">req</span><span class="op" id="8403811">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8403815">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403873">m</span>&nbsp;<span class="op" id="8403875">:=</span>&nbsp;<span class="builtinfunc" id="8403878">make</span><span class="op" id="8403882">(</span><span class="keyword" id="8403883">map</span><span class="op" id="8403886">[</span><span class="builtintype" id="8403887">string</span><span class="op" id="8403893">]</span><span class="builtintype" id="8403894">string</span><span class="op" id="8403900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403903">m</span><span class="op" id="8403904">[</span><span class="string" id="8403905">&#34;_body&#34;</span><span class="op" id="8403912">]</span>&nbsp;<span class="op" id="8403914">=</span>&nbsp;<span class="ident" id="8403916">rw</span><span class="op" id="8403918">.</span><span class="ident" id="8403919">Body</span><span class="op" id="8403923">.</span><span class="ident" id="8403924">String</span><span class="op" id="8403930">(</span><span class="op" id="8403931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403934">linesRead</span>&nbsp;<span class="op" id="8403944">:=</span>&nbsp;<span class="num" id="8403947">0</span><br>
<span class="lineno">45</span><span class="ident" id="8403949">readlines</span><span class="op" id="8403958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8403961">for</span>&nbsp;<span class="op" id="8403965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8403969">line</span><span class="op" id="8403973">,</span>&nbsp;<span class="ident" id="8403975">err</span>&nbsp;<span class="op" id="8403979">:=</span>&nbsp;<span class="ident" id="8403982">rw</span><span class="op" id="8403984">.</span><span class="ident" id="8403985">Body</span><span class="op" id="8403989">.</span><span class="ident" id="8403990">ReadString</span><span class="op" id="8404000">(</span><span class="string" id="8404001">&#39;\n&#39;</span><span class="op" id="8404005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404009">switch</span>&nbsp;<span class="op" id="8404016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404020">case</span>&nbsp;<span class="ident" id="8404025">err</span>&nbsp;<span class="op" id="8404029">==</span>&nbsp;<span class="ident" id="8404032">io</span><span class="op" id="8404034">.</span><span class="ident" id="8404035">EOF</span><span class="op" id="8404038">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404043">break</span>&nbsp;<span class="ident" id="8404049">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404061">case</span>&nbsp;<span class="ident" id="8404066">err</span>&nbsp;<span class="op" id="8404070">!=</span>&nbsp;<span class="ident" id="8404073">nil</span><span class="op" id="8404076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404081">t</span><span class="op" id="8404082">.</span><span class="ident" id="8404083">Fatalf</span><span class="op" id="8404089">(</span><span class="string" id="8404090">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="8404129">,</span>&nbsp;<span class="ident" id="8404131">err</span><span class="op" id="8404134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404142">linesRead</span><span class="op" id="8404151">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404156">trimmedLine</span>&nbsp;<span class="op" id="8404168">:=</span>&nbsp;<span class="ident" id="8404171">strings</span><span class="op" id="8404178">.</span><span class="ident" id="8404179">TrimRight</span><span class="op" id="8404188">(</span><span class="ident" id="8404189">line</span><span class="op" id="8404193">,</span>&nbsp;<span class="string" id="8404195">&#34;\r\n&#34;</span><span class="op" id="8404201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404205">split</span>&nbsp;<span class="op" id="8404211">:=</span>&nbsp;<span class="ident" id="8404214">strings</span><span class="op" id="8404221">.</span><span class="ident" id="8404222">SplitN</span><span class="op" id="8404228">(</span><span class="ident" id="8404229">trimmedLine</span><span class="op" id="8404240">,</span>&nbsp;<span class="string" id="8404242">&#34;=&#34;</span><span class="op" id="8404245">,</span>&nbsp;<span class="num" id="8404247">2</span><span class="op" id="8404248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404252">if</span>&nbsp;<span class="builtinfunc" id="8404255">len</span><span class="op" id="8404258">(</span><span class="ident" id="8404259">split</span><span class="op" id="8404264">)</span>&nbsp;<span class="op" id="8404266">!=</span>&nbsp;<span class="num" id="8404269">2</span>&nbsp;<span class="op" id="8404271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404276">t</span><span class="op" id="8404277">.</span><span class="ident" id="8404278">Fatalf</span><span class="op" id="8404284">(</span><span class="string" id="8404285">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="8404355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8404361">len</span><span class="op" id="8404364">(</span><span class="ident" id="8404365">split</span><span class="op" id="8404370">)</span><span class="op" id="8404371">,</span>&nbsp;<span class="ident" id="8404373">linesRead</span><span class="op" id="8404382">,</span>&nbsp;<span class="ident" id="8404384">line</span><span class="op" id="8404388">,</span>&nbsp;<span class="ident" id="8404390">m</span><span class="op" id="8404391">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404399">m</span><span class="op" id="8404400">[</span><span class="ident" id="8404401">split</span><span class="op" id="8404406">[</span><span class="num" id="8404407">0</span><span class="op" id="8404408">]</span><span class="op" id="8404409">]</span>&nbsp;<span class="op" id="8404411">=</span>&nbsp;<span class="ident" id="8404413">split</span><span class="op" id="8404418">[</span><span class="num" id="8404419">1</span><span class="op" id="8404420">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404427">for</span>&nbsp;<span class="ident" id="8404431">key</span><span class="op" id="8404434">,</span>&nbsp;<span class="ident" id="8404436">expected</span>&nbsp;<span class="op" id="8404445">:=</span>&nbsp;<span class="keyword" id="8404448">range</span>&nbsp;<span class="ident" id="8404454">expectedMap</span>&nbsp;<span class="op" id="8404466">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404470">got</span>&nbsp;<span class="op" id="8404474">:=</span>&nbsp;<span class="ident" id="8404477">m</span><span class="op" id="8404478">[</span><span class="ident" id="8404479">key</span><span class="op" id="8404482">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404486">if</span>&nbsp;<span class="ident" id="8404489">key</span>&nbsp;<span class="op" id="8404493">==</span>&nbsp;<span class="string" id="8404496">&#34;cwd&#34;</span>&nbsp;<span class="op" id="8404502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8404507">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404549">fi1</span><span class="op" id="8404552">,</span>&nbsp;<span class="ident" id="8404554">_</span>&nbsp;<span class="op" id="8404556">:=</span>&nbsp;<span class="ident" id="8404559">os</span><span class="op" id="8404561">.</span><span class="ident" id="8404562">Stat</span><span class="op" id="8404566">(</span><span class="ident" id="8404567">got</span><span class="op" id="8404570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404575">fi2</span><span class="op" id="8404578">,</span>&nbsp;<span class="ident" id="8404580">_</span>&nbsp;<span class="op" id="8404582">:=</span>&nbsp;<span class="ident" id="8404585">os</span><span class="op" id="8404587">.</span><span class="ident" id="8404588">Stat</span><span class="op" id="8404592">(</span><span class="ident" id="8404593">expected</span><span class="op" id="8404601">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404606">if</span>&nbsp;<span class="ident" id="8404609">os</span><span class="op" id="8404611">.</span><span class="ident" id="8404612">SameFile</span><span class="op" id="8404620">(</span><span class="ident" id="8404621">fi1</span><span class="op" id="8404624">,</span>&nbsp;<span class="ident" id="8404626">fi2</span><span class="op" id="8404629">)</span>&nbsp;<span class="op" id="8404631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404637">got</span>&nbsp;<span class="op" id="8404641">=</span>&nbsp;<span class="ident" id="8404643">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404663">if</span>&nbsp;<span class="ident" id="8404666">got</span>&nbsp;<span class="op" id="8404670">!=</span>&nbsp;<span class="ident" id="8404673">expected</span>&nbsp;<span class="op" id="8404682">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404687">t</span><span class="op" id="8404688">.</span><span class="ident" id="8404689">Errorf</span><span class="op" id="8404695">(</span><span class="string" id="8404696">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8404728">,</span>&nbsp;<span class="ident" id="8404730">key</span><span class="op" id="8404733">,</span>&nbsp;<span class="ident" id="8404735">got</span><span class="op" id="8404738">,</span>&nbsp;<span class="ident" id="8404740">expected</span><span class="op" id="8404748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404758">return</span>&nbsp;<span class="ident" id="8404765">rw</span><br>
<span class="lineno"></span><span class="op" id="8404768">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="8404771">var</span>&nbsp;<span class="ident" id="8404775">cgiTested</span><span class="op" id="8404784">,</span>&nbsp;<span class="ident" id="8404786">cgiWorks</span>&nbsp;<span class="builtintype" id="8404795">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404801">func</span>&nbsp;<span class="ident" id="8404806">check</span><span class="op" id="8404811">(</span><span class="ident" id="8404812">t</span>&nbsp;<span class="op" id="8404814">*</span><span class="ident" id="8404815">testing</span><span class="op" id="8404822">.</span><span class="ident" id="8404823">T</span><span class="op" id="8404824">)</span>&nbsp;<span class="op" id="8404826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404829">if</span>&nbsp;<span class="op" id="8404832">!</span><span class="ident" id="8404833">cgiTested</span>&nbsp;<span class="op" id="8404843">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404847">cgiTested</span>&nbsp;<span class="op" id="8404857">=</span>&nbsp;<span class="builtintype" id="8404859">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8404866">cgiWorks</span>&nbsp;<span class="op" id="8404875">=</span>&nbsp;<span class="ident" id="8404877">exec</span><span class="op" id="8404881">.</span><span class="ident" id="8404882">Command</span><span class="op" id="8404889">(</span><span class="string" id="8404890">&#34;./testdata/test.cgi&#34;</span><span class="op" id="8404911">)</span><span class="op" id="8404912">.</span><span class="ident" id="8404913">Run</span><span class="op" id="8404916">(</span><span class="op" id="8404917">)</span>&nbsp;<span class="op" id="8404919">==</span>&nbsp;<span class="ident" id="8404922">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8404927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8404930">if</span>&nbsp;<span class="op" id="8404933">!</span><span class="ident" id="8404934">cgiWorks</span>&nbsp;<span class="op" id="8404943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8404947">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8404991">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405042">t</span><span class="op" id="8405043">.</span><span class="ident" id="8405044">Skip</span><span class="op" id="8405048">(</span><span class="string" id="8405049">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="8405082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405085">}</span><br>
<span class="lineno"></span><span class="op" id="8405087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8405090">func</span>&nbsp;<span class="ident" id="8405095">TestCGIBasicGet</span><span class="op" id="8405110">(</span><span class="ident" id="8405111">t</span>&nbsp;<span class="op" id="8405113">*</span><span class="ident" id="8405114">testing</span><span class="op" id="8405121">.</span><span class="ident" id="8405122">T</span><span class="op" id="8405123">)</span>&nbsp;<span class="op" id="8405125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405128">check</span><span class="op" id="8405133">(</span><span class="ident" id="8405134">t</span><span class="op" id="8405135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405138">h</span>&nbsp;<span class="op" id="8405140">:=</span>&nbsp;<span class="op" id="8405143">&amp;</span><span class="ident" id="8405144">Handler</span><span class="op" id="8405151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405155">Path</span><span class="op" id="8405159">:</span>&nbsp;<span class="string" id="8405161">&#34;testdata/test.cgi&#34;</span><span class="op" id="8405180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405184">Root</span><span class="op" id="8405188">:</span>&nbsp;<span class="string" id="8405190">&#34;/test.cgi&#34;</span><span class="op" id="8405201">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405207">expectedMap</span>&nbsp;<span class="op" id="8405219">:=</span>&nbsp;<span class="keyword" id="8405222">map</span><span class="op" id="8405225">[</span><span class="builtintype" id="8405226">string</span><span class="op" id="8405232">]</span><span class="builtintype" id="8405233">string</span><span class="op" id="8405239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405243">&#34;test&#34;</span><span class="op" id="8405249">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405268">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8405279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405283">&#34;param-a&#34;</span><span class="op" id="8405292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405308">&#34;b&#34;</span><span class="op" id="8405311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405315">&#34;param-foo&#34;</span><span class="op" id="8405326">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405340">&#34;bar&#34;</span><span class="op" id="8405345">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405349">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8405372">:</span>&nbsp;<span class="string" id="8405374">&#34;CGI/1.1&#34;</span><span class="op" id="8405383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405387">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8405402">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405412">&#34;example.com&#34;</span><span class="op" id="8405425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405429">&#34;env-PATH_INFO&#34;</span><span class="op" id="8405444">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405454">&#34;&#34;</span><span class="op" id="8405456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405460">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8405478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405485">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8405498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405502">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8405519">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405527">&#34;1.2.3.4&#34;</span><span class="op" id="8405536">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405540">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8405557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405565">&#34;1.2.3.4&#34;</span><span class="op" id="8405574">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405578">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8405598">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405603">&#34;GET&#34;</span><span class="op" id="8405608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405612">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8405629">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405637">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8405660">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405664">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8405685">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8405689">&#34;testdata/test.cgi&#34;</span><span class="op" id="8405708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405712">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8405729">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405737">&#34;/test.cgi&#34;</span><span class="op" id="8405748">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405752">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8405769">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405777">&#34;example.com&#34;</span><span class="op" id="8405790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405794">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8405811">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405819">&#34;80&#34;</span><span class="op" id="8405823">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8405827">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8405848">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8405852">&#34;go&#34;</span><span class="op" id="8405856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8405862">replay</span>&nbsp;<span class="op" id="8405869">:=</span>&nbsp;<span class="ident" id="8405872">runCgiTest</span><span class="op" id="8405882">(</span><span class="ident" id="8405883">t</span><span class="op" id="8405884">,</span>&nbsp;<span class="ident" id="8405886">h</span><span class="op" id="8405887">,</span>&nbsp;<span class="string" id="8405889">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8405948">,</span>&nbsp;<span class="ident" id="8405950">expectedMap</span><span class="op" id="8405961">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8405965">if</span>&nbsp;<span class="ident" id="8405968">expected</span><span class="op" id="8405976">,</span>&nbsp;<span class="ident" id="8405978">got</span>&nbsp;<span class="op" id="8405982">:=</span>&nbsp;<span class="string" id="8405985">&#34;text/html&#34;</span><span class="op" id="8405996">,</span>&nbsp;<span class="ident" id="8405998">replay</span><span class="op" id="8406004">.</span><span class="ident" id="8406005">Header</span><span class="op" id="8406011">(</span><span class="op" id="8406012">)</span><span class="op" id="8406013">.</span><span class="ident" id="8406014">Get</span><span class="op" id="8406017">(</span><span class="string" id="8406018">&#34;Content-Type&#34;</span><span class="op" id="8406032">)</span><span class="op" id="8406033">;</span>&nbsp;<span class="ident" id="8406035">got</span>&nbsp;<span class="op" id="8406039">!=</span>&nbsp;<span class="ident" id="8406042">expected</span>&nbsp;<span class="op" id="8406051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406055">t</span><span class="op" id="8406056">.</span><span class="ident" id="8406057">Errorf</span><span class="op" id="8406063">(</span><span class="string" id="8406064">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8406103">,</span>&nbsp;<span class="ident" id="8406105">got</span><span class="op" id="8406108">,</span>&nbsp;<span class="ident" id="8406110">expected</span><span class="op" id="8406118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406124">if</span>&nbsp;<span class="ident" id="8406127">expected</span><span class="op" id="8406135">,</span>&nbsp;<span class="ident" id="8406137">got</span>&nbsp;<span class="op" id="8406141">:=</span>&nbsp;<span class="string" id="8406144">&#34;X-Test-Value&#34;</span><span class="op" id="8406158">,</span>&nbsp;<span class="ident" id="8406160">replay</span><span class="op" id="8406166">.</span><span class="ident" id="8406167">Header</span><span class="op" id="8406173">(</span><span class="op" id="8406174">)</span><span class="op" id="8406175">.</span><span class="ident" id="8406176">Get</span><span class="op" id="8406179">(</span><span class="string" id="8406180">&#34;X-Test-Header&#34;</span><span class="op" id="8406195">)</span><span class="op" id="8406196">;</span>&nbsp;<span class="ident" id="8406198">got</span>&nbsp;<span class="op" id="8406202">!=</span>&nbsp;<span class="ident" id="8406205">expected</span>&nbsp;<span class="op" id="8406214">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406218">t</span><span class="op" id="8406219">.</span><span class="ident" id="8406220">Errorf</span><span class="op" id="8406226">(</span><span class="string" id="8406227">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8406267">,</span>&nbsp;<span class="ident" id="8406269">got</span><span class="op" id="8406272">,</span>&nbsp;<span class="ident" id="8406274">expected</span><span class="op" id="8406282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406285">}</span><br>
<span class="lineno"></span><span class="op" id="8406287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8406290">func</span>&nbsp;<span class="ident" id="8406295">TestCGIBasicGetAbsPath</span><span class="op" id="8406317">(</span><span class="ident" id="8406318">t</span>&nbsp;<span class="op" id="8406320">*</span><span class="ident" id="8406321">testing</span><span class="op" id="8406328">.</span><span class="ident" id="8406329">T</span><span class="op" id="8406330">)</span>&nbsp;<span class="op" id="8406332">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406335">check</span><span class="op" id="8406340">(</span><span class="ident" id="8406341">t</span><span class="op" id="8406342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406345">pwd</span><span class="op" id="8406348">,</span>&nbsp;<span class="ident" id="8406350">err</span>&nbsp;<span class="op" id="8406354">:=</span>&nbsp;<span class="ident" id="8406357">os</span><span class="op" id="8406359">.</span><span class="ident" id="8406360">Getwd</span><span class="op" id="8406365">(</span><span class="op" id="8406366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8406369">if</span>&nbsp;<span class="ident" id="8406372">err</span>&nbsp;<span class="op" id="8406376">!=</span>&nbsp;<span class="ident" id="8406379">nil</span>&nbsp;<span class="op" id="8406383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406387">t</span><span class="op" id="8406388">.</span><span class="ident" id="8406389">Fatalf</span><span class="op" id="8406395">(</span><span class="string" id="8406396">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8406413">,</span>&nbsp;<span class="ident" id="8406415">err</span><span class="op" id="8406418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406421">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406424">h</span>&nbsp;<span class="op" id="8406426">:=</span>&nbsp;<span class="op" id="8406429">&amp;</span><span class="ident" id="8406430">Handler</span><span class="op" id="8406437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406441">Path</span><span class="op" id="8406445">:</span>&nbsp;<span class="ident" id="8406447">pwd</span>&nbsp;<span class="op" id="8406451">+</span>&nbsp;<span class="string" id="8406453">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8406473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406477">Root</span><span class="op" id="8406481">:</span>&nbsp;<span class="string" id="8406483">&#34;/test.cgi&#34;</span><span class="op" id="8406494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406500">expectedMap</span>&nbsp;<span class="op" id="8406512">:=</span>&nbsp;<span class="keyword" id="8406515">map</span><span class="op" id="8406518">[</span><span class="builtintype" id="8406519">string</span><span class="op" id="8406525">]</span><span class="builtintype" id="8406526">string</span><span class="op" id="8406532">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406536">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8406553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406559">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8406582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406586">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8406607">:</span>&nbsp;<span class="ident" id="8406609">pwd</span>&nbsp;<span class="op" id="8406613">+</span>&nbsp;<span class="string" id="8406615">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8406635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406639">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8406656">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406662">&#34;/test.cgi&#34;</span><span class="op" id="8406673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406679">runCgiTest</span><span class="op" id="8406689">(</span><span class="ident" id="8406690">t</span><span class="op" id="8406691">,</span>&nbsp;<span class="ident" id="8406693">h</span><span class="op" id="8406694">,</span>&nbsp;<span class="string" id="8406696">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8406755">,</span>&nbsp;<span class="ident" id="8406757">expectedMap</span><span class="op" id="8406768">)</span><br>
<span class="lineno">145</span><span class="op" id="8406770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8406773">func</span>&nbsp;<span class="ident" id="8406778">TestPathInfo</span><span class="op" id="8406790">(</span><span class="ident" id="8406791">t</span>&nbsp;<span class="op" id="8406793">*</span><span class="ident" id="8406794">testing</span><span class="op" id="8406801">.</span><span class="ident" id="8406802">T</span><span class="op" id="8406803">)</span>&nbsp;<span class="op" id="8406805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406808">check</span><span class="op" id="8406813">(</span><span class="ident" id="8406814">t</span><span class="op" id="8406815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406818">h</span>&nbsp;<span class="op" id="8406820">:=</span>&nbsp;<span class="op" id="8406823">&amp;</span><span class="ident" id="8406824">Handler</span><span class="op" id="8406831">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406835">Path</span><span class="op" id="8406839">:</span>&nbsp;<span class="string" id="8406841">&#34;testdata/test.cgi&#34;</span><span class="op" id="8406860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406864">Root</span><span class="op" id="8406868">:</span>&nbsp;<span class="string" id="8406870">&#34;/test.cgi&#34;</span><span class="op" id="8406881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8406884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8406887">expectedMap</span>&nbsp;<span class="op" id="8406899">:=</span>&nbsp;<span class="keyword" id="8406902">map</span><span class="op" id="8406905">[</span><span class="builtintype" id="8406906">string</span><span class="op" id="8406912">]</span><span class="builtintype" id="8406913">string</span><span class="op" id="8406919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406923">&#34;param-a&#34;</span><span class="op" id="8406932">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406946">&#34;b&#34;</span><span class="op" id="8406949">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406953">&#34;env-PATH_INFO&#34;</span><span class="op" id="8406968">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406976">&#34;/extrapath&#34;</span><span class="op" id="8406988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8406992">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8407010">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407015">&#34;a=b&#34;</span><span class="op" id="8407020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407024">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8407041">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407047">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="8407072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407076">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8407097">:</span>&nbsp;<span class="string" id="8407099">&#34;testdata/test.cgi&#34;</span><span class="op" id="8407118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407122">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8407139">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407145">&#34;/test.cgi&#34;</span><span class="op" id="8407156">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407162">runCgiTest</span><span class="op" id="8407172">(</span><span class="ident" id="8407173">t</span><span class="op" id="8407174">,</span>&nbsp;<span class="ident" id="8407176">h</span><span class="op" id="8407177">,</span>&nbsp;<span class="string" id="8407179">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8407240">,</span>&nbsp;<span class="ident" id="8407242">expectedMap</span><span class="op" id="8407253">)</span><br>
<span class="lineno"></span><span class="op" id="8407255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407258">func</span>&nbsp;<span class="ident" id="8407263">TestPathInfoDirRoot</span><span class="op" id="8407282">(</span><span class="ident" id="8407283">t</span>&nbsp;<span class="op" id="8407285">*</span><span class="ident" id="8407286">testing</span><span class="op" id="8407293">.</span><span class="ident" id="8407294">T</span><span class="op" id="8407295">)</span>&nbsp;<span class="op" id="8407297">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407300">check</span><span class="op" id="8407305">(</span><span class="ident" id="8407306">t</span><span class="op" id="8407307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407310">h</span>&nbsp;<span class="op" id="8407312">:=</span>&nbsp;<span class="op" id="8407315">&amp;</span><span class="ident" id="8407316">Handler</span><span class="op" id="8407323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407327">Path</span><span class="op" id="8407331">:</span>&nbsp;<span class="string" id="8407333">&#34;testdata/test.cgi&#34;</span><span class="op" id="8407352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407356">Root</span><span class="op" id="8407360">:</span>&nbsp;<span class="string" id="8407362">&#34;/myscript/&#34;</span><span class="op" id="8407374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407377">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407380">expectedMap</span>&nbsp;<span class="op" id="8407392">:=</span>&nbsp;<span class="keyword" id="8407395">map</span><span class="op" id="8407398">[</span><span class="builtintype" id="8407399">string</span><span class="op" id="8407405">]</span><span class="builtintype" id="8407406">string</span><span class="op" id="8407412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407416">&#34;env-PATH_INFO&#34;</span><span class="op" id="8407431">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407439">&#34;bar&#34;</span><span class="op" id="8407444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407448">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8407466">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407471">&#34;a=b&#34;</span><span class="op" id="8407476">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407480">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8407497">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407503">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8407522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407526">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8407547">:</span>&nbsp;<span class="string" id="8407549">&#34;testdata/test.cgi&#34;</span><span class="op" id="8407568">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407572">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8407589">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407595">&#34;/myscript/&#34;</span><span class="op" id="8407607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407613">runCgiTest</span><span class="op" id="8407623">(</span><span class="ident" id="8407624">t</span><span class="op" id="8407625">,</span>&nbsp;<span class="ident" id="8407627">h</span><span class="op" id="8407628">,</span>&nbsp;<span class="string" id="8407630">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8407685">,</span>&nbsp;<span class="ident" id="8407687">expectedMap</span><span class="op" id="8407698">)</span><br>
<span class="lineno"></span><span class="op" id="8407700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8407703">func</span>&nbsp;<span class="ident" id="8407708">TestDupHeaders</span><span class="op" id="8407722">(</span><span class="ident" id="8407723">t</span>&nbsp;<span class="op" id="8407725">*</span><span class="ident" id="8407726">testing</span><span class="op" id="8407733">.</span><span class="ident" id="8407734">T</span><span class="op" id="8407735">)</span>&nbsp;<span class="op" id="8407737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407740">check</span><span class="op" id="8407745">(</span><span class="ident" id="8407746">t</span><span class="op" id="8407747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407750">h</span>&nbsp;<span class="op" id="8407752">:=</span>&nbsp;<span class="op" id="8407755">&amp;</span><span class="ident" id="8407756">Handler</span><span class="op" id="8407763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407767">Path</span><span class="op" id="8407771">:</span>&nbsp;<span class="string" id="8407773">&#34;testdata/test.cgi&#34;</span><span class="op" id="8407792">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8407795">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8407798">expectedMap</span>&nbsp;<span class="op" id="8407810">:=</span>&nbsp;<span class="keyword" id="8407813">map</span><span class="op" id="8407816">[</span><span class="builtintype" id="8407817">string</span><span class="op" id="8407823">]</span><span class="builtintype" id="8407824">string</span><span class="op" id="8407830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407834">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8407851">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407857">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8407876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407880">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8407901">:</span>&nbsp;<span class="string" id="8407903">&#34;testdata/test.cgi&#34;</span><span class="op" id="8407922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407926">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="8407943">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407949">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="8407967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407971">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="8407987">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8407994">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="8408006">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408012">runCgiTest</span><span class="op" id="8408022">(</span><span class="ident" id="8408023">t</span><span class="op" id="8408024">,</span>&nbsp;<span class="ident" id="8408026">h</span><span class="op" id="8408027">,</span>&nbsp;<span class="string" id="8408029">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="8408063">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408067">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="8408086">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408090">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="8408109">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408113">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="8408128">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408132">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="8408147">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408151">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="8408174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408178">expectedMap</span><span class="op" id="8408189">)</span><br>
<span class="lineno"></span><span class="op" id="8408191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="8408194">func</span>&nbsp;<span class="ident" id="8408199">TestPathInfoNoRoot</span><span class="op" id="8408217">(</span><span class="ident" id="8408218">t</span>&nbsp;<span class="op" id="8408220">*</span><span class="ident" id="8408221">testing</span><span class="op" id="8408228">.</span><span class="ident" id="8408229">T</span><span class="op" id="8408230">)</span>&nbsp;<span class="op" id="8408232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408235">check</span><span class="op" id="8408240">(</span><span class="ident" id="8408241">t</span><span class="op" id="8408242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408245">h</span>&nbsp;<span class="op" id="8408247">:=</span>&nbsp;<span class="op" id="8408250">&amp;</span><span class="ident" id="8408251">Handler</span><span class="op" id="8408258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408262">Path</span><span class="op" id="8408266">:</span>&nbsp;<span class="string" id="8408268">&#34;testdata/test.cgi&#34;</span><span class="op" id="8408287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408291">Root</span><span class="op" id="8408295">:</span>&nbsp;<span class="string" id="8408297">&#34;&#34;</span><span class="op" id="8408299">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408305">expectedMap</span>&nbsp;<span class="op" id="8408317">:=</span>&nbsp;<span class="keyword" id="8408320">map</span><span class="op" id="8408323">[</span><span class="builtintype" id="8408324">string</span><span class="op" id="8408330">]</span><span class="builtintype" id="8408331">string</span><span class="op" id="8408337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408341">&#34;env-PATH_INFO&#34;</span><span class="op" id="8408356">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408364">&#34;/bar&#34;</span><span class="op" id="8408370">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408374">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8408392">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408397">&#34;a=b&#34;</span><span class="op" id="8408402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408406">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8408423">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408429">&#34;/bar?a=b&#34;</span><span class="op" id="8408439">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408443">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8408464">:</span>&nbsp;<span class="string" id="8408466">&#34;testdata/test.cgi&#34;</span><span class="op" id="8408485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408489">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8408506">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408512">&#34;/&#34;</span><span class="op" id="8408515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408521">runCgiTest</span><span class="op" id="8408531">(</span><span class="ident" id="8408532">t</span><span class="op" id="8408533">,</span>&nbsp;<span class="ident" id="8408535">h</span><span class="op" id="8408536">,</span>&nbsp;<span class="string" id="8408538">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8408584">,</span>&nbsp;<span class="ident" id="8408586">expectedMap</span><span class="op" id="8408597">)</span><br>
<span class="lineno"></span><span class="op" id="8408599">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8408602">func</span>&nbsp;<span class="ident" id="8408607">TestCGIBasicPost</span><span class="op" id="8408623">(</span><span class="ident" id="8408624">t</span>&nbsp;<span class="op" id="8408626">*</span><span class="ident" id="8408627">testing</span><span class="op" id="8408634">.</span><span class="ident" id="8408635">T</span><span class="op" id="8408636">)</span>&nbsp;<span class="op" id="8408638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408641">check</span><span class="op" id="8408646">(</span><span class="ident" id="8408647">t</span><span class="op" id="8408648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408651">postReq</span>&nbsp;<span class="op" id="8408659">:=</span>&nbsp;<span class="string" id="8408662">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408795">h</span>&nbsp;<span class="op" id="8408797">:=</span>&nbsp;<span class="op" id="8408800">&amp;</span><span class="ident" id="8408801">Handler</span><span class="op" id="8408808">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408812">Path</span><span class="op" id="8408816">:</span>&nbsp;<span class="string" id="8408818">&#34;testdata/test.cgi&#34;</span><span class="op" id="8408837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408841">Root</span><span class="op" id="8408845">:</span>&nbsp;<span class="string" id="8408847">&#34;/test.cgi&#34;</span><span class="op" id="8408858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8408864">expectedMap</span>&nbsp;<span class="op" id="8408876">:=</span>&nbsp;<span class="keyword" id="8408879">map</span><span class="op" id="8408882">[</span><span class="builtintype" id="8408883">string</span><span class="op" id="8408889">]</span><span class="builtintype" id="8408890">string</span><span class="op" id="8408896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408900">&#34;test&#34;</span><span class="op" id="8408906">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408922">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8408933">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408937">&#34;param-postfoo&#34;</span><span class="op" id="8408952">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408959">&#34;postbar&#34;</span><span class="op" id="8408968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8408972">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8408992">:</span>&nbsp;<span class="string" id="8408994">&#34;POST&#34;</span><span class="op" id="8409000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8409004">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="8409024">:</span>&nbsp;<span class="string" id="8409026">&#34;15&#34;</span><span class="op" id="8409030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8409034">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8409051">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8409056">&#34;/test.cgi?a=b&#34;</span><span class="op" id="8409071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409074">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409077">runCgiTest</span><span class="op" id="8409087">(</span><span class="ident" id="8409088">t</span><span class="op" id="8409089">,</span>&nbsp;<span class="ident" id="8409091">h</span><span class="op" id="8409092">,</span>&nbsp;<span class="ident" id="8409094">postReq</span><span class="op" id="8409101">,</span>&nbsp;<span class="ident" id="8409103">expectedMap</span><span class="op" id="8409114">)</span><br>
<span class="lineno"></span><span class="op" id="8409116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409119">func</span>&nbsp;<span class="ident" id="8409124">chunk</span><span class="op" id="8409129">(</span><span class="ident" id="8409130">s</span>&nbsp;<span class="builtintype" id="8409132">string</span><span class="op" id="8409138">)</span>&nbsp;<span class="builtintype" id="8409140">string</span>&nbsp;<span class="op" id="8409147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409150">return</span>&nbsp;<span class="ident" id="8409157">fmt</span><span class="op" id="8409160">.</span><span class="ident" id="8409161">Sprintf</span><span class="op" id="8409168">(</span><span class="string" id="8409169">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="8409183">,</span>&nbsp;<span class="builtinfunc" id="8409185">len</span><span class="op" id="8409188">(</span><span class="ident" id="8409189">s</span><span class="op" id="8409190">)</span><span class="op" id="8409191">,</span>&nbsp;<span class="ident" id="8409193">s</span><span class="op" id="8409194">)</span><br>
<span class="lineno">240</span><span class="op" id="8409196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8409199">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="8409247">func</span>&nbsp;<span class="ident" id="8409252">TestCGIPostChunked</span><span class="op" id="8409270">(</span><span class="ident" id="8409271">t</span>&nbsp;<span class="op" id="8409273">*</span><span class="ident" id="8409274">testing</span><span class="op" id="8409281">.</span><span class="ident" id="8409282">T</span><span class="op" id="8409283">)</span>&nbsp;<span class="op" id="8409285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409288">check</span><span class="op" id="8409293">(</span><span class="ident" id="8409294">t</span><span class="op" id="8409295">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409298">postReq</span>&nbsp;<span class="op" id="8409306">:=</span>&nbsp;<span class="string" id="8409309">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="8409434">+</span>&nbsp;<span class="ident" id="8409436">chunk</span><span class="op" id="8409441">(</span><span class="string" id="8409442">&#34;postfoo&#34;</span><span class="op" id="8409451">)</span>&nbsp;<span class="op" id="8409453">+</span>&nbsp;<span class="ident" id="8409455">chunk</span><span class="op" id="8409460">(</span><span class="string" id="8409461">&#34;=&#34;</span><span class="op" id="8409464">)</span>&nbsp;<span class="op" id="8409466">+</span>&nbsp;<span class="ident" id="8409468">chunk</span><span class="op" id="8409473">(</span><span class="string" id="8409474">&#34;postbar&#34;</span><span class="op" id="8409483">)</span>&nbsp;<span class="op" id="8409485">+</span>&nbsp;<span class="ident" id="8409487">chunk</span><span class="op" id="8409492">(</span><span class="string" id="8409493">&#34;&#34;</span><span class="op" id="8409495">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409499">h</span>&nbsp;<span class="op" id="8409501">:=</span>&nbsp;<span class="op" id="8409504">&amp;</span><span class="ident" id="8409505">Handler</span><span class="op" id="8409512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409516">Path</span><span class="op" id="8409520">:</span>&nbsp;<span class="string" id="8409522">&#34;testdata/test.cgi&#34;</span><span class="op" id="8409541">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409545">Root</span><span class="op" id="8409549">:</span>&nbsp;<span class="string" id="8409551">&#34;/test.cgi&#34;</span><span class="op" id="8409562">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409568">expectedMap</span>&nbsp;<span class="op" id="8409580">:=</span>&nbsp;<span class="keyword" id="8409583">map</span><span class="op" id="8409586">[</span><span class="builtintype" id="8409587">string</span><span class="op" id="8409593">]</span><span class="builtintype" id="8409594">string</span><span class="op" id="8409600">{</span><span class="op" id="8409601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409604">resp</span>&nbsp;<span class="op" id="8409609">:=</span>&nbsp;<span class="ident" id="8409612">runCgiTest</span><span class="op" id="8409622">(</span><span class="ident" id="8409623">t</span><span class="op" id="8409624">,</span>&nbsp;<span class="ident" id="8409626">h</span><span class="op" id="8409627">,</span>&nbsp;<span class="ident" id="8409629">postReq</span><span class="op" id="8409636">,</span>&nbsp;<span class="ident" id="8409638">expectedMap</span><span class="op" id="8409649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8409652">if</span>&nbsp;<span class="ident" id="8409655">got</span><span class="op" id="8409658">,</span>&nbsp;<span class="ident" id="8409660">expected</span>&nbsp;<span class="op" id="8409669">:=</span>&nbsp;<span class="ident" id="8409672">resp</span><span class="op" id="8409676">.</span><span class="ident" id="8409677">Code</span><span class="op" id="8409681">,</span>&nbsp;<span class="ident" id="8409683">http</span><span class="op" id="8409687">.</span><span class="ident" id="8409688">StatusBadRequest</span><span class="op" id="8409704">;</span>&nbsp;<span class="ident" id="8409706">got</span>&nbsp;<span class="op" id="8409710">!=</span>&nbsp;<span class="ident" id="8409713">expected</span>&nbsp;<span class="op" id="8409722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409726">t</span><span class="op" id="8409727">.</span><span class="ident" id="8409728">Fatalf</span><span class="op" id="8409734">(</span><span class="string" id="8409735">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8409796">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409801">expected</span><span class="op" id="8409809">,</span>&nbsp;<span class="ident" id="8409811">got</span><span class="op" id="8409814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409817">}</span><br>
<span class="lineno"></span><span class="op" id="8409819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409822">func</span>&nbsp;<span class="ident" id="8409827">TestRedirect</span><span class="op" id="8409839">(</span><span class="ident" id="8409840">t</span>&nbsp;<span class="op" id="8409842">*</span><span class="ident" id="8409843">testing</span><span class="op" id="8409850">.</span><span class="ident" id="8409851">T</span><span class="op" id="8409852">)</span>&nbsp;<span class="op" id="8409854">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409857">check</span><span class="op" id="8409862">(</span><span class="ident" id="8409863">t</span><span class="op" id="8409864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409867">h</span>&nbsp;<span class="op" id="8409869">:=</span>&nbsp;<span class="op" id="8409872">&amp;</span><span class="ident" id="8409873">Handler</span><span class="op" id="8409880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409884">Path</span><span class="op" id="8409888">:</span>&nbsp;<span class="string" id="8409890">&#34;testdata/test.cgi&#34;</span><span class="op" id="8409909">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409913">Root</span><span class="op" id="8409917">:</span>&nbsp;<span class="string" id="8409919">&#34;/test.cgi&#34;</span><span class="op" id="8409930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8409933">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8409936">rec</span>&nbsp;<span class="op" id="8409940">:=</span>&nbsp;<span class="ident" id="8409943">runCgiTest</span><span class="op" id="8409953">(</span><span class="ident" id="8409954">t</span><span class="op" id="8409955">,</span>&nbsp;<span class="ident" id="8409957">h</span><span class="op" id="8409958">,</span>&nbsp;<span class="string" id="8409960">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8410027">,</span>&nbsp;<span class="ident" id="8410029">nil</span><span class="op" id="8410032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410035">if</span>&nbsp;<span class="ident" id="8410038">e</span><span class="op" id="8410039">,</span>&nbsp;<span class="ident" id="8410041">g</span>&nbsp;<span class="op" id="8410043">:=</span>&nbsp;<span class="num" id="8410046">302</span><span class="op" id="8410049">,</span>&nbsp;<span class="ident" id="8410051">rec</span><span class="op" id="8410054">.</span><span class="ident" id="8410055">Code</span><span class="op" id="8410059">;</span>&nbsp;<span class="ident" id="8410061">e</span>&nbsp;<span class="op" id="8410063">!=</span>&nbsp;<span class="ident" id="8410066">g</span>&nbsp;<span class="op" id="8410068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410072">t</span><span class="op" id="8410073">.</span><span class="ident" id="8410074">Errorf</span><span class="op" id="8410080">(</span><span class="string" id="8410081">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8410114">,</span>&nbsp;<span class="ident" id="8410116">e</span><span class="op" id="8410117">,</span>&nbsp;<span class="ident" id="8410119">g</span><span class="op" id="8410120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8410126">if</span>&nbsp;<span class="ident" id="8410129">e</span><span class="op" id="8410130">,</span>&nbsp;<span class="ident" id="8410132">g</span>&nbsp;<span class="op" id="8410134">:=</span>&nbsp;<span class="string" id="8410137">&#34;http://foo.com/&#34;</span><span class="op" id="8410154">,</span>&nbsp;<span class="ident" id="8410156">rec</span><span class="op" id="8410159">.</span><span class="ident" id="8410160">Header</span><span class="op" id="8410166">(</span><span class="op" id="8410167">)</span><span class="op" id="8410168">.</span><span class="ident" id="8410169">Get</span><span class="op" id="8410172">(</span><span class="string" id="8410173">&#34;Location&#34;</span><span class="op" id="8410183">)</span><span class="op" id="8410184">;</span>&nbsp;<span class="ident" id="8410186">e</span>&nbsp;<span class="op" id="8410188">!=</span>&nbsp;<span class="ident" id="8410191">g</span>&nbsp;<span class="op" id="8410193">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410197">t</span><span class="op" id="8410198">.</span><span class="ident" id="8410199">Errorf</span><span class="op" id="8410205">(</span><span class="string" id="8410206">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8410246">,</span>&nbsp;<span class="ident" id="8410248">e</span><span class="op" id="8410249">,</span>&nbsp;<span class="ident" id="8410251">g</span><span class="op" id="8410252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410255">}</span><br>
<span class="lineno"></span><span class="op" id="8410257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410260">func</span>&nbsp;<span class="ident" id="8410265">TestInternalRedirect</span><span class="op" id="8410285">(</span><span class="ident" id="8410286">t</span>&nbsp;<span class="op" id="8410288">*</span><span class="ident" id="8410289">testing</span><span class="op" id="8410296">.</span><span class="ident" id="8410297">T</span><span class="op" id="8410298">)</span>&nbsp;<span class="op" id="8410300">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410303">check</span><span class="op" id="8410308">(</span><span class="ident" id="8410309">t</span><span class="op" id="8410310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410313">baseHandler</span>&nbsp;<span class="op" id="8410325">:=</span>&nbsp;<span class="ident" id="8410328">http</span><span class="op" id="8410332">.</span><span class="ident" id="8410333">HandlerFunc</span><span class="op" id="8410344">(</span><span class="keyword" id="8410345">func</span><span class="op" id="8410349">(</span><span class="ident" id="8410350">rw</span>&nbsp;<span class="ident" id="8410353">http</span><span class="op" id="8410357">.</span><span class="ident" id="8410358">ResponseWriter</span><span class="op" id="8410372">,</span>&nbsp;<span class="ident" id="8410374">req</span>&nbsp;<span class="op" id="8410378">*</span><span class="ident" id="8410379">http</span><span class="op" id="8410383">.</span><span class="ident" id="8410384">Request</span><span class="op" id="8410391">)</span>&nbsp;<span class="op" id="8410393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410397">fmt</span><span class="op" id="8410400">.</span><span class="ident" id="8410401">Fprintf</span><span class="op" id="8410408">(</span><span class="ident" id="8410409">rw</span><span class="op" id="8410411">,</span>&nbsp;<span class="string" id="8410413">&#34;basepath=%s\n&#34;</span><span class="op" id="8410428">,</span>&nbsp;<span class="ident" id="8410430">req</span><span class="op" id="8410433">.</span><span class="ident" id="8410434">URL</span><span class="op" id="8410437">.</span><span class="ident" id="8410438">Path</span><span class="op" id="8410442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410446">fmt</span><span class="op" id="8410449">.</span><span class="ident" id="8410450">Fprintf</span><span class="op" id="8410457">(</span><span class="ident" id="8410458">rw</span><span class="op" id="8410460">,</span>&nbsp;<span class="string" id="8410462">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="8410479">,</span>&nbsp;<span class="ident" id="8410481">req</span><span class="op" id="8410484">.</span><span class="ident" id="8410485">RemoteAddr</span><span class="op" id="8410495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410498">}</span><span class="op" id="8410499">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410502">h</span>&nbsp;<span class="op" id="8410504">:=</span>&nbsp;<span class="op" id="8410507">&amp;</span><span class="ident" id="8410508">Handler</span><span class="op" id="8410515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410519">Path</span><span class="op" id="8410523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8410540">&#34;testdata/test.cgi&#34;</span><span class="op" id="8410559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410563">Root</span><span class="op" id="8410567">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8410584">&#34;/test.cgi&#34;</span><span class="op" id="8410595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410599">PathLocationHandler</span><span class="op" id="8410618">:</span>&nbsp;<span class="ident" id="8410620">baseHandler</span><span class="op" id="8410631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410634">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410637">expectedMap</span>&nbsp;<span class="op" id="8410649">:=</span>&nbsp;<span class="keyword" id="8410652">map</span><span class="op" id="8410655">[</span><span class="builtintype" id="8410656">string</span><span class="op" id="8410662">]</span><span class="builtintype" id="8410663">string</span><span class="op" id="8410669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8410673">&#34;basepath&#34;</span><span class="op" id="8410683">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8410687">&#34;/foo&#34;</span><span class="op" id="8410693">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8410697">&#34;remoteaddr&#34;</span><span class="op" id="8410709">:</span>&nbsp;<span class="string" id="8410711">&#34;1.2.3.4&#34;</span><span class="op" id="8410720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8410723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410726">runCgiTest</span><span class="op" id="8410736">(</span><span class="ident" id="8410737">t</span><span class="op" id="8410738">,</span>&nbsp;<span class="ident" id="8410740">h</span><span class="op" id="8410741">,</span>&nbsp;<span class="string" id="8410743">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8410799">,</span>&nbsp;<span class="ident" id="8410801">expectedMap</span><span class="op" id="8410812">)</span><br>
<span class="lineno">295</span><span class="op" id="8410814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8410817">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="8410893">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="8410956">func</span>&nbsp;<span class="ident" id="8410961">TestCopyError</span><span class="op" id="8410974">(</span><span class="ident" id="8410975">t</span>&nbsp;<span class="op" id="8410977">*</span><span class="ident" id="8410978">testing</span><span class="op" id="8410985">.</span><span class="ident" id="8410986">T</span><span class="op" id="8410987">)</span>&nbsp;<span class="op" id="8410989">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8410992">check</span><span class="op" id="8410997">(</span><span class="ident" id="8410998">t</span><span class="op" id="8410999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411002">if</span>&nbsp;<span class="ident" id="8411005">runtime</span><span class="op" id="8411012">.</span><span class="ident" id="8411013">GOOS</span>&nbsp;<span class="op" id="8411018">==</span>&nbsp;<span class="string" id="8411021">&#34;windows&#34;</span>&nbsp;<span class="op" id="8411031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411035">t</span><span class="op" id="8411036">.</span><span class="ident" id="8411037">Skipf</span><span class="op" id="8411042">(</span><span class="string" id="8411043">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8411064">,</span>&nbsp;<span class="ident" id="8411066">runtime</span><span class="op" id="8411073">.</span><span class="ident" id="8411074">GOOS</span><span class="op" id="8411078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411084">h</span>&nbsp;<span class="op" id="8411086">:=</span>&nbsp;<span class="op" id="8411089">&amp;</span><span class="ident" id="8411090">Handler</span><span class="op" id="8411097">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411101">Path</span><span class="op" id="8411105">:</span>&nbsp;<span class="string" id="8411107">&#34;testdata/test.cgi&#34;</span><span class="op" id="8411126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411130">Root</span><span class="op" id="8411134">:</span>&nbsp;<span class="string" id="8411136">&#34;/test.cgi&#34;</span><span class="op" id="8411147">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411153">ts</span>&nbsp;<span class="op" id="8411156">:=</span>&nbsp;<span class="ident" id="8411159">httptest</span><span class="op" id="8411167">.</span><span class="ident" id="8411168">NewServer</span><span class="op" id="8411177">(</span><span class="ident" id="8411178">h</span><span class="op" id="8411179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411182">defer</span>&nbsp;<span class="ident" id="8411188">ts</span><span class="op" id="8411190">.</span><span class="ident" id="8411191">Close</span><span class="op" id="8411196">(</span><span class="op" id="8411197">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411201">conn</span><span class="op" id="8411205">,</span>&nbsp;<span class="ident" id="8411207">err</span>&nbsp;<span class="op" id="8411211">:=</span>&nbsp;<span class="ident" id="8411214">net</span><span class="op" id="8411217">.</span><span class="ident" id="8411218">Dial</span><span class="op" id="8411222">(</span><span class="string" id="8411223">&#34;tcp&#34;</span><span class="op" id="8411228">,</span>&nbsp;<span class="ident" id="8411230">ts</span><span class="op" id="8411232">.</span><span class="ident" id="8411233">Listener</span><span class="op" id="8411241">.</span><span class="ident" id="8411242">Addr</span><span class="op" id="8411246">(</span><span class="op" id="8411247">)</span><span class="op" id="8411248">.</span><span class="ident" id="8411249">String</span><span class="op" id="8411255">(</span><span class="op" id="8411256">)</span><span class="op" id="8411257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411260">if</span>&nbsp;<span class="ident" id="8411263">err</span>&nbsp;<span class="op" id="8411267">!=</span>&nbsp;<span class="ident" id="8411270">nil</span>&nbsp;<span class="op" id="8411274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411278">t</span><span class="op" id="8411279">.</span><span class="ident" id="8411280">Fatal</span><span class="op" id="8411285">(</span><span class="ident" id="8411286">err</span><span class="op" id="8411289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411292">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411295">req</span><span class="op" id="8411298">,</span>&nbsp;<span class="ident" id="8411300">_</span>&nbsp;<span class="op" id="8411302">:=</span>&nbsp;<span class="ident" id="8411305">http</span><span class="op" id="8411309">.</span><span class="ident" id="8411310">NewRequest</span><span class="op" id="8411320">(</span><span class="string" id="8411321">&#34;GET&#34;</span><span class="op" id="8411326">,</span>&nbsp;<span class="string" id="8411328">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="8411371">,</span>&nbsp;<span class="ident" id="8411373">nil</span><span class="op" id="8411376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411379">err</span>&nbsp;<span class="op" id="8411383">=</span>&nbsp;<span class="ident" id="8411385">req</span><span class="op" id="8411388">.</span><span class="ident" id="8411389">Write</span><span class="op" id="8411394">(</span><span class="ident" id="8411395">conn</span><span class="op" id="8411399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411402">if</span>&nbsp;<span class="ident" id="8411405">err</span>&nbsp;<span class="op" id="8411409">!=</span>&nbsp;<span class="ident" id="8411412">nil</span>&nbsp;<span class="op" id="8411416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411420">t</span><span class="op" id="8411421">.</span><span class="ident" id="8411422">Fatalf</span><span class="op" id="8411428">(</span><span class="string" id="8411429">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="8411440">,</span>&nbsp;<span class="ident" id="8411442">err</span><span class="op" id="8411445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411448">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411452">res</span><span class="op" id="8411455">,</span>&nbsp;<span class="ident" id="8411457">err</span>&nbsp;<span class="op" id="8411461">:=</span>&nbsp;<span class="ident" id="8411464">http</span><span class="op" id="8411468">.</span><span class="ident" id="8411469">ReadResponse</span><span class="op" id="8411481">(</span><span class="ident" id="8411482">bufio</span><span class="op" id="8411487">.</span><span class="ident" id="8411488">NewReader</span><span class="op" id="8411497">(</span><span class="ident" id="8411498">conn</span><span class="op" id="8411502">)</span><span class="op" id="8411503">,</span>&nbsp;<span class="ident" id="8411505">req</span><span class="op" id="8411508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411511">if</span>&nbsp;<span class="ident" id="8411514">err</span>&nbsp;<span class="op" id="8411518">!=</span>&nbsp;<span class="ident" id="8411521">nil</span>&nbsp;<span class="op" id="8411525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411529">t</span><span class="op" id="8411530">.</span><span class="ident" id="8411531">Fatalf</span><span class="op" id="8411537">(</span><span class="string" id="8411538">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="8411556">,</span>&nbsp;<span class="ident" id="8411558">err</span><span class="op" id="8411561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411564">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411568">pidstr</span>&nbsp;<span class="op" id="8411575">:=</span>&nbsp;<span class="ident" id="8411578">res</span><span class="op" id="8411581">.</span><span class="ident" id="8411582">Header</span><span class="op" id="8411588">.</span><span class="ident" id="8411589">Get</span><span class="op" id="8411592">(</span><span class="string" id="8411593">&#34;X-CGI-Pid&#34;</span><span class="op" id="8411604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411607">if</span>&nbsp;<span class="ident" id="8411610">pidstr</span>&nbsp;<span class="op" id="8411617">==</span>&nbsp;<span class="string" id="8411620">&#34;&#34;</span>&nbsp;<span class="op" id="8411623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411627">t</span><span class="op" id="8411628">.</span><span class="ident" id="8411629">Fatalf</span><span class="op" id="8411635">(</span><span class="string" id="8411636">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="8411678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411681">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411684">pid</span><span class="op" id="8411687">,</span>&nbsp;<span class="ident" id="8411689">err</span>&nbsp;<span class="op" id="8411693">:=</span>&nbsp;<span class="ident" id="8411696">strconv</span><span class="op" id="8411703">.</span><span class="ident" id="8411704">Atoi</span><span class="op" id="8411708">(</span><span class="ident" id="8411709">pidstr</span><span class="op" id="8411715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411718">if</span>&nbsp;<span class="ident" id="8411721">err</span>&nbsp;<span class="op" id="8411725">!=</span>&nbsp;<span class="ident" id="8411728">nil</span>&nbsp;<span class="op" id="8411732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411736">t</span><span class="op" id="8411737">.</span><span class="ident" id="8411738">Fatalf</span><span class="op" id="8411744">(</span><span class="string" id="8411745">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="8411770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411777">var</span>&nbsp;<span class="ident" id="8411781">buf</span>&nbsp;<span class="op" id="8411785">[</span><span class="num" id="8411786">5000</span><span class="op" id="8411790">]</span><span class="builtintype" id="8411791">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411797">n</span><span class="op" id="8411798">,</span>&nbsp;<span class="ident" id="8411800">err</span>&nbsp;<span class="op" id="8411804">:=</span>&nbsp;<span class="ident" id="8411807">io</span><span class="op" id="8411809">.</span><span class="ident" id="8411810">ReadFull</span><span class="op" id="8411818">(</span><span class="ident" id="8411819">res</span><span class="op" id="8411822">.</span><span class="ident" id="8411823">Body</span><span class="op" id="8411827">,</span>&nbsp;<span class="ident" id="8411829">buf</span><span class="op" id="8411832">[</span><span class="op" id="8411833">:</span><span class="op" id="8411834">]</span><span class="op" id="8411835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411838">if</span>&nbsp;<span class="ident" id="8411841">err</span>&nbsp;<span class="op" id="8411845">!=</span>&nbsp;<span class="ident" id="8411848">nil</span>&nbsp;<span class="op" id="8411852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411856">t</span><span class="op" id="8411857">.</span><span class="ident" id="8411858">Fatalf</span><span class="op" id="8411864">(</span><span class="string" id="8411865">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="8411889">,</span>&nbsp;<span class="ident" id="8411891">n</span><span class="op" id="8411892">,</span>&nbsp;<span class="ident" id="8411894">err</span><span class="op" id="8411897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411900">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411904">childRunning</span>&nbsp;<span class="op" id="8411917">:=</span>&nbsp;<span class="keyword" id="8411920">func</span><span class="op" id="8411924">(</span><span class="op" id="8411925">)</span>&nbsp;<span class="builtintype" id="8411927">bool</span>&nbsp;<span class="op" id="8411932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411936">return</span>&nbsp;<span class="ident" id="8411943">isProcessRunning</span><span class="op" id="8411959">(</span><span class="ident" id="8411960">t</span><span class="op" id="8411961">,</span>&nbsp;<span class="ident" id="8411963">pid</span><span class="op" id="8411966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8411969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8411973">if</span>&nbsp;<span class="op" id="8411976">!</span><span class="ident" id="8411977">childRunning</span><span class="op" id="8411989">(</span><span class="op" id="8411990">)</span>&nbsp;<span class="op" id="8411992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8411996">t</span><span class="op" id="8411997">.</span><span class="ident" id="8411998">Fatalf</span><span class="op" id="8412004">(</span><span class="string" id="8412005">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="8412051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412057">conn</span><span class="op" id="8412061">.</span><span class="ident" id="8412062">Close</span><span class="op" id="8412067">(</span><span class="op" id="8412068">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412072">tries</span>&nbsp;<span class="op" id="8412078">:=</span>&nbsp;<span class="num" id="8412081">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412084">for</span>&nbsp;<span class="ident" id="8412088">tries</span>&nbsp;<span class="op" id="8412094">&lt;</span>&nbsp;<span class="num" id="8412096">25</span>&nbsp;<span class="op" id="8412099">&amp;&amp;</span>&nbsp;<span class="ident" id="8412102">childRunning</span><span class="op" id="8412114">(</span><span class="op" id="8412115">)</span>&nbsp;<span class="op" id="8412117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412121">time</span><span class="op" id="8412125">.</span><span class="ident" id="8412126">Sleep</span><span class="op" id="8412131">(</span><span class="num" id="8412132">50</span>&nbsp;<span class="op" id="8412135">*</span>&nbsp;<span class="ident" id="8412137">time</span><span class="op" id="8412141">.</span><span class="ident" id="8412142">Millisecond</span>&nbsp;<span class="op" id="8412154">*</span>&nbsp;<span class="ident" id="8412156">time</span><span class="op" id="8412160">.</span><span class="ident" id="8412161">Duration</span><span class="op" id="8412169">(</span><span class="ident" id="8412170">tries</span><span class="op" id="8412175">)</span><span class="op" id="8412176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412180">tries</span><span class="op" id="8412185">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412189">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412192">if</span>&nbsp;<span class="ident" id="8412195">childRunning</span><span class="op" id="8412207">(</span><span class="op" id="8412208">)</span>&nbsp;<span class="op" id="8412210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412214">t</span><span class="op" id="8412215">.</span><span class="ident" id="8412216">Fatalf</span><span class="op" id="8412222">(</span><span class="string" id="8412223">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="8412267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412270">}</span><br>
<span class="lineno"></span><span class="op" id="8412272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="8412275">func</span>&nbsp;<span class="ident" id="8412280">TestDirUnix</span><span class="op" id="8412291">(</span><span class="ident" id="8412292">t</span>&nbsp;<span class="op" id="8412294">*</span><span class="ident" id="8412295">testing</span><span class="op" id="8412302">.</span><span class="ident" id="8412303">T</span><span class="op" id="8412304">)</span>&nbsp;<span class="op" id="8412306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412309">check</span><span class="op" id="8412314">(</span><span class="ident" id="8412315">t</span><span class="op" id="8412316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412319">if</span>&nbsp;<span class="ident" id="8412322">runtime</span><span class="op" id="8412329">.</span><span class="ident" id="8412330">GOOS</span>&nbsp;<span class="op" id="8412335">==</span>&nbsp;<span class="string" id="8412338">&#34;windows&#34;</span>&nbsp;<span class="op" id="8412348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412352">t</span><span class="op" id="8412353">.</span><span class="ident" id="8412354">Skipf</span><span class="op" id="8412359">(</span><span class="string" id="8412360">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8412381">,</span>&nbsp;<span class="ident" id="8412383">runtime</span><span class="op" id="8412390">.</span><span class="ident" id="8412391">GOOS</span><span class="op" id="8412395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412398">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412401">cwd</span><span class="op" id="8412404">,</span>&nbsp;<span class="ident" id="8412406">_</span>&nbsp;<span class="op" id="8412408">:=</span>&nbsp;<span class="ident" id="8412411">os</span><span class="op" id="8412413">.</span><span class="ident" id="8412414">Getwd</span><span class="op" id="8412419">(</span><span class="op" id="8412420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412423">h</span>&nbsp;<span class="op" id="8412425">:=</span>&nbsp;<span class="op" id="8412428">&amp;</span><span class="ident" id="8412429">Handler</span><span class="op" id="8412436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412440">Path</span><span class="op" id="8412444">:</span>&nbsp;<span class="string" id="8412446">&#34;testdata/test.cgi&#34;</span><span class="op" id="8412465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412469">Root</span><span class="op" id="8412473">:</span>&nbsp;<span class="string" id="8412475">&#34;/test.cgi&#34;</span><span class="op" id="8412486">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412490">Dir</span><span class="op" id="8412493">:</span>&nbsp;&nbsp;<span class="ident" id="8412496">cwd</span><span class="op" id="8412499">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412505">expectedMap</span>&nbsp;<span class="op" id="8412517">:=</span>&nbsp;<span class="keyword" id="8412520">map</span><span class="op" id="8412523">[</span><span class="builtintype" id="8412524">string</span><span class="op" id="8412530">]</span><span class="builtintype" id="8412531">string</span><span class="op" id="8412537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8412541">&#34;cwd&#34;</span><span class="op" id="8412546">:</span>&nbsp;<span class="ident" id="8412548">cwd</span><span class="op" id="8412551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412557">runCgiTest</span><span class="op" id="8412567">(</span><span class="ident" id="8412568">t</span><span class="op" id="8412569">,</span>&nbsp;<span class="ident" id="8412571">h</span><span class="op" id="8412572">,</span>&nbsp;<span class="string" id="8412574">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8412621">,</span>&nbsp;<span class="ident" id="8412623">expectedMap</span><span class="op" id="8412634">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412638">cwd</span><span class="op" id="8412641">,</span>&nbsp;<span class="ident" id="8412643">_</span>&nbsp;<span class="op" id="8412645">=</span>&nbsp;<span class="ident" id="8412647">os</span><span class="op" id="8412649">.</span><span class="ident" id="8412650">Getwd</span><span class="op" id="8412655">(</span><span class="op" id="8412656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412659">cwd</span>&nbsp;<span class="op" id="8412663">=</span>&nbsp;<span class="ident" id="8412665">filepath</span><span class="op" id="8412673">.</span><span class="ident" id="8412674">Join</span><span class="op" id="8412678">(</span><span class="ident" id="8412679">cwd</span><span class="op" id="8412682">,</span>&nbsp;<span class="string" id="8412684">&#34;testdata&#34;</span><span class="op" id="8412694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412697">h</span>&nbsp;<span class="op" id="8412699">=</span>&nbsp;<span class="op" id="8412701">&amp;</span><span class="ident" id="8412702">Handler</span><span class="op" id="8412709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412713">Path</span><span class="op" id="8412717">:</span>&nbsp;<span class="string" id="8412719">&#34;testdata/test.cgi&#34;</span><span class="op" id="8412738">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412742">Root</span><span class="op" id="8412746">:</span>&nbsp;<span class="string" id="8412748">&#34;/test.cgi&#34;</span><span class="op" id="8412759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412765">expectedMap</span>&nbsp;<span class="op" id="8412777">=</span>&nbsp;<span class="keyword" id="8412779">map</span><span class="op" id="8412782">[</span><span class="builtintype" id="8412783">string</span><span class="op" id="8412789">]</span><span class="builtintype" id="8412790">string</span><span class="op" id="8412796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8412800">&#34;cwd&#34;</span><span class="op" id="8412805">:</span>&nbsp;<span class="ident" id="8412807">cwd</span><span class="op" id="8412810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8412813">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412816">runCgiTest</span><span class="op" id="8412826">(</span><span class="ident" id="8412827">t</span><span class="op" id="8412828">,</span>&nbsp;<span class="ident" id="8412830">h</span><span class="op" id="8412831">,</span>&nbsp;<span class="string" id="8412833">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8412880">,</span>&nbsp;<span class="ident" id="8412882">expectedMap</span><span class="op" id="8412893">)</span><br>
<span class="lineno"></span><span class="op" id="8412895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8412898">func</span>&nbsp;<span class="ident" id="8412903">TestDirWindows</span><span class="op" id="8412917">(</span><span class="ident" id="8412918">t</span>&nbsp;<span class="op" id="8412920">*</span><span class="ident" id="8412921">testing</span><span class="op" id="8412928">.</span><span class="ident" id="8412929">T</span><span class="op" id="8412930">)</span>&nbsp;<span class="op" id="8412932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8412935">if</span>&nbsp;<span class="ident" id="8412938">runtime</span><span class="op" id="8412945">.</span><span class="ident" id="8412946">GOOS</span>&nbsp;<span class="op" id="8412951">!=</span>&nbsp;<span class="string" id="8412954">&#34;windows&#34;</span>&nbsp;<span class="op" id="8412964">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8412968">t</span><span class="op" id="8412969">.</span><span class="ident" id="8412970">Skip</span><span class="op" id="8412974">(</span><span class="string" id="8412975">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="8413008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413015">cgifile</span><span class="op" id="8413022">,</span>&nbsp;<span class="ident" id="8413024">_</span>&nbsp;<span class="op" id="8413026">:=</span>&nbsp;<span class="ident" id="8413029">filepath</span><span class="op" id="8413037">.</span><span class="ident" id="8413038">Abs</span><span class="op" id="8413041">(</span><span class="string" id="8413042">&#34;testdata/test.cgi&#34;</span><span class="op" id="8413061">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413065">var</span>&nbsp;<span class="ident" id="8413069">perl</span>&nbsp;<span class="builtintype" id="8413074">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413082">var</span>&nbsp;<span class="ident" id="8413086">err</span>&nbsp;<span class="builtintype" id="8413090">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413097">perl</span><span class="op" id="8413101">,</span>&nbsp;<span class="ident" id="8413103">err</span>&nbsp;<span class="op" id="8413107">=</span>&nbsp;<span class="ident" id="8413109">exec</span><span class="op" id="8413113">.</span><span class="ident" id="8413114">LookPath</span><span class="op" id="8413122">(</span><span class="string" id="8413123">&#34;perl&#34;</span><span class="op" id="8413129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413132">if</span>&nbsp;<span class="ident" id="8413135">err</span>&nbsp;<span class="op" id="8413139">!=</span>&nbsp;<span class="ident" id="8413142">nil</span>&nbsp;<span class="op" id="8413146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413150">t</span><span class="op" id="8413151">.</span><span class="ident" id="8413152">Skip</span><span class="op" id="8413156">(</span><span class="string" id="8413157">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8413189">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413195">perl</span><span class="op" id="8413199">,</span>&nbsp;<span class="ident" id="8413201">_</span>&nbsp;<span class="op" id="8413203">=</span>&nbsp;<span class="ident" id="8413205">filepath</span><span class="op" id="8413213">.</span><span class="ident" id="8413214">Abs</span><span class="op" id="8413217">(</span><span class="ident" id="8413218">perl</span><span class="op" id="8413222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413226">cwd</span><span class="op" id="8413229">,</span>&nbsp;<span class="ident" id="8413231">_</span>&nbsp;<span class="op" id="8413233">:=</span>&nbsp;<span class="ident" id="8413236">os</span><span class="op" id="8413238">.</span><span class="ident" id="8413239">Getwd</span><span class="op" id="8413244">(</span><span class="op" id="8413245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413248">h</span>&nbsp;<span class="op" id="8413250">:=</span>&nbsp;<span class="op" id="8413253">&amp;</span><span class="ident" id="8413254">Handler</span><span class="op" id="8413261">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413265">Path</span><span class="op" id="8413269">:</span>&nbsp;<span class="ident" id="8413271">perl</span><span class="op" id="8413275">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413279">Root</span><span class="op" id="8413283">:</span>&nbsp;<span class="string" id="8413285">&#34;/test.cgi&#34;</span><span class="op" id="8413296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413300">Dir</span><span class="op" id="8413303">:</span>&nbsp;&nbsp;<span class="ident" id="8413306">cwd</span><span class="op" id="8413309">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413313">Args</span><span class="op" id="8413317">:</span>&nbsp;<span class="op" id="8413319">[</span><span class="op" id="8413320">]</span><span class="builtintype" id="8413321">string</span><span class="op" id="8413327">{</span><span class="ident" id="8413328">cgifile</span><span class="op" id="8413335">}</span><span class="op" id="8413336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413340">Env</span><span class="op" id="8413343">:</span>&nbsp;&nbsp;<span class="op" id="8413346">[</span><span class="op" id="8413347">]</span><span class="builtintype" id="8413348">string</span><span class="op" id="8413354">{</span><span class="string" id="8413355">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8413374">+</span>&nbsp;<span class="ident" id="8413376">cgifile</span><span class="op" id="8413383">}</span><span class="op" id="8413384">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413390">expectedMap</span>&nbsp;<span class="op" id="8413402">:=</span>&nbsp;<span class="keyword" id="8413405">map</span><span class="op" id="8413408">[</span><span class="builtintype" id="8413409">string</span><span class="op" id="8413415">]</span><span class="builtintype" id="8413416">string</span><span class="op" id="8413422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8413426">&#34;cwd&#34;</span><span class="op" id="8413431">:</span>&nbsp;<span class="ident" id="8413433">cwd</span><span class="op" id="8413436">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413442">runCgiTest</span><span class="op" id="8413452">(</span><span class="ident" id="8413453">t</span><span class="op" id="8413454">,</span>&nbsp;<span class="ident" id="8413456">h</span><span class="op" id="8413457">,</span>&nbsp;<span class="string" id="8413459">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8413506">,</span>&nbsp;<span class="ident" id="8413508">expectedMap</span><span class="op" id="8413519">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8413523">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8413586">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413614">cwd</span><span class="op" id="8413617">,</span>&nbsp;<span class="ident" id="8413619">_</span>&nbsp;<span class="op" id="8413621">=</span>&nbsp;<span class="ident" id="8413623">filepath</span><span class="op" id="8413631">.</span><span class="ident" id="8413632">Split</span><span class="op" id="8413637">(</span><span class="ident" id="8413638">perl</span><span class="op" id="8413642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8413645">if</span>&nbsp;<span class="ident" id="8413648">cwd</span>&nbsp;<span class="op" id="8413652">!=</span>&nbsp;<span class="string" id="8413655">&#34;&#34;</span>&nbsp;<span class="op" id="8413658">&amp;&amp;</span>&nbsp;<span class="ident" id="8413661">cwd</span><span class="op" id="8413664">[</span><span class="builtinfunc" id="8413665">len</span><span class="op" id="8413668">(</span><span class="ident" id="8413669">cwd</span><span class="op" id="8413672">)</span><span class="op" id="8413673">-</span><span class="num" id="8413674">1</span><span class="op" id="8413675">]</span>&nbsp;<span class="op" id="8413677">==</span>&nbsp;<span class="ident" id="8413680">filepath</span><span class="op" id="8413688">.</span><span class="ident" id="8413689">Separator</span>&nbsp;<span class="op" id="8413699">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413703">cwd</span>&nbsp;<span class="op" id="8413707">=</span>&nbsp;<span class="ident" id="8413709">cwd</span><span class="op" id="8413712">[</span><span class="op" id="8413713">:</span><span class="builtinfunc" id="8413714">len</span><span class="op" id="8413717">(</span><span class="ident" id="8413718">cwd</span><span class="op" id="8413721">)</span><span class="op" id="8413722">-</span><span class="num" id="8413723">1</span><span class="op" id="8413724">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413730">h</span>&nbsp;<span class="op" id="8413732">=</span>&nbsp;<span class="op" id="8413734">&amp;</span><span class="ident" id="8413735">Handler</span><span class="op" id="8413742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413746">Path</span><span class="op" id="8413750">:</span>&nbsp;<span class="ident" id="8413752">perl</span><span class="op" id="8413756">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413760">Root</span><span class="op" id="8413764">:</span>&nbsp;<span class="string" id="8413766">&#34;/test.cgi&#34;</span><span class="op" id="8413777">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413781">Args</span><span class="op" id="8413785">:</span>&nbsp;<span class="op" id="8413787">[</span><span class="op" id="8413788">]</span><span class="builtintype" id="8413789">string</span><span class="op" id="8413795">{</span><span class="ident" id="8413796">cgifile</span><span class="op" id="8413803">}</span><span class="op" id="8413804">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413808">Env</span><span class="op" id="8413811">:</span>&nbsp;&nbsp;<span class="op" id="8413814">[</span><span class="op" id="8413815">]</span><span class="builtintype" id="8413816">string</span><span class="op" id="8413822">{</span><span class="string" id="8413823">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8413842">+</span>&nbsp;<span class="ident" id="8413844">cgifile</span><span class="op" id="8413851">}</span><span class="op" id="8413852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413858">expectedMap</span>&nbsp;<span class="op" id="8413870">=</span>&nbsp;<span class="keyword" id="8413872">map</span><span class="op" id="8413875">[</span><span class="builtintype" id="8413876">string</span><span class="op" id="8413882">]</span><span class="builtintype" id="8413883">string</span><span class="op" id="8413889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8413893">&#34;cwd&#34;</span><span class="op" id="8413898">:</span>&nbsp;<span class="ident" id="8413900">cwd</span><span class="op" id="8413903">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8413906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8413909">runCgiTest</span><span class="op" id="8413919">(</span><span class="ident" id="8413920">t</span><span class="op" id="8413921">,</span>&nbsp;<span class="ident" id="8413923">h</span><span class="op" id="8413924">,</span>&nbsp;<span class="string" id="8413926">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8413973">,</span>&nbsp;<span class="ident" id="8413975">expectedMap</span><span class="op" id="8413986">)</span><br>
<span class="lineno"></span><span class="op" id="8413988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8413991">func</span>&nbsp;<span class="ident" id="8413996">TestEnvOverride</span><span class="op" id="8414011">(</span><span class="ident" id="8414012">t</span>&nbsp;<span class="op" id="8414014">*</span><span class="ident" id="8414015">testing</span><span class="op" id="8414022">.</span><span class="ident" id="8414023">T</span><span class="op" id="8414024">)</span>&nbsp;<span class="op" id="8414026">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414029">cgifile</span><span class="op" id="8414036">,</span>&nbsp;<span class="ident" id="8414038">_</span>&nbsp;<span class="op" id="8414040">:=</span>&nbsp;<span class="ident" id="8414043">filepath</span><span class="op" id="8414051">.</span><span class="ident" id="8414052">Abs</span><span class="op" id="8414055">(</span><span class="string" id="8414056">&#34;testdata/test.cgi&#34;</span><span class="op" id="8414075">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414079">var</span>&nbsp;<span class="ident" id="8414083">perl</span>&nbsp;<span class="builtintype" id="8414088">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414096">var</span>&nbsp;<span class="ident" id="8414100">err</span>&nbsp;<span class="builtintype" id="8414104">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414111">perl</span><span class="op" id="8414115">,</span>&nbsp;<span class="ident" id="8414117">err</span>&nbsp;<span class="op" id="8414121">=</span>&nbsp;<span class="ident" id="8414123">exec</span><span class="op" id="8414127">.</span><span class="ident" id="8414128">LookPath</span><span class="op" id="8414136">(</span><span class="string" id="8414137">&#34;perl&#34;</span><span class="op" id="8414143">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8414146">if</span>&nbsp;<span class="ident" id="8414149">err</span>&nbsp;<span class="op" id="8414153">!=</span>&nbsp;<span class="ident" id="8414156">nil</span>&nbsp;<span class="op" id="8414160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414164">t</span><span class="op" id="8414165">.</span><span class="ident" id="8414166">Skipf</span><span class="op" id="8414171">(</span><span class="string" id="8414172">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8414204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414210">perl</span><span class="op" id="8414214">,</span>&nbsp;<span class="ident" id="8414216">_</span>&nbsp;<span class="op" id="8414218">=</span>&nbsp;<span class="ident" id="8414220">filepath</span><span class="op" id="8414228">.</span><span class="ident" id="8414229">Abs</span><span class="op" id="8414232">(</span><span class="ident" id="8414233">perl</span><span class="op" id="8414237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414241">cwd</span><span class="op" id="8414244">,</span>&nbsp;<span class="ident" id="8414246">_</span>&nbsp;<span class="op" id="8414248">:=</span>&nbsp;<span class="ident" id="8414251">os</span><span class="op" id="8414253">.</span><span class="ident" id="8414254">Getwd</span><span class="op" id="8414259">(</span><span class="op" id="8414260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414263">h</span>&nbsp;<span class="op" id="8414265">:=</span>&nbsp;<span class="op" id="8414268">&amp;</span><span class="ident" id="8414269">Handler</span><span class="op" id="8414276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414280">Path</span><span class="op" id="8414284">:</span>&nbsp;<span class="ident" id="8414286">perl</span><span class="op" id="8414290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414294">Root</span><span class="op" id="8414298">:</span>&nbsp;<span class="string" id="8414300">&#34;/test.cgi&#34;</span><span class="op" id="8414311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414315">Dir</span><span class="op" id="8414318">:</span>&nbsp;&nbsp;<span class="ident" id="8414321">cwd</span><span class="op" id="8414324">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414328">Args</span><span class="op" id="8414332">:</span>&nbsp;<span class="op" id="8414334">[</span><span class="op" id="8414335">]</span><span class="builtintype" id="8414336">string</span><span class="op" id="8414342">{</span><span class="ident" id="8414343">cgifile</span><span class="op" id="8414350">}</span><span class="op" id="8414351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414355">Env</span><span class="op" id="8414358">:</span>&nbsp;<span class="op" id="8414360">[</span><span class="op" id="8414361">]</span><span class="builtintype" id="8414362">string</span><span class="op" id="8414368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414373">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8414392">+</span>&nbsp;<span class="ident" id="8414394">cgifile</span><span class="op" id="8414401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414406">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="8414428">}</span><span class="op" id="8414429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414432">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414435">expectedMap</span>&nbsp;<span class="op" id="8414447">:=</span>&nbsp;<span class="keyword" id="8414450">map</span><span class="op" id="8414453">[</span><span class="builtintype" id="8414454">string</span><span class="op" id="8414460">]</span><span class="builtintype" id="8414461">string</span><span class="op" id="8414467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414471">&#34;cwd&#34;</span><span class="op" id="8414476">:</span>&nbsp;<span class="ident" id="8414478">cwd</span><span class="op" id="8414481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414485">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8414506">:</span>&nbsp;<span class="ident" id="8414508">cgifile</span><span class="op" id="8414515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414519">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8414536">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8414542">&#34;/foo/bar&#34;</span><span class="op" id="8414552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8414555">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8414558">runCgiTest</span><span class="op" id="8414568">(</span><span class="ident" id="8414569">t</span><span class="op" id="8414570">,</span>&nbsp;<span class="ident" id="8414572">h</span><span class="op" id="8414573">,</span>&nbsp;<span class="string" id="8414575">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8414622">,</span>&nbsp;<span class="ident" id="8414624">expectedMap</span><span class="op" id="8414635">)</span><br>
<span class="lineno"></span><span class="op" id="8414637">}</span>
</div>
</body>
</html>
