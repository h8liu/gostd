<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3998409">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3998464">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3998518">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3998569">package</span>&nbsp;<span class="ident" id="3998577">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3998582">import</span>&nbsp;<span class="op" id="3998589">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998592">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998602">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998618">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998637">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998651">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998665">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998680">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998697">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998712">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998729">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998739">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998745">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3998756">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3998759">var</span>&nbsp;<span class="ident" id="3998763">errClientKeyExchange</span>&nbsp;<span class="op" id="3998784">=</span>&nbsp;<span class="ident" id="3998786">errors</span><span class="op" id="3998792">.</span><span class="ident" id="3998793">New</span><span class="op" id="3998796">(</span><span class="string" id="3998797">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3998837">)</span><br>
<span class="lineno"></span><span class="keyword" id="3998839">var</span>&nbsp;<span class="ident" id="3998843">errServerKeyExchange</span>&nbsp;<span class="op" id="3998864">=</span>&nbsp;<span class="ident" id="3998866">errors</span><span class="op" id="3998872">.</span><span class="ident" id="3998873">New</span><span class="op" id="3998876">(</span><span class="string" id="3998877">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3998917">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3998920">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3998998">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3999060">type</span>&nbsp;<span class="ident" id="3999065">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3999081">struct</span><span class="op" id="3999087">{</span><span class="op" id="3999088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3999091">func</span>&nbsp;<span class="op" id="3999096">(</span><span class="ident" id="3999097">ka</span>&nbsp;<span class="ident" id="3999100">rsaKeyAgreement</span><span class="op" id="3999115">)</span>&nbsp;<span class="ident" id="3999117">generateServerKeyExchange</span><span class="op" id="3999142">(</span><span class="ident" id="3999143">config</span>&nbsp;<span class="op" id="3999150">*</span><span class="ident" id="3999151">Config</span><span class="op" id="3999157">,</span>&nbsp;<span class="ident" id="3999159">cert</span>&nbsp;<span class="op" id="3999164">*</span><span class="ident" id="3999165">Certificate</span><span class="op" id="3999176">,</span>&nbsp;<span class="ident" id="3999178">clientHello</span>&nbsp;<span class="op" id="3999190">*</span><span class="ident" id="3999191">clientHelloMsg</span><span class="op" id="3999205">,</span>&nbsp;<span class="ident" id="3999207">hello</span>&nbsp;<span class="op" id="3999213">*</span><span class="ident" id="3999214">serverHelloMsg</span><span class="op" id="3999228">)</span>&nbsp;<span class="op" id="3999230">(</span><span class="op" id="3999231">*</span><span class="ident" id="3999232">serverKeyExchangeMsg</span><span class="op" id="3999252">,</span>&nbsp;<span class="builtintype" id="3999254">error</span><span class="op" id="3999259">)</span>&nbsp;<span class="op" id="3999261">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999264">return</span>&nbsp;<span class="ident" id="3999271">nil</span><span class="op" id="3999274">,</span>&nbsp;<span class="ident" id="3999276">nil</span><br>
<span class="lineno"></span><span class="op" id="3999280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3999283">func</span>&nbsp;<span class="op" id="3999288">(</span><span class="ident" id="3999289">ka</span>&nbsp;<span class="ident" id="3999292">rsaKeyAgreement</span><span class="op" id="3999307">)</span>&nbsp;<span class="ident" id="3999309">processClientKeyExchange</span><span class="op" id="3999333">(</span><span class="ident" id="3999334">config</span>&nbsp;<span class="op" id="3999341">*</span><span class="ident" id="3999342">Config</span><span class="op" id="3999348">,</span>&nbsp;<span class="ident" id="3999350">cert</span>&nbsp;<span class="op" id="3999355">*</span><span class="ident" id="3999356">Certificate</span><span class="op" id="3999367">,</span>&nbsp;<span class="ident" id="3999369">ckx</span>&nbsp;<span class="op" id="3999373">*</span><span class="ident" id="3999374">clientKeyExchangeMsg</span><span class="op" id="3999394">,</span>&nbsp;<span class="ident" id="3999396">version</span>&nbsp;<span class="builtintype" id="3999404">uint16</span><span class="op" id="3999410">)</span>&nbsp;<span class="op" id="3999412">(</span><span class="op" id="3999413">[</span><span class="op" id="3999414">]</span><span class="builtintype" id="3999415">byte</span><span class="op" id="3999419">,</span>&nbsp;<span class="builtintype" id="3999421">error</span><span class="op" id="3999426">)</span>&nbsp;<span class="op" id="3999428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999431">preMasterSecret</span>&nbsp;<span class="op" id="3999447">:=</span>&nbsp;<span class="builtinfunc" id="3999450">make</span><span class="op" id="3999454">(</span><span class="op" id="3999455">[</span><span class="op" id="3999456">]</span><span class="builtintype" id="3999457">byte</span><span class="op" id="3999461">,</span>&nbsp;<span class="num" id="3999463">48</span><span class="op" id="3999465">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999468">_</span><span class="op" id="3999469">,</span>&nbsp;<span class="ident" id="3999471">err</span>&nbsp;<span class="op" id="3999475">:=</span>&nbsp;<span class="ident" id="3999478">io</span><span class="op" id="3999480">.</span><span class="ident" id="3999481">ReadFull</span><span class="op" id="3999489">(</span><span class="ident" id="3999490">config</span><span class="op" id="3999496">.</span><span class="ident" id="3999497">rand</span><span class="op" id="3999501">(</span><span class="op" id="3999502">)</span><span class="op" id="3999503">,</span>&nbsp;<span class="ident" id="3999505">preMasterSecret</span><span class="op" id="3999520">[</span><span class="num" id="3999521">2</span><span class="op" id="3999522">:</span><span class="op" id="3999523">]</span><span class="op" id="3999524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999527">if</span>&nbsp;<span class="ident" id="3999530">err</span>&nbsp;<span class="op" id="3999534">!=</span>&nbsp;<span class="ident" id="3999537">nil</span>&nbsp;<span class="op" id="3999541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999545">return</span>&nbsp;<span class="ident" id="3999552">nil</span><span class="op" id="3999555">,</span>&nbsp;<span class="ident" id="3999557">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999566">if</span>&nbsp;<span class="builtinfunc" id="3999569">len</span><span class="op" id="3999572">(</span><span class="ident" id="3999573">ckx</span><span class="op" id="3999576">.</span><span class="ident" id="3999577">ciphertext</span><span class="op" id="3999587">)</span>&nbsp;<span class="op" id="3999589">&lt;</span>&nbsp;<span class="num" id="3999591">2</span>&nbsp;<span class="op" id="3999593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999597">return</span>&nbsp;<span class="ident" id="3999604">nil</span><span class="op" id="3999607">,</span>&nbsp;<span class="ident" id="3999609">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999635">ciphertext</span>&nbsp;<span class="op" id="3999646">:=</span>&nbsp;<span class="ident" id="3999649">ckx</span><span class="op" id="3999652">.</span><span class="ident" id="3999653">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999665">if</span>&nbsp;<span class="ident" id="3999668">version</span>&nbsp;<span class="op" id="3999676">!=</span>&nbsp;<span class="ident" id="3999679">VersionSSL30</span>&nbsp;<span class="op" id="3999692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999696">ciphertextLen</span>&nbsp;<span class="op" id="3999710">:=</span>&nbsp;<span class="builtintype" id="3999713">int</span><span class="op" id="3999716">(</span><span class="ident" id="3999717">ckx</span><span class="op" id="3999720">.</span><span class="ident" id="3999721">ciphertext</span><span class="op" id="3999731">[</span><span class="num" id="3999732">0</span><span class="op" id="3999733">]</span><span class="op" id="3999734">)</span><span class="op" id="3999735">&lt;&lt;</span><span class="num" id="3999737">8</span>&nbsp;<span class="op" id="3999739">|</span>&nbsp;<span class="builtintype" id="3999741">int</span><span class="op" id="3999744">(</span><span class="ident" id="3999745">ckx</span><span class="op" id="3999748">.</span><span class="ident" id="3999749">ciphertext</span><span class="op" id="3999759">[</span><span class="num" id="3999760">1</span><span class="op" id="3999761">]</span><span class="op" id="3999762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999766">if</span>&nbsp;<span class="ident" id="3999769">ciphertextLen</span>&nbsp;<span class="op" id="3999783">!=</span>&nbsp;<span class="builtinfunc" id="3999786">len</span><span class="op" id="3999789">(</span><span class="ident" id="3999790">ckx</span><span class="op" id="3999793">.</span><span class="ident" id="3999794">ciphertext</span><span class="op" id="3999804">)</span><span class="op" id="3999805">-</span><span class="num" id="3999806">2</span>&nbsp;<span class="op" id="3999808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999813">return</span>&nbsp;<span class="ident" id="3999820">nil</span><span class="op" id="3999823">,</span>&nbsp;<span class="ident" id="3999825">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999848">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999852">ciphertext</span>&nbsp;<span class="op" id="3999863">=</span>&nbsp;<span class="ident" id="3999865">ckx</span><span class="op" id="3999868">.</span><span class="ident" id="3999869">ciphertext</span><span class="op" id="3999879">[</span><span class="num" id="3999880">2</span><span class="op" id="3999881">:</span><span class="op" id="3999882">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999889">err</span>&nbsp;<span class="op" id="3999893">=</span>&nbsp;<span class="ident" id="3999895">rsa</span><span class="op" id="3999898">.</span><span class="ident" id="3999899">DecryptPKCS1v15SessionKey</span><span class="op" id="3999924">(</span><span class="ident" id="3999925">config</span><span class="op" id="3999931">.</span><span class="ident" id="3999932">rand</span><span class="op" id="3999936">(</span><span class="op" id="3999937">)</span><span class="op" id="3999938">,</span>&nbsp;<span class="ident" id="3999940">cert</span><span class="op" id="3999944">.</span><span class="ident" id="3999945">PrivateKey</span><span class="op" id="3999955">.</span><span class="op" id="3999956">(</span><span class="op" id="3999957">*</span><span class="ident" id="3999958">rsa</span><span class="op" id="3999961">.</span><span class="ident" id="3999962">PrivateKey</span><span class="op" id="3999972">)</span><span class="op" id="3999973">,</span>&nbsp;<span class="ident" id="3999975">ciphertext</span><span class="op" id="3999985">,</span>&nbsp;<span class="ident" id="3999987">preMasterSecret</span><span class="op" id="4000002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000005">if</span>&nbsp;<span class="ident" id="4000008">err</span>&nbsp;<span class="op" id="4000012">!=</span>&nbsp;<span class="ident" id="4000015">nil</span>&nbsp;<span class="op" id="4000019">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000023">return</span>&nbsp;<span class="ident" id="4000030">nil</span><span class="op" id="4000033">,</span>&nbsp;<span class="ident" id="4000035">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000043">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000116">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000188">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000256">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000329">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4000396">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000421">return</span>&nbsp;<span class="ident" id="4000428">preMasterSecret</span><span class="op" id="4000443">,</span>&nbsp;<span class="ident" id="4000445">nil</span><br>
<span class="lineno"></span><span class="op" id="4000449">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4000452">func</span>&nbsp;<span class="op" id="4000457">(</span><span class="ident" id="4000458">ka</span>&nbsp;<span class="ident" id="4000461">rsaKeyAgreement</span><span class="op" id="4000476">)</span>&nbsp;<span class="ident" id="4000478">processServerKeyExchange</span><span class="op" id="4000502">(</span><span class="ident" id="4000503">config</span>&nbsp;<span class="op" id="4000510">*</span><span class="ident" id="4000511">Config</span><span class="op" id="4000517">,</span>&nbsp;<span class="ident" id="4000519">clientHello</span>&nbsp;<span class="op" id="4000531">*</span><span class="ident" id="4000532">clientHelloMsg</span><span class="op" id="4000546">,</span>&nbsp;<span class="ident" id="4000548">serverHello</span>&nbsp;<span class="op" id="4000560">*</span><span class="ident" id="4000561">serverHelloMsg</span><span class="op" id="4000575">,</span>&nbsp;<span class="ident" id="4000577">cert</span>&nbsp;<span class="op" id="4000582">*</span><span class="ident" id="4000583">x509</span><span class="op" id="4000587">.</span><span class="ident" id="4000588">Certificate</span><span class="op" id="4000599">,</span>&nbsp;<span class="ident" id="4000601">skx</span>&nbsp;<span class="op" id="4000605">*</span><span class="ident" id="4000606">serverKeyExchangeMsg</span><span class="op" id="4000626">)</span>&nbsp;<span class="builtintype" id="4000628">error</span>&nbsp;<span class="op" id="4000634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000637">return</span>&nbsp;<span class="ident" id="4000644">errors</span><span class="op" id="4000650">.</span><span class="ident" id="4000651">New</span><span class="op" id="4000654">(</span><span class="string" id="4000655">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4000690">)</span><br>
<span class="lineno"></span><span class="op" id="4000692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4000695">func</span>&nbsp;<span class="op" id="4000700">(</span><span class="ident" id="4000701">ka</span>&nbsp;<span class="ident" id="4000704">rsaKeyAgreement</span><span class="op" id="4000719">)</span>&nbsp;<span class="ident" id="4000721">generateClientKeyExchange</span><span class="op" id="4000746">(</span><span class="ident" id="4000747">config</span>&nbsp;<span class="op" id="4000754">*</span><span class="ident" id="4000755">Config</span><span class="op" id="4000761">,</span>&nbsp;<span class="ident" id="4000763">clientHello</span>&nbsp;<span class="op" id="4000775">*</span><span class="ident" id="4000776">clientHelloMsg</span><span class="op" id="4000790">,</span>&nbsp;<span class="ident" id="4000792">cert</span>&nbsp;<span class="op" id="4000797">*</span><span class="ident" id="4000798">x509</span><span class="op" id="4000802">.</span><span class="ident" id="4000803">Certificate</span><span class="op" id="4000814">)</span>&nbsp;<span class="op" id="4000816">(</span><span class="op" id="4000817">[</span><span class="op" id="4000818">]</span><span class="builtintype" id="4000819">byte</span><span class="op" id="4000823">,</span>&nbsp;<span class="op" id="4000825">*</span><span class="ident" id="4000826">clientKeyExchangeMsg</span><span class="op" id="4000846">,</span>&nbsp;<span class="builtintype" id="4000848">error</span><span class="op" id="4000853">)</span>&nbsp;<span class="op" id="4000855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000858">preMasterSecret</span>&nbsp;<span class="op" id="4000874">:=</span>&nbsp;<span class="builtinfunc" id="4000877">make</span><span class="op" id="4000881">(</span><span class="op" id="4000882">[</span><span class="op" id="4000883">]</span><span class="builtintype" id="4000884">byte</span><span class="op" id="4000888">,</span>&nbsp;<span class="num" id="4000890">48</span><span class="op" id="4000892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000895">preMasterSecret</span><span class="op" id="4000910">[</span><span class="num" id="4000911">0</span><span class="op" id="4000912">]</span>&nbsp;<span class="op" id="4000914">=</span>&nbsp;<span class="builtintype" id="4000916">byte</span><span class="op" id="4000920">(</span><span class="ident" id="4000921">clientHello</span><span class="op" id="4000932">.</span><span class="ident" id="4000933">vers</span>&nbsp;<span class="op" id="4000938">&gt;&gt;</span>&nbsp;<span class="num" id="4000941">8</span><span class="op" id="4000942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000945">preMasterSecret</span><span class="op" id="4000960">[</span><span class="num" id="4000961">1</span><span class="op" id="4000962">]</span>&nbsp;<span class="op" id="4000964">=</span>&nbsp;<span class="builtintype" id="4000966">byte</span><span class="op" id="4000970">(</span><span class="ident" id="4000971">clientHello</span><span class="op" id="4000982">.</span><span class="ident" id="4000983">vers</span><span class="op" id="4000987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000990">_</span><span class="op" id="4000991">,</span>&nbsp;<span class="ident" id="4000993">err</span>&nbsp;<span class="op" id="4000997">:=</span>&nbsp;<span class="ident" id="4001000">io</span><span class="op" id="4001002">.</span><span class="ident" id="4001003">ReadFull</span><span class="op" id="4001011">(</span><span class="ident" id="4001012">config</span><span class="op" id="4001018">.</span><span class="ident" id="4001019">rand</span><span class="op" id="4001023">(</span><span class="op" id="4001024">)</span><span class="op" id="4001025">,</span>&nbsp;<span class="ident" id="4001027">preMasterSecret</span><span class="op" id="4001042">[</span><span class="num" id="4001043">2</span><span class="op" id="4001044">:</span><span class="op" id="4001045">]</span><span class="op" id="4001046">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001049">if</span>&nbsp;<span class="ident" id="4001052">err</span>&nbsp;<span class="op" id="4001056">!=</span>&nbsp;<span class="ident" id="4001059">nil</span>&nbsp;<span class="op" id="4001063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001067">return</span>&nbsp;<span class="ident" id="4001074">nil</span><span class="op" id="4001077">,</span>&nbsp;<span class="ident" id="4001079">nil</span><span class="op" id="4001082">,</span>&nbsp;<span class="ident" id="4001084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001093">encrypted</span><span class="op" id="4001102">,</span>&nbsp;<span class="ident" id="4001104">err</span>&nbsp;<span class="op" id="4001108">:=</span>&nbsp;<span class="ident" id="4001111">rsa</span><span class="op" id="4001114">.</span><span class="ident" id="4001115">EncryptPKCS1v15</span><span class="op" id="4001130">(</span><span class="ident" id="4001131">config</span><span class="op" id="4001137">.</span><span class="ident" id="4001138">rand</span><span class="op" id="4001142">(</span><span class="op" id="4001143">)</span><span class="op" id="4001144">,</span>&nbsp;<span class="ident" id="4001146">cert</span><span class="op" id="4001150">.</span><span class="ident" id="4001151">PublicKey</span><span class="op" id="4001160">.</span><span class="op" id="4001161">(</span><span class="op" id="4001162">*</span><span class="ident" id="4001163">rsa</span><span class="op" id="4001166">.</span><span class="ident" id="4001167">PublicKey</span><span class="op" id="4001176">)</span><span class="op" id="4001177">,</span>&nbsp;<span class="ident" id="4001179">preMasterSecret</span><span class="op" id="4001194">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001197">if</span>&nbsp;<span class="ident" id="4001200">err</span>&nbsp;<span class="op" id="4001204">!=</span>&nbsp;<span class="ident" id="4001207">nil</span>&nbsp;<span class="op" id="4001211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001215">return</span>&nbsp;<span class="ident" id="4001222">nil</span><span class="op" id="4001225">,</span>&nbsp;<span class="ident" id="4001227">nil</span><span class="op" id="4001230">,</span>&nbsp;<span class="ident" id="4001232">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001240">ckx</span>&nbsp;<span class="op" id="4001244">:=</span>&nbsp;<span class="builtinfunc" id="4001247">new</span><span class="op" id="4001250">(</span><span class="ident" id="4001251">clientKeyExchangeMsg</span><span class="op" id="4001271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001274">ckx</span><span class="op" id="4001277">.</span><span class="ident" id="4001278">ciphertext</span>&nbsp;<span class="op" id="4001289">=</span>&nbsp;<span class="builtinfunc" id="4001291">make</span><span class="op" id="4001295">(</span><span class="op" id="4001296">[</span><span class="op" id="4001297">]</span><span class="builtintype" id="4001298">byte</span><span class="op" id="4001302">,</span>&nbsp;<span class="builtinfunc" id="4001304">len</span><span class="op" id="4001307">(</span><span class="ident" id="4001308">encrypted</span><span class="op" id="4001317">)</span><span class="op" id="4001318">+</span><span class="num" id="4001319">2</span><span class="op" id="4001320">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001323">ckx</span><span class="op" id="4001326">.</span><span class="ident" id="4001327">ciphertext</span><span class="op" id="4001337">[</span><span class="num" id="4001338">0</span><span class="op" id="4001339">]</span>&nbsp;<span class="op" id="4001341">=</span>&nbsp;<span class="builtintype" id="4001343">byte</span><span class="op" id="4001347">(</span><span class="builtinfunc" id="4001348">len</span><span class="op" id="4001351">(</span><span class="ident" id="4001352">encrypted</span><span class="op" id="4001361">)</span>&nbsp;<span class="op" id="4001363">&gt;&gt;</span>&nbsp;<span class="num" id="4001366">8</span><span class="op" id="4001367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001370">ckx</span><span class="op" id="4001373">.</span><span class="ident" id="4001374">ciphertext</span><span class="op" id="4001384">[</span><span class="num" id="4001385">1</span><span class="op" id="4001386">]</span>&nbsp;<span class="op" id="4001388">=</span>&nbsp;<span class="builtintype" id="4001390">byte</span><span class="op" id="4001394">(</span><span class="builtinfunc" id="4001395">len</span><span class="op" id="4001398">(</span><span class="ident" id="4001399">encrypted</span><span class="op" id="4001408">)</span><span class="op" id="4001409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4001412">copy</span><span class="op" id="4001416">(</span><span class="ident" id="4001417">ckx</span><span class="op" id="4001420">.</span><span class="ident" id="4001421">ciphertext</span><span class="op" id="4001431">[</span><span class="num" id="4001432">2</span><span class="op" id="4001433">:</span><span class="op" id="4001434">]</span><span class="op" id="4001435">,</span>&nbsp;<span class="ident" id="4001437">encrypted</span><span class="op" id="4001446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001449">return</span>&nbsp;<span class="ident" id="4001456">preMasterSecret</span><span class="op" id="4001471">,</span>&nbsp;<span class="ident" id="4001473">ckx</span><span class="op" id="4001476">,</span>&nbsp;<span class="ident" id="4001478">nil</span><br>
<span class="lineno"></span><span class="op" id="4001482">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4001485">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4001548">func</span>&nbsp;<span class="ident" id="4001553">sha1Hash</span><span class="op" id="4001561">(</span><span class="ident" id="4001562">slices</span>&nbsp;<span class="op" id="4001569">[</span><span class="op" id="4001570">]</span><span class="op" id="4001571">[</span><span class="op" id="4001572">]</span><span class="builtintype" id="4001573">byte</span><span class="op" id="4001577">)</span>&nbsp;<span class="op" id="4001579">[</span><span class="op" id="4001580">]</span><span class="builtintype" id="4001581">byte</span>&nbsp;<span class="op" id="4001586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001589">hsha1</span>&nbsp;<span class="op" id="4001595">:=</span>&nbsp;<span class="ident" id="4001598">sha1</span><span class="op" id="4001602">.</span><span class="ident" id="4001603">New</span><span class="op" id="4001606">(</span><span class="op" id="4001607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001610">for</span>&nbsp;<span class="ident" id="4001614">_</span><span class="op" id="4001615">,</span>&nbsp;<span class="ident" id="4001617">slice</span>&nbsp;<span class="op" id="4001623">:=</span>&nbsp;<span class="keyword" id="4001626">range</span>&nbsp;<span class="ident" id="4001632">slices</span>&nbsp;<span class="op" id="4001639">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001643">hsha1</span><span class="op" id="4001648">.</span><span class="ident" id="4001649">Write</span><span class="op" id="4001654">(</span><span class="ident" id="4001655">slice</span><span class="op" id="4001660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001666">return</span>&nbsp;<span class="ident" id="4001673">hsha1</span><span class="op" id="4001678">.</span><span class="ident" id="4001679">Sum</span><span class="op" id="4001682">(</span><span class="ident" id="4001683">nil</span><span class="op" id="4001686">)</span><br>
<span class="lineno"></span><span class="op" id="4001688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4001691">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4001770">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4001812">func</span>&nbsp;<span class="ident" id="4001817">md5SHA1Hash</span><span class="op" id="4001828">(</span><span class="ident" id="4001829">slices</span>&nbsp;<span class="op" id="4001836">[</span><span class="op" id="4001837">]</span><span class="op" id="4001838">[</span><span class="op" id="4001839">]</span><span class="builtintype" id="4001840">byte</span><span class="op" id="4001844">)</span>&nbsp;<span class="op" id="4001846">[</span><span class="op" id="4001847">]</span><span class="builtintype" id="4001848">byte</span>&nbsp;<span class="op" id="4001853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001856">md5sha1</span>&nbsp;<span class="op" id="4001864">:=</span>&nbsp;<span class="builtinfunc" id="4001867">make</span><span class="op" id="4001871">(</span><span class="op" id="4001872">[</span><span class="op" id="4001873">]</span><span class="builtintype" id="4001874">byte</span><span class="op" id="4001878">,</span>&nbsp;<span class="ident" id="4001880">md5</span><span class="op" id="4001883">.</span><span class="ident" id="4001884">Size</span><span class="op" id="4001888">+</span><span class="ident" id="4001889">sha1</span><span class="op" id="4001893">.</span><span class="ident" id="4001894">Size</span><span class="op" id="4001898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001901">hmd5</span>&nbsp;<span class="op" id="4001906">:=</span>&nbsp;<span class="ident" id="4001909">md5</span><span class="op" id="4001912">.</span><span class="ident" id="4001913">New</span><span class="op" id="4001916">(</span><span class="op" id="4001917">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001920">for</span>&nbsp;<span class="ident" id="4001924">_</span><span class="op" id="4001925">,</span>&nbsp;<span class="ident" id="4001927">slice</span>&nbsp;<span class="op" id="4001933">:=</span>&nbsp;<span class="keyword" id="4001936">range</span>&nbsp;<span class="ident" id="4001942">slices</span>&nbsp;<span class="op" id="4001949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001953">hmd5</span><span class="op" id="4001957">.</span><span class="ident" id="4001958">Write</span><span class="op" id="4001963">(</span><span class="ident" id="4001964">slice</span><span class="op" id="4001969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4001975">copy</span><span class="op" id="4001979">(</span><span class="ident" id="4001980">md5sha1</span><span class="op" id="4001987">,</span>&nbsp;<span class="ident" id="4001989">hmd5</span><span class="op" id="4001993">.</span><span class="ident" id="4001994">Sum</span><span class="op" id="4001997">(</span><span class="ident" id="4001998">nil</span><span class="op" id="4002001">)</span><span class="op" id="4002002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4002005">copy</span><span class="op" id="4002009">(</span><span class="ident" id="4002010">md5sha1</span><span class="op" id="4002017">[</span><span class="ident" id="4002018">md5</span><span class="op" id="4002021">.</span><span class="ident" id="4002022">Size</span><span class="op" id="4002026">:</span><span class="op" id="4002027">]</span><span class="op" id="4002028">,</span>&nbsp;<span class="ident" id="4002030">sha1Hash</span><span class="op" id="4002038">(</span><span class="ident" id="4002039">slices</span><span class="op" id="4002045">)</span><span class="op" id="4002046">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002049">return</span>&nbsp;<span class="ident" id="4002056">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4002064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4002067">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4002117">func</span>&nbsp;<span class="ident" id="4002122">sha256Hash</span><span class="op" id="4002132">(</span><span class="ident" id="4002133">slices</span>&nbsp;<span class="op" id="4002140">[</span><span class="op" id="4002141">]</span><span class="op" id="4002142">[</span><span class="op" id="4002143">]</span><span class="builtintype" id="4002144">byte</span><span class="op" id="4002148">)</span>&nbsp;<span class="op" id="4002150">[</span><span class="op" id="4002151">]</span><span class="builtintype" id="4002152">byte</span>&nbsp;<span class="op" id="4002157">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002160">h</span>&nbsp;<span class="op" id="4002162">:=</span>&nbsp;<span class="ident" id="4002165">sha256</span><span class="op" id="4002171">.</span><span class="ident" id="4002172">New</span><span class="op" id="4002175">(</span><span class="op" id="4002176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002179">for</span>&nbsp;<span class="ident" id="4002183">_</span><span class="op" id="4002184">,</span>&nbsp;<span class="ident" id="4002186">slice</span>&nbsp;<span class="op" id="4002192">:=</span>&nbsp;<span class="keyword" id="4002195">range</span>&nbsp;<span class="ident" id="4002201">slices</span>&nbsp;<span class="op" id="4002208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4002212">h</span><span class="op" id="4002213">.</span><span class="ident" id="4002214">Write</span><span class="op" id="4002219">(</span><span class="ident" id="4002220">slice</span><span class="op" id="4002225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002231">return</span>&nbsp;<span class="ident" id="4002238">h</span><span class="op" id="4002239">.</span><span class="ident" id="4002240">Sum</span><span class="op" id="4002243">(</span><span class="ident" id="4002244">nil</span><span class="op" id="4002247">)</span><br>
<span class="lineno">120</span><span class="op" id="4002249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4002252">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4002329">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4002408">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4002482">func</span>&nbsp;<span class="ident" id="4002487">hashForServerKeyExchange</span><span class="op" id="4002511">(</span><span class="ident" id="4002512">sigType</span><span class="op" id="4002519">,</span>&nbsp;<span class="ident" id="4002521">hashFunc</span>&nbsp;<span class="builtintype" id="4002530">uint8</span><span class="op" id="4002535">,</span>&nbsp;<span class="ident" id="4002537">version</span>&nbsp;<span class="builtintype" id="4002545">uint16</span><span class="op" id="4002551">,</span>&nbsp;<span class="ident" id="4002553">slices</span>&nbsp;<span class="op" id="4002560">...</span><span class="op" id="4002563">[</span><span class="op" id="4002564">]</span><span class="builtintype" id="4002565">byte</span><span class="op" id="4002569">)</span>&nbsp;<span class="op" id="4002571">(</span><span class="op" id="4002572">[</span><span class="op" id="4002573">]</span><span class="builtintype" id="4002574">byte</span><span class="op" id="4002578">,</span>&nbsp;<span class="ident" id="4002580">crypto</span><span class="op" id="4002586">.</span><span class="ident" id="4002587">Hash</span><span class="op" id="4002591">,</span>&nbsp;<span class="builtintype" id="4002593">error</span><span class="op" id="4002598">)</span>&nbsp;<span class="op" id="4002600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002603">if</span>&nbsp;<span class="ident" id="4002606">version</span>&nbsp;<span class="op" id="4002614">&gt;=</span>&nbsp;<span class="ident" id="4002617">VersionTLS12</span>&nbsp;<span class="op" id="4002630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002634">switch</span>&nbsp;<span class="ident" id="4002641">hashFunc</span>&nbsp;<span class="op" id="4002650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002654">case</span>&nbsp;<span class="ident" id="4002659">hashSHA256</span><span class="op" id="4002669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002674">return</span>&nbsp;<span class="ident" id="4002681">sha256Hash</span><span class="op" id="4002691">(</span><span class="ident" id="4002692">slices</span><span class="op" id="4002698">)</span><span class="op" id="4002699">,</span>&nbsp;<span class="ident" id="4002701">crypto</span><span class="op" id="4002707">.</span><span class="ident" id="4002708">SHA256</span><span class="op" id="4002714">,</span>&nbsp;<span class="ident" id="4002716">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002722">case</span>&nbsp;<span class="ident" id="4002727">hashSHA1</span><span class="op" id="4002735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002740">return</span>&nbsp;<span class="ident" id="4002747">sha1Hash</span><span class="op" id="4002755">(</span><span class="ident" id="4002756">slices</span><span class="op" id="4002762">)</span><span class="op" id="4002763">,</span>&nbsp;<span class="ident" id="4002765">crypto</span><span class="op" id="4002771">.</span><span class="ident" id="4002772">SHA1</span><span class="op" id="4002776">,</span>&nbsp;<span class="ident" id="4002778">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002784">default</span><span class="op" id="4002791">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002796">return</span>&nbsp;<span class="ident" id="4002803">nil</span><span class="op" id="4002806">,</span>&nbsp;<span class="ident" id="4002808">crypto</span><span class="op" id="4002814">.</span><span class="ident" id="4002815">Hash</span><span class="op" id="4002819">(</span><span class="num" id="4002820">0</span><span class="op" id="4002821">)</span><span class="op" id="4002822">,</span>&nbsp;<span class="ident" id="4002824">errors</span><span class="op" id="4002830">.</span><span class="ident" id="4002831">New</span><span class="op" id="4002834">(</span><span class="string" id="4002835">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4002876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002880">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002886">if</span>&nbsp;<span class="ident" id="4002889">sigType</span>&nbsp;<span class="op" id="4002897">==</span>&nbsp;<span class="ident" id="4002900">signatureECDSA</span>&nbsp;<span class="op" id="4002915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002919">return</span>&nbsp;<span class="ident" id="4002926">sha1Hash</span><span class="op" id="4002934">(</span><span class="ident" id="4002935">slices</span><span class="op" id="4002941">)</span><span class="op" id="4002942">,</span>&nbsp;<span class="ident" id="4002944">crypto</span><span class="op" id="4002950">.</span><span class="ident" id="4002951">SHA1</span><span class="op" id="4002955">,</span>&nbsp;<span class="ident" id="4002957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4002962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4002965">return</span>&nbsp;<span class="ident" id="4002972">md5SHA1Hash</span><span class="op" id="4002983">(</span><span class="ident" id="4002984">slices</span><span class="op" id="4002990">)</span><span class="op" id="4002991">,</span>&nbsp;<span class="ident" id="4002993">crypto</span><span class="op" id="4002999">.</span><span class="ident" id="4003000">MD5SHA1</span><span class="op" id="4003007">,</span>&nbsp;<span class="ident" id="4003009">nil</span><br>
<span class="lineno">140</span><span class="op" id="4003013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4003016">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4003093">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4003167">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4003232">func</span>&nbsp;<span class="ident" id="4003237">pickTLS12HashForSignature</span><span class="op" id="4003262">(</span><span class="ident" id="4003263">sigType</span>&nbsp;<span class="builtintype" id="4003271">uint8</span><span class="op" id="4003276">,</span>&nbsp;<span class="ident" id="4003278">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4003303">[</span><span class="op" id="4003304">]</span><span class="ident" id="4003305">signatureAndHash</span><span class="op" id="4003321">)</span>&nbsp;<span class="op" id="4003323">(</span><span class="builtintype" id="4003324">uint8</span><span class="op" id="4003329">,</span>&nbsp;<span class="builtintype" id="4003331">error</span><span class="op" id="4003336">)</span>&nbsp;<span class="op" id="4003338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003341">if</span>&nbsp;<span class="builtinfunc" id="4003344">len</span><span class="op" id="4003347">(</span><span class="ident" id="4003348">clientSignatureAndHashes</span><span class="op" id="4003372">)</span>&nbsp;<span class="op" id="4003374">==</span>&nbsp;<span class="num" id="4003377">0</span>&nbsp;<span class="op" id="4003379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4003383">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4003442">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4003503">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003561">return</span>&nbsp;<span class="ident" id="4003568">hashSHA1</span><span class="op" id="4003576">,</span>&nbsp;<span class="ident" id="4003578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003587">for</span>&nbsp;<span class="ident" id="4003591">_</span><span class="op" id="4003592">,</span>&nbsp;<span class="ident" id="4003594">sigAndHash</span>&nbsp;<span class="op" id="4003605">:=</span>&nbsp;<span class="keyword" id="4003608">range</span>&nbsp;<span class="ident" id="4003614">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4003639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003643">if</span>&nbsp;<span class="ident" id="4003646">sigAndHash</span><span class="op" id="4003656">.</span><span class="ident" id="4003657">signature</span>&nbsp;<span class="op" id="4003667">!=</span>&nbsp;<span class="ident" id="4003670">sigType</span>&nbsp;<span class="op" id="4003678">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003683">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003698">switch</span>&nbsp;<span class="ident" id="4003705">sigAndHash</span><span class="op" id="4003715">.</span><span class="ident" id="4003716">hash</span>&nbsp;<span class="op" id="4003721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003725">case</span>&nbsp;<span class="ident" id="4003730">hashSHA1</span><span class="op" id="4003738">,</span>&nbsp;<span class="ident" id="4003740">hashSHA256</span><span class="op" id="4003750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003755">return</span>&nbsp;<span class="ident" id="4003762">sigAndHash</span><span class="op" id="4003772">.</span><span class="ident" id="4003773">hash</span><span class="op" id="4003777">,</span>&nbsp;<span class="ident" id="4003779">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4003788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003792">return</span>&nbsp;<span class="num" id="4003799">0</span><span class="op" id="4003800">,</span>&nbsp;<span class="ident" id="4003802">errors</span><span class="op" id="4003808">.</span><span class="ident" id="4003809">New</span><span class="op" id="4003812">(</span><span class="string" id="4003813">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4003868">)</span><br>
<span class="lineno"></span><span class="op" id="4003870">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4003873">func</span>&nbsp;<span class="ident" id="4003878">curveForCurveID</span><span class="op" id="4003893">(</span><span class="ident" id="4003894">id</span>&nbsp;<span class="ident" id="4003897">CurveID</span><span class="op" id="4003904">)</span>&nbsp;<span class="op" id="4003906">(</span><span class="ident" id="4003907">elliptic</span><span class="op" id="4003915">.</span><span class="ident" id="4003916">Curve</span><span class="op" id="4003921">,</span>&nbsp;<span class="builtintype" id="4003923">bool</span><span class="op" id="4003927">)</span>&nbsp;<span class="op" id="4003929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003932">switch</span>&nbsp;<span class="ident" id="4003939">id</span>&nbsp;<span class="op" id="4003942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003945">case</span>&nbsp;<span class="ident" id="4003950">CurveP256</span><span class="op" id="4003959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003963">return</span>&nbsp;<span class="ident" id="4003970">elliptic</span><span class="op" id="4003978">.</span><span class="ident" id="4003979">P256</span><span class="op" id="4003983">(</span><span class="op" id="4003984">)</span><span class="op" id="4003985">,</span>&nbsp;<span class="ident" id="4003987">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4003993">case</span>&nbsp;<span class="ident" id="4003998">CurveP384</span><span class="op" id="4004007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004011">return</span>&nbsp;<span class="ident" id="4004018">elliptic</span><span class="op" id="4004026">.</span><span class="ident" id="4004027">P384</span><span class="op" id="4004031">(</span><span class="op" id="4004032">)</span><span class="op" id="4004033">,</span>&nbsp;<span class="ident" id="4004035">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004041">case</span>&nbsp;<span class="ident" id="4004046">CurveP521</span><span class="op" id="4004055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004059">return</span>&nbsp;<span class="ident" id="4004066">elliptic</span><span class="op" id="4004074">.</span><span class="ident" id="4004075">P521</span><span class="op" id="4004079">(</span><span class="op" id="4004080">)</span><span class="op" id="4004081">,</span>&nbsp;<span class="ident" id="4004083">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004089">default</span><span class="op" id="4004096">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004100">return</span>&nbsp;<span class="ident" id="4004107">nil</span><span class="op" id="4004110">,</span>&nbsp;<span class="ident" id="4004112">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4004122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4004125">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4004197">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4004267">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4004337">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4004364">type</span>&nbsp;<span class="ident" id="4004369">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4004387">struct</span>&nbsp;<span class="op" id="4004394">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004397">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4004408">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004416">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4004427">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004434">privateKey</span>&nbsp;<span class="op" id="4004445">[</span><span class="op" id="4004446">]</span><span class="builtintype" id="4004447">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004453">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004464">elliptic</span><span class="op" id="4004472">.</span><span class="ident" id="4004473">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004480">x</span><span class="op" id="4004481">,</span>&nbsp;<span class="ident" id="4004483">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4004491">*</span><span class="ident" id="4004492">big</span><span class="op" id="4004495">.</span><span class="ident" id="4004496">Int</span><br>
<span class="lineno">190</span><span class="op" id="4004500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4004503">func</span>&nbsp;<span class="op" id="4004508">(</span><span class="ident" id="4004509">ka</span>&nbsp;<span class="op" id="4004512">*</span><span class="ident" id="4004513">ecdheKeyAgreement</span><span class="op" id="4004530">)</span>&nbsp;<span class="ident" id="4004532">generateServerKeyExchange</span><span class="op" id="4004557">(</span><span class="ident" id="4004558">config</span>&nbsp;<span class="op" id="4004565">*</span><span class="ident" id="4004566">Config</span><span class="op" id="4004572">,</span>&nbsp;<span class="ident" id="4004574">cert</span>&nbsp;<span class="op" id="4004579">*</span><span class="ident" id="4004580">Certificate</span><span class="op" id="4004591">,</span>&nbsp;<span class="ident" id="4004593">clientHello</span>&nbsp;<span class="op" id="4004605">*</span><span class="ident" id="4004606">clientHelloMsg</span><span class="op" id="4004620">,</span>&nbsp;<span class="ident" id="4004622">hello</span>&nbsp;<span class="op" id="4004628">*</span><span class="ident" id="4004629">serverHelloMsg</span><span class="op" id="4004643">)</span>&nbsp;<span class="op" id="4004645">(</span><span class="op" id="4004646">*</span><span class="ident" id="4004647">serverKeyExchangeMsg</span><span class="op" id="4004667">,</span>&nbsp;<span class="builtintype" id="4004669">error</span><span class="op" id="4004674">)</span>&nbsp;<span class="op" id="4004676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004679">var</span>&nbsp;<span class="ident" id="4004683">curveid</span>&nbsp;<span class="ident" id="4004691">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004700">preferredCurves</span>&nbsp;<span class="op" id="4004716">:=</span>&nbsp;<span class="ident" id="4004719">config</span><span class="op" id="4004725">.</span><span class="ident" id="4004726">curvePreferences</span><span class="op" id="4004742">(</span><span class="op" id="4004743">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4004746">NextCandidate</span><span class="op" id="4004759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004762">for</span>&nbsp;<span class="ident" id="4004766">_</span><span class="op" id="4004767">,</span>&nbsp;<span class="ident" id="4004769">candidate</span>&nbsp;<span class="op" id="4004779">:=</span>&nbsp;<span class="keyword" id="4004782">range</span>&nbsp;<span class="ident" id="4004788">preferredCurves</span>&nbsp;<span class="op" id="4004804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004808">for</span>&nbsp;<span class="ident" id="4004812">_</span><span class="op" id="4004813">,</span>&nbsp;<span class="ident" id="4004815">c</span>&nbsp;<span class="op" id="4004817">:=</span>&nbsp;<span class="keyword" id="4004820">range</span>&nbsp;<span class="ident" id="4004826">clientHello</span><span class="op" id="4004837">.</span><span class="ident" id="4004838">supportedCurves</span>&nbsp;<span class="op" id="4004854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004859">if</span>&nbsp;<span class="ident" id="4004862">candidate</span>&nbsp;<span class="op" id="4004872">==</span>&nbsp;<span class="ident" id="4004875">c</span>&nbsp;<span class="op" id="4004877">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4004883">curveid</span>&nbsp;<span class="op" id="4004891">=</span>&nbsp;<span class="ident" id="4004893">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004899">break</span>&nbsp;<span class="ident" id="4004905">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4004929">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004933">if</span>&nbsp;<span class="ident" id="4004936">curveid</span>&nbsp;<span class="op" id="4004944">==</span>&nbsp;<span class="num" id="4004947">0</span>&nbsp;<span class="op" id="4004949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4004953">return</span>&nbsp;<span class="ident" id="4004960">nil</span><span class="op" id="4004963">,</span>&nbsp;<span class="ident" id="4004965">errors</span><span class="op" id="4004971">.</span><span class="ident" id="4004972">New</span><span class="op" id="4004975">(</span><span class="string" id="4004976">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4005019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005026">var</span>&nbsp;<span class="ident" id="4005030">ok</span>&nbsp;<span class="builtintype" id="4005033">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005039">if</span>&nbsp;<span class="ident" id="4005042">ka</span><span class="op" id="4005044">.</span><span class="ident" id="4005045">curve</span><span class="op" id="4005050">,</span>&nbsp;<span class="ident" id="4005052">ok</span>&nbsp;<span class="op" id="4005055">=</span>&nbsp;<span class="ident" id="4005057">curveForCurveID</span><span class="op" id="4005072">(</span><span class="ident" id="4005073">curveid</span><span class="op" id="4005080">)</span><span class="op" id="4005081">;</span>&nbsp;<span class="op" id="4005083">!</span><span class="ident" id="4005084">ok</span>&nbsp;<span class="op" id="4005087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005091">return</span>&nbsp;<span class="ident" id="4005098">nil</span><span class="op" id="4005101">,</span>&nbsp;<span class="ident" id="4005103">errors</span><span class="op" id="4005109">.</span><span class="ident" id="4005110">New</span><span class="op" id="4005113">(</span><span class="string" id="4005114">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4005163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005170">var</span>&nbsp;<span class="ident" id="4005174">x</span><span class="op" id="4005175">,</span>&nbsp;<span class="ident" id="4005177">y</span>&nbsp;<span class="op" id="4005179">*</span><span class="ident" id="4005180">big</span><span class="op" id="4005183">.</span><span class="ident" id="4005184">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005189">var</span>&nbsp;<span class="ident" id="4005193">err</span>&nbsp;<span class="builtintype" id="4005197">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005204">ka</span><span class="op" id="4005206">.</span><span class="ident" id="4005207">privateKey</span><span class="op" id="4005217">,</span>&nbsp;<span class="ident" id="4005219">x</span><span class="op" id="4005220">,</span>&nbsp;<span class="ident" id="4005222">y</span><span class="op" id="4005223">,</span>&nbsp;<span class="ident" id="4005225">err</span>&nbsp;<span class="op" id="4005229">=</span>&nbsp;<span class="ident" id="4005231">elliptic</span><span class="op" id="4005239">.</span><span class="ident" id="4005240">GenerateKey</span><span class="op" id="4005251">(</span><span class="ident" id="4005252">ka</span><span class="op" id="4005254">.</span><span class="ident" id="4005255">curve</span><span class="op" id="4005260">,</span>&nbsp;<span class="ident" id="4005262">config</span><span class="op" id="4005268">.</span><span class="ident" id="4005269">rand</span><span class="op" id="4005273">(</span><span class="op" id="4005274">)</span><span class="op" id="4005275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005278">if</span>&nbsp;<span class="ident" id="4005281">err</span>&nbsp;<span class="op" id="4005285">!=</span>&nbsp;<span class="ident" id="4005288">nil</span>&nbsp;<span class="op" id="4005292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005296">return</span>&nbsp;<span class="ident" id="4005303">nil</span><span class="op" id="4005306">,</span>&nbsp;<span class="ident" id="4005308">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005316">ecdhePublic</span>&nbsp;<span class="op" id="4005328">:=</span>&nbsp;<span class="ident" id="4005331">elliptic</span><span class="op" id="4005339">.</span><span class="ident" id="4005340">Marshal</span><span class="op" id="4005347">(</span><span class="ident" id="4005348">ka</span><span class="op" id="4005350">.</span><span class="ident" id="4005351">curve</span><span class="op" id="4005356">,</span>&nbsp;<span class="ident" id="4005358">x</span><span class="op" id="4005359">,</span>&nbsp;<span class="ident" id="4005361">y</span><span class="op" id="4005362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4005366">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005417">serverECDHParams</span>&nbsp;<span class="op" id="4005434">:=</span>&nbsp;<span class="builtinfunc" id="4005437">make</span><span class="op" id="4005441">(</span><span class="op" id="4005442">[</span><span class="op" id="4005443">]</span><span class="builtintype" id="4005444">byte</span><span class="op" id="4005448">,</span>&nbsp;<span class="num" id="4005450">1</span><span class="op" id="4005451">+</span><span class="num" id="4005452">2</span><span class="op" id="4005453">+</span><span class="num" id="4005454">1</span><span class="op" id="4005455">+</span><span class="builtinfunc" id="4005456">len</span><span class="op" id="4005459">(</span><span class="ident" id="4005460">ecdhePublic</span><span class="op" id="4005471">)</span><span class="op" id="4005472">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005475">serverECDHParams</span><span class="op" id="4005491">[</span><span class="num" id="4005492">0</span><span class="op" id="4005493">]</span>&nbsp;<span class="op" id="4005495">=</span>&nbsp;<span class="num" id="4005497">3</span>&nbsp;<span class="comment" id="4005499">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005515">serverECDHParams</span><span class="op" id="4005531">[</span><span class="num" id="4005532">1</span><span class="op" id="4005533">]</span>&nbsp;<span class="op" id="4005535">=</span>&nbsp;<span class="builtintype" id="4005537">byte</span><span class="op" id="4005541">(</span><span class="ident" id="4005542">curveid</span>&nbsp;<span class="op" id="4005550">&gt;&gt;</span>&nbsp;<span class="num" id="4005553">8</span><span class="op" id="4005554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005557">serverECDHParams</span><span class="op" id="4005573">[</span><span class="num" id="4005574">2</span><span class="op" id="4005575">]</span>&nbsp;<span class="op" id="4005577">=</span>&nbsp;<span class="builtintype" id="4005579">byte</span><span class="op" id="4005583">(</span><span class="ident" id="4005584">curveid</span><span class="op" id="4005591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005594">serverECDHParams</span><span class="op" id="4005610">[</span><span class="num" id="4005611">3</span><span class="op" id="4005612">]</span>&nbsp;<span class="op" id="4005614">=</span>&nbsp;<span class="builtintype" id="4005616">byte</span><span class="op" id="4005620">(</span><span class="builtinfunc" id="4005621">len</span><span class="op" id="4005624">(</span><span class="ident" id="4005625">ecdhePublic</span><span class="op" id="4005636">)</span><span class="op" id="4005637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4005640">copy</span><span class="op" id="4005644">(</span><span class="ident" id="4005645">serverECDHParams</span><span class="op" id="4005661">[</span><span class="num" id="4005662">4</span><span class="op" id="4005663">:</span><span class="op" id="4005664">]</span><span class="op" id="4005665">,</span>&nbsp;<span class="ident" id="4005667">ecdhePublic</span><span class="op" id="4005678">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005682">var</span>&nbsp;<span class="ident" id="4005686">tls12HashId</span>&nbsp;<span class="builtintype" id="4005698">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005705">if</span>&nbsp;<span class="ident" id="4005708">ka</span><span class="op" id="4005710">.</span><span class="ident" id="4005711">version</span>&nbsp;<span class="op" id="4005719">&gt;=</span>&nbsp;<span class="ident" id="4005722">VersionTLS12</span>&nbsp;<span class="op" id="4005735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005739">if</span>&nbsp;<span class="ident" id="4005742">tls12HashId</span><span class="op" id="4005753">,</span>&nbsp;<span class="ident" id="4005755">err</span>&nbsp;<span class="op" id="4005759">=</span>&nbsp;<span class="ident" id="4005761">pickTLS12HashForSignature</span><span class="op" id="4005786">(</span><span class="ident" id="4005787">ka</span><span class="op" id="4005789">.</span><span class="ident" id="4005790">sigType</span><span class="op" id="4005797">,</span>&nbsp;<span class="ident" id="4005799">clientHello</span><span class="op" id="4005810">.</span><span class="ident" id="4005811">signatureAndHashes</span><span class="op" id="4005829">)</span><span class="op" id="4005830">;</span>&nbsp;<span class="ident" id="4005832">err</span>&nbsp;<span class="op" id="4005836">!=</span>&nbsp;<span class="ident" id="4005839">nil</span>&nbsp;<span class="op" id="4005843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4005848">return</span>&nbsp;<span class="ident" id="4005855">nil</span><span class="op" id="4005858">,</span>&nbsp;<span class="ident" id="4005860">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4005869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4005873">digest</span><span class="op" id="4005879">,</span>&nbsp;<span class="ident" id="4005881">hashFunc</span><span class="op" id="4005889">,</span>&nbsp;<span class="ident" id="4005891">err</span>&nbsp;<span class="op" id="4005895">:=</span>&nbsp;<span class="ident" id="4005898">hashForServerKeyExchange</span><span class="op" id="4005922">(</span><span class="ident" id="4005923">ka</span><span class="op" id="4005925">.</span><span class="ident" id="4005926">sigType</span><span class="op" id="4005933">,</span>&nbsp;<span class="ident" id="4005935">tls12HashId</span><span class="op" id="4005946">,</span>&nbsp;<span class="ident" id="4005948">ka</span><span class="op" id="4005950">.</span><span class="ident" id="4005951">version</span><span class="op" id="4005958">,</span>&nbsp;<span class="ident" id="4005960">clientHello</span><span class="op" id="4005971">.</span><span class="ident" id="4005972">random</span><span class="op" id="4005978">,</span>&nbsp;<span class="ident" id="4005980">hello</span><span class="op" id="4005985">.</span><span class="ident" id="4005986">random</span><span class="op" id="4005992">,</span>&nbsp;<span class="ident" id="4005994">serverECDHParams</span><span class="op" id="4006010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006013">if</span>&nbsp;<span class="ident" id="4006016">err</span>&nbsp;<span class="op" id="4006020">!=</span>&nbsp;<span class="ident" id="4006023">nil</span>&nbsp;<span class="op" id="4006027">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006031">return</span>&nbsp;<span class="ident" id="4006038">nil</span><span class="op" id="4006041">,</span>&nbsp;<span class="ident" id="4006043">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006051">var</span>&nbsp;<span class="ident" id="4006055">sig</span>&nbsp;<span class="op" id="4006059">[</span><span class="op" id="4006060">]</span><span class="builtintype" id="4006061">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006067">switch</span>&nbsp;<span class="ident" id="4006074">ka</span><span class="op" id="4006076">.</span><span class="ident" id="4006077">sigType</span>&nbsp;<span class="op" id="4006085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006088">case</span>&nbsp;<span class="ident" id="4006093">signatureECDSA</span><span class="op" id="4006107">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006111">privKey</span><span class="op" id="4006118">,</span>&nbsp;<span class="ident" id="4006120">ok</span>&nbsp;<span class="op" id="4006123">:=</span>&nbsp;<span class="ident" id="4006126">cert</span><span class="op" id="4006130">.</span><span class="ident" id="4006131">PrivateKey</span><span class="op" id="4006141">.</span><span class="op" id="4006142">(</span><span class="op" id="4006143">*</span><span class="ident" id="4006144">ecdsa</span><span class="op" id="4006149">.</span><span class="ident" id="4006150">PrivateKey</span><span class="op" id="4006160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006164">if</span>&nbsp;<span class="op" id="4006167">!</span><span class="ident" id="4006168">ok</span>&nbsp;<span class="op" id="4006171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006176">return</span>&nbsp;<span class="ident" id="4006183">nil</span><span class="op" id="4006186">,</span>&nbsp;<span class="ident" id="4006188">errors</span><span class="op" id="4006194">.</span><span class="ident" id="4006195">New</span><span class="op" id="4006198">(</span><span class="string" id="4006199">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4006249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006257">r</span><span class="op" id="4006258">,</span>&nbsp;<span class="ident" id="4006260">s</span><span class="op" id="4006261">,</span>&nbsp;<span class="ident" id="4006263">err</span>&nbsp;<span class="op" id="4006267">:=</span>&nbsp;<span class="ident" id="4006270">ecdsa</span><span class="op" id="4006275">.</span><span class="ident" id="4006276">Sign</span><span class="op" id="4006280">(</span><span class="ident" id="4006281">config</span><span class="op" id="4006287">.</span><span class="ident" id="4006288">rand</span><span class="op" id="4006292">(</span><span class="op" id="4006293">)</span><span class="op" id="4006294">,</span>&nbsp;<span class="ident" id="4006296">privKey</span><span class="op" id="4006303">,</span>&nbsp;<span class="ident" id="4006305">digest</span><span class="op" id="4006311">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006315">if</span>&nbsp;<span class="ident" id="4006318">err</span>&nbsp;<span class="op" id="4006322">!=</span>&nbsp;<span class="ident" id="4006325">nil</span>&nbsp;<span class="op" id="4006329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006334">return</span>&nbsp;<span class="ident" id="4006341">nil</span><span class="op" id="4006344">,</span>&nbsp;<span class="ident" id="4006346">errors</span><span class="op" id="4006352">.</span><span class="ident" id="4006353">New</span><span class="op" id="4006356">(</span><span class="string" id="4006357">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4006393">+</span>&nbsp;<span class="ident" id="4006395">err</span><span class="op" id="4006398">.</span><span class="ident" id="4006399">Error</span><span class="op" id="4006404">(</span><span class="op" id="4006405">)</span><span class="op" id="4006406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006414">sig</span><span class="op" id="4006417">,</span>&nbsp;<span class="ident" id="4006419">err</span>&nbsp;<span class="op" id="4006423">=</span>&nbsp;<span class="ident" id="4006425">asn1</span><span class="op" id="4006429">.</span><span class="ident" id="4006430">Marshal</span><span class="op" id="4006437">(</span><span class="ident" id="4006438">ecdsaSignature</span><span class="op" id="4006452">{</span><span class="ident" id="4006453">r</span><span class="op" id="4006454">,</span>&nbsp;<span class="ident" id="4006456">s</span><span class="op" id="4006457">}</span><span class="op" id="4006458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006461">case</span>&nbsp;<span class="ident" id="4006466">signatureRSA</span><span class="op" id="4006478">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006482">privKey</span><span class="op" id="4006489">,</span>&nbsp;<span class="ident" id="4006491">ok</span>&nbsp;<span class="op" id="4006494">:=</span>&nbsp;<span class="ident" id="4006497">cert</span><span class="op" id="4006501">.</span><span class="ident" id="4006502">PrivateKey</span><span class="op" id="4006512">.</span><span class="op" id="4006513">(</span><span class="op" id="4006514">*</span><span class="ident" id="4006515">rsa</span><span class="op" id="4006518">.</span><span class="ident" id="4006519">PrivateKey</span><span class="op" id="4006529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006533">if</span>&nbsp;<span class="op" id="4006536">!</span><span class="ident" id="4006537">ok</span>&nbsp;<span class="op" id="4006540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006545">return</span>&nbsp;<span class="ident" id="4006552">nil</span><span class="op" id="4006555">,</span>&nbsp;<span class="ident" id="4006557">errors</span><span class="op" id="4006563">.</span><span class="ident" id="4006564">New</span><span class="op" id="4006567">(</span><span class="string" id="4006568">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4006613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006621">sig</span><span class="op" id="4006624">,</span>&nbsp;<span class="ident" id="4006626">err</span>&nbsp;<span class="op" id="4006630">=</span>&nbsp;<span class="ident" id="4006632">rsa</span><span class="op" id="4006635">.</span><span class="ident" id="4006636">SignPKCS1v15</span><span class="op" id="4006648">(</span><span class="ident" id="4006649">config</span><span class="op" id="4006655">.</span><span class="ident" id="4006656">rand</span><span class="op" id="4006660">(</span><span class="op" id="4006661">)</span><span class="op" id="4006662">,</span>&nbsp;<span class="ident" id="4006664">privKey</span><span class="op" id="4006671">,</span>&nbsp;<span class="ident" id="4006673">hashFunc</span><span class="op" id="4006681">,</span>&nbsp;<span class="ident" id="4006683">digest</span><span class="op" id="4006689">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006693">if</span>&nbsp;<span class="ident" id="4006696">err</span>&nbsp;<span class="op" id="4006700">!=</span>&nbsp;<span class="ident" id="4006703">nil</span>&nbsp;<span class="op" id="4006707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006712">return</span>&nbsp;<span class="ident" id="4006719">nil</span><span class="op" id="4006722">,</span>&nbsp;<span class="ident" id="4006724">errors</span><span class="op" id="4006730">.</span><span class="ident" id="4006731">New</span><span class="op" id="4006734">(</span><span class="string" id="4006735">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4006771">+</span>&nbsp;<span class="ident" id="4006773">err</span><span class="op" id="4006776">.</span><span class="ident" id="4006777">Error</span><span class="op" id="4006782">(</span><span class="op" id="4006783">)</span><span class="op" id="4006784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006791">default</span><span class="op" id="4006798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006802">return</span>&nbsp;<span class="ident" id="4006809">nil</span><span class="op" id="4006812">,</span>&nbsp;<span class="ident" id="4006814">errors</span><span class="op" id="4006820">.</span><span class="ident" id="4006821">New</span><span class="op" id="4006824">(</span><span class="string" id="4006825">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4006860">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006867">skx</span>&nbsp;<span class="op" id="4006871">:=</span>&nbsp;<span class="builtinfunc" id="4006874">new</span><span class="op" id="4006877">(</span><span class="ident" id="4006878">serverKeyExchangeMsg</span><span class="op" id="4006898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006901">sigAndHashLen</span>&nbsp;<span class="op" id="4006915">:=</span>&nbsp;<span class="num" id="4006918">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4006921">if</span>&nbsp;<span class="ident" id="4006924">ka</span><span class="op" id="4006926">.</span><span class="ident" id="4006927">version</span>&nbsp;<span class="op" id="4006935">&gt;=</span>&nbsp;<span class="ident" id="4006938">VersionTLS12</span>&nbsp;<span class="op" id="4006951">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006955">sigAndHashLen</span>&nbsp;<span class="op" id="4006969">=</span>&nbsp;<span class="num" id="4006971">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4006974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006977">skx</span><span class="op" id="4006980">.</span><span class="ident" id="4006981">key</span>&nbsp;<span class="op" id="4006985">=</span>&nbsp;<span class="builtinfunc" id="4006987">make</span><span class="op" id="4006991">(</span><span class="op" id="4006992">[</span><span class="op" id="4006993">]</span><span class="builtintype" id="4006994">byte</span><span class="op" id="4006998">,</span>&nbsp;<span class="builtinfunc" id="4007000">len</span><span class="op" id="4007003">(</span><span class="ident" id="4007004">serverECDHParams</span><span class="op" id="4007020">)</span><span class="op" id="4007021">+</span><span class="ident" id="4007022">sigAndHashLen</span><span class="op" id="4007035">+</span><span class="num" id="4007036">2</span><span class="op" id="4007037">+</span><span class="builtinfunc" id="4007038">len</span><span class="op" id="4007041">(</span><span class="ident" id="4007042">sig</span><span class="op" id="4007045">)</span><span class="op" id="4007046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4007049">copy</span><span class="op" id="4007053">(</span><span class="ident" id="4007054">skx</span><span class="op" id="4007057">.</span><span class="ident" id="4007058">key</span><span class="op" id="4007061">,</span>&nbsp;<span class="ident" id="4007063">serverECDHParams</span><span class="op" id="4007079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007082">k</span>&nbsp;<span class="op" id="4007084">:=</span>&nbsp;<span class="ident" id="4007087">skx</span><span class="op" id="4007090">.</span><span class="ident" id="4007091">key</span><span class="op" id="4007094">[</span><span class="builtinfunc" id="4007095">len</span><span class="op" id="4007098">(</span><span class="ident" id="4007099">serverECDHParams</span><span class="op" id="4007115">)</span><span class="op" id="4007116">:</span><span class="op" id="4007117">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007120">if</span>&nbsp;<span class="ident" id="4007123">ka</span><span class="op" id="4007125">.</span><span class="ident" id="4007126">version</span>&nbsp;<span class="op" id="4007134">&gt;=</span>&nbsp;<span class="ident" id="4007137">VersionTLS12</span>&nbsp;<span class="op" id="4007150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007154">k</span><span class="op" id="4007155">[</span><span class="num" id="4007156">0</span><span class="op" id="4007157">]</span>&nbsp;<span class="op" id="4007159">=</span>&nbsp;<span class="ident" id="4007161">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007175">k</span><span class="op" id="4007176">[</span><span class="num" id="4007177">1</span><span class="op" id="4007178">]</span>&nbsp;<span class="op" id="4007180">=</span>&nbsp;<span class="ident" id="4007182">ka</span><span class="op" id="4007184">.</span><span class="ident" id="4007185">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007195">k</span>&nbsp;<span class="op" id="4007197">=</span>&nbsp;<span class="ident" id="4007199">k</span><span class="op" id="4007200">[</span><span class="num" id="4007201">2</span><span class="op" id="4007202">:</span><span class="op" id="4007203">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007206">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007209">k</span><span class="op" id="4007210">[</span><span class="num" id="4007211">0</span><span class="op" id="4007212">]</span>&nbsp;<span class="op" id="4007214">=</span>&nbsp;<span class="builtintype" id="4007216">byte</span><span class="op" id="4007220">(</span><span class="builtinfunc" id="4007221">len</span><span class="op" id="4007224">(</span><span class="ident" id="4007225">sig</span><span class="op" id="4007228">)</span>&nbsp;<span class="op" id="4007230">&gt;&gt;</span>&nbsp;<span class="num" id="4007233">8</span><span class="op" id="4007234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007237">k</span><span class="op" id="4007238">[</span><span class="num" id="4007239">1</span><span class="op" id="4007240">]</span>&nbsp;<span class="op" id="4007242">=</span>&nbsp;<span class="builtintype" id="4007244">byte</span><span class="op" id="4007248">(</span><span class="builtinfunc" id="4007249">len</span><span class="op" id="4007252">(</span><span class="ident" id="4007253">sig</span><span class="op" id="4007256">)</span><span class="op" id="4007257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4007260">copy</span><span class="op" id="4007264">(</span><span class="ident" id="4007265">k</span><span class="op" id="4007266">[</span><span class="num" id="4007267">2</span><span class="op" id="4007268">:</span><span class="op" id="4007269">]</span><span class="op" id="4007270">,</span>&nbsp;<span class="ident" id="4007272">sig</span><span class="op" id="4007275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007279">return</span>&nbsp;<span class="ident" id="4007286">skx</span><span class="op" id="4007289">,</span>&nbsp;<span class="ident" id="4007291">nil</span><br>
<span class="lineno">285</span><span class="op" id="4007295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4007298">func</span>&nbsp;<span class="op" id="4007303">(</span><span class="ident" id="4007304">ka</span>&nbsp;<span class="op" id="4007307">*</span><span class="ident" id="4007308">ecdheKeyAgreement</span><span class="op" id="4007325">)</span>&nbsp;<span class="ident" id="4007327">processClientKeyExchange</span><span class="op" id="4007351">(</span><span class="ident" id="4007352">config</span>&nbsp;<span class="op" id="4007359">*</span><span class="ident" id="4007360">Config</span><span class="op" id="4007366">,</span>&nbsp;<span class="ident" id="4007368">cert</span>&nbsp;<span class="op" id="4007373">*</span><span class="ident" id="4007374">Certificate</span><span class="op" id="4007385">,</span>&nbsp;<span class="ident" id="4007387">ckx</span>&nbsp;<span class="op" id="4007391">*</span><span class="ident" id="4007392">clientKeyExchangeMsg</span><span class="op" id="4007412">,</span>&nbsp;<span class="ident" id="4007414">version</span>&nbsp;<span class="builtintype" id="4007422">uint16</span><span class="op" id="4007428">)</span>&nbsp;<span class="op" id="4007430">(</span><span class="op" id="4007431">[</span><span class="op" id="4007432">]</span><span class="builtintype" id="4007433">byte</span><span class="op" id="4007437">,</span>&nbsp;<span class="builtintype" id="4007439">error</span><span class="op" id="4007444">)</span>&nbsp;<span class="op" id="4007446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007449">if</span>&nbsp;<span class="builtinfunc" id="4007452">len</span><span class="op" id="4007455">(</span><span class="ident" id="4007456">ckx</span><span class="op" id="4007459">.</span><span class="ident" id="4007460">ciphertext</span><span class="op" id="4007470">)</span>&nbsp;<span class="op" id="4007472">==</span>&nbsp;<span class="num" id="4007475">0</span>&nbsp;<span class="op" id="4007477">||</span>&nbsp;<span class="builtintype" id="4007480">int</span><span class="op" id="4007483">(</span><span class="ident" id="4007484">ckx</span><span class="op" id="4007487">.</span><span class="ident" id="4007488">ciphertext</span><span class="op" id="4007498">[</span><span class="num" id="4007499">0</span><span class="op" id="4007500">]</span><span class="op" id="4007501">)</span>&nbsp;<span class="op" id="4007503">!=</span>&nbsp;<span class="builtinfunc" id="4007506">len</span><span class="op" id="4007509">(</span><span class="ident" id="4007510">ckx</span><span class="op" id="4007513">.</span><span class="ident" id="4007514">ciphertext</span><span class="op" id="4007524">)</span><span class="op" id="4007525">-</span><span class="num" id="4007526">1</span>&nbsp;<span class="op" id="4007528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007532">return</span>&nbsp;<span class="ident" id="4007539">nil</span><span class="op" id="4007542">,</span>&nbsp;<span class="ident" id="4007544">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007569">x</span><span class="op" id="4007570">,</span>&nbsp;<span class="ident" id="4007572">y</span>&nbsp;<span class="op" id="4007574">:=</span>&nbsp;<span class="ident" id="4007577">elliptic</span><span class="op" id="4007585">.</span><span class="ident" id="4007586">Unmarshal</span><span class="op" id="4007595">(</span><span class="ident" id="4007596">ka</span><span class="op" id="4007598">.</span><span class="ident" id="4007599">curve</span><span class="op" id="4007604">,</span>&nbsp;<span class="ident" id="4007606">ckx</span><span class="op" id="4007609">.</span><span class="ident" id="4007610">ciphertext</span><span class="op" id="4007620">[</span><span class="num" id="4007621">1</span><span class="op" id="4007622">:</span><span class="op" id="4007623">]</span><span class="op" id="4007624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007627">if</span>&nbsp;<span class="ident" id="4007630">x</span>&nbsp;<span class="op" id="4007632">==</span>&nbsp;<span class="ident" id="4007635">nil</span>&nbsp;<span class="op" id="4007639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007643">return</span>&nbsp;<span class="ident" id="4007650">nil</span><span class="op" id="4007653">,</span>&nbsp;<span class="ident" id="4007655">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007677">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007680">if</span>&nbsp;<span class="op" id="4007683">!</span><span class="ident" id="4007684">ka</span><span class="op" id="4007686">.</span><span class="ident" id="4007687">curve</span><span class="op" id="4007692">.</span><span class="ident" id="4007693">IsOnCurve</span><span class="op" id="4007702">(</span><span class="ident" id="4007703">x</span><span class="op" id="4007704">,</span>&nbsp;<span class="ident" id="4007706">y</span><span class="op" id="4007707">)</span>&nbsp;<span class="op" id="4007709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007713">return</span>&nbsp;<span class="ident" id="4007720">nil</span><span class="op" id="4007723">,</span>&nbsp;<span class="ident" id="4007725">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007750">x</span><span class="op" id="4007751">,</span>&nbsp;<span class="ident" id="4007753">_</span>&nbsp;<span class="op" id="4007755">=</span>&nbsp;<span class="ident" id="4007757">ka</span><span class="op" id="4007759">.</span><span class="ident" id="4007760">curve</span><span class="op" id="4007765">.</span><span class="ident" id="4007766">ScalarMult</span><span class="op" id="4007776">(</span><span class="ident" id="4007777">x</span><span class="op" id="4007778">,</span>&nbsp;<span class="ident" id="4007780">y</span><span class="op" id="4007781">,</span>&nbsp;<span class="ident" id="4007783">ka</span><span class="op" id="4007785">.</span><span class="ident" id="4007786">privateKey</span><span class="op" id="4007796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007799">preMasterSecret</span>&nbsp;<span class="op" id="4007815">:=</span>&nbsp;<span class="builtinfunc" id="4007818">make</span><span class="op" id="4007822">(</span><span class="op" id="4007823">[</span><span class="op" id="4007824">]</span><span class="builtintype" id="4007825">byte</span><span class="op" id="4007829">,</span>&nbsp;<span class="op" id="4007831">(</span><span class="ident" id="4007832">ka</span><span class="op" id="4007834">.</span><span class="ident" id="4007835">curve</span><span class="op" id="4007840">.</span><span class="ident" id="4007841">Params</span><span class="op" id="4007847">(</span><span class="op" id="4007848">)</span><span class="op" id="4007849">.</span><span class="ident" id="4007850">BitSize</span><span class="op" id="4007857">+</span><span class="num" id="4007858">7</span><span class="op" id="4007859">)</span><span class="op" id="4007860">&gt;&gt;</span><span class="num" id="4007862">3</span><span class="op" id="4007863">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007866">xBytes</span>&nbsp;<span class="op" id="4007873">:=</span>&nbsp;<span class="ident" id="4007876">x</span><span class="op" id="4007877">.</span><span class="ident" id="4007878">Bytes</span><span class="op" id="4007883">(</span><span class="op" id="4007884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4007887">copy</span><span class="op" id="4007891">(</span><span class="ident" id="4007892">preMasterSecret</span><span class="op" id="4007907">[</span><span class="builtinfunc" id="4007908">len</span><span class="op" id="4007911">(</span><span class="ident" id="4007912">preMasterSecret</span><span class="op" id="4007927">)</span><span class="op" id="4007928">-</span><span class="builtinfunc" id="4007929">len</span><span class="op" id="4007932">(</span><span class="ident" id="4007933">xBytes</span><span class="op" id="4007939">)</span><span class="op" id="4007940">:</span><span class="op" id="4007941">]</span><span class="op" id="4007942">,</span>&nbsp;<span class="ident" id="4007944">xBytes</span><span class="op" id="4007950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007954">return</span>&nbsp;<span class="ident" id="4007961">preMasterSecret</span><span class="op" id="4007976">,</span>&nbsp;<span class="ident" id="4007978">nil</span><br>
<span class="lineno"></span><span class="op" id="4007982">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4007985">func</span>&nbsp;<span class="op" id="4007990">(</span><span class="ident" id="4007991">ka</span>&nbsp;<span class="op" id="4007994">*</span><span class="ident" id="4007995">ecdheKeyAgreement</span><span class="op" id="4008012">)</span>&nbsp;<span class="ident" id="4008014">processServerKeyExchange</span><span class="op" id="4008038">(</span><span class="ident" id="4008039">config</span>&nbsp;<span class="op" id="4008046">*</span><span class="ident" id="4008047">Config</span><span class="op" id="4008053">,</span>&nbsp;<span class="ident" id="4008055">clientHello</span>&nbsp;<span class="op" id="4008067">*</span><span class="ident" id="4008068">clientHelloMsg</span><span class="op" id="4008082">,</span>&nbsp;<span class="ident" id="4008084">serverHello</span>&nbsp;<span class="op" id="4008096">*</span><span class="ident" id="4008097">serverHelloMsg</span><span class="op" id="4008111">,</span>&nbsp;<span class="ident" id="4008113">cert</span>&nbsp;<span class="op" id="4008118">*</span><span class="ident" id="4008119">x509</span><span class="op" id="4008123">.</span><span class="ident" id="4008124">Certificate</span><span class="op" id="4008135">,</span>&nbsp;<span class="ident" id="4008137">skx</span>&nbsp;<span class="op" id="4008141">*</span><span class="ident" id="4008142">serverKeyExchangeMsg</span><span class="op" id="4008162">)</span>&nbsp;<span class="builtintype" id="4008164">error</span>&nbsp;<span class="op" id="4008170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008173">if</span>&nbsp;<span class="builtinfunc" id="4008176">len</span><span class="op" id="4008179">(</span><span class="ident" id="4008180">skx</span><span class="op" id="4008183">.</span><span class="ident" id="4008184">key</span><span class="op" id="4008187">)</span>&nbsp;<span class="op" id="4008189">&lt;</span>&nbsp;<span class="num" id="4008191">4</span>&nbsp;<span class="op" id="4008193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008197">return</span>&nbsp;<span class="ident" id="4008204">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008226">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008229">if</span>&nbsp;<span class="ident" id="4008232">skx</span><span class="op" id="4008235">.</span><span class="ident" id="4008236">key</span><span class="op" id="4008239">[</span><span class="num" id="4008240">0</span><span class="op" id="4008241">]</span>&nbsp;<span class="op" id="4008243">!=</span>&nbsp;<span class="num" id="4008246">3</span>&nbsp;<span class="op" id="4008248">{</span>&nbsp;<span class="comment" id="4008250">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008267">return</span>&nbsp;<span class="ident" id="4008274">errors</span><span class="op" id="4008280">.</span><span class="ident" id="4008281">New</span><span class="op" id="4008284">(</span><span class="string" id="4008285">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4008325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008331">curveid</span>&nbsp;<span class="op" id="4008339">:=</span>&nbsp;<span class="ident" id="4008342">CurveID</span><span class="op" id="4008349">(</span><span class="ident" id="4008350">skx</span><span class="op" id="4008353">.</span><span class="ident" id="4008354">key</span><span class="op" id="4008357">[</span><span class="num" id="4008358">1</span><span class="op" id="4008359">]</span><span class="op" id="4008360">)</span><span class="op" id="4008361">&lt;&lt;</span><span class="num" id="4008363">8</span>&nbsp;<span class="op" id="4008365">|</span>&nbsp;<span class="ident" id="4008367">CurveID</span><span class="op" id="4008374">(</span><span class="ident" id="4008375">skx</span><span class="op" id="4008378">.</span><span class="ident" id="4008379">key</span><span class="op" id="4008382">[</span><span class="num" id="4008383">2</span><span class="op" id="4008384">]</span><span class="op" id="4008385">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008389">var</span>&nbsp;<span class="ident" id="4008393">ok</span>&nbsp;<span class="builtintype" id="4008396">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008402">if</span>&nbsp;<span class="ident" id="4008405">ka</span><span class="op" id="4008407">.</span><span class="ident" id="4008408">curve</span><span class="op" id="4008413">,</span>&nbsp;<span class="ident" id="4008415">ok</span>&nbsp;<span class="op" id="4008418">=</span>&nbsp;<span class="ident" id="4008420">curveForCurveID</span><span class="op" id="4008435">(</span><span class="ident" id="4008436">curveid</span><span class="op" id="4008443">)</span><span class="op" id="4008444">;</span>&nbsp;<span class="op" id="4008446">!</span><span class="ident" id="4008447">ok</span>&nbsp;<span class="op" id="4008450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008454">return</span>&nbsp;<span class="ident" id="4008461">errors</span><span class="op" id="4008467">.</span><span class="ident" id="4008468">New</span><span class="op" id="4008471">(</span><span class="string" id="4008472">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4008512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008519">publicLen</span>&nbsp;<span class="op" id="4008529">:=</span>&nbsp;<span class="builtintype" id="4008532">int</span><span class="op" id="4008535">(</span><span class="ident" id="4008536">skx</span><span class="op" id="4008539">.</span><span class="ident" id="4008540">key</span><span class="op" id="4008543">[</span><span class="num" id="4008544">3</span><span class="op" id="4008545">]</span><span class="op" id="4008546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008549">if</span>&nbsp;<span class="ident" id="4008552">publicLen</span><span class="op" id="4008561">+</span><span class="num" id="4008562">4</span>&nbsp;<span class="op" id="4008564">&gt;</span>&nbsp;<span class="builtinfunc" id="4008566">len</span><span class="op" id="4008569">(</span><span class="ident" id="4008570">skx</span><span class="op" id="4008573">.</span><span class="ident" id="4008574">key</span><span class="op" id="4008577">)</span>&nbsp;<span class="op" id="4008579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008583">return</span>&nbsp;<span class="ident" id="4008590">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008615">ka</span><span class="op" id="4008617">.</span><span class="ident" id="4008618">x</span><span class="op" id="4008619">,</span>&nbsp;<span class="ident" id="4008621">ka</span><span class="op" id="4008623">.</span><span class="ident" id="4008624">y</span>&nbsp;<span class="op" id="4008626">=</span>&nbsp;<span class="ident" id="4008628">elliptic</span><span class="op" id="4008636">.</span><span class="ident" id="4008637">Unmarshal</span><span class="op" id="4008646">(</span><span class="ident" id="4008647">ka</span><span class="op" id="4008649">.</span><span class="ident" id="4008650">curve</span><span class="op" id="4008655">,</span>&nbsp;<span class="ident" id="4008657">skx</span><span class="op" id="4008660">.</span><span class="ident" id="4008661">key</span><span class="op" id="4008664">[</span><span class="num" id="4008665">4</span><span class="op" id="4008666">:</span><span class="num" id="4008667">4</span><span class="op" id="4008668">+</span><span class="ident" id="4008669">publicLen</span><span class="op" id="4008678">]</span><span class="op" id="4008679">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008682">if</span>&nbsp;<span class="ident" id="4008685">ka</span><span class="op" id="4008687">.</span><span class="ident" id="4008688">x</span>&nbsp;<span class="op" id="4008690">==</span>&nbsp;<span class="ident" id="4008693">nil</span>&nbsp;<span class="op" id="4008697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008701">return</span>&nbsp;<span class="ident" id="4008708">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008733">if</span>&nbsp;<span class="op" id="4008736">!</span><span class="ident" id="4008737">ka</span><span class="op" id="4008739">.</span><span class="ident" id="4008740">curve</span><span class="op" id="4008745">.</span><span class="ident" id="4008746">IsOnCurve</span><span class="op" id="4008755">(</span><span class="ident" id="4008756">ka</span><span class="op" id="4008758">.</span><span class="ident" id="4008759">x</span><span class="op" id="4008760">,</span>&nbsp;<span class="ident" id="4008762">ka</span><span class="op" id="4008764">.</span><span class="ident" id="4008765">y</span><span class="op" id="4008766">)</span>&nbsp;<span class="op" id="4008768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008772">return</span>&nbsp;<span class="ident" id="4008779">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008804">serverECDHParams</span>&nbsp;<span class="op" id="4008821">:=</span>&nbsp;<span class="ident" id="4008824">skx</span><span class="op" id="4008827">.</span><span class="ident" id="4008828">key</span><span class="op" id="4008831">[</span><span class="op" id="4008832">:</span><span class="num" id="4008833">4</span><span class="op" id="4008834">+</span><span class="ident" id="4008835">publicLen</span><span class="op" id="4008844">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008848">sig</span>&nbsp;<span class="op" id="4008852">:=</span>&nbsp;<span class="ident" id="4008855">skx</span><span class="op" id="4008858">.</span><span class="ident" id="4008859">key</span><span class="op" id="4008862">[</span><span class="num" id="4008863">4</span><span class="op" id="4008864">+</span><span class="ident" id="4008865">publicLen</span><span class="op" id="4008874">:</span><span class="op" id="4008875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008878">if</span>&nbsp;<span class="builtinfunc" id="4008881">len</span><span class="op" id="4008884">(</span><span class="ident" id="4008885">sig</span><span class="op" id="4008888">)</span>&nbsp;<span class="op" id="4008890">&lt;</span>&nbsp;<span class="num" id="4008892">2</span>&nbsp;<span class="op" id="4008894">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008898">return</span>&nbsp;<span class="ident" id="4008905">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008931">var</span>&nbsp;<span class="ident" id="4008935">tls12HashId</span>&nbsp;<span class="builtintype" id="4008947">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008954">if</span>&nbsp;<span class="ident" id="4008957">ka</span><span class="op" id="4008959">.</span><span class="ident" id="4008960">version</span>&nbsp;<span class="op" id="4008968">&gt;=</span>&nbsp;<span class="ident" id="4008971">VersionTLS12</span>&nbsp;<span class="op" id="4008984">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008988">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009026">var</span>&nbsp;<span class="ident" id="4009030">sigAndHash</span>&nbsp;<span class="op" id="4009041">[</span><span class="op" id="4009042">]</span><span class="builtintype" id="4009043">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009051">sigAndHash</span><span class="op" id="4009061">,</span>&nbsp;<span class="ident" id="4009063">sig</span>&nbsp;<span class="op" id="4009067">=</span>&nbsp;<span class="ident" id="4009069">sig</span><span class="op" id="4009072">[</span><span class="op" id="4009073">:</span><span class="num" id="4009074">2</span><span class="op" id="4009075">]</span><span class="op" id="4009076">,</span>&nbsp;<span class="ident" id="4009078">sig</span><span class="op" id="4009081">[</span><span class="num" id="4009082">2</span><span class="op" id="4009083">:</span><span class="op" id="4009084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009088">if</span>&nbsp;<span class="ident" id="4009091">sigAndHash</span><span class="op" id="4009101">[</span><span class="num" id="4009102">1</span><span class="op" id="4009103">]</span>&nbsp;<span class="op" id="4009105">!=</span>&nbsp;<span class="ident" id="4009108">ka</span><span class="op" id="4009110">.</span><span class="ident" id="4009111">sigType</span>&nbsp;<span class="op" id="4009119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009124">return</span>&nbsp;<span class="ident" id="4009131">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009158">tls12HashId</span>&nbsp;<span class="op" id="4009170">=</span>&nbsp;<span class="ident" id="4009172">sigAndHash</span><span class="op" id="4009182">[</span><span class="num" id="4009183">0</span><span class="op" id="4009184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009188">if</span>&nbsp;<span class="builtinfunc" id="4009191">len</span><span class="op" id="4009194">(</span><span class="ident" id="4009195">sig</span><span class="op" id="4009198">)</span>&nbsp;<span class="op" id="4009200">&lt;</span>&nbsp;<span class="num" id="4009202">2</span>&nbsp;<span class="op" id="4009204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009209">return</span>&nbsp;<span class="ident" id="4009216">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009239">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009245">sigLen</span>&nbsp;<span class="op" id="4009252">:=</span>&nbsp;<span class="builtintype" id="4009255">int</span><span class="op" id="4009258">(</span><span class="ident" id="4009259">sig</span><span class="op" id="4009262">[</span><span class="num" id="4009263">0</span><span class="op" id="4009264">]</span><span class="op" id="4009265">)</span><span class="op" id="4009266">&lt;&lt;</span><span class="num" id="4009268">8</span>&nbsp;<span class="op" id="4009270">|</span>&nbsp;<span class="builtintype" id="4009272">int</span><span class="op" id="4009275">(</span><span class="ident" id="4009276">sig</span><span class="op" id="4009279">[</span><span class="num" id="4009280">1</span><span class="op" id="4009281">]</span><span class="op" id="4009282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009285">if</span>&nbsp;<span class="ident" id="4009288">sigLen</span><span class="op" id="4009294">+</span><span class="num" id="4009295">2</span>&nbsp;<span class="op" id="4009297">!=</span>&nbsp;<span class="builtinfunc" id="4009300">len</span><span class="op" id="4009303">(</span><span class="ident" id="4009304">sig</span><span class="op" id="4009307">)</span>&nbsp;<span class="op" id="4009309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009313">return</span>&nbsp;<span class="ident" id="4009320">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009342">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009345">sig</span>&nbsp;<span class="op" id="4009349">=</span>&nbsp;<span class="ident" id="4009351">sig</span><span class="op" id="4009354">[</span><span class="num" id="4009355">2</span><span class="op" id="4009356">:</span><span class="op" id="4009357">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009361">digest</span><span class="op" id="4009367">,</span>&nbsp;<span class="ident" id="4009369">hashFunc</span><span class="op" id="4009377">,</span>&nbsp;<span class="ident" id="4009379">err</span>&nbsp;<span class="op" id="4009383">:=</span>&nbsp;<span class="ident" id="4009386">hashForServerKeyExchange</span><span class="op" id="4009410">(</span><span class="ident" id="4009411">ka</span><span class="op" id="4009413">.</span><span class="ident" id="4009414">sigType</span><span class="op" id="4009421">,</span>&nbsp;<span class="ident" id="4009423">tls12HashId</span><span class="op" id="4009434">,</span>&nbsp;<span class="ident" id="4009436">ka</span><span class="op" id="4009438">.</span><span class="ident" id="4009439">version</span><span class="op" id="4009446">,</span>&nbsp;<span class="ident" id="4009448">clientHello</span><span class="op" id="4009459">.</span><span class="ident" id="4009460">random</span><span class="op" id="4009466">,</span>&nbsp;<span class="ident" id="4009468">serverHello</span><span class="op" id="4009479">.</span><span class="ident" id="4009480">random</span><span class="op" id="4009486">,</span>&nbsp;<span class="ident" id="4009488">serverECDHParams</span><span class="op" id="4009504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009507">if</span>&nbsp;<span class="ident" id="4009510">err</span>&nbsp;<span class="op" id="4009514">!=</span>&nbsp;<span class="ident" id="4009517">nil</span>&nbsp;<span class="op" id="4009521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009525">return</span>&nbsp;<span class="ident" id="4009532">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009540">switch</span>&nbsp;<span class="ident" id="4009547">ka</span><span class="op" id="4009549">.</span><span class="ident" id="4009550">sigType</span>&nbsp;<span class="op" id="4009558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009561">case</span>&nbsp;<span class="ident" id="4009566">signatureECDSA</span><span class="op" id="4009580">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009584">pubKey</span><span class="op" id="4009590">,</span>&nbsp;<span class="ident" id="4009592">ok</span>&nbsp;<span class="op" id="4009595">:=</span>&nbsp;<span class="ident" id="4009598">cert</span><span class="op" id="4009602">.</span><span class="ident" id="4009603">PublicKey</span><span class="op" id="4009612">.</span><span class="op" id="4009613">(</span><span class="op" id="4009614">*</span><span class="ident" id="4009615">ecdsa</span><span class="op" id="4009620">.</span><span class="ident" id="4009621">PublicKey</span><span class="op" id="4009630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009634">if</span>&nbsp;<span class="op" id="4009637">!</span><span class="ident" id="4009638">ok</span>&nbsp;<span class="op" id="4009641">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009646">return</span>&nbsp;<span class="ident" id="4009653">errors</span><span class="op" id="4009659">.</span><span class="ident" id="4009660">New</span><span class="op" id="4009663">(</span><span class="string" id="4009664">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4009712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009720">ecdsaSig</span>&nbsp;<span class="op" id="4009729">:=</span>&nbsp;<span class="builtinfunc" id="4009732">new</span><span class="op" id="4009735">(</span><span class="ident" id="4009736">ecdsaSignature</span><span class="op" id="4009750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009754">if</span>&nbsp;<span class="ident" id="4009757">_</span><span class="op" id="4009758">,</span>&nbsp;<span class="ident" id="4009760">err</span>&nbsp;<span class="op" id="4009764">:=</span>&nbsp;<span class="ident" id="4009767">asn1</span><span class="op" id="4009771">.</span><span class="ident" id="4009772">Unmarshal</span><span class="op" id="4009781">(</span><span class="ident" id="4009782">sig</span><span class="op" id="4009785">,</span>&nbsp;<span class="ident" id="4009787">ecdsaSig</span><span class="op" id="4009795">)</span><span class="op" id="4009796">;</span>&nbsp;<span class="ident" id="4009798">err</span>&nbsp;<span class="op" id="4009802">!=</span>&nbsp;<span class="ident" id="4009805">nil</span>&nbsp;<span class="op" id="4009809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009814">return</span>&nbsp;<span class="ident" id="4009821">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009831">if</span>&nbsp;<span class="ident" id="4009834">ecdsaSig</span><span class="op" id="4009842">.</span><span class="ident" id="4009843">R</span><span class="op" id="4009844">.</span><span class="ident" id="4009845">Sign</span><span class="op" id="4009849">(</span><span class="op" id="4009850">)</span>&nbsp;<span class="op" id="4009852">&lt;=</span>&nbsp;<span class="num" id="4009855">0</span>&nbsp;<span class="op" id="4009857">||</span>&nbsp;<span class="ident" id="4009860">ecdsaSig</span><span class="op" id="4009868">.</span><span class="ident" id="4009869">S</span><span class="op" id="4009870">.</span><span class="ident" id="4009871">Sign</span><span class="op" id="4009875">(</span><span class="op" id="4009876">)</span>&nbsp;<span class="op" id="4009878">&lt;=</span>&nbsp;<span class="num" id="4009881">0</span>&nbsp;<span class="op" id="4009883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009888">return</span>&nbsp;<span class="ident" id="4009895">errors</span><span class="op" id="4009901">.</span><span class="ident" id="4009902">New</span><span class="op" id="4009905">(</span><span class="string" id="4009906">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4009957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009965">if</span>&nbsp;<span class="op" id="4009968">!</span><span class="ident" id="4009969">ecdsa</span><span class="op" id="4009974">.</span><span class="ident" id="4009975">Verify</span><span class="op" id="4009981">(</span><span class="ident" id="4009982">pubKey</span><span class="op" id="4009988">,</span>&nbsp;<span class="ident" id="4009990">digest</span><span class="op" id="4009996">,</span>&nbsp;<span class="ident" id="4009998">ecdsaSig</span><span class="op" id="4010006">.</span><span class="ident" id="4010007">R</span><span class="op" id="4010008">,</span>&nbsp;<span class="ident" id="4010010">ecdsaSig</span><span class="op" id="4010018">.</span><span class="ident" id="4010019">S</span><span class="op" id="4010020">)</span>&nbsp;<span class="op" id="4010022">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010027">return</span>&nbsp;<span class="ident" id="4010034">errors</span><span class="op" id="4010040">.</span><span class="ident" id="4010041">New</span><span class="op" id="4010044">(</span><span class="string" id="4010045">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4010073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010080">case</span>&nbsp;<span class="ident" id="4010085">signatureRSA</span><span class="op" id="4010097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010101">pubKey</span><span class="op" id="4010107">,</span>&nbsp;<span class="ident" id="4010109">ok</span>&nbsp;<span class="op" id="4010112">:=</span>&nbsp;<span class="ident" id="4010115">cert</span><span class="op" id="4010119">.</span><span class="ident" id="4010120">PublicKey</span><span class="op" id="4010129">.</span><span class="op" id="4010130">(</span><span class="op" id="4010131">*</span><span class="ident" id="4010132">rsa</span><span class="op" id="4010135">.</span><span class="ident" id="4010136">PublicKey</span><span class="op" id="4010145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010149">if</span>&nbsp;<span class="op" id="4010152">!</span><span class="ident" id="4010153">ok</span>&nbsp;<span class="op" id="4010156">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010161">return</span>&nbsp;<span class="ident" id="4010168">errors</span><span class="op" id="4010174">.</span><span class="ident" id="4010175">New</span><span class="op" id="4010178">(</span><span class="string" id="4010179">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4010223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010231">if</span>&nbsp;<span class="ident" id="4010234">err</span>&nbsp;<span class="op" id="4010238">:=</span>&nbsp;<span class="ident" id="4010241">rsa</span><span class="op" id="4010244">.</span><span class="ident" id="4010245">VerifyPKCS1v15</span><span class="op" id="4010259">(</span><span class="ident" id="4010260">pubKey</span><span class="op" id="4010266">,</span>&nbsp;<span class="ident" id="4010268">hashFunc</span><span class="op" id="4010276">,</span>&nbsp;<span class="ident" id="4010278">digest</span><span class="op" id="4010284">,</span>&nbsp;<span class="ident" id="4010286">sig</span><span class="op" id="4010289">)</span><span class="op" id="4010290">;</span>&nbsp;<span class="ident" id="4010292">err</span>&nbsp;<span class="op" id="4010296">!=</span>&nbsp;<span class="ident" id="4010299">nil</span>&nbsp;<span class="op" id="4010303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010308">return</span>&nbsp;<span class="ident" id="4010315">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010321">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010324">default</span><span class="op" id="4010331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010335">return</span>&nbsp;<span class="ident" id="4010342">errors</span><span class="op" id="4010348">.</span><span class="ident" id="4010349">New</span><span class="op" id="4010352">(</span><span class="string" id="4010353">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4010388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010395">return</span>&nbsp;<span class="ident" id="4010402">nil</span><br>
<span class="lineno">390</span><span class="op" id="4010406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4010409">func</span>&nbsp;<span class="op" id="4010414">(</span><span class="ident" id="4010415">ka</span>&nbsp;<span class="op" id="4010418">*</span><span class="ident" id="4010419">ecdheKeyAgreement</span><span class="op" id="4010436">)</span>&nbsp;<span class="ident" id="4010438">generateClientKeyExchange</span><span class="op" id="4010463">(</span><span class="ident" id="4010464">config</span>&nbsp;<span class="op" id="4010471">*</span><span class="ident" id="4010472">Config</span><span class="op" id="4010478">,</span>&nbsp;<span class="ident" id="4010480">clientHello</span>&nbsp;<span class="op" id="4010492">*</span><span class="ident" id="4010493">clientHelloMsg</span><span class="op" id="4010507">,</span>&nbsp;<span class="ident" id="4010509">cert</span>&nbsp;<span class="op" id="4010514">*</span><span class="ident" id="4010515">x509</span><span class="op" id="4010519">.</span><span class="ident" id="4010520">Certificate</span><span class="op" id="4010531">)</span>&nbsp;<span class="op" id="4010533">(</span><span class="op" id="4010534">[</span><span class="op" id="4010535">]</span><span class="builtintype" id="4010536">byte</span><span class="op" id="4010540">,</span>&nbsp;<span class="op" id="4010542">*</span><span class="ident" id="4010543">clientKeyExchangeMsg</span><span class="op" id="4010563">,</span>&nbsp;<span class="builtintype" id="4010565">error</span><span class="op" id="4010570">)</span>&nbsp;<span class="op" id="4010572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010575">if</span>&nbsp;<span class="ident" id="4010578">ka</span><span class="op" id="4010580">.</span><span class="ident" id="4010581">curve</span>&nbsp;<span class="op" id="4010587">==</span>&nbsp;<span class="ident" id="4010590">nil</span>&nbsp;<span class="op" id="4010594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010598">return</span>&nbsp;<span class="ident" id="4010605">nil</span><span class="op" id="4010608">,</span>&nbsp;<span class="ident" id="4010610">nil</span><span class="op" id="4010613">,</span>&nbsp;<span class="ident" id="4010615">errors</span><span class="op" id="4010621">.</span><span class="ident" id="4010622">New</span><span class="op" id="4010625">(</span><span class="string" id="4010626">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4010661">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010667">priv</span><span class="op" id="4010671">,</span>&nbsp;<span class="ident" id="4010673">mx</span><span class="op" id="4010675">,</span>&nbsp;<span class="ident" id="4010677">my</span><span class="op" id="4010679">,</span>&nbsp;<span class="ident" id="4010681">err</span>&nbsp;<span class="op" id="4010685">:=</span>&nbsp;<span class="ident" id="4010688">elliptic</span><span class="op" id="4010696">.</span><span class="ident" id="4010697">GenerateKey</span><span class="op" id="4010708">(</span><span class="ident" id="4010709">ka</span><span class="op" id="4010711">.</span><span class="ident" id="4010712">curve</span><span class="op" id="4010717">,</span>&nbsp;<span class="ident" id="4010719">config</span><span class="op" id="4010725">.</span><span class="ident" id="4010726">rand</span><span class="op" id="4010730">(</span><span class="op" id="4010731">)</span><span class="op" id="4010732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010735">if</span>&nbsp;<span class="ident" id="4010738">err</span>&nbsp;<span class="op" id="4010742">!=</span>&nbsp;<span class="ident" id="4010745">nil</span>&nbsp;<span class="op" id="4010749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010753">return</span>&nbsp;<span class="ident" id="4010760">nil</span><span class="op" id="4010763">,</span>&nbsp;<span class="ident" id="4010765">nil</span><span class="op" id="4010768">,</span>&nbsp;<span class="ident" id="4010770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010775">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010778">x</span><span class="op" id="4010779">,</span>&nbsp;<span class="ident" id="4010781">_</span>&nbsp;<span class="op" id="4010783">:=</span>&nbsp;<span class="ident" id="4010786">ka</span><span class="op" id="4010788">.</span><span class="ident" id="4010789">curve</span><span class="op" id="4010794">.</span><span class="ident" id="4010795">ScalarMult</span><span class="op" id="4010805">(</span><span class="ident" id="4010806">ka</span><span class="op" id="4010808">.</span><span class="ident" id="4010809">x</span><span class="op" id="4010810">,</span>&nbsp;<span class="ident" id="4010812">ka</span><span class="op" id="4010814">.</span><span class="ident" id="4010815">y</span><span class="op" id="4010816">,</span>&nbsp;<span class="ident" id="4010818">priv</span><span class="op" id="4010822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010825">preMasterSecret</span>&nbsp;<span class="op" id="4010841">:=</span>&nbsp;<span class="builtinfunc" id="4010844">make</span><span class="op" id="4010848">(</span><span class="op" id="4010849">[</span><span class="op" id="4010850">]</span><span class="builtintype" id="4010851">byte</span><span class="op" id="4010855">,</span>&nbsp;<span class="op" id="4010857">(</span><span class="ident" id="4010858">ka</span><span class="op" id="4010860">.</span><span class="ident" id="4010861">curve</span><span class="op" id="4010866">.</span><span class="ident" id="4010867">Params</span><span class="op" id="4010873">(</span><span class="op" id="4010874">)</span><span class="op" id="4010875">.</span><span class="ident" id="4010876">BitSize</span><span class="op" id="4010883">+</span><span class="num" id="4010884">7</span><span class="op" id="4010885">)</span><span class="op" id="4010886">&gt;&gt;</span><span class="num" id="4010888">3</span><span class="op" id="4010889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010892">xBytes</span>&nbsp;<span class="op" id="4010899">:=</span>&nbsp;<span class="ident" id="4010902">x</span><span class="op" id="4010903">.</span><span class="ident" id="4010904">Bytes</span><span class="op" id="4010909">(</span><span class="op" id="4010910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4010913">copy</span><span class="op" id="4010917">(</span><span class="ident" id="4010918">preMasterSecret</span><span class="op" id="4010933">[</span><span class="builtinfunc" id="4010934">len</span><span class="op" id="4010937">(</span><span class="ident" id="4010938">preMasterSecret</span><span class="op" id="4010953">)</span><span class="op" id="4010954">-</span><span class="builtinfunc" id="4010955">len</span><span class="op" id="4010958">(</span><span class="ident" id="4010959">xBytes</span><span class="op" id="4010965">)</span><span class="op" id="4010966">:</span><span class="op" id="4010967">]</span><span class="op" id="4010968">,</span>&nbsp;<span class="ident" id="4010970">xBytes</span><span class="op" id="4010976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010980">serialized</span>&nbsp;<span class="op" id="4010991">:=</span>&nbsp;<span class="ident" id="4010994">elliptic</span><span class="op" id="4011002">.</span><span class="ident" id="4011003">Marshal</span><span class="op" id="4011010">(</span><span class="ident" id="4011011">ka</span><span class="op" id="4011013">.</span><span class="ident" id="4011014">curve</span><span class="op" id="4011019">,</span>&nbsp;<span class="ident" id="4011021">mx</span><span class="op" id="4011023">,</span>&nbsp;<span class="ident" id="4011025">my</span><span class="op" id="4011027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011031">ckx</span>&nbsp;<span class="op" id="4011035">:=</span>&nbsp;<span class="builtinfunc" id="4011038">new</span><span class="op" id="4011041">(</span><span class="ident" id="4011042">clientKeyExchangeMsg</span><span class="op" id="4011062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011065">ckx</span><span class="op" id="4011068">.</span><span class="ident" id="4011069">ciphertext</span>&nbsp;<span class="op" id="4011080">=</span>&nbsp;<span class="builtinfunc" id="4011082">make</span><span class="op" id="4011086">(</span><span class="op" id="4011087">[</span><span class="op" id="4011088">]</span><span class="builtintype" id="4011089">byte</span><span class="op" id="4011093">,</span>&nbsp;<span class="num" id="4011095">1</span><span class="op" id="4011096">+</span><span class="builtinfunc" id="4011097">len</span><span class="op" id="4011100">(</span><span class="ident" id="4011101">serialized</span><span class="op" id="4011111">)</span><span class="op" id="4011112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011115">ckx</span><span class="op" id="4011118">.</span><span class="ident" id="4011119">ciphertext</span><span class="op" id="4011129">[</span><span class="num" id="4011130">0</span><span class="op" id="4011131">]</span>&nbsp;<span class="op" id="4011133">=</span>&nbsp;<span class="builtintype" id="4011135">byte</span><span class="op" id="4011139">(</span><span class="builtinfunc" id="4011140">len</span><span class="op" id="4011143">(</span><span class="ident" id="4011144">serialized</span><span class="op" id="4011154">)</span><span class="op" id="4011155">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4011158">copy</span><span class="op" id="4011162">(</span><span class="ident" id="4011163">ckx</span><span class="op" id="4011166">.</span><span class="ident" id="4011167">ciphertext</span><span class="op" id="4011177">[</span><span class="num" id="4011178">1</span><span class="op" id="4011179">:</span><span class="op" id="4011180">]</span><span class="op" id="4011181">,</span>&nbsp;<span class="ident" id="4011183">serialized</span><span class="op" id="4011193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011197">return</span>&nbsp;<span class="ident" id="4011204">preMasterSecret</span><span class="op" id="4011219">,</span>&nbsp;<span class="ident" id="4011221">ckx</span><span class="op" id="4011224">,</span>&nbsp;<span class="ident" id="4011226">nil</span><br>
<span class="lineno"></span><span class="op" id="4011230">}</span>
</div>
</body>
</html>
