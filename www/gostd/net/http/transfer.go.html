<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4890921">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4890976">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4891030">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4891081">package</span>&nbsp;<span class="ident" id="4891089">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4891095">import</span>&nbsp;<span class="op" id="4891102">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891105">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891114">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891123">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891133">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891140">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891146">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891159">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891180">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891197">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891205">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891216">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4891227">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4891234">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4891237">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="4891307">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4891343">var</span>&nbsp;<span class="ident" id="4891347">ErrLineTooLong</span>&nbsp;<span class="op" id="4891362">=</span>&nbsp;<span class="ident" id="4891364">internal</span><span class="op" id="4891372">.</span><span class="ident" id="4891373">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4891389">type</span>&nbsp;<span class="ident" id="4891394">errorReader</span>&nbsp;<span class="keyword" id="4891406">struct</span>&nbsp;<span class="op" id="4891413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891416">err</span>&nbsp;<span class="builtintype" id="4891420">error</span><br>
<span class="lineno"></span><span class="op" id="4891426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="4891429">func</span>&nbsp;<span class="op" id="4891434">(</span><span class="ident" id="4891435">r</span>&nbsp;<span class="op" id="4891437">*</span><span class="ident" id="4891438">errorReader</span><span class="op" id="4891449">)</span>&nbsp;<span class="ident" id="4891451">Read</span><span class="op" id="4891455">(</span><span class="ident" id="4891456">p</span>&nbsp;<span class="op" id="4891458">[</span><span class="op" id="4891459">]</span><span class="builtintype" id="4891460">byte</span><span class="op" id="4891464">)</span>&nbsp;<span class="op" id="4891466">(</span><span class="ident" id="4891467">n</span>&nbsp;<span class="builtintype" id="4891469">int</span><span class="op" id="4891472">,</span>&nbsp;<span class="ident" id="4891474">err</span>&nbsp;<span class="builtintype" id="4891478">error</span><span class="op" id="4891483">)</span>&nbsp;<span class="op" id="4891485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4891488">return</span>&nbsp;<span class="num" id="4891495">0</span><span class="op" id="4891496">,</span>&nbsp;<span class="ident" id="4891498">r</span><span class="op" id="4891499">.</span><span class="ident" id="4891500">err</span><br>
<span class="lineno"></span><span class="op" id="4891504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4891507">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="4891585">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4891661">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="4891728">type</span>&nbsp;<span class="ident" id="4891733">transferWriter</span>&nbsp;<span class="keyword" id="4891748">struct</span>&nbsp;<span class="op" id="4891755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891758">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4891775">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891783">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4891800">io</span><span class="op" id="4891802">.</span><span class="ident" id="4891803">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891811">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4891828">io</span><span class="op" id="4891830">.</span><span class="ident" id="4891831">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891839">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4891856">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891862">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4891879">int64</span>&nbsp;<span class="comment" id="4891885">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891928">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4891945">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891951">TransferEncoding</span>&nbsp;<span class="op" id="4891968">[</span><span class="op" id="4891969">]</span><span class="builtintype" id="4891970">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4891978">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4891995">Header</span><br>
<span class="lineno"></span><span class="op" id="4892002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4892005">func</span>&nbsp;<span class="ident" id="4892010">newTransferWriter</span><span class="op" id="4892027">(</span><span class="ident" id="4892028">r</span>&nbsp;<span class="keyword" id="4892030">interface</span><span class="op" id="4892039">{</span><span class="op" id="4892040">}</span><span class="op" id="4892041">)</span>&nbsp;<span class="op" id="4892043">(</span><span class="ident" id="4892044">t</span>&nbsp;<span class="op" id="4892046">*</span><span class="ident" id="4892047">transferWriter</span><span class="op" id="4892061">,</span>&nbsp;<span class="ident" id="4892063">err</span>&nbsp;<span class="builtintype" id="4892067">error</span><span class="op" id="4892072">)</span>&nbsp;<span class="op" id="4892074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892077">t</span>&nbsp;<span class="op" id="4892079">=</span>&nbsp;<span class="op" id="4892081">&amp;</span><span class="ident" id="4892082">transferWriter</span><span class="op" id="4892096">{</span><span class="op" id="4892097">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892101">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892129">atLeastHTTP11</span>&nbsp;<span class="op" id="4892143">:=</span>&nbsp;<span class="builtintype" id="4892146">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892153">switch</span>&nbsp;<span class="ident" id="4892160">rr</span>&nbsp;<span class="op" id="4892163">:=</span>&nbsp;<span class="ident" id="4892166">r</span><span class="op" id="4892167">.</span><span class="op" id="4892168">(</span><span class="keyword" id="4892169">type</span><span class="op" id="4892173">)</span>&nbsp;<span class="op" id="4892175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892178">case</span>&nbsp;<span class="op" id="4892183">*</span><span class="ident" id="4892184">Request</span><span class="op" id="4892191">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892195">if</span>&nbsp;<span class="ident" id="4892198">rr</span><span class="op" id="4892200">.</span><span class="ident" id="4892201">ContentLength</span>&nbsp;<span class="op" id="4892215">!=</span>&nbsp;<span class="num" id="4892218">0</span>&nbsp;<span class="op" id="4892220">&amp;&amp;</span>&nbsp;<span class="ident" id="4892223">rr</span><span class="op" id="4892225">.</span><span class="ident" id="4892226">Body</span>&nbsp;<span class="op" id="4892231">==</span>&nbsp;<span class="ident" id="4892234">nil</span>&nbsp;<span class="op" id="4892238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892243">return</span>&nbsp;<span class="ident" id="4892250">nil</span><span class="op" id="4892253">,</span>&nbsp;<span class="ident" id="4892255">fmt</span><span class="op" id="4892258">.</span><span class="ident" id="4892259">Errorf</span><span class="op" id="4892265">(</span><span class="string" id="4892266">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="4892312">,</span>&nbsp;<span class="ident" id="4892314">rr</span><span class="op" id="4892316">.</span><span class="ident" id="4892317">ContentLength</span><span class="op" id="4892330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4892334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892338">t</span><span class="op" id="4892339">.</span><span class="ident" id="4892340">Method</span>&nbsp;<span class="op" id="4892347">=</span>&nbsp;<span class="ident" id="4892349">rr</span><span class="op" id="4892351">.</span><span class="ident" id="4892352">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892361">t</span><span class="op" id="4892362">.</span><span class="ident" id="4892363">Body</span>&nbsp;<span class="op" id="4892368">=</span>&nbsp;<span class="ident" id="4892370">rr</span><span class="op" id="4892372">.</span><span class="ident" id="4892373">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892380">t</span><span class="op" id="4892381">.</span><span class="ident" id="4892382">BodyCloser</span>&nbsp;<span class="op" id="4892393">=</span>&nbsp;<span class="ident" id="4892395">rr</span><span class="op" id="4892397">.</span><span class="ident" id="4892398">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892405">t</span><span class="op" id="4892406">.</span><span class="ident" id="4892407">ContentLength</span>&nbsp;<span class="op" id="4892421">=</span>&nbsp;<span class="ident" id="4892423">rr</span><span class="op" id="4892425">.</span><span class="ident" id="4892426">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892442">t</span><span class="op" id="4892443">.</span><span class="ident" id="4892444">Close</span>&nbsp;<span class="op" id="4892450">=</span>&nbsp;<span class="ident" id="4892452">rr</span><span class="op" id="4892454">.</span><span class="ident" id="4892455">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892463">t</span><span class="op" id="4892464">.</span><span class="ident" id="4892465">TransferEncoding</span>&nbsp;<span class="op" id="4892482">=</span>&nbsp;<span class="ident" id="4892484">rr</span><span class="op" id="4892486">.</span><span class="ident" id="4892487">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892506">t</span><span class="op" id="4892507">.</span><span class="ident" id="4892508">Trailer</span>&nbsp;<span class="op" id="4892516">=</span>&nbsp;<span class="ident" id="4892518">rr</span><span class="op" id="4892520">.</span><span class="ident" id="4892521">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892531">atLeastHTTP11</span>&nbsp;<span class="op" id="4892545">=</span>&nbsp;<span class="ident" id="4892547">rr</span><span class="op" id="4892549">.</span><span class="ident" id="4892550">ProtoAtLeast</span><span class="op" id="4892562">(</span><span class="num" id="4892563">1</span><span class="op" id="4892564">,</span>&nbsp;<span class="num" id="4892566">1</span><span class="op" id="4892567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892571">if</span>&nbsp;<span class="ident" id="4892574">t</span><span class="op" id="4892575">.</span><span class="ident" id="4892576">Body</span>&nbsp;<span class="op" id="4892581">!=</span>&nbsp;<span class="ident" id="4892584">nil</span>&nbsp;<span class="op" id="4892588">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4892591">len</span><span class="op" id="4892594">(</span><span class="ident" id="4892595">t</span><span class="op" id="4892596">.</span><span class="ident" id="4892597">TransferEncoding</span><span class="op" id="4892613">)</span>&nbsp;<span class="op" id="4892615">==</span>&nbsp;<span class="num" id="4892618">0</span>&nbsp;<span class="op" id="4892620">&amp;&amp;</span>&nbsp;<span class="ident" id="4892623">atLeastHTTP11</span>&nbsp;<span class="op" id="4892637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892642">if</span>&nbsp;<span class="ident" id="4892645">t</span><span class="op" id="4892646">.</span><span class="ident" id="4892647">ContentLength</span>&nbsp;<span class="op" id="4892661">==</span>&nbsp;<span class="num" id="4892664">0</span>&nbsp;<span class="op" id="4892666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892672">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892728">var</span>&nbsp;<span class="ident" id="4892732">buf</span>&nbsp;<span class="op" id="4892736">[</span><span class="num" id="4892737">1</span><span class="op" id="4892738">]</span><span class="builtintype" id="4892739">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892748">n</span><span class="op" id="4892749">,</span>&nbsp;<span class="ident" id="4892751">rerr</span>&nbsp;<span class="op" id="4892756">:=</span>&nbsp;<span class="ident" id="4892759">io</span><span class="op" id="4892761">.</span><span class="ident" id="4892762">ReadFull</span><span class="op" id="4892770">(</span><span class="ident" id="4892771">t</span><span class="op" id="4892772">.</span><span class="ident" id="4892773">Body</span><span class="op" id="4892777">,</span>&nbsp;<span class="ident" id="4892779">buf</span><span class="op" id="4892782">[</span><span class="op" id="4892783">:</span><span class="op" id="4892784">]</span><span class="op" id="4892785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4892791">if</span>&nbsp;<span class="ident" id="4892794">rerr</span>&nbsp;<span class="op" id="4892799">!=</span>&nbsp;<span class="ident" id="4892802">nil</span>&nbsp;<span class="op" id="4892806">&amp;&amp;</span>&nbsp;<span class="ident" id="4892809">rerr</span>&nbsp;<span class="op" id="4892814">!=</span>&nbsp;<span class="ident" id="4892817">io</span><span class="op" id="4892819">.</span><span class="ident" id="4892820">EOF</span>&nbsp;<span class="op" id="4892824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892831">t</span><span class="op" id="4892832">.</span><span class="ident" id="4892833">ContentLength</span>&nbsp;<span class="op" id="4892847">=</span>&nbsp;<span class="op" id="4892849">-</span><span class="num" id="4892850">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4892857">t</span><span class="op" id="4892858">.</span><span class="ident" id="4892859">Body</span>&nbsp;<span class="op" id="4892864">=</span>&nbsp;<span class="op" id="4892866">&amp;</span><span class="ident" id="4892867">errorReader</span><span class="op" id="4892878">{</span><span class="ident" id="4892879">rerr</span><span class="op" id="4892883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4892889">}</span>&nbsp;<span class="keyword" id="4892891">else</span>&nbsp;<span class="keyword" id="4892896">if</span>&nbsp;<span class="ident" id="4892899">n</span>&nbsp;<span class="op" id="4892901">==</span>&nbsp;<span class="num" id="4892904">1</span>&nbsp;<span class="op" id="4892906">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892913">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4892976">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4893025">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4893086">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893109">t</span><span class="op" id="4893110">.</span><span class="ident" id="4893111">ContentLength</span>&nbsp;<span class="op" id="4893125">=</span>&nbsp;<span class="op" id="4893127">-</span><span class="num" id="4893128">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893135">t</span><span class="op" id="4893136">.</span><span class="ident" id="4893137">Body</span>&nbsp;<span class="op" id="4893142">=</span>&nbsp;<span class="ident" id="4893144">io</span><span class="op" id="4893146">.</span><span class="ident" id="4893147">MultiReader</span><span class="op" id="4893158">(</span><span class="ident" id="4893159">bytes</span><span class="op" id="4893164">.</span><span class="ident" id="4893165">NewReader</span><span class="op" id="4893174">(</span><span class="ident" id="4893175">buf</span><span class="op" id="4893178">[</span><span class="op" id="4893179">:</span><span class="op" id="4893180">]</span><span class="op" id="4893181">)</span><span class="op" id="4893182">,</span>&nbsp;<span class="ident" id="4893184">t</span><span class="op" id="4893185">.</span><span class="ident" id="4893186">Body</span><span class="op" id="4893190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893196">}</span>&nbsp;<span class="keyword" id="4893198">else</span>&nbsp;<span class="op" id="4893203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4893210">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893242">t</span><span class="op" id="4893243">.</span><span class="ident" id="4893244">Body</span>&nbsp;<span class="op" id="4893249">=</span>&nbsp;<span class="ident" id="4893251">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893260">t</span><span class="op" id="4893261">.</span><span class="ident" id="4893262">BodyCloser</span>&nbsp;<span class="op" id="4893273">=</span>&nbsp;<span class="ident" id="4893275">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893293">if</span>&nbsp;<span class="ident" id="4893296">t</span><span class="op" id="4893297">.</span><span class="ident" id="4893298">ContentLength</span>&nbsp;<span class="op" id="4893312">&lt;</span>&nbsp;<span class="num" id="4893314">0</span>&nbsp;<span class="op" id="4893316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893322">t</span><span class="op" id="4893323">.</span><span class="ident" id="4893324">TransferEncoding</span>&nbsp;<span class="op" id="4893341">=</span>&nbsp;<span class="op" id="4893343">[</span><span class="op" id="4893344">]</span><span class="builtintype" id="4893345">string</span><span class="op" id="4893351">{</span><span class="string" id="4893352">&#34;chunked&#34;</span><span class="op" id="4893361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893366">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893373">case</span>&nbsp;<span class="op" id="4893378">*</span><span class="ident" id="4893379">Response</span><span class="op" id="4893387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893391">if</span>&nbsp;<span class="ident" id="4893394">rr</span><span class="op" id="4893396">.</span><span class="ident" id="4893397">Request</span>&nbsp;<span class="op" id="4893405">!=</span>&nbsp;<span class="ident" id="4893408">nil</span>&nbsp;<span class="op" id="4893412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893417">t</span><span class="op" id="4893418">.</span><span class="ident" id="4893419">Method</span>&nbsp;<span class="op" id="4893426">=</span>&nbsp;<span class="ident" id="4893428">rr</span><span class="op" id="4893430">.</span><span class="ident" id="4893431">Request</span><span class="op" id="4893438">.</span><span class="ident" id="4893439">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893448">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893452">t</span><span class="op" id="4893453">.</span><span class="ident" id="4893454">Body</span>&nbsp;<span class="op" id="4893459">=</span>&nbsp;<span class="ident" id="4893461">rr</span><span class="op" id="4893463">.</span><span class="ident" id="4893464">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893471">t</span><span class="op" id="4893472">.</span><span class="ident" id="4893473">BodyCloser</span>&nbsp;<span class="op" id="4893484">=</span>&nbsp;<span class="ident" id="4893486">rr</span><span class="op" id="4893488">.</span><span class="ident" id="4893489">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893496">t</span><span class="op" id="4893497">.</span><span class="ident" id="4893498">ContentLength</span>&nbsp;<span class="op" id="4893512">=</span>&nbsp;<span class="ident" id="4893514">rr</span><span class="op" id="4893516">.</span><span class="ident" id="4893517">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893533">t</span><span class="op" id="4893534">.</span><span class="ident" id="4893535">Close</span>&nbsp;<span class="op" id="4893541">=</span>&nbsp;<span class="ident" id="4893543">rr</span><span class="op" id="4893545">.</span><span class="ident" id="4893546">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893554">t</span><span class="op" id="4893555">.</span><span class="ident" id="4893556">TransferEncoding</span>&nbsp;<span class="op" id="4893573">=</span>&nbsp;<span class="ident" id="4893575">rr</span><span class="op" id="4893577">.</span><span class="ident" id="4893578">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893597">t</span><span class="op" id="4893598">.</span><span class="ident" id="4893599">Trailer</span>&nbsp;<span class="op" id="4893607">=</span>&nbsp;<span class="ident" id="4893609">rr</span><span class="op" id="4893611">.</span><span class="ident" id="4893612">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893622">atLeastHTTP11</span>&nbsp;<span class="op" id="4893636">=</span>&nbsp;<span class="ident" id="4893638">rr</span><span class="op" id="4893640">.</span><span class="ident" id="4893641">ProtoAtLeast</span><span class="op" id="4893653">(</span><span class="num" id="4893654">1</span><span class="op" id="4893655">,</span>&nbsp;<span class="num" id="4893657">1</span><span class="op" id="4893658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893662">t</span><span class="op" id="4893663">.</span><span class="ident" id="4893664">ResponseToHEAD</span>&nbsp;<span class="op" id="4893679">=</span>&nbsp;<span class="ident" id="4893681">noBodyExpected</span><span class="op" id="4893695">(</span><span class="ident" id="4893696">t</span><span class="op" id="4893697">.</span><span class="ident" id="4893698">Method</span><span class="op" id="4893704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4893711">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893760">if</span>&nbsp;<span class="ident" id="4893763">t</span><span class="op" id="4893764">.</span><span class="ident" id="4893765">ResponseToHEAD</span>&nbsp;<span class="op" id="4893780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893784">t</span><span class="op" id="4893785">.</span><span class="ident" id="4893786">Body</span>&nbsp;<span class="op" id="4893791">=</span>&nbsp;<span class="ident" id="4893793">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893799">if</span>&nbsp;<span class="ident" id="4893802">chunked</span><span class="op" id="4893809">(</span><span class="ident" id="4893810">t</span><span class="op" id="4893811">.</span><span class="ident" id="4893812">TransferEncoding</span><span class="op" id="4893828">)</span>&nbsp;<span class="op" id="4893830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893835">t</span><span class="op" id="4893836">.</span><span class="ident" id="4893837">ContentLength</span>&nbsp;<span class="op" id="4893851">=</span>&nbsp;<span class="op" id="4893853">-</span><span class="num" id="4893854">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893861">}</span>&nbsp;<span class="keyword" id="4893863">else</span>&nbsp;<span class="op" id="4893868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893872">if</span>&nbsp;<span class="op" id="4893875">!</span><span class="ident" id="4893876">atLeastHTTP11</span>&nbsp;<span class="op" id="4893890">||</span>&nbsp;<span class="ident" id="4893893">t</span><span class="op" id="4893894">.</span><span class="ident" id="4893895">Body</span>&nbsp;<span class="op" id="4893900">==</span>&nbsp;<span class="ident" id="4893903">nil</span>&nbsp;<span class="op" id="4893907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893912">t</span><span class="op" id="4893913">.</span><span class="ident" id="4893914">TransferEncoding</span>&nbsp;<span class="op" id="4893931">=</span>&nbsp;<span class="ident" id="4893933">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4893939">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4893943">if</span>&nbsp;<span class="ident" id="4893946">chunked</span><span class="op" id="4893953">(</span><span class="ident" id="4893954">t</span><span class="op" id="4893955">.</span><span class="ident" id="4893956">TransferEncoding</span><span class="op" id="4893972">)</span>&nbsp;<span class="op" id="4893974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4893979">t</span><span class="op" id="4893980">.</span><span class="ident" id="4893981">ContentLength</span>&nbsp;<span class="op" id="4893995">=</span>&nbsp;<span class="op" id="4893997">-</span><span class="num" id="4893998">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894002">}</span>&nbsp;<span class="keyword" id="4894004">else</span>&nbsp;<span class="keyword" id="4894009">if</span>&nbsp;<span class="ident" id="4894012">t</span><span class="op" id="4894013">.</span><span class="ident" id="4894014">Body</span>&nbsp;<span class="op" id="4894019">==</span>&nbsp;<span class="ident" id="4894022">nil</span>&nbsp;<span class="op" id="4894026">{</span>&nbsp;<span class="comment" id="4894028">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4894055">t</span><span class="op" id="4894056">.</span><span class="ident" id="4894057">ContentLength</span>&nbsp;<span class="op" id="4894071">=</span>&nbsp;<span class="num" id="4894073">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894077">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4894084">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894105">if</span>&nbsp;<span class="op" id="4894108">!</span><span class="ident" id="4894109">chunked</span><span class="op" id="4894116">(</span><span class="ident" id="4894117">t</span><span class="op" id="4894118">.</span><span class="ident" id="4894119">TransferEncoding</span><span class="op" id="4894135">)</span>&nbsp;<span class="op" id="4894137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4894141">t</span><span class="op" id="4894142">.</span><span class="ident" id="4894143">Trailer</span>&nbsp;<span class="op" id="4894151">=</span>&nbsp;<span class="ident" id="4894153">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894162">return</span>&nbsp;<span class="ident" id="4894169">t</span><span class="op" id="4894170">,</span>&nbsp;<span class="ident" id="4894172">nil</span><br>
<span class="lineno"></span><span class="op" id="4894176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4894179">func</span>&nbsp;<span class="ident" id="4894184">noBodyExpected</span><span class="op" id="4894198">(</span><span class="ident" id="4894199">requestMethod</span>&nbsp;<span class="builtintype" id="4894213">string</span><span class="op" id="4894219">)</span>&nbsp;<span class="builtintype" id="4894221">bool</span>&nbsp;<span class="op" id="4894226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894229">return</span>&nbsp;<span class="ident" id="4894236">requestMethod</span>&nbsp;<span class="op" id="4894250">==</span>&nbsp;<span class="string" id="4894253">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="4894260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4894263">func</span>&nbsp;<span class="op" id="4894268">(</span><span class="ident" id="4894269">t</span>&nbsp;<span class="op" id="4894271">*</span><span class="ident" id="4894272">transferWriter</span><span class="op" id="4894286">)</span>&nbsp;<span class="ident" id="4894288">shouldSendContentLength</span><span class="op" id="4894311">(</span><span class="op" id="4894312">)</span>&nbsp;<span class="builtintype" id="4894314">bool</span>&nbsp;<span class="op" id="4894319">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894322">if</span>&nbsp;<span class="ident" id="4894325">chunked</span><span class="op" id="4894332">(</span><span class="ident" id="4894333">t</span><span class="op" id="4894334">.</span><span class="ident" id="4894335">TransferEncoding</span><span class="op" id="4894351">)</span>&nbsp;<span class="op" id="4894353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894357">return</span>&nbsp;<span class="builtintype" id="4894364">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894374">if</span>&nbsp;<span class="ident" id="4894377">t</span><span class="op" id="4894378">.</span><span class="ident" id="4894379">ContentLength</span>&nbsp;<span class="op" id="4894393">&gt;</span>&nbsp;<span class="num" id="4894395">0</span>&nbsp;<span class="op" id="4894397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894401">return</span>&nbsp;<span class="builtintype" id="4894408">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4894417">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894476">if</span>&nbsp;<span class="ident" id="4894479">t</span><span class="op" id="4894480">.</span><span class="ident" id="4894481">Method</span>&nbsp;<span class="op" id="4894488">==</span>&nbsp;<span class="string" id="4894491">&#34;POST&#34;</span>&nbsp;<span class="op" id="4894498">||</span>&nbsp;<span class="ident" id="4894501">t</span><span class="op" id="4894502">.</span><span class="ident" id="4894503">Method</span>&nbsp;<span class="op" id="4894510">==</span>&nbsp;<span class="string" id="4894513">&#34;PUT&#34;</span>&nbsp;<span class="op" id="4894519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894523">return</span>&nbsp;<span class="builtintype" id="4894530">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894536">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894539">if</span>&nbsp;<span class="ident" id="4894542">t</span><span class="op" id="4894543">.</span><span class="ident" id="4894544">ContentLength</span>&nbsp;<span class="op" id="4894558">==</span>&nbsp;<span class="num" id="4894561">0</span>&nbsp;<span class="op" id="4894563">&amp;&amp;</span>&nbsp;<span class="ident" id="4894566">isIdentity</span><span class="op" id="4894576">(</span><span class="ident" id="4894577">t</span><span class="op" id="4894578">.</span><span class="ident" id="4894579">TransferEncoding</span><span class="op" id="4894595">)</span>&nbsp;<span class="op" id="4894597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894601">return</span>&nbsp;<span class="builtintype" id="4894608">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894618">return</span>&nbsp;<span class="builtintype" id="4894625">false</span><br>
<span class="lineno">150</span><span class="op" id="4894631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4894634">func</span>&nbsp;<span class="op" id="4894639">(</span><span class="ident" id="4894640">t</span>&nbsp;<span class="op" id="4894642">*</span><span class="ident" id="4894643">transferWriter</span><span class="op" id="4894657">)</span>&nbsp;<span class="ident" id="4894659">WriteHeader</span><span class="op" id="4894670">(</span><span class="ident" id="4894671">w</span>&nbsp;<span class="ident" id="4894673">io</span><span class="op" id="4894675">.</span><span class="ident" id="4894676">Writer</span><span class="op" id="4894682">)</span>&nbsp;<span class="builtintype" id="4894684">error</span>&nbsp;<span class="op" id="4894690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894693">if</span>&nbsp;<span class="ident" id="4894696">t</span><span class="op" id="4894697">.</span><span class="ident" id="4894698">Close</span>&nbsp;<span class="op" id="4894704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894708">if</span>&nbsp;<span class="ident" id="4894711">_</span><span class="op" id="4894712">,</span>&nbsp;<span class="ident" id="4894714">err</span>&nbsp;<span class="op" id="4894718">:=</span>&nbsp;<span class="ident" id="4894721">io</span><span class="op" id="4894723">.</span><span class="ident" id="4894724">WriteString</span><span class="op" id="4894735">(</span><span class="ident" id="4894736">w</span><span class="op" id="4894737">,</span>&nbsp;<span class="string" id="4894739">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4894762">)</span><span class="op" id="4894763">;</span>&nbsp;<span class="ident" id="4894765">err</span>&nbsp;<span class="op" id="4894769">!=</span>&nbsp;<span class="ident" id="4894772">nil</span>&nbsp;<span class="op" id="4894776">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894781">return</span>&nbsp;<span class="ident" id="4894788">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4894797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4894801">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4894870">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4894935">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894957">if</span>&nbsp;<span class="ident" id="4894960">t</span><span class="op" id="4894961">.</span><span class="ident" id="4894962">shouldSendContentLength</span><span class="op" id="4894985">(</span><span class="op" id="4894986">)</span>&nbsp;<span class="op" id="4894988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4894992">if</span>&nbsp;<span class="ident" id="4894995">_</span><span class="op" id="4894996">,</span>&nbsp;<span class="ident" id="4894998">err</span>&nbsp;<span class="op" id="4895002">:=</span>&nbsp;<span class="ident" id="4895005">io</span><span class="op" id="4895007">.</span><span class="ident" id="4895008">WriteString</span><span class="op" id="4895019">(</span><span class="ident" id="4895020">w</span><span class="op" id="4895021">,</span>&nbsp;<span class="string" id="4895023">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4895041">)</span><span class="op" id="4895042">;</span>&nbsp;<span class="ident" id="4895044">err</span>&nbsp;<span class="op" id="4895048">!=</span>&nbsp;<span class="ident" id="4895051">nil</span>&nbsp;<span class="op" id="4895055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895060">return</span>&nbsp;<span class="ident" id="4895067">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895077">if</span>&nbsp;<span class="ident" id="4895080">_</span><span class="op" id="4895081">,</span>&nbsp;<span class="ident" id="4895083">err</span>&nbsp;<span class="op" id="4895087">:=</span>&nbsp;<span class="ident" id="4895090">io</span><span class="op" id="4895092">.</span><span class="ident" id="4895093">WriteString</span><span class="op" id="4895104">(</span><span class="ident" id="4895105">w</span><span class="op" id="4895106">,</span>&nbsp;<span class="ident" id="4895108">strconv</span><span class="op" id="4895115">.</span><span class="ident" id="4895116">FormatInt</span><span class="op" id="4895125">(</span><span class="ident" id="4895126">t</span><span class="op" id="4895127">.</span><span class="ident" id="4895128">ContentLength</span><span class="op" id="4895141">,</span>&nbsp;<span class="num" id="4895143">10</span><span class="op" id="4895145">)</span><span class="op" id="4895146">+</span><span class="string" id="4895147">&#34;\r\n&#34;</span><span class="op" id="4895153">)</span><span class="op" id="4895154">;</span>&nbsp;<span class="ident" id="4895156">err</span>&nbsp;<span class="op" id="4895160">!=</span>&nbsp;<span class="ident" id="4895163">nil</span>&nbsp;<span class="op" id="4895167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895172">return</span>&nbsp;<span class="ident" id="4895179">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895188">}</span>&nbsp;<span class="keyword" id="4895190">else</span>&nbsp;<span class="keyword" id="4895195">if</span>&nbsp;<span class="ident" id="4895198">chunked</span><span class="op" id="4895205">(</span><span class="ident" id="4895206">t</span><span class="op" id="4895207">.</span><span class="ident" id="4895208">TransferEncoding</span><span class="op" id="4895224">)</span>&nbsp;<span class="op" id="4895226">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895230">if</span>&nbsp;<span class="ident" id="4895233">_</span><span class="op" id="4895234">,</span>&nbsp;<span class="ident" id="4895236">err</span>&nbsp;<span class="op" id="4895240">:=</span>&nbsp;<span class="ident" id="4895243">io</span><span class="op" id="4895245">.</span><span class="ident" id="4895246">WriteString</span><span class="op" id="4895257">(</span><span class="ident" id="4895258">w</span><span class="op" id="4895259">,</span>&nbsp;<span class="string" id="4895261">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="4895293">)</span><span class="op" id="4895294">;</span>&nbsp;<span class="ident" id="4895296">err</span>&nbsp;<span class="op" id="4895300">!=</span>&nbsp;<span class="ident" id="4895303">nil</span>&nbsp;<span class="op" id="4895307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895312">return</span>&nbsp;<span class="ident" id="4895319">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4895332">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895357">if</span>&nbsp;<span class="ident" id="4895360">t</span><span class="op" id="4895361">.</span><span class="ident" id="4895362">Trailer</span>&nbsp;<span class="op" id="4895370">!=</span>&nbsp;<span class="ident" id="4895373">nil</span>&nbsp;<span class="op" id="4895377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4895381">keys</span>&nbsp;<span class="op" id="4895386">:=</span>&nbsp;<span class="builtinfunc" id="4895389">make</span><span class="op" id="4895393">(</span><span class="op" id="4895394">[</span><span class="op" id="4895395">]</span><span class="builtintype" id="4895396">string</span><span class="op" id="4895402">,</span>&nbsp;<span class="num" id="4895404">0</span><span class="op" id="4895405">,</span>&nbsp;<span class="builtinfunc" id="4895407">len</span><span class="op" id="4895410">(</span><span class="ident" id="4895411">t</span><span class="op" id="4895412">.</span><span class="ident" id="4895413">Trailer</span><span class="op" id="4895420">)</span><span class="op" id="4895421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895425">for</span>&nbsp;<span class="ident" id="4895429">k</span>&nbsp;<span class="op" id="4895431">:=</span>&nbsp;<span class="keyword" id="4895434">range</span>&nbsp;<span class="ident" id="4895440">t</span><span class="op" id="4895441">.</span><span class="ident" id="4895442">Trailer</span>&nbsp;<span class="op" id="4895450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4895455">k</span>&nbsp;<span class="op" id="4895457">=</span>&nbsp;<span class="ident" id="4895459">CanonicalHeaderKey</span><span class="op" id="4895477">(</span><span class="ident" id="4895478">k</span><span class="op" id="4895479">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895484">switch</span>&nbsp;<span class="ident" id="4895491">k</span>&nbsp;<span class="op" id="4895493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895498">case</span>&nbsp;<span class="string" id="4895503">&#34;Transfer-Encoding&#34;</span><span class="op" id="4895522">,</span>&nbsp;<span class="string" id="4895524">&#34;Trailer&#34;</span><span class="op" id="4895533">,</span>&nbsp;<span class="string" id="4895535">&#34;Content-Length&#34;</span><span class="op" id="4895551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895557">return</span>&nbsp;<span class="op" id="4895564">&amp;</span><span class="ident" id="4895565">badStringError</span><span class="op" id="4895579">{</span><span class="string" id="4895580">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="4895601">,</span>&nbsp;<span class="ident" id="4895603">k</span><span class="op" id="4895604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4895614">keys</span>&nbsp;<span class="op" id="4895619">=</span>&nbsp;<span class="builtinfunc" id="4895621">append</span><span class="op" id="4895627">(</span><span class="ident" id="4895628">keys</span><span class="op" id="4895632">,</span>&nbsp;<span class="ident" id="4895634">k</span><span class="op" id="4895635">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895643">if</span>&nbsp;<span class="builtinfunc" id="4895646">len</span><span class="op" id="4895649">(</span><span class="ident" id="4895650">keys</span><span class="op" id="4895654">)</span>&nbsp;<span class="op" id="4895656">&gt;</span>&nbsp;<span class="num" id="4895658">0</span>&nbsp;<span class="op" id="4895660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4895665">sort</span><span class="op" id="4895669">.</span><span class="ident" id="4895670">Strings</span><span class="op" id="4895677">(</span><span class="ident" id="4895678">keys</span><span class="op" id="4895682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4895687">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4895760">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895789">if</span>&nbsp;<span class="ident" id="4895792">_</span><span class="op" id="4895793">,</span>&nbsp;<span class="ident" id="4895795">err</span>&nbsp;<span class="op" id="4895799">:=</span>&nbsp;<span class="ident" id="4895802">io</span><span class="op" id="4895804">.</span><span class="ident" id="4895805">WriteString</span><span class="op" id="4895816">(</span><span class="ident" id="4895817">w</span><span class="op" id="4895818">,</span>&nbsp;<span class="string" id="4895820">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="4895831">+</span><span class="ident" id="4895832">strings</span><span class="op" id="4895839">.</span><span class="ident" id="4895840">Join</span><span class="op" id="4895844">(</span><span class="ident" id="4895845">keys</span><span class="op" id="4895849">,</span>&nbsp;<span class="string" id="4895851">&#34;,&#34;</span><span class="op" id="4895854">)</span><span class="op" id="4895855">+</span><span class="string" id="4895856">&#34;\r\n&#34;</span><span class="op" id="4895862">)</span><span class="op" id="4895863">;</span>&nbsp;<span class="ident" id="4895865">err</span>&nbsp;<span class="op" id="4895869">!=</span>&nbsp;<span class="ident" id="4895872">nil</span>&nbsp;<span class="op" id="4895876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895882">return</span>&nbsp;<span class="ident" id="4895889">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4895903">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895907">return</span>&nbsp;<span class="ident" id="4895914">nil</span><br>
<span class="lineno"></span><span class="op" id="4895918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4895921">func</span>&nbsp;<span class="op" id="4895926">(</span><span class="ident" id="4895927">t</span>&nbsp;<span class="op" id="4895929">*</span><span class="ident" id="4895930">transferWriter</span><span class="op" id="4895944">)</span>&nbsp;<span class="ident" id="4895946">WriteBody</span><span class="op" id="4895955">(</span><span class="ident" id="4895956">w</span>&nbsp;<span class="ident" id="4895958">io</span><span class="op" id="4895960">.</span><span class="ident" id="4895961">Writer</span><span class="op" id="4895967">)</span>&nbsp;<span class="builtintype" id="4895969">error</span>&nbsp;<span class="op" id="4895975">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895978">var</span>&nbsp;<span class="ident" id="4895982">err</span>&nbsp;<span class="builtintype" id="4895986">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4895993">var</span>&nbsp;<span class="ident" id="4895997">ncopy</span>&nbsp;<span class="ident" id="4896003">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4896011">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896026">if</span>&nbsp;<span class="ident" id="4896029">t</span><span class="op" id="4896030">.</span><span class="ident" id="4896031">Body</span>&nbsp;<span class="op" id="4896036">!=</span>&nbsp;<span class="ident" id="4896039">nil</span>&nbsp;<span class="op" id="4896043">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896047">if</span>&nbsp;<span class="ident" id="4896050">chunked</span><span class="op" id="4896057">(</span><span class="ident" id="4896058">t</span><span class="op" id="4896059">.</span><span class="ident" id="4896060">TransferEncoding</span><span class="op" id="4896076">)</span>&nbsp;<span class="op" id="4896078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896083">cw</span>&nbsp;<span class="op" id="4896086">:=</span>&nbsp;<span class="ident" id="4896089">internal</span><span class="op" id="4896097">.</span><span class="ident" id="4896098">NewChunkedWriter</span><span class="op" id="4896114">(</span><span class="ident" id="4896115">w</span><span class="op" id="4896116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896121">_</span><span class="op" id="4896122">,</span>&nbsp;<span class="ident" id="4896124">err</span>&nbsp;<span class="op" id="4896128">=</span>&nbsp;<span class="ident" id="4896130">io</span><span class="op" id="4896132">.</span><span class="ident" id="4896133">Copy</span><span class="op" id="4896137">(</span><span class="ident" id="4896138">cw</span><span class="op" id="4896140">,</span>&nbsp;<span class="ident" id="4896142">t</span><span class="op" id="4896143">.</span><span class="ident" id="4896144">Body</span><span class="op" id="4896148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896153">if</span>&nbsp;<span class="ident" id="4896156">err</span>&nbsp;<span class="op" id="4896160">==</span>&nbsp;<span class="ident" id="4896163">nil</span>&nbsp;<span class="op" id="4896167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896173">err</span>&nbsp;<span class="op" id="4896177">=</span>&nbsp;<span class="ident" id="4896179">cw</span><span class="op" id="4896181">.</span><span class="ident" id="4896182">Close</span><span class="op" id="4896187">(</span><span class="op" id="4896188">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896197">}</span>&nbsp;<span class="keyword" id="4896199">else</span>&nbsp;<span class="keyword" id="4896204">if</span>&nbsp;<span class="ident" id="4896207">t</span><span class="op" id="4896208">.</span><span class="ident" id="4896209">ContentLength</span>&nbsp;<span class="op" id="4896223">==</span>&nbsp;<span class="op" id="4896226">-</span><span class="num" id="4896227">1</span>&nbsp;<span class="op" id="4896229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896234">ncopy</span><span class="op" id="4896239">,</span>&nbsp;<span class="ident" id="4896241">err</span>&nbsp;<span class="op" id="4896245">=</span>&nbsp;<span class="ident" id="4896247">io</span><span class="op" id="4896249">.</span><span class="ident" id="4896250">Copy</span><span class="op" id="4896254">(</span><span class="ident" id="4896255">w</span><span class="op" id="4896256">,</span>&nbsp;<span class="ident" id="4896258">t</span><span class="op" id="4896259">.</span><span class="ident" id="4896260">Body</span><span class="op" id="4896264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896268">}</span>&nbsp;<span class="keyword" id="4896270">else</span>&nbsp;<span class="op" id="4896275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896280">ncopy</span><span class="op" id="4896285">,</span>&nbsp;<span class="ident" id="4896287">err</span>&nbsp;<span class="op" id="4896291">=</span>&nbsp;<span class="ident" id="4896293">io</span><span class="op" id="4896295">.</span><span class="ident" id="4896296">Copy</span><span class="op" id="4896300">(</span><span class="ident" id="4896301">w</span><span class="op" id="4896302">,</span>&nbsp;<span class="ident" id="4896304">io</span><span class="op" id="4896306">.</span><span class="ident" id="4896307">LimitReader</span><span class="op" id="4896318">(</span><span class="ident" id="4896319">t</span><span class="op" id="4896320">.</span><span class="ident" id="4896321">Body</span><span class="op" id="4896325">,</span>&nbsp;<span class="ident" id="4896327">t</span><span class="op" id="4896328">.</span><span class="ident" id="4896329">ContentLength</span><span class="op" id="4896342">)</span><span class="op" id="4896343">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896348">if</span>&nbsp;<span class="ident" id="4896351">err</span>&nbsp;<span class="op" id="4896355">!=</span>&nbsp;<span class="ident" id="4896358">nil</span>&nbsp;<span class="op" id="4896362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896368">return</span>&nbsp;<span class="ident" id="4896375">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896387">var</span>&nbsp;<span class="ident" id="4896391">nextra</span>&nbsp;<span class="ident" id="4896398">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896407">nextra</span><span class="op" id="4896413">,</span>&nbsp;<span class="ident" id="4896415">err</span>&nbsp;<span class="op" id="4896419">=</span>&nbsp;<span class="ident" id="4896421">io</span><span class="op" id="4896423">.</span><span class="ident" id="4896424">Copy</span><span class="op" id="4896428">(</span><span class="ident" id="4896429">ioutil</span><span class="op" id="4896435">.</span><span class="ident" id="4896436">Discard</span><span class="op" id="4896443">,</span>&nbsp;<span class="ident" id="4896445">t</span><span class="op" id="4896446">.</span><span class="ident" id="4896447">Body</span><span class="op" id="4896451">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896456">ncopy</span>&nbsp;<span class="op" id="4896462">+=</span>&nbsp;<span class="ident" id="4896465">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896478">if</span>&nbsp;<span class="ident" id="4896481">err</span>&nbsp;<span class="op" id="4896485">!=</span>&nbsp;<span class="ident" id="4896488">nil</span>&nbsp;<span class="op" id="4896492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896497">return</span>&nbsp;<span class="ident" id="4896504">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896510">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896514">if</span>&nbsp;<span class="ident" id="4896517">err</span>&nbsp;<span class="op" id="4896521">=</span>&nbsp;<span class="ident" id="4896523">t</span><span class="op" id="4896524">.</span><span class="ident" id="4896525">BodyCloser</span><span class="op" id="4896535">.</span><span class="ident" id="4896536">Close</span><span class="op" id="4896541">(</span><span class="op" id="4896542">)</span><span class="op" id="4896543">;</span>&nbsp;<span class="ident" id="4896545">err</span>&nbsp;<span class="op" id="4896549">!=</span>&nbsp;<span class="ident" id="4896552">nil</span>&nbsp;<span class="op" id="4896556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896561">return</span>&nbsp;<span class="ident" id="4896568">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896581">if</span>&nbsp;<span class="op" id="4896584">!</span><span class="ident" id="4896585">t</span><span class="op" id="4896586">.</span><span class="ident" id="4896587">ResponseToHEAD</span>&nbsp;<span class="op" id="4896602">&amp;&amp;</span>&nbsp;<span class="ident" id="4896605">t</span><span class="op" id="4896606">.</span><span class="ident" id="4896607">ContentLength</span>&nbsp;<span class="op" id="4896621">!=</span>&nbsp;<span class="op" id="4896624">-</span><span class="num" id="4896625">1</span>&nbsp;<span class="op" id="4896627">&amp;&amp;</span>&nbsp;<span class="ident" id="4896630">t</span><span class="op" id="4896631">.</span><span class="ident" id="4896632">ContentLength</span>&nbsp;<span class="op" id="4896646">!=</span>&nbsp;<span class="ident" id="4896649">ncopy</span>&nbsp;<span class="op" id="4896655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896659">return</span>&nbsp;<span class="ident" id="4896666">fmt</span><span class="op" id="4896669">.</span><span class="ident" id="4896670">Errorf</span><span class="op" id="4896676">(</span><span class="string" id="4896677">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4896721">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896726">t</span><span class="op" id="4896727">.</span><span class="ident" id="4896728">ContentLength</span><span class="op" id="4896741">,</span>&nbsp;<span class="ident" id="4896743">ncopy</span><span class="op" id="4896748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4896755">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896804">if</span>&nbsp;<span class="ident" id="4896807">chunked</span><span class="op" id="4896814">(</span><span class="ident" id="4896815">t</span><span class="op" id="4896816">.</span><span class="ident" id="4896817">TransferEncoding</span><span class="op" id="4896833">)</span>&nbsp;<span class="op" id="4896835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4896839">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896865">if</span>&nbsp;<span class="ident" id="4896868">t</span><span class="op" id="4896869">.</span><span class="ident" id="4896870">Trailer</span>&nbsp;<span class="op" id="4896878">!=</span>&nbsp;<span class="ident" id="4896881">nil</span>&nbsp;<span class="op" id="4896885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896890">if</span>&nbsp;<span class="ident" id="4896893">err</span>&nbsp;<span class="op" id="4896897">:=</span>&nbsp;<span class="ident" id="4896900">t</span><span class="op" id="4896901">.</span><span class="ident" id="4896902">Trailer</span><span class="op" id="4896909">.</span><span class="ident" id="4896910">Write</span><span class="op" id="4896915">(</span><span class="ident" id="4896916">w</span><span class="op" id="4896917">)</span><span class="op" id="4896918">;</span>&nbsp;<span class="ident" id="4896920">err</span>&nbsp;<span class="op" id="4896924">!=</span>&nbsp;<span class="ident" id="4896927">nil</span>&nbsp;<span class="op" id="4896931">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4896937">return</span>&nbsp;<span class="ident" id="4896944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4896955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4896959">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4896990">_</span><span class="op" id="4896991">,</span>&nbsp;<span class="ident" id="4896993">err</span>&nbsp;<span class="op" id="4896997">=</span>&nbsp;<span class="ident" id="4896999">io</span><span class="op" id="4897001">.</span><span class="ident" id="4897002">WriteString</span><span class="op" id="4897013">(</span><span class="ident" id="4897014">w</span><span class="op" id="4897015">,</span>&nbsp;<span class="string" id="4897017">&#34;\r\n&#34;</span><span class="op" id="4897023">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4897026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897029">return</span>&nbsp;<span class="ident" id="4897036">err</span><br>
<span class="lineno"></span><span class="op" id="4897040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4897043">type</span>&nbsp;<span class="ident" id="4897048">transferReader</span>&nbsp;<span class="keyword" id="4897063">struct</span>&nbsp;<span class="op" id="4897070">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4897073">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897083">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4897097">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897105">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4897119">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897124">RequestMethod</span>&nbsp;<span class="builtintype" id="4897138">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897146">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4897160">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897165">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4897179">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4897184">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897195">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4897212">io</span><span class="op" id="4897214">.</span><span class="ident" id="4897215">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897227">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4897244">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897251">TransferEncoding</span>&nbsp;<span class="op" id="4897268">[</span><span class="op" id="4897269">]</span><span class="builtintype" id="4897270">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897278">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4897295">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897301">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4897318">Header</span><br>
<span class="lineno"></span><span class="op" id="4897325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4897328">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="4897397">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="4897443">func</span>&nbsp;<span class="ident" id="4897448">bodyAllowedForStatus</span><span class="op" id="4897468">(</span><span class="ident" id="4897469">status</span>&nbsp;<span class="builtintype" id="4897476">int</span><span class="op" id="4897479">)</span>&nbsp;<span class="builtintype" id="4897481">bool</span>&nbsp;<span class="op" id="4897486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897489">switch</span>&nbsp;<span class="op" id="4897496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897499">case</span>&nbsp;<span class="ident" id="4897504">status</span>&nbsp;<span class="op" id="4897511">&gt;=</span>&nbsp;<span class="num" id="4897514">100</span>&nbsp;<span class="op" id="4897518">&amp;&amp;</span>&nbsp;<span class="ident" id="4897521">status</span>&nbsp;<span class="op" id="4897528">&lt;=</span>&nbsp;<span class="num" id="4897531">199</span><span class="op" id="4897534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897538">return</span>&nbsp;<span class="builtintype" id="4897545">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897552">case</span>&nbsp;<span class="ident" id="4897557">status</span>&nbsp;<span class="op" id="4897564">==</span>&nbsp;<span class="num" id="4897567">204</span><span class="op" id="4897570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897574">return</span>&nbsp;<span class="builtintype" id="4897581">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897588">case</span>&nbsp;<span class="ident" id="4897593">status</span>&nbsp;<span class="op" id="4897600">==</span>&nbsp;<span class="num" id="4897603">304</span><span class="op" id="4897606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897610">return</span>&nbsp;<span class="builtintype" id="4897617">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4897624">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897627">return</span>&nbsp;<span class="builtintype" id="4897634">true</span><br>
<span class="lineno"></span><span class="op" id="4897639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4897642">var</span>&nbsp;<span class="op" id="4897646">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897649">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4897673">=</span>&nbsp;<span class="op" id="4897675">[</span><span class="op" id="4897676">]</span><span class="builtintype" id="4897677">string</span><span class="op" id="4897683">{</span><span class="string" id="4897684">&#34;Content-Type&#34;</span><span class="op" id="4897698">,</span>&nbsp;<span class="string" id="4897700">&#34;Content-Length&#34;</span><span class="op" id="4897716">,</span>&nbsp;<span class="string" id="4897718">&#34;Transfer-Encoding&#34;</span><span class="op" id="4897737">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4897740">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="4897764">=</span>&nbsp;<span class="op" id="4897766">[</span><span class="op" id="4897767">]</span><span class="builtintype" id="4897768">string</span><span class="op" id="4897774">{</span><span class="string" id="4897775">&#34;Content-Length&#34;</span><span class="op" id="4897791">,</span>&nbsp;<span class="string" id="4897793">&#34;Transfer-Encoding&#34;</span><span class="op" id="4897812">}</span><br>
<span class="lineno"></span><span class="op" id="4897814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4897817">func</span>&nbsp;<span class="ident" id="4897822">suppressedHeaders</span><span class="op" id="4897839">(</span><span class="ident" id="4897840">status</span>&nbsp;<span class="builtintype" id="4897847">int</span><span class="op" id="4897850">)</span>&nbsp;<span class="op" id="4897852">[</span><span class="op" id="4897853">]</span><span class="builtintype" id="4897854">string</span>&nbsp;<span class="op" id="4897861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897864">switch</span>&nbsp;<span class="op" id="4897871">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897874">case</span>&nbsp;<span class="ident" id="4897879">status</span>&nbsp;<span class="op" id="4897886">==</span>&nbsp;<span class="num" id="4897889">304</span><span class="op" id="4897892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4897896">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4897979">return</span>&nbsp;<span class="ident" id="4897986">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898008">case</span>&nbsp;<span class="op" id="4898013">!</span><span class="ident" id="4898014">bodyAllowedForStatus</span><span class="op" id="4898034">(</span><span class="ident" id="4898035">status</span><span class="op" id="4898041">)</span><span class="op" id="4898042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898046">return</span>&nbsp;<span class="ident" id="4898053">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4898078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898081">return</span>&nbsp;<span class="ident" id="4898088">nil</span><br>
<span class="lineno"></span><span class="op" id="4898092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4898095">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="4898128">func</span>&nbsp;<span class="ident" id="4898133">readTransfer</span><span class="op" id="4898145">(</span><span class="ident" id="4898146">msg</span>&nbsp;<span class="keyword" id="4898150">interface</span><span class="op" id="4898159">{</span><span class="op" id="4898160">}</span><span class="op" id="4898161">,</span>&nbsp;<span class="ident" id="4898163">r</span>&nbsp;<span class="op" id="4898165">*</span><span class="ident" id="4898166">bufio</span><span class="op" id="4898171">.</span><span class="ident" id="4898172">Reader</span><span class="op" id="4898178">)</span>&nbsp;<span class="op" id="4898180">(</span><span class="ident" id="4898181">err</span>&nbsp;<span class="builtintype" id="4898185">error</span><span class="op" id="4898190">)</span>&nbsp;<span class="op" id="4898192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898195">t</span>&nbsp;<span class="op" id="4898197">:=</span>&nbsp;<span class="op" id="4898200">&amp;</span><span class="ident" id="4898201">transferReader</span><span class="op" id="4898215">{</span><span class="ident" id="4898216">RequestMethod</span><span class="op" id="4898229">:</span>&nbsp;<span class="string" id="4898231">&#34;GET&#34;</span><span class="op" id="4898236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4898240">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898256">isResponse</span>&nbsp;<span class="op" id="4898267">:=</span>&nbsp;<span class="builtintype" id="4898270">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898277">switch</span>&nbsp;<span class="ident" id="4898284">rr</span>&nbsp;<span class="op" id="4898287">:=</span>&nbsp;<span class="ident" id="4898290">msg</span><span class="op" id="4898293">.</span><span class="op" id="4898294">(</span><span class="keyword" id="4898295">type</span><span class="op" id="4898299">)</span>&nbsp;<span class="op" id="4898301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898304">case</span>&nbsp;<span class="op" id="4898309">*</span><span class="ident" id="4898310">Response</span><span class="op" id="4898318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898322">t</span><span class="op" id="4898323">.</span><span class="ident" id="4898324">Header</span>&nbsp;<span class="op" id="4898331">=</span>&nbsp;<span class="ident" id="4898333">rr</span><span class="op" id="4898335">.</span><span class="ident" id="4898336">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898345">t</span><span class="op" id="4898346">.</span><span class="ident" id="4898347">StatusCode</span>&nbsp;<span class="op" id="4898358">=</span>&nbsp;<span class="ident" id="4898360">rr</span><span class="op" id="4898362">.</span><span class="ident" id="4898363">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898376">t</span><span class="op" id="4898377">.</span><span class="ident" id="4898378">ProtoMajor</span>&nbsp;<span class="op" id="4898389">=</span>&nbsp;<span class="ident" id="4898391">rr</span><span class="op" id="4898393">.</span><span class="ident" id="4898394">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898407">t</span><span class="op" id="4898408">.</span><span class="ident" id="4898409">ProtoMinor</span>&nbsp;<span class="op" id="4898420">=</span>&nbsp;<span class="ident" id="4898422">rr</span><span class="op" id="4898424">.</span><span class="ident" id="4898425">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898438">t</span><span class="op" id="4898439">.</span><span class="ident" id="4898440">Close</span>&nbsp;<span class="op" id="4898446">=</span>&nbsp;<span class="ident" id="4898448">shouldClose</span><span class="op" id="4898459">(</span><span class="ident" id="4898460">t</span><span class="op" id="4898461">.</span><span class="ident" id="4898462">ProtoMajor</span><span class="op" id="4898472">,</span>&nbsp;<span class="ident" id="4898474">t</span><span class="op" id="4898475">.</span><span class="ident" id="4898476">ProtoMinor</span><span class="op" id="4898486">,</span>&nbsp;<span class="ident" id="4898488">t</span><span class="op" id="4898489">.</span><span class="ident" id="4898490">Header</span><span class="op" id="4898496">,</span>&nbsp;<span class="builtintype" id="4898498">true</span><span class="op" id="4898502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898506">isResponse</span>&nbsp;<span class="op" id="4898517">=</span>&nbsp;<span class="builtintype" id="4898519">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898526">if</span>&nbsp;<span class="ident" id="4898529">rr</span><span class="op" id="4898531">.</span><span class="ident" id="4898532">Request</span>&nbsp;<span class="op" id="4898540">!=</span>&nbsp;<span class="ident" id="4898543">nil</span>&nbsp;<span class="op" id="4898547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898552">t</span><span class="op" id="4898553">.</span><span class="ident" id="4898554">RequestMethod</span>&nbsp;<span class="op" id="4898568">=</span>&nbsp;<span class="ident" id="4898570">rr</span><span class="op" id="4898572">.</span><span class="ident" id="4898573">Request</span><span class="op" id="4898580">.</span><span class="ident" id="4898581">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4898590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898593">case</span>&nbsp;<span class="op" id="4898598">*</span><span class="ident" id="4898599">Request</span><span class="op" id="4898606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898610">t</span><span class="op" id="4898611">.</span><span class="ident" id="4898612">Header</span>&nbsp;<span class="op" id="4898619">=</span>&nbsp;<span class="ident" id="4898621">rr</span><span class="op" id="4898623">.</span><span class="ident" id="4898624">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898633">t</span><span class="op" id="4898634">.</span><span class="ident" id="4898635">ProtoMajor</span>&nbsp;<span class="op" id="4898646">=</span>&nbsp;<span class="ident" id="4898648">rr</span><span class="op" id="4898650">.</span><span class="ident" id="4898651">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898664">t</span><span class="op" id="4898665">.</span><span class="ident" id="4898666">ProtoMinor</span>&nbsp;<span class="op" id="4898677">=</span>&nbsp;<span class="ident" id="4898679">rr</span><span class="op" id="4898681">.</span><span class="ident" id="4898682">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4898695">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4898759">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898823">t</span><span class="op" id="4898824">.</span><span class="ident" id="4898825">StatusCode</span>&nbsp;<span class="op" id="4898836">=</span>&nbsp;<span class="num" id="4898838">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898843">default</span><span class="op" id="4898850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4898854">panic</span><span class="op" id="4898859">(</span><span class="string" id="4898860">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="4898877">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4898880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4898884">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4898908">if</span>&nbsp;<span class="ident" id="4898911">t</span><span class="op" id="4898912">.</span><span class="ident" id="4898913">ProtoMajor</span>&nbsp;<span class="op" id="4898924">==</span>&nbsp;<span class="num" id="4898927">0</span>&nbsp;<span class="op" id="4898929">&amp;&amp;</span>&nbsp;<span class="ident" id="4898932">t</span><span class="op" id="4898933">.</span><span class="ident" id="4898934">ProtoMinor</span>&nbsp;<span class="op" id="4898945">==</span>&nbsp;<span class="num" id="4898948">0</span>&nbsp;<span class="op" id="4898950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4898954">t</span><span class="op" id="4898955">.</span><span class="ident" id="4898956">ProtoMajor</span><span class="op" id="4898966">,</span>&nbsp;<span class="ident" id="4898968">t</span><span class="op" id="4898969">.</span><span class="ident" id="4898970">ProtoMinor</span>&nbsp;<span class="op" id="4898981">=</span>&nbsp;<span class="num" id="4898983">1</span><span class="op" id="4898984">,</span>&nbsp;<span class="num" id="4898986">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4898989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4898993">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899031">t</span><span class="op" id="4899032">.</span><span class="ident" id="4899033">TransferEncoding</span><span class="op" id="4899049">,</span>&nbsp;<span class="ident" id="4899051">err</span>&nbsp;<span class="op" id="4899055">=</span>&nbsp;<span class="ident" id="4899057">fixTransferEncoding</span><span class="op" id="4899076">(</span><span class="ident" id="4899077">t</span><span class="op" id="4899078">.</span><span class="ident" id="4899079">RequestMethod</span><span class="op" id="4899092">,</span>&nbsp;<span class="ident" id="4899094">t</span><span class="op" id="4899095">.</span><span class="ident" id="4899096">Header</span><span class="op" id="4899102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899105">if</span>&nbsp;<span class="ident" id="4899108">err</span>&nbsp;<span class="op" id="4899112">!=</span>&nbsp;<span class="ident" id="4899115">nil</span>&nbsp;<span class="op" id="4899119">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899123">return</span>&nbsp;<span class="ident" id="4899130">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899139">realLength</span><span class="op" id="4899149">,</span>&nbsp;<span class="ident" id="4899151">err</span>&nbsp;<span class="op" id="4899155">:=</span>&nbsp;<span class="ident" id="4899158">fixLength</span><span class="op" id="4899167">(</span><span class="ident" id="4899168">isResponse</span><span class="op" id="4899178">,</span>&nbsp;<span class="ident" id="4899180">t</span><span class="op" id="4899181">.</span><span class="ident" id="4899182">StatusCode</span><span class="op" id="4899192">,</span>&nbsp;<span class="ident" id="4899194">t</span><span class="op" id="4899195">.</span><span class="ident" id="4899196">RequestMethod</span><span class="op" id="4899209">,</span>&nbsp;<span class="ident" id="4899211">t</span><span class="op" id="4899212">.</span><span class="ident" id="4899213">Header</span><span class="op" id="4899219">,</span>&nbsp;<span class="ident" id="4899221">t</span><span class="op" id="4899222">.</span><span class="ident" id="4899223">TransferEncoding</span><span class="op" id="4899239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899242">if</span>&nbsp;<span class="ident" id="4899245">err</span>&nbsp;<span class="op" id="4899249">!=</span>&nbsp;<span class="ident" id="4899252">nil</span>&nbsp;<span class="op" id="4899256">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899260">return</span>&nbsp;<span class="ident" id="4899267">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899275">if</span>&nbsp;<span class="ident" id="4899278">isResponse</span>&nbsp;<span class="op" id="4899289">&amp;&amp;</span>&nbsp;<span class="ident" id="4899292">t</span><span class="op" id="4899293">.</span><span class="ident" id="4899294">RequestMethod</span>&nbsp;<span class="op" id="4899308">==</span>&nbsp;<span class="string" id="4899311">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4899318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899322">if</span>&nbsp;<span class="ident" id="4899325">n</span><span class="op" id="4899326">,</span>&nbsp;<span class="ident" id="4899328">err</span>&nbsp;<span class="op" id="4899332">:=</span>&nbsp;<span class="ident" id="4899335">parseContentLength</span><span class="op" id="4899353">(</span><span class="ident" id="4899354">t</span><span class="op" id="4899355">.</span><span class="ident" id="4899356">Header</span><span class="op" id="4899362">.</span><span class="ident" id="4899363">get</span><span class="op" id="4899366">(</span><span class="string" id="4899367">&#34;Content-Length&#34;</span><span class="op" id="4899383">)</span><span class="op" id="4899384">)</span><span class="op" id="4899385">;</span>&nbsp;<span class="ident" id="4899387">err</span>&nbsp;<span class="op" id="4899391">!=</span>&nbsp;<span class="ident" id="4899394">nil</span>&nbsp;<span class="op" id="4899398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899403">return</span>&nbsp;<span class="ident" id="4899410">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899416">}</span>&nbsp;<span class="keyword" id="4899418">else</span>&nbsp;<span class="op" id="4899423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899428">t</span><span class="op" id="4899429">.</span><span class="ident" id="4899430">ContentLength</span>&nbsp;<span class="op" id="4899444">=</span>&nbsp;<span class="ident" id="4899446">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899453">}</span>&nbsp;<span class="keyword" id="4899455">else</span>&nbsp;<span class="op" id="4899460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899464">t</span><span class="op" id="4899465">.</span><span class="ident" id="4899466">ContentLength</span>&nbsp;<span class="op" id="4899480">=</span>&nbsp;<span class="ident" id="4899482">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899498">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899510">t</span><span class="op" id="4899511">.</span><span class="ident" id="4899512">Trailer</span><span class="op" id="4899519">,</span>&nbsp;<span class="ident" id="4899521">err</span>&nbsp;<span class="op" id="4899525">=</span>&nbsp;<span class="ident" id="4899527">fixTrailer</span><span class="op" id="4899537">(</span><span class="ident" id="4899538">t</span><span class="op" id="4899539">.</span><span class="ident" id="4899540">Header</span><span class="op" id="4899546">,</span>&nbsp;<span class="ident" id="4899548">t</span><span class="op" id="4899549">.</span><span class="ident" id="4899550">TransferEncoding</span><span class="op" id="4899566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899569">if</span>&nbsp;<span class="ident" id="4899572">err</span>&nbsp;<span class="op" id="4899576">!=</span>&nbsp;<span class="ident" id="4899579">nil</span>&nbsp;<span class="op" id="4899583">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899587">return</span>&nbsp;<span class="ident" id="4899594">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899603">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899681">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899752">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899782">switch</span>&nbsp;<span class="ident" id="4899789">msg</span><span class="op" id="4899792">.</span><span class="op" id="4899793">(</span><span class="keyword" id="4899794">type</span><span class="op" id="4899798">)</span>&nbsp;<span class="op" id="4899800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899803">case</span>&nbsp;<span class="op" id="4899808">*</span><span class="ident" id="4899809">Response</span><span class="op" id="4899817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4899821">if</span>&nbsp;<span class="ident" id="4899824">realLength</span>&nbsp;<span class="op" id="4899835">==</span>&nbsp;<span class="op" id="4899838">-</span><span class="num" id="4899839">1</span>&nbsp;<span class="op" id="4899841">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899847">!</span><span class="ident" id="4899848">chunked</span><span class="op" id="4899855">(</span><span class="ident" id="4899856">t</span><span class="op" id="4899857">.</span><span class="ident" id="4899858">TransferEncoding</span><span class="op" id="4899874">)</span>&nbsp;<span class="op" id="4899876">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899882">bodyAllowedForStatus</span><span class="op" id="4899902">(</span><span class="ident" id="4899903">t</span><span class="op" id="4899904">.</span><span class="ident" id="4899905">StatusCode</span><span class="op" id="4899915">)</span>&nbsp;<span class="op" id="4899917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899922">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4899944">t</span><span class="op" id="4899945">.</span><span class="ident" id="4899946">Close</span>&nbsp;<span class="op" id="4899952">=</span>&nbsp;<span class="builtintype" id="4899954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4899964">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4899968">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4900035">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900111">switch</span>&nbsp;<span class="op" id="4900118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900121">case</span>&nbsp;<span class="ident" id="4900126">chunked</span><span class="op" id="4900133">(</span><span class="ident" id="4900134">t</span><span class="op" id="4900135">.</span><span class="ident" id="4900136">TransferEncoding</span><span class="op" id="4900152">)</span><span class="op" id="4900153">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900157">if</span>&nbsp;<span class="ident" id="4900160">noBodyExpected</span><span class="op" id="4900174">(</span><span class="ident" id="4900175">t</span><span class="op" id="4900176">.</span><span class="ident" id="4900177">RequestMethod</span><span class="op" id="4900190">)</span>&nbsp;<span class="op" id="4900192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900197">t</span><span class="op" id="4900198">.</span><span class="ident" id="4900199">Body</span>&nbsp;<span class="op" id="4900204">=</span>&nbsp;<span class="ident" id="4900206">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4900218">}</span>&nbsp;<span class="keyword" id="4900220">else</span>&nbsp;<span class="op" id="4900225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900230">t</span><span class="op" id="4900231">.</span><span class="ident" id="4900232">Body</span>&nbsp;<span class="op" id="4900237">=</span>&nbsp;<span class="op" id="4900239">&amp;</span><span class="ident" id="4900240">body</span><span class="op" id="4900244">{</span><span class="ident" id="4900245">src</span><span class="op" id="4900248">:</span>&nbsp;<span class="ident" id="4900250">internal</span><span class="op" id="4900258">.</span><span class="ident" id="4900259">NewChunkedReader</span><span class="op" id="4900275">(</span><span class="ident" id="4900276">r</span><span class="op" id="4900277">)</span><span class="op" id="4900278">,</span>&nbsp;<span class="ident" id="4900280">hdr</span><span class="op" id="4900283">:</span>&nbsp;<span class="ident" id="4900285">msg</span><span class="op" id="4900288">,</span>&nbsp;<span class="ident" id="4900290">r</span><span class="op" id="4900291">:</span>&nbsp;<span class="ident" id="4900293">r</span><span class="op" id="4900294">,</span>&nbsp;<span class="ident" id="4900296">closing</span><span class="op" id="4900303">:</span>&nbsp;<span class="ident" id="4900305">t</span><span class="op" id="4900306">.</span><span class="ident" id="4900307">Close</span><span class="op" id="4900312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4900316">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900319">case</span>&nbsp;<span class="ident" id="4900324">realLength</span>&nbsp;<span class="op" id="4900335">==</span>&nbsp;<span class="num" id="4900338">0</span><span class="op" id="4900339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900343">t</span><span class="op" id="4900344">.</span><span class="ident" id="4900345">Body</span>&nbsp;<span class="op" id="4900350">=</span>&nbsp;<span class="ident" id="4900352">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900363">case</span>&nbsp;<span class="ident" id="4900368">realLength</span>&nbsp;<span class="op" id="4900379">&gt;</span>&nbsp;<span class="num" id="4900381">0</span><span class="op" id="4900382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900386">t</span><span class="op" id="4900387">.</span><span class="ident" id="4900388">Body</span>&nbsp;<span class="op" id="4900393">=</span>&nbsp;<span class="op" id="4900395">&amp;</span><span class="ident" id="4900396">body</span><span class="op" id="4900400">{</span><span class="ident" id="4900401">src</span><span class="op" id="4900404">:</span>&nbsp;<span class="ident" id="4900406">io</span><span class="op" id="4900408">.</span><span class="ident" id="4900409">LimitReader</span><span class="op" id="4900420">(</span><span class="ident" id="4900421">r</span><span class="op" id="4900422">,</span>&nbsp;<span class="ident" id="4900424">realLength</span><span class="op" id="4900434">)</span><span class="op" id="4900435">,</span>&nbsp;<span class="ident" id="4900437">closing</span><span class="op" id="4900444">:</span>&nbsp;<span class="ident" id="4900446">t</span><span class="op" id="4900447">.</span><span class="ident" id="4900448">Close</span><span class="op" id="4900453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900456">default</span><span class="op" id="4900463">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4900467">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900534">if</span>&nbsp;<span class="ident" id="4900537">t</span><span class="op" id="4900538">.</span><span class="ident" id="4900539">Close</span>&nbsp;<span class="op" id="4900545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4900550">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900588">t</span><span class="op" id="4900589">.</span><span class="ident" id="4900590">Body</span>&nbsp;<span class="op" id="4900595">=</span>&nbsp;<span class="op" id="4900597">&amp;</span><span class="ident" id="4900598">body</span><span class="op" id="4900602">{</span><span class="ident" id="4900603">src</span><span class="op" id="4900606">:</span>&nbsp;<span class="ident" id="4900608">r</span><span class="op" id="4900609">,</span>&nbsp;<span class="ident" id="4900611">closing</span><span class="op" id="4900618">:</span>&nbsp;<span class="ident" id="4900620">t</span><span class="op" id="4900621">.</span><span class="ident" id="4900622">Close</span><span class="op" id="4900627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4900631">}</span>&nbsp;<span class="keyword" id="4900633">else</span>&nbsp;<span class="op" id="4900638">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4900643">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900687">t</span><span class="op" id="4900688">.</span><span class="ident" id="4900689">Body</span>&nbsp;<span class="op" id="4900694">=</span>&nbsp;<span class="ident" id="4900696">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4900708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4900711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4900715">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900732">switch</span>&nbsp;<span class="ident" id="4900739">rr</span>&nbsp;<span class="op" id="4900742">:=</span>&nbsp;<span class="ident" id="4900745">msg</span><span class="op" id="4900748">.</span><span class="op" id="4900749">(</span><span class="keyword" id="4900750">type</span><span class="op" id="4900754">)</span>&nbsp;<span class="op" id="4900756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900759">case</span>&nbsp;<span class="op" id="4900764">*</span><span class="ident" id="4900765">Request</span><span class="op" id="4900772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900776">rr</span><span class="op" id="4900778">.</span><span class="ident" id="4900779">Body</span>&nbsp;<span class="op" id="4900784">=</span>&nbsp;<span class="ident" id="4900786">t</span><span class="op" id="4900787">.</span><span class="ident" id="4900788">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900795">rr</span><span class="op" id="4900797">.</span><span class="ident" id="4900798">ContentLength</span>&nbsp;<span class="op" id="4900812">=</span>&nbsp;<span class="ident" id="4900814">t</span><span class="op" id="4900815">.</span><span class="ident" id="4900816">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900832">rr</span><span class="op" id="4900834">.</span><span class="ident" id="4900835">TransferEncoding</span>&nbsp;<span class="op" id="4900852">=</span>&nbsp;<span class="ident" id="4900854">t</span><span class="op" id="4900855">.</span><span class="ident" id="4900856">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900875">rr</span><span class="op" id="4900877">.</span><span class="ident" id="4900878">Close</span>&nbsp;<span class="op" id="4900884">=</span>&nbsp;<span class="ident" id="4900886">t</span><span class="op" id="4900887">.</span><span class="ident" id="4900888">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900896">rr</span><span class="op" id="4900898">.</span><span class="ident" id="4900899">Trailer</span>&nbsp;<span class="op" id="4900907">=</span>&nbsp;<span class="ident" id="4900909">t</span><span class="op" id="4900910">.</span><span class="ident" id="4900911">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4900920">case</span>&nbsp;<span class="op" id="4900925">*</span><span class="ident" id="4900926">Response</span><span class="op" id="4900934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900938">rr</span><span class="op" id="4900940">.</span><span class="ident" id="4900941">Body</span>&nbsp;<span class="op" id="4900946">=</span>&nbsp;<span class="ident" id="4900948">t</span><span class="op" id="4900949">.</span><span class="ident" id="4900950">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900957">rr</span><span class="op" id="4900959">.</span><span class="ident" id="4900960">ContentLength</span>&nbsp;<span class="op" id="4900974">=</span>&nbsp;<span class="ident" id="4900976">t</span><span class="op" id="4900977">.</span><span class="ident" id="4900978">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4900994">rr</span><span class="op" id="4900996">.</span><span class="ident" id="4900997">TransferEncoding</span>&nbsp;<span class="op" id="4901014">=</span>&nbsp;<span class="ident" id="4901016">t</span><span class="op" id="4901017">.</span><span class="ident" id="4901018">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901037">rr</span><span class="op" id="4901039">.</span><span class="ident" id="4901040">Close</span>&nbsp;<span class="op" id="4901046">=</span>&nbsp;<span class="ident" id="4901048">t</span><span class="op" id="4901049">.</span><span class="ident" id="4901050">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901058">rr</span><span class="op" id="4901060">.</span><span class="ident" id="4901061">Trailer</span>&nbsp;<span class="op" id="4901069">=</span>&nbsp;<span class="ident" id="4901071">t</span><span class="op" id="4901072">.</span><span class="ident" id="4901073">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4901082">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4901086">return</span>&nbsp;<span class="ident" id="4901093">nil</span><br>
<span class="lineno"></span><span class="op" id="4901097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4901100">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="4901157">func</span>&nbsp;<span class="ident" id="4901162">chunked</span><span class="op" id="4901169">(</span><span class="ident" id="4901170">te</span>&nbsp;<span class="op" id="4901173">[</span><span class="op" id="4901174">]</span><span class="builtintype" id="4901175">string</span><span class="op" id="4901181">)</span>&nbsp;<span class="builtintype" id="4901183">bool</span>&nbsp;<span class="op" id="4901188">{</span>&nbsp;<span class="keyword" id="4901190">return</span>&nbsp;<span class="builtinfunc" id="4901197">len</span><span class="op" id="4901200">(</span><span class="ident" id="4901201">te</span><span class="op" id="4901203">)</span>&nbsp;<span class="op" id="4901205">&gt;</span>&nbsp;<span class="num" id="4901207">0</span>&nbsp;<span class="op" id="4901209">&amp;&amp;</span>&nbsp;<span class="ident" id="4901212">te</span><span class="op" id="4901214">[</span><span class="num" id="4901215">0</span><span class="op" id="4901216">]</span>&nbsp;<span class="op" id="4901218">==</span>&nbsp;<span class="string" id="4901221">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4901231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4901234">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4901291">func</span>&nbsp;<span class="ident" id="4901296">isIdentity</span><span class="op" id="4901306">(</span><span class="ident" id="4901307">te</span>&nbsp;<span class="op" id="4901310">[</span><span class="op" id="4901311">]</span><span class="builtintype" id="4901312">string</span><span class="op" id="4901318">)</span>&nbsp;<span class="builtintype" id="4901320">bool</span>&nbsp;<span class="op" id="4901325">{</span>&nbsp;<span class="keyword" id="4901327">return</span>&nbsp;<span class="builtinfunc" id="4901334">len</span><span class="op" id="4901337">(</span><span class="ident" id="4901338">te</span><span class="op" id="4901340">)</span>&nbsp;<span class="op" id="4901342">==</span>&nbsp;<span class="num" id="4901345">1</span>&nbsp;<span class="op" id="4901347">&amp;&amp;</span>&nbsp;<span class="ident" id="4901350">te</span><span class="op" id="4901352">[</span><span class="num" id="4901353">0</span><span class="op" id="4901354">]</span>&nbsp;<span class="op" id="4901356">==</span>&nbsp;<span class="string" id="4901359">&#34;identity&#34;</span>&nbsp;<span class="op" id="4901370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4901373">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="4901403">func</span>&nbsp;<span class="ident" id="4901408">fixTransferEncoding</span><span class="op" id="4901427">(</span><span class="ident" id="4901428">requestMethod</span>&nbsp;<span class="builtintype" id="4901442">string</span><span class="op" id="4901448">,</span>&nbsp;<span class="ident" id="4901450">header</span>&nbsp;<span class="ident" id="4901457">Header</span><span class="op" id="4901463">)</span>&nbsp;<span class="op" id="4901465">(</span><span class="op" id="4901466">[</span><span class="op" id="4901467">]</span><span class="builtintype" id="4901468">string</span><span class="op" id="4901474">,</span>&nbsp;<span class="builtintype" id="4901476">error</span><span class="op" id="4901481">)</span>&nbsp;<span class="op" id="4901483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901486">raw</span><span class="op" id="4901489">,</span>&nbsp;<span class="ident" id="4901491">present</span>&nbsp;<span class="op" id="4901499">:=</span>&nbsp;<span class="ident" id="4901502">header</span><span class="op" id="4901508">[</span><span class="string" id="4901509">&#34;Transfer-Encoding&#34;</span><span class="op" id="4901528">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4901531">if</span>&nbsp;<span class="op" id="4901534">!</span><span class="ident" id="4901535">present</span>&nbsp;<span class="op" id="4901543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4901547">return</span>&nbsp;<span class="ident" id="4901554">nil</span><span class="op" id="4901557">,</span>&nbsp;<span class="ident" id="4901559">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4901564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4901568">delete</span><span class="op" id="4901574">(</span><span class="ident" id="4901575">header</span><span class="op" id="4901581">,</span>&nbsp;<span class="string" id="4901583">&#34;Transfer-Encoding&#34;</span><span class="op" id="4901602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901606">encodings</span>&nbsp;<span class="op" id="4901616">:=</span>&nbsp;<span class="ident" id="4901619">strings</span><span class="op" id="4901626">.</span><span class="ident" id="4901627">Split</span><span class="op" id="4901632">(</span><span class="ident" id="4901633">raw</span><span class="op" id="4901636">[</span><span class="num" id="4901637">0</span><span class="op" id="4901638">]</span><span class="op" id="4901639">,</span>&nbsp;<span class="string" id="4901641">&#34;,&#34;</span><span class="op" id="4901644">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901647">te</span>&nbsp;<span class="op" id="4901650">:=</span>&nbsp;<span class="builtinfunc" id="4901653">make</span><span class="op" id="4901657">(</span><span class="op" id="4901658">[</span><span class="op" id="4901659">]</span><span class="builtintype" id="4901660">string</span><span class="op" id="4901666">,</span>&nbsp;<span class="num" id="4901668">0</span><span class="op" id="4901669">,</span>&nbsp;<span class="builtinfunc" id="4901671">len</span><span class="op" id="4901674">(</span><span class="ident" id="4901675">encodings</span><span class="op" id="4901684">)</span><span class="op" id="4901685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901688">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901751">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901813">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4901872">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4901917">for</span>&nbsp;<span class="ident" id="4901921">_</span><span class="op" id="4901922">,</span>&nbsp;<span class="ident" id="4901924">encoding</span>&nbsp;<span class="op" id="4901933">:=</span>&nbsp;<span class="keyword" id="4901936">range</span>&nbsp;<span class="ident" id="4901942">encodings</span>&nbsp;<span class="op" id="4901952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4901956">encoding</span>&nbsp;<span class="op" id="4901965">=</span>&nbsp;<span class="ident" id="4901967">strings</span><span class="op" id="4901974">.</span><span class="ident" id="4901975">ToLower</span><span class="op" id="4901982">(</span><span class="ident" id="4901983">strings</span><span class="op" id="4901990">.</span><span class="ident" id="4901991">TrimSpace</span><span class="op" id="4902000">(</span><span class="ident" id="4902001">encoding</span><span class="op" id="4902009">)</span><span class="op" id="4902010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4902014">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902055">if</span>&nbsp;<span class="ident" id="4902058">encoding</span>&nbsp;<span class="op" id="4902067">==</span>&nbsp;<span class="string" id="4902070">&#34;identity&#34;</span>&nbsp;<span class="op" id="4902081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902086">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902098">if</span>&nbsp;<span class="ident" id="4902101">encoding</span>&nbsp;<span class="op" id="4902110">!=</span>&nbsp;<span class="string" id="4902113">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4902123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902128">return</span>&nbsp;<span class="ident" id="4902135">nil</span><span class="op" id="4902138">,</span>&nbsp;<span class="op" id="4902140">&amp;</span><span class="ident" id="4902141">badStringError</span><span class="op" id="4902155">{</span><span class="string" id="4902156">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="4902187">,</span>&nbsp;<span class="ident" id="4902189">encoding</span><span class="op" id="4902197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902205">te</span>&nbsp;<span class="op" id="4902208">=</span>&nbsp;<span class="ident" id="4902210">te</span><span class="op" id="4902212">[</span><span class="num" id="4902213">0</span>&nbsp;<span class="op" id="4902215">:</span>&nbsp;<span class="builtinfunc" id="4902217">len</span><span class="op" id="4902220">(</span><span class="ident" id="4902221">te</span><span class="op" id="4902223">)</span><span class="op" id="4902224">+</span><span class="num" id="4902225">1</span><span class="op" id="4902226">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4902230">te</span><span class="op" id="4902232">[</span><span class="builtinfunc" id="4902233">len</span><span class="op" id="4902236">(</span><span class="ident" id="4902237">te</span><span class="op" id="4902239">)</span><span class="op" id="4902240">-</span><span class="num" id="4902241">1</span><span class="op" id="4902242">]</span>&nbsp;<span class="op" id="4902244">=</span>&nbsp;<span class="ident" id="4902246">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902259">if</span>&nbsp;<span class="builtinfunc" id="4902262">len</span><span class="op" id="4902265">(</span><span class="ident" id="4902266">te</span><span class="op" id="4902268">)</span>&nbsp;<span class="op" id="4902270">&gt;</span>&nbsp;<span class="num" id="4902272">1</span>&nbsp;<span class="op" id="4902274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902278">return</span>&nbsp;<span class="ident" id="4902285">nil</span><span class="op" id="4902288">,</span>&nbsp;<span class="op" id="4902290">&amp;</span><span class="ident" id="4902291">badStringError</span><span class="op" id="4902305">{</span><span class="string" id="4902306">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="4902335">,</span>&nbsp;<span class="ident" id="4902337">strings</span><span class="op" id="4902344">.</span><span class="ident" id="4902345">Join</span><span class="op" id="4902349">(</span><span class="ident" id="4902350">te</span><span class="op" id="4902352">,</span>&nbsp;<span class="string" id="4902354">&#34;,&#34;</span><span class="op" id="4902357">)</span><span class="op" id="4902358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902361">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902364">if</span>&nbsp;<span class="builtinfunc" id="4902367">len</span><span class="op" id="4902370">(</span><span class="ident" id="4902371">te</span><span class="op" id="4902373">)</span>&nbsp;<span class="op" id="4902375">&gt;</span>&nbsp;<span class="num" id="4902377">0</span>&nbsp;<span class="op" id="4902379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4902383">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4902441">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4902497">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4902512">delete</span><span class="op" id="4902518">(</span><span class="ident" id="4902519">header</span><span class="op" id="4902525">,</span>&nbsp;<span class="string" id="4902527">&#34;Content-Length&#34;</span><span class="op" id="4902543">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902547">return</span>&nbsp;<span class="ident" id="4902554">te</span><span class="op" id="4902556">,</span>&nbsp;<span class="ident" id="4902558">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902567">return</span>&nbsp;<span class="ident" id="4902574">nil</span><span class="op" id="4902577">,</span>&nbsp;<span class="ident" id="4902579">nil</span><br>
<span class="lineno"></span><span class="op" id="4902583">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4902586">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="4902658">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4902729">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="4902762">func</span>&nbsp;<span class="ident" id="4902767">fixLength</span><span class="op" id="4902776">(</span><span class="ident" id="4902777">isResponse</span>&nbsp;<span class="builtintype" id="4902788">bool</span><span class="op" id="4902792">,</span>&nbsp;<span class="ident" id="4902794">status</span>&nbsp;<span class="builtintype" id="4902801">int</span><span class="op" id="4902804">,</span>&nbsp;<span class="ident" id="4902806">requestMethod</span>&nbsp;<span class="builtintype" id="4902820">string</span><span class="op" id="4902826">,</span>&nbsp;<span class="ident" id="4902828">header</span>&nbsp;<span class="ident" id="4902835">Header</span><span class="op" id="4902841">,</span>&nbsp;<span class="ident" id="4902843">te</span>&nbsp;<span class="op" id="4902846">[</span><span class="op" id="4902847">]</span><span class="builtintype" id="4902848">string</span><span class="op" id="4902854">)</span>&nbsp;<span class="op" id="4902856">(</span><span class="ident" id="4902857">int64</span><span class="op" id="4902862">,</span>&nbsp;<span class="builtintype" id="4902864">error</span><span class="op" id="4902869">)</span>&nbsp;<span class="op" id="4902871">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4902875">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902918">if</span>&nbsp;<span class="ident" id="4902921">noBodyExpected</span><span class="op" id="4902935">(</span><span class="ident" id="4902936">requestMethod</span><span class="op" id="4902949">)</span>&nbsp;<span class="op" id="4902951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902955">return</span>&nbsp;<span class="num" id="4902962">0</span><span class="op" id="4902963">,</span>&nbsp;<span class="ident" id="4902965">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4902970">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902973">if</span>&nbsp;<span class="ident" id="4902976">status</span><span class="op" id="4902982">/</span><span class="num" id="4902983">100</span>&nbsp;<span class="op" id="4902987">==</span>&nbsp;<span class="num" id="4902990">1</span>&nbsp;<span class="op" id="4902992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4902996">return</span>&nbsp;<span class="num" id="4903003">0</span><span class="op" id="4903004">,</span>&nbsp;<span class="ident" id="4903006">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903014">switch</span>&nbsp;<span class="ident" id="4903021">status</span>&nbsp;<span class="op" id="4903028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903031">case</span>&nbsp;<span class="num" id="4903036">204</span><span class="op" id="4903039">,</span>&nbsp;<span class="num" id="4903041">304</span><span class="op" id="4903044">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903048">return</span>&nbsp;<span class="num" id="4903055">0</span><span class="op" id="4903056">,</span>&nbsp;<span class="ident" id="4903058">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903067">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903104">if</span>&nbsp;<span class="ident" id="4903107">chunked</span><span class="op" id="4903114">(</span><span class="ident" id="4903115">te</span><span class="op" id="4903117">)</span>&nbsp;<span class="op" id="4903119">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903123">return</span>&nbsp;<span class="op" id="4903130">-</span><span class="num" id="4903131">1</span><span class="op" id="4903132">,</span>&nbsp;<span class="ident" id="4903134">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903143">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903177">cl</span>&nbsp;<span class="op" id="4903180">:=</span>&nbsp;<span class="ident" id="4903183">strings</span><span class="op" id="4903190">.</span><span class="ident" id="4903191">TrimSpace</span><span class="op" id="4903200">(</span><span class="ident" id="4903201">header</span><span class="op" id="4903207">.</span><span class="ident" id="4903208">get</span><span class="op" id="4903211">(</span><span class="string" id="4903212">&#34;Content-Length&#34;</span><span class="op" id="4903228">)</span><span class="op" id="4903229">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903232">if</span>&nbsp;<span class="ident" id="4903235">cl</span>&nbsp;<span class="op" id="4903238">!=</span>&nbsp;<span class="string" id="4903241">&#34;&#34;</span>&nbsp;<span class="op" id="4903244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903248">n</span><span class="op" id="4903249">,</span>&nbsp;<span class="ident" id="4903251">err</span>&nbsp;<span class="op" id="4903255">:=</span>&nbsp;<span class="ident" id="4903258">parseContentLength</span><span class="op" id="4903276">(</span><span class="ident" id="4903277">cl</span><span class="op" id="4903279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903283">if</span>&nbsp;<span class="ident" id="4903286">err</span>&nbsp;<span class="op" id="4903290">!=</span>&nbsp;<span class="ident" id="4903293">nil</span>&nbsp;<span class="op" id="4903297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903302">return</span>&nbsp;<span class="op" id="4903309">-</span><span class="num" id="4903310">1</span><span class="op" id="4903311">,</span>&nbsp;<span class="ident" id="4903313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903319">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903323">return</span>&nbsp;<span class="ident" id="4903330">n</span><span class="op" id="4903331">,</span>&nbsp;<span class="ident" id="4903333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903338">}</span>&nbsp;<span class="keyword" id="4903340">else</span>&nbsp;<span class="op" id="4903345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903349">header</span><span class="op" id="4903355">.</span><span class="ident" id="4903356">Del</span><span class="op" id="4903359">(</span><span class="string" id="4903360">&#34;Content-Length&#34;</span><span class="op" id="4903376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903383">if</span>&nbsp;<span class="op" id="4903386">!</span><span class="ident" id="4903387">isResponse</span>&nbsp;<span class="op" id="4903398">&amp;&amp;</span>&nbsp;<span class="ident" id="4903401">requestMethod</span>&nbsp;<span class="op" id="4903415">==</span>&nbsp;<span class="string" id="4903418">&#34;GET&#34;</span>&nbsp;<span class="op" id="4903424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903428">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903482">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903536">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903591">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903629">return</span>&nbsp;<span class="num" id="4903636">0</span><span class="op" id="4903637">,</span>&nbsp;<span class="ident" id="4903639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4903648">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903724">return</span>&nbsp;<span class="op" id="4903731">-</span><span class="num" id="4903732">1</span><span class="op" id="4903733">,</span>&nbsp;<span class="ident" id="4903735">nil</span><br>
<span class="lineno">500</span><span class="op" id="4903739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4903742">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4903811">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="4903844">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="4903879">func</span>&nbsp;<span class="ident" id="4903884">shouldClose</span><span class="op" id="4903895">(</span><span class="ident" id="4903896">major</span><span class="op" id="4903901">,</span>&nbsp;<span class="ident" id="4903903">minor</span>&nbsp;<span class="builtintype" id="4903909">int</span><span class="op" id="4903912">,</span>&nbsp;<span class="ident" id="4903914">header</span>&nbsp;<span class="ident" id="4903921">Header</span><span class="op" id="4903927">,</span>&nbsp;<span class="ident" id="4903929">removeCloseHeader</span>&nbsp;<span class="builtintype" id="4903947">bool</span><span class="op" id="4903951">)</span>&nbsp;<span class="builtintype" id="4903953">bool</span>&nbsp;<span class="op" id="4903958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903961">if</span>&nbsp;<span class="ident" id="4903964">major</span>&nbsp;<span class="op" id="4903970">&lt;</span>&nbsp;<span class="num" id="4903972">1</span>&nbsp;<span class="op" id="4903974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903978">return</span>&nbsp;<span class="builtintype" id="4903985">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4903991">}</span>&nbsp;<span class="keyword" id="4903993">else</span>&nbsp;<span class="keyword" id="4903998">if</span>&nbsp;<span class="ident" id="4904001">major</span>&nbsp;<span class="op" id="4904007">==</span>&nbsp;<span class="num" id="4904010">1</span>&nbsp;<span class="op" id="4904012">&amp;&amp;</span>&nbsp;<span class="ident" id="4904015">minor</span>&nbsp;<span class="op" id="4904021">==</span>&nbsp;<span class="num" id="4904024">0</span>&nbsp;<span class="op" id="4904026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904030">if</span>&nbsp;<span class="op" id="4904033">!</span><span class="ident" id="4904034">strings</span><span class="op" id="4904041">.</span><span class="ident" id="4904042">Contains</span><span class="op" id="4904050">(</span><span class="ident" id="4904051">strings</span><span class="op" id="4904058">.</span><span class="ident" id="4904059">ToLower</span><span class="op" id="4904066">(</span><span class="ident" id="4904067">header</span><span class="op" id="4904073">.</span><span class="ident" id="4904074">get</span><span class="op" id="4904077">(</span><span class="string" id="4904078">&#34;Connection&#34;</span><span class="op" id="4904090">)</span><span class="op" id="4904091">)</span><span class="op" id="4904092">,</span>&nbsp;<span class="string" id="4904094">&#34;keep-alive&#34;</span><span class="op" id="4904106">)</span>&nbsp;<span class="op" id="4904108">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904113">return</span>&nbsp;<span class="builtintype" id="4904120">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904131">return</span>&nbsp;<span class="builtintype" id="4904138">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904145">}</span>&nbsp;<span class="keyword" id="4904147">else</span>&nbsp;<span class="op" id="4904152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4904156">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4904221">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904248">if</span>&nbsp;<span class="ident" id="4904251">strings</span><span class="op" id="4904258">.</span><span class="ident" id="4904259">ToLower</span><span class="op" id="4904266">(</span><span class="ident" id="4904267">header</span><span class="op" id="4904273">.</span><span class="ident" id="4904274">get</span><span class="op" id="4904277">(</span><span class="string" id="4904278">&#34;Connection&#34;</span><span class="op" id="4904290">)</span><span class="op" id="4904291">)</span>&nbsp;<span class="op" id="4904293">==</span>&nbsp;<span class="string" id="4904296">&#34;close&#34;</span>&nbsp;<span class="op" id="4904304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904309">if</span>&nbsp;<span class="ident" id="4904312">removeCloseHeader</span>&nbsp;<span class="op" id="4904330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904336">header</span><span class="op" id="4904342">.</span><span class="ident" id="4904343">Del</span><span class="op" id="4904346">(</span><span class="string" id="4904347">&#34;Connection&#34;</span><span class="op" id="4904359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904364">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904369">return</span>&nbsp;<span class="builtintype" id="4904376">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904389">return</span>&nbsp;<span class="builtintype" id="4904396">false</span><br>
<span class="lineno"></span><span class="op" id="4904402">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="4904405">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4904433">func</span>&nbsp;<span class="ident" id="4904438">fixTrailer</span><span class="op" id="4904448">(</span><span class="ident" id="4904449">header</span>&nbsp;<span class="ident" id="4904456">Header</span><span class="op" id="4904462">,</span>&nbsp;<span class="ident" id="4904464">te</span>&nbsp;<span class="op" id="4904467">[</span><span class="op" id="4904468">]</span><span class="builtintype" id="4904469">string</span><span class="op" id="4904475">)</span>&nbsp;<span class="op" id="4904477">(</span><span class="ident" id="4904478">Header</span><span class="op" id="4904484">,</span>&nbsp;<span class="builtintype" id="4904486">error</span><span class="op" id="4904491">)</span>&nbsp;<span class="op" id="4904493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904496">raw</span>&nbsp;<span class="op" id="4904500">:=</span>&nbsp;<span class="ident" id="4904503">header</span><span class="op" id="4904509">.</span><span class="ident" id="4904510">get</span><span class="op" id="4904513">(</span><span class="string" id="4904514">&#34;Trailer&#34;</span><span class="op" id="4904523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904526">if</span>&nbsp;<span class="ident" id="4904529">raw</span>&nbsp;<span class="op" id="4904533">==</span>&nbsp;<span class="string" id="4904536">&#34;&#34;</span>&nbsp;<span class="op" id="4904539">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904543">return</span>&nbsp;<span class="ident" id="4904550">nil</span><span class="op" id="4904553">,</span>&nbsp;<span class="ident" id="4904555">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904564">header</span><span class="op" id="4904570">.</span><span class="ident" id="4904571">Del</span><span class="op" id="4904574">(</span><span class="string" id="4904575">&#34;Trailer&#34;</span><span class="op" id="4904584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904587">trailer</span>&nbsp;<span class="op" id="4904595">:=</span>&nbsp;<span class="builtinfunc" id="4904598">make</span><span class="op" id="4904602">(</span><span class="ident" id="4904603">Header</span><span class="op" id="4904609">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904612">keys</span>&nbsp;<span class="op" id="4904617">:=</span>&nbsp;<span class="ident" id="4904620">strings</span><span class="op" id="4904627">.</span><span class="ident" id="4904628">Split</span><span class="op" id="4904633">(</span><span class="ident" id="4904634">raw</span><span class="op" id="4904637">,</span>&nbsp;<span class="string" id="4904639">&#34;,&#34;</span><span class="op" id="4904642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904645">for</span>&nbsp;<span class="ident" id="4904649">_</span><span class="op" id="4904650">,</span>&nbsp;<span class="ident" id="4904652">key</span>&nbsp;<span class="op" id="4904656">:=</span>&nbsp;<span class="keyword" id="4904659">range</span>&nbsp;<span class="ident" id="4904665">keys</span>&nbsp;<span class="op" id="4904670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904674">key</span>&nbsp;<span class="op" id="4904678">=</span>&nbsp;<span class="ident" id="4904680">CanonicalHeaderKey</span><span class="op" id="4904698">(</span><span class="ident" id="4904699">strings</span><span class="op" id="4904706">.</span><span class="ident" id="4904707">TrimSpace</span><span class="op" id="4904716">(</span><span class="ident" id="4904717">key</span><span class="op" id="4904720">)</span><span class="op" id="4904721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904725">switch</span>&nbsp;<span class="ident" id="4904732">key</span>&nbsp;<span class="op" id="4904736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904740">case</span>&nbsp;<span class="string" id="4904745">&#34;Transfer-Encoding&#34;</span><span class="op" id="4904764">,</span>&nbsp;<span class="string" id="4904766">&#34;Trailer&#34;</span><span class="op" id="4904775">,</span>&nbsp;<span class="string" id="4904777">&#34;Content-Length&#34;</span><span class="op" id="4904793">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904798">return</span>&nbsp;<span class="ident" id="4904805">nil</span><span class="op" id="4904808">,</span>&nbsp;<span class="op" id="4904810">&amp;</span><span class="ident" id="4904811">badStringError</span><span class="op" id="4904825">{</span><span class="string" id="4904826">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="4904843">,</span>&nbsp;<span class="ident" id="4904845">key</span><span class="op" id="4904848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904856">trailer</span><span class="op" id="4904863">[</span><span class="ident" id="4904864">key</span><span class="op" id="4904867">]</span>&nbsp;<span class="op" id="4904869">=</span>&nbsp;<span class="ident" id="4904871">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904879">if</span>&nbsp;<span class="builtinfunc" id="4904882">len</span><span class="op" id="4904885">(</span><span class="ident" id="4904886">trailer</span><span class="op" id="4904893">)</span>&nbsp;<span class="op" id="4904895">==</span>&nbsp;<span class="num" id="4904898">0</span>&nbsp;<span class="op" id="4904900">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904904">return</span>&nbsp;<span class="ident" id="4904911">nil</span><span class="op" id="4904914">,</span>&nbsp;<span class="ident" id="4904916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4904921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904924">if</span>&nbsp;<span class="op" id="4904927">!</span><span class="ident" id="4904928">chunked</span><span class="op" id="4904935">(</span><span class="ident" id="4904936">te</span><span class="op" id="4904938">)</span>&nbsp;<span class="op" id="4904940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4904944">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904973">return</span>&nbsp;<span class="ident" id="4904980">nil</span><span class="op" id="4904983">,</span>&nbsp;<span class="ident" id="4904985">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905010">return</span>&nbsp;<span class="ident" id="4905017">trailer</span><span class="op" id="4905024">,</span>&nbsp;<span class="ident" id="4905026">nil</span><br>
<span class="lineno"></span><span class="op" id="4905030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4905033">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="4905075">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="4905126">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4905170">type</span>&nbsp;<span class="ident" id="4905175">body</span>&nbsp;<span class="keyword" id="4905180">struct</span>&nbsp;<span class="op" id="4905187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905190">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4905198">io</span><span class="op" id="4905200">.</span><span class="ident" id="4905201">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905209">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4905217">interface</span><span class="op" id="4905226">{</span><span class="op" id="4905227">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4905231">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905290">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4905298">*</span><span class="ident" id="4905299">bufio</span><span class="op" id="4905304">.</span><span class="ident" id="4905305">Reader</span>&nbsp;<span class="comment" id="4905312">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905362">closing</span>&nbsp;<span class="builtintype" id="4905370">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4905384">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905440">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4905447">sync</span><span class="op" id="4905451">.</span><span class="ident" id="4905452">Mutex</span>&nbsp;<span class="comment" id="4905458">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905505">closed</span>&nbsp;<span class="builtintype" id="4905512">bool</span><br>
<span class="lineno">565</span><span class="op" id="4905517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4905520">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4905592">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4905672">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="4905736">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4905755">var</span>&nbsp;<span class="ident" id="4905759">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="4905781">=</span>&nbsp;<span class="ident" id="4905783">errors</span><span class="op" id="4905789">.</span><span class="ident" id="4905790">New</span><span class="op" id="4905793">(</span><span class="string" id="4905794">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="4905829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4905832">func</span>&nbsp;<span class="op" id="4905837">(</span><span class="ident" id="4905838">b</span>&nbsp;<span class="op" id="4905840">*</span><span class="ident" id="4905841">body</span><span class="op" id="4905845">)</span>&nbsp;<span class="ident" id="4905847">Read</span><span class="op" id="4905851">(</span><span class="ident" id="4905852">p</span>&nbsp;<span class="op" id="4905854">[</span><span class="op" id="4905855">]</span><span class="builtintype" id="4905856">byte</span><span class="op" id="4905860">)</span>&nbsp;<span class="op" id="4905862">(</span><span class="ident" id="4905863">n</span>&nbsp;<span class="builtintype" id="4905865">int</span><span class="op" id="4905868">,</span>&nbsp;<span class="ident" id="4905870">err</span>&nbsp;<span class="builtintype" id="4905874">error</span><span class="op" id="4905879">)</span>&nbsp;<span class="op" id="4905881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905884">b</span><span class="op" id="4905885">.</span><span class="ident" id="4905886">mu</span><span class="op" id="4905888">.</span><span class="ident" id="4905889">Lock</span><span class="op" id="4905893">(</span><span class="op" id="4905894">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905897">defer</span>&nbsp;<span class="ident" id="4905903">b</span><span class="op" id="4905904">.</span><span class="ident" id="4905905">mu</span><span class="op" id="4905907">.</span><span class="ident" id="4905908">Unlock</span><span class="op" id="4905914">(</span><span class="op" id="4905915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905918">if</span>&nbsp;<span class="ident" id="4905921">b</span><span class="op" id="4905922">.</span><span class="ident" id="4905923">closed</span>&nbsp;<span class="op" id="4905930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905934">return</span>&nbsp;<span class="num" id="4905941">0</span><span class="op" id="4905942">,</span>&nbsp;<span class="ident" id="4905944">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905970">return</span>&nbsp;<span class="ident" id="4905977">b</span><span class="op" id="4905978">.</span><span class="ident" id="4905979">readLocked</span><span class="op" id="4905989">(</span><span class="ident" id="4905990">p</span><span class="op" id="4905991">)</span><br>
<span class="lineno">580</span><span class="op" id="4905993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4905996">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4906015">func</span>&nbsp;<span class="op" id="4906020">(</span><span class="ident" id="4906021">b</span>&nbsp;<span class="op" id="4906023">*</span><span class="ident" id="4906024">body</span><span class="op" id="4906028">)</span>&nbsp;<span class="ident" id="4906030">readLocked</span><span class="op" id="4906040">(</span><span class="ident" id="4906041">p</span>&nbsp;<span class="op" id="4906043">[</span><span class="op" id="4906044">]</span><span class="builtintype" id="4906045">byte</span><span class="op" id="4906049">)</span>&nbsp;<span class="op" id="4906051">(</span><span class="ident" id="4906052">n</span>&nbsp;<span class="builtintype" id="4906054">int</span><span class="op" id="4906057">,</span>&nbsp;<span class="ident" id="4906059">err</span>&nbsp;<span class="builtintype" id="4906063">error</span><span class="op" id="4906068">)</span>&nbsp;<span class="op" id="4906070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906073">n</span><span class="op" id="4906074">,</span>&nbsp;<span class="ident" id="4906076">err</span>&nbsp;<span class="op" id="4906080">=</span>&nbsp;<span class="ident" id="4906082">b</span><span class="op" id="4906083">.</span><span class="ident" id="4906084">src</span><span class="op" id="4906087">.</span><span class="ident" id="4906088">Read</span><span class="op" id="4906092">(</span><span class="ident" id="4906093">p</span><span class="op" id="4906094">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906098">if</span>&nbsp;<span class="ident" id="4906101">err</span>&nbsp;<span class="op" id="4906105">==</span>&nbsp;<span class="ident" id="4906108">io</span><span class="op" id="4906110">.</span><span class="ident" id="4906111">EOF</span>&nbsp;<span class="op" id="4906115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906119">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906156">if</span>&nbsp;<span class="ident" id="4906159">b</span><span class="op" id="4906160">.</span><span class="ident" id="4906161">hdr</span>&nbsp;<span class="op" id="4906165">!=</span>&nbsp;<span class="ident" id="4906168">nil</span>&nbsp;<span class="op" id="4906172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906177">if</span>&nbsp;<span class="ident" id="4906180">e</span>&nbsp;<span class="op" id="4906182">:=</span>&nbsp;<span class="ident" id="4906185">b</span><span class="op" id="4906186">.</span><span class="ident" id="4906187">readTrailer</span><span class="op" id="4906198">(</span><span class="op" id="4906199">)</span><span class="op" id="4906200">;</span>&nbsp;<span class="ident" id="4906202">e</span>&nbsp;<span class="op" id="4906204">!=</span>&nbsp;<span class="ident" id="4906207">nil</span>&nbsp;<span class="op" id="4906211">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906217">err</span>&nbsp;<span class="op" id="4906221">=</span>&nbsp;<span class="ident" id="4906223">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906233">b</span><span class="op" id="4906234">.</span><span class="ident" id="4906235">hdr</span>&nbsp;<span class="op" id="4906239">=</span>&nbsp;<span class="ident" id="4906241">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906247">}</span>&nbsp;<span class="keyword" id="4906249">else</span>&nbsp;<span class="op" id="4906254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906259">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906336">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906395">if</span>&nbsp;<span class="ident" id="4906398">lr</span><span class="op" id="4906400">,</span>&nbsp;<span class="ident" id="4906402">ok</span>&nbsp;<span class="op" id="4906405">:=</span>&nbsp;<span class="ident" id="4906408">b</span><span class="op" id="4906409">.</span><span class="ident" id="4906410">src</span><span class="op" id="4906413">.</span><span class="op" id="4906414">(</span><span class="op" id="4906415">*</span><span class="ident" id="4906416">io</span><span class="op" id="4906418">.</span><span class="ident" id="4906419">LimitedReader</span><span class="op" id="4906432">)</span><span class="op" id="4906433">;</span>&nbsp;<span class="ident" id="4906435">ok</span>&nbsp;<span class="op" id="4906438">&amp;&amp;</span>&nbsp;<span class="ident" id="4906441">lr</span><span class="op" id="4906443">.</span><span class="ident" id="4906444">N</span>&nbsp;<span class="op" id="4906446">&gt;</span>&nbsp;<span class="num" id="4906448">0</span>&nbsp;<span class="op" id="4906450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906456">err</span>&nbsp;<span class="op" id="4906460">=</span>&nbsp;<span class="ident" id="4906462">io</span><span class="op" id="4906464">.</span><span class="ident" id="4906465">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906489">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906496">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906558">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906621">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906681">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906742">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906787">if</span>&nbsp;<span class="ident" id="4906790">err</span>&nbsp;<span class="op" id="4906794">==</span>&nbsp;<span class="ident" id="4906797">nil</span>&nbsp;<span class="op" id="4906801">&amp;&amp;</span>&nbsp;<span class="ident" id="4906804">n</span>&nbsp;<span class="op" id="4906806">&gt;</span>&nbsp;<span class="num" id="4906808">0</span>&nbsp;<span class="op" id="4906810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906814">if</span>&nbsp;<span class="ident" id="4906817">lr</span><span class="op" id="4906819">,</span>&nbsp;<span class="ident" id="4906821">ok</span>&nbsp;<span class="op" id="4906824">:=</span>&nbsp;<span class="ident" id="4906827">b</span><span class="op" id="4906828">.</span><span class="ident" id="4906829">src</span><span class="op" id="4906832">.</span><span class="op" id="4906833">(</span><span class="op" id="4906834">*</span><span class="ident" id="4906835">io</span><span class="op" id="4906837">.</span><span class="ident" id="4906838">LimitedReader</span><span class="op" id="4906851">)</span><span class="op" id="4906852">;</span>&nbsp;<span class="ident" id="4906854">ok</span>&nbsp;<span class="op" id="4906857">&amp;&amp;</span>&nbsp;<span class="ident" id="4906860">lr</span><span class="op" id="4906862">.</span><span class="ident" id="4906863">N</span>&nbsp;<span class="op" id="4906865">==</span>&nbsp;<span class="num" id="4906868">0</span>&nbsp;<span class="op" id="4906870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906875">err</span>&nbsp;<span class="op" id="4906879">=</span>&nbsp;<span class="ident" id="4906881">io</span><span class="op" id="4906883">.</span><span class="ident" id="4906884">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906897">return</span>&nbsp;<span class="ident" id="4906904">n</span><span class="op" id="4906905">,</span>&nbsp;<span class="ident" id="4906907">err</span><br>
<span class="lineno"></span><span class="op" id="4906911">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="4906914">var</span>&nbsp;<span class="op" id="4906918">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906921">singleCRLF</span>&nbsp;<span class="op" id="4906932">=</span>&nbsp;<span class="op" id="4906934">[</span><span class="op" id="4906935">]</span><span class="builtintype" id="4906936">byte</span><span class="op" id="4906940">(</span><span class="string" id="4906941">&#34;\r\n&#34;</span><span class="op" id="4906947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906950">doubleCRLF</span>&nbsp;<span class="op" id="4906961">=</span>&nbsp;<span class="op" id="4906963">[</span><span class="op" id="4906964">]</span><span class="builtintype" id="4906965">byte</span><span class="op" id="4906969">(</span><span class="string" id="4906970">&#34;\r\n\r\n&#34;</span><span class="op" id="4906980">)</span><br>
<span class="lineno"></span><span class="op" id="4906982">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="4906985">func</span>&nbsp;<span class="ident" id="4906990">seeUpcomingDoubleCRLF</span><span class="op" id="4907011">(</span><span class="ident" id="4907012">r</span>&nbsp;<span class="op" id="4907014">*</span><span class="ident" id="4907015">bufio</span><span class="op" id="4907020">.</span><span class="ident" id="4907021">Reader</span><span class="op" id="4907027">)</span>&nbsp;<span class="builtintype" id="4907029">bool</span>&nbsp;<span class="op" id="4907034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907037">for</span>&nbsp;<span class="ident" id="4907041">peekSize</span>&nbsp;<span class="op" id="4907050">:=</span>&nbsp;<span class="num" id="4907053">4</span><span class="op" id="4907054">;</span>&nbsp;<span class="op" id="4907056">;</span>&nbsp;<span class="ident" id="4907058">peekSize</span><span class="op" id="4907066">++</span>&nbsp;<span class="op" id="4907069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907073">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907122">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907174">buf</span><span class="op" id="4907177">,</span>&nbsp;<span class="ident" id="4907179">err</span>&nbsp;<span class="op" id="4907183">:=</span>&nbsp;<span class="ident" id="4907186">r</span><span class="op" id="4907187">.</span><span class="ident" id="4907188">Peek</span><span class="op" id="4907192">(</span><span class="ident" id="4907193">peekSize</span><span class="op" id="4907201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907205">if</span>&nbsp;<span class="ident" id="4907208">bytes</span><span class="op" id="4907213">.</span><span class="ident" id="4907214">HasSuffix</span><span class="op" id="4907223">(</span><span class="ident" id="4907224">buf</span><span class="op" id="4907227">,</span>&nbsp;<span class="ident" id="4907229">doubleCRLF</span><span class="op" id="4907239">)</span>&nbsp;<span class="op" id="4907241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907246">return</span>&nbsp;<span class="builtintype" id="4907253">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907264">if</span>&nbsp;<span class="ident" id="4907267">err</span>&nbsp;<span class="op" id="4907271">!=</span>&nbsp;<span class="ident" id="4907274">nil</span>&nbsp;<span class="op" id="4907278">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907283">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907297">return</span>&nbsp;<span class="builtintype" id="4907304">false</span><br>
<span class="lineno"></span><span class="op" id="4907310">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="4907313">var</span>&nbsp;<span class="ident" id="4907317">errTrailerEOF</span>&nbsp;<span class="op" id="4907331">=</span>&nbsp;<span class="ident" id="4907333">errors</span><span class="op" id="4907339">.</span><span class="ident" id="4907340">New</span><span class="op" id="4907343">(</span><span class="string" id="4907344">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="4907382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4907385">func</span>&nbsp;<span class="op" id="4907390">(</span><span class="ident" id="4907391">b</span>&nbsp;<span class="op" id="4907393">*</span><span class="ident" id="4907394">body</span><span class="op" id="4907398">)</span>&nbsp;<span class="ident" id="4907400">readTrailer</span><span class="op" id="4907411">(</span><span class="op" id="4907412">)</span>&nbsp;<span class="builtintype" id="4907414">error</span>&nbsp;<span class="op" id="4907420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907423">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907472">buf</span><span class="op" id="4907475">,</span>&nbsp;<span class="ident" id="4907477">err</span>&nbsp;<span class="op" id="4907481">:=</span>&nbsp;<span class="ident" id="4907484">b</span><span class="op" id="4907485">.</span><span class="ident" id="4907486">r</span><span class="op" id="4907487">.</span><span class="ident" id="4907488">Peek</span><span class="op" id="4907492">(</span><span class="num" id="4907493">2</span><span class="op" id="4907494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907497">if</span>&nbsp;<span class="ident" id="4907500">bytes</span><span class="op" id="4907505">.</span><span class="ident" id="4907506">Equal</span><span class="op" id="4907511">(</span><span class="ident" id="4907512">buf</span><span class="op" id="4907515">,</span>&nbsp;<span class="ident" id="4907517">singleCRLF</span><span class="op" id="4907527">)</span>&nbsp;<span class="op" id="4907529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907533">b</span><span class="op" id="4907534">.</span><span class="ident" id="4907535">r</span><span class="op" id="4907536">.</span><span class="ident" id="4907537">ReadByte</span><span class="op" id="4907545">(</span><span class="op" id="4907546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907550">b</span><span class="op" id="4907551">.</span><span class="ident" id="4907552">r</span><span class="op" id="4907553">.</span><span class="ident" id="4907554">ReadByte</span><span class="op" id="4907562">(</span><span class="op" id="4907563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907567">return</span>&nbsp;<span class="ident" id="4907574">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907582">if</span>&nbsp;<span class="builtinfunc" id="4907585">len</span><span class="op" id="4907588">(</span><span class="ident" id="4907589">buf</span><span class="op" id="4907592">)</span>&nbsp;<span class="op" id="4907594">&lt;</span>&nbsp;<span class="num" id="4907596">2</span>&nbsp;<span class="op" id="4907598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907602">return</span>&nbsp;<span class="ident" id="4907609">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907627">if</span>&nbsp;<span class="ident" id="4907630">err</span>&nbsp;<span class="op" id="4907634">!=</span>&nbsp;<span class="ident" id="4907637">nil</span>&nbsp;<span class="op" id="4907641">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907645">return</span>&nbsp;<span class="ident" id="4907652">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907661">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907725">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907785">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907849">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907911">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907975">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908039">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908102">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908176">if</span>&nbsp;<span class="op" id="4908179">!</span><span class="ident" id="4908180">seeUpcomingDoubleCRLF</span><span class="op" id="4908201">(</span><span class="ident" id="4908202">b</span><span class="op" id="4908203">.</span><span class="ident" id="4908204">r</span><span class="op" id="4908205">)</span>&nbsp;<span class="op" id="4908207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908211">return</span>&nbsp;<span class="ident" id="4908218">errors</span><span class="op" id="4908224">.</span><span class="ident" id="4908225">New</span><span class="op" id="4908228">(</span><span class="string" id="4908229">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="4908281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908288">hdr</span><span class="op" id="4908291">,</span>&nbsp;<span class="ident" id="4908293">err</span>&nbsp;<span class="op" id="4908297">:=</span>&nbsp;<span class="ident" id="4908300">textproto</span><span class="op" id="4908309">.</span><span class="ident" id="4908310">NewReader</span><span class="op" id="4908319">(</span><span class="ident" id="4908320">b</span><span class="op" id="4908321">.</span><span class="ident" id="4908322">r</span><span class="op" id="4908323">)</span><span class="op" id="4908324">.</span><span class="ident" id="4908325">ReadMIMEHeader</span><span class="op" id="4908339">(</span><span class="op" id="4908340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908343">if</span>&nbsp;<span class="ident" id="4908346">err</span>&nbsp;<span class="op" id="4908350">!=</span>&nbsp;<span class="ident" id="4908353">nil</span>&nbsp;<span class="op" id="4908357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908361">if</span>&nbsp;<span class="ident" id="4908364">err</span>&nbsp;<span class="op" id="4908368">==</span>&nbsp;<span class="ident" id="4908371">io</span><span class="op" id="4908373">.</span><span class="ident" id="4908374">EOF</span>&nbsp;<span class="op" id="4908378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908383">return</span>&nbsp;<span class="ident" id="4908390">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908406">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908410">return</span>&nbsp;<span class="ident" id="4908417">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908425">switch</span>&nbsp;<span class="ident" id="4908432">rr</span>&nbsp;<span class="op" id="4908435">:=</span>&nbsp;<span class="ident" id="4908438">b</span><span class="op" id="4908439">.</span><span class="ident" id="4908440">hdr</span><span class="op" id="4908443">.</span><span class="op" id="4908444">(</span><span class="keyword" id="4908445">type</span><span class="op" id="4908449">)</span>&nbsp;<span class="op" id="4908451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908454">case</span>&nbsp;<span class="op" id="4908459">*</span><span class="ident" id="4908460">Request</span><span class="op" id="4908467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908471">mergeSetHeader</span><span class="op" id="4908485">(</span><span class="op" id="4908486">&amp;</span><span class="ident" id="4908487">rr</span><span class="op" id="4908489">.</span><span class="ident" id="4908490">Trailer</span><span class="op" id="4908497">,</span>&nbsp;<span class="ident" id="4908499">Header</span><span class="op" id="4908505">(</span><span class="ident" id="4908506">hdr</span><span class="op" id="4908509">)</span><span class="op" id="4908510">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908513">case</span>&nbsp;<span class="op" id="4908518">*</span><span class="ident" id="4908519">Response</span><span class="op" id="4908527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908531">mergeSetHeader</span><span class="op" id="4908545">(</span><span class="op" id="4908546">&amp;</span><span class="ident" id="4908547">rr</span><span class="op" id="4908549">.</span><span class="ident" id="4908550">Trailer</span><span class="op" id="4908557">,</span>&nbsp;<span class="ident" id="4908559">Header</span><span class="op" id="4908565">(</span><span class="ident" id="4908566">hdr</span><span class="op" id="4908569">)</span><span class="op" id="4908570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908576">return</span>&nbsp;<span class="ident" id="4908583">nil</span><br>
<span class="lineno"></span><span class="op" id="4908587">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4908590">func</span>&nbsp;<span class="ident" id="4908595">mergeSetHeader</span><span class="op" id="4908609">(</span><span class="ident" id="4908610">dst</span>&nbsp;<span class="op" id="4908614">*</span><span class="ident" id="4908615">Header</span><span class="op" id="4908621">,</span>&nbsp;<span class="ident" id="4908623">src</span>&nbsp;<span class="ident" id="4908627">Header</span><span class="op" id="4908633">)</span>&nbsp;<span class="op" id="4908635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908638">if</span>&nbsp;<span class="op" id="4908641">*</span><span class="ident" id="4908642">dst</span>&nbsp;<span class="op" id="4908646">==</span>&nbsp;<span class="ident" id="4908649">nil</span>&nbsp;<span class="op" id="4908653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908657">*</span><span class="ident" id="4908658">dst</span>&nbsp;<span class="op" id="4908662">=</span>&nbsp;<span class="ident" id="4908664">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908670">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908681">for</span>&nbsp;<span class="ident" id="4908685">k</span><span class="op" id="4908686">,</span>&nbsp;<span class="ident" id="4908688">vv</span>&nbsp;<span class="op" id="4908691">:=</span>&nbsp;<span class="keyword" id="4908694">range</span>&nbsp;<span class="ident" id="4908700">src</span>&nbsp;<span class="op" id="4908704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908708">(</span><span class="op" id="4908709">*</span><span class="ident" id="4908710">dst</span><span class="op" id="4908713">)</span><span class="op" id="4908714">[</span><span class="ident" id="4908715">k</span><span class="op" id="4908716">]</span>&nbsp;<span class="op" id="4908718">=</span>&nbsp;<span class="ident" id="4908720">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908724">}</span><br>
<span class="lineno"></span><span class="op" id="4908726">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="4908729">func</span>&nbsp;<span class="op" id="4908734">(</span><span class="ident" id="4908735">b</span>&nbsp;<span class="op" id="4908737">*</span><span class="ident" id="4908738">body</span><span class="op" id="4908742">)</span>&nbsp;<span class="ident" id="4908744">Close</span><span class="op" id="4908749">(</span><span class="op" id="4908750">)</span>&nbsp;<span class="builtintype" id="4908752">error</span>&nbsp;<span class="op" id="4908758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908761">b</span><span class="op" id="4908762">.</span><span class="ident" id="4908763">mu</span><span class="op" id="4908765">.</span><span class="ident" id="4908766">Lock</span><span class="op" id="4908770">(</span><span class="op" id="4908771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908774">defer</span>&nbsp;<span class="ident" id="4908780">b</span><span class="op" id="4908781">.</span><span class="ident" id="4908782">mu</span><span class="op" id="4908784">.</span><span class="ident" id="4908785">Unlock</span><span class="op" id="4908791">(</span><span class="op" id="4908792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908795">if</span>&nbsp;<span class="ident" id="4908798">b</span><span class="op" id="4908799">.</span><span class="ident" id="4908800">closed</span>&nbsp;<span class="op" id="4908807">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908811">return</span>&nbsp;<span class="ident" id="4908818">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908826">var</span>&nbsp;<span class="ident" id="4908830">err</span>&nbsp;<span class="builtintype" id="4908834">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908841">switch</span>&nbsp;<span class="op" id="4908848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908851">case</span>&nbsp;<span class="ident" id="4908856">b</span><span class="op" id="4908857">.</span><span class="ident" id="4908858">hdr</span>&nbsp;<span class="op" id="4908862">==</span>&nbsp;<span class="ident" id="4908865">nil</span>&nbsp;<span class="op" id="4908869">&amp;&amp;</span>&nbsp;<span class="ident" id="4908872">b</span><span class="op" id="4908873">.</span><span class="ident" id="4908874">closing</span><span class="op" id="4908881">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908885">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908934">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908966">default</span><span class="op" id="4908973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908977">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909041">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909094">_</span><span class="op" id="4909095">,</span>&nbsp;<span class="ident" id="4909097">err</span>&nbsp;<span class="op" id="4909101">=</span>&nbsp;<span class="ident" id="4909103">io</span><span class="op" id="4909105">.</span><span class="ident" id="4909106">Copy</span><span class="op" id="4909110">(</span><span class="ident" id="4909111">ioutil</span><span class="op" id="4909117">.</span><span class="ident" id="4909118">Discard</span><span class="op" id="4909125">,</span>&nbsp;<span class="ident" id="4909127">bodyLocked</span><span class="op" id="4909137">{</span><span class="ident" id="4909138">b</span><span class="op" id="4909139">}</span><span class="op" id="4909140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909146">b</span><span class="op" id="4909147">.</span><span class="ident" id="4909148">closed</span>&nbsp;<span class="op" id="4909155">=</span>&nbsp;<span class="builtintype" id="4909157">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909163">return</span>&nbsp;<span class="ident" id="4909170">err</span><br>
<span class="lineno"></span><span class="op" id="4909174">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="4909177">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4909245">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="4909262">type</span>&nbsp;<span class="ident" id="4909267">bodyLocked</span>&nbsp;<span class="keyword" id="4909278">struct</span>&nbsp;<span class="op" id="4909285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909288">b</span>&nbsp;<span class="op" id="4909290">*</span><span class="ident" id="4909291">body</span><br>
<span class="lineno">715</span><span class="op" id="4909296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4909299">func</span>&nbsp;<span class="op" id="4909304">(</span><span class="ident" id="4909305">bl</span>&nbsp;<span class="ident" id="4909308">bodyLocked</span><span class="op" id="4909318">)</span>&nbsp;<span class="ident" id="4909320">Read</span><span class="op" id="4909324">(</span><span class="ident" id="4909325">p</span>&nbsp;<span class="op" id="4909327">[</span><span class="op" id="4909328">]</span><span class="builtintype" id="4909329">byte</span><span class="op" id="4909333">)</span>&nbsp;<span class="op" id="4909335">(</span><span class="ident" id="4909336">n</span>&nbsp;<span class="builtintype" id="4909338">int</span><span class="op" id="4909341">,</span>&nbsp;<span class="ident" id="4909343">err</span>&nbsp;<span class="builtintype" id="4909347">error</span><span class="op" id="4909352">)</span>&nbsp;<span class="op" id="4909354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909357">if</span>&nbsp;<span class="ident" id="4909360">bl</span><span class="op" id="4909362">.</span><span class="ident" id="4909363">b</span><span class="op" id="4909364">.</span><span class="ident" id="4909365">closed</span>&nbsp;<span class="op" id="4909372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909376">return</span>&nbsp;<span class="num" id="4909383">0</span><span class="op" id="4909384">,</span>&nbsp;<span class="ident" id="4909386">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909412">return</span>&nbsp;<span class="ident" id="4909419">bl</span><span class="op" id="4909421">.</span><span class="ident" id="4909422">b</span><span class="op" id="4909423">.</span><span class="ident" id="4909424">readLocked</span><span class="op" id="4909434">(</span><span class="ident" id="4909435">p</span><span class="op" id="4909436">)</span><br>
<span class="lineno"></span><span class="op" id="4909438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4909441">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="4909514">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4909552">func</span>&nbsp;<span class="ident" id="4909557">parseContentLength</span><span class="op" id="4909575">(</span><span class="ident" id="4909576">cl</span>&nbsp;<span class="builtintype" id="4909579">string</span><span class="op" id="4909585">)</span>&nbsp;<span class="op" id="4909587">(</span><span class="ident" id="4909588">int64</span><span class="op" id="4909593">,</span>&nbsp;<span class="builtintype" id="4909595">error</span><span class="op" id="4909600">)</span>&nbsp;<span class="op" id="4909602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909605">cl</span>&nbsp;<span class="op" id="4909608">=</span>&nbsp;<span class="ident" id="4909610">strings</span><span class="op" id="4909617">.</span><span class="ident" id="4909618">TrimSpace</span><span class="op" id="4909627">(</span><span class="ident" id="4909628">cl</span><span class="op" id="4909630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909633">if</span>&nbsp;<span class="ident" id="4909636">cl</span>&nbsp;<span class="op" id="4909639">==</span>&nbsp;<span class="string" id="4909642">&#34;&#34;</span>&nbsp;<span class="op" id="4909645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909649">return</span>&nbsp;<span class="op" id="4909656">-</span><span class="num" id="4909657">1</span><span class="op" id="4909658">,</span>&nbsp;<span class="ident" id="4909660">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909668">n</span><span class="op" id="4909669">,</span>&nbsp;<span class="ident" id="4909671">err</span>&nbsp;<span class="op" id="4909675">:=</span>&nbsp;<span class="ident" id="4909678">strconv</span><span class="op" id="4909685">.</span><span class="ident" id="4909686">ParseInt</span><span class="op" id="4909694">(</span><span class="ident" id="4909695">cl</span><span class="op" id="4909697">,</span>&nbsp;<span class="num" id="4909699">10</span><span class="op" id="4909701">,</span>&nbsp;<span class="num" id="4909703">64</span><span class="op" id="4909705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909708">if</span>&nbsp;<span class="ident" id="4909711">err</span>&nbsp;<span class="op" id="4909715">!=</span>&nbsp;<span class="ident" id="4909718">nil</span>&nbsp;<span class="op" id="4909722">||</span>&nbsp;<span class="ident" id="4909725">n</span>&nbsp;<span class="op" id="4909727">&lt;</span>&nbsp;<span class="num" id="4909729">0</span>&nbsp;<span class="op" id="4909731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909735">return</span>&nbsp;<span class="num" id="4909742">0</span><span class="op" id="4909743">,</span>&nbsp;<span class="op" id="4909745">&amp;</span><span class="ident" id="4909746">badStringError</span><span class="op" id="4909760">{</span><span class="string" id="4909761">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="4909781">,</span>&nbsp;<span class="ident" id="4909783">cl</span><span class="op" id="4909785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909788">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909791">return</span>&nbsp;<span class="ident" id="4909798">n</span><span class="op" id="4909799">,</span>&nbsp;<span class="ident" id="4909801">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4909806">}</span>
</div>
</body>
</html>
