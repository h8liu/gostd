<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1434498">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1434553">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1434607">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1434658">package</span>&nbsp;<span class="ident" id="1434666">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1434672">import</span>&nbsp;<span class="op" id="1434679">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1434682">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1434693">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1434708">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1434717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434720">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1434795">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1434809">//</span><br>
<span class="lineno"></span><span class="comment" id="1434812">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1434892">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1434969">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1434999">//</span><br>
<span class="lineno">20</span><span class="comment" id="1435002">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1435067">//</span><br>
<span class="lineno"></span><span class="comment" id="1435070">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1435144">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1435221">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1435301">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1435316">//</span><br>
<span class="lineno"></span><span class="comment" id="1435319">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1435391">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1435465">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1435542">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1435566">//</span><br>
<span class="lineno"></span><span class="comment" id="1435569">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1435646">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1435725">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1435795">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1435809">//</span><br>
<span class="lineno"></span><span class="comment" id="1435812">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1435892">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1435971">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1436051">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1436065">//</span><br>
<span class="lineno"></span><span class="keyword" id="1436068">type</span>&nbsp;<span class="ident" id="1436073">Pool</span>&nbsp;<span class="keyword" id="1436078">struct</span>&nbsp;<span class="op" id="1436085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436088">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1436098">unsafe</span><span class="op" id="1436104">.</span><span class="ident" id="1436105">Pointer</span>&nbsp;<span class="comment" id="1436113">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436174">localSize</span>&nbsp;<span class="builtintype" id="1436184">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1436199">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436228">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436280">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436329">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436387">New</span>&nbsp;<span class="keyword" id="1436391">func</span><span class="op" id="1436395">(</span><span class="op" id="1436396">)</span>&nbsp;<span class="keyword" id="1436398">interface</span><span class="op" id="1436407">{</span><span class="op" id="1436408">}</span><br>
<span class="lineno">50</span><span class="op" id="1436410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1436413">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1436443">type</span>&nbsp;<span class="ident" id="1436448">poolLocal</span>&nbsp;<span class="keyword" id="1436458">struct</span>&nbsp;<span class="op" id="1436465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436468">private</span>&nbsp;<span class="keyword" id="1436476">interface</span><span class="op" id="1436485">{</span><span class="op" id="1436486">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1436490">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436532">shared</span>&nbsp;&nbsp;<span class="op" id="1436540">[</span><span class="op" id="1436541">]</span><span class="keyword" id="1436542">interface</span><span class="op" id="1436551">{</span><span class="op" id="1436552">}</span>&nbsp;<span class="comment" id="1436554">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436580">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1436602">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436623">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1436631">[</span><span class="num" id="1436632">128</span><span class="op" id="1436635">]</span><span class="builtintype" id="1436636">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1436645">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1436672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1436675">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1436702">func</span>&nbsp;<span class="op" id="1436707">(</span><span class="ident" id="1436708">p</span>&nbsp;<span class="op" id="1436710">*</span><span class="ident" id="1436711">Pool</span><span class="op" id="1436715">)</span>&nbsp;<span class="ident" id="1436717">Put</span><span class="op" id="1436720">(</span><span class="ident" id="1436721">x</span>&nbsp;<span class="keyword" id="1436723">interface</span><span class="op" id="1436732">{</span><span class="op" id="1436733">}</span><span class="op" id="1436734">)</span>&nbsp;<span class="op" id="1436736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436739">if</span>&nbsp;<span class="ident" id="1436742">raceenabled</span>&nbsp;<span class="op" id="1436754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436758">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436816">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436878">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436934">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436945">if</span>&nbsp;<span class="ident" id="1436948">x</span>&nbsp;<span class="op" id="1436950">==</span>&nbsp;<span class="ident" id="1436953">nil</span>&nbsp;<span class="op" id="1436957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436961">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436972">l</span>&nbsp;<span class="op" id="1436974">:=</span>&nbsp;<span class="ident" id="1436977">p</span><span class="op" id="1436978">.</span><span class="ident" id="1436979">pin</span><span class="op" id="1436982">(</span><span class="op" id="1436983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436986">if</span>&nbsp;<span class="ident" id="1436989">l</span><span class="op" id="1436990">.</span><span class="ident" id="1436991">private</span>&nbsp;<span class="op" id="1436999">==</span>&nbsp;<span class="ident" id="1437002">nil</span>&nbsp;<span class="op" id="1437006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437010">l</span><span class="op" id="1437011">.</span><span class="ident" id="1437012">private</span>&nbsp;<span class="op" id="1437020">=</span>&nbsp;<span class="ident" id="1437022">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437026">x</span>&nbsp;<span class="op" id="1437028">=</span>&nbsp;<span class="ident" id="1437030">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437038">runtime_procUnpin</span><span class="op" id="1437055">(</span><span class="op" id="1437056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437059">if</span>&nbsp;<span class="ident" id="1437062">x</span>&nbsp;<span class="op" id="1437064">==</span>&nbsp;<span class="ident" id="1437067">nil</span>&nbsp;<span class="op" id="1437071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437075">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437083">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437086">l</span><span class="op" id="1437087">.</span><span class="ident" id="1437088">Lock</span><span class="op" id="1437092">(</span><span class="op" id="1437093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437096">l</span><span class="op" id="1437097">.</span><span class="ident" id="1437098">shared</span>&nbsp;<span class="op" id="1437105">=</span>&nbsp;<span class="builtinfunc" id="1437107">append</span><span class="op" id="1437113">(</span><span class="ident" id="1437114">l</span><span class="op" id="1437115">.</span><span class="ident" id="1437116">shared</span><span class="op" id="1437122">,</span>&nbsp;<span class="ident" id="1437124">x</span><span class="op" id="1437125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437128">l</span><span class="op" id="1437129">.</span><span class="ident" id="1437130">Unlock</span><span class="op" id="1437136">(</span><span class="op" id="1437137">)</span><br>
<span class="lineno"></span><span class="op" id="1437139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1437142">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1437210">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1437249">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1437309">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1437384">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1437415">//</span><br>
<span class="lineno"></span><span class="comment" id="1437418">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1437489">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1437521">func</span>&nbsp;<span class="op" id="1437526">(</span><span class="ident" id="1437527">p</span>&nbsp;<span class="op" id="1437529">*</span><span class="ident" id="1437530">Pool</span><span class="op" id="1437534">)</span>&nbsp;<span class="ident" id="1437536">Get</span><span class="op" id="1437539">(</span><span class="op" id="1437540">)</span>&nbsp;<span class="keyword" id="1437542">interface</span><span class="op" id="1437551">{</span><span class="op" id="1437552">}</span>&nbsp;<span class="op" id="1437554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437557">if</span>&nbsp;<span class="ident" id="1437560">raceenabled</span>&nbsp;<span class="op" id="1437572">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437576">if</span>&nbsp;<span class="ident" id="1437579">p</span><span class="op" id="1437580">.</span><span class="ident" id="1437581">New</span>&nbsp;<span class="op" id="1437585">!=</span>&nbsp;<span class="ident" id="1437588">nil</span>&nbsp;<span class="op" id="1437592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437597">return</span>&nbsp;<span class="ident" id="1437604">p</span><span class="op" id="1437605">.</span><span class="ident" id="1437606">New</span><span class="op" id="1437609">(</span><span class="op" id="1437610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437618">return</span>&nbsp;<span class="ident" id="1437625">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437630">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437633">l</span>&nbsp;<span class="op" id="1437635">:=</span>&nbsp;<span class="ident" id="1437638">p</span><span class="op" id="1437639">.</span><span class="ident" id="1437640">pin</span><span class="op" id="1437643">(</span><span class="op" id="1437644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437647">x</span>&nbsp;<span class="op" id="1437649">:=</span>&nbsp;<span class="ident" id="1437652">l</span><span class="op" id="1437653">.</span><span class="ident" id="1437654">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437663">l</span><span class="op" id="1437664">.</span><span class="ident" id="1437665">private</span>&nbsp;<span class="op" id="1437673">=</span>&nbsp;<span class="ident" id="1437675">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437680">runtime_procUnpin</span><span class="op" id="1437697">(</span><span class="op" id="1437698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437701">if</span>&nbsp;<span class="ident" id="1437704">x</span>&nbsp;<span class="op" id="1437706">!=</span>&nbsp;<span class="ident" id="1437709">nil</span>&nbsp;<span class="op" id="1437713">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437717">return</span>&nbsp;<span class="ident" id="1437724">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437730">l</span><span class="op" id="1437731">.</span><span class="ident" id="1437732">Lock</span><span class="op" id="1437736">(</span><span class="op" id="1437737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437740">last</span>&nbsp;<span class="op" id="1437745">:=</span>&nbsp;<span class="builtinfunc" id="1437748">len</span><span class="op" id="1437751">(</span><span class="ident" id="1437752">l</span><span class="op" id="1437753">.</span><span class="ident" id="1437754">shared</span><span class="op" id="1437760">)</span>&nbsp;<span class="op" id="1437762">-</span>&nbsp;<span class="num" id="1437764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437767">if</span>&nbsp;<span class="ident" id="1437770">last</span>&nbsp;<span class="op" id="1437775">&gt;=</span>&nbsp;<span class="num" id="1437778">0</span>&nbsp;<span class="op" id="1437780">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437784">x</span>&nbsp;<span class="op" id="1437786">=</span>&nbsp;<span class="ident" id="1437788">l</span><span class="op" id="1437789">.</span><span class="ident" id="1437790">shared</span><span class="op" id="1437796">[</span><span class="ident" id="1437797">last</span><span class="op" id="1437801">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437805">l</span><span class="op" id="1437806">.</span><span class="ident" id="1437807">shared</span>&nbsp;<span class="op" id="1437814">=</span>&nbsp;<span class="ident" id="1437816">l</span><span class="op" id="1437817">.</span><span class="ident" id="1437818">shared</span><span class="op" id="1437824">[</span><span class="op" id="1437825">:</span><span class="ident" id="1437826">last</span><span class="op" id="1437830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437836">l</span><span class="op" id="1437837">.</span><span class="ident" id="1437838">Unlock</span><span class="op" id="1437844">(</span><span class="op" id="1437845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437848">if</span>&nbsp;<span class="ident" id="1437851">x</span>&nbsp;<span class="op" id="1437853">!=</span>&nbsp;<span class="ident" id="1437856">nil</span>&nbsp;<span class="op" id="1437860">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437864">return</span>&nbsp;<span class="ident" id="1437871">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437877">return</span>&nbsp;<span class="ident" id="1437884">p</span><span class="op" id="1437885">.</span><span class="ident" id="1437886">getSlow</span><span class="op" id="1437893">(</span><span class="op" id="1437894">)</span><br>
<span class="lineno"></span><span class="op" id="1437896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1437899">func</span>&nbsp;<span class="op" id="1437904">(</span><span class="ident" id="1437905">p</span>&nbsp;<span class="op" id="1437907">*</span><span class="ident" id="1437908">Pool</span><span class="op" id="1437912">)</span>&nbsp;<span class="ident" id="1437914">getSlow</span><span class="op" id="1437921">(</span><span class="op" id="1437922">)</span>&nbsp;<span class="op" id="1437924">(</span><span class="ident" id="1437925">x</span>&nbsp;<span class="keyword" id="1437927">interface</span><span class="op" id="1437936">{</span><span class="op" id="1437937">}</span><span class="op" id="1437938">)</span>&nbsp;<span class="op" id="1437940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1437943">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438003">size</span>&nbsp;<span class="op" id="1438008">:=</span>&nbsp;<span class="ident" id="1438011">atomic</span><span class="op" id="1438017">.</span><span class="ident" id="1438018">LoadUintptr</span><span class="op" id="1438029">(</span><span class="op" id="1438030">&amp;</span><span class="ident" id="1438031">p</span><span class="op" id="1438032">.</span><span class="ident" id="1438033">localSize</span><span class="op" id="1438042">)</span>&nbsp;<span class="comment" id="1438044">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438061">local</span>&nbsp;<span class="op" id="1438067">:=</span>&nbsp;<span class="ident" id="1438070">p</span><span class="op" id="1438071">.</span><span class="ident" id="1438072">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1438102">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438119">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438166">pid</span>&nbsp;<span class="op" id="1438170">:=</span>&nbsp;<span class="ident" id="1438173">runtime_procPin</span><span class="op" id="1438188">(</span><span class="op" id="1438189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438192">runtime_procUnpin</span><span class="op" id="1438209">(</span><span class="op" id="1438210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438213">for</span>&nbsp;<span class="ident" id="1438217">i</span>&nbsp;<span class="op" id="1438219">:=</span>&nbsp;<span class="num" id="1438222">0</span><span class="op" id="1438223">;</span>&nbsp;<span class="ident" id="1438225">i</span>&nbsp;<span class="op" id="1438227">&lt;</span>&nbsp;<span class="builtintype" id="1438229">int</span><span class="op" id="1438232">(</span><span class="ident" id="1438233">size</span><span class="op" id="1438237">)</span><span class="op" id="1438238">;</span>&nbsp;<span class="ident" id="1438240">i</span><span class="op" id="1438241">++</span>&nbsp;<span class="op" id="1438244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438248">l</span>&nbsp;<span class="op" id="1438250">:=</span>&nbsp;<span class="ident" id="1438253">indexLocal</span><span class="op" id="1438263">(</span><span class="ident" id="1438264">local</span><span class="op" id="1438269">,</span>&nbsp;<span class="op" id="1438271">(</span><span class="ident" id="1438272">pid</span><span class="op" id="1438275">+</span><span class="ident" id="1438276">i</span><span class="op" id="1438277">+</span><span class="num" id="1438278">1</span><span class="op" id="1438279">)</span><span class="op" id="1438280">%</span><span class="builtintype" id="1438281">int</span><span class="op" id="1438284">(</span><span class="ident" id="1438285">size</span><span class="op" id="1438289">)</span><span class="op" id="1438290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438294">l</span><span class="op" id="1438295">.</span><span class="ident" id="1438296">Lock</span><span class="op" id="1438300">(</span><span class="op" id="1438301">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438305">last</span>&nbsp;<span class="op" id="1438310">:=</span>&nbsp;<span class="builtinfunc" id="1438313">len</span><span class="op" id="1438316">(</span><span class="ident" id="1438317">l</span><span class="op" id="1438318">.</span><span class="ident" id="1438319">shared</span><span class="op" id="1438325">)</span>&nbsp;<span class="op" id="1438327">-</span>&nbsp;<span class="num" id="1438329">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438333">if</span>&nbsp;<span class="ident" id="1438336">last</span>&nbsp;<span class="op" id="1438341">&gt;=</span>&nbsp;<span class="num" id="1438344">0</span>&nbsp;<span class="op" id="1438346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438351">x</span>&nbsp;<span class="op" id="1438353">=</span>&nbsp;<span class="ident" id="1438355">l</span><span class="op" id="1438356">.</span><span class="ident" id="1438357">shared</span><span class="op" id="1438363">[</span><span class="ident" id="1438364">last</span><span class="op" id="1438368">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438373">l</span><span class="op" id="1438374">.</span><span class="ident" id="1438375">shared</span>&nbsp;<span class="op" id="1438382">=</span>&nbsp;<span class="ident" id="1438384">l</span><span class="op" id="1438385">.</span><span class="ident" id="1438386">shared</span><span class="op" id="1438392">[</span><span class="op" id="1438393">:</span><span class="ident" id="1438394">last</span><span class="op" id="1438398">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438403">l</span><span class="op" id="1438404">.</span><span class="ident" id="1438405">Unlock</span><span class="op" id="1438411">(</span><span class="op" id="1438412">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438417">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438429">l</span><span class="op" id="1438430">.</span><span class="ident" id="1438431">Unlock</span><span class="op" id="1438437">(</span><span class="op" id="1438438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438445">if</span>&nbsp;<span class="ident" id="1438448">x</span>&nbsp;<span class="op" id="1438450">==</span>&nbsp;<span class="ident" id="1438453">nil</span>&nbsp;<span class="op" id="1438457">&amp;&amp;</span>&nbsp;<span class="ident" id="1438460">p</span><span class="op" id="1438461">.</span><span class="ident" id="1438462">New</span>&nbsp;<span class="op" id="1438466">!=</span>&nbsp;<span class="ident" id="1438469">nil</span>&nbsp;<span class="op" id="1438473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438477">x</span>&nbsp;<span class="op" id="1438479">=</span>&nbsp;<span class="ident" id="1438481">p</span><span class="op" id="1438482">.</span><span class="ident" id="1438483">New</span><span class="op" id="1438486">(</span><span class="op" id="1438487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438493">return</span>&nbsp;<span class="ident" id="1438500">x</span><br>
<span class="lineno"></span><span class="op" id="1438502">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1438505">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1438603">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1438668">func</span>&nbsp;<span class="op" id="1438673">(</span><span class="ident" id="1438674">p</span>&nbsp;<span class="op" id="1438676">*</span><span class="ident" id="1438677">Pool</span><span class="op" id="1438681">)</span>&nbsp;<span class="ident" id="1438683">pin</span><span class="op" id="1438686">(</span><span class="op" id="1438687">)</span>&nbsp;<span class="op" id="1438689">*</span><span class="ident" id="1438690">poolLocal</span>&nbsp;<span class="op" id="1438700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438703">pid</span>&nbsp;<span class="op" id="1438707">:=</span>&nbsp;<span class="ident" id="1438710">runtime_procPin</span><span class="op" id="1438725">(</span><span class="op" id="1438726">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438729">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438817">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438884">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438949">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439046">s</span>&nbsp;<span class="op" id="1439048">:=</span>&nbsp;<span class="ident" id="1439051">atomic</span><span class="op" id="1439057">.</span><span class="ident" id="1439058">LoadUintptr</span><span class="op" id="1439069">(</span><span class="op" id="1439070">&amp;</span><span class="ident" id="1439071">p</span><span class="op" id="1439072">.</span><span class="ident" id="1439073">localSize</span><span class="op" id="1439082">)</span>&nbsp;<span class="comment" id="1439084">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439101">l</span>&nbsp;<span class="op" id="1439103">:=</span>&nbsp;<span class="ident" id="1439106">p</span><span class="op" id="1439107">.</span><span class="ident" id="1439108">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439139">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439156">if</span>&nbsp;<span class="builtintype" id="1439159">uintptr</span><span class="op" id="1439166">(</span><span class="ident" id="1439167">pid</span><span class="op" id="1439170">)</span>&nbsp;<span class="op" id="1439172">&lt;</span>&nbsp;<span class="ident" id="1439174">s</span>&nbsp;<span class="op" id="1439176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439180">return</span>&nbsp;<span class="ident" id="1439187">indexLocal</span><span class="op" id="1439197">(</span><span class="ident" id="1439198">l</span><span class="op" id="1439199">,</span>&nbsp;<span class="ident" id="1439201">pid</span><span class="op" id="1439204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439210">return</span>&nbsp;<span class="ident" id="1439217">p</span><span class="op" id="1439218">.</span><span class="ident" id="1439219">pinSlow</span><span class="op" id="1439226">(</span><span class="op" id="1439227">)</span><br>
<span class="lineno">160</span><span class="op" id="1439229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1439232">func</span>&nbsp;<span class="op" id="1439237">(</span><span class="ident" id="1439238">p</span>&nbsp;<span class="op" id="1439240">*</span><span class="ident" id="1439241">Pool</span><span class="op" id="1439245">)</span>&nbsp;<span class="ident" id="1439247">pinSlow</span><span class="op" id="1439254">(</span><span class="op" id="1439255">)</span>&nbsp;<span class="op" id="1439257">*</span><span class="ident" id="1439258">poolLocal</span>&nbsp;<span class="op" id="1439268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439271">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439298">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439339">runtime_procUnpin</span><span class="op" id="1439356">(</span><span class="op" id="1439357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439360">allPoolsMu</span><span class="op" id="1439370">.</span><span class="ident" id="1439371">Lock</span><span class="op" id="1439375">(</span><span class="op" id="1439376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439379">defer</span>&nbsp;<span class="ident" id="1439385">allPoolsMu</span><span class="op" id="1439395">.</span><span class="ident" id="1439396">Unlock</span><span class="op" id="1439402">(</span><span class="op" id="1439403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439406">pid</span>&nbsp;<span class="op" id="1439410">:=</span>&nbsp;<span class="ident" id="1439413">runtime_procPin</span><span class="op" id="1439428">(</span><span class="op" id="1439429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439432">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439485">s</span>&nbsp;<span class="op" id="1439487">:=</span>&nbsp;<span class="ident" id="1439490">p</span><span class="op" id="1439491">.</span><span class="ident" id="1439492">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439503">l</span>&nbsp;<span class="op" id="1439505">:=</span>&nbsp;<span class="ident" id="1439508">p</span><span class="op" id="1439509">.</span><span class="ident" id="1439510">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439517">if</span>&nbsp;<span class="builtintype" id="1439520">uintptr</span><span class="op" id="1439527">(</span><span class="ident" id="1439528">pid</span><span class="op" id="1439531">)</span>&nbsp;<span class="op" id="1439533">&lt;</span>&nbsp;<span class="ident" id="1439535">s</span>&nbsp;<span class="op" id="1439537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439541">return</span>&nbsp;<span class="ident" id="1439548">indexLocal</span><span class="op" id="1439558">(</span><span class="ident" id="1439559">l</span><span class="op" id="1439560">,</span>&nbsp;<span class="ident" id="1439562">pid</span><span class="op" id="1439565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439568">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439571">if</span>&nbsp;<span class="ident" id="1439574">p</span><span class="op" id="1439575">.</span><span class="ident" id="1439576">local</span>&nbsp;<span class="op" id="1439582">==</span>&nbsp;<span class="ident" id="1439585">nil</span>&nbsp;<span class="op" id="1439589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439593">allPools</span>&nbsp;<span class="op" id="1439602">=</span>&nbsp;<span class="builtinfunc" id="1439604">append</span><span class="op" id="1439610">(</span><span class="ident" id="1439611">allPools</span><span class="op" id="1439619">,</span>&nbsp;<span class="ident" id="1439621">p</span><span class="op" id="1439622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439628">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439714">size</span>&nbsp;<span class="op" id="1439719">:=</span>&nbsp;<span class="ident" id="1439722">runtime</span><span class="op" id="1439729">.</span><span class="ident" id="1439730">GOMAXPROCS</span><span class="op" id="1439740">(</span><span class="num" id="1439741">0</span><span class="op" id="1439742">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439745">local</span>&nbsp;<span class="op" id="1439751">:=</span>&nbsp;<span class="builtinfunc" id="1439754">make</span><span class="op" id="1439758">(</span><span class="op" id="1439759">[</span><span class="op" id="1439760">]</span><span class="ident" id="1439761">poolLocal</span><span class="op" id="1439770">,</span>&nbsp;<span class="ident" id="1439772">size</span><span class="op" id="1439776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439779">atomic</span><span class="op" id="1439785">.</span><span class="ident" id="1439786">StorePointer</span><span class="op" id="1439798">(</span><span class="op" id="1439799">(</span><span class="op" id="1439800">*</span><span class="ident" id="1439801">unsafe</span><span class="op" id="1439807">.</span><span class="ident" id="1439808">Pointer</span><span class="op" id="1439815">)</span><span class="op" id="1439816">(</span><span class="op" id="1439817">&amp;</span><span class="ident" id="1439818">p</span><span class="op" id="1439819">.</span><span class="ident" id="1439820">local</span><span class="op" id="1439825">)</span><span class="op" id="1439826">,</span>&nbsp;<span class="ident" id="1439828">unsafe</span><span class="op" id="1439834">.</span><span class="ident" id="1439835">Pointer</span><span class="op" id="1439842">(</span><span class="op" id="1439843">&amp;</span><span class="ident" id="1439844">local</span><span class="op" id="1439849">[</span><span class="num" id="1439850">0</span><span class="op" id="1439851">]</span><span class="op" id="1439852">)</span><span class="op" id="1439853">)</span>&nbsp;<span class="comment" id="1439855">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439873">atomic</span><span class="op" id="1439879">.</span><span class="ident" id="1439880">StoreUintptr</span><span class="op" id="1439892">(</span><span class="op" id="1439893">&amp;</span><span class="ident" id="1439894">p</span><span class="op" id="1439895">.</span><span class="ident" id="1439896">localSize</span><span class="op" id="1439905">,</span>&nbsp;<span class="builtintype" id="1439907">uintptr</span><span class="op" id="1439914">(</span><span class="ident" id="1439915">size</span><span class="op" id="1439919">)</span><span class="op" id="1439920">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439949">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439967">return</span>&nbsp;<span class="op" id="1439974">&amp;</span><span class="ident" id="1439975">local</span><span class="op" id="1439980">[</span><span class="ident" id="1439981">pid</span><span class="op" id="1439984">]</span><br>
<span class="lineno"></span><span class="op" id="1439986">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1439989">func</span>&nbsp;<span class="ident" id="1439994">poolCleanup</span><span class="op" id="1440005">(</span><span class="op" id="1440006">)</span>&nbsp;<span class="op" id="1440008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440011">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440105">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440182">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440230">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440280">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440351">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440436">for</span>&nbsp;<span class="ident" id="1440440">i</span><span class="op" id="1440441">,</span>&nbsp;<span class="ident" id="1440443">p</span>&nbsp;<span class="op" id="1440445">:=</span>&nbsp;<span class="keyword" id="1440448">range</span>&nbsp;<span class="ident" id="1440454">allPools</span>&nbsp;<span class="op" id="1440463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440467">allPools</span><span class="op" id="1440475">[</span><span class="ident" id="1440476">i</span><span class="op" id="1440477">]</span>&nbsp;<span class="op" id="1440479">=</span>&nbsp;<span class="ident" id="1440481">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440487">for</span>&nbsp;<span class="ident" id="1440491">i</span>&nbsp;<span class="op" id="1440493">:=</span>&nbsp;<span class="num" id="1440496">0</span><span class="op" id="1440497">;</span>&nbsp;<span class="ident" id="1440499">i</span>&nbsp;<span class="op" id="1440501">&lt;</span>&nbsp;<span class="builtintype" id="1440503">int</span><span class="op" id="1440506">(</span><span class="ident" id="1440507">p</span><span class="op" id="1440508">.</span><span class="ident" id="1440509">localSize</span><span class="op" id="1440518">)</span><span class="op" id="1440519">;</span>&nbsp;<span class="ident" id="1440521">i</span><span class="op" id="1440522">++</span>&nbsp;<span class="op" id="1440525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440530">l</span>&nbsp;<span class="op" id="1440532">:=</span>&nbsp;<span class="ident" id="1440535">indexLocal</span><span class="op" id="1440545">(</span><span class="ident" id="1440546">p</span><span class="op" id="1440547">.</span><span class="ident" id="1440548">local</span><span class="op" id="1440553">,</span>&nbsp;<span class="ident" id="1440555">i</span><span class="op" id="1440556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440561">l</span><span class="op" id="1440562">.</span><span class="ident" id="1440563">private</span>&nbsp;<span class="op" id="1440571">=</span>&nbsp;<span class="ident" id="1440573">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440580">for</span>&nbsp;<span class="ident" id="1440584">j</span>&nbsp;<span class="op" id="1440586">:=</span>&nbsp;<span class="keyword" id="1440589">range</span>&nbsp;<span class="ident" id="1440595">l</span><span class="op" id="1440596">.</span><span class="ident" id="1440597">shared</span>&nbsp;<span class="op" id="1440604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440610">l</span><span class="op" id="1440611">.</span><span class="ident" id="1440612">shared</span><span class="op" id="1440618">[</span><span class="ident" id="1440619">j</span><span class="op" id="1440620">]</span>&nbsp;<span class="op" id="1440622">=</span>&nbsp;<span class="ident" id="1440624">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440636">l</span><span class="op" id="1440637">.</span><span class="ident" id="1440638">shared</span>&nbsp;<span class="op" id="1440645">=</span>&nbsp;<span class="ident" id="1440647">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440657">p</span><span class="op" id="1440658">.</span><span class="ident" id="1440659">local</span>&nbsp;<span class="op" id="1440665">=</span>&nbsp;<span class="ident" id="1440667">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440673">p</span><span class="op" id="1440674">.</span><span class="ident" id="1440675">localSize</span>&nbsp;<span class="op" id="1440685">=</span>&nbsp;<span class="num" id="1440687">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440693">allPools</span>&nbsp;<span class="op" id="1440702">=</span>&nbsp;<span class="op" id="1440704">[</span><span class="op" id="1440705">]</span><span class="op" id="1440706">*</span><span class="ident" id="1440707">Pool</span><span class="op" id="1440711">{</span><span class="op" id="1440712">}</span><br>
<span class="lineno"></span><span class="op" id="1440714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1440717">var</span>&nbsp;<span class="op" id="1440721">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440724">allPoolsMu</span>&nbsp;<span class="ident" id="1440735">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440742">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1440753">[</span><span class="op" id="1440754">]</span><span class="op" id="1440755">*</span><span class="ident" id="1440756">Pool</span><br>
<span class="lineno"></span><span class="op" id="1440761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1440764">func</span>&nbsp;<span class="ident" id="1440769">init</span><span class="op" id="1440773">(</span><span class="op" id="1440774">)</span>&nbsp;<span class="op" id="1440776">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440779">runtime_registerPoolCleanup</span><span class="op" id="1440806">(</span><span class="ident" id="1440807">poolCleanup</span><span class="op" id="1440818">)</span><br>
<span class="lineno"></span><span class="op" id="1440820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1440823">func</span>&nbsp;<span class="ident" id="1440828">indexLocal</span><span class="op" id="1440838">(</span><span class="ident" id="1440839">l</span>&nbsp;<span class="ident" id="1440841">unsafe</span><span class="op" id="1440847">.</span><span class="ident" id="1440848">Pointer</span><span class="op" id="1440855">,</span>&nbsp;<span class="ident" id="1440857">i</span>&nbsp;<span class="builtintype" id="1440859">int</span><span class="op" id="1440862">)</span>&nbsp;<span class="op" id="1440864">*</span><span class="ident" id="1440865">poolLocal</span>&nbsp;<span class="op" id="1440875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440878">return</span>&nbsp;<span class="op" id="1440885">&amp;</span><span class="op" id="1440886">(</span><span class="op" id="1440887">*</span><span class="op" id="1440888">[</span><span class="num" id="1440889">1000000</span><span class="op" id="1440896">]</span><span class="ident" id="1440897">poolLocal</span><span class="op" id="1440906">)</span><span class="op" id="1440907">(</span><span class="ident" id="1440908">l</span><span class="op" id="1440909">)</span><span class="op" id="1440910">[</span><span class="ident" id="1440911">i</span><span class="op" id="1440912">]</span><br>
<span class="lineno">220</span><span class="op" id="1440914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1440917">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1440944">func</span>&nbsp;<span class="ident" id="1440949">runtime_registerPoolCleanup</span><span class="op" id="1440976">(</span><span class="ident" id="1440977">cleanup</span>&nbsp;<span class="keyword" id="1440985">func</span><span class="op" id="1440989">(</span><span class="op" id="1440990">)</span><span class="op" id="1440991">)</span><br>
<span class="lineno"></span><span class="keyword" id="1440993">func</span>&nbsp;<span class="ident" id="1440998">runtime_procPin</span><span class="op" id="1441013">(</span><span class="op" id="1441014">)</span>&nbsp;<span class="builtintype" id="1441016">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1441020">func</span>&nbsp;<span class="ident" id="1441025">runtime_procUnpin</span><span class="op" id="1441042">(</span><span class="op" id="1441043">)</span>
</div>
</body>
</html>
