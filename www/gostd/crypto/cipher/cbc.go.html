<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3521662">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3521717">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3521771">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3521822">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3521860">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3521934">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3522007">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3522041">package</span>&nbsp;<span class="ident" id="3522049">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3522057">type</span>&nbsp;<span class="ident" id="3522062">cbc</span>&nbsp;<span class="keyword" id="3522066">struct</span>&nbsp;<span class="op" id="3522073">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522076">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522086">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522093">blockSize</span>&nbsp;<span class="builtintype" id="3522103">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522108">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522118">[</span><span class="op" id="3522119">]</span><span class="builtintype" id="3522120">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522126">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522136">[</span><span class="op" id="3522137">]</span><span class="builtintype" id="3522138">byte</span><br>
<span class="lineno"></span><span class="op" id="3522143">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3522146">func</span>&nbsp;<span class="ident" id="3522151">newCBC</span><span class="op" id="3522157">(</span><span class="ident" id="3522158">b</span>&nbsp;<span class="ident" id="3522160">Block</span><span class="op" id="3522165">,</span>&nbsp;<span class="ident" id="3522167">iv</span>&nbsp;<span class="op" id="3522170">[</span><span class="op" id="3522171">]</span><span class="builtintype" id="3522172">byte</span><span class="op" id="3522176">)</span>&nbsp;<span class="op" id="3522178">*</span><span class="ident" id="3522179">cbc</span>&nbsp;<span class="op" id="3522183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522186">return</span>&nbsp;<span class="op" id="3522193">&amp;</span><span class="ident" id="3522194">cbc</span><span class="op" id="3522197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522201">b</span><span class="op" id="3522202">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522212">b</span><span class="op" id="3522213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522217">blockSize</span><span class="op" id="3522226">:</span>&nbsp;<span class="ident" id="3522228">b</span><span class="op" id="3522229">.</span><span class="ident" id="3522230">BlockSize</span><span class="op" id="3522239">(</span><span class="op" id="3522240">)</span><span class="op" id="3522241">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522245">iv</span><span class="op" id="3522247">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522256">dup</span><span class="op" id="3522259">(</span><span class="ident" id="3522260">iv</span><span class="op" id="3522262">)</span><span class="op" id="3522263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522267">tmp</span><span class="op" id="3522270">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3522278">make</span><span class="op" id="3522282">(</span><span class="op" id="3522283">[</span><span class="op" id="3522284">]</span><span class="builtintype" id="3522285">byte</span><span class="op" id="3522289">,</span>&nbsp;<span class="ident" id="3522291">b</span><span class="op" id="3522292">.</span><span class="ident" id="3522293">BlockSize</span><span class="op" id="3522302">(</span><span class="op" id="3522303">)</span><span class="op" id="3522304">)</span><span class="op" id="3522305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522308">}</span><br>
<span class="lineno"></span><span class="op" id="3522310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3522313">type</span>&nbsp;<span class="ident" id="3522318">cbcEncrypter</span>&nbsp;<span class="ident" id="3522331">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3522336">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3522415">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3522488">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3522511">func</span>&nbsp;<span class="ident" id="3522516">NewCBCEncrypter</span><span class="op" id="3522531">(</span><span class="ident" id="3522532">b</span>&nbsp;<span class="ident" id="3522534">Block</span><span class="op" id="3522539">,</span>&nbsp;<span class="ident" id="3522541">iv</span>&nbsp;<span class="op" id="3522544">[</span><span class="op" id="3522545">]</span><span class="builtintype" id="3522546">byte</span><span class="op" id="3522550">)</span>&nbsp;<span class="ident" id="3522552">BlockMode</span>&nbsp;<span class="op" id="3522562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522565">if</span>&nbsp;<span class="builtinfunc" id="3522568">len</span><span class="op" id="3522571">(</span><span class="ident" id="3522572">iv</span><span class="op" id="3522574">)</span>&nbsp;<span class="op" id="3522576">!=</span>&nbsp;<span class="ident" id="3522579">b</span><span class="op" id="3522580">.</span><span class="ident" id="3522581">BlockSize</span><span class="op" id="3522590">(</span><span class="op" id="3522591">)</span>&nbsp;<span class="op" id="3522593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3522597">panic</span><span class="op" id="3522602">(</span><span class="string" id="3522603">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3522660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522666">return</span>&nbsp;<span class="op" id="3522673">(</span><span class="op" id="3522674">*</span><span class="ident" id="3522675">cbcEncrypter</span><span class="op" id="3522687">)</span><span class="op" id="3522688">(</span><span class="ident" id="3522689">newCBC</span><span class="op" id="3522695">(</span><span class="ident" id="3522696">b</span><span class="op" id="3522697">,</span>&nbsp;<span class="ident" id="3522699">iv</span><span class="op" id="3522701">)</span><span class="op" id="3522702">)</span><br>
<span class="lineno">40</span><span class="op" id="3522704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3522707">func</span>&nbsp;<span class="op" id="3522712">(</span><span class="ident" id="3522713">x</span>&nbsp;<span class="op" id="3522715">*</span><span class="ident" id="3522716">cbcEncrypter</span><span class="op" id="3522728">)</span>&nbsp;<span class="ident" id="3522730">BlockSize</span><span class="op" id="3522739">(</span><span class="op" id="3522740">)</span>&nbsp;<span class="builtintype" id="3522742">int</span>&nbsp;<span class="op" id="3522746">{</span>&nbsp;<span class="keyword" id="3522748">return</span>&nbsp;<span class="ident" id="3522755">x</span><span class="op" id="3522756">.</span><span class="ident" id="3522757">blockSize</span>&nbsp;<span class="op" id="3522767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3522770">func</span>&nbsp;<span class="op" id="3522775">(</span><span class="ident" id="3522776">x</span>&nbsp;<span class="op" id="3522778">*</span><span class="ident" id="3522779">cbcEncrypter</span><span class="op" id="3522791">)</span>&nbsp;<span class="ident" id="3522793">CryptBlocks</span><span class="op" id="3522804">(</span><span class="ident" id="3522805">dst</span><span class="op" id="3522808">,</span>&nbsp;<span class="ident" id="3522810">src</span>&nbsp;<span class="op" id="3522814">[</span><span class="op" id="3522815">]</span><span class="builtintype" id="3522816">byte</span><span class="op" id="3522820">)</span>&nbsp;<span class="op" id="3522822">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522825">if</span>&nbsp;<span class="builtinfunc" id="3522828">len</span><span class="op" id="3522831">(</span><span class="ident" id="3522832">src</span><span class="op" id="3522835">)</span><span class="op" id="3522836">%</span><span class="ident" id="3522837">x</span><span class="op" id="3522838">.</span><span class="ident" id="3522839">blockSize</span>&nbsp;<span class="op" id="3522849">!=</span>&nbsp;<span class="num" id="3522852">0</span>&nbsp;<span class="op" id="3522854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3522858">panic</span><span class="op" id="3522863">(</span><span class="string" id="3522864">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3522902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522908">if</span>&nbsp;<span class="builtinfunc" id="3522911">len</span><span class="op" id="3522914">(</span><span class="ident" id="3522915">dst</span><span class="op" id="3522918">)</span>&nbsp;<span class="op" id="3522920">&lt;</span>&nbsp;<span class="builtinfunc" id="3522922">len</span><span class="op" id="3522925">(</span><span class="ident" id="3522926">src</span><span class="op" id="3522929">)</span>&nbsp;<span class="op" id="3522931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3522935">panic</span><span class="op" id="3522940">(</span><span class="string" id="3522941">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3522983">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522990">iv</span>&nbsp;<span class="op" id="3522993">:=</span>&nbsp;<span class="ident" id="3522996">x</span><span class="op" id="3522997">.</span><span class="ident" id="3522998">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523003">for</span>&nbsp;<span class="builtinfunc" id="3523007">len</span><span class="op" id="3523010">(</span><span class="ident" id="3523011">src</span><span class="op" id="3523014">)</span>&nbsp;<span class="op" id="3523016">&gt;</span>&nbsp;<span class="num" id="3523018">0</span>&nbsp;<span class="op" id="3523020">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523024">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523074">xorBytes</span><span class="op" id="3523082">(</span><span class="ident" id="3523083">dst</span><span class="op" id="3523086">[</span><span class="op" id="3523087">:</span><span class="ident" id="3523088">x</span><span class="op" id="3523089">.</span><span class="ident" id="3523090">blockSize</span><span class="op" id="3523099">]</span><span class="op" id="3523100">,</span>&nbsp;<span class="ident" id="3523102">src</span><span class="op" id="3523105">[</span><span class="op" id="3523106">:</span><span class="ident" id="3523107">x</span><span class="op" id="3523108">.</span><span class="ident" id="3523109">blockSize</span><span class="op" id="3523118">]</span><span class="op" id="3523119">,</span>&nbsp;<span class="ident" id="3523121">iv</span><span class="op" id="3523123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523127">x</span><span class="op" id="3523128">.</span><span class="ident" id="3523129">b</span><span class="op" id="3523130">.</span><span class="ident" id="3523131">Encrypt</span><span class="op" id="3523138">(</span><span class="ident" id="3523139">dst</span><span class="op" id="3523142">[</span><span class="op" id="3523143">:</span><span class="ident" id="3523144">x</span><span class="op" id="3523145">.</span><span class="ident" id="3523146">blockSize</span><span class="op" id="3523155">]</span><span class="op" id="3523156">,</span>&nbsp;<span class="ident" id="3523158">dst</span><span class="op" id="3523161">[</span><span class="op" id="3523162">:</span><span class="ident" id="3523163">x</span><span class="op" id="3523164">.</span><span class="ident" id="3523165">blockSize</span><span class="op" id="3523174">]</span><span class="op" id="3523175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523180">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523240">iv</span>&nbsp;<span class="op" id="3523243">=</span>&nbsp;<span class="ident" id="3523245">dst</span><span class="op" id="3523248">[</span><span class="op" id="3523249">:</span><span class="ident" id="3523250">x</span><span class="op" id="3523251">.</span><span class="ident" id="3523252">blockSize</span><span class="op" id="3523261">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523265">src</span>&nbsp;<span class="op" id="3523269">=</span>&nbsp;<span class="ident" id="3523271">src</span><span class="op" id="3523274">[</span><span class="ident" id="3523275">x</span><span class="op" id="3523276">.</span><span class="ident" id="3523277">blockSize</span><span class="op" id="3523286">:</span><span class="op" id="3523287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523291">dst</span>&nbsp;<span class="op" id="3523295">=</span>&nbsp;<span class="ident" id="3523297">dst</span><span class="op" id="3523300">[</span><span class="ident" id="3523301">x</span><span class="op" id="3523302">.</span><span class="ident" id="3523303">blockSize</span><span class="op" id="3523312">:</span><span class="op" id="3523313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523320">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523367">copy</span><span class="op" id="3523371">(</span><span class="ident" id="3523372">x</span><span class="op" id="3523373">.</span><span class="ident" id="3523374">iv</span><span class="op" id="3523376">,</span>&nbsp;<span class="ident" id="3523378">iv</span><span class="op" id="3523380">)</span><br>
<span class="lineno"></span><span class="op" id="3523382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3523385">func</span>&nbsp;<span class="op" id="3523390">(</span><span class="ident" id="3523391">x</span>&nbsp;<span class="op" id="3523393">*</span><span class="ident" id="3523394">cbcEncrypter</span><span class="op" id="3523406">)</span>&nbsp;<span class="ident" id="3523408">SetIV</span><span class="op" id="3523413">(</span><span class="ident" id="3523414">iv</span>&nbsp;<span class="op" id="3523417">[</span><span class="op" id="3523418">]</span><span class="builtintype" id="3523419">byte</span><span class="op" id="3523423">)</span>&nbsp;<span class="op" id="3523425">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523428">if</span>&nbsp;<span class="builtinfunc" id="3523431">len</span><span class="op" id="3523434">(</span><span class="ident" id="3523435">iv</span><span class="op" id="3523437">)</span>&nbsp;<span class="op" id="3523439">!=</span>&nbsp;<span class="builtinfunc" id="3523442">len</span><span class="op" id="3523445">(</span><span class="ident" id="3523446">x</span><span class="op" id="3523447">.</span><span class="ident" id="3523448">iv</span><span class="op" id="3523450">)</span>&nbsp;<span class="op" id="3523452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523456">panic</span><span class="op" id="3523461">(</span><span class="string" id="3523462">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3523491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523497">copy</span><span class="op" id="3523501">(</span><span class="ident" id="3523502">x</span><span class="op" id="3523503">.</span><span class="ident" id="3523504">iv</span><span class="op" id="3523506">,</span>&nbsp;<span class="ident" id="3523508">iv</span><span class="op" id="3523510">)</span><br>
<span class="lineno"></span><span class="op" id="3523512">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3523515">type</span>&nbsp;<span class="ident" id="3523520">cbcDecrypter</span>&nbsp;<span class="ident" id="3523533">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3523538">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3523617">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3523690">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3523760">func</span>&nbsp;<span class="ident" id="3523765">NewCBCDecrypter</span><span class="op" id="3523780">(</span><span class="ident" id="3523781">b</span>&nbsp;<span class="ident" id="3523783">Block</span><span class="op" id="3523788">,</span>&nbsp;<span class="ident" id="3523790">iv</span>&nbsp;<span class="op" id="3523793">[</span><span class="op" id="3523794">]</span><span class="builtintype" id="3523795">byte</span><span class="op" id="3523799">)</span>&nbsp;<span class="ident" id="3523801">BlockMode</span>&nbsp;<span class="op" id="3523811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523814">if</span>&nbsp;<span class="builtinfunc" id="3523817">len</span><span class="op" id="3523820">(</span><span class="ident" id="3523821">iv</span><span class="op" id="3523823">)</span>&nbsp;<span class="op" id="3523825">!=</span>&nbsp;<span class="ident" id="3523828">b</span><span class="op" id="3523829">.</span><span class="ident" id="3523830">BlockSize</span><span class="op" id="3523839">(</span><span class="op" id="3523840">)</span>&nbsp;<span class="op" id="3523842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523846">panic</span><span class="op" id="3523851">(</span><span class="string" id="3523852">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3523909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523912">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523915">return</span>&nbsp;<span class="op" id="3523922">(</span><span class="op" id="3523923">*</span><span class="ident" id="3523924">cbcDecrypter</span><span class="op" id="3523936">)</span><span class="op" id="3523937">(</span><span class="ident" id="3523938">newCBC</span><span class="op" id="3523944">(</span><span class="ident" id="3523945">b</span><span class="op" id="3523946">,</span>&nbsp;<span class="ident" id="3523948">iv</span><span class="op" id="3523950">)</span><span class="op" id="3523951">)</span><br>
<span class="lineno"></span><span class="op" id="3523953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3523956">func</span>&nbsp;<span class="op" id="3523961">(</span><span class="ident" id="3523962">x</span>&nbsp;<span class="op" id="3523964">*</span><span class="ident" id="3523965">cbcDecrypter</span><span class="op" id="3523977">)</span>&nbsp;<span class="ident" id="3523979">BlockSize</span><span class="op" id="3523988">(</span><span class="op" id="3523989">)</span>&nbsp;<span class="builtintype" id="3523991">int</span>&nbsp;<span class="op" id="3523995">{</span>&nbsp;<span class="keyword" id="3523997">return</span>&nbsp;<span class="ident" id="3524004">x</span><span class="op" id="3524005">.</span><span class="ident" id="3524006">blockSize</span>&nbsp;<span class="op" id="3524016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3524019">func</span>&nbsp;<span class="op" id="3524024">(</span><span class="ident" id="3524025">x</span>&nbsp;<span class="op" id="3524027">*</span><span class="ident" id="3524028">cbcDecrypter</span><span class="op" id="3524040">)</span>&nbsp;<span class="ident" id="3524042">CryptBlocks</span><span class="op" id="3524053">(</span><span class="ident" id="3524054">dst</span><span class="op" id="3524057">,</span>&nbsp;<span class="ident" id="3524059">src</span>&nbsp;<span class="op" id="3524063">[</span><span class="op" id="3524064">]</span><span class="builtintype" id="3524065">byte</span><span class="op" id="3524069">)</span>&nbsp;<span class="op" id="3524071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524074">if</span>&nbsp;<span class="builtinfunc" id="3524077">len</span><span class="op" id="3524080">(</span><span class="ident" id="3524081">src</span><span class="op" id="3524084">)</span><span class="op" id="3524085">%</span><span class="ident" id="3524086">x</span><span class="op" id="3524087">.</span><span class="ident" id="3524088">blockSize</span>&nbsp;<span class="op" id="3524098">!=</span>&nbsp;<span class="num" id="3524101">0</span>&nbsp;<span class="op" id="3524103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3524107">panic</span><span class="op" id="3524112">(</span><span class="string" id="3524113">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3524151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524157">if</span>&nbsp;<span class="builtinfunc" id="3524160">len</span><span class="op" id="3524163">(</span><span class="ident" id="3524164">dst</span><span class="op" id="3524167">)</span>&nbsp;<span class="op" id="3524169">&lt;</span>&nbsp;<span class="builtinfunc" id="3524171">len</span><span class="op" id="3524174">(</span><span class="ident" id="3524175">src</span><span class="op" id="3524178">)</span>&nbsp;<span class="op" id="3524180">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3524184">panic</span><span class="op" id="3524189">(</span><span class="string" id="3524190">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3524232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524238">if</span>&nbsp;<span class="builtinfunc" id="3524241">len</span><span class="op" id="3524244">(</span><span class="ident" id="3524245">src</span><span class="op" id="3524248">)</span>&nbsp;<span class="op" id="3524250">==</span>&nbsp;<span class="num" id="3524253">0</span>&nbsp;<span class="op" id="3524255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524267">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524271">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524372">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524445">end</span>&nbsp;<span class="op" id="3524449">:=</span>&nbsp;<span class="builtinfunc" id="3524452">len</span><span class="op" id="3524455">(</span><span class="ident" id="3524456">src</span><span class="op" id="3524459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524462">start</span>&nbsp;<span class="op" id="3524468">:=</span>&nbsp;<span class="ident" id="3524471">end</span>&nbsp;<span class="op" id="3524475">-</span>&nbsp;<span class="ident" id="3524477">x</span><span class="op" id="3524478">.</span><span class="ident" id="3524479">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524490">prev</span>&nbsp;<span class="op" id="3524495">:=</span>&nbsp;<span class="ident" id="3524498">start</span>&nbsp;<span class="op" id="3524504">-</span>&nbsp;<span class="ident" id="3524506">x</span><span class="op" id="3524507">.</span><span class="ident" id="3524508">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524520">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3524588">copy</span><span class="op" id="3524592">(</span><span class="ident" id="3524593">x</span><span class="op" id="3524594">.</span><span class="ident" id="3524595">tmp</span><span class="op" id="3524598">,</span>&nbsp;<span class="ident" id="3524600">src</span><span class="op" id="3524603">[</span><span class="ident" id="3524604">start</span><span class="op" id="3524609">:</span><span class="ident" id="3524610">end</span><span class="op" id="3524613">]</span><span class="op" id="3524614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524618">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524657">for</span>&nbsp;<span class="ident" id="3524661">start</span>&nbsp;<span class="op" id="3524667">&gt;</span>&nbsp;<span class="num" id="3524669">0</span>&nbsp;<span class="op" id="3524671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524675">x</span><span class="op" id="3524676">.</span><span class="ident" id="3524677">b</span><span class="op" id="3524678">.</span><span class="ident" id="3524679">Decrypt</span><span class="op" id="3524686">(</span><span class="ident" id="3524687">dst</span><span class="op" id="3524690">[</span><span class="ident" id="3524691">start</span><span class="op" id="3524696">:</span><span class="ident" id="3524697">end</span><span class="op" id="3524700">]</span><span class="op" id="3524701">,</span>&nbsp;<span class="ident" id="3524703">src</span><span class="op" id="3524706">[</span><span class="ident" id="3524707">start</span><span class="op" id="3524712">:</span><span class="ident" id="3524713">end</span><span class="op" id="3524716">]</span><span class="op" id="3524717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524721">xorBytes</span><span class="op" id="3524729">(</span><span class="ident" id="3524730">dst</span><span class="op" id="3524733">[</span><span class="ident" id="3524734">start</span><span class="op" id="3524739">:</span><span class="ident" id="3524740">end</span><span class="op" id="3524743">]</span><span class="op" id="3524744">,</span>&nbsp;<span class="ident" id="3524746">dst</span><span class="op" id="3524749">[</span><span class="ident" id="3524750">start</span><span class="op" id="3524755">:</span><span class="ident" id="3524756">end</span><span class="op" id="3524759">]</span><span class="op" id="3524760">,</span>&nbsp;<span class="ident" id="3524762">src</span><span class="op" id="3524765">[</span><span class="ident" id="3524766">prev</span><span class="op" id="3524770">:</span><span class="ident" id="3524771">start</span><span class="op" id="3524776">]</span><span class="op" id="3524777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524782">end</span>&nbsp;<span class="op" id="3524786">=</span>&nbsp;<span class="ident" id="3524788">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524796">start</span>&nbsp;<span class="op" id="3524802">=</span>&nbsp;<span class="ident" id="3524804">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524811">prev</span>&nbsp;<span class="op" id="3524816">-=</span>&nbsp;<span class="ident" id="3524819">x</span><span class="op" id="3524820">.</span><span class="ident" id="3524821">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524836">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524897">x</span><span class="op" id="3524898">.</span><span class="ident" id="3524899">b</span><span class="op" id="3524900">.</span><span class="ident" id="3524901">Decrypt</span><span class="op" id="3524908">(</span><span class="ident" id="3524909">dst</span><span class="op" id="3524912">[</span><span class="ident" id="3524913">start</span><span class="op" id="3524918">:</span><span class="ident" id="3524919">end</span><span class="op" id="3524922">]</span><span class="op" id="3524923">,</span>&nbsp;<span class="ident" id="3524925">src</span><span class="op" id="3524928">[</span><span class="ident" id="3524929">start</span><span class="op" id="3524934">:</span><span class="ident" id="3524935">end</span><span class="op" id="3524938">]</span><span class="op" id="3524939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524942">xorBytes</span><span class="op" id="3524950">(</span><span class="ident" id="3524951">dst</span><span class="op" id="3524954">[</span><span class="ident" id="3524955">start</span><span class="op" id="3524960">:</span><span class="ident" id="3524961">end</span><span class="op" id="3524964">]</span><span class="op" id="3524965">,</span>&nbsp;<span class="ident" id="3524967">dst</span><span class="op" id="3524970">[</span><span class="ident" id="3524971">start</span><span class="op" id="3524976">:</span><span class="ident" id="3524977">end</span><span class="op" id="3524980">]</span><span class="op" id="3524981">,</span>&nbsp;<span class="ident" id="3524983">x</span><span class="op" id="3524984">.</span><span class="ident" id="3524985">iv</span><span class="op" id="3524987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524991">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525048">x</span><span class="op" id="3525049">.</span><span class="ident" id="3525050">iv</span><span class="op" id="3525052">,</span>&nbsp;<span class="ident" id="3525054">x</span><span class="op" id="3525055">.</span><span class="ident" id="3525056">tmp</span>&nbsp;<span class="op" id="3525060">=</span>&nbsp;<span class="ident" id="3525062">x</span><span class="op" id="3525063">.</span><span class="ident" id="3525064">tmp</span><span class="op" id="3525067">,</span>&nbsp;<span class="ident" id="3525069">x</span><span class="op" id="3525070">.</span><span class="ident" id="3525071">iv</span><br>
<span class="lineno"></span><span class="op" id="3525074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3525077">func</span>&nbsp;<span class="op" id="3525082">(</span><span class="ident" id="3525083">x</span>&nbsp;<span class="op" id="3525085">*</span><span class="ident" id="3525086">cbcDecrypter</span><span class="op" id="3525098">)</span>&nbsp;<span class="ident" id="3525100">SetIV</span><span class="op" id="3525105">(</span><span class="ident" id="3525106">iv</span>&nbsp;<span class="op" id="3525109">[</span><span class="op" id="3525110">]</span><span class="builtintype" id="3525111">byte</span><span class="op" id="3525115">)</span>&nbsp;<span class="op" id="3525117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525120">if</span>&nbsp;<span class="builtinfunc" id="3525123">len</span><span class="op" id="3525126">(</span><span class="ident" id="3525127">iv</span><span class="op" id="3525129">)</span>&nbsp;<span class="op" id="3525131">!=</span>&nbsp;<span class="builtinfunc" id="3525134">len</span><span class="op" id="3525137">(</span><span class="ident" id="3525138">x</span><span class="op" id="3525139">.</span><span class="ident" id="3525140">iv</span><span class="op" id="3525142">)</span>&nbsp;<span class="op" id="3525144">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3525148">panic</span><span class="op" id="3525153">(</span><span class="string" id="3525154">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3525183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3525189">copy</span><span class="op" id="3525193">(</span><span class="ident" id="3525194">x</span><span class="op" id="3525195">.</span><span class="ident" id="3525196">iv</span><span class="op" id="3525198">,</span>&nbsp;<span class="ident" id="3525200">iv</span><span class="op" id="3525202">)</span><br>
<span class="lineno"></span><span class="op" id="3525204">}</span>
</div>
</body>
</html>
