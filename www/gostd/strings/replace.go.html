<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2914885">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2914940">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2914994">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2915045">package</span>&nbsp;<span class="ident" id="2915053">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2915062">import</span>&nbsp;<span class="string" id="2915069">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2915075">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2915133">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2915190">type</span>&nbsp;<span class="ident" id="2915195">Replacer</span>&nbsp;<span class="keyword" id="2915204">struct</span>&nbsp;<span class="op" id="2915211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915214">r</span>&nbsp;<span class="ident" id="2915216">replacer</span><br>
<span class="lineno"></span><span class="op" id="2915225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2915228">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2915306">type</span>&nbsp;<span class="ident" id="2915311">replacer</span>&nbsp;<span class="keyword" id="2915320">interface</span>&nbsp;<span class="op" id="2915330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915333">Replace</span><span class="op" id="2915340">(</span><span class="ident" id="2915341">s</span>&nbsp;<span class="builtintype" id="2915343">string</span><span class="op" id="2915349">)</span>&nbsp;<span class="builtintype" id="2915351">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915359">WriteString</span><span class="op" id="2915370">(</span><span class="ident" id="2915371">w</span>&nbsp;<span class="ident" id="2915373">io</span><span class="op" id="2915375">.</span><span class="ident" id="2915376">Writer</span><span class="op" id="2915382">,</span>&nbsp;<span class="ident" id="2915384">s</span>&nbsp;<span class="builtintype" id="2915386">string</span><span class="op" id="2915392">)</span>&nbsp;<span class="op" id="2915394">(</span><span class="ident" id="2915395">n</span>&nbsp;<span class="builtintype" id="2915397">int</span><span class="op" id="2915400">,</span>&nbsp;<span class="ident" id="2915402">err</span>&nbsp;<span class="builtintype" id="2915406">error</span><span class="op" id="2915411">)</span><br>
<span class="lineno"></span><span class="op" id="2915413">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2915416">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2915492">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2915561">func</span>&nbsp;<span class="ident" id="2915566">NewReplacer</span><span class="op" id="2915577">(</span><span class="ident" id="2915578">oldnew</span>&nbsp;<span class="op" id="2915585">...</span><span class="builtintype" id="2915588">string</span><span class="op" id="2915594">)</span>&nbsp;<span class="op" id="2915596">*</span><span class="ident" id="2915597">Replacer</span>&nbsp;<span class="op" id="2915606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915609">if</span>&nbsp;<span class="builtinfunc" id="2915612">len</span><span class="op" id="2915615">(</span><span class="ident" id="2915616">oldnew</span><span class="op" id="2915622">)</span><span class="op" id="2915623">%</span><span class="num" id="2915624">2</span>&nbsp;<span class="op" id="2915626">==</span>&nbsp;<span class="num" id="2915629">1</span>&nbsp;<span class="op" id="2915631">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2915635">panic</span><span class="op" id="2915640">(</span><span class="string" id="2915641">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2915682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915689">if</span>&nbsp;<span class="builtinfunc" id="2915692">len</span><span class="op" id="2915695">(</span><span class="ident" id="2915696">oldnew</span><span class="op" id="2915702">)</span>&nbsp;<span class="op" id="2915704">==</span>&nbsp;<span class="num" id="2915707">2</span>&nbsp;<span class="op" id="2915709">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2915712">len</span><span class="op" id="2915715">(</span><span class="ident" id="2915716">oldnew</span><span class="op" id="2915722">[</span><span class="num" id="2915723">0</span><span class="op" id="2915724">]</span><span class="op" id="2915725">)</span>&nbsp;<span class="op" id="2915727">&gt;</span>&nbsp;<span class="num" id="2915729">1</span>&nbsp;<span class="op" id="2915731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915735">return</span>&nbsp;<span class="op" id="2915742">&amp;</span><span class="ident" id="2915743">Replacer</span><span class="op" id="2915751">{</span><span class="ident" id="2915752">r</span><span class="op" id="2915753">:</span>&nbsp;<span class="ident" id="2915755">makeSingleStringReplacer</span><span class="op" id="2915779">(</span><span class="ident" id="2915780">oldnew</span><span class="op" id="2915786">[</span><span class="num" id="2915787">0</span><span class="op" id="2915788">]</span><span class="op" id="2915789">,</span>&nbsp;<span class="ident" id="2915791">oldnew</span><span class="op" id="2915797">[</span><span class="num" id="2915798">1</span><span class="op" id="2915799">]</span><span class="op" id="2915800">)</span><span class="op" id="2915801">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915808">allNewBytes</span>&nbsp;<span class="op" id="2915820">:=</span>&nbsp;<span class="builtintype" id="2915823">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915829">for</span>&nbsp;<span class="ident" id="2915833">i</span>&nbsp;<span class="op" id="2915835">:=</span>&nbsp;<span class="num" id="2915838">0</span><span class="op" id="2915839">;</span>&nbsp;<span class="ident" id="2915841">i</span>&nbsp;<span class="op" id="2915843">&lt;</span>&nbsp;<span class="builtinfunc" id="2915845">len</span><span class="op" id="2915848">(</span><span class="ident" id="2915849">oldnew</span><span class="op" id="2915855">)</span><span class="op" id="2915856">;</span>&nbsp;<span class="ident" id="2915858">i</span>&nbsp;<span class="op" id="2915860">+=</span>&nbsp;<span class="num" id="2915863">2</span>&nbsp;<span class="op" id="2915865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915869">if</span>&nbsp;<span class="builtinfunc" id="2915872">len</span><span class="op" id="2915875">(</span><span class="ident" id="2915876">oldnew</span><span class="op" id="2915882">[</span><span class="ident" id="2915883">i</span><span class="op" id="2915884">]</span><span class="op" id="2915885">)</span>&nbsp;<span class="op" id="2915887">!=</span>&nbsp;<span class="num" id="2915890">1</span>&nbsp;<span class="op" id="2915892">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915897">return</span>&nbsp;<span class="op" id="2915904">&amp;</span><span class="ident" id="2915905">Replacer</span><span class="op" id="2915913">{</span><span class="ident" id="2915914">r</span><span class="op" id="2915915">:</span>&nbsp;<span class="ident" id="2915917">makeGenericReplacer</span><span class="op" id="2915936">(</span><span class="ident" id="2915937">oldnew</span><span class="op" id="2915943">)</span><span class="op" id="2915944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2915948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2915952">if</span>&nbsp;<span class="builtinfunc" id="2915955">len</span><span class="op" id="2915958">(</span><span class="ident" id="2915959">oldnew</span><span class="op" id="2915965">[</span><span class="ident" id="2915966">i</span><span class="op" id="2915967">+</span><span class="num" id="2915968">1</span><span class="op" id="2915969">]</span><span class="op" id="2915970">)</span>&nbsp;<span class="op" id="2915972">!=</span>&nbsp;<span class="num" id="2915975">1</span>&nbsp;<span class="op" id="2915977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2915982">allNewBytes</span>&nbsp;<span class="op" id="2915994">=</span>&nbsp;<span class="builtintype" id="2915996">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916004">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916011">if</span>&nbsp;<span class="ident" id="2916014">allNewBytes</span>&nbsp;<span class="op" id="2916026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916030">r</span>&nbsp;<span class="op" id="2916032">:=</span>&nbsp;<span class="ident" id="2916035">byteReplacer</span><span class="op" id="2916047">{</span><span class="op" id="2916048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916052">for</span>&nbsp;<span class="ident" id="2916056">i</span>&nbsp;<span class="op" id="2916058">:=</span>&nbsp;<span class="keyword" id="2916061">range</span>&nbsp;<span class="ident" id="2916067">r</span>&nbsp;<span class="op" id="2916069">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916074">r</span><span class="op" id="2916075">[</span><span class="ident" id="2916076">i</span><span class="op" id="2916077">]</span>&nbsp;<span class="op" id="2916079">=</span>&nbsp;<span class="builtintype" id="2916081">byte</span><span class="op" id="2916085">(</span><span class="ident" id="2916086">i</span><span class="op" id="2916087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2916095">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2916154">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916201">for</span>&nbsp;<span class="ident" id="2916205">i</span>&nbsp;<span class="op" id="2916207">:=</span>&nbsp;<span class="builtinfunc" id="2916210">len</span><span class="op" id="2916213">(</span><span class="ident" id="2916214">oldnew</span><span class="op" id="2916220">)</span>&nbsp;<span class="op" id="2916222">-</span>&nbsp;<span class="num" id="2916224">2</span><span class="op" id="2916225">;</span>&nbsp;<span class="ident" id="2916227">i</span>&nbsp;<span class="op" id="2916229">&gt;=</span>&nbsp;<span class="num" id="2916232">0</span><span class="op" id="2916233">;</span>&nbsp;<span class="ident" id="2916235">i</span>&nbsp;<span class="op" id="2916237">-=</span>&nbsp;<span class="num" id="2916240">2</span>&nbsp;<span class="op" id="2916242">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916247">o</span>&nbsp;<span class="op" id="2916249">:=</span>&nbsp;<span class="ident" id="2916252">oldnew</span><span class="op" id="2916258">[</span><span class="ident" id="2916259">i</span><span class="op" id="2916260">]</span><span class="op" id="2916261">[</span><span class="num" id="2916262">0</span><span class="op" id="2916263">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916268">n</span>&nbsp;<span class="op" id="2916270">:=</span>&nbsp;<span class="ident" id="2916273">oldnew</span><span class="op" id="2916279">[</span><span class="ident" id="2916280">i</span><span class="op" id="2916281">+</span><span class="num" id="2916282">1</span><span class="op" id="2916283">]</span><span class="op" id="2916284">[</span><span class="num" id="2916285">0</span><span class="op" id="2916286">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916291">r</span><span class="op" id="2916292">[</span><span class="ident" id="2916293">o</span><span class="op" id="2916294">]</span>&nbsp;<span class="op" id="2916296">=</span>&nbsp;<span class="ident" id="2916298">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916306">return</span>&nbsp;<span class="op" id="2916313">&amp;</span><span class="ident" id="2916314">Replacer</span><span class="op" id="2916322">{</span><span class="ident" id="2916323">r</span><span class="op" id="2916324">:</span>&nbsp;<span class="op" id="2916326">&amp;</span><span class="ident" id="2916327">r</span><span class="op" id="2916328">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916335">r</span>&nbsp;<span class="op" id="2916337">:=</span>&nbsp;<span class="ident" id="2916340">byteStringReplacer</span><span class="op" id="2916358">{</span><span class="op" id="2916359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2916362">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2916420">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916466">for</span>&nbsp;<span class="ident" id="2916470">i</span>&nbsp;<span class="op" id="2916472">:=</span>&nbsp;<span class="builtinfunc" id="2916475">len</span><span class="op" id="2916478">(</span><span class="ident" id="2916479">oldnew</span><span class="op" id="2916485">)</span>&nbsp;<span class="op" id="2916487">-</span>&nbsp;<span class="num" id="2916489">2</span><span class="op" id="2916490">;</span>&nbsp;<span class="ident" id="2916492">i</span>&nbsp;<span class="op" id="2916494">&gt;=</span>&nbsp;<span class="num" id="2916497">0</span><span class="op" id="2916498">;</span>&nbsp;<span class="ident" id="2916500">i</span>&nbsp;<span class="op" id="2916502">-=</span>&nbsp;<span class="num" id="2916505">2</span>&nbsp;<span class="op" id="2916507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916511">o</span>&nbsp;<span class="op" id="2916513">:=</span>&nbsp;<span class="ident" id="2916516">oldnew</span><span class="op" id="2916522">[</span><span class="ident" id="2916523">i</span><span class="op" id="2916524">]</span><span class="op" id="2916525">[</span><span class="num" id="2916526">0</span><span class="op" id="2916527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916531">n</span>&nbsp;<span class="op" id="2916533">:=</span>&nbsp;<span class="ident" id="2916536">oldnew</span><span class="op" id="2916542">[</span><span class="ident" id="2916543">i</span><span class="op" id="2916544">+</span><span class="num" id="2916545">1</span><span class="op" id="2916546">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2916550">r</span><span class="op" id="2916551">[</span><span class="ident" id="2916552">o</span><span class="op" id="2916553">]</span>&nbsp;<span class="op" id="2916555">=</span>&nbsp;<span class="op" id="2916557">[</span><span class="op" id="2916558">]</span><span class="builtintype" id="2916559">byte</span><span class="op" id="2916563">(</span><span class="ident" id="2916564">n</span><span class="op" id="2916565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2916568">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916571">return</span>&nbsp;<span class="op" id="2916578">&amp;</span><span class="ident" id="2916579">Replacer</span><span class="op" id="2916587">{</span><span class="ident" id="2916588">r</span><span class="op" id="2916589">:</span>&nbsp;<span class="op" id="2916591">&amp;</span><span class="ident" id="2916592">r</span><span class="op" id="2916593">}</span><br>
<span class="lineno"></span><span class="op" id="2916595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2916598">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2916662">func</span>&nbsp;<span class="op" id="2916667">(</span><span class="ident" id="2916668">r</span>&nbsp;<span class="op" id="2916670">*</span><span class="ident" id="2916671">Replacer</span><span class="op" id="2916679">)</span>&nbsp;<span class="ident" id="2916681">Replace</span><span class="op" id="2916688">(</span><span class="ident" id="2916689">s</span>&nbsp;<span class="builtintype" id="2916691">string</span><span class="op" id="2916697">)</span>&nbsp;<span class="builtintype" id="2916699">string</span>&nbsp;<span class="op" id="2916706">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916709">return</span>&nbsp;<span class="ident" id="2916716">r</span><span class="op" id="2916717">.</span><span class="ident" id="2916718">r</span><span class="op" id="2916719">.</span><span class="ident" id="2916720">Replace</span><span class="op" id="2916727">(</span><span class="ident" id="2916728">s</span><span class="op" id="2916729">)</span><br>
<span class="lineno"></span><span class="op" id="2916731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2916734">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2916796">func</span>&nbsp;<span class="op" id="2916801">(</span><span class="ident" id="2916802">r</span>&nbsp;<span class="op" id="2916804">*</span><span class="ident" id="2916805">Replacer</span><span class="op" id="2916813">)</span>&nbsp;<span class="ident" id="2916815">WriteString</span><span class="op" id="2916826">(</span><span class="ident" id="2916827">w</span>&nbsp;<span class="ident" id="2916829">io</span><span class="op" id="2916831">.</span><span class="ident" id="2916832">Writer</span><span class="op" id="2916838">,</span>&nbsp;<span class="ident" id="2916840">s</span>&nbsp;<span class="builtintype" id="2916842">string</span><span class="op" id="2916848">)</span>&nbsp;<span class="op" id="2916850">(</span><span class="ident" id="2916851">n</span>&nbsp;<span class="builtintype" id="2916853">int</span><span class="op" id="2916856">,</span>&nbsp;<span class="ident" id="2916858">err</span>&nbsp;<span class="builtintype" id="2916862">error</span><span class="op" id="2916867">)</span>&nbsp;<span class="op" id="2916869">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2916872">return</span>&nbsp;<span class="ident" id="2916879">r</span><span class="op" id="2916880">.</span><span class="ident" id="2916881">r</span><span class="op" id="2916882">.</span><span class="ident" id="2916883">WriteString</span><span class="op" id="2916894">(</span><span class="ident" id="2916895">w</span><span class="op" id="2916896">,</span>&nbsp;<span class="ident" id="2916898">s</span><span class="op" id="2916899">)</span><br>
<span class="lineno"></span><span class="op" id="2916901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2916904">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2916981">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2917059">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2917107">//</span><br>
<span class="lineno"></span><span class="comment" id="2917110">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2917120">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2917131">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2917143">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2917155">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2917166">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2917180">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2917191">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2917203">//</span><br>
<span class="lineno"></span><span class="comment" id="2917206">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2917284">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2917362">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2917436">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2917487">type</span>&nbsp;<span class="ident" id="2917492">trieNode</span>&nbsp;<span class="keyword" id="2917501">struct</span>&nbsp;<span class="op" id="2917508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917511">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917584">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917621">value</span>&nbsp;<span class="builtintype" id="2917627">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917635">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917710">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917785">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917858">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917931">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917963">priority</span>&nbsp;<span class="builtintype" id="2917972">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2917978">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918034">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918098">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918166">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918224">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918228">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918300">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918358">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918432">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918509">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918584">prefix</span>&nbsp;<span class="builtintype" id="2918591">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918599">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2918606">*</span><span class="ident" id="2918607">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918618">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918689">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918763">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918837">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918911">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918976">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919051">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919073">table</span>&nbsp;<span class="op" id="2919079">[</span><span class="op" id="2919080">]</span><span class="op" id="2919081">*</span><span class="ident" id="2919082">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2919091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2919094">func</span>&nbsp;<span class="op" id="2919099">(</span><span class="ident" id="2919100">t</span>&nbsp;<span class="op" id="2919102">*</span><span class="ident" id="2919103">trieNode</span><span class="op" id="2919111">)</span>&nbsp;<span class="ident" id="2919113">add</span><span class="op" id="2919116">(</span><span class="ident" id="2919117">key</span><span class="op" id="2919120">,</span>&nbsp;<span class="ident" id="2919122">val</span>&nbsp;<span class="builtintype" id="2919126">string</span><span class="op" id="2919132">,</span>&nbsp;<span class="ident" id="2919134">priority</span>&nbsp;<span class="builtintype" id="2919143">int</span><span class="op" id="2919146">,</span>&nbsp;<span class="ident" id="2919148">r</span>&nbsp;<span class="op" id="2919150">*</span><span class="ident" id="2919151">genericReplacer</span><span class="op" id="2919166">)</span>&nbsp;<span class="op" id="2919168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919171">if</span>&nbsp;<span class="ident" id="2919174">key</span>&nbsp;<span class="op" id="2919178">==</span>&nbsp;<span class="string" id="2919181">&#34;&#34;</span>&nbsp;<span class="op" id="2919184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919188">if</span>&nbsp;<span class="ident" id="2919191">t</span><span class="op" id="2919192">.</span><span class="ident" id="2919193">priority</span>&nbsp;<span class="op" id="2919202">==</span>&nbsp;<span class="num" id="2919205">0</span>&nbsp;<span class="op" id="2919207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919212">t</span><span class="op" id="2919213">.</span><span class="ident" id="2919214">value</span>&nbsp;<span class="op" id="2919220">=</span>&nbsp;<span class="ident" id="2919222">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919229">t</span><span class="op" id="2919230">.</span><span class="ident" id="2919231">priority</span>&nbsp;<span class="op" id="2919240">=</span>&nbsp;<span class="ident" id="2919242">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919257">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919269">if</span>&nbsp;<span class="ident" id="2919272">t</span><span class="op" id="2919273">.</span><span class="ident" id="2919274">prefix</span>&nbsp;<span class="op" id="2919281">!=</span>&nbsp;<span class="string" id="2919284">&#34;&#34;</span>&nbsp;<span class="op" id="2919287">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919291">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919343">var</span>&nbsp;<span class="ident" id="2919347">n</span>&nbsp;<span class="builtintype" id="2919349">int</span>&nbsp;<span class="comment" id="2919353">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919394">for</span>&nbsp;<span class="op" id="2919398">;</span>&nbsp;<span class="ident" id="2919400">n</span>&nbsp;<span class="op" id="2919402">&lt;</span>&nbsp;<span class="builtinfunc" id="2919404">len</span><span class="op" id="2919407">(</span><span class="ident" id="2919408">t</span><span class="op" id="2919409">.</span><span class="ident" id="2919410">prefix</span><span class="op" id="2919416">)</span>&nbsp;<span class="op" id="2919418">&amp;&amp;</span>&nbsp;<span class="ident" id="2919421">n</span>&nbsp;<span class="op" id="2919423">&lt;</span>&nbsp;<span class="builtinfunc" id="2919425">len</span><span class="op" id="2919428">(</span><span class="ident" id="2919429">key</span><span class="op" id="2919432">)</span><span class="op" id="2919433">;</span>&nbsp;<span class="ident" id="2919435">n</span><span class="op" id="2919436">++</span>&nbsp;<span class="op" id="2919439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919444">if</span>&nbsp;<span class="ident" id="2919447">t</span><span class="op" id="2919448">.</span><span class="ident" id="2919449">prefix</span><span class="op" id="2919455">[</span><span class="ident" id="2919456">n</span><span class="op" id="2919457">]</span>&nbsp;<span class="op" id="2919459">!=</span>&nbsp;<span class="ident" id="2919462">key</span><span class="op" id="2919465">[</span><span class="ident" id="2919466">n</span><span class="op" id="2919467">]</span>&nbsp;<span class="op" id="2919469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919475">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919492">if</span>&nbsp;<span class="ident" id="2919495">n</span>&nbsp;<span class="op" id="2919497">==</span>&nbsp;<span class="builtinfunc" id="2919500">len</span><span class="op" id="2919503">(</span><span class="ident" id="2919504">t</span><span class="op" id="2919505">.</span><span class="ident" id="2919506">prefix</span><span class="op" id="2919512">)</span>&nbsp;<span class="op" id="2919514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919519">t</span><span class="op" id="2919520">.</span><span class="ident" id="2919521">next</span><span class="op" id="2919525">.</span><span class="ident" id="2919526">add</span><span class="op" id="2919529">(</span><span class="ident" id="2919530">key</span><span class="op" id="2919533">[</span><span class="ident" id="2919534">n</span><span class="op" id="2919535">:</span><span class="op" id="2919536">]</span><span class="op" id="2919537">,</span>&nbsp;<span class="ident" id="2919539">val</span><span class="op" id="2919542">,</span>&nbsp;<span class="ident" id="2919544">priority</span><span class="op" id="2919552">,</span>&nbsp;<span class="ident" id="2919554">r</span><span class="op" id="2919555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919559">}</span>&nbsp;<span class="keyword" id="2919561">else</span>&nbsp;<span class="keyword" id="2919566">if</span>&nbsp;<span class="ident" id="2919569">n</span>&nbsp;<span class="op" id="2919571">==</span>&nbsp;<span class="num" id="2919574">0</span>&nbsp;<span class="op" id="2919576">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919581">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919649">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919714">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919760">var</span>&nbsp;<span class="ident" id="2919764">prefixNode</span>&nbsp;<span class="op" id="2919775">*</span><span class="ident" id="2919776">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919788">if</span>&nbsp;<span class="builtinfunc" id="2919791">len</span><span class="op" id="2919794">(</span><span class="ident" id="2919795">t</span><span class="op" id="2919796">.</span><span class="ident" id="2919797">prefix</span><span class="op" id="2919803">)</span>&nbsp;<span class="op" id="2919805">==</span>&nbsp;<span class="num" id="2919808">1</span>&nbsp;<span class="op" id="2919810">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919816">prefixNode</span>&nbsp;<span class="op" id="2919827">=</span>&nbsp;<span class="ident" id="2919829">t</span><span class="op" id="2919830">.</span><span class="ident" id="2919831">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919839">}</span>&nbsp;<span class="keyword" id="2919841">else</span>&nbsp;<span class="op" id="2919846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919852">prefixNode</span>&nbsp;<span class="op" id="2919863">=</span>&nbsp;<span class="op" id="2919865">&amp;</span><span class="ident" id="2919866">trieNode</span><span class="op" id="2919874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919881">prefix</span><span class="op" id="2919887">:</span>&nbsp;<span class="ident" id="2919889">t</span><span class="op" id="2919890">.</span><span class="ident" id="2919891">prefix</span><span class="op" id="2919897">[</span><span class="num" id="2919898">1</span><span class="op" id="2919899">:</span><span class="op" id="2919900">]</span><span class="op" id="2919901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919908">next</span><span class="op" id="2919912">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2919916">t</span><span class="op" id="2919917">.</span><span class="ident" id="2919918">next</span><span class="op" id="2919922">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919938">keyNode</span>&nbsp;<span class="op" id="2919946">:=</span>&nbsp;<span class="builtinfunc" id="2919949">new</span><span class="op" id="2919952">(</span><span class="ident" id="2919953">trieNode</span><span class="op" id="2919961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919966">t</span><span class="op" id="2919967">.</span><span class="ident" id="2919968">table</span>&nbsp;<span class="op" id="2919974">=</span>&nbsp;<span class="builtinfunc" id="2919976">make</span><span class="op" id="2919980">(</span><span class="op" id="2919981">[</span><span class="op" id="2919982">]</span><span class="op" id="2919983">*</span><span class="ident" id="2919984">trieNode</span><span class="op" id="2919992">,</span>&nbsp;<span class="ident" id="2919994">r</span><span class="op" id="2919995">.</span><span class="ident" id="2919996">tableSize</span><span class="op" id="2920005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920010">t</span><span class="op" id="2920011">.</span><span class="ident" id="2920012">table</span><span class="op" id="2920017">[</span><span class="ident" id="2920018">r</span><span class="op" id="2920019">.</span><span class="ident" id="2920020">mapping</span><span class="op" id="2920027">[</span><span class="ident" id="2920028">t</span><span class="op" id="2920029">.</span><span class="ident" id="2920030">prefix</span><span class="op" id="2920036">[</span><span class="num" id="2920037">0</span><span class="op" id="2920038">]</span><span class="op" id="2920039">]</span><span class="op" id="2920040">]</span>&nbsp;<span class="op" id="2920042">=</span>&nbsp;<span class="ident" id="2920044">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920058">t</span><span class="op" id="2920059">.</span><span class="ident" id="2920060">table</span><span class="op" id="2920065">[</span><span class="ident" id="2920066">r</span><span class="op" id="2920067">.</span><span class="ident" id="2920068">mapping</span><span class="op" id="2920075">[</span><span class="ident" id="2920076">key</span><span class="op" id="2920079">[</span><span class="num" id="2920080">0</span><span class="op" id="2920081">]</span><span class="op" id="2920082">]</span><span class="op" id="2920083">]</span>&nbsp;<span class="op" id="2920085">=</span>&nbsp;<span class="ident" id="2920087">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920098">t</span><span class="op" id="2920099">.</span><span class="ident" id="2920100">prefix</span>&nbsp;<span class="op" id="2920107">=</span>&nbsp;<span class="string" id="2920109">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920115">t</span><span class="op" id="2920116">.</span><span class="ident" id="2920117">next</span>&nbsp;<span class="op" id="2920122">=</span>&nbsp;<span class="ident" id="2920124">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920131">keyNode</span><span class="op" id="2920138">.</span><span class="ident" id="2920139">add</span><span class="op" id="2920142">(</span><span class="ident" id="2920143">key</span><span class="op" id="2920146">[</span><span class="num" id="2920147">1</span><span class="op" id="2920148">:</span><span class="op" id="2920149">]</span><span class="op" id="2920150">,</span>&nbsp;<span class="ident" id="2920152">val</span><span class="op" id="2920155">,</span>&nbsp;<span class="ident" id="2920157">priority</span><span class="op" id="2920165">,</span>&nbsp;<span class="ident" id="2920167">r</span><span class="op" id="2920168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920172">}</span>&nbsp;<span class="keyword" id="2920174">else</span>&nbsp;<span class="op" id="2920179">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920184">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920246">next</span>&nbsp;<span class="op" id="2920251">:=</span>&nbsp;<span class="op" id="2920254">&amp;</span><span class="ident" id="2920255">trieNode</span><span class="op" id="2920263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920269">prefix</span><span class="op" id="2920275">:</span>&nbsp;<span class="ident" id="2920277">t</span><span class="op" id="2920278">.</span><span class="ident" id="2920279">prefix</span><span class="op" id="2920285">[</span><span class="ident" id="2920286">n</span><span class="op" id="2920287">:</span><span class="op" id="2920288">]</span><span class="op" id="2920289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920295">next</span><span class="op" id="2920299">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2920303">t</span><span class="op" id="2920304">.</span><span class="ident" id="2920305">next</span><span class="op" id="2920309">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920314">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920319">t</span><span class="op" id="2920320">.</span><span class="ident" id="2920321">prefix</span>&nbsp;<span class="op" id="2920328">=</span>&nbsp;<span class="ident" id="2920330">t</span><span class="op" id="2920331">.</span><span class="ident" id="2920332">prefix</span><span class="op" id="2920338">[</span><span class="op" id="2920339">:</span><span class="ident" id="2920340">n</span><span class="op" id="2920341">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920346">t</span><span class="op" id="2920347">.</span><span class="ident" id="2920348">next</span>&nbsp;<span class="op" id="2920353">=</span>&nbsp;<span class="ident" id="2920355">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920363">next</span><span class="op" id="2920367">.</span><span class="ident" id="2920368">add</span><span class="op" id="2920371">(</span><span class="ident" id="2920372">key</span><span class="op" id="2920375">[</span><span class="ident" id="2920376">n</span><span class="op" id="2920377">:</span><span class="op" id="2920378">]</span><span class="op" id="2920379">,</span>&nbsp;<span class="ident" id="2920381">val</span><span class="op" id="2920384">,</span>&nbsp;<span class="ident" id="2920386">priority</span><span class="op" id="2920394">,</span>&nbsp;<span class="ident" id="2920396">r</span><span class="op" id="2920397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920404">}</span>&nbsp;<span class="keyword" id="2920406">else</span>&nbsp;<span class="keyword" id="2920411">if</span>&nbsp;<span class="ident" id="2920414">t</span><span class="op" id="2920415">.</span><span class="ident" id="2920416">table</span>&nbsp;<span class="op" id="2920422">!=</span>&nbsp;<span class="ident" id="2920425">nil</span>&nbsp;<span class="op" id="2920429">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920433">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920466">m</span>&nbsp;<span class="op" id="2920468">:=</span>&nbsp;<span class="ident" id="2920471">r</span><span class="op" id="2920472">.</span><span class="ident" id="2920473">mapping</span><span class="op" id="2920480">[</span><span class="ident" id="2920481">key</span><span class="op" id="2920484">[</span><span class="num" id="2920485">0</span><span class="op" id="2920486">]</span><span class="op" id="2920487">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920491">if</span>&nbsp;<span class="ident" id="2920494">t</span><span class="op" id="2920495">.</span><span class="ident" id="2920496">table</span><span class="op" id="2920501">[</span><span class="ident" id="2920502">m</span><span class="op" id="2920503">]</span>&nbsp;<span class="op" id="2920505">==</span>&nbsp;<span class="ident" id="2920508">nil</span>&nbsp;<span class="op" id="2920512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920517">t</span><span class="op" id="2920518">.</span><span class="ident" id="2920519">table</span><span class="op" id="2920524">[</span><span class="ident" id="2920525">m</span><span class="op" id="2920526">]</span>&nbsp;<span class="op" id="2920528">=</span>&nbsp;<span class="builtinfunc" id="2920530">new</span><span class="op" id="2920533">(</span><span class="ident" id="2920534">trieNode</span><span class="op" id="2920542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920546">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920550">t</span><span class="op" id="2920551">.</span><span class="ident" id="2920552">table</span><span class="op" id="2920557">[</span><span class="ident" id="2920558">m</span><span class="op" id="2920559">]</span><span class="op" id="2920560">.</span><span class="ident" id="2920561">add</span><span class="op" id="2920564">(</span><span class="ident" id="2920565">key</span><span class="op" id="2920568">[</span><span class="num" id="2920569">1</span><span class="op" id="2920570">:</span><span class="op" id="2920571">]</span><span class="op" id="2920572">,</span>&nbsp;<span class="ident" id="2920574">val</span><span class="op" id="2920577">,</span>&nbsp;<span class="ident" id="2920579">priority</span><span class="op" id="2920587">,</span>&nbsp;<span class="ident" id="2920589">r</span><span class="op" id="2920590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920593">}</span>&nbsp;<span class="keyword" id="2920595">else</span>&nbsp;<span class="op" id="2920600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920604">t</span><span class="op" id="2920605">.</span><span class="ident" id="2920606">prefix</span>&nbsp;<span class="op" id="2920613">=</span>&nbsp;<span class="ident" id="2920615">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920621">t</span><span class="op" id="2920622">.</span><span class="ident" id="2920623">next</span>&nbsp;<span class="op" id="2920628">=</span>&nbsp;<span class="builtinfunc" id="2920630">new</span><span class="op" id="2920633">(</span><span class="ident" id="2920634">trieNode</span><span class="op" id="2920642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920646">t</span><span class="op" id="2920647">.</span><span class="ident" id="2920648">next</span><span class="op" id="2920652">.</span><span class="ident" id="2920653">add</span><span class="op" id="2920656">(</span><span class="string" id="2920657">&#34;&#34;</span><span class="op" id="2920659">,</span>&nbsp;<span class="ident" id="2920661">val</span><span class="op" id="2920664">,</span>&nbsp;<span class="ident" id="2920666">priority</span><span class="op" id="2920674">,</span>&nbsp;<span class="ident" id="2920676">r</span><span class="op" id="2920677">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920680">}</span><br>
<span class="lineno"></span><span class="op" id="2920682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2920685">func</span>&nbsp;<span class="op" id="2920690">(</span><span class="ident" id="2920691">r</span>&nbsp;<span class="op" id="2920693">*</span><span class="ident" id="2920694">genericReplacer</span><span class="op" id="2920709">)</span>&nbsp;<span class="ident" id="2920711">lookup</span><span class="op" id="2920717">(</span><span class="ident" id="2920718">s</span>&nbsp;<span class="builtintype" id="2920720">string</span><span class="op" id="2920726">,</span>&nbsp;<span class="ident" id="2920728">ignoreRoot</span>&nbsp;<span class="builtintype" id="2920739">bool</span><span class="op" id="2920743">)</span>&nbsp;<span class="op" id="2920745">(</span><span class="ident" id="2920746">val</span>&nbsp;<span class="builtintype" id="2920750">string</span><span class="op" id="2920756">,</span>&nbsp;<span class="ident" id="2920758">keylen</span>&nbsp;<span class="builtintype" id="2920765">int</span><span class="op" id="2920768">,</span>&nbsp;<span class="ident" id="2920770">found</span>&nbsp;<span class="builtintype" id="2920776">bool</span><span class="op" id="2920780">)</span>&nbsp;<span class="op" id="2920782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920785">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920858">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920884">bestPriority</span>&nbsp;<span class="op" id="2920897">:=</span>&nbsp;<span class="num" id="2920900">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920903">node</span>&nbsp;<span class="op" id="2920908">:=</span>&nbsp;<span class="op" id="2920911">&amp;</span><span class="ident" id="2920912">r</span><span class="op" id="2920913">.</span><span class="ident" id="2920914">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920920">n</span>&nbsp;<span class="op" id="2920922">:=</span>&nbsp;<span class="num" id="2920925">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920928">for</span>&nbsp;<span class="ident" id="2920932">node</span>&nbsp;<span class="op" id="2920937">!=</span>&nbsp;<span class="ident" id="2920940">nil</span>&nbsp;<span class="op" id="2920944">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920948">if</span>&nbsp;<span class="ident" id="2920951">node</span><span class="op" id="2920955">.</span><span class="ident" id="2920956">priority</span>&nbsp;<span class="op" id="2920965">&gt;</span>&nbsp;<span class="ident" id="2920967">bestPriority</span>&nbsp;<span class="op" id="2920980">&amp;&amp;</span>&nbsp;<span class="op" id="2920983">!</span><span class="op" id="2920984">(</span><span class="ident" id="2920985">ignoreRoot</span>&nbsp;<span class="op" id="2920996">&amp;&amp;</span>&nbsp;<span class="ident" id="2920999">node</span>&nbsp;<span class="op" id="2921004">==</span>&nbsp;<span class="op" id="2921007">&amp;</span><span class="ident" id="2921008">r</span><span class="op" id="2921009">.</span><span class="ident" id="2921010">root</span><span class="op" id="2921014">)</span>&nbsp;<span class="op" id="2921016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921021">bestPriority</span>&nbsp;<span class="op" id="2921034">=</span>&nbsp;<span class="ident" id="2921036">node</span><span class="op" id="2921040">.</span><span class="ident" id="2921041">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921053">val</span>&nbsp;<span class="op" id="2921057">=</span>&nbsp;<span class="ident" id="2921059">node</span><span class="op" id="2921063">.</span><span class="ident" id="2921064">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921073">keylen</span>&nbsp;<span class="op" id="2921080">=</span>&nbsp;<span class="ident" id="2921082">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921087">found</span>&nbsp;<span class="op" id="2921093">=</span>&nbsp;<span class="builtintype" id="2921095">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921107">if</span>&nbsp;<span class="ident" id="2921110">s</span>&nbsp;<span class="op" id="2921112">==</span>&nbsp;<span class="string" id="2921115">&#34;&#34;</span>&nbsp;<span class="op" id="2921118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921123">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921131">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921135">if</span>&nbsp;<span class="ident" id="2921138">node</span><span class="op" id="2921142">.</span><span class="ident" id="2921143">table</span>&nbsp;<span class="op" id="2921149">!=</span>&nbsp;<span class="ident" id="2921152">nil</span>&nbsp;<span class="op" id="2921156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921161">index</span>&nbsp;<span class="op" id="2921167">:=</span>&nbsp;<span class="ident" id="2921170">r</span><span class="op" id="2921171">.</span><span class="ident" id="2921172">mapping</span><span class="op" id="2921179">[</span><span class="ident" id="2921180">s</span><span class="op" id="2921181">[</span><span class="num" id="2921182">0</span><span class="op" id="2921183">]</span><span class="op" id="2921184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921189">if</span>&nbsp;<span class="builtintype" id="2921192">int</span><span class="op" id="2921195">(</span><span class="ident" id="2921196">index</span><span class="op" id="2921201">)</span>&nbsp;<span class="op" id="2921203">==</span>&nbsp;<span class="ident" id="2921206">r</span><span class="op" id="2921207">.</span><span class="ident" id="2921208">tableSize</span>&nbsp;<span class="op" id="2921218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921224">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921233">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921238">node</span>&nbsp;<span class="op" id="2921243">=</span>&nbsp;<span class="ident" id="2921245">node</span><span class="op" id="2921249">.</span><span class="ident" id="2921250">table</span><span class="op" id="2921255">[</span><span class="ident" id="2921256">index</span><span class="op" id="2921261">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921266">s</span>&nbsp;<span class="op" id="2921268">=</span>&nbsp;<span class="ident" id="2921270">s</span><span class="op" id="2921271">[</span><span class="num" id="2921272">1</span><span class="op" id="2921273">:</span><span class="op" id="2921274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921279">n</span><span class="op" id="2921280">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921285">}</span>&nbsp;<span class="keyword" id="2921287">else</span>&nbsp;<span class="keyword" id="2921292">if</span>&nbsp;<span class="ident" id="2921295">node</span><span class="op" id="2921299">.</span><span class="ident" id="2921300">prefix</span>&nbsp;<span class="op" id="2921307">!=</span>&nbsp;<span class="string" id="2921310">&#34;&#34;</span>&nbsp;<span class="op" id="2921313">&amp;&amp;</span>&nbsp;<span class="ident" id="2921316">HasPrefix</span><span class="op" id="2921325">(</span><span class="ident" id="2921326">s</span><span class="op" id="2921327">,</span>&nbsp;<span class="ident" id="2921329">node</span><span class="op" id="2921333">.</span><span class="ident" id="2921334">prefix</span><span class="op" id="2921340">)</span>&nbsp;<span class="op" id="2921342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921347">n</span>&nbsp;<span class="op" id="2921349">+=</span>&nbsp;<span class="builtinfunc" id="2921352">len</span><span class="op" id="2921355">(</span><span class="ident" id="2921356">node</span><span class="op" id="2921360">.</span><span class="ident" id="2921361">prefix</span><span class="op" id="2921367">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921372">s</span>&nbsp;<span class="op" id="2921374">=</span>&nbsp;<span class="ident" id="2921376">s</span><span class="op" id="2921377">[</span><span class="builtinfunc" id="2921378">len</span><span class="op" id="2921381">(</span><span class="ident" id="2921382">node</span><span class="op" id="2921386">.</span><span class="ident" id="2921387">prefix</span><span class="op" id="2921393">)</span><span class="op" id="2921394">:</span><span class="op" id="2921395">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921400">node</span>&nbsp;<span class="op" id="2921405">=</span>&nbsp;<span class="ident" id="2921407">node</span><span class="op" id="2921411">.</span><span class="ident" id="2921412">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921419">}</span>&nbsp;<span class="keyword" id="2921421">else</span>&nbsp;<span class="op" id="2921426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921431">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921439">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921445">return</span><br>
<span class="lineno"></span><span class="op" id="2921452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2921455">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2921506">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2921566">type</span>&nbsp;<span class="ident" id="2921571">genericReplacer</span>&nbsp;<span class="keyword" id="2921587">struct</span>&nbsp;<span class="op" id="2921594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921597">root</span>&nbsp;<span class="ident" id="2921602">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921612">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921686">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921711">tableSize</span>&nbsp;<span class="builtintype" id="2921721">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921726">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921795">mapping</span>&nbsp;<span class="op" id="2921803">[</span><span class="num" id="2921804">256</span><span class="op" id="2921807">]</span><span class="builtintype" id="2921808">byte</span><br>
<span class="lineno"></span><span class="op" id="2921813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2921816">func</span>&nbsp;<span class="ident" id="2921821">makeGenericReplacer</span><span class="op" id="2921840">(</span><span class="ident" id="2921841">oldnew</span>&nbsp;<span class="op" id="2921848">[</span><span class="op" id="2921849">]</span><span class="builtintype" id="2921850">string</span><span class="op" id="2921856">)</span>&nbsp;<span class="op" id="2921858">*</span><span class="ident" id="2921859">genericReplacer</span>&nbsp;<span class="op" id="2921875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921878">r</span>&nbsp;<span class="op" id="2921880">:=</span>&nbsp;<span class="builtinfunc" id="2921883">new</span><span class="op" id="2921886">(</span><span class="ident" id="2921887">genericReplacer</span><span class="op" id="2921902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921905">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921962">for</span>&nbsp;<span class="ident" id="2921966">i</span>&nbsp;<span class="op" id="2921968">:=</span>&nbsp;<span class="num" id="2921971">0</span><span class="op" id="2921972">;</span>&nbsp;<span class="ident" id="2921974">i</span>&nbsp;<span class="op" id="2921976">&lt;</span>&nbsp;<span class="builtinfunc" id="2921978">len</span><span class="op" id="2921981">(</span><span class="ident" id="2921982">oldnew</span><span class="op" id="2921988">)</span><span class="op" id="2921989">;</span>&nbsp;<span class="ident" id="2921991">i</span>&nbsp;<span class="op" id="2921993">+=</span>&nbsp;<span class="num" id="2921996">2</span>&nbsp;<span class="op" id="2921998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922002">key</span>&nbsp;<span class="op" id="2922006">:=</span>&nbsp;<span class="ident" id="2922009">oldnew</span><span class="op" id="2922015">[</span><span class="ident" id="2922016">i</span><span class="op" id="2922017">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922021">for</span>&nbsp;<span class="ident" id="2922025">j</span>&nbsp;<span class="op" id="2922027">:=</span>&nbsp;<span class="num" id="2922030">0</span><span class="op" id="2922031">;</span>&nbsp;<span class="ident" id="2922033">j</span>&nbsp;<span class="op" id="2922035">&lt;</span>&nbsp;<span class="builtinfunc" id="2922037">len</span><span class="op" id="2922040">(</span><span class="ident" id="2922041">key</span><span class="op" id="2922044">)</span><span class="op" id="2922045">;</span>&nbsp;<span class="ident" id="2922047">j</span><span class="op" id="2922048">++</span>&nbsp;<span class="op" id="2922051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922056">r</span><span class="op" id="2922057">.</span><span class="ident" id="2922058">mapping</span><span class="op" id="2922065">[</span><span class="ident" id="2922066">key</span><span class="op" id="2922069">[</span><span class="ident" id="2922070">j</span><span class="op" id="2922071">]</span><span class="op" id="2922072">]</span>&nbsp;<span class="op" id="2922074">=</span>&nbsp;<span class="num" id="2922076">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922087">for</span>&nbsp;<span class="ident" id="2922091">_</span><span class="op" id="2922092">,</span>&nbsp;<span class="ident" id="2922094">b</span>&nbsp;<span class="op" id="2922096">:=</span>&nbsp;<span class="keyword" id="2922099">range</span>&nbsp;<span class="ident" id="2922105">r</span><span class="op" id="2922106">.</span><span class="ident" id="2922107">mapping</span>&nbsp;<span class="op" id="2922115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922119">r</span><span class="op" id="2922120">.</span><span class="ident" id="2922121">tableSize</span>&nbsp;<span class="op" id="2922131">+=</span>&nbsp;<span class="builtintype" id="2922134">int</span><span class="op" id="2922137">(</span><span class="ident" id="2922138">b</span><span class="op" id="2922139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922146">var</span>&nbsp;<span class="ident" id="2922150">index</span>&nbsp;<span class="builtintype" id="2922156">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922162">for</span>&nbsp;<span class="ident" id="2922166">i</span><span class="op" id="2922167">,</span>&nbsp;<span class="ident" id="2922169">b</span>&nbsp;<span class="op" id="2922171">:=</span>&nbsp;<span class="keyword" id="2922174">range</span>&nbsp;<span class="ident" id="2922180">r</span><span class="op" id="2922181">.</span><span class="ident" id="2922182">mapping</span>&nbsp;<span class="op" id="2922190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922194">if</span>&nbsp;<span class="ident" id="2922197">b</span>&nbsp;<span class="op" id="2922199">==</span>&nbsp;<span class="num" id="2922202">0</span>&nbsp;<span class="op" id="2922204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922209">r</span><span class="op" id="2922210">.</span><span class="ident" id="2922211">mapping</span><span class="op" id="2922218">[</span><span class="ident" id="2922219">i</span><span class="op" id="2922220">]</span>&nbsp;<span class="op" id="2922222">=</span>&nbsp;<span class="builtintype" id="2922224">byte</span><span class="op" id="2922228">(</span><span class="ident" id="2922229">r</span><span class="op" id="2922230">.</span><span class="ident" id="2922231">tableSize</span><span class="op" id="2922240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922244">}</span>&nbsp;<span class="keyword" id="2922246">else</span>&nbsp;<span class="op" id="2922251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922256">r</span><span class="op" id="2922257">.</span><span class="ident" id="2922258">mapping</span><span class="op" id="2922265">[</span><span class="ident" id="2922266">i</span><span class="op" id="2922267">]</span>&nbsp;<span class="op" id="2922269">=</span>&nbsp;<span class="ident" id="2922271">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922280">index</span><span class="op" id="2922285">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2922296">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922356">r</span><span class="op" id="2922357">.</span><span class="ident" id="2922358">root</span><span class="op" id="2922362">.</span><span class="ident" id="2922363">table</span>&nbsp;<span class="op" id="2922369">=</span>&nbsp;<span class="builtinfunc" id="2922371">make</span><span class="op" id="2922375">(</span><span class="op" id="2922376">[</span><span class="op" id="2922377">]</span><span class="op" id="2922378">*</span><span class="ident" id="2922379">trieNode</span><span class="op" id="2922387">,</span>&nbsp;<span class="ident" id="2922389">r</span><span class="op" id="2922390">.</span><span class="ident" id="2922391">tableSize</span><span class="op" id="2922400">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922404">for</span>&nbsp;<span class="ident" id="2922408">i</span>&nbsp;<span class="op" id="2922410">:=</span>&nbsp;<span class="num" id="2922413">0</span><span class="op" id="2922414">;</span>&nbsp;<span class="ident" id="2922416">i</span>&nbsp;<span class="op" id="2922418">&lt;</span>&nbsp;<span class="builtinfunc" id="2922420">len</span><span class="op" id="2922423">(</span><span class="ident" id="2922424">oldnew</span><span class="op" id="2922430">)</span><span class="op" id="2922431">;</span>&nbsp;<span class="ident" id="2922433">i</span>&nbsp;<span class="op" id="2922435">+=</span>&nbsp;<span class="num" id="2922438">2</span>&nbsp;<span class="op" id="2922440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922444">r</span><span class="op" id="2922445">.</span><span class="ident" id="2922446">root</span><span class="op" id="2922450">.</span><span class="ident" id="2922451">add</span><span class="op" id="2922454">(</span><span class="ident" id="2922455">oldnew</span><span class="op" id="2922461">[</span><span class="ident" id="2922462">i</span><span class="op" id="2922463">]</span><span class="op" id="2922464">,</span>&nbsp;<span class="ident" id="2922466">oldnew</span><span class="op" id="2922472">[</span><span class="ident" id="2922473">i</span><span class="op" id="2922474">+</span><span class="num" id="2922475">1</span><span class="op" id="2922476">]</span><span class="op" id="2922477">,</span>&nbsp;<span class="builtinfunc" id="2922479">len</span><span class="op" id="2922482">(</span><span class="ident" id="2922483">oldnew</span><span class="op" id="2922489">)</span><span class="op" id="2922490">-</span><span class="ident" id="2922491">i</span><span class="op" id="2922492">,</span>&nbsp;<span class="ident" id="2922494">r</span><span class="op" id="2922495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922501">return</span>&nbsp;<span class="ident" id="2922508">r</span><br>
<span class="lineno">270</span><span class="op" id="2922510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2922513">type</span>&nbsp;<span class="ident" id="2922518">appendSliceWriter</span>&nbsp;<span class="op" id="2922536">[</span><span class="op" id="2922537">]</span><span class="builtintype" id="2922538">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2922544">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2922596">func</span>&nbsp;<span class="op" id="2922601">(</span><span class="ident" id="2922602">w</span>&nbsp;<span class="op" id="2922604">*</span><span class="ident" id="2922605">appendSliceWriter</span><span class="op" id="2922622">)</span>&nbsp;<span class="ident" id="2922624">Write</span><span class="op" id="2922629">(</span><span class="ident" id="2922630">p</span>&nbsp;<span class="op" id="2922632">[</span><span class="op" id="2922633">]</span><span class="builtintype" id="2922634">byte</span><span class="op" id="2922638">)</span>&nbsp;<span class="op" id="2922640">(</span><span class="builtintype" id="2922641">int</span><span class="op" id="2922644">,</span>&nbsp;<span class="builtintype" id="2922646">error</span><span class="op" id="2922651">)</span>&nbsp;<span class="op" id="2922653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922656">*</span><span class="ident" id="2922657">w</span>&nbsp;<span class="op" id="2922659">=</span>&nbsp;<span class="builtinfunc" id="2922661">append</span><span class="op" id="2922667">(</span><span class="op" id="2922668">*</span><span class="ident" id="2922669">w</span><span class="op" id="2922670">,</span>&nbsp;<span class="ident" id="2922672">p</span><span class="op" id="2922673">...</span><span class="op" id="2922676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922679">return</span>&nbsp;<span class="builtinfunc" id="2922686">len</span><span class="op" id="2922689">(</span><span class="ident" id="2922690">p</span><span class="op" id="2922691">)</span><span class="op" id="2922692">,</span>&nbsp;<span class="ident" id="2922694">nil</span><br>
<span class="lineno"></span><span class="op" id="2922698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2922701">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2922781">func</span>&nbsp;<span class="op" id="2922786">(</span><span class="ident" id="2922787">w</span>&nbsp;<span class="op" id="2922789">*</span><span class="ident" id="2922790">appendSliceWriter</span><span class="op" id="2922807">)</span>&nbsp;<span class="ident" id="2922809">WriteString</span><span class="op" id="2922820">(</span><span class="ident" id="2922821">s</span>&nbsp;<span class="builtintype" id="2922823">string</span><span class="op" id="2922829">)</span>&nbsp;<span class="op" id="2922831">(</span><span class="builtintype" id="2922832">int</span><span class="op" id="2922835">,</span>&nbsp;<span class="builtintype" id="2922837">error</span><span class="op" id="2922842">)</span>&nbsp;<span class="op" id="2922844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922847">*</span><span class="ident" id="2922848">w</span>&nbsp;<span class="op" id="2922850">=</span>&nbsp;<span class="builtinfunc" id="2922852">append</span><span class="op" id="2922858">(</span><span class="op" id="2922859">*</span><span class="ident" id="2922860">w</span><span class="op" id="2922861">,</span>&nbsp;<span class="ident" id="2922863">s</span><span class="op" id="2922864">...</span><span class="op" id="2922867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922870">return</span>&nbsp;<span class="builtinfunc" id="2922877">len</span><span class="op" id="2922880">(</span><span class="ident" id="2922881">s</span><span class="op" id="2922882">)</span><span class="op" id="2922883">,</span>&nbsp;<span class="ident" id="2922885">nil</span><br>
<span class="lineno"></span><span class="op" id="2922889">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2922892">type</span>&nbsp;<span class="ident" id="2922897">stringWriterIface</span>&nbsp;<span class="keyword" id="2922915">interface</span>&nbsp;<span class="op" id="2922925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922928">WriteString</span><span class="op" id="2922939">(</span><span class="builtintype" id="2922940">string</span><span class="op" id="2922946">)</span>&nbsp;<span class="op" id="2922948">(</span><span class="builtintype" id="2922949">int</span><span class="op" id="2922952">,</span>&nbsp;<span class="builtintype" id="2922954">error</span><span class="op" id="2922959">)</span><br>
<span class="lineno"></span><span class="op" id="2922961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2922964">type</span>&nbsp;<span class="ident" id="2922969">stringWriter</span>&nbsp;<span class="keyword" id="2922982">struct</span>&nbsp;<span class="op" id="2922989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922992">w</span>&nbsp;<span class="ident" id="2922994">io</span><span class="op" id="2922996">.</span><span class="ident" id="2922997">Writer</span><br>
<span class="lineno"></span><span class="op" id="2923004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2923007">func</span>&nbsp;<span class="op" id="2923012">(</span><span class="ident" id="2923013">w</span>&nbsp;<span class="ident" id="2923015">stringWriter</span><span class="op" id="2923027">)</span>&nbsp;<span class="ident" id="2923029">WriteString</span><span class="op" id="2923040">(</span><span class="ident" id="2923041">s</span>&nbsp;<span class="builtintype" id="2923043">string</span><span class="op" id="2923049">)</span>&nbsp;<span class="op" id="2923051">(</span><span class="builtintype" id="2923052">int</span><span class="op" id="2923055">,</span>&nbsp;<span class="builtintype" id="2923057">error</span><span class="op" id="2923062">)</span>&nbsp;<span class="op" id="2923064">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923067">return</span>&nbsp;<span class="ident" id="2923074">w</span><span class="op" id="2923075">.</span><span class="ident" id="2923076">w</span><span class="op" id="2923077">.</span><span class="ident" id="2923078">Write</span><span class="op" id="2923083">(</span><span class="op" id="2923084">[</span><span class="op" id="2923085">]</span><span class="builtintype" id="2923086">byte</span><span class="op" id="2923090">(</span><span class="ident" id="2923091">s</span><span class="op" id="2923092">)</span><span class="op" id="2923093">)</span><br>
<span class="lineno"></span><span class="op" id="2923095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2923098">func</span>&nbsp;<span class="ident" id="2923103">getStringWriter</span><span class="op" id="2923118">(</span><span class="ident" id="2923119">w</span>&nbsp;<span class="ident" id="2923121">io</span><span class="op" id="2923123">.</span><span class="ident" id="2923124">Writer</span><span class="op" id="2923130">)</span>&nbsp;<span class="ident" id="2923132">stringWriterIface</span>&nbsp;<span class="op" id="2923150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923153">sw</span><span class="op" id="2923155">,</span>&nbsp;<span class="ident" id="2923157">ok</span>&nbsp;<span class="op" id="2923160">:=</span>&nbsp;<span class="ident" id="2923163">w</span><span class="op" id="2923164">.</span><span class="op" id="2923165">(</span><span class="ident" id="2923166">stringWriterIface</span><span class="op" id="2923183">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923186">if</span>&nbsp;<span class="op" id="2923189">!</span><span class="ident" id="2923190">ok</span>&nbsp;<span class="op" id="2923193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923197">sw</span>&nbsp;<span class="op" id="2923200">=</span>&nbsp;<span class="ident" id="2923202">stringWriter</span><span class="op" id="2923214">{</span><span class="ident" id="2923215">w</span><span class="op" id="2923216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923222">return</span>&nbsp;<span class="ident" id="2923229">sw</span><br>
<span class="lineno"></span><span class="op" id="2923232">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2923235">func</span>&nbsp;<span class="op" id="2923240">(</span><span class="ident" id="2923241">r</span>&nbsp;<span class="op" id="2923243">*</span><span class="ident" id="2923244">genericReplacer</span><span class="op" id="2923259">)</span>&nbsp;<span class="ident" id="2923261">Replace</span><span class="op" id="2923268">(</span><span class="ident" id="2923269">s</span>&nbsp;<span class="builtintype" id="2923271">string</span><span class="op" id="2923277">)</span>&nbsp;<span class="builtintype" id="2923279">string</span>&nbsp;<span class="op" id="2923286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923289">buf</span>&nbsp;<span class="op" id="2923293">:=</span>&nbsp;<span class="builtinfunc" id="2923296">make</span><span class="op" id="2923300">(</span><span class="ident" id="2923301">appendSliceWriter</span><span class="op" id="2923318">,</span>&nbsp;<span class="num" id="2923320">0</span><span class="op" id="2923321">,</span>&nbsp;<span class="builtinfunc" id="2923323">len</span><span class="op" id="2923326">(</span><span class="ident" id="2923327">s</span><span class="op" id="2923328">)</span><span class="op" id="2923329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923332">r</span><span class="op" id="2923333">.</span><span class="ident" id="2923334">WriteString</span><span class="op" id="2923345">(</span><span class="op" id="2923346">&amp;</span><span class="ident" id="2923347">buf</span><span class="op" id="2923350">,</span>&nbsp;<span class="ident" id="2923352">s</span><span class="op" id="2923353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923356">return</span>&nbsp;<span class="builtintype" id="2923363">string</span><span class="op" id="2923369">(</span><span class="ident" id="2923370">buf</span><span class="op" id="2923373">)</span><br>
<span class="lineno">310</span><span class="op" id="2923375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2923378">func</span>&nbsp;<span class="op" id="2923383">(</span><span class="ident" id="2923384">r</span>&nbsp;<span class="op" id="2923386">*</span><span class="ident" id="2923387">genericReplacer</span><span class="op" id="2923402">)</span>&nbsp;<span class="ident" id="2923404">WriteString</span><span class="op" id="2923415">(</span><span class="ident" id="2923416">w</span>&nbsp;<span class="ident" id="2923418">io</span><span class="op" id="2923420">.</span><span class="ident" id="2923421">Writer</span><span class="op" id="2923427">,</span>&nbsp;<span class="ident" id="2923429">s</span>&nbsp;<span class="builtintype" id="2923431">string</span><span class="op" id="2923437">)</span>&nbsp;<span class="op" id="2923439">(</span><span class="ident" id="2923440">n</span>&nbsp;<span class="builtintype" id="2923442">int</span><span class="op" id="2923445">,</span>&nbsp;<span class="ident" id="2923447">err</span>&nbsp;<span class="builtintype" id="2923451">error</span><span class="op" id="2923456">)</span>&nbsp;<span class="op" id="2923458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923461">sw</span>&nbsp;<span class="op" id="2923464">:=</span>&nbsp;<span class="ident" id="2923467">getStringWriter</span><span class="op" id="2923482">(</span><span class="ident" id="2923483">w</span><span class="op" id="2923484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923487">var</span>&nbsp;<span class="ident" id="2923491">last</span><span class="op" id="2923495">,</span>&nbsp;<span class="ident" id="2923497">wn</span>&nbsp;<span class="builtintype" id="2923500">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923505">var</span>&nbsp;<span class="ident" id="2923509">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2923524">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923530">for</span>&nbsp;<span class="ident" id="2923534">i</span>&nbsp;<span class="op" id="2923536">:=</span>&nbsp;<span class="num" id="2923539">0</span><span class="op" id="2923540">;</span>&nbsp;<span class="ident" id="2923542">i</span>&nbsp;<span class="op" id="2923544">&lt;=</span>&nbsp;<span class="builtinfunc" id="2923547">len</span><span class="op" id="2923550">(</span><span class="ident" id="2923551">s</span><span class="op" id="2923552">)</span><span class="op" id="2923553">;</span>&nbsp;<span class="op" id="2923555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2923559">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923612">if</span>&nbsp;<span class="ident" id="2923615">i</span>&nbsp;<span class="op" id="2923617">!=</span>&nbsp;<span class="builtinfunc" id="2923620">len</span><span class="op" id="2923623">(</span><span class="ident" id="2923624">s</span><span class="op" id="2923625">)</span>&nbsp;<span class="op" id="2923627">&amp;&amp;</span>&nbsp;<span class="ident" id="2923630">r</span><span class="op" id="2923631">.</span><span class="ident" id="2923632">root</span><span class="op" id="2923636">.</span><span class="ident" id="2923637">priority</span>&nbsp;<span class="op" id="2923646">==</span>&nbsp;<span class="num" id="2923649">0</span>&nbsp;<span class="op" id="2923651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923656">index</span>&nbsp;<span class="op" id="2923662">:=</span>&nbsp;<span class="builtintype" id="2923665">int</span><span class="op" id="2923668">(</span><span class="ident" id="2923669">r</span><span class="op" id="2923670">.</span><span class="ident" id="2923671">mapping</span><span class="op" id="2923678">[</span><span class="ident" id="2923679">s</span><span class="op" id="2923680">[</span><span class="ident" id="2923681">i</span><span class="op" id="2923682">]</span><span class="op" id="2923683">]</span><span class="op" id="2923684">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923689">if</span>&nbsp;<span class="ident" id="2923692">index</span>&nbsp;<span class="op" id="2923698">==</span>&nbsp;<span class="ident" id="2923701">r</span><span class="op" id="2923702">.</span><span class="ident" id="2923703">tableSize</span>&nbsp;<span class="op" id="2923713">||</span>&nbsp;<span class="ident" id="2923716">r</span><span class="op" id="2923717">.</span><span class="ident" id="2923718">root</span><span class="op" id="2923722">.</span><span class="ident" id="2923723">table</span><span class="op" id="2923728">[</span><span class="ident" id="2923729">index</span><span class="op" id="2923734">]</span>&nbsp;<span class="op" id="2923736">==</span>&nbsp;<span class="ident" id="2923739">nil</span>&nbsp;<span class="op" id="2923743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923749">i</span><span class="op" id="2923750">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923757">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923773">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2923778">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923851">val</span><span class="op" id="2923854">,</span>&nbsp;<span class="ident" id="2923856">keylen</span><span class="op" id="2923862">,</span>&nbsp;<span class="ident" id="2923864">match</span>&nbsp;<span class="op" id="2923870">:=</span>&nbsp;<span class="ident" id="2923873">r</span><span class="op" id="2923874">.</span><span class="ident" id="2923875">lookup</span><span class="op" id="2923881">(</span><span class="ident" id="2923882">s</span><span class="op" id="2923883">[</span><span class="ident" id="2923884">i</span><span class="op" id="2923885">:</span><span class="op" id="2923886">]</span><span class="op" id="2923887">,</span>&nbsp;<span class="ident" id="2923889">prevMatchEmpty</span><span class="op" id="2923903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923907">prevMatchEmpty</span>&nbsp;<span class="op" id="2923922">=</span>&nbsp;<span class="ident" id="2923924">match</span>&nbsp;<span class="op" id="2923930">&amp;&amp;</span>&nbsp;<span class="ident" id="2923933">keylen</span>&nbsp;<span class="op" id="2923940">==</span>&nbsp;<span class="num" id="2923943">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923947">if</span>&nbsp;<span class="ident" id="2923950">match</span>&nbsp;<span class="op" id="2923956">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923961">wn</span><span class="op" id="2923963">,</span>&nbsp;<span class="ident" id="2923965">err</span>&nbsp;<span class="op" id="2923969">=</span>&nbsp;<span class="ident" id="2923971">sw</span><span class="op" id="2923973">.</span><span class="ident" id="2923974">WriteString</span><span class="op" id="2923985">(</span><span class="ident" id="2923986">s</span><span class="op" id="2923987">[</span><span class="ident" id="2923988">last</span><span class="op" id="2923992">:</span><span class="ident" id="2923993">i</span><span class="op" id="2923994">]</span><span class="op" id="2923995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924000">n</span>&nbsp;<span class="op" id="2924002">+=</span>&nbsp;<span class="ident" id="2924005">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924011">if</span>&nbsp;<span class="ident" id="2924014">err</span>&nbsp;<span class="op" id="2924018">!=</span>&nbsp;<span class="ident" id="2924021">nil</span>&nbsp;<span class="op" id="2924025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924031">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924041">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924046">wn</span><span class="op" id="2924048">,</span>&nbsp;<span class="ident" id="2924050">err</span>&nbsp;<span class="op" id="2924054">=</span>&nbsp;<span class="ident" id="2924056">sw</span><span class="op" id="2924058">.</span><span class="ident" id="2924059">WriteString</span><span class="op" id="2924070">(</span><span class="ident" id="2924071">val</span><span class="op" id="2924074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924079">n</span>&nbsp;<span class="op" id="2924081">+=</span>&nbsp;<span class="ident" id="2924084">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924090">if</span>&nbsp;<span class="ident" id="2924093">err</span>&nbsp;<span class="op" id="2924097">!=</span>&nbsp;<span class="ident" id="2924100">nil</span>&nbsp;<span class="op" id="2924104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924120">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924125">i</span>&nbsp;<span class="op" id="2924127">+=</span>&nbsp;<span class="ident" id="2924130">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924140">last</span>&nbsp;<span class="op" id="2924145">=</span>&nbsp;<span class="ident" id="2924147">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924152">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924167">i</span><span class="op" id="2924168">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924175">if</span>&nbsp;<span class="ident" id="2924178">last</span>&nbsp;<span class="op" id="2924183">!=</span>&nbsp;<span class="builtinfunc" id="2924186">len</span><span class="op" id="2924189">(</span><span class="ident" id="2924190">s</span><span class="op" id="2924191">)</span>&nbsp;<span class="op" id="2924193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924197">wn</span><span class="op" id="2924199">,</span>&nbsp;<span class="ident" id="2924201">err</span>&nbsp;<span class="op" id="2924205">=</span>&nbsp;<span class="ident" id="2924207">sw</span><span class="op" id="2924209">.</span><span class="ident" id="2924210">WriteString</span><span class="op" id="2924221">(</span><span class="ident" id="2924222">s</span><span class="op" id="2924223">[</span><span class="ident" id="2924224">last</span><span class="op" id="2924228">:</span><span class="op" id="2924229">]</span><span class="op" id="2924230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924234">n</span>&nbsp;<span class="op" id="2924236">+=</span>&nbsp;<span class="ident" id="2924239">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924243">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924246">return</span><br>
<span class="lineno"></span><span class="op" id="2924253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2924256">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2924333">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2924400">type</span>&nbsp;<span class="ident" id="2924405">singleStringReplacer</span>&nbsp;<span class="keyword" id="2924426">struct</span>&nbsp;<span class="op" id="2924433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924436">finder</span>&nbsp;<span class="op" id="2924443">*</span><span class="ident" id="2924444">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2924458">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924530">value</span>&nbsp;<span class="builtintype" id="2924536">string</span><br>
<span class="lineno"></span><span class="op" id="2924543">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2924546">func</span>&nbsp;<span class="ident" id="2924551">makeSingleStringReplacer</span><span class="op" id="2924575">(</span><span class="ident" id="2924576">pattern</span>&nbsp;<span class="builtintype" id="2924584">string</span><span class="op" id="2924590">,</span>&nbsp;<span class="ident" id="2924592">value</span>&nbsp;<span class="builtintype" id="2924598">string</span><span class="op" id="2924604">)</span>&nbsp;<span class="op" id="2924606">*</span><span class="ident" id="2924607">singleStringReplacer</span>&nbsp;<span class="op" id="2924628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924631">return</span>&nbsp;<span class="op" id="2924638">&amp;</span><span class="ident" id="2924639">singleStringReplacer</span><span class="op" id="2924659">{</span><span class="ident" id="2924660">finder</span><span class="op" id="2924666">:</span>&nbsp;<span class="ident" id="2924668">makeStringFinder</span><span class="op" id="2924684">(</span><span class="ident" id="2924685">pattern</span><span class="op" id="2924692">)</span><span class="op" id="2924693">,</span>&nbsp;<span class="ident" id="2924695">value</span><span class="op" id="2924700">:</span>&nbsp;<span class="ident" id="2924702">value</span><span class="op" id="2924707">}</span><br>
<span class="lineno"></span><span class="op" id="2924709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2924712">func</span>&nbsp;<span class="op" id="2924717">(</span><span class="ident" id="2924718">r</span>&nbsp;<span class="op" id="2924720">*</span><span class="ident" id="2924721">singleStringReplacer</span><span class="op" id="2924741">)</span>&nbsp;<span class="ident" id="2924743">Replace</span><span class="op" id="2924750">(</span><span class="ident" id="2924751">s</span>&nbsp;<span class="builtintype" id="2924753">string</span><span class="op" id="2924759">)</span>&nbsp;<span class="builtintype" id="2924761">string</span>&nbsp;<span class="op" id="2924768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924771">var</span>&nbsp;<span class="ident" id="2924775">buf</span>&nbsp;<span class="op" id="2924779">[</span><span class="op" id="2924780">]</span><span class="builtintype" id="2924781">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924787">i</span><span class="op" id="2924788">,</span>&nbsp;<span class="ident" id="2924790">matched</span>&nbsp;<span class="op" id="2924798">:=</span>&nbsp;<span class="num" id="2924801">0</span><span class="op" id="2924802">,</span>&nbsp;<span class="builtintype" id="2924804">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924811">for</span>&nbsp;<span class="op" id="2924815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924819">match</span>&nbsp;<span class="op" id="2924825">:=</span>&nbsp;<span class="ident" id="2924828">r</span><span class="op" id="2924829">.</span><span class="ident" id="2924830">finder</span><span class="op" id="2924836">.</span><span class="ident" id="2924837">next</span><span class="op" id="2924841">(</span><span class="ident" id="2924842">s</span><span class="op" id="2924843">[</span><span class="ident" id="2924844">i</span><span class="op" id="2924845">:</span><span class="op" id="2924846">]</span><span class="op" id="2924847">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924851">if</span>&nbsp;<span class="ident" id="2924854">match</span>&nbsp;<span class="op" id="2924860">==</span>&nbsp;<span class="op" id="2924863">-</span><span class="num" id="2924864">1</span>&nbsp;<span class="op" id="2924866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924871">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924883">matched</span>&nbsp;<span class="op" id="2924891">=</span>&nbsp;<span class="builtintype" id="2924893">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924900">buf</span>&nbsp;<span class="op" id="2924904">=</span>&nbsp;<span class="builtinfunc" id="2924906">append</span><span class="op" id="2924912">(</span><span class="ident" id="2924913">buf</span><span class="op" id="2924916">,</span>&nbsp;<span class="ident" id="2924918">s</span><span class="op" id="2924919">[</span><span class="ident" id="2924920">i</span><span class="op" id="2924921">:</span><span class="ident" id="2924922">i</span><span class="op" id="2924923">+</span><span class="ident" id="2924924">match</span><span class="op" id="2924929">]</span><span class="op" id="2924930">...</span><span class="op" id="2924933">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924937">buf</span>&nbsp;<span class="op" id="2924941">=</span>&nbsp;<span class="builtinfunc" id="2924943">append</span><span class="op" id="2924949">(</span><span class="ident" id="2924950">buf</span><span class="op" id="2924953">,</span>&nbsp;<span class="ident" id="2924955">r</span><span class="op" id="2924956">.</span><span class="ident" id="2924957">value</span><span class="op" id="2924962">...</span><span class="op" id="2924965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924969">i</span>&nbsp;<span class="op" id="2924971">+=</span>&nbsp;<span class="ident" id="2924974">match</span>&nbsp;<span class="op" id="2924980">+</span>&nbsp;<span class="builtinfunc" id="2924982">len</span><span class="op" id="2924985">(</span><span class="ident" id="2924986">r</span><span class="op" id="2924987">.</span><span class="ident" id="2924988">finder</span><span class="op" id="2924994">.</span><span class="ident" id="2924995">pattern</span><span class="op" id="2925002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925008">if</span>&nbsp;<span class="op" id="2925011">!</span><span class="ident" id="2925012">matched</span>&nbsp;<span class="op" id="2925020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925024">return</span>&nbsp;<span class="ident" id="2925031">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925037">buf</span>&nbsp;<span class="op" id="2925041">=</span>&nbsp;<span class="builtinfunc" id="2925043">append</span><span class="op" id="2925049">(</span><span class="ident" id="2925050">buf</span><span class="op" id="2925053">,</span>&nbsp;<span class="ident" id="2925055">s</span><span class="op" id="2925056">[</span><span class="ident" id="2925057">i</span><span class="op" id="2925058">:</span><span class="op" id="2925059">]</span><span class="op" id="2925060">...</span><span class="op" id="2925063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925066">return</span>&nbsp;<span class="builtintype" id="2925073">string</span><span class="op" id="2925079">(</span><span class="ident" id="2925080">buf</span><span class="op" id="2925083">)</span><br>
<span class="lineno"></span><span class="op" id="2925085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2925088">func</span>&nbsp;<span class="op" id="2925093">(</span><span class="ident" id="2925094">r</span>&nbsp;<span class="op" id="2925096">*</span><span class="ident" id="2925097">singleStringReplacer</span><span class="op" id="2925117">)</span>&nbsp;<span class="ident" id="2925119">WriteString</span><span class="op" id="2925130">(</span><span class="ident" id="2925131">w</span>&nbsp;<span class="ident" id="2925133">io</span><span class="op" id="2925135">.</span><span class="ident" id="2925136">Writer</span><span class="op" id="2925142">,</span>&nbsp;<span class="ident" id="2925144">s</span>&nbsp;<span class="builtintype" id="2925146">string</span><span class="op" id="2925152">)</span>&nbsp;<span class="op" id="2925154">(</span><span class="ident" id="2925155">n</span>&nbsp;<span class="builtintype" id="2925157">int</span><span class="op" id="2925160">,</span>&nbsp;<span class="ident" id="2925162">err</span>&nbsp;<span class="builtintype" id="2925166">error</span><span class="op" id="2925171">)</span>&nbsp;<span class="op" id="2925173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925176">sw</span>&nbsp;<span class="op" id="2925179">:=</span>&nbsp;<span class="ident" id="2925182">getStringWriter</span><span class="op" id="2925197">(</span><span class="ident" id="2925198">w</span><span class="op" id="2925199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925202">var</span>&nbsp;<span class="ident" id="2925206">i</span><span class="op" id="2925207">,</span>&nbsp;<span class="ident" id="2925209">wn</span>&nbsp;<span class="builtintype" id="2925212">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925217">for</span>&nbsp;<span class="op" id="2925221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925225">match</span>&nbsp;<span class="op" id="2925231">:=</span>&nbsp;<span class="ident" id="2925234">r</span><span class="op" id="2925235">.</span><span class="ident" id="2925236">finder</span><span class="op" id="2925242">.</span><span class="ident" id="2925243">next</span><span class="op" id="2925247">(</span><span class="ident" id="2925248">s</span><span class="op" id="2925249">[</span><span class="ident" id="2925250">i</span><span class="op" id="2925251">:</span><span class="op" id="2925252">]</span><span class="op" id="2925253">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925257">if</span>&nbsp;<span class="ident" id="2925260">match</span>&nbsp;<span class="op" id="2925266">==</span>&nbsp;<span class="op" id="2925269">-</span><span class="num" id="2925270">1</span>&nbsp;<span class="op" id="2925272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925277">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925289">wn</span><span class="op" id="2925291">,</span>&nbsp;<span class="ident" id="2925293">err</span>&nbsp;<span class="op" id="2925297">=</span>&nbsp;<span class="ident" id="2925299">sw</span><span class="op" id="2925301">.</span><span class="ident" id="2925302">WriteString</span><span class="op" id="2925313">(</span><span class="ident" id="2925314">s</span><span class="op" id="2925315">[</span><span class="ident" id="2925316">i</span>&nbsp;<span class="op" id="2925318">:</span>&nbsp;<span class="ident" id="2925320">i</span><span class="op" id="2925321">+</span><span class="ident" id="2925322">match</span><span class="op" id="2925327">]</span><span class="op" id="2925328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925332">n</span>&nbsp;<span class="op" id="2925334">+=</span>&nbsp;<span class="ident" id="2925337">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925342">if</span>&nbsp;<span class="ident" id="2925345">err</span>&nbsp;<span class="op" id="2925349">!=</span>&nbsp;<span class="ident" id="2925352">nil</span>&nbsp;<span class="op" id="2925356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925361">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925374">wn</span><span class="op" id="2925376">,</span>&nbsp;<span class="ident" id="2925378">err</span>&nbsp;<span class="op" id="2925382">=</span>&nbsp;<span class="ident" id="2925384">sw</span><span class="op" id="2925386">.</span><span class="ident" id="2925387">WriteString</span><span class="op" id="2925398">(</span><span class="ident" id="2925399">r</span><span class="op" id="2925400">.</span><span class="ident" id="2925401">value</span><span class="op" id="2925406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925410">n</span>&nbsp;<span class="op" id="2925412">+=</span>&nbsp;<span class="ident" id="2925415">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925420">if</span>&nbsp;<span class="ident" id="2925423">err</span>&nbsp;<span class="op" id="2925427">!=</span>&nbsp;<span class="ident" id="2925430">nil</span>&nbsp;<span class="op" id="2925434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925439">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925452">i</span>&nbsp;<span class="op" id="2925454">+=</span>&nbsp;<span class="ident" id="2925457">match</span>&nbsp;<span class="op" id="2925463">+</span>&nbsp;<span class="builtinfunc" id="2925465">len</span><span class="op" id="2925468">(</span><span class="ident" id="2925469">r</span><span class="op" id="2925470">.</span><span class="ident" id="2925471">finder</span><span class="op" id="2925477">.</span><span class="ident" id="2925478">pattern</span><span class="op" id="2925485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925488">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925491">wn</span><span class="op" id="2925493">,</span>&nbsp;<span class="ident" id="2925495">err</span>&nbsp;<span class="op" id="2925499">=</span>&nbsp;<span class="ident" id="2925501">sw</span><span class="op" id="2925503">.</span><span class="ident" id="2925504">WriteString</span><span class="op" id="2925515">(</span><span class="ident" id="2925516">s</span><span class="op" id="2925517">[</span><span class="ident" id="2925518">i</span><span class="op" id="2925519">:</span><span class="op" id="2925520">]</span><span class="op" id="2925521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925524">n</span>&nbsp;<span class="op" id="2925526">+=</span>&nbsp;<span class="ident" id="2925529">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925533">return</span><br>
<span class="lineno"></span><span class="op" id="2925540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2925543">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2925612">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2925656">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2925717">type</span>&nbsp;<span class="ident" id="2925722">byteReplacer</span>&nbsp;<span class="op" id="2925735">[</span><span class="num" id="2925736">256</span><span class="op" id="2925739">]</span><span class="builtintype" id="2925740">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2925746">func</span>&nbsp;<span class="op" id="2925751">(</span><span class="ident" id="2925752">r</span>&nbsp;<span class="op" id="2925754">*</span><span class="ident" id="2925755">byteReplacer</span><span class="op" id="2925767">)</span>&nbsp;<span class="ident" id="2925769">Replace</span><span class="op" id="2925776">(</span><span class="ident" id="2925777">s</span>&nbsp;<span class="builtintype" id="2925779">string</span><span class="op" id="2925785">)</span>&nbsp;<span class="builtintype" id="2925787">string</span>&nbsp;<span class="op" id="2925794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925797">var</span>&nbsp;<span class="ident" id="2925801">buf</span>&nbsp;<span class="op" id="2925805">[</span><span class="op" id="2925806">]</span><span class="builtintype" id="2925807">byte</span>&nbsp;<span class="comment" id="2925812">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925833">for</span>&nbsp;<span class="ident" id="2925837">i</span>&nbsp;<span class="op" id="2925839">:=</span>&nbsp;<span class="num" id="2925842">0</span><span class="op" id="2925843">;</span>&nbsp;<span class="ident" id="2925845">i</span>&nbsp;<span class="op" id="2925847">&lt;</span>&nbsp;<span class="builtinfunc" id="2925849">len</span><span class="op" id="2925852">(</span><span class="ident" id="2925853">s</span><span class="op" id="2925854">)</span><span class="op" id="2925855">;</span>&nbsp;<span class="ident" id="2925857">i</span><span class="op" id="2925858">++</span>&nbsp;<span class="op" id="2925861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925865">b</span>&nbsp;<span class="op" id="2925867">:=</span>&nbsp;<span class="ident" id="2925870">s</span><span class="op" id="2925871">[</span><span class="ident" id="2925872">i</span><span class="op" id="2925873">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925877">if</span>&nbsp;<span class="ident" id="2925880">r</span><span class="op" id="2925881">[</span><span class="ident" id="2925882">b</span><span class="op" id="2925883">]</span>&nbsp;<span class="op" id="2925885">!=</span>&nbsp;<span class="ident" id="2925888">b</span>&nbsp;<span class="op" id="2925890">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925895">if</span>&nbsp;<span class="ident" id="2925898">buf</span>&nbsp;<span class="op" id="2925902">==</span>&nbsp;<span class="ident" id="2925905">nil</span>&nbsp;<span class="op" id="2925909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925915">buf</span>&nbsp;<span class="op" id="2925919">=</span>&nbsp;<span class="op" id="2925921">[</span><span class="op" id="2925922">]</span><span class="builtintype" id="2925923">byte</span><span class="op" id="2925927">(</span><span class="ident" id="2925928">s</span><span class="op" id="2925929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925939">buf</span><span class="op" id="2925942">[</span><span class="ident" id="2925943">i</span><span class="op" id="2925944">]</span>&nbsp;<span class="op" id="2925946">=</span>&nbsp;<span class="ident" id="2925948">r</span><span class="op" id="2925949">[</span><span class="ident" id="2925950">b</span><span class="op" id="2925951">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925955">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925961">if</span>&nbsp;<span class="ident" id="2925964">buf</span>&nbsp;<span class="op" id="2925968">==</span>&nbsp;<span class="ident" id="2925971">nil</span>&nbsp;<span class="op" id="2925975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925979">return</span>&nbsp;<span class="ident" id="2925986">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925992">return</span>&nbsp;<span class="builtintype" id="2925999">string</span><span class="op" id="2926005">(</span><span class="ident" id="2926006">buf</span><span class="op" id="2926009">)</span><br>
<span class="lineno">430</span><span class="op" id="2926011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2926014">func</span>&nbsp;<span class="op" id="2926019">(</span><span class="ident" id="2926020">r</span>&nbsp;<span class="op" id="2926022">*</span><span class="ident" id="2926023">byteReplacer</span><span class="op" id="2926035">)</span>&nbsp;<span class="ident" id="2926037">WriteString</span><span class="op" id="2926048">(</span><span class="ident" id="2926049">w</span>&nbsp;<span class="ident" id="2926051">io</span><span class="op" id="2926053">.</span><span class="ident" id="2926054">Writer</span><span class="op" id="2926060">,</span>&nbsp;<span class="ident" id="2926062">s</span>&nbsp;<span class="builtintype" id="2926064">string</span><span class="op" id="2926070">)</span>&nbsp;<span class="op" id="2926072">(</span><span class="ident" id="2926073">n</span>&nbsp;<span class="builtintype" id="2926075">int</span><span class="op" id="2926078">,</span>&nbsp;<span class="ident" id="2926080">err</span>&nbsp;<span class="builtintype" id="2926084">error</span><span class="op" id="2926089">)</span>&nbsp;<span class="op" id="2926091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926094">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926172">bufsize</span>&nbsp;<span class="op" id="2926180">:=</span>&nbsp;<span class="num" id="2926183">32</span>&nbsp;<span class="op" id="2926186">&lt;&lt;</span>&nbsp;<span class="num" id="2926189">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926193">if</span>&nbsp;<span class="builtinfunc" id="2926196">len</span><span class="op" id="2926199">(</span><span class="ident" id="2926200">s</span><span class="op" id="2926201">)</span>&nbsp;<span class="op" id="2926203">&lt;</span>&nbsp;<span class="ident" id="2926205">bufsize</span>&nbsp;<span class="op" id="2926213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926217">bufsize</span>&nbsp;<span class="op" id="2926225">=</span>&nbsp;<span class="builtinfunc" id="2926227">len</span><span class="op" id="2926230">(</span><span class="ident" id="2926231">s</span><span class="op" id="2926232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926238">buf</span>&nbsp;<span class="op" id="2926242">:=</span>&nbsp;<span class="builtinfunc" id="2926245">make</span><span class="op" id="2926249">(</span><span class="op" id="2926250">[</span><span class="op" id="2926251">]</span><span class="builtintype" id="2926252">byte</span><span class="op" id="2926256">,</span>&nbsp;<span class="ident" id="2926258">bufsize</span><span class="op" id="2926265">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926269">for</span>&nbsp;<span class="builtinfunc" id="2926273">len</span><span class="op" id="2926276">(</span><span class="ident" id="2926277">s</span><span class="op" id="2926278">)</span>&nbsp;<span class="op" id="2926280">&gt;</span>&nbsp;<span class="num" id="2926282">0</span>&nbsp;<span class="op" id="2926284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926288">ncopy</span>&nbsp;<span class="op" id="2926294">:=</span>&nbsp;<span class="builtinfunc" id="2926297">copy</span><span class="op" id="2926301">(</span><span class="ident" id="2926302">buf</span><span class="op" id="2926305">,</span>&nbsp;<span class="ident" id="2926307">s</span><span class="op" id="2926308">[</span><span class="op" id="2926309">:</span><span class="op" id="2926310">]</span><span class="op" id="2926311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926315">s</span>&nbsp;<span class="op" id="2926317">=</span>&nbsp;<span class="ident" id="2926319">s</span><span class="op" id="2926320">[</span><span class="ident" id="2926321">ncopy</span><span class="op" id="2926326">:</span><span class="op" id="2926327">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926331">for</span>&nbsp;<span class="ident" id="2926335">i</span><span class="op" id="2926336">,</span>&nbsp;<span class="ident" id="2926338">b</span>&nbsp;<span class="op" id="2926340">:=</span>&nbsp;<span class="keyword" id="2926343">range</span>&nbsp;<span class="ident" id="2926349">buf</span><span class="op" id="2926352">[</span><span class="op" id="2926353">:</span><span class="ident" id="2926354">ncopy</span><span class="op" id="2926359">]</span>&nbsp;<span class="op" id="2926361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926366">buf</span><span class="op" id="2926369">[</span><span class="ident" id="2926370">i</span><span class="op" id="2926371">]</span>&nbsp;<span class="op" id="2926373">=</span>&nbsp;<span class="ident" id="2926375">r</span><span class="op" id="2926376">[</span><span class="ident" id="2926377">b</span><span class="op" id="2926378">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926386">wn</span><span class="op" id="2926388">,</span>&nbsp;<span class="ident" id="2926390">err</span>&nbsp;<span class="op" id="2926394">:=</span>&nbsp;<span class="ident" id="2926397">w</span><span class="op" id="2926398">.</span><span class="ident" id="2926399">Write</span><span class="op" id="2926404">(</span><span class="ident" id="2926405">buf</span><span class="op" id="2926408">[</span><span class="op" id="2926409">:</span><span class="ident" id="2926410">ncopy</span><span class="op" id="2926415">]</span><span class="op" id="2926416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926420">n</span>&nbsp;<span class="op" id="2926422">+=</span>&nbsp;<span class="ident" id="2926425">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926430">if</span>&nbsp;<span class="ident" id="2926433">err</span>&nbsp;<span class="op" id="2926437">!=</span>&nbsp;<span class="ident" id="2926440">nil</span>&nbsp;<span class="op" id="2926444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926449">return</span>&nbsp;<span class="ident" id="2926456">n</span><span class="op" id="2926457">,</span>&nbsp;<span class="ident" id="2926459">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926471">return</span>&nbsp;<span class="ident" id="2926478">n</span><span class="op" id="2926479">,</span>&nbsp;<span class="ident" id="2926481">nil</span><br>
<span class="lineno"></span><span class="op" id="2926485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2926488">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2926557">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2926631">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2926698">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2926762">type</span>&nbsp;<span class="ident" id="2926767">byteStringReplacer</span>&nbsp;<span class="op" id="2926786">[</span><span class="num" id="2926787">256</span><span class="op" id="2926790">]</span><span class="op" id="2926791">[</span><span class="op" id="2926792">]</span><span class="builtintype" id="2926793">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2926799">func</span>&nbsp;<span class="op" id="2926804">(</span><span class="ident" id="2926805">r</span>&nbsp;<span class="op" id="2926807">*</span><span class="ident" id="2926808">byteStringReplacer</span><span class="op" id="2926826">)</span>&nbsp;<span class="ident" id="2926828">Replace</span><span class="op" id="2926835">(</span><span class="ident" id="2926836">s</span>&nbsp;<span class="builtintype" id="2926838">string</span><span class="op" id="2926844">)</span>&nbsp;<span class="builtintype" id="2926846">string</span>&nbsp;<span class="op" id="2926853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926856">newSize</span>&nbsp;<span class="op" id="2926864">:=</span>&nbsp;<span class="builtinfunc" id="2926867">len</span><span class="op" id="2926870">(</span><span class="ident" id="2926871">s</span><span class="op" id="2926872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926875">anyChanges</span>&nbsp;<span class="op" id="2926886">:=</span>&nbsp;<span class="builtintype" id="2926889">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926896">for</span>&nbsp;<span class="ident" id="2926900">i</span>&nbsp;<span class="op" id="2926902">:=</span>&nbsp;<span class="num" id="2926905">0</span><span class="op" id="2926906">;</span>&nbsp;<span class="ident" id="2926908">i</span>&nbsp;<span class="op" id="2926910">&lt;</span>&nbsp;<span class="builtinfunc" id="2926912">len</span><span class="op" id="2926915">(</span><span class="ident" id="2926916">s</span><span class="op" id="2926917">)</span><span class="op" id="2926918">;</span>&nbsp;<span class="ident" id="2926920">i</span><span class="op" id="2926921">++</span>&nbsp;<span class="op" id="2926924">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926928">b</span>&nbsp;<span class="op" id="2926930">:=</span>&nbsp;<span class="ident" id="2926933">s</span><span class="op" id="2926934">[</span><span class="ident" id="2926935">i</span><span class="op" id="2926936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926940">if</span>&nbsp;<span class="ident" id="2926943">r</span><span class="op" id="2926944">[</span><span class="ident" id="2926945">b</span><span class="op" id="2926946">]</span>&nbsp;<span class="op" id="2926948">!=</span>&nbsp;<span class="ident" id="2926951">nil</span>&nbsp;<span class="op" id="2926955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926960">anyChanges</span>&nbsp;<span class="op" id="2926971">=</span>&nbsp;<span class="builtintype" id="2926973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926981">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927051">newSize</span>&nbsp;<span class="op" id="2927059">+=</span>&nbsp;<span class="builtinfunc" id="2927062">len</span><span class="op" id="2927065">(</span><span class="ident" id="2927066">r</span><span class="op" id="2927067">[</span><span class="ident" id="2927068">b</span><span class="op" id="2927069">]</span><span class="op" id="2927070">)</span>&nbsp;<span class="op" id="2927072">-</span>&nbsp;<span class="num" id="2927074">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927084">if</span>&nbsp;<span class="op" id="2927087">!</span><span class="ident" id="2927088">anyChanges</span>&nbsp;<span class="op" id="2927099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927103">return</span>&nbsp;<span class="ident" id="2927110">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927113">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927116">buf</span>&nbsp;<span class="op" id="2927120">:=</span>&nbsp;<span class="builtinfunc" id="2927123">make</span><span class="op" id="2927127">(</span><span class="op" id="2927128">[</span><span class="op" id="2927129">]</span><span class="builtintype" id="2927130">byte</span><span class="op" id="2927134">,</span>&nbsp;<span class="ident" id="2927136">newSize</span><span class="op" id="2927143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927146">bi</span>&nbsp;<span class="op" id="2927149">:=</span>&nbsp;<span class="ident" id="2927152">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927157">for</span>&nbsp;<span class="ident" id="2927161">i</span>&nbsp;<span class="op" id="2927163">:=</span>&nbsp;<span class="num" id="2927166">0</span><span class="op" id="2927167">;</span>&nbsp;<span class="ident" id="2927169">i</span>&nbsp;<span class="op" id="2927171">&lt;</span>&nbsp;<span class="builtinfunc" id="2927173">len</span><span class="op" id="2927176">(</span><span class="ident" id="2927177">s</span><span class="op" id="2927178">)</span><span class="op" id="2927179">;</span>&nbsp;<span class="ident" id="2927181">i</span><span class="op" id="2927182">++</span>&nbsp;<span class="op" id="2927185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927189">b</span>&nbsp;<span class="op" id="2927191">:=</span>&nbsp;<span class="ident" id="2927194">s</span><span class="op" id="2927195">[</span><span class="ident" id="2927196">i</span><span class="op" id="2927197">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927201">if</span>&nbsp;<span class="ident" id="2927204">r</span><span class="op" id="2927205">[</span><span class="ident" id="2927206">b</span><span class="op" id="2927207">]</span>&nbsp;<span class="op" id="2927209">!=</span>&nbsp;<span class="ident" id="2927212">nil</span>&nbsp;<span class="op" id="2927216">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927221">n</span>&nbsp;<span class="op" id="2927223">:=</span>&nbsp;<span class="builtinfunc" id="2927226">copy</span><span class="op" id="2927230">(</span><span class="ident" id="2927231">bi</span><span class="op" id="2927233">,</span>&nbsp;<span class="ident" id="2927235">r</span><span class="op" id="2927236">[</span><span class="ident" id="2927237">b</span><span class="op" id="2927238">]</span><span class="op" id="2927239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927244">bi</span>&nbsp;<span class="op" id="2927247">=</span>&nbsp;<span class="ident" id="2927249">bi</span><span class="op" id="2927251">[</span><span class="ident" id="2927252">n</span><span class="op" id="2927253">:</span><span class="op" id="2927254">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927258">}</span>&nbsp;<span class="keyword" id="2927260">else</span>&nbsp;<span class="op" id="2927265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927270">bi</span><span class="op" id="2927272">[</span><span class="num" id="2927273">0</span><span class="op" id="2927274">]</span>&nbsp;<span class="op" id="2927276">=</span>&nbsp;<span class="ident" id="2927278">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927283">bi</span>&nbsp;<span class="op" id="2927286">=</span>&nbsp;<span class="ident" id="2927288">bi</span><span class="op" id="2927290">[</span><span class="num" id="2927291">1</span><span class="op" id="2927292">:</span><span class="op" id="2927293">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927303">return</span>&nbsp;<span class="builtintype" id="2927310">string</span><span class="op" id="2927316">(</span><span class="ident" id="2927317">buf</span><span class="op" id="2927320">)</span><br>
<span class="lineno"></span><span class="op" id="2927322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2927325">func</span>&nbsp;<span class="op" id="2927330">(</span><span class="ident" id="2927331">r</span>&nbsp;<span class="op" id="2927333">*</span><span class="ident" id="2927334">byteStringReplacer</span><span class="op" id="2927352">)</span>&nbsp;<span class="ident" id="2927354">WriteString</span><span class="op" id="2927365">(</span><span class="ident" id="2927366">w</span>&nbsp;<span class="ident" id="2927368">io</span><span class="op" id="2927370">.</span><span class="ident" id="2927371">Writer</span><span class="op" id="2927377">,</span>&nbsp;<span class="ident" id="2927379">s</span>&nbsp;<span class="builtintype" id="2927381">string</span><span class="op" id="2927387">)</span>&nbsp;<span class="op" id="2927389">(</span><span class="ident" id="2927390">n</span>&nbsp;<span class="builtintype" id="2927392">int</span><span class="op" id="2927395">,</span>&nbsp;<span class="ident" id="2927397">err</span>&nbsp;<span class="builtintype" id="2927401">error</span><span class="op" id="2927406">)</span>&nbsp;<span class="op" id="2927408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927411">sw</span>&nbsp;<span class="op" id="2927414">:=</span>&nbsp;<span class="ident" id="2927417">getStringWriter</span><span class="op" id="2927432">(</span><span class="ident" id="2927433">w</span><span class="op" id="2927434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927437">last</span>&nbsp;<span class="op" id="2927442">:=</span>&nbsp;<span class="num" id="2927445">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927448">for</span>&nbsp;<span class="ident" id="2927452">i</span>&nbsp;<span class="op" id="2927454">:=</span>&nbsp;<span class="num" id="2927457">0</span><span class="op" id="2927458">;</span>&nbsp;<span class="ident" id="2927460">i</span>&nbsp;<span class="op" id="2927462">&lt;</span>&nbsp;<span class="builtinfunc" id="2927464">len</span><span class="op" id="2927467">(</span><span class="ident" id="2927468">s</span><span class="op" id="2927469">)</span><span class="op" id="2927470">;</span>&nbsp;<span class="ident" id="2927472">i</span><span class="op" id="2927473">++</span>&nbsp;<span class="op" id="2927476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927480">b</span>&nbsp;<span class="op" id="2927482">:=</span>&nbsp;<span class="ident" id="2927485">s</span><span class="op" id="2927486">[</span><span class="ident" id="2927487">i</span><span class="op" id="2927488">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927492">if</span>&nbsp;<span class="ident" id="2927495">r</span><span class="op" id="2927496">[</span><span class="ident" id="2927497">b</span><span class="op" id="2927498">]</span>&nbsp;<span class="op" id="2927500">==</span>&nbsp;<span class="ident" id="2927503">nil</span>&nbsp;<span class="op" id="2927507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927512">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927527">if</span>&nbsp;<span class="ident" id="2927530">last</span>&nbsp;<span class="op" id="2927535">!=</span>&nbsp;<span class="ident" id="2927538">i</span>&nbsp;<span class="op" id="2927540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927545">nw</span><span class="op" id="2927547">,</span>&nbsp;<span class="ident" id="2927549">err</span>&nbsp;<span class="op" id="2927553">:=</span>&nbsp;<span class="ident" id="2927556">sw</span><span class="op" id="2927558">.</span><span class="ident" id="2927559">WriteString</span><span class="op" id="2927570">(</span><span class="ident" id="2927571">s</span><span class="op" id="2927572">[</span><span class="ident" id="2927573">last</span><span class="op" id="2927577">:</span><span class="ident" id="2927578">i</span><span class="op" id="2927579">]</span><span class="op" id="2927580">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927585">n</span>&nbsp;<span class="op" id="2927587">+=</span>&nbsp;<span class="ident" id="2927590">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927596">if</span>&nbsp;<span class="ident" id="2927599">err</span>&nbsp;<span class="op" id="2927603">!=</span>&nbsp;<span class="ident" id="2927606">nil</span>&nbsp;<span class="op" id="2927610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927616">return</span>&nbsp;<span class="ident" id="2927623">n</span><span class="op" id="2927624">,</span>&nbsp;<span class="ident" id="2927626">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927637">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927641">last</span>&nbsp;<span class="op" id="2927646">=</span>&nbsp;<span class="ident" id="2927648">i</span>&nbsp;<span class="op" id="2927650">+</span>&nbsp;<span class="num" id="2927652">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927656">nw</span><span class="op" id="2927658">,</span>&nbsp;<span class="ident" id="2927660">err</span>&nbsp;<span class="op" id="2927664">:=</span>&nbsp;<span class="ident" id="2927667">w</span><span class="op" id="2927668">.</span><span class="ident" id="2927669">Write</span><span class="op" id="2927674">(</span><span class="ident" id="2927675">r</span><span class="op" id="2927676">[</span><span class="ident" id="2927677">b</span><span class="op" id="2927678">]</span><span class="op" id="2927679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927683">n</span>&nbsp;<span class="op" id="2927685">+=</span>&nbsp;<span class="ident" id="2927688">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927693">if</span>&nbsp;<span class="ident" id="2927696">err</span>&nbsp;<span class="op" id="2927700">!=</span>&nbsp;<span class="ident" id="2927703">nil</span>&nbsp;<span class="op" id="2927707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927712">return</span>&nbsp;<span class="ident" id="2927719">n</span><span class="op" id="2927720">,</span>&nbsp;<span class="ident" id="2927722">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927734">if</span>&nbsp;<span class="ident" id="2927737">last</span>&nbsp;<span class="op" id="2927742">!=</span>&nbsp;<span class="builtinfunc" id="2927745">len</span><span class="op" id="2927748">(</span><span class="ident" id="2927749">s</span><span class="op" id="2927750">)</span>&nbsp;<span class="op" id="2927752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927756">var</span>&nbsp;<span class="ident" id="2927760">nw</span>&nbsp;<span class="builtintype" id="2927763">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927769">nw</span><span class="op" id="2927771">,</span>&nbsp;<span class="ident" id="2927773">err</span>&nbsp;<span class="op" id="2927777">=</span>&nbsp;<span class="ident" id="2927779">sw</span><span class="op" id="2927781">.</span><span class="ident" id="2927782">WriteString</span><span class="op" id="2927793">(</span><span class="ident" id="2927794">s</span><span class="op" id="2927795">[</span><span class="ident" id="2927796">last</span><span class="op" id="2927800">:</span><span class="op" id="2927801">]</span><span class="op" id="2927802">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927806">n</span>&nbsp;<span class="op" id="2927808">+=</span>&nbsp;<span class="ident" id="2927811">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927818">return</span><br>
<span class="lineno"></span><span class="op" id="2927825">}</span>
</div>
</body>
</html>
