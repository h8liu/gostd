<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html" class="current">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5783527">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5783583">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5783637">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5783688">package</span>&nbsp;<span class="ident" id="5783696">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5783705">import</span>&nbsp;<span class="op" id="5783712">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5783715">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5783732">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5783742">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5783748">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5783759">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5783766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5783769">var</span>&nbsp;<span class="ident" id="5783773">errMissingParams</span>&nbsp;<span class="op" id="5783790">=</span>&nbsp;<span class="ident" id="5783792">errors</span><span class="op" id="5783798">.</span><span class="ident" id="5783799">New</span><span class="op" id="5783802">(</span><span class="string" id="5783803">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5783841">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5783844">type</span>&nbsp;<span class="ident" id="5783849">serverCodec</span>&nbsp;<span class="keyword" id="5783861">struct</span>&nbsp;<span class="op" id="5783868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5783871">dec</span>&nbsp;<span class="op" id="5783875">*</span><span class="ident" id="5783876">json</span><span class="op" id="5783880">.</span><span class="ident" id="5783881">Decoder</span>&nbsp;<span class="comment" id="5783889">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5783917">enc</span>&nbsp;<span class="op" id="5783921">*</span><span class="ident" id="5783922">json</span><span class="op" id="5783926">.</span><span class="ident" id="5783927">Encoder</span>&nbsp;<span class="comment" id="5783935">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5783963">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5783967">io</span><span class="op" id="5783969">.</span><span class="ident" id="5783970">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5783979">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784004">req</span>&nbsp;<span class="ident" id="5784008">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784024">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784091">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784135">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784194">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784251">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5784304">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784354">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5784362">sync</span><span class="op" id="5784366">.</span><span class="ident" id="5784367">Mutex</span>&nbsp;<span class="comment" id="5784373">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784399">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784407">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784415">pending</span>&nbsp;<span class="keyword" id="5784423">map</span><span class="op" id="5784426">[</span><span class="ident" id="5784427">uint64</span><span class="op" id="5784433">]</span><span class="op" id="5784434">*</span><span class="ident" id="5784435">json</span><span class="op" id="5784439">.</span><span class="ident" id="5784440">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5784451">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5784454">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5784526">func</span>&nbsp;<span class="ident" id="5784531">NewServerCodec</span><span class="op" id="5784545">(</span><span class="ident" id="5784546">conn</span>&nbsp;<span class="ident" id="5784551">io</span><span class="op" id="5784553">.</span><span class="ident" id="5784554">ReadWriteCloser</span><span class="op" id="5784569">)</span>&nbsp;<span class="ident" id="5784571">rpc</span><span class="op" id="5784574">.</span><span class="ident" id="5784575">ServerCodec</span>&nbsp;<span class="op" id="5784587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5784590">return</span>&nbsp;<span class="op" id="5784597">&amp;</span><span class="ident" id="5784598">serverCodec</span><span class="op" id="5784609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784613">dec</span><span class="op" id="5784616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784622">json</span><span class="op" id="5784626">.</span><span class="ident" id="5784627">NewDecoder</span><span class="op" id="5784637">(</span><span class="ident" id="5784638">conn</span><span class="op" id="5784642">)</span><span class="op" id="5784643">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784647">enc</span><span class="op" id="5784650">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784656">json</span><span class="op" id="5784660">.</span><span class="ident" id="5784661">NewEncoder</span><span class="op" id="5784671">(</span><span class="ident" id="5784672">conn</span><span class="op" id="5784676">)</span><span class="op" id="5784677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784681">c</span><span class="op" id="5784682">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784690">conn</span><span class="op" id="5784694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784698">pending</span><span class="op" id="5784705">:</span>&nbsp;<span class="builtinfunc" id="5784707">make</span><span class="op" id="5784711">(</span><span class="keyword" id="5784712">map</span><span class="op" id="5784715">[</span><span class="ident" id="5784716">uint64</span><span class="op" id="5784722">]</span><span class="op" id="5784723">*</span><span class="ident" id="5784724">json</span><span class="op" id="5784728">.</span><span class="ident" id="5784729">RawMessage</span><span class="op" id="5784739">)</span><span class="op" id="5784740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5784743">}</span><br>
<span class="lineno"></span><span class="op" id="5784745">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5784748">type</span>&nbsp;<span class="ident" id="5784753">serverRequest</span>&nbsp;<span class="keyword" id="5784767">struct</span>&nbsp;<span class="op" id="5784774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784777">Method</span>&nbsp;<span class="builtintype" id="5784784">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5784801">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784818">Params</span>&nbsp;<span class="op" id="5784825">*</span><span class="ident" id="5784826">json</span><span class="op" id="5784830">.</span><span class="ident" id="5784831">RawMessage</span>&nbsp;<span class="string" id="5784842">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784859">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5784866">*</span><span class="ident" id="5784867">json</span><span class="op" id="5784871">.</span><span class="ident" id="5784872">RawMessage</span>&nbsp;<span class="string" id="5784883">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5784895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5784898">func</span>&nbsp;<span class="op" id="5784903">(</span><span class="ident" id="5784904">r</span>&nbsp;<span class="op" id="5784906">*</span><span class="ident" id="5784907">serverRequest</span><span class="op" id="5784920">)</span>&nbsp;<span class="ident" id="5784922">reset</span><span class="op" id="5784927">(</span><span class="op" id="5784928">)</span>&nbsp;<span class="op" id="5784930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784933">r</span><span class="op" id="5784934">.</span><span class="ident" id="5784935">Method</span>&nbsp;<span class="op" id="5784942">=</span>&nbsp;<span class="string" id="5784944">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784948">r</span><span class="op" id="5784949">.</span><span class="ident" id="5784950">Params</span>&nbsp;<span class="op" id="5784957">=</span>&nbsp;<span class="builtintype" id="5784959">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5784964">r</span><span class="op" id="5784965">.</span><span class="ident" id="5784966">Id</span>&nbsp;<span class="op" id="5784969">=</span>&nbsp;<span class="builtintype" id="5784971">nil</span><br>
<span class="lineno"></span><span class="op" id="5784975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5784978">type</span>&nbsp;<span class="ident" id="5784983">serverResponse</span>&nbsp;<span class="keyword" id="5784998">struct</span>&nbsp;<span class="op" id="5785005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785008">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5785015">*</span><span class="ident" id="5785016">json</span><span class="op" id="5785020">.</span><span class="ident" id="5785021">RawMessage</span>&nbsp;<span class="string" id="5785032">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785045">Result</span>&nbsp;<span class="keyword" id="5785052">interface</span><span class="op" id="5785061">{</span><span class="op" id="5785062">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5785069">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785086">Error</span>&nbsp;&nbsp;<span class="keyword" id="5785093">interface</span><span class="op" id="5785102">{</span><span class="op" id="5785103">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5785110">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5785125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5785128">func</span>&nbsp;<span class="op" id="5785133">(</span><span class="ident" id="5785134">c</span>&nbsp;<span class="op" id="5785136">*</span><span class="ident" id="5785137">serverCodec</span><span class="op" id="5785148">)</span>&nbsp;<span class="ident" id="5785150">ReadRequestHeader</span><span class="op" id="5785167">(</span><span class="ident" id="5785168">r</span>&nbsp;<span class="op" id="5785170">*</span><span class="ident" id="5785171">rpc</span><span class="op" id="5785174">.</span><span class="ident" id="5785175">Request</span><span class="op" id="5785182">)</span>&nbsp;<span class="builtintype" id="5785184">error</span>&nbsp;<span class="op" id="5785190">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785193">c</span><span class="op" id="5785194">.</span><span class="ident" id="5785195">req</span><span class="op" id="5785198">.</span><span class="ident" id="5785199">reset</span><span class="op" id="5785204">(</span><span class="op" id="5785205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785208">if</span>&nbsp;<span class="ident" id="5785211">err</span>&nbsp;<span class="op" id="5785215">:=</span>&nbsp;<span class="ident" id="5785218">c</span><span class="op" id="5785219">.</span><span class="ident" id="5785220">dec</span><span class="op" id="5785223">.</span><span class="ident" id="5785224">Decode</span><span class="op" id="5785230">(</span><span class="op" id="5785231">&amp;</span><span class="ident" id="5785232">c</span><span class="op" id="5785233">.</span><span class="ident" id="5785234">req</span><span class="op" id="5785237">)</span><span class="op" id="5785238">;</span>&nbsp;<span class="ident" id="5785240">err</span>&nbsp;<span class="op" id="5785244">!=</span>&nbsp;<span class="builtintype" id="5785247">nil</span>&nbsp;<span class="op" id="5785251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785255">return</span>&nbsp;<span class="ident" id="5785262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5785267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785270">r</span><span class="op" id="5785271">.</span><span class="ident" id="5785272">ServiceMethod</span>&nbsp;<span class="op" id="5785286">=</span>&nbsp;<span class="ident" id="5785288">c</span><span class="op" id="5785289">.</span><span class="ident" id="5785290">req</span><span class="op" id="5785293">.</span><span class="ident" id="5785294">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785303">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785346">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785392">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785439">c</span><span class="op" id="5785440">.</span><span class="ident" id="5785441">mutex</span><span class="op" id="5785446">.</span><span class="ident" id="5785447">Lock</span><span class="op" id="5785451">(</span><span class="op" id="5785452">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785455">c</span><span class="op" id="5785456">.</span><span class="ident" id="5785457">seq</span><span class="op" id="5785460">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785464">c</span><span class="op" id="5785465">.</span><span class="ident" id="5785466">pending</span><span class="op" id="5785473">[</span><span class="ident" id="5785474">c</span><span class="op" id="5785475">.</span><span class="ident" id="5785476">seq</span><span class="op" id="5785479">]</span>&nbsp;<span class="op" id="5785481">=</span>&nbsp;<span class="ident" id="5785483">c</span><span class="op" id="5785484">.</span><span class="ident" id="5785485">req</span><span class="op" id="5785488">.</span><span class="ident" id="5785489">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785493">c</span><span class="op" id="5785494">.</span><span class="ident" id="5785495">req</span><span class="op" id="5785498">.</span><span class="ident" id="5785499">Id</span>&nbsp;<span class="op" id="5785502">=</span>&nbsp;<span class="builtintype" id="5785504">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785509">r</span><span class="op" id="5785510">.</span><span class="ident" id="5785511">Seq</span>&nbsp;<span class="op" id="5785515">=</span>&nbsp;<span class="ident" id="5785517">c</span><span class="op" id="5785518">.</span><span class="ident" id="5785519">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785524">c</span><span class="op" id="5785525">.</span><span class="ident" id="5785526">mutex</span><span class="op" id="5785531">.</span><span class="ident" id="5785532">Unlock</span><span class="op" id="5785538">(</span><span class="op" id="5785539">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785543">return</span>&nbsp;<span class="builtintype" id="5785550">nil</span><br>
<span class="lineno"></span><span class="op" id="5785554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5785557">func</span>&nbsp;<span class="op" id="5785562">(</span><span class="ident" id="5785563">c</span>&nbsp;<span class="op" id="5785565">*</span><span class="ident" id="5785566">serverCodec</span><span class="op" id="5785577">)</span>&nbsp;<span class="ident" id="5785579">ReadRequestBody</span><span class="op" id="5785594">(</span><span class="ident" id="5785595">x</span>&nbsp;<span class="keyword" id="5785597">interface</span><span class="op" id="5785606">{</span><span class="op" id="5785607">}</span><span class="op" id="5785608">)</span>&nbsp;<span class="builtintype" id="5785610">error</span>&nbsp;<span class="op" id="5785616">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785619">if</span>&nbsp;<span class="ident" id="5785622">x</span>&nbsp;<span class="op" id="5785624">==</span>&nbsp;<span class="builtintype" id="5785627">nil</span>&nbsp;<span class="op" id="5785631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785635">return</span>&nbsp;<span class="builtintype" id="5785642">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5785647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785650">if</span>&nbsp;<span class="ident" id="5785653">c</span><span class="op" id="5785654">.</span><span class="ident" id="5785655">req</span><span class="op" id="5785658">.</span><span class="ident" id="5785659">Params</span>&nbsp;<span class="op" id="5785666">==</span>&nbsp;<span class="builtintype" id="5785669">nil</span>&nbsp;<span class="op" id="5785673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785677">return</span>&nbsp;<span class="ident" id="5785684">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5785702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785705">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785737">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785763">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785815">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785863">var</span>&nbsp;<span class="ident" id="5785867">params</span>&nbsp;<span class="op" id="5785874">[</span><span class="num" id="5785875">1</span><span class="op" id="5785876">]</span><span class="keyword" id="5785877">interface</span><span class="op" id="5785886">{</span><span class="op" id="5785887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785890">params</span><span class="op" id="5785896">[</span><span class="num" id="5785897">0</span><span class="op" id="5785898">]</span>&nbsp;<span class="op" id="5785900">=</span>&nbsp;<span class="ident" id="5785902">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785905">return</span>&nbsp;<span class="ident" id="5785912">json</span><span class="op" id="5785916">.</span><span class="ident" id="5785917">Unmarshal</span><span class="op" id="5785926">(</span><span class="op" id="5785927">*</span><span class="ident" id="5785928">c</span><span class="op" id="5785929">.</span><span class="ident" id="5785930">req</span><span class="op" id="5785933">.</span><span class="ident" id="5785934">Params</span><span class="op" id="5785940">,</span>&nbsp;<span class="op" id="5785942">&amp;</span><span class="ident" id="5785943">params</span><span class="op" id="5785949">)</span><br>
<span class="lineno"></span><span class="op" id="5785951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5785954">var</span>&nbsp;<span class="ident" id="5785958">null</span>&nbsp;<span class="op" id="5785963">=</span>&nbsp;<span class="ident" id="5785965">json</span><span class="op" id="5785969">.</span><span class="ident" id="5785970">RawMessage</span><span class="op" id="5785980">(</span><span class="op" id="5785981">[</span><span class="op" id="5785982">]</span><span class="builtintype" id="5785983">byte</span><span class="op" id="5785987">(</span><span class="string" id="5785988">&#34;null&#34;</span><span class="op" id="5785994">)</span><span class="op" id="5785995">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5785998">func</span>&nbsp;<span class="op" id="5786003">(</span><span class="ident" id="5786004">c</span>&nbsp;<span class="op" id="5786006">*</span><span class="ident" id="5786007">serverCodec</span><span class="op" id="5786018">)</span>&nbsp;<span class="ident" id="5786020">WriteResponse</span><span class="op" id="5786033">(</span><span class="ident" id="5786034">r</span>&nbsp;<span class="op" id="5786036">*</span><span class="ident" id="5786037">rpc</span><span class="op" id="5786040">.</span><span class="ident" id="5786041">Response</span><span class="op" id="5786049">,</span>&nbsp;<span class="ident" id="5786051">x</span>&nbsp;<span class="keyword" id="5786053">interface</span><span class="op" id="5786062">{</span><span class="op" id="5786063">}</span><span class="op" id="5786064">)</span>&nbsp;<span class="builtintype" id="5786066">error</span>&nbsp;<span class="op" id="5786072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786075">c</span><span class="op" id="5786076">.</span><span class="ident" id="5786077">mutex</span><span class="op" id="5786082">.</span><span class="ident" id="5786083">Lock</span><span class="op" id="5786087">(</span><span class="op" id="5786088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786091">b</span><span class="op" id="5786092">,</span>&nbsp;<span class="ident" id="5786094">ok</span>&nbsp;<span class="op" id="5786097">:=</span>&nbsp;<span class="ident" id="5786100">c</span><span class="op" id="5786101">.</span><span class="ident" id="5786102">pending</span><span class="op" id="5786109">[</span><span class="ident" id="5786110">r</span><span class="op" id="5786111">.</span><span class="ident" id="5786112">Seq</span><span class="op" id="5786115">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786118">if</span>&nbsp;<span class="op" id="5786121">!</span><span class="ident" id="5786122">ok</span>&nbsp;<span class="op" id="5786125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786129">c</span><span class="op" id="5786130">.</span><span class="ident" id="5786131">mutex</span><span class="op" id="5786136">.</span><span class="ident" id="5786137">Unlock</span><span class="op" id="5786143">(</span><span class="op" id="5786144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786148">return</span>&nbsp;<span class="ident" id="5786155">errors</span><span class="op" id="5786161">.</span><span class="ident" id="5786162">New</span><span class="op" id="5786165">(</span><span class="string" id="5786166">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5786203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5786206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5786209">delete</span><span class="op" id="5786215">(</span><span class="ident" id="5786216">c</span><span class="op" id="5786217">.</span><span class="ident" id="5786218">pending</span><span class="op" id="5786225">,</span>&nbsp;<span class="ident" id="5786227">r</span><span class="op" id="5786228">.</span><span class="ident" id="5786229">Seq</span><span class="op" id="5786232">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786235">c</span><span class="op" id="5786236">.</span><span class="ident" id="5786237">mutex</span><span class="op" id="5786242">.</span><span class="ident" id="5786243">Unlock</span><span class="op" id="5786249">(</span><span class="op" id="5786250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786254">if</span>&nbsp;<span class="ident" id="5786257">b</span>&nbsp;<span class="op" id="5786259">==</span>&nbsp;<span class="builtintype" id="5786262">nil</span>&nbsp;<span class="op" id="5786266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5786270">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786317">b</span>&nbsp;<span class="op" id="5786319">=</span>&nbsp;<span class="op" id="5786321">&amp;</span><span class="ident" id="5786322">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5786328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786331">resp</span>&nbsp;<span class="op" id="5786336">:=</span>&nbsp;<span class="ident" id="5786339">serverResponse</span><span class="op" id="5786353">{</span><span class="ident" id="5786354">Id</span><span class="op" id="5786356">:</span>&nbsp;<span class="ident" id="5786358">b</span><span class="op" id="5786359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786362">if</span>&nbsp;<span class="ident" id="5786365">r</span><span class="op" id="5786366">.</span><span class="ident" id="5786367">Error</span>&nbsp;<span class="op" id="5786373">==</span>&nbsp;<span class="string" id="5786376">&#34;&#34;</span>&nbsp;<span class="op" id="5786379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786383">resp</span><span class="op" id="5786387">.</span><span class="ident" id="5786388">Result</span>&nbsp;<span class="op" id="5786395">=</span>&nbsp;<span class="ident" id="5786397">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5786400">}</span>&nbsp;<span class="keyword" id="5786402">else</span>&nbsp;<span class="op" id="5786407">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786411">resp</span><span class="op" id="5786415">.</span><span class="ident" id="5786416">Error</span>&nbsp;<span class="op" id="5786422">=</span>&nbsp;<span class="ident" id="5786424">r</span><span class="op" id="5786425">.</span><span class="ident" id="5786426">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5786433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786436">return</span>&nbsp;<span class="ident" id="5786443">c</span><span class="op" id="5786444">.</span><span class="ident" id="5786445">enc</span><span class="op" id="5786448">.</span><span class="ident" id="5786449">Encode</span><span class="op" id="5786455">(</span><span class="ident" id="5786456">resp</span><span class="op" id="5786460">)</span><br>
<span class="lineno"></span><span class="op" id="5786462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5786465">func</span>&nbsp;<span class="op" id="5786470">(</span><span class="ident" id="5786471">c</span>&nbsp;<span class="op" id="5786473">*</span><span class="ident" id="5786474">serverCodec</span><span class="op" id="5786485">)</span>&nbsp;<span class="ident" id="5786487">Close</span><span class="op" id="5786492">(</span><span class="op" id="5786493">)</span>&nbsp;<span class="builtintype" id="5786495">error</span>&nbsp;<span class="op" id="5786501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786504">return</span>&nbsp;<span class="ident" id="5786511">c</span><span class="op" id="5786512">.</span><span class="ident" id="5786513">c</span><span class="op" id="5786514">.</span><span class="ident" id="5786515">Close</span><span class="op" id="5786520">(</span><span class="op" id="5786521">)</span><br>
<span class="lineno"></span><span class="op" id="5786523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5786526">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5786588">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5786659">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5786720">func</span>&nbsp;<span class="ident" id="5786725">ServeConn</span><span class="op" id="5786734">(</span><span class="ident" id="5786735">conn</span>&nbsp;<span class="ident" id="5786740">io</span><span class="op" id="5786742">.</span><span class="ident" id="5786743">ReadWriteCloser</span><span class="op" id="5786758">)</span>&nbsp;<span class="op" id="5786760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786763">rpc</span><span class="op" id="5786766">.</span><span class="ident" id="5786767">ServeCodec</span><span class="op" id="5786777">(</span><span class="ident" id="5786778">NewServerCodec</span><span class="op" id="5786792">(</span><span class="ident" id="5786793">conn</span><span class="op" id="5786797">)</span><span class="op" id="5786798">)</span><br>
<span class="lineno"></span><span class="op" id="5786800">}</span>
</div>
</body>
</html>
