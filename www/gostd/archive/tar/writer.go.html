<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5503949">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5504004">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5504058">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5504109">package</span>&nbsp;<span class="ident" id="5504117">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5504122">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="5504141">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5504189">import</span>&nbsp;<span class="op" id="5504196">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504199">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504208">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504218">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504225">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504231">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504237">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504245">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504256">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5504267">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5504274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504277">var</span>&nbsp;<span class="op" id="5504281">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504284">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504303">=</span>&nbsp;<span class="ident" id="5504305">errors</span><span class="op" id="5504311">.</span><span class="ident" id="5504312">New</span><span class="op" id="5504315">(</span><span class="string" id="5504316">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="5504345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504348">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504367">=</span>&nbsp;<span class="ident" id="5504369">errors</span><span class="op" id="5504375">.</span><span class="ident" id="5504376">New</span><span class="op" id="5504379">(</span><span class="string" id="5504380">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="5504416">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504419">ErrWriteAfterClose</span>&nbsp;<span class="op" id="5504438">=</span>&nbsp;<span class="ident" id="5504440">errors</span><span class="op" id="5504446">.</span><span class="ident" id="5504447">New</span><span class="op" id="5504450">(</span><span class="string" id="5504451">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="5504483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504486">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504505">=</span>&nbsp;<span class="ident" id="5504507">errors</span><span class="op" id="5504513">.</span><span class="ident" id="5504514">New</span><span class="op" id="5504517">(</span><span class="string" id="5504518">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="5504546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504549">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5504568">=</span>&nbsp;<span class="ident" id="5504570">errors</span><span class="op" id="5504576">.</span><span class="ident" id="5504577">New</span><span class="op" id="5504580">(</span><span class="string" id="5504581">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="5504644">)</span><br>
<span class="lineno"></span><span class="op" id="5504646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="5504649">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5504725">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5504775">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="5504864">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="5504908">type</span>&nbsp;<span class="ident" id="5504913">Writer</span>&nbsp;<span class="keyword" id="5504920">struct</span>&nbsp;<span class="op" id="5504927">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504930">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504941">io</span><span class="op" id="5504943">.</span><span class="ident" id="5504944">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504952">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504963">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504970">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504981">int64</span>&nbsp;<span class="comment" id="5504987">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505040">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505051">int64</span>&nbsp;<span class="comment" id="5505057">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505113">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5505124">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505130">usedBinary</span>&nbsp;<span class="builtintype" id="5505141">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505157">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505213">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="5505224">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505240">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505292">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505303">[</span><span class="ident" id="5505304">blockSize</span><span class="op" id="5505313">]</span><span class="builtintype" id="5505314">byte</span>&nbsp;<span class="comment" id="5505319">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505382">paxHdrBuff</span>&nbsp;<span class="op" id="5505393">[</span><span class="ident" id="5505394">blockSize</span><span class="op" id="5505403">]</span><span class="builtintype" id="5505404">byte</span>&nbsp;<span class="comment" id="5505409">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="5505467">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5505470">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5505518">func</span>&nbsp;<span class="ident" id="5505523">NewWriter</span><span class="op" id="5505532">(</span><span class="ident" id="5505533">w</span>&nbsp;<span class="ident" id="5505535">io</span><span class="op" id="5505537">.</span><span class="ident" id="5505538">Writer</span><span class="op" id="5505544">)</span>&nbsp;<span class="op" id="5505546">*</span><span class="ident" id="5505547">Writer</span>&nbsp;<span class="op" id="5505554">{</span>&nbsp;<span class="keyword" id="5505556">return</span>&nbsp;<span class="op" id="5505563">&amp;</span><span class="ident" id="5505564">Writer</span><span class="op" id="5505570">{</span><span class="ident" id="5505571">w</span><span class="op" id="5505572">:</span>&nbsp;<span class="ident" id="5505574">w</span><span class="op" id="5505575">}</span>&nbsp;<span class="op" id="5505577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5505580">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="5505635">func</span>&nbsp;<span class="op" id="5505640">(</span><span class="ident" id="5505641">tw</span>&nbsp;<span class="op" id="5505644">*</span><span class="ident" id="5505645">Writer</span><span class="op" id="5505651">)</span>&nbsp;<span class="ident" id="5505653">Flush</span><span class="op" id="5505658">(</span><span class="op" id="5505659">)</span>&nbsp;<span class="builtintype" id="5505661">error</span>&nbsp;<span class="op" id="5505667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505670">if</span>&nbsp;<span class="ident" id="5505673">tw</span><span class="op" id="5505675">.</span><span class="ident" id="5505676">nb</span>&nbsp;<span class="op" id="5505679">&gt;</span>&nbsp;<span class="num" id="5505681">0</span>&nbsp;<span class="op" id="5505683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505687">tw</span><span class="op" id="5505689">.</span><span class="ident" id="5505690">err</span>&nbsp;<span class="op" id="5505694">=</span>&nbsp;<span class="ident" id="5505696">fmt</span><span class="op" id="5505699">.</span><span class="ident" id="5505700">Errorf</span><span class="op" id="5505706">(</span><span class="string" id="5505707">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="5505745">,</span>&nbsp;<span class="ident" id="5505747">tw</span><span class="op" id="5505749">.</span><span class="ident" id="5505750">nb</span><span class="op" id="5505752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505756">return</span>&nbsp;<span class="ident" id="5505763">tw</span><span class="op" id="5505765">.</span><span class="ident" id="5505766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505771">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505775">n</span>&nbsp;<span class="op" id="5505777">:=</span>&nbsp;<span class="ident" id="5505780">tw</span><span class="op" id="5505782">.</span><span class="ident" id="5505783">nb</span>&nbsp;<span class="op" id="5505786">+</span>&nbsp;<span class="ident" id="5505788">tw</span><span class="op" id="5505790">.</span><span class="ident" id="5505791">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505796">for</span>&nbsp;<span class="ident" id="5505800">n</span>&nbsp;<span class="op" id="5505802">&gt;</span>&nbsp;<span class="num" id="5505804">0</span>&nbsp;<span class="op" id="5505806">&amp;&amp;</span>&nbsp;<span class="ident" id="5505809">tw</span><span class="op" id="5505811">.</span><span class="ident" id="5505812">err</span>&nbsp;<span class="op" id="5505816">==</span>&nbsp;<span class="ident" id="5505819">nil</span>&nbsp;<span class="op" id="5505823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505827">nr</span>&nbsp;<span class="op" id="5505830">:=</span>&nbsp;<span class="ident" id="5505833">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505837">if</span>&nbsp;<span class="ident" id="5505840">nr</span>&nbsp;<span class="op" id="5505843">&gt;</span>&nbsp;<span class="ident" id="5505845">blockSize</span>&nbsp;<span class="op" id="5505855">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505860">nr</span>&nbsp;<span class="op" id="5505863">=</span>&nbsp;<span class="ident" id="5505865">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505881">var</span>&nbsp;<span class="ident" id="5505885">nw</span>&nbsp;<span class="builtintype" id="5505888">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505894">nw</span><span class="op" id="5505896">,</span>&nbsp;<span class="ident" id="5505898">tw</span><span class="op" id="5505900">.</span><span class="ident" id="5505901">err</span>&nbsp;<span class="op" id="5505905">=</span>&nbsp;<span class="ident" id="5505907">tw</span><span class="op" id="5505909">.</span><span class="ident" id="5505910">w</span><span class="op" id="5505911">.</span><span class="ident" id="5505912">Write</span><span class="op" id="5505917">(</span><span class="ident" id="5505918">zeroBlock</span><span class="op" id="5505927">[</span><span class="num" id="5505928">0</span><span class="op" id="5505929">:</span><span class="ident" id="5505930">nr</span><span class="op" id="5505932">]</span><span class="op" id="5505933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505937">n</span>&nbsp;<span class="op" id="5505939">-=</span>&nbsp;<span class="ident" id="5505942">int64</span><span class="op" id="5505947">(</span><span class="ident" id="5505948">nw</span><span class="op" id="5505950">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505956">tw</span><span class="op" id="5505958">.</span><span class="ident" id="5505959">nb</span>&nbsp;<span class="op" id="5505962">=</span>&nbsp;<span class="num" id="5505964">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505967">tw</span><span class="op" id="5505969">.</span><span class="ident" id="5505970">pad</span>&nbsp;<span class="op" id="5505974">=</span>&nbsp;<span class="num" id="5505976">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505979">return</span>&nbsp;<span class="ident" id="5505986">tw</span><span class="op" id="5505988">.</span><span class="ident" id="5505989">err</span><br>
<span class="lineno"></span><span class="op" id="5505993">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5505996">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="5506059">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5506153">func</span>&nbsp;<span class="op" id="5506158">(</span><span class="ident" id="5506159">tw</span>&nbsp;<span class="op" id="5506162">*</span><span class="ident" id="5506163">Writer</span><span class="op" id="5506169">)</span>&nbsp;<span class="ident" id="5506171">cString</span><span class="op" id="5506178">(</span><span class="ident" id="5506179">b</span>&nbsp;<span class="op" id="5506181">[</span><span class="op" id="5506182">]</span><span class="builtintype" id="5506183">byte</span><span class="op" id="5506187">,</span>&nbsp;<span class="ident" id="5506189">s</span>&nbsp;<span class="builtintype" id="5506191">string</span><span class="op" id="5506197">,</span>&nbsp;<span class="ident" id="5506199">allowPax</span>&nbsp;<span class="builtintype" id="5506208">bool</span><span class="op" id="5506212">,</span>&nbsp;<span class="ident" id="5506214">paxKeyword</span>&nbsp;<span class="builtintype" id="5506225">string</span><span class="op" id="5506231">,</span>&nbsp;<span class="ident" id="5506233">paxHeaders</span>&nbsp;<span class="keyword" id="5506244">map</span><span class="op" id="5506247">[</span><span class="builtintype" id="5506248">string</span><span class="op" id="5506254">]</span><span class="builtintype" id="5506255">string</span><span class="op" id="5506261">)</span>&nbsp;<span class="op" id="5506263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506266">needsPaxHeader</span>&nbsp;<span class="op" id="5506281">:=</span>&nbsp;<span class="ident" id="5506284">allowPax</span>&nbsp;<span class="op" id="5506293">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5506296">len</span><span class="op" id="5506299">(</span><span class="ident" id="5506300">s</span><span class="op" id="5506301">)</span>&nbsp;<span class="op" id="5506303">&gt;</span>&nbsp;<span class="builtinfunc" id="5506305">len</span><span class="op" id="5506308">(</span><span class="ident" id="5506309">b</span><span class="op" id="5506310">)</span>&nbsp;<span class="op" id="5506312">||</span>&nbsp;<span class="op" id="5506315">!</span><span class="ident" id="5506316">isASCII</span><span class="op" id="5506323">(</span><span class="ident" id="5506324">s</span><span class="op" id="5506325">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506328">if</span>&nbsp;<span class="ident" id="5506331">needsPaxHeader</span>&nbsp;<span class="op" id="5506346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506350">paxHeaders</span><span class="op" id="5506360">[</span><span class="ident" id="5506361">paxKeyword</span><span class="op" id="5506371">]</span>&nbsp;<span class="op" id="5506373">=</span>&nbsp;<span class="ident" id="5506375">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506379">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506390">if</span>&nbsp;<span class="builtinfunc" id="5506393">len</span><span class="op" id="5506396">(</span><span class="ident" id="5506397">s</span><span class="op" id="5506398">)</span>&nbsp;<span class="op" id="5506400">&gt;</span>&nbsp;<span class="builtinfunc" id="5506402">len</span><span class="op" id="5506405">(</span><span class="ident" id="5506406">b</span><span class="op" id="5506407">)</span>&nbsp;<span class="op" id="5506409">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506413">if</span>&nbsp;<span class="ident" id="5506416">tw</span><span class="op" id="5506418">.</span><span class="ident" id="5506419">err</span>&nbsp;<span class="op" id="5506423">==</span>&nbsp;<span class="ident" id="5506426">nil</span>&nbsp;<span class="op" id="5506430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506435">tw</span><span class="op" id="5506437">.</span><span class="ident" id="5506438">err</span>&nbsp;<span class="op" id="5506442">=</span>&nbsp;<span class="ident" id="5506444">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506466">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506474">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506477">ascii</span>&nbsp;<span class="op" id="5506483">:=</span>&nbsp;<span class="ident" id="5506486">toASCII</span><span class="op" id="5506493">(</span><span class="ident" id="5506494">s</span><span class="op" id="5506495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5506498">copy</span><span class="op" id="5506502">(</span><span class="ident" id="5506503">b</span><span class="op" id="5506504">,</span>&nbsp;<span class="ident" id="5506506">ascii</span><span class="op" id="5506511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506514">if</span>&nbsp;<span class="builtinfunc" id="5506517">len</span><span class="op" id="5506520">(</span><span class="ident" id="5506521">ascii</span><span class="op" id="5506526">)</span>&nbsp;<span class="op" id="5506528">&lt;</span>&nbsp;<span class="builtinfunc" id="5506530">len</span><span class="op" id="5506533">(</span><span class="ident" id="5506534">b</span><span class="op" id="5506535">)</span>&nbsp;<span class="op" id="5506537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506541">b</span><span class="op" id="5506542">[</span><span class="builtinfunc" id="5506543">len</span><span class="op" id="5506546">(</span><span class="ident" id="5506547">ascii</span><span class="op" id="5506552">)</span><span class="op" id="5506553">]</span>&nbsp;<span class="op" id="5506555">=</span>&nbsp;<span class="num" id="5506557">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506560">}</span><br>
<span class="lineno">90</span><span class="op" id="5506562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5506565">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="5506642">func</span>&nbsp;<span class="op" id="5506647">(</span><span class="ident" id="5506648">tw</span>&nbsp;<span class="op" id="5506651">*</span><span class="ident" id="5506652">Writer</span><span class="op" id="5506658">)</span>&nbsp;<span class="ident" id="5506660">octal</span><span class="op" id="5506665">(</span><span class="ident" id="5506666">b</span>&nbsp;<span class="op" id="5506668">[</span><span class="op" id="5506669">]</span><span class="builtintype" id="5506670">byte</span><span class="op" id="5506674">,</span>&nbsp;<span class="ident" id="5506676">x</span>&nbsp;<span class="ident" id="5506678">int64</span><span class="op" id="5506683">)</span>&nbsp;<span class="op" id="5506685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506688">s</span>&nbsp;<span class="op" id="5506690">:=</span>&nbsp;<span class="ident" id="5506693">strconv</span><span class="op" id="5506700">.</span><span class="ident" id="5506701">FormatInt</span><span class="op" id="5506710">(</span><span class="ident" id="5506711">x</span><span class="op" id="5506712">,</span>&nbsp;<span class="num" id="5506714">8</span><span class="op" id="5506715">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5506718">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506763">for</span>&nbsp;<span class="builtinfunc" id="5506767">len</span><span class="op" id="5506770">(</span><span class="ident" id="5506771">s</span><span class="op" id="5506772">)</span><span class="op" id="5506773">+</span><span class="num" id="5506774">1</span>&nbsp;<span class="op" id="5506776">&lt;</span>&nbsp;<span class="builtinfunc" id="5506778">len</span><span class="op" id="5506781">(</span><span class="ident" id="5506782">b</span><span class="op" id="5506783">)</span>&nbsp;<span class="op" id="5506785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506789">s</span>&nbsp;<span class="op" id="5506791">=</span>&nbsp;<span class="string" id="5506793">&#34;0&#34;</span>&nbsp;<span class="op" id="5506797">+</span>&nbsp;<span class="ident" id="5506799">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506805">tw</span><span class="op" id="5506807">.</span><span class="ident" id="5506808">cString</span><span class="op" id="5506815">(</span><span class="ident" id="5506816">b</span><span class="op" id="5506817">,</span>&nbsp;<span class="ident" id="5506819">s</span><span class="op" id="5506820">,</span>&nbsp;<span class="builtintype" id="5506822">false</span><span class="op" id="5506827">,</span>&nbsp;<span class="ident" id="5506829">paxNone</span><span class="op" id="5506836">,</span>&nbsp;<span class="ident" id="5506838">nil</span><span class="op" id="5506841">)</span><br>
<span class="lineno">100</span><span class="op" id="5506843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5506846">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="5506919">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="5507045">func</span>&nbsp;<span class="op" id="5507050">(</span><span class="ident" id="5507051">tw</span>&nbsp;<span class="op" id="5507054">*</span><span class="ident" id="5507055">Writer</span><span class="op" id="5507061">)</span>&nbsp;<span class="ident" id="5507063">numeric</span><span class="op" id="5507070">(</span><span class="ident" id="5507071">b</span>&nbsp;<span class="op" id="5507073">[</span><span class="op" id="5507074">]</span><span class="builtintype" id="5507075">byte</span><span class="op" id="5507079">,</span>&nbsp;<span class="ident" id="5507081">x</span>&nbsp;<span class="ident" id="5507083">int64</span><span class="op" id="5507088">,</span>&nbsp;<span class="ident" id="5507090">allowPax</span>&nbsp;<span class="builtintype" id="5507099">bool</span><span class="op" id="5507103">,</span>&nbsp;<span class="ident" id="5507105">paxKeyword</span>&nbsp;<span class="builtintype" id="5507116">string</span><span class="op" id="5507122">,</span>&nbsp;<span class="ident" id="5507124">paxHeaders</span>&nbsp;<span class="keyword" id="5507135">map</span><span class="op" id="5507138">[</span><span class="builtintype" id="5507139">string</span><span class="op" id="5507145">]</span><span class="builtintype" id="5507146">string</span><span class="op" id="5507152">)</span>&nbsp;<span class="op" id="5507154">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507157">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507178">s</span>&nbsp;<span class="op" id="5507180">:=</span>&nbsp;<span class="ident" id="5507183">strconv</span><span class="op" id="5507190">.</span><span class="ident" id="5507191">FormatInt</span><span class="op" id="5507200">(</span><span class="ident" id="5507201">x</span><span class="op" id="5507202">,</span>&nbsp;<span class="num" id="5507204">8</span><span class="op" id="5507205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507208">if</span>&nbsp;<span class="builtinfunc" id="5507211">len</span><span class="op" id="5507214">(</span><span class="ident" id="5507215">s</span><span class="op" id="5507216">)</span>&nbsp;<span class="op" id="5507218">&lt;</span>&nbsp;<span class="builtinfunc" id="5507220">len</span><span class="op" id="5507223">(</span><span class="ident" id="5507224">b</span><span class="op" id="5507225">)</span>&nbsp;<span class="op" id="5507227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507231">tw</span><span class="op" id="5507233">.</span><span class="ident" id="5507234">octal</span><span class="op" id="5507239">(</span><span class="ident" id="5507240">b</span><span class="op" id="5507241">,</span>&nbsp;<span class="ident" id="5507243">x</span><span class="op" id="5507244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507248">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507260">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507332">if</span>&nbsp;<span class="ident" id="5507335">allowPax</span>&nbsp;<span class="op" id="5507344">&amp;&amp;</span>&nbsp;<span class="ident" id="5507347">tw</span><span class="op" id="5507349">.</span><span class="ident" id="5507350">preferPax</span>&nbsp;<span class="op" id="5507360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507364">tw</span><span class="op" id="5507366">.</span><span class="ident" id="5507367">octal</span><span class="op" id="5507372">(</span><span class="ident" id="5507373">b</span><span class="op" id="5507374">,</span>&nbsp;<span class="num" id="5507376">0</span><span class="op" id="5507377">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507381">s</span>&nbsp;<span class="op" id="5507383">:=</span>&nbsp;<span class="ident" id="5507386">strconv</span><span class="op" id="5507393">.</span><span class="ident" id="5507394">FormatInt</span><span class="op" id="5507403">(</span><span class="ident" id="5507404">x</span><span class="op" id="5507405">,</span>&nbsp;<span class="num" id="5507407">10</span><span class="op" id="5507409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507413">paxHeaders</span><span class="op" id="5507423">[</span><span class="ident" id="5507424">paxKeyword</span><span class="op" id="5507434">]</span>&nbsp;<span class="op" id="5507436">=</span>&nbsp;<span class="ident" id="5507438">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507442">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507454">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507492">tw</span><span class="op" id="5507494">.</span><span class="ident" id="5507495">usedBinary</span>&nbsp;<span class="op" id="5507506">=</span>&nbsp;<span class="builtintype" id="5507508">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507514">for</span>&nbsp;<span class="ident" id="5507518">i</span>&nbsp;<span class="op" id="5507520">:=</span>&nbsp;<span class="builtinfunc" id="5507523">len</span><span class="op" id="5507526">(</span><span class="ident" id="5507527">b</span><span class="op" id="5507528">)</span>&nbsp;<span class="op" id="5507530">-</span>&nbsp;<span class="num" id="5507532">1</span><span class="op" id="5507533">;</span>&nbsp;<span class="ident" id="5507535">x</span>&nbsp;<span class="op" id="5507537">&gt;</span>&nbsp;<span class="num" id="5507539">0</span>&nbsp;<span class="op" id="5507541">&amp;&amp;</span>&nbsp;<span class="ident" id="5507544">i</span>&nbsp;<span class="op" id="5507546">&gt;=</span>&nbsp;<span class="num" id="5507549">0</span><span class="op" id="5507550">;</span>&nbsp;<span class="ident" id="5507552">i</span><span class="op" id="5507553">--</span>&nbsp;<span class="op" id="5507556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507560">b</span><span class="op" id="5507561">[</span><span class="ident" id="5507562">i</span><span class="op" id="5507563">]</span>&nbsp;<span class="op" id="5507565">=</span>&nbsp;<span class="builtintype" id="5507567">byte</span><span class="op" id="5507571">(</span><span class="ident" id="5507572">x</span><span class="op" id="5507573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507577">x</span>&nbsp;<span class="op" id="5507579">&gt;&gt;=</span>&nbsp;<span class="num" id="5507583">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507589">b</span><span class="op" id="5507590">[</span><span class="num" id="5507591">0</span><span class="op" id="5507592">]</span>&nbsp;<span class="op" id="5507594">|=</span>&nbsp;<span class="num" id="5507597">0x80</span>&nbsp;<span class="comment" id="5507602">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="5507641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5507644">var</span>&nbsp;<span class="op" id="5507648">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507651">minTime</span>&nbsp;<span class="op" id="5507659">=</span>&nbsp;<span class="ident" id="5507661">time</span><span class="op" id="5507665">.</span><span class="ident" id="5507666">Unix</span><span class="op" id="5507670">(</span><span class="num" id="5507671">0</span><span class="op" id="5507672">,</span>&nbsp;<span class="num" id="5507674">0</span><span class="op" id="5507675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507678">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507736">maxTime</span>&nbsp;<span class="op" id="5507744">=</span>&nbsp;<span class="ident" id="5507746">minTime</span><span class="op" id="5507753">.</span><span class="ident" id="5507754">Add</span><span class="op" id="5507757">(</span><span class="op" id="5507758">(</span><span class="num" id="5507759">1</span><span class="op" id="5507760">&lt;&lt;</span><span class="num" id="5507762">33</span>&nbsp;<span class="op" id="5507765">-</span>&nbsp;<span class="num" id="5507767">1</span><span class="op" id="5507768">)</span>&nbsp;<span class="op" id="5507770">*</span>&nbsp;<span class="ident" id="5507772">time</span><span class="op" id="5507776">.</span><span class="ident" id="5507777">Second</span><span class="op" id="5507783">)</span><br>
<span class="lineno"></span><span class="op" id="5507785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="5507788">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5507858">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5507916">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="5507973">func</span>&nbsp;<span class="op" id="5507978">(</span><span class="ident" id="5507979">tw</span>&nbsp;<span class="op" id="5507982">*</span><span class="ident" id="5507983">Writer</span><span class="op" id="5507989">)</span>&nbsp;<span class="ident" id="5507991">WriteHeader</span><span class="op" id="5508002">(</span><span class="ident" id="5508003">hdr</span>&nbsp;<span class="op" id="5508007">*</span><span class="ident" id="5508008">Header</span><span class="op" id="5508014">)</span>&nbsp;<span class="builtintype" id="5508016">error</span>&nbsp;<span class="op" id="5508022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508025">return</span>&nbsp;<span class="ident" id="5508032">tw</span><span class="op" id="5508034">.</span><span class="ident" id="5508035">writeHeader</span><span class="op" id="5508046">(</span><span class="ident" id="5508047">hdr</span><span class="op" id="5508050">,</span>&nbsp;<span class="builtintype" id="5508052">true</span><span class="op" id="5508056">)</span><br>
<span class="lineno">140</span><span class="op" id="5508058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5508061">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="5508131">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5508189">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="5508246">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5508319">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5508355">func</span>&nbsp;<span class="op" id="5508360">(</span><span class="ident" id="5508361">tw</span>&nbsp;<span class="op" id="5508364">*</span><span class="ident" id="5508365">Writer</span><span class="op" id="5508371">)</span>&nbsp;<span class="ident" id="5508373">writeHeader</span><span class="op" id="5508384">(</span><span class="ident" id="5508385">hdr</span>&nbsp;<span class="op" id="5508389">*</span><span class="ident" id="5508390">Header</span><span class="op" id="5508396">,</span>&nbsp;<span class="ident" id="5508398">allowPax</span>&nbsp;<span class="builtintype" id="5508407">bool</span><span class="op" id="5508411">)</span>&nbsp;<span class="builtintype" id="5508413">error</span>&nbsp;<span class="op" id="5508419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508422">if</span>&nbsp;<span class="ident" id="5508425">tw</span><span class="op" id="5508427">.</span><span class="ident" id="5508428">closed</span>&nbsp;<span class="op" id="5508435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508439">return</span>&nbsp;<span class="ident" id="5508446">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508469">if</span>&nbsp;<span class="ident" id="5508472">tw</span><span class="op" id="5508474">.</span><span class="ident" id="5508475">err</span>&nbsp;<span class="op" id="5508479">==</span>&nbsp;<span class="ident" id="5508482">nil</span>&nbsp;<span class="op" id="5508486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508490">tw</span><span class="op" id="5508492">.</span><span class="ident" id="5508493">Flush</span><span class="op" id="5508498">(</span><span class="op" id="5508499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508505">if</span>&nbsp;<span class="ident" id="5508508">tw</span><span class="op" id="5508510">.</span><span class="ident" id="5508511">err</span>&nbsp;<span class="op" id="5508515">!=</span>&nbsp;<span class="ident" id="5508518">nil</span>&nbsp;<span class="op" id="5508522">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508526">return</span>&nbsp;<span class="ident" id="5508533">tw</span><span class="op" id="5508535">.</span><span class="ident" id="5508536">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508545">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508601">paxHeaders</span>&nbsp;<span class="op" id="5508612">:=</span>&nbsp;<span class="builtinfunc" id="5508615">make</span><span class="op" id="5508619">(</span><span class="keyword" id="5508620">map</span><span class="op" id="5508623">[</span><span class="builtintype" id="5508624">string</span><span class="op" id="5508630">]</span><span class="builtintype" id="5508631">string</span><span class="op" id="5508637">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508641">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508702">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508764">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508809">var</span>&nbsp;<span class="ident" id="5508813">header</span>&nbsp;<span class="op" id="5508820">[</span><span class="op" id="5508821">]</span><span class="builtintype" id="5508822">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508829">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508890">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508956">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509038">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509118">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509195">header</span>&nbsp;<span class="op" id="5509202">=</span>&nbsp;<span class="ident" id="5509204">tw</span><span class="op" id="5509206">.</span><span class="ident" id="5509207">hdrBuff</span><span class="op" id="5509214">[</span><span class="op" id="5509215">:</span><span class="op" id="5509216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509219">if</span>&nbsp;<span class="op" id="5509222">!</span><span class="ident" id="5509223">allowPax</span>&nbsp;<span class="op" id="5509232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509236">header</span>&nbsp;<span class="op" id="5509243">=</span>&nbsp;<span class="ident" id="5509245">tw</span><span class="op" id="5509247">.</span><span class="ident" id="5509248">paxHdrBuff</span><span class="op" id="5509258">[</span><span class="op" id="5509259">:</span><span class="op" id="5509260">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5509266">copy</span><span class="op" id="5509270">(</span><span class="ident" id="5509271">header</span><span class="op" id="5509277">,</span>&nbsp;<span class="ident" id="5509279">zeroBlock</span><span class="op" id="5509288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509291">s</span>&nbsp;<span class="op" id="5509293">:=</span>&nbsp;<span class="ident" id="5509296">slicer</span><span class="op" id="5509302">(</span><span class="ident" id="5509303">header</span><span class="op" id="5509309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509313">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509441">pathHeaderBytes</span>&nbsp;<span class="op" id="5509457">:=</span>&nbsp;<span class="ident" id="5509460">s</span><span class="op" id="5509461">.</span><span class="ident" id="5509462">next</span><span class="op" id="5509466">(</span><span class="ident" id="5509467">fileNameSize</span><span class="op" id="5509479">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509483">tw</span><span class="op" id="5509485">.</span><span class="ident" id="5509486">cString</span><span class="op" id="5509493">(</span><span class="ident" id="5509494">pathHeaderBytes</span><span class="op" id="5509509">,</span>&nbsp;<span class="ident" id="5509511">hdr</span><span class="op" id="5509514">.</span><span class="ident" id="5509515">Name</span><span class="op" id="5509519">,</span>&nbsp;<span class="builtintype" id="5509521">true</span><span class="op" id="5509525">,</span>&nbsp;<span class="ident" id="5509527">paxPath</span><span class="op" id="5509534">,</span>&nbsp;<span class="ident" id="5509536">paxHeaders</span><span class="op" id="5509546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509550">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509593">var</span>&nbsp;<span class="ident" id="5509597">modTime</span>&nbsp;<span class="ident" id="5509605">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509612">if</span>&nbsp;<span class="op" id="5509615">!</span><span class="ident" id="5509616">hdr</span><span class="op" id="5509619">.</span><span class="ident" id="5509620">ModTime</span><span class="op" id="5509627">.</span><span class="ident" id="5509628">Before</span><span class="op" id="5509634">(</span><span class="ident" id="5509635">minTime</span><span class="op" id="5509642">)</span>&nbsp;<span class="op" id="5509644">&amp;&amp;</span>&nbsp;<span class="op" id="5509647">!</span><span class="ident" id="5509648">hdr</span><span class="op" id="5509651">.</span><span class="ident" id="5509652">ModTime</span><span class="op" id="5509659">.</span><span class="ident" id="5509660">After</span><span class="op" id="5509665">(</span><span class="ident" id="5509666">maxTime</span><span class="op" id="5509673">)</span>&nbsp;<span class="op" id="5509675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509679">modTime</span>&nbsp;<span class="op" id="5509687">=</span>&nbsp;<span class="ident" id="5509689">hdr</span><span class="op" id="5509692">.</span><span class="ident" id="5509693">ModTime</span><span class="op" id="5509700">.</span><span class="ident" id="5509701">Unix</span><span class="op" id="5509705">(</span><span class="op" id="5509706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509713">tw</span><span class="op" id="5509715">.</span><span class="ident" id="5509716">octal</span><span class="op" id="5509721">(</span><span class="ident" id="5509722">s</span><span class="op" id="5509723">.</span><span class="ident" id="5509724">next</span><span class="op" id="5509728">(</span><span class="num" id="5509729">8</span><span class="op" id="5509730">)</span><span class="op" id="5509731">,</span>&nbsp;<span class="ident" id="5509733">hdr</span><span class="op" id="5509736">.</span><span class="ident" id="5509737">Mode</span><span class="op" id="5509741">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509777">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509789">tw</span><span class="op" id="5509791">.</span><span class="ident" id="5509792">numeric</span><span class="op" id="5509799">(</span><span class="ident" id="5509800">s</span><span class="op" id="5509801">.</span><span class="ident" id="5509802">next</span><span class="op" id="5509806">(</span><span class="num" id="5509807">8</span><span class="op" id="5509808">)</span><span class="op" id="5509809">,</span>&nbsp;<span class="ident" id="5509811">int64</span><span class="op" id="5509816">(</span><span class="ident" id="5509817">hdr</span><span class="op" id="5509820">.</span><span class="ident" id="5509821">Uid</span><span class="op" id="5509824">)</span><span class="op" id="5509825">,</span>&nbsp;<span class="builtintype" id="5509827">true</span><span class="op" id="5509831">,</span>&nbsp;<span class="ident" id="5509833">paxUid</span><span class="op" id="5509839">,</span>&nbsp;<span class="ident" id="5509841">paxHeaders</span><span class="op" id="5509851">)</span>&nbsp;<span class="comment" id="5509853">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509865">tw</span><span class="op" id="5509867">.</span><span class="ident" id="5509868">numeric</span><span class="op" id="5509875">(</span><span class="ident" id="5509876">s</span><span class="op" id="5509877">.</span><span class="ident" id="5509878">next</span><span class="op" id="5509882">(</span><span class="num" id="5509883">8</span><span class="op" id="5509884">)</span><span class="op" id="5509885">,</span>&nbsp;<span class="ident" id="5509887">int64</span><span class="op" id="5509892">(</span><span class="ident" id="5509893">hdr</span><span class="op" id="5509896">.</span><span class="ident" id="5509897">Gid</span><span class="op" id="5509900">)</span><span class="op" id="5509901">,</span>&nbsp;<span class="builtintype" id="5509903">true</span><span class="op" id="5509907">,</span>&nbsp;<span class="ident" id="5509909">paxGid</span><span class="op" id="5509915">,</span>&nbsp;<span class="ident" id="5509917">paxHeaders</span><span class="op" id="5509927">)</span>&nbsp;<span class="comment" id="5509929">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509941">tw</span><span class="op" id="5509943">.</span><span class="ident" id="5509944">numeric</span><span class="op" id="5509951">(</span><span class="ident" id="5509952">s</span><span class="op" id="5509953">.</span><span class="ident" id="5509954">next</span><span class="op" id="5509958">(</span><span class="num" id="5509959">12</span><span class="op" id="5509961">)</span><span class="op" id="5509962">,</span>&nbsp;<span class="ident" id="5509964">hdr</span><span class="op" id="5509967">.</span><span class="ident" id="5509968">Size</span><span class="op" id="5509972">,</span>&nbsp;<span class="builtintype" id="5509974">true</span><span class="op" id="5509978">,</span>&nbsp;<span class="ident" id="5509980">paxSize</span><span class="op" id="5509987">,</span>&nbsp;<span class="ident" id="5509989">paxHeaders</span><span class="op" id="5509999">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510005">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510017">tw</span><span class="op" id="5510019">.</span><span class="ident" id="5510020">numeric</span><span class="op" id="5510027">(</span><span class="ident" id="5510028">s</span><span class="op" id="5510029">.</span><span class="ident" id="5510030">next</span><span class="op" id="5510034">(</span><span class="num" id="5510035">12</span><span class="op" id="5510037">)</span><span class="op" id="5510038">,</span>&nbsp;<span class="ident" id="5510040">modTime</span><span class="op" id="5510047">,</span>&nbsp;<span class="builtintype" id="5510049">false</span><span class="op" id="5510054">,</span>&nbsp;<span class="ident" id="5510056">paxNone</span><span class="op" id="5510063">,</span>&nbsp;<span class="ident" id="5510065">nil</span><span class="op" id="5510068">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510081">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510138">s</span><span class="op" id="5510139">.</span><span class="ident" id="5510140">next</span><span class="op" id="5510144">(</span><span class="num" id="5510145">8</span><span class="op" id="5510146">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510202">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510223">s</span><span class="op" id="5510224">.</span><span class="ident" id="5510225">next</span><span class="op" id="5510229">(</span><span class="num" id="5510230">1</span><span class="op" id="5510231">)</span><span class="op" id="5510232">[</span><span class="num" id="5510233">0</span><span class="op" id="5510234">]</span>&nbsp;<span class="op" id="5510236">=</span>&nbsp;<span class="ident" id="5510238">hdr</span><span class="op" id="5510241">.</span><span class="ident" id="5510242">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510287">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510300">tw</span><span class="op" id="5510302">.</span><span class="ident" id="5510303">cString</span><span class="op" id="5510310">(</span><span class="ident" id="5510311">s</span><span class="op" id="5510312">.</span><span class="ident" id="5510313">next</span><span class="op" id="5510317">(</span><span class="num" id="5510318">100</span><span class="op" id="5510321">)</span><span class="op" id="5510322">,</span>&nbsp;<span class="ident" id="5510324">hdr</span><span class="op" id="5510327">.</span><span class="ident" id="5510328">Linkname</span><span class="op" id="5510336">,</span>&nbsp;<span class="builtintype" id="5510338">true</span><span class="op" id="5510342">,</span>&nbsp;<span class="ident" id="5510344">paxLinkpath</span><span class="op" id="5510355">,</span>&nbsp;<span class="ident" id="5510357">paxHeaders</span><span class="op" id="5510367">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5510371">copy</span><span class="op" id="5510375">(</span><span class="ident" id="5510376">s</span><span class="op" id="5510377">.</span><span class="ident" id="5510378">next</span><span class="op" id="5510382">(</span><span class="num" id="5510383">8</span><span class="op" id="5510384">)</span><span class="op" id="5510385">,</span>&nbsp;<span class="op" id="5510387">[</span><span class="op" id="5510388">]</span><span class="builtintype" id="5510389">byte</span><span class="op" id="5510393">(</span><span class="string" id="5510394">&#34;ustar\x0000&#34;</span><span class="op" id="5510407">)</span><span class="op" id="5510408">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510433">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510445">tw</span><span class="op" id="5510447">.</span><span class="ident" id="5510448">cString</span><span class="op" id="5510455">(</span><span class="ident" id="5510456">s</span><span class="op" id="5510457">.</span><span class="ident" id="5510458">next</span><span class="op" id="5510462">(</span><span class="num" id="5510463">32</span><span class="op" id="5510465">)</span><span class="op" id="5510466">,</span>&nbsp;<span class="ident" id="5510468">hdr</span><span class="op" id="5510471">.</span><span class="ident" id="5510472">Uname</span><span class="op" id="5510477">,</span>&nbsp;<span class="builtintype" id="5510479">true</span><span class="op" id="5510483">,</span>&nbsp;<span class="ident" id="5510485">paxUname</span><span class="op" id="5510493">,</span>&nbsp;<span class="ident" id="5510495">paxHeaders</span><span class="op" id="5510505">)</span>&nbsp;<span class="comment" id="5510507">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510519">tw</span><span class="op" id="5510521">.</span><span class="ident" id="5510522">cString</span><span class="op" id="5510529">(</span><span class="ident" id="5510530">s</span><span class="op" id="5510531">.</span><span class="ident" id="5510532">next</span><span class="op" id="5510536">(</span><span class="num" id="5510537">32</span><span class="op" id="5510539">)</span><span class="op" id="5510540">,</span>&nbsp;<span class="ident" id="5510542">hdr</span><span class="op" id="5510545">.</span><span class="ident" id="5510546">Gname</span><span class="op" id="5510551">,</span>&nbsp;<span class="builtintype" id="5510553">true</span><span class="op" id="5510557">,</span>&nbsp;<span class="ident" id="5510559">paxGname</span><span class="op" id="5510567">,</span>&nbsp;<span class="ident" id="5510569">paxHeaders</span><span class="op" id="5510579">)</span>&nbsp;<span class="comment" id="5510581">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510593">tw</span><span class="op" id="5510595">.</span><span class="ident" id="5510596">numeric</span><span class="op" id="5510603">(</span><span class="ident" id="5510604">s</span><span class="op" id="5510605">.</span><span class="ident" id="5510606">next</span><span class="op" id="5510610">(</span><span class="num" id="5510611">8</span><span class="op" id="5510612">)</span><span class="op" id="5510613">,</span>&nbsp;<span class="ident" id="5510615">hdr</span><span class="op" id="5510618">.</span><span class="ident" id="5510619">Devmajor</span><span class="op" id="5510627">,</span>&nbsp;<span class="builtintype" id="5510629">false</span><span class="op" id="5510634">,</span>&nbsp;<span class="ident" id="5510636">paxNone</span><span class="op" id="5510643">,</span>&nbsp;<span class="ident" id="5510645">nil</span><span class="op" id="5510648">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510655">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510667">tw</span><span class="op" id="5510669">.</span><span class="ident" id="5510670">numeric</span><span class="op" id="5510677">(</span><span class="ident" id="5510678">s</span><span class="op" id="5510679">.</span><span class="ident" id="5510680">next</span><span class="op" id="5510684">(</span><span class="num" id="5510685">8</span><span class="op" id="5510686">)</span><span class="op" id="5510687">,</span>&nbsp;<span class="ident" id="5510689">hdr</span><span class="op" id="5510692">.</span><span class="ident" id="5510693">Devminor</span><span class="op" id="5510701">,</span>&nbsp;<span class="builtintype" id="5510703">false</span><span class="op" id="5510708">,</span>&nbsp;<span class="ident" id="5510710">paxNone</span><span class="op" id="5510717">,</span>&nbsp;<span class="ident" id="5510719">nil</span><span class="op" id="5510722">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510729">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5510742">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510868">prefixHeaderBytes</span>&nbsp;<span class="op" id="5510886">:=</span>&nbsp;<span class="ident" id="5510889">s</span><span class="op" id="5510890">.</span><span class="ident" id="5510891">next</span><span class="op" id="5510895">(</span><span class="num" id="5510896">155</span><span class="op" id="5510899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510902">tw</span><span class="op" id="5510904">.</span><span class="ident" id="5510905">cString</span><span class="op" id="5510912">(</span><span class="ident" id="5510913">prefixHeaderBytes</span><span class="op" id="5510930">,</span>&nbsp;<span class="string" id="5510932">&#34;&#34;</span><span class="op" id="5510934">,</span>&nbsp;<span class="builtintype" id="5510936">false</span><span class="op" id="5510941">,</span>&nbsp;<span class="ident" id="5510943">paxNone</span><span class="op" id="5510950">,</span>&nbsp;<span class="ident" id="5510952">nil</span><span class="op" id="5510955">)</span>&nbsp;<span class="comment" id="5510957">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5510978">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511054">if</span>&nbsp;<span class="ident" id="5511057">tw</span><span class="op" id="5511059">.</span><span class="ident" id="5511060">usedBinary</span>&nbsp;<span class="op" id="5511071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5511075">copy</span><span class="op" id="5511079">(</span><span class="ident" id="5511080">header</span><span class="op" id="5511086">[</span><span class="num" id="5511087">257</span><span class="op" id="5511090">:</span><span class="num" id="5511091">265</span><span class="op" id="5511094">]</span><span class="op" id="5511095">,</span>&nbsp;<span class="op" id="5511097">[</span><span class="op" id="5511098">]</span><span class="builtintype" id="5511099">byte</span><span class="op" id="5511103">(</span><span class="string" id="5511104">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="5511117">)</span><span class="op" id="5511118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511125">_</span><span class="op" id="5511126">,</span>&nbsp;<span class="ident" id="5511128">paxPathUsed</span>&nbsp;<span class="op" id="5511140">:=</span>&nbsp;<span class="ident" id="5511143">paxHeaders</span><span class="op" id="5511153">[</span><span class="ident" id="5511154">paxPath</span><span class="op" id="5511161">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511164">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511225">if</span>&nbsp;<span class="op" id="5511228">!</span><span class="ident" id="5511229">tw</span><span class="op" id="5511231">.</span><span class="ident" id="5511232">preferPax</span>&nbsp;<span class="op" id="5511242">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5511245">len</span><span class="op" id="5511248">(</span><span class="ident" id="5511249">paxHeaders</span><span class="op" id="5511259">)</span>&nbsp;<span class="op" id="5511261">==</span>&nbsp;<span class="num" id="5511264">1</span>&nbsp;<span class="op" id="5511266">&amp;&amp;</span>&nbsp;<span class="ident" id="5511269">paxPathUsed</span>&nbsp;<span class="op" id="5511281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511285">suffix</span>&nbsp;<span class="op" id="5511292">:=</span>&nbsp;<span class="ident" id="5511295">hdr</span><span class="op" id="5511298">.</span><span class="ident" id="5511299">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511306">prefix</span>&nbsp;<span class="op" id="5511313">:=</span>&nbsp;<span class="string" id="5511316">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511321">if</span>&nbsp;<span class="builtinfunc" id="5511324">len</span><span class="op" id="5511327">(</span><span class="ident" id="5511328">hdr</span><span class="op" id="5511331">.</span><span class="ident" id="5511332">Name</span><span class="op" id="5511336">)</span>&nbsp;<span class="op" id="5511338">&gt;</span>&nbsp;<span class="ident" id="5511340">fileNameSize</span>&nbsp;<span class="op" id="5511353">&amp;&amp;</span>&nbsp;<span class="ident" id="5511356">isASCII</span><span class="op" id="5511363">(</span><span class="ident" id="5511364">hdr</span><span class="op" id="5511367">.</span><span class="ident" id="5511368">Name</span><span class="op" id="5511372">)</span>&nbsp;<span class="op" id="5511374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511379">var</span>&nbsp;<span class="ident" id="5511383">err</span>&nbsp;<span class="builtintype" id="5511387">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511396">prefix</span><span class="op" id="5511402">,</span>&nbsp;<span class="ident" id="5511404">suffix</span><span class="op" id="5511410">,</span>&nbsp;<span class="ident" id="5511412">err</span>&nbsp;<span class="op" id="5511416">=</span>&nbsp;<span class="ident" id="5511418">tw</span><span class="op" id="5511420">.</span><span class="ident" id="5511421">splitUSTARLongName</span><span class="op" id="5511439">(</span><span class="ident" id="5511440">hdr</span><span class="op" id="5511443">.</span><span class="ident" id="5511444">Name</span><span class="op" id="5511448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511453">if</span>&nbsp;<span class="ident" id="5511456">err</span>&nbsp;<span class="op" id="5511460">==</span>&nbsp;<span class="ident" id="5511463">nil</span>&nbsp;<span class="op" id="5511467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511473">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511552">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5511636">delete</span><span class="op" id="5511642">(</span><span class="ident" id="5511643">paxHeaders</span><span class="op" id="5511653">,</span>&nbsp;<span class="ident" id="5511655">paxPath</span><span class="op" id="5511662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511669">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511699">tw</span><span class="op" id="5511701">.</span><span class="ident" id="5511702">cString</span><span class="op" id="5511709">(</span><span class="ident" id="5511710">pathHeaderBytes</span><span class="op" id="5511725">,</span>&nbsp;<span class="ident" id="5511727">suffix</span><span class="op" id="5511733">,</span>&nbsp;<span class="builtintype" id="5511735">false</span><span class="op" id="5511740">,</span>&nbsp;<span class="ident" id="5511742">paxNone</span><span class="op" id="5511749">,</span>&nbsp;<span class="ident" id="5511751">nil</span><span class="op" id="5511754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511760">tw</span><span class="op" id="5511762">.</span><span class="ident" id="5511763">cString</span><span class="op" id="5511770">(</span><span class="ident" id="5511771">prefixHeaderBytes</span><span class="op" id="5511788">,</span>&nbsp;<span class="ident" id="5511790">prefix</span><span class="op" id="5511796">,</span>&nbsp;<span class="builtintype" id="5511798">false</span><span class="op" id="5511803">,</span>&nbsp;<span class="ident" id="5511805">paxNone</span><span class="op" id="5511812">,</span>&nbsp;<span class="ident" id="5511814">nil</span><span class="op" id="5511817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511824">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511880">if</span>&nbsp;<span class="builtinfunc" id="5511883">len</span><span class="op" id="5511886">(</span><span class="ident" id="5511887">prefix</span><span class="op" id="5511893">)</span>&nbsp;<span class="op" id="5511895">&gt;</span>&nbsp;<span class="num" id="5511897">0</span>&nbsp;<span class="op" id="5511899">&amp;&amp;</span>&nbsp;<span class="op" id="5511902">!</span><span class="ident" id="5511903">tw</span><span class="op" id="5511905">.</span><span class="ident" id="5511906">usedBinary</span>&nbsp;<span class="op" id="5511917">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5511924">copy</span><span class="op" id="5511928">(</span><span class="ident" id="5511929">header</span><span class="op" id="5511935">[</span><span class="num" id="5511936">257</span><span class="op" id="5511939">:</span><span class="num" id="5511940">265</span><span class="op" id="5511943">]</span><span class="op" id="5511944">,</span>&nbsp;<span class="op" id="5511946">[</span><span class="op" id="5511947">]</span><span class="builtintype" id="5511948">byte</span><span class="op" id="5511952">(</span><span class="string" id="5511953">&#34;ustar\x00&#34;</span><span class="op" id="5511964">)</span><span class="op" id="5511965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511983">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511987">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512044">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512095">chksum</span><span class="op" id="5512101">,</span>&nbsp;<span class="ident" id="5512103">_</span>&nbsp;<span class="op" id="5512105">:=</span>&nbsp;<span class="ident" id="5512108">checksum</span><span class="op" id="5512116">(</span><span class="ident" id="5512117">header</span><span class="op" id="5512123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512126">tw</span><span class="op" id="5512128">.</span><span class="ident" id="5512129">octal</span><span class="op" id="5512134">(</span><span class="ident" id="5512135">header</span><span class="op" id="5512141">[</span><span class="num" id="5512142">148</span><span class="op" id="5512145">:</span><span class="num" id="5512146">155</span><span class="op" id="5512149">]</span><span class="op" id="5512150">,</span>&nbsp;<span class="ident" id="5512152">chksum</span><span class="op" id="5512158">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512161">header</span><span class="op" id="5512167">[</span><span class="num" id="5512168">155</span><span class="op" id="5512171">]</span>&nbsp;<span class="op" id="5512173">=</span>&nbsp;<span class="string" id="5512175">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512181">if</span>&nbsp;<span class="ident" id="5512184">tw</span><span class="op" id="5512186">.</span><span class="ident" id="5512187">err</span>&nbsp;<span class="op" id="5512191">!=</span>&nbsp;<span class="ident" id="5512194">nil</span>&nbsp;<span class="op" id="5512198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512202">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512266">return</span>&nbsp;<span class="ident" id="5512273">tw</span><span class="op" id="5512275">.</span><span class="ident" id="5512276">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512285">if</span>&nbsp;<span class="ident" id="5512288">allowPax</span>&nbsp;<span class="op" id="5512297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512301">for</span>&nbsp;<span class="ident" id="5512305">k</span><span class="op" id="5512306">,</span>&nbsp;<span class="ident" id="5512308">v</span>&nbsp;<span class="op" id="5512310">:=</span>&nbsp;<span class="keyword" id="5512313">range</span>&nbsp;<span class="ident" id="5512319">hdr</span><span class="op" id="5512322">.</span><span class="ident" id="5512323">Xattrs</span>&nbsp;<span class="op" id="5512330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512335">paxHeaders</span><span class="op" id="5512345">[</span><span class="ident" id="5512346">paxXattr</span><span class="op" id="5512354">+</span><span class="ident" id="5512355">k</span><span class="op" id="5512356">]</span>&nbsp;<span class="op" id="5512358">=</span>&nbsp;<span class="ident" id="5512360">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512371">if</span>&nbsp;<span class="builtinfunc" id="5512374">len</span><span class="op" id="5512377">(</span><span class="ident" id="5512378">paxHeaders</span><span class="op" id="5512388">)</span>&nbsp;<span class="op" id="5512390">&gt;</span>&nbsp;<span class="num" id="5512392">0</span>&nbsp;<span class="op" id="5512394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512398">if</span>&nbsp;<span class="op" id="5512401">!</span><span class="ident" id="5512402">allowPax</span>&nbsp;<span class="op" id="5512411">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512416">return</span>&nbsp;<span class="ident" id="5512423">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512446">if</span>&nbsp;<span class="ident" id="5512449">err</span>&nbsp;<span class="op" id="5512453">:=</span>&nbsp;<span class="ident" id="5512456">tw</span><span class="op" id="5512458">.</span><span class="ident" id="5512459">writePAXHeader</span><span class="op" id="5512473">(</span><span class="ident" id="5512474">hdr</span><span class="op" id="5512477">,</span>&nbsp;<span class="ident" id="5512479">paxHeaders</span><span class="op" id="5512489">)</span><span class="op" id="5512490">;</span>&nbsp;<span class="ident" id="5512492">err</span>&nbsp;<span class="op" id="5512496">!=</span>&nbsp;<span class="ident" id="5512499">nil</span>&nbsp;<span class="op" id="5512503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512508">return</span>&nbsp;<span class="ident" id="5512515">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512521">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512527">tw</span><span class="op" id="5512529">.</span><span class="ident" id="5512530">nb</span>&nbsp;<span class="op" id="5512533">=</span>&nbsp;<span class="ident" id="5512535">int64</span><span class="op" id="5512540">(</span><span class="ident" id="5512541">hdr</span><span class="op" id="5512544">.</span><span class="ident" id="5512545">Size</span><span class="op" id="5512549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512552">tw</span><span class="op" id="5512554">.</span><span class="ident" id="5512555">pad</span>&nbsp;<span class="op" id="5512559">=</span>&nbsp;<span class="op" id="5512561">(</span><span class="ident" id="5512562">blockSize</span>&nbsp;<span class="op" id="5512572">-</span>&nbsp;<span class="op" id="5512574">(</span><span class="ident" id="5512575">tw</span><span class="op" id="5512577">.</span><span class="ident" id="5512578">nb</span>&nbsp;<span class="op" id="5512581">%</span>&nbsp;<span class="ident" id="5512583">blockSize</span><span class="op" id="5512592">)</span><span class="op" id="5512593">)</span>&nbsp;<span class="op" id="5512595">%</span>&nbsp;<span class="ident" id="5512597">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512609">_</span><span class="op" id="5512610">,</span>&nbsp;<span class="ident" id="5512612">tw</span><span class="op" id="5512614">.</span><span class="ident" id="5512615">err</span>&nbsp;<span class="op" id="5512619">=</span>&nbsp;<span class="ident" id="5512621">tw</span><span class="op" id="5512623">.</span><span class="ident" id="5512624">w</span><span class="op" id="5512625">.</span><span class="ident" id="5512626">Write</span><span class="op" id="5512631">(</span><span class="ident" id="5512632">header</span><span class="op" id="5512638">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512641">return</span>&nbsp;<span class="ident" id="5512648">tw</span><span class="op" id="5512650">.</span><span class="ident" id="5512651">err</span><br>
<span class="lineno"></span><span class="op" id="5512655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5512658">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="5512715">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="5512776">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="5512831">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="5512862">func</span>&nbsp;<span class="op" id="5512867">(</span><span class="ident" id="5512868">tw</span>&nbsp;<span class="op" id="5512871">*</span><span class="ident" id="5512872">Writer</span><span class="op" id="5512878">)</span>&nbsp;<span class="ident" id="5512880">splitUSTARLongName</span><span class="op" id="5512898">(</span><span class="ident" id="5512899">name</span>&nbsp;<span class="builtintype" id="5512904">string</span><span class="op" id="5512910">)</span>&nbsp;<span class="op" id="5512912">(</span><span class="ident" id="5512913">prefix</span><span class="op" id="5512919">,</span>&nbsp;<span class="ident" id="5512921">suffix</span>&nbsp;<span class="builtintype" id="5512928">string</span><span class="op" id="5512934">,</span>&nbsp;<span class="ident" id="5512936">err</span>&nbsp;<span class="builtintype" id="5512940">error</span><span class="op" id="5512945">)</span>&nbsp;<span class="op" id="5512947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512950">length</span>&nbsp;<span class="op" id="5512957">:=</span>&nbsp;<span class="builtinfunc" id="5512960">len</span><span class="op" id="5512963">(</span><span class="ident" id="5512964">name</span><span class="op" id="5512968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512971">if</span>&nbsp;<span class="ident" id="5512974">length</span>&nbsp;<span class="op" id="5512981">&gt;</span>&nbsp;<span class="ident" id="5512983">fileNamePrefixSize</span><span class="op" id="5513001">+</span><span class="num" id="5513002">1</span>&nbsp;<span class="op" id="5513004">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513008">length</span>&nbsp;<span class="op" id="5513015">=</span>&nbsp;<span class="ident" id="5513017">fileNamePrefixSize</span>&nbsp;<span class="op" id="5513036">+</span>&nbsp;<span class="num" id="5513038">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513041">}</span>&nbsp;<span class="keyword" id="5513043">else</span>&nbsp;<span class="keyword" id="5513048">if</span>&nbsp;<span class="ident" id="5513051">name</span><span class="op" id="5513055">[</span><span class="ident" id="5513056">length</span><span class="op" id="5513062">-</span><span class="num" id="5513063">1</span><span class="op" id="5513064">]</span>&nbsp;<span class="op" id="5513066">==</span>&nbsp;<span class="string" id="5513069">&#39;/&#39;</span>&nbsp;<span class="op" id="5513073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513077">length</span><span class="op" id="5513083">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513090">i</span>&nbsp;<span class="op" id="5513092">:=</span>&nbsp;<span class="ident" id="5513095">strings</span><span class="op" id="5513102">.</span><span class="ident" id="5513103">LastIndex</span><span class="op" id="5513112">(</span><span class="ident" id="5513113">name</span><span class="op" id="5513117">[</span><span class="op" id="5513118">:</span><span class="ident" id="5513119">length</span><span class="op" id="5513125">]</span><span class="op" id="5513126">,</span>&nbsp;<span class="string" id="5513128">&#34;/&#34;</span><span class="op" id="5513131">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513134">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513192">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513252">nlen</span>&nbsp;<span class="op" id="5513257">:=</span>&nbsp;<span class="builtinfunc" id="5513260">len</span><span class="op" id="5513263">(</span><span class="ident" id="5513264">name</span><span class="op" id="5513268">)</span>&nbsp;<span class="op" id="5513270">-</span>&nbsp;<span class="ident" id="5513272">i</span>&nbsp;<span class="op" id="5513274">-</span>&nbsp;<span class="num" id="5513276">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513279">plen</span>&nbsp;<span class="op" id="5513284">:=</span>&nbsp;<span class="ident" id="5513287">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513290">if</span>&nbsp;<span class="ident" id="5513293">i</span>&nbsp;<span class="op" id="5513295">&lt;=</span>&nbsp;<span class="num" id="5513298">0</span>&nbsp;<span class="op" id="5513300">||</span>&nbsp;<span class="ident" id="5513303">nlen</span>&nbsp;<span class="op" id="5513308">&gt;</span>&nbsp;<span class="ident" id="5513310">fileNameSize</span>&nbsp;<span class="op" id="5513323">||</span>&nbsp;<span class="ident" id="5513326">nlen</span>&nbsp;<span class="op" id="5513331">==</span>&nbsp;<span class="num" id="5513334">0</span>&nbsp;<span class="op" id="5513336">||</span>&nbsp;<span class="ident" id="5513339">plen</span>&nbsp;<span class="op" id="5513344">&gt;</span>&nbsp;<span class="ident" id="5513346">fileNamePrefixSize</span>&nbsp;<span class="op" id="5513365">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513369">err</span>&nbsp;<span class="op" id="5513373">=</span>&nbsp;<span class="ident" id="5513375">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513392">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513403">prefix</span><span class="op" id="5513409">,</span>&nbsp;<span class="ident" id="5513411">suffix</span>&nbsp;<span class="op" id="5513418">=</span>&nbsp;<span class="ident" id="5513420">name</span><span class="op" id="5513424">[</span><span class="op" id="5513425">:</span><span class="ident" id="5513426">i</span><span class="op" id="5513427">]</span><span class="op" id="5513428">,</span>&nbsp;<span class="ident" id="5513430">name</span><span class="op" id="5513434">[</span><span class="ident" id="5513435">i</span><span class="op" id="5513436">+</span><span class="num" id="5513437">1</span><span class="op" id="5513438">:</span><span class="op" id="5513439">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513442">return</span><br>
<span class="lineno">295</span><span class="op" id="5513449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5513452">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5513507">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="5513519">func</span>&nbsp;<span class="op" id="5513524">(</span><span class="ident" id="5513525">tw</span>&nbsp;<span class="op" id="5513528">*</span><span class="ident" id="5513529">Writer</span><span class="op" id="5513535">)</span>&nbsp;<span class="ident" id="5513537">writePAXHeader</span><span class="op" id="5513551">(</span><span class="ident" id="5513552">hdr</span>&nbsp;<span class="op" id="5513556">*</span><span class="ident" id="5513557">Header</span><span class="op" id="5513563">,</span>&nbsp;<span class="ident" id="5513565">paxHeaders</span>&nbsp;<span class="keyword" id="5513576">map</span><span class="op" id="5513579">[</span><span class="builtintype" id="5513580">string</span><span class="op" id="5513586">]</span><span class="builtintype" id="5513587">string</span><span class="op" id="5513593">)</span>&nbsp;<span class="builtintype" id="5513595">error</span>&nbsp;<span class="op" id="5513601">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513604">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513632">ext</span>&nbsp;<span class="op" id="5513636">:=</span>&nbsp;<span class="builtinfunc" id="5513639">new</span><span class="op" id="5513642">(</span><span class="ident" id="5513643">Header</span><span class="op" id="5513649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513652">ext</span><span class="op" id="5513655">.</span><span class="ident" id="5513656">Typeflag</span>&nbsp;<span class="op" id="5513665">=</span>&nbsp;<span class="ident" id="5513667">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513680">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513734">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513774">ext</span><span class="op" id="5513777">.</span><span class="ident" id="5513778">ModTime</span>&nbsp;<span class="op" id="5513786">=</span>&nbsp;<span class="ident" id="5513788">hdr</span><span class="op" id="5513791">.</span><span class="ident" id="5513792">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513801">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513854">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513880">pid</span>&nbsp;<span class="op" id="5513884">:=</span>&nbsp;<span class="ident" id="5513887">os</span><span class="op" id="5513889">.</span><span class="ident" id="5513890">Getpid</span><span class="op" id="5513896">(</span><span class="op" id="5513897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513900">dir</span><span class="op" id="5513903">,</span>&nbsp;<span class="ident" id="5513905">file</span>&nbsp;<span class="op" id="5513910">:=</span>&nbsp;<span class="ident" id="5513913">path</span><span class="op" id="5513917">.</span><span class="ident" id="5513918">Split</span><span class="op" id="5513923">(</span><span class="ident" id="5513924">hdr</span><span class="op" id="5513927">.</span><span class="ident" id="5513928">Name</span><span class="op" id="5513932">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513935">fullName</span>&nbsp;<span class="op" id="5513944">:=</span>&nbsp;<span class="ident" id="5513947">path</span><span class="op" id="5513951">.</span><span class="ident" id="5513952">Join</span><span class="op" id="5513956">(</span><span class="ident" id="5513957">dir</span><span class="op" id="5513960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513964">fmt</span><span class="op" id="5513967">.</span><span class="ident" id="5513968">Sprintf</span><span class="op" id="5513975">(</span><span class="string" id="5513976">&#34;PaxHeaders.%d&#34;</span><span class="op" id="5513991">,</span>&nbsp;<span class="ident" id="5513993">pid</span><span class="op" id="5513996">)</span><span class="op" id="5513997">,</span>&nbsp;<span class="ident" id="5513999">file</span><span class="op" id="5514003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514007">ascii</span>&nbsp;<span class="op" id="5514013">:=</span>&nbsp;<span class="ident" id="5514016">toASCII</span><span class="op" id="5514023">(</span><span class="ident" id="5514024">fullName</span><span class="op" id="5514032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514035">if</span>&nbsp;<span class="builtinfunc" id="5514038">len</span><span class="op" id="5514041">(</span><span class="ident" id="5514042">ascii</span><span class="op" id="5514047">)</span>&nbsp;<span class="op" id="5514049">&gt;</span>&nbsp;<span class="num" id="5514051">100</span>&nbsp;<span class="op" id="5514055">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514059">ascii</span>&nbsp;<span class="op" id="5514065">=</span>&nbsp;<span class="ident" id="5514067">ascii</span><span class="op" id="5514072">[</span><span class="op" id="5514073">:</span><span class="num" id="5514074">100</span><span class="op" id="5514077">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514083">ext</span><span class="op" id="5514086">.</span><span class="ident" id="5514087">Name</span>&nbsp;<span class="op" id="5514092">=</span>&nbsp;<span class="ident" id="5514094">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5514101">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514124">var</span>&nbsp;<span class="ident" id="5514128">buf</span>&nbsp;<span class="ident" id="5514132">bytes</span><span class="op" id="5514137">.</span><span class="ident" id="5514138">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514147">for</span>&nbsp;<span class="ident" id="5514151">k</span><span class="op" id="5514152">,</span>&nbsp;<span class="ident" id="5514154">v</span>&nbsp;<span class="op" id="5514156">:=</span>&nbsp;<span class="keyword" id="5514159">range</span>&nbsp;<span class="ident" id="5514165">paxHeaders</span>&nbsp;<span class="op" id="5514176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514180">fmt</span><span class="op" id="5514183">.</span><span class="ident" id="5514184">Fprint</span><span class="op" id="5514190">(</span><span class="op" id="5514191">&amp;</span><span class="ident" id="5514192">buf</span><span class="op" id="5514195">,</span>&nbsp;<span class="ident" id="5514197">paxHeader</span><span class="op" id="5514206">(</span><span class="ident" id="5514207">k</span><span class="op" id="5514208">+</span><span class="string" id="5514209">&#34;=&#34;</span><span class="op" id="5514212">+</span><span class="ident" id="5514213">v</span><span class="op" id="5514214">)</span><span class="op" id="5514215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514222">ext</span><span class="op" id="5514225">.</span><span class="ident" id="5514226">Size</span>&nbsp;<span class="op" id="5514231">=</span>&nbsp;<span class="ident" id="5514233">int64</span><span class="op" id="5514238">(</span><span class="builtinfunc" id="5514239">len</span><span class="op" id="5514242">(</span><span class="ident" id="5514243">buf</span><span class="op" id="5514246">.</span><span class="ident" id="5514247">Bytes</span><span class="op" id="5514252">(</span><span class="op" id="5514253">)</span><span class="op" id="5514254">)</span><span class="op" id="5514255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514258">if</span>&nbsp;<span class="ident" id="5514261">err</span>&nbsp;<span class="op" id="5514265">:=</span>&nbsp;<span class="ident" id="5514268">tw</span><span class="op" id="5514270">.</span><span class="ident" id="5514271">writeHeader</span><span class="op" id="5514282">(</span><span class="ident" id="5514283">ext</span><span class="op" id="5514286">,</span>&nbsp;<span class="builtintype" id="5514288">false</span><span class="op" id="5514293">)</span><span class="op" id="5514294">;</span>&nbsp;<span class="ident" id="5514296">err</span>&nbsp;<span class="op" id="5514300">!=</span>&nbsp;<span class="ident" id="5514303">nil</span>&nbsp;<span class="op" id="5514307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514311">return</span>&nbsp;<span class="ident" id="5514318">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514326">if</span>&nbsp;<span class="ident" id="5514329">_</span><span class="op" id="5514330">,</span>&nbsp;<span class="ident" id="5514332">err</span>&nbsp;<span class="op" id="5514336">:=</span>&nbsp;<span class="ident" id="5514339">tw</span><span class="op" id="5514341">.</span><span class="ident" id="5514342">Write</span><span class="op" id="5514347">(</span><span class="ident" id="5514348">buf</span><span class="op" id="5514351">.</span><span class="ident" id="5514352">Bytes</span><span class="op" id="5514357">(</span><span class="op" id="5514358">)</span><span class="op" id="5514359">)</span><span class="op" id="5514360">;</span>&nbsp;<span class="ident" id="5514362">err</span>&nbsp;<span class="op" id="5514366">!=</span>&nbsp;<span class="ident" id="5514369">nil</span>&nbsp;<span class="op" id="5514373">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514377">return</span>&nbsp;<span class="ident" id="5514384">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514392">if</span>&nbsp;<span class="ident" id="5514395">err</span>&nbsp;<span class="op" id="5514399">:=</span>&nbsp;<span class="ident" id="5514402">tw</span><span class="op" id="5514404">.</span><span class="ident" id="5514405">Flush</span><span class="op" id="5514410">(</span><span class="op" id="5514411">)</span><span class="op" id="5514412">;</span>&nbsp;<span class="ident" id="5514414">err</span>&nbsp;<span class="op" id="5514418">!=</span>&nbsp;<span class="ident" id="5514421">nil</span>&nbsp;<span class="op" id="5514425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514429">return</span>&nbsp;<span class="ident" id="5514436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514441">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514444">return</span>&nbsp;<span class="ident" id="5514451">nil</span><br>
<span class="lineno"></span><span class="op" id="5514455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5514458">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="5514541">func</span>&nbsp;<span class="ident" id="5514546">paxHeader</span><span class="op" id="5514555">(</span><span class="ident" id="5514556">msg</span>&nbsp;<span class="builtintype" id="5514560">string</span><span class="op" id="5514566">)</span>&nbsp;<span class="builtintype" id="5514568">string</span>&nbsp;<span class="op" id="5514575">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514578">const</span>&nbsp;<span class="ident" id="5514584">padding</span>&nbsp;<span class="op" id="5514592">=</span>&nbsp;<span class="num" id="5514594">2</span>&nbsp;<span class="comment" id="5514596">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514636">size</span>&nbsp;<span class="op" id="5514641">:=</span>&nbsp;<span class="builtinfunc" id="5514644">len</span><span class="op" id="5514647">(</span><span class="ident" id="5514648">msg</span><span class="op" id="5514651">)</span>&nbsp;<span class="op" id="5514653">+</span>&nbsp;<span class="ident" id="5514655">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514664">size</span>&nbsp;<span class="op" id="5514669">+=</span>&nbsp;<span class="builtinfunc" id="5514672">len</span><span class="op" id="5514675">(</span><span class="ident" id="5514676">strconv</span><span class="op" id="5514683">.</span><span class="ident" id="5514684">Itoa</span><span class="op" id="5514688">(</span><span class="ident" id="5514689">size</span><span class="op" id="5514693">)</span><span class="op" id="5514694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514697">record</span>&nbsp;<span class="op" id="5514704">:=</span>&nbsp;<span class="ident" id="5514707">fmt</span><span class="op" id="5514710">.</span><span class="ident" id="5514711">Sprintf</span><span class="op" id="5514718">(</span><span class="string" id="5514719">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5514728">,</span>&nbsp;<span class="ident" id="5514730">size</span><span class="op" id="5514734">,</span>&nbsp;<span class="ident" id="5514736">msg</span><span class="op" id="5514739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514742">if</span>&nbsp;<span class="builtinfunc" id="5514745">len</span><span class="op" id="5514748">(</span><span class="ident" id="5514749">record</span><span class="op" id="5514755">)</span>&nbsp;<span class="op" id="5514757">!=</span>&nbsp;<span class="ident" id="5514760">size</span>&nbsp;<span class="op" id="5514765">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5514769">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5514816">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514850">size</span>&nbsp;<span class="op" id="5514855">=</span>&nbsp;<span class="builtinfunc" id="5514857">len</span><span class="op" id="5514860">(</span><span class="ident" id="5514861">record</span><span class="op" id="5514867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5514871">record</span>&nbsp;<span class="op" id="5514878">=</span>&nbsp;<span class="ident" id="5514880">fmt</span><span class="op" id="5514883">.</span><span class="ident" id="5514884">Sprintf</span><span class="op" id="5514891">(</span><span class="string" id="5514892">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5514901">,</span>&nbsp;<span class="ident" id="5514903">size</span><span class="op" id="5514907">,</span>&nbsp;<span class="ident" id="5514909">msg</span><span class="op" id="5514912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5514915">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5514918">return</span>&nbsp;<span class="ident" id="5514925">record</span><br>
<span class="lineno"></span><span class="op" id="5514932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5514935">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="5514992">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="5515048">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="5515097">func</span>&nbsp;<span class="op" id="5515102">(</span><span class="ident" id="5515103">tw</span>&nbsp;<span class="op" id="5515106">*</span><span class="ident" id="5515107">Writer</span><span class="op" id="5515113">)</span>&nbsp;<span class="ident" id="5515115">Write</span><span class="op" id="5515120">(</span><span class="ident" id="5515121">b</span>&nbsp;<span class="op" id="5515123">[</span><span class="op" id="5515124">]</span><span class="builtintype" id="5515125">byte</span><span class="op" id="5515129">)</span>&nbsp;<span class="op" id="5515131">(</span><span class="ident" id="5515132">n</span>&nbsp;<span class="builtintype" id="5515134">int</span><span class="op" id="5515137">,</span>&nbsp;<span class="ident" id="5515139">err</span>&nbsp;<span class="builtintype" id="5515143">error</span><span class="op" id="5515148">)</span>&nbsp;<span class="op" id="5515150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515153">if</span>&nbsp;<span class="ident" id="5515156">tw</span><span class="op" id="5515158">.</span><span class="ident" id="5515159">closed</span>&nbsp;<span class="op" id="5515166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515170">err</span>&nbsp;<span class="op" id="5515174">=</span>&nbsp;<span class="ident" id="5515176">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515194">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515205">overwrite</span>&nbsp;<span class="op" id="5515215">:=</span>&nbsp;<span class="builtintype" id="5515218">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515225">if</span>&nbsp;<span class="ident" id="5515228">int64</span><span class="op" id="5515233">(</span><span class="builtinfunc" id="5515234">len</span><span class="op" id="5515237">(</span><span class="ident" id="5515238">b</span><span class="op" id="5515239">)</span><span class="op" id="5515240">)</span>&nbsp;<span class="op" id="5515242">&gt;</span>&nbsp;<span class="ident" id="5515244">tw</span><span class="op" id="5515246">.</span><span class="ident" id="5515247">nb</span>&nbsp;<span class="op" id="5515250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515254">b</span>&nbsp;<span class="op" id="5515256">=</span>&nbsp;<span class="ident" id="5515258">b</span><span class="op" id="5515259">[</span><span class="num" id="5515260">0</span><span class="op" id="5515261">:</span><span class="ident" id="5515262">tw</span><span class="op" id="5515264">.</span><span class="ident" id="5515265">nb</span><span class="op" id="5515267">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515271">overwrite</span>&nbsp;<span class="op" id="5515281">=</span>&nbsp;<span class="builtintype" id="5515283">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515292">n</span><span class="op" id="5515293">,</span>&nbsp;<span class="ident" id="5515295">err</span>&nbsp;<span class="op" id="5515299">=</span>&nbsp;<span class="ident" id="5515301">tw</span><span class="op" id="5515303">.</span><span class="ident" id="5515304">w</span><span class="op" id="5515305">.</span><span class="ident" id="5515306">Write</span><span class="op" id="5515311">(</span><span class="ident" id="5515312">b</span><span class="op" id="5515313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515316">tw</span><span class="op" id="5515318">.</span><span class="ident" id="5515319">nb</span>&nbsp;<span class="op" id="5515322">-=</span>&nbsp;<span class="ident" id="5515325">int64</span><span class="op" id="5515330">(</span><span class="ident" id="5515331">n</span><span class="op" id="5515332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515335">if</span>&nbsp;<span class="ident" id="5515338">err</span>&nbsp;<span class="op" id="5515342">==</span>&nbsp;<span class="ident" id="5515345">nil</span>&nbsp;<span class="op" id="5515349">&amp;&amp;</span>&nbsp;<span class="ident" id="5515352">overwrite</span>&nbsp;<span class="op" id="5515362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515366">err</span>&nbsp;<span class="op" id="5515370">=</span>&nbsp;<span class="ident" id="5515372">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515390">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515401">tw</span><span class="op" id="5515403">.</span><span class="ident" id="5515404">err</span>&nbsp;<span class="op" id="5515408">=</span>&nbsp;<span class="ident" id="5515410">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515415">return</span><br>
<span class="lineno"></span><span class="op" id="5515422">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="5515425">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="5515481">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5515515">func</span>&nbsp;<span class="op" id="5515520">(</span><span class="ident" id="5515521">tw</span>&nbsp;<span class="op" id="5515524">*</span><span class="ident" id="5515525">Writer</span><span class="op" id="5515531">)</span>&nbsp;<span class="ident" id="5515533">Close</span><span class="op" id="5515538">(</span><span class="op" id="5515539">)</span>&nbsp;<span class="builtintype" id="5515541">error</span>&nbsp;<span class="op" id="5515547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515550">if</span>&nbsp;<span class="ident" id="5515553">tw</span><span class="op" id="5515555">.</span><span class="ident" id="5515556">err</span>&nbsp;<span class="op" id="5515560">!=</span>&nbsp;<span class="ident" id="5515563">nil</span>&nbsp;<span class="op" id="5515567">||</span>&nbsp;<span class="ident" id="5515570">tw</span><span class="op" id="5515572">.</span><span class="ident" id="5515573">closed</span>&nbsp;<span class="op" id="5515580">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515584">return</span>&nbsp;<span class="ident" id="5515591">tw</span><span class="op" id="5515593">.</span><span class="ident" id="5515594">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515602">tw</span><span class="op" id="5515604">.</span><span class="ident" id="5515605">Flush</span><span class="op" id="5515610">(</span><span class="op" id="5515611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515614">tw</span><span class="op" id="5515616">.</span><span class="ident" id="5515617">closed</span>&nbsp;<span class="op" id="5515624">=</span>&nbsp;<span class="builtintype" id="5515626">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515632">if</span>&nbsp;<span class="ident" id="5515635">tw</span><span class="op" id="5515637">.</span><span class="ident" id="5515638">err</span>&nbsp;<span class="op" id="5515642">!=</span>&nbsp;<span class="ident" id="5515645">nil</span>&nbsp;<span class="op" id="5515649">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515653">return</span>&nbsp;<span class="ident" id="5515660">tw</span><span class="op" id="5515662">.</span><span class="ident" id="5515663">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5515672">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515701">for</span>&nbsp;<span class="ident" id="5515705">i</span>&nbsp;<span class="op" id="5515707">:=</span>&nbsp;<span class="num" id="5515710">0</span><span class="op" id="5515711">;</span>&nbsp;<span class="ident" id="5515713">i</span>&nbsp;<span class="op" id="5515715">&lt;</span>&nbsp;<span class="num" id="5515717">2</span><span class="op" id="5515718">;</span>&nbsp;<span class="ident" id="5515720">i</span><span class="op" id="5515721">++</span>&nbsp;<span class="op" id="5515724">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5515728">_</span><span class="op" id="5515729">,</span>&nbsp;<span class="ident" id="5515731">tw</span><span class="op" id="5515733">.</span><span class="ident" id="5515734">err</span>&nbsp;<span class="op" id="5515738">=</span>&nbsp;<span class="ident" id="5515740">tw</span><span class="op" id="5515742">.</span><span class="ident" id="5515743">w</span><span class="op" id="5515744">.</span><span class="ident" id="5515745">Write</span><span class="op" id="5515750">(</span><span class="ident" id="5515751">zeroBlock</span><span class="op" id="5515760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515764">if</span>&nbsp;<span class="ident" id="5515767">tw</span><span class="op" id="5515769">.</span><span class="ident" id="5515770">err</span>&nbsp;<span class="op" id="5515774">!=</span>&nbsp;<span class="ident" id="5515777">nil</span>&nbsp;<span class="op" id="5515781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515786">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5515797">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5515800">return</span>&nbsp;<span class="ident" id="5515807">tw</span><span class="op" id="5515809">.</span><span class="ident" id="5515810">err</span><br>
<span class="lineno"></span><span class="op" id="5515814">}</span>
</div>
</body>
</html>
