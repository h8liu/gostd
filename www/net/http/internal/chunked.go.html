<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4279062">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4279117">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4279171">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4279222">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4279284">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4279351">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4279373">package</span>&nbsp;<span class="ident" id="4279381">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4279391">import</span>&nbsp;<span class="op" id="4279398">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4279401">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4279410">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4279419">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4279429">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4279436">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4279441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4279444">const</span>&nbsp;<span class="ident" id="4279450">maxLineLength</span>&nbsp;<span class="op" id="4279464">=</span>&nbsp;<span class="num" id="4279466">4096</span>&nbsp;<span class="comment" id="4279471">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4279507">var</span>&nbsp;<span class="ident" id="4279511">ErrLineTooLong</span>&nbsp;<span class="op" id="4279526">=</span>&nbsp;<span class="ident" id="4279528">errors</span><span class="op" id="4279534">.</span><span class="ident" id="4279535">New</span><span class="op" id="4279538">(</span><span class="string" id="4279539">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4279561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4279564">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4279649">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4279702">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4279777">//</span><br>
<span class="lineno"></span><span class="comment" id="4279780">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4279855">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4279919">func</span>&nbsp;<span class="ident" id="4279924">NewChunkedReader</span><span class="op" id="4279940">(</span><span class="ident" id="4279941">r</span>&nbsp;<span class="ident" id="4279943">io</span><span class="op" id="4279945">.</span><span class="ident" id="4279946">Reader</span><span class="op" id="4279952">)</span>&nbsp;<span class="ident" id="4279954">io</span><span class="op" id="4279956">.</span><span class="ident" id="4279957">Reader</span>&nbsp;<span class="op" id="4279964">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4279967">br</span><span class="op" id="4279969">,</span>&nbsp;<span class="ident" id="4279971">ok</span>&nbsp;<span class="op" id="4279974">:=</span>&nbsp;<span class="ident" id="4279977">r</span><span class="op" id="4279978">.</span><span class="op" id="4279979">(</span><span class="op" id="4279980">*</span><span class="ident" id="4279981">bufio</span><span class="op" id="4279986">.</span><span class="ident" id="4279987">Reader</span><span class="op" id="4279993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4279996">if</span>&nbsp;<span class="op" id="4279999">!</span><span class="ident" id="4280000">ok</span>&nbsp;<span class="op" id="4280003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280007">br</span>&nbsp;<span class="op" id="4280010">=</span>&nbsp;<span class="ident" id="4280012">bufio</span><span class="op" id="4280017">.</span><span class="ident" id="4280018">NewReader</span><span class="op" id="4280027">(</span><span class="ident" id="4280028">r</span><span class="op" id="4280029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280035">return</span>&nbsp;<span class="op" id="4280042">&amp;</span><span class="ident" id="4280043">chunkedReader</span><span class="op" id="4280056">{</span><span class="ident" id="4280057">r</span><span class="op" id="4280058">:</span>&nbsp;<span class="ident" id="4280060">br</span><span class="op" id="4280062">}</span><br>
<span class="lineno">35</span><span class="op" id="4280064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4280067">type</span>&nbsp;<span class="ident" id="4280072">chunkedReader</span>&nbsp;<span class="keyword" id="4280086">struct</span>&nbsp;<span class="op" id="4280093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280096">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4280100">*</span><span class="ident" id="4280101">bufio</span><span class="op" id="4280106">.</span><span class="ident" id="4280107">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280115">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4280119">uint64</span>&nbsp;<span class="comment" id="4280126">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280152">err</span>&nbsp;<span class="builtintype" id="4280156">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280163">buf</span>&nbsp;<span class="op" id="4280167">[</span><span class="num" id="4280168">2</span><span class="op" id="4280169">]</span><span class="builtintype" id="4280170">byte</span><br>
<span class="lineno"></span><span class="op" id="4280175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4280178">func</span>&nbsp;<span class="op" id="4280183">(</span><span class="ident" id="4280184">cr</span>&nbsp;<span class="op" id="4280187">*</span><span class="ident" id="4280188">chunkedReader</span><span class="op" id="4280201">)</span>&nbsp;<span class="ident" id="4280203">beginChunk</span><span class="op" id="4280213">(</span><span class="op" id="4280214">)</span>&nbsp;<span class="op" id="4280216">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4280219">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280239">var</span>&nbsp;<span class="ident" id="4280243">line</span>&nbsp;<span class="op" id="4280248">[</span><span class="op" id="4280249">]</span><span class="builtintype" id="4280250">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280256">line</span><span class="op" id="4280260">,</span>&nbsp;<span class="ident" id="4280262">cr</span><span class="op" id="4280264">.</span><span class="ident" id="4280265">err</span>&nbsp;<span class="op" id="4280269">=</span>&nbsp;<span class="ident" id="4280271">readLine</span><span class="op" id="4280279">(</span><span class="ident" id="4280280">cr</span><span class="op" id="4280282">.</span><span class="ident" id="4280283">r</span><span class="op" id="4280284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280287">if</span>&nbsp;<span class="ident" id="4280290">cr</span><span class="op" id="4280292">.</span><span class="ident" id="4280293">err</span>&nbsp;<span class="op" id="4280297">!=</span>&nbsp;<span class="ident" id="4280300">nil</span>&nbsp;<span class="op" id="4280304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280308">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280319">cr</span><span class="op" id="4280321">.</span><span class="ident" id="4280322">n</span><span class="op" id="4280323">,</span>&nbsp;<span class="ident" id="4280325">cr</span><span class="op" id="4280327">.</span><span class="ident" id="4280328">err</span>&nbsp;<span class="op" id="4280332">=</span>&nbsp;<span class="ident" id="4280334">parseHexUint</span><span class="op" id="4280346">(</span><span class="ident" id="4280347">line</span><span class="op" id="4280351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280354">if</span>&nbsp;<span class="ident" id="4280357">cr</span><span class="op" id="4280359">.</span><span class="ident" id="4280360">err</span>&nbsp;<span class="op" id="4280364">!=</span>&nbsp;<span class="ident" id="4280367">nil</span>&nbsp;<span class="op" id="4280371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280375">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280383">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280386">if</span>&nbsp;<span class="ident" id="4280389">cr</span><span class="op" id="4280391">.</span><span class="ident" id="4280392">n</span>&nbsp;<span class="op" id="4280394">==</span>&nbsp;<span class="num" id="4280397">0</span>&nbsp;<span class="op" id="4280399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280403">cr</span><span class="op" id="4280405">.</span><span class="ident" id="4280406">err</span>&nbsp;<span class="op" id="4280410">=</span>&nbsp;<span class="ident" id="4280412">io</span><span class="op" id="4280414">.</span><span class="ident" id="4280415">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280420">}</span><br>
<span class="lineno"></span><span class="op" id="4280422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4280425">func</span>&nbsp;<span class="op" id="4280430">(</span><span class="ident" id="4280431">cr</span>&nbsp;<span class="op" id="4280434">*</span><span class="ident" id="4280435">chunkedReader</span><span class="op" id="4280448">)</span>&nbsp;<span class="ident" id="4280450">chunkHeaderAvailable</span><span class="op" id="4280470">(</span><span class="op" id="4280471">)</span>&nbsp;<span class="builtintype" id="4280473">bool</span>&nbsp;<span class="op" id="4280478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280481">n</span>&nbsp;<span class="op" id="4280483">:=</span>&nbsp;<span class="ident" id="4280486">cr</span><span class="op" id="4280488">.</span><span class="ident" id="4280489">r</span><span class="op" id="4280490">.</span><span class="ident" id="4280491">Buffered</span><span class="op" id="4280499">(</span><span class="op" id="4280500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280503">if</span>&nbsp;<span class="ident" id="4280506">n</span>&nbsp;<span class="op" id="4280508">&gt;</span>&nbsp;<span class="num" id="4280510">0</span>&nbsp;<span class="op" id="4280512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280516">peek</span><span class="op" id="4280520">,</span>&nbsp;<span class="ident" id="4280522">_</span>&nbsp;<span class="op" id="4280524">:=</span>&nbsp;<span class="ident" id="4280527">cr</span><span class="op" id="4280529">.</span><span class="ident" id="4280530">r</span><span class="op" id="4280531">.</span><span class="ident" id="4280532">Peek</span><span class="op" id="4280536">(</span><span class="ident" id="4280537">n</span><span class="op" id="4280538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280542">return</span>&nbsp;<span class="ident" id="4280549">bytes</span><span class="op" id="4280554">.</span><span class="ident" id="4280555">IndexByte</span><span class="op" id="4280564">(</span><span class="ident" id="4280565">peek</span><span class="op" id="4280569">,</span>&nbsp;<span class="string" id="4280571">&#39;\n&#39;</span><span class="op" id="4280575">)</span>&nbsp;<span class="op" id="4280577">&gt;=</span>&nbsp;<span class="num" id="4280580">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280586">return</span>&nbsp;<span class="ident" id="4280593">false</span><br>
<span class="lineno"></span><span class="op" id="4280599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4280602">func</span>&nbsp;<span class="op" id="4280607">(</span><span class="ident" id="4280608">cr</span>&nbsp;<span class="op" id="4280611">*</span><span class="ident" id="4280612">chunkedReader</span><span class="op" id="4280625">)</span>&nbsp;<span class="ident" id="4280627">Read</span><span class="op" id="4280631">(</span><span class="ident" id="4280632">b</span>&nbsp;<span class="op" id="4280634">[</span><span class="op" id="4280635">]</span><span class="builtintype" id="4280636">uint8</span><span class="op" id="4280641">)</span>&nbsp;<span class="op" id="4280643">(</span><span class="ident" id="4280644">n</span>&nbsp;<span class="builtintype" id="4280646">int</span><span class="op" id="4280649">,</span>&nbsp;<span class="ident" id="4280651">err</span>&nbsp;<span class="builtintype" id="4280655">error</span><span class="op" id="4280660">)</span>&nbsp;<span class="op" id="4280662">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280665">for</span>&nbsp;<span class="ident" id="4280669">cr</span><span class="op" id="4280671">.</span><span class="ident" id="4280672">err</span>&nbsp;<span class="op" id="4280676">==</span>&nbsp;<span class="ident" id="4280679">nil</span>&nbsp;<span class="op" id="4280683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280687">if</span>&nbsp;<span class="ident" id="4280690">cr</span><span class="op" id="4280692">.</span><span class="ident" id="4280693">n</span>&nbsp;<span class="op" id="4280695">==</span>&nbsp;<span class="num" id="4280698">0</span>&nbsp;<span class="op" id="4280700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280705">if</span>&nbsp;<span class="ident" id="4280708">n</span>&nbsp;<span class="op" id="4280710">&gt;</span>&nbsp;<span class="num" id="4280712">0</span>&nbsp;<span class="op" id="4280714">&amp;&amp;</span>&nbsp;<span class="op" id="4280717">!</span><span class="ident" id="4280718">cr</span><span class="op" id="4280720">.</span><span class="ident" id="4280721">chunkHeaderAvailable</span><span class="op" id="4280741">(</span><span class="op" id="4280742">)</span>&nbsp;<span class="op" id="4280744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4280750">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4280800">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280835">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280849">cr</span><span class="op" id="4280851">.</span><span class="ident" id="4280852">beginChunk</span><span class="op" id="4280862">(</span><span class="op" id="4280863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280868">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280879">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280883">if</span>&nbsp;<span class="builtinfunc" id="4280886">len</span><span class="op" id="4280889">(</span><span class="ident" id="4280890">b</span><span class="op" id="4280891">)</span>&nbsp;<span class="op" id="4280893">==</span>&nbsp;<span class="num" id="4280896">0</span>&nbsp;<span class="op" id="4280898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280903">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280915">rbuf</span>&nbsp;<span class="op" id="4280920">:=</span>&nbsp;<span class="ident" id="4280923">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280927">if</span>&nbsp;<span class="ident" id="4280930">uint64</span><span class="op" id="4280936">(</span><span class="builtinfunc" id="4280937">len</span><span class="op" id="4280940">(</span><span class="ident" id="4280941">rbuf</span><span class="op" id="4280945">)</span><span class="op" id="4280946">)</span>&nbsp;<span class="op" id="4280948">&gt;</span>&nbsp;<span class="ident" id="4280950">cr</span><span class="op" id="4280952">.</span><span class="ident" id="4280953">n</span>&nbsp;<span class="op" id="4280955">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280960">rbuf</span>&nbsp;<span class="op" id="4280965">=</span>&nbsp;<span class="ident" id="4280967">rbuf</span><span class="op" id="4280971">[</span><span class="op" id="4280972">:</span><span class="ident" id="4280973">cr</span><span class="op" id="4280975">.</span><span class="ident" id="4280976">n</span><span class="op" id="4280977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4280981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4280985">var</span>&nbsp;<span class="ident" id="4280989">n0</span>&nbsp;<span class="builtintype" id="4280992">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4280998">n0</span><span class="op" id="4281000">,</span>&nbsp;<span class="ident" id="4281002">cr</span><span class="op" id="4281004">.</span><span class="ident" id="4281005">err</span>&nbsp;<span class="op" id="4281009">=</span>&nbsp;<span class="ident" id="4281011">cr</span><span class="op" id="4281013">.</span><span class="ident" id="4281014">r</span><span class="op" id="4281015">.</span><span class="ident" id="4281016">Read</span><span class="op" id="4281020">(</span><span class="ident" id="4281021">rbuf</span><span class="op" id="4281025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281029">n</span>&nbsp;<span class="op" id="4281031">+=</span>&nbsp;<span class="ident" id="4281034">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281039">b</span>&nbsp;<span class="op" id="4281041">=</span>&nbsp;<span class="ident" id="4281043">b</span><span class="op" id="4281044">[</span><span class="ident" id="4281045">n0</span><span class="op" id="4281047">:</span><span class="op" id="4281048">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281052">cr</span><span class="op" id="4281054">.</span><span class="ident" id="4281055">n</span>&nbsp;<span class="op" id="4281057">-=</span>&nbsp;<span class="ident" id="4281060">uint64</span><span class="op" id="4281066">(</span><span class="ident" id="4281067">n0</span><span class="op" id="4281069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4281073">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4281128">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281166">if</span>&nbsp;<span class="ident" id="4281169">cr</span><span class="op" id="4281171">.</span><span class="ident" id="4281172">n</span>&nbsp;<span class="op" id="4281174">==</span>&nbsp;<span class="num" id="4281177">0</span>&nbsp;<span class="op" id="4281179">&amp;&amp;</span>&nbsp;<span class="ident" id="4281182">cr</span><span class="op" id="4281184">.</span><span class="ident" id="4281185">err</span>&nbsp;<span class="op" id="4281189">==</span>&nbsp;<span class="ident" id="4281192">nil</span>&nbsp;<span class="op" id="4281196">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281201">if</span>&nbsp;<span class="ident" id="4281204">_</span><span class="op" id="4281205">,</span>&nbsp;<span class="ident" id="4281207">cr</span><span class="op" id="4281209">.</span><span class="ident" id="4281210">err</span>&nbsp;<span class="op" id="4281214">=</span>&nbsp;<span class="ident" id="4281216">io</span><span class="op" id="4281218">.</span><span class="ident" id="4281219">ReadFull</span><span class="op" id="4281227">(</span><span class="ident" id="4281228">cr</span><span class="op" id="4281230">.</span><span class="ident" id="4281231">r</span><span class="op" id="4281232">,</span>&nbsp;<span class="ident" id="4281234">cr</span><span class="op" id="4281236">.</span><span class="ident" id="4281237">buf</span><span class="op" id="4281240">[</span><span class="op" id="4281241">:</span><span class="num" id="4281242">2</span><span class="op" id="4281243">]</span><span class="op" id="4281244">)</span><span class="op" id="4281245">;</span>&nbsp;<span class="ident" id="4281247">cr</span><span class="op" id="4281249">.</span><span class="ident" id="4281250">err</span>&nbsp;<span class="op" id="4281254">==</span>&nbsp;<span class="ident" id="4281257">nil</span>&nbsp;<span class="op" id="4281261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281267">if</span>&nbsp;<span class="ident" id="4281270">cr</span><span class="op" id="4281272">.</span><span class="ident" id="4281273">buf</span><span class="op" id="4281276">[</span><span class="num" id="4281277">0</span><span class="op" id="4281278">]</span>&nbsp;<span class="op" id="4281280">!=</span>&nbsp;<span class="string" id="4281283">&#39;\r&#39;</span>&nbsp;<span class="op" id="4281288">||</span>&nbsp;<span class="ident" id="4281291">cr</span><span class="op" id="4281293">.</span><span class="ident" id="4281294">buf</span><span class="op" id="4281297">[</span><span class="num" id="4281298">1</span><span class="op" id="4281299">]</span>&nbsp;<span class="op" id="4281301">!=</span>&nbsp;<span class="string" id="4281304">&#39;\n&#39;</span>&nbsp;<span class="op" id="4281309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281316">cr</span><span class="op" id="4281318">.</span><span class="ident" id="4281319">err</span>&nbsp;<span class="op" id="4281323">=</span>&nbsp;<span class="ident" id="4281325">errors</span><span class="op" id="4281331">.</span><span class="ident" id="4281332">New</span><span class="op" id="4281335">(</span><span class="string" id="4281336">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4281364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281375">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281385">return</span>&nbsp;<span class="ident" id="4281392">n</span><span class="op" id="4281393">,</span>&nbsp;<span class="ident" id="4281395">cr</span><span class="op" id="4281397">.</span><span class="ident" id="4281398">err</span><br>
<span class="lineno"></span><span class="op" id="4281402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4281405">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4281448">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4281494">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4281546">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4281610">func</span>&nbsp;<span class="ident" id="4281615">readLine</span><span class="op" id="4281623">(</span><span class="ident" id="4281624">b</span>&nbsp;<span class="op" id="4281626">*</span><span class="ident" id="4281627">bufio</span><span class="op" id="4281632">.</span><span class="ident" id="4281633">Reader</span><span class="op" id="4281639">)</span>&nbsp;<span class="op" id="4281641">(</span><span class="ident" id="4281642">p</span>&nbsp;<span class="op" id="4281644">[</span><span class="op" id="4281645">]</span><span class="builtintype" id="4281646">byte</span><span class="op" id="4281650">,</span>&nbsp;<span class="ident" id="4281652">err</span>&nbsp;<span class="builtintype" id="4281656">error</span><span class="op" id="4281661">)</span>&nbsp;<span class="op" id="4281663">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281666">if</span>&nbsp;<span class="ident" id="4281669">p</span><span class="op" id="4281670">,</span>&nbsp;<span class="ident" id="4281672">err</span>&nbsp;<span class="op" id="4281676">=</span>&nbsp;<span class="ident" id="4281678">b</span><span class="op" id="4281679">.</span><span class="ident" id="4281680">ReadSlice</span><span class="op" id="4281689">(</span><span class="string" id="4281690">&#39;\n&#39;</span><span class="op" id="4281694">)</span><span class="op" id="4281695">;</span>&nbsp;<span class="ident" id="4281697">err</span>&nbsp;<span class="op" id="4281701">!=</span>&nbsp;<span class="ident" id="4281704">nil</span>&nbsp;<span class="op" id="4281708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4281712">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4281752">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281813">if</span>&nbsp;<span class="ident" id="4281816">err</span>&nbsp;<span class="op" id="4281820">==</span>&nbsp;<span class="ident" id="4281823">io</span><span class="op" id="4281825">.</span><span class="ident" id="4281826">EOF</span>&nbsp;<span class="op" id="4281830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281835">err</span>&nbsp;<span class="op" id="4281839">=</span>&nbsp;<span class="ident" id="4281841">io</span><span class="op" id="4281843">.</span><span class="ident" id="4281844">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281863">}</span>&nbsp;<span class="keyword" id="4281865">else</span>&nbsp;<span class="keyword" id="4281870">if</span>&nbsp;<span class="ident" id="4281873">err</span>&nbsp;<span class="op" id="4281877">==</span>&nbsp;<span class="ident" id="4281880">bufio</span><span class="op" id="4281885">.</span><span class="ident" id="4281886">ErrBufferFull</span>&nbsp;<span class="op" id="4281900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4281905">err</span>&nbsp;<span class="op" id="4281909">=</span>&nbsp;<span class="ident" id="4281911">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281932">return</span>&nbsp;<span class="ident" id="4281939">nil</span><span class="op" id="4281942">,</span>&nbsp;<span class="ident" id="4281944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4281949">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281952">if</span>&nbsp;<span class="builtinfunc" id="4281955">len</span><span class="op" id="4281958">(</span><span class="ident" id="4281959">p</span><span class="op" id="4281960">)</span>&nbsp;<span class="op" id="4281962">&gt;=</span>&nbsp;<span class="ident" id="4281965">maxLineLength</span>&nbsp;<span class="op" id="4281979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4281983">return</span>&nbsp;<span class="ident" id="4281990">nil</span><span class="op" id="4281993">,</span>&nbsp;<span class="ident" id="4281995">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4282011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4282014">return</span>&nbsp;<span class="ident" id="4282021">trimTrailingWhitespace</span><span class="op" id="4282043">(</span><span class="ident" id="4282044">p</span><span class="op" id="4282045">)</span><span class="op" id="4282046">,</span>&nbsp;<span class="ident" id="4282048">nil</span><br>
<span class="lineno"></span><span class="op" id="4282052">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4282055">func</span>&nbsp;<span class="ident" id="4282060">trimTrailingWhitespace</span><span class="op" id="4282082">(</span><span class="ident" id="4282083">b</span>&nbsp;<span class="op" id="4282085">[</span><span class="op" id="4282086">]</span><span class="builtintype" id="4282087">byte</span><span class="op" id="4282091">)</span>&nbsp;<span class="op" id="4282093">[</span><span class="op" id="4282094">]</span><span class="builtintype" id="4282095">byte</span>&nbsp;<span class="op" id="4282100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4282103">for</span>&nbsp;<span class="builtinfunc" id="4282107">len</span><span class="op" id="4282110">(</span><span class="ident" id="4282111">b</span><span class="op" id="4282112">)</span>&nbsp;<span class="op" id="4282114">&gt;</span>&nbsp;<span class="num" id="4282116">0</span>&nbsp;<span class="op" id="4282118">&amp;&amp;</span>&nbsp;<span class="ident" id="4282121">isASCIISpace</span><span class="op" id="4282133">(</span><span class="ident" id="4282134">b</span><span class="op" id="4282135">[</span><span class="builtinfunc" id="4282136">len</span><span class="op" id="4282139">(</span><span class="ident" id="4282140">b</span><span class="op" id="4282141">)</span><span class="op" id="4282142">-</span><span class="num" id="4282143">1</span><span class="op" id="4282144">]</span><span class="op" id="4282145">)</span>&nbsp;<span class="op" id="4282147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4282151">b</span>&nbsp;<span class="op" id="4282153">=</span>&nbsp;<span class="ident" id="4282155">b</span><span class="op" id="4282156">[</span><span class="op" id="4282157">:</span><span class="builtinfunc" id="4282158">len</span><span class="op" id="4282161">(</span><span class="ident" id="4282162">b</span><span class="op" id="4282163">)</span><span class="op" id="4282164">-</span><span class="num" id="4282165">1</span><span class="op" id="4282166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4282169">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4282172">return</span>&nbsp;<span class="ident" id="4282179">b</span><br>
<span class="lineno"></span><span class="op" id="4282181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4282184">func</span>&nbsp;<span class="ident" id="4282189">isASCIISpace</span><span class="op" id="4282201">(</span><span class="ident" id="4282202">b</span>&nbsp;<span class="builtintype" id="4282204">byte</span><span class="op" id="4282208">)</span>&nbsp;<span class="builtintype" id="4282210">bool</span>&nbsp;<span class="op" id="4282215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4282218">return</span>&nbsp;<span class="ident" id="4282225">b</span>&nbsp;<span class="op" id="4282227">==</span>&nbsp;<span class="string" id="4282230">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4282234">||</span>&nbsp;<span class="ident" id="4282237">b</span>&nbsp;<span class="op" id="4282239">==</span>&nbsp;<span class="string" id="4282242">&#39;\t&#39;</span>&nbsp;<span class="op" id="4282247">||</span>&nbsp;<span class="ident" id="4282250">b</span>&nbsp;<span class="op" id="4282252">==</span>&nbsp;<span class="string" id="4282255">&#39;\n&#39;</span>&nbsp;<span class="op" id="4282260">||</span>&nbsp;<span class="ident" id="4282263">b</span>&nbsp;<span class="op" id="4282265">==</span>&nbsp;<span class="string" id="4282268">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4282273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4282276">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4282357">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4282438">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4282506">//</span><br>
<span class="lineno"></span><span class="comment" id="4282509">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4282576">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4282639">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4282705">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4282774">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4282810">func</span>&nbsp;<span class="ident" id="4282815">NewChunkedWriter</span><span class="op" id="4282831">(</span><span class="ident" id="4282832">w</span>&nbsp;<span class="ident" id="4282834">io</span><span class="op" id="4282836">.</span><span class="ident" id="4282837">Writer</span><span class="op" id="4282843">)</span>&nbsp;<span class="ident" id="4282845">io</span><span class="op" id="4282847">.</span><span class="ident" id="4282848">WriteCloser</span>&nbsp;<span class="op" id="4282860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4282863">return</span>&nbsp;<span class="op" id="4282870">&amp;</span><span class="ident" id="4282871">chunkedWriter</span><span class="op" id="4282884">{</span><span class="ident" id="4282885">w</span><span class="op" id="4282886">}</span><br>
<span class="lineno"></span><span class="op" id="4282888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4282891">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4282966">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4283028">type</span>&nbsp;<span class="ident" id="4283033">chunkedWriter</span>&nbsp;<span class="keyword" id="4283047">struct</span>&nbsp;<span class="op" id="4283054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283057">Wire</span>&nbsp;<span class="ident" id="4283062">io</span><span class="op" id="4283064">.</span><span class="ident" id="4283065">Writer</span><br>
<span class="lineno"></span><span class="op" id="4283072">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4283075">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4283127">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4283206">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4283269">func</span>&nbsp;<span class="op" id="4283274">(</span><span class="ident" id="4283275">cw</span>&nbsp;<span class="op" id="4283278">*</span><span class="ident" id="4283279">chunkedWriter</span><span class="op" id="4283292">)</span>&nbsp;<span class="ident" id="4283294">Write</span><span class="op" id="4283299">(</span><span class="ident" id="4283300">data</span>&nbsp;<span class="op" id="4283305">[</span><span class="op" id="4283306">]</span><span class="builtintype" id="4283307">byte</span><span class="op" id="4283311">)</span>&nbsp;<span class="op" id="4283313">(</span><span class="ident" id="4283314">n</span>&nbsp;<span class="builtintype" id="4283316">int</span><span class="op" id="4283319">,</span>&nbsp;<span class="ident" id="4283321">err</span>&nbsp;<span class="builtintype" id="4283325">error</span><span class="op" id="4283330">)</span>&nbsp;<span class="op" id="4283332">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4283336">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283406">if</span>&nbsp;<span class="builtinfunc" id="4283409">len</span><span class="op" id="4283412">(</span><span class="ident" id="4283413">data</span><span class="op" id="4283417">)</span>&nbsp;<span class="op" id="4283419">==</span>&nbsp;<span class="num" id="4283422">0</span>&nbsp;<span class="op" id="4283424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283428">return</span>&nbsp;<span class="num" id="4283435">0</span><span class="op" id="4283436">,</span>&nbsp;<span class="ident" id="4283438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4283443">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283447">if</span>&nbsp;<span class="ident" id="4283450">_</span><span class="op" id="4283451">,</span>&nbsp;<span class="ident" id="4283453">err</span>&nbsp;<span class="op" id="4283457">=</span>&nbsp;<span class="ident" id="4283459">fmt</span><span class="op" id="4283462">.</span><span class="ident" id="4283463">Fprintf</span><span class="op" id="4283470">(</span><span class="ident" id="4283471">cw</span><span class="op" id="4283473">.</span><span class="ident" id="4283474">Wire</span><span class="op" id="4283478">,</span>&nbsp;<span class="string" id="4283480">&#34;%x\r\n&#34;</span><span class="op" id="4283488">,</span>&nbsp;<span class="builtinfunc" id="4283490">len</span><span class="op" id="4283493">(</span><span class="ident" id="4283494">data</span><span class="op" id="4283498">)</span><span class="op" id="4283499">)</span><span class="op" id="4283500">;</span>&nbsp;<span class="ident" id="4283502">err</span>&nbsp;<span class="op" id="4283506">!=</span>&nbsp;<span class="ident" id="4283509">nil</span>&nbsp;<span class="op" id="4283513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283517">return</span>&nbsp;<span class="num" id="4283524">0</span><span class="op" id="4283525">,</span>&nbsp;<span class="ident" id="4283527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4283532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283535">if</span>&nbsp;<span class="ident" id="4283538">n</span><span class="op" id="4283539">,</span>&nbsp;<span class="ident" id="4283541">err</span>&nbsp;<span class="op" id="4283545">=</span>&nbsp;<span class="ident" id="4283547">cw</span><span class="op" id="4283549">.</span><span class="ident" id="4283550">Wire</span><span class="op" id="4283554">.</span><span class="ident" id="4283555">Write</span><span class="op" id="4283560">(</span><span class="ident" id="4283561">data</span><span class="op" id="4283565">)</span><span class="op" id="4283566">;</span>&nbsp;<span class="ident" id="4283568">err</span>&nbsp;<span class="op" id="4283572">!=</span>&nbsp;<span class="ident" id="4283575">nil</span>&nbsp;<span class="op" id="4283579">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283583">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4283591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283594">if</span>&nbsp;<span class="ident" id="4283597">n</span>&nbsp;<span class="op" id="4283599">!=</span>&nbsp;<span class="builtinfunc" id="4283602">len</span><span class="op" id="4283605">(</span><span class="ident" id="4283606">data</span><span class="op" id="4283610">)</span>&nbsp;<span class="op" id="4283612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283616">err</span>&nbsp;<span class="op" id="4283620">=</span>&nbsp;<span class="ident" id="4283622">io</span><span class="op" id="4283624">.</span><span class="ident" id="4283625">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283641">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4283649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283652">_</span><span class="op" id="4283653">,</span>&nbsp;<span class="ident" id="4283655">err</span>&nbsp;<span class="op" id="4283659">=</span>&nbsp;<span class="ident" id="4283661">io</span><span class="op" id="4283663">.</span><span class="ident" id="4283664">WriteString</span><span class="op" id="4283675">(</span><span class="ident" id="4283676">cw</span><span class="op" id="4283678">.</span><span class="ident" id="4283679">Wire</span><span class="op" id="4283683">,</span>&nbsp;<span class="string" id="4283685">&#34;\r\n&#34;</span><span class="op" id="4283691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283695">return</span><br>
<span class="lineno"></span><span class="op" id="4283702">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4283705">func</span>&nbsp;<span class="op" id="4283710">(</span><span class="ident" id="4283711">cw</span>&nbsp;<span class="op" id="4283714">*</span><span class="ident" id="4283715">chunkedWriter</span><span class="op" id="4283728">)</span>&nbsp;<span class="ident" id="4283730">Close</span><span class="op" id="4283735">(</span><span class="op" id="4283736">)</span>&nbsp;<span class="builtintype" id="4283738">error</span>&nbsp;<span class="op" id="4283744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283747">_</span><span class="op" id="4283748">,</span>&nbsp;<span class="ident" id="4283750">err</span>&nbsp;<span class="op" id="4283754">:=</span>&nbsp;<span class="ident" id="4283757">io</span><span class="op" id="4283759">.</span><span class="ident" id="4283760">WriteString</span><span class="op" id="4283771">(</span><span class="ident" id="4283772">cw</span><span class="op" id="4283774">.</span><span class="ident" id="4283775">Wire</span><span class="op" id="4283779">,</span>&nbsp;<span class="string" id="4283781">&#34;0\r\n&#34;</span><span class="op" id="4283788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283791">return</span>&nbsp;<span class="ident" id="4283798">err</span><br>
<span class="lineno"></span><span class="op" id="4283802">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4283805">func</span>&nbsp;<span class="ident" id="4283810">parseHexUint</span><span class="op" id="4283822">(</span><span class="ident" id="4283823">v</span>&nbsp;<span class="op" id="4283825">[</span><span class="op" id="4283826">]</span><span class="builtintype" id="4283827">byte</span><span class="op" id="4283831">)</span>&nbsp;<span class="op" id="4283833">(</span><span class="ident" id="4283834">n</span>&nbsp;<span class="ident" id="4283836">uint64</span><span class="op" id="4283842">,</span>&nbsp;<span class="ident" id="4283844">err</span>&nbsp;<span class="builtintype" id="4283848">error</span><span class="op" id="4283853">)</span>&nbsp;<span class="op" id="4283855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283858">for</span>&nbsp;<span class="ident" id="4283862">_</span><span class="op" id="4283863">,</span>&nbsp;<span class="ident" id="4283865">b</span>&nbsp;<span class="op" id="4283867">:=</span>&nbsp;<span class="keyword" id="4283870">range</span>&nbsp;<span class="ident" id="4283876">v</span>&nbsp;<span class="op" id="4283878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283882">n</span>&nbsp;<span class="op" id="4283884">&lt;&lt;=</span>&nbsp;<span class="num" id="4283888">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283892">switch</span>&nbsp;<span class="op" id="4283899">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283903">case</span>&nbsp;<span class="string" id="4283908">&#39;0&#39;</span>&nbsp;<span class="op" id="4283912">&lt;=</span>&nbsp;<span class="ident" id="4283915">b</span>&nbsp;<span class="op" id="4283917">&amp;&amp;</span>&nbsp;<span class="ident" id="4283920">b</span>&nbsp;<span class="op" id="4283922">&lt;=</span>&nbsp;<span class="string" id="4283925">&#39;9&#39;</span><span class="op" id="4283928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283933">b</span>&nbsp;<span class="op" id="4283935">=</span>&nbsp;<span class="ident" id="4283937">b</span>&nbsp;<span class="op" id="4283939">-</span>&nbsp;<span class="string" id="4283941">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283947">case</span>&nbsp;<span class="string" id="4283952">&#39;a&#39;</span>&nbsp;<span class="op" id="4283956">&lt;=</span>&nbsp;<span class="ident" id="4283959">b</span>&nbsp;<span class="op" id="4283961">&amp;&amp;</span>&nbsp;<span class="ident" id="4283964">b</span>&nbsp;<span class="op" id="4283966">&lt;=</span>&nbsp;<span class="string" id="4283969">&#39;f&#39;</span><span class="op" id="4283972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4283977">b</span>&nbsp;<span class="op" id="4283979">=</span>&nbsp;<span class="ident" id="4283981">b</span>&nbsp;<span class="op" id="4283983">-</span>&nbsp;<span class="string" id="4283985">&#39;a&#39;</span>&nbsp;<span class="op" id="4283989">+</span>&nbsp;<span class="num" id="4283991">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4283996">case</span>&nbsp;<span class="string" id="4284001">&#39;A&#39;</span>&nbsp;<span class="op" id="4284005">&lt;=</span>&nbsp;<span class="ident" id="4284008">b</span>&nbsp;<span class="op" id="4284010">&amp;&amp;</span>&nbsp;<span class="ident" id="4284013">b</span>&nbsp;<span class="op" id="4284015">&lt;=</span>&nbsp;<span class="string" id="4284018">&#39;F&#39;</span><span class="op" id="4284021">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4284026">b</span>&nbsp;<span class="op" id="4284028">=</span>&nbsp;<span class="ident" id="4284030">b</span>&nbsp;<span class="op" id="4284032">-</span>&nbsp;<span class="string" id="4284034">&#39;A&#39;</span>&nbsp;<span class="op" id="4284038">+</span>&nbsp;<span class="num" id="4284040">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4284045">default</span><span class="op" id="4284052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4284057">return</span>&nbsp;<span class="num" id="4284064">0</span><span class="op" id="4284065">,</span>&nbsp;<span class="ident" id="4284067">errors</span><span class="op" id="4284073">.</span><span class="ident" id="4284074">New</span><span class="op" id="4284077">(</span><span class="string" id="4284078">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4284108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4284112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4284116">n</span>&nbsp;<span class="op" id="4284118">|=</span>&nbsp;<span class="ident" id="4284121">uint64</span><span class="op" id="4284127">(</span><span class="ident" id="4284128">b</span><span class="op" id="4284129">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4284132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4284135">return</span><br>
<span class="lineno"></span><span class="op" id="4284142">}</span>
</div>
</body>
</html>
