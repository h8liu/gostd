<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3918740">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3918795">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3918849">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3918900">package</span>&nbsp;<span class="ident" id="3918908">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3918913">import</span>&nbsp;<span class="op" id="3918920">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918923">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918933">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918949">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918963">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918980">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3918995">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3919012">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3919022">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3919029">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3919034">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919037">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3919113">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3919165">type</span>&nbsp;<span class="ident" id="3919170">serverHandshakeState</span>&nbsp;<span class="keyword" id="3919191">struct</span>&nbsp;<span class="op" id="3919198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919201">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919217">*</span><span class="ident" id="3919218"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919224">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919240">*</span><span class="ident" id="3919241"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919257">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919273">*</span><span class="ident" id="3919274"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919290">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919306">*</span><span class="ident" id="3919307"><a href="/crypto/tls/cipher_suites.go.html#3815009">cipherSuite</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919320">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3919336">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919342">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3919358">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919364">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919380">*</span><span class="ident" id="3919381"><a href="/crypto/tls/ticket.go.html#3959716">sessionState</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919395">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3919411"><a href="/crypto/tls/prf.go.html#3956115">finishedHash</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919425">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919441">[</span><span class="op" id="3919442">]</span><span class="builtintype" id="3919443">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919449">certsFromClient</span>&nbsp;<span class="op" id="3919465">[</span><span class="op" id="3919466">]</span><span class="op" id="3919467">[</span><span class="op" id="3919468">]</span><span class="builtintype" id="3919469">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919475">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3919491">*</span><span class="ident" id="3919492"><a href="/crypto/tls/common.go.html#3838319">Certificate</a></span><br>
<span class="lineno"></span><span class="op" id="3919504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3919507">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3919564">func</span>&nbsp;<span class="op" id="3919569">(</span><span class="ident" id="3919570">c</span>&nbsp;<span class="op" id="3919572">*</span><span class="ident" id="3919573"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3919577">)</span>&nbsp;<span class="ident" id="3919579">serverHandshake</span><span class="op" id="3919594">(</span><span class="op" id="3919595">)</span>&nbsp;<span class="builtintype" id="3919597">error</span>&nbsp;<span class="op" id="3919603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919606">config</span>&nbsp;<span class="op" id="3919613">:=</span>&nbsp;<span class="ident" id="3919616"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3919617">.</span><span class="ident" id="3919618">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919627">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919698">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919728"><a href="/crypto/tls/handshake_server.go.html#3919606">config</a></span><span class="op" id="3919734">.</span><span class="ident" id="3919735">serverInitOnce</span><span class="op" id="3919749">.</span><span class="ident" id="3919750">Do</span><span class="op" id="3919752">(</span><span class="ident" id="3919753"><a href="/crypto/tls/handshake_server.go.html#3919606">config</a></span><span class="op" id="3919759">.</span><span class="ident" id="3919760">serverInit</span><span class="op" id="3919770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919774">hs</span>&nbsp;<span class="op" id="3919777">:=</span>&nbsp;<span class="ident" id="3919780"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3919800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919804">c</span><span class="op" id="3919805">:</span>&nbsp;<span class="ident" id="3919807"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3919808">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919814">isResume</span><span class="op" id="3919822">,</span>&nbsp;<span class="ident" id="3919824">err</span>&nbsp;<span class="op" id="3919828">:=</span>&nbsp;<span class="ident" id="3919831"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3919833">.</span><span class="ident" id="3919834">readClientHello</span><span class="op" id="3919849">(</span><span class="op" id="3919850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919853">if</span>&nbsp;<span class="ident" id="3919856"><a href="/crypto/tls/handshake_server.go.html#3919824">err</a></span>&nbsp;<span class="op" id="3919860">!=</span>&nbsp;<span class="ident" id="3919863">nil</span>&nbsp;<span class="op" id="3919867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919871">return</span>&nbsp;<span class="ident" id="3919878"><a href="/crypto/tls/handshake_server.go.html#3919824">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919883">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919887">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919979">if</span>&nbsp;<span class="ident" id="3919982"><a href="/crypto/tls/handshake_server.go.html#3919814">isResume</a></span>&nbsp;<span class="op" id="3919991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919995">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920080">if</span>&nbsp;<span class="ident" id="3920083">err</span>&nbsp;<span class="op" id="3920087">:=</span>&nbsp;<span class="ident" id="3920090"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920092">.</span><span class="ident" id="3920093">doResumeHandshake</span><span class="op" id="3920110">(</span><span class="op" id="3920111">)</span><span class="op" id="3920112">;</span>&nbsp;<span class="ident" id="3920114"><a href="/crypto/tls/handshake_server.go.html#3920083">err</a></span>&nbsp;<span class="op" id="3920118">!=</span>&nbsp;<span class="ident" id="3920121">nil</span>&nbsp;<span class="op" id="3920125">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920130">return</span>&nbsp;<span class="ident" id="3920137"><a href="/crypto/tls/handshake_server.go.html#3920083">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920147">if</span>&nbsp;<span class="ident" id="3920150">err</span>&nbsp;<span class="op" id="3920154">:=</span>&nbsp;<span class="ident" id="3920157"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920159">.</span><span class="ident" id="3920160">establishKeys</span><span class="op" id="3920173">(</span><span class="op" id="3920174">)</span><span class="op" id="3920175">;</span>&nbsp;<span class="ident" id="3920177"><a href="/crypto/tls/handshake_server.go.html#3920150">err</a></span>&nbsp;<span class="op" id="3920181">!=</span>&nbsp;<span class="ident" id="3920184">nil</span>&nbsp;<span class="op" id="3920188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920193">return</span>&nbsp;<span class="ident" id="3920200"><a href="/crypto/tls/handshake_server.go.html#3920150">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920206">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920210">if</span>&nbsp;<span class="ident" id="3920213">err</span>&nbsp;<span class="op" id="3920217">:=</span>&nbsp;<span class="ident" id="3920220"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920222">.</span><span class="ident" id="3920223">sendFinished</span><span class="op" id="3920235">(</span><span class="ident" id="3920236"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3920237">.</span><span class="ident" id="3920238">firstFinished</span><span class="op" id="3920251">[</span><span class="op" id="3920252">:</span><span class="op" id="3920253">]</span><span class="op" id="3920254">)</span><span class="op" id="3920255">;</span>&nbsp;<span class="ident" id="3920257"><a href="/crypto/tls/handshake_server.go.html#3920213">err</a></span>&nbsp;<span class="op" id="3920261">!=</span>&nbsp;<span class="ident" id="3920264">nil</span>&nbsp;<span class="op" id="3920268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920273">return</span>&nbsp;<span class="ident" id="3920280"><a href="/crypto/tls/handshake_server.go.html#3920213">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920290">if</span>&nbsp;<span class="ident" id="3920293">err</span>&nbsp;<span class="op" id="3920297">:=</span>&nbsp;<span class="ident" id="3920300"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920302">.</span><span class="ident" id="3920303">readFinished</span><span class="op" id="3920315">(</span><span class="ident" id="3920316">nil</span><span class="op" id="3920319">)</span><span class="op" id="3920320">;</span>&nbsp;<span class="ident" id="3920322"><a href="/crypto/tls/handshake_server.go.html#3920293">err</a></span>&nbsp;<span class="op" id="3920326">!=</span>&nbsp;<span class="ident" id="3920329">nil</span>&nbsp;<span class="op" id="3920333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920338">return</span>&nbsp;<span class="ident" id="3920345"><a href="/crypto/tls/handshake_server.go.html#3920293">err</a></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920355"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3920356">.</span><span class="ident" id="3920357">didResume</span>&nbsp;<span class="op" id="3920367">=</span>&nbsp;<span class="builtintype" id="3920369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920375">}</span>&nbsp;<span class="keyword" id="3920377">else</span>&nbsp;<span class="op" id="3920382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920386">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920448">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920486">if</span>&nbsp;<span class="ident" id="3920489">err</span>&nbsp;<span class="op" id="3920493">:=</span>&nbsp;<span class="ident" id="3920496"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920498">.</span><span class="ident" id="3920499">doFullHandshake</span><span class="op" id="3920514">(</span><span class="op" id="3920515">)</span><span class="op" id="3920516">;</span>&nbsp;<span class="ident" id="3920518"><a href="/crypto/tls/handshake_server.go.html#3920489">err</a></span>&nbsp;<span class="op" id="3920522">!=</span>&nbsp;<span class="ident" id="3920525">nil</span>&nbsp;<span class="op" id="3920529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920534">return</span>&nbsp;<span class="ident" id="3920541"><a href="/crypto/tls/handshake_server.go.html#3920489">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920551">if</span>&nbsp;<span class="ident" id="3920554">err</span>&nbsp;<span class="op" id="3920558">:=</span>&nbsp;<span class="ident" id="3920561"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920563">.</span><span class="ident" id="3920564">establishKeys</span><span class="op" id="3920577">(</span><span class="op" id="3920578">)</span><span class="op" id="3920579">;</span>&nbsp;<span class="ident" id="3920581"><a href="/crypto/tls/handshake_server.go.html#3920554">err</a></span>&nbsp;<span class="op" id="3920585">!=</span>&nbsp;<span class="ident" id="3920588">nil</span>&nbsp;<span class="op" id="3920592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920597">return</span>&nbsp;<span class="ident" id="3920604"><a href="/crypto/tls/handshake_server.go.html#3920554">err</a></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920614">if</span>&nbsp;<span class="ident" id="3920617">err</span>&nbsp;<span class="op" id="3920621">:=</span>&nbsp;<span class="ident" id="3920624"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920626">.</span><span class="ident" id="3920627">readFinished</span><span class="op" id="3920639">(</span><span class="ident" id="3920640"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3920641">.</span><span class="ident" id="3920642">firstFinished</span><span class="op" id="3920655">[</span><span class="op" id="3920656">:</span><span class="op" id="3920657">]</span><span class="op" id="3920658">)</span><span class="op" id="3920659">;</span>&nbsp;<span class="ident" id="3920661"><a href="/crypto/tls/handshake_server.go.html#3920617">err</a></span>&nbsp;<span class="op" id="3920665">!=</span>&nbsp;<span class="ident" id="3920668">nil</span>&nbsp;<span class="op" id="3920672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920677">return</span>&nbsp;<span class="ident" id="3920684"><a href="/crypto/tls/handshake_server.go.html#3920617">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920694">if</span>&nbsp;<span class="ident" id="3920697">err</span>&nbsp;<span class="op" id="3920701">:=</span>&nbsp;<span class="ident" id="3920704"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920706">.</span><span class="ident" id="3920707">sendSessionTicket</span><span class="op" id="3920724">(</span><span class="op" id="3920725">)</span><span class="op" id="3920726">;</span>&nbsp;<span class="ident" id="3920728"><a href="/crypto/tls/handshake_server.go.html#3920697">err</a></span>&nbsp;<span class="op" id="3920732">!=</span>&nbsp;<span class="ident" id="3920735">nil</span>&nbsp;<span class="op" id="3920739">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920744">return</span>&nbsp;<span class="ident" id="3920751"><a href="/crypto/tls/handshake_server.go.html#3920697">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920761">if</span>&nbsp;<span class="ident" id="3920764">err</span>&nbsp;<span class="op" id="3920768">:=</span>&nbsp;<span class="ident" id="3920771"><a href="/crypto/tls/handshake_server.go.html#3919774">hs</a></span><span class="op" id="3920773">.</span><span class="ident" id="3920774">sendFinished</span><span class="op" id="3920786">(</span><span class="ident" id="3920787">nil</span><span class="op" id="3920790">)</span><span class="op" id="3920791">;</span>&nbsp;<span class="ident" id="3920793"><a href="/crypto/tls/handshake_server.go.html#3920764">err</a></span>&nbsp;<span class="op" id="3920797">!=</span>&nbsp;<span class="ident" id="3920800">nil</span>&nbsp;<span class="op" id="3920804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920809">return</span>&nbsp;<span class="ident" id="3920816"><a href="/crypto/tls/handshake_server.go.html#3920764">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920822">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920828"><a href="/crypto/tls/handshake_server.go.html#3919570">c</a></span><span class="op" id="3920829">.</span><span class="ident" id="3920830">handshakeComplete</span>&nbsp;<span class="op" id="3920848">=</span>&nbsp;<span class="builtintype" id="3920850">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920857">return</span>&nbsp;<span class="ident" id="3920864">nil</span><br>
<span class="lineno"></span><span class="op" id="3920868">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3920871">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3920946">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3920993">func</span>&nbsp;<span class="op" id="3920998">(</span><span class="ident" id="3920999">hs</span>&nbsp;<span class="op" id="3921002">*</span><span class="ident" id="3921003"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3921023">)</span>&nbsp;<span class="ident" id="3921025">readClientHello</span><span class="op" id="3921040">(</span><span class="op" id="3921041">)</span>&nbsp;<span class="op" id="3921043">(</span><span class="ident" id="3921044">isResume</span>&nbsp;<span class="builtintype" id="3921053">bool</span><span class="op" id="3921057">,</span>&nbsp;<span class="ident" id="3921059">err</span>&nbsp;<span class="builtintype" id="3921063">error</span><span class="op" id="3921068">)</span>&nbsp;<span class="op" id="3921070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921073">config</span>&nbsp;<span class="op" id="3921080">:=</span>&nbsp;<span class="ident" id="3921083"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921085">.</span><span class="ident" id="3921086">c</span><span class="op" id="3921087">.</span><span class="ident" id="3921088">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921096">c</span>&nbsp;<span class="op" id="3921098">:=</span>&nbsp;<span class="ident" id="3921101"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921103">.</span><span class="ident" id="3921104">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921108">msg</span><span class="op" id="3921111">,</span>&nbsp;<span class="ident" id="3921113"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3921117">:=</span>&nbsp;<span class="ident" id="3921120"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921121">.</span><span class="ident" id="3921122">readHandshake</span><span class="op" id="3921135">(</span><span class="op" id="3921136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921139">if</span>&nbsp;<span class="ident" id="3921142"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3921146">!=</span>&nbsp;<span class="ident" id="3921149">nil</span>&nbsp;<span class="op" id="3921153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921157">return</span>&nbsp;<span class="builtintype" id="3921164">false</span><span class="op" id="3921169">,</span>&nbsp;<span class="ident" id="3921171"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921179">var</span>&nbsp;<span class="ident" id="3921183">ok</span>&nbsp;<span class="builtintype" id="3921186">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921192"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921194">.</span><span class="ident" id="3921195">clientHello</span><span class="op" id="3921206">,</span>&nbsp;<span class="ident" id="3921208"><a href="/crypto/tls/handshake_server.go.html#3921183">ok</a></span>&nbsp;<span class="op" id="3921211">=</span>&nbsp;<span class="ident" id="3921213"><a href="/crypto/tls/handshake_server.go.html#3921108">msg</a></span><span class="op" id="3921216">.</span><span class="op" id="3921217">(</span><span class="op" id="3921218">*</span><span class="ident" id="3921219"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3921233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921236">if</span>&nbsp;<span class="op" id="3921239">!</span><span class="ident" id="3921240"><a href="/crypto/tls/handshake_server.go.html#3921183">ok</a></span>&nbsp;<span class="op" id="3921243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921247"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921248">.</span><span class="ident" id="3921249">sendAlert</span><span class="op" id="3921258">(</span><span class="ident" id="3921259"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3921281">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921285">return</span>&nbsp;<span class="builtintype" id="3921292">false</span><span class="op" id="3921297">,</span>&nbsp;<span class="ident" id="3921299"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3921321">(</span><span class="ident" id="3921322"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921324">.</span><span class="ident" id="3921325">clientHello</span><span class="op" id="3921336">,</span>&nbsp;<span class="ident" id="3921338"><a href="/crypto/tls/handshake_server.go.html#3921108">msg</a></span><span class="op" id="3921341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921347"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921348">.</span><span class="ident" id="3921349">vers</span><span class="op" id="3921353">,</span>&nbsp;<span class="ident" id="3921355"><a href="/crypto/tls/handshake_server.go.html#3921183">ok</a></span>&nbsp;<span class="op" id="3921358">=</span>&nbsp;<span class="ident" id="3921360"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3921366">.</span><span class="ident" id="3921367">mutualVersion</span><span class="op" id="3921380">(</span><span class="ident" id="3921381"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921383">.</span><span class="ident" id="3921384">clientHello</span><span class="op" id="3921395">.</span><span class="ident" id="3921396">vers</span><span class="op" id="3921400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921403">if</span>&nbsp;<span class="op" id="3921406">!</span><span class="ident" id="3921407"><a href="/crypto/tls/handshake_server.go.html#3921183">ok</a></span>&nbsp;<span class="op" id="3921410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921414"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921415">.</span><span class="ident" id="3921416">sendAlert</span><span class="op" id="3921425">(</span><span class="ident" id="3921426"><a href="/crypto/tls/alert.go.html#3811268">alertProtocolVersion</a></span><span class="op" id="3921446">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921450">return</span>&nbsp;<span class="builtintype" id="3921457">false</span><span class="op" id="3921462">,</span>&nbsp;<span class="ident" id="3921464"><a href="/crypto/tls/handshake_server.go.html#3919022">fmt</a></span><span class="op" id="3921467">.</span><span class="ident" id="3921468">Errorf</span><span class="op" id="3921474">(</span><span class="string" id="3921475">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3921543">,</span>&nbsp;<span class="ident" id="3921545"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921547">.</span><span class="ident" id="3921548">clientHello</span><span class="op" id="3921559">.</span><span class="ident" id="3921560">vers</span><span class="op" id="3921564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921570"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921571">.</span><span class="ident" id="3921572">haveVers</span>&nbsp;<span class="op" id="3921581">=</span>&nbsp;<span class="builtintype" id="3921583">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921590"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921592">.</span><span class="ident" id="3921593">finishedHash</span>&nbsp;<span class="op" id="3921606">=</span>&nbsp;<span class="ident" id="3921608"><a href="/crypto/tls/prf.go.html#3955764">newFinishedHash</a></span><span class="op" id="3921623">(</span><span class="ident" id="3921624"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3921625">.</span><span class="ident" id="3921626">vers</span><span class="op" id="3921630">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921633"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921635">.</span><span class="ident" id="3921636">finishedHash</span><span class="op" id="3921648">.</span><span class="ident" id="3921649">Write</span><span class="op" id="3921654">(</span><span class="ident" id="3921655"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921657">.</span><span class="ident" id="3921658">clientHello</span><span class="op" id="3921669">.</span><span class="ident" id="3921670">marshal</span><span class="op" id="3921677">(</span><span class="op" id="3921678">)</span><span class="op" id="3921679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921683"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921685">.</span><span class="ident" id="3921686">hello</span>&nbsp;<span class="op" id="3921692">=</span>&nbsp;<span class="builtinfunc" id="3921694">new</span><span class="op" id="3921697">(</span><span class="ident" id="3921698"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3921712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921716">supportedCurve</span>&nbsp;<span class="op" id="3921731">:=</span>&nbsp;<span class="builtintype" id="3921734">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921741">preferredCurves</span>&nbsp;<span class="op" id="3921757">:=</span>&nbsp;<span class="ident" id="3921760"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3921766">.</span><span class="ident" id="3921767">curvePreferences</span><span class="op" id="3921783">(</span><span class="op" id="3921784">)</span><br>
<span class="lineno"></span><span class="ident" id="3921786">Curves</span><span class="op" id="3921792">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921795">for</span>&nbsp;<span class="ident" id="3921799">_</span><span class="op" id="3921800">,</span>&nbsp;<span class="ident" id="3921802">curve</span>&nbsp;<span class="op" id="3921808">:=</span>&nbsp;<span class="keyword" id="3921811">range</span>&nbsp;<span class="ident" id="3921817"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3921819">.</span><span class="ident" id="3921820">clientHello</span><span class="op" id="3921831">.</span><span class="ident" id="3921832">supportedCurves</span>&nbsp;<span class="op" id="3921848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921852">for</span>&nbsp;<span class="ident" id="3921856">_</span><span class="op" id="3921857">,</span>&nbsp;<span class="ident" id="3921859">supported</span>&nbsp;<span class="op" id="3921869">:=</span>&nbsp;<span class="keyword" id="3921872">range</span>&nbsp;<span class="ident" id="3921878"><a href="/crypto/tls/handshake_server.go.html#3921741">preferredCurves</a></span>&nbsp;<span class="op" id="3921894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921899">if</span>&nbsp;<span class="ident" id="3921902"><a href="/crypto/tls/handshake_server.go.html#3921859">supported</a></span>&nbsp;<span class="op" id="3921912">==</span>&nbsp;<span class="ident" id="3921915"><a href="/crypto/tls/handshake_server.go.html#3921802">curve</a></span>&nbsp;<span class="op" id="3921921">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921927"><a href="/crypto/tls/handshake_server.go.html#3921716">supportedCurve</a></span>&nbsp;<span class="op" id="3921942">=</span>&nbsp;<span class="builtintype" id="3921944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921953">break</span>&nbsp;<span class="ident" id="3921959">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921976">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921980">supportedPointFormat</span>&nbsp;<span class="op" id="3922001">:=</span>&nbsp;<span class="builtintype" id="3922004">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922011">for</span>&nbsp;<span class="ident" id="3922015">_</span><span class="op" id="3922016">,</span>&nbsp;<span class="ident" id="3922018">pointFormat</span>&nbsp;<span class="op" id="3922030">:=</span>&nbsp;<span class="keyword" id="3922033">range</span>&nbsp;<span class="ident" id="3922039"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922041">.</span><span class="ident" id="3922042">clientHello</span><span class="op" id="3922053">.</span><span class="ident" id="3922054">supportedPoints</span>&nbsp;<span class="op" id="3922070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922074">if</span>&nbsp;<span class="ident" id="3922077"><a href="/crypto/tls/handshake_server.go.html#3922018">pointFormat</a></span>&nbsp;<span class="op" id="3922089">==</span>&nbsp;<span class="ident" id="3922092"><a href="/crypto/tls/common.go.html#3824903">pointFormatUncompressed</a></span>&nbsp;<span class="op" id="3922116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922121"><a href="/crypto/tls/handshake_server.go.html#3921980">supportedPointFormat</a></span>&nbsp;<span class="op" id="3922142">=</span>&nbsp;<span class="builtintype" id="3922144">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922152">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922166"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922168">.</span><span class="ident" id="3922169">ellipticOk</span>&nbsp;<span class="op" id="3922180">=</span>&nbsp;<span class="ident" id="3922182"><a href="/crypto/tls/handshake_server.go.html#3921716">supportedCurve</a></span>&nbsp;<span class="op" id="3922197">&amp;&amp;</span>&nbsp;<span class="ident" id="3922200"><a href="/crypto/tls/handshake_server.go.html#3921980">supportedPointFormat</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922223">foundCompression</span>&nbsp;<span class="op" id="3922240">:=</span>&nbsp;<span class="builtintype" id="3922243">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922250">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922325">for</span>&nbsp;<span class="ident" id="3922329">_</span><span class="op" id="3922330">,</span>&nbsp;<span class="ident" id="3922332">compression</span>&nbsp;<span class="op" id="3922344">:=</span>&nbsp;<span class="keyword" id="3922347">range</span>&nbsp;<span class="ident" id="3922353"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922355">.</span><span class="ident" id="3922356">clientHello</span><span class="op" id="3922367">.</span><span class="ident" id="3922368">compressionMethods</span>&nbsp;<span class="op" id="3922387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922391">if</span>&nbsp;<span class="ident" id="3922394"><a href="/crypto/tls/handshake_server.go.html#3922332">compression</a></span>&nbsp;<span class="op" id="3922406">==</span>&nbsp;<span class="ident" id="3922409"><a href="/crypto/tls/common.go.html#3823960">compressionNone</a></span>&nbsp;<span class="op" id="3922425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922430"><a href="/crypto/tls/handshake_server.go.html#3922223">foundCompression</a></span>&nbsp;<span class="op" id="3922447">=</span>&nbsp;<span class="builtintype" id="3922449">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922457">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922472">if</span>&nbsp;<span class="op" id="3922475">!</span><span class="ident" id="3922476"><a href="/crypto/tls/handshake_server.go.html#3922223">foundCompression</a></span>&nbsp;<span class="op" id="3922493">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922497"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3922498">.</span><span class="ident" id="3922499">sendAlert</span><span class="op" id="3922508">(</span><span class="ident" id="3922509"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3922530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922534">return</span>&nbsp;<span class="builtintype" id="3922541">false</span><span class="op" id="3922546">,</span>&nbsp;<span class="ident" id="3922548"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3922554">.</span><span class="ident" id="3922555">New</span><span class="op" id="3922558">(</span><span class="string" id="3922559">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3922614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922621"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922623">.</span><span class="ident" id="3922624">hello</span><span class="op" id="3922629">.</span><span class="ident" id="3922630">vers</span>&nbsp;<span class="op" id="3922635">=</span>&nbsp;<span class="ident" id="3922637"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3922638">.</span><span class="ident" id="3922639">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922645"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922647">.</span><span class="ident" id="3922648">hello</span><span class="op" id="3922653">.</span><span class="ident" id="3922654">random</span>&nbsp;<span class="op" id="3922661">=</span>&nbsp;<span class="builtinfunc" id="3922663">make</span><span class="op" id="3922667">(</span><span class="op" id="3922668">[</span><span class="op" id="3922669">]</span><span class="builtintype" id="3922670">byte</span><span class="op" id="3922674">,</span>&nbsp;<span class="num" id="3922676">32</span><span class="op" id="3922678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922681">_</span><span class="op" id="3922682">,</span>&nbsp;<span class="ident" id="3922684"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3922688">=</span>&nbsp;<span class="ident" id="3922690"><a href="/crypto/tls/handshake_server.go.html#3919029">io</a></span><span class="op" id="3922692">.</span><span class="ident" id="3922693">ReadFull</span><span class="op" id="3922701">(</span><span class="ident" id="3922702"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3922708">.</span><span class="ident" id="3922709">rand</span><span class="op" id="3922713">(</span><span class="op" id="3922714">)</span><span class="op" id="3922715">,</span>&nbsp;<span class="ident" id="3922717"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922719">.</span><span class="ident" id="3922720">hello</span><span class="op" id="3922725">.</span><span class="ident" id="3922726">random</span><span class="op" id="3922732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922735">if</span>&nbsp;<span class="ident" id="3922738"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3922742">!=</span>&nbsp;<span class="ident" id="3922745">nil</span>&nbsp;<span class="op" id="3922749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922753"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3922754">.</span><span class="ident" id="3922755">sendAlert</span><span class="op" id="3922764">(</span><span class="ident" id="3922765"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3922783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922787">return</span>&nbsp;<span class="builtintype" id="3922794">false</span><span class="op" id="3922799">,</span>&nbsp;<span class="ident" id="3922801"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922809"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922811">.</span><span class="ident" id="3922812">hello</span><span class="op" id="3922817">.</span><span class="ident" id="3922818">secureRenegotiation</span>&nbsp;<span class="op" id="3922838">=</span>&nbsp;<span class="ident" id="3922840"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922842">.</span><span class="ident" id="3922843">clientHello</span><span class="op" id="3922854">.</span><span class="ident" id="3922855">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922876"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922878">.</span><span class="ident" id="3922879">hello</span><span class="op" id="3922884">.</span><span class="ident" id="3922885">compressionMethod</span>&nbsp;<span class="op" id="3922903">=</span>&nbsp;<span class="ident" id="3922905"><a href="/crypto/tls/common.go.html#3823960">compressionNone</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922922">if</span>&nbsp;<span class="builtinfunc" id="3922925">len</span><span class="op" id="3922928">(</span><span class="ident" id="3922929"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922931">.</span><span class="ident" id="3922932">clientHello</span><span class="op" id="3922943">.</span><span class="ident" id="3922944">serverName</span><span class="op" id="3922954">)</span>&nbsp;<span class="op" id="3922956">&gt;</span>&nbsp;<span class="num" id="3922958">0</span>&nbsp;<span class="op" id="3922960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922964"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3922965">.</span><span class="ident" id="3922966">serverName</span>&nbsp;<span class="op" id="3922977">=</span>&nbsp;<span class="ident" id="3922979"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3922981">.</span><span class="ident" id="3922982">clientHello</span><span class="op" id="3922993">.</span><span class="ident" id="3922994">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923010">if</span>&nbsp;<span class="builtinfunc" id="3923013">len</span><span class="op" id="3923016">(</span><span class="ident" id="3923017"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923019">.</span><span class="ident" id="3923020">clientHello</span><span class="op" id="3923031">.</span><span class="ident" id="3923032">alpnProtocols</span><span class="op" id="3923045">)</span>&nbsp;<span class="op" id="3923047">&gt;</span>&nbsp;<span class="num" id="3923049">0</span>&nbsp;<span class="op" id="3923051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923055">if</span>&nbsp;<span class="ident" id="3923058">selectedProto</span><span class="op" id="3923071">,</span>&nbsp;<span class="ident" id="3923073">fallback</span>&nbsp;<span class="op" id="3923082">:=</span>&nbsp;<span class="ident" id="3923085"><a href="/crypto/tls/handshake_client.go.html#3888195">mutualProtocol</a></span><span class="op" id="3923099">(</span><span class="ident" id="3923100"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923102">.</span><span class="ident" id="3923103">clientHello</span><span class="op" id="3923114">.</span><span class="ident" id="3923115">alpnProtocols</span><span class="op" id="3923128">,</span>&nbsp;<span class="ident" id="3923130"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3923131">.</span><span class="ident" id="3923132">config</span><span class="op" id="3923138">.</span><span class="ident" id="3923139">NextProtos</span><span class="op" id="3923149">)</span><span class="op" id="3923150">;</span>&nbsp;<span class="op" id="3923152">!</span><span class="ident" id="3923153"><a href="/crypto/tls/handshake_server.go.html#3923073">fallback</a></span>&nbsp;<span class="op" id="3923162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923167"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923169">.</span><span class="ident" id="3923170">hello</span><span class="op" id="3923175">.</span><span class="ident" id="3923176">alpnProtocol</span>&nbsp;<span class="op" id="3923189">=</span>&nbsp;<span class="ident" id="3923191"><a href="/crypto/tls/handshake_server.go.html#3923058">selectedProto</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923208"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3923209">.</span><span class="ident" id="3923210">clientProtocol</span>&nbsp;<span class="op" id="3923225">=</span>&nbsp;<span class="ident" id="3923227"><a href="/crypto/tls/handshake_server.go.html#3923058">selectedProto</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923246">}</span>&nbsp;<span class="keyword" id="3923248">else</span>&nbsp;<span class="op" id="3923253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923257">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923329">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923388">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923425">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923482">if</span>&nbsp;<span class="ident" id="3923485"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923487">.</span><span class="ident" id="3923488">clientHello</span><span class="op" id="3923499">.</span><span class="ident" id="3923500">nextProtoNeg</span>&nbsp;<span class="op" id="3923513">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3923516">len</span><span class="op" id="3923519">(</span><span class="ident" id="3923520"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3923526">.</span><span class="ident" id="3923527">NextProtos</span><span class="op" id="3923537">)</span>&nbsp;<span class="op" id="3923539">&gt;</span>&nbsp;<span class="num" id="3923541">0</span>&nbsp;<span class="op" id="3923543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923548"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923550">.</span><span class="ident" id="3923551">hello</span><span class="op" id="3923556">.</span><span class="ident" id="3923557">nextProtoNeg</span>&nbsp;<span class="op" id="3923570">=</span>&nbsp;<span class="builtintype" id="3923572">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923580"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923582">.</span><span class="ident" id="3923583">hello</span><span class="op" id="3923588">.</span><span class="ident" id="3923589">nextProtos</span>&nbsp;<span class="op" id="3923600">=</span>&nbsp;<span class="ident" id="3923602"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3923608">.</span><span class="ident" id="3923609">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923629">if</span>&nbsp;<span class="builtinfunc" id="3923632">len</span><span class="op" id="3923635">(</span><span class="ident" id="3923636"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3923642">.</span><span class="ident" id="3923643">Certificates</span><span class="op" id="3923655">)</span>&nbsp;<span class="op" id="3923657">==</span>&nbsp;<span class="num" id="3923660">0</span>&nbsp;<span class="op" id="3923662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923666"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3923667">.</span><span class="ident" id="3923668">sendAlert</span><span class="op" id="3923677">(</span><span class="ident" id="3923678"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3923696">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923700">return</span>&nbsp;<span class="builtintype" id="3923707">false</span><span class="op" id="3923712">,</span>&nbsp;<span class="ident" id="3923714"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3923720">.</span><span class="ident" id="3923721">New</span><span class="op" id="3923724">(</span><span class="string" id="3923725">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3923758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923764"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923766">.</span><span class="ident" id="3923767">cert</span>&nbsp;<span class="op" id="3923772">=</span>&nbsp;<span class="op" id="3923774">&amp;</span><span class="ident" id="3923775"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3923781">.</span><span class="ident" id="3923782">Certificates</span><span class="op" id="3923794">[</span><span class="num" id="3923795">0</span><span class="op" id="3923796">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923799">if</span>&nbsp;<span class="builtinfunc" id="3923802">len</span><span class="op" id="3923805">(</span><span class="ident" id="3923806"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923808">.</span><span class="ident" id="3923809">clientHello</span><span class="op" id="3923820">.</span><span class="ident" id="3923821">serverName</span><span class="op" id="3923831">)</span>&nbsp;<span class="op" id="3923833">&gt;</span>&nbsp;<span class="num" id="3923835">0</span>&nbsp;<span class="op" id="3923837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923841">chi</span>&nbsp;<span class="op" id="3923845">:=</span>&nbsp;<span class="op" id="3923848">&amp;</span><span class="ident" id="3923849"><a href="/crypto/tls/common.go.html#3829703">ClientHelloInfo</a></span><span class="op" id="3923864">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923869">CipherSuites</span><span class="op" id="3923881">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923886"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923888">.</span><span class="ident" id="3923889">clientHello</span><span class="op" id="3923900">.</span><span class="ident" id="3923901">cipherSuites</span><span class="op" id="3923913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923918">ServerName</span><span class="op" id="3923928">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3923935"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923937">.</span><span class="ident" id="3923938">clientHello</span><span class="op" id="3923949">.</span><span class="ident" id="3923950">serverName</span><span class="op" id="3923960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923965">SupportedCurves</span><span class="op" id="3923980">:</span>&nbsp;<span class="ident" id="3923982"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3923984">.</span><span class="ident" id="3923985">clientHello</span><span class="op" id="3923996">.</span><span class="ident" id="3923997">supportedCurves</span><span class="op" id="3924012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924017">SupportedPoints</span><span class="op" id="3924032">:</span>&nbsp;<span class="ident" id="3924034"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924036">.</span><span class="ident" id="3924037">clientHello</span><span class="op" id="3924048">.</span><span class="ident" id="3924049">supportedPoints</span><span class="op" id="3924064">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924068">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924072">if</span>&nbsp;<span class="ident" id="3924075"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924077">.</span><span class="ident" id="3924078">cert</span><span class="op" id="3924082">,</span>&nbsp;<span class="ident" id="3924084"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3924088">=</span>&nbsp;<span class="ident" id="3924090"><a href="/crypto/tls/handshake_server.go.html#3921073">config</a></span><span class="op" id="3924096">.</span><span class="ident" id="3924097">getCertificate</span><span class="op" id="3924111">(</span><span class="ident" id="3924112"><a href="/crypto/tls/handshake_server.go.html#3923841">chi</a></span><span class="op" id="3924115">)</span><span class="op" id="3924116">;</span>&nbsp;<span class="ident" id="3924118"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span>&nbsp;<span class="op" id="3924122">!=</span>&nbsp;<span class="ident" id="3924125">nil</span>&nbsp;<span class="op" id="3924129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924134"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924135">.</span><span class="ident" id="3924136">sendAlert</span><span class="op" id="3924145">(</span><span class="ident" id="3924146"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3924164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924169">return</span>&nbsp;<span class="builtintype" id="3924176">false</span><span class="op" id="3924181">,</span>&nbsp;<span class="ident" id="3924183"><a href="/crypto/tls/handshake_server.go.html#3921059">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924192">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924196">_</span><span class="op" id="3924197">,</span>&nbsp;<span class="ident" id="3924199"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924201">.</span><span class="ident" id="3924202">ecdsaOk</span>&nbsp;<span class="op" id="3924210">=</span>&nbsp;<span class="ident" id="3924212"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924214">.</span><span class="ident" id="3924215">cert</span><span class="op" id="3924219">.</span><span class="ident" id="3924220">PrivateKey</span><span class="op" id="3924230">.</span><span class="op" id="3924231">(</span><span class="op" id="3924232">*</span><span class="ident" id="3924233"><a href="/crypto/tls/handshake_server.go.html#3918933">ecdsa</a></span><span class="op" id="3924238">.</span><span class="ident" id="3924239">PrivateKey</span><span class="op" id="3924249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924253">if</span>&nbsp;<span class="ident" id="3924256"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924258">.</span><span class="ident" id="3924259">checkForResumption</span><span class="op" id="3924277">(</span><span class="op" id="3924278">)</span>&nbsp;<span class="op" id="3924280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924284">return</span>&nbsp;<span class="builtintype" id="3924291">true</span><span class="op" id="3924295">,</span>&nbsp;<span class="ident" id="3924297">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924306">var</span>&nbsp;<span class="ident" id="3924310">preferenceList</span><span class="op" id="3924324">,</span>&nbsp;<span class="ident" id="3924326">supportedList</span>&nbsp;<span class="op" id="3924340">[</span><span class="op" id="3924341">]</span><span class="builtintype" id="3924342">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924350">if</span>&nbsp;<span class="ident" id="3924353"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924354">.</span><span class="ident" id="3924355">config</span><span class="op" id="3924361">.</span><span class="ident" id="3924362">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3924387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924391"><a href="/crypto/tls/handshake_server.go.html#3924310">preferenceList</a></span>&nbsp;<span class="op" id="3924406">=</span>&nbsp;<span class="ident" id="3924408"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924409">.</span><span class="ident" id="3924410">config</span><span class="op" id="3924416">.</span><span class="ident" id="3924417">cipherSuites</span><span class="op" id="3924429">(</span><span class="op" id="3924430">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924434"><a href="/crypto/tls/handshake_server.go.html#3924326">supportedList</a></span>&nbsp;<span class="op" id="3924448">=</span>&nbsp;<span class="ident" id="3924450"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924452">.</span><span class="ident" id="3924453">clientHello</span><span class="op" id="3924464">.</span><span class="ident" id="3924465">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924479">}</span>&nbsp;<span class="keyword" id="3924481">else</span>&nbsp;<span class="op" id="3924486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924490"><a href="/crypto/tls/handshake_server.go.html#3924310">preferenceList</a></span>&nbsp;<span class="op" id="3924505">=</span>&nbsp;<span class="ident" id="3924507"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924509">.</span><span class="ident" id="3924510">clientHello</span><span class="op" id="3924521">.</span><span class="ident" id="3924522">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924537"><a href="/crypto/tls/handshake_server.go.html#3924326">supportedList</a></span>&nbsp;<span class="op" id="3924551">=</span>&nbsp;<span class="ident" id="3924553"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924554">.</span><span class="ident" id="3924555">config</span><span class="op" id="3924561">.</span><span class="ident" id="3924562">cipherSuites</span><span class="op" id="3924574">(</span><span class="op" id="3924575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924578">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924582">for</span>&nbsp;<span class="ident" id="3924586">_</span><span class="op" id="3924587">,</span>&nbsp;<span class="ident" id="3924589">id</span>&nbsp;<span class="op" id="3924592">:=</span>&nbsp;<span class="keyword" id="3924595">range</span>&nbsp;<span class="ident" id="3924601"><a href="/crypto/tls/handshake_server.go.html#3924310">preferenceList</a></span>&nbsp;<span class="op" id="3924616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924620">if</span>&nbsp;<span class="ident" id="3924623"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924625">.</span><span class="ident" id="3924626">suite</span>&nbsp;<span class="op" id="3924632">=</span>&nbsp;<span class="ident" id="3924634"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924635">.</span><span class="ident" id="3924636">tryCipherSuite</span><span class="op" id="3924650">(</span><span class="ident" id="3924651"><a href="/crypto/tls/handshake_server.go.html#3924589">id</a></span><span class="op" id="3924653">,</span>&nbsp;<span class="ident" id="3924655"><a href="/crypto/tls/handshake_server.go.html#3924326">supportedList</a></span><span class="op" id="3924668">,</span>&nbsp;<span class="ident" id="3924670"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924671">.</span><span class="ident" id="3924672">vers</span><span class="op" id="3924676">,</span>&nbsp;<span class="ident" id="3924678"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924680">.</span><span class="ident" id="3924681">ellipticOk</span><span class="op" id="3924691">,</span>&nbsp;<span class="ident" id="3924693"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924695">.</span><span class="ident" id="3924696">ecdsaOk</span><span class="op" id="3924703">)</span><span class="op" id="3924704">;</span>&nbsp;<span class="ident" id="3924706"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924708">.</span><span class="ident" id="3924709">suite</span>&nbsp;<span class="op" id="3924715">!=</span>&nbsp;<span class="ident" id="3924718">nil</span>&nbsp;<span class="op" id="3924722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924727">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924735">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924742">if</span>&nbsp;<span class="ident" id="3924745"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924747">.</span><span class="ident" id="3924748">suite</span>&nbsp;<span class="op" id="3924754">==</span>&nbsp;<span class="ident" id="3924757">nil</span>&nbsp;<span class="op" id="3924761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924765"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3924766">.</span><span class="ident" id="3924767">sendAlert</span><span class="op" id="3924776">(</span><span class="ident" id="3924777"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3924798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924802">return</span>&nbsp;<span class="builtintype" id="3924809">false</span><span class="op" id="3924814">,</span>&nbsp;<span class="ident" id="3924816"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3924822">.</span><span class="ident" id="3924823">New</span><span class="op" id="3924826">(</span><span class="string" id="3924827">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3924885">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3924892">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924962">for</span>&nbsp;<span class="ident" id="3924966">_</span><span class="op" id="3924967">,</span>&nbsp;<span class="ident" id="3924969">id</span>&nbsp;<span class="op" id="3924972">:=</span>&nbsp;<span class="keyword" id="3924975">range</span>&nbsp;<span class="ident" id="3924981"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3924983">.</span><span class="ident" id="3924984">clientHello</span><span class="op" id="3924995">.</span><span class="ident" id="3924996">cipherSuites</span>&nbsp;<span class="op" id="3925009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925013">if</span>&nbsp;<span class="ident" id="3925016"><a href="/crypto/tls/handshake_server.go.html#3924969">id</a></span>&nbsp;<span class="op" id="3925019">==</span>&nbsp;<span class="ident" id="3925022"><a href="/crypto/tls/cipher_suites.go.html#3822431">TLS_FALLBACK_SCSV</a></span>&nbsp;<span class="op" id="3925040">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925045">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925094">if</span>&nbsp;<span class="ident" id="3925097"><a href="/crypto/tls/handshake_server.go.html#3920999">hs</a></span><span class="op" id="3925099">.</span><span class="ident" id="3925100">clientHello</span><span class="op" id="3925111">.</span><span class="ident" id="3925112">vers</span>&nbsp;<span class="op" id="3925117">&lt;</span>&nbsp;<span class="ident" id="3925119"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3925120">.</span><span class="ident" id="3925121">config</span><span class="op" id="3925127">.</span><span class="ident" id="3925128">MaxVersion</span>&nbsp;<span class="op" id="3925139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925145"><a href="/crypto/tls/handshake_server.go.html#3921096">c</a></span><span class="op" id="3925146">.</span><span class="ident" id="3925147">sendAlert</span><span class="op" id="3925156">(</span><span class="ident" id="3925157"><a href="/crypto/tls/alert.go.html#3811388">alertInappropriateFallback</a></span><span class="op" id="3925183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925189">return</span>&nbsp;<span class="builtintype" id="3925196">false</span><span class="op" id="3925201">,</span>&nbsp;<span class="ident" id="3925203"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3925209">.</span><span class="ident" id="3925210">New</span><span class="op" id="3925213">(</span><span class="string" id="3925214">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3925264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925269">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925274">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925289">return</span>&nbsp;<span class="builtintype" id="3925296">false</span><span class="op" id="3925301">,</span>&nbsp;<span class="ident" id="3925303">nil</span><br>
<span class="lineno">240</span><span class="op" id="3925307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3925310">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3925397">func</span>&nbsp;<span class="op" id="3925402">(</span><span class="ident" id="3925403">hs</span>&nbsp;<span class="op" id="3925406">*</span><span class="ident" id="3925407"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3925427">)</span>&nbsp;<span class="ident" id="3925429">checkForResumption</span><span class="op" id="3925447">(</span><span class="op" id="3925448">)</span>&nbsp;<span class="builtintype" id="3925450">bool</span>&nbsp;<span class="op" id="3925455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925458">c</span>&nbsp;<span class="op" id="3925460">:=</span>&nbsp;<span class="ident" id="3925463"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925465">.</span><span class="ident" id="3925466">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925470">if</span>&nbsp;<span class="ident" id="3925473"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3925474">.</span><span class="ident" id="3925475">config</span><span class="op" id="3925481">.</span><span class="ident" id="3925482">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3925505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925509">return</span>&nbsp;<span class="builtintype" id="3925516">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925527">var</span>&nbsp;<span class="ident" id="3925531">ok</span>&nbsp;<span class="builtintype" id="3925534">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925540">if</span>&nbsp;<span class="ident" id="3925543"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925545">.</span><span class="ident" id="3925546">sessionState</span><span class="op" id="3925558">,</span>&nbsp;<span class="ident" id="3925560"><a href="/crypto/tls/handshake_server.go.html#3925531">ok</a></span>&nbsp;<span class="op" id="3925563">=</span>&nbsp;<span class="ident" id="3925565"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3925566">.</span><span class="ident" id="3925567">decryptTicket</span><span class="op" id="3925580">(</span><span class="ident" id="3925581"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925583">.</span><span class="ident" id="3925584">clientHello</span><span class="op" id="3925595">.</span><span class="ident" id="3925596">sessionTicket</span><span class="op" id="3925609">)</span><span class="op" id="3925610">;</span>&nbsp;<span class="op" id="3925612">!</span><span class="ident" id="3925613"><a href="/crypto/tls/handshake_server.go.html#3925531">ok</a></span>&nbsp;<span class="op" id="3925616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925620">return</span>&nbsp;<span class="builtintype" id="3925627">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925638">if</span>&nbsp;<span class="ident" id="3925641"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925643">.</span><span class="ident" id="3925644">sessionState</span><span class="op" id="3925656">.</span><span class="ident" id="3925657">vers</span>&nbsp;<span class="op" id="3925662">&gt;</span>&nbsp;<span class="ident" id="3925664"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925666">.</span><span class="ident" id="3925667">clientHello</span><span class="op" id="3925678">.</span><span class="ident" id="3925679">vers</span>&nbsp;<span class="op" id="3925684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925688">return</span>&nbsp;<span class="builtintype" id="3925695">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925705">if</span>&nbsp;<span class="ident" id="3925708">vers</span><span class="op" id="3925712">,</span>&nbsp;<span class="ident" id="3925714">ok</span>&nbsp;<span class="op" id="3925717">:=</span>&nbsp;<span class="ident" id="3925720"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3925721">.</span><span class="ident" id="3925722">config</span><span class="op" id="3925728">.</span><span class="ident" id="3925729">mutualVersion</span><span class="op" id="3925742">(</span><span class="ident" id="3925743"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925745">.</span><span class="ident" id="3925746">sessionState</span><span class="op" id="3925758">.</span><span class="ident" id="3925759">vers</span><span class="op" id="3925763">)</span><span class="op" id="3925764">;</span>&nbsp;<span class="op" id="3925766">!</span><span class="ident" id="3925767"><a href="/crypto/tls/handshake_server.go.html#3925714">ok</a></span>&nbsp;<span class="op" id="3925770">||</span>&nbsp;<span class="ident" id="3925773"><a href="/crypto/tls/handshake_server.go.html#3925708">vers</a></span>&nbsp;<span class="op" id="3925778">!=</span>&nbsp;<span class="ident" id="3925781"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925783">.</span><span class="ident" id="3925784">sessionState</span><span class="op" id="3925796">.</span><span class="ident" id="3925797">vers</span>&nbsp;<span class="op" id="3925802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925806">return</span>&nbsp;<span class="builtintype" id="3925813">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925824">cipherSuiteOk</span>&nbsp;<span class="op" id="3925838">:=</span>&nbsp;<span class="builtintype" id="3925841">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925848">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925924">for</span>&nbsp;<span class="ident" id="3925928">_</span><span class="op" id="3925929">,</span>&nbsp;<span class="ident" id="3925931">id</span>&nbsp;<span class="op" id="3925934">:=</span>&nbsp;<span class="keyword" id="3925937">range</span>&nbsp;<span class="ident" id="3925943"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925945">.</span><span class="ident" id="3925946">clientHello</span><span class="op" id="3925957">.</span><span class="ident" id="3925958">cipherSuites</span>&nbsp;<span class="op" id="3925971">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925975">if</span>&nbsp;<span class="ident" id="3925978"><a href="/crypto/tls/handshake_server.go.html#3925931">id</a></span>&nbsp;<span class="op" id="3925981">==</span>&nbsp;<span class="ident" id="3925984"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3925986">.</span><span class="ident" id="3925987">sessionState</span><span class="op" id="3925999">.</span><span class="ident" id="3926000">cipherSuite</span>&nbsp;<span class="op" id="3926012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926017"><a href="/crypto/tls/handshake_server.go.html#3925824">cipherSuiteOk</a></span>&nbsp;<span class="op" id="3926031">=</span>&nbsp;<span class="builtintype" id="3926033">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926041">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926052">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926055">if</span>&nbsp;<span class="op" id="3926058">!</span><span class="ident" id="3926059"><a href="/crypto/tls/handshake_server.go.html#3925824">cipherSuiteOk</a></span>&nbsp;<span class="op" id="3926073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926077">return</span>&nbsp;<span class="builtintype" id="3926084">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926095">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926160"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926162">.</span><span class="ident" id="3926163">suite</span>&nbsp;<span class="op" id="3926169">=</span>&nbsp;<span class="ident" id="3926171"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3926172">.</span><span class="ident" id="3926173">tryCipherSuite</span><span class="op" id="3926187">(</span><span class="ident" id="3926188"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926190">.</span><span class="ident" id="3926191">sessionState</span><span class="op" id="3926203">.</span><span class="ident" id="3926204">cipherSuite</span><span class="op" id="3926215">,</span>&nbsp;<span class="ident" id="3926217"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3926218">.</span><span class="ident" id="3926219">config</span><span class="op" id="3926225">.</span><span class="ident" id="3926226">cipherSuites</span><span class="op" id="3926238">(</span><span class="op" id="3926239">)</span><span class="op" id="3926240">,</span>&nbsp;<span class="ident" id="3926242"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926244">.</span><span class="ident" id="3926245">sessionState</span><span class="op" id="3926257">.</span><span class="ident" id="3926258">vers</span><span class="op" id="3926262">,</span>&nbsp;<span class="ident" id="3926264"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926266">.</span><span class="ident" id="3926267">ellipticOk</span><span class="op" id="3926277">,</span>&nbsp;<span class="ident" id="3926279"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926281">.</span><span class="ident" id="3926282">ecdsaOk</span><span class="op" id="3926289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926292">if</span>&nbsp;<span class="ident" id="3926295"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926297">.</span><span class="ident" id="3926298">suite</span>&nbsp;<span class="op" id="3926304">==</span>&nbsp;<span class="ident" id="3926307">nil</span>&nbsp;<span class="op" id="3926311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926315">return</span>&nbsp;<span class="builtintype" id="3926322">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926333">sessionHasClientCerts</span>&nbsp;<span class="op" id="3926355">:=</span>&nbsp;<span class="builtinfunc" id="3926358">len</span><span class="op" id="3926361">(</span><span class="ident" id="3926362"><a href="/crypto/tls/handshake_server.go.html#3925403">hs</a></span><span class="op" id="3926364">.</span><span class="ident" id="3926365">sessionState</span><span class="op" id="3926377">.</span><span class="ident" id="3926378">certificates</span><span class="op" id="3926390">)</span>&nbsp;<span class="op" id="3926392">!=</span>&nbsp;<span class="num" id="3926395">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926398">needClientCerts</span>&nbsp;<span class="op" id="3926414">:=</span>&nbsp;<span class="ident" id="3926417"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3926418">.</span><span class="ident" id="3926419">config</span><span class="op" id="3926425">.</span><span class="ident" id="3926426">ClientAuth</span>&nbsp;<span class="op" id="3926437">==</span>&nbsp;<span class="ident" id="3926440"><a href="/crypto/tls/common.go.html#3828323">RequireAnyClientCert</a></span>&nbsp;<span class="op" id="3926461">||</span>&nbsp;<span class="ident" id="3926464"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3926465">.</span><span class="ident" id="3926466">config</span><span class="op" id="3926472">.</span><span class="ident" id="3926473">ClientAuth</span>&nbsp;<span class="op" id="3926484">==</span>&nbsp;<span class="ident" id="3926487"><a href="/crypto/tls/common.go.html#3828370">RequireAndVerifyClientCert</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926515">if</span>&nbsp;<span class="ident" id="3926518"><a href="/crypto/tls/handshake_server.go.html#3926398">needClientCerts</a></span>&nbsp;<span class="op" id="3926534">&amp;&amp;</span>&nbsp;<span class="op" id="3926537">!</span><span class="ident" id="3926538"><a href="/crypto/tls/handshake_server.go.html#3926333">sessionHasClientCerts</a></span>&nbsp;<span class="op" id="3926560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926564">return</span>&nbsp;<span class="builtintype" id="3926571">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926578">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926581">if</span>&nbsp;<span class="ident" id="3926584"><a href="/crypto/tls/handshake_server.go.html#3926333">sessionHasClientCerts</a></span>&nbsp;<span class="op" id="3926606">&amp;&amp;</span>&nbsp;<span class="ident" id="3926609"><a href="/crypto/tls/handshake_server.go.html#3925458">c</a></span><span class="op" id="3926610">.</span><span class="ident" id="3926611">config</span><span class="op" id="3926617">.</span><span class="ident" id="3926618">ClientAuth</span>&nbsp;<span class="op" id="3926629">==</span>&nbsp;<span class="ident" id="3926632"><a href="/crypto/tls/common.go.html#3828268">NoClientCert</a></span>&nbsp;<span class="op" id="3926645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926649">return</span>&nbsp;<span class="builtintype" id="3926656">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926667">return</span>&nbsp;<span class="builtintype" id="3926674">true</span><br>
<span class="lineno">290</span><span class="op" id="3926679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3926682">func</span>&nbsp;<span class="op" id="3926687">(</span><span class="ident" id="3926688">hs</span>&nbsp;<span class="op" id="3926691">*</span><span class="ident" id="3926692"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3926712">)</span>&nbsp;<span class="ident" id="3926714">doResumeHandshake</span><span class="op" id="3926731">(</span><span class="op" id="3926732">)</span>&nbsp;<span class="builtintype" id="3926734">error</span>&nbsp;<span class="op" id="3926740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926743">c</span>&nbsp;<span class="op" id="3926745">:=</span>&nbsp;<span class="ident" id="3926748"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926750">.</span><span class="ident" id="3926751">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926755"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926757">.</span><span class="ident" id="3926758">hello</span><span class="op" id="3926763">.</span><span class="ident" id="3926764">cipherSuite</span>&nbsp;<span class="op" id="3926776">=</span>&nbsp;<span class="ident" id="3926778"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926780">.</span><span class="ident" id="3926781">suite</span><span class="op" id="3926786">.</span><span class="ident" id="3926787">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926791">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926861">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926896"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926898">.</span><span class="ident" id="3926899">hello</span><span class="op" id="3926904">.</span><span class="ident" id="3926905">sessionId</span>&nbsp;<span class="op" id="3926915">=</span>&nbsp;<span class="ident" id="3926917"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926919">.</span><span class="ident" id="3926920">clientHello</span><span class="op" id="3926931">.</span><span class="ident" id="3926932">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926943"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926945">.</span><span class="ident" id="3926946">finishedHash</span><span class="op" id="3926958">.</span><span class="ident" id="3926959">Write</span><span class="op" id="3926964">(</span><span class="ident" id="3926965"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3926967">.</span><span class="ident" id="3926968">hello</span><span class="op" id="3926973">.</span><span class="ident" id="3926974">marshal</span><span class="op" id="3926981">(</span><span class="op" id="3926982">)</span><span class="op" id="3926983">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926986"><a href="/crypto/tls/handshake_server.go.html#3926743">c</a></span><span class="op" id="3926987">.</span><span class="ident" id="3926988">writeRecord</span><span class="op" id="3926999">(</span><span class="ident" id="3927000"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3927019">,</span>&nbsp;<span class="ident" id="3927021"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927023">.</span><span class="ident" id="3927024">hello</span><span class="op" id="3927029">.</span><span class="ident" id="3927030">marshal</span><span class="op" id="3927037">(</span><span class="op" id="3927038">)</span><span class="op" id="3927039">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927043">if</span>&nbsp;<span class="builtinfunc" id="3927046">len</span><span class="op" id="3927049">(</span><span class="ident" id="3927050"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927052">.</span><span class="ident" id="3927053">sessionState</span><span class="op" id="3927065">.</span><span class="ident" id="3927066">certificates</span><span class="op" id="3927078">)</span>&nbsp;<span class="op" id="3927080">&gt;</span>&nbsp;<span class="num" id="3927082">0</span>&nbsp;<span class="op" id="3927084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927088">if</span>&nbsp;<span class="ident" id="3927091">_</span><span class="op" id="3927092">,</span>&nbsp;<span class="ident" id="3927094">err</span>&nbsp;<span class="op" id="3927098">:=</span>&nbsp;<span class="ident" id="3927101"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927103">.</span><span class="ident" id="3927104">processCertsFromClient</span><span class="op" id="3927126">(</span><span class="ident" id="3927127"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927129">.</span><span class="ident" id="3927130">sessionState</span><span class="op" id="3927142">.</span><span class="ident" id="3927143">certificates</span><span class="op" id="3927155">)</span><span class="op" id="3927156">;</span>&nbsp;<span class="ident" id="3927158"><a href="/crypto/tls/handshake_server.go.html#3927094">err</a></span>&nbsp;<span class="op" id="3927162">!=</span>&nbsp;<span class="ident" id="3927165">nil</span>&nbsp;<span class="op" id="3927169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927174">return</span>&nbsp;<span class="ident" id="3927181"><a href="/crypto/tls/handshake_server.go.html#3927094">err</a></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927194"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927196">.</span><span class="ident" id="3927197">masterSecret</span>&nbsp;<span class="op" id="3927210">=</span>&nbsp;<span class="ident" id="3927212"><a href="/crypto/tls/handshake_server.go.html#3926688">hs</a></span><span class="op" id="3927214">.</span><span class="ident" id="3927215">sessionState</span><span class="op" id="3927227">.</span><span class="ident" id="3927228">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927243">return</span>&nbsp;<span class="ident" id="3927250">nil</span><br>
<span class="lineno"></span><span class="op" id="3927254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3927257">func</span>&nbsp;<span class="op" id="3927262">(</span><span class="ident" id="3927263">hs</span>&nbsp;<span class="op" id="3927266">*</span><span class="ident" id="3927267"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3927287">)</span>&nbsp;<span class="ident" id="3927289">doFullHandshake</span><span class="op" id="3927304">(</span><span class="op" id="3927305">)</span>&nbsp;<span class="builtintype" id="3927307">error</span>&nbsp;<span class="op" id="3927313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927316">config</span>&nbsp;<span class="op" id="3927323">:=</span>&nbsp;<span class="ident" id="3927326"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927328">.</span><span class="ident" id="3927329">c</span><span class="op" id="3927330">.</span><span class="ident" id="3927331">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927339">c</span>&nbsp;<span class="op" id="3927341">:=</span>&nbsp;<span class="ident" id="3927344"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927346">.</span><span class="ident" id="3927347">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927351">if</span>&nbsp;<span class="ident" id="3927354"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927356">.</span><span class="ident" id="3927357">clientHello</span><span class="op" id="3927368">.</span><span class="ident" id="3927369">ocspStapling</span>&nbsp;<span class="op" id="3927382">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3927385">len</span><span class="op" id="3927388">(</span><span class="ident" id="3927389"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927391">.</span><span class="ident" id="3927392">cert</span><span class="op" id="3927396">.</span><span class="ident" id="3927397">OCSPStaple</span><span class="op" id="3927407">)</span>&nbsp;<span class="op" id="3927409">&gt;</span>&nbsp;<span class="num" id="3927411">0</span>&nbsp;<span class="op" id="3927413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927417"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927419">.</span><span class="ident" id="3927420">hello</span><span class="op" id="3927425">.</span><span class="ident" id="3927426">ocspStapling</span>&nbsp;<span class="op" id="3927439">=</span>&nbsp;<span class="builtintype" id="3927441">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927447">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927451"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927453">.</span><span class="ident" id="3927454">hello</span><span class="op" id="3927459">.</span><span class="ident" id="3927460">ticketSupported</span>&nbsp;<span class="op" id="3927476">=</span>&nbsp;<span class="ident" id="3927478"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927480">.</span><span class="ident" id="3927481">clientHello</span><span class="op" id="3927492">.</span><span class="ident" id="3927493">ticketSupported</span>&nbsp;<span class="op" id="3927509">&amp;&amp;</span>&nbsp;<span class="op" id="3927512">!</span><span class="ident" id="3927513"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3927519">.</span><span class="ident" id="3927520">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927544"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927546">.</span><span class="ident" id="3927547">hello</span><span class="op" id="3927552">.</span><span class="ident" id="3927553">cipherSuite</span>&nbsp;<span class="op" id="3927565">=</span>&nbsp;<span class="ident" id="3927567"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927569">.</span><span class="ident" id="3927570">suite</span><span class="op" id="3927575">.</span><span class="ident" id="3927576">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927580"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927582">.</span><span class="ident" id="3927583">finishedHash</span><span class="op" id="3927595">.</span><span class="ident" id="3927596">Write</span><span class="op" id="3927601">(</span><span class="ident" id="3927602"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927604">.</span><span class="ident" id="3927605">hello</span><span class="op" id="3927610">.</span><span class="ident" id="3927611">marshal</span><span class="op" id="3927618">(</span><span class="op" id="3927619">)</span><span class="op" id="3927620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927623"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3927624">.</span><span class="ident" id="3927625">writeRecord</span><span class="op" id="3927636">(</span><span class="ident" id="3927637"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3927656">,</span>&nbsp;<span class="ident" id="3927658"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927660">.</span><span class="ident" id="3927661">hello</span><span class="op" id="3927666">.</span><span class="ident" id="3927667">marshal</span><span class="op" id="3927674">(</span><span class="op" id="3927675">)</span><span class="op" id="3927676">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927680">certMsg</span>&nbsp;<span class="op" id="3927688">:=</span>&nbsp;<span class="builtinfunc" id="3927691">new</span><span class="op" id="3927694">(</span><span class="ident" id="3927695"><a href="/crypto/tls/handshake_messages.go.html#3905092">certificateMsg</a></span><span class="op" id="3927709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927712"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3927719">.</span><span class="ident" id="3927720">certificates</span>&nbsp;<span class="op" id="3927733">=</span>&nbsp;<span class="ident" id="3927735"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927737">.</span><span class="ident" id="3927738">cert</span><span class="op" id="3927742">.</span><span class="ident" id="3927743">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927756"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927758">.</span><span class="ident" id="3927759">finishedHash</span><span class="op" id="3927771">.</span><span class="ident" id="3927772">Write</span><span class="op" id="3927777">(</span><span class="ident" id="3927778"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3927785">.</span><span class="ident" id="3927786">marshal</span><span class="op" id="3927793">(</span><span class="op" id="3927794">)</span><span class="op" id="3927795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927798"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3927799">.</span><span class="ident" id="3927800">writeRecord</span><span class="op" id="3927811">(</span><span class="ident" id="3927812"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3927831">,</span>&nbsp;<span class="ident" id="3927833"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3927840">.</span><span class="ident" id="3927841">marshal</span><span class="op" id="3927848">(</span><span class="op" id="3927849">)</span><span class="op" id="3927850">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927854">if</span>&nbsp;<span class="ident" id="3927857"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927859">.</span><span class="ident" id="3927860">hello</span><span class="op" id="3927865">.</span><span class="ident" id="3927866">ocspStapling</span>&nbsp;<span class="op" id="3927879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927883">certStatus</span>&nbsp;<span class="op" id="3927894">:=</span>&nbsp;<span class="builtinfunc" id="3927897">new</span><span class="op" id="3927900">(</span><span class="ident" id="3927901"><a href="/crypto/tls/handshake_messages.go.html#3907489">certificateStatusMsg</a></span><span class="op" id="3927921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927925"><a href="/crypto/tls/handshake_server.go.html#3927883">certStatus</a></span><span class="op" id="3927935">.</span><span class="ident" id="3927936">statusType</span>&nbsp;<span class="op" id="3927947">=</span>&nbsp;<span class="ident" id="3927949"><a href="/crypto/tls/common.go.html#3824989">statusTypeOCSP</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927966"><a href="/crypto/tls/handshake_server.go.html#3927883">certStatus</a></span><span class="op" id="3927976">.</span><span class="ident" id="3927977">response</span>&nbsp;<span class="op" id="3927986">=</span>&nbsp;<span class="ident" id="3927988"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3927990">.</span><span class="ident" id="3927991">cert</span><span class="op" id="3927995">.</span><span class="ident" id="3927996">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928009"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928011">.</span><span class="ident" id="3928012">finishedHash</span><span class="op" id="3928024">.</span><span class="ident" id="3928025">Write</span><span class="op" id="3928030">(</span><span class="ident" id="3928031"><a href="/crypto/tls/handshake_server.go.html#3927883">certStatus</a></span><span class="op" id="3928041">.</span><span class="ident" id="3928042">marshal</span><span class="op" id="3928049">(</span><span class="op" id="3928050">)</span><span class="op" id="3928051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928055"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3928056">.</span><span class="ident" id="3928057">writeRecord</span><span class="op" id="3928068">(</span><span class="ident" id="3928069"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3928088">,</span>&nbsp;<span class="ident" id="3928090"><a href="/crypto/tls/handshake_server.go.html#3927883">certStatus</a></span><span class="op" id="3928100">.</span><span class="ident" id="3928101">marshal</span><span class="op" id="3928108">(</span><span class="op" id="3928109">)</span><span class="op" id="3928110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928117">keyAgreement</span>&nbsp;<span class="op" id="3928130">:=</span>&nbsp;<span class="ident" id="3928133"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928135">.</span><span class="ident" id="3928136">suite</span><span class="op" id="3928141">.</span><span class="ident" id="3928142">ka</span><span class="op" id="3928144">(</span><span class="ident" id="3928145"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3928146">.</span><span class="ident" id="3928147">vers</span><span class="op" id="3928151">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928154">skx</span><span class="op" id="3928157">,</span>&nbsp;<span class="ident" id="3928159">err</span>&nbsp;<span class="op" id="3928163">:=</span>&nbsp;<span class="ident" id="3928166"><a href="/crypto/tls/handshake_server.go.html#3928117">keyAgreement</a></span><span class="op" id="3928178">.</span><span class="ident" id="3928179">generateServerKeyExchange</span><span class="op" id="3928204">(</span><span class="ident" id="3928205"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3928211">,</span>&nbsp;<span class="ident" id="3928213"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928215">.</span><span class="ident" id="3928216">cert</span><span class="op" id="3928220">,</span>&nbsp;<span class="ident" id="3928222"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928224">.</span><span class="ident" id="3928225">clientHello</span><span class="op" id="3928236">,</span>&nbsp;<span class="ident" id="3928238"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928240">.</span><span class="ident" id="3928241">hello</span><span class="op" id="3928246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928249">if</span>&nbsp;<span class="ident" id="3928252"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3928256">!=</span>&nbsp;<span class="ident" id="3928259">nil</span>&nbsp;<span class="op" id="3928263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928267"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3928268">.</span><span class="ident" id="3928269">sendAlert</span><span class="op" id="3928278">(</span><span class="ident" id="3928279"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3928300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928304">return</span>&nbsp;<span class="ident" id="3928311"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928316">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928319">if</span>&nbsp;<span class="ident" id="3928322"><a href="/crypto/tls/handshake_server.go.html#3928154">skx</a></span>&nbsp;<span class="op" id="3928326">!=</span>&nbsp;<span class="ident" id="3928329">nil</span>&nbsp;<span class="op" id="3928333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928337"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3928339">.</span><span class="ident" id="3928340">finishedHash</span><span class="op" id="3928352">.</span><span class="ident" id="3928353">Write</span><span class="op" id="3928358">(</span><span class="ident" id="3928359"><a href="/crypto/tls/handshake_server.go.html#3928154">skx</a></span><span class="op" id="3928362">.</span><span class="ident" id="3928363">marshal</span><span class="op" id="3928370">(</span><span class="op" id="3928371">)</span><span class="op" id="3928372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928376"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3928377">.</span><span class="ident" id="3928378">writeRecord</span><span class="op" id="3928389">(</span><span class="ident" id="3928390"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3928409">,</span>&nbsp;<span class="ident" id="3928411"><a href="/crypto/tls/handshake_server.go.html#3928154">skx</a></span><span class="op" id="3928414">.</span><span class="ident" id="3928415">marshal</span><span class="op" id="3928422">(</span><span class="op" id="3928423">)</span><span class="op" id="3928424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928431">if</span>&nbsp;<span class="ident" id="3928434"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3928440">.</span><span class="ident" id="3928441">ClientAuth</span>&nbsp;<span class="op" id="3928452">&gt;=</span>&nbsp;<span class="ident" id="3928455"><a href="/crypto/tls/common.go.html#3828304">RequestClientCert</a></span>&nbsp;<span class="op" id="3928473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928477">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928511">certReq</span>&nbsp;<span class="op" id="3928519">:=</span>&nbsp;<span class="builtinfunc" id="3928522">new</span><span class="op" id="3928525">(</span><span class="ident" id="3928526"><a href="/crypto/tls/handshake_messages.go.html#3911637">certificateRequestMsg</a></span><span class="op" id="3928547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928551"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3928558">.</span><span class="ident" id="3928559">certificateTypes</span>&nbsp;<span class="op" id="3928576">=</span>&nbsp;<span class="op" id="3928578">[</span><span class="op" id="3928579">]</span><span class="builtintype" id="3928580">byte</span><span class="op" id="3928584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3928589">byte</span><span class="op" id="3928593">(</span><span class="ident" id="3928594"><a href="/crypto/tls/common.go.html#3825075">certTypeRSASign</a></span><span class="op" id="3928609">)</span><span class="op" id="3928610">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3928615">byte</span><span class="op" id="3928619">(</span><span class="ident" id="3928620"><a href="/crypto/tls/common.go.html#3825373">certTypeECDSASign</a></span><span class="op" id="3928637">)</span><span class="op" id="3928638">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928646">if</span>&nbsp;<span class="ident" id="3928649"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3928650">.</span><span class="ident" id="3928651">vers</span>&nbsp;<span class="op" id="3928656">&gt;=</span>&nbsp;<span class="ident" id="3928659"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3928672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928677"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3928684">.</span><span class="ident" id="3928685">hasSignatureAndHash</span>&nbsp;<span class="op" id="3928705">=</span>&nbsp;<span class="builtintype" id="3928707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928715"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3928722">.</span><span class="ident" id="3928723">signatureAndHashes</span>&nbsp;<span class="op" id="3928742">=</span>&nbsp;<span class="ident" id="3928744"><a href="/crypto/tls/common.go.html#3826630">supportedClientCertSignatureAlgorithms</a></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928790">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928846">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928907">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928964">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929022">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929069">if</span>&nbsp;<span class="ident" id="3929072"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3929078">.</span><span class="ident" id="3929079">ClientCAs</span>&nbsp;<span class="op" id="3929089">!=</span>&nbsp;<span class="ident" id="3929092">nil</span>&nbsp;<span class="op" id="3929096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929101"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3929108">.</span><span class="ident" id="3929109">certificateAuthorities</span>&nbsp;<span class="op" id="3929132">=</span>&nbsp;<span class="ident" id="3929134"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3929140">.</span><span class="ident" id="3929141">ClientCAs</span><span class="op" id="3929150">.</span><span class="ident" id="3929151">Subjects</span><span class="op" id="3929159">(</span><span class="op" id="3929160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929164">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929168"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3929170">.</span><span class="ident" id="3929171">finishedHash</span><span class="op" id="3929183">.</span><span class="ident" id="3929184">Write</span><span class="op" id="3929189">(</span><span class="ident" id="3929190"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3929197">.</span><span class="ident" id="3929198">marshal</span><span class="op" id="3929205">(</span><span class="op" id="3929206">)</span><span class="op" id="3929207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929211"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3929212">.</span><span class="ident" id="3929213">writeRecord</span><span class="op" id="3929224">(</span><span class="ident" id="3929225"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3929244">,</span>&nbsp;<span class="ident" id="3929246"><a href="/crypto/tls/handshake_server.go.html#3928511">certReq</a></span><span class="op" id="3929253">.</span><span class="ident" id="3929254">marshal</span><span class="op" id="3929261">(</span><span class="op" id="3929262">)</span><span class="op" id="3929263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929270">helloDone</span>&nbsp;<span class="op" id="3929280">:=</span>&nbsp;<span class="builtinfunc" id="3929283">new</span><span class="op" id="3929286">(</span><span class="ident" id="3929287"><a href="/crypto/tls/handshake_messages.go.html#3908750">serverHelloDoneMsg</a></span><span class="op" id="3929305">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929308"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3929310">.</span><span class="ident" id="3929311">finishedHash</span><span class="op" id="3929323">.</span><span class="ident" id="3929324">Write</span><span class="op" id="3929329">(</span><span class="ident" id="3929330"><a href="/crypto/tls/handshake_server.go.html#3929270">helloDone</a></span><span class="op" id="3929339">.</span><span class="ident" id="3929340">marshal</span><span class="op" id="3929347">(</span><span class="op" id="3929348">)</span><span class="op" id="3929349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929352"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3929353">.</span><span class="ident" id="3929354">writeRecord</span><span class="op" id="3929365">(</span><span class="ident" id="3929366"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3929385">,</span>&nbsp;<span class="ident" id="3929387"><a href="/crypto/tls/handshake_server.go.html#3929270">helloDone</a></span><span class="op" id="3929396">.</span><span class="ident" id="3929397">marshal</span><span class="op" id="3929404">(</span><span class="op" id="3929405">)</span><span class="op" id="3929406">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929410">var</span>&nbsp;<span class="ident" id="3929414">pub</span>&nbsp;<span class="ident" id="3929418"><a href="/crypto/tls/handshake_server.go.html#3918923">crypto</a></span><span class="op" id="3929424">.</span><span class="ident" id="3929425">PublicKey</span>&nbsp;<span class="comment" id="3929435">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929475">msg</span><span class="op" id="3929478">,</span>&nbsp;<span class="ident" id="3929480"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3929484">:=</span>&nbsp;<span class="ident" id="3929487"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3929488">.</span><span class="ident" id="3929489">readHandshake</span><span class="op" id="3929502">(</span><span class="op" id="3929503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929506">if</span>&nbsp;<span class="ident" id="3929509"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3929513">!=</span>&nbsp;<span class="ident" id="3929516">nil</span>&nbsp;<span class="op" id="3929520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929524">return</span>&nbsp;<span class="ident" id="3929531"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929540">var</span>&nbsp;<span class="ident" id="3929544">ok</span>&nbsp;<span class="builtintype" id="3929547">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929553">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929623">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929668">if</span>&nbsp;<span class="ident" id="3929671"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3929677">.</span><span class="ident" id="3929678">ClientAuth</span>&nbsp;<span class="op" id="3929689">&gt;=</span>&nbsp;<span class="ident" id="3929692"><a href="/crypto/tls/common.go.html#3828304">RequestClientCert</a></span>&nbsp;<span class="op" id="3929710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929714">if</span>&nbsp;<span class="ident" id="3929717"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3929724">,</span>&nbsp;<span class="ident" id="3929726"><a href="/crypto/tls/handshake_server.go.html#3929544">ok</a></span>&nbsp;<span class="op" id="3929729">=</span>&nbsp;<span class="ident" id="3929731"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3929734">.</span><span class="op" id="3929735">(</span><span class="op" id="3929736">*</span><span class="ident" id="3929737"><a href="/crypto/tls/handshake_messages.go.html#3905092">certificateMsg</a></span><span class="op" id="3929751">)</span><span class="op" id="3929752">;</span>&nbsp;<span class="op" id="3929754">!</span><span class="ident" id="3929755"><a href="/crypto/tls/handshake_server.go.html#3929544">ok</a></span>&nbsp;<span class="op" id="3929758">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929763"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3929764">.</span><span class="ident" id="3929765">sendAlert</span><span class="op" id="3929774">(</span><span class="ident" id="3929775"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3929797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929802">return</span>&nbsp;<span class="ident" id="3929809"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3929831">(</span><span class="ident" id="3929832"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3929839">,</span>&nbsp;<span class="ident" id="3929841"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3929844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929852"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3929854">.</span><span class="ident" id="3929855">finishedHash</span><span class="op" id="3929867">.</span><span class="ident" id="3929868">Write</span><span class="op" id="3929873">(</span><span class="ident" id="3929874"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3929881">.</span><span class="ident" id="3929882">marshal</span><span class="op" id="3929889">(</span><span class="op" id="3929890">)</span><span class="op" id="3929891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929896">if</span>&nbsp;<span class="builtinfunc" id="3929899">len</span><span class="op" id="3929902">(</span><span class="ident" id="3929903"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3929910">.</span><span class="ident" id="3929911">certificates</span><span class="op" id="3929923">)</span>&nbsp;<span class="op" id="3929925">==</span>&nbsp;<span class="num" id="3929928">0</span>&nbsp;<span class="op" id="3929930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929935">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929987">switch</span>&nbsp;<span class="ident" id="3929994"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3930000">.</span><span class="ident" id="3930001">ClientAuth</span>&nbsp;<span class="op" id="3930012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930017">case</span>&nbsp;<span class="ident" id="3930022"><a href="/crypto/tls/common.go.html#3828323">RequireAnyClientCert</a></span><span class="op" id="3930042">,</span>&nbsp;<span class="ident" id="3930044"><a href="/crypto/tls/common.go.html#3828370">RequireAndVerifyClientCert</a></span><span class="op" id="3930070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930076"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3930077">.</span><span class="ident" id="3930078">sendAlert</span><span class="op" id="3930087">(</span><span class="ident" id="3930088"><a href="/crypto/tls/alert.go.html#3810868">alertBadCertificate</a></span><span class="op" id="3930107">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930113">return</span>&nbsp;<span class="ident" id="3930120"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3930126">.</span><span class="ident" id="3930127">New</span><span class="op" id="3930130">(</span><span class="string" id="3930131">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3930173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930187"><a href="/crypto/tls/handshake_server.go.html#3929414">pub</a></span><span class="op" id="3930190">,</span>&nbsp;<span class="ident" id="3930192"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3930196">=</span>&nbsp;<span class="ident" id="3930198"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3930200">.</span><span class="ident" id="3930201">processCertsFromClient</span><span class="op" id="3930223">(</span><span class="ident" id="3930224"><a href="/crypto/tls/handshake_server.go.html#3927680">certMsg</a></span><span class="op" id="3930231">.</span><span class="ident" id="3930232">certificates</span><span class="op" id="3930244">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930248">if</span>&nbsp;<span class="ident" id="3930251"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3930255">!=</span>&nbsp;<span class="ident" id="3930258">nil</span>&nbsp;<span class="op" id="3930262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930267">return</span>&nbsp;<span class="ident" id="3930274"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930285"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3930288">,</span>&nbsp;<span class="ident" id="3930290"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3930294">=</span>&nbsp;<span class="ident" id="3930296"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3930297">.</span><span class="ident" id="3930298">readHandshake</span><span class="op" id="3930311">(</span><span class="op" id="3930312">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930316">if</span>&nbsp;<span class="ident" id="3930319"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3930323">!=</span>&nbsp;<span class="ident" id="3930326">nil</span>&nbsp;<span class="op" id="3930330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930335">return</span>&nbsp;<span class="ident" id="3930342"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930355">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930383">ckx</span><span class="op" id="3930386">,</span>&nbsp;<span class="ident" id="3930388"><a href="/crypto/tls/handshake_server.go.html#3929544">ok</a></span>&nbsp;<span class="op" id="3930391">:=</span>&nbsp;<span class="ident" id="3930394"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3930397">.</span><span class="op" id="3930398">(</span><span class="op" id="3930399">*</span><span class="ident" id="3930400"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3930420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930423">if</span>&nbsp;<span class="op" id="3930426">!</span><span class="ident" id="3930427"><a href="/crypto/tls/handshake_server.go.html#3929544">ok</a></span>&nbsp;<span class="op" id="3930430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930434"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3930435">.</span><span class="ident" id="3930436">sendAlert</span><span class="op" id="3930445">(</span><span class="ident" id="3930446"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3930468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930472">return</span>&nbsp;<span class="ident" id="3930479"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3930501">(</span><span class="ident" id="3930502"><a href="/crypto/tls/handshake_server.go.html#3930383">ckx</a></span><span class="op" id="3930505">,</span>&nbsp;<span class="ident" id="3930507"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3930510">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930516"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3930518">.</span><span class="ident" id="3930519">finishedHash</span><span class="op" id="3930531">.</span><span class="ident" id="3930532">Write</span><span class="op" id="3930537">(</span><span class="ident" id="3930538"><a href="/crypto/tls/handshake_server.go.html#3930383">ckx</a></span><span class="op" id="3930541">.</span><span class="ident" id="3930542">marshal</span><span class="op" id="3930549">(</span><span class="op" id="3930550">)</span><span class="op" id="3930551">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930555">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930636">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930709">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930778">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930858">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930938">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930992">if</span>&nbsp;<span class="builtinfunc" id="3930995">len</span><span class="op" id="3930998">(</span><span class="ident" id="3930999"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3931000">.</span><span class="ident" id="3931001">peerCertificates</span><span class="op" id="3931017">)</span>&nbsp;<span class="op" id="3931019">&gt;</span>&nbsp;<span class="num" id="3931021">0</span>&nbsp;<span class="op" id="3931023">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931027"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3931030">,</span>&nbsp;<span class="ident" id="3931032"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931036">=</span>&nbsp;<span class="ident" id="3931038"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3931039">.</span><span class="ident" id="3931040">readHandshake</span><span class="op" id="3931053">(</span><span class="op" id="3931054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931058">if</span>&nbsp;<span class="ident" id="3931061"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931065">!=</span>&nbsp;<span class="ident" id="3931068">nil</span>&nbsp;<span class="op" id="3931072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931077">return</span>&nbsp;<span class="ident" id="3931084"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931094">certVerify</span><span class="op" id="3931104">,</span>&nbsp;<span class="ident" id="3931106">ok</span>&nbsp;<span class="op" id="3931109">:=</span>&nbsp;<span class="ident" id="3931112"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3931115">.</span><span class="op" id="3931116">(</span><span class="op" id="3931117">*</span><span class="ident" id="3931118"><a href="/crypto/tls/handshake_messages.go.html#3915062">certificateVerifyMsg</a></span><span class="op" id="3931138">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931142">if</span>&nbsp;<span class="op" id="3931145">!</span><span class="ident" id="3931146"><a href="/crypto/tls/handshake_server.go.html#3931106">ok</a></span>&nbsp;<span class="op" id="3931149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931154"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3931155">.</span><span class="ident" id="3931156">sendAlert</span><span class="op" id="3931165">(</span><span class="ident" id="3931166"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3931188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931193">return</span>&nbsp;<span class="ident" id="3931200"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3931222">(</span><span class="ident" id="3931223"><a href="/crypto/tls/handshake_server.go.html#3931094">certVerify</a></span><span class="op" id="3931233">,</span>&nbsp;<span class="ident" id="3931235"><a href="/crypto/tls/handshake_server.go.html#3929475">msg</a></span><span class="op" id="3931238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931247">switch</span>&nbsp;<span class="ident" id="3931254">key</span>&nbsp;<span class="op" id="3931258">:=</span>&nbsp;<span class="ident" id="3931261"><a href="/crypto/tls/handshake_server.go.html#3929414">pub</a></span><span class="op" id="3931264">.</span><span class="op" id="3931265">(</span><span class="keyword" id="3931266">type</span><span class="op" id="3931270">)</span>&nbsp;<span class="op" id="3931272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931276">case</span>&nbsp;<span class="op" id="3931281">*</span><span class="ident" id="3931282"><a href="/crypto/tls/handshake_server.go.html#3918933">ecdsa</a></span><span class="op" id="3931287">.</span><span class="ident" id="3931288">PublicKey</span><span class="op" id="3931297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931302">ecdsaSig</span>&nbsp;<span class="op" id="3931311">:=</span>&nbsp;<span class="builtinfunc" id="3931314">new</span><span class="op" id="3931317">(</span><span class="ident" id="3931318"><a href="/crypto/tls/common.go.html#3841172">ecdsaSignature</a></span><span class="op" id="3931332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931337">if</span>&nbsp;<span class="ident" id="3931340">_</span><span class="op" id="3931341">,</span>&nbsp;<span class="ident" id="3931343"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931347">=</span>&nbsp;<span class="ident" id="3931349"><a href="/crypto/tls/handshake_server.go.html#3918995">asn1</a></span><span class="op" id="3931353">.</span><span class="ident" id="3931354">Unmarshal</span><span class="op" id="3931363">(</span><span class="ident" id="3931364"><a href="/crypto/tls/handshake_server.go.html#3931094">certVerify</a></span><span class="op" id="3931374">.</span><span class="ident" id="3931375">signature</span><span class="op" id="3931384">,</span>&nbsp;<span class="ident" id="3931386"><a href="/crypto/tls/handshake_server.go.html#3931302">ecdsaSig</a></span><span class="op" id="3931394">)</span><span class="op" id="3931395">;</span>&nbsp;<span class="ident" id="3931397"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931401">!=</span>&nbsp;<span class="ident" id="3931404">nil</span>&nbsp;<span class="op" id="3931408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931414">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931428">if</span>&nbsp;<span class="ident" id="3931431"><a href="/crypto/tls/handshake_server.go.html#3931302">ecdsaSig</a></span><span class="op" id="3931439">.</span><span class="ident" id="3931440">R</span><span class="op" id="3931441">.</span><span class="ident" id="3931442">Sign</span><span class="op" id="3931446">(</span><span class="op" id="3931447">)</span>&nbsp;<span class="op" id="3931449">&lt;=</span>&nbsp;<span class="num" id="3931452">0</span>&nbsp;<span class="op" id="3931454">||</span>&nbsp;<span class="ident" id="3931457"><a href="/crypto/tls/handshake_server.go.html#3931302">ecdsaSig</a></span><span class="op" id="3931465">.</span><span class="ident" id="3931466">S</span><span class="op" id="3931467">.</span><span class="ident" id="3931468">Sign</span><span class="op" id="3931472">(</span><span class="op" id="3931473">)</span>&nbsp;<span class="op" id="3931475">&lt;=</span>&nbsp;<span class="num" id="3931478">0</span>&nbsp;<span class="op" id="3931480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931486"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931490">=</span>&nbsp;<span class="ident" id="3931492"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3931498">.</span><span class="ident" id="3931499">New</span><span class="op" id="3931502">(</span><span class="string" id="3931503">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3931554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931560">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931569">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931574">digest</span><span class="op" id="3931580">,</span>&nbsp;<span class="ident" id="3931582">_</span><span class="op" id="3931583">,</span>&nbsp;<span class="ident" id="3931585">_</span>&nbsp;<span class="op" id="3931587">:=</span>&nbsp;<span class="ident" id="3931590"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3931592">.</span><span class="ident" id="3931593">finishedHash</span><span class="op" id="3931605">.</span><span class="ident" id="3931606">hashForClientCertificate</span><span class="op" id="3931630">(</span><span class="ident" id="3931631"><a href="/crypto/tls/common.go.html#3825950">signatureECDSA</a></span><span class="op" id="3931645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931650">if</span>&nbsp;<span class="op" id="3931653">!</span><span class="ident" id="3931654"><a href="/crypto/tls/handshake_server.go.html#3918933">ecdsa</a></span><span class="op" id="3931659">.</span><span class="ident" id="3931660">Verify</span><span class="op" id="3931666">(</span><span class="ident" id="3931667"><a href="/crypto/tls/handshake_server.go.html#3931254">key</a></span><span class="op" id="3931670">,</span>&nbsp;<span class="ident" id="3931672"><a href="/crypto/tls/handshake_server.go.html#3931574">digest</a></span><span class="op" id="3931678">,</span>&nbsp;<span class="ident" id="3931680"><a href="/crypto/tls/handshake_server.go.html#3931302">ecdsaSig</a></span><span class="op" id="3931688">.</span><span class="ident" id="3931689">R</span><span class="op" id="3931690">,</span>&nbsp;<span class="ident" id="3931692"><a href="/crypto/tls/handshake_server.go.html#3931302">ecdsaSig</a></span><span class="op" id="3931700">.</span><span class="ident" id="3931701">S</span><span class="op" id="3931702">)</span>&nbsp;<span class="op" id="3931704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931710"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931714">=</span>&nbsp;<span class="ident" id="3931716"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3931722">.</span><span class="ident" id="3931723">New</span><span class="op" id="3931726">(</span><span class="string" id="3931727">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3931755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931761">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931770">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931774">case</span>&nbsp;<span class="op" id="3931779">*</span><span class="ident" id="3931780"><a href="/crypto/tls/handshake_server.go.html#3918949">rsa</a></span><span class="op" id="3931783">.</span><span class="ident" id="3931784">PublicKey</span><span class="op" id="3931793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931798">digest</span><span class="op" id="3931804">,</span>&nbsp;<span class="ident" id="3931806">hashFunc</span><span class="op" id="3931814">,</span>&nbsp;<span class="ident" id="3931816">_</span>&nbsp;<span class="op" id="3931818">:=</span>&nbsp;<span class="ident" id="3931821"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3931823">.</span><span class="ident" id="3931824">finishedHash</span><span class="op" id="3931836">.</span><span class="ident" id="3931837">hashForClientCertificate</span><span class="op" id="3931861">(</span><span class="ident" id="3931862"><a href="/crypto/tls/common.go.html#3825924">signatureRSA</a></span><span class="op" id="3931874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931879"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931883">=</span>&nbsp;<span class="ident" id="3931885"><a href="/crypto/tls/handshake_server.go.html#3918949">rsa</a></span><span class="op" id="3931888">.</span><span class="ident" id="3931889">VerifyPKCS1v15</span><span class="op" id="3931903">(</span><span class="ident" id="3931904"><a href="/crypto/tls/handshake_server.go.html#3931254">key</a></span><span class="op" id="3931907">,</span>&nbsp;<span class="ident" id="3931909"><a href="/crypto/tls/handshake_server.go.html#3931806">hashFunc</a></span><span class="op" id="3931917">,</span>&nbsp;<span class="ident" id="3931919"><a href="/crypto/tls/handshake_server.go.html#3931798">digest</a></span><span class="op" id="3931925">,</span>&nbsp;<span class="ident" id="3931927"><a href="/crypto/tls/handshake_server.go.html#3931094">certVerify</a></span><span class="op" id="3931937">.</span><span class="ident" id="3931938">signature</span><span class="op" id="3931947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931955">if</span>&nbsp;<span class="ident" id="3931958"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3931962">!=</span>&nbsp;<span class="ident" id="3931965">nil</span>&nbsp;<span class="op" id="3931969">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931974"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3931975">.</span><span class="ident" id="3931976">sendAlert</span><span class="op" id="3931985">(</span><span class="ident" id="3931986"><a href="/crypto/tls/alert.go.html#3810868">alertBadCertificate</a></span><span class="op" id="3932005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932010">return</span>&nbsp;<span class="ident" id="3932017"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3932023">.</span><span class="ident" id="3932024">New</span><span class="op" id="3932027">(</span><span class="string" id="3932028">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3932082">+</span>&nbsp;<span class="ident" id="3932084"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><span class="op" id="3932087">.</span><span class="ident" id="3932088">Error</span><span class="op" id="3932093">(</span><span class="op" id="3932094">)</span><span class="op" id="3932095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932104"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3932106">.</span><span class="ident" id="3932107">finishedHash</span><span class="op" id="3932119">.</span><span class="ident" id="3932120">Write</span><span class="op" id="3932125">(</span><span class="ident" id="3932126"><a href="/crypto/tls/handshake_server.go.html#3931094">certVerify</a></span><span class="op" id="3932136">.</span><span class="ident" id="3932137">marshal</span><span class="op" id="3932144">(</span><span class="op" id="3932145">)</span><span class="op" id="3932146">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932153">preMasterSecret</span><span class="op" id="3932168">,</span>&nbsp;<span class="ident" id="3932170"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3932174">:=</span>&nbsp;<span class="ident" id="3932177"><a href="/crypto/tls/handshake_server.go.html#3928117">keyAgreement</a></span><span class="op" id="3932189">.</span><span class="ident" id="3932190">processClientKeyExchange</span><span class="op" id="3932214">(</span><span class="ident" id="3932215"><a href="/crypto/tls/handshake_server.go.html#3927316">config</a></span><span class="op" id="3932221">,</span>&nbsp;<span class="ident" id="3932223"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3932225">.</span><span class="ident" id="3932226">cert</span><span class="op" id="3932230">,</span>&nbsp;<span class="ident" id="3932232"><a href="/crypto/tls/handshake_server.go.html#3930383">ckx</a></span><span class="op" id="3932235">,</span>&nbsp;<span class="ident" id="3932237"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3932238">.</span><span class="ident" id="3932239">vers</span><span class="op" id="3932243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932246">if</span>&nbsp;<span class="ident" id="3932249"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span>&nbsp;<span class="op" id="3932253">!=</span>&nbsp;<span class="ident" id="3932256">nil</span>&nbsp;<span class="op" id="3932260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932264"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3932265">.</span><span class="ident" id="3932266">sendAlert</span><span class="op" id="3932275">(</span><span class="ident" id="3932276"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3932297">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932301">return</span>&nbsp;<span class="ident" id="3932308"><a href="/crypto/tls/handshake_server.go.html#3928159">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932316"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3932318">.</span><span class="ident" id="3932319">masterSecret</span>&nbsp;<span class="op" id="3932332">=</span>&nbsp;<span class="ident" id="3932334"><a href="/crypto/tls/prf.go.html#3954335">masterFromPreMasterSecret</a></span><span class="op" id="3932359">(</span><span class="ident" id="3932360"><a href="/crypto/tls/handshake_server.go.html#3927339">c</a></span><span class="op" id="3932361">.</span><span class="ident" id="3932362">vers</span><span class="op" id="3932366">,</span>&nbsp;<span class="ident" id="3932368"><a href="/crypto/tls/handshake_server.go.html#3932153">preMasterSecret</a></span><span class="op" id="3932383">,</span>&nbsp;<span class="ident" id="3932385"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3932387">.</span><span class="ident" id="3932388">clientHello</span><span class="op" id="3932399">.</span><span class="ident" id="3932400">random</span><span class="op" id="3932406">,</span>&nbsp;<span class="ident" id="3932408"><a href="/crypto/tls/handshake_server.go.html#3927263">hs</a></span><span class="op" id="3932410">.</span><span class="ident" id="3932411">hello</span><span class="op" id="3932416">.</span><span class="ident" id="3932417">random</span><span class="op" id="3932423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932427">return</span>&nbsp;<span class="ident" id="3932434">nil</span><br>
<span class="lineno">475</span><span class="op" id="3932438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3932441">func</span>&nbsp;<span class="op" id="3932446">(</span><span class="ident" id="3932447">hs</span>&nbsp;<span class="op" id="3932450">*</span><span class="ident" id="3932451"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3932471">)</span>&nbsp;<span class="ident" id="3932473">establishKeys</span><span class="op" id="3932486">(</span><span class="op" id="3932487">)</span>&nbsp;<span class="builtintype" id="3932489">error</span>&nbsp;<span class="op" id="3932495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932498">c</span>&nbsp;<span class="op" id="3932500">:=</span>&nbsp;<span class="ident" id="3932503"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932505">.</span><span class="ident" id="3932506">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932510">clientMAC</span><span class="op" id="3932519">,</span>&nbsp;<span class="ident" id="3932521">serverMAC</span><span class="op" id="3932530">,</span>&nbsp;<span class="ident" id="3932532">clientKey</span><span class="op" id="3932541">,</span>&nbsp;<span class="ident" id="3932543">serverKey</span><span class="op" id="3932552">,</span>&nbsp;<span class="ident" id="3932554">clientIV</span><span class="op" id="3932562">,</span>&nbsp;<span class="ident" id="3932564">serverIV</span>&nbsp;<span class="op" id="3932573">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932578"><a href="/crypto/tls/prf.go.html#3954904">keysFromMasterSecret</a></span><span class="op" id="3932598">(</span><span class="ident" id="3932599"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3932600">.</span><span class="ident" id="3932601">vers</span><span class="op" id="3932605">,</span>&nbsp;<span class="ident" id="3932607"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932609">.</span><span class="ident" id="3932610">masterSecret</span><span class="op" id="3932622">,</span>&nbsp;<span class="ident" id="3932624"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932626">.</span><span class="ident" id="3932627">clientHello</span><span class="op" id="3932638">.</span><span class="ident" id="3932639">random</span><span class="op" id="3932645">,</span>&nbsp;<span class="ident" id="3932647"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932649">.</span><span class="ident" id="3932650">hello</span><span class="op" id="3932655">.</span><span class="ident" id="3932656">random</span><span class="op" id="3932662">,</span>&nbsp;<span class="ident" id="3932664"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932666">.</span><span class="ident" id="3932667">suite</span><span class="op" id="3932672">.</span><span class="ident" id="3932673">macLen</span><span class="op" id="3932679">,</span>&nbsp;<span class="ident" id="3932681"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932683">.</span><span class="ident" id="3932684">suite</span><span class="op" id="3932689">.</span><span class="ident" id="3932690">keyLen</span><span class="op" id="3932696">,</span>&nbsp;<span class="ident" id="3932698"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932700">.</span><span class="ident" id="3932701">suite</span><span class="op" id="3932706">.</span><span class="ident" id="3932707">ivLen</span><span class="op" id="3932712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932716">var</span>&nbsp;<span class="ident" id="3932720">clientCipher</span><span class="op" id="3932732">,</span>&nbsp;<span class="ident" id="3932734">serverCipher</span>&nbsp;<span class="keyword" id="3932747">interface</span><span class="op" id="3932756">{</span><span class="op" id="3932757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932760">var</span>&nbsp;<span class="ident" id="3932764">clientHash</span><span class="op" id="3932774">,</span>&nbsp;<span class="ident" id="3932776">serverHash</span>&nbsp;<span class="ident" id="3932787"><a href="/crypto/tls/cipher_suites.go.html#3817704">macFunction</a></span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932801">if</span>&nbsp;<span class="ident" id="3932804"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932806">.</span><span class="ident" id="3932807">suite</span><span class="op" id="3932812">.</span><span class="ident" id="3932813">aead</span>&nbsp;<span class="op" id="3932818">==</span>&nbsp;<span class="ident" id="3932821">nil</span>&nbsp;<span class="op" id="3932825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932829"><a href="/crypto/tls/handshake_server.go.html#3932720">clientCipher</a></span>&nbsp;<span class="op" id="3932842">=</span>&nbsp;<span class="ident" id="3932844"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932846">.</span><span class="ident" id="3932847">suite</span><span class="op" id="3932852">.</span><span class="ident" id="3932853">cipher</span><span class="op" id="3932859">(</span><span class="ident" id="3932860"><a href="/crypto/tls/handshake_server.go.html#3932532">clientKey</a></span><span class="op" id="3932869">,</span>&nbsp;<span class="ident" id="3932871"><a href="/crypto/tls/handshake_server.go.html#3932554">clientIV</a></span><span class="op" id="3932879">,</span>&nbsp;<span class="builtintype" id="3932881">true</span>&nbsp;<span class="comment" id="3932886">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3932903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932907"><a href="/crypto/tls/handshake_server.go.html#3932764">clientHash</a></span>&nbsp;<span class="op" id="3932918">=</span>&nbsp;<span class="ident" id="3932920"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932922">.</span><span class="ident" id="3932923">suite</span><span class="op" id="3932928">.</span><span class="ident" id="3932929">mac</span><span class="op" id="3932932">(</span><span class="ident" id="3932933"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3932934">.</span><span class="ident" id="3932935">vers</span><span class="op" id="3932939">,</span>&nbsp;<span class="ident" id="3932941"><a href="/crypto/tls/handshake_server.go.html#3932510">clientMAC</a></span><span class="op" id="3932950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932954"><a href="/crypto/tls/handshake_server.go.html#3932734">serverCipher</a></span>&nbsp;<span class="op" id="3932967">=</span>&nbsp;<span class="ident" id="3932969"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3932971">.</span><span class="ident" id="3932972">suite</span><span class="op" id="3932977">.</span><span class="ident" id="3932978">cipher</span><span class="op" id="3932984">(</span><span class="ident" id="3932985"><a href="/crypto/tls/handshake_server.go.html#3932543">serverKey</a></span><span class="op" id="3932994">,</span>&nbsp;<span class="ident" id="3932996"><a href="/crypto/tls/handshake_server.go.html#3932564">serverIV</a></span><span class="op" id="3933004">,</span>&nbsp;<span class="builtintype" id="3933006">false</span>&nbsp;<span class="comment" id="3933012">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3933033">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933037"><a href="/crypto/tls/handshake_server.go.html#3932776">serverHash</a></span>&nbsp;<span class="op" id="3933048">=</span>&nbsp;<span class="ident" id="3933050"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3933052">.</span><span class="ident" id="3933053">suite</span><span class="op" id="3933058">.</span><span class="ident" id="3933059">mac</span><span class="op" id="3933062">(</span><span class="ident" id="3933063"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3933064">.</span><span class="ident" id="3933065">vers</span><span class="op" id="3933069">,</span>&nbsp;<span class="ident" id="3933071"><a href="/crypto/tls/handshake_server.go.html#3932521">serverMAC</a></span><span class="op" id="3933080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933083">}</span>&nbsp;<span class="keyword" id="3933085">else</span>&nbsp;<span class="op" id="3933090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933094"><a href="/crypto/tls/handshake_server.go.html#3932720">clientCipher</a></span>&nbsp;<span class="op" id="3933107">=</span>&nbsp;<span class="ident" id="3933109"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3933111">.</span><span class="ident" id="3933112">suite</span><span class="op" id="3933117">.</span><span class="ident" id="3933118">aead</span><span class="op" id="3933122">(</span><span class="ident" id="3933123"><a href="/crypto/tls/handshake_server.go.html#3932532">clientKey</a></span><span class="op" id="3933132">,</span>&nbsp;<span class="ident" id="3933134"><a href="/crypto/tls/handshake_server.go.html#3932554">clientIV</a></span><span class="op" id="3933142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933146"><a href="/crypto/tls/handshake_server.go.html#3932734">serverCipher</a></span>&nbsp;<span class="op" id="3933159">=</span>&nbsp;<span class="ident" id="3933161"><a href="/crypto/tls/handshake_server.go.html#3932447">hs</a></span><span class="op" id="3933163">.</span><span class="ident" id="3933164">suite</span><span class="op" id="3933169">.</span><span class="ident" id="3933170">aead</span><span class="op" id="3933174">(</span><span class="ident" id="3933175"><a href="/crypto/tls/handshake_server.go.html#3932543">serverKey</a></span><span class="op" id="3933184">,</span>&nbsp;<span class="ident" id="3933186"><a href="/crypto/tls/handshake_server.go.html#3932564">serverIV</a></span><span class="op" id="3933194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933197">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933201"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3933202">.</span><span class="ident" id="3933203">in</span><span class="op" id="3933205">.</span><span class="ident" id="3933206">prepareCipherSpec</span><span class="op" id="3933223">(</span><span class="ident" id="3933224"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3933225">.</span><span class="ident" id="3933226">vers</span><span class="op" id="3933230">,</span>&nbsp;<span class="ident" id="3933232"><a href="/crypto/tls/handshake_server.go.html#3932720">clientCipher</a></span><span class="op" id="3933244">,</span>&nbsp;<span class="ident" id="3933246"><a href="/crypto/tls/handshake_server.go.html#3932764">clientHash</a></span><span class="op" id="3933256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933259"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3933260">.</span><span class="ident" id="3933261">out</span><span class="op" id="3933264">.</span><span class="ident" id="3933265">prepareCipherSpec</span><span class="op" id="3933282">(</span><span class="ident" id="3933283"><a href="/crypto/tls/handshake_server.go.html#3932498">c</a></span><span class="op" id="3933284">.</span><span class="ident" id="3933285">vers</span><span class="op" id="3933289">,</span>&nbsp;<span class="ident" id="3933291"><a href="/crypto/tls/handshake_server.go.html#3932734">serverCipher</a></span><span class="op" id="3933303">,</span>&nbsp;<span class="ident" id="3933305"><a href="/crypto/tls/handshake_server.go.html#3932776">serverHash</a></span><span class="op" id="3933315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933319">return</span>&nbsp;<span class="ident" id="3933326">nil</span><br>
<span class="lineno">500</span><span class="op" id="3933330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3933333">func</span>&nbsp;<span class="op" id="3933338">(</span><span class="ident" id="3933339">hs</span>&nbsp;<span class="op" id="3933342">*</span><span class="ident" id="3933343"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3933363">)</span>&nbsp;<span class="ident" id="3933365">readFinished</span><span class="op" id="3933377">(</span><span class="ident" id="3933378">out</span>&nbsp;<span class="op" id="3933382">[</span><span class="op" id="3933383">]</span><span class="builtintype" id="3933384">byte</span><span class="op" id="3933388">)</span>&nbsp;<span class="builtintype" id="3933390">error</span>&nbsp;<span class="op" id="3933396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933399">c</span>&nbsp;<span class="op" id="3933401">:=</span>&nbsp;<span class="ident" id="3933404"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3933406">.</span><span class="ident" id="3933407">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933411"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933412">.</span><span class="ident" id="3933413">readRecord</span><span class="op" id="3933423">(</span><span class="ident" id="3933424"><a href="/crypto/tls/common.go.html#3823266">recordTypeChangeCipherSpec</a></span><span class="op" id="3933450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933453">if</span>&nbsp;<span class="ident" id="3933456">err</span>&nbsp;<span class="op" id="3933460">:=</span>&nbsp;<span class="ident" id="3933463"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933464">.</span><span class="ident" id="3933465">in</span><span class="op" id="3933467">.</span><span class="builtintype" id="3933468">error</span><span class="op" id="3933473">(</span><span class="op" id="3933474">)</span><span class="op" id="3933475">;</span>&nbsp;<span class="ident" id="3933477"><a href="/crypto/tls/handshake_server.go.html#3933456">err</a></span>&nbsp;<span class="op" id="3933481">!=</span>&nbsp;<span class="ident" id="3933484">nil</span>&nbsp;<span class="op" id="3933488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933492">return</span>&nbsp;<span class="ident" id="3933499"><a href="/crypto/tls/handshake_server.go.html#3933456">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933508">if</span>&nbsp;<span class="ident" id="3933511"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3933513">.</span><span class="ident" id="3933514">hello</span><span class="op" id="3933519">.</span><span class="ident" id="3933520">nextProtoNeg</span>&nbsp;<span class="op" id="3933533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933537">msg</span><span class="op" id="3933540">,</span>&nbsp;<span class="ident" id="3933542">err</span>&nbsp;<span class="op" id="3933546">:=</span>&nbsp;<span class="ident" id="3933549"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933550">.</span><span class="ident" id="3933551">readHandshake</span><span class="op" id="3933564">(</span><span class="op" id="3933565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933569">if</span>&nbsp;<span class="ident" id="3933572"><a href="/crypto/tls/handshake_server.go.html#3933542">err</a></span>&nbsp;<span class="op" id="3933576">!=</span>&nbsp;<span class="ident" id="3933579">nil</span>&nbsp;<span class="op" id="3933583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933588">return</span>&nbsp;<span class="ident" id="3933595"><a href="/crypto/tls/handshake_server.go.html#3933542">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933601">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933605">nextProto</span><span class="op" id="3933614">,</span>&nbsp;<span class="ident" id="3933616">ok</span>&nbsp;<span class="op" id="3933619">:=</span>&nbsp;<span class="ident" id="3933622"><a href="/crypto/tls/handshake_server.go.html#3933537">msg</a></span><span class="op" id="3933625">.</span><span class="op" id="3933626">(</span><span class="op" id="3933627">*</span><span class="ident" id="3933628"><a href="/crypto/tls/handshake_messages.go.html#3910552">nextProtoMsg</a></span><span class="op" id="3933640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933644">if</span>&nbsp;<span class="op" id="3933647">!</span><span class="ident" id="3933648"><a href="/crypto/tls/handshake_server.go.html#3933616">ok</a></span>&nbsp;<span class="op" id="3933651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933656"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933657">.</span><span class="ident" id="3933658">sendAlert</span><span class="op" id="3933667">(</span><span class="ident" id="3933668"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3933690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933695">return</span>&nbsp;<span class="ident" id="3933702"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3933724">(</span><span class="ident" id="3933725"><a href="/crypto/tls/handshake_server.go.html#3933605">nextProto</a></span><span class="op" id="3933734">,</span>&nbsp;<span class="ident" id="3933736"><a href="/crypto/tls/handshake_server.go.html#3933537">msg</a></span><span class="op" id="3933739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933743">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933747"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3933749">.</span><span class="ident" id="3933750">finishedHash</span><span class="op" id="3933762">.</span><span class="ident" id="3933763">Write</span><span class="op" id="3933768">(</span><span class="ident" id="3933769"><a href="/crypto/tls/handshake_server.go.html#3933605">nextProto</a></span><span class="op" id="3933778">.</span><span class="ident" id="3933779">marshal</span><span class="op" id="3933786">(</span><span class="op" id="3933787">)</span><span class="op" id="3933788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933792"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933793">.</span><span class="ident" id="3933794">clientProtocol</span>&nbsp;<span class="op" id="3933809">=</span>&nbsp;<span class="ident" id="3933811"><a href="/crypto/tls/handshake_server.go.html#3933605">nextProto</a></span><span class="op" id="3933820">.</span><span class="ident" id="3933821">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933832">msg</span><span class="op" id="3933835">,</span>&nbsp;<span class="ident" id="3933837">err</span>&nbsp;<span class="op" id="3933841">:=</span>&nbsp;<span class="ident" id="3933844"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933845">.</span><span class="ident" id="3933846">readHandshake</span><span class="op" id="3933859">(</span><span class="op" id="3933860">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933863">if</span>&nbsp;<span class="ident" id="3933866"><a href="/crypto/tls/handshake_server.go.html#3933837">err</a></span>&nbsp;<span class="op" id="3933870">!=</span>&nbsp;<span class="ident" id="3933873">nil</span>&nbsp;<span class="op" id="3933877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933881">return</span>&nbsp;<span class="ident" id="3933888"><a href="/crypto/tls/handshake_server.go.html#3933837">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933896">clientFinished</span><span class="op" id="3933910">,</span>&nbsp;<span class="ident" id="3933912">ok</span>&nbsp;<span class="op" id="3933915">:=</span>&nbsp;<span class="ident" id="3933918"><a href="/crypto/tls/handshake_server.go.html#3933832">msg</a></span><span class="op" id="3933921">.</span><span class="op" id="3933922">(</span><span class="op" id="3933923">*</span><span class="ident" id="3933924"><a href="/crypto/tls/handshake_messages.go.html#3909925">finishedMsg</a></span><span class="op" id="3933935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933938">if</span>&nbsp;<span class="op" id="3933941">!</span><span class="ident" id="3933942"><a href="/crypto/tls/handshake_server.go.html#3933912">ok</a></span>&nbsp;<span class="op" id="3933945">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933949"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3933950">.</span><span class="ident" id="3933951">sendAlert</span><span class="op" id="3933960">(</span><span class="ident" id="3933961"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3933983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933987">return</span>&nbsp;<span class="ident" id="3933994"><a href="/crypto/tls/common.go.html#3841643">unexpectedMessageError</a></span><span class="op" id="3934016">(</span><span class="ident" id="3934017"><a href="/crypto/tls/handshake_server.go.html#3933896">clientFinished</a></span><span class="op" id="3934031">,</span>&nbsp;<span class="ident" id="3934033"><a href="/crypto/tls/handshake_server.go.html#3933832">msg</a></span><span class="op" id="3934036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934043">verify</span>&nbsp;<span class="op" id="3934050">:=</span>&nbsp;<span class="ident" id="3934053"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3934055">.</span><span class="ident" id="3934056">finishedHash</span><span class="op" id="3934068">.</span><span class="ident" id="3934069">clientSum</span><span class="op" id="3934078">(</span><span class="ident" id="3934079"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3934081">.</span><span class="ident" id="3934082">masterSecret</span><span class="op" id="3934094">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934097">if</span>&nbsp;<span class="builtinfunc" id="3934100">len</span><span class="op" id="3934103">(</span><span class="ident" id="3934104"><a href="/crypto/tls/handshake_server.go.html#3934043">verify</a></span><span class="op" id="3934110">)</span>&nbsp;<span class="op" id="3934112">!=</span>&nbsp;<span class="builtinfunc" id="3934115">len</span><span class="op" id="3934118">(</span><span class="ident" id="3934119"><a href="/crypto/tls/handshake_server.go.html#3933896">clientFinished</a></span><span class="op" id="3934133">.</span><span class="ident" id="3934134">verifyData</span><span class="op" id="3934144">)</span>&nbsp;<span class="op" id="3934146">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934151"><a href="/crypto/tls/handshake_server.go.html#3918963">subtle</a></span><span class="op" id="3934157">.</span><span class="ident" id="3934158">ConstantTimeCompare</span><span class="op" id="3934177">(</span><span class="ident" id="3934178"><a href="/crypto/tls/handshake_server.go.html#3934043">verify</a></span><span class="op" id="3934184">,</span>&nbsp;<span class="ident" id="3934186"><a href="/crypto/tls/handshake_server.go.html#3933896">clientFinished</a></span><span class="op" id="3934200">.</span><span class="ident" id="3934201">verifyData</span><span class="op" id="3934211">)</span>&nbsp;<span class="op" id="3934213">!=</span>&nbsp;<span class="num" id="3934216">1</span>&nbsp;<span class="op" id="3934218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934222"><a href="/crypto/tls/handshake_server.go.html#3933399">c</a></span><span class="op" id="3934223">.</span><span class="ident" id="3934224">sendAlert</span><span class="op" id="3934233">(</span><span class="ident" id="3934234"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3934255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934259">return</span>&nbsp;<span class="ident" id="3934266"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3934272">.</span><span class="ident" id="3934273">New</span><span class="op" id="3934276">(</span><span class="string" id="3934277">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3934322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934325">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934329"><a href="/crypto/tls/handshake_server.go.html#3933339">hs</a></span><span class="op" id="3934331">.</span><span class="ident" id="3934332">finishedHash</span><span class="op" id="3934344">.</span><span class="ident" id="3934345">Write</span><span class="op" id="3934350">(</span><span class="ident" id="3934351"><a href="/crypto/tls/handshake_server.go.html#3933896">clientFinished</a></span><span class="op" id="3934365">.</span><span class="ident" id="3934366">marshal</span><span class="op" id="3934373">(</span><span class="op" id="3934374">)</span><span class="op" id="3934375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3934378">copy</span><span class="op" id="3934382">(</span><span class="ident" id="3934383"><a href="/crypto/tls/handshake_server.go.html#3933378">out</a></span><span class="op" id="3934386">,</span>&nbsp;<span class="ident" id="3934388"><a href="/crypto/tls/handshake_server.go.html#3934043">verify</a></span><span class="op" id="3934394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934397">return</span>&nbsp;<span class="ident" id="3934404">nil</span><br>
<span class="lineno"></span><span class="op" id="3934408">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3934411">func</span>&nbsp;<span class="op" id="3934416">(</span><span class="ident" id="3934417">hs</span>&nbsp;<span class="op" id="3934420">*</span><span class="ident" id="3934421"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3934441">)</span>&nbsp;<span class="ident" id="3934443">sendSessionTicket</span><span class="op" id="3934460">(</span><span class="op" id="3934461">)</span>&nbsp;<span class="builtintype" id="3934463">error</span>&nbsp;<span class="op" id="3934469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934472">if</span>&nbsp;<span class="op" id="3934475">!</span><span class="ident" id="3934476"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934478">.</span><span class="ident" id="3934479">hello</span><span class="op" id="3934484">.</span><span class="ident" id="3934485">ticketSupported</span>&nbsp;<span class="op" id="3934501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934505">return</span>&nbsp;<span class="ident" id="3934512">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934517">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934521">c</span>&nbsp;<span class="op" id="3934523">:=</span>&nbsp;<span class="ident" id="3934526"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934528">.</span><span class="ident" id="3934529">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934532">m</span>&nbsp;<span class="op" id="3934534">:=</span>&nbsp;<span class="builtinfunc" id="3934537">new</span><span class="op" id="3934540">(</span><span class="ident" id="3934541"><a href="/crypto/tls/handshake_messages.go.html#3916789">newSessionTicketMsg</a></span><span class="op" id="3934560">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934564">var</span>&nbsp;<span class="ident" id="3934568">err</span>&nbsp;<span class="builtintype" id="3934572">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934579">state</span>&nbsp;<span class="op" id="3934585">:=</span>&nbsp;<span class="ident" id="3934588"><a href="/crypto/tls/ticket.go.html#3959716">sessionState</a></span><span class="op" id="3934600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934604">vers</span><span class="op" id="3934608">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934618"><a href="/crypto/tls/handshake_server.go.html#3934521">c</a></span><span class="op" id="3934619">.</span><span class="ident" id="3934620">vers</span><span class="op" id="3934624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934628">cipherSuite</span><span class="op" id="3934639">:</span>&nbsp;&nbsp;<span class="ident" id="3934642"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934644">.</span><span class="ident" id="3934645">suite</span><span class="op" id="3934650">.</span><span class="ident" id="3934651">id</span><span class="op" id="3934653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934657">masterSecret</span><span class="op" id="3934669">:</span>&nbsp;<span class="ident" id="3934671"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934673">.</span><span class="ident" id="3934674">masterSecret</span><span class="op" id="3934686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934690">certificates</span><span class="op" id="3934702">:</span>&nbsp;<span class="ident" id="3934704"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934706">.</span><span class="ident" id="3934707">certsFromClient</span><span class="op" id="3934722">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934728"><a href="/crypto/tls/handshake_server.go.html#3934532">m</a></span><span class="op" id="3934729">.</span><span class="ident" id="3934730">ticket</span><span class="op" id="3934736">,</span>&nbsp;<span class="ident" id="3934738"><a href="/crypto/tls/handshake_server.go.html#3934568">err</a></span>&nbsp;<span class="op" id="3934742">=</span>&nbsp;<span class="ident" id="3934744"><a href="/crypto/tls/handshake_server.go.html#3934521">c</a></span><span class="op" id="3934745">.</span><span class="ident" id="3934746">encryptTicket</span><span class="op" id="3934759">(</span><span class="op" id="3934760">&amp;</span><span class="ident" id="3934761"><a href="/crypto/tls/handshake_server.go.html#3934579">state</a></span><span class="op" id="3934766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934769">if</span>&nbsp;<span class="ident" id="3934772"><a href="/crypto/tls/handshake_server.go.html#3934568">err</a></span>&nbsp;<span class="op" id="3934776">!=</span>&nbsp;<span class="ident" id="3934779">nil</span>&nbsp;<span class="op" id="3934783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934787">return</span>&nbsp;<span class="ident" id="3934794"><a href="/crypto/tls/handshake_server.go.html#3934568">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934799">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934803"><a href="/crypto/tls/handshake_server.go.html#3934417">hs</a></span><span class="op" id="3934805">.</span><span class="ident" id="3934806">finishedHash</span><span class="op" id="3934818">.</span><span class="ident" id="3934819">Write</span><span class="op" id="3934824">(</span><span class="ident" id="3934825"><a href="/crypto/tls/handshake_server.go.html#3934532">m</a></span><span class="op" id="3934826">.</span><span class="ident" id="3934827">marshal</span><span class="op" id="3934834">(</span><span class="op" id="3934835">)</span><span class="op" id="3934836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934839"><a href="/crypto/tls/handshake_server.go.html#3934521">c</a></span><span class="op" id="3934840">.</span><span class="ident" id="3934841">writeRecord</span><span class="op" id="3934852">(</span><span class="ident" id="3934853"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3934872">,</span>&nbsp;<span class="ident" id="3934874"><a href="/crypto/tls/handshake_server.go.html#3934532">m</a></span><span class="op" id="3934875">.</span><span class="ident" id="3934876">marshal</span><span class="op" id="3934883">(</span><span class="op" id="3934884">)</span><span class="op" id="3934885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934889">return</span>&nbsp;<span class="ident" id="3934896">nil</span><br>
<span class="lineno">570</span><span class="op" id="3934900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3934903">func</span>&nbsp;<span class="op" id="3934908">(</span><span class="ident" id="3934909">hs</span>&nbsp;<span class="op" id="3934912">*</span><span class="ident" id="3934913"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3934933">)</span>&nbsp;<span class="ident" id="3934935">sendFinished</span><span class="op" id="3934947">(</span><span class="ident" id="3934948">out</span>&nbsp;<span class="op" id="3934952">[</span><span class="op" id="3934953">]</span><span class="builtintype" id="3934954">byte</span><span class="op" id="3934958">)</span>&nbsp;<span class="builtintype" id="3934960">error</span>&nbsp;<span class="op" id="3934966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934969">c</span>&nbsp;<span class="op" id="3934971">:=</span>&nbsp;<span class="ident" id="3934974"><a href="/crypto/tls/handshake_server.go.html#3934909">hs</a></span><span class="op" id="3934976">.</span><span class="ident" id="3934977">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934981"><a href="/crypto/tls/handshake_server.go.html#3934969">c</a></span><span class="op" id="3934982">.</span><span class="ident" id="3934983">writeRecord</span><span class="op" id="3934994">(</span><span class="ident" id="3934995"><a href="/crypto/tls/common.go.html#3823266">recordTypeChangeCipherSpec</a></span><span class="op" id="3935021">,</span>&nbsp;<span class="op" id="3935023">[</span><span class="op" id="3935024">]</span><span class="builtintype" id="3935025">byte</span><span class="op" id="3935029">{</span><span class="num" id="3935030">1</span><span class="op" id="3935031">}</span><span class="op" id="3935032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935036">finished</span>&nbsp;<span class="op" id="3935045">:=</span>&nbsp;<span class="builtinfunc" id="3935048">new</span><span class="op" id="3935051">(</span><span class="ident" id="3935052"><a href="/crypto/tls/handshake_messages.go.html#3909925">finishedMsg</a></span><span class="op" id="3935063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935066"><a href="/crypto/tls/handshake_server.go.html#3935036">finished</a></span><span class="op" id="3935074">.</span><span class="ident" id="3935075">verifyData</span>&nbsp;<span class="op" id="3935086">=</span>&nbsp;<span class="ident" id="3935088"><a href="/crypto/tls/handshake_server.go.html#3934909">hs</a></span><span class="op" id="3935090">.</span><span class="ident" id="3935091">finishedHash</span><span class="op" id="3935103">.</span><span class="ident" id="3935104">serverSum</span><span class="op" id="3935113">(</span><span class="ident" id="3935114"><a href="/crypto/tls/handshake_server.go.html#3934909">hs</a></span><span class="op" id="3935116">.</span><span class="ident" id="3935117">masterSecret</span><span class="op" id="3935129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935132"><a href="/crypto/tls/handshake_server.go.html#3934909">hs</a></span><span class="op" id="3935134">.</span><span class="ident" id="3935135">finishedHash</span><span class="op" id="3935147">.</span><span class="ident" id="3935148">Write</span><span class="op" id="3935153">(</span><span class="ident" id="3935154"><a href="/crypto/tls/handshake_server.go.html#3935036">finished</a></span><span class="op" id="3935162">.</span><span class="ident" id="3935163">marshal</span><span class="op" id="3935170">(</span><span class="op" id="3935171">)</span><span class="op" id="3935172">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935175"><a href="/crypto/tls/handshake_server.go.html#3934969">c</a></span><span class="op" id="3935176">.</span><span class="ident" id="3935177">writeRecord</span><span class="op" id="3935188">(</span><span class="ident" id="3935189"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3935208">,</span>&nbsp;<span class="ident" id="3935210"><a href="/crypto/tls/handshake_server.go.html#3935036">finished</a></span><span class="op" id="3935218">.</span><span class="ident" id="3935219">marshal</span><span class="op" id="3935226">(</span><span class="op" id="3935227">)</span><span class="op" id="3935228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935232"><a href="/crypto/tls/handshake_server.go.html#3934969">c</a></span><span class="op" id="3935233">.</span><span class="ident" id="3935234">cipherSuite</span>&nbsp;<span class="op" id="3935246">=</span>&nbsp;<span class="ident" id="3935248"><a href="/crypto/tls/handshake_server.go.html#3934909">hs</a></span><span class="op" id="3935250">.</span><span class="ident" id="3935251">suite</span><span class="op" id="3935256">.</span><span class="ident" id="3935257">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3935261">copy</span><span class="op" id="3935265">(</span><span class="ident" id="3935266"><a href="/crypto/tls/handshake_server.go.html#3934948">out</a></span><span class="op" id="3935269">,</span>&nbsp;<span class="ident" id="3935271"><a href="/crypto/tls/handshake_server.go.html#3935036">finished</a></span><span class="op" id="3935279">.</span><span class="ident" id="3935280">verifyData</span><span class="op" id="3935290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935294">return</span>&nbsp;<span class="ident" id="3935301">nil</span><br>
<span class="lineno"></span><span class="op" id="3935305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3935308">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3935385">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3935462">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3935505">func</span>&nbsp;<span class="op" id="3935510">(</span><span class="ident" id="3935511">hs</span>&nbsp;<span class="op" id="3935514">*</span><span class="ident" id="3935515"><a href="/crypto/tls/handshake_server.go.html#3919170">serverHandshakeState</a></span><span class="op" id="3935535">)</span>&nbsp;<span class="ident" id="3935537">processCertsFromClient</span><span class="op" id="3935559">(</span><span class="ident" id="3935560">certificates</span>&nbsp;<span class="op" id="3935573">[</span><span class="op" id="3935574">]</span><span class="op" id="3935575">[</span><span class="op" id="3935576">]</span><span class="builtintype" id="3935577">byte</span><span class="op" id="3935581">)</span>&nbsp;<span class="op" id="3935583">(</span><span class="ident" id="3935584"><a href="/crypto/tls/handshake_server.go.html#3918923">crypto</a></span><span class="op" id="3935590">.</span><span class="ident" id="3935591">PublicKey</span><span class="op" id="3935600">,</span>&nbsp;<span class="builtintype" id="3935602">error</span><span class="op" id="3935607">)</span>&nbsp;<span class="op" id="3935609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935612">c</span>&nbsp;<span class="op" id="3935614">:=</span>&nbsp;<span class="ident" id="3935617"><a href="/crypto/tls/handshake_server.go.html#3935511">hs</a></span><span class="op" id="3935619">.</span><span class="ident" id="3935620">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935624"><a href="/crypto/tls/handshake_server.go.html#3935511">hs</a></span><span class="op" id="3935626">.</span><span class="ident" id="3935627">certsFromClient</span>&nbsp;<span class="op" id="3935643">=</span>&nbsp;<span class="ident" id="3935645"><a href="/crypto/tls/handshake_server.go.html#3935560">certificates</a></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935659">certs</span>&nbsp;<span class="op" id="3935665">:=</span>&nbsp;<span class="builtinfunc" id="3935668">make</span><span class="op" id="3935672">(</span><span class="op" id="3935673">[</span><span class="op" id="3935674">]</span><span class="op" id="3935675">*</span><span class="ident" id="3935676"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3935680">.</span><span class="ident" id="3935681">Certificate</span><span class="op" id="3935692">,</span>&nbsp;<span class="builtinfunc" id="3935694">len</span><span class="op" id="3935697">(</span><span class="ident" id="3935698"><a href="/crypto/tls/handshake_server.go.html#3935560">certificates</a></span><span class="op" id="3935710">)</span><span class="op" id="3935711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935714">var</span>&nbsp;<span class="ident" id="3935718">err</span>&nbsp;<span class="builtintype" id="3935722">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935729">for</span>&nbsp;<span class="ident" id="3935733">i</span><span class="op" id="3935734">,</span>&nbsp;<span class="ident" id="3935736">asn1Data</span>&nbsp;<span class="op" id="3935745">:=</span>&nbsp;<span class="keyword" id="3935748">range</span>&nbsp;<span class="ident" id="3935754"><a href="/crypto/tls/handshake_server.go.html#3935560">certificates</a></span>&nbsp;<span class="op" id="3935767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935771">if</span>&nbsp;<span class="ident" id="3935774"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3935779">[</span><span class="ident" id="3935780"><a href="/crypto/tls/handshake_server.go.html#3935733">i</a></span><span class="op" id="3935781">]</span><span class="op" id="3935782">,</span>&nbsp;<span class="ident" id="3935784"><a href="/crypto/tls/handshake_server.go.html#3935718">err</a></span>&nbsp;<span class="op" id="3935788">=</span>&nbsp;<span class="ident" id="3935790"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3935794">.</span><span class="ident" id="3935795">ParseCertificate</span><span class="op" id="3935811">(</span><span class="ident" id="3935812"><a href="/crypto/tls/handshake_server.go.html#3935736">asn1Data</a></span><span class="op" id="3935820">)</span><span class="op" id="3935821">;</span>&nbsp;<span class="ident" id="3935823"><a href="/crypto/tls/handshake_server.go.html#3935718">err</a></span>&nbsp;<span class="op" id="3935827">!=</span>&nbsp;<span class="ident" id="3935830">nil</span>&nbsp;<span class="op" id="3935834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935839"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3935840">.</span><span class="ident" id="3935841">sendAlert</span><span class="op" id="3935850">(</span><span class="ident" id="3935851"><a href="/crypto/tls/alert.go.html#3810868">alertBadCertificate</a></span><span class="op" id="3935870">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935875">return</span>&nbsp;<span class="ident" id="3935882">nil</span><span class="op" id="3935885">,</span>&nbsp;<span class="ident" id="3935887"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3935893">.</span><span class="ident" id="3935894">New</span><span class="op" id="3935897">(</span><span class="string" id="3935898">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3935942">+</span>&nbsp;<span class="ident" id="3935944"><a href="/crypto/tls/handshake_server.go.html#3935718">err</a></span><span class="op" id="3935947">.</span><span class="ident" id="3935948">Error</span><span class="op" id="3935953">(</span><span class="op" id="3935954">)</span><span class="op" id="3935955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935966">if</span>&nbsp;<span class="ident" id="3935969"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3935970">.</span><span class="ident" id="3935971">config</span><span class="op" id="3935977">.</span><span class="ident" id="3935978">ClientAuth</span>&nbsp;<span class="op" id="3935989">&gt;=</span>&nbsp;<span class="ident" id="3935992"><a href="/crypto/tls/common.go.html#3828345">VerifyClientCertIfGiven</a></span>&nbsp;<span class="op" id="3936016">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3936019">len</span><span class="op" id="3936022">(</span><span class="ident" id="3936023"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936028">)</span>&nbsp;<span class="op" id="3936030">&gt;</span>&nbsp;<span class="num" id="3936032">0</span>&nbsp;<span class="op" id="3936034">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936038">opts</span>&nbsp;<span class="op" id="3936043">:=</span>&nbsp;<span class="ident" id="3936046"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3936050">.</span><span class="ident" id="3936051">VerifyOptions</span><span class="op" id="3936064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936069">Roots</span><span class="op" id="3936074">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3936084"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3936085">.</span><span class="ident" id="3936086">config</span><span class="op" id="3936092">.</span><span class="ident" id="3936093">ClientCAs</span><span class="op" id="3936102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936107">CurrentTime</span><span class="op" id="3936118">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3936122"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3936123">.</span><span class="ident" id="3936124">config</span><span class="op" id="3936130">.</span><span class="ident" id="3936131">time</span><span class="op" id="3936135">(</span><span class="op" id="3936136">)</span><span class="op" id="3936137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936142">Intermediates</span><span class="op" id="3936155">:</span>&nbsp;<span class="ident" id="3936157"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3936161">.</span><span class="ident" id="3936162">NewCertPool</span><span class="op" id="3936173">(</span><span class="op" id="3936174">)</span><span class="op" id="3936175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936180">KeyUsages</span><span class="op" id="3936189">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3936195">[</span><span class="op" id="3936196">]</span><span class="ident" id="3936197"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3936201">.</span><span class="ident" id="3936202">ExtKeyUsage</span><span class="op" id="3936213">{</span><span class="ident" id="3936214"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3936218">.</span><span class="ident" id="3936219">ExtKeyUsageClientAuth</span><span class="op" id="3936240">}</span><span class="op" id="3936241">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936250">for</span>&nbsp;<span class="ident" id="3936254">_</span><span class="op" id="3936255">,</span>&nbsp;<span class="ident" id="3936257">cert</span>&nbsp;<span class="op" id="3936262">:=</span>&nbsp;<span class="keyword" id="3936265">range</span>&nbsp;<span class="ident" id="3936271"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936276">[</span><span class="num" id="3936277">1</span><span class="op" id="3936278">:</span><span class="op" id="3936279">]</span>&nbsp;<span class="op" id="3936281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936286"><a href="/crypto/tls/handshake_server.go.html#3936038">opts</a></span><span class="op" id="3936290">.</span><span class="ident" id="3936291">Intermediates</span><span class="op" id="3936304">.</span><span class="ident" id="3936305">AddCert</span><span class="op" id="3936312">(</span><span class="ident" id="3936313"><a href="/crypto/tls/handshake_server.go.html#3936257">cert</a></span><span class="op" id="3936317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936321">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936326">chains</span><span class="op" id="3936332">,</span>&nbsp;<span class="ident" id="3936334">err</span>&nbsp;<span class="op" id="3936338">:=</span>&nbsp;<span class="ident" id="3936341"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936346">[</span><span class="num" id="3936347">0</span><span class="op" id="3936348">]</span><span class="op" id="3936349">.</span><span class="ident" id="3936350">Verify</span><span class="op" id="3936356">(</span><span class="ident" id="3936357"><a href="/crypto/tls/handshake_server.go.html#3936038">opts</a></span><span class="op" id="3936361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936365">if</span>&nbsp;<span class="ident" id="3936368"><a href="/crypto/tls/handshake_server.go.html#3936334">err</a></span>&nbsp;<span class="op" id="3936372">!=</span>&nbsp;<span class="ident" id="3936375">nil</span>&nbsp;<span class="op" id="3936379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936384"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3936385">.</span><span class="ident" id="3936386">sendAlert</span><span class="op" id="3936395">(</span><span class="ident" id="3936396"><a href="/crypto/tls/alert.go.html#3810868">alertBadCertificate</a></span><span class="op" id="3936415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936420">return</span>&nbsp;<span class="ident" id="3936427">nil</span><span class="op" id="3936430">,</span>&nbsp;<span class="ident" id="3936432"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3936438">.</span><span class="ident" id="3936439">New</span><span class="op" id="3936442">(</span><span class="string" id="3936443">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3936490">+</span>&nbsp;<span class="ident" id="3936492"><a href="/crypto/tls/handshake_server.go.html#3936334">err</a></span><span class="op" id="3936495">.</span><span class="ident" id="3936496">Error</span><span class="op" id="3936501">(</span><span class="op" id="3936502">)</span><span class="op" id="3936503">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936512">ok</span>&nbsp;<span class="op" id="3936515">:=</span>&nbsp;<span class="builtintype" id="3936518">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936526">for</span>&nbsp;<span class="ident" id="3936530">_</span><span class="op" id="3936531">,</span>&nbsp;<span class="ident" id="3936533">ku</span>&nbsp;<span class="op" id="3936536">:=</span>&nbsp;<span class="keyword" id="3936539">range</span>&nbsp;<span class="ident" id="3936545"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936550">[</span><span class="num" id="3936551">0</span><span class="op" id="3936552">]</span><span class="op" id="3936553">.</span><span class="ident" id="3936554">ExtKeyUsage</span>&nbsp;<span class="op" id="3936566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936571">if</span>&nbsp;<span class="ident" id="3936574"><a href="/crypto/tls/handshake_server.go.html#3936533">ku</a></span>&nbsp;<span class="op" id="3936577">==</span>&nbsp;<span class="ident" id="3936580"><a href="/crypto/tls/handshake_server.go.html#3918980">x509</a></span><span class="op" id="3936584">.</span><span class="ident" id="3936585">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3936607">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936613"><a href="/crypto/tls/handshake_server.go.html#3936512">ok</a></span>&nbsp;<span class="op" id="3936616">=</span>&nbsp;<span class="builtintype" id="3936618">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936627">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936644">if</span>&nbsp;<span class="op" id="3936647">!</span><span class="ident" id="3936648"><a href="/crypto/tls/handshake_server.go.html#3936512">ok</a></span>&nbsp;<span class="op" id="3936651">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936656"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3936657">.</span><span class="ident" id="3936658">sendAlert</span><span class="op" id="3936667">(</span><span class="ident" id="3936668"><a href="/crypto/tls/alert.go.html#3810828">alertHandshakeFailure</a></span><span class="op" id="3936689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936694">return</span>&nbsp;<span class="ident" id="3936701">nil</span><span class="op" id="3936704">,</span>&nbsp;<span class="ident" id="3936706"><a href="/crypto/tls/handshake_server.go.html#3919012">errors</a></span><span class="op" id="3936712">.</span><span class="ident" id="3936713">New</span><span class="op" id="3936716">(</span><span class="string" id="3936717">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3936820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936829"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3936830">.</span><span class="ident" id="3936831">verifiedChains</span>&nbsp;<span class="op" id="3936846">=</span>&nbsp;<span class="ident" id="3936848"><a href="/crypto/tls/handshake_server.go.html#3936326">chains</a></span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936860">if</span>&nbsp;<span class="builtinfunc" id="3936863">len</span><span class="op" id="3936866">(</span><span class="ident" id="3936867"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936872">)</span>&nbsp;<span class="op" id="3936874">&gt;</span>&nbsp;<span class="num" id="3936876">0</span>&nbsp;<span class="op" id="3936878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936882">var</span>&nbsp;<span class="ident" id="3936886">pub</span>&nbsp;<span class="ident" id="3936890"><a href="/crypto/tls/handshake_server.go.html#3918923">crypto</a></span><span class="op" id="3936896">.</span><span class="ident" id="3936897">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936909">switch</span>&nbsp;<span class="ident" id="3936916">key</span>&nbsp;<span class="op" id="3936920">:=</span>&nbsp;<span class="ident" id="3936923"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3936928">[</span><span class="num" id="3936929">0</span><span class="op" id="3936930">]</span><span class="op" id="3936931">.</span><span class="ident" id="3936932">PublicKey</span><span class="op" id="3936941">.</span><span class="op" id="3936942">(</span><span class="keyword" id="3936943">type</span><span class="op" id="3936947">)</span>&nbsp;<span class="op" id="3936949">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936953">case</span>&nbsp;<span class="op" id="3936958">*</span><span class="ident" id="3936959"><a href="/crypto/tls/handshake_server.go.html#3918933">ecdsa</a></span><span class="op" id="3936964">.</span><span class="ident" id="3936965">PublicKey</span><span class="op" id="3936974">,</span>&nbsp;<span class="op" id="3936976">*</span><span class="ident" id="3936977"><a href="/crypto/tls/handshake_server.go.html#3918949">rsa</a></span><span class="op" id="3936980">.</span><span class="ident" id="3936981">PublicKey</span><span class="op" id="3936990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936995"><a href="/crypto/tls/handshake_server.go.html#3936886">pub</a></span>&nbsp;<span class="op" id="3936999">=</span>&nbsp;<span class="ident" id="3937001"><a href="/crypto/tls/handshake_server.go.html#3936916">key</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937007">default</span><span class="op" id="3937014">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937019"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3937020">.</span><span class="ident" id="3937021">sendAlert</span><span class="op" id="3937030">(</span><span class="ident" id="3937031"><a href="/crypto/tls/alert.go.html#3810908">alertUnsupportedCertificate</a></span><span class="op" id="3937058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937063">return</span>&nbsp;<span class="ident" id="3937070">nil</span><span class="op" id="3937073">,</span>&nbsp;<span class="ident" id="3937075"><a href="/crypto/tls/handshake_server.go.html#3919022">fmt</a></span><span class="op" id="3937078">.</span><span class="ident" id="3937079">Errorf</span><span class="op" id="3937085">(</span><span class="string" id="3937086">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3937159">,</span>&nbsp;<span class="ident" id="3937161"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><span class="op" id="3937166">[</span><span class="num" id="3937167">0</span><span class="op" id="3937168">]</span><span class="op" id="3937169">.</span><span class="ident" id="3937170">PublicKey</span><span class="op" id="3937179">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937187"><a href="/crypto/tls/handshake_server.go.html#3935612">c</a></span><span class="op" id="3937188">.</span><span class="ident" id="3937189">peerCertificates</span>&nbsp;<span class="op" id="3937206">=</span>&nbsp;<span class="ident" id="3937208"><a href="/crypto/tls/handshake_server.go.html#3935659">certs</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937216">return</span>&nbsp;<span class="ident" id="3937223"><a href="/crypto/tls/handshake_server.go.html#3936886">pub</a></span><span class="op" id="3937226">,</span>&nbsp;<span class="ident" id="3937228">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937237">return</span>&nbsp;<span class="ident" id="3937244">nil</span><span class="op" id="3937247">,</span>&nbsp;<span class="ident" id="3937249">nil</span><br>
<span class="lineno"></span><span class="op" id="3937253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3937256">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3937335">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3937360">func</span>&nbsp;<span class="op" id="3937365">(</span><span class="ident" id="3937366">c</span>&nbsp;<span class="op" id="3937368">*</span><span class="ident" id="3937369"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3937373">)</span>&nbsp;<span class="ident" id="3937375">tryCipherSuite</span><span class="op" id="3937389">(</span><span class="ident" id="3937390">id</span>&nbsp;<span class="builtintype" id="3937393">uint16</span><span class="op" id="3937399">,</span>&nbsp;<span class="ident" id="3937401">supportedCipherSuites</span>&nbsp;<span class="op" id="3937423">[</span><span class="op" id="3937424">]</span><span class="builtintype" id="3937425">uint16</span><span class="op" id="3937431">,</span>&nbsp;<span class="ident" id="3937433">version</span>&nbsp;<span class="builtintype" id="3937441">uint16</span><span class="op" id="3937447">,</span>&nbsp;<span class="ident" id="3937449">ellipticOk</span><span class="op" id="3937459">,</span>&nbsp;<span class="ident" id="3937461">ecdsaOk</span>&nbsp;<span class="builtintype" id="3937469">bool</span><span class="op" id="3937473">)</span>&nbsp;<span class="op" id="3937475">*</span><span class="ident" id="3937476"><a href="/crypto/tls/cipher_suites.go.html#3815009">cipherSuite</a></span>&nbsp;<span class="op" id="3937488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937491">for</span>&nbsp;<span class="ident" id="3937495">_</span><span class="op" id="3937496">,</span>&nbsp;<span class="ident" id="3937498">supported</span>&nbsp;<span class="op" id="3937508">:=</span>&nbsp;<span class="keyword" id="3937511">range</span>&nbsp;<span class="ident" id="3937517"><a href="/crypto/tls/handshake_server.go.html#3937401">supportedCipherSuites</a></span>&nbsp;<span class="op" id="3937539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937543">if</span>&nbsp;<span class="ident" id="3937546"><a href="/crypto/tls/handshake_server.go.html#3937390">id</a></span>&nbsp;<span class="op" id="3937549">==</span>&nbsp;<span class="ident" id="3937552"><a href="/crypto/tls/handshake_server.go.html#3937498">supported</a></span>&nbsp;<span class="op" id="3937562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937567">var</span>&nbsp;<span class="ident" id="3937571">candidate</span>&nbsp;<span class="op" id="3937581">*</span><span class="ident" id="3937582"><a href="/crypto/tls/cipher_suites.go.html#3815009">cipherSuite</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937598">for</span>&nbsp;<span class="ident" id="3937602">_</span><span class="op" id="3937603">,</span>&nbsp;<span class="ident" id="3937605">s</span>&nbsp;<span class="op" id="3937607">:=</span>&nbsp;<span class="keyword" id="3937610">range</span>&nbsp;<span class="ident" id="3937616"><a href="/crypto/tls/cipher_suites.go.html#3815423">cipherSuites</a></span>&nbsp;<span class="op" id="3937629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937635">if</span>&nbsp;<span class="ident" id="3937638"><a href="/crypto/tls/handshake_server.go.html#3937605">s</a></span><span class="op" id="3937639">.</span><span class="ident" id="3937640">id</span>&nbsp;<span class="op" id="3937643">==</span>&nbsp;<span class="ident" id="3937646"><a href="/crypto/tls/handshake_server.go.html#3937390">id</a></span>&nbsp;<span class="op" id="3937649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937656"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span>&nbsp;<span class="op" id="3937666">=</span>&nbsp;<span class="ident" id="3937668"><a href="/crypto/tls/handshake_server.go.html#3937605">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937675">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937685">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937695">if</span>&nbsp;<span class="ident" id="3937698"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span>&nbsp;<span class="op" id="3937708">==</span>&nbsp;<span class="ident" id="3937711">nil</span>&nbsp;<span class="op" id="3937715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937721">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3937738">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3937786">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937817">if</span>&nbsp;<span class="op" id="3937820">(</span><span class="ident" id="3937821"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span><span class="op" id="3937830">.</span><span class="ident" id="3937831">flags</span><span class="op" id="3937836">&amp;</span><span class="ident" id="3937837"><a href="/crypto/tls/cipher_suites.go.html#3814484">suiteECDHE</a></span>&nbsp;<span class="op" id="3937848">!=</span>&nbsp;<span class="num" id="3937851">0</span><span class="op" id="3937852">)</span>&nbsp;<span class="op" id="3937854">&amp;&amp;</span>&nbsp;<span class="op" id="3937857">!</span><span class="ident" id="3937858"><a href="/crypto/tls/handshake_server.go.html#3937449">ellipticOk</a></span>&nbsp;<span class="op" id="3937869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937875">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937892">if</span>&nbsp;<span class="op" id="3937895">(</span><span class="ident" id="3937896"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span><span class="op" id="3937905">.</span><span class="ident" id="3937906">flags</span><span class="op" id="3937911">&amp;</span><span class="ident" id="3937912"><a href="/crypto/tls/cipher_suites.go.html#3814725">suiteECDSA</a></span>&nbsp;<span class="op" id="3937923">!=</span>&nbsp;<span class="num" id="3937926">0</span><span class="op" id="3937927">)</span>&nbsp;<span class="op" id="3937929">!=</span>&nbsp;<span class="ident" id="3937932"><a href="/crypto/tls/handshake_server.go.html#3937461">ecdsaOk</a></span>&nbsp;<span class="op" id="3937940">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937946">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937963">if</span>&nbsp;<span class="ident" id="3937966"><a href="/crypto/tls/handshake_server.go.html#3937433">version</a></span>&nbsp;<span class="op" id="3937974">&lt;</span>&nbsp;<span class="ident" id="3937976"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3937989">&amp;&amp;</span>&nbsp;<span class="ident" id="3937992"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span><span class="op" id="3938001">.</span><span class="ident" id="3938002">flags</span><span class="op" id="3938007">&amp;</span><span class="ident" id="3938008"><a href="/crypto/tls/cipher_suites.go.html#3814847">suiteTLS12</a></span>&nbsp;<span class="op" id="3938019">!=</span>&nbsp;<span class="num" id="3938022">0</span>&nbsp;<span class="op" id="3938024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938030">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938042">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938047">return</span>&nbsp;<span class="ident" id="3938054"><a href="/crypto/tls/handshake_server.go.html#3937571">candidate</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938073">return</span>&nbsp;<span class="ident" id="3938080">nil</span><br>
<span class="lineno">685</span><span class="op" id="3938084">}</span>
</div>
</body>
</html>
