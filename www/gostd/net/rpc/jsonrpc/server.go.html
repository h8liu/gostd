<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5276088">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5276144">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5276198">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5276249">package</span>&nbsp;<span class="ident" id="5276257">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5276266">import</span>&nbsp;<span class="op" id="5276273">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5276276">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5276293">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5276303">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5276309">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5276320">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5276327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5276330">var</span>&nbsp;<span class="ident" id="5276334">errMissingParams</span>&nbsp;<span class="op" id="5276351">=</span>&nbsp;<span class="ident" id="5276353">errors</span><span class="op" id="5276359">.</span><span class="ident" id="5276360">New</span><span class="op" id="5276363">(</span><span class="string" id="5276364">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5276402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5276405">type</span>&nbsp;<span class="ident" id="5276410">serverCodec</span>&nbsp;<span class="keyword" id="5276422">struct</span>&nbsp;<span class="op" id="5276429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276432">dec</span>&nbsp;<span class="op" id="5276436">*</span><span class="ident" id="5276437">json</span><span class="op" id="5276441">.</span><span class="ident" id="5276442">Decoder</span>&nbsp;<span class="comment" id="5276450">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276478">enc</span>&nbsp;<span class="op" id="5276482">*</span><span class="ident" id="5276483">json</span><span class="op" id="5276487">.</span><span class="ident" id="5276488">Encoder</span>&nbsp;<span class="comment" id="5276496">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276524">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5276528">io</span><span class="op" id="5276530">.</span><span class="ident" id="5276531">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276540">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276565">req</span>&nbsp;<span class="ident" id="5276569">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276585">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276652">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276696">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276755">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276812">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276865">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276915">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5276923">sync</span><span class="op" id="5276927">.</span><span class="ident" id="5276928">Mutex</span>&nbsp;<span class="comment" id="5276934">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276960">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5276968">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276976">pending</span>&nbsp;<span class="keyword" id="5276984">map</span><span class="op" id="5276987">[</span><span class="ident" id="5276988">uint64</span><span class="op" id="5276994">]</span><span class="op" id="5276995">*</span><span class="ident" id="5276996">json</span><span class="op" id="5277000">.</span><span class="ident" id="5277001">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5277012">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5277015">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5277087">func</span>&nbsp;<span class="ident" id="5277092">NewServerCodec</span><span class="op" id="5277106">(</span><span class="ident" id="5277107">conn</span>&nbsp;<span class="ident" id="5277112">io</span><span class="op" id="5277114">.</span><span class="ident" id="5277115">ReadWriteCloser</span><span class="op" id="5277130">)</span>&nbsp;<span class="ident" id="5277132">rpc</span><span class="op" id="5277135">.</span><span class="ident" id="5277136">ServerCodec</span>&nbsp;<span class="op" id="5277148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277151">return</span>&nbsp;<span class="op" id="5277158">&amp;</span><span class="ident" id="5277159">serverCodec</span><span class="op" id="5277170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277174">dec</span><span class="op" id="5277177">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277183">json</span><span class="op" id="5277187">.</span><span class="ident" id="5277188">NewDecoder</span><span class="op" id="5277198">(</span><span class="ident" id="5277199">conn</span><span class="op" id="5277203">)</span><span class="op" id="5277204">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277208">enc</span><span class="op" id="5277211">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277217">json</span><span class="op" id="5277221">.</span><span class="ident" id="5277222">NewEncoder</span><span class="op" id="5277232">(</span><span class="ident" id="5277233">conn</span><span class="op" id="5277237">)</span><span class="op" id="5277238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277242">c</span><span class="op" id="5277243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277251">conn</span><span class="op" id="5277255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277259">pending</span><span class="op" id="5277266">:</span>&nbsp;<span class="builtinfunc" id="5277268">make</span><span class="op" id="5277272">(</span><span class="keyword" id="5277273">map</span><span class="op" id="5277276">[</span><span class="ident" id="5277277">uint64</span><span class="op" id="5277283">]</span><span class="op" id="5277284">*</span><span class="ident" id="5277285">json</span><span class="op" id="5277289">.</span><span class="ident" id="5277290">RawMessage</span><span class="op" id="5277300">)</span><span class="op" id="5277301">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277304">}</span><br>
<span class="lineno"></span><span class="op" id="5277306">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5277309">type</span>&nbsp;<span class="ident" id="5277314">serverRequest</span>&nbsp;<span class="keyword" id="5277328">struct</span>&nbsp;<span class="op" id="5277335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277338">Method</span>&nbsp;<span class="builtintype" id="5277345">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277362">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277379">Params</span>&nbsp;<span class="op" id="5277386">*</span><span class="ident" id="5277387">json</span><span class="op" id="5277391">.</span><span class="ident" id="5277392">RawMessage</span>&nbsp;<span class="string" id="5277403">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277420">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5277427">*</span><span class="ident" id="5277428">json</span><span class="op" id="5277432">.</span><span class="ident" id="5277433">RawMessage</span>&nbsp;<span class="string" id="5277444">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5277456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5277459">func</span>&nbsp;<span class="op" id="5277464">(</span><span class="ident" id="5277465">r</span>&nbsp;<span class="op" id="5277467">*</span><span class="ident" id="5277468">serverRequest</span><span class="op" id="5277481">)</span>&nbsp;<span class="ident" id="5277483">reset</span><span class="op" id="5277488">(</span><span class="op" id="5277489">)</span>&nbsp;<span class="op" id="5277491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277494">r</span><span class="op" id="5277495">.</span><span class="ident" id="5277496">Method</span>&nbsp;<span class="op" id="5277503">=</span>&nbsp;<span class="string" id="5277505">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277509">r</span><span class="op" id="5277510">.</span><span class="ident" id="5277511">Params</span>&nbsp;<span class="op" id="5277518">=</span>&nbsp;<span class="ident" id="5277520">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277525">r</span><span class="op" id="5277526">.</span><span class="ident" id="5277527">Id</span>&nbsp;<span class="op" id="5277530">=</span>&nbsp;<span class="ident" id="5277532">nil</span><br>
<span class="lineno"></span><span class="op" id="5277536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5277539">type</span>&nbsp;<span class="ident" id="5277544">serverResponse</span>&nbsp;<span class="keyword" id="5277559">struct</span>&nbsp;<span class="op" id="5277566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277569">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5277576">*</span><span class="ident" id="5277577">json</span><span class="op" id="5277581">.</span><span class="ident" id="5277582">RawMessage</span>&nbsp;<span class="string" id="5277593">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277606">Result</span>&nbsp;<span class="keyword" id="5277613">interface</span><span class="op" id="5277622">{</span><span class="op" id="5277623">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277630">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277647">Error</span>&nbsp;&nbsp;<span class="keyword" id="5277654">interface</span><span class="op" id="5277663">{</span><span class="op" id="5277664">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277671">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5277686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5277689">func</span>&nbsp;<span class="op" id="5277694">(</span><span class="ident" id="5277695">c</span>&nbsp;<span class="op" id="5277697">*</span><span class="ident" id="5277698">serverCodec</span><span class="op" id="5277709">)</span>&nbsp;<span class="ident" id="5277711">ReadRequestHeader</span><span class="op" id="5277728">(</span><span class="ident" id="5277729">r</span>&nbsp;<span class="op" id="5277731">*</span><span class="ident" id="5277732">rpc</span><span class="op" id="5277735">.</span><span class="ident" id="5277736">Request</span><span class="op" id="5277743">)</span>&nbsp;<span class="builtintype" id="5277745">error</span>&nbsp;<span class="op" id="5277751">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277754">c</span><span class="op" id="5277755">.</span><span class="ident" id="5277756">req</span><span class="op" id="5277759">.</span><span class="ident" id="5277760">reset</span><span class="op" id="5277765">(</span><span class="op" id="5277766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277769">if</span>&nbsp;<span class="ident" id="5277772">err</span>&nbsp;<span class="op" id="5277776">:=</span>&nbsp;<span class="ident" id="5277779">c</span><span class="op" id="5277780">.</span><span class="ident" id="5277781">dec</span><span class="op" id="5277784">.</span><span class="ident" id="5277785">Decode</span><span class="op" id="5277791">(</span><span class="op" id="5277792">&amp;</span><span class="ident" id="5277793">c</span><span class="op" id="5277794">.</span><span class="ident" id="5277795">req</span><span class="op" id="5277798">)</span><span class="op" id="5277799">;</span>&nbsp;<span class="ident" id="5277801">err</span>&nbsp;<span class="op" id="5277805">!=</span>&nbsp;<span class="ident" id="5277808">nil</span>&nbsp;<span class="op" id="5277812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277816">return</span>&nbsp;<span class="ident" id="5277823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277831">r</span><span class="op" id="5277832">.</span><span class="ident" id="5277833">ServiceMethod</span>&nbsp;<span class="op" id="5277847">=</span>&nbsp;<span class="ident" id="5277849">c</span><span class="op" id="5277850">.</span><span class="ident" id="5277851">req</span><span class="op" id="5277854">.</span><span class="ident" id="5277855">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277864">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277907">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277953">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278000">c</span><span class="op" id="5278001">.</span><span class="ident" id="5278002">mutex</span><span class="op" id="5278007">.</span><span class="ident" id="5278008">Lock</span><span class="op" id="5278012">(</span><span class="op" id="5278013">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278016">c</span><span class="op" id="5278017">.</span><span class="ident" id="5278018">seq</span><span class="op" id="5278021">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278025">c</span><span class="op" id="5278026">.</span><span class="ident" id="5278027">pending</span><span class="op" id="5278034">[</span><span class="ident" id="5278035">c</span><span class="op" id="5278036">.</span><span class="ident" id="5278037">seq</span><span class="op" id="5278040">]</span>&nbsp;<span class="op" id="5278042">=</span>&nbsp;<span class="ident" id="5278044">c</span><span class="op" id="5278045">.</span><span class="ident" id="5278046">req</span><span class="op" id="5278049">.</span><span class="ident" id="5278050">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278054">c</span><span class="op" id="5278055">.</span><span class="ident" id="5278056">req</span><span class="op" id="5278059">.</span><span class="ident" id="5278060">Id</span>&nbsp;<span class="op" id="5278063">=</span>&nbsp;<span class="ident" id="5278065">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278070">r</span><span class="op" id="5278071">.</span><span class="ident" id="5278072">Seq</span>&nbsp;<span class="op" id="5278076">=</span>&nbsp;<span class="ident" id="5278078">c</span><span class="op" id="5278079">.</span><span class="ident" id="5278080">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278085">c</span><span class="op" id="5278086">.</span><span class="ident" id="5278087">mutex</span><span class="op" id="5278092">.</span><span class="ident" id="5278093">Unlock</span><span class="op" id="5278099">(</span><span class="op" id="5278100">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278104">return</span>&nbsp;<span class="ident" id="5278111">nil</span><br>
<span class="lineno"></span><span class="op" id="5278115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5278118">func</span>&nbsp;<span class="op" id="5278123">(</span><span class="ident" id="5278124">c</span>&nbsp;<span class="op" id="5278126">*</span><span class="ident" id="5278127">serverCodec</span><span class="op" id="5278138">)</span>&nbsp;<span class="ident" id="5278140">ReadRequestBody</span><span class="op" id="5278155">(</span><span class="ident" id="5278156">x</span>&nbsp;<span class="keyword" id="5278158">interface</span><span class="op" id="5278167">{</span><span class="op" id="5278168">}</span><span class="op" id="5278169">)</span>&nbsp;<span class="builtintype" id="5278171">error</span>&nbsp;<span class="op" id="5278177">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278180">if</span>&nbsp;<span class="ident" id="5278183">x</span>&nbsp;<span class="op" id="5278185">==</span>&nbsp;<span class="ident" id="5278188">nil</span>&nbsp;<span class="op" id="5278192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278196">return</span>&nbsp;<span class="ident" id="5278203">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278211">if</span>&nbsp;<span class="ident" id="5278214">c</span><span class="op" id="5278215">.</span><span class="ident" id="5278216">req</span><span class="op" id="5278219">.</span><span class="ident" id="5278220">Params</span>&nbsp;<span class="op" id="5278227">==</span>&nbsp;<span class="ident" id="5278230">nil</span>&nbsp;<span class="op" id="5278234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278238">return</span>&nbsp;<span class="ident" id="5278245">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278266">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278298">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278324">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278376">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278424">var</span>&nbsp;<span class="ident" id="5278428">params</span>&nbsp;<span class="op" id="5278435">[</span><span class="num" id="5278436">1</span><span class="op" id="5278437">]</span><span class="keyword" id="5278438">interface</span><span class="op" id="5278447">{</span><span class="op" id="5278448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278451">params</span><span class="op" id="5278457">[</span><span class="num" id="5278458">0</span><span class="op" id="5278459">]</span>&nbsp;<span class="op" id="5278461">=</span>&nbsp;<span class="ident" id="5278463">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278466">return</span>&nbsp;<span class="ident" id="5278473">json</span><span class="op" id="5278477">.</span><span class="ident" id="5278478">Unmarshal</span><span class="op" id="5278487">(</span><span class="op" id="5278488">*</span><span class="ident" id="5278489">c</span><span class="op" id="5278490">.</span><span class="ident" id="5278491">req</span><span class="op" id="5278494">.</span><span class="ident" id="5278495">Params</span><span class="op" id="5278501">,</span>&nbsp;<span class="op" id="5278503">&amp;</span><span class="ident" id="5278504">params</span><span class="op" id="5278510">)</span><br>
<span class="lineno"></span><span class="op" id="5278512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5278515">var</span>&nbsp;<span class="ident" id="5278519">null</span>&nbsp;<span class="op" id="5278524">=</span>&nbsp;<span class="ident" id="5278526">json</span><span class="op" id="5278530">.</span><span class="ident" id="5278531">RawMessage</span><span class="op" id="5278541">(</span><span class="op" id="5278542">[</span><span class="op" id="5278543">]</span><span class="builtintype" id="5278544">byte</span><span class="op" id="5278548">(</span><span class="string" id="5278549">&#34;null&#34;</span><span class="op" id="5278555">)</span><span class="op" id="5278556">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5278559">func</span>&nbsp;<span class="op" id="5278564">(</span><span class="ident" id="5278565">c</span>&nbsp;<span class="op" id="5278567">*</span><span class="ident" id="5278568">serverCodec</span><span class="op" id="5278579">)</span>&nbsp;<span class="ident" id="5278581">WriteResponse</span><span class="op" id="5278594">(</span><span class="ident" id="5278595">r</span>&nbsp;<span class="op" id="5278597">*</span><span class="ident" id="5278598">rpc</span><span class="op" id="5278601">.</span><span class="ident" id="5278602">Response</span><span class="op" id="5278610">,</span>&nbsp;<span class="ident" id="5278612">x</span>&nbsp;<span class="keyword" id="5278614">interface</span><span class="op" id="5278623">{</span><span class="op" id="5278624">}</span><span class="op" id="5278625">)</span>&nbsp;<span class="builtintype" id="5278627">error</span>&nbsp;<span class="op" id="5278633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278636">c</span><span class="op" id="5278637">.</span><span class="ident" id="5278638">mutex</span><span class="op" id="5278643">.</span><span class="ident" id="5278644">Lock</span><span class="op" id="5278648">(</span><span class="op" id="5278649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278652">b</span><span class="op" id="5278653">,</span>&nbsp;<span class="ident" id="5278655">ok</span>&nbsp;<span class="op" id="5278658">:=</span>&nbsp;<span class="ident" id="5278661">c</span><span class="op" id="5278662">.</span><span class="ident" id="5278663">pending</span><span class="op" id="5278670">[</span><span class="ident" id="5278671">r</span><span class="op" id="5278672">.</span><span class="ident" id="5278673">Seq</span><span class="op" id="5278676">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278679">if</span>&nbsp;<span class="op" id="5278682">!</span><span class="ident" id="5278683">ok</span>&nbsp;<span class="op" id="5278686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278690">c</span><span class="op" id="5278691">.</span><span class="ident" id="5278692">mutex</span><span class="op" id="5278697">.</span><span class="ident" id="5278698">Unlock</span><span class="op" id="5278704">(</span><span class="op" id="5278705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278709">return</span>&nbsp;<span class="ident" id="5278716">errors</span><span class="op" id="5278722">.</span><span class="ident" id="5278723">New</span><span class="op" id="5278726">(</span><span class="string" id="5278727">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5278764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5278770">delete</span><span class="op" id="5278776">(</span><span class="ident" id="5278777">c</span><span class="op" id="5278778">.</span><span class="ident" id="5278779">pending</span><span class="op" id="5278786">,</span>&nbsp;<span class="ident" id="5278788">r</span><span class="op" id="5278789">.</span><span class="ident" id="5278790">Seq</span><span class="op" id="5278793">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278796">c</span><span class="op" id="5278797">.</span><span class="ident" id="5278798">mutex</span><span class="op" id="5278803">.</span><span class="ident" id="5278804">Unlock</span><span class="op" id="5278810">(</span><span class="op" id="5278811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278815">if</span>&nbsp;<span class="ident" id="5278818">b</span>&nbsp;<span class="op" id="5278820">==</span>&nbsp;<span class="ident" id="5278823">nil</span>&nbsp;<span class="op" id="5278827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278831">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278878">b</span>&nbsp;<span class="op" id="5278880">=</span>&nbsp;<span class="op" id="5278882">&amp;</span><span class="ident" id="5278883">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278892">resp</span>&nbsp;<span class="op" id="5278897">:=</span>&nbsp;<span class="ident" id="5278900">serverResponse</span><span class="op" id="5278914">{</span><span class="ident" id="5278915">Id</span><span class="op" id="5278917">:</span>&nbsp;<span class="ident" id="5278919">b</span><span class="op" id="5278920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278923">if</span>&nbsp;<span class="ident" id="5278926">r</span><span class="op" id="5278927">.</span><span class="ident" id="5278928">Error</span>&nbsp;<span class="op" id="5278934">==</span>&nbsp;<span class="string" id="5278937">&#34;&#34;</span>&nbsp;<span class="op" id="5278940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278944">resp</span><span class="op" id="5278948">.</span><span class="ident" id="5278949">Result</span>&nbsp;<span class="op" id="5278956">=</span>&nbsp;<span class="ident" id="5278958">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278961">}</span>&nbsp;<span class="keyword" id="5278963">else</span>&nbsp;<span class="op" id="5278968">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278972">resp</span><span class="op" id="5278976">.</span><span class="ident" id="5278977">Error</span>&nbsp;<span class="op" id="5278983">=</span>&nbsp;<span class="ident" id="5278985">r</span><span class="op" id="5278986">.</span><span class="ident" id="5278987">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278997">return</span>&nbsp;<span class="ident" id="5279004">c</span><span class="op" id="5279005">.</span><span class="ident" id="5279006">enc</span><span class="op" id="5279009">.</span><span class="ident" id="5279010">Encode</span><span class="op" id="5279016">(</span><span class="ident" id="5279017">resp</span><span class="op" id="5279021">)</span><br>
<span class="lineno"></span><span class="op" id="5279023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5279026">func</span>&nbsp;<span class="op" id="5279031">(</span><span class="ident" id="5279032">c</span>&nbsp;<span class="op" id="5279034">*</span><span class="ident" id="5279035">serverCodec</span><span class="op" id="5279046">)</span>&nbsp;<span class="ident" id="5279048">Close</span><span class="op" id="5279053">(</span><span class="op" id="5279054">)</span>&nbsp;<span class="builtintype" id="5279056">error</span>&nbsp;<span class="op" id="5279062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279065">return</span>&nbsp;<span class="ident" id="5279072">c</span><span class="op" id="5279073">.</span><span class="ident" id="5279074">c</span><span class="op" id="5279075">.</span><span class="ident" id="5279076">Close</span><span class="op" id="5279081">(</span><span class="op" id="5279082">)</span><br>
<span class="lineno"></span><span class="op" id="5279084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5279087">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5279149">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5279220">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5279281">func</span>&nbsp;<span class="ident" id="5279286">ServeConn</span><span class="op" id="5279295">(</span><span class="ident" id="5279296">conn</span>&nbsp;<span class="ident" id="5279301">io</span><span class="op" id="5279303">.</span><span class="ident" id="5279304">ReadWriteCloser</span><span class="op" id="5279319">)</span>&nbsp;<span class="op" id="5279321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279324">rpc</span><span class="op" id="5279327">.</span><span class="ident" id="5279328">ServeCodec</span><span class="op" id="5279338">(</span><span class="ident" id="5279339">NewServerCodec</span><span class="op" id="5279353">(</span><span class="ident" id="5279354">conn</span><span class="op" id="5279358">)</span><span class="op" id="5279359">)</span><br>
<span class="lineno"></span><span class="op" id="5279361">}</span>
</div>
</body>
</html>
