<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3471116">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3471171">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3471225">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3471276">package</span>&nbsp;<span class="ident" id="3471284">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3471290">import</span>&nbsp;<span class="op" id="3471297">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471300">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471309">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471318">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471328">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471335">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471341">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471354">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471375">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471392">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471400">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471411">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3471422">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3471429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3471432">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3471502">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3471538">var</span>&nbsp;<span class="ident" id="3471542">ErrLineTooLong</span>&nbsp;<span class="op" id="3471557">=</span>&nbsp;<span class="ident" id="3471559"><a href="/net/http/transfer.go.html#3471354">internal</a></span><span class="op" id="3471567">.</span><span class="ident" id="3471568">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3471584">type</span>&nbsp;<span class="ident" id="3471589">errorReader</span>&nbsp;<span class="keyword" id="3471601">struct</span>&nbsp;<span class="op" id="3471608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471611">err</span>&nbsp;<span class="builtintype" id="3471615">error</span><br>
<span class="lineno"></span><span class="op" id="3471621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3471624">func</span>&nbsp;<span class="op" id="3471629">(</span><span class="ident" id="3471630">r</span>&nbsp;<span class="op" id="3471632">*</span><span class="ident" id="3471633"><a href="/net/http/transfer.go.html#3471589">errorReader</a></span><span class="op" id="3471644">)</span>&nbsp;<span class="ident" id="3471646">Read</span><span class="op" id="3471650">(</span><span class="ident" id="3471651">p</span>&nbsp;<span class="op" id="3471653">[</span><span class="op" id="3471654">]</span><span class="builtintype" id="3471655">byte</span><span class="op" id="3471659">)</span>&nbsp;<span class="op" id="3471661">(</span><span class="ident" id="3471662">n</span>&nbsp;<span class="builtintype" id="3471664">int</span><span class="op" id="3471667">,</span>&nbsp;<span class="ident" id="3471669">err</span>&nbsp;<span class="builtintype" id="3471673">error</span><span class="op" id="3471678">)</span>&nbsp;<span class="op" id="3471680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471683">return</span>&nbsp;<span class="num" id="3471690">0</span><span class="op" id="3471691">,</span>&nbsp;<span class="ident" id="3471693"><a href="/net/http/transfer.go.html#3471630">r</a></span><span class="op" id="3471694">.</span><span class="ident" id="3471695">err</span><br>
<span class="lineno"></span><span class="op" id="3471699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3471702">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3471780">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3471856">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3471923">type</span>&nbsp;<span class="ident" id="3471928">transferWriter</span>&nbsp;<span class="keyword" id="3471943">struct</span>&nbsp;<span class="op" id="3471950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471953">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3471970">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471978">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3471995"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3471997">.</span><span class="ident" id="3471998">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472006">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472023"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3472025">.</span><span class="ident" id="3472026">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472034">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3472051">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472057">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472074">int64</span>&nbsp;<span class="comment" id="3472080">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472123">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3472140">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472146">TransferEncoding</span>&nbsp;<span class="op" id="3472163">[</span><span class="op" id="3472164">]</span><span class="builtintype" id="3472165">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472173">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3472190"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span><span class="op" id="3472197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3472200">func</span>&nbsp;<span class="ident" id="3472205">newTransferWriter</span><span class="op" id="3472222">(</span><span class="ident" id="3472223">r</span>&nbsp;<span class="keyword" id="3472225">interface</span><span class="op" id="3472234">{</span><span class="op" id="3472235">}</span><span class="op" id="3472236">)</span>&nbsp;<span class="op" id="3472238">(</span><span class="ident" id="3472239">t</span>&nbsp;<span class="op" id="3472241">*</span><span class="ident" id="3472242"><a href="/net/http/transfer.go.html#3471928">transferWriter</a></span><span class="op" id="3472256">,</span>&nbsp;<span class="ident" id="3472258">err</span>&nbsp;<span class="builtintype" id="3472262">error</span><span class="op" id="3472267">)</span>&nbsp;<span class="op" id="3472269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472272"><a href="/net/http/transfer.go.html#3472239">t</a></span>&nbsp;<span class="op" id="3472274">=</span>&nbsp;<span class="op" id="3472276">&amp;</span><span class="ident" id="3472277"><a href="/net/http/transfer.go.html#3471928">transferWriter</a></span><span class="op" id="3472291">{</span><span class="op" id="3472292">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472296">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472324">atLeastHTTP11</span>&nbsp;<span class="op" id="3472338">:=</span>&nbsp;<span class="builtintype" id="3472341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472348">switch</span>&nbsp;<span class="ident" id="3472355">rr</span>&nbsp;<span class="op" id="3472358">:=</span>&nbsp;<span class="ident" id="3472361"><a href="/net/http/transfer.go.html#3472223">r</a></span><span class="op" id="3472362">.</span><span class="op" id="3472363">(</span><span class="keyword" id="3472364">type</span><span class="op" id="3472368">)</span>&nbsp;<span class="op" id="3472370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472373">case</span>&nbsp;<span class="op" id="3472378">*</span><span class="ident" id="3472379"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3472386">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472390">if</span>&nbsp;<span class="ident" id="3472393"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472395">.</span><span class="ident" id="3472396">ContentLength</span>&nbsp;<span class="op" id="3472410">!=</span>&nbsp;<span class="num" id="3472413">0</span>&nbsp;<span class="op" id="3472415">&amp;&amp;</span>&nbsp;<span class="ident" id="3472418"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472420">.</span><span class="ident" id="3472421">Body</span>&nbsp;<span class="op" id="3472426">==</span>&nbsp;<span class="ident" id="3472429">nil</span>&nbsp;<span class="op" id="3472433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472438">return</span>&nbsp;<span class="ident" id="3472445">nil</span><span class="op" id="3472448">,</span>&nbsp;<span class="ident" id="3472450"><a href="/net/http/transfer.go.html#3471328">fmt</a></span><span class="op" id="3472453">.</span><span class="ident" id="3472454">Errorf</span><span class="op" id="3472460">(</span><span class="string" id="3472461">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3472507">,</span>&nbsp;<span class="ident" id="3472509"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472511">.</span><span class="ident" id="3472512">ContentLength</span><span class="op" id="3472525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472533"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472534">.</span><span class="ident" id="3472535">Method</span>&nbsp;<span class="op" id="3472542">=</span>&nbsp;<span class="ident" id="3472544"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472546">.</span><span class="ident" id="3472547">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472556"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472557">.</span><span class="ident" id="3472558">Body</span>&nbsp;<span class="op" id="3472563">=</span>&nbsp;<span class="ident" id="3472565"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472567">.</span><span class="ident" id="3472568">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472575"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472576">.</span><span class="ident" id="3472577">BodyCloser</span>&nbsp;<span class="op" id="3472588">=</span>&nbsp;<span class="ident" id="3472590"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472592">.</span><span class="ident" id="3472593">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472600"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472601">.</span><span class="ident" id="3472602">ContentLength</span>&nbsp;<span class="op" id="3472616">=</span>&nbsp;<span class="ident" id="3472618"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472620">.</span><span class="ident" id="3472621">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472637"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472638">.</span><span class="ident" id="3472639">Close</span>&nbsp;<span class="op" id="3472645">=</span>&nbsp;<span class="ident" id="3472647"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472649">.</span><span class="ident" id="3472650">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472658"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472659">.</span><span class="ident" id="3472660">TransferEncoding</span>&nbsp;<span class="op" id="3472677">=</span>&nbsp;<span class="ident" id="3472679"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472681">.</span><span class="ident" id="3472682">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472701"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472702">.</span><span class="ident" id="3472703">Trailer</span>&nbsp;<span class="op" id="3472711">=</span>&nbsp;<span class="ident" id="3472713"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472715">.</span><span class="ident" id="3472716">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472726"><a href="/net/http/transfer.go.html#3472324">atLeastHTTP11</a></span>&nbsp;<span class="op" id="3472740">=</span>&nbsp;<span class="ident" id="3472742"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3472744">.</span><span class="ident" id="3472745">ProtoAtLeast</span><span class="op" id="3472757">(</span><span class="num" id="3472758">1</span><span class="op" id="3472759">,</span>&nbsp;<span class="num" id="3472761">1</span><span class="op" id="3472762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472766">if</span>&nbsp;<span class="ident" id="3472769"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472770">.</span><span class="ident" id="3472771">Body</span>&nbsp;<span class="op" id="3472776">!=</span>&nbsp;<span class="ident" id="3472779">nil</span>&nbsp;<span class="op" id="3472783">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3472786">len</span><span class="op" id="3472789">(</span><span class="ident" id="3472790"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472791">.</span><span class="ident" id="3472792">TransferEncoding</span><span class="op" id="3472808">)</span>&nbsp;<span class="op" id="3472810">==</span>&nbsp;<span class="num" id="3472813">0</span>&nbsp;<span class="op" id="3472815">&amp;&amp;</span>&nbsp;<span class="ident" id="3472818"><a href="/net/http/transfer.go.html#3472324">atLeastHTTP11</a></span>&nbsp;<span class="op" id="3472832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472837">if</span>&nbsp;<span class="ident" id="3472840"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472841">.</span><span class="ident" id="3472842">ContentLength</span>&nbsp;<span class="op" id="3472856">==</span>&nbsp;<span class="num" id="3472859">0</span>&nbsp;<span class="op" id="3472861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472867">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472923">var</span>&nbsp;<span class="ident" id="3472927">buf</span>&nbsp;<span class="op" id="3472931">[</span><span class="num" id="3472932">1</span><span class="op" id="3472933">]</span><span class="builtintype" id="3472934">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472943">n</span><span class="op" id="3472944">,</span>&nbsp;<span class="ident" id="3472946">rerr</span>&nbsp;<span class="op" id="3472951">:=</span>&nbsp;<span class="ident" id="3472954"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3472956">.</span><span class="ident" id="3472957">ReadFull</span><span class="op" id="3472965">(</span><span class="ident" id="3472966"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3472967">.</span><span class="ident" id="3472968">Body</span><span class="op" id="3472972">,</span>&nbsp;<span class="ident" id="3472974"><a href="/net/http/transfer.go.html#3472927">buf</a></span><span class="op" id="3472977">[</span><span class="op" id="3472978">:</span><span class="op" id="3472979">]</span><span class="op" id="3472980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472986">if</span>&nbsp;<span class="ident" id="3472989"><a href="/net/http/transfer.go.html#3472946">rerr</a></span>&nbsp;<span class="op" id="3472994">!=</span>&nbsp;<span class="ident" id="3472997">nil</span>&nbsp;<span class="op" id="3473001">&amp;&amp;</span>&nbsp;<span class="ident" id="3473004"><a href="/net/http/transfer.go.html#3472946">rerr</a></span>&nbsp;<span class="op" id="3473009">!=</span>&nbsp;<span class="ident" id="3473012"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3473014">.</span><span class="ident" id="3473015">EOF</span>&nbsp;<span class="op" id="3473019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473026"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473027">.</span><span class="ident" id="3473028">ContentLength</span>&nbsp;<span class="op" id="3473042">=</span>&nbsp;<span class="op" id="3473044">-</span><span class="num" id="3473045">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473052"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473053">.</span><span class="ident" id="3473054">Body</span>&nbsp;<span class="op" id="3473059">=</span>&nbsp;<span class="op" id="3473061">&amp;</span><span class="ident" id="3473062"><a href="/net/http/transfer.go.html#3471589">errorReader</a></span><span class="op" id="3473073">{</span><span class="ident" id="3473074"><a href="/net/http/transfer.go.html#3472946">rerr</a></span><span class="op" id="3473078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473084">}</span>&nbsp;<span class="keyword" id="3473086">else</span>&nbsp;<span class="keyword" id="3473091">if</span>&nbsp;<span class="ident" id="3473094"><a href="/net/http/transfer.go.html#3472943">n</a></span>&nbsp;<span class="op" id="3473096">==</span>&nbsp;<span class="num" id="3473099">1</span>&nbsp;<span class="op" id="3473101">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473108">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473171">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473220">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473281">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473304"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473305">.</span><span class="ident" id="3473306">ContentLength</span>&nbsp;<span class="op" id="3473320">=</span>&nbsp;<span class="op" id="3473322">-</span><span class="num" id="3473323">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473330"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473331">.</span><span class="ident" id="3473332">Body</span>&nbsp;<span class="op" id="3473337">=</span>&nbsp;<span class="ident" id="3473339"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3473341">.</span><span class="ident" id="3473342">MultiReader</span><span class="op" id="3473353">(</span><span class="ident" id="3473354"><a href="/net/http/transfer.go.html#3471309">bytes</a></span><span class="op" id="3473359">.</span><span class="ident" id="3473360">NewReader</span><span class="op" id="3473369">(</span><span class="ident" id="3473370"><a href="/net/http/transfer.go.html#3472927">buf</a></span><span class="op" id="3473373">[</span><span class="op" id="3473374">:</span><span class="op" id="3473375">]</span><span class="op" id="3473376">)</span><span class="op" id="3473377">,</span>&nbsp;<span class="ident" id="3473379"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473380">.</span><span class="ident" id="3473381">Body</span><span class="op" id="3473385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473391">}</span>&nbsp;<span class="keyword" id="3473393">else</span>&nbsp;<span class="op" id="3473398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473405">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473437"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473438">.</span><span class="ident" id="3473439">Body</span>&nbsp;<span class="op" id="3473444">=</span>&nbsp;<span class="ident" id="3473446">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473455"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473456">.</span><span class="ident" id="3473457">BodyCloser</span>&nbsp;<span class="op" id="3473468">=</span>&nbsp;<span class="ident" id="3473470">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473488">if</span>&nbsp;<span class="ident" id="3473491"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473492">.</span><span class="ident" id="3473493">ContentLength</span>&nbsp;<span class="op" id="3473507">&lt;</span>&nbsp;<span class="num" id="3473509">0</span>&nbsp;<span class="op" id="3473511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473517"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473518">.</span><span class="ident" id="3473519">TransferEncoding</span>&nbsp;<span class="op" id="3473536">=</span>&nbsp;<span class="op" id="3473538">[</span><span class="op" id="3473539">]</span><span class="builtintype" id="3473540">string</span><span class="op" id="3473546">{</span><span class="string" id="3473547">&#34;chunked&#34;</span><span class="op" id="3473556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473561">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473568">case</span>&nbsp;<span class="op" id="3473573">*</span><span class="ident" id="3473574"><a href="/net/http/response.go.html#3392041">Response</a></span><span class="op" id="3473582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473586">if</span>&nbsp;<span class="ident" id="3473589"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473591">.</span><span class="ident" id="3473592">Request</span>&nbsp;<span class="op" id="3473600">!=</span>&nbsp;<span class="ident" id="3473603">nil</span>&nbsp;<span class="op" id="3473607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473612"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473613">.</span><span class="ident" id="3473614">Method</span>&nbsp;<span class="op" id="3473621">=</span>&nbsp;<span class="ident" id="3473623"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473625">.</span><span class="ident" id="3473626">Request</span><span class="op" id="3473633">.</span><span class="ident" id="3473634">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473643">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473647"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473648">.</span><span class="ident" id="3473649">Body</span>&nbsp;<span class="op" id="3473654">=</span>&nbsp;<span class="ident" id="3473656"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473658">.</span><span class="ident" id="3473659">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473666"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473667">.</span><span class="ident" id="3473668">BodyCloser</span>&nbsp;<span class="op" id="3473679">=</span>&nbsp;<span class="ident" id="3473681"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473683">.</span><span class="ident" id="3473684">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473691"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473692">.</span><span class="ident" id="3473693">ContentLength</span>&nbsp;<span class="op" id="3473707">=</span>&nbsp;<span class="ident" id="3473709"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473711">.</span><span class="ident" id="3473712">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473728"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473729">.</span><span class="ident" id="3473730">Close</span>&nbsp;<span class="op" id="3473736">=</span>&nbsp;<span class="ident" id="3473738"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473740">.</span><span class="ident" id="3473741">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473749"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473750">.</span><span class="ident" id="3473751">TransferEncoding</span>&nbsp;<span class="op" id="3473768">=</span>&nbsp;<span class="ident" id="3473770"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473772">.</span><span class="ident" id="3473773">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473792"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473793">.</span><span class="ident" id="3473794">Trailer</span>&nbsp;<span class="op" id="3473802">=</span>&nbsp;<span class="ident" id="3473804"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473806">.</span><span class="ident" id="3473807">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473817"><a href="/net/http/transfer.go.html#3472324">atLeastHTTP11</a></span>&nbsp;<span class="op" id="3473831">=</span>&nbsp;<span class="ident" id="3473833"><a href="/net/http/transfer.go.html#3472355">rr</a></span><span class="op" id="3473835">.</span><span class="ident" id="3473836">ProtoAtLeast</span><span class="op" id="3473848">(</span><span class="num" id="3473849">1</span><span class="op" id="3473850">,</span>&nbsp;<span class="num" id="3473852">1</span><span class="op" id="3473853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473857"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473858">.</span><span class="ident" id="3473859">ResponseToHEAD</span>&nbsp;<span class="op" id="3473874">=</span>&nbsp;<span class="ident" id="3473876"><a href="/net/http/transfer.go.html#3474379">noBodyExpected</a></span><span class="op" id="3473890">(</span><span class="ident" id="3473891"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473892">.</span><span class="ident" id="3473893">Method</span><span class="op" id="3473899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473906">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473955">if</span>&nbsp;<span class="ident" id="3473958"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473959">.</span><span class="ident" id="3473960">ResponseToHEAD</span>&nbsp;<span class="op" id="3473975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473979"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3473980">.</span><span class="ident" id="3473981">Body</span>&nbsp;<span class="op" id="3473986">=</span>&nbsp;<span class="ident" id="3473988">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473994">if</span>&nbsp;<span class="ident" id="3473997"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3474004">(</span><span class="ident" id="3474005"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474006">.</span><span class="ident" id="3474007">TransferEncoding</span><span class="op" id="3474023">)</span>&nbsp;<span class="op" id="3474025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474030"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474031">.</span><span class="ident" id="3474032">ContentLength</span>&nbsp;<span class="op" id="3474046">=</span>&nbsp;<span class="op" id="3474048">-</span><span class="num" id="3474049">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474056">}</span>&nbsp;<span class="keyword" id="3474058">else</span>&nbsp;<span class="op" id="3474063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474067">if</span>&nbsp;<span class="op" id="3474070">!</span><span class="ident" id="3474071"><a href="/net/http/transfer.go.html#3472324">atLeastHTTP11</a></span>&nbsp;<span class="op" id="3474085">||</span>&nbsp;<span class="ident" id="3474088"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474089">.</span><span class="ident" id="3474090">Body</span>&nbsp;<span class="op" id="3474095">==</span>&nbsp;<span class="ident" id="3474098">nil</span>&nbsp;<span class="op" id="3474102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474107"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474108">.</span><span class="ident" id="3474109">TransferEncoding</span>&nbsp;<span class="op" id="3474126">=</span>&nbsp;<span class="ident" id="3474128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474134">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474138">if</span>&nbsp;<span class="ident" id="3474141"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3474148">(</span><span class="ident" id="3474149"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474150">.</span><span class="ident" id="3474151">TransferEncoding</span><span class="op" id="3474167">)</span>&nbsp;<span class="op" id="3474169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474174"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474175">.</span><span class="ident" id="3474176">ContentLength</span>&nbsp;<span class="op" id="3474190">=</span>&nbsp;<span class="op" id="3474192">-</span><span class="num" id="3474193">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474197">}</span>&nbsp;<span class="keyword" id="3474199">else</span>&nbsp;<span class="keyword" id="3474204">if</span>&nbsp;<span class="ident" id="3474207"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474208">.</span><span class="ident" id="3474209">Body</span>&nbsp;<span class="op" id="3474214">==</span>&nbsp;<span class="ident" id="3474217">nil</span>&nbsp;<span class="op" id="3474221">{</span>&nbsp;<span class="comment" id="3474223">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474250"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474251">.</span><span class="ident" id="3474252">ContentLength</span>&nbsp;<span class="op" id="3474266">=</span>&nbsp;<span class="num" id="3474268">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474272">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474279">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474300">if</span>&nbsp;<span class="op" id="3474303">!</span><span class="ident" id="3474304"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3474311">(</span><span class="ident" id="3474312"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474313">.</span><span class="ident" id="3474314">TransferEncoding</span><span class="op" id="3474330">)</span>&nbsp;<span class="op" id="3474332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474336"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474337">.</span><span class="ident" id="3474338">Trailer</span>&nbsp;<span class="op" id="3474346">=</span>&nbsp;<span class="ident" id="3474348">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474357">return</span>&nbsp;<span class="ident" id="3474364"><a href="/net/http/transfer.go.html#3472239">t</a></span><span class="op" id="3474365">,</span>&nbsp;<span class="ident" id="3474367">nil</span><br>
<span class="lineno"></span><span class="op" id="3474371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3474374">func</span>&nbsp;<span class="ident" id="3474379">noBodyExpected</span><span class="op" id="3474393">(</span><span class="ident" id="3474394">requestMethod</span>&nbsp;<span class="builtintype" id="3474408">string</span><span class="op" id="3474414">)</span>&nbsp;<span class="builtintype" id="3474416">bool</span>&nbsp;<span class="op" id="3474421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474424">return</span>&nbsp;<span class="ident" id="3474431"><a href="/net/http/transfer.go.html#3474394">requestMethod</a></span>&nbsp;<span class="op" id="3474445">==</span>&nbsp;<span class="string" id="3474448">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3474455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3474458">func</span>&nbsp;<span class="op" id="3474463">(</span><span class="ident" id="3474464">t</span>&nbsp;<span class="op" id="3474466">*</span><span class="ident" id="3474467"><a href="/net/http/transfer.go.html#3471928">transferWriter</a></span><span class="op" id="3474481">)</span>&nbsp;<span class="ident" id="3474483">shouldSendContentLength</span><span class="op" id="3474506">(</span><span class="op" id="3474507">)</span>&nbsp;<span class="builtintype" id="3474509">bool</span>&nbsp;<span class="op" id="3474514">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474517">if</span>&nbsp;<span class="ident" id="3474520"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3474527">(</span><span class="ident" id="3474528"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474529">.</span><span class="ident" id="3474530">TransferEncoding</span><span class="op" id="3474546">)</span>&nbsp;<span class="op" id="3474548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474552">return</span>&nbsp;<span class="builtintype" id="3474559">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474569">if</span>&nbsp;<span class="ident" id="3474572"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474573">.</span><span class="ident" id="3474574">ContentLength</span>&nbsp;<span class="op" id="3474588">&gt;</span>&nbsp;<span class="num" id="3474590">0</span>&nbsp;<span class="op" id="3474592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474596">return</span>&nbsp;<span class="builtintype" id="3474603">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474612">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474671">if</span>&nbsp;<span class="ident" id="3474674"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474675">.</span><span class="ident" id="3474676">Method</span>&nbsp;<span class="op" id="3474683">==</span>&nbsp;<span class="string" id="3474686">&#34;POST&#34;</span>&nbsp;<span class="op" id="3474693">||</span>&nbsp;<span class="ident" id="3474696"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474697">.</span><span class="ident" id="3474698">Method</span>&nbsp;<span class="op" id="3474705">==</span>&nbsp;<span class="string" id="3474708">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3474714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474718">return</span>&nbsp;<span class="builtintype" id="3474725">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474731">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474734">if</span>&nbsp;<span class="ident" id="3474737"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474738">.</span><span class="ident" id="3474739">ContentLength</span>&nbsp;<span class="op" id="3474753">==</span>&nbsp;<span class="num" id="3474756">0</span>&nbsp;<span class="op" id="3474758">&amp;&amp;</span>&nbsp;<span class="ident" id="3474761"><a href="/net/http/transfer.go.html#3481491">isIdentity</a></span><span class="op" id="3474771">(</span><span class="ident" id="3474772"><a href="/net/http/transfer.go.html#3474464">t</a></span><span class="op" id="3474773">.</span><span class="ident" id="3474774">TransferEncoding</span><span class="op" id="3474790">)</span>&nbsp;<span class="op" id="3474792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474796">return</span>&nbsp;<span class="builtintype" id="3474803">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474813">return</span>&nbsp;<span class="builtintype" id="3474820">false</span><br>
<span class="lineno">150</span><span class="op" id="3474826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3474829">func</span>&nbsp;<span class="op" id="3474834">(</span><span class="ident" id="3474835">t</span>&nbsp;<span class="op" id="3474837">*</span><span class="ident" id="3474838"><a href="/net/http/transfer.go.html#3471928">transferWriter</a></span><span class="op" id="3474852">)</span>&nbsp;<span class="ident" id="3474854">WriteHeader</span><span class="op" id="3474865">(</span><span class="ident" id="3474866">w</span>&nbsp;<span class="ident" id="3474868"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3474870">.</span><span class="ident" id="3474871">Writer</span><span class="op" id="3474877">)</span>&nbsp;<span class="builtintype" id="3474879">error</span>&nbsp;<span class="op" id="3474885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474888">if</span>&nbsp;<span class="ident" id="3474891"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3474892">.</span><span class="ident" id="3474893">Close</span>&nbsp;<span class="op" id="3474899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474903">if</span>&nbsp;<span class="ident" id="3474906">_</span><span class="op" id="3474907">,</span>&nbsp;<span class="ident" id="3474909">err</span>&nbsp;<span class="op" id="3474913">:=</span>&nbsp;<span class="ident" id="3474916"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3474918">.</span><span class="ident" id="3474919">WriteString</span><span class="op" id="3474930">(</span><span class="ident" id="3474931"><a href="/net/http/transfer.go.html#3474866">w</a></span><span class="op" id="3474932">,</span>&nbsp;<span class="string" id="3474934">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3474957">)</span><span class="op" id="3474958">;</span>&nbsp;<span class="ident" id="3474960"><a href="/net/http/transfer.go.html#3474909">err</a></span>&nbsp;<span class="op" id="3474964">!=</span>&nbsp;<span class="ident" id="3474967">nil</span>&nbsp;<span class="op" id="3474971">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474976">return</span>&nbsp;<span class="ident" id="3474983"><a href="/net/http/transfer.go.html#3474909">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3474992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3474996">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475065">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475130">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475152">if</span>&nbsp;<span class="ident" id="3475155"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475156">.</span><span class="ident" id="3475157">shouldSendContentLength</span><span class="op" id="3475180">(</span><span class="op" id="3475181">)</span>&nbsp;<span class="op" id="3475183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475187">if</span>&nbsp;<span class="ident" id="3475190">_</span><span class="op" id="3475191">,</span>&nbsp;<span class="ident" id="3475193">err</span>&nbsp;<span class="op" id="3475197">:=</span>&nbsp;<span class="ident" id="3475200"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3475202">.</span><span class="ident" id="3475203">WriteString</span><span class="op" id="3475214">(</span><span class="ident" id="3475215"><a href="/net/http/transfer.go.html#3474866">w</a></span><span class="op" id="3475216">,</span>&nbsp;<span class="string" id="3475218">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3475236">)</span><span class="op" id="3475237">;</span>&nbsp;<span class="ident" id="3475239"><a href="/net/http/transfer.go.html#3475193">err</a></span>&nbsp;<span class="op" id="3475243">!=</span>&nbsp;<span class="ident" id="3475246">nil</span>&nbsp;<span class="op" id="3475250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475255">return</span>&nbsp;<span class="ident" id="3475262"><a href="/net/http/transfer.go.html#3475193">err</a></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475272">if</span>&nbsp;<span class="ident" id="3475275">_</span><span class="op" id="3475276">,</span>&nbsp;<span class="ident" id="3475278">err</span>&nbsp;<span class="op" id="3475282">:=</span>&nbsp;<span class="ident" id="3475285"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3475287">.</span><span class="ident" id="3475288">WriteString</span><span class="op" id="3475299">(</span><span class="ident" id="3475300"><a href="/net/http/transfer.go.html#3474866">w</a></span><span class="op" id="3475301">,</span>&nbsp;<span class="ident" id="3475303"><a href="/net/http/transfer.go.html#3471400">strconv</a></span><span class="op" id="3475310">.</span><span class="ident" id="3475311">FormatInt</span><span class="op" id="3475320">(</span><span class="ident" id="3475321"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475322">.</span><span class="ident" id="3475323">ContentLength</span><span class="op" id="3475336">,</span>&nbsp;<span class="num" id="3475338">10</span><span class="op" id="3475340">)</span><span class="op" id="3475341">+</span><span class="string" id="3475342">&#34;\r\n&#34;</span><span class="op" id="3475348">)</span><span class="op" id="3475349">;</span>&nbsp;<span class="ident" id="3475351"><a href="/net/http/transfer.go.html#3475278">err</a></span>&nbsp;<span class="op" id="3475355">!=</span>&nbsp;<span class="ident" id="3475358">nil</span>&nbsp;<span class="op" id="3475362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475367">return</span>&nbsp;<span class="ident" id="3475374"><a href="/net/http/transfer.go.html#3475278">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475383">}</span>&nbsp;<span class="keyword" id="3475385">else</span>&nbsp;<span class="keyword" id="3475390">if</span>&nbsp;<span class="ident" id="3475393"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3475400">(</span><span class="ident" id="3475401"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475402">.</span><span class="ident" id="3475403">TransferEncoding</span><span class="op" id="3475419">)</span>&nbsp;<span class="op" id="3475421">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475425">if</span>&nbsp;<span class="ident" id="3475428">_</span><span class="op" id="3475429">,</span>&nbsp;<span class="ident" id="3475431">err</span>&nbsp;<span class="op" id="3475435">:=</span>&nbsp;<span class="ident" id="3475438"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3475440">.</span><span class="ident" id="3475441">WriteString</span><span class="op" id="3475452">(</span><span class="ident" id="3475453"><a href="/net/http/transfer.go.html#3474866">w</a></span><span class="op" id="3475454">,</span>&nbsp;<span class="string" id="3475456">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3475488">)</span><span class="op" id="3475489">;</span>&nbsp;<span class="ident" id="3475491"><a href="/net/http/transfer.go.html#3475431">err</a></span>&nbsp;<span class="op" id="3475495">!=</span>&nbsp;<span class="ident" id="3475498">nil</span>&nbsp;<span class="op" id="3475502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475507">return</span>&nbsp;<span class="ident" id="3475514"><a href="/net/http/transfer.go.html#3475431">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475527">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475552">if</span>&nbsp;<span class="ident" id="3475555"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475556">.</span><span class="ident" id="3475557">Trailer</span>&nbsp;<span class="op" id="3475565">!=</span>&nbsp;<span class="ident" id="3475568">nil</span>&nbsp;<span class="op" id="3475572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475576">keys</span>&nbsp;<span class="op" id="3475581">:=</span>&nbsp;<span class="builtinfunc" id="3475584">make</span><span class="op" id="3475588">(</span><span class="op" id="3475589">[</span><span class="op" id="3475590">]</span><span class="builtintype" id="3475591">string</span><span class="op" id="3475597">,</span>&nbsp;<span class="num" id="3475599">0</span><span class="op" id="3475600">,</span>&nbsp;<span class="builtinfunc" id="3475602">len</span><span class="op" id="3475605">(</span><span class="ident" id="3475606"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475607">.</span><span class="ident" id="3475608">Trailer</span><span class="op" id="3475615">)</span><span class="op" id="3475616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475620">for</span>&nbsp;<span class="ident" id="3475624">k</span>&nbsp;<span class="op" id="3475626">:=</span>&nbsp;<span class="keyword" id="3475629">range</span>&nbsp;<span class="ident" id="3475635"><a href="/net/http/transfer.go.html#3474835">t</a></span><span class="op" id="3475636">.</span><span class="ident" id="3475637">Trailer</span>&nbsp;<span class="op" id="3475645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475650"><a href="/net/http/transfer.go.html#3475624">k</a></span>&nbsp;<span class="op" id="3475652">=</span>&nbsp;<span class="ident" id="3475654"><a href="/net/http/header.go.html#3360764">CanonicalHeaderKey</a></span><span class="op" id="3475672">(</span><span class="ident" id="3475673"><a href="/net/http/transfer.go.html#3475624">k</a></span><span class="op" id="3475674">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475679">switch</span>&nbsp;<span class="ident" id="3475686"><a href="/net/http/transfer.go.html#3475624">k</a></span>&nbsp;<span class="op" id="3475688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475693">case</span>&nbsp;<span class="string" id="3475698">&#34;Transfer-Encoding&#34;</span><span class="op" id="3475717">,</span>&nbsp;<span class="string" id="3475719">&#34;Trailer&#34;</span><span class="op" id="3475728">,</span>&nbsp;<span class="string" id="3475730">&#34;Content-Length&#34;</span><span class="op" id="3475746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475752">return</span>&nbsp;<span class="op" id="3475759">&amp;</span><span class="ident" id="3475760"><a href="/net/http/request.go.html#3365780">badStringError</a></span><span class="op" id="3475774">{</span><span class="string" id="3475775">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3475796">,</span>&nbsp;<span class="ident" id="3475798"><a href="/net/http/transfer.go.html#3475624">k</a></span><span class="op" id="3475799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475809"><a href="/net/http/transfer.go.html#3475576">keys</a></span>&nbsp;<span class="op" id="3475814">=</span>&nbsp;<span class="builtinfunc" id="3475816">append</span><span class="op" id="3475822">(</span><span class="ident" id="3475823"><a href="/net/http/transfer.go.html#3475576">keys</a></span><span class="op" id="3475827">,</span>&nbsp;<span class="ident" id="3475829"><a href="/net/http/transfer.go.html#3475624">k</a></span><span class="op" id="3475830">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3475834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475838">if</span>&nbsp;<span class="builtinfunc" id="3475841">len</span><span class="op" id="3475844">(</span><span class="ident" id="3475845"><a href="/net/http/transfer.go.html#3475576">keys</a></span><span class="op" id="3475849">)</span>&nbsp;<span class="op" id="3475851">&gt;</span>&nbsp;<span class="num" id="3475853">0</span>&nbsp;<span class="op" id="3475855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475860"><a href="/net/http/transfer.go.html#3471392">sort</a></span><span class="op" id="3475864">.</span><span class="ident" id="3475865">Strings</span><span class="op" id="3475872">(</span><span class="ident" id="3475873"><a href="/net/http/transfer.go.html#3475576">keys</a></span><span class="op" id="3475877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475882">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3475955">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3475984">if</span>&nbsp;<span class="ident" id="3475987">_</span><span class="op" id="3475988">,</span>&nbsp;<span class="ident" id="3475990">err</span>&nbsp;<span class="op" id="3475994">:=</span>&nbsp;<span class="ident" id="3475997"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3475999">.</span><span class="ident" id="3476000">WriteString</span><span class="op" id="3476011">(</span><span class="ident" id="3476012"><a href="/net/http/transfer.go.html#3474866">w</a></span><span class="op" id="3476013">,</span>&nbsp;<span class="string" id="3476015">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3476026">+</span><span class="ident" id="3476027"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3476034">.</span><span class="ident" id="3476035">Join</span><span class="op" id="3476039">(</span><span class="ident" id="3476040"><a href="/net/http/transfer.go.html#3475576">keys</a></span><span class="op" id="3476044">,</span>&nbsp;<span class="string" id="3476046">&#34;,&#34;</span><span class="op" id="3476049">)</span><span class="op" id="3476050">+</span><span class="string" id="3476051">&#34;\r\n&#34;</span><span class="op" id="3476057">)</span><span class="op" id="3476058">;</span>&nbsp;<span class="ident" id="3476060"><a href="/net/http/transfer.go.html#3475990">err</a></span>&nbsp;<span class="op" id="3476064">!=</span>&nbsp;<span class="ident" id="3476067">nil</span>&nbsp;<span class="op" id="3476071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476077">return</span>&nbsp;<span class="ident" id="3476084"><a href="/net/http/transfer.go.html#3475990">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476098">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476102">return</span>&nbsp;<span class="ident" id="3476109">nil</span><br>
<span class="lineno"></span><span class="op" id="3476113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3476116">func</span>&nbsp;<span class="op" id="3476121">(</span><span class="ident" id="3476122">t</span>&nbsp;<span class="op" id="3476124">*</span><span class="ident" id="3476125"><a href="/net/http/transfer.go.html#3471928">transferWriter</a></span><span class="op" id="3476139">)</span>&nbsp;<span class="ident" id="3476141">WriteBody</span><span class="op" id="3476150">(</span><span class="ident" id="3476151">w</span>&nbsp;<span class="ident" id="3476153"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476155">.</span><span class="ident" id="3476156">Writer</span><span class="op" id="3476162">)</span>&nbsp;<span class="builtintype" id="3476164">error</span>&nbsp;<span class="op" id="3476170">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476173">var</span>&nbsp;<span class="ident" id="3476177">err</span>&nbsp;<span class="builtintype" id="3476181">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476188">var</span>&nbsp;<span class="ident" id="3476192">ncopy</span>&nbsp;<span class="ident" id="3476198">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476206">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476221">if</span>&nbsp;<span class="ident" id="3476224"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476225">.</span><span class="ident" id="3476226">Body</span>&nbsp;<span class="op" id="3476231">!=</span>&nbsp;<span class="ident" id="3476234">nil</span>&nbsp;<span class="op" id="3476238">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476242">if</span>&nbsp;<span class="ident" id="3476245"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3476252">(</span><span class="ident" id="3476253"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476254">.</span><span class="ident" id="3476255">TransferEncoding</span><span class="op" id="3476271">)</span>&nbsp;<span class="op" id="3476273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476278">cw</span>&nbsp;<span class="op" id="3476281">:=</span>&nbsp;<span class="ident" id="3476284"><a href="/net/http/transfer.go.html#3471354">internal</a></span><span class="op" id="3476292">.</span><span class="ident" id="3476293">NewChunkedWriter</span><span class="op" id="3476309">(</span><span class="ident" id="3476310"><a href="/net/http/transfer.go.html#3476151">w</a></span><span class="op" id="3476311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476316">_</span><span class="op" id="3476317">,</span>&nbsp;<span class="ident" id="3476319"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476323">=</span>&nbsp;<span class="ident" id="3476325"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476327">.</span><span class="ident" id="3476328">Copy</span><span class="op" id="3476332">(</span><span class="ident" id="3476333"><a href="/net/http/transfer.go.html#3476278">cw</a></span><span class="op" id="3476335">,</span>&nbsp;<span class="ident" id="3476337"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476338">.</span><span class="ident" id="3476339">Body</span><span class="op" id="3476343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476348">if</span>&nbsp;<span class="ident" id="3476351"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476355">==</span>&nbsp;<span class="ident" id="3476358">nil</span>&nbsp;<span class="op" id="3476362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476368"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476372">=</span>&nbsp;<span class="ident" id="3476374"><a href="/net/http/transfer.go.html#3476278">cw</a></span><span class="op" id="3476376">.</span><span class="ident" id="3476377">Close</span><span class="op" id="3476382">(</span><span class="op" id="3476383">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476392">}</span>&nbsp;<span class="keyword" id="3476394">else</span>&nbsp;<span class="keyword" id="3476399">if</span>&nbsp;<span class="ident" id="3476402"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476403">.</span><span class="ident" id="3476404">ContentLength</span>&nbsp;<span class="op" id="3476418">==</span>&nbsp;<span class="op" id="3476421">-</span><span class="num" id="3476422">1</span>&nbsp;<span class="op" id="3476424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476429"><a href="/net/http/transfer.go.html#3476192">ncopy</a></span><span class="op" id="3476434">,</span>&nbsp;<span class="ident" id="3476436"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476440">=</span>&nbsp;<span class="ident" id="3476442"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476444">.</span><span class="ident" id="3476445">Copy</span><span class="op" id="3476449">(</span><span class="ident" id="3476450"><a href="/net/http/transfer.go.html#3476151">w</a></span><span class="op" id="3476451">,</span>&nbsp;<span class="ident" id="3476453"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476454">.</span><span class="ident" id="3476455">Body</span><span class="op" id="3476459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476463">}</span>&nbsp;<span class="keyword" id="3476465">else</span>&nbsp;<span class="op" id="3476470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476475"><a href="/net/http/transfer.go.html#3476192">ncopy</a></span><span class="op" id="3476480">,</span>&nbsp;<span class="ident" id="3476482"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476486">=</span>&nbsp;<span class="ident" id="3476488"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476490">.</span><span class="ident" id="3476491">Copy</span><span class="op" id="3476495">(</span><span class="ident" id="3476496"><a href="/net/http/transfer.go.html#3476151">w</a></span><span class="op" id="3476497">,</span>&nbsp;<span class="ident" id="3476499"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476501">.</span><span class="ident" id="3476502">LimitReader</span><span class="op" id="3476513">(</span><span class="ident" id="3476514"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476515">.</span><span class="ident" id="3476516">Body</span><span class="op" id="3476520">,</span>&nbsp;<span class="ident" id="3476522"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476523">.</span><span class="ident" id="3476524">ContentLength</span><span class="op" id="3476537">)</span><span class="op" id="3476538">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476543">if</span>&nbsp;<span class="ident" id="3476546"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476550">!=</span>&nbsp;<span class="ident" id="3476553">nil</span>&nbsp;<span class="op" id="3476557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476563">return</span>&nbsp;<span class="ident" id="3476570"><a href="/net/http/transfer.go.html#3476177">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476582">var</span>&nbsp;<span class="ident" id="3476586">nextra</span>&nbsp;<span class="ident" id="3476593">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476602"><a href="/net/http/transfer.go.html#3476586">nextra</a></span><span class="op" id="3476608">,</span>&nbsp;<span class="ident" id="3476610"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476614">=</span>&nbsp;<span class="ident" id="3476616"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3476618">.</span><span class="ident" id="3476619">Copy</span><span class="op" id="3476623">(</span><span class="ident" id="3476624"><a href="/net/http/transfer.go.html#3471341">ioutil</a></span><span class="op" id="3476630">.</span><span class="ident" id="3476631">Discard</span><span class="op" id="3476638">,</span>&nbsp;<span class="ident" id="3476640"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476641">.</span><span class="ident" id="3476642">Body</span><span class="op" id="3476646">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476651"><a href="/net/http/transfer.go.html#3476192">ncopy</a></span>&nbsp;<span class="op" id="3476657">+=</span>&nbsp;<span class="ident" id="3476660"><a href="/net/http/transfer.go.html#3476586">nextra</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476673">if</span>&nbsp;<span class="ident" id="3476676"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476680">!=</span>&nbsp;<span class="ident" id="3476683">nil</span>&nbsp;<span class="op" id="3476687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476692">return</span>&nbsp;<span class="ident" id="3476699"><a href="/net/http/transfer.go.html#3476177">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476705">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476709">if</span>&nbsp;<span class="ident" id="3476712"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476716">=</span>&nbsp;<span class="ident" id="3476718"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476719">.</span><span class="ident" id="3476720">BodyCloser</span><span class="op" id="3476730">.</span><span class="ident" id="3476731">Close</span><span class="op" id="3476736">(</span><span class="op" id="3476737">)</span><span class="op" id="3476738">;</span>&nbsp;<span class="ident" id="3476740"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3476744">!=</span>&nbsp;<span class="ident" id="3476747">nil</span>&nbsp;<span class="op" id="3476751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476756">return</span>&nbsp;<span class="ident" id="3476763"><a href="/net/http/transfer.go.html#3476177">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476776">if</span>&nbsp;<span class="op" id="3476779">!</span><span class="ident" id="3476780"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476781">.</span><span class="ident" id="3476782">ResponseToHEAD</span>&nbsp;<span class="op" id="3476797">&amp;&amp;</span>&nbsp;<span class="ident" id="3476800"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476801">.</span><span class="ident" id="3476802">ContentLength</span>&nbsp;<span class="op" id="3476816">!=</span>&nbsp;<span class="op" id="3476819">-</span><span class="num" id="3476820">1</span>&nbsp;<span class="op" id="3476822">&amp;&amp;</span>&nbsp;<span class="ident" id="3476825"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476826">.</span><span class="ident" id="3476827">ContentLength</span>&nbsp;<span class="op" id="3476841">!=</span>&nbsp;<span class="ident" id="3476844"><a href="/net/http/transfer.go.html#3476192">ncopy</a></span>&nbsp;<span class="op" id="3476850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476854">return</span>&nbsp;<span class="ident" id="3476861"><a href="/net/http/transfer.go.html#3471328">fmt</a></span><span class="op" id="3476864">.</span><span class="ident" id="3476865">Errorf</span><span class="op" id="3476871">(</span><span class="string" id="3476872">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3476916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476921"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3476922">.</span><span class="ident" id="3476923">ContentLength</span><span class="op" id="3476936">,</span>&nbsp;<span class="ident" id="3476938"><a href="/net/http/transfer.go.html#3476192">ncopy</a></span><span class="op" id="3476943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476950">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476999">if</span>&nbsp;<span class="ident" id="3477002"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3477009">(</span><span class="ident" id="3477010"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3477011">.</span><span class="ident" id="3477012">TransferEncoding</span><span class="op" id="3477028">)</span>&nbsp;<span class="op" id="3477030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477034">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477060">if</span>&nbsp;<span class="ident" id="3477063"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3477064">.</span><span class="ident" id="3477065">Trailer</span>&nbsp;<span class="op" id="3477073">!=</span>&nbsp;<span class="ident" id="3477076">nil</span>&nbsp;<span class="op" id="3477080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477085">if</span>&nbsp;<span class="ident" id="3477088">err</span>&nbsp;<span class="op" id="3477092">:=</span>&nbsp;<span class="ident" id="3477095"><a href="/net/http/transfer.go.html#3476122">t</a></span><span class="op" id="3477096">.</span><span class="ident" id="3477097">Trailer</span><span class="op" id="3477104">.</span><span class="ident" id="3477105">Write</span><span class="op" id="3477110">(</span><span class="ident" id="3477111"><a href="/net/http/transfer.go.html#3476151">w</a></span><span class="op" id="3477112">)</span><span class="op" id="3477113">;</span>&nbsp;<span class="ident" id="3477115"><a href="/net/http/transfer.go.html#3477088">err</a></span>&nbsp;<span class="op" id="3477119">!=</span>&nbsp;<span class="ident" id="3477122">nil</span>&nbsp;<span class="op" id="3477126">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477132">return</span>&nbsp;<span class="ident" id="3477139"><a href="/net/http/transfer.go.html#3477088">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477154">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477185">_</span><span class="op" id="3477186">,</span>&nbsp;<span class="ident" id="3477188"><a href="/net/http/transfer.go.html#3476177">err</a></span>&nbsp;<span class="op" id="3477192">=</span>&nbsp;<span class="ident" id="3477194"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3477196">.</span><span class="ident" id="3477197">WriteString</span><span class="op" id="3477208">(</span><span class="ident" id="3477209"><a href="/net/http/transfer.go.html#3476151">w</a></span><span class="op" id="3477210">,</span>&nbsp;<span class="string" id="3477212">&#34;\r\n&#34;</span><span class="op" id="3477218">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477224">return</span>&nbsp;<span class="ident" id="3477231"><a href="/net/http/transfer.go.html#3476177">err</a></span><br>
<span class="lineno"></span><span class="op" id="3477235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3477238">type</span>&nbsp;<span class="ident" id="3477243">transferReader</span>&nbsp;<span class="keyword" id="3477258">struct</span>&nbsp;<span class="op" id="3477265">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477268">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477278">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3477292"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477300">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3477314">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477319">RequestMethod</span>&nbsp;<span class="builtintype" id="3477333">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477341">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3477355">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477360">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3477374">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3477379">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477390">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3477407"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3477409">.</span><span class="ident" id="3477410">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477422">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3477439">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477446">TransferEncoding</span>&nbsp;<span class="op" id="3477463">[</span><span class="op" id="3477464">]</span><span class="builtintype" id="3477465">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477473">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3477490">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477496">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3477513"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span><span class="op" id="3477520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3477523">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3477592">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3477638">func</span>&nbsp;<span class="ident" id="3477643">bodyAllowedForStatus</span><span class="op" id="3477663">(</span><span class="ident" id="3477664">status</span>&nbsp;<span class="builtintype" id="3477671">int</span><span class="op" id="3477674">)</span>&nbsp;<span class="builtintype" id="3477676">bool</span>&nbsp;<span class="op" id="3477681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477684">switch</span>&nbsp;<span class="op" id="3477691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477694">case</span>&nbsp;<span class="ident" id="3477699"><a href="/net/http/transfer.go.html#3477664">status</a></span>&nbsp;<span class="op" id="3477706">&gt;=</span>&nbsp;<span class="num" id="3477709">100</span>&nbsp;<span class="op" id="3477713">&amp;&amp;</span>&nbsp;<span class="ident" id="3477716"><a href="/net/http/transfer.go.html#3477664">status</a></span>&nbsp;<span class="op" id="3477723">&lt;=</span>&nbsp;<span class="num" id="3477726">199</span><span class="op" id="3477729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477733">return</span>&nbsp;<span class="builtintype" id="3477740">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477747">case</span>&nbsp;<span class="ident" id="3477752"><a href="/net/http/transfer.go.html#3477664">status</a></span>&nbsp;<span class="op" id="3477759">==</span>&nbsp;<span class="num" id="3477762">204</span><span class="op" id="3477765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477769">return</span>&nbsp;<span class="builtintype" id="3477776">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477783">case</span>&nbsp;<span class="ident" id="3477788"><a href="/net/http/transfer.go.html#3477664">status</a></span>&nbsp;<span class="op" id="3477795">==</span>&nbsp;<span class="num" id="3477798">304</span><span class="op" id="3477801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477805">return</span>&nbsp;<span class="builtintype" id="3477812">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477819">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477822">return</span>&nbsp;<span class="builtintype" id="3477829">true</span><br>
<span class="lineno"></span><span class="op" id="3477834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3477837">var</span>&nbsp;<span class="op" id="3477841">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477844">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3477868">=</span>&nbsp;<span class="op" id="3477870">[</span><span class="op" id="3477871">]</span><span class="builtintype" id="3477872">string</span><span class="op" id="3477878">{</span><span class="string" id="3477879">&#34;Content-Type&#34;</span><span class="op" id="3477893">,</span>&nbsp;<span class="string" id="3477895">&#34;Content-Length&#34;</span><span class="op" id="3477911">,</span>&nbsp;<span class="string" id="3477913">&#34;Transfer-Encoding&#34;</span><span class="op" id="3477932">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477935">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3477959">=</span>&nbsp;<span class="op" id="3477961">[</span><span class="op" id="3477962">]</span><span class="builtintype" id="3477963">string</span><span class="op" id="3477969">{</span><span class="string" id="3477970">&#34;Content-Length&#34;</span><span class="op" id="3477986">,</span>&nbsp;<span class="string" id="3477988">&#34;Transfer-Encoding&#34;</span><span class="op" id="3478007">}</span><br>
<span class="lineno"></span><span class="op" id="3478009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3478012">func</span>&nbsp;<span class="ident" id="3478017">suppressedHeaders</span><span class="op" id="3478034">(</span><span class="ident" id="3478035">status</span>&nbsp;<span class="builtintype" id="3478042">int</span><span class="op" id="3478045">)</span>&nbsp;<span class="op" id="3478047">[</span><span class="op" id="3478048">]</span><span class="builtintype" id="3478049">string</span>&nbsp;<span class="op" id="3478056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478059">switch</span>&nbsp;<span class="op" id="3478066">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478069">case</span>&nbsp;<span class="ident" id="3478074"><a href="/net/http/transfer.go.html#3478035">status</a></span>&nbsp;<span class="op" id="3478081">==</span>&nbsp;<span class="num" id="3478084">304</span><span class="op" id="3478087">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478091">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478174">return</span>&nbsp;<span class="ident" id="3478181"><a href="/net/http/transfer.go.html#3477844">suppressedHeaders304</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478203">case</span>&nbsp;<span class="op" id="3478208">!</span><span class="ident" id="3478209"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3478229">(</span><span class="ident" id="3478230"><a href="/net/http/transfer.go.html#3478035">status</a></span><span class="op" id="3478236">)</span><span class="op" id="3478237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478241">return</span>&nbsp;<span class="ident" id="3478248"><a href="/net/http/transfer.go.html#3477935">suppressedHeadersNoBody</a></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478276">return</span>&nbsp;<span class="ident" id="3478283">nil</span><br>
<span class="lineno"></span><span class="op" id="3478287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3478290">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3478323">func</span>&nbsp;<span class="ident" id="3478328">readTransfer</span><span class="op" id="3478340">(</span><span class="ident" id="3478341">msg</span>&nbsp;<span class="keyword" id="3478345">interface</span><span class="op" id="3478354">{</span><span class="op" id="3478355">}</span><span class="op" id="3478356">,</span>&nbsp;<span class="ident" id="3478358">r</span>&nbsp;<span class="op" id="3478360">*</span><span class="ident" id="3478361"><a href="/net/http/transfer.go.html#3471300">bufio</a></span><span class="op" id="3478366">.</span><span class="ident" id="3478367">Reader</span><span class="op" id="3478373">)</span>&nbsp;<span class="op" id="3478375">(</span><span class="ident" id="3478376">err</span>&nbsp;<span class="builtintype" id="3478380">error</span><span class="op" id="3478385">)</span>&nbsp;<span class="op" id="3478387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478390">t</span>&nbsp;<span class="op" id="3478392">:=</span>&nbsp;<span class="op" id="3478395">&amp;</span><span class="ident" id="3478396"><a href="/net/http/transfer.go.html#3477243">transferReader</a></span><span class="op" id="3478410">{</span><span class="ident" id="3478411">RequestMethod</span><span class="op" id="3478424">:</span>&nbsp;<span class="string" id="3478426">&#34;GET&#34;</span><span class="op" id="3478431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478435">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478451">isResponse</span>&nbsp;<span class="op" id="3478462">:=</span>&nbsp;<span class="builtintype" id="3478465">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478472">switch</span>&nbsp;<span class="ident" id="3478479">rr</span>&nbsp;<span class="op" id="3478482">:=</span>&nbsp;<span class="ident" id="3478485"><a href="/net/http/transfer.go.html#3478341">msg</a></span><span class="op" id="3478488">.</span><span class="op" id="3478489">(</span><span class="keyword" id="3478490">type</span><span class="op" id="3478494">)</span>&nbsp;<span class="op" id="3478496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478499">case</span>&nbsp;<span class="op" id="3478504">*</span><span class="ident" id="3478505"><a href="/net/http/response.go.html#3392041">Response</a></span><span class="op" id="3478513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478517"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478518">.</span><span class="ident" id="3478519">Header</span>&nbsp;<span class="op" id="3478526">=</span>&nbsp;<span class="ident" id="3478528"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478530">.</span><span class="ident" id="3478531">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478540"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478541">.</span><span class="ident" id="3478542">StatusCode</span>&nbsp;<span class="op" id="3478553">=</span>&nbsp;<span class="ident" id="3478555"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478557">.</span><span class="ident" id="3478558">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478571"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478572">.</span><span class="ident" id="3478573">ProtoMajor</span>&nbsp;<span class="op" id="3478584">=</span>&nbsp;<span class="ident" id="3478586"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478588">.</span><span class="ident" id="3478589">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478602"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478603">.</span><span class="ident" id="3478604">ProtoMinor</span>&nbsp;<span class="op" id="3478615">=</span>&nbsp;<span class="ident" id="3478617"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478619">.</span><span class="ident" id="3478620">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478633"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478634">.</span><span class="ident" id="3478635">Close</span>&nbsp;<span class="op" id="3478641">=</span>&nbsp;<span class="ident" id="3478643"><a href="/net/http/transfer.go.html#3484079">shouldClose</a></span><span class="op" id="3478654">(</span><span class="ident" id="3478655"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478656">.</span><span class="ident" id="3478657">ProtoMajor</span><span class="op" id="3478667">,</span>&nbsp;<span class="ident" id="3478669"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478670">.</span><span class="ident" id="3478671">ProtoMinor</span><span class="op" id="3478681">,</span>&nbsp;<span class="ident" id="3478683"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478684">.</span><span class="ident" id="3478685">Header</span><span class="op" id="3478691">,</span>&nbsp;<span class="builtintype" id="3478693">true</span><span class="op" id="3478697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478701"><a href="/net/http/transfer.go.html#3478451">isResponse</a></span>&nbsp;<span class="op" id="3478712">=</span>&nbsp;<span class="builtintype" id="3478714">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478721">if</span>&nbsp;<span class="ident" id="3478724"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478726">.</span><span class="ident" id="3478727">Request</span>&nbsp;<span class="op" id="3478735">!=</span>&nbsp;<span class="ident" id="3478738">nil</span>&nbsp;<span class="op" id="3478742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478747"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478748">.</span><span class="ident" id="3478749">RequestMethod</span>&nbsp;<span class="op" id="3478763">=</span>&nbsp;<span class="ident" id="3478765"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478767">.</span><span class="ident" id="3478768">Request</span><span class="op" id="3478775">.</span><span class="ident" id="3478776">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478788">case</span>&nbsp;<span class="op" id="3478793">*</span><span class="ident" id="3478794"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3478801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478805"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478806">.</span><span class="ident" id="3478807">Header</span>&nbsp;<span class="op" id="3478814">=</span>&nbsp;<span class="ident" id="3478816"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478818">.</span><span class="ident" id="3478819">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478828"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478829">.</span><span class="ident" id="3478830">ProtoMajor</span>&nbsp;<span class="op" id="3478841">=</span>&nbsp;<span class="ident" id="3478843"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478845">.</span><span class="ident" id="3478846">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478859"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3478860">.</span><span class="ident" id="3478861">ProtoMinor</span>&nbsp;<span class="op" id="3478872">=</span>&nbsp;<span class="ident" id="3478874"><a href="/net/http/transfer.go.html#3478479">rr</a></span><span class="op" id="3478876">.</span><span class="ident" id="3478877">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478890">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478954">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479018"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479019">.</span><span class="ident" id="3479020">StatusCode</span>&nbsp;<span class="op" id="3479031">=</span>&nbsp;<span class="num" id="3479033">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479038">default</span><span class="op" id="3479045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3479049">panic</span><span class="op" id="3479054">(</span><span class="string" id="3479055">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3479072">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479079">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479103">if</span>&nbsp;<span class="ident" id="3479106"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479107">.</span><span class="ident" id="3479108">ProtoMajor</span>&nbsp;<span class="op" id="3479119">==</span>&nbsp;<span class="num" id="3479122">0</span>&nbsp;<span class="op" id="3479124">&amp;&amp;</span>&nbsp;<span class="ident" id="3479127"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479128">.</span><span class="ident" id="3479129">ProtoMinor</span>&nbsp;<span class="op" id="3479140">==</span>&nbsp;<span class="num" id="3479143">0</span>&nbsp;<span class="op" id="3479145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479149"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479150">.</span><span class="ident" id="3479151">ProtoMajor</span><span class="op" id="3479161">,</span>&nbsp;<span class="ident" id="3479163"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479164">.</span><span class="ident" id="3479165">ProtoMinor</span>&nbsp;<span class="op" id="3479176">=</span>&nbsp;<span class="num" id="3479178">1</span><span class="op" id="3479179">,</span>&nbsp;<span class="num" id="3479181">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479188">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479226"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479227">.</span><span class="ident" id="3479228">TransferEncoding</span><span class="op" id="3479244">,</span>&nbsp;<span class="ident" id="3479246"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479250">=</span>&nbsp;<span class="ident" id="3479252"><a href="/net/http/transfer.go.html#3481603">fixTransferEncoding</a></span><span class="op" id="3479271">(</span><span class="ident" id="3479272"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479273">.</span><span class="ident" id="3479274">RequestMethod</span><span class="op" id="3479287">,</span>&nbsp;<span class="ident" id="3479289"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479290">.</span><span class="ident" id="3479291">Header</span><span class="op" id="3479297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479300">if</span>&nbsp;<span class="ident" id="3479303"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479307">!=</span>&nbsp;<span class="ident" id="3479310">nil</span>&nbsp;<span class="op" id="3479314">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479318">return</span>&nbsp;<span class="ident" id="3479325"><a href="/net/http/transfer.go.html#3478376">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479334">realLength</span><span class="op" id="3479344">,</span>&nbsp;<span class="ident" id="3479346"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479350">:=</span>&nbsp;<span class="ident" id="3479353"><a href="/net/http/transfer.go.html#3482962">fixLength</a></span><span class="op" id="3479362">(</span><span class="ident" id="3479363"><a href="/net/http/transfer.go.html#3478451">isResponse</a></span><span class="op" id="3479373">,</span>&nbsp;<span class="ident" id="3479375"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479376">.</span><span class="ident" id="3479377">StatusCode</span><span class="op" id="3479387">,</span>&nbsp;<span class="ident" id="3479389"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479390">.</span><span class="ident" id="3479391">RequestMethod</span><span class="op" id="3479404">,</span>&nbsp;<span class="ident" id="3479406"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479407">.</span><span class="ident" id="3479408">Header</span><span class="op" id="3479414">,</span>&nbsp;<span class="ident" id="3479416"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479417">.</span><span class="ident" id="3479418">TransferEncoding</span><span class="op" id="3479434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479437">if</span>&nbsp;<span class="ident" id="3479440"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479444">!=</span>&nbsp;<span class="ident" id="3479447">nil</span>&nbsp;<span class="op" id="3479451">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479455">return</span>&nbsp;<span class="ident" id="3479462"><a href="/net/http/transfer.go.html#3478376">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479470">if</span>&nbsp;<span class="ident" id="3479473"><a href="/net/http/transfer.go.html#3478451">isResponse</a></span>&nbsp;<span class="op" id="3479484">&amp;&amp;</span>&nbsp;<span class="ident" id="3479487"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479488">.</span><span class="ident" id="3479489">RequestMethod</span>&nbsp;<span class="op" id="3479503">==</span>&nbsp;<span class="string" id="3479506">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3479513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479517">if</span>&nbsp;<span class="ident" id="3479520">n</span><span class="op" id="3479521">,</span>&nbsp;<span class="ident" id="3479523">err</span>&nbsp;<span class="op" id="3479527">:=</span>&nbsp;<span class="ident" id="3479530"><a href="/net/http/transfer.go.html#3489752">parseContentLength</a></span><span class="op" id="3479548">(</span><span class="ident" id="3479549"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479550">.</span><span class="ident" id="3479551">Header</span><span class="op" id="3479557">.</span><span class="ident" id="3479558">get</span><span class="op" id="3479561">(</span><span class="string" id="3479562">&#34;Content-Length&#34;</span><span class="op" id="3479578">)</span><span class="op" id="3479579">)</span><span class="op" id="3479580">;</span>&nbsp;<span class="ident" id="3479582"><a href="/net/http/transfer.go.html#3479523">err</a></span>&nbsp;<span class="op" id="3479586">!=</span>&nbsp;<span class="ident" id="3479589">nil</span>&nbsp;<span class="op" id="3479593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479598">return</span>&nbsp;<span class="ident" id="3479605"><a href="/net/http/transfer.go.html#3479523">err</a></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479611">}</span>&nbsp;<span class="keyword" id="3479613">else</span>&nbsp;<span class="op" id="3479618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479623"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479624">.</span><span class="ident" id="3479625">ContentLength</span>&nbsp;<span class="op" id="3479639">=</span>&nbsp;<span class="ident" id="3479641"><a href="/net/http/transfer.go.html#3479520">n</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479648">}</span>&nbsp;<span class="keyword" id="3479650">else</span>&nbsp;<span class="op" id="3479655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479659"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479660">.</span><span class="ident" id="3479661">ContentLength</span>&nbsp;<span class="op" id="3479675">=</span>&nbsp;<span class="ident" id="3479677"><a href="/net/http/transfer.go.html#3479334">realLength</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479693">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479705"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479706">.</span><span class="ident" id="3479707">Trailer</span><span class="op" id="3479714">,</span>&nbsp;<span class="ident" id="3479716"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479720">=</span>&nbsp;<span class="ident" id="3479722"><a href="/net/http/transfer.go.html#3484633">fixTrailer</a></span><span class="op" id="3479732">(</span><span class="ident" id="3479733"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479734">.</span><span class="ident" id="3479735">Header</span><span class="op" id="3479741">,</span>&nbsp;<span class="ident" id="3479743"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3479744">.</span><span class="ident" id="3479745">TransferEncoding</span><span class="op" id="3479761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479764">if</span>&nbsp;<span class="ident" id="3479767"><a href="/net/http/transfer.go.html#3478376">err</a></span>&nbsp;<span class="op" id="3479771">!=</span>&nbsp;<span class="ident" id="3479774">nil</span>&nbsp;<span class="op" id="3479778">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479782">return</span>&nbsp;<span class="ident" id="3479789"><a href="/net/http/transfer.go.html#3478376">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479798">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479876">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479947">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479977">switch</span>&nbsp;<span class="ident" id="3479984"><a href="/net/http/transfer.go.html#3478341">msg</a></span><span class="op" id="3479987">.</span><span class="op" id="3479988">(</span><span class="keyword" id="3479989">type</span><span class="op" id="3479993">)</span>&nbsp;<span class="op" id="3479995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479998">case</span>&nbsp;<span class="op" id="3480003">*</span><span class="ident" id="3480004"><a href="/net/http/response.go.html#3392041">Response</a></span><span class="op" id="3480012">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480016">if</span>&nbsp;<span class="ident" id="3480019"><a href="/net/http/transfer.go.html#3479334">realLength</a></span>&nbsp;<span class="op" id="3480030">==</span>&nbsp;<span class="op" id="3480033">-</span><span class="num" id="3480034">1</span>&nbsp;<span class="op" id="3480036">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480042">!</span><span class="ident" id="3480043"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3480050">(</span><span class="ident" id="3480051"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480052">.</span><span class="ident" id="3480053">TransferEncoding</span><span class="op" id="3480069">)</span>&nbsp;<span class="op" id="3480071">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480077"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3480097">(</span><span class="ident" id="3480098"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480099">.</span><span class="ident" id="3480100">StatusCode</span><span class="op" id="3480110">)</span>&nbsp;<span class="op" id="3480112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480117">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480139"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480140">.</span><span class="ident" id="3480141">Close</span>&nbsp;<span class="op" id="3480147">=</span>&nbsp;<span class="builtintype" id="3480149">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480159">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480163">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480230">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480306">switch</span>&nbsp;<span class="op" id="3480313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480316">case</span>&nbsp;<span class="ident" id="3480321"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3480328">(</span><span class="ident" id="3480329"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480330">.</span><span class="ident" id="3480331">TransferEncoding</span><span class="op" id="3480347">)</span><span class="op" id="3480348">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480352">if</span>&nbsp;<span class="ident" id="3480355"><a href="/net/http/transfer.go.html#3474379">noBodyExpected</a></span><span class="op" id="3480369">(</span><span class="ident" id="3480370"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480371">.</span><span class="ident" id="3480372">RequestMethod</span><span class="op" id="3480385">)</span>&nbsp;<span class="op" id="3480387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480392"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480393">.</span><span class="ident" id="3480394">Body</span>&nbsp;<span class="op" id="3480399">=</span>&nbsp;<span class="ident" id="3480401"><a href="/net/http/server.go.html#3458959">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480413">}</span>&nbsp;<span class="keyword" id="3480415">else</span>&nbsp;<span class="op" id="3480420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480425"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480426">.</span><span class="ident" id="3480427">Body</span>&nbsp;<span class="op" id="3480432">=</span>&nbsp;<span class="op" id="3480434">&amp;</span><span class="ident" id="3480435"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3480439">{</span><span class="ident" id="3480440">src</span><span class="op" id="3480443">:</span>&nbsp;<span class="ident" id="3480445"><a href="/net/http/transfer.go.html#3471354">internal</a></span><span class="op" id="3480453">.</span><span class="ident" id="3480454">NewChunkedReader</span><span class="op" id="3480470">(</span><span class="ident" id="3480471"><a href="/net/http/transfer.go.html#3478358">r</a></span><span class="op" id="3480472">)</span><span class="op" id="3480473">,</span>&nbsp;<span class="ident" id="3480475">hdr</span><span class="op" id="3480478">:</span>&nbsp;<span class="ident" id="3480480"><a href="/net/http/transfer.go.html#3478341">msg</a></span><span class="op" id="3480483">,</span>&nbsp;<span class="ident" id="3480485">r</span><span class="op" id="3480486">:</span>&nbsp;<span class="ident" id="3480488"><a href="/net/http/transfer.go.html#3478358">r</a></span><span class="op" id="3480489">,</span>&nbsp;<span class="ident" id="3480491">closing</span><span class="op" id="3480498">:</span>&nbsp;<span class="ident" id="3480500"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480501">.</span><span class="ident" id="3480502">Close</span><span class="op" id="3480507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480511">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480514">case</span>&nbsp;<span class="ident" id="3480519"><a href="/net/http/transfer.go.html#3479334">realLength</a></span>&nbsp;<span class="op" id="3480530">==</span>&nbsp;<span class="num" id="3480533">0</span><span class="op" id="3480534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480538"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480539">.</span><span class="ident" id="3480540">Body</span>&nbsp;<span class="op" id="3480545">=</span>&nbsp;<span class="ident" id="3480547"><a href="/net/http/server.go.html#3458959">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480558">case</span>&nbsp;<span class="ident" id="3480563"><a href="/net/http/transfer.go.html#3479334">realLength</a></span>&nbsp;<span class="op" id="3480574">&gt;</span>&nbsp;<span class="num" id="3480576">0</span><span class="op" id="3480577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480581"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480582">.</span><span class="ident" id="3480583">Body</span>&nbsp;<span class="op" id="3480588">=</span>&nbsp;<span class="op" id="3480590">&amp;</span><span class="ident" id="3480591"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3480595">{</span><span class="ident" id="3480596">src</span><span class="op" id="3480599">:</span>&nbsp;<span class="ident" id="3480601"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3480603">.</span><span class="ident" id="3480604">LimitReader</span><span class="op" id="3480615">(</span><span class="ident" id="3480616"><a href="/net/http/transfer.go.html#3478358">r</a></span><span class="op" id="3480617">,</span>&nbsp;<span class="ident" id="3480619"><a href="/net/http/transfer.go.html#3479334">realLength</a></span><span class="op" id="3480629">)</span><span class="op" id="3480630">,</span>&nbsp;<span class="ident" id="3480632">closing</span><span class="op" id="3480639">:</span>&nbsp;<span class="ident" id="3480641"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480642">.</span><span class="ident" id="3480643">Close</span><span class="op" id="3480648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480651">default</span><span class="op" id="3480658">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480662">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480729">if</span>&nbsp;<span class="ident" id="3480732"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480733">.</span><span class="ident" id="3480734">Close</span>&nbsp;<span class="op" id="3480740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480745">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480783"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480784">.</span><span class="ident" id="3480785">Body</span>&nbsp;<span class="op" id="3480790">=</span>&nbsp;<span class="op" id="3480792">&amp;</span><span class="ident" id="3480793"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3480797">{</span><span class="ident" id="3480798">src</span><span class="op" id="3480801">:</span>&nbsp;<span class="ident" id="3480803"><a href="/net/http/transfer.go.html#3478358">r</a></span><span class="op" id="3480804">,</span>&nbsp;<span class="ident" id="3480806">closing</span><span class="op" id="3480813">:</span>&nbsp;<span class="ident" id="3480815"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480816">.</span><span class="ident" id="3480817">Close</span><span class="op" id="3480822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480826">}</span>&nbsp;<span class="keyword" id="3480828">else</span>&nbsp;<span class="op" id="3480833">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480838">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480882"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480883">.</span><span class="ident" id="3480884">Body</span>&nbsp;<span class="op" id="3480889">=</span>&nbsp;<span class="ident" id="3480891"><a href="/net/http/server.go.html#3458959">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480910">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480927">switch</span>&nbsp;<span class="ident" id="3480934">rr</span>&nbsp;<span class="op" id="3480937">:=</span>&nbsp;<span class="ident" id="3480940"><a href="/net/http/transfer.go.html#3478341">msg</a></span><span class="op" id="3480943">.</span><span class="op" id="3480944">(</span><span class="keyword" id="3480945">type</span><span class="op" id="3480949">)</span>&nbsp;<span class="op" id="3480951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3480954">case</span>&nbsp;<span class="op" id="3480959">*</span><span class="ident" id="3480960"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3480967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480971"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3480973">.</span><span class="ident" id="3480974">Body</span>&nbsp;<span class="op" id="3480979">=</span>&nbsp;<span class="ident" id="3480981"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3480982">.</span><span class="ident" id="3480983">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480990"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3480992">.</span><span class="ident" id="3480993">ContentLength</span>&nbsp;<span class="op" id="3481007">=</span>&nbsp;<span class="ident" id="3481009"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481010">.</span><span class="ident" id="3481011">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481027"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481029">.</span><span class="ident" id="3481030">TransferEncoding</span>&nbsp;<span class="op" id="3481047">=</span>&nbsp;<span class="ident" id="3481049"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481050">.</span><span class="ident" id="3481051">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481070"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481072">.</span><span class="ident" id="3481073">Close</span>&nbsp;<span class="op" id="3481079">=</span>&nbsp;<span class="ident" id="3481081"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481082">.</span><span class="ident" id="3481083">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481091"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481093">.</span><span class="ident" id="3481094">Trailer</span>&nbsp;<span class="op" id="3481102">=</span>&nbsp;<span class="ident" id="3481104"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481105">.</span><span class="ident" id="3481106">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481115">case</span>&nbsp;<span class="op" id="3481120">*</span><span class="ident" id="3481121"><a href="/net/http/response.go.html#3392041">Response</a></span><span class="op" id="3481129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481133"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481135">.</span><span class="ident" id="3481136">Body</span>&nbsp;<span class="op" id="3481141">=</span>&nbsp;<span class="ident" id="3481143"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481144">.</span><span class="ident" id="3481145">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481152"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481154">.</span><span class="ident" id="3481155">ContentLength</span>&nbsp;<span class="op" id="3481169">=</span>&nbsp;<span class="ident" id="3481171"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481172">.</span><span class="ident" id="3481173">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481189"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481191">.</span><span class="ident" id="3481192">TransferEncoding</span>&nbsp;<span class="op" id="3481209">=</span>&nbsp;<span class="ident" id="3481211"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481212">.</span><span class="ident" id="3481213">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481232"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481234">.</span><span class="ident" id="3481235">Close</span>&nbsp;<span class="op" id="3481241">=</span>&nbsp;<span class="ident" id="3481243"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481244">.</span><span class="ident" id="3481245">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481253"><a href="/net/http/transfer.go.html#3480934">rr</a></span><span class="op" id="3481255">.</span><span class="ident" id="3481256">Trailer</span>&nbsp;<span class="op" id="3481264">=</span>&nbsp;<span class="ident" id="3481266"><a href="/net/http/transfer.go.html#3478390">t</a></span><span class="op" id="3481267">.</span><span class="ident" id="3481268">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481277">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481281">return</span>&nbsp;<span class="ident" id="3481288">nil</span><br>
<span class="lineno"></span><span class="op" id="3481292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3481295">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3481352">func</span>&nbsp;<span class="ident" id="3481357">chunked</span><span class="op" id="3481364">(</span><span class="ident" id="3481365">te</span>&nbsp;<span class="op" id="3481368">[</span><span class="op" id="3481369">]</span><span class="builtintype" id="3481370">string</span><span class="op" id="3481376">)</span>&nbsp;<span class="builtintype" id="3481378">bool</span>&nbsp;<span class="op" id="3481383">{</span>&nbsp;<span class="keyword" id="3481385">return</span>&nbsp;<span class="builtinfunc" id="3481392">len</span><span class="op" id="3481395">(</span><span class="ident" id="3481396"><a href="/net/http/transfer.go.html#3481365">te</a></span><span class="op" id="3481398">)</span>&nbsp;<span class="op" id="3481400">&gt;</span>&nbsp;<span class="num" id="3481402">0</span>&nbsp;<span class="op" id="3481404">&amp;&amp;</span>&nbsp;<span class="ident" id="3481407"><a href="/net/http/transfer.go.html#3481365">te</a></span><span class="op" id="3481409">[</span><span class="num" id="3481410">0</span><span class="op" id="3481411">]</span>&nbsp;<span class="op" id="3481413">==</span>&nbsp;<span class="string" id="3481416">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3481426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3481429">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3481486">func</span>&nbsp;<span class="ident" id="3481491">isIdentity</span><span class="op" id="3481501">(</span><span class="ident" id="3481502">te</span>&nbsp;<span class="op" id="3481505">[</span><span class="op" id="3481506">]</span><span class="builtintype" id="3481507">string</span><span class="op" id="3481513">)</span>&nbsp;<span class="builtintype" id="3481515">bool</span>&nbsp;<span class="op" id="3481520">{</span>&nbsp;<span class="keyword" id="3481522">return</span>&nbsp;<span class="builtinfunc" id="3481529">len</span><span class="op" id="3481532">(</span><span class="ident" id="3481533"><a href="/net/http/transfer.go.html#3481502">te</a></span><span class="op" id="3481535">)</span>&nbsp;<span class="op" id="3481537">==</span>&nbsp;<span class="num" id="3481540">1</span>&nbsp;<span class="op" id="3481542">&amp;&amp;</span>&nbsp;<span class="ident" id="3481545"><a href="/net/http/transfer.go.html#3481502">te</a></span><span class="op" id="3481547">[</span><span class="num" id="3481548">0</span><span class="op" id="3481549">]</span>&nbsp;<span class="op" id="3481551">==</span>&nbsp;<span class="string" id="3481554">&#34;identity&#34;</span>&nbsp;<span class="op" id="3481565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3481568">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3481598">func</span>&nbsp;<span class="ident" id="3481603">fixTransferEncoding</span><span class="op" id="3481622">(</span><span class="ident" id="3481623">requestMethod</span>&nbsp;<span class="builtintype" id="3481637">string</span><span class="op" id="3481643">,</span>&nbsp;<span class="ident" id="3481645">header</span>&nbsp;<span class="ident" id="3481652"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3481658">)</span>&nbsp;<span class="op" id="3481660">(</span><span class="op" id="3481661">[</span><span class="op" id="3481662">]</span><span class="builtintype" id="3481663">string</span><span class="op" id="3481669">,</span>&nbsp;<span class="builtintype" id="3481671">error</span><span class="op" id="3481676">)</span>&nbsp;<span class="op" id="3481678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481681">raw</span><span class="op" id="3481684">,</span>&nbsp;<span class="ident" id="3481686">present</span>&nbsp;<span class="op" id="3481694">:=</span>&nbsp;<span class="ident" id="3481697"><a href="/net/http/transfer.go.html#3481645">header</a></span><span class="op" id="3481703">[</span><span class="string" id="3481704">&#34;Transfer-Encoding&#34;</span><span class="op" id="3481723">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481726">if</span>&nbsp;<span class="op" id="3481729">!</span><span class="ident" id="3481730"><a href="/net/http/transfer.go.html#3481686">present</a></span>&nbsp;<span class="op" id="3481738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481742">return</span>&nbsp;<span class="ident" id="3481749">nil</span><span class="op" id="3481752">,</span>&nbsp;<span class="ident" id="3481754">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3481759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3481763">delete</span><span class="op" id="3481769">(</span><span class="ident" id="3481770"><a href="/net/http/transfer.go.html#3481645">header</a></span><span class="op" id="3481776">,</span>&nbsp;<span class="string" id="3481778">&#34;Transfer-Encoding&#34;</span><span class="op" id="3481797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481801">encodings</span>&nbsp;<span class="op" id="3481811">:=</span>&nbsp;<span class="ident" id="3481814"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3481821">.</span><span class="ident" id="3481822">Split</span><span class="op" id="3481827">(</span><span class="ident" id="3481828"><a href="/net/http/transfer.go.html#3481681">raw</a></span><span class="op" id="3481831">[</span><span class="num" id="3481832">0</span><span class="op" id="3481833">]</span><span class="op" id="3481834">,</span>&nbsp;<span class="string" id="3481836">&#34;,&#34;</span><span class="op" id="3481839">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481842">te</span>&nbsp;<span class="op" id="3481845">:=</span>&nbsp;<span class="builtinfunc" id="3481848">make</span><span class="op" id="3481852">(</span><span class="op" id="3481853">[</span><span class="op" id="3481854">]</span><span class="builtintype" id="3481855">string</span><span class="op" id="3481861">,</span>&nbsp;<span class="num" id="3481863">0</span><span class="op" id="3481864">,</span>&nbsp;<span class="builtinfunc" id="3481866">len</span><span class="op" id="3481869">(</span><span class="ident" id="3481870"><a href="/net/http/transfer.go.html#3481801">encodings</a></span><span class="op" id="3481879">)</span><span class="op" id="3481880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481883">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481946">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482008">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482067">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482112">for</span>&nbsp;<span class="ident" id="3482116">_</span><span class="op" id="3482117">,</span>&nbsp;<span class="ident" id="3482119">encoding</span>&nbsp;<span class="op" id="3482128">:=</span>&nbsp;<span class="keyword" id="3482131">range</span>&nbsp;<span class="ident" id="3482137"><a href="/net/http/transfer.go.html#3481801">encodings</a></span>&nbsp;<span class="op" id="3482147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482151"><a href="/net/http/transfer.go.html#3482119">encoding</a></span>&nbsp;<span class="op" id="3482160">=</span>&nbsp;<span class="ident" id="3482162"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3482169">.</span><span class="ident" id="3482170">ToLower</span><span class="op" id="3482177">(</span><span class="ident" id="3482178"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3482185">.</span><span class="ident" id="3482186">TrimSpace</span><span class="op" id="3482195">(</span><span class="ident" id="3482196"><a href="/net/http/transfer.go.html#3482119">encoding</a></span><span class="op" id="3482204">)</span><span class="op" id="3482205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482209">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482250">if</span>&nbsp;<span class="ident" id="3482253"><a href="/net/http/transfer.go.html#3482119">encoding</a></span>&nbsp;<span class="op" id="3482262">==</span>&nbsp;<span class="string" id="3482265">&#34;identity&#34;</span>&nbsp;<span class="op" id="3482276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482281">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482293">if</span>&nbsp;<span class="ident" id="3482296"><a href="/net/http/transfer.go.html#3482119">encoding</a></span>&nbsp;<span class="op" id="3482305">!=</span>&nbsp;<span class="string" id="3482308">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3482318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482323">return</span>&nbsp;<span class="ident" id="3482330">nil</span><span class="op" id="3482333">,</span>&nbsp;<span class="op" id="3482335">&amp;</span><span class="ident" id="3482336"><a href="/net/http/request.go.html#3365780">badStringError</a></span><span class="op" id="3482350">{</span><span class="string" id="3482351">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3482382">,</span>&nbsp;<span class="ident" id="3482384"><a href="/net/http/transfer.go.html#3482119">encoding</a></span><span class="op" id="3482392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482400"><a href="/net/http/transfer.go.html#3481842">te</a></span>&nbsp;<span class="op" id="3482403">=</span>&nbsp;<span class="ident" id="3482405"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482407">[</span><span class="num" id="3482408">0</span>&nbsp;<span class="op" id="3482410">:</span>&nbsp;<span class="builtinfunc" id="3482412">len</span><span class="op" id="3482415">(</span><span class="ident" id="3482416"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482418">)</span><span class="op" id="3482419">+</span><span class="num" id="3482420">1</span><span class="op" id="3482421">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482425"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482427">[</span><span class="builtinfunc" id="3482428">len</span><span class="op" id="3482431">(</span><span class="ident" id="3482432"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482434">)</span><span class="op" id="3482435">-</span><span class="num" id="3482436">1</span><span class="op" id="3482437">]</span>&nbsp;<span class="op" id="3482439">=</span>&nbsp;<span class="ident" id="3482441"><a href="/net/http/transfer.go.html#3482119">encoding</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482454">if</span>&nbsp;<span class="builtinfunc" id="3482457">len</span><span class="op" id="3482460">(</span><span class="ident" id="3482461"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482463">)</span>&nbsp;<span class="op" id="3482465">&gt;</span>&nbsp;<span class="num" id="3482467">1</span>&nbsp;<span class="op" id="3482469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482473">return</span>&nbsp;<span class="ident" id="3482480">nil</span><span class="op" id="3482483">,</span>&nbsp;<span class="op" id="3482485">&amp;</span><span class="ident" id="3482486"><a href="/net/http/request.go.html#3365780">badStringError</a></span><span class="op" id="3482500">{</span><span class="string" id="3482501">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3482530">,</span>&nbsp;<span class="ident" id="3482532"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3482539">.</span><span class="ident" id="3482540">Join</span><span class="op" id="3482544">(</span><span class="ident" id="3482545"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482547">,</span>&nbsp;<span class="string" id="3482549">&#34;,&#34;</span><span class="op" id="3482552">)</span><span class="op" id="3482553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482556">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482559">if</span>&nbsp;<span class="builtinfunc" id="3482562">len</span><span class="op" id="3482565">(</span><span class="ident" id="3482566"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482568">)</span>&nbsp;<span class="op" id="3482570">&gt;</span>&nbsp;<span class="num" id="3482572">0</span>&nbsp;<span class="op" id="3482574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482578">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482636">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482692">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3482707">delete</span><span class="op" id="3482713">(</span><span class="ident" id="3482714"><a href="/net/http/transfer.go.html#3481645">header</a></span><span class="op" id="3482720">,</span>&nbsp;<span class="string" id="3482722">&#34;Content-Length&#34;</span><span class="op" id="3482738">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482742">return</span>&nbsp;<span class="ident" id="3482749"><a href="/net/http/transfer.go.html#3481842">te</a></span><span class="op" id="3482751">,</span>&nbsp;<span class="ident" id="3482753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482762">return</span>&nbsp;<span class="ident" id="3482769">nil</span><span class="op" id="3482772">,</span>&nbsp;<span class="ident" id="3482774">nil</span><br>
<span class="lineno"></span><span class="op" id="3482778">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3482781">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3482853">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3482924">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3482957">func</span>&nbsp;<span class="ident" id="3482962">fixLength</span><span class="op" id="3482971">(</span><span class="ident" id="3482972">isResponse</span>&nbsp;<span class="builtintype" id="3482983">bool</span><span class="op" id="3482987">,</span>&nbsp;<span class="ident" id="3482989">status</span>&nbsp;<span class="builtintype" id="3482996">int</span><span class="op" id="3482999">,</span>&nbsp;<span class="ident" id="3483001">requestMethod</span>&nbsp;<span class="builtintype" id="3483015">string</span><span class="op" id="3483021">,</span>&nbsp;<span class="ident" id="3483023">header</span>&nbsp;<span class="ident" id="3483030"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3483036">,</span>&nbsp;<span class="ident" id="3483038">te</span>&nbsp;<span class="op" id="3483041">[</span><span class="op" id="3483042">]</span><span class="builtintype" id="3483043">string</span><span class="op" id="3483049">)</span>&nbsp;<span class="op" id="3483051">(</span><span class="ident" id="3483052">int64</span><span class="op" id="3483057">,</span>&nbsp;<span class="builtintype" id="3483059">error</span><span class="op" id="3483064">)</span>&nbsp;<span class="op" id="3483066">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483070">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483113">if</span>&nbsp;<span class="ident" id="3483116"><a href="/net/http/transfer.go.html#3474379">noBodyExpected</a></span><span class="op" id="3483130">(</span><span class="ident" id="3483131"><a href="/net/http/transfer.go.html#3483001">requestMethod</a></span><span class="op" id="3483144">)</span>&nbsp;<span class="op" id="3483146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483150">return</span>&nbsp;<span class="num" id="3483157">0</span><span class="op" id="3483158">,</span>&nbsp;<span class="ident" id="3483160">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483165">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483168">if</span>&nbsp;<span class="ident" id="3483171"><a href="/net/http/transfer.go.html#3482989">status</a></span><span class="op" id="3483177">/</span><span class="num" id="3483178">100</span>&nbsp;<span class="op" id="3483182">==</span>&nbsp;<span class="num" id="3483185">1</span>&nbsp;<span class="op" id="3483187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483191">return</span>&nbsp;<span class="num" id="3483198">0</span><span class="op" id="3483199">,</span>&nbsp;<span class="ident" id="3483201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483209">switch</span>&nbsp;<span class="ident" id="3483216"><a href="/net/http/transfer.go.html#3482989">status</a></span>&nbsp;<span class="op" id="3483223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483226">case</span>&nbsp;<span class="num" id="3483231">204</span><span class="op" id="3483234">,</span>&nbsp;<span class="num" id="3483236">304</span><span class="op" id="3483239">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483243">return</span>&nbsp;<span class="num" id="3483250">0</span><span class="op" id="3483251">,</span>&nbsp;<span class="ident" id="3483253">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483262">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483299">if</span>&nbsp;<span class="ident" id="3483302"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3483309">(</span><span class="ident" id="3483310"><a href="/net/http/transfer.go.html#3483038">te</a></span><span class="op" id="3483312">)</span>&nbsp;<span class="op" id="3483314">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483318">return</span>&nbsp;<span class="op" id="3483325">-</span><span class="num" id="3483326">1</span><span class="op" id="3483327">,</span>&nbsp;<span class="ident" id="3483329">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483338">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483372">cl</span>&nbsp;<span class="op" id="3483375">:=</span>&nbsp;<span class="ident" id="3483378"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3483385">.</span><span class="ident" id="3483386">TrimSpace</span><span class="op" id="3483395">(</span><span class="ident" id="3483396"><a href="/net/http/transfer.go.html#3483023">header</a></span><span class="op" id="3483402">.</span><span class="ident" id="3483403">get</span><span class="op" id="3483406">(</span><span class="string" id="3483407">&#34;Content-Length&#34;</span><span class="op" id="3483423">)</span><span class="op" id="3483424">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483427">if</span>&nbsp;<span class="ident" id="3483430"><a href="/net/http/transfer.go.html#3483372">cl</a></span>&nbsp;<span class="op" id="3483433">!=</span>&nbsp;<span class="string" id="3483436">&#34;&#34;</span>&nbsp;<span class="op" id="3483439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483443">n</span><span class="op" id="3483444">,</span>&nbsp;<span class="ident" id="3483446">err</span>&nbsp;<span class="op" id="3483450">:=</span>&nbsp;<span class="ident" id="3483453"><a href="/net/http/transfer.go.html#3489752">parseContentLength</a></span><span class="op" id="3483471">(</span><span class="ident" id="3483472"><a href="/net/http/transfer.go.html#3483372">cl</a></span><span class="op" id="3483474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483478">if</span>&nbsp;<span class="ident" id="3483481"><a href="/net/http/transfer.go.html#3483446">err</a></span>&nbsp;<span class="op" id="3483485">!=</span>&nbsp;<span class="ident" id="3483488">nil</span>&nbsp;<span class="op" id="3483492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483497">return</span>&nbsp;<span class="op" id="3483504">-</span><span class="num" id="3483505">1</span><span class="op" id="3483506">,</span>&nbsp;<span class="ident" id="3483508"><a href="/net/http/transfer.go.html#3483446">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483514">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483518">return</span>&nbsp;<span class="ident" id="3483525"><a href="/net/http/transfer.go.html#3483443">n</a></span><span class="op" id="3483526">,</span>&nbsp;<span class="ident" id="3483528">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483533">}</span>&nbsp;<span class="keyword" id="3483535">else</span>&nbsp;<span class="op" id="3483540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483544"><a href="/net/http/transfer.go.html#3483023">header</a></span><span class="op" id="3483550">.</span><span class="ident" id="3483551">Del</span><span class="op" id="3483554">(</span><span class="string" id="3483555">&#34;Content-Length&#34;</span><span class="op" id="3483571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483578">if</span>&nbsp;<span class="op" id="3483581">!</span><span class="ident" id="3483582"><a href="/net/http/transfer.go.html#3482972">isResponse</a></span>&nbsp;<span class="op" id="3483593">&amp;&amp;</span>&nbsp;<span class="ident" id="3483596"><a href="/net/http/transfer.go.html#3483001">requestMethod</a></span>&nbsp;<span class="op" id="3483610">==</span>&nbsp;<span class="string" id="3483613">&#34;GET&#34;</span>&nbsp;<span class="op" id="3483619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483623">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483677">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483731">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483786">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483824">return</span>&nbsp;<span class="num" id="3483831">0</span><span class="op" id="3483832">,</span>&nbsp;<span class="ident" id="3483834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483843">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483919">return</span>&nbsp;<span class="op" id="3483926">-</span><span class="num" id="3483927">1</span><span class="op" id="3483928">,</span>&nbsp;<span class="ident" id="3483930">nil</span><br>
<span class="lineno">500</span><span class="op" id="3483934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3483937">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3484006">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3484039">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3484074">func</span>&nbsp;<span class="ident" id="3484079">shouldClose</span><span class="op" id="3484090">(</span><span class="ident" id="3484091">major</span><span class="op" id="3484096">,</span>&nbsp;<span class="ident" id="3484098">minor</span>&nbsp;<span class="builtintype" id="3484104">int</span><span class="op" id="3484107">,</span>&nbsp;<span class="ident" id="3484109">header</span>&nbsp;<span class="ident" id="3484116"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3484122">,</span>&nbsp;<span class="ident" id="3484124">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3484142">bool</span><span class="op" id="3484146">)</span>&nbsp;<span class="builtintype" id="3484148">bool</span>&nbsp;<span class="op" id="3484153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484156">if</span>&nbsp;<span class="ident" id="3484159"><a href="/net/http/transfer.go.html#3484091">major</a></span>&nbsp;<span class="op" id="3484165">&lt;</span>&nbsp;<span class="num" id="3484167">1</span>&nbsp;<span class="op" id="3484169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484173">return</span>&nbsp;<span class="builtintype" id="3484180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484186">}</span>&nbsp;<span class="keyword" id="3484188">else</span>&nbsp;<span class="keyword" id="3484193">if</span>&nbsp;<span class="ident" id="3484196"><a href="/net/http/transfer.go.html#3484091">major</a></span>&nbsp;<span class="op" id="3484202">==</span>&nbsp;<span class="num" id="3484205">1</span>&nbsp;<span class="op" id="3484207">&amp;&amp;</span>&nbsp;<span class="ident" id="3484210"><a href="/net/http/transfer.go.html#3484098">minor</a></span>&nbsp;<span class="op" id="3484216">==</span>&nbsp;<span class="num" id="3484219">0</span>&nbsp;<span class="op" id="3484221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484225">if</span>&nbsp;<span class="op" id="3484228">!</span><span class="ident" id="3484229"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3484236">.</span><span class="ident" id="3484237">Contains</span><span class="op" id="3484245">(</span><span class="ident" id="3484246"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3484253">.</span><span class="ident" id="3484254">ToLower</span><span class="op" id="3484261">(</span><span class="ident" id="3484262"><a href="/net/http/transfer.go.html#3484109">header</a></span><span class="op" id="3484268">.</span><span class="ident" id="3484269">get</span><span class="op" id="3484272">(</span><span class="string" id="3484273">&#34;Connection&#34;</span><span class="op" id="3484285">)</span><span class="op" id="3484286">)</span><span class="op" id="3484287">,</span>&nbsp;<span class="string" id="3484289">&#34;keep-alive&#34;</span><span class="op" id="3484301">)</span>&nbsp;<span class="op" id="3484303">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484308">return</span>&nbsp;<span class="builtintype" id="3484315">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484326">return</span>&nbsp;<span class="builtintype" id="3484333">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484340">}</span>&nbsp;<span class="keyword" id="3484342">else</span>&nbsp;<span class="op" id="3484347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484351">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484416">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484443">if</span>&nbsp;<span class="ident" id="3484446"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3484453">.</span><span class="ident" id="3484454">ToLower</span><span class="op" id="3484461">(</span><span class="ident" id="3484462"><a href="/net/http/transfer.go.html#3484109">header</a></span><span class="op" id="3484468">.</span><span class="ident" id="3484469">get</span><span class="op" id="3484472">(</span><span class="string" id="3484473">&#34;Connection&#34;</span><span class="op" id="3484485">)</span><span class="op" id="3484486">)</span>&nbsp;<span class="op" id="3484488">==</span>&nbsp;<span class="string" id="3484491">&#34;close&#34;</span>&nbsp;<span class="op" id="3484499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484504">if</span>&nbsp;<span class="ident" id="3484507"><a href="/net/http/transfer.go.html#3484124">removeCloseHeader</a></span>&nbsp;<span class="op" id="3484525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484531"><a href="/net/http/transfer.go.html#3484109">header</a></span><span class="op" id="3484537">.</span><span class="ident" id="3484538">Del</span><span class="op" id="3484541">(</span><span class="string" id="3484542">&#34;Connection&#34;</span><span class="op" id="3484554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484559">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484564">return</span>&nbsp;<span class="builtintype" id="3484571">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484584">return</span>&nbsp;<span class="builtintype" id="3484591">false</span><br>
<span class="lineno"></span><span class="op" id="3484597">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3484600">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3484628">func</span>&nbsp;<span class="ident" id="3484633">fixTrailer</span><span class="op" id="3484643">(</span><span class="ident" id="3484644">header</span>&nbsp;<span class="ident" id="3484651"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3484657">,</span>&nbsp;<span class="ident" id="3484659">te</span>&nbsp;<span class="op" id="3484662">[</span><span class="op" id="3484663">]</span><span class="builtintype" id="3484664">string</span><span class="op" id="3484670">)</span>&nbsp;<span class="op" id="3484672">(</span><span class="ident" id="3484673"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3484679">,</span>&nbsp;<span class="builtintype" id="3484681">error</span><span class="op" id="3484686">)</span>&nbsp;<span class="op" id="3484688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484691">raw</span>&nbsp;<span class="op" id="3484695">:=</span>&nbsp;<span class="ident" id="3484698"><a href="/net/http/transfer.go.html#3484644">header</a></span><span class="op" id="3484704">.</span><span class="ident" id="3484705">get</span><span class="op" id="3484708">(</span><span class="string" id="3484709">&#34;Trailer&#34;</span><span class="op" id="3484718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484721">if</span>&nbsp;<span class="ident" id="3484724"><a href="/net/http/transfer.go.html#3484691">raw</a></span>&nbsp;<span class="op" id="3484728">==</span>&nbsp;<span class="string" id="3484731">&#34;&#34;</span>&nbsp;<span class="op" id="3484734">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484738">return</span>&nbsp;<span class="ident" id="3484745">nil</span><span class="op" id="3484748">,</span>&nbsp;<span class="ident" id="3484750">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484759"><a href="/net/http/transfer.go.html#3484644">header</a></span><span class="op" id="3484765">.</span><span class="ident" id="3484766">Del</span><span class="op" id="3484769">(</span><span class="string" id="3484770">&#34;Trailer&#34;</span><span class="op" id="3484779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484782">trailer</span>&nbsp;<span class="op" id="3484790">:=</span>&nbsp;<span class="builtinfunc" id="3484793">make</span><span class="op" id="3484797">(</span><span class="ident" id="3484798"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3484804">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484807">keys</span>&nbsp;<span class="op" id="3484812">:=</span>&nbsp;<span class="ident" id="3484815"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3484822">.</span><span class="ident" id="3484823">Split</span><span class="op" id="3484828">(</span><span class="ident" id="3484829"><a href="/net/http/transfer.go.html#3484691">raw</a></span><span class="op" id="3484832">,</span>&nbsp;<span class="string" id="3484834">&#34;,&#34;</span><span class="op" id="3484837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484840">for</span>&nbsp;<span class="ident" id="3484844">_</span><span class="op" id="3484845">,</span>&nbsp;<span class="ident" id="3484847">key</span>&nbsp;<span class="op" id="3484851">:=</span>&nbsp;<span class="keyword" id="3484854">range</span>&nbsp;<span class="ident" id="3484860"><a href="/net/http/transfer.go.html#3484807">keys</a></span>&nbsp;<span class="op" id="3484865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484869"><a href="/net/http/transfer.go.html#3484847">key</a></span>&nbsp;<span class="op" id="3484873">=</span>&nbsp;<span class="ident" id="3484875"><a href="/net/http/header.go.html#3360764">CanonicalHeaderKey</a></span><span class="op" id="3484893">(</span><span class="ident" id="3484894"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3484901">.</span><span class="ident" id="3484902">TrimSpace</span><span class="op" id="3484911">(</span><span class="ident" id="3484912"><a href="/net/http/transfer.go.html#3484847">key</a></span><span class="op" id="3484915">)</span><span class="op" id="3484916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484920">switch</span>&nbsp;<span class="ident" id="3484927"><a href="/net/http/transfer.go.html#3484847">key</a></span>&nbsp;<span class="op" id="3484931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484935">case</span>&nbsp;<span class="string" id="3484940">&#34;Transfer-Encoding&#34;</span><span class="op" id="3484959">,</span>&nbsp;<span class="string" id="3484961">&#34;Trailer&#34;</span><span class="op" id="3484970">,</span>&nbsp;<span class="string" id="3484972">&#34;Content-Length&#34;</span><span class="op" id="3484988">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484993">return</span>&nbsp;<span class="ident" id="3485000">nil</span><span class="op" id="3485003">,</span>&nbsp;<span class="op" id="3485005">&amp;</span><span class="ident" id="3485006"><a href="/net/http/request.go.html#3365780">badStringError</a></span><span class="op" id="3485020">{</span><span class="string" id="3485021">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3485038">,</span>&nbsp;<span class="ident" id="3485040"><a href="/net/http/transfer.go.html#3484847">key</a></span><span class="op" id="3485043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485051"><a href="/net/http/transfer.go.html#3484782">trailer</a></span><span class="op" id="3485058">[</span><span class="ident" id="3485059"><a href="/net/http/transfer.go.html#3484847">key</a></span><span class="op" id="3485062">]</span>&nbsp;<span class="op" id="3485064">=</span>&nbsp;<span class="ident" id="3485066">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485074">if</span>&nbsp;<span class="builtinfunc" id="3485077">len</span><span class="op" id="3485080">(</span><span class="ident" id="3485081"><a href="/net/http/transfer.go.html#3484782">trailer</a></span><span class="op" id="3485088">)</span>&nbsp;<span class="op" id="3485090">==</span>&nbsp;<span class="num" id="3485093">0</span>&nbsp;<span class="op" id="3485095">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485099">return</span>&nbsp;<span class="ident" id="3485106">nil</span><span class="op" id="3485109">,</span>&nbsp;<span class="ident" id="3485111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485119">if</span>&nbsp;<span class="op" id="3485122">!</span><span class="ident" id="3485123"><a href="/net/http/transfer.go.html#3481357">chunked</a></span><span class="op" id="3485130">(</span><span class="ident" id="3485131"><a href="/net/http/transfer.go.html#3484659">te</a></span><span class="op" id="3485133">)</span>&nbsp;<span class="op" id="3485135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485139">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485168">return</span>&nbsp;<span class="ident" id="3485175">nil</span><span class="op" id="3485178">,</span>&nbsp;<span class="ident" id="3485180"><a href="/net/http/request.go.html#3365414">ErrUnexpectedTrailer</a></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485205">return</span>&nbsp;<span class="ident" id="3485212"><a href="/net/http/transfer.go.html#3484782">trailer</a></span><span class="op" id="3485219">,</span>&nbsp;<span class="ident" id="3485221">nil</span><br>
<span class="lineno"></span><span class="op" id="3485225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485228">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3485270">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3485321">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3485365">type</span>&nbsp;<span class="ident" id="3485370">body</span>&nbsp;<span class="keyword" id="3485375">struct</span>&nbsp;<span class="op" id="3485382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485385">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485393"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3485395">.</span><span class="ident" id="3485396">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485404">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3485412">interface</span><span class="op" id="3485421">{</span><span class="op" id="3485422">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3485426">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485485">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3485493">*</span><span class="ident" id="3485494"><a href="/net/http/transfer.go.html#3471300">bufio</a></span><span class="op" id="3485499">.</span><span class="ident" id="3485500">Reader</span>&nbsp;<span class="comment" id="3485507">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485557">closing</span>&nbsp;<span class="builtintype" id="3485565">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3485579">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485635">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3485642"><a href="/net/http/transfer.go.html#3471422">sync</a></span><span class="op" id="3485646">.</span><span class="ident" id="3485647">Mutex</span>&nbsp;<span class="comment" id="3485653">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485700">closed</span>&nbsp;<span class="builtintype" id="3485707">bool</span><br>
<span class="lineno">565</span><span class="op" id="3485712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485715">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3485787">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3485867">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3485931">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3485950">var</span>&nbsp;<span class="ident" id="3485954">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3485976">=</span>&nbsp;<span class="ident" id="3485978"><a href="/net/http/transfer.go.html#3471318">errors</a></span><span class="op" id="3485984">.</span><span class="ident" id="3485985">New</span><span class="op" id="3485988">(</span><span class="string" id="3485989">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3486024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3486027">func</span>&nbsp;<span class="op" id="3486032">(</span><span class="ident" id="3486033">b</span>&nbsp;<span class="op" id="3486035">*</span><span class="ident" id="3486036"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3486040">)</span>&nbsp;<span class="ident" id="3486042">Read</span><span class="op" id="3486046">(</span><span class="ident" id="3486047">p</span>&nbsp;<span class="op" id="3486049">[</span><span class="op" id="3486050">]</span><span class="builtintype" id="3486051">byte</span><span class="op" id="3486055">)</span>&nbsp;<span class="op" id="3486057">(</span><span class="ident" id="3486058">n</span>&nbsp;<span class="builtintype" id="3486060">int</span><span class="op" id="3486063">,</span>&nbsp;<span class="ident" id="3486065">err</span>&nbsp;<span class="builtintype" id="3486069">error</span><span class="op" id="3486074">)</span>&nbsp;<span class="op" id="3486076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486079"><a href="/net/http/transfer.go.html#3486033">b</a></span><span class="op" id="3486080">.</span><span class="ident" id="3486081">mu</span><span class="op" id="3486083">.</span><span class="ident" id="3486084">Lock</span><span class="op" id="3486088">(</span><span class="op" id="3486089">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486092">defer</span>&nbsp;<span class="ident" id="3486098"><a href="/net/http/transfer.go.html#3486033">b</a></span><span class="op" id="3486099">.</span><span class="ident" id="3486100">mu</span><span class="op" id="3486102">.</span><span class="ident" id="3486103">Unlock</span><span class="op" id="3486109">(</span><span class="op" id="3486110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486113">if</span>&nbsp;<span class="ident" id="3486116"><a href="/net/http/transfer.go.html#3486033">b</a></span><span class="op" id="3486117">.</span><span class="ident" id="3486118">closed</span>&nbsp;<span class="op" id="3486125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486129">return</span>&nbsp;<span class="num" id="3486136">0</span><span class="op" id="3486137">,</span>&nbsp;<span class="ident" id="3486139"><a href="/net/http/transfer.go.html#3485954">ErrBodyReadAfterClose</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486165">return</span>&nbsp;<span class="ident" id="3486172"><a href="/net/http/transfer.go.html#3486033">b</a></span><span class="op" id="3486173">.</span><span class="ident" id="3486174">readLocked</span><span class="op" id="3486184">(</span><span class="ident" id="3486185"><a href="/net/http/transfer.go.html#3486047">p</a></span><span class="op" id="3486186">)</span><br>
<span class="lineno">580</span><span class="op" id="3486188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3486191">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3486210">func</span>&nbsp;<span class="op" id="3486215">(</span><span class="ident" id="3486216">b</span>&nbsp;<span class="op" id="3486218">*</span><span class="ident" id="3486219"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3486223">)</span>&nbsp;<span class="ident" id="3486225">readLocked</span><span class="op" id="3486235">(</span><span class="ident" id="3486236">p</span>&nbsp;<span class="op" id="3486238">[</span><span class="op" id="3486239">]</span><span class="builtintype" id="3486240">byte</span><span class="op" id="3486244">)</span>&nbsp;<span class="op" id="3486246">(</span><span class="ident" id="3486247">n</span>&nbsp;<span class="builtintype" id="3486249">int</span><span class="op" id="3486252">,</span>&nbsp;<span class="ident" id="3486254">err</span>&nbsp;<span class="builtintype" id="3486258">error</span><span class="op" id="3486263">)</span>&nbsp;<span class="op" id="3486265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486268"><a href="/net/http/transfer.go.html#3486247">n</a></span><span class="op" id="3486269">,</span>&nbsp;<span class="ident" id="3486271"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3486275">=</span>&nbsp;<span class="ident" id="3486277"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3486278">.</span><span class="ident" id="3486279">src</span><span class="op" id="3486282">.</span><span class="ident" id="3486283">Read</span><span class="op" id="3486287">(</span><span class="ident" id="3486288"><a href="/net/http/transfer.go.html#3486236">p</a></span><span class="op" id="3486289">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486293">if</span>&nbsp;<span class="ident" id="3486296"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3486300">==</span>&nbsp;<span class="ident" id="3486303"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3486305">.</span><span class="ident" id="3486306">EOF</span>&nbsp;<span class="op" id="3486310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486314">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486351">if</span>&nbsp;<span class="ident" id="3486354"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3486355">.</span><span class="ident" id="3486356">hdr</span>&nbsp;<span class="op" id="3486360">!=</span>&nbsp;<span class="ident" id="3486363">nil</span>&nbsp;<span class="op" id="3486367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486372">if</span>&nbsp;<span class="ident" id="3486375">e</span>&nbsp;<span class="op" id="3486377">:=</span>&nbsp;<span class="ident" id="3486380"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3486381">.</span><span class="ident" id="3486382">readTrailer</span><span class="op" id="3486393">(</span><span class="op" id="3486394">)</span><span class="op" id="3486395">;</span>&nbsp;<span class="ident" id="3486397"><a href="/net/http/transfer.go.html#3486375">e</a></span>&nbsp;<span class="op" id="3486399">!=</span>&nbsp;<span class="ident" id="3486402">nil</span>&nbsp;<span class="op" id="3486406">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486412"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3486416">=</span>&nbsp;<span class="ident" id="3486418"><a href="/net/http/transfer.go.html#3486375">e</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486428"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3486429">.</span><span class="ident" id="3486430">hdr</span>&nbsp;<span class="op" id="3486434">=</span>&nbsp;<span class="ident" id="3486436">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486442">}</span>&nbsp;<span class="keyword" id="3486444">else</span>&nbsp;<span class="op" id="3486449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486454">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486531">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486590">if</span>&nbsp;<span class="ident" id="3486593">lr</span><span class="op" id="3486595">,</span>&nbsp;<span class="ident" id="3486597">ok</span>&nbsp;<span class="op" id="3486600">:=</span>&nbsp;<span class="ident" id="3486603"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3486604">.</span><span class="ident" id="3486605">src</span><span class="op" id="3486608">.</span><span class="op" id="3486609">(</span><span class="op" id="3486610">*</span><span class="ident" id="3486611"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3486613">.</span><span class="ident" id="3486614">LimitedReader</span><span class="op" id="3486627">)</span><span class="op" id="3486628">;</span>&nbsp;<span class="ident" id="3486630"><a href="/net/http/transfer.go.html#3486597">ok</a></span>&nbsp;<span class="op" id="3486633">&amp;&amp;</span>&nbsp;<span class="ident" id="3486636"><a href="/net/http/transfer.go.html#3486593">lr</a></span><span class="op" id="3486638">.</span><span class="ident" id="3486639">N</span>&nbsp;<span class="op" id="3486641">&gt;</span>&nbsp;<span class="num" id="3486643">0</span>&nbsp;<span class="op" id="3486645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486651"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3486655">=</span>&nbsp;<span class="ident" id="3486657"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3486659">.</span><span class="ident" id="3486660">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486684">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486691">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486753">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486816">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486876">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486937">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486982">if</span>&nbsp;<span class="ident" id="3486985"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3486989">==</span>&nbsp;<span class="ident" id="3486992">nil</span>&nbsp;<span class="op" id="3486996">&amp;&amp;</span>&nbsp;<span class="ident" id="3486999"><a href="/net/http/transfer.go.html#3486247">n</a></span>&nbsp;<span class="op" id="3487001">&gt;</span>&nbsp;<span class="num" id="3487003">0</span>&nbsp;<span class="op" id="3487005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487009">if</span>&nbsp;<span class="ident" id="3487012">lr</span><span class="op" id="3487014">,</span>&nbsp;<span class="ident" id="3487016">ok</span>&nbsp;<span class="op" id="3487019">:=</span>&nbsp;<span class="ident" id="3487022"><a href="/net/http/transfer.go.html#3486216">b</a></span><span class="op" id="3487023">.</span><span class="ident" id="3487024">src</span><span class="op" id="3487027">.</span><span class="op" id="3487028">(</span><span class="op" id="3487029">*</span><span class="ident" id="3487030"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3487032">.</span><span class="ident" id="3487033">LimitedReader</span><span class="op" id="3487046">)</span><span class="op" id="3487047">;</span>&nbsp;<span class="ident" id="3487049"><a href="/net/http/transfer.go.html#3487016">ok</a></span>&nbsp;<span class="op" id="3487052">&amp;&amp;</span>&nbsp;<span class="ident" id="3487055"><a href="/net/http/transfer.go.html#3487012">lr</a></span><span class="op" id="3487057">.</span><span class="ident" id="3487058">N</span>&nbsp;<span class="op" id="3487060">==</span>&nbsp;<span class="num" id="3487063">0</span>&nbsp;<span class="op" id="3487065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487070"><a href="/net/http/transfer.go.html#3486254">err</a></span>&nbsp;<span class="op" id="3487074">=</span>&nbsp;<span class="ident" id="3487076"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3487078">.</span><span class="ident" id="3487079">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487092">return</span>&nbsp;<span class="ident" id="3487099"><a href="/net/http/transfer.go.html#3486247">n</a></span><span class="op" id="3487100">,</span>&nbsp;<span class="ident" id="3487102"><a href="/net/http/transfer.go.html#3486254">err</a></span><br>
<span class="lineno"></span><span class="op" id="3487106">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3487109">var</span>&nbsp;<span class="op" id="3487113">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487116">singleCRLF</span>&nbsp;<span class="op" id="3487127">=</span>&nbsp;<span class="op" id="3487129">[</span><span class="op" id="3487130">]</span><span class="builtintype" id="3487131">byte</span><span class="op" id="3487135">(</span><span class="string" id="3487136">&#34;\r\n&#34;</span><span class="op" id="3487142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487145">doubleCRLF</span>&nbsp;<span class="op" id="3487156">=</span>&nbsp;<span class="op" id="3487158">[</span><span class="op" id="3487159">]</span><span class="builtintype" id="3487160">byte</span><span class="op" id="3487164">(</span><span class="string" id="3487165">&#34;\r\n\r\n&#34;</span><span class="op" id="3487175">)</span><br>
<span class="lineno"></span><span class="op" id="3487177">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3487180">func</span>&nbsp;<span class="ident" id="3487185">seeUpcomingDoubleCRLF</span><span class="op" id="3487206">(</span><span class="ident" id="3487207">r</span>&nbsp;<span class="op" id="3487209">*</span><span class="ident" id="3487210"><a href="/net/http/transfer.go.html#3471300">bufio</a></span><span class="op" id="3487215">.</span><span class="ident" id="3487216">Reader</span><span class="op" id="3487222">)</span>&nbsp;<span class="builtintype" id="3487224">bool</span>&nbsp;<span class="op" id="3487229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487232">for</span>&nbsp;<span class="ident" id="3487236">peekSize</span>&nbsp;<span class="op" id="3487245">:=</span>&nbsp;<span class="num" id="3487248">4</span><span class="op" id="3487249">;</span>&nbsp;<span class="op" id="3487251">;</span>&nbsp;<span class="ident" id="3487253"><a href="/net/http/transfer.go.html#3487236">peekSize</a></span><span class="op" id="3487261">++</span>&nbsp;<span class="op" id="3487264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487268">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487317">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487369">buf</span><span class="op" id="3487372">,</span>&nbsp;<span class="ident" id="3487374">err</span>&nbsp;<span class="op" id="3487378">:=</span>&nbsp;<span class="ident" id="3487381"><a href="/net/http/transfer.go.html#3487207">r</a></span><span class="op" id="3487382">.</span><span class="ident" id="3487383">Peek</span><span class="op" id="3487387">(</span><span class="ident" id="3487388"><a href="/net/http/transfer.go.html#3487236">peekSize</a></span><span class="op" id="3487396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487400">if</span>&nbsp;<span class="ident" id="3487403"><a href="/net/http/transfer.go.html#3471309">bytes</a></span><span class="op" id="3487408">.</span><span class="ident" id="3487409">HasSuffix</span><span class="op" id="3487418">(</span><span class="ident" id="3487419"><a href="/net/http/transfer.go.html#3487369">buf</a></span><span class="op" id="3487422">,</span>&nbsp;<span class="ident" id="3487424"><a href="/net/http/transfer.go.html#3487145">doubleCRLF</a></span><span class="op" id="3487434">)</span>&nbsp;<span class="op" id="3487436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487441">return</span>&nbsp;<span class="builtintype" id="3487448">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487459">if</span>&nbsp;<span class="ident" id="3487462"><a href="/net/http/transfer.go.html#3487374">err</a></span>&nbsp;<span class="op" id="3487466">!=</span>&nbsp;<span class="ident" id="3487469">nil</span>&nbsp;<span class="op" id="3487473">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487478">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487492">return</span>&nbsp;<span class="builtintype" id="3487499">false</span><br>
<span class="lineno"></span><span class="op" id="3487505">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3487508">var</span>&nbsp;<span class="ident" id="3487512">errTrailerEOF</span>&nbsp;<span class="op" id="3487526">=</span>&nbsp;<span class="ident" id="3487528"><a href="/net/http/transfer.go.html#3471318">errors</a></span><span class="op" id="3487534">.</span><span class="ident" id="3487535">New</span><span class="op" id="3487538">(</span><span class="string" id="3487539">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3487577">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3487580">func</span>&nbsp;<span class="op" id="3487585">(</span><span class="ident" id="3487586">b</span>&nbsp;<span class="op" id="3487588">*</span><span class="ident" id="3487589"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3487593">)</span>&nbsp;<span class="ident" id="3487595">readTrailer</span><span class="op" id="3487606">(</span><span class="op" id="3487607">)</span>&nbsp;<span class="builtintype" id="3487609">error</span>&nbsp;<span class="op" id="3487615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487618">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487667">buf</span><span class="op" id="3487670">,</span>&nbsp;<span class="ident" id="3487672">err</span>&nbsp;<span class="op" id="3487676">:=</span>&nbsp;<span class="ident" id="3487679"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3487680">.</span><span class="ident" id="3487681">r</span><span class="op" id="3487682">.</span><span class="ident" id="3487683">Peek</span><span class="op" id="3487687">(</span><span class="num" id="3487688">2</span><span class="op" id="3487689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487692">if</span>&nbsp;<span class="ident" id="3487695"><a href="/net/http/transfer.go.html#3471309">bytes</a></span><span class="op" id="3487700">.</span><span class="ident" id="3487701">Equal</span><span class="op" id="3487706">(</span><span class="ident" id="3487707"><a href="/net/http/transfer.go.html#3487667">buf</a></span><span class="op" id="3487710">,</span>&nbsp;<span class="ident" id="3487712"><a href="/net/http/transfer.go.html#3487116">singleCRLF</a></span><span class="op" id="3487722">)</span>&nbsp;<span class="op" id="3487724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487728"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3487729">.</span><span class="ident" id="3487730">r</span><span class="op" id="3487731">.</span><span class="ident" id="3487732">ReadByte</span><span class="op" id="3487740">(</span><span class="op" id="3487741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487745"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3487746">.</span><span class="ident" id="3487747">r</span><span class="op" id="3487748">.</span><span class="ident" id="3487749">ReadByte</span><span class="op" id="3487757">(</span><span class="op" id="3487758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487762">return</span>&nbsp;<span class="ident" id="3487769">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487777">if</span>&nbsp;<span class="builtinfunc" id="3487780">len</span><span class="op" id="3487783">(</span><span class="ident" id="3487784"><a href="/net/http/transfer.go.html#3487667">buf</a></span><span class="op" id="3487787">)</span>&nbsp;<span class="op" id="3487789">&lt;</span>&nbsp;<span class="num" id="3487791">2</span>&nbsp;<span class="op" id="3487793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487797">return</span>&nbsp;<span class="ident" id="3487804"><a href="/net/http/transfer.go.html#3487512">errTrailerEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487822">if</span>&nbsp;<span class="ident" id="3487825"><a href="/net/http/transfer.go.html#3487672">err</a></span>&nbsp;<span class="op" id="3487829">!=</span>&nbsp;<span class="ident" id="3487832">nil</span>&nbsp;<span class="op" id="3487836">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487840">return</span>&nbsp;<span class="ident" id="3487847"><a href="/net/http/transfer.go.html#3487672">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487856">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487920">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3487980">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3488044">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3488106">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3488170">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3488234">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3488297">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488371">if</span>&nbsp;<span class="op" id="3488374">!</span><span class="ident" id="3488375"><a href="/net/http/transfer.go.html#3487185">seeUpcomingDoubleCRLF</a></span><span class="op" id="3488396">(</span><span class="ident" id="3488397"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3488398">.</span><span class="ident" id="3488399">r</span><span class="op" id="3488400">)</span>&nbsp;<span class="op" id="3488402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488406">return</span>&nbsp;<span class="ident" id="3488413"><a href="/net/http/transfer.go.html#3471318">errors</a></span><span class="op" id="3488419">.</span><span class="ident" id="3488420">New</span><span class="op" id="3488423">(</span><span class="string" id="3488424">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3488476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488483">hdr</span><span class="op" id="3488486">,</span>&nbsp;<span class="ident" id="3488488"><a href="/net/http/transfer.go.html#3487672">err</a></span>&nbsp;<span class="op" id="3488492">:=</span>&nbsp;<span class="ident" id="3488495"><a href="/net/http/transfer.go.html#3471375">textproto</a></span><span class="op" id="3488504">.</span><span class="ident" id="3488505">NewReader</span><span class="op" id="3488514">(</span><span class="ident" id="3488515"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3488516">.</span><span class="ident" id="3488517">r</span><span class="op" id="3488518">)</span><span class="op" id="3488519">.</span><span class="ident" id="3488520">ReadMIMEHeader</span><span class="op" id="3488534">(</span><span class="op" id="3488535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488538">if</span>&nbsp;<span class="ident" id="3488541"><a href="/net/http/transfer.go.html#3487672">err</a></span>&nbsp;<span class="op" id="3488545">!=</span>&nbsp;<span class="ident" id="3488548">nil</span>&nbsp;<span class="op" id="3488552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488556">if</span>&nbsp;<span class="ident" id="3488559"><a href="/net/http/transfer.go.html#3487672">err</a></span>&nbsp;<span class="op" id="3488563">==</span>&nbsp;<span class="ident" id="3488566"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3488568">.</span><span class="ident" id="3488569">EOF</span>&nbsp;<span class="op" id="3488573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488578">return</span>&nbsp;<span class="ident" id="3488585"><a href="/net/http/transfer.go.html#3487512">errTrailerEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488601">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488605">return</span>&nbsp;<span class="ident" id="3488612"><a href="/net/http/transfer.go.html#3487672">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488620">switch</span>&nbsp;<span class="ident" id="3488627">rr</span>&nbsp;<span class="op" id="3488630">:=</span>&nbsp;<span class="ident" id="3488633"><a href="/net/http/transfer.go.html#3487586">b</a></span><span class="op" id="3488634">.</span><span class="ident" id="3488635">hdr</span><span class="op" id="3488638">.</span><span class="op" id="3488639">(</span><span class="keyword" id="3488640">type</span><span class="op" id="3488644">)</span>&nbsp;<span class="op" id="3488646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488649">case</span>&nbsp;<span class="op" id="3488654">*</span><span class="ident" id="3488655"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3488662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488666"><a href="/net/http/transfer.go.html#3488790">mergeSetHeader</a></span><span class="op" id="3488680">(</span><span class="op" id="3488681">&amp;</span><span class="ident" id="3488682"><a href="/net/http/transfer.go.html#3488627">rr</a></span><span class="op" id="3488684">.</span><span class="ident" id="3488685">Trailer</span><span class="op" id="3488692">,</span>&nbsp;<span class="ident" id="3488694"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3488700">(</span><span class="ident" id="3488701"><a href="/net/http/transfer.go.html#3488483">hdr</a></span><span class="op" id="3488704">)</span><span class="op" id="3488705">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488708">case</span>&nbsp;<span class="op" id="3488713">*</span><span class="ident" id="3488714"><a href="/net/http/response.go.html#3392041">Response</a></span><span class="op" id="3488722">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488726"><a href="/net/http/transfer.go.html#3488790">mergeSetHeader</a></span><span class="op" id="3488740">(</span><span class="op" id="3488741">&amp;</span><span class="ident" id="3488742"><a href="/net/http/transfer.go.html#3488627">rr</a></span><span class="op" id="3488744">.</span><span class="ident" id="3488745">Trailer</span><span class="op" id="3488752">,</span>&nbsp;<span class="ident" id="3488754"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3488760">(</span><span class="ident" id="3488761"><a href="/net/http/transfer.go.html#3488483">hdr</a></span><span class="op" id="3488764">)</span><span class="op" id="3488765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488771">return</span>&nbsp;<span class="ident" id="3488778">nil</span><br>
<span class="lineno"></span><span class="op" id="3488782">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3488785">func</span>&nbsp;<span class="ident" id="3488790">mergeSetHeader</span><span class="op" id="3488804">(</span><span class="ident" id="3488805">dst</span>&nbsp;<span class="op" id="3488809">*</span><span class="ident" id="3488810"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3488816">,</span>&nbsp;<span class="ident" id="3488818">src</span>&nbsp;<span class="ident" id="3488822"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3488828">)</span>&nbsp;<span class="op" id="3488830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488833">if</span>&nbsp;<span class="op" id="3488836">*</span><span class="ident" id="3488837"><a href="/net/http/transfer.go.html#3488805">dst</a></span>&nbsp;<span class="op" id="3488841">==</span>&nbsp;<span class="ident" id="3488844">nil</span>&nbsp;<span class="op" id="3488848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488852">*</span><span class="ident" id="3488853"><a href="/net/http/transfer.go.html#3488805">dst</a></span>&nbsp;<span class="op" id="3488857">=</span>&nbsp;<span class="ident" id="3488859"><a href="/net/http/transfer.go.html#3488818">src</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488865">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488876">for</span>&nbsp;<span class="ident" id="3488880">k</span><span class="op" id="3488881">,</span>&nbsp;<span class="ident" id="3488883">vv</span>&nbsp;<span class="op" id="3488886">:=</span>&nbsp;<span class="keyword" id="3488889">range</span>&nbsp;<span class="ident" id="3488895"><a href="/net/http/transfer.go.html#3488818">src</a></span>&nbsp;<span class="op" id="3488899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488903">(</span><span class="op" id="3488904">*</span><span class="ident" id="3488905"><a href="/net/http/transfer.go.html#3488805">dst</a></span><span class="op" id="3488908">)</span><span class="op" id="3488909">[</span><span class="ident" id="3488910"><a href="/net/http/transfer.go.html#3488880">k</a></span><span class="op" id="3488911">]</span>&nbsp;<span class="op" id="3488913">=</span>&nbsp;<span class="ident" id="3488915"><a href="/net/http/transfer.go.html#3488883">vv</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488919">}</span><br>
<span class="lineno"></span><span class="op" id="3488921">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3488924">func</span>&nbsp;<span class="op" id="3488929">(</span><span class="ident" id="3488930">b</span>&nbsp;<span class="op" id="3488932">*</span><span class="ident" id="3488933"><a href="/net/http/transfer.go.html#3485370">body</a></span><span class="op" id="3488937">)</span>&nbsp;<span class="ident" id="3488939">Close</span><span class="op" id="3488944">(</span><span class="op" id="3488945">)</span>&nbsp;<span class="builtintype" id="3488947">error</span>&nbsp;<span class="op" id="3488953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488956"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3488957">.</span><span class="ident" id="3488958">mu</span><span class="op" id="3488960">.</span><span class="ident" id="3488961">Lock</span><span class="op" id="3488965">(</span><span class="op" id="3488966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488969">defer</span>&nbsp;<span class="ident" id="3488975"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3488976">.</span><span class="ident" id="3488977">mu</span><span class="op" id="3488979">.</span><span class="ident" id="3488980">Unlock</span><span class="op" id="3488986">(</span><span class="op" id="3488987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488990">if</span>&nbsp;<span class="ident" id="3488993"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3488994">.</span><span class="ident" id="3488995">closed</span>&nbsp;<span class="op" id="3489002">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489006">return</span>&nbsp;<span class="ident" id="3489013">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489021">var</span>&nbsp;<span class="ident" id="3489025">err</span>&nbsp;<span class="builtintype" id="3489029">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489036">switch</span>&nbsp;<span class="op" id="3489043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489046">case</span>&nbsp;<span class="ident" id="3489051"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3489052">.</span><span class="ident" id="3489053">hdr</span>&nbsp;<span class="op" id="3489057">==</span>&nbsp;<span class="ident" id="3489060">nil</span>&nbsp;<span class="op" id="3489064">&amp;&amp;</span>&nbsp;<span class="ident" id="3489067"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3489068">.</span><span class="ident" id="3489069">closing</span><span class="op" id="3489076">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3489080">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3489129">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489161">default</span><span class="op" id="3489168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3489172">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3489236">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489289">_</span><span class="op" id="3489290">,</span>&nbsp;<span class="ident" id="3489292"><a href="/net/http/transfer.go.html#3489025">err</a></span>&nbsp;<span class="op" id="3489296">=</span>&nbsp;<span class="ident" id="3489298"><a href="/net/http/transfer.go.html#3471335">io</a></span><span class="op" id="3489300">.</span><span class="ident" id="3489301">Copy</span><span class="op" id="3489305">(</span><span class="ident" id="3489306"><a href="/net/http/transfer.go.html#3471341">ioutil</a></span><span class="op" id="3489312">.</span><span class="ident" id="3489313">Discard</span><span class="op" id="3489320">,</span>&nbsp;<span class="ident" id="3489322"><a href="/net/http/transfer.go.html#3489462">bodyLocked</a></span><span class="op" id="3489332">{</span><span class="ident" id="3489333"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3489334">}</span><span class="op" id="3489335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489341"><a href="/net/http/transfer.go.html#3488930">b</a></span><span class="op" id="3489342">.</span><span class="ident" id="3489343">closed</span>&nbsp;<span class="op" id="3489350">=</span>&nbsp;<span class="builtintype" id="3489352">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489358">return</span>&nbsp;<span class="ident" id="3489365"><a href="/net/http/transfer.go.html#3489025">err</a></span><br>
<span class="lineno"></span><span class="op" id="3489369">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3489372">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3489440">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3489457">type</span>&nbsp;<span class="ident" id="3489462">bodyLocked</span>&nbsp;<span class="keyword" id="3489473">struct</span>&nbsp;<span class="op" id="3489480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489483">b</span>&nbsp;<span class="op" id="3489485">*</span><span class="ident" id="3489486"><a href="/net/http/transfer.go.html#3485370">body</a></span><br>
<span class="lineno">715</span><span class="op" id="3489491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3489494">func</span>&nbsp;<span class="op" id="3489499">(</span><span class="ident" id="3489500">bl</span>&nbsp;<span class="ident" id="3489503"><a href="/net/http/transfer.go.html#3489462">bodyLocked</a></span><span class="op" id="3489513">)</span>&nbsp;<span class="ident" id="3489515">Read</span><span class="op" id="3489519">(</span><span class="ident" id="3489520">p</span>&nbsp;<span class="op" id="3489522">[</span><span class="op" id="3489523">]</span><span class="builtintype" id="3489524">byte</span><span class="op" id="3489528">)</span>&nbsp;<span class="op" id="3489530">(</span><span class="ident" id="3489531">n</span>&nbsp;<span class="builtintype" id="3489533">int</span><span class="op" id="3489536">,</span>&nbsp;<span class="ident" id="3489538">err</span>&nbsp;<span class="builtintype" id="3489542">error</span><span class="op" id="3489547">)</span>&nbsp;<span class="op" id="3489549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489552">if</span>&nbsp;<span class="ident" id="3489555"><a href="/net/http/transfer.go.html#3489500">bl</a></span><span class="op" id="3489557">.</span><span class="ident" id="3489558">b</span><span class="op" id="3489559">.</span><span class="ident" id="3489560">closed</span>&nbsp;<span class="op" id="3489567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489571">return</span>&nbsp;<span class="num" id="3489578">0</span><span class="op" id="3489579">,</span>&nbsp;<span class="ident" id="3489581"><a href="/net/http/transfer.go.html#3485954">ErrBodyReadAfterClose</a></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489607">return</span>&nbsp;<span class="ident" id="3489614"><a href="/net/http/transfer.go.html#3489500">bl</a></span><span class="op" id="3489616">.</span><span class="ident" id="3489617">b</span><span class="op" id="3489618">.</span><span class="ident" id="3489619">readLocked</span><span class="op" id="3489629">(</span><span class="ident" id="3489630"><a href="/net/http/transfer.go.html#3489520">p</a></span><span class="op" id="3489631">)</span><br>
<span class="lineno"></span><span class="op" id="3489633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3489636">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3489709">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3489747">func</span>&nbsp;<span class="ident" id="3489752">parseContentLength</span><span class="op" id="3489770">(</span><span class="ident" id="3489771">cl</span>&nbsp;<span class="builtintype" id="3489774">string</span><span class="op" id="3489780">)</span>&nbsp;<span class="op" id="3489782">(</span><span class="ident" id="3489783">int64</span><span class="op" id="3489788">,</span>&nbsp;<span class="builtintype" id="3489790">error</span><span class="op" id="3489795">)</span>&nbsp;<span class="op" id="3489797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489800"><a href="/net/http/transfer.go.html#3489771">cl</a></span>&nbsp;<span class="op" id="3489803">=</span>&nbsp;<span class="ident" id="3489805"><a href="/net/http/transfer.go.html#3471411">strings</a></span><span class="op" id="3489812">.</span><span class="ident" id="3489813">TrimSpace</span><span class="op" id="3489822">(</span><span class="ident" id="3489823"><a href="/net/http/transfer.go.html#3489771">cl</a></span><span class="op" id="3489825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489828">if</span>&nbsp;<span class="ident" id="3489831"><a href="/net/http/transfer.go.html#3489771">cl</a></span>&nbsp;<span class="op" id="3489834">==</span>&nbsp;<span class="string" id="3489837">&#34;&#34;</span>&nbsp;<span class="op" id="3489840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489844">return</span>&nbsp;<span class="op" id="3489851">-</span><span class="num" id="3489852">1</span><span class="op" id="3489853">,</span>&nbsp;<span class="ident" id="3489855">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489863">n</span><span class="op" id="3489864">,</span>&nbsp;<span class="ident" id="3489866">err</span>&nbsp;<span class="op" id="3489870">:=</span>&nbsp;<span class="ident" id="3489873"><a href="/net/http/transfer.go.html#3471400">strconv</a></span><span class="op" id="3489880">.</span><span class="ident" id="3489881">ParseInt</span><span class="op" id="3489889">(</span><span class="ident" id="3489890"><a href="/net/http/transfer.go.html#3489771">cl</a></span><span class="op" id="3489892">,</span>&nbsp;<span class="num" id="3489894">10</span><span class="op" id="3489896">,</span>&nbsp;<span class="num" id="3489898">64</span><span class="op" id="3489900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489903">if</span>&nbsp;<span class="ident" id="3489906"><a href="/net/http/transfer.go.html#3489866">err</a></span>&nbsp;<span class="op" id="3489910">!=</span>&nbsp;<span class="ident" id="3489913">nil</span>&nbsp;<span class="op" id="3489917">||</span>&nbsp;<span class="ident" id="3489920"><a href="/net/http/transfer.go.html#3489863">n</a></span>&nbsp;<span class="op" id="3489922">&lt;</span>&nbsp;<span class="num" id="3489924">0</span>&nbsp;<span class="op" id="3489926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489930">return</span>&nbsp;<span class="num" id="3489937">0</span><span class="op" id="3489938">,</span>&nbsp;<span class="op" id="3489940">&amp;</span><span class="ident" id="3489941"><a href="/net/http/request.go.html#3365780">badStringError</a></span><span class="op" id="3489955">{</span><span class="string" id="3489956">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3489976">,</span>&nbsp;<span class="ident" id="3489978"><a href="/net/http/transfer.go.html#3489771">cl</a></span><span class="op" id="3489980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489983">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489986">return</span>&nbsp;<span class="ident" id="3489993"><a href="/net/http/transfer.go.html#3489863">n</a></span><span class="op" id="3489994">,</span>&nbsp;<span class="ident" id="3489996">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3490001">}</span>
</div>
</body>
</html>
