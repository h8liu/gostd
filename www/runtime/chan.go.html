<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1478989">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1479044">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1479098">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1479149">package</span>&nbsp;<span class="ident" id="1479157">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1479166">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1479224">import</span>&nbsp;<span class="string" id="1479231">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1479241">const</span>&nbsp;<span class="op" id="1479247">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479250">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1479260">=</span>&nbsp;<span class="num" id="1479262">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479265">hchanSize</span>&nbsp;<span class="op" id="1479275">=</span>&nbsp;<span class="ident" id="1479277">unsafe</span><span class="op" id="1479283">.</span><span class="ident" id="1479284">Sizeof</span><span class="op" id="1479290">(</span><span class="ident" id="1479291">hchan</span><span class="op" id="1479296">{</span><span class="op" id="1479297">}</span><span class="op" id="1479298">)</span>&nbsp;<span class="op" id="1479300">+</span>&nbsp;<span class="builtintype" id="1479302">uintptr</span><span class="op" id="1479309">(</span><span class="op" id="1479310">-</span><span class="builtintype" id="1479311">int</span><span class="op" id="1479314">(</span><span class="ident" id="1479315">unsafe</span><span class="op" id="1479321">.</span><span class="ident" id="1479322">Sizeof</span><span class="op" id="1479328">(</span><span class="ident" id="1479329">hchan</span><span class="op" id="1479334">{</span><span class="op" id="1479335">}</span><span class="op" id="1479336">)</span><span class="op" id="1479337">)</span><span class="op" id="1479338">&amp;</span><span class="op" id="1479339">(</span><span class="ident" id="1479340">maxAlign</span><span class="op" id="1479348">-</span><span class="num" id="1479349">1</span><span class="op" id="1479350">)</span><span class="op" id="1479351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479354">debugChan</span>&nbsp;<span class="op" id="1479364">=</span>&nbsp;<span class="ident" id="1479366">false</span><br>
<span class="lineno">15</span><span class="op" id="1479372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1479375">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1479437">func</span>&nbsp;<span class="ident" id="1479442">makechan</span><span class="op" id="1479450">(</span><span class="ident" id="1479451">t</span>&nbsp;<span class="op" id="1479453">*</span><span class="ident" id="1479454">chantype</span><span class="op" id="1479462">,</span>&nbsp;<span class="ident" id="1479464">size</span>&nbsp;<span class="ident" id="1479469">int64</span><span class="op" id="1479474">)</span>&nbsp;<span class="op" id="1479476">*</span><span class="ident" id="1479477">hchan</span>&nbsp;<span class="op" id="1479483">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479486">elem</span>&nbsp;<span class="op" id="1479491">:=</span>&nbsp;<span class="ident" id="1479494">t</span><span class="op" id="1479495">.</span><span class="ident" id="1479496">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1479503">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479541">if</span>&nbsp;<span class="ident" id="1479544">elem</span><span class="op" id="1479548">.</span><span class="ident" id="1479549">size</span>&nbsp;<span class="op" id="1479554">&gt;=</span>&nbsp;<span class="num" id="1479557">1</span><span class="op" id="1479558">&lt;&lt;</span><span class="num" id="1479560">16</span>&nbsp;<span class="op" id="1479563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479567">gothrow</span><span class="op" id="1479574">(</span><span class="string" id="1479575">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1479615">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479621">if</span>&nbsp;<span class="ident" id="1479624">hchanSize</span><span class="op" id="1479633">%</span><span class="ident" id="1479634">maxAlign</span>&nbsp;<span class="op" id="1479643">!=</span>&nbsp;<span class="num" id="1479646">0</span>&nbsp;<span class="op" id="1479648">||</span>&nbsp;<span class="ident" id="1479651">elem</span><span class="op" id="1479655">.</span><span class="ident" id="1479656">align</span>&nbsp;<span class="op" id="1479662">&gt;</span>&nbsp;<span class="ident" id="1479664">maxAlign</span>&nbsp;<span class="op" id="1479673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479677">gothrow</span><span class="op" id="1479684">(</span><span class="string" id="1479685">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1479710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479716">if</span>&nbsp;<span class="ident" id="1479719">size</span>&nbsp;<span class="op" id="1479724">&lt;</span>&nbsp;<span class="num" id="1479726">0</span>&nbsp;<span class="op" id="1479728">||</span>&nbsp;<span class="ident" id="1479731">int64</span><span class="op" id="1479736">(</span><span class="builtintype" id="1479737">uintptr</span><span class="op" id="1479744">(</span><span class="ident" id="1479745">size</span><span class="op" id="1479749">)</span><span class="op" id="1479750">)</span>&nbsp;<span class="op" id="1479752">!=</span>&nbsp;<span class="ident" id="1479755">size</span>&nbsp;<span class="op" id="1479760">||</span>&nbsp;<span class="op" id="1479763">(</span><span class="ident" id="1479764">elem</span><span class="op" id="1479768">.</span><span class="ident" id="1479769">size</span>&nbsp;<span class="op" id="1479774">&gt;</span>&nbsp;<span class="num" id="1479776">0</span>&nbsp;<span class="op" id="1479778">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1479781">uintptr</span><span class="op" id="1479788">(</span><span class="ident" id="1479789">size</span><span class="op" id="1479793">)</span>&nbsp;<span class="op" id="1479795">&gt;</span>&nbsp;<span class="op" id="1479797">(</span><span class="ident" id="1479798">maxmem</span><span class="op" id="1479804">-</span><span class="ident" id="1479805">hchanSize</span><span class="op" id="1479814">)</span><span class="op" id="1479815">/</span><span class="builtintype" id="1479816">uintptr</span><span class="op" id="1479823">(</span><span class="ident" id="1479824">elem</span><span class="op" id="1479828">.</span><span class="ident" id="1479829">size</span><span class="op" id="1479833">)</span><span class="op" id="1479834">)</span>&nbsp;<span class="op" id="1479836">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1479840">panic</span><span class="op" id="1479845">(</span><span class="string" id="1479846">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1479875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479882">var</span>&nbsp;<span class="ident" id="1479886">c</span>&nbsp;<span class="op" id="1479888">*</span><span class="ident" id="1479889">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479896">if</span>&nbsp;<span class="ident" id="1479899">elem</span><span class="op" id="1479903">.</span><span class="ident" id="1479904">kind</span><span class="op" id="1479908">&amp;</span><span class="ident" id="1479909">kindNoPointers</span>&nbsp;<span class="op" id="1479924">!=</span>&nbsp;<span class="num" id="1479927">0</span>&nbsp;<span class="op" id="1479929">||</span>&nbsp;<span class="ident" id="1479932">size</span>&nbsp;<span class="op" id="1479937">==</span>&nbsp;<span class="num" id="1479940">0</span>&nbsp;<span class="op" id="1479942">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1479946">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1479980">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480050">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480116">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480197">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480272">c</span>&nbsp;<span class="op" id="1480274">=</span>&nbsp;<span class="op" id="1480276">(</span><span class="op" id="1480277">*</span><span class="ident" id="1480278">hchan</span><span class="op" id="1480283">)</span><span class="op" id="1480284">(</span><span class="ident" id="1480285">mallocgc</span><span class="op" id="1480293">(</span><span class="ident" id="1480294">hchanSize</span><span class="op" id="1480303">+</span><span class="builtintype" id="1480304">uintptr</span><span class="op" id="1480311">(</span><span class="ident" id="1480312">size</span><span class="op" id="1480316">)</span><span class="op" id="1480317">*</span><span class="builtintype" id="1480318">uintptr</span><span class="op" id="1480325">(</span><span class="ident" id="1480326">elem</span><span class="op" id="1480330">.</span><span class="ident" id="1480331">size</span><span class="op" id="1480335">)</span><span class="op" id="1480336">,</span>&nbsp;<span class="ident" id="1480338">nil</span><span class="op" id="1480341">,</span>&nbsp;<span class="ident" id="1480343">flagNoScan</span><span class="op" id="1480353">)</span><span class="op" id="1480354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480358">if</span>&nbsp;<span class="ident" id="1480361">size</span>&nbsp;<span class="op" id="1480366">&gt;</span>&nbsp;<span class="num" id="1480368">0</span>&nbsp;<span class="op" id="1480370">&amp;&amp;</span>&nbsp;<span class="ident" id="1480373">elem</span><span class="op" id="1480377">.</span><span class="ident" id="1480378">size</span>&nbsp;<span class="op" id="1480383">!=</span>&nbsp;<span class="num" id="1480386">0</span>&nbsp;<span class="op" id="1480388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480393">c</span><span class="op" id="1480394">.</span><span class="ident" id="1480395">buf</span>&nbsp;<span class="op" id="1480399">=</span>&nbsp;<span class="op" id="1480401">(</span><span class="op" id="1480402">*</span><span class="builtintype" id="1480403">uint8</span><span class="op" id="1480408">)</span><span class="op" id="1480409">(</span><span class="ident" id="1480410">add</span><span class="op" id="1480413">(</span><span class="ident" id="1480414">unsafe</span><span class="op" id="1480420">.</span><span class="ident" id="1480421">Pointer</span><span class="op" id="1480428">(</span><span class="ident" id="1480429">c</span><span class="op" id="1480430">)</span><span class="op" id="1480431">,</span>&nbsp;<span class="ident" id="1480433">hchanSize</span><span class="op" id="1480442">)</span><span class="op" id="1480443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480447">}</span>&nbsp;<span class="keyword" id="1480449">else</span>&nbsp;<span class="op" id="1480454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480459">c</span><span class="op" id="1480460">.</span><span class="ident" id="1480461">buf</span>&nbsp;<span class="op" id="1480465">=</span>&nbsp;<span class="op" id="1480467">(</span><span class="op" id="1480468">*</span><span class="builtintype" id="1480469">uint8</span><span class="op" id="1480474">)</span><span class="op" id="1480475">(</span><span class="ident" id="1480476">unsafe</span><span class="op" id="1480482">.</span><span class="ident" id="1480483">Pointer</span><span class="op" id="1480490">(</span><span class="ident" id="1480491">c</span><span class="op" id="1480492">)</span><span class="op" id="1480493">)</span>&nbsp;<span class="comment" id="1480495">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480556">}</span>&nbsp;<span class="keyword" id="1480558">else</span>&nbsp;<span class="op" id="1480563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480567">c</span>&nbsp;<span class="op" id="1480569">=</span>&nbsp;<span class="builtinfunc" id="1480571">new</span><span class="op" id="1480574">(</span><span class="ident" id="1480575">hchan</span><span class="op" id="1480580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480584">c</span><span class="op" id="1480585">.</span><span class="ident" id="1480586">buf</span>&nbsp;<span class="op" id="1480590">=</span>&nbsp;<span class="op" id="1480592">(</span><span class="op" id="1480593">*</span><span class="builtintype" id="1480594">uint8</span><span class="op" id="1480599">)</span><span class="op" id="1480600">(</span><span class="ident" id="1480601">newarray</span><span class="op" id="1480609">(</span><span class="ident" id="1480610">elem</span><span class="op" id="1480614">,</span>&nbsp;<span class="builtintype" id="1480616">uintptr</span><span class="op" id="1480623">(</span><span class="ident" id="1480624">size</span><span class="op" id="1480628">)</span><span class="op" id="1480629">)</span><span class="op" id="1480630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480633">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480636">c</span><span class="op" id="1480637">.</span><span class="ident" id="1480638">elemsize</span>&nbsp;<span class="op" id="1480647">=</span>&nbsp;<span class="builtintype" id="1480649">uint16</span><span class="op" id="1480655">(</span><span class="ident" id="1480656">elem</span><span class="op" id="1480660">.</span><span class="ident" id="1480661">size</span><span class="op" id="1480665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480668">c</span><span class="op" id="1480669">.</span><span class="ident" id="1480670">elemtype</span>&nbsp;<span class="op" id="1480679">=</span>&nbsp;<span class="ident" id="1480681">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480687">c</span><span class="op" id="1480688">.</span><span class="ident" id="1480689">dataqsiz</span>&nbsp;<span class="op" id="1480698">=</span>&nbsp;<span class="builtintype" id="1480700">uint</span><span class="op" id="1480704">(</span><span class="ident" id="1480705">size</span><span class="op" id="1480709">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480713">if</span>&nbsp;<span class="ident" id="1480716">debugChan</span>&nbsp;<span class="op" id="1480726">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1480730">print</span><span class="op" id="1480735">(</span><span class="string" id="1480736">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1480753">,</span>&nbsp;<span class="ident" id="1480755">c</span><span class="op" id="1480756">,</span>&nbsp;<span class="string" id="1480758">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1480771">,</span>&nbsp;<span class="ident" id="1480773">elem</span><span class="op" id="1480777">.</span><span class="ident" id="1480778">size</span><span class="op" id="1480782">,</span>&nbsp;<span class="string" id="1480784">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1480796">,</span>&nbsp;<span class="ident" id="1480798">elem</span><span class="op" id="1480802">.</span><span class="ident" id="1480803">alg</span><span class="op" id="1480806">,</span>&nbsp;<span class="string" id="1480808">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1480821">,</span>&nbsp;<span class="ident" id="1480823">size</span><span class="op" id="1480827">,</span>&nbsp;<span class="string" id="1480829">&#34;\n&#34;</span><span class="op" id="1480833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480839">return</span>&nbsp;<span class="ident" id="1480846">c</span><br>
<span class="lineno"></span><span class="op" id="1480848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1480851">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1480911">func</span>&nbsp;<span class="ident" id="1480916">chanbuf</span><span class="op" id="1480923">(</span><span class="ident" id="1480924">c</span>&nbsp;<span class="op" id="1480926">*</span><span class="ident" id="1480927">hchan</span><span class="op" id="1480932">,</span>&nbsp;<span class="ident" id="1480934">i</span>&nbsp;<span class="builtintype" id="1480936">uint</span><span class="op" id="1480940">)</span>&nbsp;<span class="ident" id="1480942">unsafe</span><span class="op" id="1480948">.</span><span class="ident" id="1480949">Pointer</span>&nbsp;<span class="op" id="1480957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480960">return</span>&nbsp;<span class="ident" id="1480967">add</span><span class="op" id="1480970">(</span><span class="ident" id="1480971">unsafe</span><span class="op" id="1480977">.</span><span class="ident" id="1480978">Pointer</span><span class="op" id="1480985">(</span><span class="ident" id="1480986">c</span><span class="op" id="1480987">.</span><span class="ident" id="1480988">buf</span><span class="op" id="1480991">)</span><span class="op" id="1480992">,</span>&nbsp;<span class="builtintype" id="1480994">uintptr</span><span class="op" id="1481001">(</span><span class="ident" id="1481002">i</span><span class="op" id="1481003">)</span><span class="op" id="1481004">*</span><span class="builtintype" id="1481005">uintptr</span><span class="op" id="1481012">(</span><span class="ident" id="1481013">c</span><span class="op" id="1481014">.</span><span class="ident" id="1481015">elemsize</span><span class="op" id="1481023">)</span><span class="op" id="1481024">)</span><br>
<span class="lineno"></span><span class="op" id="1481026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1481029">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1481074">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1481087">func</span>&nbsp;<span class="ident" id="1481092">chansend1</span><span class="op" id="1481101">(</span><span class="ident" id="1481102">t</span>&nbsp;<span class="op" id="1481104">*</span><span class="ident" id="1481105">chantype</span><span class="op" id="1481113">,</span>&nbsp;<span class="ident" id="1481115">c</span>&nbsp;<span class="op" id="1481117">*</span><span class="ident" id="1481118">hchan</span><span class="op" id="1481123">,</span>&nbsp;<span class="ident" id="1481125">elem</span>&nbsp;<span class="ident" id="1481130">unsafe</span><span class="op" id="1481136">.</span><span class="ident" id="1481137">Pointer</span><span class="op" id="1481144">)</span>&nbsp;<span class="op" id="1481146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481149">chansend</span><span class="op" id="1481157">(</span><span class="ident" id="1481158">t</span><span class="op" id="1481159">,</span>&nbsp;<span class="ident" id="1481161">c</span><span class="op" id="1481162">,</span>&nbsp;<span class="ident" id="1481164">elem</span><span class="op" id="1481168">,</span>&nbsp;<span class="ident" id="1481170">true</span><span class="op" id="1481174">,</span>&nbsp;<span class="ident" id="1481176">getcallerpc</span><span class="op" id="1481187">(</span><span class="ident" id="1481188">unsafe</span><span class="op" id="1481194">.</span><span class="ident" id="1481195">Pointer</span><span class="op" id="1481202">(</span><span class="op" id="1481203">&amp;</span><span class="ident" id="1481204">t</span><span class="op" id="1481205">)</span><span class="op" id="1481206">)</span><span class="op" id="1481207">)</span><br>
<span class="lineno"></span><span class="op" id="1481209">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1481212">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1481546">func</span>&nbsp;<span class="ident" id="1481551">chansend</span><span class="op" id="1481559">(</span><span class="ident" id="1481560">t</span>&nbsp;<span class="op" id="1481562">*</span><span class="ident" id="1481563">chantype</span><span class="op" id="1481571">,</span>&nbsp;<span class="ident" id="1481573">c</span>&nbsp;<span class="op" id="1481575">*</span><span class="ident" id="1481576">hchan</span><span class="op" id="1481581">,</span>&nbsp;<span class="ident" id="1481583">ep</span>&nbsp;<span class="ident" id="1481586">unsafe</span><span class="op" id="1481592">.</span><span class="ident" id="1481593">Pointer</span><span class="op" id="1481600">,</span>&nbsp;<span class="ident" id="1481602">block</span>&nbsp;<span class="builtintype" id="1481608">bool</span><span class="op" id="1481612">,</span>&nbsp;<span class="ident" id="1481614">callerpc</span>&nbsp;<span class="builtintype" id="1481623">uintptr</span><span class="op" id="1481630">)</span>&nbsp;<span class="builtintype" id="1481632">bool</span>&nbsp;<span class="op" id="1481637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481640">if</span>&nbsp;<span class="ident" id="1481643">raceenabled</span>&nbsp;<span class="op" id="1481655">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481659">raceReadObjectPC</span><span class="op" id="1481675">(</span><span class="ident" id="1481676">t</span><span class="op" id="1481677">.</span><span class="ident" id="1481678">elem</span><span class="op" id="1481682">,</span>&nbsp;<span class="ident" id="1481684">ep</span><span class="op" id="1481686">,</span>&nbsp;<span class="ident" id="1481688">callerpc</span><span class="op" id="1481696">,</span>&nbsp;<span class="ident" id="1481698">funcPC</span><span class="op" id="1481704">(</span><span class="ident" id="1481705">chansend</span><span class="op" id="1481713">)</span><span class="op" id="1481714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481721">if</span>&nbsp;<span class="ident" id="1481724">c</span>&nbsp;<span class="op" id="1481726">==</span>&nbsp;<span class="ident" id="1481729">nil</span>&nbsp;<span class="op" id="1481733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481737">if</span>&nbsp;<span class="op" id="1481740">!</span><span class="ident" id="1481741">block</span>&nbsp;<span class="op" id="1481747">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481752">return</span>&nbsp;<span class="ident" id="1481759">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481771">gopark</span><span class="op" id="1481777">(</span><span class="ident" id="1481778">nil</span><span class="op" id="1481781">,</span>&nbsp;<span class="ident" id="1481783">nil</span><span class="op" id="1481786">,</span>&nbsp;<span class="string" id="1481788">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1481810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481814">gothrow</span><span class="op" id="1481821">(</span><span class="string" id="1481822">&#34;unreachable&#34;</span><span class="op" id="1481835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481838">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481842">if</span>&nbsp;<span class="ident" id="1481845">debugChan</span>&nbsp;<span class="op" id="1481855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1481859">print</span><span class="op" id="1481864">(</span><span class="string" id="1481865">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1481882">,</span>&nbsp;<span class="ident" id="1481884">c</span><span class="op" id="1481885">,</span>&nbsp;<span class="string" id="1481887">&#34;\n&#34;</span><span class="op" id="1481891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481898">if</span>&nbsp;<span class="ident" id="1481901">raceenabled</span>&nbsp;<span class="op" id="1481913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481917">racereadpc</span><span class="op" id="1481927">(</span><span class="ident" id="1481928">unsafe</span><span class="op" id="1481934">.</span><span class="ident" id="1481935">Pointer</span><span class="op" id="1481942">(</span><span class="ident" id="1481943">c</span><span class="op" id="1481944">)</span><span class="op" id="1481945">,</span>&nbsp;<span class="ident" id="1481947">callerpc</span><span class="op" id="1481955">,</span>&nbsp;<span class="ident" id="1481957">funcPC</span><span class="op" id="1481963">(</span><span class="ident" id="1481964">chansend</span><span class="op" id="1481972">)</span><span class="op" id="1481973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1481980">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482063">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482067">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482150">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482232">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482320">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482395">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482484">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482565">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482652">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482697">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482701">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482787">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482871">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482927">if</span>&nbsp;<span class="op" id="1482930">!</span><span class="ident" id="1482931">block</span>&nbsp;<span class="op" id="1482937">&amp;&amp;</span>&nbsp;<span class="ident" id="1482940">c</span><span class="op" id="1482941">.</span><span class="ident" id="1482942">closed</span>&nbsp;<span class="op" id="1482949">==</span>&nbsp;<span class="num" id="1482952">0</span>&nbsp;<span class="op" id="1482954">&amp;&amp;</span>&nbsp;<span class="op" id="1482957">(</span><span class="op" id="1482958">(</span><span class="ident" id="1482959">c</span><span class="op" id="1482960">.</span><span class="ident" id="1482961">dataqsiz</span>&nbsp;<span class="op" id="1482970">==</span>&nbsp;<span class="num" id="1482973">0</span>&nbsp;<span class="op" id="1482975">&amp;&amp;</span>&nbsp;<span class="ident" id="1482978">c</span><span class="op" id="1482979">.</span><span class="ident" id="1482980">recvq</span><span class="op" id="1482985">.</span><span class="ident" id="1482986">first</span>&nbsp;<span class="op" id="1482992">==</span>&nbsp;<span class="ident" id="1482995">nil</span><span class="op" id="1482998">)</span>&nbsp;<span class="op" id="1483000">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483005">(</span><span class="ident" id="1483006">c</span><span class="op" id="1483007">.</span><span class="ident" id="1483008">dataqsiz</span>&nbsp;<span class="op" id="1483017">&gt;</span>&nbsp;<span class="num" id="1483019">0</span>&nbsp;<span class="op" id="1483021">&amp;&amp;</span>&nbsp;<span class="ident" id="1483024">c</span><span class="op" id="1483025">.</span><span class="ident" id="1483026">qcount</span>&nbsp;<span class="op" id="1483033">==</span>&nbsp;<span class="ident" id="1483036">c</span><span class="op" id="1483037">.</span><span class="ident" id="1483038">dataqsiz</span><span class="op" id="1483046">)</span><span class="op" id="1483047">)</span>&nbsp;<span class="op" id="1483049">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483053">return</span>&nbsp;<span class="ident" id="1483060">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483071">var</span>&nbsp;<span class="ident" id="1483075">t0</span>&nbsp;<span class="ident" id="1483078">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483085">if</span>&nbsp;<span class="ident" id="1483088">blockprofilerate</span>&nbsp;<span class="op" id="1483105">&gt;</span>&nbsp;<span class="num" id="1483107">0</span>&nbsp;<span class="op" id="1483109">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483113">t0</span>&nbsp;<span class="op" id="1483116">=</span>&nbsp;<span class="ident" id="1483118">cputicks</span><span class="op" id="1483126">(</span><span class="op" id="1483127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483134">lock</span><span class="op" id="1483138">(</span><span class="op" id="1483139">&amp;</span><span class="ident" id="1483140">c</span><span class="op" id="1483141">.</span><span class="ident" id="1483142">lock</span><span class="op" id="1483146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483149">if</span>&nbsp;<span class="ident" id="1483152">c</span><span class="op" id="1483153">.</span><span class="ident" id="1483154">closed</span>&nbsp;<span class="op" id="1483161">!=</span>&nbsp;<span class="num" id="1483164">0</span>&nbsp;<span class="op" id="1483166">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483170">unlock</span><span class="op" id="1483176">(</span><span class="op" id="1483177">&amp;</span><span class="ident" id="1483178">c</span><span class="op" id="1483179">.</span><span class="ident" id="1483180">lock</span><span class="op" id="1483184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1483188">panic</span><span class="op" id="1483193">(</span><span class="string" id="1483194">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1483218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483225">if</span>&nbsp;<span class="ident" id="1483228">c</span><span class="op" id="1483229">.</span><span class="ident" id="1483230">dataqsiz</span>&nbsp;<span class="op" id="1483239">==</span>&nbsp;<span class="num" id="1483242">0</span>&nbsp;<span class="op" id="1483244">{</span>&nbsp;<span class="comment" id="1483246">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483271">sg</span>&nbsp;<span class="op" id="1483274">:=</span>&nbsp;<span class="ident" id="1483277">c</span><span class="op" id="1483278">.</span><span class="ident" id="1483279">recvq</span><span class="op" id="1483284">.</span><span class="ident" id="1483285">dequeue</span><span class="op" id="1483292">(</span><span class="op" id="1483293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483297">if</span>&nbsp;<span class="ident" id="1483300">sg</span>&nbsp;<span class="op" id="1483303">!=</span>&nbsp;<span class="ident" id="1483306">nil</span>&nbsp;<span class="op" id="1483310">{</span>&nbsp;<span class="comment" id="1483312">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483343">if</span>&nbsp;<span class="ident" id="1483346">raceenabled</span>&nbsp;<span class="op" id="1483358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483364">racesync</span><span class="op" id="1483372">(</span><span class="ident" id="1483373">c</span><span class="op" id="1483374">,</span>&nbsp;<span class="ident" id="1483376">sg</span><span class="op" id="1483378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483383">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483388">unlock</span><span class="op" id="1483394">(</span><span class="op" id="1483395">&amp;</span><span class="ident" id="1483396">c</span><span class="op" id="1483397">.</span><span class="ident" id="1483398">lock</span><span class="op" id="1483402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483408">recvg</span>&nbsp;<span class="op" id="1483414">:=</span>&nbsp;<span class="ident" id="1483417">sg</span><span class="op" id="1483419">.</span><span class="ident" id="1483420">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483425">if</span>&nbsp;<span class="ident" id="1483428">sg</span><span class="op" id="1483430">.</span><span class="ident" id="1483431">elem</span>&nbsp;<span class="op" id="1483436">!=</span>&nbsp;<span class="ident" id="1483439">nil</span>&nbsp;<span class="op" id="1483443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483449">memmove</span><span class="op" id="1483456">(</span><span class="ident" id="1483457">unsafe</span><span class="op" id="1483463">.</span><span class="ident" id="1483464">Pointer</span><span class="op" id="1483471">(</span><span class="ident" id="1483472">sg</span><span class="op" id="1483474">.</span><span class="ident" id="1483475">elem</span><span class="op" id="1483479">)</span><span class="op" id="1483480">,</span>&nbsp;<span class="ident" id="1483482">ep</span><span class="op" id="1483484">,</span>&nbsp;<span class="builtintype" id="1483486">uintptr</span><span class="op" id="1483493">(</span><span class="ident" id="1483494">c</span><span class="op" id="1483495">.</span><span class="ident" id="1483496">elemsize</span><span class="op" id="1483504">)</span><span class="op" id="1483505">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483511">sg</span><span class="op" id="1483513">.</span><span class="ident" id="1483514">elem</span>&nbsp;<span class="op" id="1483519">=</span>&nbsp;<span class="ident" id="1483521">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483533">recvg</span><span class="op" id="1483538">.</span><span class="ident" id="1483539">param</span>&nbsp;<span class="op" id="1483545">=</span>&nbsp;<span class="ident" id="1483547">unsafe</span><span class="op" id="1483553">.</span><span class="ident" id="1483554">Pointer</span><span class="op" id="1483561">(</span><span class="ident" id="1483562">sg</span><span class="op" id="1483564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483569">if</span>&nbsp;<span class="ident" id="1483572">sg</span><span class="op" id="1483574">.</span><span class="ident" id="1483575">releasetime</span>&nbsp;<span class="op" id="1483587">!=</span>&nbsp;<span class="num" id="1483590">0</span>&nbsp;<span class="op" id="1483592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483598">sg</span><span class="op" id="1483600">.</span><span class="ident" id="1483601">releasetime</span>&nbsp;<span class="op" id="1483613">=</span>&nbsp;<span class="ident" id="1483615">cputicks</span><span class="op" id="1483623">(</span><span class="op" id="1483624">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483634">goready</span><span class="op" id="1483641">(</span><span class="ident" id="1483642">recvg</span><span class="op" id="1483647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483652">return</span>&nbsp;<span class="ident" id="1483659">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483671">if</span>&nbsp;<span class="op" id="1483674">!</span><span class="ident" id="1483675">block</span>&nbsp;<span class="op" id="1483681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483686">unlock</span><span class="op" id="1483692">(</span><span class="op" id="1483693">&amp;</span><span class="ident" id="1483694">c</span><span class="op" id="1483695">.</span><span class="ident" id="1483696">lock</span><span class="op" id="1483700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483705">return</span>&nbsp;<span class="ident" id="1483712">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1483725">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483776">gp</span>&nbsp;<span class="op" id="1483779">:=</span>&nbsp;<span class="ident" id="1483782">getg</span><span class="op" id="1483786">(</span><span class="op" id="1483787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483791">mysg</span>&nbsp;<span class="op" id="1483796">:=</span>&nbsp;<span class="ident" id="1483799">acquireSudog</span><span class="op" id="1483811">(</span><span class="op" id="1483812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483816">mysg</span><span class="op" id="1483820">.</span><span class="ident" id="1483821">releasetime</span>&nbsp;<span class="op" id="1483833">=</span>&nbsp;<span class="num" id="1483835">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483839">if</span>&nbsp;<span class="ident" id="1483842">t0</span>&nbsp;<span class="op" id="1483845">!=</span>&nbsp;<span class="num" id="1483848">0</span>&nbsp;<span class="op" id="1483850">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483855">mysg</span><span class="op" id="1483859">.</span><span class="ident" id="1483860">releasetime</span>&nbsp;<span class="op" id="1483872">=</span>&nbsp;<span class="op" id="1483874">-</span><span class="num" id="1483875">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483883">mysg</span><span class="op" id="1483887">.</span><span class="ident" id="1483888">elem</span>&nbsp;<span class="op" id="1483893">=</span>&nbsp;<span class="ident" id="1483895">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483900">mysg</span><span class="op" id="1483904">.</span><span class="ident" id="1483905">waitlink</span>&nbsp;<span class="op" id="1483914">=</span>&nbsp;<span class="ident" id="1483916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483922">gp</span><span class="op" id="1483924">.</span><span class="ident" id="1483925">waiting</span>&nbsp;<span class="op" id="1483933">=</span>&nbsp;<span class="ident" id="1483935">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483942">mysg</span><span class="op" id="1483946">.</span><span class="ident" id="1483947">g</span>&nbsp;<span class="op" id="1483949">=</span>&nbsp;<span class="ident" id="1483951">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483956">mysg</span><span class="op" id="1483960">.</span><span class="ident" id="1483961">selectdone</span>&nbsp;<span class="op" id="1483972">=</span>&nbsp;<span class="ident" id="1483974">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483980">gp</span><span class="op" id="1483982">.</span><span class="ident" id="1483983">param</span>&nbsp;<span class="op" id="1483989">=</span>&nbsp;<span class="ident" id="1483991">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483997">c</span><span class="op" id="1483998">.</span><span class="ident" id="1483999">sendq</span><span class="op" id="1484004">.</span><span class="ident" id="1484005">enqueue</span><span class="op" id="1484012">(</span><span class="ident" id="1484013">mysg</span><span class="op" id="1484017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484021">goparkunlock</span><span class="op" id="1484033">(</span><span class="op" id="1484034">&amp;</span><span class="ident" id="1484035">c</span><span class="op" id="1484036">.</span><span class="ident" id="1484037">lock</span><span class="op" id="1484041">,</span>&nbsp;<span class="string" id="1484043">&#34;chan&nbsp;send&#34;</span><span class="op" id="1484054">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484059">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484084">if</span>&nbsp;<span class="ident" id="1484087">mysg</span>&nbsp;<span class="op" id="1484092">!=</span>&nbsp;<span class="ident" id="1484095">gp</span><span class="op" id="1484097">.</span><span class="ident" id="1484098">waiting</span>&nbsp;<span class="op" id="1484106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484111">gothrow</span><span class="op" id="1484118">(</span><span class="string" id="1484119">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1484149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484153">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484157">gp</span><span class="op" id="1484159">.</span><span class="ident" id="1484160">waiting</span>&nbsp;<span class="op" id="1484168">=</span>&nbsp;<span class="ident" id="1484170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484176">if</span>&nbsp;<span class="ident" id="1484179">gp</span><span class="op" id="1484181">.</span><span class="ident" id="1484182">param</span>&nbsp;<span class="op" id="1484188">==</span>&nbsp;<span class="ident" id="1484191">nil</span>&nbsp;<span class="op" id="1484195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484200">if</span>&nbsp;<span class="ident" id="1484203">c</span><span class="op" id="1484204">.</span><span class="ident" id="1484205">closed</span>&nbsp;<span class="op" id="1484212">==</span>&nbsp;<span class="num" id="1484215">0</span>&nbsp;<span class="op" id="1484217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484223">gothrow</span><span class="op" id="1484230">(</span><span class="string" id="1484231">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1484258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484263">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1484268">panic</span><span class="op" id="1484273">(</span><span class="string" id="1484274">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1484298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484306">gp</span><span class="op" id="1484308">.</span><span class="ident" id="1484309">param</span>&nbsp;<span class="op" id="1484315">=</span>&nbsp;<span class="ident" id="1484317">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484323">if</span>&nbsp;<span class="ident" id="1484326">mysg</span><span class="op" id="1484330">.</span><span class="ident" id="1484331">releasetime</span>&nbsp;<span class="op" id="1484343">&gt;</span>&nbsp;<span class="num" id="1484345">0</span>&nbsp;<span class="op" id="1484347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484352">blockevent</span><span class="op" id="1484362">(</span><span class="ident" id="1484363">int64</span><span class="op" id="1484368">(</span><span class="ident" id="1484369">mysg</span><span class="op" id="1484373">.</span><span class="ident" id="1484374">releasetime</span><span class="op" id="1484385">)</span><span class="op" id="1484386">-</span><span class="ident" id="1484387">t0</span><span class="op" id="1484389">,</span>&nbsp;<span class="num" id="1484391">2</span><span class="op" id="1484392">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484400">releaseSudog</span><span class="op" id="1484412">(</span><span class="ident" id="1484413">mysg</span><span class="op" id="1484417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484421">return</span>&nbsp;<span class="ident" id="1484428">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484438">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484463">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484505">var</span>&nbsp;<span class="ident" id="1484509">t1</span>&nbsp;<span class="ident" id="1484512">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484519">for</span>&nbsp;<span class="ident" id="1484523">c</span><span class="op" id="1484524">.</span><span class="ident" id="1484525">qcount</span>&nbsp;<span class="op" id="1484532">&gt;=</span>&nbsp;<span class="ident" id="1484535">c</span><span class="op" id="1484536">.</span><span class="ident" id="1484537">dataqsiz</span>&nbsp;<span class="op" id="1484546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484550">if</span>&nbsp;<span class="op" id="1484553">!</span><span class="ident" id="1484554">block</span>&nbsp;<span class="op" id="1484560">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484565">unlock</span><span class="op" id="1484571">(</span><span class="op" id="1484572">&amp;</span><span class="ident" id="1484573">c</span><span class="op" id="1484574">.</span><span class="ident" id="1484575">lock</span><span class="op" id="1484579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484584">return</span>&nbsp;<span class="ident" id="1484591">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484603">gp</span>&nbsp;<span class="op" id="1484606">:=</span>&nbsp;<span class="ident" id="1484609">getg</span><span class="op" id="1484613">(</span><span class="op" id="1484614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484618">mysg</span>&nbsp;<span class="op" id="1484623">:=</span>&nbsp;<span class="ident" id="1484626">acquireSudog</span><span class="op" id="1484638">(</span><span class="op" id="1484639">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484643">mysg</span><span class="op" id="1484647">.</span><span class="ident" id="1484648">releasetime</span>&nbsp;<span class="op" id="1484660">=</span>&nbsp;<span class="num" id="1484662">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484666">if</span>&nbsp;<span class="ident" id="1484669">t0</span>&nbsp;<span class="op" id="1484672">!=</span>&nbsp;<span class="num" id="1484675">0</span>&nbsp;<span class="op" id="1484677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484682">mysg</span><span class="op" id="1484686">.</span><span class="ident" id="1484687">releasetime</span>&nbsp;<span class="op" id="1484699">=</span>&nbsp;<span class="op" id="1484701">-</span><span class="num" id="1484702">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484710">mysg</span><span class="op" id="1484714">.</span><span class="ident" id="1484715">g</span>&nbsp;<span class="op" id="1484717">=</span>&nbsp;<span class="ident" id="1484719">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484724">mysg</span><span class="op" id="1484728">.</span><span class="ident" id="1484729">elem</span>&nbsp;<span class="op" id="1484734">=</span>&nbsp;<span class="ident" id="1484736">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484742">mysg</span><span class="op" id="1484746">.</span><span class="ident" id="1484747">selectdone</span>&nbsp;<span class="op" id="1484758">=</span>&nbsp;<span class="ident" id="1484760">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484766">c</span><span class="op" id="1484767">.</span><span class="ident" id="1484768">sendq</span><span class="op" id="1484773">.</span><span class="ident" id="1484774">enqueue</span><span class="op" id="1484781">(</span><span class="ident" id="1484782">mysg</span><span class="op" id="1484786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484790">goparkunlock</span><span class="op" id="1484802">(</span><span class="op" id="1484803">&amp;</span><span class="ident" id="1484804">c</span><span class="op" id="1484805">.</span><span class="ident" id="1484806">lock</span><span class="op" id="1484810">,</span>&nbsp;<span class="string" id="1484812">&#34;chan&nbsp;send&#34;</span><span class="op" id="1484823">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484828">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484864">if</span>&nbsp;<span class="ident" id="1484867">mysg</span><span class="op" id="1484871">.</span><span class="ident" id="1484872">releasetime</span>&nbsp;<span class="op" id="1484884">&gt;</span>&nbsp;<span class="num" id="1484886">0</span>&nbsp;<span class="op" id="1484888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484893">t1</span>&nbsp;<span class="op" id="1484896">=</span>&nbsp;<span class="ident" id="1484898">mysg</span><span class="op" id="1484902">.</span><span class="ident" id="1484903">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484921">releaseSudog</span><span class="op" id="1484933">(</span><span class="ident" id="1484934">mysg</span><span class="op" id="1484938">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484942">lock</span><span class="op" id="1484946">(</span><span class="op" id="1484947">&amp;</span><span class="ident" id="1484948">c</span><span class="op" id="1484949">.</span><span class="ident" id="1484950">lock</span><span class="op" id="1484954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484958">if</span>&nbsp;<span class="ident" id="1484961">c</span><span class="op" id="1484962">.</span><span class="ident" id="1484963">closed</span>&nbsp;<span class="op" id="1484970">!=</span>&nbsp;<span class="num" id="1484973">0</span>&nbsp;<span class="op" id="1484975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484980">unlock</span><span class="op" id="1484986">(</span><span class="op" id="1484987">&amp;</span><span class="ident" id="1484988">c</span><span class="op" id="1484989">.</span><span class="ident" id="1484990">lock</span><span class="op" id="1484994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1484999">panic</span><span class="op" id="1485004">(</span><span class="string" id="1485005">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1485029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485033">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485040">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485083">if</span>&nbsp;<span class="ident" id="1485086">raceenabled</span>&nbsp;<span class="op" id="1485098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485102">raceacquire</span><span class="op" id="1485113">(</span><span class="ident" id="1485114">chanbuf</span><span class="op" id="1485121">(</span><span class="ident" id="1485122">c</span><span class="op" id="1485123">,</span>&nbsp;<span class="ident" id="1485125">c</span><span class="op" id="1485126">.</span><span class="ident" id="1485127">sendx</span><span class="op" id="1485132">)</span><span class="op" id="1485133">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485137">racerelease</span><span class="op" id="1485148">(</span><span class="ident" id="1485149">chanbuf</span><span class="op" id="1485156">(</span><span class="ident" id="1485157">c</span><span class="op" id="1485158">,</span>&nbsp;<span class="ident" id="1485160">c</span><span class="op" id="1485161">.</span><span class="ident" id="1485162">sendx</span><span class="op" id="1485167">)</span><span class="op" id="1485168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485174">memmove</span><span class="op" id="1485181">(</span><span class="ident" id="1485182">chanbuf</span><span class="op" id="1485189">(</span><span class="ident" id="1485190">c</span><span class="op" id="1485191">,</span>&nbsp;<span class="ident" id="1485193">c</span><span class="op" id="1485194">.</span><span class="ident" id="1485195">sendx</span><span class="op" id="1485200">)</span><span class="op" id="1485201">,</span>&nbsp;<span class="ident" id="1485203">ep</span><span class="op" id="1485205">,</span>&nbsp;<span class="builtintype" id="1485207">uintptr</span><span class="op" id="1485214">(</span><span class="ident" id="1485215">c</span><span class="op" id="1485216">.</span><span class="ident" id="1485217">elemsize</span><span class="op" id="1485225">)</span><span class="op" id="1485226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485229">c</span><span class="op" id="1485230">.</span><span class="ident" id="1485231">sendx</span><span class="op" id="1485236">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485240">if</span>&nbsp;<span class="ident" id="1485243">c</span><span class="op" id="1485244">.</span><span class="ident" id="1485245">sendx</span>&nbsp;<span class="op" id="1485251">==</span>&nbsp;<span class="ident" id="1485254">c</span><span class="op" id="1485255">.</span><span class="ident" id="1485256">dataqsiz</span>&nbsp;<span class="op" id="1485265">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485269">c</span><span class="op" id="1485270">.</span><span class="ident" id="1485271">sendx</span>&nbsp;<span class="op" id="1485277">=</span>&nbsp;<span class="num" id="1485279">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485285">c</span><span class="op" id="1485286">.</span><span class="ident" id="1485287">qcount</span><span class="op" id="1485293">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485298">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485329">sg</span>&nbsp;<span class="op" id="1485332">:=</span>&nbsp;<span class="ident" id="1485335">c</span><span class="op" id="1485336">.</span><span class="ident" id="1485337">recvq</span><span class="op" id="1485342">.</span><span class="ident" id="1485343">dequeue</span><span class="op" id="1485350">(</span><span class="op" id="1485351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485354">if</span>&nbsp;<span class="ident" id="1485357">sg</span>&nbsp;<span class="op" id="1485360">!=</span>&nbsp;<span class="ident" id="1485363">nil</span>&nbsp;<span class="op" id="1485367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485371">recvg</span>&nbsp;<span class="op" id="1485377">:=</span>&nbsp;<span class="ident" id="1485380">sg</span><span class="op" id="1485382">.</span><span class="ident" id="1485383">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485387">unlock</span><span class="op" id="1485393">(</span><span class="op" id="1485394">&amp;</span><span class="ident" id="1485395">c</span><span class="op" id="1485396">.</span><span class="ident" id="1485397">lock</span><span class="op" id="1485401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485405">if</span>&nbsp;<span class="ident" id="1485408">sg</span><span class="op" id="1485410">.</span><span class="ident" id="1485411">releasetime</span>&nbsp;<span class="op" id="1485423">!=</span>&nbsp;<span class="num" id="1485426">0</span>&nbsp;<span class="op" id="1485428">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485433">sg</span><span class="op" id="1485435">.</span><span class="ident" id="1485436">releasetime</span>&nbsp;<span class="op" id="1485448">=</span>&nbsp;<span class="ident" id="1485450">cputicks</span><span class="op" id="1485458">(</span><span class="op" id="1485459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485467">goready</span><span class="op" id="1485474">(</span><span class="ident" id="1485475">recvg</span><span class="op" id="1485480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485483">}</span>&nbsp;<span class="keyword" id="1485485">else</span>&nbsp;<span class="op" id="1485490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485494">unlock</span><span class="op" id="1485500">(</span><span class="op" id="1485501">&amp;</span><span class="ident" id="1485502">c</span><span class="op" id="1485503">.</span><span class="ident" id="1485504">lock</span><span class="op" id="1485508">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485514">if</span>&nbsp;<span class="ident" id="1485517">t1</span>&nbsp;<span class="op" id="1485520">&gt;</span>&nbsp;<span class="num" id="1485522">0</span>&nbsp;<span class="op" id="1485524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485528">blockevent</span><span class="op" id="1485538">(</span><span class="ident" id="1485539">t1</span><span class="op" id="1485541">-</span><span class="ident" id="1485542">t0</span><span class="op" id="1485544">,</span>&nbsp;<span class="num" id="1485546">2</span><span class="op" id="1485547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485553">return</span>&nbsp;<span class="ident" id="1485560">true</span><br>
<span class="lineno">255</span><span class="op" id="1485565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1485568">func</span>&nbsp;<span class="ident" id="1485573">closechan</span><span class="op" id="1485582">(</span><span class="ident" id="1485583">c</span>&nbsp;<span class="op" id="1485585">*</span><span class="ident" id="1485586">hchan</span><span class="op" id="1485591">)</span>&nbsp;<span class="op" id="1485593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485596">if</span>&nbsp;<span class="ident" id="1485599">c</span>&nbsp;<span class="op" id="1485601">==</span>&nbsp;<span class="ident" id="1485604">nil</span>&nbsp;<span class="op" id="1485608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1485612">panic</span><span class="op" id="1485617">(</span><span class="string" id="1485618">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1485640">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485647">lock</span><span class="op" id="1485651">(</span><span class="op" id="1485652">&amp;</span><span class="ident" id="1485653">c</span><span class="op" id="1485654">.</span><span class="ident" id="1485655">lock</span><span class="op" id="1485659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485662">if</span>&nbsp;<span class="ident" id="1485665">c</span><span class="op" id="1485666">.</span><span class="ident" id="1485667">closed</span>&nbsp;<span class="op" id="1485674">!=</span>&nbsp;<span class="num" id="1485677">0</span>&nbsp;<span class="op" id="1485679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485683">unlock</span><span class="op" id="1485689">(</span><span class="op" id="1485690">&amp;</span><span class="ident" id="1485691">c</span><span class="op" id="1485692">.</span><span class="ident" id="1485693">lock</span><span class="op" id="1485697">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1485701">panic</span><span class="op" id="1485706">(</span><span class="string" id="1485707">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1485732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485739">if</span>&nbsp;<span class="ident" id="1485742">raceenabled</span>&nbsp;<span class="op" id="1485754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485758">callerpc</span>&nbsp;<span class="op" id="1485767">:=</span>&nbsp;<span class="ident" id="1485770">getcallerpc</span><span class="op" id="1485781">(</span><span class="ident" id="1485782">unsafe</span><span class="op" id="1485788">.</span><span class="ident" id="1485789">Pointer</span><span class="op" id="1485796">(</span><span class="op" id="1485797">&amp;</span><span class="ident" id="1485798">c</span><span class="op" id="1485799">)</span><span class="op" id="1485800">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485804">racewritepc</span><span class="op" id="1485815">(</span><span class="ident" id="1485816">unsafe</span><span class="op" id="1485822">.</span><span class="ident" id="1485823">Pointer</span><span class="op" id="1485830">(</span><span class="ident" id="1485831">c</span><span class="op" id="1485832">)</span><span class="op" id="1485833">,</span>&nbsp;<span class="ident" id="1485835">callerpc</span><span class="op" id="1485843">,</span>&nbsp;<span class="ident" id="1485845">funcPC</span><span class="op" id="1485851">(</span><span class="ident" id="1485852">closechan</span><span class="op" id="1485861">)</span><span class="op" id="1485862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485866">racerelease</span><span class="op" id="1485877">(</span><span class="ident" id="1485878">unsafe</span><span class="op" id="1485884">.</span><span class="ident" id="1485885">Pointer</span><span class="op" id="1485892">(</span><span class="ident" id="1485893">c</span><span class="op" id="1485894">)</span><span class="op" id="1485895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485902">c</span><span class="op" id="1485903">.</span><span class="ident" id="1485904">closed</span>&nbsp;<span class="op" id="1485911">=</span>&nbsp;<span class="num" id="1485913">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485917">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485941">for</span>&nbsp;<span class="op" id="1485945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485949">sg</span>&nbsp;<span class="op" id="1485952">:=</span>&nbsp;<span class="ident" id="1485955">c</span><span class="op" id="1485956">.</span><span class="ident" id="1485957">recvq</span><span class="op" id="1485962">.</span><span class="ident" id="1485963">dequeue</span><span class="op" id="1485970">(</span><span class="op" id="1485971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485975">if</span>&nbsp;<span class="ident" id="1485978">sg</span>&nbsp;<span class="op" id="1485981">==</span>&nbsp;<span class="ident" id="1485984">nil</span>&nbsp;<span class="op" id="1485988">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485993">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486005">gp</span>&nbsp;<span class="op" id="1486008">:=</span>&nbsp;<span class="ident" id="1486011">sg</span><span class="op" id="1486013">.</span><span class="ident" id="1486014">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486018">sg</span><span class="op" id="1486020">.</span><span class="ident" id="1486021">elem</span>&nbsp;<span class="op" id="1486026">=</span>&nbsp;<span class="ident" id="1486028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486034">gp</span><span class="op" id="1486036">.</span><span class="ident" id="1486037">param</span>&nbsp;<span class="op" id="1486043">=</span>&nbsp;<span class="ident" id="1486045">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486051">if</span>&nbsp;<span class="ident" id="1486054">sg</span><span class="op" id="1486056">.</span><span class="ident" id="1486057">releasetime</span>&nbsp;<span class="op" id="1486069">!=</span>&nbsp;<span class="num" id="1486072">0</span>&nbsp;<span class="op" id="1486074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486079">sg</span><span class="op" id="1486081">.</span><span class="ident" id="1486082">releasetime</span>&nbsp;<span class="op" id="1486094">=</span>&nbsp;<span class="ident" id="1486096">cputicks</span><span class="op" id="1486104">(</span><span class="op" id="1486105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486113">goready</span><span class="op" id="1486120">(</span><span class="ident" id="1486121">gp</span><span class="op" id="1486123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486126">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1486130">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486154">for</span>&nbsp;<span class="op" id="1486158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486162">sg</span>&nbsp;<span class="op" id="1486165">:=</span>&nbsp;<span class="ident" id="1486168">c</span><span class="op" id="1486169">.</span><span class="ident" id="1486170">sendq</span><span class="op" id="1486175">.</span><span class="ident" id="1486176">dequeue</span><span class="op" id="1486183">(</span><span class="op" id="1486184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486188">if</span>&nbsp;<span class="ident" id="1486191">sg</span>&nbsp;<span class="op" id="1486194">==</span>&nbsp;<span class="ident" id="1486197">nil</span>&nbsp;<span class="op" id="1486201">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486218">gp</span>&nbsp;<span class="op" id="1486221">:=</span>&nbsp;<span class="ident" id="1486224">sg</span><span class="op" id="1486226">.</span><span class="ident" id="1486227">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486231">sg</span><span class="op" id="1486233">.</span><span class="ident" id="1486234">elem</span>&nbsp;<span class="op" id="1486239">=</span>&nbsp;<span class="ident" id="1486241">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486247">gp</span><span class="op" id="1486249">.</span><span class="ident" id="1486250">param</span>&nbsp;<span class="op" id="1486256">=</span>&nbsp;<span class="ident" id="1486258">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486264">if</span>&nbsp;<span class="ident" id="1486267">sg</span><span class="op" id="1486269">.</span><span class="ident" id="1486270">releasetime</span>&nbsp;<span class="op" id="1486282">!=</span>&nbsp;<span class="num" id="1486285">0</span>&nbsp;<span class="op" id="1486287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486292">sg</span><span class="op" id="1486294">.</span><span class="ident" id="1486295">releasetime</span>&nbsp;<span class="op" id="1486307">=</span>&nbsp;<span class="ident" id="1486309">cputicks</span><span class="op" id="1486317">(</span><span class="op" id="1486318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486326">goready</span><span class="op" id="1486333">(</span><span class="ident" id="1486334">gp</span><span class="op" id="1486336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486339">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486342">unlock</span><span class="op" id="1486348">(</span><span class="op" id="1486349">&amp;</span><span class="ident" id="1486350">c</span><span class="op" id="1486351">.</span><span class="ident" id="1486352">lock</span><span class="op" id="1486356">)</span><br>
<span class="lineno"></span><span class="op" id="1486358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1486361">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1486405">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1486418">func</span>&nbsp;<span class="ident" id="1486423">chanrecv1</span><span class="op" id="1486432">(</span><span class="ident" id="1486433">t</span>&nbsp;<span class="op" id="1486435">*</span><span class="ident" id="1486436">chantype</span><span class="op" id="1486444">,</span>&nbsp;<span class="ident" id="1486446">c</span>&nbsp;<span class="op" id="1486448">*</span><span class="ident" id="1486449">hchan</span><span class="op" id="1486454">,</span>&nbsp;<span class="ident" id="1486456">elem</span>&nbsp;<span class="ident" id="1486461">unsafe</span><span class="op" id="1486467">.</span><span class="ident" id="1486468">Pointer</span><span class="op" id="1486475">)</span>&nbsp;<span class="op" id="1486477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486480">chanrecv</span><span class="op" id="1486488">(</span><span class="ident" id="1486489">t</span><span class="op" id="1486490">,</span>&nbsp;<span class="ident" id="1486492">c</span><span class="op" id="1486493">,</span>&nbsp;<span class="ident" id="1486495">elem</span><span class="op" id="1486499">,</span>&nbsp;<span class="ident" id="1486501">true</span><span class="op" id="1486505">)</span><br>
<span class="lineno"></span><span class="op" id="1486507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1486510">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1486523">func</span>&nbsp;<span class="ident" id="1486528">chanrecv2</span><span class="op" id="1486537">(</span><span class="ident" id="1486538">t</span>&nbsp;<span class="op" id="1486540">*</span><span class="ident" id="1486541">chantype</span><span class="op" id="1486549">,</span>&nbsp;<span class="ident" id="1486551">c</span>&nbsp;<span class="op" id="1486553">*</span><span class="ident" id="1486554">hchan</span><span class="op" id="1486559">,</span>&nbsp;<span class="ident" id="1486561">elem</span>&nbsp;<span class="ident" id="1486566">unsafe</span><span class="op" id="1486572">.</span><span class="ident" id="1486573">Pointer</span><span class="op" id="1486580">)</span>&nbsp;<span class="op" id="1486582">(</span><span class="ident" id="1486583">received</span>&nbsp;<span class="builtintype" id="1486592">bool</span><span class="op" id="1486596">)</span>&nbsp;<span class="op" id="1486598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486601">_</span><span class="op" id="1486602">,</span>&nbsp;<span class="ident" id="1486604">received</span>&nbsp;<span class="op" id="1486613">=</span>&nbsp;<span class="ident" id="1486615">chanrecv</span><span class="op" id="1486623">(</span><span class="ident" id="1486624">t</span><span class="op" id="1486625">,</span>&nbsp;<span class="ident" id="1486627">c</span><span class="op" id="1486628">,</span>&nbsp;<span class="ident" id="1486630">elem</span><span class="op" id="1486634">,</span>&nbsp;<span class="ident" id="1486636">true</span><span class="op" id="1486640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486643">return</span><br>
<span class="lineno"></span><span class="op" id="1486650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1486653">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1486723">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1486781">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1486857">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1486924">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1486993">func</span>&nbsp;<span class="ident" id="1486998">chanrecv</span><span class="op" id="1487006">(</span><span class="ident" id="1487007">t</span>&nbsp;<span class="op" id="1487009">*</span><span class="ident" id="1487010">chantype</span><span class="op" id="1487018">,</span>&nbsp;<span class="ident" id="1487020">c</span>&nbsp;<span class="op" id="1487022">*</span><span class="ident" id="1487023">hchan</span><span class="op" id="1487028">,</span>&nbsp;<span class="ident" id="1487030">ep</span>&nbsp;<span class="ident" id="1487033">unsafe</span><span class="op" id="1487039">.</span><span class="ident" id="1487040">Pointer</span><span class="op" id="1487047">,</span>&nbsp;<span class="ident" id="1487049">block</span>&nbsp;<span class="builtintype" id="1487055">bool</span><span class="op" id="1487059">)</span>&nbsp;<span class="op" id="1487061">(</span><span class="ident" id="1487062">selected</span><span class="op" id="1487070">,</span>&nbsp;<span class="ident" id="1487072">received</span>&nbsp;<span class="builtintype" id="1487081">bool</span><span class="op" id="1487085">)</span>&nbsp;<span class="op" id="1487087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487090">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487162">if</span>&nbsp;<span class="ident" id="1487165">debugChan</span>&nbsp;<span class="op" id="1487175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1487179">print</span><span class="op" id="1487184">(</span><span class="string" id="1487185">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1487202">,</span>&nbsp;<span class="ident" id="1487204">c</span><span class="op" id="1487205">,</span>&nbsp;<span class="string" id="1487207">&#34;\n&#34;</span><span class="op" id="1487211">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487218">if</span>&nbsp;<span class="ident" id="1487221">c</span>&nbsp;<span class="op" id="1487223">==</span>&nbsp;<span class="ident" id="1487226">nil</span>&nbsp;<span class="op" id="1487230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487234">if</span>&nbsp;<span class="op" id="1487237">!</span><span class="ident" id="1487238">block</span>&nbsp;<span class="op" id="1487244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487249">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487262">gopark</span><span class="op" id="1487268">(</span><span class="ident" id="1487269">nil</span><span class="op" id="1487272">,</span>&nbsp;<span class="ident" id="1487274">nil</span><span class="op" id="1487277">,</span>&nbsp;<span class="string" id="1487279">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1487304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487308">gothrow</span><span class="op" id="1487315">(</span><span class="string" id="1487316">&#34;unreachable&#34;</span><span class="op" id="1487329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487336">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487419">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487423">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487508">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487590">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487650">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487729">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487807">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487885">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487933">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487937">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1488021">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488070">if</span>&nbsp;<span class="op" id="1488073">!</span><span class="ident" id="1488074">block</span>&nbsp;<span class="op" id="1488080">&amp;&amp;</span>&nbsp;<span class="op" id="1488083">(</span><span class="ident" id="1488084">c</span><span class="op" id="1488085">.</span><span class="ident" id="1488086">dataqsiz</span>&nbsp;<span class="op" id="1488095">==</span>&nbsp;<span class="num" id="1488098">0</span>&nbsp;<span class="op" id="1488100">&amp;&amp;</span>&nbsp;<span class="ident" id="1488103">c</span><span class="op" id="1488104">.</span><span class="ident" id="1488105">sendq</span><span class="op" id="1488110">.</span><span class="ident" id="1488111">first</span>&nbsp;<span class="op" id="1488117">==</span>&nbsp;<span class="ident" id="1488120">nil</span>&nbsp;<span class="op" id="1488124">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488129">c</span><span class="op" id="1488130">.</span><span class="ident" id="1488131">dataqsiz</span>&nbsp;<span class="op" id="1488140">&gt;</span>&nbsp;<span class="num" id="1488142">0</span>&nbsp;<span class="op" id="1488144">&amp;&amp;</span>&nbsp;<span class="ident" id="1488147">atomicloaduint</span><span class="op" id="1488161">(</span><span class="op" id="1488162">&amp;</span><span class="ident" id="1488163">c</span><span class="op" id="1488164">.</span><span class="ident" id="1488165">qcount</span><span class="op" id="1488171">)</span>&nbsp;<span class="op" id="1488173">==</span>&nbsp;<span class="num" id="1488176">0</span><span class="op" id="1488177">)</span>&nbsp;<span class="op" id="1488179">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488184">atomicload</span><span class="op" id="1488194">(</span><span class="op" id="1488195">&amp;</span><span class="ident" id="1488196">c</span><span class="op" id="1488197">.</span><span class="ident" id="1488198">closed</span><span class="op" id="1488204">)</span>&nbsp;<span class="op" id="1488206">==</span>&nbsp;<span class="num" id="1488209">0</span>&nbsp;<span class="op" id="1488211">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488215">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488227">var</span>&nbsp;<span class="ident" id="1488231">t0</span>&nbsp;<span class="ident" id="1488234">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488241">if</span>&nbsp;<span class="ident" id="1488244">blockprofilerate</span>&nbsp;<span class="op" id="1488261">&gt;</span>&nbsp;<span class="num" id="1488263">0</span>&nbsp;<span class="op" id="1488265">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488269">t0</span>&nbsp;<span class="op" id="1488272">=</span>&nbsp;<span class="ident" id="1488274">cputicks</span><span class="op" id="1488282">(</span><span class="op" id="1488283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488290">lock</span><span class="op" id="1488294">(</span><span class="op" id="1488295">&amp;</span><span class="ident" id="1488296">c</span><span class="op" id="1488297">.</span><span class="ident" id="1488298">lock</span><span class="op" id="1488302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488305">if</span>&nbsp;<span class="ident" id="1488308">c</span><span class="op" id="1488309">.</span><span class="ident" id="1488310">dataqsiz</span>&nbsp;<span class="op" id="1488319">==</span>&nbsp;<span class="num" id="1488322">0</span>&nbsp;<span class="op" id="1488324">{</span>&nbsp;<span class="comment" id="1488326">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488351">if</span>&nbsp;<span class="ident" id="1488354">c</span><span class="op" id="1488355">.</span><span class="ident" id="1488356">closed</span>&nbsp;<span class="op" id="1488363">!=</span>&nbsp;<span class="num" id="1488366">0</span>&nbsp;<span class="op" id="1488368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488373">return</span>&nbsp;<span class="ident" id="1488380">recvclosed</span><span class="op" id="1488390">(</span><span class="ident" id="1488391">c</span><span class="op" id="1488392">,</span>&nbsp;<span class="ident" id="1488394">ep</span><span class="op" id="1488396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488405">sg</span>&nbsp;<span class="op" id="1488408">:=</span>&nbsp;<span class="ident" id="1488411">c</span><span class="op" id="1488412">.</span><span class="ident" id="1488413">sendq</span><span class="op" id="1488418">.</span><span class="ident" id="1488419">dequeue</span><span class="op" id="1488426">(</span><span class="op" id="1488427">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488431">if</span>&nbsp;<span class="ident" id="1488434">sg</span>&nbsp;<span class="op" id="1488437">!=</span>&nbsp;<span class="ident" id="1488440">nil</span>&nbsp;<span class="op" id="1488444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488449">if</span>&nbsp;<span class="ident" id="1488452">raceenabled</span>&nbsp;<span class="op" id="1488464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488470">racesync</span><span class="op" id="1488478">(</span><span class="ident" id="1488479">c</span><span class="op" id="1488480">,</span>&nbsp;<span class="ident" id="1488482">sg</span><span class="op" id="1488484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488494">unlock</span><span class="op" id="1488500">(</span><span class="op" id="1488501">&amp;</span><span class="ident" id="1488502">c</span><span class="op" id="1488503">.</span><span class="ident" id="1488504">lock</span><span class="op" id="1488508">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488514">if</span>&nbsp;<span class="ident" id="1488517">ep</span>&nbsp;<span class="op" id="1488520">!=</span>&nbsp;<span class="ident" id="1488523">nil</span>&nbsp;<span class="op" id="1488527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488533">memmove</span><span class="op" id="1488540">(</span><span class="ident" id="1488541">ep</span><span class="op" id="1488543">,</span>&nbsp;<span class="ident" id="1488545">sg</span><span class="op" id="1488547">.</span><span class="ident" id="1488548">elem</span><span class="op" id="1488552">,</span>&nbsp;<span class="builtintype" id="1488554">uintptr</span><span class="op" id="1488561">(</span><span class="ident" id="1488562">c</span><span class="op" id="1488563">.</span><span class="ident" id="1488564">elemsize</span><span class="op" id="1488572">)</span><span class="op" id="1488573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488583">sg</span><span class="op" id="1488585">.</span><span class="ident" id="1488586">elem</span>&nbsp;<span class="op" id="1488591">=</span>&nbsp;<span class="ident" id="1488593">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488600">gp</span>&nbsp;<span class="op" id="1488603">:=</span>&nbsp;<span class="ident" id="1488606">sg</span><span class="op" id="1488608">.</span><span class="ident" id="1488609">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488614">gp</span><span class="op" id="1488616">.</span><span class="ident" id="1488617">param</span>&nbsp;<span class="op" id="1488623">=</span>&nbsp;<span class="ident" id="1488625">unsafe</span><span class="op" id="1488631">.</span><span class="ident" id="1488632">Pointer</span><span class="op" id="1488639">(</span><span class="ident" id="1488640">sg</span><span class="op" id="1488642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488647">if</span>&nbsp;<span class="ident" id="1488650">sg</span><span class="op" id="1488652">.</span><span class="ident" id="1488653">releasetime</span>&nbsp;<span class="op" id="1488665">!=</span>&nbsp;<span class="num" id="1488668">0</span>&nbsp;<span class="op" id="1488670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488676">sg</span><span class="op" id="1488678">.</span><span class="ident" id="1488679">releasetime</span>&nbsp;<span class="op" id="1488691">=</span>&nbsp;<span class="ident" id="1488693">cputicks</span><span class="op" id="1488701">(</span><span class="op" id="1488702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488707">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488712">goready</span><span class="op" id="1488719">(</span><span class="ident" id="1488720">gp</span><span class="op" id="1488722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488727">selected</span>&nbsp;<span class="op" id="1488736">=</span>&nbsp;<span class="ident" id="1488738">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488746">received</span>&nbsp;<span class="op" id="1488755">=</span>&nbsp;<span class="ident" id="1488757">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488765">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488774">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488779">if</span>&nbsp;<span class="op" id="1488782">!</span><span class="ident" id="1488783">block</span>&nbsp;<span class="op" id="1488789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488794">unlock</span><span class="op" id="1488800">(</span><span class="op" id="1488801">&amp;</span><span class="ident" id="1488802">c</span><span class="op" id="1488803">.</span><span class="ident" id="1488804">lock</span><span class="op" id="1488808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488813">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488822">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1488827">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488876">gp</span>&nbsp;<span class="op" id="1488879">:=</span>&nbsp;<span class="ident" id="1488882">getg</span><span class="op" id="1488886">(</span><span class="op" id="1488887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488891">mysg</span>&nbsp;<span class="op" id="1488896">:=</span>&nbsp;<span class="ident" id="1488899">acquireSudog</span><span class="op" id="1488911">(</span><span class="op" id="1488912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488916">mysg</span><span class="op" id="1488920">.</span><span class="ident" id="1488921">releasetime</span>&nbsp;<span class="op" id="1488933">=</span>&nbsp;<span class="num" id="1488935">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488939">if</span>&nbsp;<span class="ident" id="1488942">t0</span>&nbsp;<span class="op" id="1488945">!=</span>&nbsp;<span class="num" id="1488948">0</span>&nbsp;<span class="op" id="1488950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488955">mysg</span><span class="op" id="1488959">.</span><span class="ident" id="1488960">releasetime</span>&nbsp;<span class="op" id="1488972">=</span>&nbsp;<span class="op" id="1488974">-</span><span class="num" id="1488975">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488983">mysg</span><span class="op" id="1488987">.</span><span class="ident" id="1488988">elem</span>&nbsp;<span class="op" id="1488993">=</span>&nbsp;<span class="ident" id="1488995">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489000">mysg</span><span class="op" id="1489004">.</span><span class="ident" id="1489005">waitlink</span>&nbsp;<span class="op" id="1489014">=</span>&nbsp;<span class="ident" id="1489016">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489022">gp</span><span class="op" id="1489024">.</span><span class="ident" id="1489025">waiting</span>&nbsp;<span class="op" id="1489033">=</span>&nbsp;<span class="ident" id="1489035">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489042">mysg</span><span class="op" id="1489046">.</span><span class="ident" id="1489047">g</span>&nbsp;<span class="op" id="1489049">=</span>&nbsp;<span class="ident" id="1489051">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489056">mysg</span><span class="op" id="1489060">.</span><span class="ident" id="1489061">selectdone</span>&nbsp;<span class="op" id="1489072">=</span>&nbsp;<span class="ident" id="1489074">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489080">gp</span><span class="op" id="1489082">.</span><span class="ident" id="1489083">param</span>&nbsp;<span class="op" id="1489089">=</span>&nbsp;<span class="ident" id="1489091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489097">c</span><span class="op" id="1489098">.</span><span class="ident" id="1489099">recvq</span><span class="op" id="1489104">.</span><span class="ident" id="1489105">enqueue</span><span class="op" id="1489112">(</span><span class="ident" id="1489113">mysg</span><span class="op" id="1489117">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489121">goparkunlock</span><span class="op" id="1489133">(</span><span class="op" id="1489134">&amp;</span><span class="ident" id="1489135">c</span><span class="op" id="1489136">.</span><span class="ident" id="1489137">lock</span><span class="op" id="1489141">,</span>&nbsp;<span class="string" id="1489143">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1489157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489162">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489186">if</span>&nbsp;<span class="ident" id="1489189">mysg</span>&nbsp;<span class="op" id="1489194">!=</span>&nbsp;<span class="ident" id="1489197">gp</span><span class="op" id="1489199">.</span><span class="ident" id="1489200">waiting</span>&nbsp;<span class="op" id="1489208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489213">gothrow</span><span class="op" id="1489220">(</span><span class="string" id="1489221">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1489251">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489259">gp</span><span class="op" id="1489261">.</span><span class="ident" id="1489262">waiting</span>&nbsp;<span class="op" id="1489270">=</span>&nbsp;<span class="ident" id="1489272">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489278">if</span>&nbsp;<span class="ident" id="1489281">mysg</span><span class="op" id="1489285">.</span><span class="ident" id="1489286">releasetime</span>&nbsp;<span class="op" id="1489298">&gt;</span>&nbsp;<span class="num" id="1489300">0</span>&nbsp;<span class="op" id="1489302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489307">blockevent</span><span class="op" id="1489317">(</span><span class="ident" id="1489318">mysg</span><span class="op" id="1489322">.</span><span class="ident" id="1489323">releasetime</span><span class="op" id="1489334">-</span><span class="ident" id="1489335">t0</span><span class="op" id="1489337">,</span>&nbsp;<span class="num" id="1489339">2</span><span class="op" id="1489340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489344">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489348">haveData</span>&nbsp;<span class="op" id="1489357">:=</span>&nbsp;<span class="ident" id="1489360">gp</span><span class="op" id="1489362">.</span><span class="ident" id="1489363">param</span>&nbsp;<span class="op" id="1489369">!=</span>&nbsp;<span class="ident" id="1489372">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489378">gp</span><span class="op" id="1489380">.</span><span class="ident" id="1489381">param</span>&nbsp;<span class="op" id="1489387">=</span>&nbsp;<span class="ident" id="1489389">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489395">releaseSudog</span><span class="op" id="1489407">(</span><span class="ident" id="1489408">mysg</span><span class="op" id="1489412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489417">if</span>&nbsp;<span class="ident" id="1489420">haveData</span>&nbsp;<span class="op" id="1489429">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489434">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489492">selected</span>&nbsp;<span class="op" id="1489501">=</span>&nbsp;<span class="ident" id="1489503">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489511">received</span>&nbsp;<span class="op" id="1489520">=</span>&nbsp;<span class="ident" id="1489522">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489530">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489539">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489544">lock</span><span class="op" id="1489548">(</span><span class="op" id="1489549">&amp;</span><span class="ident" id="1489550">c</span><span class="op" id="1489551">.</span><span class="ident" id="1489552">lock</span><span class="op" id="1489556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489560">if</span>&nbsp;<span class="ident" id="1489563">c</span><span class="op" id="1489564">.</span><span class="ident" id="1489565">closed</span>&nbsp;<span class="op" id="1489572">==</span>&nbsp;<span class="num" id="1489575">0</span>&nbsp;<span class="op" id="1489577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489582">gothrow</span><span class="op" id="1489589">(</span><span class="string" id="1489590">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1489617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489621">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489625">return</span>&nbsp;<span class="ident" id="1489632">recvclosed</span><span class="op" id="1489642">(</span><span class="ident" id="1489643">c</span><span class="op" id="1489644">,</span>&nbsp;<span class="ident" id="1489646">ep</span><span class="op" id="1489648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489655">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489680">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489713">var</span>&nbsp;<span class="ident" id="1489717">t1</span>&nbsp;<span class="ident" id="1489720">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489727">for</span>&nbsp;<span class="ident" id="1489731">c</span><span class="op" id="1489732">.</span><span class="ident" id="1489733">qcount</span>&nbsp;<span class="op" id="1489740">&lt;=</span>&nbsp;<span class="num" id="1489743">0</span>&nbsp;<span class="op" id="1489745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489749">if</span>&nbsp;<span class="ident" id="1489752">c</span><span class="op" id="1489753">.</span><span class="ident" id="1489754">closed</span>&nbsp;<span class="op" id="1489761">!=</span>&nbsp;<span class="num" id="1489764">0</span>&nbsp;<span class="op" id="1489766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489771">selected</span><span class="op" id="1489779">,</span>&nbsp;<span class="ident" id="1489781">received</span>&nbsp;<span class="op" id="1489790">=</span>&nbsp;<span class="ident" id="1489792">recvclosed</span><span class="op" id="1489802">(</span><span class="ident" id="1489803">c</span><span class="op" id="1489804">,</span>&nbsp;<span class="ident" id="1489806">ep</span><span class="op" id="1489808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489813">if</span>&nbsp;<span class="ident" id="1489816">t1</span>&nbsp;<span class="op" id="1489819">&gt;</span>&nbsp;<span class="num" id="1489821">0</span>&nbsp;<span class="op" id="1489823">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489829">blockevent</span><span class="op" id="1489839">(</span><span class="ident" id="1489840">t1</span><span class="op" id="1489842">-</span><span class="ident" id="1489843">t0</span><span class="op" id="1489845">,</span>&nbsp;<span class="num" id="1489847">2</span><span class="op" id="1489848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489858">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489872">if</span>&nbsp;<span class="op" id="1489875">!</span><span class="ident" id="1489876">block</span>&nbsp;<span class="op" id="1489882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489887">unlock</span><span class="op" id="1489893">(</span><span class="op" id="1489894">&amp;</span><span class="ident" id="1489895">c</span><span class="op" id="1489896">.</span><span class="ident" id="1489897">lock</span><span class="op" id="1489901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489906">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489920">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489961">gp</span>&nbsp;<span class="op" id="1489964">:=</span>&nbsp;<span class="ident" id="1489967">getg</span><span class="op" id="1489971">(</span><span class="op" id="1489972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489976">mysg</span>&nbsp;<span class="op" id="1489981">:=</span>&nbsp;<span class="ident" id="1489984">acquireSudog</span><span class="op" id="1489996">(</span><span class="op" id="1489997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490001">mysg</span><span class="op" id="1490005">.</span><span class="ident" id="1490006">releasetime</span>&nbsp;<span class="op" id="1490018">=</span>&nbsp;<span class="num" id="1490020">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490024">if</span>&nbsp;<span class="ident" id="1490027">t0</span>&nbsp;<span class="op" id="1490030">!=</span>&nbsp;<span class="num" id="1490033">0</span>&nbsp;<span class="op" id="1490035">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490040">mysg</span><span class="op" id="1490044">.</span><span class="ident" id="1490045">releasetime</span>&nbsp;<span class="op" id="1490057">=</span>&nbsp;<span class="op" id="1490059">-</span><span class="num" id="1490060">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490068">mysg</span><span class="op" id="1490072">.</span><span class="ident" id="1490073">elem</span>&nbsp;<span class="op" id="1490078">=</span>&nbsp;<span class="ident" id="1490080">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490086">mysg</span><span class="op" id="1490090">.</span><span class="ident" id="1490091">g</span>&nbsp;<span class="op" id="1490093">=</span>&nbsp;<span class="ident" id="1490095">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490100">mysg</span><span class="op" id="1490104">.</span><span class="ident" id="1490105">selectdone</span>&nbsp;<span class="op" id="1490116">=</span>&nbsp;<span class="ident" id="1490118">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490125">c</span><span class="op" id="1490126">.</span><span class="ident" id="1490127">recvq</span><span class="op" id="1490132">.</span><span class="ident" id="1490133">enqueue</span><span class="op" id="1490140">(</span><span class="ident" id="1490141">mysg</span><span class="op" id="1490145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490149">goparkunlock</span><span class="op" id="1490161">(</span><span class="op" id="1490162">&amp;</span><span class="ident" id="1490163">c</span><span class="op" id="1490164">.</span><span class="ident" id="1490165">lock</span><span class="op" id="1490169">,</span>&nbsp;<span class="string" id="1490171">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1490185">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490190">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490226">if</span>&nbsp;<span class="ident" id="1490229">mysg</span><span class="op" id="1490233">.</span><span class="ident" id="1490234">releasetime</span>&nbsp;<span class="op" id="1490246">&gt;</span>&nbsp;<span class="num" id="1490248">0</span>&nbsp;<span class="op" id="1490250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490255">t1</span>&nbsp;<span class="op" id="1490258">=</span>&nbsp;<span class="ident" id="1490260">mysg</span><span class="op" id="1490264">.</span><span class="ident" id="1490265">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490283">releaseSudog</span><span class="op" id="1490295">(</span><span class="ident" id="1490296">mysg</span><span class="op" id="1490300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490304">lock</span><span class="op" id="1490308">(</span><span class="op" id="1490309">&amp;</span><span class="ident" id="1490310">c</span><span class="op" id="1490311">.</span><span class="ident" id="1490312">lock</span><span class="op" id="1490316">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490323">if</span>&nbsp;<span class="ident" id="1490326">raceenabled</span>&nbsp;<span class="op" id="1490338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490342">raceacquire</span><span class="op" id="1490353">(</span><span class="ident" id="1490354">chanbuf</span><span class="op" id="1490361">(</span><span class="ident" id="1490362">c</span><span class="op" id="1490363">,</span>&nbsp;<span class="ident" id="1490365">c</span><span class="op" id="1490366">.</span><span class="ident" id="1490367">recvx</span><span class="op" id="1490372">)</span><span class="op" id="1490373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490377">racerelease</span><span class="op" id="1490388">(</span><span class="ident" id="1490389">chanbuf</span><span class="op" id="1490396">(</span><span class="ident" id="1490397">c</span><span class="op" id="1490398">,</span>&nbsp;<span class="ident" id="1490400">c</span><span class="op" id="1490401">.</span><span class="ident" id="1490402">recvx</span><span class="op" id="1490407">)</span><span class="op" id="1490408">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490414">if</span>&nbsp;<span class="ident" id="1490417">ep</span>&nbsp;<span class="op" id="1490420">!=</span>&nbsp;<span class="ident" id="1490423">nil</span>&nbsp;<span class="op" id="1490427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490431">memmove</span><span class="op" id="1490438">(</span><span class="ident" id="1490439">ep</span><span class="op" id="1490441">,</span>&nbsp;<span class="ident" id="1490443">chanbuf</span><span class="op" id="1490450">(</span><span class="ident" id="1490451">c</span><span class="op" id="1490452">,</span>&nbsp;<span class="ident" id="1490454">c</span><span class="op" id="1490455">.</span><span class="ident" id="1490456">recvx</span><span class="op" id="1490461">)</span><span class="op" id="1490462">,</span>&nbsp;<span class="builtintype" id="1490464">uintptr</span><span class="op" id="1490471">(</span><span class="ident" id="1490472">c</span><span class="op" id="1490473">.</span><span class="ident" id="1490474">elemsize</span><span class="op" id="1490482">)</span><span class="op" id="1490483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490489">memclr</span><span class="op" id="1490495">(</span><span class="ident" id="1490496">chanbuf</span><span class="op" id="1490503">(</span><span class="ident" id="1490504">c</span><span class="op" id="1490505">,</span>&nbsp;<span class="ident" id="1490507">c</span><span class="op" id="1490508">.</span><span class="ident" id="1490509">recvx</span><span class="op" id="1490514">)</span><span class="op" id="1490515">,</span>&nbsp;<span class="builtintype" id="1490517">uintptr</span><span class="op" id="1490524">(</span><span class="ident" id="1490525">c</span><span class="op" id="1490526">.</span><span class="ident" id="1490527">elemsize</span><span class="op" id="1490535">)</span><span class="op" id="1490536">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490540">c</span><span class="op" id="1490541">.</span><span class="ident" id="1490542">recvx</span><span class="op" id="1490547">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490551">if</span>&nbsp;<span class="ident" id="1490554">c</span><span class="op" id="1490555">.</span><span class="ident" id="1490556">recvx</span>&nbsp;<span class="op" id="1490562">==</span>&nbsp;<span class="ident" id="1490565">c</span><span class="op" id="1490566">.</span><span class="ident" id="1490567">dataqsiz</span>&nbsp;<span class="op" id="1490576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490580">c</span><span class="op" id="1490581">.</span><span class="ident" id="1490582">recvx</span>&nbsp;<span class="op" id="1490588">=</span>&nbsp;<span class="num" id="1490590">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490593">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490596">c</span><span class="op" id="1490597">.</span><span class="ident" id="1490598">qcount</span><span class="op" id="1490604">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490609">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490651">sg</span>&nbsp;<span class="op" id="1490654">:=</span>&nbsp;<span class="ident" id="1490657">c</span><span class="op" id="1490658">.</span><span class="ident" id="1490659">sendq</span><span class="op" id="1490664">.</span><span class="ident" id="1490665">dequeue</span><span class="op" id="1490672">(</span><span class="op" id="1490673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490676">if</span>&nbsp;<span class="ident" id="1490679">sg</span>&nbsp;<span class="op" id="1490682">!=</span>&nbsp;<span class="ident" id="1490685">nil</span>&nbsp;<span class="op" id="1490689">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490693">gp</span>&nbsp;<span class="op" id="1490696">:=</span>&nbsp;<span class="ident" id="1490699">sg</span><span class="op" id="1490701">.</span><span class="ident" id="1490702">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490706">unlock</span><span class="op" id="1490712">(</span><span class="op" id="1490713">&amp;</span><span class="ident" id="1490714">c</span><span class="op" id="1490715">.</span><span class="ident" id="1490716">lock</span><span class="op" id="1490720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490724">if</span>&nbsp;<span class="ident" id="1490727">sg</span><span class="op" id="1490729">.</span><span class="ident" id="1490730">releasetime</span>&nbsp;<span class="op" id="1490742">!=</span>&nbsp;<span class="num" id="1490745">0</span>&nbsp;<span class="op" id="1490747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490752">sg</span><span class="op" id="1490754">.</span><span class="ident" id="1490755">releasetime</span>&nbsp;<span class="op" id="1490767">=</span>&nbsp;<span class="ident" id="1490769">cputicks</span><span class="op" id="1490777">(</span><span class="op" id="1490778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490782">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490786">goready</span><span class="op" id="1490793">(</span><span class="ident" id="1490794">gp</span><span class="op" id="1490796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490799">}</span>&nbsp;<span class="keyword" id="1490801">else</span>&nbsp;<span class="op" id="1490806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490810">unlock</span><span class="op" id="1490816">(</span><span class="op" id="1490817">&amp;</span><span class="ident" id="1490818">c</span><span class="op" id="1490819">.</span><span class="ident" id="1490820">lock</span><span class="op" id="1490824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490831">if</span>&nbsp;<span class="ident" id="1490834">t1</span>&nbsp;<span class="op" id="1490837">&gt;</span>&nbsp;<span class="num" id="1490839">0</span>&nbsp;<span class="op" id="1490841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490845">blockevent</span><span class="op" id="1490855">(</span><span class="ident" id="1490856">t1</span><span class="op" id="1490858">-</span><span class="ident" id="1490859">t0</span><span class="op" id="1490861">,</span>&nbsp;<span class="num" id="1490863">2</span><span class="op" id="1490864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490870">selected</span>&nbsp;<span class="op" id="1490879">=</span>&nbsp;<span class="ident" id="1490881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490887">received</span>&nbsp;<span class="op" id="1490896">=</span>&nbsp;<span class="ident" id="1490898">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490904">return</span><br>
<span class="lineno"></span><span class="op" id="1490911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1490914">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1490980">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1491030">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1491092">func</span>&nbsp;<span class="ident" id="1491097">recvclosed</span><span class="op" id="1491107">(</span><span class="ident" id="1491108">c</span>&nbsp;<span class="op" id="1491110">*</span><span class="ident" id="1491111">hchan</span><span class="op" id="1491116">,</span>&nbsp;<span class="ident" id="1491118">ep</span>&nbsp;<span class="ident" id="1491121">unsafe</span><span class="op" id="1491127">.</span><span class="ident" id="1491128">Pointer</span><span class="op" id="1491135">)</span>&nbsp;<span class="op" id="1491137">(</span><span class="ident" id="1491138">selected</span><span class="op" id="1491146">,</span>&nbsp;<span class="ident" id="1491148">recevied</span>&nbsp;<span class="builtintype" id="1491157">bool</span><span class="op" id="1491161">)</span>&nbsp;<span class="op" id="1491163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491166">if</span>&nbsp;<span class="ident" id="1491169">raceenabled</span>&nbsp;<span class="op" id="1491181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491185">raceacquire</span><span class="op" id="1491196">(</span><span class="ident" id="1491197">unsafe</span><span class="op" id="1491203">.</span><span class="ident" id="1491204">Pointer</span><span class="op" id="1491211">(</span><span class="ident" id="1491212">c</span><span class="op" id="1491213">)</span><span class="op" id="1491214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491217">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491220">unlock</span><span class="op" id="1491226">(</span><span class="op" id="1491227">&amp;</span><span class="ident" id="1491228">c</span><span class="op" id="1491229">.</span><span class="ident" id="1491230">lock</span><span class="op" id="1491234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491237">if</span>&nbsp;<span class="ident" id="1491240">ep</span>&nbsp;<span class="op" id="1491243">!=</span>&nbsp;<span class="ident" id="1491246">nil</span>&nbsp;<span class="op" id="1491250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491254">memclr</span><span class="op" id="1491260">(</span><span class="ident" id="1491261">ep</span><span class="op" id="1491263">,</span>&nbsp;<span class="builtintype" id="1491265">uintptr</span><span class="op" id="1491272">(</span><span class="ident" id="1491273">c</span><span class="op" id="1491274">.</span><span class="ident" id="1491275">elemsize</span><span class="op" id="1491283">)</span><span class="op" id="1491284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491290">return</span>&nbsp;<span class="ident" id="1491297">true</span><span class="op" id="1491301">,</span>&nbsp;<span class="ident" id="1491303">false</span><br>
<span class="lineno">525</span><span class="op" id="1491309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1491312">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1491335">//</span><br>
<span class="lineno"></span><span class="comment" id="1491338">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1491350">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1491366">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1491378">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1491390">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1491402">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1491407">//</span><br>
<span class="lineno"></span><span class="comment" id="1491410">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1491416">//</span><br>
<span class="lineno"></span><span class="comment" id="1491419">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1491446">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1491458">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1491470">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1491482">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1491487">//</span><br>
<span class="lineno"></span><span class="keyword" id="1491490">func</span>&nbsp;<span class="ident" id="1491495">selectnbsend</span><span class="op" id="1491507">(</span><span class="ident" id="1491508">t</span>&nbsp;<span class="op" id="1491510">*</span><span class="ident" id="1491511">chantype</span><span class="op" id="1491519">,</span>&nbsp;<span class="ident" id="1491521">c</span>&nbsp;<span class="op" id="1491523">*</span><span class="ident" id="1491524">hchan</span><span class="op" id="1491529">,</span>&nbsp;<span class="ident" id="1491531">elem</span>&nbsp;<span class="ident" id="1491536">unsafe</span><span class="op" id="1491542">.</span><span class="ident" id="1491543">Pointer</span><span class="op" id="1491550">)</span>&nbsp;<span class="op" id="1491552">(</span><span class="ident" id="1491553">selected</span>&nbsp;<span class="builtintype" id="1491562">bool</span><span class="op" id="1491566">)</span>&nbsp;<span class="op" id="1491568">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491571">return</span>&nbsp;<span class="ident" id="1491578">chansend</span><span class="op" id="1491586">(</span><span class="ident" id="1491587">t</span><span class="op" id="1491588">,</span>&nbsp;<span class="ident" id="1491590">c</span><span class="op" id="1491591">,</span>&nbsp;<span class="ident" id="1491593">elem</span><span class="op" id="1491597">,</span>&nbsp;<span class="ident" id="1491599">false</span><span class="op" id="1491604">,</span>&nbsp;<span class="ident" id="1491606">getcallerpc</span><span class="op" id="1491617">(</span><span class="ident" id="1491618">unsafe</span><span class="op" id="1491624">.</span><span class="ident" id="1491625">Pointer</span><span class="op" id="1491632">(</span><span class="op" id="1491633">&amp;</span><span class="ident" id="1491634">t</span><span class="op" id="1491635">)</span><span class="op" id="1491636">)</span><span class="op" id="1491637">)</span><br>
<span class="lineno"></span><span class="op" id="1491639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1491642">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1491665">//</span><br>
<span class="lineno">550</span><span class="comment" id="1491668">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1491680">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1491697">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1491709">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1491721">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1491733">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1491738">//</span><br>
<span class="lineno"></span><span class="comment" id="1491741">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1491747">//</span><br>
<span class="lineno"></span><span class="comment" id="1491750">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1491778">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1491790">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1491802">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1491814">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1491819">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1491822">func</span>&nbsp;<span class="ident" id="1491827">selectnbrecv</span><span class="op" id="1491839">(</span><span class="ident" id="1491840">t</span>&nbsp;<span class="op" id="1491842">*</span><span class="ident" id="1491843">chantype</span><span class="op" id="1491851">,</span>&nbsp;<span class="ident" id="1491853">elem</span>&nbsp;<span class="ident" id="1491858">unsafe</span><span class="op" id="1491864">.</span><span class="ident" id="1491865">Pointer</span><span class="op" id="1491872">,</span>&nbsp;<span class="ident" id="1491874">c</span>&nbsp;<span class="op" id="1491876">*</span><span class="ident" id="1491877">hchan</span><span class="op" id="1491882">)</span>&nbsp;<span class="op" id="1491884">(</span><span class="ident" id="1491885">selected</span>&nbsp;<span class="builtintype" id="1491894">bool</span><span class="op" id="1491898">)</span>&nbsp;<span class="op" id="1491900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491903">selected</span><span class="op" id="1491911">,</span>&nbsp;<span class="ident" id="1491913">_</span>&nbsp;<span class="op" id="1491915">=</span>&nbsp;<span class="ident" id="1491917">chanrecv</span><span class="op" id="1491925">(</span><span class="ident" id="1491926">t</span><span class="op" id="1491927">,</span>&nbsp;<span class="ident" id="1491929">c</span><span class="op" id="1491930">,</span>&nbsp;<span class="ident" id="1491932">elem</span><span class="op" id="1491936">,</span>&nbsp;<span class="ident" id="1491938">false</span><span class="op" id="1491943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491946">return</span><br>
<span class="lineno"></span><span class="op" id="1491953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1491956">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1491979">//</span><br>
<span class="lineno"></span><span class="comment" id="1491982">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1491994">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1492015">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1492027">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1492039">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1492051">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1492056">//</span><br>
<span class="lineno"></span><span class="comment" id="1492059">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1492065">//</span><br>
<span class="lineno"></span><span class="comment" id="1492068">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1492114">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1492126">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1492138">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1492150">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1492155">//</span><br>
<span class="lineno"></span><span class="keyword" id="1492158">func</span>&nbsp;<span class="ident" id="1492163">selectnbrecv2</span><span class="op" id="1492176">(</span><span class="ident" id="1492177">t</span>&nbsp;<span class="op" id="1492179">*</span><span class="ident" id="1492180">chantype</span><span class="op" id="1492188">,</span>&nbsp;<span class="ident" id="1492190">elem</span>&nbsp;<span class="ident" id="1492195">unsafe</span><span class="op" id="1492201">.</span><span class="ident" id="1492202">Pointer</span><span class="op" id="1492209">,</span>&nbsp;<span class="ident" id="1492211">received</span>&nbsp;<span class="op" id="1492220">*</span><span class="builtintype" id="1492221">bool</span><span class="op" id="1492225">,</span>&nbsp;<span class="ident" id="1492227">c</span>&nbsp;<span class="op" id="1492229">*</span><span class="ident" id="1492230">hchan</span><span class="op" id="1492235">)</span>&nbsp;<span class="op" id="1492237">(</span><span class="ident" id="1492238">selected</span>&nbsp;<span class="builtintype" id="1492247">bool</span><span class="op" id="1492251">)</span>&nbsp;<span class="op" id="1492253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492256">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492334">selected</span><span class="op" id="1492342">,</span>&nbsp;<span class="op" id="1492344">*</span><span class="ident" id="1492345">received</span>&nbsp;<span class="op" id="1492354">=</span>&nbsp;<span class="ident" id="1492356">chanrecv</span><span class="op" id="1492364">(</span><span class="ident" id="1492365">t</span><span class="op" id="1492366">,</span>&nbsp;<span class="ident" id="1492368">c</span><span class="op" id="1492369">,</span>&nbsp;<span class="ident" id="1492371">elem</span><span class="op" id="1492375">,</span>&nbsp;<span class="ident" id="1492377">false</span><span class="op" id="1492382">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492385">return</span><br>
<span class="lineno"></span><span class="op" id="1492392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1492395">func</span>&nbsp;<span class="ident" id="1492400">reflect_chansend</span><span class="op" id="1492416">(</span><span class="ident" id="1492417">t</span>&nbsp;<span class="op" id="1492419">*</span><span class="ident" id="1492420">chantype</span><span class="op" id="1492428">,</span>&nbsp;<span class="ident" id="1492430">c</span>&nbsp;<span class="op" id="1492432">*</span><span class="ident" id="1492433">hchan</span><span class="op" id="1492438">,</span>&nbsp;<span class="ident" id="1492440">elem</span>&nbsp;<span class="ident" id="1492445">unsafe</span><span class="op" id="1492451">.</span><span class="ident" id="1492452">Pointer</span><span class="op" id="1492459">,</span>&nbsp;<span class="ident" id="1492461">nb</span>&nbsp;<span class="builtintype" id="1492464">bool</span><span class="op" id="1492468">)</span>&nbsp;<span class="op" id="1492470">(</span><span class="ident" id="1492471">selected</span>&nbsp;<span class="builtintype" id="1492480">bool</span><span class="op" id="1492484">)</span>&nbsp;<span class="op" id="1492486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492489">return</span>&nbsp;<span class="ident" id="1492496">chansend</span><span class="op" id="1492504">(</span><span class="ident" id="1492505">t</span><span class="op" id="1492506">,</span>&nbsp;<span class="ident" id="1492508">c</span><span class="op" id="1492509">,</span>&nbsp;<span class="ident" id="1492511">elem</span><span class="op" id="1492515">,</span>&nbsp;<span class="op" id="1492517">!</span><span class="ident" id="1492518">nb</span><span class="op" id="1492520">,</span>&nbsp;<span class="ident" id="1492522">getcallerpc</span><span class="op" id="1492533">(</span><span class="ident" id="1492534">unsafe</span><span class="op" id="1492540">.</span><span class="ident" id="1492541">Pointer</span><span class="op" id="1492548">(</span><span class="op" id="1492549">&amp;</span><span class="ident" id="1492550">t</span><span class="op" id="1492551">)</span><span class="op" id="1492552">)</span><span class="op" id="1492553">)</span><br>
<span class="lineno">595</span><span class="op" id="1492555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1492558">func</span>&nbsp;<span class="ident" id="1492563">reflect_chanrecv</span><span class="op" id="1492579">(</span><span class="ident" id="1492580">t</span>&nbsp;<span class="op" id="1492582">*</span><span class="ident" id="1492583">chantype</span><span class="op" id="1492591">,</span>&nbsp;<span class="ident" id="1492593">c</span>&nbsp;<span class="op" id="1492595">*</span><span class="ident" id="1492596">hchan</span><span class="op" id="1492601">,</span>&nbsp;<span class="ident" id="1492603">nb</span>&nbsp;<span class="builtintype" id="1492606">bool</span><span class="op" id="1492610">,</span>&nbsp;<span class="ident" id="1492612">elem</span>&nbsp;<span class="ident" id="1492617">unsafe</span><span class="op" id="1492623">.</span><span class="ident" id="1492624">Pointer</span><span class="op" id="1492631">)</span>&nbsp;<span class="op" id="1492633">(</span><span class="ident" id="1492634">selected</span>&nbsp;<span class="builtintype" id="1492643">bool</span><span class="op" id="1492647">,</span>&nbsp;<span class="ident" id="1492649">received</span>&nbsp;<span class="builtintype" id="1492658">bool</span><span class="op" id="1492662">)</span>&nbsp;<span class="op" id="1492664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492667">return</span>&nbsp;<span class="ident" id="1492674">chanrecv</span><span class="op" id="1492682">(</span><span class="ident" id="1492683">t</span><span class="op" id="1492684">,</span>&nbsp;<span class="ident" id="1492686">c</span><span class="op" id="1492687">,</span>&nbsp;<span class="ident" id="1492689">elem</span><span class="op" id="1492693">,</span>&nbsp;<span class="op" id="1492695">!</span><span class="ident" id="1492696">nb</span><span class="op" id="1492698">)</span><br>
<span class="lineno"></span><span class="op" id="1492700">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1492703">func</span>&nbsp;<span class="ident" id="1492708">reflect_chanlen</span><span class="op" id="1492723">(</span><span class="ident" id="1492724">c</span>&nbsp;<span class="op" id="1492726">*</span><span class="ident" id="1492727">hchan</span><span class="op" id="1492732">)</span>&nbsp;<span class="builtintype" id="1492734">int</span>&nbsp;<span class="op" id="1492738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492741">if</span>&nbsp;<span class="ident" id="1492744">c</span>&nbsp;<span class="op" id="1492746">==</span>&nbsp;<span class="ident" id="1492749">nil</span>&nbsp;<span class="op" id="1492753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492757">return</span>&nbsp;<span class="num" id="1492764">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492767">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492770">return</span>&nbsp;<span class="builtintype" id="1492777">int</span><span class="op" id="1492780">(</span><span class="ident" id="1492781">c</span><span class="op" id="1492782">.</span><span class="ident" id="1492783">qcount</span><span class="op" id="1492789">)</span><br>
<span class="lineno"></span><span class="op" id="1492791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1492794">func</span>&nbsp;<span class="ident" id="1492799">reflect_chancap</span><span class="op" id="1492814">(</span><span class="ident" id="1492815">c</span>&nbsp;<span class="op" id="1492817">*</span><span class="ident" id="1492818">hchan</span><span class="op" id="1492823">)</span>&nbsp;<span class="builtintype" id="1492825">int</span>&nbsp;<span class="op" id="1492829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492832">if</span>&nbsp;<span class="ident" id="1492835">c</span>&nbsp;<span class="op" id="1492837">==</span>&nbsp;<span class="ident" id="1492840">nil</span>&nbsp;<span class="op" id="1492844">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492848">return</span>&nbsp;<span class="num" id="1492855">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492861">return</span>&nbsp;<span class="builtintype" id="1492868">int</span><span class="op" id="1492871">(</span><span class="ident" id="1492872">c</span><span class="op" id="1492873">.</span><span class="ident" id="1492874">dataqsiz</span><span class="op" id="1492882">)</span><br>
<span class="lineno"></span><span class="op" id="1492884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1492887">func</span>&nbsp;<span class="op" id="1492892">(</span><span class="ident" id="1492893">q</span>&nbsp;<span class="op" id="1492895">*</span><span class="ident" id="1492896">waitq</span><span class="op" id="1492901">)</span>&nbsp;<span class="ident" id="1492903">enqueue</span><span class="op" id="1492910">(</span><span class="ident" id="1492911">sgp</span>&nbsp;<span class="op" id="1492915">*</span><span class="ident" id="1492916">sudog</span><span class="op" id="1492921">)</span>&nbsp;<span class="op" id="1492923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492926">sgp</span><span class="op" id="1492929">.</span><span class="ident" id="1492930">next</span>&nbsp;<span class="op" id="1492935">=</span>&nbsp;<span class="ident" id="1492937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492942">if</span>&nbsp;<span class="ident" id="1492945">q</span><span class="op" id="1492946">.</span><span class="ident" id="1492947">first</span>&nbsp;<span class="op" id="1492953">==</span>&nbsp;<span class="ident" id="1492956">nil</span>&nbsp;<span class="op" id="1492960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492964">q</span><span class="op" id="1492965">.</span><span class="ident" id="1492966">first</span>&nbsp;<span class="op" id="1492972">=</span>&nbsp;<span class="ident" id="1492974">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492980">q</span><span class="op" id="1492981">.</span><span class="ident" id="1492982">last</span>&nbsp;<span class="op" id="1492987">=</span>&nbsp;<span class="ident" id="1492989">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492995">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493006">q</span><span class="op" id="1493007">.</span><span class="ident" id="1493008">last</span><span class="op" id="1493012">.</span><span class="ident" id="1493013">next</span>&nbsp;<span class="op" id="1493018">=</span>&nbsp;<span class="ident" id="1493020">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493025">q</span><span class="op" id="1493026">.</span><span class="ident" id="1493027">last</span>&nbsp;<span class="op" id="1493032">=</span>&nbsp;<span class="ident" id="1493034">sgp</span><br>
<span class="lineno"></span><span class="op" id="1493038">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1493041">func</span>&nbsp;<span class="op" id="1493046">(</span><span class="ident" id="1493047">q</span>&nbsp;<span class="op" id="1493049">*</span><span class="ident" id="1493050">waitq</span><span class="op" id="1493055">)</span>&nbsp;<span class="ident" id="1493057">dequeue</span><span class="op" id="1493064">(</span><span class="op" id="1493065">)</span>&nbsp;<span class="op" id="1493067">*</span><span class="ident" id="1493068">sudog</span>&nbsp;<span class="op" id="1493074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493077">for</span>&nbsp;<span class="op" id="1493081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493085">sgp</span>&nbsp;<span class="op" id="1493089">:=</span>&nbsp;<span class="ident" id="1493092">q</span><span class="op" id="1493093">.</span><span class="ident" id="1493094">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493102">if</span>&nbsp;<span class="ident" id="1493105">sgp</span>&nbsp;<span class="op" id="1493109">==</span>&nbsp;<span class="ident" id="1493112">nil</span>&nbsp;<span class="op" id="1493116">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493121">return</span>&nbsp;<span class="ident" id="1493128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493138">q</span><span class="op" id="1493139">.</span><span class="ident" id="1493140">first</span>&nbsp;<span class="op" id="1493146">=</span>&nbsp;<span class="ident" id="1493148">sgp</span><span class="op" id="1493151">.</span><span class="ident" id="1493152">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493159">sgp</span><span class="op" id="1493162">.</span><span class="ident" id="1493163">next</span>&nbsp;<span class="op" id="1493168">=</span>&nbsp;<span class="ident" id="1493170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493176">if</span>&nbsp;<span class="ident" id="1493179">q</span><span class="op" id="1493180">.</span><span class="ident" id="1493181">last</span>&nbsp;<span class="op" id="1493186">==</span>&nbsp;<span class="ident" id="1493189">sgp</span>&nbsp;<span class="op" id="1493193">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493198">q</span><span class="op" id="1493199">.</span><span class="ident" id="1493200">last</span>&nbsp;<span class="op" id="1493205">=</span>&nbsp;<span class="ident" id="1493207">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493218">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493290">if</span>&nbsp;<span class="ident" id="1493293">sgp</span><span class="op" id="1493296">.</span><span class="ident" id="1493297">selectdone</span>&nbsp;<span class="op" id="1493308">!=</span>&nbsp;<span class="ident" id="1493311">nil</span>&nbsp;<span class="op" id="1493315">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493320">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493352">if</span>&nbsp;<span class="op" id="1493355">*</span><span class="ident" id="1493356">sgp</span><span class="op" id="1493359">.</span><span class="ident" id="1493360">selectdone</span>&nbsp;<span class="op" id="1493371">!=</span>&nbsp;<span class="num" id="1493374">0</span>&nbsp;<span class="op" id="1493376">||</span>&nbsp;<span class="op" id="1493379">!</span><span class="ident" id="1493380">cas</span><span class="op" id="1493383">(</span><span class="ident" id="1493384">sgp</span><span class="op" id="1493387">.</span><span class="ident" id="1493388">selectdone</span><span class="op" id="1493398">,</span>&nbsp;<span class="num" id="1493400">0</span><span class="op" id="1493401">,</span>&nbsp;<span class="num" id="1493403">1</span><span class="op" id="1493404">)</span>&nbsp;<span class="op" id="1493406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493412">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493428">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493433">return</span>&nbsp;<span class="ident" id="1493440">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493445">}</span><br>
<span class="lineno"></span><span class="op" id="1493447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1493450">func</span>&nbsp;<span class="ident" id="1493455">racesync</span><span class="op" id="1493463">(</span><span class="ident" id="1493464">c</span>&nbsp;<span class="op" id="1493466">*</span><span class="ident" id="1493467">hchan</span><span class="op" id="1493472">,</span>&nbsp;<span class="ident" id="1493474">sg</span>&nbsp;<span class="op" id="1493477">*</span><span class="ident" id="1493478">sudog</span><span class="op" id="1493483">)</span>&nbsp;<span class="op" id="1493485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493488">racerelease</span><span class="op" id="1493499">(</span><span class="ident" id="1493500">chanbuf</span><span class="op" id="1493507">(</span><span class="ident" id="1493508">c</span><span class="op" id="1493509">,</span>&nbsp;<span class="num" id="1493511">0</span><span class="op" id="1493512">)</span><span class="op" id="1493513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493516">raceacquireg</span><span class="op" id="1493528">(</span><span class="ident" id="1493529">sg</span><span class="op" id="1493531">.</span><span class="ident" id="1493532">g</span><span class="op" id="1493533">,</span>&nbsp;<span class="ident" id="1493535">chanbuf</span><span class="op" id="1493542">(</span><span class="ident" id="1493543">c</span><span class="op" id="1493544">,</span>&nbsp;<span class="num" id="1493546">0</span><span class="op" id="1493547">)</span><span class="op" id="1493548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493551">racereleaseg</span><span class="op" id="1493563">(</span><span class="ident" id="1493564">sg</span><span class="op" id="1493566">.</span><span class="ident" id="1493567">g</span><span class="op" id="1493568">,</span>&nbsp;<span class="ident" id="1493570">chanbuf</span><span class="op" id="1493577">(</span><span class="ident" id="1493578">c</span><span class="op" id="1493579">,</span>&nbsp;<span class="num" id="1493581">0</span><span class="op" id="1493582">)</span><span class="op" id="1493583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493586">raceacquire</span><span class="op" id="1493597">(</span><span class="ident" id="1493598">chanbuf</span><span class="op" id="1493605">(</span><span class="ident" id="1493606">c</span><span class="op" id="1493607">,</span>&nbsp;<span class="num" id="1493609">0</span><span class="op" id="1493610">)</span><span class="op" id="1493611">)</span><br>
<span class="lineno">655</span><span class="op" id="1493613">}</span>
</div>
</body>
</html>
