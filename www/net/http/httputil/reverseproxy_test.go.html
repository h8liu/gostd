<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7884665">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7884720">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7884774">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7884825">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7884850">package</span>&nbsp;<span class="ident" id="7884858">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7884868">import</span>&nbsp;<span class="op" id="7884875">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884878">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884891">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884903">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884924">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884935">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884946">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7884957">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7884964">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7884967">const</span>&nbsp;<span class="ident" id="7884973">fakeHopHeader</span>&nbsp;<span class="op" id="7884987">=</span>&nbsp;<span class="string" id="7884989">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7885019">func</span>&nbsp;<span class="ident" id="7885024">init</span><span class="op" id="7885028">(</span><span class="op" id="7885029">)</span>&nbsp;<span class="op" id="7885031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885034">hopHeaders</span>&nbsp;<span class="op" id="7885045">=</span>&nbsp;<span class="builtinfunc" id="7885047">append</span><span class="op" id="7885053">(</span><span class="ident" id="7885054">hopHeaders</span><span class="op" id="7885064">,</span>&nbsp;<span class="ident" id="7885066">fakeHopHeader</span><span class="op" id="7885079">)</span><br>
<span class="lineno"></span><span class="op" id="7885081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7885084">func</span>&nbsp;<span class="ident" id="7885089">TestReverseProxy</span><span class="op" id="7885105">(</span><span class="ident" id="7885106">t</span>&nbsp;<span class="op" id="7885108">*</span><span class="ident" id="7885109">testing</span><span class="op" id="7885116">.</span><span class="ident" id="7885117">T</span><span class="op" id="7885118">)</span>&nbsp;<span class="op" id="7885120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885123">const</span>&nbsp;<span class="ident" id="7885129">backendResponse</span>&nbsp;<span class="op" id="7885145">=</span>&nbsp;<span class="string" id="7885147">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885167">const</span>&nbsp;<span class="ident" id="7885173">backendStatus</span>&nbsp;<span class="op" id="7885187">=</span>&nbsp;<span class="num" id="7885189">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885194">backend</span>&nbsp;<span class="op" id="7885202">:=</span>&nbsp;<span class="ident" id="7885205">httptest</span><span class="op" id="7885213">.</span><span class="ident" id="7885214">NewServer</span><span class="op" id="7885223">(</span><span class="ident" id="7885224">http</span><span class="op" id="7885228">.</span><span class="ident" id="7885229">HandlerFunc</span><span class="op" id="7885240">(</span><span class="keyword" id="7885241">func</span><span class="op" id="7885245">(</span><span class="ident" id="7885246">w</span>&nbsp;<span class="ident" id="7885248">http</span><span class="op" id="7885252">.</span><span class="ident" id="7885253">ResponseWriter</span><span class="op" id="7885267">,</span>&nbsp;<span class="ident" id="7885269">r</span>&nbsp;<span class="op" id="7885271">*</span><span class="ident" id="7885272">http</span><span class="op" id="7885276">.</span><span class="ident" id="7885277">Request</span><span class="op" id="7885284">)</span>&nbsp;<span class="op" id="7885286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885290">if</span>&nbsp;<span class="builtinfunc" id="7885293">len</span><span class="op" id="7885296">(</span><span class="ident" id="7885297">r</span><span class="op" id="7885298">.</span><span class="ident" id="7885299">TransferEncoding</span><span class="op" id="7885315">)</span>&nbsp;<span class="op" id="7885317">&gt;</span>&nbsp;<span class="num" id="7885319">0</span>&nbsp;<span class="op" id="7885321">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885326">t</span><span class="op" id="7885327">.</span><span class="ident" id="7885328">Errorf</span><span class="op" id="7885334">(</span><span class="string" id="7885335">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7885380">,</span>&nbsp;<span class="ident" id="7885382">r</span><span class="op" id="7885383">.</span><span class="ident" id="7885384">TransferEncoding</span><span class="op" id="7885400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885408">if</span>&nbsp;<span class="ident" id="7885411">r</span><span class="op" id="7885412">.</span><span class="ident" id="7885413">Header</span><span class="op" id="7885419">.</span><span class="ident" id="7885420">Get</span><span class="op" id="7885423">(</span><span class="string" id="7885424">&#34;X-Forwarded-For&#34;</span><span class="op" id="7885441">)</span>&nbsp;<span class="op" id="7885443">==</span>&nbsp;<span class="string" id="7885446">&#34;&#34;</span>&nbsp;<span class="op" id="7885449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885454">t</span><span class="op" id="7885455">.</span><span class="ident" id="7885456">Errorf</span><span class="op" id="7885462">(</span><span class="string" id="7885463">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7885498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885502">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885506">if</span>&nbsp;<span class="ident" id="7885509">c</span>&nbsp;<span class="op" id="7885511">:=</span>&nbsp;<span class="ident" id="7885514">r</span><span class="op" id="7885515">.</span><span class="ident" id="7885516">Header</span><span class="op" id="7885522">.</span><span class="ident" id="7885523">Get</span><span class="op" id="7885526">(</span><span class="string" id="7885527">&#34;Connection&#34;</span><span class="op" id="7885539">)</span><span class="op" id="7885540">;</span>&nbsp;<span class="ident" id="7885542">c</span>&nbsp;<span class="op" id="7885544">!=</span>&nbsp;<span class="string" id="7885547">&#34;&#34;</span>&nbsp;<span class="op" id="7885550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885555">t</span><span class="op" id="7885556">.</span><span class="ident" id="7885557">Errorf</span><span class="op" id="7885563">(</span><span class="string" id="7885564">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7885604">,</span>&nbsp;<span class="ident" id="7885606">c</span><span class="op" id="7885607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885615">if</span>&nbsp;<span class="ident" id="7885618">c</span>&nbsp;<span class="op" id="7885620">:=</span>&nbsp;<span class="ident" id="7885623">r</span><span class="op" id="7885624">.</span><span class="ident" id="7885625">Header</span><span class="op" id="7885631">.</span><span class="ident" id="7885632">Get</span><span class="op" id="7885635">(</span><span class="string" id="7885636">&#34;Upgrade&#34;</span><span class="op" id="7885645">)</span><span class="op" id="7885646">;</span>&nbsp;<span class="ident" id="7885648">c</span>&nbsp;<span class="op" id="7885650">!=</span>&nbsp;<span class="string" id="7885653">&#34;&#34;</span>&nbsp;<span class="op" id="7885656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885661">t</span><span class="op" id="7885662">.</span><span class="ident" id="7885663">Errorf</span><span class="op" id="7885669">(</span><span class="string" id="7885670">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7885707">,</span>&nbsp;<span class="ident" id="7885709">c</span><span class="op" id="7885710">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7885718">if</span>&nbsp;<span class="ident" id="7885721">g</span><span class="op" id="7885722">,</span>&nbsp;<span class="ident" id="7885724">e</span>&nbsp;<span class="op" id="7885726">:=</span>&nbsp;<span class="ident" id="7885729">r</span><span class="op" id="7885730">.</span><span class="ident" id="7885731">Host</span><span class="op" id="7885735">,</span>&nbsp;<span class="string" id="7885737">&#34;some-name&#34;</span><span class="op" id="7885748">;</span>&nbsp;<span class="ident" id="7885750">g</span>&nbsp;<span class="op" id="7885752">!=</span>&nbsp;<span class="ident" id="7885755">e</span>&nbsp;<span class="op" id="7885757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885762">t</span><span class="op" id="7885763">.</span><span class="ident" id="7885764">Errorf</span><span class="op" id="7885770">(</span><span class="string" id="7885771">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7885808">,</span>&nbsp;<span class="ident" id="7885810">g</span><span class="op" id="7885811">,</span>&nbsp;<span class="ident" id="7885813">e</span><span class="op" id="7885814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7885818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885822">w</span><span class="op" id="7885823">.</span><span class="ident" id="7885824">Header</span><span class="op" id="7885830">(</span><span class="op" id="7885831">)</span><span class="op" id="7885832">.</span><span class="ident" id="7885833">Set</span><span class="op" id="7885836">(</span><span class="string" id="7885837">&#34;X-Foo&#34;</span><span class="op" id="7885844">,</span>&nbsp;<span class="string" id="7885846">&#34;bar&#34;</span><span class="op" id="7885851">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885855">w</span><span class="op" id="7885856">.</span><span class="ident" id="7885857">Header</span><span class="op" id="7885863">(</span><span class="op" id="7885864">)</span><span class="op" id="7885865">.</span><span class="ident" id="7885866">Set</span><span class="op" id="7885869">(</span><span class="string" id="7885870">&#34;Upgrade&#34;</span><span class="op" id="7885879">,</span>&nbsp;<span class="string" id="7885881">&#34;foo&#34;</span><span class="op" id="7885886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885890">w</span><span class="op" id="7885891">.</span><span class="ident" id="7885892">Header</span><span class="op" id="7885898">(</span><span class="op" id="7885899">)</span><span class="op" id="7885900">.</span><span class="ident" id="7885901">Set</span><span class="op" id="7885904">(</span><span class="ident" id="7885905">fakeHopHeader</span><span class="op" id="7885918">,</span>&nbsp;<span class="string" id="7885920">&#34;foo&#34;</span><span class="op" id="7885925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885929">w</span><span class="op" id="7885930">.</span><span class="ident" id="7885931">Header</span><span class="op" id="7885937">(</span><span class="op" id="7885938">)</span><span class="op" id="7885939">.</span><span class="ident" id="7885940">Add</span><span class="op" id="7885943">(</span><span class="string" id="7885944">&#34;X-Multi-Value&#34;</span><span class="op" id="7885959">,</span>&nbsp;<span class="string" id="7885961">&#34;foo&#34;</span><span class="op" id="7885966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7885970">w</span><span class="op" id="7885971">.</span><span class="ident" id="7885972">Header</span><span class="op" id="7885978">(</span><span class="op" id="7885979">)</span><span class="op" id="7885980">.</span><span class="ident" id="7885981">Add</span><span class="op" id="7885984">(</span><span class="string" id="7885985">&#34;X-Multi-Value&#34;</span><span class="op" id="7886000">,</span>&nbsp;<span class="string" id="7886002">&#34;bar&#34;</span><span class="op" id="7886007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886011">http</span><span class="op" id="7886015">.</span><span class="ident" id="7886016">SetCookie</span><span class="op" id="7886025">(</span><span class="ident" id="7886026">w</span><span class="op" id="7886027">,</span>&nbsp;<span class="op" id="7886029">&amp;</span><span class="ident" id="7886030">http</span><span class="op" id="7886034">.</span><span class="ident" id="7886035">Cookie</span><span class="op" id="7886041">{</span><span class="ident" id="7886042">Name</span><span class="op" id="7886046">:</span>&nbsp;<span class="string" id="7886048">&#34;flavor&#34;</span><span class="op" id="7886056">,</span>&nbsp;<span class="ident" id="7886058">Value</span><span class="op" id="7886063">:</span>&nbsp;<span class="string" id="7886065">&#34;chocolateChip&#34;</span><span class="op" id="7886080">}</span><span class="op" id="7886081">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886085">w</span><span class="op" id="7886086">.</span><span class="ident" id="7886087">WriteHeader</span><span class="op" id="7886098">(</span><span class="ident" id="7886099">backendStatus</span><span class="op" id="7886112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886116">w</span><span class="op" id="7886117">.</span><span class="ident" id="7886118">Write</span><span class="op" id="7886123">(</span><span class="op" id="7886124">[</span><span class="op" id="7886125">]</span><span class="builtintype" id="7886126">byte</span><span class="op" id="7886130">(</span><span class="ident" id="7886131">backendResponse</span><span class="op" id="7886146">)</span><span class="op" id="7886147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886150">}</span><span class="op" id="7886151">)</span><span class="op" id="7886152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886155">defer</span>&nbsp;<span class="ident" id="7886161">backend</span><span class="op" id="7886168">.</span><span class="ident" id="7886169">Close</span><span class="op" id="7886174">(</span><span class="op" id="7886175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886178">backendURL</span><span class="op" id="7886188">,</span>&nbsp;<span class="ident" id="7886190">err</span>&nbsp;<span class="op" id="7886194">:=</span>&nbsp;<span class="ident" id="7886197">url</span><span class="op" id="7886200">.</span><span class="ident" id="7886201">Parse</span><span class="op" id="7886206">(</span><span class="ident" id="7886207">backend</span><span class="op" id="7886214">.</span><span class="ident" id="7886215">URL</span><span class="op" id="7886218">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886221">if</span>&nbsp;<span class="ident" id="7886224">err</span>&nbsp;<span class="op" id="7886228">!=</span>&nbsp;<span class="ident" id="7886231">nil</span>&nbsp;<span class="op" id="7886235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886239">t</span><span class="op" id="7886240">.</span><span class="ident" id="7886241">Fatal</span><span class="op" id="7886246">(</span><span class="ident" id="7886247">err</span><span class="op" id="7886250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886256">proxyHandler</span>&nbsp;<span class="op" id="7886269">:=</span>&nbsp;<span class="ident" id="7886272">NewSingleHostReverseProxy</span><span class="op" id="7886297">(</span><span class="ident" id="7886298">backendURL</span><span class="op" id="7886308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886311">frontend</span>&nbsp;<span class="op" id="7886320">:=</span>&nbsp;<span class="ident" id="7886323">httptest</span><span class="op" id="7886331">.</span><span class="ident" id="7886332">NewServer</span><span class="op" id="7886341">(</span><span class="ident" id="7886342">proxyHandler</span><span class="op" id="7886354">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886357">defer</span>&nbsp;<span class="ident" id="7886363">frontend</span><span class="op" id="7886371">.</span><span class="ident" id="7886372">Close</span><span class="op" id="7886377">(</span><span class="op" id="7886378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886382">getReq</span><span class="op" id="7886388">,</span>&nbsp;<span class="ident" id="7886390">_</span>&nbsp;<span class="op" id="7886392">:=</span>&nbsp;<span class="ident" id="7886395">http</span><span class="op" id="7886399">.</span><span class="ident" id="7886400">NewRequest</span><span class="op" id="7886410">(</span><span class="string" id="7886411">&#34;GET&#34;</span><span class="op" id="7886416">,</span>&nbsp;<span class="ident" id="7886418">frontend</span><span class="op" id="7886426">.</span><span class="ident" id="7886427">URL</span><span class="op" id="7886430">,</span>&nbsp;<span class="ident" id="7886432">nil</span><span class="op" id="7886435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886438">getReq</span><span class="op" id="7886444">.</span><span class="ident" id="7886445">Host</span>&nbsp;<span class="op" id="7886450">=</span>&nbsp;<span class="string" id="7886452">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886465">getReq</span><span class="op" id="7886471">.</span><span class="ident" id="7886472">Header</span><span class="op" id="7886478">.</span><span class="ident" id="7886479">Set</span><span class="op" id="7886482">(</span><span class="string" id="7886483">&#34;Connection&#34;</span><span class="op" id="7886495">,</span>&nbsp;<span class="string" id="7886497">&#34;close&#34;</span><span class="op" id="7886504">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886507">getReq</span><span class="op" id="7886513">.</span><span class="ident" id="7886514">Header</span><span class="op" id="7886520">.</span><span class="ident" id="7886521">Set</span><span class="op" id="7886524">(</span><span class="string" id="7886525">&#34;Upgrade&#34;</span><span class="op" id="7886534">,</span>&nbsp;<span class="string" id="7886536">&#34;foo&#34;</span><span class="op" id="7886541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886544">getReq</span><span class="op" id="7886550">.</span><span class="ident" id="7886551">Close</span>&nbsp;<span class="op" id="7886557">=</span>&nbsp;<span class="ident" id="7886559">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886565">res</span><span class="op" id="7886568">,</span>&nbsp;<span class="ident" id="7886570">err</span>&nbsp;<span class="op" id="7886574">:=</span>&nbsp;<span class="ident" id="7886577">http</span><span class="op" id="7886581">.</span><span class="ident" id="7886582">DefaultClient</span><span class="op" id="7886595">.</span><span class="ident" id="7886596">Do</span><span class="op" id="7886598">(</span><span class="ident" id="7886599">getReq</span><span class="op" id="7886605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886608">if</span>&nbsp;<span class="ident" id="7886611">err</span>&nbsp;<span class="op" id="7886615">!=</span>&nbsp;<span class="ident" id="7886618">nil</span>&nbsp;<span class="op" id="7886622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886626">t</span><span class="op" id="7886627">.</span><span class="ident" id="7886628">Fatalf</span><span class="op" id="7886634">(</span><span class="string" id="7886635">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7886644">,</span>&nbsp;<span class="ident" id="7886646">err</span><span class="op" id="7886649">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886655">if</span>&nbsp;<span class="ident" id="7886658">g</span><span class="op" id="7886659">,</span>&nbsp;<span class="ident" id="7886661">e</span>&nbsp;<span class="op" id="7886663">:=</span>&nbsp;<span class="ident" id="7886666">res</span><span class="op" id="7886669">.</span><span class="ident" id="7886670">StatusCode</span><span class="op" id="7886680">,</span>&nbsp;<span class="ident" id="7886682">backendStatus</span><span class="op" id="7886695">;</span>&nbsp;<span class="ident" id="7886697">g</span>&nbsp;<span class="op" id="7886699">!=</span>&nbsp;<span class="ident" id="7886702">e</span>&nbsp;<span class="op" id="7886704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886708">t</span><span class="op" id="7886709">.</span><span class="ident" id="7886710">Errorf</span><span class="op" id="7886716">(</span><span class="string" id="7886717">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7886753">,</span>&nbsp;<span class="ident" id="7886755">g</span><span class="op" id="7886756">,</span>&nbsp;<span class="ident" id="7886758">e</span><span class="op" id="7886759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886765">if</span>&nbsp;<span class="ident" id="7886768">g</span><span class="op" id="7886769">,</span>&nbsp;<span class="ident" id="7886771">e</span>&nbsp;<span class="op" id="7886773">:=</span>&nbsp;<span class="ident" id="7886776">res</span><span class="op" id="7886779">.</span><span class="ident" id="7886780">Header</span><span class="op" id="7886786">.</span><span class="ident" id="7886787">Get</span><span class="op" id="7886790">(</span><span class="string" id="7886791">&#34;X-Foo&#34;</span><span class="op" id="7886798">)</span><span class="op" id="7886799">,</span>&nbsp;<span class="string" id="7886801">&#34;bar&#34;</span><span class="op" id="7886806">;</span>&nbsp;<span class="ident" id="7886808">g</span>&nbsp;<span class="op" id="7886810">!=</span>&nbsp;<span class="ident" id="7886813">e</span>&nbsp;<span class="op" id="7886815">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886819">t</span><span class="op" id="7886820">.</span><span class="ident" id="7886821">Errorf</span><span class="op" id="7886827">(</span><span class="string" id="7886828">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7886855">,</span>&nbsp;<span class="ident" id="7886857">g</span><span class="op" id="7886858">,</span>&nbsp;<span class="ident" id="7886860">e</span><span class="op" id="7886861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886867">if</span>&nbsp;<span class="ident" id="7886870">c</span>&nbsp;<span class="op" id="7886872">:=</span>&nbsp;<span class="ident" id="7886875">res</span><span class="op" id="7886878">.</span><span class="ident" id="7886879">Header</span><span class="op" id="7886885">.</span><span class="ident" id="7886886">Get</span><span class="op" id="7886889">(</span><span class="ident" id="7886890">fakeHopHeader</span><span class="op" id="7886903">)</span><span class="op" id="7886904">;</span>&nbsp;<span class="ident" id="7886906">c</span>&nbsp;<span class="op" id="7886908">!=</span>&nbsp;<span class="string" id="7886911">&#34;&#34;</span>&nbsp;<span class="op" id="7886914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7886918">t</span><span class="op" id="7886919">.</span><span class="ident" id="7886920">Errorf</span><span class="op" id="7886926">(</span><span class="string" id="7886927">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7886951">,</span>&nbsp;<span class="ident" id="7886953">fakeHopHeader</span><span class="op" id="7886966">,</span>&nbsp;<span class="ident" id="7886968">c</span><span class="op" id="7886969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7886972">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7886975">if</span>&nbsp;<span class="ident" id="7886978">g</span><span class="op" id="7886979">,</span>&nbsp;<span class="ident" id="7886981">e</span>&nbsp;<span class="op" id="7886983">:=</span>&nbsp;<span class="builtinfunc" id="7886986">len</span><span class="op" id="7886989">(</span><span class="ident" id="7886990">res</span><span class="op" id="7886993">.</span><span class="ident" id="7886994">Header</span><span class="op" id="7887000">[</span><span class="string" id="7887001">&#34;X-Multi-Value&#34;</span><span class="op" id="7887016">]</span><span class="op" id="7887017">)</span><span class="op" id="7887018">,</span>&nbsp;<span class="num" id="7887020">2</span><span class="op" id="7887021">;</span>&nbsp;<span class="ident" id="7887023">g</span>&nbsp;<span class="op" id="7887025">!=</span>&nbsp;<span class="ident" id="7887028">e</span>&nbsp;<span class="op" id="7887030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887034">t</span><span class="op" id="7887035">.</span><span class="ident" id="7887036">Errorf</span><span class="op" id="7887042">(</span><span class="string" id="7887043">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7887092">,</span>&nbsp;<span class="ident" id="7887094">g</span><span class="op" id="7887095">,</span>&nbsp;<span class="ident" id="7887097">e</span><span class="op" id="7887098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887104">if</span>&nbsp;<span class="ident" id="7887107">g</span><span class="op" id="7887108">,</span>&nbsp;<span class="ident" id="7887110">e</span>&nbsp;<span class="op" id="7887112">:=</span>&nbsp;<span class="builtinfunc" id="7887115">len</span><span class="op" id="7887118">(</span><span class="ident" id="7887119">res</span><span class="op" id="7887122">.</span><span class="ident" id="7887123">Header</span><span class="op" id="7887129">[</span><span class="string" id="7887130">&#34;Set-Cookie&#34;</span><span class="op" id="7887142">]</span><span class="op" id="7887143">)</span><span class="op" id="7887144">,</span>&nbsp;<span class="num" id="7887146">1</span><span class="op" id="7887147">;</span>&nbsp;<span class="ident" id="7887149">g</span>&nbsp;<span class="op" id="7887151">!=</span>&nbsp;<span class="ident" id="7887154">e</span>&nbsp;<span class="op" id="7887156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887160">t</span><span class="op" id="7887161">.</span><span class="ident" id="7887162">Fatalf</span><span class="op" id="7887168">(</span><span class="string" id="7887169">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7887197">,</span>&nbsp;<span class="ident" id="7887199">g</span><span class="op" id="7887200">,</span>&nbsp;<span class="ident" id="7887202">e</span><span class="op" id="7887203">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887209">if</span>&nbsp;<span class="ident" id="7887212">cookie</span>&nbsp;<span class="op" id="7887219">:=</span>&nbsp;<span class="ident" id="7887222">res</span><span class="op" id="7887225">.</span><span class="ident" id="7887226">Cookies</span><span class="op" id="7887233">(</span><span class="op" id="7887234">)</span><span class="op" id="7887235">[</span><span class="num" id="7887236">0</span><span class="op" id="7887237">]</span><span class="op" id="7887238">;</span>&nbsp;<span class="ident" id="7887240">cookie</span><span class="op" id="7887246">.</span><span class="ident" id="7887247">Name</span>&nbsp;<span class="op" id="7887252">!=</span>&nbsp;<span class="string" id="7887255">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7887264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887268">t</span><span class="op" id="7887269">.</span><span class="ident" id="7887270">Errorf</span><span class="op" id="7887276">(</span><span class="string" id="7887277">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7887299">,</span>&nbsp;<span class="ident" id="7887301">cookie</span><span class="op" id="7887307">.</span><span class="ident" id="7887308">Name</span><span class="op" id="7887312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887318">bodyBytes</span><span class="op" id="7887327">,</span>&nbsp;<span class="ident" id="7887329">_</span>&nbsp;<span class="op" id="7887331">:=</span>&nbsp;<span class="ident" id="7887334">ioutil</span><span class="op" id="7887340">.</span><span class="ident" id="7887341">ReadAll</span><span class="op" id="7887348">(</span><span class="ident" id="7887349">res</span><span class="op" id="7887352">.</span><span class="ident" id="7887353">Body</span><span class="op" id="7887357">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887360">if</span>&nbsp;<span class="ident" id="7887363">g</span><span class="op" id="7887364">,</span>&nbsp;<span class="ident" id="7887366">e</span>&nbsp;<span class="op" id="7887368">:=</span>&nbsp;<span class="builtintype" id="7887371">string</span><span class="op" id="7887377">(</span><span class="ident" id="7887378">bodyBytes</span><span class="op" id="7887387">)</span><span class="op" id="7887388">,</span>&nbsp;<span class="ident" id="7887390">backendResponse</span><span class="op" id="7887405">;</span>&nbsp;<span class="ident" id="7887407">g</span>&nbsp;<span class="op" id="7887409">!=</span>&nbsp;<span class="ident" id="7887412">e</span>&nbsp;<span class="op" id="7887414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887418">t</span><span class="op" id="7887419">.</span><span class="ident" id="7887420">Errorf</span><span class="op" id="7887426">(</span><span class="string" id="7887427">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7887453">,</span>&nbsp;<span class="ident" id="7887455">g</span><span class="op" id="7887456">,</span>&nbsp;<span class="ident" id="7887458">e</span><span class="op" id="7887459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887462">}</span><br>
<span class="lineno"></span><span class="op" id="7887464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7887467">func</span>&nbsp;<span class="ident" id="7887472">TestXForwardedFor</span><span class="op" id="7887489">(</span><span class="ident" id="7887490">t</span>&nbsp;<span class="op" id="7887492">*</span><span class="ident" id="7887493">testing</span><span class="op" id="7887500">.</span><span class="ident" id="7887501">T</span><span class="op" id="7887502">)</span>&nbsp;<span class="op" id="7887504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887507">const</span>&nbsp;<span class="ident" id="7887513">prevForwardedFor</span>&nbsp;<span class="op" id="7887530">=</span>&nbsp;<span class="string" id="7887532">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887545">const</span>&nbsp;<span class="ident" id="7887551">backendResponse</span>&nbsp;<span class="op" id="7887567">=</span>&nbsp;<span class="string" id="7887569">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887589">const</span>&nbsp;<span class="ident" id="7887595">backendStatus</span>&nbsp;<span class="op" id="7887609">=</span>&nbsp;<span class="num" id="7887611">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887616">backend</span>&nbsp;<span class="op" id="7887624">:=</span>&nbsp;<span class="ident" id="7887627">httptest</span><span class="op" id="7887635">.</span><span class="ident" id="7887636">NewServer</span><span class="op" id="7887645">(</span><span class="ident" id="7887646">http</span><span class="op" id="7887650">.</span><span class="ident" id="7887651">HandlerFunc</span><span class="op" id="7887662">(</span><span class="keyword" id="7887663">func</span><span class="op" id="7887667">(</span><span class="ident" id="7887668">w</span>&nbsp;<span class="ident" id="7887670">http</span><span class="op" id="7887674">.</span><span class="ident" id="7887675">ResponseWriter</span><span class="op" id="7887689">,</span>&nbsp;<span class="ident" id="7887691">r</span>&nbsp;<span class="op" id="7887693">*</span><span class="ident" id="7887694">http</span><span class="op" id="7887698">.</span><span class="ident" id="7887699">Request</span><span class="op" id="7887706">)</span>&nbsp;<span class="op" id="7887708">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887712">if</span>&nbsp;<span class="ident" id="7887715">r</span><span class="op" id="7887716">.</span><span class="ident" id="7887717">Header</span><span class="op" id="7887723">.</span><span class="ident" id="7887724">Get</span><span class="op" id="7887727">(</span><span class="string" id="7887728">&#34;X-Forwarded-For&#34;</span><span class="op" id="7887745">)</span>&nbsp;<span class="op" id="7887747">==</span>&nbsp;<span class="string" id="7887750">&#34;&#34;</span>&nbsp;<span class="op" id="7887753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887758">t</span><span class="op" id="7887759">.</span><span class="ident" id="7887760">Errorf</span><span class="op" id="7887766">(</span><span class="string" id="7887767">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7887802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7887810">if</span>&nbsp;<span class="op" id="7887813">!</span><span class="ident" id="7887814">strings</span><span class="op" id="7887821">.</span><span class="ident" id="7887822">Contains</span><span class="op" id="7887830">(</span><span class="ident" id="7887831">r</span><span class="op" id="7887832">.</span><span class="ident" id="7887833">Header</span><span class="op" id="7887839">.</span><span class="ident" id="7887840">Get</span><span class="op" id="7887843">(</span><span class="string" id="7887844">&#34;X-Forwarded-For&#34;</span><span class="op" id="7887861">)</span><span class="op" id="7887862">,</span>&nbsp;<span class="ident" id="7887864">prevForwardedFor</span><span class="op" id="7887880">)</span>&nbsp;<span class="op" id="7887882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887887">t</span><span class="op" id="7887888">.</span><span class="ident" id="7887889">Errorf</span><span class="op" id="7887895">(</span><span class="string" id="7887896">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7887939">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7887943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887947">w</span><span class="op" id="7887948">.</span><span class="ident" id="7887949">WriteHeader</span><span class="op" id="7887960">(</span><span class="ident" id="7887961">backendStatus</span><span class="op" id="7887974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7887978">w</span><span class="op" id="7887979">.</span><span class="ident" id="7887980">Write</span><span class="op" id="7887985">(</span><span class="op" id="7887986">[</span><span class="op" id="7887987">]</span><span class="builtintype" id="7887988">byte</span><span class="op" id="7887992">(</span><span class="ident" id="7887993">backendResponse</span><span class="op" id="7888008">)</span><span class="op" id="7888009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888012">}</span><span class="op" id="7888013">)</span><span class="op" id="7888014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888017">defer</span>&nbsp;<span class="ident" id="7888023">backend</span><span class="op" id="7888030">.</span><span class="ident" id="7888031">Close</span><span class="op" id="7888036">(</span><span class="op" id="7888037">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888040">backendURL</span><span class="op" id="7888050">,</span>&nbsp;<span class="ident" id="7888052">err</span>&nbsp;<span class="op" id="7888056">:=</span>&nbsp;<span class="ident" id="7888059">url</span><span class="op" id="7888062">.</span><span class="ident" id="7888063">Parse</span><span class="op" id="7888068">(</span><span class="ident" id="7888069">backend</span><span class="op" id="7888076">.</span><span class="ident" id="7888077">URL</span><span class="op" id="7888080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888083">if</span>&nbsp;<span class="ident" id="7888086">err</span>&nbsp;<span class="op" id="7888090">!=</span>&nbsp;<span class="ident" id="7888093">nil</span>&nbsp;<span class="op" id="7888097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888101">t</span><span class="op" id="7888102">.</span><span class="ident" id="7888103">Fatal</span><span class="op" id="7888108">(</span><span class="ident" id="7888109">err</span><span class="op" id="7888112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888118">proxyHandler</span>&nbsp;<span class="op" id="7888131">:=</span>&nbsp;<span class="ident" id="7888134">NewSingleHostReverseProxy</span><span class="op" id="7888159">(</span><span class="ident" id="7888160">backendURL</span><span class="op" id="7888170">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888173">frontend</span>&nbsp;<span class="op" id="7888182">:=</span>&nbsp;<span class="ident" id="7888185">httptest</span><span class="op" id="7888193">.</span><span class="ident" id="7888194">NewServer</span><span class="op" id="7888203">(</span><span class="ident" id="7888204">proxyHandler</span><span class="op" id="7888216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888219">defer</span>&nbsp;<span class="ident" id="7888225">frontend</span><span class="op" id="7888233">.</span><span class="ident" id="7888234">Close</span><span class="op" id="7888239">(</span><span class="op" id="7888240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888244">getReq</span><span class="op" id="7888250">,</span>&nbsp;<span class="ident" id="7888252">_</span>&nbsp;<span class="op" id="7888254">:=</span>&nbsp;<span class="ident" id="7888257">http</span><span class="op" id="7888261">.</span><span class="ident" id="7888262">NewRequest</span><span class="op" id="7888272">(</span><span class="string" id="7888273">&#34;GET&#34;</span><span class="op" id="7888278">,</span>&nbsp;<span class="ident" id="7888280">frontend</span><span class="op" id="7888288">.</span><span class="ident" id="7888289">URL</span><span class="op" id="7888292">,</span>&nbsp;<span class="ident" id="7888294">nil</span><span class="op" id="7888297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888300">getReq</span><span class="op" id="7888306">.</span><span class="ident" id="7888307">Host</span>&nbsp;<span class="op" id="7888312">=</span>&nbsp;<span class="string" id="7888314">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888327">getReq</span><span class="op" id="7888333">.</span><span class="ident" id="7888334">Header</span><span class="op" id="7888340">.</span><span class="ident" id="7888341">Set</span><span class="op" id="7888344">(</span><span class="string" id="7888345">&#34;Connection&#34;</span><span class="op" id="7888357">,</span>&nbsp;<span class="string" id="7888359">&#34;close&#34;</span><span class="op" id="7888366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888369">getReq</span><span class="op" id="7888375">.</span><span class="ident" id="7888376">Header</span><span class="op" id="7888382">.</span><span class="ident" id="7888383">Set</span><span class="op" id="7888386">(</span><span class="string" id="7888387">&#34;X-Forwarded-For&#34;</span><span class="op" id="7888404">,</span>&nbsp;<span class="ident" id="7888406">prevForwardedFor</span><span class="op" id="7888422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888425">getReq</span><span class="op" id="7888431">.</span><span class="ident" id="7888432">Close</span>&nbsp;<span class="op" id="7888438">=</span>&nbsp;<span class="ident" id="7888440">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888446">res</span><span class="op" id="7888449">,</span>&nbsp;<span class="ident" id="7888451">err</span>&nbsp;<span class="op" id="7888455">:=</span>&nbsp;<span class="ident" id="7888458">http</span><span class="op" id="7888462">.</span><span class="ident" id="7888463">DefaultClient</span><span class="op" id="7888476">.</span><span class="ident" id="7888477">Do</span><span class="op" id="7888479">(</span><span class="ident" id="7888480">getReq</span><span class="op" id="7888486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888489">if</span>&nbsp;<span class="ident" id="7888492">err</span>&nbsp;<span class="op" id="7888496">!=</span>&nbsp;<span class="ident" id="7888499">nil</span>&nbsp;<span class="op" id="7888503">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888507">t</span><span class="op" id="7888508">.</span><span class="ident" id="7888509">Fatalf</span><span class="op" id="7888515">(</span><span class="string" id="7888516">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7888525">,</span>&nbsp;<span class="ident" id="7888527">err</span><span class="op" id="7888530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888536">if</span>&nbsp;<span class="ident" id="7888539">g</span><span class="op" id="7888540">,</span>&nbsp;<span class="ident" id="7888542">e</span>&nbsp;<span class="op" id="7888544">:=</span>&nbsp;<span class="ident" id="7888547">res</span><span class="op" id="7888550">.</span><span class="ident" id="7888551">StatusCode</span><span class="op" id="7888561">,</span>&nbsp;<span class="ident" id="7888563">backendStatus</span><span class="op" id="7888576">;</span>&nbsp;<span class="ident" id="7888578">g</span>&nbsp;<span class="op" id="7888580">!=</span>&nbsp;<span class="ident" id="7888583">e</span>&nbsp;<span class="op" id="7888585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888589">t</span><span class="op" id="7888590">.</span><span class="ident" id="7888591">Errorf</span><span class="op" id="7888597">(</span><span class="string" id="7888598">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7888634">,</span>&nbsp;<span class="ident" id="7888636">g</span><span class="op" id="7888637">,</span>&nbsp;<span class="ident" id="7888639">e</span><span class="op" id="7888640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888643">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888646">bodyBytes</span><span class="op" id="7888655">,</span>&nbsp;<span class="ident" id="7888657">_</span>&nbsp;<span class="op" id="7888659">:=</span>&nbsp;<span class="ident" id="7888662">ioutil</span><span class="op" id="7888668">.</span><span class="ident" id="7888669">ReadAll</span><span class="op" id="7888676">(</span><span class="ident" id="7888677">res</span><span class="op" id="7888680">.</span><span class="ident" id="7888681">Body</span><span class="op" id="7888685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7888688">if</span>&nbsp;<span class="ident" id="7888691">g</span><span class="op" id="7888692">,</span>&nbsp;<span class="ident" id="7888694">e</span>&nbsp;<span class="op" id="7888696">:=</span>&nbsp;<span class="builtintype" id="7888699">string</span><span class="op" id="7888705">(</span><span class="ident" id="7888706">bodyBytes</span><span class="op" id="7888715">)</span><span class="op" id="7888716">,</span>&nbsp;<span class="ident" id="7888718">backendResponse</span><span class="op" id="7888733">;</span>&nbsp;<span class="ident" id="7888735">g</span>&nbsp;<span class="op" id="7888737">!=</span>&nbsp;<span class="ident" id="7888740">e</span>&nbsp;<span class="op" id="7888742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888746">t</span><span class="op" id="7888747">.</span><span class="ident" id="7888748">Errorf</span><span class="op" id="7888754">(</span><span class="string" id="7888755">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7888781">,</span>&nbsp;<span class="ident" id="7888783">g</span><span class="op" id="7888784">,</span>&nbsp;<span class="ident" id="7888786">e</span><span class="op" id="7888787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7888790">}</span><br>
<span class="lineno"></span><span class="op" id="7888792">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7888795">var</span>&nbsp;<span class="ident" id="7888799">proxyQueryTests</span>&nbsp;<span class="op" id="7888815">=</span>&nbsp;<span class="op" id="7888817">[</span><span class="op" id="7888818">]</span><span class="keyword" id="7888819">struct</span>&nbsp;<span class="op" id="7888826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888829">baseSuffix</span>&nbsp;<span class="builtintype" id="7888840">string</span>&nbsp;<span class="comment" id="7888847">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888880">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7888891">string</span>&nbsp;<span class="comment" id="7888898">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7888942">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7888953">string</span>&nbsp;<span class="comment" id="7888960">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7889021">}</span><span class="op" id="7889022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889025">{</span><span class="string" id="7889026">&#34;&#34;</span><span class="op" id="7889028">,</span>&nbsp;<span class="string" id="7889030">&#34;&#34;</span><span class="op" id="7889032">,</span>&nbsp;<span class="string" id="7889034">&#34;&#34;</span><span class="op" id="7889036">}</span><span class="op" id="7889037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889040">{</span><span class="string" id="7889041">&#34;?sta=tic&#34;</span><span class="op" id="7889051">,</span>&nbsp;<span class="string" id="7889053">&#34;?us=er&#34;</span><span class="op" id="7889061">,</span>&nbsp;<span class="string" id="7889063">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7889078">}</span><span class="op" id="7889079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889082">{</span><span class="string" id="7889083">&#34;&#34;</span><span class="op" id="7889085">,</span>&nbsp;<span class="string" id="7889087">&#34;?us=er&#34;</span><span class="op" id="7889095">,</span>&nbsp;<span class="string" id="7889097">&#34;us=er&#34;</span><span class="op" id="7889104">}</span><span class="op" id="7889105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889108">{</span><span class="string" id="7889109">&#34;?sta=tic&#34;</span><span class="op" id="7889119">,</span>&nbsp;<span class="string" id="7889121">&#34;&#34;</span><span class="op" id="7889123">,</span>&nbsp;<span class="string" id="7889125">&#34;sta=tic&#34;</span><span class="op" id="7889134">}</span><span class="op" id="7889135">,</span><br>
<span class="lineno">145</span><span class="op" id="7889137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7889140">func</span>&nbsp;<span class="ident" id="7889145">TestReverseProxyQuery</span><span class="op" id="7889166">(</span><span class="ident" id="7889167">t</span>&nbsp;<span class="op" id="7889169">*</span><span class="ident" id="7889170">testing</span><span class="op" id="7889177">.</span><span class="ident" id="7889178">T</span><span class="op" id="7889179">)</span>&nbsp;<span class="op" id="7889181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889184">backend</span>&nbsp;<span class="op" id="7889192">:=</span>&nbsp;<span class="ident" id="7889195">httptest</span><span class="op" id="7889203">.</span><span class="ident" id="7889204">NewServer</span><span class="op" id="7889213">(</span><span class="ident" id="7889214">http</span><span class="op" id="7889218">.</span><span class="ident" id="7889219">HandlerFunc</span><span class="op" id="7889230">(</span><span class="keyword" id="7889231">func</span><span class="op" id="7889235">(</span><span class="ident" id="7889236">w</span>&nbsp;<span class="ident" id="7889238">http</span><span class="op" id="7889242">.</span><span class="ident" id="7889243">ResponseWriter</span><span class="op" id="7889257">,</span>&nbsp;<span class="ident" id="7889259">r</span>&nbsp;<span class="op" id="7889261">*</span><span class="ident" id="7889262">http</span><span class="op" id="7889266">.</span><span class="ident" id="7889267">Request</span><span class="op" id="7889274">)</span>&nbsp;<span class="op" id="7889276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889280">w</span><span class="op" id="7889281">.</span><span class="ident" id="7889282">Header</span><span class="op" id="7889288">(</span><span class="op" id="7889289">)</span><span class="op" id="7889290">.</span><span class="ident" id="7889291">Set</span><span class="op" id="7889294">(</span><span class="string" id="7889295">&#34;X-Got-Query&#34;</span><span class="op" id="7889308">,</span>&nbsp;<span class="ident" id="7889310">r</span><span class="op" id="7889311">.</span><span class="ident" id="7889312">URL</span><span class="op" id="7889315">.</span><span class="ident" id="7889316">RawQuery</span><span class="op" id="7889324">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889328">w</span><span class="op" id="7889329">.</span><span class="ident" id="7889330">Write</span><span class="op" id="7889335">(</span><span class="op" id="7889336">[</span><span class="op" id="7889337">]</span><span class="builtintype" id="7889338">byte</span><span class="op" id="7889342">(</span><span class="string" id="7889343">&#34;hi&#34;</span><span class="op" id="7889347">)</span><span class="op" id="7889348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889351">}</span><span class="op" id="7889352">)</span><span class="op" id="7889353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889356">defer</span>&nbsp;<span class="ident" id="7889362">backend</span><span class="op" id="7889369">.</span><span class="ident" id="7889370">Close</span><span class="op" id="7889375">(</span><span class="op" id="7889376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889380">for</span>&nbsp;<span class="ident" id="7889384">i</span><span class="op" id="7889385">,</span>&nbsp;<span class="ident" id="7889387">tt</span>&nbsp;<span class="op" id="7889390">:=</span>&nbsp;<span class="keyword" id="7889393">range</span>&nbsp;<span class="ident" id="7889399">proxyQueryTests</span>&nbsp;<span class="op" id="7889415">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889419">backendURL</span><span class="op" id="7889429">,</span>&nbsp;<span class="ident" id="7889431">err</span>&nbsp;<span class="op" id="7889435">:=</span>&nbsp;<span class="ident" id="7889438">url</span><span class="op" id="7889441">.</span><span class="ident" id="7889442">Parse</span><span class="op" id="7889447">(</span><span class="ident" id="7889448">backend</span><span class="op" id="7889455">.</span><span class="ident" id="7889456">URL</span>&nbsp;<span class="op" id="7889460">+</span>&nbsp;<span class="ident" id="7889462">tt</span><span class="op" id="7889464">.</span><span class="ident" id="7889465">baseSuffix</span><span class="op" id="7889475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889479">if</span>&nbsp;<span class="ident" id="7889482">err</span>&nbsp;<span class="op" id="7889486">!=</span>&nbsp;<span class="ident" id="7889489">nil</span>&nbsp;<span class="op" id="7889493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889498">t</span><span class="op" id="7889499">.</span><span class="ident" id="7889500">Fatal</span><span class="op" id="7889505">(</span><span class="ident" id="7889506">err</span><span class="op" id="7889509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889517">frontend</span>&nbsp;<span class="op" id="7889526">:=</span>&nbsp;<span class="ident" id="7889529">httptest</span><span class="op" id="7889537">.</span><span class="ident" id="7889538">NewServer</span><span class="op" id="7889547">(</span><span class="ident" id="7889548">NewSingleHostReverseProxy</span><span class="op" id="7889573">(</span><span class="ident" id="7889574">backendURL</span><span class="op" id="7889584">)</span><span class="op" id="7889585">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889589">req</span><span class="op" id="7889592">,</span>&nbsp;<span class="ident" id="7889594">_</span>&nbsp;<span class="op" id="7889596">:=</span>&nbsp;<span class="ident" id="7889599">http</span><span class="op" id="7889603">.</span><span class="ident" id="7889604">NewRequest</span><span class="op" id="7889614">(</span><span class="string" id="7889615">&#34;GET&#34;</span><span class="op" id="7889620">,</span>&nbsp;<span class="ident" id="7889622">frontend</span><span class="op" id="7889630">.</span><span class="ident" id="7889631">URL</span><span class="op" id="7889634">+</span><span class="ident" id="7889635">tt</span><span class="op" id="7889637">.</span><span class="ident" id="7889638">reqSuffix</span><span class="op" id="7889647">,</span>&nbsp;<span class="ident" id="7889649">nil</span><span class="op" id="7889652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889656">req</span><span class="op" id="7889659">.</span><span class="ident" id="7889660">Close</span>&nbsp;<span class="op" id="7889666">=</span>&nbsp;<span class="ident" id="7889668">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889675">res</span><span class="op" id="7889678">,</span>&nbsp;<span class="ident" id="7889680">err</span>&nbsp;<span class="op" id="7889684">:=</span>&nbsp;<span class="ident" id="7889687">http</span><span class="op" id="7889691">.</span><span class="ident" id="7889692">DefaultClient</span><span class="op" id="7889705">.</span><span class="ident" id="7889706">Do</span><span class="op" id="7889708">(</span><span class="ident" id="7889709">req</span><span class="op" id="7889712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889716">if</span>&nbsp;<span class="ident" id="7889719">err</span>&nbsp;<span class="op" id="7889723">!=</span>&nbsp;<span class="ident" id="7889726">nil</span>&nbsp;<span class="op" id="7889730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889735">t</span><span class="op" id="7889736">.</span><span class="ident" id="7889737">Fatalf</span><span class="op" id="7889743">(</span><span class="string" id="7889744">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7889757">,</span>&nbsp;<span class="ident" id="7889759">i</span><span class="op" id="7889760">,</span>&nbsp;<span class="ident" id="7889762">err</span><span class="op" id="7889765">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889773">if</span>&nbsp;<span class="ident" id="7889776">g</span><span class="op" id="7889777">,</span>&nbsp;<span class="ident" id="7889779">e</span>&nbsp;<span class="op" id="7889781">:=</span>&nbsp;<span class="ident" id="7889784">res</span><span class="op" id="7889787">.</span><span class="ident" id="7889788">Header</span><span class="op" id="7889794">.</span><span class="ident" id="7889795">Get</span><span class="op" id="7889798">(</span><span class="string" id="7889799">&#34;X-Got-Query&#34;</span><span class="op" id="7889812">)</span><span class="op" id="7889813">,</span>&nbsp;<span class="ident" id="7889815">tt</span><span class="op" id="7889817">.</span><span class="ident" id="7889818">want</span><span class="op" id="7889822">;</span>&nbsp;<span class="ident" id="7889824">g</span>&nbsp;<span class="op" id="7889826">!=</span>&nbsp;<span class="ident" id="7889829">e</span>&nbsp;<span class="op" id="7889831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889836">t</span><span class="op" id="7889837">.</span><span class="ident" id="7889838">Errorf</span><span class="op" id="7889844">(</span><span class="string" id="7889845">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7889876">,</span>&nbsp;<span class="ident" id="7889878">i</span><span class="op" id="7889879">,</span>&nbsp;<span class="ident" id="7889881">g</span><span class="op" id="7889882">,</span>&nbsp;<span class="ident" id="7889884">e</span><span class="op" id="7889885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889893">res</span><span class="op" id="7889896">.</span><span class="ident" id="7889897">Body</span><span class="op" id="7889901">.</span><span class="ident" id="7889902">Close</span><span class="op" id="7889907">(</span><span class="op" id="7889908">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7889912">frontend</span><span class="op" id="7889920">.</span><span class="ident" id="7889921">Close</span><span class="op" id="7889926">(</span><span class="op" id="7889927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7889930">}</span><br>
<span class="lineno"></span><span class="op" id="7889932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7889935">func</span>&nbsp;<span class="ident" id="7889940">TestReverseProxyFlushInterval</span><span class="op" id="7889969">(</span><span class="ident" id="7889970">t</span>&nbsp;<span class="op" id="7889972">*</span><span class="ident" id="7889973">testing</span><span class="op" id="7889980">.</span><span class="ident" id="7889981">T</span><span class="op" id="7889982">)</span>&nbsp;<span class="op" id="7889984">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7889987">const</span>&nbsp;<span class="ident" id="7889993">expected</span>&nbsp;<span class="op" id="7890002">=</span>&nbsp;<span class="string" id="7890004">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890010">backend</span>&nbsp;<span class="op" id="7890018">:=</span>&nbsp;<span class="ident" id="7890021">httptest</span><span class="op" id="7890029">.</span><span class="ident" id="7890030">NewServer</span><span class="op" id="7890039">(</span><span class="ident" id="7890040">http</span><span class="op" id="7890044">.</span><span class="ident" id="7890045">HandlerFunc</span><span class="op" id="7890056">(</span><span class="keyword" id="7890057">func</span><span class="op" id="7890061">(</span><span class="ident" id="7890062">w</span>&nbsp;<span class="ident" id="7890064">http</span><span class="op" id="7890068">.</span><span class="ident" id="7890069">ResponseWriter</span><span class="op" id="7890083">,</span>&nbsp;<span class="ident" id="7890085">r</span>&nbsp;<span class="op" id="7890087">*</span><span class="ident" id="7890088">http</span><span class="op" id="7890092">.</span><span class="ident" id="7890093">Request</span><span class="op" id="7890100">)</span>&nbsp;<span class="op" id="7890102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890106">w</span><span class="op" id="7890107">.</span><span class="ident" id="7890108">Write</span><span class="op" id="7890113">(</span><span class="op" id="7890114">[</span><span class="op" id="7890115">]</span><span class="builtintype" id="7890116">byte</span><span class="op" id="7890120">(</span><span class="ident" id="7890121">expected</span><span class="op" id="7890129">)</span><span class="op" id="7890130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890133">}</span><span class="op" id="7890134">)</span><span class="op" id="7890135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890138">defer</span>&nbsp;<span class="ident" id="7890144">backend</span><span class="op" id="7890151">.</span><span class="ident" id="7890152">Close</span><span class="op" id="7890157">(</span><span class="op" id="7890158">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890162">backendURL</span><span class="op" id="7890172">,</span>&nbsp;<span class="ident" id="7890174">err</span>&nbsp;<span class="op" id="7890178">:=</span>&nbsp;<span class="ident" id="7890181">url</span><span class="op" id="7890184">.</span><span class="ident" id="7890185">Parse</span><span class="op" id="7890190">(</span><span class="ident" id="7890191">backend</span><span class="op" id="7890198">.</span><span class="ident" id="7890199">URL</span><span class="op" id="7890202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890205">if</span>&nbsp;<span class="ident" id="7890208">err</span>&nbsp;<span class="op" id="7890212">!=</span>&nbsp;<span class="ident" id="7890215">nil</span>&nbsp;<span class="op" id="7890219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890223">t</span><span class="op" id="7890224">.</span><span class="ident" id="7890225">Fatal</span><span class="op" id="7890230">(</span><span class="ident" id="7890231">err</span><span class="op" id="7890234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890237">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890241">proxyHandler</span>&nbsp;<span class="op" id="7890254">:=</span>&nbsp;<span class="ident" id="7890257">NewSingleHostReverseProxy</span><span class="op" id="7890282">(</span><span class="ident" id="7890283">backendURL</span><span class="op" id="7890293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890296">proxyHandler</span><span class="op" id="7890308">.</span><span class="ident" id="7890309">FlushInterval</span>&nbsp;<span class="op" id="7890323">=</span>&nbsp;<span class="ident" id="7890325">time</span><span class="op" id="7890329">.</span><span class="ident" id="7890330">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890344">done</span>&nbsp;<span class="op" id="7890349">:=</span>&nbsp;<span class="builtinfunc" id="7890352">make</span><span class="op" id="7890356">(</span><span class="keyword" id="7890357">chan</span>&nbsp;<span class="builtintype" id="7890362">bool</span><span class="op" id="7890366">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890369">onExitFlushLoop</span>&nbsp;<span class="op" id="7890385">=</span>&nbsp;<span class="keyword" id="7890387">func</span><span class="op" id="7890391">(</span><span class="op" id="7890392">)</span>&nbsp;<span class="op" id="7890394">{</span>&nbsp;<span class="ident" id="7890396">done</span>&nbsp;<span class="op" id="7890401">&lt;-</span>&nbsp;<span class="ident" id="7890404">true</span>&nbsp;<span class="op" id="7890409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890412">defer</span>&nbsp;<span class="keyword" id="7890418">func</span><span class="op" id="7890422">(</span><span class="op" id="7890423">)</span>&nbsp;<span class="op" id="7890425">{</span>&nbsp;<span class="ident" id="7890427">onExitFlushLoop</span>&nbsp;<span class="op" id="7890443">=</span>&nbsp;<span class="ident" id="7890445">nil</span>&nbsp;<span class="op" id="7890449">}</span><span class="op" id="7890450">(</span><span class="op" id="7890451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890455">frontend</span>&nbsp;<span class="op" id="7890464">:=</span>&nbsp;<span class="ident" id="7890467">httptest</span><span class="op" id="7890475">.</span><span class="ident" id="7890476">NewServer</span><span class="op" id="7890485">(</span><span class="ident" id="7890486">proxyHandler</span><span class="op" id="7890498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890501">defer</span>&nbsp;<span class="ident" id="7890507">frontend</span><span class="op" id="7890515">.</span><span class="ident" id="7890516">Close</span><span class="op" id="7890521">(</span><span class="op" id="7890522">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890526">req</span><span class="op" id="7890529">,</span>&nbsp;<span class="ident" id="7890531">_</span>&nbsp;<span class="op" id="7890533">:=</span>&nbsp;<span class="ident" id="7890536">http</span><span class="op" id="7890540">.</span><span class="ident" id="7890541">NewRequest</span><span class="op" id="7890551">(</span><span class="string" id="7890552">&#34;GET&#34;</span><span class="op" id="7890557">,</span>&nbsp;<span class="ident" id="7890559">frontend</span><span class="op" id="7890567">.</span><span class="ident" id="7890568">URL</span><span class="op" id="7890571">,</span>&nbsp;<span class="ident" id="7890573">nil</span><span class="op" id="7890576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890579">req</span><span class="op" id="7890582">.</span><span class="ident" id="7890583">Close</span>&nbsp;<span class="op" id="7890589">=</span>&nbsp;<span class="ident" id="7890591">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890597">res</span><span class="op" id="7890600">,</span>&nbsp;<span class="ident" id="7890602">err</span>&nbsp;<span class="op" id="7890606">:=</span>&nbsp;<span class="ident" id="7890609">http</span><span class="op" id="7890613">.</span><span class="ident" id="7890614">DefaultClient</span><span class="op" id="7890627">.</span><span class="ident" id="7890628">Do</span><span class="op" id="7890630">(</span><span class="ident" id="7890631">req</span><span class="op" id="7890634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890637">if</span>&nbsp;<span class="ident" id="7890640">err</span>&nbsp;<span class="op" id="7890644">!=</span>&nbsp;<span class="ident" id="7890647">nil</span>&nbsp;<span class="op" id="7890651">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890655">t</span><span class="op" id="7890656">.</span><span class="ident" id="7890657">Fatalf</span><span class="op" id="7890663">(</span><span class="string" id="7890664">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7890673">,</span>&nbsp;<span class="ident" id="7890675">err</span><span class="op" id="7890678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890684">defer</span>&nbsp;<span class="ident" id="7890690">res</span><span class="op" id="7890693">.</span><span class="ident" id="7890694">Body</span><span class="op" id="7890698">.</span><span class="ident" id="7890699">Close</span><span class="op" id="7890704">(</span><span class="op" id="7890705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890708">if</span>&nbsp;<span class="ident" id="7890711">bodyBytes</span><span class="op" id="7890720">,</span>&nbsp;<span class="ident" id="7890722">_</span>&nbsp;<span class="op" id="7890724">:=</span>&nbsp;<span class="ident" id="7890727">ioutil</span><span class="op" id="7890733">.</span><span class="ident" id="7890734">ReadAll</span><span class="op" id="7890741">(</span><span class="ident" id="7890742">res</span><span class="op" id="7890745">.</span><span class="ident" id="7890746">Body</span><span class="op" id="7890750">)</span><span class="op" id="7890751">;</span>&nbsp;<span class="builtintype" id="7890753">string</span><span class="op" id="7890759">(</span><span class="ident" id="7890760">bodyBytes</span><span class="op" id="7890769">)</span>&nbsp;<span class="op" id="7890771">!=</span>&nbsp;<span class="ident" id="7890774">expected</span>&nbsp;<span class="op" id="7890783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890787">t</span><span class="op" id="7890788">.</span><span class="ident" id="7890789">Errorf</span><span class="op" id="7890795">(</span><span class="string" id="7890796">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7890822">,</span>&nbsp;<span class="ident" id="7890824">bodyBytes</span><span class="op" id="7890833">,</span>&nbsp;<span class="ident" id="7890835">expected</span><span class="op" id="7890843">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890850">select</span>&nbsp;<span class="op" id="7890857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890860">case</span>&nbsp;<span class="op" id="7890865">&lt;-</span><span class="ident" id="7890867">done</span><span class="op" id="7890871">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7890875">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7890882">case</span>&nbsp;<span class="op" id="7890887">&lt;-</span><span class="ident" id="7890889">time</span><span class="op" id="7890893">.</span><span class="ident" id="7890894">After</span><span class="op" id="7890899">(</span><span class="num" id="7890900">5</span>&nbsp;<span class="op" id="7890902">*</span>&nbsp;<span class="ident" id="7890904">time</span><span class="op" id="7890908">.</span><span class="ident" id="7890909">Second</span><span class="op" id="7890915">)</span><span class="op" id="7890916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7890920">t</span><span class="op" id="7890921">.</span><span class="ident" id="7890922">Error</span><span class="op" id="7890927">(</span><span class="string" id="7890928">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7890971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7890974">}</span><br>
<span class="lineno"></span><span class="op" id="7890976">}</span>
</div>
</body>
</html>
