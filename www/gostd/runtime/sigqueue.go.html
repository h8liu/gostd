<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html" class="current">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1705407">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1705462">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1705516">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1705567">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1705628">//</span><br>
<span class="lineno"></span><span class="comment" id="1705631">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1705689">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1705760">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1705819">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1705845">//</span><br>
<span class="lineno"></span><span class="comment" id="1705848">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1705914">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1705991">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1706068">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1706143">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1706222">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1706246">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1706315">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1706362">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1706449">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1706509">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1706585">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1706661">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1706735">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1706754">package</span>&nbsp;<span class="ident" id="1706762">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1706771">import</span>&nbsp;<span class="string" id="1706778">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1706788">var</span>&nbsp;<span class="ident" id="1706792">sig</span>&nbsp;<span class="keyword" id="1706796">struct</span>&nbsp;<span class="op" id="1706803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706806">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1706813">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706819">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1706826">[</span><span class="op" id="1706827">(</span><span class="ident" id="1706828">_NSIG</span>&nbsp;<span class="op" id="1706834">+</span>&nbsp;<span class="num" id="1706836">31</span><span class="op" id="1706838">)</span>&nbsp;<span class="op" id="1706840">/</span>&nbsp;<span class="num" id="1706842">32</span><span class="op" id="1706844">]</span><span class="builtintype" id="1706845">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706853">wanted</span>&nbsp;<span class="op" id="1706860">[</span><span class="op" id="1706861">(</span><span class="ident" id="1706862">_NSIG</span>&nbsp;<span class="op" id="1706868">+</span>&nbsp;<span class="num" id="1706870">31</span><span class="op" id="1706872">)</span>&nbsp;<span class="op" id="1706874">/</span>&nbsp;<span class="num" id="1706876">32</span><span class="op" id="1706878">]</span><span class="builtintype" id="1706879">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706887">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1706894">[</span><span class="op" id="1706895">(</span><span class="ident" id="1706896">_NSIG</span>&nbsp;<span class="op" id="1706902">+</span>&nbsp;<span class="num" id="1706904">31</span><span class="op" id="1706906">)</span>&nbsp;<span class="op" id="1706908">/</span>&nbsp;<span class="num" id="1706910">32</span><span class="op" id="1706912">]</span><span class="builtintype" id="1706913">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706921">state</span>&nbsp;&nbsp;<span class="builtintype" id="1706928">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706936">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1706943">bool</span><br>
<span class="lineno"></span><span class="op" id="1706948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1706951">const</span>&nbsp;<span class="op" id="1706957">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706960">sigIdle</span>&nbsp;<span class="op" id="1706968">=</span>&nbsp;<span class="ident" id="1706970">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706976">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706990">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1707001">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1707004">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1707087">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1707177">func</span>&nbsp;<span class="ident" id="1707182">sigsend</span><span class="op" id="1707189">(</span><span class="ident" id="1707190">s</span>&nbsp;<span class="builtintype" id="1707192">int32</span><span class="op" id="1707197">)</span>&nbsp;<span class="builtintype" id="1707199">bool</span>&nbsp;<span class="op" id="1707204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707207">bit</span>&nbsp;<span class="op" id="1707211">:=</span>&nbsp;<span class="builtintype" id="1707214">uint32</span><span class="op" id="1707220">(</span><span class="num" id="1707221">1</span><span class="op" id="1707222">)</span>&nbsp;<span class="op" id="1707224">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1707227">uint</span><span class="op" id="1707231">(</span><span class="ident" id="1707232">s</span><span class="op" id="1707233">&amp;</span><span class="num" id="1707234">31</span><span class="op" id="1707236">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707239">if</span>&nbsp;<span class="op" id="1707242">!</span><span class="ident" id="1707243">sig</span><span class="op" id="1707246">.</span><span class="ident" id="1707247">inuse</span>&nbsp;<span class="op" id="1707253">||</span>&nbsp;<span class="ident" id="1707256">s</span>&nbsp;<span class="op" id="1707258">&lt;</span>&nbsp;<span class="num" id="1707260">0</span>&nbsp;<span class="op" id="1707262">||</span>&nbsp;<span class="builtintype" id="1707265">int</span><span class="op" id="1707268">(</span><span class="ident" id="1707269">s</span><span class="op" id="1707270">)</span>&nbsp;<span class="op" id="1707272">&gt;=</span>&nbsp;<span class="num" id="1707275">32</span><span class="op" id="1707277">*</span><span class="builtinfunc" id="1707278">len</span><span class="op" id="1707281">(</span><span class="ident" id="1707282">sig</span><span class="op" id="1707285">.</span><span class="ident" id="1707286">wanted</span><span class="op" id="1707292">)</span>&nbsp;<span class="op" id="1707294">||</span>&nbsp;<span class="ident" id="1707297">sig</span><span class="op" id="1707300">.</span><span class="ident" id="1707301">wanted</span><span class="op" id="1707307">[</span><span class="ident" id="1707308">s</span><span class="op" id="1707309">/</span><span class="num" id="1707310">32</span><span class="op" id="1707312">]</span><span class="op" id="1707313">&amp;</span><span class="ident" id="1707314">bit</span>&nbsp;<span class="op" id="1707318">==</span>&nbsp;<span class="num" id="1707321">0</span>&nbsp;<span class="op" id="1707323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707327">return</span>&nbsp;<span class="builtintype" id="1707334">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707345">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707379">for</span>&nbsp;<span class="op" id="1707383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707387">mask</span>&nbsp;<span class="op" id="1707392">:=</span>&nbsp;<span class="ident" id="1707395">sig</span><span class="op" id="1707398">.</span><span class="ident" id="1707399">mask</span><span class="op" id="1707403">[</span><span class="ident" id="1707404">s</span><span class="op" id="1707405">/</span><span class="num" id="1707406">32</span><span class="op" id="1707408">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707412">if</span>&nbsp;<span class="ident" id="1707415">mask</span><span class="op" id="1707419">&amp;</span><span class="ident" id="1707420">bit</span>&nbsp;<span class="op" id="1707424">!=</span>&nbsp;<span class="num" id="1707427">0</span>&nbsp;<span class="op" id="1707429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707434">return</span>&nbsp;<span class="builtintype" id="1707441">true</span>&nbsp;<span class="comment" id="1707446">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707475">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707479">if</span>&nbsp;<span class="ident" id="1707482">cas</span><span class="op" id="1707485">(</span><span class="op" id="1707486">&amp;</span><span class="ident" id="1707487">sig</span><span class="op" id="1707490">.</span><span class="ident" id="1707491">mask</span><span class="op" id="1707495">[</span><span class="ident" id="1707496">s</span><span class="op" id="1707497">/</span><span class="num" id="1707498">32</span><span class="op" id="1707500">]</span><span class="op" id="1707501">,</span>&nbsp;<span class="ident" id="1707503">mask</span><span class="op" id="1707507">,</span>&nbsp;<span class="ident" id="1707509">mask</span><span class="op" id="1707513">|</span><span class="ident" id="1707514">bit</span><span class="op" id="1707517">)</span>&nbsp;<span class="op" id="1707519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707524">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707539">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1707582">Send</span><span class="op" id="1707586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707589">for</span>&nbsp;<span class="op" id="1707593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707597">switch</span>&nbsp;<span class="ident" id="1707604">atomicload</span><span class="op" id="1707614">(</span><span class="op" id="1707615">&amp;</span><span class="ident" id="1707616">sig</span><span class="op" id="1707619">.</span><span class="ident" id="1707620">state</span><span class="op" id="1707625">)</span>&nbsp;<span class="op" id="1707627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707631">default</span><span class="op" id="1707638">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707643">gothrow</span><span class="op" id="1707650">(</span><span class="string" id="1707651">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1707680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707684">case</span>&nbsp;<span class="ident" id="1707689">sigIdle</span><span class="op" id="1707696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707701">if</span>&nbsp;<span class="ident" id="1707704">cas</span><span class="op" id="1707707">(</span><span class="op" id="1707708">&amp;</span><span class="ident" id="1707709">sig</span><span class="op" id="1707712">.</span><span class="ident" id="1707713">state</span><span class="op" id="1707718">,</span>&nbsp;<span class="ident" id="1707720">sigIdle</span><span class="op" id="1707727">,</span>&nbsp;<span class="ident" id="1707729">sigSending</span><span class="op" id="1707739">)</span>&nbsp;<span class="op" id="1707741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707747">break</span>&nbsp;<span class="ident" id="1707753">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707761">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707765">case</span>&nbsp;<span class="ident" id="1707770">sigSending</span><span class="op" id="1707780">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707785">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707820">break</span>&nbsp;<span class="ident" id="1707826">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707833">case</span>&nbsp;<span class="ident" id="1707838">sigReceiving</span><span class="op" id="1707850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707855">if</span>&nbsp;<span class="ident" id="1707858">cas</span><span class="op" id="1707861">(</span><span class="op" id="1707862">&amp;</span><span class="ident" id="1707863">sig</span><span class="op" id="1707866">.</span><span class="ident" id="1707867">state</span><span class="op" id="1707872">,</span>&nbsp;<span class="ident" id="1707874">sigReceiving</span><span class="op" id="1707886">,</span>&nbsp;<span class="ident" id="1707888">sigIdle</span><span class="op" id="1707895">)</span>&nbsp;<span class="op" id="1707897">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707903">notewakeup</span><span class="op" id="1707913">(</span><span class="op" id="1707914">&amp;</span><span class="ident" id="1707915">sig</span><span class="op" id="1707918">.</span><span class="ident" id="1707919">note</span><span class="op" id="1707923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707929">break</span>&nbsp;<span class="ident" id="1707935">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707950">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1707954">return</span>&nbsp;<span class="builtintype" id="1707961">true</span><br>
<span class="lineno"></span><span class="op" id="1707966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1707969">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1708014">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1708072">func</span>&nbsp;<span class="ident" id="1708077">signal_recv</span><span class="op" id="1708088">(</span><span class="op" id="1708089">)</span>&nbsp;<span class="builtintype" id="1708091">uint32</span>&nbsp;<span class="op" id="1708098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708101">for</span>&nbsp;<span class="op" id="1708105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708109">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708149">for</span>&nbsp;<span class="ident" id="1708153">i</span>&nbsp;<span class="op" id="1708155">:=</span>&nbsp;<span class="builtintype" id="1708158">uint32</span><span class="op" id="1708164">(</span><span class="num" id="1708165">0</span><span class="op" id="1708166">)</span><span class="op" id="1708167">;</span>&nbsp;<span class="ident" id="1708169">i</span>&nbsp;<span class="op" id="1708171">&lt;</span>&nbsp;<span class="ident" id="1708173">_NSIG</span><span class="op" id="1708178">;</span>&nbsp;<span class="ident" id="1708180">i</span><span class="op" id="1708181">++</span>&nbsp;<span class="op" id="1708184">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708189">if</span>&nbsp;<span class="ident" id="1708192">sig</span><span class="op" id="1708195">.</span><span class="ident" id="1708196">recv</span><span class="op" id="1708200">[</span><span class="ident" id="1708201">i</span><span class="op" id="1708202">/</span><span class="num" id="1708203">32</span><span class="op" id="1708205">]</span><span class="op" id="1708206">&amp;</span><span class="op" id="1708207">(</span><span class="num" id="1708208">1</span><span class="op" id="1708209">&lt;&lt;</span><span class="op" id="1708211">(</span><span class="ident" id="1708212">i</span><span class="op" id="1708213">&amp;</span><span class="num" id="1708214">31</span><span class="op" id="1708216">)</span><span class="op" id="1708217">)</span>&nbsp;<span class="op" id="1708219">!=</span>&nbsp;<span class="num" id="1708222">0</span>&nbsp;<span class="op" id="1708224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708230">sig</span><span class="op" id="1708233">.</span><span class="ident" id="1708234">recv</span><span class="op" id="1708238">[</span><span class="ident" id="1708239">i</span><span class="op" id="1708240">/</span><span class="num" id="1708241">32</span><span class="op" id="1708243">]</span>&nbsp;<span class="op" id="1708245">&amp;^=</span>&nbsp;<span class="num" id="1708249">1</span>&nbsp;<span class="op" id="1708251">&lt;&lt;</span>&nbsp;<span class="op" id="1708254">(</span><span class="ident" id="1708255">i</span>&nbsp;<span class="op" id="1708257">&amp;</span>&nbsp;<span class="num" id="1708259">31</span><span class="op" id="1708261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708267">return</span>&nbsp;<span class="ident" id="1708274">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708283">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708288">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708345">Receive</span><span class="op" id="1708352">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708356">for</span>&nbsp;<span class="op" id="1708360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708365">switch</span>&nbsp;<span class="ident" id="1708372">atomicload</span><span class="op" id="1708382">(</span><span class="op" id="1708383">&amp;</span><span class="ident" id="1708384">sig</span><span class="op" id="1708387">.</span><span class="ident" id="1708388">state</span><span class="op" id="1708393">)</span>&nbsp;<span class="op" id="1708395">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708400">default</span><span class="op" id="1708407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708413">gothrow</span><span class="op" id="1708420">(</span><span class="string" id="1708421">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1708454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708459">case</span>&nbsp;<span class="ident" id="1708464">sigIdle</span><span class="op" id="1708471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708477">if</span>&nbsp;<span class="ident" id="1708480">cas</span><span class="op" id="1708483">(</span><span class="op" id="1708484">&amp;</span><span class="ident" id="1708485">sig</span><span class="op" id="1708488">.</span><span class="ident" id="1708489">state</span><span class="op" id="1708494">,</span>&nbsp;<span class="ident" id="1708496">sigIdle</span><span class="op" id="1708503">,</span>&nbsp;<span class="ident" id="1708505">sigReceiving</span><span class="op" id="1708517">)</span>&nbsp;<span class="op" id="1708519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708526">notetsleepg</span><span class="op" id="1708537">(</span><span class="op" id="1708538">&amp;</span><span class="ident" id="1708539">sig</span><span class="op" id="1708542">.</span><span class="ident" id="1708543">note</span><span class="op" id="1708547">,</span>&nbsp;<span class="op" id="1708549">-</span><span class="num" id="1708550">1</span><span class="op" id="1708551">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708558">noteclear</span><span class="op" id="1708567">(</span><span class="op" id="1708568">&amp;</span><span class="ident" id="1708569">sig</span><span class="op" id="1708572">.</span><span class="ident" id="1708573">note</span><span class="op" id="1708577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708584">break</span>&nbsp;<span class="ident" id="1708590">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708607">case</span>&nbsp;<span class="ident" id="1708612">sigSending</span><span class="op" id="1708622">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708628">if</span>&nbsp;<span class="ident" id="1708631">cas</span><span class="op" id="1708634">(</span><span class="op" id="1708635">&amp;</span><span class="ident" id="1708636">sig</span><span class="op" id="1708639">.</span><span class="ident" id="1708640">state</span><span class="op" id="1708645">,</span>&nbsp;<span class="ident" id="1708647">sigSending</span><span class="op" id="1708657">,</span>&nbsp;<span class="ident" id="1708659">sigIdle</span><span class="op" id="1708666">)</span>&nbsp;<span class="op" id="1708668">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708675">break</span>&nbsp;<span class="ident" id="1708681">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708707">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708761">for</span>&nbsp;<span class="ident" id="1708765">i</span>&nbsp;<span class="op" id="1708767">:=</span>&nbsp;<span class="keyword" id="1708770">range</span>&nbsp;<span class="ident" id="1708776">sig</span><span class="op" id="1708779">.</span><span class="ident" id="1708780">mask</span>&nbsp;<span class="op" id="1708785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708790">sig</span><span class="op" id="1708793">.</span><span class="ident" id="1708794">recv</span><span class="op" id="1708798">[</span><span class="ident" id="1708799">i</span><span class="op" id="1708800">]</span>&nbsp;<span class="op" id="1708802">=</span>&nbsp;<span class="ident" id="1708804">xchg</span><span class="op" id="1708808">(</span><span class="op" id="1708809">&amp;</span><span class="ident" id="1708810">sig</span><span class="op" id="1708813">.</span><span class="ident" id="1708814">mask</span><span class="op" id="1708818">[</span><span class="ident" id="1708819">i</span><span class="op" id="1708820">]</span><span class="op" id="1708821">,</span>&nbsp;<span class="num" id="1708823">0</span><span class="op" id="1708824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1708831">}</span><br>
<span class="lineno">125</span><span class="op" id="1708833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1708836">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1708894">func</span>&nbsp;<span class="ident" id="1708899">signal_enable</span><span class="op" id="1708912">(</span><span class="ident" id="1708913">s</span>&nbsp;<span class="builtintype" id="1708915">uint32</span><span class="op" id="1708921">)</span>&nbsp;<span class="op" id="1708923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1708926">if</span>&nbsp;<span class="op" id="1708929">!</span><span class="ident" id="1708930">sig</span><span class="op" id="1708933">.</span><span class="ident" id="1708934">inuse</span>&nbsp;<span class="op" id="1708940">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708944">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708991">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1709041">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709071">sig</span><span class="op" id="1709074">.</span><span class="ident" id="1709075">inuse</span>&nbsp;<span class="op" id="1709081">=</span>&nbsp;<span class="builtintype" id="1709083">true</span>&nbsp;<span class="comment" id="1709088">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709137">noteclear</span><span class="op" id="1709146">(</span><span class="op" id="1709147">&amp;</span><span class="ident" id="1709148">sig</span><span class="op" id="1709151">.</span><span class="ident" id="1709152">note</span><span class="op" id="1709156">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1709160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1709168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1709172">if</span>&nbsp;<span class="builtintype" id="1709175">int</span><span class="op" id="1709178">(</span><span class="ident" id="1709179">s</span><span class="op" id="1709180">)</span>&nbsp;<span class="op" id="1709182">&gt;=</span>&nbsp;<span class="builtinfunc" id="1709185">len</span><span class="op" id="1709188">(</span><span class="ident" id="1709189">sig</span><span class="op" id="1709192">.</span><span class="ident" id="1709193">wanted</span><span class="op" id="1709199">)</span><span class="op" id="1709200">*</span><span class="num" id="1709201">32</span>&nbsp;<span class="op" id="1709204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1709208">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1709216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709219">sig</span><span class="op" id="1709222">.</span><span class="ident" id="1709223">wanted</span><span class="op" id="1709229">[</span><span class="ident" id="1709230">s</span><span class="op" id="1709231">/</span><span class="num" id="1709232">32</span><span class="op" id="1709234">]</span>&nbsp;<span class="op" id="1709236">|=</span>&nbsp;<span class="num" id="1709239">1</span>&nbsp;<span class="op" id="1709241">&lt;&lt;</span>&nbsp;<span class="op" id="1709244">(</span><span class="ident" id="1709245">s</span>&nbsp;<span class="op" id="1709247">&amp;</span>&nbsp;<span class="num" id="1709249">31</span><span class="op" id="1709251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709254">sigenable_go</span><span class="op" id="1709266">(</span><span class="ident" id="1709267">s</span><span class="op" id="1709268">)</span><br>
<span class="lineno"></span><span class="op" id="1709270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1709273">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1709331">func</span>&nbsp;<span class="ident" id="1709336">signal_disable</span><span class="op" id="1709350">(</span><span class="ident" id="1709351">s</span>&nbsp;<span class="builtintype" id="1709353">uint32</span><span class="op" id="1709359">)</span>&nbsp;<span class="op" id="1709361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1709364">if</span>&nbsp;<span class="builtintype" id="1709367">int</span><span class="op" id="1709370">(</span><span class="ident" id="1709371">s</span><span class="op" id="1709372">)</span>&nbsp;<span class="op" id="1709374">&gt;=</span>&nbsp;<span class="builtinfunc" id="1709377">len</span><span class="op" id="1709380">(</span><span class="ident" id="1709381">sig</span><span class="op" id="1709384">.</span><span class="ident" id="1709385">wanted</span><span class="op" id="1709391">)</span><span class="op" id="1709392">*</span><span class="num" id="1709393">32</span>&nbsp;<span class="op" id="1709396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1709400">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1709408">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709411">sig</span><span class="op" id="1709414">.</span><span class="ident" id="1709415">wanted</span><span class="op" id="1709421">[</span><span class="ident" id="1709422">s</span><span class="op" id="1709423">/</span><span class="num" id="1709424">32</span><span class="op" id="1709426">]</span>&nbsp;<span class="op" id="1709428">&amp;^=</span>&nbsp;<span class="num" id="1709432">1</span>&nbsp;<span class="op" id="1709434">&lt;&lt;</span>&nbsp;<span class="op" id="1709437">(</span><span class="ident" id="1709438">s</span>&nbsp;<span class="op" id="1709440">&amp;</span>&nbsp;<span class="num" id="1709442">31</span><span class="op" id="1709444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709447">sigdisable_go</span><span class="op" id="1709460">(</span><span class="ident" id="1709461">s</span><span class="op" id="1709462">)</span><br>
<span class="lineno"></span><span class="op" id="1709464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1709467">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1709538">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1709551">func</span>&nbsp;<span class="ident" id="1709556">badsignal</span><span class="op" id="1709565">(</span><span class="ident" id="1709566">sig</span>&nbsp;<span class="builtintype" id="1709570">uintptr</span><span class="op" id="1709577">)</span>&nbsp;<span class="op" id="1709579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709582">cgocallback</span><span class="op" id="1709593">(</span><span class="ident" id="1709594">unsafe</span><span class="op" id="1709600">.</span><span class="ident" id="1709601">Pointer</span><span class="op" id="1709608">(</span><span class="ident" id="1709609">funcPC</span><span class="op" id="1709615">(</span><span class="ident" id="1709616">sigsend</span><span class="op" id="1709623">)</span><span class="op" id="1709624">)</span><span class="op" id="1709625">,</span>&nbsp;<span class="ident" id="1709627">noescape</span><span class="op" id="1709635">(</span><span class="ident" id="1709636">unsafe</span><span class="op" id="1709642">.</span><span class="ident" id="1709643">Pointer</span><span class="op" id="1709650">(</span><span class="op" id="1709651">&amp;</span><span class="ident" id="1709652">sig</span><span class="op" id="1709655">)</span><span class="op" id="1709656">)</span><span class="op" id="1709657">,</span>&nbsp;<span class="ident" id="1709659">unsafe</span><span class="op" id="1709665">.</span><span class="ident" id="1709666">Sizeof</span><span class="op" id="1709672">(</span><span class="ident" id="1709673">sig</span><span class="op" id="1709676">)</span><span class="op" id="1709677">)</span><br>
<span class="lineno"></span><span class="op" id="1709679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1709682">func</span>&nbsp;<span class="ident" id="1709687">sigenable_m</span><span class="op" id="1709698">(</span><span class="op" id="1709699">)</span><br>
<span class="lineno"></span><span class="keyword" id="1709701">func</span>&nbsp;<span class="ident" id="1709706">sigdisable_m</span><span class="op" id="1709718">(</span><span class="op" id="1709719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1709722">func</span>&nbsp;<span class="ident" id="1709727">sigenable_go</span><span class="op" id="1709739">(</span><span class="ident" id="1709740">s</span>&nbsp;<span class="builtintype" id="1709742">uint32</span><span class="op" id="1709748">)</span>&nbsp;<span class="op" id="1709750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709753">g</span>&nbsp;<span class="op" id="1709755">:=</span>&nbsp;<span class="ident" id="1709758">getg</span><span class="op" id="1709762">(</span><span class="op" id="1709763">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709766">g</span><span class="op" id="1709767">.</span><span class="ident" id="1709768">m</span><span class="op" id="1709769">.</span><span class="ident" id="1709770">scalararg</span><span class="op" id="1709779">[</span><span class="num" id="1709780">0</span><span class="op" id="1709781">]</span>&nbsp;<span class="op" id="1709783">=</span>&nbsp;<span class="builtintype" id="1709785">uintptr</span><span class="op" id="1709792">(</span><span class="ident" id="1709793">s</span><span class="op" id="1709794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709797">onM</span><span class="op" id="1709800">(</span><span class="ident" id="1709801">sigenable_m</span><span class="op" id="1709812">)</span><br>
<span class="lineno"></span><span class="op" id="1709814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1709817">func</span>&nbsp;<span class="ident" id="1709822">sigdisable_go</span><span class="op" id="1709835">(</span><span class="ident" id="1709836">s</span>&nbsp;<span class="builtintype" id="1709838">uint32</span><span class="op" id="1709844">)</span>&nbsp;<span class="op" id="1709846">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709849">g</span>&nbsp;<span class="op" id="1709851">:=</span>&nbsp;<span class="ident" id="1709854">getg</span><span class="op" id="1709858">(</span><span class="op" id="1709859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709862">g</span><span class="op" id="1709863">.</span><span class="ident" id="1709864">m</span><span class="op" id="1709865">.</span><span class="ident" id="1709866">scalararg</span><span class="op" id="1709875">[</span><span class="num" id="1709876">0</span><span class="op" id="1709877">]</span>&nbsp;<span class="op" id="1709879">=</span>&nbsp;<span class="builtintype" id="1709881">uintptr</span><span class="op" id="1709888">(</span><span class="ident" id="1709889">s</span><span class="op" id="1709890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709893">onM</span><span class="op" id="1709896">(</span><span class="ident" id="1709897">sigdisable_m</span><span class="op" id="1709909">)</span><br>
<span class="lineno"></span><span class="op" id="1709911">}</span>
</div>
</body>
</html>
