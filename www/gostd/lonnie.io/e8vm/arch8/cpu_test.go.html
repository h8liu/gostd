<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="8015002">package</span>&nbsp;<span class="ident" id="8015010">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8015017">import</span>&nbsp;<span class="op" id="8015024">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8015027">&#34;testing&#34;</span><br>
<span class="lineno">5</span><span class="op" id="8015037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8015040">type</span>&nbsp;<span class="ident" id="8015045">ti1</span>&nbsp;<span class="builtintype" id="8015049">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8015054">func</span>&nbsp;<span class="op" id="8015059">(</span><span class="ident" id="8015060">i</span>&nbsp;<span class="ident" id="8015062">ti1</span><span class="op" id="8015065">)</span>&nbsp;<span class="ident" id="8015067">I</span><span class="op" id="8015068">(</span><span class="ident" id="8015069">cpu</span>&nbsp;<span class="op" id="8015073">*</span><span class="ident" id="8015074">cpu</span><span class="op" id="8015077">,</span>&nbsp;<span class="ident" id="8015079">in</span>&nbsp;<span class="builtintype" id="8015082">uint32</span><span class="op" id="8015088">)</span>&nbsp;<span class="op" id="8015090">*</span><span class="ident" id="8015091">Excep</span>&nbsp;<span class="op" id="8015097">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015100">switch</span>&nbsp;<span class="ident" id="8015107">in</span>&nbsp;<span class="op" id="8015110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015113">case</span>&nbsp;<span class="num" id="8015118">0</span><span class="op" id="8015119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015123">return</span>&nbsp;<span class="ident" id="8015130">errHalt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015139">case</span>&nbsp;<span class="num" id="8015144">1</span><span class="op" id="8015145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015149">return</span>&nbsp;<span class="ident" id="8015156">errTimeInt</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015168">case</span>&nbsp;<span class="num" id="8015173">2</span><span class="op" id="8015174">:</span>&nbsp;<span class="comment" id="8015176">//&nbsp;iret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015186">if</span>&nbsp;<span class="ident" id="8015189">cpu</span><span class="op" id="8015192">.</span><span class="ident" id="8015193">UserMode</span><span class="op" id="8015201">(</span><span class="op" id="8015202">)</span>&nbsp;<span class="op" id="8015204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015209">return</span>&nbsp;<span class="ident" id="8015216">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015237">return</span>&nbsp;<span class="ident" id="8015244">cpu</span><span class="op" id="8015247">.</span><span class="ident" id="8015248">Iret</span><span class="op" id="8015252">(</span><span class="op" id="8015253">)</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015256">default</span><span class="op" id="8015263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015267">return</span>&nbsp;<span class="ident" id="8015274">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015290">}</span><br>
<span class="lineno"></span><span class="op" id="8015292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8015295">func</span>&nbsp;<span class="ident" id="8015300">TestCPU</span><span class="op" id="8015307">(</span><span class="ident" id="8015308">t</span>&nbsp;<span class="op" id="8015310">*</span><span class="ident" id="8015311">testing</span><span class="op" id="8015318">.</span><span class="ident" id="8015319">T</span><span class="op" id="8015320">)</span>&nbsp;<span class="op" id="8015322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015325">as</span>&nbsp;<span class="op" id="8015328">:=</span>&nbsp;<span class="keyword" id="8015331">func</span><span class="op" id="8015335">(</span><span class="ident" id="8015336">cond</span>&nbsp;<span class="builtintype" id="8015341">bool</span><span class="op" id="8015345">,</span>&nbsp;<span class="ident" id="8015347">s</span>&nbsp;<span class="builtintype" id="8015349">string</span><span class="op" id="8015355">,</span>&nbsp;<span class="ident" id="8015357">args</span>&nbsp;<span class="op" id="8015362">...</span><span class="keyword" id="8015365">interface</span><span class="op" id="8015374">{</span><span class="op" id="8015375">}</span><span class="op" id="8015376">)</span>&nbsp;<span class="op" id="8015378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015382">if</span>&nbsp;<span class="op" id="8015385">!</span><span class="ident" id="8015386">cond</span>&nbsp;<span class="op" id="8015391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015396">t</span><span class="op" id="8015397">.</span><span class="ident" id="8015398">Fatalf</span><span class="op" id="8015404">(</span><span class="ident" id="8015405">s</span><span class="op" id="8015406">,</span>&nbsp;<span class="ident" id="8015408">args</span><span class="op" id="8015412">...</span><span class="op" id="8015415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015419">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015426">m</span>&nbsp;<span class="op" id="8015428">:=</span>&nbsp;<span class="ident" id="8015431">newPhyMemory</span><span class="op" id="8015443">(</span><span class="ident" id="8015444">PageSize</span>&nbsp;<span class="op" id="8015453">*</span>&nbsp;<span class="num" id="8015455">32</span><span class="op" id="8015457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015460">cpu</span>&nbsp;<span class="op" id="8015464">:=</span>&nbsp;<span class="ident" id="8015467">newCPU</span><span class="op" id="8015473">(</span><span class="ident" id="8015474">m</span><span class="op" id="8015475">,</span>&nbsp;<span class="ident" id="8015477">ti1</span><span class="op" id="8015480">(</span><span class="num" id="8015481">0</span><span class="op" id="8015482">)</span><span class="op" id="8015483">,</span>&nbsp;<span class="num" id="8015485">0</span><span class="op" id="8015486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015489">e</span>&nbsp;<span class="op" id="8015491">:=</span>&nbsp;<span class="ident" id="8015494">cpu</span><span class="op" id="8015497">.</span><span class="ident" id="8015498">Tick</span><span class="op" id="8015502">(</span><span class="op" id="8015503">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015506">as</span><span class="op" id="8015508">(</span><span class="ident" id="8015509">e</span>&nbsp;<span class="op" id="8015511">==</span>&nbsp;<span class="ident" id="8015514">errHalt</span><span class="op" id="8015521">,</span>&nbsp;<span class="string" id="8015523">&#34;not&nbsp;halting&#34;</span><span class="op" id="8015536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015540">cpu</span><span class="op" id="8015543">.</span><span class="ident" id="8015544">Reset</span><span class="op" id="8015549">(</span><span class="op" id="8015550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015553">m</span><span class="op" id="8015554">.</span><span class="ident" id="8015555">WriteWord</span><span class="op" id="8015564">(</span><span class="ident" id="8015565">InitPC</span><span class="op" id="8015571">,</span>&nbsp;<span class="num" id="8015573">1</span><span class="op" id="8015574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015577">e</span>&nbsp;<span class="op" id="8015579">=</span>&nbsp;<span class="ident" id="8015581">cpu</span><span class="op" id="8015584">.</span><span class="ident" id="8015585">Tick</span><span class="op" id="8015589">(</span><span class="op" id="8015590">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015593">as</span><span class="op" id="8015595">(</span><span class="ident" id="8015596">e</span>&nbsp;<span class="op" id="8015598">==</span>&nbsp;<span class="ident" id="8015601">errTimeInt</span><span class="op" id="8015611">,</span>&nbsp;<span class="string" id="8015613">&#34;not&nbsp;time&nbsp;interrupt&#34;</span><span class="op" id="8015633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015637">cpu</span><span class="op" id="8015640">.</span><span class="ident" id="8015641">Reset</span><span class="op" id="8015646">(</span><span class="op" id="8015647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015650">cpu</span><span class="op" id="8015653">.</span><span class="ident" id="8015654">interrupt</span><span class="op" id="8015663">.</span><span class="ident" id="8015664">Enable</span><span class="op" id="8015670">(</span><span class="op" id="8015671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015674">cpu</span><span class="op" id="8015677">.</span><span class="ident" id="8015678">interrupt</span><span class="op" id="8015687">.</span><span class="ident" id="8015688">EnableInt</span><span class="op" id="8015697">(</span><span class="ident" id="8015698">errTimeInt</span><span class="op" id="8015708">.</span><span class="ident" id="8015709">Code</span><span class="op" id="8015713">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015716">cpu</span><span class="op" id="8015719">.</span><span class="ident" id="8015720">interrupt</span><span class="op" id="8015729">.</span><span class="ident" id="8015730">writeWord</span><span class="op" id="8015739">(</span><span class="ident" id="8015740">intKernelSP</span><span class="op" id="8015751">,</span>&nbsp;<span class="num" id="8015753">0x10000</span><span class="op" id="8015760">)</span>&nbsp;&nbsp;<span class="comment" id="8015763">//&nbsp;page&nbsp;16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015775">cpu</span><span class="op" id="8015778">.</span><span class="ident" id="8015779">interrupt</span><span class="op" id="8015788">.</span><span class="ident" id="8015789">writeWord</span><span class="op" id="8015798">(</span><span class="ident" id="8015799">intHandlerPC</span><span class="op" id="8015811">,</span>&nbsp;<span class="num" id="8015813">0x10000</span><span class="op" id="8015820">)</span>&nbsp;<span class="comment" id="8015822">//&nbsp;page&nbsp;16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015834">cpu</span><span class="op" id="8015837">.</span><span class="ident" id="8015838">ring</span>&nbsp;<span class="op" id="8015843">=</span>&nbsp;<span class="num" id="8015845">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015849">e</span>&nbsp;<span class="op" id="8015851">=</span>&nbsp;<span class="ident" id="8015853">cpu</span><span class="op" id="8015856">.</span><span class="ident" id="8015857">Tick</span><span class="op" id="8015861">(</span><span class="op" id="8015862">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015865">as</span><span class="op" id="8015867">(</span><span class="ident" id="8015868">e</span>&nbsp;<span class="op" id="8015870">==</span>&nbsp;<span class="ident" id="8015873">nil</span><span class="op" id="8015876">,</span>&nbsp;<span class="string" id="8015878">&#34;should&nbsp;have&nbsp;no&nbsp;error&#34;</span><span class="op" id="8015900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015903">as</span><span class="op" id="8015905">(</span><span class="ident" id="8015906">cpu</span><span class="op" id="8015909">.</span><span class="ident" id="8015910">regs</span><span class="op" id="8015914">[</span><span class="ident" id="8015915">PC</span><span class="op" id="8015917">]</span>&nbsp;<span class="op" id="8015919">==</span>&nbsp;<span class="num" id="8015922">0x10000</span><span class="op" id="8015929">,</span>&nbsp;<span class="string" id="8015931">&#34;pc&nbsp;incorrect&#34;</span><span class="op" id="8015945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015948">as</span><span class="op" id="8015950">(</span><span class="ident" id="8015951">cpu</span><span class="op" id="8015954">.</span><span class="ident" id="8015955">regs</span><span class="op" id="8015959">[</span><span class="ident" id="8015960">SP</span><span class="op" id="8015962">]</span>&nbsp;<span class="op" id="8015964">==</span>&nbsp;<span class="num" id="8015967">0x10000</span><span class="op" id="8015974">,</span>&nbsp;<span class="string" id="8015976">&#34;sp&nbsp;incorrect&#34;</span><span class="op" id="8015990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015993">as</span><span class="op" id="8015995">(</span><span class="ident" id="8015996">cpu</span><span class="op" id="8015999">.</span><span class="ident" id="8016000">regs</span><span class="op" id="8016004">[</span><span class="ident" id="8016005">RET</span><span class="op" id="8016008">]</span>&nbsp;<span class="op" id="8016010">==</span>&nbsp;<span class="num" id="8016013">0x8000</span><span class="op" id="8016019">,</span>&nbsp;<span class="string" id="8016021">&#34;ret&nbsp;incorrect&#34;</span><span class="op" id="8016036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016039">as</span><span class="op" id="8016041">(</span><span class="op" id="8016042">!</span><span class="ident" id="8016043">cpu</span><span class="op" id="8016046">.</span><span class="ident" id="8016047">UserMode</span><span class="op" id="8016055">(</span><span class="op" id="8016056">)</span><span class="op" id="8016057">,</span>&nbsp;<span class="string" id="8016059">&#34;not&nbsp;in&nbsp;kernel&#34;</span><span class="op" id="8016074">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016077">b</span><span class="op" id="8016078">,</span>&nbsp;<span class="ident" id="8016080">e</span>&nbsp;<span class="op" id="8016082">:=</span>&nbsp;<span class="ident" id="8016085">m</span><span class="op" id="8016086">.</span><span class="ident" id="8016087">ReadByte</span><span class="op" id="8016095">(</span><span class="num" id="8016096">0x10000</span>&nbsp;<span class="op" id="8016104">-</span>&nbsp;<span class="ident" id="8016106">intFrameSize</span>&nbsp;<span class="op" id="8016119">+</span>&nbsp;<span class="ident" id="8016121">intFrameCode</span><span class="op" id="8016133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016136">as</span><span class="op" id="8016138">(</span><span class="ident" id="8016139">e</span>&nbsp;<span class="op" id="8016141">==</span>&nbsp;<span class="ident" id="8016144">nil</span><span class="op" id="8016147">,</span>&nbsp;<span class="string" id="8016149">&#34;read&nbsp;byte&nbsp;error&#34;</span><span class="op" id="8016166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016169">as</span><span class="op" id="8016171">(</span><span class="ident" id="8016172">b</span>&nbsp;<span class="op" id="8016174">==</span>&nbsp;<span class="ident" id="8016177">errTimeInt</span><span class="op" id="8016187">.</span><span class="ident" id="8016188">Code</span><span class="op" id="8016192">,</span>&nbsp;<span class="string" id="8016194">&#34;not&nbsp;time&nbsp;interrupt&#34;</span><span class="op" id="8016214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016217">b</span><span class="op" id="8016218">,</span>&nbsp;<span class="ident" id="8016220">e</span>&nbsp;<span class="op" id="8016222">=</span>&nbsp;<span class="ident" id="8016224">m</span><span class="op" id="8016225">.</span><span class="ident" id="8016226">ReadByte</span><span class="op" id="8016234">(</span><span class="num" id="8016235">0x10000</span>&nbsp;<span class="op" id="8016243">-</span>&nbsp;<span class="ident" id="8016245">intFrameSize</span>&nbsp;<span class="op" id="8016258">+</span>&nbsp;<span class="ident" id="8016260">intFrameRing</span><span class="op" id="8016272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016275">as</span><span class="op" id="8016277">(</span><span class="ident" id="8016278">b</span>&nbsp;<span class="op" id="8016280">==</span>&nbsp;<span class="num" id="8016283">1</span><span class="op" id="8016284">,</span>&nbsp;<span class="string" id="8016286">&#34;was&nbsp;not&nbsp;in&nbsp;user&#34;</span><span class="op" id="8016303">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016306">as</span><span class="op" id="8016308">(</span><span class="op" id="8016309">!</span><span class="ident" id="8016310">cpu</span><span class="op" id="8016313">.</span><span class="ident" id="8016314">interrupt</span><span class="op" id="8016323">.</span><span class="ident" id="8016324">Enabled</span><span class="op" id="8016331">(</span><span class="op" id="8016332">)</span><span class="op" id="8016333">,</span>&nbsp;<span class="string" id="8016335">&#34;interrupt&nbsp;not&nbsp;disabled&#34;</span><span class="op" id="8016359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016363">e</span>&nbsp;<span class="op" id="8016365">=</span>&nbsp;<span class="ident" id="8016367">cpu</span><span class="op" id="8016370">.</span><span class="ident" id="8016371">Tick</span><span class="op" id="8016375">(</span><span class="op" id="8016376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016379">as</span><span class="op" id="8016381">(</span><span class="ident" id="8016382">e</span>&nbsp;<span class="op" id="8016384">==</span>&nbsp;<span class="ident" id="8016387">errHalt</span><span class="op" id="8016394">,</span>&nbsp;<span class="string" id="8016396">&#34;should&nbsp;halt&nbsp;now&#34;</span><span class="op" id="8016413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016417">cpu</span><span class="op" id="8016420">.</span><span class="ident" id="8016421">Reset</span><span class="op" id="8016426">(</span><span class="op" id="8016427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016430">cpu</span><span class="op" id="8016433">.</span><span class="ident" id="8016434">interrupt</span><span class="op" id="8016443">.</span><span class="ident" id="8016444">Enable</span><span class="op" id="8016450">(</span><span class="op" id="8016451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016454">cpu</span><span class="op" id="8016457">.</span><span class="ident" id="8016458">ring</span>&nbsp;<span class="op" id="8016463">=</span>&nbsp;<span class="num" id="8016465">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016468">m</span><span class="op" id="8016469">.</span><span class="ident" id="8016470">WriteWord</span><span class="op" id="8016479">(</span><span class="num" id="8016480">0x10000</span><span class="op" id="8016487">,</span>&nbsp;<span class="num" id="8016489">2</span><span class="op" id="8016490">)</span>&nbsp;<span class="comment" id="8016492">//&nbsp;write&nbsp;an&nbsp;iret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016510">e</span>&nbsp;<span class="op" id="8016512">=</span>&nbsp;<span class="ident" id="8016514">cpu</span><span class="op" id="8016517">.</span><span class="ident" id="8016518">Tick</span><span class="op" id="8016522">(</span><span class="op" id="8016523">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016526">as</span><span class="op" id="8016528">(</span><span class="ident" id="8016529">e</span>&nbsp;<span class="op" id="8016531">==</span>&nbsp;<span class="ident" id="8016534">nil</span><span class="op" id="8016537">,</span>&nbsp;<span class="string" id="8016539">&#34;unexpected&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8016561">,</span>&nbsp;<span class="ident" id="8016563">e</span><span class="op" id="8016564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016567">as</span><span class="op" id="8016569">(</span><span class="op" id="8016570">!</span><span class="ident" id="8016571">cpu</span><span class="op" id="8016574">.</span><span class="ident" id="8016575">interrupt</span><span class="op" id="8016584">.</span><span class="ident" id="8016585">Enabled</span><span class="op" id="8016592">(</span><span class="op" id="8016593">)</span><span class="op" id="8016594">,</span>&nbsp;<span class="string" id="8016596">&#34;interrupt&nbsp;not&nbsp;disabled&#34;</span><span class="op" id="8016620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016623">e</span>&nbsp;<span class="op" id="8016625">=</span>&nbsp;<span class="ident" id="8016627">cpu</span><span class="op" id="8016630">.</span><span class="ident" id="8016631">Tick</span><span class="op" id="8016635">(</span><span class="op" id="8016636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016639">as</span><span class="op" id="8016641">(</span><span class="ident" id="8016642">e</span>&nbsp;<span class="op" id="8016644">==</span>&nbsp;<span class="ident" id="8016647">nil</span><span class="op" id="8016650">,</span>&nbsp;<span class="string" id="8016652">&#34;unexpected&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8016674">,</span>&nbsp;<span class="ident" id="8016676">e</span><span class="op" id="8016677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016680">as</span><span class="op" id="8016682">(</span><span class="ident" id="8016683">cpu</span><span class="op" id="8016686">.</span><span class="ident" id="8016687">regs</span><span class="op" id="8016691">[</span><span class="ident" id="8016692">PC</span><span class="op" id="8016694">]</span>&nbsp;<span class="op" id="8016696">==</span>&nbsp;<span class="num" id="8016699">0x8000</span><span class="op" id="8016705">,</span>&nbsp;<span class="string" id="8016707">&#34;pc&nbsp;not&nbsp;iret&#39;ed&#34;</span><span class="op" id="8016723">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016726">as</span><span class="op" id="8016728">(</span><span class="ident" id="8016729">cpu</span><span class="op" id="8016732">.</span><span class="ident" id="8016733">regs</span><span class="op" id="8016737">[</span><span class="ident" id="8016738">SP</span><span class="op" id="8016740">]</span>&nbsp;<span class="op" id="8016742">==</span>&nbsp;<span class="num" id="8016745">0</span><span class="op" id="8016746">,</span>&nbsp;<span class="string" id="8016748">&#34;sp&nbsp;not&nbsp;restored&#34;</span><span class="op" id="8016765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016768">as</span><span class="op" id="8016770">(</span><span class="ident" id="8016771">cpu</span><span class="op" id="8016774">.</span><span class="ident" id="8016775">ring</span>&nbsp;<span class="op" id="8016780">==</span>&nbsp;<span class="num" id="8016783">1</span><span class="op" id="8016784">,</span>&nbsp;<span class="string" id="8016786">&#34;ring&nbsp;not&nbsp;restored&#34;</span><span class="op" id="8016805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016808">as</span><span class="op" id="8016810">(</span><span class="ident" id="8016811">cpu</span><span class="op" id="8016814">.</span><span class="ident" id="8016815">interrupt</span><span class="op" id="8016824">.</span><span class="ident" id="8016825">Enabled</span><span class="op" id="8016832">(</span><span class="op" id="8016833">)</span><span class="op" id="8016834">,</span>&nbsp;<span class="string" id="8016836">&#34;interrupt&nbsp;not&nbsp;enabled&nbsp;again&#34;</span><span class="op" id="8016865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016868">has</span><span class="op" id="8016871">,</span>&nbsp;<span class="ident" id="8016873">code</span>&nbsp;<span class="op" id="8016878">:=</span>&nbsp;<span class="ident" id="8016881">cpu</span><span class="op" id="8016884">.</span><span class="ident" id="8016885">interrupt</span><span class="op" id="8016894">.</span><span class="ident" id="8016895">Poll</span><span class="op" id="8016899">(</span><span class="op" id="8016900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016903">as</span><span class="op" id="8016905">(</span><span class="op" id="8016906">!</span><span class="ident" id="8016907">has</span>&nbsp;<span class="op" id="8016911">&amp;&amp;</span>&nbsp;<span class="ident" id="8016914">code</span>&nbsp;<span class="op" id="8016919">==</span>&nbsp;<span class="num" id="8016922">0</span><span class="op" id="8016923">,</span>&nbsp;<span class="string" id="8016925">&#34;interrupt&nbsp;was&nbsp;not&nbsp;cleared&#34;</span><span class="op" id="8016952">)</span><br>
<span class="lineno">80</span><span class="op" id="8016954">}</span>
</div>
</body>
</html>
