<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/gob&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ServerError&nbsp;represents&nbsp;an&nbsp;error&nbsp;that&nbsp;has&nbsp;been&nbsp;returned&nbsp;from</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;remote&nbsp;side&nbsp;of&nbsp;the&nbsp;RPC&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword">type</span>&nbsp;<span class="ident">ServerError</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="ident">ServerError</span><span class="op">)</span>&nbsp;<span class="ident">Error</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">e</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrShutdown</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;connection&nbsp;is&nbsp;shut&nbsp;down&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Call&nbsp;represents&nbsp;an&nbsp;active&nbsp;RPC.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Call</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ServiceMethod</span>&nbsp;<span class="builtintype">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Args</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;argument&nbsp;to&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Reply</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span>&nbsp;<span class="comment">//&nbsp;The&nbsp;reply&nbsp;from&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;After&nbsp;completion,&nbsp;the&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">chan</span>&nbsp;<span class="op">*</span><span class="ident">Call</span>&nbsp;&nbsp;<span class="comment">//&nbsp;Strobes&nbsp;when&nbsp;call&nbsp;is&nbsp;complete.</span><br>
<span class="lineno">35</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Client&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Client.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;There&nbsp;may&nbsp;be&nbsp;multiple&nbsp;outstanding&nbsp;Calls&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;a&nbsp;single&nbsp;Client,&nbsp;and&nbsp;a&nbsp;Client&nbsp;may&nbsp;be&nbsp;used&nbsp;by</span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Client</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codec</span>&nbsp;<span class="ident">ClientCodec</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reqMutex</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span>&nbsp;<span class="comment">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">request</span>&nbsp;&nbsp;<span class="ident">Request</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span>&nbsp;<span class="comment">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pending</span>&nbsp;&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">uint64</span><span class="op">]</span><span class="op">*</span><span class="ident">Call</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">closing</span>&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;user&nbsp;has&nbsp;called&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shutdown</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;server&nbsp;has&nbsp;told&nbsp;us&nbsp;to&nbsp;stop</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;ClientCodec&nbsp;implements&nbsp;writing&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and</span><br>
<span class="lineno">55</span><span class="comment">//&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;client&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;client&nbsp;calls&nbsp;WriteRequest&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;to&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;calls&nbsp;ReadResponseHeader&nbsp;and&nbsp;ReadResponseBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;read&nbsp;responses.&nbsp;&nbsp;The&nbsp;client&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;connection.&nbsp;ReadResponseBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">ClientCodec</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;WriteRequest&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">WriteRequest</span><span class="op">(</span><span class="op">*</span><span class="ident">Request</span><span class="op">,</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ReadResponseHeader</span><span class="op">(</span><span class="op">*</span><span class="ident">Response</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ReadResponseBody</span><span class="op">(</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">client</span>&nbsp;<span class="op">*</span><span class="ident">Client</span><span class="op">)</span>&nbsp;<span class="ident">send</span><span class="op">(</span><span class="ident">call</span>&nbsp;<span class="op">*</span><span class="ident">Call</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">reqMutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">reqMutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Register&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">shutdown</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">closing</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seq</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">seq</span><span class="op">++</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">pending</span><span class="op">[</span><span class="ident">seq</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Encode&nbsp;and&nbsp;send&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">request</span><span class="op">.</span><span class="ident">Seq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">seq</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">request</span><span class="op">.</span><span class="ident">ServiceMethod</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">call</span><span class="op">.</span><span class="ident">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">WriteRequest</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">client</span><span class="op">.</span><span class="ident">request</span><span class="op">,</span>&nbsp;<span class="ident">call</span><span class="op">.</span><span class="ident">Args</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">pending</span><span class="op">[</span><span class="ident">seq</span><span class="op">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">client</span><span class="op">.</span><span class="ident">pending</span><span class="op">,</span>&nbsp;<span class="ident">seq</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">call</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">client</span>&nbsp;<span class="op">*</span><span class="ident">Client</span><span class="op">)</span>&nbsp;<span class="ident">input</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">response</span>&nbsp;<span class="ident">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">response</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Response</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">ReadResponseHeader</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">response</span><span class="op">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seq</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">response</span><span class="op">.</span><span class="ident">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">pending</span><span class="op">[</span><span class="ident">seq</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">client</span><span class="op">.</span><span class="ident">pending</span><span class="op">,</span>&nbsp;<span class="ident">seq</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">call</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&#39;ve&nbsp;got&nbsp;no&nbsp;pending&nbsp;call.&nbsp;That&nbsp;usually&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;WriteRequest&nbsp;partially&nbsp;failed,&nbsp;and&nbsp;call&nbsp;was&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;removed;&nbsp;response&nbsp;is&nbsp;a&nbsp;server&nbsp;telling&nbsp;us&nbsp;about&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;error&nbsp;reading&nbsp;request&nbsp;body.&nbsp;We&nbsp;should&nbsp;still&nbsp;attempt</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;read&nbsp;error&nbsp;body,&nbsp;but&nbsp;there&#39;s&nbsp;no&nbsp;one&nbsp;to&nbsp;give&nbsp;it&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">ReadResponseBody</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">response</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&#39;ve&nbsp;got&nbsp;an&nbsp;error&nbsp;response.&nbsp;Give&nbsp;this&nbsp;to&nbsp;the&nbsp;request;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;any&nbsp;subsequent&nbsp;requests&nbsp;will&nbsp;get&nbsp;the&nbsp;ReadResponseBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;error&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ServerError</span><span class="op">(</span><span class="ident">response</span><span class="op">.</span><span class="ident">Error</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">ReadResponseBody</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">ReadResponseBody</span><span class="op">(</span><span class="ident">call</span><span class="op">.</span><span class="ident">Reply</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;reading&nbsp;body&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Terminate&nbsp;pending&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">reqMutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">shutdown</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">closing</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">closing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">closing</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">call</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">pending</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">done</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">reqMutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">debugLog</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">EOF</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">closing</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">log</span><span class="op">.</span><span class="ident">Println</span><span class="op">(</span><span class="string">&#34;rpc:&nbsp;client&nbsp;protocol&nbsp;error:&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">call</span>&nbsp;<span class="op">*</span><span class="ident">Call</span><span class="op">)</span>&nbsp;<span class="ident">done</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">select</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">call</span><span class="op">.</span><span class="ident">Done</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">call</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;ok</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;block&nbsp;here.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;sure&nbsp;the&nbsp;channel&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;space.&nbsp;See&nbsp;comment&nbsp;in&nbsp;Go().</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">debugLog</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">log</span><span class="op">.</span><span class="ident">Println</span><span class="op">(</span><span class="string">&#34;rpc:&nbsp;discarding&nbsp;Call&nbsp;reply&nbsp;due&nbsp;to&nbsp;insufficient&nbsp;Done&nbsp;chan&nbsp;capacity&#34;</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno">185</span><span class="comment">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;adds&nbsp;a&nbsp;buffer&nbsp;to&nbsp;the&nbsp;write&nbsp;side&nbsp;of&nbsp;the&nbsp;connection&nbsp;so</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;header&nbsp;and&nbsp;payload&nbsp;are&nbsp;sent&nbsp;as&nbsp;a&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewClient</span><span class="op">(</span><span class="ident">conn</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadWriteCloser</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Client</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encBuf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewWriter</span><span class="op">(</span><span class="ident">conn</span><span class="op">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">gobClientCodec</span><span class="op">{</span><span class="ident">conn</span><span class="op">,</span>&nbsp;<span class="ident">gob</span><span class="op">.</span><span class="ident">NewDecoder</span><span class="op">(</span><span class="ident">conn</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">gob</span><span class="op">.</span><span class="ident">NewEncoder</span><span class="op">(</span><span class="ident">encBuf</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">encBuf</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewClientWithCodec</span><span class="op">(</span><span class="ident">client</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewClientWithCodec&nbsp;is&nbsp;like&nbsp;NewClient&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified</span><br>
<span class="lineno">195</span><span class="comment">//&nbsp;codec&nbsp;to&nbsp;encode&nbsp;requests&nbsp;and&nbsp;decode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewClientWithCodec</span><span class="op">(</span><span class="ident">codec</span>&nbsp;<span class="ident">ClientCodec</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Client</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Client</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codec</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">codec</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pending</span><span class="op">:</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">uint64</span><span class="op">]</span><span class="op">*</span><span class="ident">Call</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">input</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">client</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="keyword">type</span>&nbsp;<span class="ident">gobClientCodec</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadWriteCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">gob</span><span class="op">.</span><span class="ident">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">gob</span><span class="op">.</span><span class="ident">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encBuf</span>&nbsp;<span class="op">*</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">Writer</span><br>
<span class="lineno">210</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">gobClientCodec</span><span class="op">)</span>&nbsp;<span class="ident">WriteRequest</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Request</span><span class="op">,</span>&nbsp;<span class="ident">body</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">Encode</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">Encode</span><span class="op">(</span><span class="ident">body</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">encBuf</span><span class="op">.</span><span class="ident">Flush</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">220</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">gobClientCodec</span><span class="op">)</span>&nbsp;<span class="ident">ReadResponseHeader</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Response</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">Decode</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">gobClientCodec</span><span class="op">)</span>&nbsp;<span class="ident">ReadResponseBody</span><span class="op">(</span><span class="ident">body</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">dec</span><span class="op">.</span><span class="ident">Decode</span><span class="op">(</span><span class="ident">body</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">gobClientCodec</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">rwc</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DialHTTP&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address</span><br>
<span class="lineno">235</span><span class="comment">//&nbsp;listening&nbsp;on&nbsp;the&nbsp;default&nbsp;HTTP&nbsp;RPC&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DialHTTP</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Client</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">DialHTTPPath</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">,</span>&nbsp;<span class="ident">DefaultRPCPath</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="comment">//&nbsp;DialHTTPPath&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address&nbsp;and&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DialHTTPPath</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">,</span>&nbsp;<span class="ident">path</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Client</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">conn</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">io</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">conn</span><span class="op">,</span>&nbsp;<span class="string">&#34;CONNECT&nbsp;&#34;</span><span class="op">+</span><span class="ident">path</span><span class="op">+</span><span class="string">&#34;&nbsp;HTTP/1.0\n\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Require&nbsp;successful&nbsp;HTTP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;before&nbsp;switching&nbsp;to&nbsp;RPC&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">resp</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">http</span><span class="op">.</span><span class="ident">ReadResponse</span><span class="op">(</span><span class="ident">bufio</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">conn</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">http</span><span class="op">.</span><span class="ident">Request</span><span class="op">{</span><span class="ident">Method</span><span class="op">:</span>&nbsp;<span class="string">&#34;CONNECT&#34;</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">resp</span><span class="op">.</span><span class="ident">Status</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">connected</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewClient</span><span class="op">(</span><span class="ident">conn</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;unexpected&nbsp;HTTP&nbsp;response:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">resp</span><span class="op">.</span><span class="ident">Status</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">conn</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">net</span><span class="op">.</span><span class="ident">OpError</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Op</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="string">&#34;dial-http&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Net</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">network</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">address</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Err</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">err</span><span class="op">,</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;an&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Client</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">conn</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewClient</span><span class="op">(</span><span class="ident">conn</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">275</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">client</span>&nbsp;<span class="op">*</span><span class="ident">Client</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">closing</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">closing</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">mutex</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">client</span><span class="op">.</span><span class="ident">codec</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Go&nbsp;invokes&nbsp;the&nbsp;function&nbsp;asynchronously.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;Call&nbsp;structure&nbsp;representing</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;invocation.&nbsp;&nbsp;The&nbsp;done&nbsp;channel&nbsp;will&nbsp;signal&nbsp;when&nbsp;the&nbsp;call&nbsp;is&nbsp;complete&nbsp;by&nbsp;returning</span><br>
<span class="lineno">290</span><span class="comment">//&nbsp;the&nbsp;same&nbsp;Call&nbsp;object.&nbsp;&nbsp;If&nbsp;done&nbsp;is&nbsp;nil,&nbsp;Go&nbsp;will&nbsp;allocate&nbsp;a&nbsp;new&nbsp;channel.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;non-nil,&nbsp;done&nbsp;must&nbsp;be&nbsp;buffered&nbsp;or&nbsp;Go&nbsp;will&nbsp;deliberately&nbsp;crash.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">client</span>&nbsp;<span class="op">*</span><span class="ident">Client</span><span class="op">)</span>&nbsp;<span class="ident">Go</span><span class="op">(</span><span class="ident">serviceMethod</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">args</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">reply</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="keyword">chan</span>&nbsp;<span class="op">*</span><span class="ident">Call</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Call</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">Call</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">ServiceMethod</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">serviceMethod</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Args</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">args</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Reply</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="op">*</span><span class="ident">Call</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;buffered.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;caller&nbsp;passes&nbsp;done&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;must&nbsp;arrange&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;done&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;for&nbsp;the&nbsp;number&nbsp;of&nbsp;simultaneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;RPCs&nbsp;that&nbsp;will&nbsp;be&nbsp;using&nbsp;that&nbsp;channel.&nbsp;&nbsp;If&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;totally&nbsp;unbuffered,&nbsp;it&#39;s&nbsp;best&nbsp;not&nbsp;to&nbsp;run&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">done</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">log</span><span class="op">.</span><span class="ident">Panic</span><span class="op">(</span><span class="string">&#34;rpc:&nbsp;done&nbsp;channel&nbsp;is&nbsp;unbuffered&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span><span class="op">.</span><span class="ident">Done</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">client</span><span class="op">.</span><span class="ident">send</span><span class="op">(</span><span class="ident">call</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">call</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Call&nbsp;invokes&nbsp;the&nbsp;named&nbsp;function,&nbsp;waits&nbsp;for&nbsp;it&nbsp;to&nbsp;complete,&nbsp;and&nbsp;returns&nbsp;its&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">client</span>&nbsp;<span class="op">*</span><span class="ident">Client</span><span class="op">)</span>&nbsp;<span class="ident">Call</span><span class="op">(</span><span class="ident">serviceMethod</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">args</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">reply</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">call</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">client</span><span class="op">.</span><span class="ident">Go</span><span class="op">(</span><span class="ident">serviceMethod</span><span class="op">,</span>&nbsp;<span class="ident">args</span><span class="op">,</span>&nbsp;<span class="ident">reply</span><span class="op">,</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="op">*</span><span class="ident">Call</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">call</span><span class="op">.</span><span class="ident">Error</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
