<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3899689">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3899744">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3899798">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3899849">package</span>&nbsp;<span class="ident" id="3899857">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3899862">import</span>&nbsp;<span class="op" id="3899869">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899872">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899881">&#34;crypto/aes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899895">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899912">&#34;crypto/hmac&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899927">&#34;crypto/sha256&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899944">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899961">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3899971">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3899976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3899979">//&nbsp;sessionState&nbsp;contains&nbsp;the&nbsp;information&nbsp;that&nbsp;is&nbsp;serialized&nbsp;into&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span><span class="comment" id="3900054">//&nbsp;ticket&nbsp;in&nbsp;order&nbsp;to&nbsp;later&nbsp;resume&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="3900103">type</span>&nbsp;<span class="ident" id="3900108">sessionState</span>&nbsp;<span class="keyword" id="3900121">struct</span>&nbsp;<span class="op" id="3900128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900131">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3900144">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900152">cipherSuite</span>&nbsp;&nbsp;<span class="builtintype" id="3900165">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900173">masterSecret</span>&nbsp;<span class="op" id="3900186">[</span><span class="op" id="3900187">]</span><span class="builtintype" id="3900188">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900194">certificates</span>&nbsp;<span class="op" id="3900207">[</span><span class="op" id="3900208">]</span><span class="op" id="3900209">[</span><span class="op" id="3900210">]</span><span class="builtintype" id="3900211">byte</span><br>
<span class="lineno">25</span><span class="op" id="3900216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3900219">func</span>&nbsp;<span class="op" id="3900224">(</span><span class="ident" id="3900225">s</span>&nbsp;<span class="op" id="3900227">*</span><span class="ident" id="3900228">sessionState</span><span class="op" id="3900240">)</span>&nbsp;<span class="ident" id="3900242">equal</span><span class="op" id="3900247">(</span><span class="ident" id="3900248">i</span>&nbsp;<span class="keyword" id="3900250">interface</span><span class="op" id="3900259">{</span><span class="op" id="3900260">}</span><span class="op" id="3900261">)</span>&nbsp;<span class="builtintype" id="3900263">bool</span>&nbsp;<span class="op" id="3900268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900271">s1</span><span class="op" id="3900273">,</span>&nbsp;<span class="ident" id="3900275">ok</span>&nbsp;<span class="op" id="3900278">:=</span>&nbsp;<span class="ident" id="3900281">i</span><span class="op" id="3900282">.</span><span class="op" id="3900283">(</span><span class="op" id="3900284">*</span><span class="ident" id="3900285">sessionState</span><span class="op" id="3900297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900300">if</span>&nbsp;<span class="op" id="3900303">!</span><span class="ident" id="3900304">ok</span>&nbsp;<span class="op" id="3900307">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900311">return</span>&nbsp;<span class="builtintype" id="3900318">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900329">if</span>&nbsp;<span class="ident" id="3900332">s</span><span class="op" id="3900333">.</span><span class="ident" id="3900334">vers</span>&nbsp;<span class="op" id="3900339">!=</span>&nbsp;<span class="ident" id="3900342">s1</span><span class="op" id="3900344">.</span><span class="ident" id="3900345">vers</span>&nbsp;<span class="op" id="3900350">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900355">s</span><span class="op" id="3900356">.</span><span class="ident" id="3900357">cipherSuite</span>&nbsp;<span class="op" id="3900369">!=</span>&nbsp;<span class="ident" id="3900372">s1</span><span class="op" id="3900374">.</span><span class="ident" id="3900375">cipherSuite</span>&nbsp;<span class="op" id="3900387">||</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900392">!</span><span class="ident" id="3900393">bytes</span><span class="op" id="3900398">.</span><span class="ident" id="3900399">Equal</span><span class="op" id="3900404">(</span><span class="ident" id="3900405">s</span><span class="op" id="3900406">.</span><span class="ident" id="3900407">masterSecret</span><span class="op" id="3900419">,</span>&nbsp;<span class="ident" id="3900421">s1</span><span class="op" id="3900423">.</span><span class="ident" id="3900424">masterSecret</span><span class="op" id="3900436">)</span>&nbsp;<span class="op" id="3900438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900442">return</span>&nbsp;<span class="builtintype" id="3900449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900460">if</span>&nbsp;<span class="builtinfunc" id="3900463">len</span><span class="op" id="3900466">(</span><span class="ident" id="3900467">s</span><span class="op" id="3900468">.</span><span class="ident" id="3900469">certificates</span><span class="op" id="3900481">)</span>&nbsp;<span class="op" id="3900483">!=</span>&nbsp;<span class="builtinfunc" id="3900486">len</span><span class="op" id="3900489">(</span><span class="ident" id="3900490">s1</span><span class="op" id="3900492">.</span><span class="ident" id="3900493">certificates</span><span class="op" id="3900505">)</span>&nbsp;<span class="op" id="3900507">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900511">return</span>&nbsp;<span class="builtintype" id="3900518">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900529">for</span>&nbsp;<span class="ident" id="3900533">i</span>&nbsp;<span class="op" id="3900535">:=</span>&nbsp;<span class="keyword" id="3900538">range</span>&nbsp;<span class="ident" id="3900544">s</span><span class="op" id="3900545">.</span><span class="ident" id="3900546">certificates</span>&nbsp;<span class="op" id="3900559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900563">if</span>&nbsp;<span class="op" id="3900566">!</span><span class="ident" id="3900567">bytes</span><span class="op" id="3900572">.</span><span class="ident" id="3900573">Equal</span><span class="op" id="3900578">(</span><span class="ident" id="3900579">s</span><span class="op" id="3900580">.</span><span class="ident" id="3900581">certificates</span><span class="op" id="3900593">[</span><span class="ident" id="3900594">i</span><span class="op" id="3900595">]</span><span class="op" id="3900596">,</span>&nbsp;<span class="ident" id="3900598">s1</span><span class="op" id="3900600">.</span><span class="ident" id="3900601">certificates</span><span class="op" id="3900613">[</span><span class="ident" id="3900614">i</span><span class="op" id="3900615">]</span><span class="op" id="3900616">)</span>&nbsp;<span class="op" id="3900618">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900623">return</span>&nbsp;<span class="builtintype" id="3900630">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900645">return</span>&nbsp;<span class="builtintype" id="3900652">true</span><br>
<span class="lineno">50</span><span class="op" id="3900657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3900660">func</span>&nbsp;<span class="op" id="3900665">(</span><span class="ident" id="3900666">s</span>&nbsp;<span class="op" id="3900668">*</span><span class="ident" id="3900669">sessionState</span><span class="op" id="3900681">)</span>&nbsp;<span class="ident" id="3900683">marshal</span><span class="op" id="3900690">(</span><span class="op" id="3900691">)</span>&nbsp;<span class="op" id="3900693">[</span><span class="op" id="3900694">]</span><span class="builtintype" id="3900695">byte</span>&nbsp;<span class="op" id="3900700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900703">length</span>&nbsp;<span class="op" id="3900710">:=</span>&nbsp;<span class="num" id="3900713">2</span>&nbsp;<span class="op" id="3900715">+</span>&nbsp;<span class="num" id="3900717">2</span>&nbsp;<span class="op" id="3900719">+</span>&nbsp;<span class="num" id="3900721">2</span>&nbsp;<span class="op" id="3900723">+</span>&nbsp;<span class="builtinfunc" id="3900725">len</span><span class="op" id="3900728">(</span><span class="ident" id="3900729">s</span><span class="op" id="3900730">.</span><span class="ident" id="3900731">masterSecret</span><span class="op" id="3900743">)</span>&nbsp;<span class="op" id="3900745">+</span>&nbsp;<span class="num" id="3900747">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900750">for</span>&nbsp;<span class="ident" id="3900754">_</span><span class="op" id="3900755">,</span>&nbsp;<span class="ident" id="3900757">cert</span>&nbsp;<span class="op" id="3900762">:=</span>&nbsp;<span class="keyword" id="3900765">range</span>&nbsp;<span class="ident" id="3900771">s</span><span class="op" id="3900772">.</span><span class="ident" id="3900773">certificates</span>&nbsp;<span class="op" id="3900786">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900790">length</span>&nbsp;<span class="op" id="3900797">+=</span>&nbsp;<span class="num" id="3900800">4</span>&nbsp;<span class="op" id="3900802">+</span>&nbsp;<span class="builtinfunc" id="3900804">len</span><span class="op" id="3900807">(</span><span class="ident" id="3900808">cert</span><span class="op" id="3900812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900819">ret</span>&nbsp;<span class="op" id="3900823">:=</span>&nbsp;<span class="builtinfunc" id="3900826">make</span><span class="op" id="3900830">(</span><span class="op" id="3900831">[</span><span class="op" id="3900832">]</span><span class="builtintype" id="3900833">byte</span><span class="op" id="3900837">,</span>&nbsp;<span class="ident" id="3900839">length</span><span class="op" id="3900845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900848">x</span>&nbsp;<span class="op" id="3900850">:=</span>&nbsp;<span class="ident" id="3900853">ret</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900858">x</span><span class="op" id="3900859">[</span><span class="num" id="3900860">0</span><span class="op" id="3900861">]</span>&nbsp;<span class="op" id="3900863">=</span>&nbsp;<span class="builtintype" id="3900865">byte</span><span class="op" id="3900869">(</span><span class="ident" id="3900870">s</span><span class="op" id="3900871">.</span><span class="ident" id="3900872">vers</span>&nbsp;<span class="op" id="3900877">&gt;&gt;</span>&nbsp;<span class="num" id="3900880">8</span><span class="op" id="3900881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900884">x</span><span class="op" id="3900885">[</span><span class="num" id="3900886">1</span><span class="op" id="3900887">]</span>&nbsp;<span class="op" id="3900889">=</span>&nbsp;<span class="builtintype" id="3900891">byte</span><span class="op" id="3900895">(</span><span class="ident" id="3900896">s</span><span class="op" id="3900897">.</span><span class="ident" id="3900898">vers</span><span class="op" id="3900902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900905">x</span><span class="op" id="3900906">[</span><span class="num" id="3900907">2</span><span class="op" id="3900908">]</span>&nbsp;<span class="op" id="3900910">=</span>&nbsp;<span class="builtintype" id="3900912">byte</span><span class="op" id="3900916">(</span><span class="ident" id="3900917">s</span><span class="op" id="3900918">.</span><span class="ident" id="3900919">cipherSuite</span>&nbsp;<span class="op" id="3900931">&gt;&gt;</span>&nbsp;<span class="num" id="3900934">8</span><span class="op" id="3900935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900938">x</span><span class="op" id="3900939">[</span><span class="num" id="3900940">3</span><span class="op" id="3900941">]</span>&nbsp;<span class="op" id="3900943">=</span>&nbsp;<span class="builtintype" id="3900945">byte</span><span class="op" id="3900949">(</span><span class="ident" id="3900950">s</span><span class="op" id="3900951">.</span><span class="ident" id="3900952">cipherSuite</span><span class="op" id="3900963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900966">x</span><span class="op" id="3900967">[</span><span class="num" id="3900968">4</span><span class="op" id="3900969">]</span>&nbsp;<span class="op" id="3900971">=</span>&nbsp;<span class="builtintype" id="3900973">byte</span><span class="op" id="3900977">(</span><span class="builtinfunc" id="3900978">len</span><span class="op" id="3900981">(</span><span class="ident" id="3900982">s</span><span class="op" id="3900983">.</span><span class="ident" id="3900984">masterSecret</span><span class="op" id="3900996">)</span>&nbsp;<span class="op" id="3900998">&gt;&gt;</span>&nbsp;<span class="num" id="3901001">8</span><span class="op" id="3901002">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901005">x</span><span class="op" id="3901006">[</span><span class="num" id="3901007">5</span><span class="op" id="3901008">]</span>&nbsp;<span class="op" id="3901010">=</span>&nbsp;<span class="builtintype" id="3901012">byte</span><span class="op" id="3901016">(</span><span class="builtinfunc" id="3901017">len</span><span class="op" id="3901020">(</span><span class="ident" id="3901021">s</span><span class="op" id="3901022">.</span><span class="ident" id="3901023">masterSecret</span><span class="op" id="3901035">)</span><span class="op" id="3901036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901039">x</span>&nbsp;<span class="op" id="3901041">=</span>&nbsp;<span class="ident" id="3901043">x</span><span class="op" id="3901044">[</span><span class="num" id="3901045">6</span><span class="op" id="3901046">:</span><span class="op" id="3901047">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3901050">copy</span><span class="op" id="3901054">(</span><span class="ident" id="3901055">x</span><span class="op" id="3901056">,</span>&nbsp;<span class="ident" id="3901058">s</span><span class="op" id="3901059">.</span><span class="ident" id="3901060">masterSecret</span><span class="op" id="3901072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901075">x</span>&nbsp;<span class="op" id="3901077">=</span>&nbsp;<span class="ident" id="3901079">x</span><span class="op" id="3901080">[</span><span class="builtinfunc" id="3901081">len</span><span class="op" id="3901084">(</span><span class="ident" id="3901085">s</span><span class="op" id="3901086">.</span><span class="ident" id="3901087">masterSecret</span><span class="op" id="3901099">)</span><span class="op" id="3901100">:</span><span class="op" id="3901101">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901105">x</span><span class="op" id="3901106">[</span><span class="num" id="3901107">0</span><span class="op" id="3901108">]</span>&nbsp;<span class="op" id="3901110">=</span>&nbsp;<span class="builtintype" id="3901112">byte</span><span class="op" id="3901116">(</span><span class="builtinfunc" id="3901117">len</span><span class="op" id="3901120">(</span><span class="ident" id="3901121">s</span><span class="op" id="3901122">.</span><span class="ident" id="3901123">certificates</span><span class="op" id="3901135">)</span>&nbsp;<span class="op" id="3901137">&gt;&gt;</span>&nbsp;<span class="num" id="3901140">8</span><span class="op" id="3901141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901144">x</span><span class="op" id="3901145">[</span><span class="num" id="3901146">1</span><span class="op" id="3901147">]</span>&nbsp;<span class="op" id="3901149">=</span>&nbsp;<span class="builtintype" id="3901151">byte</span><span class="op" id="3901155">(</span><span class="builtinfunc" id="3901156">len</span><span class="op" id="3901159">(</span><span class="ident" id="3901160">s</span><span class="op" id="3901161">.</span><span class="ident" id="3901162">certificates</span><span class="op" id="3901174">)</span><span class="op" id="3901175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901178">x</span>&nbsp;<span class="op" id="3901180">=</span>&nbsp;<span class="ident" id="3901182">x</span><span class="op" id="3901183">[</span><span class="num" id="3901184">2</span><span class="op" id="3901185">:</span><span class="op" id="3901186">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901190">for</span>&nbsp;<span class="ident" id="3901194">_</span><span class="op" id="3901195">,</span>&nbsp;<span class="ident" id="3901197">cert</span>&nbsp;<span class="op" id="3901202">:=</span>&nbsp;<span class="keyword" id="3901205">range</span>&nbsp;<span class="ident" id="3901211">s</span><span class="op" id="3901212">.</span><span class="ident" id="3901213">certificates</span>&nbsp;<span class="op" id="3901226">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901230">x</span><span class="op" id="3901231">[</span><span class="num" id="3901232">0</span><span class="op" id="3901233">]</span>&nbsp;<span class="op" id="3901235">=</span>&nbsp;<span class="builtintype" id="3901237">byte</span><span class="op" id="3901241">(</span><span class="builtinfunc" id="3901242">len</span><span class="op" id="3901245">(</span><span class="ident" id="3901246">cert</span><span class="op" id="3901250">)</span>&nbsp;<span class="op" id="3901252">&gt;&gt;</span>&nbsp;<span class="num" id="3901255">24</span><span class="op" id="3901257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901261">x</span><span class="op" id="3901262">[</span><span class="num" id="3901263">1</span><span class="op" id="3901264">]</span>&nbsp;<span class="op" id="3901266">=</span>&nbsp;<span class="builtintype" id="3901268">byte</span><span class="op" id="3901272">(</span><span class="builtinfunc" id="3901273">len</span><span class="op" id="3901276">(</span><span class="ident" id="3901277">cert</span><span class="op" id="3901281">)</span>&nbsp;<span class="op" id="3901283">&gt;&gt;</span>&nbsp;<span class="num" id="3901286">16</span><span class="op" id="3901288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901292">x</span><span class="op" id="3901293">[</span><span class="num" id="3901294">2</span><span class="op" id="3901295">]</span>&nbsp;<span class="op" id="3901297">=</span>&nbsp;<span class="builtintype" id="3901299">byte</span><span class="op" id="3901303">(</span><span class="builtinfunc" id="3901304">len</span><span class="op" id="3901307">(</span><span class="ident" id="3901308">cert</span><span class="op" id="3901312">)</span>&nbsp;<span class="op" id="3901314">&gt;&gt;</span>&nbsp;<span class="num" id="3901317">8</span><span class="op" id="3901318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901322">x</span><span class="op" id="3901323">[</span><span class="num" id="3901324">3</span><span class="op" id="3901325">]</span>&nbsp;<span class="op" id="3901327">=</span>&nbsp;<span class="builtintype" id="3901329">byte</span><span class="op" id="3901333">(</span><span class="builtinfunc" id="3901334">len</span><span class="op" id="3901337">(</span><span class="ident" id="3901338">cert</span><span class="op" id="3901342">)</span><span class="op" id="3901343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3901347">copy</span><span class="op" id="3901351">(</span><span class="ident" id="3901352">x</span><span class="op" id="3901353">[</span><span class="num" id="3901354">4</span><span class="op" id="3901355">:</span><span class="op" id="3901356">]</span><span class="op" id="3901357">,</span>&nbsp;<span class="ident" id="3901359">cert</span><span class="op" id="3901363">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901367">x</span>&nbsp;<span class="op" id="3901369">=</span>&nbsp;<span class="ident" id="3901371">x</span><span class="op" id="3901372">[</span><span class="num" id="3901373">4</span><span class="op" id="3901374">+</span><span class="builtinfunc" id="3901375">len</span><span class="op" id="3901378">(</span><span class="ident" id="3901379">cert</span><span class="op" id="3901383">)</span><span class="op" id="3901384">:</span><span class="op" id="3901385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901392">return</span>&nbsp;<span class="ident" id="3901399">ret</span><br>
<span class="lineno"></span><span class="op" id="3901403">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="3901406">func</span>&nbsp;<span class="op" id="3901411">(</span><span class="ident" id="3901412">s</span>&nbsp;<span class="op" id="3901414">*</span><span class="ident" id="3901415">sessionState</span><span class="op" id="3901427">)</span>&nbsp;<span class="ident" id="3901429">unmarshal</span><span class="op" id="3901438">(</span><span class="ident" id="3901439">data</span>&nbsp;<span class="op" id="3901444">[</span><span class="op" id="3901445">]</span><span class="builtintype" id="3901446">byte</span><span class="op" id="3901450">)</span>&nbsp;<span class="builtintype" id="3901452">bool</span>&nbsp;<span class="op" id="3901457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901460">if</span>&nbsp;<span class="builtinfunc" id="3901463">len</span><span class="op" id="3901466">(</span><span class="ident" id="3901467">data</span><span class="op" id="3901471">)</span>&nbsp;<span class="op" id="3901473">&lt;</span>&nbsp;<span class="num" id="3901475">8</span>&nbsp;<span class="op" id="3901477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901481">return</span>&nbsp;<span class="builtintype" id="3901488">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901495">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901499">s</span><span class="op" id="3901500">.</span><span class="ident" id="3901501">vers</span>&nbsp;<span class="op" id="3901506">=</span>&nbsp;<span class="builtintype" id="3901508">uint16</span><span class="op" id="3901514">(</span><span class="ident" id="3901515">data</span><span class="op" id="3901519">[</span><span class="num" id="3901520">0</span><span class="op" id="3901521">]</span><span class="op" id="3901522">)</span><span class="op" id="3901523">&lt;&lt;</span><span class="num" id="3901525">8</span>&nbsp;<span class="op" id="3901527">|</span>&nbsp;<span class="builtintype" id="3901529">uint16</span><span class="op" id="3901535">(</span><span class="ident" id="3901536">data</span><span class="op" id="3901540">[</span><span class="num" id="3901541">1</span><span class="op" id="3901542">]</span><span class="op" id="3901543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901546">s</span><span class="op" id="3901547">.</span><span class="ident" id="3901548">cipherSuite</span>&nbsp;<span class="op" id="3901560">=</span>&nbsp;<span class="builtintype" id="3901562">uint16</span><span class="op" id="3901568">(</span><span class="ident" id="3901569">data</span><span class="op" id="3901573">[</span><span class="num" id="3901574">2</span><span class="op" id="3901575">]</span><span class="op" id="3901576">)</span><span class="op" id="3901577">&lt;&lt;</span><span class="num" id="3901579">8</span>&nbsp;<span class="op" id="3901581">|</span>&nbsp;<span class="builtintype" id="3901583">uint16</span><span class="op" id="3901589">(</span><span class="ident" id="3901590">data</span><span class="op" id="3901594">[</span><span class="num" id="3901595">3</span><span class="op" id="3901596">]</span><span class="op" id="3901597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901600">masterSecretLen</span>&nbsp;<span class="op" id="3901616">:=</span>&nbsp;<span class="builtintype" id="3901619">int</span><span class="op" id="3901622">(</span><span class="ident" id="3901623">data</span><span class="op" id="3901627">[</span><span class="num" id="3901628">4</span><span class="op" id="3901629">]</span><span class="op" id="3901630">)</span><span class="op" id="3901631">&lt;&lt;</span><span class="num" id="3901633">8</span>&nbsp;<span class="op" id="3901635">|</span>&nbsp;<span class="builtintype" id="3901637">int</span><span class="op" id="3901640">(</span><span class="ident" id="3901641">data</span><span class="op" id="3901645">[</span><span class="num" id="3901646">5</span><span class="op" id="3901647">]</span><span class="op" id="3901648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901651">data</span>&nbsp;<span class="op" id="3901656">=</span>&nbsp;<span class="ident" id="3901658">data</span><span class="op" id="3901662">[</span><span class="num" id="3901663">6</span><span class="op" id="3901664">:</span><span class="op" id="3901665">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901668">if</span>&nbsp;<span class="builtinfunc" id="3901671">len</span><span class="op" id="3901674">(</span><span class="ident" id="3901675">data</span><span class="op" id="3901679">)</span>&nbsp;<span class="op" id="3901681">&lt;</span>&nbsp;<span class="ident" id="3901683">masterSecretLen</span>&nbsp;<span class="op" id="3901699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901703">return</span>&nbsp;<span class="builtintype" id="3901710">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901721">s</span><span class="op" id="3901722">.</span><span class="ident" id="3901723">masterSecret</span>&nbsp;<span class="op" id="3901736">=</span>&nbsp;<span class="ident" id="3901738">data</span><span class="op" id="3901742">[</span><span class="op" id="3901743">:</span><span class="ident" id="3901744">masterSecretLen</span><span class="op" id="3901759">]</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901762">data</span>&nbsp;<span class="op" id="3901767">=</span>&nbsp;<span class="ident" id="3901769">data</span><span class="op" id="3901773">[</span><span class="ident" id="3901774">masterSecretLen</span><span class="op" id="3901789">:</span><span class="op" id="3901790">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901794">if</span>&nbsp;<span class="builtinfunc" id="3901797">len</span><span class="op" id="3901800">(</span><span class="ident" id="3901801">data</span><span class="op" id="3901805">)</span>&nbsp;<span class="op" id="3901807">&lt;</span>&nbsp;<span class="num" id="3901809">2</span>&nbsp;<span class="op" id="3901811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901815">return</span>&nbsp;<span class="builtintype" id="3901822">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901829">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901833">numCerts</span>&nbsp;<span class="op" id="3901842">:=</span>&nbsp;<span class="builtintype" id="3901845">int</span><span class="op" id="3901848">(</span><span class="ident" id="3901849">data</span><span class="op" id="3901853">[</span><span class="num" id="3901854">0</span><span class="op" id="3901855">]</span><span class="op" id="3901856">)</span><span class="op" id="3901857">&lt;&lt;</span><span class="num" id="3901859">8</span>&nbsp;<span class="op" id="3901861">|</span>&nbsp;<span class="builtintype" id="3901863">int</span><span class="op" id="3901866">(</span><span class="ident" id="3901867">data</span><span class="op" id="3901871">[</span><span class="num" id="3901872">1</span><span class="op" id="3901873">]</span><span class="op" id="3901874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901877">data</span>&nbsp;<span class="op" id="3901882">=</span>&nbsp;<span class="ident" id="3901884">data</span><span class="op" id="3901888">[</span><span class="num" id="3901889">2</span><span class="op" id="3901890">:</span><span class="op" id="3901891">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901895">s</span><span class="op" id="3901896">.</span><span class="ident" id="3901897">certificates</span>&nbsp;<span class="op" id="3901910">=</span>&nbsp;<span class="builtinfunc" id="3901912">make</span><span class="op" id="3901916">(</span><span class="op" id="3901917">[</span><span class="op" id="3901918">]</span><span class="op" id="3901919">[</span><span class="op" id="3901920">]</span><span class="builtintype" id="3901921">byte</span><span class="op" id="3901925">,</span>&nbsp;<span class="ident" id="3901927">numCerts</span><span class="op" id="3901935">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901938">for</span>&nbsp;<span class="ident" id="3901942">i</span>&nbsp;<span class="op" id="3901944">:=</span>&nbsp;<span class="keyword" id="3901947">range</span>&nbsp;<span class="ident" id="3901953">s</span><span class="op" id="3901954">.</span><span class="ident" id="3901955">certificates</span>&nbsp;<span class="op" id="3901968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901972">if</span>&nbsp;<span class="builtinfunc" id="3901975">len</span><span class="op" id="3901978">(</span><span class="ident" id="3901979">data</span><span class="op" id="3901983">)</span>&nbsp;<span class="op" id="3901985">&lt;</span>&nbsp;<span class="num" id="3901987">4</span>&nbsp;<span class="op" id="3901989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901994">return</span>&nbsp;<span class="builtintype" id="3902001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902013">certLen</span>&nbsp;<span class="op" id="3902021">:=</span>&nbsp;<span class="builtintype" id="3902024">int</span><span class="op" id="3902027">(</span><span class="ident" id="3902028">data</span><span class="op" id="3902032">[</span><span class="num" id="3902033">0</span><span class="op" id="3902034">]</span><span class="op" id="3902035">)</span><span class="op" id="3902036">&lt;&lt;</span><span class="num" id="3902038">24</span>&nbsp;<span class="op" id="3902041">|</span>&nbsp;<span class="builtintype" id="3902043">int</span><span class="op" id="3902046">(</span><span class="ident" id="3902047">data</span><span class="op" id="3902051">[</span><span class="num" id="3902052">1</span><span class="op" id="3902053">]</span><span class="op" id="3902054">)</span><span class="op" id="3902055">&lt;&lt;</span><span class="num" id="3902057">16</span>&nbsp;<span class="op" id="3902060">|</span>&nbsp;<span class="builtintype" id="3902062">int</span><span class="op" id="3902065">(</span><span class="ident" id="3902066">data</span><span class="op" id="3902070">[</span><span class="num" id="3902071">2</span><span class="op" id="3902072">]</span><span class="op" id="3902073">)</span><span class="op" id="3902074">&lt;&lt;</span><span class="num" id="3902076">8</span>&nbsp;<span class="op" id="3902078">|</span>&nbsp;<span class="builtintype" id="3902080">int</span><span class="op" id="3902083">(</span><span class="ident" id="3902084">data</span><span class="op" id="3902088">[</span><span class="num" id="3902089">3</span><span class="op" id="3902090">]</span><span class="op" id="3902091">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902095">data</span>&nbsp;<span class="op" id="3902100">=</span>&nbsp;<span class="ident" id="3902102">data</span><span class="op" id="3902106">[</span><span class="num" id="3902107">4</span><span class="op" id="3902108">:</span><span class="op" id="3902109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902113">if</span>&nbsp;<span class="ident" id="3902116">certLen</span>&nbsp;<span class="op" id="3902124">&lt;</span>&nbsp;<span class="num" id="3902126">0</span>&nbsp;<span class="op" id="3902128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902133">return</span>&nbsp;<span class="builtintype" id="3902140">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902152">if</span>&nbsp;<span class="builtinfunc" id="3902155">len</span><span class="op" id="3902158">(</span><span class="ident" id="3902159">data</span><span class="op" id="3902163">)</span>&nbsp;<span class="op" id="3902165">&lt;</span>&nbsp;<span class="ident" id="3902167">certLen</span>&nbsp;<span class="op" id="3902175">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902180">return</span>&nbsp;<span class="builtintype" id="3902187">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902199">s</span><span class="op" id="3902200">.</span><span class="ident" id="3902201">certificates</span><span class="op" id="3902213">[</span><span class="ident" id="3902214">i</span><span class="op" id="3902215">]</span>&nbsp;<span class="op" id="3902217">=</span>&nbsp;<span class="ident" id="3902219">data</span><span class="op" id="3902223">[</span><span class="op" id="3902224">:</span><span class="ident" id="3902225">certLen</span><span class="op" id="3902232">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902236">data</span>&nbsp;<span class="op" id="3902241">=</span>&nbsp;<span class="ident" id="3902243">data</span><span class="op" id="3902247">[</span><span class="ident" id="3902248">certLen</span><span class="op" id="3902255">:</span><span class="op" id="3902256">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902259">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902263">if</span>&nbsp;<span class="builtinfunc" id="3902266">len</span><span class="op" id="3902269">(</span><span class="ident" id="3902270">data</span><span class="op" id="3902274">)</span>&nbsp;<span class="op" id="3902276">&gt;</span>&nbsp;<span class="num" id="3902278">0</span>&nbsp;<span class="op" id="3902280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902284">return</span>&nbsp;<span class="builtintype" id="3902291">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902302">return</span>&nbsp;<span class="builtintype" id="3902309">true</span><br>
<span class="lineno"></span><span class="op" id="3902314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3902317">func</span>&nbsp;<span class="op" id="3902322">(</span><span class="ident" id="3902323">c</span>&nbsp;<span class="op" id="3902325">*</span><span class="ident" id="3902326">Conn</span><span class="op" id="3902330">)</span>&nbsp;<span class="ident" id="3902332">encryptTicket</span><span class="op" id="3902345">(</span><span class="ident" id="3902346">state</span>&nbsp;<span class="op" id="3902352">*</span><span class="ident" id="3902353">sessionState</span><span class="op" id="3902365">)</span>&nbsp;<span class="op" id="3902367">(</span><span class="op" id="3902368">[</span><span class="op" id="3902369">]</span><span class="builtintype" id="3902370">byte</span><span class="op" id="3902374">,</span>&nbsp;<span class="builtintype" id="3902376">error</span><span class="op" id="3902381">)</span>&nbsp;<span class="op" id="3902383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902386">serialized</span>&nbsp;<span class="op" id="3902397">:=</span>&nbsp;<span class="ident" id="3902400">state</span><span class="op" id="3902405">.</span><span class="ident" id="3902406">marshal</span><span class="op" id="3902413">(</span><span class="op" id="3902414">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902417">encrypted</span>&nbsp;<span class="op" id="3902427">:=</span>&nbsp;<span class="builtinfunc" id="3902430">make</span><span class="op" id="3902434">(</span><span class="op" id="3902435">[</span><span class="op" id="3902436">]</span><span class="builtintype" id="3902437">byte</span><span class="op" id="3902441">,</span>&nbsp;<span class="ident" id="3902443">aes</span><span class="op" id="3902446">.</span><span class="ident" id="3902447">BlockSize</span><span class="op" id="3902456">+</span><span class="builtinfunc" id="3902457">len</span><span class="op" id="3902460">(</span><span class="ident" id="3902461">serialized</span><span class="op" id="3902471">)</span><span class="op" id="3902472">+</span><span class="ident" id="3902473">sha256</span><span class="op" id="3902479">.</span><span class="ident" id="3902480">Size</span><span class="op" id="3902484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902487">iv</span>&nbsp;<span class="op" id="3902490">:=</span>&nbsp;<span class="ident" id="3902493">encrypted</span><span class="op" id="3902502">[</span><span class="op" id="3902503">:</span><span class="ident" id="3902504">aes</span><span class="op" id="3902507">.</span><span class="ident" id="3902508">BlockSize</span><span class="op" id="3902517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902520">macBytes</span>&nbsp;<span class="op" id="3902529">:=</span>&nbsp;<span class="ident" id="3902532">encrypted</span><span class="op" id="3902541">[</span><span class="builtinfunc" id="3902542">len</span><span class="op" id="3902545">(</span><span class="ident" id="3902546">encrypted</span><span class="op" id="3902555">)</span><span class="op" id="3902556">-</span><span class="ident" id="3902557">sha256</span><span class="op" id="3902563">.</span><span class="ident" id="3902564">Size</span><span class="op" id="3902568">:</span><span class="op" id="3902569">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902573">if</span>&nbsp;<span class="ident" id="3902576">_</span><span class="op" id="3902577">,</span>&nbsp;<span class="ident" id="3902579">err</span>&nbsp;<span class="op" id="3902583">:=</span>&nbsp;<span class="ident" id="3902586">io</span><span class="op" id="3902588">.</span><span class="ident" id="3902589">ReadFull</span><span class="op" id="3902597">(</span><span class="ident" id="3902598">c</span><span class="op" id="3902599">.</span><span class="ident" id="3902600">config</span><span class="op" id="3902606">.</span><span class="ident" id="3902607">rand</span><span class="op" id="3902611">(</span><span class="op" id="3902612">)</span><span class="op" id="3902613">,</span>&nbsp;<span class="ident" id="3902615">iv</span><span class="op" id="3902617">)</span><span class="op" id="3902618">;</span>&nbsp;<span class="ident" id="3902620">err</span>&nbsp;<span class="op" id="3902624">!=</span>&nbsp;<span class="ident" id="3902627">nil</span>&nbsp;<span class="op" id="3902631">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902635">return</span>&nbsp;<span class="ident" id="3902642">nil</span><span class="op" id="3902645">,</span>&nbsp;<span class="ident" id="3902647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902655">block</span><span class="op" id="3902660">,</span>&nbsp;<span class="ident" id="3902662">err</span>&nbsp;<span class="op" id="3902666">:=</span>&nbsp;<span class="ident" id="3902669">aes</span><span class="op" id="3902672">.</span><span class="ident" id="3902673">NewCipher</span><span class="op" id="3902682">(</span><span class="ident" id="3902683">c</span><span class="op" id="3902684">.</span><span class="ident" id="3902685">config</span><span class="op" id="3902691">.</span><span class="ident" id="3902692">SessionTicketKey</span><span class="op" id="3902708">[</span><span class="op" id="3902709">:</span><span class="num" id="3902710">16</span><span class="op" id="3902712">]</span><span class="op" id="3902713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902716">if</span>&nbsp;<span class="ident" id="3902719">err</span>&nbsp;<span class="op" id="3902723">!=</span>&nbsp;<span class="ident" id="3902726">nil</span>&nbsp;<span class="op" id="3902730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902734">return</span>&nbsp;<span class="ident" id="3902741">nil</span><span class="op" id="3902744">,</span>&nbsp;<span class="ident" id="3902746">errors</span><span class="op" id="3902752">.</span><span class="ident" id="3902753">New</span><span class="op" id="3902756">(</span><span class="string" id="3902757">&#34;tls:&nbsp;failed&nbsp;to&nbsp;create&nbsp;cipher&nbsp;while&nbsp;encrypting&nbsp;ticket:&nbsp;&#34;</span>&nbsp;<span class="op" id="3902814">+</span>&nbsp;<span class="ident" id="3902816">err</span><span class="op" id="3902819">.</span><span class="ident" id="3902820">Error</span><span class="op" id="3902825">(</span><span class="op" id="3902826">)</span><span class="op" id="3902827">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902833">cipher</span><span class="op" id="3902839">.</span><span class="ident" id="3902840">NewCTR</span><span class="op" id="3902846">(</span><span class="ident" id="3902847">block</span><span class="op" id="3902852">,</span>&nbsp;<span class="ident" id="3902854">iv</span><span class="op" id="3902856">)</span><span class="op" id="3902857">.</span><span class="ident" id="3902858">XORKeyStream</span><span class="op" id="3902870">(</span><span class="ident" id="3902871">encrypted</span><span class="op" id="3902880">[</span><span class="ident" id="3902881">aes</span><span class="op" id="3902884">.</span><span class="ident" id="3902885">BlockSize</span><span class="op" id="3902894">:</span><span class="op" id="3902895">]</span><span class="op" id="3902896">,</span>&nbsp;<span class="ident" id="3902898">serialized</span><span class="op" id="3902908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902912">mac</span>&nbsp;<span class="op" id="3902916">:=</span>&nbsp;<span class="ident" id="3902919">hmac</span><span class="op" id="3902923">.</span><span class="ident" id="3902924">New</span><span class="op" id="3902927">(</span><span class="ident" id="3902928">sha256</span><span class="op" id="3902934">.</span><span class="ident" id="3902935">New</span><span class="op" id="3902938">,</span>&nbsp;<span class="ident" id="3902940">c</span><span class="op" id="3902941">.</span><span class="ident" id="3902942">config</span><span class="op" id="3902948">.</span><span class="ident" id="3902949">SessionTicketKey</span><span class="op" id="3902965">[</span><span class="num" id="3902966">16</span><span class="op" id="3902968">:</span><span class="num" id="3902969">32</span><span class="op" id="3902971">]</span><span class="op" id="3902972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902975">mac</span><span class="op" id="3902978">.</span><span class="ident" id="3902979">Write</span><span class="op" id="3902984">(</span><span class="ident" id="3902985">encrypted</span><span class="op" id="3902994">[</span><span class="op" id="3902995">:</span><span class="builtinfunc" id="3902996">len</span><span class="op" id="3902999">(</span><span class="ident" id="3903000">encrypted</span><span class="op" id="3903009">)</span><span class="op" id="3903010">-</span><span class="ident" id="3903011">sha256</span><span class="op" id="3903017">.</span><span class="ident" id="3903018">Size</span><span class="op" id="3903022">]</span><span class="op" id="3903023">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903026">mac</span><span class="op" id="3903029">.</span><span class="ident" id="3903030">Sum</span><span class="op" id="3903033">(</span><span class="ident" id="3903034">macBytes</span><span class="op" id="3903042">[</span><span class="op" id="3903043">:</span><span class="num" id="3903044">0</span><span class="op" id="3903045">]</span><span class="op" id="3903046">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903050">return</span>&nbsp;<span class="ident" id="3903057">encrypted</span><span class="op" id="3903066">,</span>&nbsp;<span class="ident" id="3903068">nil</span><br>
<span class="lineno"></span><span class="op" id="3903072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3903075">func</span>&nbsp;<span class="op" id="3903080">(</span><span class="ident" id="3903081">c</span>&nbsp;<span class="op" id="3903083">*</span><span class="ident" id="3903084">Conn</span><span class="op" id="3903088">)</span>&nbsp;<span class="ident" id="3903090">decryptTicket</span><span class="op" id="3903103">(</span><span class="ident" id="3903104">encrypted</span>&nbsp;<span class="op" id="3903114">[</span><span class="op" id="3903115">]</span><span class="builtintype" id="3903116">byte</span><span class="op" id="3903120">)</span>&nbsp;<span class="op" id="3903122">(</span><span class="op" id="3903123">*</span><span class="ident" id="3903124">sessionState</span><span class="op" id="3903136">,</span>&nbsp;<span class="builtintype" id="3903138">bool</span><span class="op" id="3903142">)</span>&nbsp;<span class="op" id="3903144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903147">if</span>&nbsp;<span class="ident" id="3903150">c</span><span class="op" id="3903151">.</span><span class="ident" id="3903152">config</span><span class="op" id="3903158">.</span><span class="ident" id="3903159">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3903182">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3903187">len</span><span class="op" id="3903190">(</span><span class="ident" id="3903191">encrypted</span><span class="op" id="3903200">)</span>&nbsp;<span class="op" id="3903202">&lt;</span>&nbsp;<span class="ident" id="3903204">aes</span><span class="op" id="3903207">.</span><span class="ident" id="3903208">BlockSize</span><span class="op" id="3903217">+</span><span class="ident" id="3903218">sha256</span><span class="op" id="3903224">.</span><span class="ident" id="3903225">Size</span>&nbsp;<span class="op" id="3903230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903234">return</span>&nbsp;<span class="ident" id="3903241">nil</span><span class="op" id="3903244">,</span>&nbsp;<span class="builtintype" id="3903246">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903253">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903257">iv</span>&nbsp;<span class="op" id="3903260">:=</span>&nbsp;<span class="ident" id="3903263">encrypted</span><span class="op" id="3903272">[</span><span class="op" id="3903273">:</span><span class="ident" id="3903274">aes</span><span class="op" id="3903277">.</span><span class="ident" id="3903278">BlockSize</span><span class="op" id="3903287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903290">macBytes</span>&nbsp;<span class="op" id="3903299">:=</span>&nbsp;<span class="ident" id="3903302">encrypted</span><span class="op" id="3903311">[</span><span class="builtinfunc" id="3903312">len</span><span class="op" id="3903315">(</span><span class="ident" id="3903316">encrypted</span><span class="op" id="3903325">)</span><span class="op" id="3903326">-</span><span class="ident" id="3903327">sha256</span><span class="op" id="3903333">.</span><span class="ident" id="3903334">Size</span><span class="op" id="3903338">:</span><span class="op" id="3903339">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903343">mac</span>&nbsp;<span class="op" id="3903347">:=</span>&nbsp;<span class="ident" id="3903350">hmac</span><span class="op" id="3903354">.</span><span class="ident" id="3903355">New</span><span class="op" id="3903358">(</span><span class="ident" id="3903359">sha256</span><span class="op" id="3903365">.</span><span class="ident" id="3903366">New</span><span class="op" id="3903369">,</span>&nbsp;<span class="ident" id="3903371">c</span><span class="op" id="3903372">.</span><span class="ident" id="3903373">config</span><span class="op" id="3903379">.</span><span class="ident" id="3903380">SessionTicketKey</span><span class="op" id="3903396">[</span><span class="num" id="3903397">16</span><span class="op" id="3903399">:</span><span class="num" id="3903400">32</span><span class="op" id="3903402">]</span><span class="op" id="3903403">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903406">mac</span><span class="op" id="3903409">.</span><span class="ident" id="3903410">Write</span><span class="op" id="3903415">(</span><span class="ident" id="3903416">encrypted</span><span class="op" id="3903425">[</span><span class="op" id="3903426">:</span><span class="builtinfunc" id="3903427">len</span><span class="op" id="3903430">(</span><span class="ident" id="3903431">encrypted</span><span class="op" id="3903440">)</span><span class="op" id="3903441">-</span><span class="ident" id="3903442">sha256</span><span class="op" id="3903448">.</span><span class="ident" id="3903449">Size</span><span class="op" id="3903453">]</span><span class="op" id="3903454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903457">expected</span>&nbsp;<span class="op" id="3903466">:=</span>&nbsp;<span class="ident" id="3903469">mac</span><span class="op" id="3903472">.</span><span class="ident" id="3903473">Sum</span><span class="op" id="3903476">(</span><span class="ident" id="3903477">nil</span><span class="op" id="3903480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903484">if</span>&nbsp;<span class="ident" id="3903487">subtle</span><span class="op" id="3903493">.</span><span class="ident" id="3903494">ConstantTimeCompare</span><span class="op" id="3903513">(</span><span class="ident" id="3903514">macBytes</span><span class="op" id="3903522">,</span>&nbsp;<span class="ident" id="3903524">expected</span><span class="op" id="3903532">)</span>&nbsp;<span class="op" id="3903534">!=</span>&nbsp;<span class="num" id="3903537">1</span>&nbsp;<span class="op" id="3903539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903543">return</span>&nbsp;<span class="ident" id="3903550">nil</span><span class="op" id="3903553">,</span>&nbsp;<span class="builtintype" id="3903555">false</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903566">block</span><span class="op" id="3903571">,</span>&nbsp;<span class="ident" id="3903573">err</span>&nbsp;<span class="op" id="3903577">:=</span>&nbsp;<span class="ident" id="3903580">aes</span><span class="op" id="3903583">.</span><span class="ident" id="3903584">NewCipher</span><span class="op" id="3903593">(</span><span class="ident" id="3903594">c</span><span class="op" id="3903595">.</span><span class="ident" id="3903596">config</span><span class="op" id="3903602">.</span><span class="ident" id="3903603">SessionTicketKey</span><span class="op" id="3903619">[</span><span class="op" id="3903620">:</span><span class="num" id="3903621">16</span><span class="op" id="3903623">]</span><span class="op" id="3903624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903627">if</span>&nbsp;<span class="ident" id="3903630">err</span>&nbsp;<span class="op" id="3903634">!=</span>&nbsp;<span class="ident" id="3903637">nil</span>&nbsp;<span class="op" id="3903641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903645">return</span>&nbsp;<span class="ident" id="3903652">nil</span><span class="op" id="3903655">,</span>&nbsp;<span class="builtintype" id="3903657">false</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903667">ciphertext</span>&nbsp;<span class="op" id="3903678">:=</span>&nbsp;<span class="ident" id="3903681">encrypted</span><span class="op" id="3903690">[</span><span class="ident" id="3903691">aes</span><span class="op" id="3903694">.</span><span class="ident" id="3903695">BlockSize</span>&nbsp;<span class="op" id="3903705">:</span>&nbsp;<span class="builtinfunc" id="3903707">len</span><span class="op" id="3903710">(</span><span class="ident" id="3903711">encrypted</span><span class="op" id="3903720">)</span><span class="op" id="3903721">-</span><span class="ident" id="3903722">sha256</span><span class="op" id="3903728">.</span><span class="ident" id="3903729">Size</span><span class="op" id="3903733">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903736">plaintext</span>&nbsp;<span class="op" id="3903746">:=</span>&nbsp;<span class="ident" id="3903749">ciphertext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903761">cipher</span><span class="op" id="3903767">.</span><span class="ident" id="3903768">NewCTR</span><span class="op" id="3903774">(</span><span class="ident" id="3903775">block</span><span class="op" id="3903780">,</span>&nbsp;<span class="ident" id="3903782">iv</span><span class="op" id="3903784">)</span><span class="op" id="3903785">.</span><span class="ident" id="3903786">XORKeyStream</span><span class="op" id="3903798">(</span><span class="ident" id="3903799">plaintext</span><span class="op" id="3903808">,</span>&nbsp;<span class="ident" id="3903810">ciphertext</span><span class="op" id="3903820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903824">state</span>&nbsp;<span class="op" id="3903830">:=</span>&nbsp;<span class="builtinfunc" id="3903833">new</span><span class="op" id="3903836">(</span><span class="ident" id="3903837">sessionState</span><span class="op" id="3903849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903852">ok</span>&nbsp;<span class="op" id="3903855">:=</span>&nbsp;<span class="ident" id="3903858">state</span><span class="op" id="3903863">.</span><span class="ident" id="3903864">unmarshal</span><span class="op" id="3903873">(</span><span class="ident" id="3903874">plaintext</span><span class="op" id="3903883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903886">return</span>&nbsp;<span class="ident" id="3903893">state</span><span class="op" id="3903898">,</span>&nbsp;<span class="ident" id="3903900">ok</span><br>
<span class="lineno"></span><span class="op" id="3903903">}</span>
</div>
</body>
</html>
