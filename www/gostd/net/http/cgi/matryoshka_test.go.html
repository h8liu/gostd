<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6459610">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6459665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6459719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6459770">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="6459833">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="6459897">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6459954">package</span>&nbsp;<span class="ident" id="6459962">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6459967">import</span>&nbsp;<span class="op" id="6459974">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459977">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459986">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6459996">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460003">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460009">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460021">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460042">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460048">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460059">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460070">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6460077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6460080">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="6460150">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="6460214">func</span>&nbsp;<span class="ident" id="6460219">TestHostingOurselves</span><span class="op" id="6460239">(</span><span class="ident" id="6460240">t</span>&nbsp;<span class="op" id="6460242">*</span><span class="ident" id="6460243">testing</span><span class="op" id="6460250">.</span><span class="ident" id="6460251">T</span><span class="op" id="6460252">)</span>&nbsp;<span class="op" id="6460254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6460257">if</span>&nbsp;<span class="ident" id="6460260">runtime</span><span class="op" id="6460267">.</span><span class="ident" id="6460268">GOOS</span>&nbsp;<span class="op" id="6460273">==</span>&nbsp;<span class="string" id="6460276">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6460283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460287">t</span><span class="op" id="6460288">.</span><span class="ident" id="6460289">Skip</span><span class="op" id="6460293">(</span><span class="string" id="6460294">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6460312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6460315">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460319">h</span>&nbsp;<span class="op" id="6460321">:=</span>&nbsp;<span class="op" id="6460324">&amp;</span><span class="ident" id="6460325">Handler</span><span class="op" id="6460332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460336">Path</span><span class="op" id="6460340">:</span>&nbsp;<span class="ident" id="6460342">os</span><span class="op" id="6460344">.</span><span class="ident" id="6460345">Args</span><span class="op" id="6460349">[</span><span class="num" id="6460350">0</span><span class="op" id="6460351">]</span><span class="op" id="6460352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460356">Root</span><span class="op" id="6460360">:</span>&nbsp;<span class="string" id="6460362">&#34;/test.go&#34;</span><span class="op" id="6460372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460376">Args</span><span class="op" id="6460380">:</span>&nbsp;<span class="op" id="6460382">[</span><span class="op" id="6460383">]</span><span class="builtintype" id="6460384">string</span><span class="op" id="6460390">{</span><span class="string" id="6460391">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6460424">}</span><span class="op" id="6460425">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6460428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6460431">expectedMap</span>&nbsp;<span class="op" id="6460443">:=</span>&nbsp;<span class="keyword" id="6460446">map</span><span class="op" id="6460449">[</span><span class="builtintype" id="6460450">string</span><span class="op" id="6460456">]</span><span class="builtintype" id="6460457">string</span><span class="op" id="6460463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460467">&#34;test&#34;</span><span class="op" id="6460473">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460492">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="6460510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460514">&#34;param-a&#34;</span><span class="op" id="6460523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460539">&#34;b&#34;</span><span class="op" id="6460542">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460546">&#34;param-foo&#34;</span><span class="op" id="6460557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460571">&#34;bar&#34;</span><span class="op" id="6460576">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460580">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6460603">:</span>&nbsp;<span class="string" id="6460605">&#34;CGI/1.1&#34;</span><span class="op" id="6460614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460618">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6460633">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460643">&#34;example.com&#34;</span><span class="op" id="6460656">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460660">&#34;env-PATH_INFO&#34;</span><span class="op" id="6460675">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460685">&#34;&#34;</span><span class="op" id="6460687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460691">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6460709">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460716">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6460729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460733">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6460750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460758">&#34;1.2.3.4&#34;</span><span class="op" id="6460767">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460771">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6460788">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460796">&#34;1.2.3.4&#34;</span><span class="op" id="6460805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460809">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6460829">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460834">&#34;GET&#34;</span><span class="op" id="6460839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460843">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6460860">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460868">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="6460890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460894">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6460915">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6460919">os</span><span class="op" id="6460921">.</span><span class="ident" id="6460922">Args</span><span class="op" id="6460926">[</span><span class="num" id="6460927">0</span><span class="op" id="6460928">]</span><span class="op" id="6460929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460933">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6460950">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460958">&#34;/test.go&#34;</span><span class="op" id="6460968">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6460972">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6460989">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6460997">&#34;example.com&#34;</span><span class="op" id="6461010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6461014">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6461031">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6461039">&#34;80&#34;</span><span class="op" id="6461043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6461047">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6461068">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6461072">&#34;go&#34;</span><span class="op" id="6461076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461082">replay</span>&nbsp;<span class="op" id="6461089">:=</span>&nbsp;<span class="ident" id="6461092">runCgiTest</span><span class="op" id="6461102">(</span><span class="ident" id="6461103">t</span><span class="op" id="6461104">,</span>&nbsp;<span class="ident" id="6461106">h</span><span class="op" id="6461107">,</span>&nbsp;<span class="string" id="6461109">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6461167">,</span>&nbsp;<span class="ident" id="6461169">expectedMap</span><span class="op" id="6461180">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461184">if</span>&nbsp;<span class="ident" id="6461187">expected</span><span class="op" id="6461195">,</span>&nbsp;<span class="ident" id="6461197">got</span>&nbsp;<span class="op" id="6461201">:=</span>&nbsp;<span class="string" id="6461204">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6461230">,</span>&nbsp;<span class="ident" id="6461232">replay</span><span class="op" id="6461238">.</span><span class="ident" id="6461239">Header</span><span class="op" id="6461245">(</span><span class="op" id="6461246">)</span><span class="op" id="6461247">.</span><span class="ident" id="6461248">Get</span><span class="op" id="6461251">(</span><span class="string" id="6461252">&#34;Content-Type&#34;</span><span class="op" id="6461266">)</span><span class="op" id="6461267">;</span>&nbsp;<span class="ident" id="6461269">got</span>&nbsp;<span class="op" id="6461273">!=</span>&nbsp;<span class="ident" id="6461276">expected</span>&nbsp;<span class="op" id="6461285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461289">t</span><span class="op" id="6461290">.</span><span class="ident" id="6461291">Errorf</span><span class="op" id="6461297">(</span><span class="string" id="6461298">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6461337">,</span>&nbsp;<span class="ident" id="6461339">got</span><span class="op" id="6461342">,</span>&nbsp;<span class="ident" id="6461344">expected</span><span class="op" id="6461352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461358">if</span>&nbsp;<span class="ident" id="6461361">expected</span><span class="op" id="6461369">,</span>&nbsp;<span class="ident" id="6461371">got</span>&nbsp;<span class="op" id="6461375">:=</span>&nbsp;<span class="string" id="6461378">&#34;X-Test-Value&#34;</span><span class="op" id="6461392">,</span>&nbsp;<span class="ident" id="6461394">replay</span><span class="op" id="6461400">.</span><span class="ident" id="6461401">Header</span><span class="op" id="6461407">(</span><span class="op" id="6461408">)</span><span class="op" id="6461409">.</span><span class="ident" id="6461410">Get</span><span class="op" id="6461413">(</span><span class="string" id="6461414">&#34;X-Test-Header&#34;</span><span class="op" id="6461429">)</span><span class="op" id="6461430">;</span>&nbsp;<span class="ident" id="6461432">got</span>&nbsp;<span class="op" id="6461436">!=</span>&nbsp;<span class="ident" id="6461439">expected</span>&nbsp;<span class="op" id="6461448">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461452">t</span><span class="op" id="6461453">.</span><span class="ident" id="6461454">Errorf</span><span class="op" id="6461460">(</span><span class="string" id="6461461">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6461501">,</span>&nbsp;<span class="ident" id="6461503">got</span><span class="op" id="6461506">,</span>&nbsp;<span class="ident" id="6461508">expected</span><span class="op" id="6461516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461519">}</span><br>
<span class="lineno"></span><span class="op" id="6461521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6461524">type</span>&nbsp;<span class="ident" id="6461529">customWriterRecorder</span>&nbsp;<span class="keyword" id="6461550">struct</span>&nbsp;<span class="op" id="6461557">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461560">w</span>&nbsp;<span class="ident" id="6461562">io</span><span class="op" id="6461564">.</span><span class="ident" id="6461565">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461573">*</span><span class="ident" id="6461574">httptest</span><span class="op" id="6461582">.</span><span class="ident" id="6461583">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="6461600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6461603">func</span>&nbsp;<span class="op" id="6461608">(</span><span class="ident" id="6461609">r</span>&nbsp;<span class="op" id="6461611">*</span><span class="ident" id="6461612">customWriterRecorder</span><span class="op" id="6461632">)</span>&nbsp;<span class="ident" id="6461634">Write</span><span class="op" id="6461639">(</span><span class="ident" id="6461640">p</span>&nbsp;<span class="op" id="6461642">[</span><span class="op" id="6461643">]</span><span class="builtintype" id="6461644">byte</span><span class="op" id="6461648">)</span>&nbsp;<span class="op" id="6461650">(</span><span class="ident" id="6461651">n</span>&nbsp;<span class="builtintype" id="6461653">int</span><span class="op" id="6461656">,</span>&nbsp;<span class="ident" id="6461658">err</span>&nbsp;<span class="builtintype" id="6461662">error</span><span class="op" id="6461667">)</span>&nbsp;<span class="op" id="6461669">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461672">return</span>&nbsp;<span class="ident" id="6461679">r</span><span class="op" id="6461680">.</span><span class="ident" id="6461681">w</span><span class="op" id="6461682">.</span><span class="ident" id="6461683">Write</span><span class="op" id="6461688">(</span><span class="ident" id="6461689">p</span><span class="op" id="6461690">)</span><br>
<span class="lineno"></span><span class="op" id="6461692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6461695">type</span>&nbsp;<span class="ident" id="6461700">limitWriter</span>&nbsp;<span class="keyword" id="6461712">struct</span>&nbsp;<span class="op" id="6461719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461722">w</span>&nbsp;<span class="ident" id="6461724">io</span><span class="op" id="6461726">.</span><span class="ident" id="6461727">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461735">n</span>&nbsp;<span class="builtintype" id="6461737">int</span><br>
<span class="lineno"></span><span class="op" id="6461741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6461744">func</span>&nbsp;<span class="op" id="6461749">(</span><span class="ident" id="6461750">w</span>&nbsp;<span class="op" id="6461752">*</span><span class="ident" id="6461753">limitWriter</span><span class="op" id="6461764">)</span>&nbsp;<span class="ident" id="6461766">Write</span><span class="op" id="6461771">(</span><span class="ident" id="6461772">p</span>&nbsp;<span class="op" id="6461774">[</span><span class="op" id="6461775">]</span><span class="builtintype" id="6461776">byte</span><span class="op" id="6461780">)</span>&nbsp;<span class="op" id="6461782">(</span><span class="ident" id="6461783">n</span>&nbsp;<span class="builtintype" id="6461785">int</span><span class="op" id="6461788">,</span>&nbsp;<span class="ident" id="6461790">err</span>&nbsp;<span class="builtintype" id="6461794">error</span><span class="op" id="6461799">)</span>&nbsp;<span class="op" id="6461801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461804">if</span>&nbsp;<span class="builtinfunc" id="6461807">len</span><span class="op" id="6461810">(</span><span class="ident" id="6461811">p</span><span class="op" id="6461812">)</span>&nbsp;<span class="op" id="6461814">&gt;</span>&nbsp;<span class="ident" id="6461816">w</span><span class="op" id="6461817">.</span><span class="ident" id="6461818">n</span>&nbsp;<span class="op" id="6461820">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461824">p</span>&nbsp;<span class="op" id="6461826">=</span>&nbsp;<span class="ident" id="6461828">p</span><span class="op" id="6461829">[</span><span class="op" id="6461830">:</span><span class="ident" id="6461831">w</span><span class="op" id="6461832">.</span><span class="ident" id="6461833">n</span><span class="op" id="6461834">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461840">if</span>&nbsp;<span class="builtinfunc" id="6461843">len</span><span class="op" id="6461846">(</span><span class="ident" id="6461847">p</span><span class="op" id="6461848">)</span>&nbsp;<span class="op" id="6461850">&gt;</span>&nbsp;<span class="num" id="6461852">0</span>&nbsp;<span class="op" id="6461854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461858">n</span><span class="op" id="6461859">,</span>&nbsp;<span class="ident" id="6461861">err</span>&nbsp;<span class="op" id="6461865">=</span>&nbsp;<span class="ident" id="6461867">w</span><span class="op" id="6461868">.</span><span class="ident" id="6461869">w</span><span class="op" id="6461870">.</span><span class="ident" id="6461871">Write</span><span class="op" id="6461876">(</span><span class="ident" id="6461877">p</span><span class="op" id="6461878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461882">w</span><span class="op" id="6461883">.</span><span class="ident" id="6461884">n</span>&nbsp;<span class="op" id="6461886">-=</span>&nbsp;<span class="ident" id="6461889">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461895">if</span>&nbsp;<span class="ident" id="6461898">w</span><span class="op" id="6461899">.</span><span class="ident" id="6461900">n</span>&nbsp;<span class="op" id="6461902">==</span>&nbsp;<span class="num" id="6461905">0</span>&nbsp;<span class="op" id="6461907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6461911">err</span>&nbsp;<span class="op" id="6461915">=</span>&nbsp;<span class="ident" id="6461917">errors</span><span class="op" id="6461923">.</span><span class="ident" id="6461924">New</span><span class="op" id="6461927">(</span><span class="string" id="6461928">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="6461946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6461949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6461952">return</span><br>
<span class="lineno">90</span><span class="op" id="6461959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6461962">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="6462032">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="6462059">func</span>&nbsp;<span class="ident" id="6462064">TestKillChildAfterCopyError</span><span class="op" id="6462091">(</span><span class="ident" id="6462092">t</span>&nbsp;<span class="op" id="6462094">*</span><span class="ident" id="6462095">testing</span><span class="op" id="6462102">.</span><span class="ident" id="6462103">T</span><span class="op" id="6462104">)</span>&nbsp;<span class="op" id="6462106">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462109">if</span>&nbsp;<span class="ident" id="6462112">runtime</span><span class="op" id="6462119">.</span><span class="ident" id="6462120">GOOS</span>&nbsp;<span class="op" id="6462125">==</span>&nbsp;<span class="string" id="6462128">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6462135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462139">t</span><span class="op" id="6462140">.</span><span class="ident" id="6462141">Skip</span><span class="op" id="6462145">(</span><span class="string" id="6462146">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6462164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6462167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462171">defer</span>&nbsp;<span class="keyword" id="6462177">func</span><span class="op" id="6462181">(</span><span class="op" id="6462182">)</span>&nbsp;<span class="op" id="6462184">{</span>&nbsp;<span class="ident" id="6462186">testHookStartProcess</span>&nbsp;<span class="op" id="6462207">=</span>&nbsp;<span class="ident" id="6462209">nil</span>&nbsp;<span class="op" id="6462213">}</span><span class="op" id="6462214">(</span><span class="op" id="6462215">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462218">proc</span>&nbsp;<span class="op" id="6462223">:=</span>&nbsp;<span class="builtinfunc" id="6462226">make</span><span class="op" id="6462230">(</span><span class="keyword" id="6462231">chan</span>&nbsp;<span class="op" id="6462236">*</span><span class="ident" id="6462237">os</span><span class="op" id="6462239">.</span><span class="ident" id="6462240">Process</span><span class="op" id="6462247">,</span>&nbsp;<span class="num" id="6462249">1</span><span class="op" id="6462250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462253">testHookStartProcess</span>&nbsp;<span class="op" id="6462274">=</span>&nbsp;<span class="keyword" id="6462276">func</span><span class="op" id="6462280">(</span><span class="ident" id="6462281">p</span>&nbsp;<span class="op" id="6462283">*</span><span class="ident" id="6462284">os</span><span class="op" id="6462286">.</span><span class="ident" id="6462287">Process</span><span class="op" id="6462294">)</span>&nbsp;<span class="op" id="6462296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462300">proc</span>&nbsp;<span class="op" id="6462305">&lt;-</span>&nbsp;<span class="ident" id="6462308">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6462311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462315">h</span>&nbsp;<span class="op" id="6462317">:=</span>&nbsp;<span class="op" id="6462320">&amp;</span><span class="ident" id="6462321">Handler</span><span class="op" id="6462328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462332">Path</span><span class="op" id="6462336">:</span>&nbsp;<span class="ident" id="6462338">os</span><span class="op" id="6462340">.</span><span class="ident" id="6462341">Args</span><span class="op" id="6462345">[</span><span class="num" id="6462346">0</span><span class="op" id="6462347">]</span><span class="op" id="6462348">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462352">Root</span><span class="op" id="6462356">:</span>&nbsp;<span class="string" id="6462358">&#34;/test.go&#34;</span><span class="op" id="6462368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462372">Args</span><span class="op" id="6462376">:</span>&nbsp;<span class="op" id="6462378">[</span><span class="op" id="6462379">]</span><span class="builtintype" id="6462380">string</span><span class="op" id="6462386">{</span><span class="string" id="6462387">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6462420">}</span><span class="op" id="6462421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6462424">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462427">req</span><span class="op" id="6462430">,</span>&nbsp;<span class="ident" id="6462432">_</span>&nbsp;<span class="op" id="6462434">:=</span>&nbsp;<span class="ident" id="6462437">http</span><span class="op" id="6462441">.</span><span class="ident" id="6462442">NewRequest</span><span class="op" id="6462452">(</span><span class="string" id="6462453">&#34;GET&#34;</span><span class="op" id="6462458">,</span>&nbsp;<span class="string" id="6462460">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="6462505">,</span>&nbsp;<span class="ident" id="6462507">nil</span><span class="op" id="6462510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462513">rec</span>&nbsp;<span class="op" id="6462517">:=</span>&nbsp;<span class="ident" id="6462520">httptest</span><span class="op" id="6462528">.</span><span class="ident" id="6462529">NewRecorder</span><span class="op" id="6462540">(</span><span class="op" id="6462541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462544">var</span>&nbsp;<span class="ident" id="6462548">out</span>&nbsp;<span class="ident" id="6462552">bytes</span><span class="op" id="6462557">.</span><span class="ident" id="6462558">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462566">const</span>&nbsp;<span class="ident" id="6462572">writeLen</span>&nbsp;<span class="op" id="6462581">=</span>&nbsp;<span class="num" id="6462583">50</span>&nbsp;<span class="op" id="6462586">&lt;&lt;</span>&nbsp;<span class="num" id="6462589">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462593">rw</span>&nbsp;<span class="op" id="6462596">:=</span>&nbsp;<span class="op" id="6462599">&amp;</span><span class="ident" id="6462600">customWriterRecorder</span><span class="op" id="6462620">{</span><span class="op" id="6462621">&amp;</span><span class="ident" id="6462622">limitWriter</span><span class="op" id="6462633">{</span><span class="op" id="6462634">&amp;</span><span class="ident" id="6462635">out</span><span class="op" id="6462638">,</span>&nbsp;<span class="ident" id="6462640">writeLen</span><span class="op" id="6462648">}</span><span class="op" id="6462649">,</span>&nbsp;<span class="ident" id="6462651">rec</span><span class="op" id="6462654">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462658">donec</span>&nbsp;<span class="op" id="6462664">:=</span>&nbsp;<span class="builtinfunc" id="6462667">make</span><span class="op" id="6462671">(</span><span class="keyword" id="6462672">chan</span>&nbsp;<span class="builtintype" id="6462677">bool</span><span class="op" id="6462681">,</span>&nbsp;<span class="num" id="6462683">1</span><span class="op" id="6462684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462687">go</span>&nbsp;<span class="keyword" id="6462690">func</span><span class="op" id="6462694">(</span><span class="op" id="6462695">)</span>&nbsp;<span class="op" id="6462697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462701">h</span><span class="op" id="6462702">.</span><span class="ident" id="6462703">ServeHTTP</span><span class="op" id="6462712">(</span><span class="ident" id="6462713">rw</span><span class="op" id="6462715">,</span>&nbsp;<span class="ident" id="6462717">req</span><span class="op" id="6462720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462724">donec</span>&nbsp;<span class="op" id="6462730">&lt;-</span>&nbsp;<span class="builtintype" id="6462733">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6462739">}</span><span class="op" id="6462740">(</span><span class="op" id="6462741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462745">select</span>&nbsp;<span class="op" id="6462752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462755">case</span>&nbsp;<span class="op" id="6462760">&lt;-</span><span class="ident" id="6462762">donec</span><span class="op" id="6462767">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462771">if</span>&nbsp;<span class="ident" id="6462774">out</span><span class="op" id="6462777">.</span><span class="ident" id="6462778">Len</span><span class="op" id="6462781">(</span><span class="op" id="6462782">)</span>&nbsp;<span class="op" id="6462784">!=</span>&nbsp;<span class="ident" id="6462787">writeLen</span>&nbsp;<span class="op" id="6462796">||</span>&nbsp;<span class="ident" id="6462799">out</span><span class="op" id="6462802">.</span><span class="ident" id="6462803">Bytes</span><span class="op" id="6462808">(</span><span class="op" id="6462809">)</span><span class="op" id="6462810">[</span><span class="num" id="6462811">0</span><span class="op" id="6462812">]</span>&nbsp;<span class="op" id="6462814">!=</span>&nbsp;<span class="string" id="6462817">&#39;a&#39;</span>&nbsp;<span class="op" id="6462821">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462826">t</span><span class="op" id="6462827">.</span><span class="ident" id="6462828">Errorf</span><span class="op" id="6462834">(</span><span class="string" id="6462835">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="6462858">,</span>&nbsp;<span class="ident" id="6462860">out</span><span class="op" id="6462863">.</span><span class="ident" id="6462864">Bytes</span><span class="op" id="6462869">(</span><span class="op" id="6462870">)</span><span class="op" id="6462871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6462875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462878">case</span>&nbsp;<span class="op" id="6462883">&lt;-</span><span class="ident" id="6462885">time</span><span class="op" id="6462889">.</span><span class="ident" id="6462890">After</span><span class="op" id="6462895">(</span><span class="num" id="6462896">5</span>&nbsp;<span class="op" id="6462898">*</span>&nbsp;<span class="ident" id="6462900">time</span><span class="op" id="6462904">.</span><span class="ident" id="6462905">Second</span><span class="op" id="6462911">)</span><span class="op" id="6462912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6462916">t</span><span class="op" id="6462917">.</span><span class="ident" id="6462918">Errorf</span><span class="op" id="6462924">(</span><span class="string" id="6462925">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="6462985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6462989">select</span>&nbsp;<span class="op" id="6462996">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6463000">case</span>&nbsp;<span class="ident" id="6463005">p</span>&nbsp;<span class="op" id="6463007">:=</span>&nbsp;<span class="op" id="6463010">&lt;-</span><span class="ident" id="6463012">proc</span><span class="op" id="6463016">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463021">p</span><span class="op" id="6463022">.</span><span class="ident" id="6463023">Kill</span><span class="op" id="6463027">(</span><span class="op" id="6463028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463033">t</span><span class="op" id="6463034">.</span><span class="ident" id="6463035">Logf</span><span class="op" id="6463039">(</span><span class="string" id="6463040">&#34;killed&nbsp;process&#34;</span><span class="op" id="6463056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6463060">default</span><span class="op" id="6463067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463072">t</span><span class="op" id="6463073">.</span><span class="ident" id="6463074">Logf</span><span class="op" id="6463078">(</span><span class="string" id="6463079">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="6463100">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463107">}</span><br>
<span class="lineno"></span><span class="op" id="6463109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6463112">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="6463169">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="6463194">func</span>&nbsp;<span class="ident" id="6463199">TestChildOnlyHeaders</span><span class="op" id="6463219">(</span><span class="ident" id="6463220">t</span>&nbsp;<span class="op" id="6463222">*</span><span class="ident" id="6463223">testing</span><span class="op" id="6463230">.</span><span class="ident" id="6463231">T</span><span class="op" id="6463232">)</span>&nbsp;<span class="op" id="6463234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6463237">if</span>&nbsp;<span class="ident" id="6463240">runtime</span><span class="op" id="6463247">.</span><span class="ident" id="6463248">GOOS</span>&nbsp;<span class="op" id="6463253">==</span>&nbsp;<span class="string" id="6463256">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6463263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463267">t</span><span class="op" id="6463268">.</span><span class="ident" id="6463269">Skip</span><span class="op" id="6463273">(</span><span class="string" id="6463274">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6463292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463295">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463299">h</span>&nbsp;<span class="op" id="6463301">:=</span>&nbsp;<span class="op" id="6463304">&amp;</span><span class="ident" id="6463305">Handler</span><span class="op" id="6463312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463316">Path</span><span class="op" id="6463320">:</span>&nbsp;<span class="ident" id="6463322">os</span><span class="op" id="6463324">.</span><span class="ident" id="6463325">Args</span><span class="op" id="6463329">[</span><span class="num" id="6463330">0</span><span class="op" id="6463331">]</span><span class="op" id="6463332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463336">Root</span><span class="op" id="6463340">:</span>&nbsp;<span class="string" id="6463342">&#34;/test.go&#34;</span><span class="op" id="6463352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463356">Args</span><span class="op" id="6463360">:</span>&nbsp;<span class="op" id="6463362">[</span><span class="op" id="6463363">]</span><span class="builtintype" id="6463364">string</span><span class="op" id="6463370">{</span><span class="string" id="6463371">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6463404">}</span><span class="op" id="6463405">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463411">expectedMap</span>&nbsp;<span class="op" id="6463423">:=</span>&nbsp;<span class="keyword" id="6463426">map</span><span class="op" id="6463429">[</span><span class="builtintype" id="6463430">string</span><span class="op" id="6463436">]</span><span class="builtintype" id="6463437">string</span><span class="op" id="6463443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6463447">&#34;_body&#34;</span><span class="op" id="6463454">:</span>&nbsp;<span class="string" id="6463456">&#34;&#34;</span><span class="op" id="6463458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463464">replay</span>&nbsp;<span class="op" id="6463471">:=</span>&nbsp;<span class="ident" id="6463474">runCgiTest</span><span class="op" id="6463484">(</span><span class="ident" id="6463485">t</span><span class="op" id="6463486">,</span>&nbsp;<span class="ident" id="6463488">h</span><span class="op" id="6463489">,</span>&nbsp;<span class="string" id="6463491">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6463547">,</span>&nbsp;<span class="ident" id="6463549">expectedMap</span><span class="op" id="6463560">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6463563">if</span>&nbsp;<span class="ident" id="6463566">expected</span><span class="op" id="6463574">,</span>&nbsp;<span class="ident" id="6463576">got</span>&nbsp;<span class="op" id="6463580">:=</span>&nbsp;<span class="string" id="6463583">&#34;X-Test-Value&#34;</span><span class="op" id="6463597">,</span>&nbsp;<span class="ident" id="6463599">replay</span><span class="op" id="6463605">.</span><span class="ident" id="6463606">Header</span><span class="op" id="6463612">(</span><span class="op" id="6463613">)</span><span class="op" id="6463614">.</span><span class="ident" id="6463615">Get</span><span class="op" id="6463618">(</span><span class="string" id="6463619">&#34;X-Test-Header&#34;</span><span class="op" id="6463634">)</span><span class="op" id="6463635">;</span>&nbsp;<span class="ident" id="6463637">got</span>&nbsp;<span class="op" id="6463641">!=</span>&nbsp;<span class="ident" id="6463644">expected</span>&nbsp;<span class="op" id="6463653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6463657">t</span><span class="op" id="6463658">.</span><span class="ident" id="6463659">Errorf</span><span class="op" id="6463665">(</span><span class="string" id="6463666">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6463706">,</span>&nbsp;<span class="ident" id="6463708">got</span><span class="op" id="6463711">,</span>&nbsp;<span class="ident" id="6463713">expected</span><span class="op" id="6463721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6463724">}</span><br>
<span class="lineno"></span><span class="op" id="6463726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="6463729">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="6463754">func</span>&nbsp;<span class="ident" id="6463759">Test500WithNoHeaders</span><span class="op" id="6463779">(</span><span class="ident" id="6463780">t</span>&nbsp;<span class="op" id="6463782">*</span><span class="ident" id="6463783">testing</span><span class="op" id="6463790">.</span><span class="ident" id="6463791">T</span><span class="op" id="6463792">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6463798">{</span>&nbsp;<span class="ident" id="6463800">want500Test</span><span class="op" id="6463811">(</span><span class="ident" id="6463812">t</span><span class="op" id="6463813">,</span>&nbsp;<span class="string" id="6463815">&#34;/immediate-disconnect&#34;</span><span class="op" id="6463838">)</span>&nbsp;<span class="op" id="6463840">}</span><br>
<span class="lineno"></span><span class="keyword" id="6463842">func</span>&nbsp;<span class="ident" id="6463847">Test500WithNoContentType</span><span class="op" id="6463871">(</span><span class="ident" id="6463872">t</span>&nbsp;<span class="op" id="6463874">*</span><span class="ident" id="6463875">testing</span><span class="op" id="6463882">.</span><span class="ident" id="6463883">T</span><span class="op" id="6463884">)</span>&nbsp;<span class="op" id="6463886">{</span>&nbsp;<span class="ident" id="6463888">want500Test</span><span class="op" id="6463899">(</span><span class="ident" id="6463900">t</span><span class="op" id="6463901">,</span>&nbsp;<span class="string" id="6463903">&#34;/no-content-type&#34;</span><span class="op" id="6463921">)</span>&nbsp;<span class="op" id="6463923">}</span><br>
<span class="lineno"></span><span class="keyword" id="6463925">func</span>&nbsp;<span class="ident" id="6463930">Test500WithEmptyHeaders</span><span class="op" id="6463953">(</span><span class="ident" id="6463954">t</span>&nbsp;<span class="op" id="6463956">*</span><span class="ident" id="6463957">testing</span><span class="op" id="6463964">.</span><span class="ident" id="6463965">T</span><span class="op" id="6463966">)</span>&nbsp;&nbsp;<span class="op" id="6463969">{</span>&nbsp;<span class="ident" id="6463971">want500Test</span><span class="op" id="6463982">(</span><span class="ident" id="6463983">t</span><span class="op" id="6463984">,</span>&nbsp;<span class="string" id="6463986">&#34;/empty-headers&#34;</span><span class="op" id="6464002">)</span>&nbsp;<span class="op" id="6464004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6464007">func</span>&nbsp;<span class="ident" id="6464012">want500Test</span><span class="op" id="6464023">(</span><span class="ident" id="6464024">t</span>&nbsp;<span class="op" id="6464026">*</span><span class="ident" id="6464027">testing</span><span class="op" id="6464034">.</span><span class="ident" id="6464035">T</span><span class="op" id="6464036">,</span>&nbsp;<span class="ident" id="6464038">path</span>&nbsp;<span class="builtintype" id="6464043">string</span><span class="op" id="6464049">)</span>&nbsp;<span class="op" id="6464051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464054">h</span>&nbsp;<span class="op" id="6464056">:=</span>&nbsp;<span class="op" id="6464059">&amp;</span><span class="ident" id="6464060">Handler</span><span class="op" id="6464067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464071">Path</span><span class="op" id="6464075">:</span>&nbsp;<span class="ident" id="6464077">os</span><span class="op" id="6464079">.</span><span class="ident" id="6464080">Args</span><span class="op" id="6464084">[</span><span class="num" id="6464085">0</span><span class="op" id="6464086">]</span><span class="op" id="6464087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464091">Root</span><span class="op" id="6464095">:</span>&nbsp;<span class="string" id="6464097">&#34;/test.go&#34;</span><span class="op" id="6464107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464111">Args</span><span class="op" id="6464115">:</span>&nbsp;<span class="op" id="6464117">[</span><span class="op" id="6464118">]</span><span class="builtintype" id="6464119">string</span><span class="op" id="6464125">{</span><span class="string" id="6464126">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6464159">}</span><span class="op" id="6464160">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464166">expectedMap</span>&nbsp;<span class="op" id="6464178">:=</span>&nbsp;<span class="keyword" id="6464181">map</span><span class="op" id="6464184">[</span><span class="builtintype" id="6464185">string</span><span class="op" id="6464191">]</span><span class="builtintype" id="6464192">string</span><span class="op" id="6464198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6464202">&#34;_body&#34;</span><span class="op" id="6464209">:</span>&nbsp;<span class="string" id="6464211">&#34;&#34;</span><span class="op" id="6464213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464219">replay</span>&nbsp;<span class="op" id="6464226">:=</span>&nbsp;<span class="ident" id="6464229">runCgiTest</span><span class="op" id="6464239">(</span><span class="ident" id="6464240">t</span><span class="op" id="6464241">,</span>&nbsp;<span class="ident" id="6464243">h</span><span class="op" id="6464244">,</span>&nbsp;<span class="string" id="6464246">&#34;GET&nbsp;&#34;</span><span class="op" id="6464252">+</span><span class="ident" id="6464253">path</span><span class="op" id="6464257">+</span><span class="string" id="6464258">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6464292">,</span>&nbsp;<span class="ident" id="6464294">expectedMap</span><span class="op" id="6464305">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464308">if</span>&nbsp;<span class="ident" id="6464311">replay</span><span class="op" id="6464317">.</span><span class="ident" id="6464318">Code</span>&nbsp;<span class="op" id="6464323">!=</span>&nbsp;<span class="num" id="6464326">500</span>&nbsp;<span class="op" id="6464330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464334">t</span><span class="op" id="6464335">.</span><span class="ident" id="6464336">Errorf</span><span class="op" id="6464342">(</span><span class="string" id="6464343">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="6464366">,</span>&nbsp;<span class="ident" id="6464368">replay</span><span class="op" id="6464374">.</span><span class="ident" id="6464375">Code</span><span class="op" id="6464379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464382">}</span><br>
<span class="lineno"></span><span class="op" id="6464384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6464387">type</span>&nbsp;<span class="ident" id="6464392">neverEnding</span>&nbsp;<span class="builtintype" id="6464404">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6464410">func</span>&nbsp;<span class="op" id="6464415">(</span><span class="ident" id="6464416">b</span>&nbsp;<span class="ident" id="6464418">neverEnding</span><span class="op" id="6464429">)</span>&nbsp;<span class="ident" id="6464431">Read</span><span class="op" id="6464435">(</span><span class="ident" id="6464436">p</span>&nbsp;<span class="op" id="6464438">[</span><span class="op" id="6464439">]</span><span class="builtintype" id="6464440">byte</span><span class="op" id="6464444">)</span>&nbsp;<span class="op" id="6464446">(</span><span class="ident" id="6464447">n</span>&nbsp;<span class="builtintype" id="6464449">int</span><span class="op" id="6464452">,</span>&nbsp;<span class="ident" id="6464454">err</span>&nbsp;<span class="builtintype" id="6464458">error</span><span class="op" id="6464463">)</span>&nbsp;<span class="op" id="6464465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464468">for</span>&nbsp;<span class="ident" id="6464472">i</span>&nbsp;<span class="op" id="6464474">:=</span>&nbsp;<span class="keyword" id="6464477">range</span>&nbsp;<span class="ident" id="6464483">p</span>&nbsp;<span class="op" id="6464485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464489">p</span><span class="op" id="6464490">[</span><span class="ident" id="6464491">i</span><span class="op" id="6464492">]</span>&nbsp;<span class="op" id="6464494">=</span>&nbsp;<span class="builtintype" id="6464496">byte</span><span class="op" id="6464500">(</span><span class="ident" id="6464501">b</span><span class="op" id="6464502">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464508">return</span>&nbsp;<span class="builtinfunc" id="6464515">len</span><span class="op" id="6464518">(</span><span class="ident" id="6464519">p</span><span class="op" id="6464520">)</span><span class="op" id="6464521">,</span>&nbsp;<span class="ident" id="6464523">nil</span><br>
<span class="lineno"></span><span class="op" id="6464527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6464530">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="6464560">func</span>&nbsp;<span class="ident" id="6464565">TestBeChildCGIProcess</span><span class="op" id="6464586">(</span><span class="ident" id="6464587">t</span>&nbsp;<span class="op" id="6464589">*</span><span class="ident" id="6464590">testing</span><span class="op" id="6464597">.</span><span class="ident" id="6464598">T</span><span class="op" id="6464599">)</span>&nbsp;<span class="op" id="6464601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464604">if</span>&nbsp;<span class="ident" id="6464607">os</span><span class="op" id="6464609">.</span><span class="ident" id="6464610">Getenv</span><span class="op" id="6464616">(</span><span class="string" id="6464617">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6464633">)</span>&nbsp;<span class="op" id="6464635">==</span>&nbsp;<span class="string" id="6464638">&#34;&#34;</span>&nbsp;<span class="op" id="6464641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6464645">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464691">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464699">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464702">switch</span>&nbsp;<span class="ident" id="6464709">os</span><span class="op" id="6464711">.</span><span class="ident" id="6464712">Getenv</span><span class="op" id="6464718">(</span><span class="string" id="6464719">&#34;REQUEST_URI&#34;</span><span class="op" id="6464732">)</span>&nbsp;<span class="op" id="6464734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464737">case</span>&nbsp;<span class="string" id="6464742">&#34;/immediate-disconnect&#34;</span><span class="op" id="6464765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464769">os</span><span class="op" id="6464771">.</span><span class="ident" id="6464772">Exit</span><span class="op" id="6464776">(</span><span class="num" id="6464777">0</span><span class="op" id="6464778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464781">case</span>&nbsp;<span class="string" id="6464786">&#34;/no-content-type&#34;</span><span class="op" id="6464804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464808">fmt</span><span class="op" id="6464811">.</span><span class="ident" id="6464812">Printf</span><span class="op" id="6464818">(</span><span class="string" id="6464819">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="6464849">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464853">os</span><span class="op" id="6464855">.</span><span class="ident" id="6464856">Exit</span><span class="op" id="6464860">(</span><span class="num" id="6464861">0</span><span class="op" id="6464862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6464865">case</span>&nbsp;<span class="string" id="6464870">&#34;/empty-headers&#34;</span><span class="op" id="6464886">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464890">fmt</span><span class="op" id="6464893">.</span><span class="ident" id="6464894">Printf</span><span class="op" id="6464900">(</span><span class="string" id="6464901">&#34;\nHello&#34;</span><span class="op" id="6464910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464914">os</span><span class="op" id="6464916">.</span><span class="ident" id="6464917">Exit</span><span class="op" id="6464921">(</span><span class="num" id="6464922">0</span><span class="op" id="6464923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6464926">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6464929">Serve</span><span class="op" id="6464934">(</span><span class="ident" id="6464935">http</span><span class="op" id="6464939">.</span><span class="ident" id="6464940">HandlerFunc</span><span class="op" id="6464951">(</span><span class="keyword" id="6464952">func</span><span class="op" id="6464956">(</span><span class="ident" id="6464957">rw</span>&nbsp;<span class="ident" id="6464960">http</span><span class="op" id="6464964">.</span><span class="ident" id="6464965">ResponseWriter</span><span class="op" id="6464979">,</span>&nbsp;<span class="ident" id="6464981">req</span>&nbsp;<span class="op" id="6464985">*</span><span class="ident" id="6464986">http</span><span class="op" id="6464990">.</span><span class="ident" id="6464991">Request</span><span class="op" id="6464998">)</span>&nbsp;<span class="op" id="6465000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465004">rw</span><span class="op" id="6465006">.</span><span class="ident" id="6465007">Header</span><span class="op" id="6465013">(</span><span class="op" id="6465014">)</span><span class="op" id="6465015">.</span><span class="ident" id="6465016">Set</span><span class="op" id="6465019">(</span><span class="string" id="6465020">&#34;X-Test-Header&#34;</span><span class="op" id="6465035">,</span>&nbsp;<span class="string" id="6465037">&#34;X-Test-Value&#34;</span><span class="op" id="6465051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465055">req</span><span class="op" id="6465058">.</span><span class="ident" id="6465059">ParseForm</span><span class="op" id="6465068">(</span><span class="op" id="6465069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465073">if</span>&nbsp;<span class="ident" id="6465076">req</span><span class="op" id="6465079">.</span><span class="ident" id="6465080">FormValue</span><span class="op" id="6465089">(</span><span class="string" id="6465090">&#34;no-body&#34;</span><span class="op" id="6465099">)</span>&nbsp;<span class="op" id="6465101">==</span>&nbsp;<span class="string" id="6465104">&#34;1&#34;</span>&nbsp;<span class="op" id="6465108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465113">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465126">if</span>&nbsp;<span class="ident" id="6465129">req</span><span class="op" id="6465132">.</span><span class="ident" id="6465133">FormValue</span><span class="op" id="6465142">(</span><span class="string" id="6465143">&#34;write-forever&#34;</span><span class="op" id="6465158">)</span>&nbsp;<span class="op" id="6465160">==</span>&nbsp;<span class="string" id="6465163">&#34;1&#34;</span>&nbsp;<span class="op" id="6465167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465172">io</span><span class="op" id="6465174">.</span><span class="ident" id="6465175">Copy</span><span class="op" id="6465179">(</span><span class="ident" id="6465180">rw</span><span class="op" id="6465182">,</span>&nbsp;<span class="ident" id="6465184">neverEnding</span><span class="op" id="6465195">(</span><span class="string" id="6465196">&#39;a&#39;</span><span class="op" id="6465199">)</span><span class="op" id="6465200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465205">for</span>&nbsp;<span class="op" id="6465209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465215">time</span><span class="op" id="6465219">.</span><span class="ident" id="6465220">Sleep</span><span class="op" id="6465225">(</span><span class="num" id="6465226">5</span>&nbsp;<span class="op" id="6465228">*</span>&nbsp;<span class="ident" id="6465230">time</span><span class="op" id="6465234">.</span><span class="ident" id="6465235">Second</span><span class="op" id="6465241">)</span>&nbsp;<span class="comment" id="6465243">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465284">fmt</span><span class="op" id="6465287">.</span><span class="ident" id="6465288">Fprintf</span><span class="op" id="6465295">(</span><span class="ident" id="6465296">rw</span><span class="op" id="6465298">,</span>&nbsp;<span class="string" id="6465300">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="6465325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465329">for</span>&nbsp;<span class="ident" id="6465333">k</span><span class="op" id="6465334">,</span>&nbsp;<span class="ident" id="6465336">vv</span>&nbsp;<span class="op" id="6465339">:=</span>&nbsp;<span class="keyword" id="6465342">range</span>&nbsp;<span class="ident" id="6465348">req</span><span class="op" id="6465351">.</span><span class="ident" id="6465352">Form</span>&nbsp;<span class="op" id="6465357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465362">for</span>&nbsp;<span class="ident" id="6465366">_</span><span class="op" id="6465367">,</span>&nbsp;<span class="ident" id="6465369">v</span>&nbsp;<span class="op" id="6465371">:=</span>&nbsp;<span class="keyword" id="6465374">range</span>&nbsp;<span class="ident" id="6465380">vv</span>&nbsp;<span class="op" id="6465383">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465389">fmt</span><span class="op" id="6465392">.</span><span class="ident" id="6465393">Fprintf</span><span class="op" id="6465400">(</span><span class="ident" id="6465401">rw</span><span class="op" id="6465403">,</span>&nbsp;<span class="string" id="6465405">&#34;param-%s=%s\n&#34;</span><span class="op" id="6465420">,</span>&nbsp;<span class="ident" id="6465422">k</span><span class="op" id="6465423">,</span>&nbsp;<span class="ident" id="6465425">v</span><span class="op" id="6465426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6465439">for</span>&nbsp;<span class="ident" id="6465443">_</span><span class="op" id="6465444">,</span>&nbsp;<span class="ident" id="6465446">kv</span>&nbsp;<span class="op" id="6465449">:=</span>&nbsp;<span class="keyword" id="6465452">range</span>&nbsp;<span class="ident" id="6465458">os</span><span class="op" id="6465460">.</span><span class="ident" id="6465461">Environ</span><span class="op" id="6465468">(</span><span class="op" id="6465469">)</span>&nbsp;<span class="op" id="6465471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465476">fmt</span><span class="op" id="6465479">.</span><span class="ident" id="6465480">Fprintf</span><span class="op" id="6465487">(</span><span class="ident" id="6465488">rw</span><span class="op" id="6465490">,</span>&nbsp;<span class="string" id="6465492">&#34;env-%s\n&#34;</span><span class="op" id="6465502">,</span>&nbsp;<span class="ident" id="6465504">kv</span><span class="op" id="6465506">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6465513">}</span><span class="op" id="6465514">)</span><span class="op" id="6465515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6465518">os</span><span class="op" id="6465520">.</span><span class="ident" id="6465521">Exit</span><span class="op" id="6465525">(</span><span class="num" id="6465526">0</span><span class="op" id="6465527">)</span><br>
<span class="lineno"></span><span class="op" id="6465529">}</span>
</div>
</body>
</html>
