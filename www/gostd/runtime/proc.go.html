<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2003455">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2003510">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2003564">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2003615">package</span>&nbsp;<span class="ident" id="2003623">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2003632">import</span>&nbsp;<span class="string" id="2003639">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2003649">func</span>&nbsp;<span class="ident" id="2003654">newsysmon</span><span class="op" id="2003663">(</span><span class="op" id="2003664">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2003667">func</span>&nbsp;<span class="ident" id="2003672">runtime_init</span><span class="op" id="2003684">(</span><span class="op" id="2003685">)</span><br>
<span class="lineno"></span><span class="keyword" id="2003687">func</span>&nbsp;<span class="ident" id="2003692">main_init</span><span class="op" id="2003701">(</span><span class="op" id="2003702">)</span><br>
<span class="lineno"></span><span class="keyword" id="2003704">func</span>&nbsp;<span class="ident" id="2003709">main_main</span><span class="op" id="2003718">(</span><span class="op" id="2003719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2003722">//&nbsp;The&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="2003745">func</span>&nbsp;<span class="ident" id="2003750">main</span><span class="op" id="2003754">(</span><span class="op" id="2003755">)</span>&nbsp;<span class="op" id="2003757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2003760">g</span>&nbsp;<span class="op" id="2003762">:=</span>&nbsp;<span class="ident" id="2003765">getg</span><span class="op" id="2003769">(</span><span class="op" id="2003770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2003774">//&nbsp;Racectx&nbsp;of&nbsp;m0-&gt;g0&nbsp;is&nbsp;used&nbsp;only&nbsp;as&nbsp;the&nbsp;parent&nbsp;of&nbsp;the&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2003846">//&nbsp;It&nbsp;must&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;anything&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2003889">g</span><span class="op" id="2003890">.</span><span class="ident" id="2003891">m</span><span class="op" id="2003892">.</span><span class="ident" id="2003893">g0</span><span class="op" id="2003895">.</span><span class="ident" id="2003896">racectx</span>&nbsp;<span class="op" id="2003904">=</span>&nbsp;<span class="num" id="2003906">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2003910">//&nbsp;Max&nbsp;stack&nbsp;size&nbsp;is&nbsp;1&nbsp;GB&nbsp;on&nbsp;64-bit,&nbsp;250&nbsp;MB&nbsp;on&nbsp;32-bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2003966">//&nbsp;Using&nbsp;decimal&nbsp;instead&nbsp;of&nbsp;binary&nbsp;GB&nbsp;and&nbsp;MB&nbsp;because</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004020">//&nbsp;they&nbsp;look&nbsp;nicer&nbsp;in&nbsp;the&nbsp;stack&nbsp;overflow&nbsp;failure&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2004079">if</span>&nbsp;<span class="ident" id="2004082">ptrSize</span>&nbsp;<span class="op" id="2004090">==</span>&nbsp;<span class="num" id="2004093">8</span>&nbsp;<span class="op" id="2004095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004099">maxstacksize</span>&nbsp;<span class="op" id="2004112">=</span>&nbsp;<span class="num" id="2004114">1000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004126">}</span>&nbsp;<span class="keyword" id="2004128">else</span>&nbsp;<span class="op" id="2004133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004137">maxstacksize</span>&nbsp;<span class="op" id="2004150">=</span>&nbsp;<span class="num" id="2004152">250000000</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004167">onM</span><span class="op" id="2004170">(</span><span class="ident" id="2004171">newsysmon</span><span class="op" id="2004180">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004184">//&nbsp;Lock&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;onto&nbsp;this,&nbsp;the&nbsp;main&nbsp;OS&nbsp;thread,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004243">//&nbsp;during&nbsp;initialization.&nbsp;&nbsp;Most&nbsp;programs&nbsp;won&#39;t&nbsp;care,&nbsp;but&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004307">//&nbsp;do&nbsp;require&nbsp;certain&nbsp;calls&nbsp;to&nbsp;be&nbsp;made&nbsp;by&nbsp;the&nbsp;main&nbsp;thread.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004367">//&nbsp;Those&nbsp;can&nbsp;arrange&nbsp;for&nbsp;main.main&nbsp;to&nbsp;run&nbsp;in&nbsp;the&nbsp;main&nbsp;thread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004429">//&nbsp;by&nbsp;calling&nbsp;runtime.LockOSThread&nbsp;during&nbsp;initialization</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004487">//&nbsp;to&nbsp;preserve&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004513">lockOSThread</span><span class="op" id="2004525">(</span><span class="op" id="2004526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2004530">if</span>&nbsp;<span class="ident" id="2004533">g</span><span class="op" id="2004534">.</span><span class="ident" id="2004535">m</span>&nbsp;<span class="op" id="2004537">!=</span>&nbsp;<span class="op" id="2004540">&amp;</span><span class="ident" id="2004541">m0</span>&nbsp;<span class="op" id="2004544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004548">gothrow</span><span class="op" id="2004555">(</span><span class="string" id="2004556">&#34;runtime.main&nbsp;not&nbsp;on&nbsp;m0&#34;</span><span class="op" id="2004580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004583">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004587">runtime_init</span><span class="op" id="2004599">(</span><span class="op" id="2004600">)</span>&nbsp;<span class="comment" id="2004602">//&nbsp;must&nbsp;be&nbsp;before&nbsp;defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004628">//&nbsp;Defer&nbsp;unlock&nbsp;so&nbsp;that&nbsp;runtime.Goexit&nbsp;during&nbsp;init&nbsp;does&nbsp;the&nbsp;unlock&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004701">needUnlock</span>&nbsp;<span class="op" id="2004712">:=</span>&nbsp;<span class="builtintype" id="2004715">true</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2004721">defer</span>&nbsp;<span class="keyword" id="2004727">func</span><span class="op" id="2004731">(</span><span class="op" id="2004732">)</span>&nbsp;<span class="op" id="2004734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2004738">if</span>&nbsp;<span class="ident" id="2004741">needUnlock</span>&nbsp;<span class="op" id="2004752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004757">unlockOSThread</span><span class="op" id="2004771">(</span><span class="op" id="2004772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004779">}</span><span class="op" id="2004780">(</span><span class="op" id="2004781">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004785">memstats</span><span class="op" id="2004793">.</span><span class="ident" id="2004794">enablegc</span>&nbsp;<span class="op" id="2004803">=</span>&nbsp;<span class="builtintype" id="2004805">true</span>&nbsp;<span class="comment" id="2004810">//&nbsp;now&nbsp;that&nbsp;runtime&nbsp;is&nbsp;initialized,&nbsp;GC&nbsp;is&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004859">main_init</span><span class="op" id="2004868">(</span><span class="op" id="2004869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004873">needUnlock</span>&nbsp;<span class="op" id="2004884">=</span>&nbsp;<span class="builtintype" id="2004886">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004893">unlockOSThread</span><span class="op" id="2004907">(</span><span class="op" id="2004908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004912">main_main</span><span class="op" id="2004921">(</span><span class="op" id="2004922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2004925">if</span>&nbsp;<span class="ident" id="2004928">raceenabled</span>&nbsp;<span class="op" id="2004940">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2004944">racefini</span><span class="op" id="2004952">(</span><span class="op" id="2004953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2004956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2004960">//&nbsp;Make&nbsp;racy&nbsp;client&nbsp;program&nbsp;work:&nbsp;if&nbsp;panicking&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2005011">//&nbsp;another&nbsp;goroutine&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;as&nbsp;main&nbsp;returns,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2005067">//&nbsp;let&nbsp;the&nbsp;other&nbsp;goroutine&nbsp;finish&nbsp;printing&nbsp;the&nbsp;panic&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2005128">//&nbsp;Once&nbsp;it&nbsp;does,&nbsp;it&nbsp;will&nbsp;exit.&nbsp;See&nbsp;issue&nbsp;3934.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005176">if</span>&nbsp;<span class="ident" id="2005179">panicking</span>&nbsp;<span class="op" id="2005189">!=</span>&nbsp;<span class="num" id="2005192">0</span>&nbsp;<span class="op" id="2005194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005198">gopark</span><span class="op" id="2005204">(</span><span class="ident" id="2005205">nil</span><span class="op" id="2005208">,</span>&nbsp;<span class="ident" id="2005210">nil</span><span class="op" id="2005213">,</span>&nbsp;<span class="string" id="2005215">&#34;panicwait&#34;</span><span class="op" id="2005226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005229">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005233">exit</span><span class="op" id="2005237">(</span><span class="num" id="2005238">0</span><span class="op" id="2005239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005242">for</span>&nbsp;<span class="op" id="2005246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005250">var</span>&nbsp;<span class="ident" id="2005254">x</span>&nbsp;<span class="op" id="2005256">*</span><span class="builtintype" id="2005257">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005265">*</span><span class="ident" id="2005266">x</span>&nbsp;<span class="op" id="2005268">=</span>&nbsp;<span class="num" id="2005270">0</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005273">}</span><br>
<span class="lineno"></span><span class="op" id="2005275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2005278">var</span>&nbsp;<span class="ident" id="2005282">parkunlock_c</span>&nbsp;<span class="builtintype" id="2005295">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="2005301">//&nbsp;start&nbsp;forcegc&nbsp;helper&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="keyword" id="2005335">func</span>&nbsp;<span class="ident" id="2005340">init</span><span class="op" id="2005344">(</span><span class="op" id="2005345">)</span>&nbsp;<span class="op" id="2005347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005350">go</span>&nbsp;<span class="ident" id="2005353">forcegchelper</span><span class="op" id="2005366">(</span><span class="op" id="2005367">)</span><br>
<span class="lineno"></span><span class="op" id="2005369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="2005372">func</span>&nbsp;<span class="ident" id="2005377">forcegchelper</span><span class="op" id="2005390">(</span><span class="op" id="2005391">)</span>&nbsp;<span class="op" id="2005393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005396">forcegc</span><span class="op" id="2005403">.</span><span class="ident" id="2005404">g</span>&nbsp;<span class="op" id="2005406">=</span>&nbsp;<span class="ident" id="2005408">getg</span><span class="op" id="2005412">(</span><span class="op" id="2005413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005416">forcegc</span><span class="op" id="2005423">.</span><span class="ident" id="2005424">g</span><span class="op" id="2005425">.</span><span class="ident" id="2005426">issystem</span>&nbsp;<span class="op" id="2005435">=</span>&nbsp;<span class="builtintype" id="2005437">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005443">for</span>&nbsp;<span class="op" id="2005447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005451">lock</span><span class="op" id="2005455">(</span><span class="op" id="2005456">&amp;</span><span class="ident" id="2005457">forcegc</span><span class="op" id="2005464">.</span><span class="ident" id="2005465">lock</span><span class="op" id="2005469">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005473">if</span>&nbsp;<span class="ident" id="2005476">forcegc</span><span class="op" id="2005483">.</span><span class="ident" id="2005484">idle</span>&nbsp;<span class="op" id="2005489">!=</span>&nbsp;<span class="num" id="2005492">0</span>&nbsp;<span class="op" id="2005494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005499">gothrow</span><span class="op" id="2005506">(</span><span class="string" id="2005507">&#34;forcegc:&nbsp;phase&nbsp;error&#34;</span><span class="op" id="2005529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005537">atomicstore</span><span class="op" id="2005548">(</span><span class="op" id="2005549">&amp;</span><span class="ident" id="2005550">forcegc</span><span class="op" id="2005557">.</span><span class="ident" id="2005558">idle</span><span class="op" id="2005562">,</span>&nbsp;<span class="num" id="2005564">1</span><span class="op" id="2005565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005569">goparkunlock</span><span class="op" id="2005581">(</span><span class="op" id="2005582">&amp;</span><span class="ident" id="2005583">forcegc</span><span class="op" id="2005590">.</span><span class="ident" id="2005591">lock</span><span class="op" id="2005595">,</span>&nbsp;<span class="string" id="2005597">&#34;force&nbsp;gc&nbsp;(idle)&#34;</span><span class="op" id="2005614">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2005618">//&nbsp;this&nbsp;goroutine&nbsp;is&nbsp;explicitly&nbsp;resumed&nbsp;by&nbsp;sysmon</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2005670">if</span>&nbsp;<span class="ident" id="2005673">debug</span><span class="op" id="2005678">.</span><span class="ident" id="2005679">gctrace</span>&nbsp;<span class="op" id="2005687">&gt;</span>&nbsp;<span class="num" id="2005689">0</span>&nbsp;<span class="op" id="2005691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2005696">println</span><span class="op" id="2005703">(</span><span class="string" id="2005704">&#34;GC&nbsp;forced&#34;</span><span class="op" id="2005715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005723">gogc</span><span class="op" id="2005727">(</span><span class="num" id="2005728">1</span><span class="op" id="2005729">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2005732">}</span><br>
<span class="lineno"></span><span class="op" id="2005734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2005737">//go:nosplit</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2005751">//&nbsp;Gosched&nbsp;yields&nbsp;the&nbsp;processor,&nbsp;allowing&nbsp;other&nbsp;goroutines&nbsp;to&nbsp;run.&nbsp;&nbsp;It&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="2005831">//&nbsp;suspend&nbsp;the&nbsp;current&nbsp;goroutine,&nbsp;so&nbsp;execution&nbsp;resumes&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="2005901">func</span>&nbsp;<span class="ident" id="2005906">Gosched</span><span class="op" id="2005913">(</span><span class="op" id="2005914">)</span>&nbsp;<span class="op" id="2005916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2005919">mcall</span><span class="op" id="2005924">(</span><span class="ident" id="2005925">gosched_m</span><span class="op" id="2005934">)</span><br>
<span class="lineno"></span><span class="op" id="2005936">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="2005939">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;calls&nbsp;unlockf.</span><br>
<span class="lineno"></span><span class="comment" id="2006009">//&nbsp;If&nbsp;unlockf&nbsp;returns&nbsp;false,&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;resumed.</span><br>
<span class="lineno"></span><span class="keyword" id="2006064">func</span>&nbsp;<span class="ident" id="2006069">gopark</span><span class="op" id="2006075">(</span><span class="ident" id="2006076">unlockf</span>&nbsp;<span class="ident" id="2006084">unsafe</span><span class="op" id="2006090">.</span><span class="ident" id="2006091">Pointer</span><span class="op" id="2006098">,</span>&nbsp;<span class="ident" id="2006100">lock</span>&nbsp;<span class="ident" id="2006105">unsafe</span><span class="op" id="2006111">.</span><span class="ident" id="2006112">Pointer</span><span class="op" id="2006119">,</span>&nbsp;<span class="ident" id="2006121">reason</span>&nbsp;<span class="builtintype" id="2006128">string</span><span class="op" id="2006134">)</span>&nbsp;<span class="op" id="2006136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006139">mp</span>&nbsp;<span class="op" id="2006142">:=</span>&nbsp;<span class="ident" id="2006145">acquirem</span><span class="op" id="2006153">(</span><span class="op" id="2006154">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006157">gp</span>&nbsp;<span class="op" id="2006160">:=</span>&nbsp;<span class="ident" id="2006163">mp</span><span class="op" id="2006165">.</span><span class="ident" id="2006166">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006172">status</span>&nbsp;<span class="op" id="2006179">:=</span>&nbsp;<span class="ident" id="2006182">readgstatus</span><span class="op" id="2006193">(</span><span class="ident" id="2006194">gp</span><span class="op" id="2006196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2006199">if</span>&nbsp;<span class="ident" id="2006202">status</span>&nbsp;<span class="op" id="2006209">!=</span>&nbsp;<span class="ident" id="2006212">_Grunning</span>&nbsp;<span class="op" id="2006222">&amp;&amp;</span>&nbsp;<span class="ident" id="2006225">status</span>&nbsp;<span class="op" id="2006232">!=</span>&nbsp;<span class="ident" id="2006235">_Gscanrunning</span>&nbsp;<span class="op" id="2006249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006253">gothrow</span><span class="op" id="2006260">(</span><span class="string" id="2006261">&#34;gopark:&nbsp;bad&nbsp;g&nbsp;status&#34;</span><span class="op" id="2006283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2006286">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006289">mp</span><span class="op" id="2006291">.</span><span class="ident" id="2006292">waitlock</span>&nbsp;<span class="op" id="2006301">=</span>&nbsp;<span class="ident" id="2006303">lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006309">mp</span><span class="op" id="2006311">.</span><span class="ident" id="2006312">waitunlockf</span>&nbsp;<span class="op" id="2006324">=</span>&nbsp;<span class="ident" id="2006326">unlockf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006335">gp</span><span class="op" id="2006337">.</span><span class="ident" id="2006338">waitreason</span>&nbsp;<span class="op" id="2006349">=</span>&nbsp;<span class="ident" id="2006351">reason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006359">releasem</span><span class="op" id="2006367">(</span><span class="ident" id="2006368">mp</span><span class="op" id="2006370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2006373">//&nbsp;can&#39;t&nbsp;do&nbsp;anything&nbsp;that&nbsp;might&nbsp;move&nbsp;the&nbsp;G&nbsp;between&nbsp;Ms&nbsp;here.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006434">mcall</span><span class="op" id="2006439">(</span><span class="ident" id="2006440">park_m</span><span class="op" id="2006446">)</span><br>
<span class="lineno"></span><span class="op" id="2006448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2006451">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;unlocks&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="2006524">//&nbsp;The&nbsp;goroutine&nbsp;can&nbsp;be&nbsp;made&nbsp;runnable&nbsp;again&nbsp;by&nbsp;calling&nbsp;goready(gp).</span><br>
<span class="lineno">135</span><span class="keyword" id="2006592">func</span>&nbsp;<span class="ident" id="2006597">goparkunlock</span><span class="op" id="2006609">(</span><span class="ident" id="2006610">lock</span>&nbsp;<span class="op" id="2006615">*</span><span class="ident" id="2006616">mutex</span><span class="op" id="2006621">,</span>&nbsp;<span class="ident" id="2006623">reason</span>&nbsp;<span class="builtintype" id="2006630">string</span><span class="op" id="2006636">)</span>&nbsp;<span class="op" id="2006638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006641">gopark</span><span class="op" id="2006647">(</span><span class="ident" id="2006648">unsafe</span><span class="op" id="2006654">.</span><span class="ident" id="2006655">Pointer</span><span class="op" id="2006662">(</span><span class="op" id="2006663">&amp;</span><span class="ident" id="2006664">parkunlock_c</span><span class="op" id="2006676">)</span><span class="op" id="2006677">,</span>&nbsp;<span class="ident" id="2006679">unsafe</span><span class="op" id="2006685">.</span><span class="ident" id="2006686">Pointer</span><span class="op" id="2006693">(</span><span class="ident" id="2006694">lock</span><span class="op" id="2006698">)</span><span class="op" id="2006699">,</span>&nbsp;<span class="ident" id="2006701">reason</span><span class="op" id="2006707">)</span><br>
<span class="lineno"></span><span class="op" id="2006709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2006712">func</span>&nbsp;<span class="ident" id="2006717">goready</span><span class="op" id="2006724">(</span><span class="ident" id="2006725">gp</span>&nbsp;<span class="op" id="2006728">*</span><span class="ident" id="2006729">g</span><span class="op" id="2006730">)</span>&nbsp;<span class="op" id="2006732">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006735">mp</span>&nbsp;<span class="op" id="2006738">:=</span>&nbsp;<span class="ident" id="2006741">acquirem</span><span class="op" id="2006749">(</span><span class="op" id="2006750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006753">mp</span><span class="op" id="2006755">.</span><span class="ident" id="2006756">ptrarg</span><span class="op" id="2006762">[</span><span class="num" id="2006763">0</span><span class="op" id="2006764">]</span>&nbsp;<span class="op" id="2006766">=</span>&nbsp;<span class="ident" id="2006768">unsafe</span><span class="op" id="2006774">.</span><span class="ident" id="2006775">Pointer</span><span class="op" id="2006782">(</span><span class="ident" id="2006783">gp</span><span class="op" id="2006785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006788">onM</span><span class="op" id="2006791">(</span><span class="ident" id="2006792">ready_m</span><span class="op" id="2006799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006802">releasem</span><span class="op" id="2006810">(</span><span class="ident" id="2006811">mp</span><span class="op" id="2006813">)</span><br>
<span class="lineno"></span><span class="op" id="2006815">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="2006818">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2006831">func</span>&nbsp;<span class="ident" id="2006836">acquireSudog</span><span class="op" id="2006848">(</span><span class="op" id="2006849">)</span>&nbsp;<span class="op" id="2006851">*</span><span class="ident" id="2006852">sudog</span>&nbsp;<span class="op" id="2006858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006861">c</span>&nbsp;<span class="op" id="2006863">:=</span>&nbsp;<span class="ident" id="2006866">gomcache</span><span class="op" id="2006874">(</span><span class="op" id="2006875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006878">s</span>&nbsp;<span class="op" id="2006880">:=</span>&nbsp;<span class="ident" id="2006883">c</span><span class="op" id="2006884">.</span><span class="ident" id="2006885">sudogcache</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2006897">if</span>&nbsp;<span class="ident" id="2006900">s</span>&nbsp;<span class="op" id="2006902">!=</span>&nbsp;<span class="ident" id="2006905">nil</span>&nbsp;<span class="op" id="2006909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2006913">if</span>&nbsp;<span class="ident" id="2006916">s</span><span class="op" id="2006917">.</span><span class="ident" id="2006918">elem</span>&nbsp;<span class="op" id="2006923">!=</span>&nbsp;<span class="ident" id="2006926">nil</span>&nbsp;<span class="op" id="2006930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006935">gothrow</span><span class="op" id="2006942">(</span><span class="string" id="2006943">&#34;acquireSudog:&nbsp;found&nbsp;s.elem&nbsp;!=&nbsp;nil&nbsp;in&nbsp;cache&#34;</span><span class="op" id="2006987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2006991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2006995">c</span><span class="op" id="2006996">.</span><span class="ident" id="2006997">sudogcache</span>&nbsp;<span class="op" id="2007008">=</span>&nbsp;<span class="ident" id="2007010">s</span><span class="op" id="2007011">.</span><span class="ident" id="2007012">next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007019">s</span><span class="op" id="2007020">.</span><span class="ident" id="2007021">next</span>&nbsp;<span class="op" id="2007026">=</span>&nbsp;<span class="ident" id="2007028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007034">return</span>&nbsp;<span class="ident" id="2007041">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007048">//&nbsp;Delicate&nbsp;dance:&nbsp;the&nbsp;semaphore&nbsp;implementation&nbsp;calls</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007103">//&nbsp;acquireSudog,&nbsp;acquireSudog&nbsp;calls&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007152">//&nbsp;new&nbsp;calls&nbsp;malloc,&nbsp;malloc&nbsp;can&nbsp;call&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007213">//&nbsp;and&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;calls&nbsp;the&nbsp;semaphore&nbsp;implementation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007278">//&nbsp;in&nbsp;stoptheworld.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007299">//&nbsp;Break&nbsp;the&nbsp;cycle&nbsp;by&nbsp;doing&nbsp;acquirem/releasem&nbsp;around&nbsp;new(sudog).</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007365">//&nbsp;The&nbsp;acquirem/releasem&nbsp;increments&nbsp;m.locks&nbsp;during&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2007429">//&nbsp;which&nbsp;keeps&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;from&nbsp;being&nbsp;invoked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007487">mp</span>&nbsp;<span class="op" id="2007490">:=</span>&nbsp;<span class="ident" id="2007493">acquirem</span><span class="op" id="2007501">(</span><span class="op" id="2007502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007505">p</span>&nbsp;<span class="op" id="2007507">:=</span>&nbsp;<span class="builtinfunc" id="2007510">new</span><span class="op" id="2007513">(</span><span class="ident" id="2007514">sudog</span><span class="op" id="2007519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007522">releasem</span><span class="op" id="2007530">(</span><span class="ident" id="2007531">mp</span><span class="op" id="2007533">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007536">return</span>&nbsp;<span class="ident" id="2007543">p</span><br>
<span class="lineno"></span><span class="op" id="2007545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2007548">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2007561">func</span>&nbsp;<span class="ident" id="2007566">releaseSudog</span><span class="op" id="2007578">(</span><span class="ident" id="2007579">s</span>&nbsp;<span class="op" id="2007581">*</span><span class="ident" id="2007582">sudog</span><span class="op" id="2007587">)</span>&nbsp;<span class="op" id="2007589">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007592">if</span>&nbsp;<span class="ident" id="2007595">s</span><span class="op" id="2007596">.</span><span class="ident" id="2007597">elem</span>&nbsp;<span class="op" id="2007602">!=</span>&nbsp;<span class="ident" id="2007605">nil</span>&nbsp;<span class="op" id="2007609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007613">gothrow</span><span class="op" id="2007620">(</span><span class="string" id="2007621">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;elem&#34;</span><span class="op" id="2007655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007661">if</span>&nbsp;<span class="ident" id="2007664">s</span><span class="op" id="2007665">.</span><span class="ident" id="2007666">selectdone</span>&nbsp;<span class="op" id="2007677">!=</span>&nbsp;<span class="ident" id="2007680">nil</span>&nbsp;<span class="op" id="2007684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007688">gothrow</span><span class="op" id="2007695">(</span><span class="string" id="2007696">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;selectdone&#34;</span><span class="op" id="2007736">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007742">if</span>&nbsp;<span class="ident" id="2007745">s</span><span class="op" id="2007746">.</span><span class="ident" id="2007747">next</span>&nbsp;<span class="op" id="2007752">!=</span>&nbsp;<span class="ident" id="2007755">nil</span>&nbsp;<span class="op" id="2007759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007763">gothrow</span><span class="op" id="2007770">(</span><span class="string" id="2007771">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;next&#34;</span><span class="op" id="2007805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007811">if</span>&nbsp;<span class="ident" id="2007814">s</span><span class="op" id="2007815">.</span><span class="ident" id="2007816">prev</span>&nbsp;<span class="op" id="2007821">!=</span>&nbsp;<span class="ident" id="2007824">nil</span>&nbsp;<span class="op" id="2007828">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007832">gothrow</span><span class="op" id="2007839">(</span><span class="string" id="2007840">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;prev&#34;</span><span class="op" id="2007874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007880">if</span>&nbsp;<span class="ident" id="2007883">s</span><span class="op" id="2007884">.</span><span class="ident" id="2007885">waitlink</span>&nbsp;<span class="op" id="2007894">!=</span>&nbsp;<span class="ident" id="2007897">nil</span>&nbsp;<span class="op" id="2007901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007905">gothrow</span><span class="op" id="2007912">(</span><span class="string" id="2007913">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;waitlink&#34;</span><span class="op" id="2007951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2007954">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007957">gp</span>&nbsp;<span class="op" id="2007960">:=</span>&nbsp;<span class="ident" id="2007963">getg</span><span class="op" id="2007967">(</span><span class="op" id="2007968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2007971">if</span>&nbsp;<span class="ident" id="2007974">gp</span><span class="op" id="2007976">.</span><span class="ident" id="2007977">param</span>&nbsp;<span class="op" id="2007983">!=</span>&nbsp;<span class="ident" id="2007986">nil</span>&nbsp;<span class="op" id="2007990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2007994">gothrow</span><span class="op" id="2008001">(</span><span class="string" id="2008002">&#34;runtime:&nbsp;releaseSudog&nbsp;with&nbsp;non-nil&nbsp;gp.param&#34;</span><span class="op" id="2008047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2008050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008053">c</span>&nbsp;<span class="op" id="2008055">:=</span>&nbsp;<span class="ident" id="2008058">gomcache</span><span class="op" id="2008066">(</span><span class="op" id="2008067">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008070">s</span><span class="op" id="2008071">.</span><span class="ident" id="2008072">next</span>&nbsp;<span class="op" id="2008077">=</span>&nbsp;<span class="ident" id="2008079">c</span><span class="op" id="2008080">.</span><span class="ident" id="2008081">sudogcache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008093">c</span><span class="op" id="2008094">.</span><span class="ident" id="2008095">sudogcache</span>&nbsp;<span class="op" id="2008106">=</span>&nbsp;<span class="ident" id="2008108">s</span><br>
<span class="lineno"></span><span class="op" id="2008110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2008113">//&nbsp;funcPC&nbsp;returns&nbsp;the&nbsp;entry&nbsp;PC&nbsp;of&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno">200</span><span class="comment" id="2008163">//&nbsp;It&nbsp;assumes&nbsp;that&nbsp;f&nbsp;is&nbsp;a&nbsp;func&nbsp;value.&nbsp;Otherwise&nbsp;the&nbsp;behavior&nbsp;is&nbsp;undefined.</span><br>
<span class="lineno"></span><span class="comment" id="2008238">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="2008251">func</span>&nbsp;<span class="ident" id="2008256">funcPC</span><span class="op" id="2008262">(</span><span class="ident" id="2008263">f</span>&nbsp;<span class="keyword" id="2008265">interface</span><span class="op" id="2008274">{</span><span class="op" id="2008275">}</span><span class="op" id="2008276">)</span>&nbsp;<span class="builtintype" id="2008278">uintptr</span>&nbsp;<span class="op" id="2008286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008289">return</span>&nbsp;<span class="op" id="2008296">*</span><span class="op" id="2008297">*</span><span class="op" id="2008298">(</span><span class="op" id="2008299">*</span><span class="op" id="2008300">*</span><span class="builtintype" id="2008301">uintptr</span><span class="op" id="2008308">)</span><span class="op" id="2008309">(</span><span class="ident" id="2008310">add</span><span class="op" id="2008313">(</span><span class="ident" id="2008314">unsafe</span><span class="op" id="2008320">.</span><span class="ident" id="2008321">Pointer</span><span class="op" id="2008328">(</span><span class="op" id="2008329">&amp;</span><span class="ident" id="2008330">f</span><span class="op" id="2008331">)</span><span class="op" id="2008332">,</span>&nbsp;<span class="ident" id="2008334">ptrSize</span><span class="op" id="2008341">)</span><span class="op" id="2008342">)</span><br>
<span class="lineno"></span><span class="op" id="2008344">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="2008347">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno"></span><span class="keyword" id="2008371">func</span>&nbsp;<span class="ident" id="2008376">badmcall</span><span class="op" id="2008384">(</span><span class="ident" id="2008385">fn</span>&nbsp;<span class="keyword" id="2008388">func</span><span class="op" id="2008392">(</span><span class="op" id="2008393">*</span><span class="ident" id="2008394">g</span><span class="op" id="2008395">)</span><span class="op" id="2008396">)</span>&nbsp;<span class="op" id="2008398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008401">gothrow</span><span class="op" id="2008408">(</span><span class="string" id="2008409">&#34;runtime:&nbsp;mcall&nbsp;called&nbsp;on&nbsp;m-&gt;g0&nbsp;stack&#34;</span><span class="op" id="2008447">)</span><br>
<span class="lineno"></span><span class="op" id="2008449">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="2008452">func</span>&nbsp;<span class="ident" id="2008457">badmcall2</span><span class="op" id="2008466">(</span><span class="ident" id="2008467">fn</span>&nbsp;<span class="keyword" id="2008470">func</span><span class="op" id="2008474">(</span><span class="op" id="2008475">*</span><span class="ident" id="2008476">g</span><span class="op" id="2008477">)</span><span class="op" id="2008478">)</span>&nbsp;<span class="op" id="2008480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008483">gothrow</span><span class="op" id="2008490">(</span><span class="string" id="2008491">&#34;runtime:&nbsp;mcall&nbsp;function&nbsp;returned&#34;</span><span class="op" id="2008525">)</span><br>
<span class="lineno"></span><span class="op" id="2008527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="2008530">func</span>&nbsp;<span class="ident" id="2008535">badreflectcall</span><span class="op" id="2008549">(</span><span class="op" id="2008550">)</span>&nbsp;<span class="op" id="2008552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2008555">panic</span><span class="op" id="2008560">(</span><span class="string" id="2008561">&#34;runtime:&nbsp;arg&nbsp;size&nbsp;to&nbsp;reflect.call&nbsp;more&nbsp;than&nbsp;1GB&#34;</span><span class="op" id="2008610">)</span><br>
<span class="lineno"></span><span class="op" id="2008612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2008615">func</span>&nbsp;<span class="ident" id="2008620">lockedOSThread</span><span class="op" id="2008634">(</span><span class="op" id="2008635">)</span>&nbsp;<span class="builtintype" id="2008637">bool</span>&nbsp;<span class="op" id="2008642">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008645">gp</span>&nbsp;<span class="op" id="2008648">:=</span>&nbsp;<span class="ident" id="2008651">getg</span><span class="op" id="2008655">(</span><span class="op" id="2008656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008659">return</span>&nbsp;<span class="ident" id="2008666">gp</span><span class="op" id="2008668">.</span><span class="ident" id="2008669">lockedm</span>&nbsp;<span class="op" id="2008677">!=</span>&nbsp;<span class="ident" id="2008680">nil</span>&nbsp;<span class="op" id="2008684">&amp;&amp;</span>&nbsp;<span class="ident" id="2008687">gp</span><span class="op" id="2008689">.</span><span class="ident" id="2008690">m</span><span class="op" id="2008691">.</span><span class="ident" id="2008692">lockedg</span>&nbsp;<span class="op" id="2008700">!=</span>&nbsp;<span class="ident" id="2008703">nil</span><br>
<span class="lineno"></span><span class="op" id="2008707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2008710">func</span>&nbsp;<span class="ident" id="2008715">newP</span><span class="op" id="2008719">(</span><span class="op" id="2008720">)</span>&nbsp;<span class="op" id="2008722">*</span><span class="ident" id="2008723">p</span>&nbsp;<span class="op" id="2008725">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008728">return</span>&nbsp;<span class="builtinfunc" id="2008735">new</span><span class="op" id="2008738">(</span><span class="ident" id="2008739">p</span><span class="op" id="2008740">)</span><br>
<span class="lineno"></span><span class="op" id="2008742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2008745">func</span>&nbsp;<span class="ident" id="2008750">newM</span><span class="op" id="2008754">(</span><span class="op" id="2008755">)</span>&nbsp;<span class="op" id="2008757">*</span><span class="ident" id="2008758">m</span>&nbsp;<span class="op" id="2008760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008763">return</span>&nbsp;<span class="builtinfunc" id="2008770">new</span><span class="op" id="2008773">(</span><span class="ident" id="2008774">m</span><span class="op" id="2008775">)</span><br>
<span class="lineno">230</span><span class="op" id="2008777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2008780">func</span>&nbsp;<span class="ident" id="2008785">newG</span><span class="op" id="2008789">(</span><span class="op" id="2008790">)</span>&nbsp;<span class="op" id="2008792">*</span><span class="ident" id="2008793">g</span>&nbsp;<span class="op" id="2008795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008798">return</span>&nbsp;<span class="builtinfunc" id="2008805">new</span><span class="op" id="2008808">(</span><span class="ident" id="2008809">g</span><span class="op" id="2008810">)</span><br>
<span class="lineno"></span><span class="op" id="2008812">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="2008815">func</span>&nbsp;<span class="ident" id="2008820">allgadd</span><span class="op" id="2008827">(</span><span class="ident" id="2008828">gp</span>&nbsp;<span class="op" id="2008831">*</span><span class="ident" id="2008832">g</span><span class="op" id="2008833">)</span>&nbsp;<span class="op" id="2008835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2008838">if</span>&nbsp;<span class="ident" id="2008841">readgstatus</span><span class="op" id="2008852">(</span><span class="ident" id="2008853">gp</span><span class="op" id="2008855">)</span>&nbsp;<span class="op" id="2008857">==</span>&nbsp;<span class="ident" id="2008860">_Gidle</span>&nbsp;<span class="op" id="2008867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008871">gothrow</span><span class="op" id="2008878">(</span><span class="string" id="2008879">&#34;allgadd:&nbsp;bad&nbsp;status&nbsp;Gidle&#34;</span><span class="op" id="2008906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2008909">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008913">lock</span><span class="op" id="2008917">(</span><span class="op" id="2008918">&amp;</span><span class="ident" id="2008919">allglock</span><span class="op" id="2008927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008930">allgs</span>&nbsp;<span class="op" id="2008936">=</span>&nbsp;<span class="builtinfunc" id="2008938">append</span><span class="op" id="2008944">(</span><span class="ident" id="2008945">allgs</span><span class="op" id="2008950">,</span>&nbsp;<span class="ident" id="2008952">gp</span><span class="op" id="2008954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008957">allg</span>&nbsp;<span class="op" id="2008962">=</span>&nbsp;<span class="op" id="2008964">&amp;</span><span class="ident" id="2008965">allgs</span><span class="op" id="2008970">[</span><span class="num" id="2008971">0</span><span class="op" id="2008972">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2008975">allglen</span>&nbsp;<span class="op" id="2008983">=</span>&nbsp;<span class="builtintype" id="2008985">uintptr</span><span class="op" id="2008992">(</span><span class="builtinfunc" id="2008993">len</span><span class="op" id="2008996">(</span><span class="ident" id="2008997">allgs</span><span class="op" id="2009002">)</span><span class="op" id="2009003">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2009006">unlock</span><span class="op" id="2009012">(</span><span class="op" id="2009013">&amp;</span><span class="ident" id="2009014">allglock</span><span class="op" id="2009022">)</span><br>
<span class="lineno"></span><span class="op" id="2009024">}</span>
</div>
</body>
</html>
