<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2635551">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2635607">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2635661">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2635712">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2635790">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2635837">package</span>&nbsp;<span class="ident" id="2635845">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2635850">import</span>&nbsp;<span class="op" id="2635857">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2635860">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2635871">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="2635878">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="2635881">func</span>&nbsp;<span class="ident" id="2635886">probeIPv4Stack</span><span class="op" id="2635900">(</span><span class="op" id="2635901">)</span>&nbsp;<span class="builtintype" id="2635903">bool</span>&nbsp;<span class="op" id="2635908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2635911">s</span><span class="op" id="2635912">,</span>&nbsp;<span class="ident" id="2635914">err</span>&nbsp;<span class="op" id="2635918">:=</span>&nbsp;<span class="ident" id="2635921"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2635928">.</span><span class="ident" id="2635929">Socket</span><span class="op" id="2635935">(</span><span class="ident" id="2635936"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2635943">.</span><span class="ident" id="2635944">AF_INET</span><span class="op" id="2635951">,</span>&nbsp;<span class="ident" id="2635953"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2635960">.</span><span class="ident" id="2635961">SOCK_STREAM</span><span class="op" id="2635972">,</span>&nbsp;<span class="ident" id="2635974"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2635981">.</span><span class="ident" id="2635982">IPPROTO_TCP</span><span class="op" id="2635993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2635996">switch</span>&nbsp;<span class="ident" id="2636003"><a href="/net/ipsock_posix.go.html#2635914">err</a></span>&nbsp;<span class="op" id="2636007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2636010">case</span>&nbsp;<span class="ident" id="2636015"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2636022">.</span><span class="ident" id="2636023">EAFNOSUPPORT</span><span class="op" id="2636035">,</span>&nbsp;<span class="ident" id="2636037"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2636044">.</span><span class="ident" id="2636045">EPROTONOSUPPORT</span><span class="op" id="2636060">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2636064">return</span>&nbsp;<span class="ident" id="2636071">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2636078">case</span>&nbsp;<span class="ident" id="2636083">nil</span><span class="op" id="2636086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2636090"><a href="/net/fd_unix.go.html#2587250">closesocket</a></span><span class="op" id="2636101">(</span><span class="ident" id="2636102"><a href="/net/ipsock_posix.go.html#2635911">s</a></span><span class="op" id="2636103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2636106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2636109">return</span>&nbsp;<span class="ident" id="2636116">true</span><br>
<span class="lineno">25</span><span class="op" id="2636121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2636124">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="2636183">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="2636246">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="2636312">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="2636373">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="2636436">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="2636491">//</span><br>
<span class="lineno"></span><span class="comment" id="2636494">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="2636561">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="2636625">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="2636679">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2636744">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="2636810">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="2636871">func</span>&nbsp;<span class="ident" id="2636876">probeIPv6Stack</span><span class="op" id="2636890">(</span><span class="op" id="2636891">)</span>&nbsp;<span class="op" id="2636893">(</span><span class="ident" id="2636894">supportsIPv6</span><span class="op" id="2636906">,</span>&nbsp;<span class="ident" id="2636908">supportsIPv4map</span>&nbsp;<span class="builtintype" id="2636924">bool</span><span class="op" id="2636928">)</span>&nbsp;<span class="op" id="2636930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2636933">var</span>&nbsp;<span class="ident" id="2636937">probes</span>&nbsp;<span class="op" id="2636944">=</span>&nbsp;<span class="op" id="2636946">[</span><span class="op" id="2636947">]</span><span class="keyword" id="2636948">struct</span>&nbsp;<span class="op" id="2636955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2636959">laddr</span>&nbsp;<span class="ident" id="2636965"><a href="/net/tcpsock.go.html#2691528">TCPAddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2636975">value</span>&nbsp;<span class="builtintype" id="2636981">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2636987">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2636993">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2636999">}</span><span class="op" id="2637000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2637004">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637039">{</span><span class="ident" id="2637040">laddr</span><span class="op" id="2637045">:</span>&nbsp;<span class="ident" id="2637047"><a href="/net/tcpsock.go.html#2691528">TCPAddr</a></span><span class="op" id="2637054">{</span><span class="ident" id="2637055">IP</span><span class="op" id="2637057">:</span>&nbsp;<span class="ident" id="2637059"><a href="/net/ip.go.html#2617916">ParseIP</a></span><span class="op" id="2637066">(</span><span class="string" id="2637067">&#34;::1&#34;</span><span class="op" id="2637072">)</span><span class="op" id="2637073">}</span><span class="op" id="2637074">,</span>&nbsp;<span class="ident" id="2637076">value</span><span class="op" id="2637081">:</span>&nbsp;<span class="num" id="2637083">1</span><span class="op" id="2637084">}</span><span class="op" id="2637085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2637089">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637144">{</span><span class="ident" id="2637145">laddr</span><span class="op" id="2637150">:</span>&nbsp;<span class="ident" id="2637152"><a href="/net/tcpsock.go.html#2691528">TCPAddr</a></span><span class="op" id="2637159">{</span><span class="ident" id="2637160">IP</span><span class="op" id="2637162">:</span>&nbsp;<span class="ident" id="2637164"><a href="/net/ip.go.html#2604600">IPv4</a></span><span class="op" id="2637168">(</span><span class="num" id="2637169">127</span><span class="op" id="2637172">,</span>&nbsp;<span class="num" id="2637174">0</span><span class="op" id="2637175">,</span>&nbsp;<span class="num" id="2637177">0</span><span class="op" id="2637178">,</span>&nbsp;<span class="num" id="2637180">1</span><span class="op" id="2637181">)</span><span class="op" id="2637182">}</span><span class="op" id="2637183">,</span>&nbsp;<span class="ident" id="2637185">value</span><span class="op" id="2637190">:</span>&nbsp;<span class="num" id="2637192">0</span><span class="op" id="2637193">}</span><span class="op" id="2637194">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637201">for</span>&nbsp;<span class="ident" id="2637205">i</span>&nbsp;<span class="op" id="2637207">:=</span>&nbsp;<span class="keyword" id="2637210">range</span>&nbsp;<span class="ident" id="2637216"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span>&nbsp;<span class="op" id="2637223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2637227">s</span><span class="op" id="2637228">,</span>&nbsp;<span class="ident" id="2637230">err</span>&nbsp;<span class="op" id="2637234">:=</span>&nbsp;<span class="ident" id="2637237"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637244">.</span><span class="ident" id="2637245">Socket</span><span class="op" id="2637251">(</span><span class="ident" id="2637252"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637259">.</span><span class="ident" id="2637260">AF_INET6</span><span class="op" id="2637268">,</span>&nbsp;<span class="ident" id="2637270"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637277">.</span><span class="ident" id="2637278">SOCK_STREAM</span><span class="op" id="2637289">,</span>&nbsp;<span class="ident" id="2637291"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637298">.</span><span class="ident" id="2637299">IPPROTO_TCP</span><span class="op" id="2637310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637314">if</span>&nbsp;<span class="ident" id="2637317"><a href="/net/ipsock_posix.go.html#2637230">err</a></span>&nbsp;<span class="op" id="2637321">!=</span>&nbsp;<span class="ident" id="2637324">nil</span>&nbsp;<span class="op" id="2637328">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637333">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637348">defer</span>&nbsp;<span class="ident" id="2637354"><a href="/net/fd_unix.go.html#2587250">closesocket</a></span><span class="op" id="2637365">(</span><span class="ident" id="2637366"><a href="/net/ipsock_posix.go.html#2637227">s</a></span><span class="op" id="2637367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2637371"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637378">.</span><span class="ident" id="2637379">SetsockoptInt</span><span class="op" id="2637392">(</span><span class="ident" id="2637393"><a href="/net/ipsock_posix.go.html#2637227">s</a></span><span class="op" id="2637394">,</span>&nbsp;<span class="ident" id="2637396"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637403">.</span><span class="ident" id="2637404">IPPROTO_IPV6</span><span class="op" id="2637416">,</span>&nbsp;<span class="ident" id="2637418"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637425">.</span><span class="ident" id="2637426">IPV6_V6ONLY</span><span class="op" id="2637437">,</span>&nbsp;<span class="ident" id="2637439"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span><span class="op" id="2637445">[</span><span class="ident" id="2637446"><a href="/net/ipsock_posix.go.html#2637205">i</a></span><span class="op" id="2637447">]</span><span class="op" id="2637448">.</span><span class="ident" id="2637449">value</span><span class="op" id="2637454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2637458">sa</span><span class="op" id="2637460">,</span>&nbsp;<span class="ident" id="2637462"><a href="/net/ipsock_posix.go.html#2637230">err</a></span>&nbsp;<span class="op" id="2637466">:=</span>&nbsp;<span class="ident" id="2637469"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span><span class="op" id="2637475">[</span><span class="ident" id="2637476"><a href="/net/ipsock_posix.go.html#2637205">i</a></span><span class="op" id="2637477">]</span><span class="op" id="2637478">.</span><span class="ident" id="2637479">laddr</span><span class="op" id="2637484">.</span><span class="ident" id="2637485">sockaddr</span><span class="op" id="2637493">(</span><span class="ident" id="2637494"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637501">.</span><span class="ident" id="2637502">AF_INET6</span><span class="op" id="2637510">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637514">if</span>&nbsp;<span class="ident" id="2637517"><a href="/net/ipsock_posix.go.html#2637230">err</a></span>&nbsp;<span class="op" id="2637521">!=</span>&nbsp;<span class="ident" id="2637524">nil</span>&nbsp;<span class="op" id="2637528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637533">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637548">if</span>&nbsp;<span class="ident" id="2637551">err</span>&nbsp;<span class="op" id="2637555">:=</span>&nbsp;<span class="ident" id="2637558"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2637565">.</span><span class="ident" id="2637566">Bind</span><span class="op" id="2637570">(</span><span class="ident" id="2637571"><a href="/net/ipsock_posix.go.html#2637227">s</a></span><span class="op" id="2637572">,</span>&nbsp;<span class="ident" id="2637574"><a href="/net/ipsock_posix.go.html#2637458">sa</a></span><span class="op" id="2637576">)</span><span class="op" id="2637577">;</span>&nbsp;<span class="ident" id="2637579"><a href="/net/ipsock_posix.go.html#2637551">err</a></span>&nbsp;<span class="op" id="2637583">!=</span>&nbsp;<span class="ident" id="2637586">nil</span>&nbsp;<span class="op" id="2637590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637595">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2637610"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span><span class="op" id="2637616">[</span><span class="ident" id="2637617"><a href="/net/ipsock_posix.go.html#2637205">i</a></span><span class="op" id="2637618">]</span><span class="op" id="2637619">.</span><span class="ident" id="2637620">ok</span>&nbsp;<span class="op" id="2637623">=</span>&nbsp;<span class="ident" id="2637625">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2637631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2637635">return</span>&nbsp;<span class="ident" id="2637642"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span><span class="op" id="2637648">[</span><span class="num" id="2637649">0</span><span class="op" id="2637650">]</span><span class="op" id="2637651">.</span><span class="ident" id="2637652">ok</span><span class="op" id="2637654">,</span>&nbsp;<span class="ident" id="2637656"><a href="/net/ipsock_posix.go.html#2636937">probes</a></span><span class="op" id="2637662">[</span><span class="num" id="2637663">1</span><span class="op" id="2637664">]</span><span class="op" id="2637665">.</span><span class="ident" id="2637666">ok</span><br>
<span class="lineno">70</span><span class="op" id="2637669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2637672">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2637736">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="2637798">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="2637862">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2637924">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="2637990">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="2638054">//</span><br>
<span class="lineno"></span><span class="comment" id="2638057">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="2638094">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="2638154">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="2638213">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="2638269">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="2638328">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="2638379">//</span><br>
<span class="lineno"></span><span class="comment" id="2638382">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2638430">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="2638444">//</span><br>
<span class="lineno"></span><span class="comment" id="2638447">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="2638492">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="2638551">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="2638609">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="2638669">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="2638692">//</span><br>
<span class="lineno">95</span><span class="comment" id="2638695">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2638750">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="2638803">//</span><br>
<span class="lineno"></span><span class="comment" id="2638806">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2638858">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="2638919">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="2638930">//</span><br>
<span class="lineno"></span><span class="comment" id="2638933">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="2639001">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="2639068">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="2639102">//</span><br>
<span class="lineno"></span><span class="comment" id="2639105">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="2639173">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="2639234">func</span>&nbsp;<span class="ident" id="2639239">favoriteAddrFamily</span><span class="op" id="2639257">(</span><span class="ident" id="2639258">net</span>&nbsp;<span class="builtintype" id="2639262">string</span><span class="op" id="2639268">,</span>&nbsp;<span class="ident" id="2639270">laddr</span><span class="op" id="2639275">,</span>&nbsp;<span class="ident" id="2639277">raddr</span>&nbsp;<span class="ident" id="2639283"><a href="/net/sock_posix.go.html#2679308">sockaddr</a></span><span class="op" id="2639291">,</span>&nbsp;<span class="ident" id="2639293">mode</span>&nbsp;<span class="builtintype" id="2639298">string</span><span class="op" id="2639304">)</span>&nbsp;<span class="op" id="2639306">(</span><span class="ident" id="2639307">family</span>&nbsp;<span class="builtintype" id="2639314">int</span><span class="op" id="2639317">,</span>&nbsp;<span class="ident" id="2639319">ipv6only</span>&nbsp;<span class="builtintype" id="2639328">bool</span><span class="op" id="2639332">)</span>&nbsp;<span class="op" id="2639334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639337">switch</span>&nbsp;<span class="ident" id="2639344"><a href="/net/ipsock_posix.go.html#2639258">net</a></span><span class="op" id="2639347">[</span><span class="builtinfunc" id="2639348">len</span><span class="op" id="2639351">(</span><span class="ident" id="2639352"><a href="/net/ipsock_posix.go.html#2639258">net</a></span><span class="op" id="2639355">)</span><span class="op" id="2639356">-</span><span class="num" id="2639357">1</span><span class="op" id="2639358">]</span>&nbsp;<span class="op" id="2639360">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639363">case</span>&nbsp;<span class="string" id="2639368">&#39;4&#39;</span><span class="op" id="2639371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639375">return</span>&nbsp;<span class="ident" id="2639382"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639389">.</span><span class="ident" id="2639390">AF_INET</span><span class="op" id="2639397">,</span>&nbsp;<span class="ident" id="2639399">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639406">case</span>&nbsp;<span class="string" id="2639411">&#39;6&#39;</span><span class="op" id="2639414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639418">return</span>&nbsp;<span class="ident" id="2639425"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639432">.</span><span class="ident" id="2639433">AF_INET6</span><span class="op" id="2639441">,</span>&nbsp;<span class="ident" id="2639443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639449">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639453">if</span>&nbsp;<span class="ident" id="2639456"><a href="/net/ipsock_posix.go.html#2639293">mode</a></span>&nbsp;<span class="op" id="2639461">==</span>&nbsp;<span class="string" id="2639464">&#34;listen&#34;</span>&nbsp;<span class="op" id="2639473">&amp;&amp;</span>&nbsp;<span class="op" id="2639476">(</span><span class="ident" id="2639477"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span>&nbsp;<span class="op" id="2639483">==</span>&nbsp;<span class="ident" id="2639486">nil</span>&nbsp;<span class="op" id="2639490">||</span>&nbsp;<span class="ident" id="2639493"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span><span class="op" id="2639498">.</span><span class="ident" id="2639499">isWildcard</span><span class="op" id="2639509">(</span><span class="op" id="2639510">)</span><span class="op" id="2639511">)</span>&nbsp;<span class="op" id="2639513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639517">if</span>&nbsp;<span class="ident" id="2639520"><a href="/net/ipsock.go.html#2627970">supportsIPv4map</a></span>&nbsp;<span class="op" id="2639536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639541">return</span>&nbsp;<span class="ident" id="2639548"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639555">.</span><span class="ident" id="2639556">AF_INET6</span><span class="op" id="2639564">,</span>&nbsp;<span class="ident" id="2639566">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639574">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639578">if</span>&nbsp;<span class="ident" id="2639581"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span>&nbsp;<span class="op" id="2639587">==</span>&nbsp;<span class="ident" id="2639590">nil</span>&nbsp;<span class="op" id="2639594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639599">return</span>&nbsp;<span class="ident" id="2639606"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639613">.</span><span class="ident" id="2639614">AF_INET</span><span class="op" id="2639621">,</span>&nbsp;<span class="ident" id="2639623">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639635">return</span>&nbsp;<span class="ident" id="2639642"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span><span class="op" id="2639647">.</span><span class="ident" id="2639648">family</span><span class="op" id="2639654">(</span><span class="op" id="2639655">)</span><span class="op" id="2639656">,</span>&nbsp;<span class="ident" id="2639658">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639665">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639669">if</span>&nbsp;<span class="op" id="2639672">(</span><span class="ident" id="2639673"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span>&nbsp;<span class="op" id="2639679">==</span>&nbsp;<span class="ident" id="2639682">nil</span>&nbsp;<span class="op" id="2639686">||</span>&nbsp;<span class="ident" id="2639689"><a href="/net/ipsock_posix.go.html#2639270">laddr</a></span><span class="op" id="2639694">.</span><span class="ident" id="2639695">family</span><span class="op" id="2639701">(</span><span class="op" id="2639702">)</span>&nbsp;<span class="op" id="2639704">==</span>&nbsp;<span class="ident" id="2639707"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639714">.</span><span class="ident" id="2639715">AF_INET</span><span class="op" id="2639722">)</span>&nbsp;<span class="op" id="2639724">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639729">(</span><span class="ident" id="2639730"><a href="/net/ipsock_posix.go.html#2639277">raddr</a></span>&nbsp;<span class="op" id="2639736">==</span>&nbsp;<span class="ident" id="2639739">nil</span>&nbsp;<span class="op" id="2639743">||</span>&nbsp;<span class="ident" id="2639746"><a href="/net/ipsock_posix.go.html#2639277">raddr</a></span><span class="op" id="2639751">.</span><span class="ident" id="2639752">family</span><span class="op" id="2639758">(</span><span class="op" id="2639759">)</span>&nbsp;<span class="op" id="2639761">==</span>&nbsp;<span class="ident" id="2639764"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639771">.</span><span class="ident" id="2639772">AF_INET</span><span class="op" id="2639779">)</span>&nbsp;<span class="op" id="2639781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639785">return</span>&nbsp;<span class="ident" id="2639792"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639799">.</span><span class="ident" id="2639800">AF_INET</span><span class="op" id="2639807">,</span>&nbsp;<span class="ident" id="2639809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2639816">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2639819">return</span>&nbsp;<span class="ident" id="2639826"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2639833">.</span><span class="ident" id="2639834">AF_INET6</span><span class="op" id="2639842">,</span>&nbsp;<span class="ident" id="2639844">false</span><br>
<span class="lineno"></span><span class="op" id="2639850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2639853">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="2639889">func</span>&nbsp;<span class="ident" id="2639894">internetSocket</span><span class="op" id="2639908">(</span><span class="ident" id="2639909">net</span>&nbsp;<span class="builtintype" id="2639913">string</span><span class="op" id="2639919">,</span>&nbsp;<span class="ident" id="2639921">laddr</span><span class="op" id="2639926">,</span>&nbsp;<span class="ident" id="2639928">raddr</span>&nbsp;<span class="ident" id="2639934"><a href="/net/sock_posix.go.html#2679308">sockaddr</a></span><span class="op" id="2639942">,</span>&nbsp;<span class="ident" id="2639944">deadline</span>&nbsp;<span class="ident" id="2639953"><a href="/net/ipsock_posix.go.html#2635871">time</a></span><span class="op" id="2639957">.</span><span class="ident" id="2639958">Time</span><span class="op" id="2639962">,</span>&nbsp;<span class="ident" id="2639964">sotype</span><span class="op" id="2639970">,</span>&nbsp;<span class="ident" id="2639972">proto</span>&nbsp;<span class="builtintype" id="2639978">int</span><span class="op" id="2639981">,</span>&nbsp;<span class="ident" id="2639983">mode</span>&nbsp;<span class="builtintype" id="2639988">string</span><span class="op" id="2639994">)</span>&nbsp;<span class="op" id="2639996">(</span><span class="ident" id="2639997">fd</span>&nbsp;<span class="op" id="2640000">*</span><span class="ident" id="2640001"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2640006">,</span>&nbsp;<span class="ident" id="2640008">err</span>&nbsp;<span class="builtintype" id="2640012">error</span><span class="op" id="2640017">)</span>&nbsp;<span class="op" id="2640019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640022">family</span><span class="op" id="2640028">,</span>&nbsp;<span class="ident" id="2640030">ipv6only</span>&nbsp;<span class="op" id="2640039">:=</span>&nbsp;<span class="ident" id="2640042"><a href="/net/ipsock_posix.go.html#2639239">favoriteAddrFamily</a></span><span class="op" id="2640060">(</span><span class="ident" id="2640061"><a href="/net/ipsock_posix.go.html#2639909">net</a></span><span class="op" id="2640064">,</span>&nbsp;<span class="ident" id="2640066"><a href="/net/ipsock_posix.go.html#2639921">laddr</a></span><span class="op" id="2640071">,</span>&nbsp;<span class="ident" id="2640073"><a href="/net/ipsock_posix.go.html#2639928">raddr</a></span><span class="op" id="2640078">,</span>&nbsp;<span class="ident" id="2640080"><a href="/net/ipsock_posix.go.html#2639983">mode</a></span><span class="op" id="2640084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640087">return</span>&nbsp;<span class="ident" id="2640094"><a href="/net/sock_posix.go.html#2679868">socket</a></span><span class="op" id="2640100">(</span><span class="ident" id="2640101"><a href="/net/ipsock_posix.go.html#2639909">net</a></span><span class="op" id="2640104">,</span>&nbsp;<span class="ident" id="2640106"><a href="/net/ipsock_posix.go.html#2640022">family</a></span><span class="op" id="2640112">,</span>&nbsp;<span class="ident" id="2640114"><a href="/net/ipsock_posix.go.html#2639964">sotype</a></span><span class="op" id="2640120">,</span>&nbsp;<span class="ident" id="2640122"><a href="/net/ipsock_posix.go.html#2639972">proto</a></span><span class="op" id="2640127">,</span>&nbsp;<span class="ident" id="2640129"><a href="/net/ipsock_posix.go.html#2640030">ipv6only</a></span><span class="op" id="2640137">,</span>&nbsp;<span class="ident" id="2640139"><a href="/net/ipsock_posix.go.html#2639921">laddr</a></span><span class="op" id="2640144">,</span>&nbsp;<span class="ident" id="2640146"><a href="/net/ipsock_posix.go.html#2639928">raddr</a></span><span class="op" id="2640151">,</span>&nbsp;<span class="ident" id="2640153"><a href="/net/ipsock_posix.go.html#2639944">deadline</a></span><span class="op" id="2640161">)</span><br>
<span class="lineno"></span><span class="op" id="2640163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="2640166">func</span>&nbsp;<span class="ident" id="2640171">ipToSockaddr</span><span class="op" id="2640183">(</span><span class="ident" id="2640184">family</span>&nbsp;<span class="builtintype" id="2640191">int</span><span class="op" id="2640194">,</span>&nbsp;<span class="ident" id="2640196">ip</span>&nbsp;<span class="ident" id="2640199"><a href="/net/ip.go.html#2604330">IP</a></span><span class="op" id="2640201">,</span>&nbsp;<span class="ident" id="2640203">port</span>&nbsp;<span class="builtintype" id="2640208">int</span><span class="op" id="2640211">,</span>&nbsp;<span class="ident" id="2640213">zone</span>&nbsp;<span class="builtintype" id="2640218">string</span><span class="op" id="2640224">)</span>&nbsp;<span class="op" id="2640226">(</span><span class="ident" id="2640227"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2640234">.</span><span class="ident" id="2640235">Sockaddr</span><span class="op" id="2640243">,</span>&nbsp;<span class="builtintype" id="2640245">error</span><span class="op" id="2640250">)</span>&nbsp;<span class="op" id="2640252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640255">switch</span>&nbsp;<span class="ident" id="2640262"><a href="/net/ipsock_posix.go.html#2640184">family</a></span>&nbsp;<span class="op" id="2640269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640272">case</span>&nbsp;<span class="ident" id="2640277"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2640284">.</span><span class="ident" id="2640285">AF_INET</span><span class="op" id="2640292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640296">if</span>&nbsp;<span class="builtinfunc" id="2640299">len</span><span class="op" id="2640302">(</span><span class="ident" id="2640303"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640305">)</span>&nbsp;<span class="op" id="2640307">==</span>&nbsp;<span class="num" id="2640310">0</span>&nbsp;<span class="op" id="2640312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640317"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640320">=</span>&nbsp;<span class="ident" id="2640322"><a href="/net/ip.go.html#2605716">IPv4zero</a></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640337">if</span>&nbsp;<span class="ident" id="2640340"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640343">=</span>&nbsp;<span class="ident" id="2640345"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640347">.</span><span class="ident" id="2640348">To4</span><span class="op" id="2640351">(</span><span class="op" id="2640352">)</span><span class="op" id="2640353">;</span>&nbsp;<span class="ident" id="2640355"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640358">==</span>&nbsp;<span class="ident" id="2640361">nil</span>&nbsp;<span class="op" id="2640365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640370">return</span>&nbsp;<span class="ident" id="2640377">nil</span><span class="op" id="2640380">,</span>&nbsp;<span class="ident" id="2640382"><a href="/net/net.go.html#2661256">InvalidAddrError</a></span><span class="op" id="2640398">(</span><span class="string" id="2640399">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="2640417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640425">sa</span>&nbsp;<span class="op" id="2640428">:=</span>&nbsp;<span class="builtinfunc" id="2640431">new</span><span class="op" id="2640434">(</span><span class="ident" id="2640435"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2640442">.</span><span class="ident" id="2640443">SockaddrInet4</span><span class="op" id="2640456">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640460">for</span>&nbsp;<span class="ident" id="2640464">i</span>&nbsp;<span class="op" id="2640466">:=</span>&nbsp;<span class="num" id="2640469">0</span><span class="op" id="2640470">;</span>&nbsp;<span class="ident" id="2640472"><a href="/net/ipsock_posix.go.html#2640464">i</a></span>&nbsp;<span class="op" id="2640474">&lt;</span>&nbsp;<span class="ident" id="2640476"><a href="/net/ip.go.html#2603910">IPv4len</a></span><span class="op" id="2640483">;</span>&nbsp;<span class="ident" id="2640485"><a href="/net/ipsock_posix.go.html#2640464">i</a></span><span class="op" id="2640486">++</span>&nbsp;<span class="op" id="2640489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640494"><a href="/net/ipsock_posix.go.html#2640425">sa</a></span><span class="op" id="2640496">.</span><span class="ident" id="2640497">Addr</span><span class="op" id="2640501">[</span><span class="ident" id="2640502"><a href="/net/ipsock_posix.go.html#2640464">i</a></span><span class="op" id="2640503">]</span>&nbsp;<span class="op" id="2640505">=</span>&nbsp;<span class="ident" id="2640507"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640509">[</span><span class="ident" id="2640510"><a href="/net/ipsock_posix.go.html#2640464">i</a></span><span class="op" id="2640511">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640519"><a href="/net/ipsock_posix.go.html#2640425">sa</a></span><span class="op" id="2640521">.</span><span class="ident" id="2640522">Port</span>&nbsp;<span class="op" id="2640527">=</span>&nbsp;<span class="ident" id="2640529"><a href="/net/ipsock_posix.go.html#2640203">port</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640536">return</span>&nbsp;<span class="ident" id="2640543"><a href="/net/ipsock_posix.go.html#2640425">sa</a></span><span class="op" id="2640545">,</span>&nbsp;<span class="ident" id="2640547">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640552">case</span>&nbsp;<span class="ident" id="2640557"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2640564">.</span><span class="ident" id="2640565">AF_INET6</span><span class="op" id="2640573">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640577">if</span>&nbsp;<span class="builtinfunc" id="2640580">len</span><span class="op" id="2640583">(</span><span class="ident" id="2640584"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640586">)</span>&nbsp;<span class="op" id="2640588">==</span>&nbsp;<span class="num" id="2640591">0</span>&nbsp;<span class="op" id="2640593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640598"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640601">=</span>&nbsp;<span class="ident" id="2640603"><a href="/net/ip.go.html#2605809">IPv6zero</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2640618">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2640693">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2640764">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640835">if</span>&nbsp;<span class="ident" id="2640838"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640840">.</span><span class="ident" id="2640841">Equal</span><span class="op" id="2640846">(</span><span class="ident" id="2640847"><a href="/net/ip.go.html#2605716">IPv4zero</a></span><span class="op" id="2640855">)</span>&nbsp;<span class="op" id="2640857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640862"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640865">=</span>&nbsp;<span class="ident" id="2640867"><a href="/net/ip.go.html#2605809">IPv6zero</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640878">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640882">if</span>&nbsp;<span class="ident" id="2640885"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640888">=</span>&nbsp;<span class="ident" id="2640890"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2640892">.</span><span class="ident" id="2640893">To16</span><span class="op" id="2640897">(</span><span class="op" id="2640898">)</span><span class="op" id="2640899">;</span>&nbsp;<span class="ident" id="2640901"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span>&nbsp;<span class="op" id="2640904">==</span>&nbsp;<span class="ident" id="2640907">nil</span>&nbsp;<span class="op" id="2640911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640916">return</span>&nbsp;<span class="ident" id="2640923">nil</span><span class="op" id="2640926">,</span>&nbsp;<span class="ident" id="2640928"><a href="/net/net.go.html#2661256">InvalidAddrError</a></span><span class="op" id="2640944">(</span><span class="string" id="2640945">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="2640963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2640967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640971">sa</span>&nbsp;<span class="op" id="2640974">:=</span>&nbsp;<span class="builtinfunc" id="2640977">new</span><span class="op" id="2640980">(</span><span class="ident" id="2640981"><a href="/net/ipsock_posix.go.html#2635860">syscall</a></span><span class="op" id="2640988">.</span><span class="ident" id="2640989">SockaddrInet6</span><span class="op" id="2641002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641006">for</span>&nbsp;<span class="ident" id="2641010">i</span>&nbsp;<span class="op" id="2641012">:=</span>&nbsp;<span class="num" id="2641015">0</span><span class="op" id="2641016">;</span>&nbsp;<span class="ident" id="2641018"><a href="/net/ipsock_posix.go.html#2641010">i</a></span>&nbsp;<span class="op" id="2641020">&lt;</span>&nbsp;<span class="ident" id="2641022"><a href="/net/ip.go.html#2603923">IPv6len</a></span><span class="op" id="2641029">;</span>&nbsp;<span class="ident" id="2641031"><a href="/net/ipsock_posix.go.html#2641010">i</a></span><span class="op" id="2641032">++</span>&nbsp;<span class="op" id="2641035">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641040"><a href="/net/ipsock_posix.go.html#2640971">sa</a></span><span class="op" id="2641042">.</span><span class="ident" id="2641043">Addr</span><span class="op" id="2641047">[</span><span class="ident" id="2641048"><a href="/net/ipsock_posix.go.html#2641010">i</a></span><span class="op" id="2641049">]</span>&nbsp;<span class="op" id="2641051">=</span>&nbsp;<span class="ident" id="2641053"><a href="/net/ipsock_posix.go.html#2640196">ip</a></span><span class="op" id="2641055">[</span><span class="ident" id="2641056"><a href="/net/ipsock_posix.go.html#2641010">i</a></span><span class="op" id="2641057">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641065"><a href="/net/ipsock_posix.go.html#2640971">sa</a></span><span class="op" id="2641067">.</span><span class="ident" id="2641068">Port</span>&nbsp;<span class="op" id="2641073">=</span>&nbsp;<span class="ident" id="2641075"><a href="/net/ipsock_posix.go.html#2640203">port</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641082"><a href="/net/ipsock_posix.go.html#2640971">sa</a></span><span class="op" id="2641084">.</span><span class="ident" id="2641085">ZoneId</span>&nbsp;<span class="op" id="2641092">=</span>&nbsp;<span class="builtintype" id="2641094">uint32</span><span class="op" id="2641100">(</span><span class="ident" id="2641101"><a href="/net/ipsock.go.html#2635378">zoneToInt</a></span><span class="op" id="2641110">(</span><span class="ident" id="2641111"><a href="/net/ipsock_posix.go.html#2640213">zone</a></span><span class="op" id="2641115">)</span><span class="op" id="2641116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641120">return</span>&nbsp;<span class="ident" id="2641127"><a href="/net/ipsock_posix.go.html#2640971">sa</a></span><span class="op" id="2641129">,</span>&nbsp;<span class="ident" id="2641131">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641139">return</span>&nbsp;<span class="ident" id="2641146">nil</span><span class="op" id="2641149">,</span>&nbsp;<span class="ident" id="2641151"><a href="/net/net.go.html#2661256">InvalidAddrError</a></span><span class="op" id="2641167">(</span><span class="string" id="2641168">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="2641194">)</span><br>
<span class="lineno"></span><span class="op" id="2641196">}</span>
</div>
</body>
</html>
