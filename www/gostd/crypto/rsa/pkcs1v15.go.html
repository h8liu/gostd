<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3908922">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3908977">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3909031">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3909082">package</span>&nbsp;<span class="ident" id="3909090">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3909095">import</span>&nbsp;<span class="op" id="3909102">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3909105">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3909115">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3909132">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3909142">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3909148">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3909159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="3909162">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3909240">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3909336">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3909423">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="3909502">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="3909550">func</span>&nbsp;<span class="ident" id="3909555">EncryptPKCS1v15</span><span class="op" id="3909570">(</span><span class="ident" id="3909571">rand</span>&nbsp;<span class="ident" id="3909576">io</span><span class="op" id="3909578">.</span><span class="ident" id="3909579">Reader</span><span class="op" id="3909585">,</span>&nbsp;<span class="ident" id="3909587">pub</span>&nbsp;<span class="op" id="3909591">*</span><span class="ident" id="3909592">PublicKey</span><span class="op" id="3909601">,</span>&nbsp;<span class="ident" id="3909603">msg</span>&nbsp;<span class="op" id="3909607">[</span><span class="op" id="3909608">]</span><span class="builtintype" id="3909609">byte</span><span class="op" id="3909613">)</span>&nbsp;<span class="op" id="3909615">(</span><span class="ident" id="3909616">out</span>&nbsp;<span class="op" id="3909620">[</span><span class="op" id="3909621">]</span><span class="builtintype" id="3909622">byte</span><span class="op" id="3909626">,</span>&nbsp;<span class="ident" id="3909628">err</span>&nbsp;<span class="builtintype" id="3909632">error</span><span class="op" id="3909637">)</span>&nbsp;<span class="op" id="3909639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909642">if</span>&nbsp;<span class="ident" id="3909645">err</span>&nbsp;<span class="op" id="3909649">:=</span>&nbsp;<span class="ident" id="3909652">checkPub</span><span class="op" id="3909660">(</span><span class="ident" id="3909661">pub</span><span class="op" id="3909664">)</span><span class="op" id="3909665">;</span>&nbsp;<span class="ident" id="3909667">err</span>&nbsp;<span class="op" id="3909671">!=</span>&nbsp;<span class="ident" id="3909674">nil</span>&nbsp;<span class="op" id="3909678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909682">return</span>&nbsp;<span class="ident" id="3909689">nil</span><span class="op" id="3909692">,</span>&nbsp;<span class="ident" id="3909694">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909699">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909702">k</span>&nbsp;<span class="op" id="3909704">:=</span>&nbsp;<span class="op" id="3909707">(</span><span class="ident" id="3909708">pub</span><span class="op" id="3909711">.</span><span class="ident" id="3909712">N</span><span class="op" id="3909713">.</span><span class="ident" id="3909714">BitLen</span><span class="op" id="3909720">(</span><span class="op" id="3909721">)</span>&nbsp;<span class="op" id="3909723">+</span>&nbsp;<span class="num" id="3909725">7</span><span class="op" id="3909726">)</span>&nbsp;<span class="op" id="3909728">/</span>&nbsp;<span class="num" id="3909730">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909733">if</span>&nbsp;<span class="builtinfunc" id="3909736">len</span><span class="op" id="3909739">(</span><span class="ident" id="3909740">msg</span><span class="op" id="3909743">)</span>&nbsp;<span class="op" id="3909745">&gt;</span>&nbsp;<span class="ident" id="3909747">k</span><span class="op" id="3909748">-</span><span class="num" id="3909749">11</span>&nbsp;<span class="op" id="3909752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909756">err</span>&nbsp;<span class="op" id="3909760">=</span>&nbsp;<span class="ident" id="3909762">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909782">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909790">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909794">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909835">em</span>&nbsp;<span class="op" id="3909838">:=</span>&nbsp;<span class="builtinfunc" id="3909841">make</span><span class="op" id="3909845">(</span><span class="op" id="3909846">[</span><span class="op" id="3909847">]</span><span class="builtintype" id="3909848">byte</span><span class="op" id="3909852">,</span>&nbsp;<span class="ident" id="3909854">k</span><span class="op" id="3909855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909858">em</span><span class="op" id="3909860">[</span><span class="num" id="3909861">1</span><span class="op" id="3909862">]</span>&nbsp;<span class="op" id="3909864">=</span>&nbsp;<span class="num" id="3909866">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909869">ps</span><span class="op" id="3909871">,</span>&nbsp;<span class="ident" id="3909873">mm</span>&nbsp;<span class="op" id="3909876">:=</span>&nbsp;<span class="ident" id="3909879">em</span><span class="op" id="3909881">[</span><span class="num" id="3909882">2</span><span class="op" id="3909883">:</span><span class="builtinfunc" id="3909884">len</span><span class="op" id="3909887">(</span><span class="ident" id="3909888">em</span><span class="op" id="3909890">)</span><span class="op" id="3909891">-</span><span class="builtinfunc" id="3909892">len</span><span class="op" id="3909895">(</span><span class="ident" id="3909896">msg</span><span class="op" id="3909899">)</span><span class="op" id="3909900">-</span><span class="num" id="3909901">1</span><span class="op" id="3909902">]</span><span class="op" id="3909903">,</span>&nbsp;<span class="ident" id="3909905">em</span><span class="op" id="3909907">[</span><span class="builtinfunc" id="3909908">len</span><span class="op" id="3909911">(</span><span class="ident" id="3909912">em</span><span class="op" id="3909914">)</span><span class="op" id="3909915">-</span><span class="builtinfunc" id="3909916">len</span><span class="op" id="3909919">(</span><span class="ident" id="3909920">msg</span><span class="op" id="3909923">)</span><span class="op" id="3909924">:</span><span class="op" id="3909925">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909928">err</span>&nbsp;<span class="op" id="3909932">=</span>&nbsp;<span class="ident" id="3909934">nonZeroRandomBytes</span><span class="op" id="3909952">(</span><span class="ident" id="3909953">ps</span><span class="op" id="3909955">,</span>&nbsp;<span class="ident" id="3909957">rand</span><span class="op" id="3909961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909964">if</span>&nbsp;<span class="ident" id="3909967">err</span>&nbsp;<span class="op" id="3909971">!=</span>&nbsp;<span class="ident" id="3909974">nil</span>&nbsp;<span class="op" id="3909978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909982">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909993">em</span><span class="op" id="3909995">[</span><span class="builtinfunc" id="3909996">len</span><span class="op" id="3909999">(</span><span class="ident" id="3910000">em</span><span class="op" id="3910002">)</span><span class="op" id="3910003">-</span><span class="builtinfunc" id="3910004">len</span><span class="op" id="3910007">(</span><span class="ident" id="3910008">msg</span><span class="op" id="3910011">)</span><span class="op" id="3910012">-</span><span class="num" id="3910013">1</span><span class="op" id="3910014">]</span>&nbsp;<span class="op" id="3910016">=</span>&nbsp;<span class="num" id="3910018">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3910021">copy</span><span class="op" id="3910025">(</span><span class="ident" id="3910026">mm</span><span class="op" id="3910028">,</span>&nbsp;<span class="ident" id="3910030">msg</span><span class="op" id="3910033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910037">m</span>&nbsp;<span class="op" id="3910039">:=</span>&nbsp;<span class="builtinfunc" id="3910042">new</span><span class="op" id="3910045">(</span><span class="ident" id="3910046">big</span><span class="op" id="3910049">.</span><span class="ident" id="3910050">Int</span><span class="op" id="3910053">)</span><span class="op" id="3910054">.</span><span class="ident" id="3910055">SetBytes</span><span class="op" id="3910063">(</span><span class="ident" id="3910064">em</span><span class="op" id="3910066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910069">c</span>&nbsp;<span class="op" id="3910071">:=</span>&nbsp;<span class="ident" id="3910074">encrypt</span><span class="op" id="3910081">(</span><span class="builtinfunc" id="3910082">new</span><span class="op" id="3910085">(</span><span class="ident" id="3910086">big</span><span class="op" id="3910089">.</span><span class="ident" id="3910090">Int</span><span class="op" id="3910093">)</span><span class="op" id="3910094">,</span>&nbsp;<span class="ident" id="3910096">pub</span><span class="op" id="3910099">,</span>&nbsp;<span class="ident" id="3910101">m</span><span class="op" id="3910102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910106">copyWithLeftPad</span><span class="op" id="3910121">(</span><span class="ident" id="3910122">em</span><span class="op" id="3910124">,</span>&nbsp;<span class="ident" id="3910126">c</span><span class="op" id="3910127">.</span><span class="ident" id="3910128">Bytes</span><span class="op" id="3910133">(</span><span class="op" id="3910134">)</span><span class="op" id="3910135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910138">out</span>&nbsp;<span class="op" id="3910142">=</span>&nbsp;<span class="ident" id="3910144">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910148">return</span><br>
<span class="lineno"></span><span class="op" id="3910155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3910158">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3910249">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="3910327">func</span>&nbsp;<span class="ident" id="3910332">DecryptPKCS1v15</span><span class="op" id="3910347">(</span><span class="ident" id="3910348">rand</span>&nbsp;<span class="ident" id="3910353">io</span><span class="op" id="3910355">.</span><span class="ident" id="3910356">Reader</span><span class="op" id="3910362">,</span>&nbsp;<span class="ident" id="3910364">priv</span>&nbsp;<span class="op" id="3910369">*</span><span class="ident" id="3910370">PrivateKey</span><span class="op" id="3910380">,</span>&nbsp;<span class="ident" id="3910382">ciphertext</span>&nbsp;<span class="op" id="3910393">[</span><span class="op" id="3910394">]</span><span class="builtintype" id="3910395">byte</span><span class="op" id="3910399">)</span>&nbsp;<span class="op" id="3910401">(</span><span class="ident" id="3910402">out</span>&nbsp;<span class="op" id="3910406">[</span><span class="op" id="3910407">]</span><span class="builtintype" id="3910408">byte</span><span class="op" id="3910412">,</span>&nbsp;<span class="ident" id="3910414">err</span>&nbsp;<span class="builtintype" id="3910418">error</span><span class="op" id="3910423">)</span>&nbsp;<span class="op" id="3910425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910428">if</span>&nbsp;<span class="ident" id="3910431">err</span>&nbsp;<span class="op" id="3910435">:=</span>&nbsp;<span class="ident" id="3910438">checkPub</span><span class="op" id="3910446">(</span><span class="op" id="3910447">&amp;</span><span class="ident" id="3910448">priv</span><span class="op" id="3910452">.</span><span class="ident" id="3910453">PublicKey</span><span class="op" id="3910462">)</span><span class="op" id="3910463">;</span>&nbsp;<span class="ident" id="3910465">err</span>&nbsp;<span class="op" id="3910469">!=</span>&nbsp;<span class="ident" id="3910472">nil</span>&nbsp;<span class="op" id="3910476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910480">return</span>&nbsp;<span class="ident" id="3910487">nil</span><span class="op" id="3910490">,</span>&nbsp;<span class="ident" id="3910492">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910500">valid</span><span class="op" id="3910505">,</span>&nbsp;<span class="ident" id="3910507">out</span><span class="op" id="3910510">,</span>&nbsp;<span class="ident" id="3910512">index</span><span class="op" id="3910517">,</span>&nbsp;<span class="ident" id="3910519">err</span>&nbsp;<span class="op" id="3910523">:=</span>&nbsp;<span class="ident" id="3910526">decryptPKCS1v15</span><span class="op" id="3910541">(</span><span class="ident" id="3910542">rand</span><span class="op" id="3910546">,</span>&nbsp;<span class="ident" id="3910548">priv</span><span class="op" id="3910552">,</span>&nbsp;<span class="ident" id="3910554">ciphertext</span><span class="op" id="3910564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910567">if</span>&nbsp;<span class="ident" id="3910570">err</span>&nbsp;<span class="op" id="3910574">!=</span>&nbsp;<span class="ident" id="3910577">nil</span>&nbsp;<span class="op" id="3910581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910585">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910593">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910596">if</span>&nbsp;<span class="ident" id="3910599">valid</span>&nbsp;<span class="op" id="3910605">==</span>&nbsp;<span class="num" id="3910608">0</span>&nbsp;<span class="op" id="3910610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910614">return</span>&nbsp;<span class="ident" id="3910621">nil</span><span class="op" id="3910624">,</span>&nbsp;<span class="ident" id="3910626">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910644">out</span>&nbsp;<span class="op" id="3910648">=</span>&nbsp;<span class="ident" id="3910650">out</span><span class="op" id="3910653">[</span><span class="ident" id="3910654">index</span><span class="op" id="3910659">:</span><span class="op" id="3910660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910663">return</span><br>
<span class="lineno">65</span><span class="op" id="3910670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3910673">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3910776">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="3910854">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="3910925">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3910998">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="3911078">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="3911157">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="3911230">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="3911308">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="3911387">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="3911411">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="3911481">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="3911561">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="3911578">func</span>&nbsp;<span class="ident" id="3911583">DecryptPKCS1v15SessionKey</span><span class="op" id="3911608">(</span><span class="ident" id="3911609">rand</span>&nbsp;<span class="ident" id="3911614">io</span><span class="op" id="3911616">.</span><span class="ident" id="3911617">Reader</span><span class="op" id="3911623">,</span>&nbsp;<span class="ident" id="3911625">priv</span>&nbsp;<span class="op" id="3911630">*</span><span class="ident" id="3911631">PrivateKey</span><span class="op" id="3911641">,</span>&nbsp;<span class="ident" id="3911643">ciphertext</span>&nbsp;<span class="op" id="3911654">[</span><span class="op" id="3911655">]</span><span class="builtintype" id="3911656">byte</span><span class="op" id="3911660">,</span>&nbsp;<span class="ident" id="3911662">key</span>&nbsp;<span class="op" id="3911666">[</span><span class="op" id="3911667">]</span><span class="builtintype" id="3911668">byte</span><span class="op" id="3911672">)</span>&nbsp;<span class="op" id="3911674">(</span><span class="ident" id="3911675">err</span>&nbsp;<span class="builtintype" id="3911679">error</span><span class="op" id="3911684">)</span>&nbsp;<span class="op" id="3911686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911689">if</span>&nbsp;<span class="ident" id="3911692">err</span>&nbsp;<span class="op" id="3911696">:=</span>&nbsp;<span class="ident" id="3911699">checkPub</span><span class="op" id="3911707">(</span><span class="op" id="3911708">&amp;</span><span class="ident" id="3911709">priv</span><span class="op" id="3911713">.</span><span class="ident" id="3911714">PublicKey</span><span class="op" id="3911723">)</span><span class="op" id="3911724">;</span>&nbsp;<span class="ident" id="3911726">err</span>&nbsp;<span class="op" id="3911730">!=</span>&nbsp;<span class="ident" id="3911733">nil</span>&nbsp;<span class="op" id="3911737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911741">return</span>&nbsp;<span class="ident" id="3911748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911756">k</span>&nbsp;<span class="op" id="3911758">:=</span>&nbsp;<span class="op" id="3911761">(</span><span class="ident" id="3911762">priv</span><span class="op" id="3911766">.</span><span class="ident" id="3911767">N</span><span class="op" id="3911768">.</span><span class="ident" id="3911769">BitLen</span><span class="op" id="3911775">(</span><span class="op" id="3911776">)</span>&nbsp;<span class="op" id="3911778">+</span>&nbsp;<span class="num" id="3911780">7</span><span class="op" id="3911781">)</span>&nbsp;<span class="op" id="3911783">/</span>&nbsp;<span class="num" id="3911785">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911788">if</span>&nbsp;<span class="ident" id="3911791">k</span><span class="op" id="3911792">-</span><span class="op" id="3911793">(</span><span class="builtinfunc" id="3911794">len</span><span class="op" id="3911797">(</span><span class="ident" id="3911798">key</span><span class="op" id="3911801">)</span><span class="op" id="3911802">+</span><span class="num" id="3911803">3</span><span class="op" id="3911804">+</span><span class="num" id="3911805">8</span><span class="op" id="3911806">)</span>&nbsp;<span class="op" id="3911808">&lt;</span>&nbsp;<span class="num" id="3911810">0</span>&nbsp;<span class="op" id="3911812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911816">return</span>&nbsp;<span class="ident" id="3911823">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911842">valid</span><span class="op" id="3911847">,</span>&nbsp;<span class="ident" id="3911849">em</span><span class="op" id="3911851">,</span>&nbsp;<span class="ident" id="3911853">index</span><span class="op" id="3911858">,</span>&nbsp;<span class="ident" id="3911860">err</span>&nbsp;<span class="op" id="3911864">:=</span>&nbsp;<span class="ident" id="3911867">decryptPKCS1v15</span><span class="op" id="3911882">(</span><span class="ident" id="3911883">rand</span><span class="op" id="3911887">,</span>&nbsp;<span class="ident" id="3911889">priv</span><span class="op" id="3911893">,</span>&nbsp;<span class="ident" id="3911895">ciphertext</span><span class="op" id="3911905">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911908">if</span>&nbsp;<span class="ident" id="3911911">err</span>&nbsp;<span class="op" id="3911915">!=</span>&nbsp;<span class="ident" id="3911918">nil</span>&nbsp;<span class="op" id="3911922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911926">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911938">if</span>&nbsp;<span class="builtinfunc" id="3911941">len</span><span class="op" id="3911944">(</span><span class="ident" id="3911945">em</span><span class="op" id="3911947">)</span>&nbsp;<span class="op" id="3911949">!=</span>&nbsp;<span class="ident" id="3911952">k</span>&nbsp;<span class="op" id="3911954">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911958">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912020">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912049">return</span>&nbsp;<span class="ident" id="3912056">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912075">valid</span>&nbsp;<span class="op" id="3912081">&amp;=</span>&nbsp;<span class="ident" id="3912084">subtle</span><span class="op" id="3912090">.</span><span class="ident" id="3912091">ConstantTimeEq</span><span class="op" id="3912105">(</span><span class="builtintype" id="3912106">int32</span><span class="op" id="3912111">(</span><span class="builtinfunc" id="3912112">len</span><span class="op" id="3912115">(</span><span class="ident" id="3912116">em</span><span class="op" id="3912118">)</span><span class="op" id="3912119">-</span><span class="ident" id="3912120">index</span><span class="op" id="3912125">)</span><span class="op" id="3912126">,</span>&nbsp;<span class="builtintype" id="3912128">int32</span><span class="op" id="3912133">(</span><span class="builtinfunc" id="3912134">len</span><span class="op" id="3912137">(</span><span class="ident" id="3912138">key</span><span class="op" id="3912141">)</span><span class="op" id="3912142">)</span><span class="op" id="3912143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912146">subtle</span><span class="op" id="3912152">.</span><span class="ident" id="3912153">ConstantTimeCopy</span><span class="op" id="3912169">(</span><span class="ident" id="3912170">valid</span><span class="op" id="3912175">,</span>&nbsp;<span class="ident" id="3912177">key</span><span class="op" id="3912180">,</span>&nbsp;<span class="ident" id="3912182">em</span><span class="op" id="3912184">[</span><span class="builtinfunc" id="3912185">len</span><span class="op" id="3912188">(</span><span class="ident" id="3912189">em</span><span class="op" id="3912191">)</span><span class="op" id="3912192">-</span><span class="builtinfunc" id="3912193">len</span><span class="op" id="3912196">(</span><span class="ident" id="3912197">key</span><span class="op" id="3912200">)</span><span class="op" id="3912201">:</span><span class="op" id="3912202">]</span><span class="op" id="3912203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912206">return</span><br>
<span class="lineno"></span><span class="op" id="3912213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3912216">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3912294">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3912373">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3912445">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="3912524">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="3912602">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="3912672">func</span>&nbsp;<span class="ident" id="3912677">decryptPKCS1v15</span><span class="op" id="3912692">(</span><span class="ident" id="3912693">rand</span>&nbsp;<span class="ident" id="3912698">io</span><span class="op" id="3912700">.</span><span class="ident" id="3912701">Reader</span><span class="op" id="3912707">,</span>&nbsp;<span class="ident" id="3912709">priv</span>&nbsp;<span class="op" id="3912714">*</span><span class="ident" id="3912715">PrivateKey</span><span class="op" id="3912725">,</span>&nbsp;<span class="ident" id="3912727">ciphertext</span>&nbsp;<span class="op" id="3912738">[</span><span class="op" id="3912739">]</span><span class="builtintype" id="3912740">byte</span><span class="op" id="3912744">)</span>&nbsp;<span class="op" id="3912746">(</span><span class="ident" id="3912747">valid</span>&nbsp;<span class="builtintype" id="3912753">int</span><span class="op" id="3912756">,</span>&nbsp;<span class="ident" id="3912758">em</span>&nbsp;<span class="op" id="3912761">[</span><span class="op" id="3912762">]</span><span class="builtintype" id="3912763">byte</span><span class="op" id="3912767">,</span>&nbsp;<span class="ident" id="3912769">index</span>&nbsp;<span class="builtintype" id="3912775">int</span><span class="op" id="3912778">,</span>&nbsp;<span class="ident" id="3912780">err</span>&nbsp;<span class="builtintype" id="3912784">error</span><span class="op" id="3912789">)</span>&nbsp;<span class="op" id="3912791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912794">k</span>&nbsp;<span class="op" id="3912796">:=</span>&nbsp;<span class="op" id="3912799">(</span><span class="ident" id="3912800">priv</span><span class="op" id="3912804">.</span><span class="ident" id="3912805">N</span><span class="op" id="3912806">.</span><span class="ident" id="3912807">BitLen</span><span class="op" id="3912813">(</span><span class="op" id="3912814">)</span>&nbsp;<span class="op" id="3912816">+</span>&nbsp;<span class="num" id="3912818">7</span><span class="op" id="3912819">)</span>&nbsp;<span class="op" id="3912821">/</span>&nbsp;<span class="num" id="3912823">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912826">if</span>&nbsp;<span class="ident" id="3912829">k</span>&nbsp;<span class="op" id="3912831">&lt;</span>&nbsp;<span class="num" id="3912833">11</span>&nbsp;<span class="op" id="3912836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912840">err</span>&nbsp;<span class="op" id="3912844">=</span>&nbsp;<span class="ident" id="3912846">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912862">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912874">c</span>&nbsp;<span class="op" id="3912876">:=</span>&nbsp;<span class="builtinfunc" id="3912879">new</span><span class="op" id="3912882">(</span><span class="ident" id="3912883">big</span><span class="op" id="3912886">.</span><span class="ident" id="3912887">Int</span><span class="op" id="3912890">)</span><span class="op" id="3912891">.</span><span class="ident" id="3912892">SetBytes</span><span class="op" id="3912900">(</span><span class="ident" id="3912901">ciphertext</span><span class="op" id="3912911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912914">m</span><span class="op" id="3912915">,</span>&nbsp;<span class="ident" id="3912917">err</span>&nbsp;<span class="op" id="3912921">:=</span>&nbsp;<span class="ident" id="3912924">decrypt</span><span class="op" id="3912931">(</span><span class="ident" id="3912932">rand</span><span class="op" id="3912936">,</span>&nbsp;<span class="ident" id="3912938">priv</span><span class="op" id="3912942">,</span>&nbsp;<span class="ident" id="3912944">c</span><span class="op" id="3912945">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912948">if</span>&nbsp;<span class="ident" id="3912951">err</span>&nbsp;<span class="op" id="3912955">!=</span>&nbsp;<span class="ident" id="3912958">nil</span>&nbsp;<span class="op" id="3912962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912966">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912978">em</span>&nbsp;<span class="op" id="3912981">=</span>&nbsp;<span class="ident" id="3912983">leftPad</span><span class="op" id="3912990">(</span><span class="ident" id="3912991">m</span><span class="op" id="3912992">.</span><span class="ident" id="3912993">Bytes</span><span class="op" id="3912998">(</span><span class="op" id="3912999">)</span><span class="op" id="3913000">,</span>&nbsp;<span class="ident" id="3913002">k</span><span class="op" id="3913003">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913006">firstByteIsZero</span>&nbsp;<span class="op" id="3913022">:=</span>&nbsp;<span class="ident" id="3913025">subtle</span><span class="op" id="3913031">.</span><span class="ident" id="3913032">ConstantTimeByteEq</span><span class="op" id="3913050">(</span><span class="ident" id="3913051">em</span><span class="op" id="3913053">[</span><span class="num" id="3913054">0</span><span class="op" id="3913055">]</span><span class="op" id="3913056">,</span>&nbsp;<span class="num" id="3913058">0</span><span class="op" id="3913059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913062">secondByteIsTwo</span>&nbsp;<span class="op" id="3913078">:=</span>&nbsp;<span class="ident" id="3913081">subtle</span><span class="op" id="3913087">.</span><span class="ident" id="3913088">ConstantTimeByteEq</span><span class="op" id="3913106">(</span><span class="ident" id="3913107">em</span><span class="op" id="3913109">[</span><span class="num" id="3913110">1</span><span class="op" id="3913111">]</span><span class="op" id="3913112">,</span>&nbsp;<span class="num" id="3913114">2</span><span class="op" id="3913115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913119">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913190">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913244">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913308">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913356">lookingForIndex</span>&nbsp;<span class="op" id="3913372">:=</span>&nbsp;<span class="num" id="3913375">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913379">for</span>&nbsp;<span class="ident" id="3913383">i</span>&nbsp;<span class="op" id="3913385">:=</span>&nbsp;<span class="num" id="3913388">2</span><span class="op" id="3913389">;</span>&nbsp;<span class="ident" id="3913391">i</span>&nbsp;<span class="op" id="3913393">&lt;</span>&nbsp;<span class="builtinfunc" id="3913395">len</span><span class="op" id="3913398">(</span><span class="ident" id="3913399">em</span><span class="op" id="3913401">)</span><span class="op" id="3913402">;</span>&nbsp;<span class="ident" id="3913404">i</span><span class="op" id="3913405">++</span>&nbsp;<span class="op" id="3913408">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913412">equals0</span>&nbsp;<span class="op" id="3913420">:=</span>&nbsp;<span class="ident" id="3913423">subtle</span><span class="op" id="3913429">.</span><span class="ident" id="3913430">ConstantTimeByteEq</span><span class="op" id="3913448">(</span><span class="ident" id="3913449">em</span><span class="op" id="3913451">[</span><span class="ident" id="3913452">i</span><span class="op" id="3913453">]</span><span class="op" id="3913454">,</span>&nbsp;<span class="num" id="3913456">0</span><span class="op" id="3913457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913461">index</span>&nbsp;<span class="op" id="3913467">=</span>&nbsp;<span class="ident" id="3913469">subtle</span><span class="op" id="3913475">.</span><span class="ident" id="3913476">ConstantTimeSelect</span><span class="op" id="3913494">(</span><span class="ident" id="3913495">lookingForIndex</span><span class="op" id="3913510">&amp;</span><span class="ident" id="3913511">equals0</span><span class="op" id="3913518">,</span>&nbsp;<span class="ident" id="3913520">i</span><span class="op" id="3913521">,</span>&nbsp;<span class="ident" id="3913523">index</span><span class="op" id="3913528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913532">lookingForIndex</span>&nbsp;<span class="op" id="3913548">=</span>&nbsp;<span class="ident" id="3913550">subtle</span><span class="op" id="3913556">.</span><span class="ident" id="3913557">ConstantTimeSelect</span><span class="op" id="3913575">(</span><span class="ident" id="3913576">equals0</span><span class="op" id="3913583">,</span>&nbsp;<span class="num" id="3913585">0</span><span class="op" id="3913586">,</span>&nbsp;<span class="ident" id="3913588">lookingForIndex</span><span class="op" id="3913603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3913606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913610">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913678">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913697">validPS</span>&nbsp;<span class="op" id="3913705">:=</span>&nbsp;<span class="ident" id="3913708">subtle</span><span class="op" id="3913714">.</span><span class="ident" id="3913715">ConstantTimeLessOrEq</span><span class="op" id="3913735">(</span><span class="num" id="3913736">2</span><span class="op" id="3913737">+</span><span class="num" id="3913738">8</span><span class="op" id="3913739">,</span>&nbsp;<span class="ident" id="3913741">index</span><span class="op" id="3913746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913750">valid</span>&nbsp;<span class="op" id="3913756">=</span>&nbsp;<span class="ident" id="3913758">firstByteIsZero</span>&nbsp;<span class="op" id="3913774">&amp;</span>&nbsp;<span class="ident" id="3913776">secondByteIsTwo</span>&nbsp;<span class="op" id="3913792">&amp;</span>&nbsp;<span class="op" id="3913794">(</span><span class="op" id="3913795">^</span><span class="ident" id="3913796">lookingForIndex</span>&nbsp;<span class="op" id="3913812">&amp;</span>&nbsp;<span class="num" id="3913814">1</span><span class="op" id="3913815">)</span>&nbsp;<span class="op" id="3913817">&amp;</span>&nbsp;<span class="ident" id="3913819">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913828">index</span>&nbsp;<span class="op" id="3913834">=</span>&nbsp;<span class="ident" id="3913836">subtle</span><span class="op" id="3913842">.</span><span class="ident" id="3913843">ConstantTimeSelect</span><span class="op" id="3913861">(</span><span class="ident" id="3913862">valid</span><span class="op" id="3913867">,</span>&nbsp;<span class="ident" id="3913869">index</span><span class="op" id="3913874">+</span><span class="num" id="3913875">1</span><span class="op" id="3913876">,</span>&nbsp;<span class="num" id="3913878">0</span><span class="op" id="3913879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913882">return</span>&nbsp;<span class="ident" id="3913889">valid</span><span class="op" id="3913894">,</span>&nbsp;<span class="ident" id="3913896">em</span><span class="op" id="3913898">,</span>&nbsp;<span class="ident" id="3913900">index</span><span class="op" id="3913905">,</span>&nbsp;<span class="ident" id="3913907">nil</span><br>
<span class="lineno"></span><span class="op" id="3913911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3913914">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="3913987">func</span>&nbsp;<span class="ident" id="3913992">nonZeroRandomBytes</span><span class="op" id="3914010">(</span><span class="ident" id="3914011">s</span>&nbsp;<span class="op" id="3914013">[</span><span class="op" id="3914014">]</span><span class="builtintype" id="3914015">byte</span><span class="op" id="3914019">,</span>&nbsp;<span class="ident" id="3914021">rand</span>&nbsp;<span class="ident" id="3914026">io</span><span class="op" id="3914028">.</span><span class="ident" id="3914029">Reader</span><span class="op" id="3914035">)</span>&nbsp;<span class="op" id="3914037">(</span><span class="ident" id="3914038">err</span>&nbsp;<span class="builtintype" id="3914042">error</span><span class="op" id="3914047">)</span>&nbsp;<span class="op" id="3914049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914052">_</span><span class="op" id="3914053">,</span>&nbsp;<span class="ident" id="3914055">err</span>&nbsp;<span class="op" id="3914059">=</span>&nbsp;<span class="ident" id="3914061">io</span><span class="op" id="3914063">.</span><span class="ident" id="3914064">ReadFull</span><span class="op" id="3914072">(</span><span class="ident" id="3914073">rand</span><span class="op" id="3914077">,</span>&nbsp;<span class="ident" id="3914079">s</span><span class="op" id="3914080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914083">if</span>&nbsp;<span class="ident" id="3914086">err</span>&nbsp;<span class="op" id="3914090">!=</span>&nbsp;<span class="ident" id="3914093">nil</span>&nbsp;<span class="op" id="3914097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914101">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914109">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914113">for</span>&nbsp;<span class="ident" id="3914117">i</span>&nbsp;<span class="op" id="3914119">:=</span>&nbsp;<span class="num" id="3914122">0</span><span class="op" id="3914123">;</span>&nbsp;<span class="ident" id="3914125">i</span>&nbsp;<span class="op" id="3914127">&lt;</span>&nbsp;<span class="builtinfunc" id="3914129">len</span><span class="op" id="3914132">(</span><span class="ident" id="3914133">s</span><span class="op" id="3914134">)</span><span class="op" id="3914135">;</span>&nbsp;<span class="ident" id="3914137">i</span><span class="op" id="3914138">++</span>&nbsp;<span class="op" id="3914141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914145">for</span>&nbsp;<span class="ident" id="3914149">s</span><span class="op" id="3914150">[</span><span class="ident" id="3914151">i</span><span class="op" id="3914152">]</span>&nbsp;<span class="op" id="3914154">==</span>&nbsp;<span class="num" id="3914157">0</span>&nbsp;<span class="op" id="3914159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914164">_</span><span class="op" id="3914165">,</span>&nbsp;<span class="ident" id="3914167">err</span>&nbsp;<span class="op" id="3914171">=</span>&nbsp;<span class="ident" id="3914173">io</span><span class="op" id="3914175">.</span><span class="ident" id="3914176">ReadFull</span><span class="op" id="3914184">(</span><span class="ident" id="3914185">rand</span><span class="op" id="3914189">,</span>&nbsp;<span class="ident" id="3914191">s</span><span class="op" id="3914192">[</span><span class="ident" id="3914193">i</span><span class="op" id="3914194">:</span><span class="ident" id="3914195">i</span><span class="op" id="3914196">+</span><span class="num" id="3914197">1</span><span class="op" id="3914198">]</span><span class="op" id="3914199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914204">if</span>&nbsp;<span class="ident" id="3914207">err</span>&nbsp;<span class="op" id="3914211">!=</span>&nbsp;<span class="ident" id="3914214">nil</span>&nbsp;<span class="op" id="3914218">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914224">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914239">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914294">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914324">s</span><span class="op" id="3914325">[</span><span class="ident" id="3914326">i</span><span class="op" id="3914327">]</span>&nbsp;<span class="op" id="3914329">^=</span>&nbsp;<span class="num" id="3914332">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914346">return</span><br>
<span class="lineno"></span><span class="op" id="3914353">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="3914356">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="3914390">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3914421">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="3914465">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="3914492">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3914499">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="3914569">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3914647">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="3914677">var</span>&nbsp;<span class="ident" id="3914681">hashPrefixes</span>&nbsp;<span class="op" id="3914694">=</span>&nbsp;<span class="keyword" id="3914696">map</span><span class="op" id="3914699">[</span><span class="ident" id="3914700">crypto</span><span class="op" id="3914706">.</span><span class="ident" id="3914707">Hash</span><span class="op" id="3914711">]</span><span class="op" id="3914712">[</span><span class="op" id="3914713">]</span><span class="builtintype" id="3914714">byte</span><span class="op" id="3914718">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914721">crypto</span><span class="op" id="3914727">.</span><span class="ident" id="3914728">MD5</span><span class="op" id="3914731">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914739">{</span><span class="num" id="3914740">0x30</span><span class="op" id="3914744">,</span>&nbsp;<span class="num" id="3914746">0x20</span><span class="op" id="3914750">,</span>&nbsp;<span class="num" id="3914752">0x30</span><span class="op" id="3914756">,</span>&nbsp;<span class="num" id="3914758">0x0c</span><span class="op" id="3914762">,</span>&nbsp;<span class="num" id="3914764">0x06</span><span class="op" id="3914768">,</span>&nbsp;<span class="num" id="3914770">0x08</span><span class="op" id="3914774">,</span>&nbsp;<span class="num" id="3914776">0x2a</span><span class="op" id="3914780">,</span>&nbsp;<span class="num" id="3914782">0x86</span><span class="op" id="3914786">,</span>&nbsp;<span class="num" id="3914788">0x48</span><span class="op" id="3914792">,</span>&nbsp;<span class="num" id="3914794">0x86</span><span class="op" id="3914798">,</span>&nbsp;<span class="num" id="3914800">0xf7</span><span class="op" id="3914804">,</span>&nbsp;<span class="num" id="3914806">0x0d</span><span class="op" id="3914810">,</span>&nbsp;<span class="num" id="3914812">0x02</span><span class="op" id="3914816">,</span>&nbsp;<span class="num" id="3914818">0x05</span><span class="op" id="3914822">,</span>&nbsp;<span class="num" id="3914824">0x05</span><span class="op" id="3914828">,</span>&nbsp;<span class="num" id="3914830">0x00</span><span class="op" id="3914834">,</span>&nbsp;<span class="num" id="3914836">0x04</span><span class="op" id="3914840">,</span>&nbsp;<span class="num" id="3914842">0x10</span><span class="op" id="3914846">}</span><span class="op" id="3914847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914850">crypto</span><span class="op" id="3914856">.</span><span class="ident" id="3914857">SHA1</span><span class="op" id="3914861">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914868">{</span><span class="num" id="3914869">0x30</span><span class="op" id="3914873">,</span>&nbsp;<span class="num" id="3914875">0x21</span><span class="op" id="3914879">,</span>&nbsp;<span class="num" id="3914881">0x30</span><span class="op" id="3914885">,</span>&nbsp;<span class="num" id="3914887">0x09</span><span class="op" id="3914891">,</span>&nbsp;<span class="num" id="3914893">0x06</span><span class="op" id="3914897">,</span>&nbsp;<span class="num" id="3914899">0x05</span><span class="op" id="3914903">,</span>&nbsp;<span class="num" id="3914905">0x2b</span><span class="op" id="3914909">,</span>&nbsp;<span class="num" id="3914911">0x0e</span><span class="op" id="3914915">,</span>&nbsp;<span class="num" id="3914917">0x03</span><span class="op" id="3914921">,</span>&nbsp;<span class="num" id="3914923">0x02</span><span class="op" id="3914927">,</span>&nbsp;<span class="num" id="3914929">0x1a</span><span class="op" id="3914933">,</span>&nbsp;<span class="num" id="3914935">0x05</span><span class="op" id="3914939">,</span>&nbsp;<span class="num" id="3914941">0x00</span><span class="op" id="3914945">,</span>&nbsp;<span class="num" id="3914947">0x04</span><span class="op" id="3914951">,</span>&nbsp;<span class="num" id="3914953">0x14</span><span class="op" id="3914957">}</span><span class="op" id="3914958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914961">crypto</span><span class="op" id="3914967">.</span><span class="ident" id="3914968">SHA224</span><span class="op" id="3914974">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3914979">{</span><span class="num" id="3914980">0x30</span><span class="op" id="3914984">,</span>&nbsp;<span class="num" id="3914986">0x2d</span><span class="op" id="3914990">,</span>&nbsp;<span class="num" id="3914992">0x30</span><span class="op" id="3914996">,</span>&nbsp;<span class="num" id="3914998">0x0d</span><span class="op" id="3915002">,</span>&nbsp;<span class="num" id="3915004">0x06</span><span class="op" id="3915008">,</span>&nbsp;<span class="num" id="3915010">0x09</span><span class="op" id="3915014">,</span>&nbsp;<span class="num" id="3915016">0x60</span><span class="op" id="3915020">,</span>&nbsp;<span class="num" id="3915022">0x86</span><span class="op" id="3915026">,</span>&nbsp;<span class="num" id="3915028">0x48</span><span class="op" id="3915032">,</span>&nbsp;<span class="num" id="3915034">0x01</span><span class="op" id="3915038">,</span>&nbsp;<span class="num" id="3915040">0x65</span><span class="op" id="3915044">,</span>&nbsp;<span class="num" id="3915046">0x03</span><span class="op" id="3915050">,</span>&nbsp;<span class="num" id="3915052">0x04</span><span class="op" id="3915056">,</span>&nbsp;<span class="num" id="3915058">0x02</span><span class="op" id="3915062">,</span>&nbsp;<span class="num" id="3915064">0x04</span><span class="op" id="3915068">,</span>&nbsp;<span class="num" id="3915070">0x05</span><span class="op" id="3915074">,</span>&nbsp;<span class="num" id="3915076">0x00</span><span class="op" id="3915080">,</span>&nbsp;<span class="num" id="3915082">0x04</span><span class="op" id="3915086">,</span>&nbsp;<span class="num" id="3915088">0x1c</span><span class="op" id="3915092">}</span><span class="op" id="3915093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915096">crypto</span><span class="op" id="3915102">.</span><span class="ident" id="3915103">SHA256</span><span class="op" id="3915109">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915114">{</span><span class="num" id="3915115">0x30</span><span class="op" id="3915119">,</span>&nbsp;<span class="num" id="3915121">0x31</span><span class="op" id="3915125">,</span>&nbsp;<span class="num" id="3915127">0x30</span><span class="op" id="3915131">,</span>&nbsp;<span class="num" id="3915133">0x0d</span><span class="op" id="3915137">,</span>&nbsp;<span class="num" id="3915139">0x06</span><span class="op" id="3915143">,</span>&nbsp;<span class="num" id="3915145">0x09</span><span class="op" id="3915149">,</span>&nbsp;<span class="num" id="3915151">0x60</span><span class="op" id="3915155">,</span>&nbsp;<span class="num" id="3915157">0x86</span><span class="op" id="3915161">,</span>&nbsp;<span class="num" id="3915163">0x48</span><span class="op" id="3915167">,</span>&nbsp;<span class="num" id="3915169">0x01</span><span class="op" id="3915173">,</span>&nbsp;<span class="num" id="3915175">0x65</span><span class="op" id="3915179">,</span>&nbsp;<span class="num" id="3915181">0x03</span><span class="op" id="3915185">,</span>&nbsp;<span class="num" id="3915187">0x04</span><span class="op" id="3915191">,</span>&nbsp;<span class="num" id="3915193">0x02</span><span class="op" id="3915197">,</span>&nbsp;<span class="num" id="3915199">0x01</span><span class="op" id="3915203">,</span>&nbsp;<span class="num" id="3915205">0x05</span><span class="op" id="3915209">,</span>&nbsp;<span class="num" id="3915211">0x00</span><span class="op" id="3915215">,</span>&nbsp;<span class="num" id="3915217">0x04</span><span class="op" id="3915221">,</span>&nbsp;<span class="num" id="3915223">0x20</span><span class="op" id="3915227">}</span><span class="op" id="3915228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915231">crypto</span><span class="op" id="3915237">.</span><span class="ident" id="3915238">SHA384</span><span class="op" id="3915244">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915249">{</span><span class="num" id="3915250">0x30</span><span class="op" id="3915254">,</span>&nbsp;<span class="num" id="3915256">0x41</span><span class="op" id="3915260">,</span>&nbsp;<span class="num" id="3915262">0x30</span><span class="op" id="3915266">,</span>&nbsp;<span class="num" id="3915268">0x0d</span><span class="op" id="3915272">,</span>&nbsp;<span class="num" id="3915274">0x06</span><span class="op" id="3915278">,</span>&nbsp;<span class="num" id="3915280">0x09</span><span class="op" id="3915284">,</span>&nbsp;<span class="num" id="3915286">0x60</span><span class="op" id="3915290">,</span>&nbsp;<span class="num" id="3915292">0x86</span><span class="op" id="3915296">,</span>&nbsp;<span class="num" id="3915298">0x48</span><span class="op" id="3915302">,</span>&nbsp;<span class="num" id="3915304">0x01</span><span class="op" id="3915308">,</span>&nbsp;<span class="num" id="3915310">0x65</span><span class="op" id="3915314">,</span>&nbsp;<span class="num" id="3915316">0x03</span><span class="op" id="3915320">,</span>&nbsp;<span class="num" id="3915322">0x04</span><span class="op" id="3915326">,</span>&nbsp;<span class="num" id="3915328">0x02</span><span class="op" id="3915332">,</span>&nbsp;<span class="num" id="3915334">0x02</span><span class="op" id="3915338">,</span>&nbsp;<span class="num" id="3915340">0x05</span><span class="op" id="3915344">,</span>&nbsp;<span class="num" id="3915346">0x00</span><span class="op" id="3915350">,</span>&nbsp;<span class="num" id="3915352">0x04</span><span class="op" id="3915356">,</span>&nbsp;<span class="num" id="3915358">0x30</span><span class="op" id="3915362">}</span><span class="op" id="3915363">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915366">crypto</span><span class="op" id="3915372">.</span><span class="ident" id="3915373">SHA512</span><span class="op" id="3915379">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3915384">{</span><span class="num" id="3915385">0x30</span><span class="op" id="3915389">,</span>&nbsp;<span class="num" id="3915391">0x51</span><span class="op" id="3915395">,</span>&nbsp;<span class="num" id="3915397">0x30</span><span class="op" id="3915401">,</span>&nbsp;<span class="num" id="3915403">0x0d</span><span class="op" id="3915407">,</span>&nbsp;<span class="num" id="3915409">0x06</span><span class="op" id="3915413">,</span>&nbsp;<span class="num" id="3915415">0x09</span><span class="op" id="3915419">,</span>&nbsp;<span class="num" id="3915421">0x60</span><span class="op" id="3915425">,</span>&nbsp;<span class="num" id="3915427">0x86</span><span class="op" id="3915431">,</span>&nbsp;<span class="num" id="3915433">0x48</span><span class="op" id="3915437">,</span>&nbsp;<span class="num" id="3915439">0x01</span><span class="op" id="3915443">,</span>&nbsp;<span class="num" id="3915445">0x65</span><span class="op" id="3915449">,</span>&nbsp;<span class="num" id="3915451">0x03</span><span class="op" id="3915455">,</span>&nbsp;<span class="num" id="3915457">0x04</span><span class="op" id="3915461">,</span>&nbsp;<span class="num" id="3915463">0x02</span><span class="op" id="3915467">,</span>&nbsp;<span class="num" id="3915469">0x03</span><span class="op" id="3915473">,</span>&nbsp;<span class="num" id="3915475">0x05</span><span class="op" id="3915479">,</span>&nbsp;<span class="num" id="3915481">0x00</span><span class="op" id="3915485">,</span>&nbsp;<span class="num" id="3915487">0x04</span><span class="op" id="3915491">,</span>&nbsp;<span class="num" id="3915493">0x40</span><span class="op" id="3915497">}</span><span class="op" id="3915498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915501">crypto</span><span class="op" id="3915507">.</span><span class="ident" id="3915508">MD5SHA1</span><span class="op" id="3915515">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3915519">{</span><span class="op" id="3915520">}</span><span class="op" id="3915521">,</span>&nbsp;<span class="comment" id="3915523">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915580">crypto</span><span class="op" id="3915586">.</span><span class="ident" id="3915587">RIPEMD160</span><span class="op" id="3915596">:</span>&nbsp;<span class="op" id="3915598">{</span><span class="num" id="3915599">0x30</span><span class="op" id="3915603">,</span>&nbsp;<span class="num" id="3915605">0x20</span><span class="op" id="3915609">,</span>&nbsp;<span class="num" id="3915611">0x30</span><span class="op" id="3915615">,</span>&nbsp;<span class="num" id="3915617">0x08</span><span class="op" id="3915621">,</span>&nbsp;<span class="num" id="3915623">0x06</span><span class="op" id="3915627">,</span>&nbsp;<span class="num" id="3915629">0x06</span><span class="op" id="3915633">,</span>&nbsp;<span class="num" id="3915635">0x28</span><span class="op" id="3915639">,</span>&nbsp;<span class="num" id="3915641">0xcf</span><span class="op" id="3915645">,</span>&nbsp;<span class="num" id="3915647">0x06</span><span class="op" id="3915651">,</span>&nbsp;<span class="num" id="3915653">0x03</span><span class="op" id="3915657">,</span>&nbsp;<span class="num" id="3915659">0x00</span><span class="op" id="3915663">,</span>&nbsp;<span class="num" id="3915665">0x31</span><span class="op" id="3915669">,</span>&nbsp;<span class="num" id="3915671">0x04</span><span class="op" id="3915675">,</span>&nbsp;<span class="num" id="3915677">0x14</span><span class="op" id="3915681">}</span><span class="op" id="3915682">,</span><br>
<span class="lineno"></span><span class="op" id="3915684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="3915687">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3915789">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3915867">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3915946">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3915988">func</span>&nbsp;<span class="ident" id="3915993">SignPKCS1v15</span><span class="op" id="3916005">(</span><span class="ident" id="3916006">rand</span>&nbsp;<span class="ident" id="3916011">io</span><span class="op" id="3916013">.</span><span class="ident" id="3916014">Reader</span><span class="op" id="3916020">,</span>&nbsp;<span class="ident" id="3916022">priv</span>&nbsp;<span class="op" id="3916027">*</span><span class="ident" id="3916028">PrivateKey</span><span class="op" id="3916038">,</span>&nbsp;<span class="ident" id="3916040">hash</span>&nbsp;<span class="ident" id="3916045">crypto</span><span class="op" id="3916051">.</span><span class="ident" id="3916052">Hash</span><span class="op" id="3916056">,</span>&nbsp;<span class="ident" id="3916058">hashed</span>&nbsp;<span class="op" id="3916065">[</span><span class="op" id="3916066">]</span><span class="builtintype" id="3916067">byte</span><span class="op" id="3916071">)</span>&nbsp;<span class="op" id="3916073">(</span><span class="ident" id="3916074">s</span>&nbsp;<span class="op" id="3916076">[</span><span class="op" id="3916077">]</span><span class="builtintype" id="3916078">byte</span><span class="op" id="3916082">,</span>&nbsp;<span class="ident" id="3916084">err</span>&nbsp;<span class="builtintype" id="3916088">error</span><span class="op" id="3916093">)</span>&nbsp;<span class="op" id="3916095">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916098">hashLen</span><span class="op" id="3916105">,</span>&nbsp;<span class="ident" id="3916107">prefix</span><span class="op" id="3916113">,</span>&nbsp;<span class="ident" id="3916115">err</span>&nbsp;<span class="op" id="3916119">:=</span>&nbsp;<span class="ident" id="3916122">pkcs1v15HashInfo</span><span class="op" id="3916138">(</span><span class="ident" id="3916139">hash</span><span class="op" id="3916143">,</span>&nbsp;<span class="builtinfunc" id="3916145">len</span><span class="op" id="3916148">(</span><span class="ident" id="3916149">hashed</span><span class="op" id="3916155">)</span><span class="op" id="3916156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916159">if</span>&nbsp;<span class="ident" id="3916162">err</span>&nbsp;<span class="op" id="3916166">!=</span>&nbsp;<span class="ident" id="3916169">nil</span>&nbsp;<span class="op" id="3916173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916177">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916189">tLen</span>&nbsp;<span class="op" id="3916194">:=</span>&nbsp;<span class="builtinfunc" id="3916197">len</span><span class="op" id="3916200">(</span><span class="ident" id="3916201">prefix</span><span class="op" id="3916207">)</span>&nbsp;<span class="op" id="3916209">+</span>&nbsp;<span class="ident" id="3916211">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916220">k</span>&nbsp;<span class="op" id="3916222">:=</span>&nbsp;<span class="op" id="3916225">(</span><span class="ident" id="3916226">priv</span><span class="op" id="3916230">.</span><span class="ident" id="3916231">N</span><span class="op" id="3916232">.</span><span class="ident" id="3916233">BitLen</span><span class="op" id="3916239">(</span><span class="op" id="3916240">)</span>&nbsp;<span class="op" id="3916242">+</span>&nbsp;<span class="num" id="3916244">7</span><span class="op" id="3916245">)</span>&nbsp;<span class="op" id="3916247">/</span>&nbsp;<span class="num" id="3916249">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916252">if</span>&nbsp;<span class="ident" id="3916255">k</span>&nbsp;<span class="op" id="3916257">&lt;</span>&nbsp;<span class="ident" id="3916259">tLen</span><span class="op" id="3916263">+</span><span class="num" id="3916264">11</span>&nbsp;<span class="op" id="3916267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916271">return</span>&nbsp;<span class="ident" id="3916278">nil</span><span class="op" id="3916281">,</span>&nbsp;<span class="ident" id="3916283">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916302">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916306">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916347">em</span>&nbsp;<span class="op" id="3916350">:=</span>&nbsp;<span class="builtinfunc" id="3916353">make</span><span class="op" id="3916357">(</span><span class="op" id="3916358">[</span><span class="op" id="3916359">]</span><span class="builtintype" id="3916360">byte</span><span class="op" id="3916364">,</span>&nbsp;<span class="ident" id="3916366">k</span><span class="op" id="3916367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916370">em</span><span class="op" id="3916372">[</span><span class="num" id="3916373">1</span><span class="op" id="3916374">]</span>&nbsp;<span class="op" id="3916376">=</span>&nbsp;<span class="num" id="3916378">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916381">for</span>&nbsp;<span class="ident" id="3916385">i</span>&nbsp;<span class="op" id="3916387">:=</span>&nbsp;<span class="num" id="3916390">2</span><span class="op" id="3916391">;</span>&nbsp;<span class="ident" id="3916393">i</span>&nbsp;<span class="op" id="3916395">&lt;</span>&nbsp;<span class="ident" id="3916397">k</span><span class="op" id="3916398">-</span><span class="ident" id="3916399">tLen</span><span class="op" id="3916403">-</span><span class="num" id="3916404">1</span><span class="op" id="3916405">;</span>&nbsp;<span class="ident" id="3916407">i</span><span class="op" id="3916408">++</span>&nbsp;<span class="op" id="3916411">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916415">em</span><span class="op" id="3916417">[</span><span class="ident" id="3916418">i</span><span class="op" id="3916419">]</span>&nbsp;<span class="op" id="3916421">=</span>&nbsp;<span class="num" id="3916423">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3916432">copy</span><span class="op" id="3916436">(</span><span class="ident" id="3916437">em</span><span class="op" id="3916439">[</span><span class="ident" id="3916440">k</span><span class="op" id="3916441">-</span><span class="ident" id="3916442">tLen</span><span class="op" id="3916446">:</span><span class="ident" id="3916447">k</span><span class="op" id="3916448">-</span><span class="ident" id="3916449">hashLen</span><span class="op" id="3916456">]</span><span class="op" id="3916457">,</span>&nbsp;<span class="ident" id="3916459">prefix</span><span class="op" id="3916465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3916468">copy</span><span class="op" id="3916472">(</span><span class="ident" id="3916473">em</span><span class="op" id="3916475">[</span><span class="ident" id="3916476">k</span><span class="op" id="3916477">-</span><span class="ident" id="3916478">hashLen</span><span class="op" id="3916485">:</span><span class="ident" id="3916486">k</span><span class="op" id="3916487">]</span><span class="op" id="3916488">,</span>&nbsp;<span class="ident" id="3916490">hashed</span><span class="op" id="3916496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916500">m</span>&nbsp;<span class="op" id="3916502">:=</span>&nbsp;<span class="builtinfunc" id="3916505">new</span><span class="op" id="3916508">(</span><span class="ident" id="3916509">big</span><span class="op" id="3916512">.</span><span class="ident" id="3916513">Int</span><span class="op" id="3916516">)</span><span class="op" id="3916517">.</span><span class="ident" id="3916518">SetBytes</span><span class="op" id="3916526">(</span><span class="ident" id="3916527">em</span><span class="op" id="3916529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916532">c</span><span class="op" id="3916533">,</span>&nbsp;<span class="ident" id="3916535">err</span>&nbsp;<span class="op" id="3916539">:=</span>&nbsp;<span class="ident" id="3916542">decrypt</span><span class="op" id="3916549">(</span><span class="ident" id="3916550">rand</span><span class="op" id="3916554">,</span>&nbsp;<span class="ident" id="3916556">priv</span><span class="op" id="3916560">,</span>&nbsp;<span class="ident" id="3916562">m</span><span class="op" id="3916563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916566">if</span>&nbsp;<span class="ident" id="3916569">err</span>&nbsp;<span class="op" id="3916573">!=</span>&nbsp;<span class="ident" id="3916576">nil</span>&nbsp;<span class="op" id="3916580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916584">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916592">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916596">copyWithLeftPad</span><span class="op" id="3916611">(</span><span class="ident" id="3916612">em</span><span class="op" id="3916614">,</span>&nbsp;<span class="ident" id="3916616">c</span><span class="op" id="3916617">.</span><span class="ident" id="3916618">Bytes</span><span class="op" id="3916623">(</span><span class="op" id="3916624">)</span><span class="op" id="3916625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916628">s</span>&nbsp;<span class="op" id="3916630">=</span>&nbsp;<span class="ident" id="3916632">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916636">return</span><br>
<span class="lineno"></span><span class="op" id="3916643">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="3916646">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="3916703">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="3916777">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3916849">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="3916926">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3916974">func</span>&nbsp;<span class="ident" id="3916979">VerifyPKCS1v15</span><span class="op" id="3916993">(</span><span class="ident" id="3916994">pub</span>&nbsp;<span class="op" id="3916998">*</span><span class="ident" id="3916999">PublicKey</span><span class="op" id="3917008">,</span>&nbsp;<span class="ident" id="3917010">hash</span>&nbsp;<span class="ident" id="3917015">crypto</span><span class="op" id="3917021">.</span><span class="ident" id="3917022">Hash</span><span class="op" id="3917026">,</span>&nbsp;<span class="ident" id="3917028">hashed</span>&nbsp;<span class="op" id="3917035">[</span><span class="op" id="3917036">]</span><span class="builtintype" id="3917037">byte</span><span class="op" id="3917041">,</span>&nbsp;<span class="ident" id="3917043">sig</span>&nbsp;<span class="op" id="3917047">[</span><span class="op" id="3917048">]</span><span class="builtintype" id="3917049">byte</span><span class="op" id="3917053">)</span>&nbsp;<span class="op" id="3917055">(</span><span class="ident" id="3917056">err</span>&nbsp;<span class="builtintype" id="3917060">error</span><span class="op" id="3917065">)</span>&nbsp;<span class="op" id="3917067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917070">hashLen</span><span class="op" id="3917077">,</span>&nbsp;<span class="ident" id="3917079">prefix</span><span class="op" id="3917085">,</span>&nbsp;<span class="ident" id="3917087">err</span>&nbsp;<span class="op" id="3917091">:=</span>&nbsp;<span class="ident" id="3917094">pkcs1v15HashInfo</span><span class="op" id="3917110">(</span><span class="ident" id="3917111">hash</span><span class="op" id="3917115">,</span>&nbsp;<span class="builtinfunc" id="3917117">len</span><span class="op" id="3917120">(</span><span class="ident" id="3917121">hashed</span><span class="op" id="3917127">)</span><span class="op" id="3917128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917131">if</span>&nbsp;<span class="ident" id="3917134">err</span>&nbsp;<span class="op" id="3917138">!=</span>&nbsp;<span class="ident" id="3917141">nil</span>&nbsp;<span class="op" id="3917145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917149">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917161">tLen</span>&nbsp;<span class="op" id="3917166">:=</span>&nbsp;<span class="builtinfunc" id="3917169">len</span><span class="op" id="3917172">(</span><span class="ident" id="3917173">prefix</span><span class="op" id="3917179">)</span>&nbsp;<span class="op" id="3917181">+</span>&nbsp;<span class="ident" id="3917183">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917192">k</span>&nbsp;<span class="op" id="3917194">:=</span>&nbsp;<span class="op" id="3917197">(</span><span class="ident" id="3917198">pub</span><span class="op" id="3917201">.</span><span class="ident" id="3917202">N</span><span class="op" id="3917203">.</span><span class="ident" id="3917204">BitLen</span><span class="op" id="3917210">(</span><span class="op" id="3917211">)</span>&nbsp;<span class="op" id="3917213">+</span>&nbsp;<span class="num" id="3917215">7</span><span class="op" id="3917216">)</span>&nbsp;<span class="op" id="3917218">/</span>&nbsp;<span class="num" id="3917220">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917223">if</span>&nbsp;<span class="ident" id="3917226">k</span>&nbsp;<span class="op" id="3917228">&lt;</span>&nbsp;<span class="ident" id="3917230">tLen</span><span class="op" id="3917234">+</span><span class="num" id="3917235">11</span>&nbsp;<span class="op" id="3917238">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917242">err</span>&nbsp;<span class="op" id="3917246">=</span>&nbsp;<span class="ident" id="3917248">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917266">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917278">c</span>&nbsp;<span class="op" id="3917280">:=</span>&nbsp;<span class="builtinfunc" id="3917283">new</span><span class="op" id="3917286">(</span><span class="ident" id="3917287">big</span><span class="op" id="3917290">.</span><span class="ident" id="3917291">Int</span><span class="op" id="3917294">)</span><span class="op" id="3917295">.</span><span class="ident" id="3917296">SetBytes</span><span class="op" id="3917304">(</span><span class="ident" id="3917305">sig</span><span class="op" id="3917308">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917311">m</span>&nbsp;<span class="op" id="3917313">:=</span>&nbsp;<span class="ident" id="3917316">encrypt</span><span class="op" id="3917323">(</span><span class="builtinfunc" id="3917324">new</span><span class="op" id="3917327">(</span><span class="ident" id="3917328">big</span><span class="op" id="3917331">.</span><span class="ident" id="3917332">Int</span><span class="op" id="3917335">)</span><span class="op" id="3917336">,</span>&nbsp;<span class="ident" id="3917338">pub</span><span class="op" id="3917341">,</span>&nbsp;<span class="ident" id="3917343">c</span><span class="op" id="3917344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917347">em</span>&nbsp;<span class="op" id="3917350">:=</span>&nbsp;<span class="ident" id="3917353">leftPad</span><span class="op" id="3917360">(</span><span class="ident" id="3917361">m</span><span class="op" id="3917362">.</span><span class="ident" id="3917363">Bytes</span><span class="op" id="3917368">(</span><span class="op" id="3917369">)</span><span class="op" id="3917370">,</span>&nbsp;<span class="ident" id="3917372">k</span><span class="op" id="3917373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917376">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917418">ok</span>&nbsp;<span class="op" id="3917421">:=</span>&nbsp;<span class="ident" id="3917424">subtle</span><span class="op" id="3917430">.</span><span class="ident" id="3917431">ConstantTimeByteEq</span><span class="op" id="3917449">(</span><span class="ident" id="3917450">em</span><span class="op" id="3917452">[</span><span class="num" id="3917453">0</span><span class="op" id="3917454">]</span><span class="op" id="3917455">,</span>&nbsp;<span class="num" id="3917457">0</span><span class="op" id="3917458">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917461">ok</span>&nbsp;<span class="op" id="3917464">&amp;=</span>&nbsp;<span class="ident" id="3917467">subtle</span><span class="op" id="3917473">.</span><span class="ident" id="3917474">ConstantTimeByteEq</span><span class="op" id="3917492">(</span><span class="ident" id="3917493">em</span><span class="op" id="3917495">[</span><span class="num" id="3917496">1</span><span class="op" id="3917497">]</span><span class="op" id="3917498">,</span>&nbsp;<span class="num" id="3917500">1</span><span class="op" id="3917501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917504">ok</span>&nbsp;<span class="op" id="3917507">&amp;=</span>&nbsp;<span class="ident" id="3917510">subtle</span><span class="op" id="3917516">.</span><span class="ident" id="3917517">ConstantTimeCompare</span><span class="op" id="3917536">(</span><span class="ident" id="3917537">em</span><span class="op" id="3917539">[</span><span class="ident" id="3917540">k</span><span class="op" id="3917541">-</span><span class="ident" id="3917542">hashLen</span><span class="op" id="3917549">:</span><span class="ident" id="3917550">k</span><span class="op" id="3917551">]</span><span class="op" id="3917552">,</span>&nbsp;<span class="ident" id="3917554">hashed</span><span class="op" id="3917560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917563">ok</span>&nbsp;<span class="op" id="3917566">&amp;=</span>&nbsp;<span class="ident" id="3917569">subtle</span><span class="op" id="3917575">.</span><span class="ident" id="3917576">ConstantTimeCompare</span><span class="op" id="3917595">(</span><span class="ident" id="3917596">em</span><span class="op" id="3917598">[</span><span class="ident" id="3917599">k</span><span class="op" id="3917600">-</span><span class="ident" id="3917601">tLen</span><span class="op" id="3917605">:</span><span class="ident" id="3917606">k</span><span class="op" id="3917607">-</span><span class="ident" id="3917608">hashLen</span><span class="op" id="3917615">]</span><span class="op" id="3917616">,</span>&nbsp;<span class="ident" id="3917618">prefix</span><span class="op" id="3917624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917627">ok</span>&nbsp;<span class="op" id="3917630">&amp;=</span>&nbsp;<span class="ident" id="3917633">subtle</span><span class="op" id="3917639">.</span><span class="ident" id="3917640">ConstantTimeByteEq</span><span class="op" id="3917658">(</span><span class="ident" id="3917659">em</span><span class="op" id="3917661">[</span><span class="ident" id="3917662">k</span><span class="op" id="3917663">-</span><span class="ident" id="3917664">tLen</span><span class="op" id="3917668">-</span><span class="num" id="3917669">1</span><span class="op" id="3917670">]</span><span class="op" id="3917671">,</span>&nbsp;<span class="num" id="3917673">0</span><span class="op" id="3917674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917678">for</span>&nbsp;<span class="ident" id="3917682">i</span>&nbsp;<span class="op" id="3917684">:=</span>&nbsp;<span class="num" id="3917687">2</span><span class="op" id="3917688">;</span>&nbsp;<span class="ident" id="3917690">i</span>&nbsp;<span class="op" id="3917692">&lt;</span>&nbsp;<span class="ident" id="3917694">k</span><span class="op" id="3917695">-</span><span class="ident" id="3917696">tLen</span><span class="op" id="3917700">-</span><span class="num" id="3917701">1</span><span class="op" id="3917702">;</span>&nbsp;<span class="ident" id="3917704">i</span><span class="op" id="3917705">++</span>&nbsp;<span class="op" id="3917708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917712">ok</span>&nbsp;<span class="op" id="3917715">&amp;=</span>&nbsp;<span class="ident" id="3917718">subtle</span><span class="op" id="3917724">.</span><span class="ident" id="3917725">ConstantTimeByteEq</span><span class="op" id="3917743">(</span><span class="ident" id="3917744">em</span><span class="op" id="3917746">[</span><span class="ident" id="3917747">i</span><span class="op" id="3917748">]</span><span class="op" id="3917749">,</span>&nbsp;<span class="num" id="3917751">0xff</span><span class="op" id="3917755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917762">if</span>&nbsp;<span class="ident" id="3917765">ok</span>&nbsp;<span class="op" id="3917768">!=</span>&nbsp;<span class="num" id="3917771">1</span>&nbsp;<span class="op" id="3917773">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917777">return</span>&nbsp;<span class="ident" id="3917784">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917805">return</span>&nbsp;<span class="ident" id="3917812">nil</span><br>
<span class="lineno"></span><span class="op" id="3917816">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="3917819">func</span>&nbsp;<span class="ident" id="3917824">pkcs1v15HashInfo</span><span class="op" id="3917840">(</span><span class="ident" id="3917841">hash</span>&nbsp;<span class="ident" id="3917846">crypto</span><span class="op" id="3917852">.</span><span class="ident" id="3917853">Hash</span><span class="op" id="3917857">,</span>&nbsp;<span class="ident" id="3917859">inLen</span>&nbsp;<span class="builtintype" id="3917865">int</span><span class="op" id="3917868">)</span>&nbsp;<span class="op" id="3917870">(</span><span class="ident" id="3917871">hashLen</span>&nbsp;<span class="builtintype" id="3917879">int</span><span class="op" id="3917882">,</span>&nbsp;<span class="ident" id="3917884">prefix</span>&nbsp;<span class="op" id="3917891">[</span><span class="op" id="3917892">]</span><span class="builtintype" id="3917893">byte</span><span class="op" id="3917897">,</span>&nbsp;<span class="ident" id="3917899">err</span>&nbsp;<span class="builtintype" id="3917903">error</span><span class="op" id="3917908">)</span>&nbsp;<span class="op" id="3917910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917913">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917983">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918004">if</span>&nbsp;<span class="ident" id="3918007">hash</span>&nbsp;<span class="op" id="3918012">==</span>&nbsp;<span class="num" id="3918015">0</span>&nbsp;<span class="op" id="3918017">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918021">return</span>&nbsp;<span class="ident" id="3918028">inLen</span><span class="op" id="3918033">,</span>&nbsp;<span class="ident" id="3918035">nil</span><span class="op" id="3918038">,</span>&nbsp;<span class="ident" id="3918040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918049">hashLen</span>&nbsp;<span class="op" id="3918057">=</span>&nbsp;<span class="ident" id="3918059">hash</span><span class="op" id="3918063">.</span><span class="ident" id="3918064">Size</span><span class="op" id="3918068">(</span><span class="op" id="3918069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918072">if</span>&nbsp;<span class="ident" id="3918075">inLen</span>&nbsp;<span class="op" id="3918081">!=</span>&nbsp;<span class="ident" id="3918084">hashLen</span>&nbsp;<span class="op" id="3918092">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918096">return</span>&nbsp;<span class="num" id="3918103">0</span><span class="op" id="3918104">,</span>&nbsp;<span class="ident" id="3918106">nil</span><span class="op" id="3918109">,</span>&nbsp;<span class="ident" id="3918111">errors</span><span class="op" id="3918117">.</span><span class="ident" id="3918118">New</span><span class="op" id="3918121">(</span><span class="string" id="3918122">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="3918164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918170">prefix</span><span class="op" id="3918176">,</span>&nbsp;<span class="ident" id="3918178">ok</span>&nbsp;<span class="op" id="3918181">:=</span>&nbsp;<span class="ident" id="3918184">hashPrefixes</span><span class="op" id="3918196">[</span><span class="ident" id="3918197">hash</span><span class="op" id="3918201">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918204">if</span>&nbsp;<span class="op" id="3918207">!</span><span class="ident" id="3918208">ok</span>&nbsp;<span class="op" id="3918211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918215">return</span>&nbsp;<span class="num" id="3918222">0</span><span class="op" id="3918223">,</span>&nbsp;<span class="ident" id="3918225">nil</span><span class="op" id="3918228">,</span>&nbsp;<span class="ident" id="3918230">errors</span><span class="op" id="3918236">.</span><span class="ident" id="3918237">New</span><span class="op" id="3918240">(</span><span class="string" id="3918241">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="3918280">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918286">return</span><br>
<span class="lineno"></span><span class="op" id="3918293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3918296">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="3918373">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="3918384">func</span>&nbsp;<span class="ident" id="3918389">copyWithLeftPad</span><span class="op" id="3918404">(</span><span class="ident" id="3918405">dest</span><span class="op" id="3918409">,</span>&nbsp;<span class="ident" id="3918411">src</span>&nbsp;<span class="op" id="3918415">[</span><span class="op" id="3918416">]</span><span class="builtintype" id="3918417">byte</span><span class="op" id="3918421">)</span>&nbsp;<span class="op" id="3918423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918426">numPaddingBytes</span>&nbsp;<span class="op" id="3918442">:=</span>&nbsp;<span class="builtinfunc" id="3918445">len</span><span class="op" id="3918448">(</span><span class="ident" id="3918449">dest</span><span class="op" id="3918453">)</span>&nbsp;<span class="op" id="3918455">-</span>&nbsp;<span class="builtinfunc" id="3918457">len</span><span class="op" id="3918460">(</span><span class="ident" id="3918461">src</span><span class="op" id="3918464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918467">for</span>&nbsp;<span class="ident" id="3918471">i</span>&nbsp;<span class="op" id="3918473">:=</span>&nbsp;<span class="num" id="3918476">0</span><span class="op" id="3918477">;</span>&nbsp;<span class="ident" id="3918479">i</span>&nbsp;<span class="op" id="3918481">&lt;</span>&nbsp;<span class="ident" id="3918483">numPaddingBytes</span><span class="op" id="3918498">;</span>&nbsp;<span class="ident" id="3918500">i</span><span class="op" id="3918501">++</span>&nbsp;<span class="op" id="3918504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918508">dest</span><span class="op" id="3918512">[</span><span class="ident" id="3918513">i</span><span class="op" id="3918514">]</span>&nbsp;<span class="op" id="3918516">=</span>&nbsp;<span class="num" id="3918518">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3918524">copy</span><span class="op" id="3918528">(</span><span class="ident" id="3918529">dest</span><span class="op" id="3918533">[</span><span class="ident" id="3918534">numPaddingBytes</span><span class="op" id="3918549">:</span><span class="op" id="3918550">]</span><span class="op" id="3918551">,</span>&nbsp;<span class="ident" id="3918553">src</span><span class="op" id="3918556">)</span><br>
<span class="lineno"></span><span class="op" id="3918558">}</span>
</div>
</body>
</html>
