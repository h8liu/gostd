<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1429829">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1429885">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1429939">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1429990">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1430008">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1430059">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1430106">//</span><br>
<span class="lineno"></span><span class="comment" id="1430109">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1430175">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1430246">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1430315">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1430354">//</span><br>
<span class="lineno"></span><span class="comment" id="1430357">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1430431">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1430503">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1430572">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1430644">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1430711">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1430787">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1430859">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1430933">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1431011">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1431089">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1431169">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1431240">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1431318">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1431391">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1431413">//</span><br>
<span class="lineno">30</span><span class="comment" id="1431416">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1431488">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1431569">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1431646">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1431716">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1431789">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1431865">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1431939">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1432020">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1432104">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1432186">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1432225">//</span><br>
<span class="lineno"></span><span class="comment" id="1432228">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1432289">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1432367">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1432433">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1432506">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1432580">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1432653">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1432729">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1432794">package</span>&nbsp;<span class="ident" id="1432802">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432811">import</span>&nbsp;<span class="string" id="1432818">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1432828">const</span>&nbsp;<span class="op" id="1432834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432837">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1432853">=</span>&nbsp;<span class="num" id="1432855">1</span>&nbsp;<span class="op" id="1432857">&lt;&lt;</span>&nbsp;<span class="num" id="1432860">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432864">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1432880">=</span>&nbsp;<span class="num" id="1432882">1</span>&nbsp;<span class="op" id="1432884">&lt;&lt;</span>&nbsp;<span class="num" id="1432887">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432891">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1432907">=</span>&nbsp;<span class="num" id="1432909">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432912">maxCPUProfStack</span>&nbsp;<span class="op" id="1432928">=</span>&nbsp;<span class="num" id="1432930">64</span><br>
<span class="lineno">60</span><span class="op" id="1432933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432936">type</span>&nbsp;<span class="ident" id="1432941">cpuprofEntry</span>&nbsp;<span class="keyword" id="1432954">struct</span>&nbsp;<span class="op" id="1432961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432964">count</span>&nbsp;<span class="builtintype" id="1432970">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432979">depth</span>&nbsp;<span class="builtintype" id="1432985">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432994">stack</span>&nbsp;<span class="op" id="1433000">[</span><span class="ident" id="1433001">maxCPUProfStack</span><span class="op" id="1433016">]</span><span class="builtintype" id="1433017">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1433025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433028">type</span>&nbsp;<span class="ident" id="1433033">cpuProfile</span>&nbsp;<span class="keyword" id="1433044">struct</span>&nbsp;<span class="op" id="1433051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433054">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1433061">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1433069">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433089">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1433096">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1433104">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433129">count</span>&nbsp;&nbsp;<span class="builtintype" id="1433136">uintptr</span>&nbsp;<span class="comment" id="1433144">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433159">evicts</span>&nbsp;<span class="builtintype" id="1433166">uintptr</span>&nbsp;<span class="comment" id="1433174">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433193">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1433200">uintptr</span>&nbsp;<span class="comment" id="1433208">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433247">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433279">hash</span>&nbsp;<span class="op" id="1433284">[</span><span class="ident" id="1433285">numBuckets</span><span class="op" id="1433295">]</span><span class="keyword" id="1433296">struct</span>&nbsp;<span class="op" id="1433303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433307">entry</span>&nbsp;<span class="op" id="1433313">[</span><span class="ident" id="1433314">assoc</span><span class="op" id="1433319">]</span><span class="ident" id="1433320">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433338">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433375">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433425">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433475">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1433483">[</span><span class="num" id="1433484">2</span><span class="op" id="1433485">]</span><span class="op" id="1433486">[</span><span class="ident" id="1433487">logSize</span>&nbsp;<span class="op" id="1433495">/</span>&nbsp;<span class="num" id="1433497">2</span><span class="op" id="1433498">]</span><span class="builtintype" id="1433499">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433508">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1433516">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433525">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1433533">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433540">handoff</span>&nbsp;<span class="builtintype" id="1433548">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433557">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433575">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433626">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433666">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1433675">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433683">wholding</span>&nbsp;<span class="builtintype" id="1433692">bool</span>&nbsp;<span class="comment" id="1433697">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433738">flushing</span>&nbsp;<span class="builtintype" id="1433747">bool</span>&nbsp;<span class="comment" id="1433752">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433794">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1433803">bool</span>&nbsp;<span class="comment" id="1433808">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1433856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433859">var</span>&nbsp;<span class="op" id="1433863">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433866">cpuprofLock</span>&nbsp;<span class="ident" id="1433878">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433885">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1433897">*</span><span class="ident" id="1433898">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433911">eod</span>&nbsp;<span class="op" id="1433915">=</span>&nbsp;<span class="op" id="1433917">[</span><span class="num" id="1433918">3</span><span class="op" id="1433919">]</span><span class="builtintype" id="1433920">uintptr</span><span class="op" id="1433927">{</span><span class="num" id="1433928">0</span><span class="op" id="1433929">,</span>&nbsp;<span class="num" id="1433931">1</span><span class="op" id="1433932">,</span>&nbsp;<span class="num" id="1433934">0</span><span class="op" id="1433935">}</span><br>
<span class="lineno"></span><span class="op" id="1433937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433940">func</span>&nbsp;<span class="ident" id="1433945">setcpuprofilerate_m</span><span class="op" id="1433964">(</span><span class="op" id="1433965">)</span>&nbsp;<span class="comment" id="1433967">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1433978">func</span>&nbsp;<span class="ident" id="1433983">setcpuprofilerate</span><span class="op" id="1434000">(</span><span class="ident" id="1434001">hz</span>&nbsp;<span class="builtintype" id="1434004">int32</span><span class="op" id="1434009">)</span>&nbsp;<span class="op" id="1434011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434014">g</span>&nbsp;<span class="op" id="1434016">:=</span>&nbsp;<span class="ident" id="1434019">getg</span><span class="op" id="1434023">(</span><span class="op" id="1434024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434027">g</span><span class="op" id="1434028">.</span><span class="ident" id="1434029">m</span><span class="op" id="1434030">.</span><span class="ident" id="1434031">scalararg</span><span class="op" id="1434040">[</span><span class="num" id="1434041">0</span><span class="op" id="1434042">]</span>&nbsp;<span class="op" id="1434044">=</span>&nbsp;<span class="builtintype" id="1434046">uintptr</span><span class="op" id="1434053">(</span><span class="ident" id="1434054">hz</span><span class="op" id="1434056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434059">onM</span><span class="op" id="1434062">(</span><span class="ident" id="1434063">setcpuprofilerate_m</span><span class="op" id="1434082">)</span><br>
<span class="lineno">110</span><span class="op" id="1434084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434087">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1434143">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1434201">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1434240">func</span>&nbsp;<span class="ident" id="1434245">lostProfileData</span><span class="op" id="1434260">(</span><span class="op" id="1434261">)</span>&nbsp;<span class="op" id="1434263">{</span><span class="op" id="1434264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434267">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1434342">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1434396">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1434479">//</span><br>
<span class="lineno"></span><span class="comment" id="1434482">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1434538">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1434604">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1434635">func</span>&nbsp;<span class="ident" id="1434640">SetCPUProfileRate</span><span class="op" id="1434657">(</span><span class="ident" id="1434658">hz</span>&nbsp;<span class="builtintype" id="1434661">int</span><span class="op" id="1434664">)</span>&nbsp;<span class="op" id="1434666">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434669">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434707">if</span>&nbsp;<span class="ident" id="1434710">hz</span>&nbsp;<span class="op" id="1434713">&lt;</span>&nbsp;<span class="num" id="1434715">0</span>&nbsp;<span class="op" id="1434717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434721">hz</span>&nbsp;<span class="op" id="1434724">=</span>&nbsp;<span class="num" id="1434726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434732">if</span>&nbsp;<span class="ident" id="1434735">hz</span>&nbsp;<span class="op" id="1434738">&gt;</span>&nbsp;<span class="num" id="1434740">1000000</span>&nbsp;<span class="op" id="1434748">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434752">hz</span>&nbsp;<span class="op" id="1434755">=</span>&nbsp;<span class="num" id="1434757">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434770">lock</span><span class="op" id="1434774">(</span><span class="op" id="1434775">&amp;</span><span class="ident" id="1434776">cpuprofLock</span><span class="op" id="1434787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434790">if</span>&nbsp;<span class="ident" id="1434793">hz</span>&nbsp;<span class="op" id="1434796">&gt;</span>&nbsp;<span class="num" id="1434798">0</span>&nbsp;<span class="op" id="1434800">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434804">if</span>&nbsp;<span class="ident" id="1434807">cpuprof</span>&nbsp;<span class="op" id="1434815">==</span>&nbsp;<span class="ident" id="1434818">nil</span>&nbsp;<span class="op" id="1434822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434827">cpuprof</span>&nbsp;<span class="op" id="1434835">=</span>&nbsp;<span class="op" id="1434837">(</span><span class="op" id="1434838">*</span><span class="ident" id="1434839">cpuProfile</span><span class="op" id="1434849">)</span><span class="op" id="1434850">(</span><span class="ident" id="1434851">sysAlloc</span><span class="op" id="1434859">(</span><span class="ident" id="1434860">unsafe</span><span class="op" id="1434866">.</span><span class="ident" id="1434867">Sizeof</span><span class="op" id="1434873">(</span><span class="ident" id="1434874">cpuProfile</span><span class="op" id="1434884">{</span><span class="op" id="1434885">}</span><span class="op" id="1434886">)</span><span class="op" id="1434887">,</span>&nbsp;<span class="op" id="1434889">&amp;</span><span class="ident" id="1434890">memstats</span><span class="op" id="1434898">.</span><span class="ident" id="1434899">other_sys</span><span class="op" id="1434908">)</span><span class="op" id="1434909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434914">if</span>&nbsp;<span class="ident" id="1434917">cpuprof</span>&nbsp;<span class="op" id="1434925">==</span>&nbsp;<span class="ident" id="1434928">nil</span>&nbsp;<span class="op" id="1434932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1434938">print</span><span class="op" id="1434943">(</span><span class="string" id="1434944">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1434993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434999">unlock</span><span class="op" id="1435005">(</span><span class="op" id="1435006">&amp;</span><span class="ident" id="1435007">cpuprofLock</span><span class="op" id="1435018">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435024">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435042">if</span>&nbsp;<span class="ident" id="1435045">cpuprof</span><span class="op" id="1435052">.</span><span class="ident" id="1435053">on</span>&nbsp;<span class="op" id="1435056">||</span>&nbsp;<span class="ident" id="1435059">cpuprof</span><span class="op" id="1435066">.</span><span class="ident" id="1435067">handoff</span>&nbsp;<span class="op" id="1435075">!=</span>&nbsp;<span class="num" id="1435078">0</span>&nbsp;<span class="op" id="1435080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1435085">print</span><span class="op" id="1435090">(</span><span class="string" id="1435091">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1435168">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435173">unlock</span><span class="op" id="1435179">(</span><span class="op" id="1435180">&amp;</span><span class="ident" id="1435181">cpuprofLock</span><span class="op" id="1435192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435197">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435211">cpuprof</span><span class="op" id="1435218">.</span><span class="ident" id="1435219">on</span>&nbsp;<span class="op" id="1435222">=</span>&nbsp;<span class="builtintype" id="1435224">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435231">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435264">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435354">p</span>&nbsp;<span class="op" id="1435356">:=</span>&nbsp;<span class="op" id="1435359">&amp;</span><span class="ident" id="1435360">cpuprof</span><span class="op" id="1435367">.</span><span class="ident" id="1435368">log</span><span class="op" id="1435371">[</span><span class="num" id="1435372">0</span><span class="op" id="1435373">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435377">p</span><span class="op" id="1435378">[</span><span class="num" id="1435379">0</span><span class="op" id="1435380">]</span>&nbsp;<span class="op" id="1435382">=</span>&nbsp;<span class="num" id="1435384">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1435402">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435424">p</span><span class="op" id="1435425">[</span><span class="num" id="1435426">1</span><span class="op" id="1435427">]</span>&nbsp;<span class="op" id="1435429">=</span>&nbsp;<span class="num" id="1435431">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1435449">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435471">p</span><span class="op" id="1435472">[</span><span class="num" id="1435473">2</span><span class="op" id="1435474">]</span>&nbsp;<span class="op" id="1435476">=</span>&nbsp;<span class="num" id="1435478">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1435496">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435516">p</span><span class="op" id="1435517">[</span><span class="num" id="1435518">3</span><span class="op" id="1435519">]</span>&nbsp;<span class="op" id="1435521">=</span>&nbsp;<span class="builtintype" id="1435523">uintptr</span><span class="op" id="1435530">(</span><span class="num" id="1435531">1e6</span>&nbsp;<span class="op" id="1435535">/</span>&nbsp;<span class="ident" id="1435537">hz</span><span class="op" id="1435539">)</span>&nbsp;<span class="comment" id="1435541">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435568">p</span><span class="op" id="1435569">[</span><span class="num" id="1435570">4</span><span class="op" id="1435571">]</span>&nbsp;<span class="op" id="1435573">=</span>&nbsp;<span class="num" id="1435575">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435579">cpuprof</span><span class="op" id="1435586">.</span><span class="ident" id="1435587">nlog</span>&nbsp;<span class="op" id="1435592">=</span>&nbsp;<span class="num" id="1435594">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435598">cpuprof</span><span class="op" id="1435605">.</span><span class="ident" id="1435606">toggle</span>&nbsp;<span class="op" id="1435613">=</span>&nbsp;<span class="num" id="1435615">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435619">cpuprof</span><span class="op" id="1435626">.</span><span class="ident" id="1435627">wholding</span>&nbsp;<span class="op" id="1435636">=</span>&nbsp;<span class="builtintype" id="1435638">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435646">cpuprof</span><span class="op" id="1435653">.</span><span class="ident" id="1435654">wtoggle</span>&nbsp;<span class="op" id="1435662">=</span>&nbsp;<span class="num" id="1435664">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435668">cpuprof</span><span class="op" id="1435675">.</span><span class="ident" id="1435676">flushing</span>&nbsp;<span class="op" id="1435685">=</span>&nbsp;<span class="builtintype" id="1435687">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435695">cpuprof</span><span class="op" id="1435702">.</span><span class="ident" id="1435703">eodSent</span>&nbsp;<span class="op" id="1435711">=</span>&nbsp;<span class="builtintype" id="1435713">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435721">noteclear</span><span class="op" id="1435730">(</span><span class="op" id="1435731">&amp;</span><span class="ident" id="1435732">cpuprof</span><span class="op" id="1435739">.</span><span class="ident" id="1435740">wait</span><span class="op" id="1435744">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435749">setcpuprofilerate</span><span class="op" id="1435766">(</span><span class="builtintype" id="1435767">int32</span><span class="op" id="1435772">(</span><span class="ident" id="1435773">hz</span><span class="op" id="1435775">)</span><span class="op" id="1435776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435779">}</span>&nbsp;<span class="keyword" id="1435781">else</span>&nbsp;<span class="keyword" id="1435786">if</span>&nbsp;<span class="ident" id="1435789">cpuprof</span>&nbsp;<span class="op" id="1435797">!=</span>&nbsp;<span class="ident" id="1435800">nil</span>&nbsp;<span class="op" id="1435804">&amp;&amp;</span>&nbsp;<span class="ident" id="1435807">cpuprof</span><span class="op" id="1435814">.</span><span class="ident" id="1435815">on</span>&nbsp;<span class="op" id="1435818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435822">setcpuprofilerate</span><span class="op" id="1435839">(</span><span class="num" id="1435840">0</span><span class="op" id="1435841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435845">cpuprof</span><span class="op" id="1435852">.</span><span class="ident" id="1435853">on</span>&nbsp;<span class="op" id="1435856">=</span>&nbsp;<span class="builtintype" id="1435858">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435867">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435940">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435999">for</span>&nbsp;<span class="op" id="1436003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436008">n</span>&nbsp;<span class="op" id="1436010">:=</span>&nbsp;<span class="ident" id="1436013">cpuprof</span><span class="op" id="1436020">.</span><span class="ident" id="1436021">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436032">if</span>&nbsp;<span class="ident" id="1436035">n</span><span class="op" id="1436036">&amp;</span><span class="num" id="1436037">0x80000000</span>&nbsp;<span class="op" id="1436048">!=</span>&nbsp;<span class="num" id="1436051">0</span>&nbsp;<span class="op" id="1436053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1436059">print</span><span class="op" id="1436064">(</span><span class="string" id="1436065">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1436102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436112">if</span>&nbsp;<span class="ident" id="1436115">cas</span><span class="op" id="1436118">(</span><span class="op" id="1436119">&amp;</span><span class="ident" id="1436120">cpuprof</span><span class="op" id="1436127">.</span><span class="ident" id="1436128">handoff</span><span class="op" id="1436135">,</span>&nbsp;<span class="ident" id="1436137">n</span><span class="op" id="1436138">,</span>&nbsp;<span class="ident" id="1436140">n</span><span class="op" id="1436141">|</span><span class="num" id="1436142">0x80000000</span><span class="op" id="1436152">)</span>&nbsp;<span class="op" id="1436154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436160">if</span>&nbsp;<span class="ident" id="1436163">n</span>&nbsp;<span class="op" id="1436165">==</span>&nbsp;<span class="num" id="1436168">0</span>&nbsp;<span class="op" id="1436170">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436177">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436247">notewakeup</span><span class="op" id="1436257">(</span><span class="op" id="1436258">&amp;</span><span class="ident" id="1436259">cpuprof</span><span class="op" id="1436266">.</span><span class="ident" id="1436267">wait</span><span class="op" id="1436271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436283">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436292">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436302">unlock</span><span class="op" id="1436308">(</span><span class="op" id="1436309">&amp;</span><span class="ident" id="1436310">cpuprofLock</span><span class="op" id="1436321">)</span><br>
<span class="lineno"></span><span class="op" id="1436323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1436326">func</span>&nbsp;<span class="ident" id="1436331">cpuproftick</span><span class="op" id="1436342">(</span><span class="ident" id="1436343">pc</span>&nbsp;<span class="op" id="1436346">*</span><span class="builtintype" id="1436347">uintptr</span><span class="op" id="1436354">,</span>&nbsp;<span class="ident" id="1436356">n</span>&nbsp;<span class="builtintype" id="1436358">int32</span><span class="op" id="1436363">)</span>&nbsp;<span class="op" id="1436365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436368">if</span>&nbsp;<span class="ident" id="1436371">n</span>&nbsp;<span class="op" id="1436373">&gt;</span>&nbsp;<span class="ident" id="1436375">maxCPUProfStack</span>&nbsp;<span class="op" id="1436391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436395">n</span>&nbsp;<span class="op" id="1436397">=</span>&nbsp;<span class="ident" id="1436399">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436419">s</span>&nbsp;<span class="op" id="1436421">:=</span>&nbsp;<span class="op" id="1436424">(</span><span class="op" id="1436425">*</span><span class="op" id="1436426">[</span><span class="ident" id="1436427">maxCPUProfStack</span><span class="op" id="1436442">]</span><span class="builtintype" id="1436443">uintptr</span><span class="op" id="1436450">)</span><span class="op" id="1436451">(</span><span class="ident" id="1436452">unsafe</span><span class="op" id="1436458">.</span><span class="ident" id="1436459">Pointer</span><span class="op" id="1436466">(</span><span class="ident" id="1436467">pc</span><span class="op" id="1436469">)</span><span class="op" id="1436470">)</span><span class="op" id="1436471">[</span><span class="op" id="1436472">:</span><span class="ident" id="1436473">n</span><span class="op" id="1436474">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436477">cpuprof</span><span class="op" id="1436484">.</span><span class="ident" id="1436485">add</span><span class="op" id="1436488">(</span><span class="ident" id="1436489">s</span><span class="op" id="1436490">)</span><br>
<span class="lineno"></span><span class="op" id="1436492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1436495">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1436539">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1436607">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1436668">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1436738">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1436781">func</span>&nbsp;<span class="op" id="1436786">(</span><span class="ident" id="1436787">p</span>&nbsp;<span class="op" id="1436789">*</span><span class="ident" id="1436790">cpuProfile</span><span class="op" id="1436800">)</span>&nbsp;<span class="ident" id="1436802">add</span><span class="op" id="1436805">(</span><span class="ident" id="1436806">pc</span>&nbsp;<span class="op" id="1436809">[</span><span class="op" id="1436810">]</span><span class="builtintype" id="1436811">uintptr</span><span class="op" id="1436818">)</span>&nbsp;<span class="op" id="1436820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436823">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436841">h</span>&nbsp;<span class="op" id="1436843">:=</span>&nbsp;<span class="builtintype" id="1436846">uintptr</span><span class="op" id="1436853">(</span><span class="num" id="1436854">0</span><span class="op" id="1436855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436858">for</span>&nbsp;<span class="ident" id="1436862">_</span><span class="op" id="1436863">,</span>&nbsp;<span class="ident" id="1436865">x</span>&nbsp;<span class="op" id="1436867">:=</span>&nbsp;<span class="keyword" id="1436870">range</span>&nbsp;<span class="ident" id="1436876">pc</span>&nbsp;<span class="op" id="1436879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436883">h</span>&nbsp;<span class="op" id="1436885">=</span>&nbsp;<span class="ident" id="1436887">h</span><span class="op" id="1436888">&lt;&lt;</span><span class="num" id="1436890">8</span>&nbsp;<span class="op" id="1436892">|</span>&nbsp;<span class="op" id="1436894">(</span><span class="ident" id="1436895">h</span>&nbsp;<span class="op" id="1436897">&gt;&gt;</span>&nbsp;<span class="op" id="1436900">(</span><span class="num" id="1436901">8</span>&nbsp;<span class="op" id="1436903">*</span>&nbsp;<span class="op" id="1436905">(</span><span class="ident" id="1436906">unsafe</span><span class="op" id="1436912">.</span><span class="ident" id="1436913">Sizeof</span><span class="op" id="1436919">(</span><span class="ident" id="1436920">h</span><span class="op" id="1436921">)</span>&nbsp;<span class="op" id="1436923">-</span>&nbsp;<span class="num" id="1436925">1</span><span class="op" id="1436926">)</span><span class="op" id="1436927">)</span><span class="op" id="1436928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436932">h</span>&nbsp;<span class="op" id="1436934">+=</span>&nbsp;<span class="ident" id="1436937">x</span><span class="op" id="1436938">*</span><span class="num" id="1436939">31</span>&nbsp;<span class="op" id="1436942">+</span>&nbsp;<span class="ident" id="1436944">x</span><span class="op" id="1436945">*</span><span class="num" id="1436946">7</span>&nbsp;<span class="op" id="1436948">+</span>&nbsp;<span class="ident" id="1436950">x</span><span class="op" id="1436951">*</span><span class="num" id="1436952">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436955">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436958">p</span><span class="op" id="1436959">.</span><span class="ident" id="1436960">count</span><span class="op" id="1436965">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1436970">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437022">b</span>&nbsp;<span class="op" id="1437024">:=</span>&nbsp;<span class="op" id="1437027">&amp;</span><span class="ident" id="1437028">p</span><span class="op" id="1437029">.</span><span class="ident" id="1437030">hash</span><span class="op" id="1437034">[</span><span class="ident" id="1437035">h</span><span class="op" id="1437036">%</span><span class="ident" id="1437037">numBuckets</span><span class="op" id="1437047">]</span><br>
<span class="lineno"></span><span class="ident" id="1437049">Assoc</span><span class="op" id="1437054">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437057">for</span>&nbsp;<span class="ident" id="1437061">i</span>&nbsp;<span class="op" id="1437063">:=</span>&nbsp;<span class="keyword" id="1437066">range</span>&nbsp;<span class="ident" id="1437072">b</span><span class="op" id="1437073">.</span><span class="ident" id="1437074">entry</span>&nbsp;<span class="op" id="1437080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437084">e</span>&nbsp;<span class="op" id="1437086">:=</span>&nbsp;<span class="op" id="1437089">&amp;</span><span class="ident" id="1437090">b</span><span class="op" id="1437091">.</span><span class="ident" id="1437092">entry</span><span class="op" id="1437097">[</span><span class="ident" id="1437098">i</span><span class="op" id="1437099">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437103">if</span>&nbsp;<span class="ident" id="1437106">e</span><span class="op" id="1437107">.</span><span class="ident" id="1437108">depth</span>&nbsp;<span class="op" id="1437114">!=</span>&nbsp;<span class="builtintype" id="1437117">uintptr</span><span class="op" id="1437124">(</span><span class="builtinfunc" id="1437125">len</span><span class="op" id="1437128">(</span><span class="ident" id="1437129">pc</span><span class="op" id="1437131">)</span><span class="op" id="1437132">)</span>&nbsp;<span class="op" id="1437134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437139">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437150">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437154">for</span>&nbsp;<span class="ident" id="1437158">j</span>&nbsp;<span class="op" id="1437160">:=</span>&nbsp;<span class="keyword" id="1437163">range</span>&nbsp;<span class="ident" id="1437169">pc</span>&nbsp;<span class="op" id="1437172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437177">if</span>&nbsp;<span class="ident" id="1437180">e</span><span class="op" id="1437181">.</span><span class="ident" id="1437182">stack</span><span class="op" id="1437187">[</span><span class="ident" id="1437188">j</span><span class="op" id="1437189">]</span>&nbsp;<span class="op" id="1437191">!=</span>&nbsp;<span class="ident" id="1437194">pc</span><span class="op" id="1437196">[</span><span class="ident" id="1437197">j</span><span class="op" id="1437198">]</span>&nbsp;<span class="op" id="1437200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437206">continue</span>&nbsp;<span class="ident" id="1437215">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437228">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437232">e</span><span class="op" id="1437233">.</span><span class="ident" id="1437234">count</span><span class="op" id="1437239">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437244">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1437256">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437293">var</span>&nbsp;<span class="ident" id="1437297">e</span>&nbsp;<span class="op" id="1437299">*</span><span class="ident" id="1437300">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437314">for</span>&nbsp;<span class="ident" id="1437318">i</span>&nbsp;<span class="op" id="1437320">:=</span>&nbsp;<span class="keyword" id="1437323">range</span>&nbsp;<span class="ident" id="1437329">b</span><span class="op" id="1437330">.</span><span class="ident" id="1437331">entry</span>&nbsp;<span class="op" id="1437337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437341">if</span>&nbsp;<span class="ident" id="1437344">e</span>&nbsp;<span class="op" id="1437346">==</span>&nbsp;<span class="ident" id="1437349">nil</span>&nbsp;<span class="op" id="1437353">||</span>&nbsp;<span class="ident" id="1437356">b</span><span class="op" id="1437357">.</span><span class="ident" id="1437358">entry</span><span class="op" id="1437363">[</span><span class="ident" id="1437364">i</span><span class="op" id="1437365">]</span><span class="op" id="1437366">.</span><span class="ident" id="1437367">count</span>&nbsp;<span class="op" id="1437373">&lt;</span>&nbsp;<span class="ident" id="1437375">e</span><span class="op" id="1437376">.</span><span class="ident" id="1437377">count</span>&nbsp;<span class="op" id="1437383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437388">e</span>&nbsp;<span class="op" id="1437390">=</span>&nbsp;<span class="op" id="1437392">&amp;</span><span class="ident" id="1437393">b</span><span class="op" id="1437394">.</span><span class="ident" id="1437395">entry</span><span class="op" id="1437400">[</span><span class="ident" id="1437401">i</span><span class="op" id="1437402">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437406">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437412">if</span>&nbsp;<span class="ident" id="1437415">e</span><span class="op" id="1437416">.</span><span class="ident" id="1437417">count</span>&nbsp;<span class="op" id="1437423">&gt;</span>&nbsp;<span class="num" id="1437425">0</span>&nbsp;<span class="op" id="1437427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437431">if</span>&nbsp;<span class="op" id="1437434">!</span><span class="ident" id="1437435">p</span><span class="op" id="1437436">.</span><span class="ident" id="1437437">evict</span><span class="op" id="1437442">(</span><span class="ident" id="1437443">e</span><span class="op" id="1437444">)</span>&nbsp;<span class="op" id="1437446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1437451">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437500">p</span><span class="op" id="1437501">.</span><span class="ident" id="1437502">lost</span><span class="op" id="1437506">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437512">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437525">p</span><span class="op" id="1437526">.</span><span class="ident" id="1437527">evicts</span><span class="op" id="1437533">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1437541">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437576">e</span><span class="op" id="1437577">.</span><span class="ident" id="1437578">depth</span>&nbsp;<span class="op" id="1437584">=</span>&nbsp;<span class="builtintype" id="1437586">uintptr</span><span class="op" id="1437593">(</span><span class="builtinfunc" id="1437594">len</span><span class="op" id="1437597">(</span><span class="ident" id="1437598">pc</span><span class="op" id="1437600">)</span><span class="op" id="1437601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437604">e</span><span class="op" id="1437605">.</span><span class="ident" id="1437606">count</span>&nbsp;<span class="op" id="1437612">=</span>&nbsp;<span class="num" id="1437614">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1437617">copy</span><span class="op" id="1437621">(</span><span class="ident" id="1437622">e</span><span class="op" id="1437623">.</span><span class="ident" id="1437624">stack</span><span class="op" id="1437629">[</span><span class="op" id="1437630">:</span><span class="op" id="1437631">]</span><span class="op" id="1437632">,</span>&nbsp;<span class="ident" id="1437634">pc</span><span class="op" id="1437636">)</span><br>
<span class="lineno"></span><span class="op" id="1437638">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1437641">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1437702">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1437763">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1437826">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1437885">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1437943">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1437984">func</span>&nbsp;<span class="op" id="1437989">(</span><span class="ident" id="1437990">p</span>&nbsp;<span class="op" id="1437992">*</span><span class="ident" id="1437993">cpuProfile</span><span class="op" id="1438003">)</span>&nbsp;<span class="ident" id="1438005">evict</span><span class="op" id="1438010">(</span><span class="ident" id="1438011">e</span>&nbsp;<span class="op" id="1438013">*</span><span class="ident" id="1438014">cpuprofEntry</span><span class="op" id="1438026">)</span>&nbsp;<span class="builtintype" id="1438028">bool</span>&nbsp;<span class="op" id="1438033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438036">d</span>&nbsp;<span class="op" id="1438038">:=</span>&nbsp;<span class="ident" id="1438041">e</span><span class="op" id="1438042">.</span><span class="ident" id="1438043">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438050">nslot</span>&nbsp;<span class="op" id="1438056">:=</span>&nbsp;<span class="ident" id="1438059">d</span>&nbsp;<span class="op" id="1438061">+</span>&nbsp;<span class="num" id="1438063">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438066">log</span>&nbsp;<span class="op" id="1438070">:=</span>&nbsp;<span class="op" id="1438073">&amp;</span><span class="ident" id="1438074">p</span><span class="op" id="1438075">.</span><span class="ident" id="1438076">log</span><span class="op" id="1438079">[</span><span class="ident" id="1438080">p</span><span class="op" id="1438081">.</span><span class="ident" id="1438082">toggle</span><span class="op" id="1438088">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438091">if</span>&nbsp;<span class="ident" id="1438094">p</span><span class="op" id="1438095">.</span><span class="ident" id="1438096">nlog</span><span class="op" id="1438100">+</span><span class="ident" id="1438101">nslot</span>&nbsp;<span class="op" id="1438107">&gt;</span>&nbsp;<span class="builtintype" id="1438109">uintptr</span><span class="op" id="1438116">(</span><span class="builtinfunc" id="1438117">len</span><span class="op" id="1438120">(</span><span class="ident" id="1438121">p</span><span class="op" id="1438122">.</span><span class="ident" id="1438123">log</span><span class="op" id="1438126">[</span><span class="num" id="1438127">0</span><span class="op" id="1438128">]</span><span class="op" id="1438129">)</span><span class="op" id="1438130">)</span>&nbsp;<span class="op" id="1438132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438136">if</span>&nbsp;<span class="op" id="1438139">!</span><span class="ident" id="1438140">p</span><span class="op" id="1438141">.</span><span class="ident" id="1438142">flushlog</span><span class="op" id="1438150">(</span><span class="op" id="1438151">)</span>&nbsp;<span class="op" id="1438153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438158">return</span>&nbsp;<span class="builtintype" id="1438165">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438173">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438177">log</span>&nbsp;<span class="op" id="1438181">=</span>&nbsp;<span class="op" id="1438183">&amp;</span><span class="ident" id="1438184">p</span><span class="op" id="1438185">.</span><span class="ident" id="1438186">log</span><span class="op" id="1438189">[</span><span class="ident" id="1438190">p</span><span class="op" id="1438191">.</span><span class="ident" id="1438192">toggle</span><span class="op" id="1438198">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438205">q</span>&nbsp;<span class="op" id="1438207">:=</span>&nbsp;<span class="ident" id="1438210">p</span><span class="op" id="1438211">.</span><span class="ident" id="1438212">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438218">log</span><span class="op" id="1438221">[</span><span class="ident" id="1438222">q</span><span class="op" id="1438223">]</span>&nbsp;<span class="op" id="1438225">=</span>&nbsp;<span class="ident" id="1438227">e</span><span class="op" id="1438228">.</span><span class="ident" id="1438229">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438236">q</span><span class="op" id="1438237">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438241">log</span><span class="op" id="1438244">[</span><span class="ident" id="1438245">q</span><span class="op" id="1438246">]</span>&nbsp;<span class="op" id="1438248">=</span>&nbsp;<span class="ident" id="1438250">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438253">q</span><span class="op" id="1438254">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1438258">copy</span><span class="op" id="1438262">(</span><span class="ident" id="1438263">log</span><span class="op" id="1438266">[</span><span class="ident" id="1438267">q</span><span class="op" id="1438268">:</span><span class="op" id="1438269">]</span><span class="op" id="1438270">,</span>&nbsp;<span class="ident" id="1438272">e</span><span class="op" id="1438273">.</span><span class="ident" id="1438274">stack</span><span class="op" id="1438279">[</span><span class="op" id="1438280">:</span><span class="ident" id="1438281">d</span><span class="op" id="1438282">]</span><span class="op" id="1438283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438286">q</span>&nbsp;<span class="op" id="1438288">+=</span>&nbsp;<span class="ident" id="1438291">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438294">p</span><span class="op" id="1438295">.</span><span class="ident" id="1438296">nlog</span>&nbsp;<span class="op" id="1438301">=</span>&nbsp;<span class="ident" id="1438303">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438306">e</span><span class="op" id="1438307">.</span><span class="ident" id="1438308">count</span>&nbsp;<span class="op" id="1438314">=</span>&nbsp;<span class="num" id="1438316">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438319">return</span>&nbsp;<span class="builtintype" id="1438326">true</span><br>
<span class="lineno"></span><span class="op" id="1438331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1438334">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1438406">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1438489">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1438561">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1438640">func</span>&nbsp;<span class="op" id="1438645">(</span><span class="ident" id="1438646">p</span>&nbsp;<span class="op" id="1438648">*</span><span class="ident" id="1438649">cpuProfile</span><span class="op" id="1438659">)</span>&nbsp;<span class="ident" id="1438661">flushlog</span><span class="op" id="1438669">(</span><span class="op" id="1438670">)</span>&nbsp;<span class="builtintype" id="1438672">bool</span>&nbsp;<span class="op" id="1438677">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438680">if</span>&nbsp;<span class="op" id="1438683">!</span><span class="ident" id="1438684">cas</span><span class="op" id="1438687">(</span><span class="op" id="1438688">&amp;</span><span class="ident" id="1438689">p</span><span class="op" id="1438690">.</span><span class="ident" id="1438691">handoff</span><span class="op" id="1438698">,</span>&nbsp;<span class="num" id="1438700">0</span><span class="op" id="1438701">,</span>&nbsp;<span class="builtintype" id="1438703">uint32</span><span class="op" id="1438709">(</span><span class="ident" id="1438710">p</span><span class="op" id="1438711">.</span><span class="ident" id="1438712">nlog</span><span class="op" id="1438716">)</span><span class="op" id="1438717">)</span>&nbsp;<span class="op" id="1438719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438723">return</span>&nbsp;<span class="builtintype" id="1438730">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438740">notewakeup</span><span class="op" id="1438750">(</span><span class="op" id="1438751">&amp;</span><span class="ident" id="1438752">p</span><span class="op" id="1438753">.</span><span class="ident" id="1438754">wait</span><span class="op" id="1438758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438762">p</span><span class="op" id="1438763">.</span><span class="ident" id="1438764">toggle</span>&nbsp;<span class="op" id="1438771">=</span>&nbsp;<span class="num" id="1438773">1</span>&nbsp;<span class="op" id="1438775">-</span>&nbsp;<span class="ident" id="1438777">p</span><span class="op" id="1438778">.</span><span class="ident" id="1438779">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438787">log</span>&nbsp;<span class="op" id="1438791">:=</span>&nbsp;<span class="op" id="1438794">&amp;</span><span class="ident" id="1438795">p</span><span class="op" id="1438796">.</span><span class="ident" id="1438797">log</span><span class="op" id="1438800">[</span><span class="ident" id="1438801">p</span><span class="op" id="1438802">.</span><span class="ident" id="1438803">toggle</span><span class="op" id="1438809">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438812">q</span>&nbsp;<span class="op" id="1438814">:=</span>&nbsp;<span class="builtintype" id="1438817">uintptr</span><span class="op" id="1438824">(</span><span class="num" id="1438825">0</span><span class="op" id="1438826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438829">if</span>&nbsp;<span class="ident" id="1438832">p</span><span class="op" id="1438833">.</span><span class="ident" id="1438834">lost</span>&nbsp;<span class="op" id="1438839">&gt;</span>&nbsp;<span class="num" id="1438841">0</span>&nbsp;<span class="op" id="1438843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438847">lostPC</span>&nbsp;<span class="op" id="1438854">:=</span>&nbsp;<span class="ident" id="1438857">funcPC</span><span class="op" id="1438863">(</span><span class="ident" id="1438864">lostProfileData</span><span class="op" id="1438879">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438883">log</span><span class="op" id="1438886">[</span><span class="num" id="1438887">0</span><span class="op" id="1438888">]</span>&nbsp;<span class="op" id="1438890">=</span>&nbsp;<span class="ident" id="1438892">p</span><span class="op" id="1438893">.</span><span class="ident" id="1438894">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438901">log</span><span class="op" id="1438904">[</span><span class="num" id="1438905">1</span><span class="op" id="1438906">]</span>&nbsp;<span class="op" id="1438908">=</span>&nbsp;<span class="num" id="1438910">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438914">log</span><span class="op" id="1438917">[</span><span class="num" id="1438918">2</span><span class="op" id="1438919">]</span>&nbsp;<span class="op" id="1438921">=</span>&nbsp;<span class="ident" id="1438923">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438932">q</span>&nbsp;<span class="op" id="1438934">=</span>&nbsp;<span class="num" id="1438936">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438940">p</span><span class="op" id="1438941">.</span><span class="ident" id="1438942">lost</span>&nbsp;<span class="op" id="1438947">=</span>&nbsp;<span class="num" id="1438949">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438955">p</span><span class="op" id="1438956">.</span><span class="ident" id="1438957">nlog</span>&nbsp;<span class="op" id="1438962">=</span>&nbsp;<span class="ident" id="1438964">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438967">return</span>&nbsp;<span class="builtintype" id="1438974">true</span><br>
<span class="lineno"></span><span class="op" id="1438979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1438982">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1439055">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1439128">func</span>&nbsp;<span class="op" id="1439133">(</span><span class="ident" id="1439134">p</span>&nbsp;<span class="op" id="1439136">*</span><span class="ident" id="1439137">cpuProfile</span><span class="op" id="1439147">)</span>&nbsp;<span class="ident" id="1439149">getprofile</span><span class="op" id="1439159">(</span><span class="op" id="1439160">)</span>&nbsp;<span class="op" id="1439162">[</span><span class="op" id="1439163">]</span><span class="builtintype" id="1439164">byte</span>&nbsp;<span class="op" id="1439169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439172">if</span>&nbsp;<span class="ident" id="1439175">p</span>&nbsp;<span class="op" id="1439177">==</span>&nbsp;<span class="ident" id="1439180">nil</span>&nbsp;<span class="op" id="1439184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439188">return</span>&nbsp;<span class="ident" id="1439195">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439204">if</span>&nbsp;<span class="ident" id="1439207">p</span><span class="op" id="1439208">.</span><span class="ident" id="1439209">wholding</span>&nbsp;<span class="op" id="1439218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439222">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439273">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439335">for</span>&nbsp;<span class="op" id="1439339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439344">n</span>&nbsp;<span class="op" id="1439346">:=</span>&nbsp;<span class="ident" id="1439349">p</span><span class="op" id="1439350">.</span><span class="ident" id="1439351">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439362">if</span>&nbsp;<span class="ident" id="1439365">n</span>&nbsp;<span class="op" id="1439367">==</span>&nbsp;<span class="num" id="1439370">0</span>&nbsp;<span class="op" id="1439372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1439378">print</span><span class="op" id="1439383">(</span><span class="string" id="1439384">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1439435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439441">return</span>&nbsp;<span class="ident" id="1439448">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439460">if</span>&nbsp;<span class="ident" id="1439463">n</span><span class="op" id="1439464">&amp;</span><span class="num" id="1439465">0x80000000</span>&nbsp;<span class="op" id="1439476">!=</span>&nbsp;<span class="num" id="1439479">0</span>&nbsp;<span class="op" id="1439481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439487">p</span><span class="op" id="1439488">.</span><span class="ident" id="1439489">wtoggle</span>&nbsp;<span class="op" id="1439497">=</span>&nbsp;<span class="num" id="1439499">1</span>&nbsp;<span class="op" id="1439501">-</span>&nbsp;<span class="ident" id="1439503">p</span><span class="op" id="1439504">.</span><span class="ident" id="1439505">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439517">p</span><span class="op" id="1439518">.</span><span class="ident" id="1439519">wholding</span>&nbsp;<span class="op" id="1439528">=</span>&nbsp;<span class="builtintype" id="1439530">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439540">p</span><span class="op" id="1439541">.</span><span class="ident" id="1439542">flushing</span>&nbsp;<span class="op" id="1439551">=</span>&nbsp;<span class="builtintype" id="1439553">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439562">goto</span>&nbsp;<span class="ident" id="1439567">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439581">if</span>&nbsp;<span class="ident" id="1439584">cas</span><span class="op" id="1439587">(</span><span class="op" id="1439588">&amp;</span><span class="ident" id="1439589">p</span><span class="op" id="1439590">.</span><span class="ident" id="1439591">handoff</span><span class="op" id="1439598">,</span>&nbsp;<span class="ident" id="1439600">n</span><span class="op" id="1439601">,</span>&nbsp;<span class="num" id="1439603">0</span><span class="op" id="1439604">)</span>&nbsp;<span class="op" id="1439606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439612">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439621">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439629">p</span><span class="op" id="1439630">.</span><span class="ident" id="1439631">wtoggle</span>&nbsp;<span class="op" id="1439639">=</span>&nbsp;<span class="num" id="1439641">1</span>&nbsp;<span class="op" id="1439643">-</span>&nbsp;<span class="ident" id="1439645">p</span><span class="op" id="1439646">.</span><span class="ident" id="1439647">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439657">p</span><span class="op" id="1439658">.</span><span class="ident" id="1439659">wholding</span>&nbsp;<span class="op" id="1439668">=</span>&nbsp;<span class="builtintype" id="1439670">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439681">if</span>&nbsp;<span class="ident" id="1439684">p</span><span class="op" id="1439685">.</span><span class="ident" id="1439686">flushing</span>&nbsp;<span class="op" id="1439695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439699">goto</span>&nbsp;<span class="ident" id="1439704">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439715">if</span>&nbsp;<span class="op" id="1439718">!</span><span class="ident" id="1439719">p</span><span class="op" id="1439720">.</span><span class="ident" id="1439721">on</span>&nbsp;<span class="op" id="1439724">&amp;&amp;</span>&nbsp;<span class="ident" id="1439727">p</span><span class="op" id="1439728">.</span><span class="ident" id="1439729">handoff</span>&nbsp;<span class="op" id="1439737">==</span>&nbsp;<span class="num" id="1439740">0</span>&nbsp;<span class="op" id="1439742">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439746">return</span>&nbsp;<span class="ident" id="1439753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439762">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439784">notetsleepg</span><span class="op" id="1439795">(</span><span class="op" id="1439796">&amp;</span><span class="ident" id="1439797">p</span><span class="op" id="1439798">.</span><span class="ident" id="1439799">wait</span><span class="op" id="1439803">,</span>&nbsp;<span class="op" id="1439805">-</span><span class="num" id="1439806">1</span><span class="op" id="1439807">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439810">noteclear</span><span class="op" id="1439819">(</span><span class="op" id="1439820">&amp;</span><span class="ident" id="1439821">p</span><span class="op" id="1439822">.</span><span class="ident" id="1439823">wait</span><span class="op" id="1439827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439831">switch</span>&nbsp;<span class="ident" id="1439838">n</span>&nbsp;<span class="op" id="1439840">:=</span>&nbsp;<span class="ident" id="1439843">p</span><span class="op" id="1439844">.</span><span class="ident" id="1439845">handoff</span><span class="op" id="1439852">;</span>&nbsp;<span class="op" id="1439854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439857">case</span>&nbsp;<span class="ident" id="1439862">n</span>&nbsp;<span class="op" id="1439864">==</span>&nbsp;<span class="num" id="1439867">0</span><span class="op" id="1439868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1439872">print</span><span class="op" id="1439877">(</span><span class="string" id="1439878">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1439926">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439930">return</span>&nbsp;<span class="ident" id="1439937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439942">case</span>&nbsp;<span class="ident" id="1439947">n</span>&nbsp;<span class="op" id="1439949">==</span>&nbsp;<span class="num" id="1439952">0x80000000</span><span class="op" id="1439962">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439966">p</span><span class="op" id="1439967">.</span><span class="ident" id="1439968">flushing</span>&nbsp;<span class="op" id="1439977">=</span>&nbsp;<span class="builtintype" id="1439979">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439986">goto</span>&nbsp;<span class="ident" id="1439991">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439998">default</span><span class="op" id="1440005">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440009">n</span>&nbsp;<span class="op" id="1440011">&amp;^=</span>&nbsp;<span class="num" id="1440015">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440029">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440060">p</span><span class="op" id="1440061">.</span><span class="ident" id="1440062">wholding</span>&nbsp;<span class="op" id="1440071">=</span>&nbsp;<span class="builtintype" id="1440073">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440081">return</span>&nbsp;<span class="ident" id="1440088">uintptrBytes</span><span class="op" id="1440100">(</span><span class="ident" id="1440101">p</span><span class="op" id="1440102">.</span><span class="ident" id="1440103">log</span><span class="op" id="1440106">[</span><span class="ident" id="1440107">p</span><span class="op" id="1440108">.</span><span class="ident" id="1440109">wtoggle</span><span class="op" id="1440116">]</span><span class="op" id="1440117">[</span><span class="op" id="1440118">:</span><span class="ident" id="1440119">n</span><span class="op" id="1440120">]</span><span class="op" id="1440121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440128">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440147">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440199">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440264">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1440316">Flush</span><span class="op" id="1440321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440324">for</span>&nbsp;<span class="ident" id="1440328">i</span>&nbsp;<span class="op" id="1440330">:=</span>&nbsp;<span class="keyword" id="1440333">range</span>&nbsp;<span class="ident" id="1440339">p</span><span class="op" id="1440340">.</span><span class="ident" id="1440341">hash</span>&nbsp;<span class="op" id="1440346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440350">b</span>&nbsp;<span class="op" id="1440352">:=</span>&nbsp;<span class="op" id="1440355">&amp;</span><span class="ident" id="1440356">p</span><span class="op" id="1440357">.</span><span class="ident" id="1440358">hash</span><span class="op" id="1440362">[</span><span class="ident" id="1440363">i</span><span class="op" id="1440364">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440368">for</span>&nbsp;<span class="ident" id="1440372">j</span>&nbsp;<span class="op" id="1440374">:=</span>&nbsp;<span class="keyword" id="1440377">range</span>&nbsp;<span class="ident" id="1440383">b</span><span class="op" id="1440384">.</span><span class="ident" id="1440385">entry</span>&nbsp;<span class="op" id="1440391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440396">e</span>&nbsp;<span class="op" id="1440398">:=</span>&nbsp;<span class="op" id="1440401">&amp;</span><span class="ident" id="1440402">b</span><span class="op" id="1440403">.</span><span class="ident" id="1440404">entry</span><span class="op" id="1440409">[</span><span class="ident" id="1440410">j</span><span class="op" id="1440411">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440416">if</span>&nbsp;<span class="ident" id="1440419">e</span><span class="op" id="1440420">.</span><span class="ident" id="1440421">count</span>&nbsp;<span class="op" id="1440427">&gt;</span>&nbsp;<span class="num" id="1440429">0</span>&nbsp;<span class="op" id="1440431">&amp;&amp;</span>&nbsp;<span class="op" id="1440434">!</span><span class="ident" id="1440435">p</span><span class="op" id="1440436">.</span><span class="ident" id="1440437">evict</span><span class="op" id="1440442">(</span><span class="ident" id="1440443">e</span><span class="op" id="1440444">)</span>&nbsp;<span class="op" id="1440446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440452">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440517">break</span>&nbsp;<span class="ident" id="1440523">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440543">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440572">if</span>&nbsp;<span class="ident" id="1440575">p</span><span class="op" id="1440576">.</span><span class="ident" id="1440577">nlog</span>&nbsp;<span class="op" id="1440582">&gt;</span>&nbsp;<span class="num" id="1440584">0</span>&nbsp;<span class="op" id="1440586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440590">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440642">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440690">n</span>&nbsp;<span class="op" id="1440692">:=</span>&nbsp;<span class="ident" id="1440695">p</span><span class="op" id="1440696">.</span><span class="ident" id="1440697">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440704">p</span><span class="op" id="1440705">.</span><span class="ident" id="1440706">nlog</span>&nbsp;<span class="op" id="1440711">=</span>&nbsp;<span class="num" id="1440713">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440717">return</span>&nbsp;<span class="ident" id="1440724">uintptrBytes</span><span class="op" id="1440736">(</span><span class="ident" id="1440737">p</span><span class="op" id="1440738">.</span><span class="ident" id="1440739">log</span><span class="op" id="1440742">[</span><span class="ident" id="1440743">p</span><span class="op" id="1440744">.</span><span class="ident" id="1440745">toggle</span><span class="op" id="1440751">]</span><span class="op" id="1440752">[</span><span class="op" id="1440753">:</span><span class="ident" id="1440754">n</span><span class="op" id="1440755">]</span><span class="op" id="1440756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440763">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440826">if</span>&nbsp;<span class="op" id="1440829">!</span><span class="ident" id="1440830">p</span><span class="op" id="1440831">.</span><span class="ident" id="1440832">eodSent</span>&nbsp;<span class="op" id="1440840">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440844">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440910">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440975">p</span><span class="op" id="1440976">.</span><span class="ident" id="1440977">eodSent</span>&nbsp;<span class="op" id="1440985">=</span>&nbsp;<span class="builtintype" id="1440987">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440994">return</span>&nbsp;<span class="ident" id="1441001">uintptrBytes</span><span class="op" id="1441013">(</span><span class="ident" id="1441014">eod</span><span class="op" id="1441017">[</span><span class="op" id="1441018">:</span><span class="op" id="1441019">]</span><span class="op" id="1441020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441023">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441027">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441071">p</span><span class="op" id="1441072">.</span><span class="ident" id="1441073">flushing</span>&nbsp;<span class="op" id="1441082">=</span>&nbsp;<span class="builtintype" id="1441084">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441091">if</span>&nbsp;<span class="op" id="1441094">!</span><span class="ident" id="1441095">cas</span><span class="op" id="1441098">(</span><span class="op" id="1441099">&amp;</span><span class="ident" id="1441100">p</span><span class="op" id="1441101">.</span><span class="ident" id="1441102">handoff</span><span class="op" id="1441109">,</span>&nbsp;<span class="ident" id="1441111">p</span><span class="op" id="1441112">.</span><span class="ident" id="1441113">handoff</span><span class="op" id="1441120">,</span>&nbsp;<span class="num" id="1441122">0</span><span class="op" id="1441123">)</span>&nbsp;<span class="op" id="1441125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1441129">print</span><span class="op" id="1441134">(</span><span class="string" id="1441135">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1441183">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441189">return</span>&nbsp;<span class="ident" id="1441196">nil</span><br>
<span class="lineno"></span><span class="op" id="1441200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1441203">func</span>&nbsp;<span class="ident" id="1441208">uintptrBytes</span><span class="op" id="1441220">(</span><span class="ident" id="1441221">p</span>&nbsp;<span class="op" id="1441223">[</span><span class="op" id="1441224">]</span><span class="builtintype" id="1441225">uintptr</span><span class="op" id="1441232">)</span>&nbsp;<span class="op" id="1441234">(</span><span class="ident" id="1441235">ret</span>&nbsp;<span class="op" id="1441239">[</span><span class="op" id="1441240">]</span><span class="builtintype" id="1441241">byte</span><span class="op" id="1441245">)</span>&nbsp;<span class="op" id="1441247">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441250">pp</span>&nbsp;<span class="op" id="1441253">:=</span>&nbsp;<span class="op" id="1441256">(</span><span class="op" id="1441257">*</span><span class="ident" id="1441258">sliceStruct</span><span class="op" id="1441269">)</span><span class="op" id="1441270">(</span><span class="ident" id="1441271">unsafe</span><span class="op" id="1441277">.</span><span class="ident" id="1441278">Pointer</span><span class="op" id="1441285">(</span><span class="op" id="1441286">&amp;</span><span class="ident" id="1441287">p</span><span class="op" id="1441288">)</span><span class="op" id="1441289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441292">rp</span>&nbsp;<span class="op" id="1441295">:=</span>&nbsp;<span class="op" id="1441298">(</span><span class="op" id="1441299">*</span><span class="ident" id="1441300">sliceStruct</span><span class="op" id="1441311">)</span><span class="op" id="1441312">(</span><span class="ident" id="1441313">unsafe</span><span class="op" id="1441319">.</span><span class="ident" id="1441320">Pointer</span><span class="op" id="1441327">(</span><span class="op" id="1441328">&amp;</span><span class="ident" id="1441329">ret</span><span class="op" id="1441332">)</span><span class="op" id="1441333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441337">rp</span><span class="op" id="1441339">.</span><span class="ident" id="1441340">array</span>&nbsp;<span class="op" id="1441346">=</span>&nbsp;<span class="ident" id="1441348">pp</span><span class="op" id="1441350">.</span><span class="ident" id="1441351">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441358">rp</span><span class="op" id="1441360">.</span><span class="builtinfunc" id="1441361">len</span>&nbsp;<span class="op" id="1441365">=</span>&nbsp;<span class="ident" id="1441367">pp</span><span class="op" id="1441369">.</span><span class="builtinfunc" id="1441370">len</span>&nbsp;<span class="op" id="1441374">*</span>&nbsp;<span class="builtintype" id="1441376">int</span><span class="op" id="1441379">(</span><span class="ident" id="1441380">unsafe</span><span class="op" id="1441386">.</span><span class="ident" id="1441387">Sizeof</span><span class="op" id="1441393">(</span><span class="ident" id="1441394">p</span><span class="op" id="1441395">[</span><span class="num" id="1441396">0</span><span class="op" id="1441397">]</span><span class="op" id="1441398">)</span><span class="op" id="1441399">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441402">rp</span><span class="op" id="1441404">.</span><span class="builtinfunc" id="1441405">cap</span>&nbsp;<span class="op" id="1441409">=</span>&nbsp;<span class="ident" id="1441411">rp</span><span class="op" id="1441413">.</span><span class="builtinfunc" id="1441414">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441420">return</span><br>
<span class="lineno"></span><span class="op" id="1441427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1441430">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1441509">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1441594">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1441673">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1441748">//</span><br>
<span class="lineno">420</span><span class="comment" id="1441751">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1441807">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1441873">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1441897">func</span>&nbsp;<span class="ident" id="1441902">CPUProfile</span><span class="op" id="1441912">(</span><span class="op" id="1441913">)</span>&nbsp;<span class="op" id="1441915">[</span><span class="op" id="1441916">]</span><span class="builtintype" id="1441917">byte</span>&nbsp;<span class="op" id="1441922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441925">return</span>&nbsp;<span class="ident" id="1441932">cpuprof</span><span class="op" id="1441939">.</span><span class="ident" id="1441940">getprofile</span><span class="op" id="1441950">(</span><span class="op" id="1441951">)</span><br>
<span class="lineno">425</span><span class="op" id="1441953">}</span>
</div>
</body>
</html>
