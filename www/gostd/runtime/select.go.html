<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1675757">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1675812">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1675866">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1675917">package</span>&nbsp;<span class="ident" id="1675925">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1675934">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1676001">import</span>&nbsp;<span class="string" id="1676008">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1676018">const</span>&nbsp;<span class="op" id="1676024">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676027">debugSelect</span>&nbsp;<span class="op" id="1676039">=</span>&nbsp;<span class="builtintype" id="1676041">false</span><br>
<span class="lineno"></span><span class="op" id="1676047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1676050">var</span>&nbsp;<span class="op" id="1676054">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676057">chansendpc</span>&nbsp;<span class="op" id="1676068">=</span>&nbsp;<span class="ident" id="1676070">funcPC</span><span class="op" id="1676076">(</span><span class="ident" id="1676077">chansend</span><span class="op" id="1676085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676088">chanrecvpc</span>&nbsp;<span class="op" id="1676099">=</span>&nbsp;<span class="ident" id="1676101">funcPC</span><span class="op" id="1676107">(</span><span class="ident" id="1676108">chanrecv</span><span class="op" id="1676116">)</span><br>
<span class="lineno"></span><span class="op" id="1676118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1676121">func</span>&nbsp;<span class="ident" id="1676126">selectsize</span><span class="op" id="1676136">(</span><span class="ident" id="1676137">size</span>&nbsp;<span class="builtintype" id="1676142">uintptr</span><span class="op" id="1676149">)</span>&nbsp;<span class="builtintype" id="1676151">uintptr</span>&nbsp;<span class="op" id="1676159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676162">selsize</span>&nbsp;<span class="op" id="1676170">:=</span>&nbsp;<span class="ident" id="1676173">unsafe</span><span class="op" id="1676179">.</span><span class="ident" id="1676180">Sizeof</span><span class="op" id="1676186">(</span><span class="ident" id="1676187">_select</span><span class="op" id="1676194">{</span><span class="op" id="1676195">}</span><span class="op" id="1676196">)</span>&nbsp;<span class="op" id="1676198">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676202">(</span><span class="ident" id="1676203">size</span><span class="op" id="1676207">-</span><span class="num" id="1676208">1</span><span class="op" id="1676209">)</span><span class="op" id="1676210">*</span><span class="ident" id="1676211">unsafe</span><span class="op" id="1676217">.</span><span class="ident" id="1676218">Sizeof</span><span class="op" id="1676224">(</span><span class="ident" id="1676225">_select</span><span class="op" id="1676232">{</span><span class="op" id="1676233">}</span><span class="op" id="1676234">.</span><span class="ident" id="1676235">scase</span><span class="op" id="1676240">[</span><span class="num" id="1676241">0</span><span class="op" id="1676242">]</span><span class="op" id="1676243">)</span>&nbsp;<span class="op" id="1676245">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676249">size</span><span class="op" id="1676253">*</span><span class="ident" id="1676254">unsafe</span><span class="op" id="1676260">.</span><span class="ident" id="1676261">Sizeof</span><span class="op" id="1676267">(</span><span class="op" id="1676268">*</span><span class="ident" id="1676269">_select</span><span class="op" id="1676276">{</span><span class="op" id="1676277">}</span><span class="op" id="1676278">.</span><span class="ident" id="1676279">lockorder</span><span class="op" id="1676288">)</span>&nbsp;<span class="op" id="1676290">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676294">size</span><span class="op" id="1676298">*</span><span class="ident" id="1676299">unsafe</span><span class="op" id="1676305">.</span><span class="ident" id="1676306">Sizeof</span><span class="op" id="1676312">(</span><span class="op" id="1676313">*</span><span class="ident" id="1676314">_select</span><span class="op" id="1676321">{</span><span class="op" id="1676322">}</span><span class="op" id="1676323">.</span><span class="ident" id="1676324">pollorder</span><span class="op" id="1676333">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676336">return</span>&nbsp;<span class="ident" id="1676343">round</span><span class="op" id="1676348">(</span><span class="ident" id="1676349">selsize</span><span class="op" id="1676356">,</span>&nbsp;<span class="ident" id="1676358">_Int64Align</span><span class="op" id="1676369">)</span><br>
<span class="lineno"></span><span class="op" id="1676371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1676374">func</span>&nbsp;<span class="ident" id="1676379">newselect</span><span class="op" id="1676388">(</span><span class="ident" id="1676389">sel</span>&nbsp;<span class="op" id="1676393">*</span><span class="ident" id="1676394">_select</span><span class="op" id="1676401">,</span>&nbsp;<span class="ident" id="1676403">selsize</span>&nbsp;<span class="ident" id="1676411">int64</span><span class="op" id="1676416">,</span>&nbsp;<span class="ident" id="1676418">size</span>&nbsp;<span class="builtintype" id="1676423">int32</span><span class="op" id="1676428">)</span>&nbsp;<span class="op" id="1676430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676433">if</span>&nbsp;<span class="ident" id="1676436">selsize</span>&nbsp;<span class="op" id="1676444">!=</span>&nbsp;<span class="ident" id="1676447">int64</span><span class="op" id="1676452">(</span><span class="ident" id="1676453">selectsize</span><span class="op" id="1676463">(</span><span class="builtintype" id="1676464">uintptr</span><span class="op" id="1676471">(</span><span class="ident" id="1676472">size</span><span class="op" id="1676476">)</span><span class="op" id="1676477">)</span><span class="op" id="1676478">)</span>&nbsp;<span class="op" id="1676480">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1676484">print</span><span class="op" id="1676489">(</span><span class="string" id="1676490">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1676517">,</span>&nbsp;<span class="ident" id="1676519">selsize</span><span class="op" id="1676526">,</span>&nbsp;<span class="string" id="1676528">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1676537">,</span>&nbsp;<span class="ident" id="1676539">selectsize</span><span class="op" id="1676549">(</span><span class="builtintype" id="1676550">uintptr</span><span class="op" id="1676557">(</span><span class="ident" id="1676558">size</span><span class="op" id="1676562">)</span><span class="op" id="1676563">)</span><span class="op" id="1676564">,</span>&nbsp;<span class="string" id="1676566">&#34;\n&#34;</span><span class="op" id="1676570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676574">gothrow</span><span class="op" id="1676581">(</span><span class="string" id="1676582">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1676599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676605">sel</span><span class="op" id="1676608">.</span><span class="ident" id="1676609">tcase</span>&nbsp;<span class="op" id="1676615">=</span>&nbsp;<span class="builtintype" id="1676617">uint16</span><span class="op" id="1676623">(</span><span class="ident" id="1676624">size</span><span class="op" id="1676628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676631">sel</span><span class="op" id="1676634">.</span><span class="ident" id="1676635">ncase</span>&nbsp;<span class="op" id="1676641">=</span>&nbsp;<span class="num" id="1676643">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676646">sel</span><span class="op" id="1676649">.</span><span class="ident" id="1676650">lockorder</span>&nbsp;<span class="op" id="1676660">=</span>&nbsp;<span class="op" id="1676662">(</span><span class="op" id="1676663">*</span><span class="op" id="1676664">*</span><span class="ident" id="1676665">hchan</span><span class="op" id="1676670">)</span><span class="op" id="1676671">(</span><span class="ident" id="1676672">add</span><span class="op" id="1676675">(</span><span class="ident" id="1676676">unsafe</span><span class="op" id="1676682">.</span><span class="ident" id="1676683">Pointer</span><span class="op" id="1676690">(</span><span class="op" id="1676691">&amp;</span><span class="ident" id="1676692">sel</span><span class="op" id="1676695">.</span><span class="ident" id="1676696">scase</span><span class="op" id="1676701">)</span><span class="op" id="1676702">,</span>&nbsp;<span class="builtintype" id="1676704">uintptr</span><span class="op" id="1676711">(</span><span class="ident" id="1676712">size</span><span class="op" id="1676716">)</span><span class="op" id="1676717">*</span><span class="ident" id="1676718">unsafe</span><span class="op" id="1676724">.</span><span class="ident" id="1676725">Sizeof</span><span class="op" id="1676731">(</span><span class="ident" id="1676732">_select</span><span class="op" id="1676739">{</span><span class="op" id="1676740">}</span><span class="op" id="1676741">.</span><span class="ident" id="1676742">scase</span><span class="op" id="1676747">[</span><span class="num" id="1676748">0</span><span class="op" id="1676749">]</span><span class="op" id="1676750">)</span><span class="op" id="1676751">)</span><span class="op" id="1676752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1676755">sel</span><span class="op" id="1676758">.</span><span class="ident" id="1676759">pollorder</span>&nbsp;<span class="op" id="1676769">=</span>&nbsp;<span class="op" id="1676771">(</span><span class="op" id="1676772">*</span><span class="builtintype" id="1676773">uint16</span><span class="op" id="1676779">)</span><span class="op" id="1676780">(</span><span class="ident" id="1676781">add</span><span class="op" id="1676784">(</span><span class="ident" id="1676785">unsafe</span><span class="op" id="1676791">.</span><span class="ident" id="1676792">Pointer</span><span class="op" id="1676799">(</span><span class="ident" id="1676800">sel</span><span class="op" id="1676803">.</span><span class="ident" id="1676804">lockorder</span><span class="op" id="1676813">)</span><span class="op" id="1676814">,</span>&nbsp;<span class="builtintype" id="1676816">uintptr</span><span class="op" id="1676823">(</span><span class="ident" id="1676824">size</span><span class="op" id="1676828">)</span><span class="op" id="1676829">*</span><span class="ident" id="1676830">unsafe</span><span class="op" id="1676836">.</span><span class="ident" id="1676837">Sizeof</span><span class="op" id="1676843">(</span><span class="op" id="1676844">*</span><span class="ident" id="1676845">_select</span><span class="op" id="1676852">{</span><span class="op" id="1676853">}</span><span class="op" id="1676854">.</span><span class="ident" id="1676855">lockorder</span><span class="op" id="1676864">)</span><span class="op" id="1676865">)</span><span class="op" id="1676866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1676870">if</span>&nbsp;<span class="ident" id="1676873">debugSelect</span>&nbsp;<span class="op" id="1676885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1676889">print</span><span class="op" id="1676894">(</span><span class="string" id="1676895">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1676909">,</span>&nbsp;<span class="ident" id="1676911">sel</span><span class="op" id="1676914">,</span>&nbsp;<span class="string" id="1676916">&#34;&nbsp;size=&#34;</span><span class="op" id="1676924">,</span>&nbsp;<span class="ident" id="1676926">size</span><span class="op" id="1676930">,</span>&nbsp;<span class="string" id="1676932">&#34;\n&#34;</span><span class="op" id="1676936">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1676939">}</span><br>
<span class="lineno"></span><span class="op" id="1676941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1676944">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1676957">func</span>&nbsp;<span class="ident" id="1676962">selectsend</span><span class="op" id="1676972">(</span><span class="ident" id="1676973">sel</span>&nbsp;<span class="op" id="1676977">*</span><span class="ident" id="1676978">_select</span><span class="op" id="1676985">,</span>&nbsp;<span class="ident" id="1676987">c</span>&nbsp;<span class="op" id="1676989">*</span><span class="ident" id="1676990">hchan</span><span class="op" id="1676995">,</span>&nbsp;<span class="ident" id="1676997">elem</span>&nbsp;<span class="ident" id="1677002">unsafe</span><span class="op" id="1677008">.</span><span class="ident" id="1677009">Pointer</span><span class="op" id="1677016">)</span>&nbsp;<span class="op" id="1677018">(</span><span class="ident" id="1677019">selected</span>&nbsp;<span class="builtintype" id="1677028">bool</span><span class="op" id="1677032">)</span>&nbsp;<span class="op" id="1677034">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677037">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677066">if</span>&nbsp;<span class="ident" id="1677069">c</span>&nbsp;<span class="op" id="1677071">!=</span>&nbsp;<span class="ident" id="1677074">nil</span>&nbsp;<span class="op" id="1677078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677082">selectsendImpl</span><span class="op" id="1677096">(</span><span class="ident" id="1677097">sel</span><span class="op" id="1677100">,</span>&nbsp;<span class="ident" id="1677102">c</span><span class="op" id="1677103">,</span>&nbsp;<span class="ident" id="1677105">getcallerpc</span><span class="op" id="1677116">(</span><span class="ident" id="1677117">unsafe</span><span class="op" id="1677123">.</span><span class="ident" id="1677124">Pointer</span><span class="op" id="1677131">(</span><span class="op" id="1677132">&amp;</span><span class="ident" id="1677133">sel</span><span class="op" id="1677136">)</span><span class="op" id="1677137">)</span><span class="op" id="1677138">,</span>&nbsp;<span class="ident" id="1677140">elem</span><span class="op" id="1677144">,</span>&nbsp;<span class="builtintype" id="1677146">uintptr</span><span class="op" id="1677153">(</span><span class="ident" id="1677154">unsafe</span><span class="op" id="1677160">.</span><span class="ident" id="1677161">Pointer</span><span class="op" id="1677168">(</span><span class="op" id="1677169">&amp;</span><span class="ident" id="1677170">selected</span><span class="op" id="1677178">)</span><span class="op" id="1677179">)</span><span class="op" id="1677180">-</span><span class="builtintype" id="1677181">uintptr</span><span class="op" id="1677188">(</span><span class="ident" id="1677189">unsafe</span><span class="op" id="1677195">.</span><span class="ident" id="1677196">Pointer</span><span class="op" id="1677203">(</span><span class="op" id="1677204">&amp;</span><span class="ident" id="1677205">sel</span><span class="op" id="1677208">)</span><span class="op" id="1677209">)</span><span class="op" id="1677210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677216">return</span><br>
<span class="lineno">50</span><span class="op" id="1677223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1677226">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1677273">func</span>&nbsp;<span class="ident" id="1677278">selectsendImpl</span><span class="op" id="1677292">(</span><span class="ident" id="1677293">sel</span>&nbsp;<span class="op" id="1677297">*</span><span class="ident" id="1677298">_select</span><span class="op" id="1677305">,</span>&nbsp;<span class="ident" id="1677307">c</span>&nbsp;<span class="op" id="1677309">*</span><span class="ident" id="1677310">hchan</span><span class="op" id="1677315">,</span>&nbsp;<span class="ident" id="1677317">pc</span>&nbsp;<span class="builtintype" id="1677320">uintptr</span><span class="op" id="1677327">,</span>&nbsp;<span class="ident" id="1677329">elem</span>&nbsp;<span class="ident" id="1677334">unsafe</span><span class="op" id="1677340">.</span><span class="ident" id="1677341">Pointer</span><span class="op" id="1677348">,</span>&nbsp;<span class="ident" id="1677350">so</span>&nbsp;<span class="builtintype" id="1677353">uintptr</span><span class="op" id="1677360">)</span>&nbsp;<span class="op" id="1677362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677365">i</span>&nbsp;<span class="op" id="1677367">:=</span>&nbsp;<span class="ident" id="1677370">sel</span><span class="op" id="1677373">.</span><span class="ident" id="1677374">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677381">if</span>&nbsp;<span class="ident" id="1677384">i</span>&nbsp;<span class="op" id="1677386">&gt;=</span>&nbsp;<span class="ident" id="1677389">sel</span><span class="op" id="1677392">.</span><span class="ident" id="1677393">tcase</span>&nbsp;<span class="op" id="1677399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677403">gothrow</span><span class="op" id="1677410">(</span><span class="string" id="1677411">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1677439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677445">sel</span><span class="op" id="1677448">.</span><span class="ident" id="1677449">ncase</span>&nbsp;<span class="op" id="1677455">=</span>&nbsp;<span class="ident" id="1677457">i</span>&nbsp;<span class="op" id="1677459">+</span>&nbsp;<span class="num" id="1677461">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677464">cas</span>&nbsp;<span class="op" id="1677468">:=</span>&nbsp;<span class="op" id="1677471">(</span><span class="op" id="1677472">*</span><span class="ident" id="1677473">scase</span><span class="op" id="1677478">)</span><span class="op" id="1677479">(</span><span class="ident" id="1677480">add</span><span class="op" id="1677483">(</span><span class="ident" id="1677484">unsafe</span><span class="op" id="1677490">.</span><span class="ident" id="1677491">Pointer</span><span class="op" id="1677498">(</span><span class="op" id="1677499">&amp;</span><span class="ident" id="1677500">sel</span><span class="op" id="1677503">.</span><span class="ident" id="1677504">scase</span><span class="op" id="1677509">)</span><span class="op" id="1677510">,</span>&nbsp;<span class="builtintype" id="1677512">uintptr</span><span class="op" id="1677519">(</span><span class="ident" id="1677520">i</span><span class="op" id="1677521">)</span><span class="op" id="1677522">*</span><span class="ident" id="1677523">unsafe</span><span class="op" id="1677529">.</span><span class="ident" id="1677530">Sizeof</span><span class="op" id="1677536">(</span><span class="ident" id="1677537">sel</span><span class="op" id="1677540">.</span><span class="ident" id="1677541">scase</span><span class="op" id="1677546">[</span><span class="num" id="1677547">0</span><span class="op" id="1677548">]</span><span class="op" id="1677549">)</span><span class="op" id="1677550">)</span><span class="op" id="1677551">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677555">cas</span><span class="op" id="1677558">.</span><span class="ident" id="1677559">pc</span>&nbsp;<span class="op" id="1677562">=</span>&nbsp;<span class="ident" id="1677564">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677568">cas</span><span class="op" id="1677571">.</span><span class="ident" id="1677572">_chan</span>&nbsp;<span class="op" id="1677578">=</span>&nbsp;<span class="ident" id="1677580">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677583">cas</span><span class="op" id="1677586">.</span><span class="ident" id="1677587">so</span>&nbsp;<span class="op" id="1677590">=</span>&nbsp;<span class="builtintype" id="1677592">uint16</span><span class="op" id="1677598">(</span><span class="ident" id="1677599">so</span><span class="op" id="1677601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677604">cas</span><span class="op" id="1677607">.</span><span class="ident" id="1677608">kind</span>&nbsp;<span class="op" id="1677613">=</span>&nbsp;<span class="ident" id="1677615">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677626">cas</span><span class="op" id="1677629">.</span><span class="ident" id="1677630">elem</span>&nbsp;<span class="op" id="1677635">=</span>&nbsp;<span class="ident" id="1677637">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677644">if</span>&nbsp;<span class="ident" id="1677647">debugSelect</span>&nbsp;<span class="op" id="1677659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1677663">print</span><span class="op" id="1677668">(</span><span class="string" id="1677669">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1677684">,</span>&nbsp;<span class="ident" id="1677686">sel</span><span class="op" id="1677689">,</span>&nbsp;<span class="string" id="1677691">&#34;&nbsp;pc=&#34;</span><span class="op" id="1677697">,</span>&nbsp;<span class="ident" id="1677699">hex</span><span class="op" id="1677702">(</span><span class="ident" id="1677703">cas</span><span class="op" id="1677706">.</span><span class="ident" id="1677707">pc</span><span class="op" id="1677709">)</span><span class="op" id="1677710">,</span>&nbsp;<span class="string" id="1677712">&#34;&nbsp;chan=&#34;</span><span class="op" id="1677720">,</span>&nbsp;<span class="ident" id="1677722">cas</span><span class="op" id="1677725">.</span><span class="ident" id="1677726">_chan</span><span class="op" id="1677731">,</span>&nbsp;<span class="string" id="1677733">&#34;&nbsp;so=&#34;</span><span class="op" id="1677739">,</span>&nbsp;<span class="ident" id="1677741">cas</span><span class="op" id="1677744">.</span><span class="ident" id="1677745">so</span><span class="op" id="1677747">,</span>&nbsp;<span class="string" id="1677749">&#34;\n&#34;</span><span class="op" id="1677753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1677756">}</span><br>
<span class="lineno">70</span><span class="op" id="1677758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1677761">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1677774">func</span>&nbsp;<span class="ident" id="1677779">selectrecv</span><span class="op" id="1677789">(</span><span class="ident" id="1677790">sel</span>&nbsp;<span class="op" id="1677794">*</span><span class="ident" id="1677795">_select</span><span class="op" id="1677802">,</span>&nbsp;<span class="ident" id="1677804">c</span>&nbsp;<span class="op" id="1677806">*</span><span class="ident" id="1677807">hchan</span><span class="op" id="1677812">,</span>&nbsp;<span class="ident" id="1677814">elem</span>&nbsp;<span class="ident" id="1677819">unsafe</span><span class="op" id="1677825">.</span><span class="ident" id="1677826">Pointer</span><span class="op" id="1677833">)</span>&nbsp;<span class="op" id="1677835">(</span><span class="ident" id="1677836">selected</span>&nbsp;<span class="builtintype" id="1677845">bool</span><span class="op" id="1677849">)</span>&nbsp;<span class="op" id="1677851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1677854">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1677883">if</span>&nbsp;<span class="ident" id="1677886">c</span>&nbsp;<span class="op" id="1677888">!=</span>&nbsp;<span class="ident" id="1677891">nil</span>&nbsp;<span class="op" id="1677895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1677899">selectrecvImpl</span><span class="op" id="1677913">(</span><span class="ident" id="1677914">sel</span><span class="op" id="1677917">,</span>&nbsp;<span class="ident" id="1677919">c</span><span class="op" id="1677920">,</span>&nbsp;<span class="ident" id="1677922">getcallerpc</span><span class="op" id="1677933">(</span><span class="ident" id="1677934">unsafe</span><span class="op" id="1677940">.</span><span class="ident" id="1677941">Pointer</span><span class="op" id="1677948">(</span><span class="op" id="1677949">&amp;</span><span class="ident" id="1677950">sel</span><span class="op" id="1677953">)</span><span class="op" id="1677954">)</span><span class="op" id="1677955">,</span>&nbsp;<span class="ident" id="1677957">elem</span><span class="op" id="1677961">,</span>&nbsp;<span class="ident" id="1677963">nil</span><span class="op" id="1677966">,</span>&nbsp;<span class="builtintype" id="1677968">uintptr</span><span class="op" id="1677975">(</span><span class="ident" id="1677976">unsafe</span><span class="op" id="1677982">.</span><span class="ident" id="1677983">Pointer</span><span class="op" id="1677990">(</span><span class="op" id="1677991">&amp;</span><span class="ident" id="1677992">selected</span><span class="op" id="1678000">)</span><span class="op" id="1678001">)</span><span class="op" id="1678002">-</span><span class="builtintype" id="1678003">uintptr</span><span class="op" id="1678010">(</span><span class="ident" id="1678011">unsafe</span><span class="op" id="1678017">.</span><span class="ident" id="1678018">Pointer</span><span class="op" id="1678025">(</span><span class="op" id="1678026">&amp;</span><span class="ident" id="1678027">sel</span><span class="op" id="1678030">)</span><span class="op" id="1678031">)</span><span class="op" id="1678032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678038">return</span><br>
<span class="lineno"></span><span class="op" id="1678045">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1678048">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1678061">func</span>&nbsp;<span class="ident" id="1678066">selectrecv2</span><span class="op" id="1678077">(</span><span class="ident" id="1678078">sel</span>&nbsp;<span class="op" id="1678082">*</span><span class="ident" id="1678083">_select</span><span class="op" id="1678090">,</span>&nbsp;<span class="ident" id="1678092">c</span>&nbsp;<span class="op" id="1678094">*</span><span class="ident" id="1678095">hchan</span><span class="op" id="1678100">,</span>&nbsp;<span class="ident" id="1678102">elem</span>&nbsp;<span class="ident" id="1678107">unsafe</span><span class="op" id="1678113">.</span><span class="ident" id="1678114">Pointer</span><span class="op" id="1678121">,</span>&nbsp;<span class="ident" id="1678123">received</span>&nbsp;<span class="op" id="1678132">*</span><span class="builtintype" id="1678133">bool</span><span class="op" id="1678137">)</span>&nbsp;<span class="op" id="1678139">(</span><span class="ident" id="1678140">selected</span>&nbsp;<span class="builtintype" id="1678149">bool</span><span class="op" id="1678153">)</span>&nbsp;<span class="op" id="1678155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1678158">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678187">if</span>&nbsp;<span class="ident" id="1678190">c</span>&nbsp;<span class="op" id="1678192">!=</span>&nbsp;<span class="ident" id="1678195">nil</span>&nbsp;<span class="op" id="1678199">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678203">selectrecvImpl</span><span class="op" id="1678217">(</span><span class="ident" id="1678218">sel</span><span class="op" id="1678221">,</span>&nbsp;<span class="ident" id="1678223">c</span><span class="op" id="1678224">,</span>&nbsp;<span class="ident" id="1678226">getcallerpc</span><span class="op" id="1678237">(</span><span class="ident" id="1678238">unsafe</span><span class="op" id="1678244">.</span><span class="ident" id="1678245">Pointer</span><span class="op" id="1678252">(</span><span class="op" id="1678253">&amp;</span><span class="ident" id="1678254">sel</span><span class="op" id="1678257">)</span><span class="op" id="1678258">)</span><span class="op" id="1678259">,</span>&nbsp;<span class="ident" id="1678261">elem</span><span class="op" id="1678265">,</span>&nbsp;<span class="ident" id="1678267">received</span><span class="op" id="1678275">,</span>&nbsp;<span class="builtintype" id="1678277">uintptr</span><span class="op" id="1678284">(</span><span class="ident" id="1678285">unsafe</span><span class="op" id="1678291">.</span><span class="ident" id="1678292">Pointer</span><span class="op" id="1678299">(</span><span class="op" id="1678300">&amp;</span><span class="ident" id="1678301">selected</span><span class="op" id="1678309">)</span><span class="op" id="1678310">)</span><span class="op" id="1678311">-</span><span class="builtintype" id="1678312">uintptr</span><span class="op" id="1678319">(</span><span class="ident" id="1678320">unsafe</span><span class="op" id="1678326">.</span><span class="ident" id="1678327">Pointer</span><span class="op" id="1678334">(</span><span class="op" id="1678335">&amp;</span><span class="ident" id="1678336">sel</span><span class="op" id="1678339">)</span><span class="op" id="1678340">)</span><span class="op" id="1678341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678347">return</span><br>
<span class="lineno"></span><span class="op" id="1678354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1678357">func</span>&nbsp;<span class="ident" id="1678362">selectrecvImpl</span><span class="op" id="1678376">(</span><span class="ident" id="1678377">sel</span>&nbsp;<span class="op" id="1678381">*</span><span class="ident" id="1678382">_select</span><span class="op" id="1678389">,</span>&nbsp;<span class="ident" id="1678391">c</span>&nbsp;<span class="op" id="1678393">*</span><span class="ident" id="1678394">hchan</span><span class="op" id="1678399">,</span>&nbsp;<span class="ident" id="1678401">pc</span>&nbsp;<span class="builtintype" id="1678404">uintptr</span><span class="op" id="1678411">,</span>&nbsp;<span class="ident" id="1678413">elem</span>&nbsp;<span class="ident" id="1678418">unsafe</span><span class="op" id="1678424">.</span><span class="ident" id="1678425">Pointer</span><span class="op" id="1678432">,</span>&nbsp;<span class="ident" id="1678434">received</span>&nbsp;<span class="op" id="1678443">*</span><span class="builtintype" id="1678444">bool</span><span class="op" id="1678448">,</span>&nbsp;<span class="ident" id="1678450">so</span>&nbsp;<span class="builtintype" id="1678453">uintptr</span><span class="op" id="1678460">)</span>&nbsp;<span class="op" id="1678462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678465">i</span>&nbsp;<span class="op" id="1678467">:=</span>&nbsp;<span class="ident" id="1678470">sel</span><span class="op" id="1678473">.</span><span class="ident" id="1678474">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678481">if</span>&nbsp;<span class="ident" id="1678484">i</span>&nbsp;<span class="op" id="1678486">&gt;=</span>&nbsp;<span class="ident" id="1678489">sel</span><span class="op" id="1678492">.</span><span class="ident" id="1678493">tcase</span>&nbsp;<span class="op" id="1678499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678503">gothrow</span><span class="op" id="1678510">(</span><span class="string" id="1678511">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1678539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678542">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678545">sel</span><span class="op" id="1678548">.</span><span class="ident" id="1678549">ncase</span>&nbsp;<span class="op" id="1678555">=</span>&nbsp;<span class="ident" id="1678557">i</span>&nbsp;<span class="op" id="1678559">+</span>&nbsp;<span class="num" id="1678561">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678564">cas</span>&nbsp;<span class="op" id="1678568">:=</span>&nbsp;<span class="op" id="1678571">(</span><span class="op" id="1678572">*</span><span class="ident" id="1678573">scase</span><span class="op" id="1678578">)</span><span class="op" id="1678579">(</span><span class="ident" id="1678580">add</span><span class="op" id="1678583">(</span><span class="ident" id="1678584">unsafe</span><span class="op" id="1678590">.</span><span class="ident" id="1678591">Pointer</span><span class="op" id="1678598">(</span><span class="op" id="1678599">&amp;</span><span class="ident" id="1678600">sel</span><span class="op" id="1678603">.</span><span class="ident" id="1678604">scase</span><span class="op" id="1678609">)</span><span class="op" id="1678610">,</span>&nbsp;<span class="builtintype" id="1678612">uintptr</span><span class="op" id="1678619">(</span><span class="ident" id="1678620">i</span><span class="op" id="1678621">)</span><span class="op" id="1678622">*</span><span class="ident" id="1678623">unsafe</span><span class="op" id="1678629">.</span><span class="ident" id="1678630">Sizeof</span><span class="op" id="1678636">(</span><span class="ident" id="1678637">sel</span><span class="op" id="1678640">.</span><span class="ident" id="1678641">scase</span><span class="op" id="1678646">[</span><span class="num" id="1678647">0</span><span class="op" id="1678648">]</span><span class="op" id="1678649">)</span><span class="op" id="1678650">)</span><span class="op" id="1678651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678654">cas</span><span class="op" id="1678657">.</span><span class="ident" id="1678658">pc</span>&nbsp;<span class="op" id="1678661">=</span>&nbsp;<span class="ident" id="1678663">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678667">cas</span><span class="op" id="1678670">.</span><span class="ident" id="1678671">_chan</span>&nbsp;<span class="op" id="1678677">=</span>&nbsp;<span class="ident" id="1678679">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678682">cas</span><span class="op" id="1678685">.</span><span class="ident" id="1678686">so</span>&nbsp;<span class="op" id="1678689">=</span>&nbsp;<span class="builtintype" id="1678691">uint16</span><span class="op" id="1678697">(</span><span class="ident" id="1678698">so</span><span class="op" id="1678700">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678703">cas</span><span class="op" id="1678706">.</span><span class="ident" id="1678707">kind</span>&nbsp;<span class="op" id="1678712">=</span>&nbsp;<span class="ident" id="1678714">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678725">cas</span><span class="op" id="1678728">.</span><span class="ident" id="1678729">elem</span>&nbsp;<span class="op" id="1678734">=</span>&nbsp;<span class="ident" id="1678736">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678742">cas</span><span class="op" id="1678745">.</span><span class="ident" id="1678746">receivedp</span>&nbsp;<span class="op" id="1678756">=</span>&nbsp;<span class="ident" id="1678758">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1678769">if</span>&nbsp;<span class="ident" id="1678772">debugSelect</span>&nbsp;<span class="op" id="1678784">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1678788">print</span><span class="op" id="1678793">(</span><span class="string" id="1678794">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1678809">,</span>&nbsp;<span class="ident" id="1678811">sel</span><span class="op" id="1678814">,</span>&nbsp;<span class="string" id="1678816">&#34;&nbsp;pc=&#34;</span><span class="op" id="1678822">,</span>&nbsp;<span class="ident" id="1678824">hex</span><span class="op" id="1678827">(</span><span class="ident" id="1678828">cas</span><span class="op" id="1678831">.</span><span class="ident" id="1678832">pc</span><span class="op" id="1678834">)</span><span class="op" id="1678835">,</span>&nbsp;<span class="string" id="1678837">&#34;&nbsp;chan=&#34;</span><span class="op" id="1678845">,</span>&nbsp;<span class="ident" id="1678847">cas</span><span class="op" id="1678850">.</span><span class="ident" id="1678851">_chan</span><span class="op" id="1678856">,</span>&nbsp;<span class="string" id="1678858">&#34;&nbsp;so=&#34;</span><span class="op" id="1678864">,</span>&nbsp;<span class="ident" id="1678866">cas</span><span class="op" id="1678869">.</span><span class="ident" id="1678870">so</span><span class="op" id="1678872">,</span>&nbsp;<span class="string" id="1678874">&#34;\n&#34;</span><span class="op" id="1678878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1678881">}</span><br>
<span class="lineno"></span><span class="op" id="1678883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1678886">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1678899">func</span>&nbsp;<span class="ident" id="1678904">selectdefault</span><span class="op" id="1678917">(</span><span class="ident" id="1678918">sel</span>&nbsp;<span class="op" id="1678922">*</span><span class="ident" id="1678923">_select</span><span class="op" id="1678930">)</span>&nbsp;<span class="op" id="1678932">(</span><span class="ident" id="1678933">selected</span>&nbsp;<span class="builtintype" id="1678942">bool</span><span class="op" id="1678946">)</span>&nbsp;<span class="op" id="1678948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1678951">selectdefaultImpl</span><span class="op" id="1678968">(</span><span class="ident" id="1678969">sel</span><span class="op" id="1678972">,</span>&nbsp;<span class="ident" id="1678974">getcallerpc</span><span class="op" id="1678985">(</span><span class="ident" id="1678986">unsafe</span><span class="op" id="1678992">.</span><span class="ident" id="1678993">Pointer</span><span class="op" id="1679000">(</span><span class="op" id="1679001">&amp;</span><span class="ident" id="1679002">sel</span><span class="op" id="1679005">)</span><span class="op" id="1679006">)</span><span class="op" id="1679007">,</span>&nbsp;<span class="builtintype" id="1679009">uintptr</span><span class="op" id="1679016">(</span><span class="ident" id="1679017">unsafe</span><span class="op" id="1679023">.</span><span class="ident" id="1679024">Pointer</span><span class="op" id="1679031">(</span><span class="op" id="1679032">&amp;</span><span class="ident" id="1679033">selected</span><span class="op" id="1679041">)</span><span class="op" id="1679042">)</span><span class="op" id="1679043">-</span><span class="builtintype" id="1679044">uintptr</span><span class="op" id="1679051">(</span><span class="ident" id="1679052">unsafe</span><span class="op" id="1679058">.</span><span class="ident" id="1679059">Pointer</span><span class="op" id="1679066">(</span><span class="op" id="1679067">&amp;</span><span class="ident" id="1679068">sel</span><span class="op" id="1679071">)</span><span class="op" id="1679072">)</span><span class="op" id="1679073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679076">return</span><br>
<span class="lineno"></span><span class="op" id="1679083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1679086">func</span>&nbsp;<span class="ident" id="1679091">selectdefaultImpl</span><span class="op" id="1679108">(</span><span class="ident" id="1679109">sel</span>&nbsp;<span class="op" id="1679113">*</span><span class="ident" id="1679114">_select</span><span class="op" id="1679121">,</span>&nbsp;<span class="ident" id="1679123">callerpc</span>&nbsp;<span class="builtintype" id="1679132">uintptr</span><span class="op" id="1679139">,</span>&nbsp;<span class="ident" id="1679141">so</span>&nbsp;<span class="builtintype" id="1679144">uintptr</span><span class="op" id="1679151">)</span>&nbsp;<span class="op" id="1679153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679156">i</span>&nbsp;<span class="op" id="1679158">:=</span>&nbsp;<span class="ident" id="1679161">sel</span><span class="op" id="1679164">.</span><span class="ident" id="1679165">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679172">if</span>&nbsp;<span class="ident" id="1679175">i</span>&nbsp;<span class="op" id="1679177">&gt;=</span>&nbsp;<span class="ident" id="1679180">sel</span><span class="op" id="1679183">.</span><span class="ident" id="1679184">tcase</span>&nbsp;<span class="op" id="1679190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679194">gothrow</span><span class="op" id="1679201">(</span><span class="string" id="1679202">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1679233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679236">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679239">sel</span><span class="op" id="1679242">.</span><span class="ident" id="1679243">ncase</span>&nbsp;<span class="op" id="1679249">=</span>&nbsp;<span class="ident" id="1679251">i</span>&nbsp;<span class="op" id="1679253">+</span>&nbsp;<span class="num" id="1679255">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679258">cas</span>&nbsp;<span class="op" id="1679262">:=</span>&nbsp;<span class="op" id="1679265">(</span><span class="op" id="1679266">*</span><span class="ident" id="1679267">scase</span><span class="op" id="1679272">)</span><span class="op" id="1679273">(</span><span class="ident" id="1679274">add</span><span class="op" id="1679277">(</span><span class="ident" id="1679278">unsafe</span><span class="op" id="1679284">.</span><span class="ident" id="1679285">Pointer</span><span class="op" id="1679292">(</span><span class="op" id="1679293">&amp;</span><span class="ident" id="1679294">sel</span><span class="op" id="1679297">.</span><span class="ident" id="1679298">scase</span><span class="op" id="1679303">)</span><span class="op" id="1679304">,</span>&nbsp;<span class="builtintype" id="1679306">uintptr</span><span class="op" id="1679313">(</span><span class="ident" id="1679314">i</span><span class="op" id="1679315">)</span><span class="op" id="1679316">*</span><span class="ident" id="1679317">unsafe</span><span class="op" id="1679323">.</span><span class="ident" id="1679324">Sizeof</span><span class="op" id="1679330">(</span><span class="ident" id="1679331">sel</span><span class="op" id="1679334">.</span><span class="ident" id="1679335">scase</span><span class="op" id="1679340">[</span><span class="num" id="1679341">0</span><span class="op" id="1679342">]</span><span class="op" id="1679343">)</span><span class="op" id="1679344">)</span><span class="op" id="1679345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679348">cas</span><span class="op" id="1679351">.</span><span class="ident" id="1679352">pc</span>&nbsp;<span class="op" id="1679355">=</span>&nbsp;<span class="ident" id="1679357">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679367">cas</span><span class="op" id="1679370">.</span><span class="ident" id="1679371">_chan</span>&nbsp;<span class="op" id="1679377">=</span>&nbsp;<span class="ident" id="1679379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679384">cas</span><span class="op" id="1679387">.</span><span class="ident" id="1679388">so</span>&nbsp;<span class="op" id="1679391">=</span>&nbsp;<span class="builtintype" id="1679393">uint16</span><span class="op" id="1679399">(</span><span class="ident" id="1679400">so</span><span class="op" id="1679402">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679405">cas</span><span class="op" id="1679408">.</span><span class="ident" id="1679409">kind</span>&nbsp;<span class="op" id="1679414">=</span>&nbsp;<span class="ident" id="1679416">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679431">if</span>&nbsp;<span class="ident" id="1679434">debugSelect</span>&nbsp;<span class="op" id="1679446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1679450">print</span><span class="op" id="1679455">(</span><span class="string" id="1679456">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1679474">,</span>&nbsp;<span class="ident" id="1679476">sel</span><span class="op" id="1679479">,</span>&nbsp;<span class="string" id="1679481">&#34;&nbsp;pc=&#34;</span><span class="op" id="1679487">,</span>&nbsp;<span class="ident" id="1679489">hex</span><span class="op" id="1679492">(</span><span class="ident" id="1679493">cas</span><span class="op" id="1679496">.</span><span class="ident" id="1679497">pc</span><span class="op" id="1679499">)</span><span class="op" id="1679500">,</span>&nbsp;<span class="string" id="1679502">&#34;&nbsp;so=&#34;</span><span class="op" id="1679508">,</span>&nbsp;<span class="ident" id="1679510">cas</span><span class="op" id="1679513">.</span><span class="ident" id="1679514">so</span><span class="op" id="1679516">,</span>&nbsp;<span class="string" id="1679518">&#34;\n&#34;</span><span class="op" id="1679522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679525">}</span><br>
<span class="lineno">130</span><span class="op" id="1679527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1679530">func</span>&nbsp;<span class="ident" id="1679535">sellock</span><span class="op" id="1679542">(</span><span class="ident" id="1679543">sel</span>&nbsp;<span class="op" id="1679547">*</span><span class="ident" id="1679548">_select</span><span class="op" id="1679555">)</span>&nbsp;<span class="op" id="1679557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679560">lockslice</span>&nbsp;<span class="op" id="1679570">:=</span>&nbsp;<span class="ident" id="1679573">sliceStruct</span><span class="op" id="1679584">{</span><span class="ident" id="1679585">unsafe</span><span class="op" id="1679591">.</span><span class="ident" id="1679592">Pointer</span><span class="op" id="1679599">(</span><span class="ident" id="1679600">sel</span><span class="op" id="1679603">.</span><span class="ident" id="1679604">lockorder</span><span class="op" id="1679613">)</span><span class="op" id="1679614">,</span>&nbsp;<span class="builtintype" id="1679616">int</span><span class="op" id="1679619">(</span><span class="ident" id="1679620">sel</span><span class="op" id="1679623">.</span><span class="ident" id="1679624">ncase</span><span class="op" id="1679629">)</span><span class="op" id="1679630">,</span>&nbsp;<span class="builtintype" id="1679632">int</span><span class="op" id="1679635">(</span><span class="ident" id="1679636">sel</span><span class="op" id="1679639">.</span><span class="ident" id="1679640">ncase</span><span class="op" id="1679645">)</span><span class="op" id="1679646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679649">lockorder</span>&nbsp;<span class="op" id="1679659">:=</span>&nbsp;<span class="op" id="1679662">*</span><span class="op" id="1679663">(</span><span class="op" id="1679664">*</span><span class="op" id="1679665">[</span><span class="op" id="1679666">]</span><span class="op" id="1679667">*</span><span class="ident" id="1679668">hchan</span><span class="op" id="1679673">)</span><span class="op" id="1679674">(</span><span class="ident" id="1679675">unsafe</span><span class="op" id="1679681">.</span><span class="ident" id="1679682">Pointer</span><span class="op" id="1679689">(</span><span class="op" id="1679690">&amp;</span><span class="ident" id="1679691">lockslice</span><span class="op" id="1679700">)</span><span class="op" id="1679701">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679704">var</span>&nbsp;<span class="ident" id="1679708">c</span>&nbsp;<span class="op" id="1679710">*</span><span class="ident" id="1679711">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679718">for</span>&nbsp;<span class="ident" id="1679722">_</span><span class="op" id="1679723">,</span>&nbsp;<span class="ident" id="1679725">c0</span>&nbsp;<span class="op" id="1679728">:=</span>&nbsp;<span class="keyword" id="1679731">range</span>&nbsp;<span class="ident" id="1679737">lockorder</span>&nbsp;<span class="op" id="1679747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1679751">if</span>&nbsp;<span class="ident" id="1679754">c0</span>&nbsp;<span class="op" id="1679757">!=</span>&nbsp;<span class="ident" id="1679760">nil</span>&nbsp;<span class="op" id="1679764">&amp;&amp;</span>&nbsp;<span class="ident" id="1679767">c0</span>&nbsp;<span class="op" id="1679770">!=</span>&nbsp;<span class="ident" id="1679773">c</span>&nbsp;<span class="op" id="1679775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679780">c</span>&nbsp;<span class="op" id="1679782">=</span>&nbsp;<span class="ident" id="1679784">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1679790">lock</span><span class="op" id="1679794">(</span><span class="op" id="1679795">&amp;</span><span class="ident" id="1679796">c</span><span class="op" id="1679797">.</span><span class="ident" id="1679798">lock</span><span class="op" id="1679802">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1679809">}</span><br>
<span class="lineno"></span><span class="op" id="1679811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1679814">func</span>&nbsp;<span class="ident" id="1679819">selunlock</span><span class="op" id="1679828">(</span><span class="ident" id="1679829">sel</span>&nbsp;<span class="op" id="1679833">*</span><span class="ident" id="1679834">_select</span><span class="op" id="1679841">)</span>&nbsp;<span class="op" id="1679843">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679846">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679919">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1679992">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680030">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680104">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680173">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680248">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680320">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680385">n</span>&nbsp;<span class="op" id="1680387">:=</span>&nbsp;<span class="builtintype" id="1680390">int</span><span class="op" id="1680393">(</span><span class="ident" id="1680394">sel</span><span class="op" id="1680397">.</span><span class="ident" id="1680398">ncase</span><span class="op" id="1680403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680406">r</span>&nbsp;<span class="op" id="1680408">:=</span>&nbsp;<span class="num" id="1680411">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680414">lockslice</span>&nbsp;<span class="op" id="1680424">:=</span>&nbsp;<span class="ident" id="1680427">sliceStruct</span><span class="op" id="1680438">{</span><span class="ident" id="1680439">unsafe</span><span class="op" id="1680445">.</span><span class="ident" id="1680446">Pointer</span><span class="op" id="1680453">(</span><span class="ident" id="1680454">sel</span><span class="op" id="1680457">.</span><span class="ident" id="1680458">lockorder</span><span class="op" id="1680467">)</span><span class="op" id="1680468">,</span>&nbsp;<span class="ident" id="1680470">n</span><span class="op" id="1680471">,</span>&nbsp;<span class="ident" id="1680473">n</span><span class="op" id="1680474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680477">lockorder</span>&nbsp;<span class="op" id="1680487">:=</span>&nbsp;<span class="op" id="1680490">*</span><span class="op" id="1680491">(</span><span class="op" id="1680492">*</span><span class="op" id="1680493">[</span><span class="op" id="1680494">]</span><span class="op" id="1680495">*</span><span class="ident" id="1680496">hchan</span><span class="op" id="1680501">)</span><span class="op" id="1680502">(</span><span class="ident" id="1680503">unsafe</span><span class="op" id="1680509">.</span><span class="ident" id="1680510">Pointer</span><span class="op" id="1680517">(</span><span class="op" id="1680518">&amp;</span><span class="ident" id="1680519">lockslice</span><span class="op" id="1680528">)</span><span class="op" id="1680529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1680532">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680558">if</span>&nbsp;<span class="ident" id="1680561">n</span>&nbsp;<span class="op" id="1680563">&gt;</span>&nbsp;<span class="num" id="1680565">0</span>&nbsp;<span class="op" id="1680567">&amp;&amp;</span>&nbsp;<span class="ident" id="1680570">lockorder</span><span class="op" id="1680579">[</span><span class="num" id="1680580">0</span><span class="op" id="1680581">]</span>&nbsp;<span class="op" id="1680583">==</span>&nbsp;<span class="ident" id="1680586">nil</span>&nbsp;<span class="op" id="1680590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680594">r</span>&nbsp;<span class="op" id="1680596">=</span>&nbsp;<span class="num" id="1680598">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680604">for</span>&nbsp;<span class="ident" id="1680608">i</span>&nbsp;<span class="op" id="1680610">:=</span>&nbsp;<span class="ident" id="1680613">n</span>&nbsp;<span class="op" id="1680615">-</span>&nbsp;<span class="num" id="1680617">1</span><span class="op" id="1680618">;</span>&nbsp;<span class="ident" id="1680620">i</span>&nbsp;<span class="op" id="1680622">&gt;=</span>&nbsp;<span class="ident" id="1680625">r</span><span class="op" id="1680626">;</span>&nbsp;<span class="ident" id="1680628">i</span><span class="op" id="1680629">--</span>&nbsp;<span class="op" id="1680632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680636">c</span>&nbsp;<span class="op" id="1680638">:=</span>&nbsp;<span class="ident" id="1680641">lockorder</span><span class="op" id="1680650">[</span><span class="ident" id="1680651">i</span><span class="op" id="1680652">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680656">if</span>&nbsp;<span class="ident" id="1680659">i</span>&nbsp;<span class="op" id="1680661">&gt;</span>&nbsp;<span class="num" id="1680663">0</span>&nbsp;<span class="op" id="1680665">&amp;&amp;</span>&nbsp;<span class="ident" id="1680668">c</span>&nbsp;<span class="op" id="1680670">==</span>&nbsp;<span class="ident" id="1680673">lockorder</span><span class="op" id="1680682">[</span><span class="ident" id="1680683">i</span><span class="op" id="1680684">-</span><span class="num" id="1680685">1</span><span class="op" id="1680686">]</span>&nbsp;<span class="op" id="1680688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680693">continue</span>&nbsp;<span class="comment" id="1680702">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680748">unlock</span><span class="op" id="1680754">(</span><span class="op" id="1680755">&amp;</span><span class="ident" id="1680756">c</span><span class="op" id="1680757">.</span><span class="ident" id="1680758">lock</span><span class="op" id="1680762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1680765">}</span><br>
<span class="lineno"></span><span class="op" id="1680767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1680770">func</span>&nbsp;<span class="ident" id="1680775">selparkcommit</span><span class="op" id="1680788">(</span><span class="ident" id="1680789">gp</span>&nbsp;<span class="op" id="1680792">*</span><span class="ident" id="1680793">g</span><span class="op" id="1680794">,</span>&nbsp;<span class="ident" id="1680796">sel</span>&nbsp;<span class="op" id="1680800">*</span><span class="ident" id="1680801">_select</span><span class="op" id="1680808">)</span>&nbsp;<span class="builtintype" id="1680810">bool</span>&nbsp;<span class="op" id="1680815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680818">selunlock</span><span class="op" id="1680827">(</span><span class="ident" id="1680828">sel</span><span class="op" id="1680831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1680834">return</span>&nbsp;<span class="builtintype" id="1680841">true</span><br>
<span class="lineno"></span><span class="op" id="1680846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1680849">func</span>&nbsp;<span class="ident" id="1680854">block</span><span class="op" id="1680859">(</span><span class="op" id="1680860">)</span>&nbsp;<span class="op" id="1680862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1680865">gopark</span><span class="op" id="1680871">(</span><span class="ident" id="1680872">nil</span><span class="op" id="1680875">,</span>&nbsp;<span class="ident" id="1680877">nil</span><span class="op" id="1680880">,</span>&nbsp;<span class="string" id="1680882">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1680901">)</span>&nbsp;<span class="comment" id="1680903">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1680914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1680917">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1680985">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1681042">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1681055">func</span>&nbsp;<span class="ident" id="1681060">selectgo</span><span class="op" id="1681068">(</span><span class="ident" id="1681069">sel</span>&nbsp;<span class="op" id="1681073">*</span><span class="ident" id="1681074">_select</span><span class="op" id="1681081">)</span>&nbsp;<span class="op" id="1681083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681086">pc</span><span class="op" id="1681088">,</span>&nbsp;<span class="ident" id="1681090">offset</span>&nbsp;<span class="op" id="1681097">:=</span>&nbsp;<span class="ident" id="1681100">selectgoImpl</span><span class="op" id="1681112">(</span><span class="ident" id="1681113">sel</span><span class="op" id="1681116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681119">*</span><span class="op" id="1681120">(</span><span class="op" id="1681121">*</span><span class="builtintype" id="1681122">bool</span><span class="op" id="1681126">)</span><span class="op" id="1681127">(</span><span class="ident" id="1681128">add</span><span class="op" id="1681131">(</span><span class="ident" id="1681132">unsafe</span><span class="op" id="1681138">.</span><span class="ident" id="1681139">Pointer</span><span class="op" id="1681146">(</span><span class="op" id="1681147">&amp;</span><span class="ident" id="1681148">sel</span><span class="op" id="1681151">)</span><span class="op" id="1681152">,</span>&nbsp;<span class="builtintype" id="1681154">uintptr</span><span class="op" id="1681161">(</span><span class="ident" id="1681162">offset</span><span class="op" id="1681168">)</span><span class="op" id="1681169">)</span><span class="op" id="1681170">)</span>&nbsp;<span class="op" id="1681172">=</span>&nbsp;<span class="builtintype" id="1681174">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681180">setcallerpc</span><span class="op" id="1681191">(</span><span class="ident" id="1681192">unsafe</span><span class="op" id="1681198">.</span><span class="ident" id="1681199">Pointer</span><span class="op" id="1681206">(</span><span class="op" id="1681207">&amp;</span><span class="ident" id="1681208">sel</span><span class="op" id="1681211">)</span><span class="op" id="1681212">,</span>&nbsp;<span class="ident" id="1681214">pc</span><span class="op" id="1681216">)</span><br>
<span class="lineno"></span><span class="op" id="1681218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1681221">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1681282">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1681303">func</span>&nbsp;<span class="ident" id="1681308">selectgoImpl</span><span class="op" id="1681320">(</span><span class="ident" id="1681321">sel</span>&nbsp;<span class="op" id="1681325">*</span><span class="ident" id="1681326">_select</span><span class="op" id="1681333">)</span>&nbsp;<span class="op" id="1681335">(</span><span class="builtintype" id="1681336">uintptr</span><span class="op" id="1681343">,</span>&nbsp;<span class="builtintype" id="1681345">uint16</span><span class="op" id="1681351">)</span>&nbsp;<span class="op" id="1681353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681356">if</span>&nbsp;<span class="ident" id="1681359">debugSelect</span>&nbsp;<span class="op" id="1681371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1681375">print</span><span class="op" id="1681380">(</span><span class="string" id="1681381">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1681395">,</span>&nbsp;<span class="ident" id="1681397">sel</span><span class="op" id="1681400">,</span>&nbsp;<span class="string" id="1681402">&#34;\n&#34;</span><span class="op" id="1681406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681413">scaseslice</span>&nbsp;<span class="op" id="1681424">:=</span>&nbsp;<span class="ident" id="1681427">sliceStruct</span><span class="op" id="1681438">{</span><span class="ident" id="1681439">unsafe</span><span class="op" id="1681445">.</span><span class="ident" id="1681446">Pointer</span><span class="op" id="1681453">(</span><span class="op" id="1681454">&amp;</span><span class="ident" id="1681455">sel</span><span class="op" id="1681458">.</span><span class="ident" id="1681459">scase</span><span class="op" id="1681464">)</span><span class="op" id="1681465">,</span>&nbsp;<span class="builtintype" id="1681467">int</span><span class="op" id="1681470">(</span><span class="ident" id="1681471">sel</span><span class="op" id="1681474">.</span><span class="ident" id="1681475">ncase</span><span class="op" id="1681480">)</span><span class="op" id="1681481">,</span>&nbsp;<span class="builtintype" id="1681483">int</span><span class="op" id="1681486">(</span><span class="ident" id="1681487">sel</span><span class="op" id="1681490">.</span><span class="ident" id="1681491">ncase</span><span class="op" id="1681496">)</span><span class="op" id="1681497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681500">scases</span>&nbsp;<span class="op" id="1681507">:=</span>&nbsp;<span class="op" id="1681510">*</span><span class="op" id="1681511">(</span><span class="op" id="1681512">*</span><span class="op" id="1681513">[</span><span class="op" id="1681514">]</span><span class="ident" id="1681515">scase</span><span class="op" id="1681520">)</span><span class="op" id="1681521">(</span><span class="ident" id="1681522">unsafe</span><span class="op" id="1681528">.</span><span class="ident" id="1681529">Pointer</span><span class="op" id="1681536">(</span><span class="op" id="1681537">&amp;</span><span class="ident" id="1681538">scaseslice</span><span class="op" id="1681548">)</span><span class="op" id="1681549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681553">var</span>&nbsp;<span class="ident" id="1681557">t0</span>&nbsp;<span class="ident" id="1681560">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681567">if</span>&nbsp;<span class="ident" id="1681570">blockprofilerate</span>&nbsp;<span class="op" id="1681587">&gt;</span>&nbsp;<span class="num" id="1681589">0</span>&nbsp;<span class="op" id="1681591">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681595">t0</span>&nbsp;<span class="op" id="1681598">=</span>&nbsp;<span class="ident" id="1681600">cputicks</span><span class="op" id="1681608">(</span><span class="op" id="1681609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1681613">for</span>&nbsp;<span class="ident" id="1681617">i</span>&nbsp;<span class="op" id="1681619">:=</span>&nbsp;<span class="num" id="1681622">0</span><span class="op" id="1681623">;</span>&nbsp;<span class="ident" id="1681625">i</span>&nbsp;<span class="op" id="1681627">&lt;</span>&nbsp;<span class="builtintype" id="1681629">int</span><span class="op" id="1681632">(</span><span class="ident" id="1681633">sel</span><span class="op" id="1681636">.</span><span class="ident" id="1681637">ncase</span><span class="op" id="1681642">)</span><span class="op" id="1681643">;</span>&nbsp;<span class="ident" id="1681645">i</span><span class="op" id="1681646">++</span>&nbsp;<span class="op" id="1681649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1681654">scases</span><span class="op" id="1681660">[</span><span class="ident" id="1681661">i</span><span class="op" id="1681662">]</span><span class="op" id="1681663">.</span><span class="ident" id="1681664">releasetime</span>&nbsp;<span class="op" id="1681676">=</span>&nbsp;<span class="op" id="1681678">-</span><span class="num" id="1681679">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1681686">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681690">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681745">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681805">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681862">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681924">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1681982">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682042">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682081">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682109">pollslice</span>&nbsp;<span class="op" id="1682119">:=</span>&nbsp;<span class="ident" id="1682122">sliceStruct</span><span class="op" id="1682133">{</span><span class="ident" id="1682134">unsafe</span><span class="op" id="1682140">.</span><span class="ident" id="1682141">Pointer</span><span class="op" id="1682148">(</span><span class="ident" id="1682149">sel</span><span class="op" id="1682152">.</span><span class="ident" id="1682153">pollorder</span><span class="op" id="1682162">)</span><span class="op" id="1682163">,</span>&nbsp;<span class="builtintype" id="1682165">int</span><span class="op" id="1682168">(</span><span class="ident" id="1682169">sel</span><span class="op" id="1682172">.</span><span class="ident" id="1682173">ncase</span><span class="op" id="1682178">)</span><span class="op" id="1682179">,</span>&nbsp;<span class="builtintype" id="1682181">int</span><span class="op" id="1682184">(</span><span class="ident" id="1682185">sel</span><span class="op" id="1682188">.</span><span class="ident" id="1682189">ncase</span><span class="op" id="1682194">)</span><span class="op" id="1682195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682198">pollorder</span>&nbsp;<span class="op" id="1682208">:=</span>&nbsp;<span class="op" id="1682211">*</span><span class="op" id="1682212">(</span><span class="op" id="1682213">*</span><span class="op" id="1682214">[</span><span class="op" id="1682215">]</span><span class="builtintype" id="1682216">uint16</span><span class="op" id="1682222">)</span><span class="op" id="1682223">(</span><span class="ident" id="1682224">unsafe</span><span class="op" id="1682230">.</span><span class="ident" id="1682231">Pointer</span><span class="op" id="1682238">(</span><span class="op" id="1682239">&amp;</span><span class="ident" id="1682240">pollslice</span><span class="op" id="1682249">)</span><span class="op" id="1682250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682253">for</span>&nbsp;<span class="ident" id="1682257">i</span>&nbsp;<span class="op" id="1682259">:=</span>&nbsp;<span class="num" id="1682262">0</span><span class="op" id="1682263">;</span>&nbsp;<span class="ident" id="1682265">i</span>&nbsp;<span class="op" id="1682267">&lt;</span>&nbsp;<span class="builtintype" id="1682269">int</span><span class="op" id="1682272">(</span><span class="ident" id="1682273">sel</span><span class="op" id="1682276">.</span><span class="ident" id="1682277">ncase</span><span class="op" id="1682282">)</span><span class="op" id="1682283">;</span>&nbsp;<span class="ident" id="1682285">i</span><span class="op" id="1682286">++</span>&nbsp;<span class="op" id="1682289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682293">pollorder</span><span class="op" id="1682302">[</span><span class="ident" id="1682303">i</span><span class="op" id="1682304">]</span>&nbsp;<span class="op" id="1682306">=</span>&nbsp;<span class="builtintype" id="1682308">uint16</span><span class="op" id="1682314">(</span><span class="ident" id="1682315">i</span><span class="op" id="1682316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682319">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682322">for</span>&nbsp;<span class="ident" id="1682326">i</span>&nbsp;<span class="op" id="1682328">:=</span>&nbsp;<span class="num" id="1682331">1</span><span class="op" id="1682332">;</span>&nbsp;<span class="ident" id="1682334">i</span>&nbsp;<span class="op" id="1682336">&lt;</span>&nbsp;<span class="builtintype" id="1682338">int</span><span class="op" id="1682341">(</span><span class="ident" id="1682342">sel</span><span class="op" id="1682345">.</span><span class="ident" id="1682346">ncase</span><span class="op" id="1682351">)</span><span class="op" id="1682352">;</span>&nbsp;<span class="ident" id="1682354">i</span><span class="op" id="1682355">++</span>&nbsp;<span class="op" id="1682358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682362">o</span>&nbsp;<span class="op" id="1682364">:=</span>&nbsp;<span class="ident" id="1682367">pollorder</span><span class="op" id="1682376">[</span><span class="ident" id="1682377">i</span><span class="op" id="1682378">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682382">j</span>&nbsp;<span class="op" id="1682384">:=</span>&nbsp;<span class="builtintype" id="1682387">int</span><span class="op" id="1682390">(</span><span class="ident" id="1682391">fastrand1</span><span class="op" id="1682400">(</span><span class="op" id="1682401">)</span><span class="op" id="1682402">)</span>&nbsp;<span class="op" id="1682404">%</span>&nbsp;<span class="op" id="1682406">(</span><span class="ident" id="1682407">i</span>&nbsp;<span class="op" id="1682409">+</span>&nbsp;<span class="num" id="1682411">1</span><span class="op" id="1682412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682416">pollorder</span><span class="op" id="1682425">[</span><span class="ident" id="1682426">i</span><span class="op" id="1682427">]</span>&nbsp;<span class="op" id="1682429">=</span>&nbsp;<span class="ident" id="1682431">pollorder</span><span class="op" id="1682440">[</span><span class="ident" id="1682441">j</span><span class="op" id="1682442">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682446">pollorder</span><span class="op" id="1682455">[</span><span class="ident" id="1682456">j</span><span class="op" id="1682457">]</span>&nbsp;<span class="op" id="1682459">=</span>&nbsp;<span class="ident" id="1682461">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682468">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1682530">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682608">lockslice</span>&nbsp;<span class="op" id="1682618">:=</span>&nbsp;<span class="ident" id="1682621">sliceStruct</span><span class="op" id="1682632">{</span><span class="ident" id="1682633">unsafe</span><span class="op" id="1682639">.</span><span class="ident" id="1682640">Pointer</span><span class="op" id="1682647">(</span><span class="ident" id="1682648">sel</span><span class="op" id="1682651">.</span><span class="ident" id="1682652">lockorder</span><span class="op" id="1682661">)</span><span class="op" id="1682662">,</span>&nbsp;<span class="builtintype" id="1682664">int</span><span class="op" id="1682667">(</span><span class="ident" id="1682668">sel</span><span class="op" id="1682671">.</span><span class="ident" id="1682672">ncase</span><span class="op" id="1682677">)</span><span class="op" id="1682678">,</span>&nbsp;<span class="builtintype" id="1682680">int</span><span class="op" id="1682683">(</span><span class="ident" id="1682684">sel</span><span class="op" id="1682687">.</span><span class="ident" id="1682688">ncase</span><span class="op" id="1682693">)</span><span class="op" id="1682694">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682697">lockorder</span>&nbsp;<span class="op" id="1682707">:=</span>&nbsp;<span class="op" id="1682710">*</span><span class="op" id="1682711">(</span><span class="op" id="1682712">*</span><span class="op" id="1682713">[</span><span class="op" id="1682714">]</span><span class="op" id="1682715">*</span><span class="ident" id="1682716">hchan</span><span class="op" id="1682721">)</span><span class="op" id="1682722">(</span><span class="ident" id="1682723">unsafe</span><span class="op" id="1682729">.</span><span class="ident" id="1682730">Pointer</span><span class="op" id="1682737">(</span><span class="op" id="1682738">&amp;</span><span class="ident" id="1682739">lockslice</span><span class="op" id="1682748">)</span><span class="op" id="1682749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682752">for</span>&nbsp;<span class="ident" id="1682756">i</span>&nbsp;<span class="op" id="1682758">:=</span>&nbsp;<span class="num" id="1682761">0</span><span class="op" id="1682762">;</span>&nbsp;<span class="ident" id="1682764">i</span>&nbsp;<span class="op" id="1682766">&lt;</span>&nbsp;<span class="builtintype" id="1682768">int</span><span class="op" id="1682771">(</span><span class="ident" id="1682772">sel</span><span class="op" id="1682775">.</span><span class="ident" id="1682776">ncase</span><span class="op" id="1682781">)</span><span class="op" id="1682782">;</span>&nbsp;<span class="ident" id="1682784">i</span><span class="op" id="1682785">++</span>&nbsp;<span class="op" id="1682788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682792">j</span>&nbsp;<span class="op" id="1682794">:=</span>&nbsp;<span class="ident" id="1682797">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682801">c</span>&nbsp;<span class="op" id="1682803">:=</span>&nbsp;<span class="ident" id="1682806">scases</span><span class="op" id="1682812">[</span><span class="ident" id="1682813">j</span><span class="op" id="1682814">]</span><span class="op" id="1682815">.</span><span class="ident" id="1682816">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682824">for</span>&nbsp;<span class="ident" id="1682828">j</span>&nbsp;<span class="op" id="1682830">&gt;</span>&nbsp;<span class="num" id="1682832">0</span>&nbsp;<span class="op" id="1682834">&amp;&amp;</span>&nbsp;<span class="ident" id="1682837">lockorder</span><span class="op" id="1682846">[</span><span class="op" id="1682847">(</span><span class="ident" id="1682848">j</span><span class="op" id="1682849">-</span><span class="num" id="1682850">1</span><span class="op" id="1682851">)</span><span class="op" id="1682852">/</span><span class="num" id="1682853">2</span><span class="op" id="1682854">]</span><span class="op" id="1682855">.</span><span class="ident" id="1682856">sortkey</span><span class="op" id="1682863">(</span><span class="op" id="1682864">)</span>&nbsp;<span class="op" id="1682866">&lt;</span>&nbsp;<span class="ident" id="1682868">c</span><span class="op" id="1682869">.</span><span class="ident" id="1682870">sortkey</span><span class="op" id="1682877">(</span><span class="op" id="1682878">)</span>&nbsp;<span class="op" id="1682880">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682885">k</span>&nbsp;<span class="op" id="1682887">:=</span>&nbsp;<span class="op" id="1682890">(</span><span class="ident" id="1682891">j</span>&nbsp;<span class="op" id="1682893">-</span>&nbsp;<span class="num" id="1682895">1</span><span class="op" id="1682896">)</span>&nbsp;<span class="op" id="1682898">/</span>&nbsp;<span class="num" id="1682900">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682905">lockorder</span><span class="op" id="1682914">[</span><span class="ident" id="1682915">j</span><span class="op" id="1682916">]</span>&nbsp;<span class="op" id="1682918">=</span>&nbsp;<span class="ident" id="1682920">lockorder</span><span class="op" id="1682929">[</span><span class="ident" id="1682930">k</span><span class="op" id="1682931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682936">j</span>&nbsp;<span class="op" id="1682938">=</span>&nbsp;<span class="ident" id="1682940">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1682948">lockorder</span><span class="op" id="1682957">[</span><span class="ident" id="1682958">j</span><span class="op" id="1682959">]</span>&nbsp;<span class="op" id="1682961">=</span>&nbsp;<span class="ident" id="1682963">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1682966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1682969">for</span>&nbsp;<span class="ident" id="1682973">i</span>&nbsp;<span class="op" id="1682975">:=</span>&nbsp;<span class="builtintype" id="1682978">int</span><span class="op" id="1682981">(</span><span class="ident" id="1682982">sel</span><span class="op" id="1682985">.</span><span class="ident" id="1682986">ncase</span><span class="op" id="1682991">)</span>&nbsp;<span class="op" id="1682993">-</span>&nbsp;<span class="num" id="1682995">1</span><span class="op" id="1682996">;</span>&nbsp;<span class="ident" id="1682998">i</span>&nbsp;<span class="op" id="1683000">&gt;=</span>&nbsp;<span class="num" id="1683003">0</span><span class="op" id="1683004">;</span>&nbsp;<span class="ident" id="1683006">i</span><span class="op" id="1683007">--</span>&nbsp;<span class="op" id="1683010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683014">c</span>&nbsp;<span class="op" id="1683016">:=</span>&nbsp;<span class="ident" id="1683019">lockorder</span><span class="op" id="1683028">[</span><span class="ident" id="1683029">i</span><span class="op" id="1683030">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683034">lockorder</span><span class="op" id="1683043">[</span><span class="ident" id="1683044">i</span><span class="op" id="1683045">]</span>&nbsp;<span class="op" id="1683047">=</span>&nbsp;<span class="ident" id="1683049">lockorder</span><span class="op" id="1683058">[</span><span class="num" id="1683059">0</span><span class="op" id="1683060">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683064">j</span>&nbsp;<span class="op" id="1683066">:=</span>&nbsp;<span class="num" id="1683069">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683073">for</span>&nbsp;<span class="op" id="1683077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683082">k</span>&nbsp;<span class="op" id="1683084">:=</span>&nbsp;<span class="ident" id="1683087">j</span><span class="op" id="1683088">*</span><span class="num" id="1683089">2</span>&nbsp;<span class="op" id="1683091">+</span>&nbsp;<span class="num" id="1683093">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683098">if</span>&nbsp;<span class="ident" id="1683101">k</span>&nbsp;<span class="op" id="1683103">&gt;=</span>&nbsp;<span class="ident" id="1683106">i</span>&nbsp;<span class="op" id="1683108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683114">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683123">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683128">if</span>&nbsp;<span class="ident" id="1683131">k</span><span class="op" id="1683132">+</span><span class="num" id="1683133">1</span>&nbsp;<span class="op" id="1683135">&lt;</span>&nbsp;<span class="ident" id="1683137">i</span>&nbsp;<span class="op" id="1683139">&amp;&amp;</span>&nbsp;<span class="ident" id="1683142">lockorder</span><span class="op" id="1683151">[</span><span class="ident" id="1683152">k</span><span class="op" id="1683153">]</span><span class="op" id="1683154">.</span><span class="ident" id="1683155">sortkey</span><span class="op" id="1683162">(</span><span class="op" id="1683163">)</span>&nbsp;<span class="op" id="1683165">&lt;</span>&nbsp;<span class="ident" id="1683167">lockorder</span><span class="op" id="1683176">[</span><span class="ident" id="1683177">k</span><span class="op" id="1683178">+</span><span class="num" id="1683179">1</span><span class="op" id="1683180">]</span><span class="op" id="1683181">.</span><span class="ident" id="1683182">sortkey</span><span class="op" id="1683189">(</span><span class="op" id="1683190">)</span>&nbsp;<span class="op" id="1683192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683198">k</span><span class="op" id="1683199">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683210">if</span>&nbsp;<span class="ident" id="1683213">c</span><span class="op" id="1683214">.</span><span class="ident" id="1683215">sortkey</span><span class="op" id="1683222">(</span><span class="op" id="1683223">)</span>&nbsp;<span class="op" id="1683225">&lt;</span>&nbsp;<span class="ident" id="1683227">lockorder</span><span class="op" id="1683236">[</span><span class="ident" id="1683237">k</span><span class="op" id="1683238">]</span><span class="op" id="1683239">.</span><span class="ident" id="1683240">sortkey</span><span class="op" id="1683247">(</span><span class="op" id="1683248">)</span>&nbsp;<span class="op" id="1683250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683256">lockorder</span><span class="op" id="1683265">[</span><span class="ident" id="1683266">j</span><span class="op" id="1683267">]</span>&nbsp;<span class="op" id="1683269">=</span>&nbsp;<span class="ident" id="1683271">lockorder</span><span class="op" id="1683280">[</span><span class="ident" id="1683281">k</span><span class="op" id="1683282">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683288">j</span>&nbsp;<span class="op" id="1683290">=</span>&nbsp;<span class="ident" id="1683292">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683298">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683315">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683323">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683327">lockorder</span><span class="op" id="1683336">[</span><span class="ident" id="1683337">j</span><span class="op" id="1683338">]</span>&nbsp;<span class="op" id="1683340">=</span>&nbsp;<span class="ident" id="1683342">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683348">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683570">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683619">sellock</span><span class="op" id="1683626">(</span><span class="ident" id="1683627">sel</span><span class="op" id="1683630">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683634">var</span>&nbsp;<span class="op" id="1683638">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683642">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683649">*</span><span class="ident" id="1683650">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683654">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1683661">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683670">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683677">*</span><span class="ident" id="1683678">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683686">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683693">*</span><span class="ident" id="1683694">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683702">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683709">*</span><span class="ident" id="1683710">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683718">sglist</span>&nbsp;<span class="op" id="1683725">*</span><span class="ident" id="1683726">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683734">sgnext</span>&nbsp;<span class="op" id="1683741">*</span><span class="ident" id="1683742">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1683749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1683752">loop</span><span class="op" id="1683756">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1683759">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683807">var</span>&nbsp;<span class="ident" id="1683811">dfl</span>&nbsp;<span class="op" id="1683815">*</span><span class="ident" id="1683816">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683823">var</span>&nbsp;<span class="ident" id="1683827">cas</span>&nbsp;<span class="op" id="1683831">*</span><span class="ident" id="1683832">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683839">for</span>&nbsp;<span class="ident" id="1683843">i</span>&nbsp;<span class="op" id="1683845">:=</span>&nbsp;<span class="num" id="1683848">0</span><span class="op" id="1683849">;</span>&nbsp;<span class="ident" id="1683851">i</span>&nbsp;<span class="op" id="1683853">&lt;</span>&nbsp;<span class="builtintype" id="1683855">int</span><span class="op" id="1683858">(</span><span class="ident" id="1683859">sel</span><span class="op" id="1683862">.</span><span class="ident" id="1683863">ncase</span><span class="op" id="1683868">)</span><span class="op" id="1683869">;</span>&nbsp;<span class="ident" id="1683871">i</span><span class="op" id="1683872">++</span>&nbsp;<span class="op" id="1683875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683879">cas</span>&nbsp;<span class="op" id="1683883">=</span>&nbsp;<span class="op" id="1683885">&amp;</span><span class="ident" id="1683886">scases</span><span class="op" id="1683892">[</span><span class="ident" id="1683893">pollorder</span><span class="op" id="1683902">[</span><span class="ident" id="1683903">i</span><span class="op" id="1683904">]</span><span class="op" id="1683905">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1683909">c</span>&nbsp;<span class="op" id="1683911">=</span>&nbsp;<span class="ident" id="1683913">cas</span><span class="op" id="1683916">.</span><span class="ident" id="1683917">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683926">switch</span>&nbsp;<span class="ident" id="1683933">cas</span><span class="op" id="1683936">.</span><span class="ident" id="1683937">kind</span>&nbsp;<span class="op" id="1683942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683946">case</span>&nbsp;<span class="ident" id="1683951">_CaseRecv</span><span class="op" id="1683960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683965">if</span>&nbsp;<span class="ident" id="1683968">c</span><span class="op" id="1683969">.</span><span class="ident" id="1683970">dataqsiz</span>&nbsp;<span class="op" id="1683979">&gt;</span>&nbsp;<span class="num" id="1683981">0</span>&nbsp;<span class="op" id="1683983">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1683989">if</span>&nbsp;<span class="ident" id="1683992">c</span><span class="op" id="1683993">.</span><span class="ident" id="1683994">qcount</span>&nbsp;<span class="op" id="1684001">&gt;</span>&nbsp;<span class="num" id="1684003">0</span>&nbsp;<span class="op" id="1684005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684012">goto</span>&nbsp;<span class="ident" id="1684017">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684036">}</span>&nbsp;<span class="keyword" id="1684038">else</span>&nbsp;<span class="op" id="1684043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684049">sg</span>&nbsp;<span class="op" id="1684052">=</span>&nbsp;<span class="ident" id="1684054">c</span><span class="op" id="1684055">.</span><span class="ident" id="1684056">sendq</span><span class="op" id="1684061">.</span><span class="ident" id="1684062">dequeue</span><span class="op" id="1684069">(</span><span class="op" id="1684070">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684076">if</span>&nbsp;<span class="ident" id="1684079">sg</span>&nbsp;<span class="op" id="1684082">!=</span>&nbsp;<span class="ident" id="1684085">nil</span>&nbsp;<span class="op" id="1684089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684096">goto</span>&nbsp;<span class="ident" id="1684101">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684124">if</span>&nbsp;<span class="ident" id="1684127">c</span><span class="op" id="1684128">.</span><span class="ident" id="1684129">closed</span>&nbsp;<span class="op" id="1684136">!=</span>&nbsp;<span class="num" id="1684139">0</span>&nbsp;<span class="op" id="1684141">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684147">goto</span>&nbsp;<span class="ident" id="1684152">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684167">case</span>&nbsp;<span class="ident" id="1684172">_CaseSend</span><span class="op" id="1684181">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684186">if</span>&nbsp;<span class="ident" id="1684189">raceenabled</span>&nbsp;<span class="op" id="1684201">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684207">racereadpc</span><span class="op" id="1684217">(</span><span class="ident" id="1684218">unsafe</span><span class="op" id="1684224">.</span><span class="ident" id="1684225">Pointer</span><span class="op" id="1684232">(</span><span class="ident" id="1684233">c</span><span class="op" id="1684234">)</span><span class="op" id="1684235">,</span>&nbsp;<span class="ident" id="1684237">cas</span><span class="op" id="1684240">.</span><span class="ident" id="1684241">pc</span><span class="op" id="1684243">,</span>&nbsp;<span class="ident" id="1684245">chansendpc</span><span class="op" id="1684255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684265">if</span>&nbsp;<span class="ident" id="1684268">c</span><span class="op" id="1684269">.</span><span class="ident" id="1684270">closed</span>&nbsp;<span class="op" id="1684277">!=</span>&nbsp;<span class="num" id="1684280">0</span>&nbsp;<span class="op" id="1684282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684288">goto</span>&nbsp;<span class="ident" id="1684293">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684303">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684308">if</span>&nbsp;<span class="ident" id="1684311">c</span><span class="op" id="1684312">.</span><span class="ident" id="1684313">dataqsiz</span>&nbsp;<span class="op" id="1684322">&gt;</span>&nbsp;<span class="num" id="1684324">0</span>&nbsp;<span class="op" id="1684326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684332">if</span>&nbsp;<span class="ident" id="1684335">c</span><span class="op" id="1684336">.</span><span class="ident" id="1684337">qcount</span>&nbsp;<span class="op" id="1684344">&lt;</span>&nbsp;<span class="ident" id="1684346">c</span><span class="op" id="1684347">.</span><span class="ident" id="1684348">dataqsiz</span>&nbsp;<span class="op" id="1684357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684364">goto</span>&nbsp;<span class="ident" id="1684369">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684388">}</span>&nbsp;<span class="keyword" id="1684390">else</span>&nbsp;<span class="op" id="1684395">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684401">sg</span>&nbsp;<span class="op" id="1684404">=</span>&nbsp;<span class="ident" id="1684406">c</span><span class="op" id="1684407">.</span><span class="ident" id="1684408">recvq</span><span class="op" id="1684413">.</span><span class="ident" id="1684414">dequeue</span><span class="op" id="1684421">(</span><span class="op" id="1684422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684428">if</span>&nbsp;<span class="ident" id="1684431">sg</span>&nbsp;<span class="op" id="1684434">!=</span>&nbsp;<span class="ident" id="1684437">nil</span>&nbsp;<span class="op" id="1684441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684448">goto</span>&nbsp;<span class="ident" id="1684453">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684471">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684476">case</span>&nbsp;<span class="ident" id="1684481">_CaseDefault</span><span class="op" id="1684493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684498">dfl</span>&nbsp;<span class="op" id="1684502">=</span>&nbsp;<span class="ident" id="1684504">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684513">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684517">if</span>&nbsp;<span class="ident" id="1684520">dfl</span>&nbsp;<span class="op" id="1684524">!=</span>&nbsp;<span class="ident" id="1684527">nil</span>&nbsp;<span class="op" id="1684531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684535">selunlock</span><span class="op" id="1684544">(</span><span class="ident" id="1684545">sel</span><span class="op" id="1684548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684552">cas</span>&nbsp;<span class="op" id="1684556">=</span>&nbsp;<span class="ident" id="1684558">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684564">goto</span>&nbsp;<span class="ident" id="1684569">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684579">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684613">gp</span>&nbsp;<span class="op" id="1684616">=</span>&nbsp;<span class="ident" id="1684618">getg</span><span class="op" id="1684622">(</span><span class="op" id="1684623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684626">done</span>&nbsp;<span class="op" id="1684631">=</span>&nbsp;<span class="num" id="1684633">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684636">for</span>&nbsp;<span class="ident" id="1684640">i</span>&nbsp;<span class="op" id="1684642">:=</span>&nbsp;<span class="num" id="1684645">0</span><span class="op" id="1684646">;</span>&nbsp;<span class="ident" id="1684648">i</span>&nbsp;<span class="op" id="1684650">&lt;</span>&nbsp;<span class="builtintype" id="1684652">int</span><span class="op" id="1684655">(</span><span class="ident" id="1684656">sel</span><span class="op" id="1684659">.</span><span class="ident" id="1684660">ncase</span><span class="op" id="1684665">)</span><span class="op" id="1684666">;</span>&nbsp;<span class="ident" id="1684668">i</span><span class="op" id="1684669">++</span>&nbsp;<span class="op" id="1684672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684676">cas</span>&nbsp;<span class="op" id="1684680">=</span>&nbsp;<span class="op" id="1684682">&amp;</span><span class="ident" id="1684683">scases</span><span class="op" id="1684689">[</span><span class="ident" id="1684690">pollorder</span><span class="op" id="1684699">[</span><span class="ident" id="1684700">i</span><span class="op" id="1684701">]</span><span class="op" id="1684702">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684706">c</span>&nbsp;<span class="op" id="1684708">=</span>&nbsp;<span class="ident" id="1684710">cas</span><span class="op" id="1684713">.</span><span class="ident" id="1684714">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684722">sg</span>&nbsp;<span class="op" id="1684725">:=</span>&nbsp;<span class="ident" id="1684728">acquireSudog</span><span class="op" id="1684740">(</span><span class="op" id="1684741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684745">sg</span><span class="op" id="1684747">.</span><span class="ident" id="1684748">g</span>&nbsp;<span class="op" id="1684750">=</span>&nbsp;<span class="ident" id="1684752">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1684757">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684832">sg</span><span class="op" id="1684834">.</span><span class="ident" id="1684835">selectdone</span>&nbsp;<span class="op" id="1684846">=</span>&nbsp;<span class="op" id="1684848">(</span><span class="op" id="1684849">*</span><span class="builtintype" id="1684850">uint32</span><span class="op" id="1684856">)</span><span class="op" id="1684857">(</span><span class="ident" id="1684858">noescape</span><span class="op" id="1684866">(</span><span class="ident" id="1684867">unsafe</span><span class="op" id="1684873">.</span><span class="ident" id="1684874">Pointer</span><span class="op" id="1684881">(</span><span class="op" id="1684882">&amp;</span><span class="ident" id="1684883">done</span><span class="op" id="1684887">)</span><span class="op" id="1684888">)</span><span class="op" id="1684889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684893">sg</span><span class="op" id="1684895">.</span><span class="ident" id="1684896">elem</span>&nbsp;<span class="op" id="1684901">=</span>&nbsp;<span class="ident" id="1684903">cas</span><span class="op" id="1684906">.</span><span class="ident" id="1684907">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684914">sg</span><span class="op" id="1684916">.</span><span class="ident" id="1684917">releasetime</span>&nbsp;<span class="op" id="1684929">=</span>&nbsp;<span class="num" id="1684931">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1684935">if</span>&nbsp;<span class="ident" id="1684938">t0</span>&nbsp;<span class="op" id="1684941">!=</span>&nbsp;<span class="num" id="1684944">0</span>&nbsp;<span class="op" id="1684946">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684951">sg</span><span class="op" id="1684953">.</span><span class="ident" id="1684954">releasetime</span>&nbsp;<span class="op" id="1684966">=</span>&nbsp;<span class="op" id="1684968">-</span><span class="num" id="1684969">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1684973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1684977">sg</span><span class="op" id="1684979">.</span><span class="ident" id="1684980">waitlink</span>&nbsp;<span class="op" id="1684989">=</span>&nbsp;<span class="ident" id="1684991">gp</span><span class="op" id="1684993">.</span><span class="ident" id="1684994">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685004">gp</span><span class="op" id="1685006">.</span><span class="ident" id="1685007">waiting</span>&nbsp;<span class="op" id="1685015">=</span>&nbsp;<span class="ident" id="1685017">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685023">switch</span>&nbsp;<span class="ident" id="1685030">cas</span><span class="op" id="1685033">.</span><span class="ident" id="1685034">kind</span>&nbsp;<span class="op" id="1685039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685043">case</span>&nbsp;<span class="ident" id="1685048">_CaseRecv</span><span class="op" id="1685057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685062">c</span><span class="op" id="1685063">.</span><span class="ident" id="1685064">recvq</span><span class="op" id="1685069">.</span><span class="ident" id="1685070">enqueue</span><span class="op" id="1685077">(</span><span class="ident" id="1685078">sg</span><span class="op" id="1685080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1685085">case</span>&nbsp;<span class="ident" id="1685090">_CaseSend</span><span class="op" id="1685099">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685104">c</span><span class="op" id="1685105">.</span><span class="ident" id="1685106">sendq</span><span class="op" id="1685111">.</span><span class="ident" id="1685112">enqueue</span><span class="op" id="1685119">(</span><span class="ident" id="1685120">sg</span><span class="op" id="1685122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1685129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685133">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685168">gp</span><span class="op" id="1685170">.</span><span class="ident" id="1685171">param</span>&nbsp;<span class="op" id="1685177">=</span>&nbsp;<span class="ident" id="1685179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685184">gopark</span><span class="op" id="1685190">(</span><span class="ident" id="1685191">unsafe</span><span class="op" id="1685197">.</span><span class="ident" id="1685198">Pointer</span><span class="op" id="1685205">(</span><span class="ident" id="1685206">funcPC</span><span class="op" id="1685212">(</span><span class="ident" id="1685213">selparkcommit</span><span class="op" id="1685226">)</span><span class="op" id="1685227">)</span><span class="op" id="1685228">,</span>&nbsp;<span class="ident" id="1685230">unsafe</span><span class="op" id="1685236">.</span><span class="ident" id="1685237">Pointer</span><span class="op" id="1685244">(</span><span class="ident" id="1685245">sel</span><span class="op" id="1685248">)</span><span class="op" id="1685249">,</span>&nbsp;<span class="string" id="1685251">&#34;select&#34;</span><span class="op" id="1685259">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685263">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685286">sellock</span><span class="op" id="1685293">(</span><span class="ident" id="1685294">sel</span><span class="op" id="1685297">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685300">sg</span>&nbsp;<span class="op" id="1685303">=</span>&nbsp;<span class="op" id="1685305">(</span><span class="op" id="1685306">*</span><span class="ident" id="1685307">sudog</span><span class="op" id="1685312">)</span><span class="op" id="1685313">(</span><span class="ident" id="1685314">gp</span><span class="op" id="1685316">.</span><span class="ident" id="1685317">param</span><span class="op" id="1685322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685325">gp</span><span class="op" id="1685327">.</span><span class="ident" id="1685328">param</span>&nbsp;<span class="op" id="1685334">=</span>&nbsp;<span class="ident" id="1685336">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685342">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685387">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685433">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685473">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685531">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685596">cas</span>&nbsp;<span class="op" id="1685600">=</span>&nbsp;<span class="ident" id="1685602">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1685607">sglist</span>&nbsp;<span class="op" id="1685614">=</span>&nbsp;<span class="ident" id="1685616">gp</span><span class="op" id="1685618">.</span><span class="ident" id="1685619">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685628">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685696">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685765">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685843">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685918">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1685984">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686007">for</span>&nbsp;<span class="ident" id="1686011">sg1</span>&nbsp;<span class="op" id="1686015">:=</span>&nbsp;<span class="ident" id="1686018">gp</span><span class="op" id="1686020">.</span><span class="ident" id="1686021">waiting</span><span class="op" id="1686028">;</span>&nbsp;<span class="ident" id="1686030">sg1</span>&nbsp;<span class="op" id="1686034">!=</span>&nbsp;<span class="ident" id="1686037">nil</span><span class="op" id="1686040">;</span>&nbsp;<span class="ident" id="1686042">sg1</span>&nbsp;<span class="op" id="1686046">=</span>&nbsp;<span class="ident" id="1686048">sg1</span><span class="op" id="1686051">.</span><span class="ident" id="1686052">waitlink</span>&nbsp;<span class="op" id="1686061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686065">sg1</span><span class="op" id="1686068">.</span><span class="ident" id="1686069">selectdone</span>&nbsp;<span class="op" id="1686080">=</span>&nbsp;<span class="ident" id="1686082">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686088">sg1</span><span class="op" id="1686091">.</span><span class="ident" id="1686092">elem</span>&nbsp;<span class="op" id="1686097">=</span>&nbsp;<span class="ident" id="1686099">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686104">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686107">gp</span><span class="op" id="1686109">.</span><span class="ident" id="1686110">waiting</span>&nbsp;<span class="op" id="1686118">=</span>&nbsp;<span class="ident" id="1686120">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686125">for</span>&nbsp;<span class="ident" id="1686129">i</span>&nbsp;<span class="op" id="1686131">:=</span>&nbsp;<span class="builtintype" id="1686134">int</span><span class="op" id="1686137">(</span><span class="ident" id="1686138">sel</span><span class="op" id="1686141">.</span><span class="ident" id="1686142">ncase</span><span class="op" id="1686147">)</span>&nbsp;<span class="op" id="1686149">-</span>&nbsp;<span class="num" id="1686151">1</span><span class="op" id="1686152">;</span>&nbsp;<span class="ident" id="1686154">i</span>&nbsp;<span class="op" id="1686156">&gt;=</span>&nbsp;<span class="num" id="1686159">0</span><span class="op" id="1686160">;</span>&nbsp;<span class="ident" id="1686162">i</span><span class="op" id="1686163">--</span>&nbsp;<span class="op" id="1686166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686170">k</span>&nbsp;<span class="op" id="1686172">=</span>&nbsp;<span class="op" id="1686174">&amp;</span><span class="ident" id="1686175">scases</span><span class="op" id="1686181">[</span><span class="ident" id="1686182">pollorder</span><span class="op" id="1686191">[</span><span class="ident" id="1686192">i</span><span class="op" id="1686193">]</span><span class="op" id="1686194">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686198">if</span>&nbsp;<span class="ident" id="1686201">sglist</span><span class="op" id="1686207">.</span><span class="ident" id="1686208">releasetime</span>&nbsp;<span class="op" id="1686220">&gt;</span>&nbsp;<span class="num" id="1686222">0</span>&nbsp;<span class="op" id="1686224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686229">k</span><span class="op" id="1686230">.</span><span class="ident" id="1686231">releasetime</span>&nbsp;<span class="op" id="1686243">=</span>&nbsp;<span class="ident" id="1686245">sglist</span><span class="op" id="1686251">.</span><span class="ident" id="1686252">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686270">if</span>&nbsp;<span class="ident" id="1686273">sg</span>&nbsp;<span class="op" id="1686276">==</span>&nbsp;<span class="ident" id="1686279">sglist</span>&nbsp;<span class="op" id="1686286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686291">cas</span>&nbsp;<span class="op" id="1686295">=</span>&nbsp;<span class="ident" id="1686297">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686301">}</span>&nbsp;<span class="keyword" id="1686303">else</span>&nbsp;<span class="op" id="1686308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686313">c</span>&nbsp;<span class="op" id="1686315">=</span>&nbsp;<span class="ident" id="1686317">k</span><span class="op" id="1686318">.</span><span class="ident" id="1686319">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686328">if</span>&nbsp;<span class="ident" id="1686331">k</span><span class="op" id="1686332">.</span><span class="ident" id="1686333">kind</span>&nbsp;<span class="op" id="1686338">==</span>&nbsp;<span class="ident" id="1686341">_CaseSend</span>&nbsp;<span class="op" id="1686351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686357">c</span><span class="op" id="1686358">.</span><span class="ident" id="1686359">sendq</span><span class="op" id="1686364">.</span><span class="ident" id="1686365">dequeueSudoG</span><span class="op" id="1686377">(</span><span class="ident" id="1686378">sglist</span><span class="op" id="1686384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686389">}</span>&nbsp;<span class="keyword" id="1686391">else</span>&nbsp;<span class="op" id="1686396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686402">c</span><span class="op" id="1686403">.</span><span class="ident" id="1686404">recvq</span><span class="op" id="1686409">.</span><span class="ident" id="1686410">dequeueSudoG</span><span class="op" id="1686422">(</span><span class="ident" id="1686423">sglist</span><span class="op" id="1686429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686434">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686442">sgnext</span>&nbsp;<span class="op" id="1686449">=</span>&nbsp;<span class="ident" id="1686451">sglist</span><span class="op" id="1686457">.</span><span class="ident" id="1686458">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686469">sglist</span><span class="op" id="1686475">.</span><span class="ident" id="1686476">waitlink</span>&nbsp;<span class="op" id="1686485">=</span>&nbsp;<span class="ident" id="1686487">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686493">releaseSudog</span><span class="op" id="1686505">(</span><span class="ident" id="1686506">sglist</span><span class="op" id="1686512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686516">sglist</span>&nbsp;<span class="op" id="1686523">=</span>&nbsp;<span class="ident" id="1686525">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686537">if</span>&nbsp;<span class="ident" id="1686540">cas</span>&nbsp;<span class="op" id="1686544">==</span>&nbsp;<span class="ident" id="1686547">nil</span>&nbsp;<span class="op" id="1686551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686555">goto</span>&nbsp;<span class="ident" id="1686560">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686566">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686570">c</span>&nbsp;<span class="op" id="1686572">=</span>&nbsp;<span class="ident" id="1686574">cas</span><span class="op" id="1686577">.</span><span class="ident" id="1686578">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686586">if</span>&nbsp;<span class="ident" id="1686589">c</span><span class="op" id="1686590">.</span><span class="ident" id="1686591">dataqsiz</span>&nbsp;<span class="op" id="1686600">&gt;</span>&nbsp;<span class="num" id="1686602">0</span>&nbsp;<span class="op" id="1686604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686608">gothrow</span><span class="op" id="1686615">(</span><span class="string" id="1686616">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1686644">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686651">if</span>&nbsp;<span class="ident" id="1686654">debugSelect</span>&nbsp;<span class="op" id="1686666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1686670">print</span><span class="op" id="1686675">(</span><span class="string" id="1686676">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1686695">,</span>&nbsp;<span class="ident" id="1686697">sel</span><span class="op" id="1686700">,</span>&nbsp;<span class="string" id="1686702">&#34;&nbsp;c=&#34;</span><span class="op" id="1686707">,</span>&nbsp;<span class="ident" id="1686709">c</span><span class="op" id="1686710">,</span>&nbsp;<span class="string" id="1686712">&#34;&nbsp;cas=&#34;</span><span class="op" id="1686719">,</span>&nbsp;<span class="ident" id="1686721">cas</span><span class="op" id="1686724">,</span>&nbsp;<span class="string" id="1686726">&#34;&nbsp;kind=&#34;</span><span class="op" id="1686734">,</span>&nbsp;<span class="ident" id="1686736">cas</span><span class="op" id="1686739">.</span><span class="ident" id="1686740">kind</span><span class="op" id="1686744">,</span>&nbsp;<span class="string" id="1686746">&#34;\n&#34;</span><span class="op" id="1686750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686753">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686757">if</span>&nbsp;<span class="ident" id="1686760">cas</span><span class="op" id="1686763">.</span><span class="ident" id="1686764">kind</span>&nbsp;<span class="op" id="1686769">==</span>&nbsp;<span class="ident" id="1686772">_CaseRecv</span>&nbsp;<span class="op" id="1686782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686786">if</span>&nbsp;<span class="ident" id="1686789">cas</span><span class="op" id="1686792">.</span><span class="ident" id="1686793">receivedp</span>&nbsp;<span class="op" id="1686803">!=</span>&nbsp;<span class="ident" id="1686806">nil</span>&nbsp;<span class="op" id="1686810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686815">*</span><span class="ident" id="1686816">cas</span><span class="op" id="1686819">.</span><span class="ident" id="1686820">receivedp</span>&nbsp;<span class="op" id="1686830">=</span>&nbsp;<span class="builtintype" id="1686832">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686839">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686846">if</span>&nbsp;<span class="ident" id="1686849">raceenabled</span>&nbsp;<span class="op" id="1686861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1686865">if</span>&nbsp;<span class="ident" id="1686868">cas</span><span class="op" id="1686871">.</span><span class="ident" id="1686872">kind</span>&nbsp;<span class="op" id="1686877">==</span>&nbsp;<span class="ident" id="1686880">_CaseRecv</span>&nbsp;<span class="op" id="1686890">&amp;&amp;</span>&nbsp;<span class="ident" id="1686893">cas</span><span class="op" id="1686896">.</span><span class="ident" id="1686897">elem</span>&nbsp;<span class="op" id="1686902">!=</span>&nbsp;<span class="ident" id="1686905">nil</span>&nbsp;<span class="op" id="1686909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1686914">raceWriteObjectPC</span><span class="op" id="1686931">(</span><span class="ident" id="1686932">c</span><span class="op" id="1686933">.</span><span class="ident" id="1686934">elemtype</span><span class="op" id="1686942">,</span>&nbsp;<span class="ident" id="1686944">cas</span><span class="op" id="1686947">.</span><span class="ident" id="1686948">elem</span><span class="op" id="1686952">,</span>&nbsp;<span class="ident" id="1686954">cas</span><span class="op" id="1686957">.</span><span class="ident" id="1686958">pc</span><span class="op" id="1686960">,</span>&nbsp;<span class="ident" id="1686962">chanrecvpc</span><span class="op" id="1686972">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1686976">}</span>&nbsp;<span class="keyword" id="1686978">else</span>&nbsp;<span class="keyword" id="1686983">if</span>&nbsp;<span class="ident" id="1686986">cas</span><span class="op" id="1686989">.</span><span class="ident" id="1686990">kind</span>&nbsp;<span class="op" id="1686995">==</span>&nbsp;<span class="ident" id="1686998">_CaseSend</span>&nbsp;<span class="op" id="1687008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687013">raceReadObjectPC</span><span class="op" id="1687029">(</span><span class="ident" id="1687030">c</span><span class="op" id="1687031">.</span><span class="ident" id="1687032">elemtype</span><span class="op" id="1687040">,</span>&nbsp;<span class="ident" id="1687042">cas</span><span class="op" id="1687045">.</span><span class="ident" id="1687046">elem</span><span class="op" id="1687050">,</span>&nbsp;<span class="ident" id="1687052">cas</span><span class="op" id="1687055">.</span><span class="ident" id="1687056">pc</span><span class="op" id="1687058">,</span>&nbsp;<span class="ident" id="1687060">chansendpc</span><span class="op" id="1687070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687081">selunlock</span><span class="op" id="1687090">(</span><span class="ident" id="1687091">sel</span><span class="op" id="1687094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687097">goto</span>&nbsp;<span class="ident" id="1687102">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1687108">asyncrecv</span><span class="op" id="1687117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687120">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687148">if</span>&nbsp;<span class="ident" id="1687151">raceenabled</span>&nbsp;<span class="op" id="1687163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687167">if</span>&nbsp;<span class="ident" id="1687170">cas</span><span class="op" id="1687173">.</span><span class="ident" id="1687174">elem</span>&nbsp;<span class="op" id="1687179">!=</span>&nbsp;<span class="ident" id="1687182">nil</span>&nbsp;<span class="op" id="1687186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687191">raceWriteObjectPC</span><span class="op" id="1687208">(</span><span class="ident" id="1687209">c</span><span class="op" id="1687210">.</span><span class="ident" id="1687211">elemtype</span><span class="op" id="1687219">,</span>&nbsp;<span class="ident" id="1687221">cas</span><span class="op" id="1687224">.</span><span class="ident" id="1687225">elem</span><span class="op" id="1687229">,</span>&nbsp;<span class="ident" id="1687231">cas</span><span class="op" id="1687234">.</span><span class="ident" id="1687235">pc</span><span class="op" id="1687237">,</span>&nbsp;<span class="ident" id="1687239">chanrecvpc</span><span class="op" id="1687249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687257">raceacquire</span><span class="op" id="1687268">(</span><span class="ident" id="1687269">chanbuf</span><span class="op" id="1687276">(</span><span class="ident" id="1687277">c</span><span class="op" id="1687278">,</span>&nbsp;<span class="ident" id="1687280">c</span><span class="op" id="1687281">.</span><span class="ident" id="1687282">recvx</span><span class="op" id="1687287">)</span><span class="op" id="1687288">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687292">racerelease</span><span class="op" id="1687303">(</span><span class="ident" id="1687304">chanbuf</span><span class="op" id="1687311">(</span><span class="ident" id="1687312">c</span><span class="op" id="1687313">,</span>&nbsp;<span class="ident" id="1687315">c</span><span class="op" id="1687316">.</span><span class="ident" id="1687317">recvx</span><span class="op" id="1687322">)</span><span class="op" id="1687323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687329">if</span>&nbsp;<span class="ident" id="1687332">cas</span><span class="op" id="1687335">.</span><span class="ident" id="1687336">receivedp</span>&nbsp;<span class="op" id="1687346">!=</span>&nbsp;<span class="ident" id="1687349">nil</span>&nbsp;<span class="op" id="1687353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687357">*</span><span class="ident" id="1687358">cas</span><span class="op" id="1687361">.</span><span class="ident" id="1687362">receivedp</span>&nbsp;<span class="op" id="1687372">=</span>&nbsp;<span class="builtintype" id="1687374">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687380">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687383">if</span>&nbsp;<span class="ident" id="1687386">cas</span><span class="op" id="1687389">.</span><span class="ident" id="1687390">elem</span>&nbsp;<span class="op" id="1687395">!=</span>&nbsp;<span class="ident" id="1687398">nil</span>&nbsp;<span class="op" id="1687402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687406">memmove</span><span class="op" id="1687413">(</span><span class="ident" id="1687414">cas</span><span class="op" id="1687417">.</span><span class="ident" id="1687418">elem</span><span class="op" id="1687422">,</span>&nbsp;<span class="ident" id="1687424">chanbuf</span><span class="op" id="1687431">(</span><span class="ident" id="1687432">c</span><span class="op" id="1687433">,</span>&nbsp;<span class="ident" id="1687435">c</span><span class="op" id="1687436">.</span><span class="ident" id="1687437">recvx</span><span class="op" id="1687442">)</span><span class="op" id="1687443">,</span>&nbsp;<span class="builtintype" id="1687445">uintptr</span><span class="op" id="1687452">(</span><span class="ident" id="1687453">c</span><span class="op" id="1687454">.</span><span class="ident" id="1687455">elemsize</span><span class="op" id="1687463">)</span><span class="op" id="1687464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687470">memclr</span><span class="op" id="1687476">(</span><span class="ident" id="1687477">chanbuf</span><span class="op" id="1687484">(</span><span class="ident" id="1687485">c</span><span class="op" id="1687486">,</span>&nbsp;<span class="ident" id="1687488">c</span><span class="op" id="1687489">.</span><span class="ident" id="1687490">recvx</span><span class="op" id="1687495">)</span><span class="op" id="1687496">,</span>&nbsp;<span class="builtintype" id="1687498">uintptr</span><span class="op" id="1687505">(</span><span class="ident" id="1687506">c</span><span class="op" id="1687507">.</span><span class="ident" id="1687508">elemsize</span><span class="op" id="1687516">)</span><span class="op" id="1687517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687520">c</span><span class="op" id="1687521">.</span><span class="ident" id="1687522">recvx</span><span class="op" id="1687527">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687531">if</span>&nbsp;<span class="ident" id="1687534">c</span><span class="op" id="1687535">.</span><span class="ident" id="1687536">recvx</span>&nbsp;<span class="op" id="1687542">==</span>&nbsp;<span class="ident" id="1687545">c</span><span class="op" id="1687546">.</span><span class="ident" id="1687547">dataqsiz</span>&nbsp;<span class="op" id="1687556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687560">c</span><span class="op" id="1687561">.</span><span class="ident" id="1687562">recvx</span>&nbsp;<span class="op" id="1687568">=</span>&nbsp;<span class="num" id="1687570">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687576">c</span><span class="op" id="1687577">.</span><span class="ident" id="1687578">qcount</span><span class="op" id="1687584">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687588">sg</span>&nbsp;<span class="op" id="1687591">=</span>&nbsp;<span class="ident" id="1687593">c</span><span class="op" id="1687594">.</span><span class="ident" id="1687595">sendq</span><span class="op" id="1687600">.</span><span class="ident" id="1687601">dequeue</span><span class="op" id="1687608">(</span><span class="op" id="1687609">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687612">if</span>&nbsp;<span class="ident" id="1687615">sg</span>&nbsp;<span class="op" id="1687618">!=</span>&nbsp;<span class="ident" id="1687621">nil</span>&nbsp;<span class="op" id="1687625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687629">gp</span>&nbsp;<span class="op" id="1687632">=</span>&nbsp;<span class="ident" id="1687634">sg</span><span class="op" id="1687636">.</span><span class="ident" id="1687637">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687641">selunlock</span><span class="op" id="1687650">(</span><span class="ident" id="1687651">sel</span><span class="op" id="1687654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687658">if</span>&nbsp;<span class="ident" id="1687661">sg</span><span class="op" id="1687663">.</span><span class="ident" id="1687664">releasetime</span>&nbsp;<span class="op" id="1687676">!=</span>&nbsp;<span class="num" id="1687679">0</span>&nbsp;<span class="op" id="1687681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687686">sg</span><span class="op" id="1687688">.</span><span class="ident" id="1687689">releasetime</span>&nbsp;<span class="op" id="1687701">=</span>&nbsp;<span class="ident" id="1687703">cputicks</span><span class="op" id="1687711">(</span><span class="op" id="1687712">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687720">goready</span><span class="op" id="1687727">(</span><span class="ident" id="1687728">gp</span><span class="op" id="1687730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687733">}</span>&nbsp;<span class="keyword" id="1687735">else</span>&nbsp;<span class="op" id="1687740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687744">selunlock</span><span class="op" id="1687753">(</span><span class="ident" id="1687754">sel</span><span class="op" id="1687757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687760">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687763">goto</span>&nbsp;<span class="ident" id="1687768">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1687774">asyncsend</span><span class="op" id="1687783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1687786">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1687809">if</span>&nbsp;<span class="ident" id="1687812">raceenabled</span>&nbsp;<span class="op" id="1687824">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687828">raceacquire</span><span class="op" id="1687839">(</span><span class="ident" id="1687840">chanbuf</span><span class="op" id="1687847">(</span><span class="ident" id="1687848">c</span><span class="op" id="1687849">,</span>&nbsp;<span class="ident" id="1687851">c</span><span class="op" id="1687852">.</span><span class="ident" id="1687853">sendx</span><span class="op" id="1687858">)</span><span class="op" id="1687859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687863">racerelease</span><span class="op" id="1687874">(</span><span class="ident" id="1687875">chanbuf</span><span class="op" id="1687882">(</span><span class="ident" id="1687883">c</span><span class="op" id="1687884">,</span>&nbsp;<span class="ident" id="1687886">c</span><span class="op" id="1687887">.</span><span class="ident" id="1687888">sendx</span><span class="op" id="1687893">)</span><span class="op" id="1687894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687898">raceReadObjectPC</span><span class="op" id="1687914">(</span><span class="ident" id="1687915">c</span><span class="op" id="1687916">.</span><span class="ident" id="1687917">elemtype</span><span class="op" id="1687925">,</span>&nbsp;<span class="ident" id="1687927">cas</span><span class="op" id="1687930">.</span><span class="ident" id="1687931">elem</span><span class="op" id="1687935">,</span>&nbsp;<span class="ident" id="1687937">cas</span><span class="op" id="1687940">.</span><span class="ident" id="1687941">pc</span><span class="op" id="1687943">,</span>&nbsp;<span class="ident" id="1687945">chansendpc</span><span class="op" id="1687955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1687958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1687961">memmove</span><span class="op" id="1687968">(</span><span class="ident" id="1687969">chanbuf</span><span class="op" id="1687976">(</span><span class="ident" id="1687977">c</span><span class="op" id="1687978">,</span>&nbsp;<span class="ident" id="1687980">c</span><span class="op" id="1687981">.</span><span class="ident" id="1687982">sendx</span><span class="op" id="1687987">)</span><span class="op" id="1687988">,</span>&nbsp;<span class="ident" id="1687990">cas</span><span class="op" id="1687993">.</span><span class="ident" id="1687994">elem</span><span class="op" id="1687998">,</span>&nbsp;<span class="builtintype" id="1688000">uintptr</span><span class="op" id="1688007">(</span><span class="ident" id="1688008">c</span><span class="op" id="1688009">.</span><span class="ident" id="1688010">elemsize</span><span class="op" id="1688018">)</span><span class="op" id="1688019">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688022">c</span><span class="op" id="1688023">.</span><span class="ident" id="1688024">sendx</span><span class="op" id="1688029">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688033">if</span>&nbsp;<span class="ident" id="1688036">c</span><span class="op" id="1688037">.</span><span class="ident" id="1688038">sendx</span>&nbsp;<span class="op" id="1688044">==</span>&nbsp;<span class="ident" id="1688047">c</span><span class="op" id="1688048">.</span><span class="ident" id="1688049">dataqsiz</span>&nbsp;<span class="op" id="1688058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688062">c</span><span class="op" id="1688063">.</span><span class="ident" id="1688064">sendx</span>&nbsp;<span class="op" id="1688070">=</span>&nbsp;<span class="num" id="1688072">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688078">c</span><span class="op" id="1688079">.</span><span class="ident" id="1688080">qcount</span><span class="op" id="1688086">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688090">sg</span>&nbsp;<span class="op" id="1688093">=</span>&nbsp;<span class="ident" id="1688095">c</span><span class="op" id="1688096">.</span><span class="ident" id="1688097">recvq</span><span class="op" id="1688102">.</span><span class="ident" id="1688103">dequeue</span><span class="op" id="1688110">(</span><span class="op" id="1688111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688114">if</span>&nbsp;<span class="ident" id="1688117">sg</span>&nbsp;<span class="op" id="1688120">!=</span>&nbsp;<span class="ident" id="1688123">nil</span>&nbsp;<span class="op" id="1688127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688131">gp</span>&nbsp;<span class="op" id="1688134">=</span>&nbsp;<span class="ident" id="1688136">sg</span><span class="op" id="1688138">.</span><span class="ident" id="1688139">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688143">selunlock</span><span class="op" id="1688152">(</span><span class="ident" id="1688153">sel</span><span class="op" id="1688156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688160">if</span>&nbsp;<span class="ident" id="1688163">sg</span><span class="op" id="1688165">.</span><span class="ident" id="1688166">releasetime</span>&nbsp;<span class="op" id="1688178">!=</span>&nbsp;<span class="num" id="1688181">0</span>&nbsp;<span class="op" id="1688183">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688188">sg</span><span class="op" id="1688190">.</span><span class="ident" id="1688191">releasetime</span>&nbsp;<span class="op" id="1688203">=</span>&nbsp;<span class="ident" id="1688205">cputicks</span><span class="op" id="1688213">(</span><span class="op" id="1688214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688222">goready</span><span class="op" id="1688229">(</span><span class="ident" id="1688230">gp</span><span class="op" id="1688232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688235">}</span>&nbsp;<span class="keyword" id="1688237">else</span>&nbsp;<span class="op" id="1688242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688246">selunlock</span><span class="op" id="1688255">(</span><span class="ident" id="1688256">sel</span><span class="op" id="1688259">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688265">goto</span>&nbsp;<span class="ident" id="1688270">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1688276">syncrecv</span><span class="op" id="1688284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688287">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688329">if</span>&nbsp;<span class="ident" id="1688332">raceenabled</span>&nbsp;<span class="op" id="1688344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688348">if</span>&nbsp;<span class="ident" id="1688351">cas</span><span class="op" id="1688354">.</span><span class="ident" id="1688355">elem</span>&nbsp;<span class="op" id="1688360">!=</span>&nbsp;<span class="ident" id="1688363">nil</span>&nbsp;<span class="op" id="1688367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688372">raceWriteObjectPC</span><span class="op" id="1688389">(</span><span class="ident" id="1688390">c</span><span class="op" id="1688391">.</span><span class="ident" id="1688392">elemtype</span><span class="op" id="1688400">,</span>&nbsp;<span class="ident" id="1688402">cas</span><span class="op" id="1688405">.</span><span class="ident" id="1688406">elem</span><span class="op" id="1688410">,</span>&nbsp;<span class="ident" id="1688412">cas</span><span class="op" id="1688415">.</span><span class="ident" id="1688416">pc</span><span class="op" id="1688418">,</span>&nbsp;<span class="ident" id="1688420">chanrecvpc</span><span class="op" id="1688430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688438">racesync</span><span class="op" id="1688446">(</span><span class="ident" id="1688447">c</span><span class="op" id="1688448">,</span>&nbsp;<span class="ident" id="1688450">sg</span><span class="op" id="1688452">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688458">selunlock</span><span class="op" id="1688467">(</span><span class="ident" id="1688468">sel</span><span class="op" id="1688471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688474">if</span>&nbsp;<span class="ident" id="1688477">debugSelect</span>&nbsp;<span class="op" id="1688489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1688493">print</span><span class="op" id="1688498">(</span><span class="string" id="1688499">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1688515">,</span>&nbsp;<span class="ident" id="1688517">sel</span><span class="op" id="1688520">,</span>&nbsp;<span class="string" id="1688522">&#34;&nbsp;c=&#34;</span><span class="op" id="1688527">,</span>&nbsp;<span class="ident" id="1688529">c</span><span class="op" id="1688530">,</span>&nbsp;<span class="string" id="1688532">&#34;\n&#34;</span><span class="op" id="1688536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688539">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688542">if</span>&nbsp;<span class="ident" id="1688545">cas</span><span class="op" id="1688548">.</span><span class="ident" id="1688549">receivedp</span>&nbsp;<span class="op" id="1688559">!=</span>&nbsp;<span class="ident" id="1688562">nil</span>&nbsp;<span class="op" id="1688566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688570">*</span><span class="ident" id="1688571">cas</span><span class="op" id="1688574">.</span><span class="ident" id="1688575">receivedp</span>&nbsp;<span class="op" id="1688585">=</span>&nbsp;<span class="builtintype" id="1688587">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688596">if</span>&nbsp;<span class="ident" id="1688599">cas</span><span class="op" id="1688602">.</span><span class="ident" id="1688603">elem</span>&nbsp;<span class="op" id="1688608">!=</span>&nbsp;<span class="ident" id="1688611">nil</span>&nbsp;<span class="op" id="1688615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688619">memmove</span><span class="op" id="1688626">(</span><span class="ident" id="1688627">cas</span><span class="op" id="1688630">.</span><span class="ident" id="1688631">elem</span><span class="op" id="1688635">,</span>&nbsp;<span class="ident" id="1688637">sg</span><span class="op" id="1688639">.</span><span class="ident" id="1688640">elem</span><span class="op" id="1688644">,</span>&nbsp;<span class="builtintype" id="1688646">uintptr</span><span class="op" id="1688653">(</span><span class="ident" id="1688654">c</span><span class="op" id="1688655">.</span><span class="ident" id="1688656">elemsize</span><span class="op" id="1688664">)</span><span class="op" id="1688665">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688671">sg</span><span class="op" id="1688673">.</span><span class="ident" id="1688674">elem</span>&nbsp;<span class="op" id="1688679">=</span>&nbsp;<span class="ident" id="1688681">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688686">gp</span>&nbsp;<span class="op" id="1688689">=</span>&nbsp;<span class="ident" id="1688691">sg</span><span class="op" id="1688693">.</span><span class="ident" id="1688694">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688697">gp</span><span class="op" id="1688699">.</span><span class="ident" id="1688700">param</span>&nbsp;<span class="op" id="1688706">=</span>&nbsp;<span class="ident" id="1688708">unsafe</span><span class="op" id="1688714">.</span><span class="ident" id="1688715">Pointer</span><span class="op" id="1688722">(</span><span class="ident" id="1688723">sg</span><span class="op" id="1688725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688728">if</span>&nbsp;<span class="ident" id="1688731">sg</span><span class="op" id="1688733">.</span><span class="ident" id="1688734">releasetime</span>&nbsp;<span class="op" id="1688746">!=</span>&nbsp;<span class="num" id="1688749">0</span>&nbsp;<span class="op" id="1688751">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688755">sg</span><span class="op" id="1688757">.</span><span class="ident" id="1688758">releasetime</span>&nbsp;<span class="op" id="1688770">=</span>&nbsp;<span class="ident" id="1688772">cputicks</span><span class="op" id="1688780">(</span><span class="op" id="1688781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688787">goready</span><span class="op" id="1688794">(</span><span class="ident" id="1688795">gp</span><span class="op" id="1688797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688800">goto</span>&nbsp;<span class="ident" id="1688805">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1688811">rclose</span><span class="op" id="1688817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1688820">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688854">selunlock</span><span class="op" id="1688863">(</span><span class="ident" id="1688864">sel</span><span class="op" id="1688867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688870">if</span>&nbsp;<span class="ident" id="1688873">cas</span><span class="op" id="1688876">.</span><span class="ident" id="1688877">receivedp</span>&nbsp;<span class="op" id="1688887">!=</span>&nbsp;<span class="ident" id="1688890">nil</span>&nbsp;<span class="op" id="1688894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688898">*</span><span class="ident" id="1688899">cas</span><span class="op" id="1688902">.</span><span class="ident" id="1688903">receivedp</span>&nbsp;<span class="op" id="1688913">=</span>&nbsp;<span class="builtintype" id="1688915">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688925">if</span>&nbsp;<span class="ident" id="1688928">cas</span><span class="op" id="1688931">.</span><span class="ident" id="1688932">elem</span>&nbsp;<span class="op" id="1688937">!=</span>&nbsp;<span class="ident" id="1688940">nil</span>&nbsp;<span class="op" id="1688944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1688948">memclr</span><span class="op" id="1688954">(</span><span class="ident" id="1688955">cas</span><span class="op" id="1688958">.</span><span class="ident" id="1688959">elem</span><span class="op" id="1688963">,</span>&nbsp;<span class="builtintype" id="1688965">uintptr</span><span class="op" id="1688972">(</span><span class="ident" id="1688973">c</span><span class="op" id="1688974">.</span><span class="ident" id="1688975">elemsize</span><span class="op" id="1688983">)</span><span class="op" id="1688984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1688987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1688990">if</span>&nbsp;<span class="ident" id="1688993">raceenabled</span>&nbsp;<span class="op" id="1689005">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689009">raceacquire</span><span class="op" id="1689020">(</span><span class="ident" id="1689021">unsafe</span><span class="op" id="1689027">.</span><span class="ident" id="1689028">Pointer</span><span class="op" id="1689035">(</span><span class="ident" id="1689036">c</span><span class="op" id="1689037">)</span><span class="op" id="1689038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689044">goto</span>&nbsp;<span class="ident" id="1689049">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1689055">syncsend</span><span class="op" id="1689063">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689066">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689105">if</span>&nbsp;<span class="ident" id="1689108">raceenabled</span>&nbsp;<span class="op" id="1689120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689124">raceReadObjectPC</span><span class="op" id="1689140">(</span><span class="ident" id="1689141">c</span><span class="op" id="1689142">.</span><span class="ident" id="1689143">elemtype</span><span class="op" id="1689151">,</span>&nbsp;<span class="ident" id="1689153">cas</span><span class="op" id="1689156">.</span><span class="ident" id="1689157">elem</span><span class="op" id="1689161">,</span>&nbsp;<span class="ident" id="1689163">cas</span><span class="op" id="1689166">.</span><span class="ident" id="1689167">pc</span><span class="op" id="1689169">,</span>&nbsp;<span class="ident" id="1689171">chansendpc</span><span class="op" id="1689181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689185">racesync</span><span class="op" id="1689193">(</span><span class="ident" id="1689194">c</span><span class="op" id="1689195">,</span>&nbsp;<span class="ident" id="1689197">sg</span><span class="op" id="1689199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689202">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689205">selunlock</span><span class="op" id="1689214">(</span><span class="ident" id="1689215">sel</span><span class="op" id="1689218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689221">if</span>&nbsp;<span class="ident" id="1689224">debugSelect</span>&nbsp;<span class="op" id="1689236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1689240">print</span><span class="op" id="1689245">(</span><span class="string" id="1689246">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1689262">,</span>&nbsp;<span class="ident" id="1689264">sel</span><span class="op" id="1689267">,</span>&nbsp;<span class="string" id="1689269">&#34;&nbsp;c=&#34;</span><span class="op" id="1689274">,</span>&nbsp;<span class="ident" id="1689276">c</span><span class="op" id="1689277">,</span>&nbsp;<span class="string" id="1689279">&#34;\n&#34;</span><span class="op" id="1689283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689289">if</span>&nbsp;<span class="ident" id="1689292">sg</span><span class="op" id="1689294">.</span><span class="ident" id="1689295">elem</span>&nbsp;<span class="op" id="1689300">!=</span>&nbsp;<span class="ident" id="1689303">nil</span>&nbsp;<span class="op" id="1689307">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689311">memmove</span><span class="op" id="1689318">(</span><span class="ident" id="1689319">sg</span><span class="op" id="1689321">.</span><span class="ident" id="1689322">elem</span><span class="op" id="1689326">,</span>&nbsp;<span class="ident" id="1689328">cas</span><span class="op" id="1689331">.</span><span class="ident" id="1689332">elem</span><span class="op" id="1689336">,</span>&nbsp;<span class="builtintype" id="1689338">uintptr</span><span class="op" id="1689345">(</span><span class="ident" id="1689346">c</span><span class="op" id="1689347">.</span><span class="ident" id="1689348">elemsize</span><span class="op" id="1689356">)</span><span class="op" id="1689357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689363">sg</span><span class="op" id="1689365">.</span><span class="ident" id="1689366">elem</span>&nbsp;<span class="op" id="1689371">=</span>&nbsp;<span class="ident" id="1689373">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689378">gp</span>&nbsp;<span class="op" id="1689381">=</span>&nbsp;<span class="ident" id="1689383">sg</span><span class="op" id="1689385">.</span><span class="ident" id="1689386">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689389">gp</span><span class="op" id="1689391">.</span><span class="ident" id="1689392">param</span>&nbsp;<span class="op" id="1689398">=</span>&nbsp;<span class="ident" id="1689400">unsafe</span><span class="op" id="1689406">.</span><span class="ident" id="1689407">Pointer</span><span class="op" id="1689414">(</span><span class="ident" id="1689415">sg</span><span class="op" id="1689417">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689420">if</span>&nbsp;<span class="ident" id="1689423">sg</span><span class="op" id="1689425">.</span><span class="ident" id="1689426">releasetime</span>&nbsp;<span class="op" id="1689438">!=</span>&nbsp;<span class="num" id="1689441">0</span>&nbsp;<span class="op" id="1689443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689447">sg</span><span class="op" id="1689449">.</span><span class="ident" id="1689450">releasetime</span>&nbsp;<span class="op" id="1689462">=</span>&nbsp;<span class="ident" id="1689464">cputicks</span><span class="op" id="1689472">(</span><span class="op" id="1689473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689479">goready</span><span class="op" id="1689486">(</span><span class="ident" id="1689487">gp</span><span class="op" id="1689489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1689492">retc</span><span class="op" id="1689496">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689499">if</span>&nbsp;<span class="ident" id="1689502">cas</span><span class="op" id="1689505">.</span><span class="ident" id="1689506">releasetime</span>&nbsp;<span class="op" id="1689518">&gt;</span>&nbsp;<span class="num" id="1689520">0</span>&nbsp;<span class="op" id="1689522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689526">blockevent</span><span class="op" id="1689536">(</span><span class="ident" id="1689537">cas</span><span class="op" id="1689540">.</span><span class="ident" id="1689541">releasetime</span><span class="op" id="1689552">-</span><span class="ident" id="1689553">t0</span><span class="op" id="1689555">,</span>&nbsp;<span class="num" id="1689557">2</span><span class="op" id="1689558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1689561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689564">return</span>&nbsp;<span class="ident" id="1689571">cas</span><span class="op" id="1689574">.</span><span class="ident" id="1689575">pc</span><span class="op" id="1689577">,</span>&nbsp;<span class="ident" id="1689579">cas</span><span class="op" id="1689582">.</span><span class="ident" id="1689583">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1689587">sclose</span><span class="op" id="1689593">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689596">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689623">selunlock</span><span class="op" id="1689632">(</span><span class="ident" id="1689633">sel</span><span class="op" id="1689636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1689639">panic</span><span class="op" id="1689644">(</span><span class="string" id="1689645">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1689669">)</span><br>
<span class="lineno">575</span><span class="op" id="1689671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1689674">func</span>&nbsp;<span class="op" id="1689679">(</span><span class="ident" id="1689680">c</span>&nbsp;<span class="op" id="1689682">*</span><span class="ident" id="1689683">hchan</span><span class="op" id="1689688">)</span>&nbsp;<span class="ident" id="1689690">sortkey</span><span class="op" id="1689697">(</span><span class="op" id="1689698">)</span>&nbsp;<span class="builtintype" id="1689700">uintptr</span>&nbsp;<span class="op" id="1689708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689711">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1689779">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1689805">return</span>&nbsp;<span class="builtintype" id="1689812">uintptr</span><span class="op" id="1689819">(</span><span class="ident" id="1689820">unsafe</span><span class="op" id="1689826">.</span><span class="ident" id="1689827">Pointer</span><span class="op" id="1689834">(</span><span class="ident" id="1689835">c</span><span class="op" id="1689836">)</span><span class="op" id="1689837">)</span><br>
<span class="lineno"></span><span class="op" id="1689839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1689842">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1689897">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1689951">type</span>&nbsp;<span class="ident" id="1689956">runtimeSelect</span>&nbsp;<span class="keyword" id="1689970">struct</span>&nbsp;<span class="op" id="1689977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689980">dir</span>&nbsp;<span class="ident" id="1689984">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1689995">typ</span>&nbsp;<span class="ident" id="1689999">unsafe</span><span class="op" id="1690005">.</span><span class="ident" id="1690006">Pointer</span>&nbsp;<span class="comment" id="1690014">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690047">ch</span>&nbsp;&nbsp;<span class="op" id="1690051">*</span><span class="ident" id="1690052">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690066">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690078">val</span>&nbsp;<span class="ident" id="1690082">unsafe</span><span class="op" id="1690088">.</span><span class="ident" id="1690089">Pointer</span>&nbsp;<span class="comment" id="1690097">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1690157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1690160">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1690219">type</span>&nbsp;<span class="ident" id="1690224">selectDir</span>&nbsp;<span class="builtintype" id="1690234">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1690239">const</span>&nbsp;<span class="op" id="1690245">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690248">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1690262">selectDir</span>&nbsp;<span class="op" id="1690272">=</span>&nbsp;<span class="ident" id="1690274">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690280">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690304">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690326">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690350">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690367">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690391">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1690402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1690405">func</span>&nbsp;<span class="ident" id="1690410">reflect_rselect</span><span class="op" id="1690425">(</span><span class="ident" id="1690426">cases</span>&nbsp;<span class="op" id="1690432">[</span><span class="op" id="1690433">]</span><span class="ident" id="1690434">runtimeSelect</span><span class="op" id="1690447">)</span>&nbsp;<span class="op" id="1690449">(</span><span class="ident" id="1690450">chosen</span>&nbsp;<span class="builtintype" id="1690457">int</span><span class="op" id="1690460">,</span>&nbsp;<span class="ident" id="1690462">recvOK</span>&nbsp;<span class="builtintype" id="1690469">bool</span><span class="op" id="1690473">)</span>&nbsp;<span class="op" id="1690475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1690478">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690559">size</span>&nbsp;<span class="op" id="1690564">:=</span>&nbsp;<span class="ident" id="1690567">selectsize</span><span class="op" id="1690577">(</span><span class="builtintype" id="1690578">uintptr</span><span class="op" id="1690585">(</span><span class="builtinfunc" id="1690586">len</span><span class="op" id="1690589">(</span><span class="ident" id="1690590">cases</span><span class="op" id="1690595">)</span><span class="op" id="1690596">)</span><span class="op" id="1690597">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690600">sel</span>&nbsp;<span class="op" id="1690604">:=</span>&nbsp;<span class="op" id="1690607">(</span><span class="op" id="1690608">*</span><span class="ident" id="1690609">_select</span><span class="op" id="1690616">)</span><span class="op" id="1690617">(</span><span class="ident" id="1690618">mallocgc</span><span class="op" id="1690626">(</span><span class="ident" id="1690627">size</span><span class="op" id="1690631">,</span>&nbsp;<span class="ident" id="1690633">nil</span><span class="op" id="1690636">,</span>&nbsp;<span class="ident" id="1690638">flagNoScan</span><span class="op" id="1690648">)</span><span class="op" id="1690649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690652">newselect</span><span class="op" id="1690661">(</span><span class="ident" id="1690662">sel</span><span class="op" id="1690665">,</span>&nbsp;<span class="ident" id="1690667">int64</span><span class="op" id="1690672">(</span><span class="ident" id="1690673">size</span><span class="op" id="1690677">)</span><span class="op" id="1690678">,</span>&nbsp;<span class="builtintype" id="1690680">int32</span><span class="op" id="1690685">(</span><span class="builtinfunc" id="1690686">len</span><span class="op" id="1690689">(</span><span class="ident" id="1690690">cases</span><span class="op" id="1690695">)</span><span class="op" id="1690696">)</span><span class="op" id="1690697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690700">r</span>&nbsp;<span class="op" id="1690702">:=</span>&nbsp;<span class="builtinfunc" id="1690705">new</span><span class="op" id="1690708">(</span><span class="builtintype" id="1690709">bool</span><span class="op" id="1690713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690716">for</span>&nbsp;<span class="ident" id="1690720">i</span>&nbsp;<span class="op" id="1690722">:=</span>&nbsp;<span class="keyword" id="1690725">range</span>&nbsp;<span class="ident" id="1690731">cases</span>&nbsp;<span class="op" id="1690737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690741">rc</span>&nbsp;<span class="op" id="1690744">:=</span>&nbsp;<span class="op" id="1690747">&amp;</span><span class="ident" id="1690748">cases</span><span class="op" id="1690753">[</span><span class="ident" id="1690754">i</span><span class="op" id="1690755">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690759">switch</span>&nbsp;<span class="ident" id="1690766">rc</span><span class="op" id="1690768">.</span><span class="ident" id="1690769">dir</span>&nbsp;<span class="op" id="1690773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690777">case</span>&nbsp;<span class="ident" id="1690782">selectDefault</span><span class="op" id="1690795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690800">selectdefaultImpl</span><span class="op" id="1690817">(</span><span class="ident" id="1690818">sel</span><span class="op" id="1690821">,</span>&nbsp;<span class="builtintype" id="1690823">uintptr</span><span class="op" id="1690830">(</span><span class="ident" id="1690831">i</span><span class="op" id="1690832">)</span><span class="op" id="1690833">,</span>&nbsp;<span class="num" id="1690835">0</span><span class="op" id="1690836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690840">case</span>&nbsp;<span class="ident" id="1690845">selectSend</span><span class="op" id="1690855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690860">if</span>&nbsp;<span class="ident" id="1690863">rc</span><span class="op" id="1690865">.</span><span class="ident" id="1690866">ch</span>&nbsp;<span class="op" id="1690869">==</span>&nbsp;<span class="ident" id="1690872">nil</span>&nbsp;<span class="op" id="1690876">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690882">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1690896">selectsendImpl</span><span class="op" id="1690910">(</span><span class="ident" id="1690911">sel</span><span class="op" id="1690914">,</span>&nbsp;<span class="ident" id="1690916">rc</span><span class="op" id="1690918">.</span><span class="ident" id="1690919">ch</span><span class="op" id="1690921">,</span>&nbsp;<span class="builtintype" id="1690923">uintptr</span><span class="op" id="1690930">(</span><span class="ident" id="1690931">i</span><span class="op" id="1690932">)</span><span class="op" id="1690933">,</span>&nbsp;<span class="ident" id="1690935">rc</span><span class="op" id="1690937">.</span><span class="ident" id="1690938">val</span><span class="op" id="1690941">,</span>&nbsp;<span class="num" id="1690943">0</span><span class="op" id="1690944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690948">case</span>&nbsp;<span class="ident" id="1690953">selectRecv</span><span class="op" id="1690963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690968">if</span>&nbsp;<span class="ident" id="1690971">rc</span><span class="op" id="1690973">.</span><span class="ident" id="1690974">ch</span>&nbsp;<span class="op" id="1690977">==</span>&nbsp;<span class="ident" id="1690980">nil</span>&nbsp;<span class="op" id="1690984">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1690990">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1690999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691004">selectrecvImpl</span><span class="op" id="1691018">(</span><span class="ident" id="1691019">sel</span><span class="op" id="1691022">,</span>&nbsp;<span class="ident" id="1691024">rc</span><span class="op" id="1691026">.</span><span class="ident" id="1691027">ch</span><span class="op" id="1691029">,</span>&nbsp;<span class="builtintype" id="1691031">uintptr</span><span class="op" id="1691038">(</span><span class="ident" id="1691039">i</span><span class="op" id="1691040">)</span><span class="op" id="1691041">,</span>&nbsp;<span class="ident" id="1691043">rc</span><span class="op" id="1691045">.</span><span class="ident" id="1691046">val</span><span class="op" id="1691049">,</span>&nbsp;<span class="ident" id="1691051">r</span><span class="op" id="1691052">,</span>&nbsp;<span class="num" id="1691054">0</span><span class="op" id="1691055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691062">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691066">pc</span><span class="op" id="1691068">,</span>&nbsp;<span class="ident" id="1691070">_</span>&nbsp;<span class="op" id="1691072">:=</span>&nbsp;<span class="ident" id="1691075">selectgoImpl</span><span class="op" id="1691087">(</span><span class="ident" id="1691088">sel</span><span class="op" id="1691091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691094">chosen</span>&nbsp;<span class="op" id="1691101">=</span>&nbsp;<span class="builtintype" id="1691103">int</span><span class="op" id="1691106">(</span><span class="ident" id="1691107">pc</span><span class="op" id="1691109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691112">recvOK</span>&nbsp;<span class="op" id="1691119">=</span>&nbsp;<span class="op" id="1691121">*</span><span class="ident" id="1691122">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691125">return</span><br>
<span class="lineno">630</span><span class="op" id="1691132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1691135">func</span>&nbsp;<span class="op" id="1691140">(</span><span class="ident" id="1691141">q</span>&nbsp;<span class="op" id="1691143">*</span><span class="ident" id="1691144">waitq</span><span class="op" id="1691149">)</span>&nbsp;<span class="ident" id="1691151">dequeueSudoG</span><span class="op" id="1691163">(</span><span class="ident" id="1691164">s</span>&nbsp;<span class="op" id="1691166">*</span><span class="ident" id="1691167">sudog</span><span class="op" id="1691172">)</span>&nbsp;<span class="op" id="1691174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691177">var</span>&nbsp;<span class="ident" id="1691181">prevsgp</span>&nbsp;<span class="op" id="1691189">*</span><span class="ident" id="1691190">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691197">l</span>&nbsp;<span class="op" id="1691199">:=</span>&nbsp;<span class="op" id="1691202">&amp;</span><span class="ident" id="1691203">q</span><span class="op" id="1691204">.</span><span class="ident" id="1691205">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691212">for</span>&nbsp;<span class="op" id="1691216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691220">sgp</span>&nbsp;<span class="op" id="1691224">:=</span>&nbsp;<span class="op" id="1691227">*</span><span class="ident" id="1691228">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691232">if</span>&nbsp;<span class="ident" id="1691235">sgp</span>&nbsp;<span class="op" id="1691239">==</span>&nbsp;<span class="ident" id="1691242">nil</span>&nbsp;<span class="op" id="1691246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691251">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691260">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691264">if</span>&nbsp;<span class="ident" id="1691267">sgp</span>&nbsp;<span class="op" id="1691271">==</span>&nbsp;<span class="ident" id="1691274">s</span>&nbsp;<span class="op" id="1691276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691281">*</span><span class="ident" id="1691282">l</span>&nbsp;<span class="op" id="1691284">=</span>&nbsp;<span class="ident" id="1691286">sgp</span><span class="op" id="1691289">.</span><span class="ident" id="1691290">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691298">if</span>&nbsp;<span class="ident" id="1691301">q</span><span class="op" id="1691302">.</span><span class="ident" id="1691303">last</span>&nbsp;<span class="op" id="1691308">==</span>&nbsp;<span class="ident" id="1691311">sgp</span>&nbsp;<span class="op" id="1691315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691321">q</span><span class="op" id="1691322">.</span><span class="ident" id="1691323">last</span>&nbsp;<span class="op" id="1691328">=</span>&nbsp;<span class="ident" id="1691330">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691341">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691346">s</span><span class="op" id="1691347">.</span><span class="ident" id="1691348">next</span>&nbsp;<span class="op" id="1691353">=</span>&nbsp;<span class="ident" id="1691355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1691362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691375">l</span>&nbsp;<span class="op" id="1691377">=</span>&nbsp;<span class="op" id="1691379">&amp;</span><span class="ident" id="1691380">sgp</span><span class="op" id="1691383">.</span><span class="ident" id="1691384">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1691391">prevsgp</span>&nbsp;<span class="op" id="1691399">=</span>&nbsp;<span class="ident" id="1691401">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1691406">}</span><br>
<span class="lineno"></span><span class="op" id="1691408">}</span>
</div>
</body>
</html>
