<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html" class="current">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1371972">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1372027">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1372081">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1372132">package</span>&nbsp;<span class="ident" id="1372140">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1372146">import</span>&nbsp;<span class="op" id="1372153">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1372156">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1372171">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1372180">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1372183">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1372246">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1372299">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1372355">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1372412">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1372477">type</span>&nbsp;<span class="ident" id="1372482">WaitGroup</span>&nbsp;<span class="keyword" id="1372492">struct</span>&nbsp;<span class="op" id="1372499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1372502">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1372510">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1372517">counter</span>&nbsp;<span class="builtintype" id="1372525">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1372532">waiters</span>&nbsp;<span class="builtintype" id="1372540">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1372547">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1372555">*</span><span class="builtintype" id="1372556">uint32</span><br>
<span class="lineno"></span><span class="op" id="1372563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1372566">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1372631">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1372684">//</span><br>
<span class="lineno"></span><span class="comment" id="1372687">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1372701">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1372716">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1372788">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1372869">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1372935">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1372986">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1373001">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1373076">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1373144">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1373221">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1373266">//</span><br>
<span class="lineno">40</span><span class="comment" id="1373269">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1373346">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1373421">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1373500">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1373516">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1373593">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1373652">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1373682">func</span>&nbsp;<span class="op" id="1373687">(</span><span class="ident" id="1373688">wg</span>&nbsp;<span class="op" id="1373691">*</span><span class="ident" id="1373692">WaitGroup</span><span class="op" id="1373701">)</span>&nbsp;<span class="ident" id="1373703">Add</span><span class="op" id="1373706">(</span><span class="ident" id="1373707">delta</span>&nbsp;<span class="builtintype" id="1373713">int</span><span class="op" id="1373716">)</span>&nbsp;<span class="op" id="1373718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1373721">if</span>&nbsp;<span class="ident" id="1373724">raceenabled</span>&nbsp;<span class="op" id="1373736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1373740">_</span>&nbsp;<span class="op" id="1373742">=</span>&nbsp;<span class="ident" id="1373744">wg</span><span class="op" id="1373746">.</span><span class="ident" id="1373747">m</span><span class="op" id="1373748">.</span><span class="ident" id="1373749">state</span>&nbsp;<span class="comment" id="1373755">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1373784">if</span>&nbsp;<span class="ident" id="1373787">delta</span>&nbsp;<span class="op" id="1373793">&lt;</span>&nbsp;<span class="num" id="1373795">0</span>&nbsp;<span class="op" id="1373797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1373802">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1373842">raceReleaseMerge</span><span class="op" id="1373858">(</span><span class="ident" id="1373859">unsafe</span><span class="op" id="1373865">.</span><span class="ident" id="1373866">Pointer</span><span class="op" id="1373873">(</span><span class="ident" id="1373874">wg</span><span class="op" id="1373876">)</span><span class="op" id="1373877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1373881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1373885">raceDisable</span><span class="op" id="1373896">(</span><span class="op" id="1373897">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1373901">defer</span>&nbsp;<span class="ident" id="1373907">raceEnable</span><span class="op" id="1373917">(</span><span class="op" id="1373918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1373921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1373924">v</span>&nbsp;<span class="op" id="1373926">:=</span>&nbsp;<span class="ident" id="1373929">atomic</span><span class="op" id="1373935">.</span><span class="ident" id="1373936">AddInt32</span><span class="op" id="1373944">(</span><span class="op" id="1373945">&amp;</span><span class="ident" id="1373946">wg</span><span class="op" id="1373948">.</span><span class="ident" id="1373949">counter</span><span class="op" id="1373956">,</span>&nbsp;<span class="builtintype" id="1373958">int32</span><span class="op" id="1373963">(</span><span class="ident" id="1373964">delta</span><span class="op" id="1373969">)</span><span class="op" id="1373970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1373973">if</span>&nbsp;<span class="ident" id="1373976">raceenabled</span>&nbsp;<span class="op" id="1373988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1373992">if</span>&nbsp;<span class="ident" id="1373995">delta</span>&nbsp;<span class="op" id="1374001">&gt;</span>&nbsp;<span class="num" id="1374003">0</span>&nbsp;<span class="op" id="1374005">&amp;&amp;</span>&nbsp;<span class="ident" id="1374008">v</span>&nbsp;<span class="op" id="1374010">==</span>&nbsp;<span class="builtintype" id="1374013">int32</span><span class="op" id="1374018">(</span><span class="ident" id="1374019">delta</span><span class="op" id="1374024">)</span>&nbsp;<span class="op" id="1374026">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1374031">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1374089">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1374146">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374202">raceRead</span><span class="op" id="1374210">(</span><span class="ident" id="1374211">unsafe</span><span class="op" id="1374217">.</span><span class="ident" id="1374218">Pointer</span><span class="op" id="1374225">(</span><span class="op" id="1374226">&amp;</span><span class="ident" id="1374227">wg</span><span class="op" id="1374229">.</span><span class="ident" id="1374230">sema</span><span class="op" id="1374234">)</span><span class="op" id="1374235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374239">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374245">if</span>&nbsp;<span class="ident" id="1374248">v</span>&nbsp;<span class="op" id="1374250">&lt;</span>&nbsp;<span class="num" id="1374252">0</span>&nbsp;<span class="op" id="1374254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1374258">panic</span><span class="op" id="1374263">(</span><span class="string" id="1374264">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1374298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374304">if</span>&nbsp;<span class="ident" id="1374307">v</span>&nbsp;<span class="op" id="1374309">&gt;</span>&nbsp;<span class="num" id="1374311">0</span>&nbsp;<span class="op" id="1374313">||</span>&nbsp;<span class="ident" id="1374316">atomic</span><span class="op" id="1374322">.</span><span class="ident" id="1374323">LoadInt32</span><span class="op" id="1374332">(</span><span class="op" id="1374333">&amp;</span><span class="ident" id="1374334">wg</span><span class="op" id="1374336">.</span><span class="ident" id="1374337">waiters</span><span class="op" id="1374344">)</span>&nbsp;<span class="op" id="1374346">==</span>&nbsp;<span class="num" id="1374349">0</span>&nbsp;<span class="op" id="1374351">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374355">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374366">wg</span><span class="op" id="1374368">.</span><span class="ident" id="1374369">m</span><span class="op" id="1374370">.</span><span class="ident" id="1374371">Lock</span><span class="op" id="1374375">(</span><span class="op" id="1374376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374379">if</span>&nbsp;<span class="ident" id="1374382">atomic</span><span class="op" id="1374388">.</span><span class="ident" id="1374389">LoadInt32</span><span class="op" id="1374398">(</span><span class="op" id="1374399">&amp;</span><span class="ident" id="1374400">wg</span><span class="op" id="1374402">.</span><span class="ident" id="1374403">counter</span><span class="op" id="1374410">)</span>&nbsp;<span class="op" id="1374412">==</span>&nbsp;<span class="num" id="1374415">0</span>&nbsp;<span class="op" id="1374417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374421">for</span>&nbsp;<span class="ident" id="1374425">i</span>&nbsp;<span class="op" id="1374427">:=</span>&nbsp;<span class="builtintype" id="1374430">int32</span><span class="op" id="1374435">(</span><span class="num" id="1374436">0</span><span class="op" id="1374437">)</span><span class="op" id="1374438">;</span>&nbsp;<span class="ident" id="1374440">i</span>&nbsp;<span class="op" id="1374442">&lt;</span>&nbsp;<span class="ident" id="1374444">wg</span><span class="op" id="1374446">.</span><span class="ident" id="1374447">waiters</span><span class="op" id="1374454">;</span>&nbsp;<span class="ident" id="1374456">i</span><span class="op" id="1374457">++</span>&nbsp;<span class="op" id="1374460">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374465">runtime_Semrelease</span><span class="op" id="1374483">(</span><span class="ident" id="1374484">wg</span><span class="op" id="1374486">.</span><span class="ident" id="1374487">sema</span><span class="op" id="1374491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374499">wg</span><span class="op" id="1374501">.</span><span class="ident" id="1374502">waiters</span>&nbsp;<span class="op" id="1374510">=</span>&nbsp;<span class="num" id="1374512">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374516">wg</span><span class="op" id="1374518">.</span><span class="ident" id="1374519">sema</span>&nbsp;<span class="op" id="1374524">=</span>&nbsp;<span class="builtintype" id="1374526">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374531">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374534">wg</span><span class="op" id="1374536">.</span><span class="ident" id="1374537">m</span><span class="op" id="1374538">.</span><span class="ident" id="1374539">Unlock</span><span class="op" id="1374545">(</span><span class="op" id="1374546">)</span><br>
<span class="lineno"></span><span class="op" id="1374548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1374551">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1374593">func</span>&nbsp;<span class="op" id="1374598">(</span><span class="ident" id="1374599">wg</span>&nbsp;<span class="op" id="1374602">*</span><span class="ident" id="1374603">WaitGroup</span><span class="op" id="1374612">)</span>&nbsp;<span class="ident" id="1374614">Done</span><span class="op" id="1374618">(</span><span class="op" id="1374619">)</span>&nbsp;<span class="op" id="1374621">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374624">wg</span><span class="op" id="1374626">.</span><span class="ident" id="1374627">Add</span><span class="op" id="1374630">(</span><span class="op" id="1374631">-</span><span class="num" id="1374632">1</span><span class="op" id="1374633">)</span><br>
<span class="lineno"></span><span class="op" id="1374635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1374638">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1374690">func</span>&nbsp;<span class="op" id="1374695">(</span><span class="ident" id="1374696">wg</span>&nbsp;<span class="op" id="1374699">*</span><span class="ident" id="1374700">WaitGroup</span><span class="op" id="1374709">)</span>&nbsp;<span class="ident" id="1374711">Wait</span><span class="op" id="1374715">(</span><span class="op" id="1374716">)</span>&nbsp;<span class="op" id="1374718">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374721">if</span>&nbsp;<span class="ident" id="1374724">raceenabled</span>&nbsp;<span class="op" id="1374736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374740">_</span>&nbsp;<span class="op" id="1374742">=</span>&nbsp;<span class="ident" id="1374744">wg</span><span class="op" id="1374746">.</span><span class="ident" id="1374747">m</span><span class="op" id="1374748">.</span><span class="ident" id="1374749">state</span>&nbsp;<span class="comment" id="1374755">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374784">raceDisable</span><span class="op" id="1374795">(</span><span class="op" id="1374796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374802">if</span>&nbsp;<span class="ident" id="1374805">atomic</span><span class="op" id="1374811">.</span><span class="ident" id="1374812">LoadInt32</span><span class="op" id="1374821">(</span><span class="op" id="1374822">&amp;</span><span class="ident" id="1374823">wg</span><span class="op" id="1374825">.</span><span class="ident" id="1374826">counter</span><span class="op" id="1374833">)</span>&nbsp;<span class="op" id="1374835">==</span>&nbsp;<span class="num" id="1374838">0</span>&nbsp;<span class="op" id="1374840">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374844">if</span>&nbsp;<span class="ident" id="1374847">raceenabled</span>&nbsp;<span class="op" id="1374859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374864">raceEnable</span><span class="op" id="1374874">(</span><span class="op" id="1374875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374880">raceAcquire</span><span class="op" id="1374891">(</span><span class="ident" id="1374892">unsafe</span><span class="op" id="1374898">.</span><span class="ident" id="1374899">Pointer</span><span class="op" id="1374906">(</span><span class="ident" id="1374907">wg</span><span class="op" id="1374909">)</span><span class="op" id="1374910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1374918">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1374926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374929">wg</span><span class="op" id="1374931">.</span><span class="ident" id="1374932">m</span><span class="op" id="1374933">.</span><span class="ident" id="1374934">Lock</span><span class="op" id="1374938">(</span><span class="op" id="1374939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1374942">w</span>&nbsp;<span class="op" id="1374944">:=</span>&nbsp;<span class="ident" id="1374947">atomic</span><span class="op" id="1374953">.</span><span class="ident" id="1374954">AddInt32</span><span class="op" id="1374962">(</span><span class="op" id="1374963">&amp;</span><span class="ident" id="1374964">wg</span><span class="op" id="1374966">.</span><span class="ident" id="1374967">waiters</span><span class="op" id="1374974">,</span>&nbsp;<span class="num" id="1374976">1</span><span class="op" id="1374977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1374980">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375041">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375101">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375171">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375200">if</span>&nbsp;<span class="ident" id="1375203">atomic</span><span class="op" id="1375209">.</span><span class="ident" id="1375210">LoadInt32</span><span class="op" id="1375219">(</span><span class="op" id="1375220">&amp;</span><span class="ident" id="1375221">wg</span><span class="op" id="1375223">.</span><span class="ident" id="1375224">counter</span><span class="op" id="1375231">)</span>&nbsp;<span class="op" id="1375233">==</span>&nbsp;<span class="num" id="1375236">0</span>&nbsp;<span class="op" id="1375238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375242">atomic</span><span class="op" id="1375248">.</span><span class="ident" id="1375249">AddInt32</span><span class="op" id="1375257">(</span><span class="op" id="1375258">&amp;</span><span class="ident" id="1375259">wg</span><span class="op" id="1375261">.</span><span class="ident" id="1375262">waiters</span><span class="op" id="1375269">,</span>&nbsp;<span class="op" id="1375271">-</span><span class="num" id="1375272">1</span><span class="op" id="1375273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375277">if</span>&nbsp;<span class="ident" id="1375280">raceenabled</span>&nbsp;<span class="op" id="1375292">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375297">raceEnable</span><span class="op" id="1375307">(</span><span class="op" id="1375308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375313">raceAcquire</span><span class="op" id="1375324">(</span><span class="ident" id="1375325">unsafe</span><span class="op" id="1375331">.</span><span class="ident" id="1375332">Pointer</span><span class="op" id="1375339">(</span><span class="ident" id="1375340">wg</span><span class="op" id="1375342">)</span><span class="op" id="1375343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375348">raceDisable</span><span class="op" id="1375359">(</span><span class="op" id="1375360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375368">wg</span><span class="op" id="1375370">.</span><span class="ident" id="1375371">m</span><span class="op" id="1375372">.</span><span class="ident" id="1375373">Unlock</span><span class="op" id="1375379">(</span><span class="op" id="1375380">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375384">if</span>&nbsp;<span class="ident" id="1375387">raceenabled</span>&nbsp;<span class="op" id="1375399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375404">raceEnable</span><span class="op" id="1375414">(</span><span class="op" id="1375415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375423">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375431">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375434">if</span>&nbsp;<span class="ident" id="1375437">raceenabled</span>&nbsp;<span class="op" id="1375449">&amp;&amp;</span>&nbsp;<span class="ident" id="1375452">w</span>&nbsp;<span class="op" id="1375454">==</span>&nbsp;<span class="num" id="1375457">1</span>&nbsp;<span class="op" id="1375459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375463">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375514">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375582">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1375649">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375708">raceWrite</span><span class="op" id="1375717">(</span><span class="ident" id="1375718">unsafe</span><span class="op" id="1375724">.</span><span class="ident" id="1375725">Pointer</span><span class="op" id="1375732">(</span><span class="op" id="1375733">&amp;</span><span class="ident" id="1375734">wg</span><span class="op" id="1375736">.</span><span class="ident" id="1375737">sema</span><span class="op" id="1375741">)</span><span class="op" id="1375742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375748">if</span>&nbsp;<span class="ident" id="1375751">wg</span><span class="op" id="1375753">.</span><span class="ident" id="1375754">sema</span>&nbsp;<span class="op" id="1375759">==</span>&nbsp;<span class="builtintype" id="1375762">nil</span>&nbsp;<span class="op" id="1375766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375770">wg</span><span class="op" id="1375772">.</span><span class="ident" id="1375773">sema</span>&nbsp;<span class="op" id="1375778">=</span>&nbsp;<span class="builtinfunc" id="1375780">new</span><span class="op" id="1375783">(</span><span class="builtintype" id="1375784">uint32</span><span class="op" id="1375790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375793">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375796">s</span>&nbsp;<span class="op" id="1375798">:=</span>&nbsp;<span class="ident" id="1375801">wg</span><span class="op" id="1375803">.</span><span class="ident" id="1375804">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375810">wg</span><span class="op" id="1375812">.</span><span class="ident" id="1375813">m</span><span class="op" id="1375814">.</span><span class="ident" id="1375815">Unlock</span><span class="op" id="1375821">(</span><span class="op" id="1375822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375825">runtime_Semacquire</span><span class="op" id="1375843">(</span><span class="ident" id="1375844">s</span><span class="op" id="1375845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1375848">if</span>&nbsp;<span class="ident" id="1375851">raceenabled</span>&nbsp;<span class="op" id="1375863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375867">raceEnable</span><span class="op" id="1375877">(</span><span class="op" id="1375878">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1375882">raceAcquire</span><span class="op" id="1375893">(</span><span class="ident" id="1375894">unsafe</span><span class="op" id="1375900">.</span><span class="ident" id="1375901">Pointer</span><span class="op" id="1375908">(</span><span class="ident" id="1375909">wg</span><span class="op" id="1375911">)</span><span class="op" id="1375912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1375915">}</span><br>
<span class="lineno"></span><span class="op" id="1375917">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
