<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html" class="current">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7411725">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7411781">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7411835">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7411886">package</span>&nbsp;<span class="ident" id="7411894">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7411900">import</span>&nbsp;<span class="op" id="7411907">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411910">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411919">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411932">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411939">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411950">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7411961">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7411971">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="7411974">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="7412010">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="7412036">var</span>&nbsp;<span class="ident" id="7412040">streamTest</span>&nbsp;<span class="op" id="7412051">=</span>&nbsp;<span class="op" id="7412053">[</span><span class="op" id="7412054">]</span><span class="keyword" id="7412055">interface</span><span class="op" id="7412064">{</span><span class="op" id="7412065">}</span><span class="op" id="7412066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="7412069">0.1</span><span class="op" id="7412072">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7412075">&#34;hello&#34;</span><span class="op" id="7412082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412085">nil</span><span class="op" id="7412088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7412091">true</span><span class="op" id="7412095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7412098">false</span><span class="op" id="7412103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412106">[</span><span class="op" id="7412107">]</span><span class="keyword" id="7412108">interface</span><span class="op" id="7412117">{</span><span class="op" id="7412118">}</span><span class="op" id="7412119">{</span><span class="string" id="7412120">&#34;a&#34;</span><span class="op" id="7412123">,</span>&nbsp;<span class="string" id="7412125">&#34;b&#34;</span><span class="op" id="7412128">,</span>&nbsp;<span class="string" id="7412130">&#34;c&#34;</span><span class="op" id="7412133">}</span><span class="op" id="7412134">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412137">map</span><span class="op" id="7412140">[</span><span class="builtintype" id="7412141">string</span><span class="op" id="7412147">]</span><span class="keyword" id="7412148">interface</span><span class="op" id="7412157">{</span><span class="op" id="7412158">}</span><span class="op" id="7412159">{</span><span class="string" id="7412160">&#34;K&#34;</span><span class="op" id="7412165">:</span>&nbsp;<span class="string" id="7412167">&#34;Kelvin&#34;</span><span class="op" id="7412175">,</span>&nbsp;<span class="string" id="7412177">&#34;ß&#34;</span><span class="op" id="7412181">:</span>&nbsp;<span class="string" id="7412183">&#34;long&nbsp;s&#34;</span><span class="op" id="7412191">}</span><span class="op" id="7412192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="7412195">3.14</span><span class="op" id="7412199">,</span>&nbsp;<span class="comment" id="7412201">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="7412256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7412259">var</span>&nbsp;<span class="ident" id="7412263">streamEncoded</span>&nbsp;<span class="op" id="7412277">=</span>&nbsp;<span class="string" id="7412279">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7412361">func</span>&nbsp;<span class="ident" id="7412366">TestEncoder</span><span class="op" id="7412377">(</span><span class="ident" id="7412378">t</span>&nbsp;<span class="op" id="7412380">*</span><span class="ident" id="7412381">testing</span><span class="op" id="7412388">.</span><span class="ident" id="7412389">T</span><span class="op" id="7412390">)</span>&nbsp;<span class="op" id="7412392">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412395">for</span>&nbsp;<span class="ident" id="7412399">i</span>&nbsp;<span class="op" id="7412401">:=</span>&nbsp;<span class="num" id="7412404">0</span><span class="op" id="7412405">;</span>&nbsp;<span class="ident" id="7412407">i</span>&nbsp;<span class="op" id="7412409">&lt;=</span>&nbsp;<span class="builtinfunc" id="7412412">len</span><span class="op" id="7412415">(</span><span class="ident" id="7412416">streamTest</span><span class="op" id="7412426">)</span><span class="op" id="7412427">;</span>&nbsp;<span class="ident" id="7412429">i</span><span class="op" id="7412430">++</span>&nbsp;<span class="op" id="7412433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412437">var</span>&nbsp;<span class="ident" id="7412441">buf</span>&nbsp;<span class="ident" id="7412445">bytes</span><span class="op" id="7412450">.</span><span class="ident" id="7412451">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412460">enc</span>&nbsp;<span class="op" id="7412464">:=</span>&nbsp;<span class="ident" id="7412467">NewEncoder</span><span class="op" id="7412477">(</span><span class="op" id="7412478">&amp;</span><span class="ident" id="7412479">buf</span><span class="op" id="7412482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412486">for</span>&nbsp;<span class="ident" id="7412490">j</span><span class="op" id="7412491">,</span>&nbsp;<span class="ident" id="7412493">v</span>&nbsp;<span class="op" id="7412495">:=</span>&nbsp;<span class="keyword" id="7412498">range</span>&nbsp;<span class="ident" id="7412504">streamTest</span><span class="op" id="7412514">[</span><span class="num" id="7412515">0</span><span class="op" id="7412516">:</span><span class="ident" id="7412517">i</span><span class="op" id="7412518">]</span>&nbsp;<span class="op" id="7412520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412525">if</span>&nbsp;<span class="ident" id="7412528">err</span>&nbsp;<span class="op" id="7412532">:=</span>&nbsp;<span class="ident" id="7412535">enc</span><span class="op" id="7412538">.</span><span class="ident" id="7412539">Encode</span><span class="op" id="7412545">(</span><span class="ident" id="7412546">v</span><span class="op" id="7412547">)</span><span class="op" id="7412548">;</span>&nbsp;<span class="ident" id="7412550">err</span>&nbsp;<span class="op" id="7412554">!=</span>&nbsp;<span class="ident" id="7412557">nil</span>&nbsp;<span class="op" id="7412561">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412567">t</span><span class="op" id="7412568">.</span><span class="ident" id="7412569">Fatalf</span><span class="op" id="7412575">(</span><span class="string" id="7412576">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7412592">,</span>&nbsp;<span class="ident" id="7412594">j</span><span class="op" id="7412595">,</span>&nbsp;<span class="ident" id="7412597">err</span><span class="op" id="7412600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412613">if</span>&nbsp;<span class="ident" id="7412616">have</span><span class="op" id="7412620">,</span>&nbsp;<span class="ident" id="7412622">want</span>&nbsp;<span class="op" id="7412627">:=</span>&nbsp;<span class="ident" id="7412630">buf</span><span class="op" id="7412633">.</span><span class="ident" id="7412634">String</span><span class="op" id="7412640">(</span><span class="op" id="7412641">)</span><span class="op" id="7412642">,</span>&nbsp;<span class="ident" id="7412644">nlines</span><span class="op" id="7412650">(</span><span class="ident" id="7412651">streamEncoded</span><span class="op" id="7412664">,</span>&nbsp;<span class="ident" id="7412666">i</span><span class="op" id="7412667">)</span><span class="op" id="7412668">;</span>&nbsp;<span class="ident" id="7412670">have</span>&nbsp;<span class="op" id="7412675">!=</span>&nbsp;<span class="ident" id="7412678">want</span>&nbsp;<span class="op" id="7412683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412688">t</span><span class="op" id="7412689">.</span><span class="ident" id="7412690">Errorf</span><span class="op" id="7412696">(</span><span class="string" id="7412697">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="7412726">,</span>&nbsp;<span class="ident" id="7412728">i</span><span class="op" id="7412729">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7412734">diff</span><span class="op" id="7412738">(</span><span class="ident" id="7412739">t</span><span class="op" id="7412740">,</span>&nbsp;<span class="op" id="7412742">[</span><span class="op" id="7412743">]</span><span class="builtintype" id="7412744">byte</span><span class="op" id="7412748">(</span><span class="ident" id="7412749">have</span><span class="op" id="7412753">)</span><span class="op" id="7412754">,</span>&nbsp;<span class="op" id="7412756">[</span><span class="op" id="7412757">]</span><span class="builtintype" id="7412758">byte</span><span class="op" id="7412762">(</span><span class="ident" id="7412763">want</span><span class="op" id="7412767">)</span><span class="op" id="7412768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412773">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7412784">}</span><br>
<span class="lineno"></span><span class="op" id="7412786">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7412789">func</span>&nbsp;<span class="ident" id="7412794">TestDecoder</span><span class="op" id="7412805">(</span><span class="ident" id="7412806">t</span>&nbsp;<span class="op" id="7412808">*</span><span class="ident" id="7412809">testing</span><span class="op" id="7412816">.</span><span class="ident" id="7412817">T</span><span class="op" id="7412818">)</span>&nbsp;<span class="op" id="7412820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7412823">for</span>&nbsp;<span class="ident" id="7412827">i</span>&nbsp;<span class="op" id="7412829">:=</span>&nbsp;<span class="num" id="7412832">0</span><span class="op" id="7412833">;</span>&nbsp;<span class="ident" id="7412835">i</span>&nbsp;<span class="op" id="7412837">&lt;=</span>&nbsp;<span class="builtinfunc" id="7412840">len</span><span class="op" id="7412843">(</span><span class="ident" id="7412844">streamTest</span><span class="op" id="7412854">)</span><span class="op" id="7412855">;</span>&nbsp;<span class="ident" id="7412857">i</span><span class="op" id="7412858">++</span>&nbsp;<span class="op" id="7412861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7412865">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7412908">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7412951">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7413010">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7413054">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413091">var</span>&nbsp;<span class="ident" id="7413095">buf</span>&nbsp;<span class="ident" id="7413099">bytes</span><span class="op" id="7413104">.</span><span class="ident" id="7413105">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413114">for</span>&nbsp;<span class="ident" id="7413118">_</span><span class="op" id="7413119">,</span>&nbsp;<span class="ident" id="7413121">c</span>&nbsp;<span class="op" id="7413123">:=</span>&nbsp;<span class="keyword" id="7413126">range</span>&nbsp;<span class="ident" id="7413132">nlines</span><span class="op" id="7413138">(</span><span class="ident" id="7413139">streamEncoded</span><span class="op" id="7413152">,</span>&nbsp;<span class="ident" id="7413154">i</span><span class="op" id="7413155">)</span>&nbsp;<span class="op" id="7413157">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413162">if</span>&nbsp;<span class="ident" id="7413165">c</span>&nbsp;<span class="op" id="7413167">!=</span>&nbsp;<span class="string" id="7413170">&#39;\n&#39;</span>&nbsp;<span class="op" id="7413175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413181">buf</span><span class="op" id="7413184">.</span><span class="ident" id="7413185">WriteRune</span><span class="op" id="7413194">(</span><span class="ident" id="7413195">c</span><span class="op" id="7413196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413209">out</span>&nbsp;<span class="op" id="7413213">:=</span>&nbsp;<span class="builtinfunc" id="7413216">make</span><span class="op" id="7413220">(</span><span class="op" id="7413221">[</span><span class="op" id="7413222">]</span><span class="keyword" id="7413223">interface</span><span class="op" id="7413232">{</span><span class="op" id="7413233">}</span><span class="op" id="7413234">,</span>&nbsp;<span class="ident" id="7413236">i</span><span class="op" id="7413237">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413241">dec</span>&nbsp;<span class="op" id="7413245">:=</span>&nbsp;<span class="ident" id="7413248">NewDecoder</span><span class="op" id="7413258">(</span><span class="op" id="7413259">&amp;</span><span class="ident" id="7413260">buf</span><span class="op" id="7413263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413267">for</span>&nbsp;<span class="ident" id="7413271">j</span>&nbsp;<span class="op" id="7413273">:=</span>&nbsp;<span class="keyword" id="7413276">range</span>&nbsp;<span class="ident" id="7413282">out</span>&nbsp;<span class="op" id="7413286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413291">if</span>&nbsp;<span class="ident" id="7413294">err</span>&nbsp;<span class="op" id="7413298">:=</span>&nbsp;<span class="ident" id="7413301">dec</span><span class="op" id="7413304">.</span><span class="ident" id="7413305">Decode</span><span class="op" id="7413311">(</span><span class="op" id="7413312">&amp;</span><span class="ident" id="7413313">out</span><span class="op" id="7413316">[</span><span class="ident" id="7413317">j</span><span class="op" id="7413318">]</span><span class="op" id="7413319">)</span><span class="op" id="7413320">;</span>&nbsp;<span class="ident" id="7413322">err</span>&nbsp;<span class="op" id="7413326">!=</span>&nbsp;<span class="ident" id="7413329">nil</span>&nbsp;<span class="op" id="7413333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413339">t</span><span class="op" id="7413340">.</span><span class="ident" id="7413341">Fatalf</span><span class="op" id="7413347">(</span><span class="string" id="7413348">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="7413367">,</span>&nbsp;<span class="ident" id="7413369">j</span><span class="op" id="7413370">,</span>&nbsp;<span class="ident" id="7413372">i</span><span class="op" id="7413373">,</span>&nbsp;<span class="ident" id="7413375">err</span><span class="op" id="7413378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413383">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413391">if</span>&nbsp;<span class="op" id="7413394">!</span><span class="ident" id="7413395">reflect</span><span class="op" id="7413402">.</span><span class="ident" id="7413403">DeepEqual</span><span class="op" id="7413412">(</span><span class="ident" id="7413413">out</span><span class="op" id="7413416">,</span>&nbsp;<span class="ident" id="7413418">streamTest</span><span class="op" id="7413428">[</span><span class="num" id="7413429">0</span><span class="op" id="7413430">:</span><span class="ident" id="7413431">i</span><span class="op" id="7413432">]</span><span class="op" id="7413433">)</span>&nbsp;<span class="op" id="7413435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413440">t</span><span class="op" id="7413441">.</span><span class="ident" id="7413442">Errorf</span><span class="op" id="7413448">(</span><span class="string" id="7413449">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="7413478">,</span>&nbsp;<span class="ident" id="7413480">i</span><span class="op" id="7413481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413486">for</span>&nbsp;<span class="ident" id="7413490">j</span>&nbsp;<span class="op" id="7413492">:=</span>&nbsp;<span class="keyword" id="7413495">range</span>&nbsp;<span class="ident" id="7413501">out</span>&nbsp;<span class="op" id="7413505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413511">if</span>&nbsp;<span class="op" id="7413514">!</span><span class="ident" id="7413515">reflect</span><span class="op" id="7413522">.</span><span class="ident" id="7413523">DeepEqual</span><span class="op" id="7413532">(</span><span class="ident" id="7413533">out</span><span class="op" id="7413536">[</span><span class="ident" id="7413537">j</span><span class="op" id="7413538">]</span><span class="op" id="7413539">,</span>&nbsp;<span class="ident" id="7413541">streamTest</span><span class="op" id="7413551">[</span><span class="ident" id="7413552">j</span><span class="op" id="7413553">]</span><span class="op" id="7413554">)</span>&nbsp;<span class="op" id="7413556">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413563">t</span><span class="op" id="7413564">.</span><span class="ident" id="7413565">Errorf</span><span class="op" id="7413571">(</span><span class="string" id="7413572">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7413594">,</span>&nbsp;<span class="ident" id="7413596">j</span><span class="op" id="7413597">,</span>&nbsp;<span class="ident" id="7413599">out</span><span class="op" id="7413602">[</span><span class="ident" id="7413603">j</span><span class="op" id="7413604">]</span><span class="op" id="7413605">,</span>&nbsp;<span class="ident" id="7413607">streamTest</span><span class="op" id="7413617">[</span><span class="ident" id="7413618">j</span><span class="op" id="7413619">]</span><span class="op" id="7413620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413636">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413644">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413647">}</span><br>
<span class="lineno"></span><span class="op" id="7413649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7413652">func</span>&nbsp;<span class="ident" id="7413657">TestDecoderBuffered</span><span class="op" id="7413676">(</span><span class="ident" id="7413677">t</span>&nbsp;<span class="op" id="7413679">*</span><span class="ident" id="7413680">testing</span><span class="op" id="7413687">.</span><span class="ident" id="7413688">T</span><span class="op" id="7413689">)</span>&nbsp;<span class="op" id="7413691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413694">r</span>&nbsp;<span class="op" id="7413696">:=</span>&nbsp;<span class="ident" id="7413699">strings</span><span class="op" id="7413706">.</span><span class="ident" id="7413707">NewReader</span><span class="op" id="7413716">(</span><span class="string" id="7413717">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="7413744">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413747">var</span>&nbsp;<span class="ident" id="7413751">m</span>&nbsp;<span class="keyword" id="7413753">struct</span>&nbsp;<span class="op" id="7413760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413764">Name</span>&nbsp;<span class="builtintype" id="7413769">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413780">d</span>&nbsp;<span class="op" id="7413782">:=</span>&nbsp;<span class="ident" id="7413785">NewDecoder</span><span class="op" id="7413795">(</span><span class="ident" id="7413796">r</span><span class="op" id="7413797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413800">err</span>&nbsp;<span class="op" id="7413804">:=</span>&nbsp;<span class="ident" id="7413807">d</span><span class="op" id="7413808">.</span><span class="ident" id="7413809">Decode</span><span class="op" id="7413815">(</span><span class="op" id="7413816">&amp;</span><span class="ident" id="7413817">m</span><span class="op" id="7413818">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413821">if</span>&nbsp;<span class="ident" id="7413824">err</span>&nbsp;<span class="op" id="7413828">!=</span>&nbsp;<span class="ident" id="7413831">nil</span>&nbsp;<span class="op" id="7413835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413839">t</span><span class="op" id="7413840">.</span><span class="ident" id="7413841">Fatal</span><span class="op" id="7413846">(</span><span class="ident" id="7413847">err</span><span class="op" id="7413850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413856">if</span>&nbsp;<span class="ident" id="7413859">m</span><span class="op" id="7413860">.</span><span class="ident" id="7413861">Name</span>&nbsp;<span class="op" id="7413866">!=</span>&nbsp;<span class="string" id="7413869">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="7413878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413882">t</span><span class="op" id="7413883">.</span><span class="ident" id="7413884">Errorf</span><span class="op" id="7413890">(</span><span class="string" id="7413891">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="7413915">,</span>&nbsp;<span class="ident" id="7413917">m</span><span class="op" id="7413918">.</span><span class="ident" id="7413919">Name</span><span class="op" id="7413923">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7413926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413929">rest</span><span class="op" id="7413933">,</span>&nbsp;<span class="ident" id="7413935">err</span>&nbsp;<span class="op" id="7413939">:=</span>&nbsp;<span class="ident" id="7413942">ioutil</span><span class="op" id="7413948">.</span><span class="ident" id="7413949">ReadAll</span><span class="op" id="7413956">(</span><span class="ident" id="7413957">d</span><span class="op" id="7413958">.</span><span class="ident" id="7413959">Buffered</span><span class="op" id="7413967">(</span><span class="op" id="7413968">)</span><span class="op" id="7413969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7413972">if</span>&nbsp;<span class="ident" id="7413975">err</span>&nbsp;<span class="op" id="7413979">!=</span>&nbsp;<span class="ident" id="7413982">nil</span>&nbsp;<span class="op" id="7413986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7413990">t</span><span class="op" id="7413991">.</span><span class="ident" id="7413992">Fatal</span><span class="op" id="7413997">(</span><span class="ident" id="7413998">err</span><span class="op" id="7414001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414004">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414007">if</span>&nbsp;<span class="ident" id="7414010">g</span><span class="op" id="7414011">,</span>&nbsp;<span class="ident" id="7414013">w</span>&nbsp;<span class="op" id="7414015">:=</span>&nbsp;<span class="builtintype" id="7414018">string</span><span class="op" id="7414024">(</span><span class="ident" id="7414025">rest</span><span class="op" id="7414029">)</span><span class="op" id="7414030">,</span>&nbsp;<span class="string" id="7414032">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="7414041">;</span>&nbsp;<span class="ident" id="7414043">g</span>&nbsp;<span class="op" id="7414045">!=</span>&nbsp;<span class="ident" id="7414048">w</span>&nbsp;<span class="op" id="7414050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414054">t</span><span class="op" id="7414055">.</span><span class="ident" id="7414056">Errorf</span><span class="op" id="7414062">(</span><span class="string" id="7414063">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7414088">,</span>&nbsp;<span class="ident" id="7414090">g</span><span class="op" id="7414091">,</span>&nbsp;<span class="ident" id="7414093">w</span><span class="op" id="7414094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414097">}</span><br>
<span class="lineno"></span><span class="op" id="7414099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="7414102">func</span>&nbsp;<span class="ident" id="7414107">nlines</span><span class="op" id="7414113">(</span><span class="ident" id="7414114">s</span>&nbsp;<span class="builtintype" id="7414116">string</span><span class="op" id="7414122">,</span>&nbsp;<span class="ident" id="7414124">n</span>&nbsp;<span class="builtintype" id="7414126">int</span><span class="op" id="7414129">)</span>&nbsp;<span class="builtintype" id="7414131">string</span>&nbsp;<span class="op" id="7414138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414141">if</span>&nbsp;<span class="ident" id="7414144">n</span>&nbsp;<span class="op" id="7414146">&lt;=</span>&nbsp;<span class="num" id="7414149">0</span>&nbsp;<span class="op" id="7414151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414155">return</span>&nbsp;<span class="string" id="7414162">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414169">for</span>&nbsp;<span class="ident" id="7414173">i</span><span class="op" id="7414174">,</span>&nbsp;<span class="ident" id="7414176">c</span>&nbsp;<span class="op" id="7414178">:=</span>&nbsp;<span class="keyword" id="7414181">range</span>&nbsp;<span class="ident" id="7414187">s</span>&nbsp;<span class="op" id="7414189">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414193">if</span>&nbsp;<span class="ident" id="7414196">c</span>&nbsp;<span class="op" id="7414198">==</span>&nbsp;<span class="string" id="7414201">&#39;\n&#39;</span>&nbsp;<span class="op" id="7414206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414211">if</span>&nbsp;<span class="ident" id="7414214">n</span><span class="op" id="7414215">--</span><span class="op" id="7414217">;</span>&nbsp;<span class="ident" id="7414219">n</span>&nbsp;<span class="op" id="7414221">==</span>&nbsp;<span class="num" id="7414224">0</span>&nbsp;<span class="op" id="7414226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414232">return</span>&nbsp;<span class="ident" id="7414239">s</span><span class="op" id="7414240">[</span><span class="num" id="7414241">0</span>&nbsp;<span class="op" id="7414243">:</span>&nbsp;<span class="ident" id="7414245">i</span><span class="op" id="7414246">+</span><span class="num" id="7414247">1</span><span class="op" id="7414248">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414257">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414263">return</span>&nbsp;<span class="ident" id="7414270">s</span><br>
<span class="lineno"></span><span class="op" id="7414272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7414275">func</span>&nbsp;<span class="ident" id="7414280">TestRawMessage</span><span class="op" id="7414294">(</span><span class="ident" id="7414295">t</span>&nbsp;<span class="op" id="7414297">*</span><span class="ident" id="7414298">testing</span><span class="op" id="7414305">.</span><span class="ident" id="7414306">T</span><span class="op" id="7414307">)</span>&nbsp;<span class="op" id="7414309">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7414312">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414364">var</span>&nbsp;<span class="ident" id="7414368">data</span>&nbsp;<span class="keyword" id="7414373">struct</span>&nbsp;<span class="op" id="7414380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414384">X</span>&nbsp;&nbsp;<span class="builtintype" id="7414387">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414397">Id</span>&nbsp;<span class="op" id="7414400">*</span><span class="ident" id="7414401">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414414">Y</span>&nbsp;&nbsp;<span class="builtintype" id="7414417">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414429">const</span>&nbsp;<span class="ident" id="7414435">raw</span>&nbsp;<span class="op" id="7414439">=</span>&nbsp;<span class="string" id="7414441">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414460">const</span>&nbsp;<span class="ident" id="7414466">msg</span>&nbsp;<span class="op" id="7414470">=</span>&nbsp;<span class="string" id="7414472">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414514">err</span>&nbsp;<span class="op" id="7414518">:=</span>&nbsp;<span class="ident" id="7414521">Unmarshal</span><span class="op" id="7414530">(</span><span class="op" id="7414531">[</span><span class="op" id="7414532">]</span><span class="builtintype" id="7414533">byte</span><span class="op" id="7414537">(</span><span class="ident" id="7414538">msg</span><span class="op" id="7414541">)</span><span class="op" id="7414542">,</span>&nbsp;<span class="op" id="7414544">&amp;</span><span class="ident" id="7414545">data</span><span class="op" id="7414549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414552">if</span>&nbsp;<span class="ident" id="7414555">err</span>&nbsp;<span class="op" id="7414559">!=</span>&nbsp;<span class="ident" id="7414562">nil</span>&nbsp;<span class="op" id="7414566">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414570">t</span><span class="op" id="7414571">.</span><span class="ident" id="7414572">Fatalf</span><span class="op" id="7414578">(</span><span class="string" id="7414579">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="7414594">,</span>&nbsp;<span class="ident" id="7414596">err</span><span class="op" id="7414599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414605">if</span>&nbsp;<span class="builtintype" id="7414608">string</span><span class="op" id="7414614">(</span><span class="op" id="7414615">[</span><span class="op" id="7414616">]</span><span class="builtintype" id="7414617">byte</span><span class="op" id="7414621">(</span><span class="op" id="7414622">*</span><span class="ident" id="7414623">data</span><span class="op" id="7414627">.</span><span class="ident" id="7414628">Id</span><span class="op" id="7414630">)</span><span class="op" id="7414631">)</span>&nbsp;<span class="op" id="7414633">!=</span>&nbsp;<span class="ident" id="7414636">raw</span>&nbsp;<span class="op" id="7414640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414644">t</span><span class="op" id="7414645">.</span><span class="ident" id="7414646">Fatalf</span><span class="op" id="7414652">(</span><span class="string" id="7414653">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7414686">,</span>&nbsp;<span class="op" id="7414688">[</span><span class="op" id="7414689">]</span><span class="builtintype" id="7414690">byte</span><span class="op" id="7414694">(</span><span class="op" id="7414695">*</span><span class="ident" id="7414696">data</span><span class="op" id="7414700">.</span><span class="ident" id="7414701">Id</span><span class="op" id="7414703">)</span><span class="op" id="7414704">,</span>&nbsp;<span class="ident" id="7414706">raw</span><span class="op" id="7414709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414712">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414715">b</span><span class="op" id="7414716">,</span>&nbsp;<span class="ident" id="7414718">err</span>&nbsp;<span class="op" id="7414722">:=</span>&nbsp;<span class="ident" id="7414725">Marshal</span><span class="op" id="7414732">(</span><span class="op" id="7414733">&amp;</span><span class="ident" id="7414734">data</span><span class="op" id="7414738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414741">if</span>&nbsp;<span class="ident" id="7414744">err</span>&nbsp;<span class="op" id="7414748">!=</span>&nbsp;<span class="ident" id="7414751">nil</span>&nbsp;<span class="op" id="7414755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414759">t</span><span class="op" id="7414760">.</span><span class="ident" id="7414761">Fatalf</span><span class="op" id="7414767">(</span><span class="string" id="7414768">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="7414781">,</span>&nbsp;<span class="ident" id="7414783">err</span><span class="op" id="7414786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414792">if</span>&nbsp;<span class="builtintype" id="7414795">string</span><span class="op" id="7414801">(</span><span class="ident" id="7414802">b</span><span class="op" id="7414803">)</span>&nbsp;<span class="op" id="7414805">!=</span>&nbsp;<span class="ident" id="7414808">msg</span>&nbsp;<span class="op" id="7414812">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414816">t</span><span class="op" id="7414817">.</span><span class="ident" id="7414818">Fatalf</span><span class="op" id="7414824">(</span><span class="string" id="7414825">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7414853">,</span>&nbsp;<span class="ident" id="7414855">b</span><span class="op" id="7414856">,</span>&nbsp;<span class="ident" id="7414858">msg</span><span class="op" id="7414861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7414864">}</span><br>
<span class="lineno"></span><span class="op" id="7414866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7414869">func</span>&nbsp;<span class="ident" id="7414874">TestNullRawMessage</span><span class="op" id="7414892">(</span><span class="ident" id="7414893">t</span>&nbsp;<span class="op" id="7414895">*</span><span class="ident" id="7414896">testing</span><span class="op" id="7414903">.</span><span class="ident" id="7414904">T</span><span class="op" id="7414905">)</span>&nbsp;<span class="op" id="7414907">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7414910">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7414962">var</span>&nbsp;<span class="ident" id="7414966">data</span>&nbsp;<span class="keyword" id="7414971">struct</span>&nbsp;<span class="op" id="7414978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414982">X</span>&nbsp;&nbsp;<span class="builtintype" id="7414985">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7414995">Id</span>&nbsp;<span class="op" id="7414998">*</span><span class="ident" id="7414999">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415012">Y</span>&nbsp;&nbsp;<span class="builtintype" id="7415015">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415027">data</span><span class="op" id="7415031">.</span><span class="ident" id="7415032">Id</span>&nbsp;<span class="op" id="7415035">=</span>&nbsp;<span class="builtinfunc" id="7415037">new</span><span class="op" id="7415040">(</span><span class="ident" id="7415041">RawMessage</span><span class="op" id="7415051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415054">const</span>&nbsp;<span class="ident" id="7415060">msg</span>&nbsp;<span class="op" id="7415064">=</span>&nbsp;<span class="string" id="7415066">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415097">err</span>&nbsp;<span class="op" id="7415101">:=</span>&nbsp;<span class="ident" id="7415104">Unmarshal</span><span class="op" id="7415113">(</span><span class="op" id="7415114">[</span><span class="op" id="7415115">]</span><span class="builtintype" id="7415116">byte</span><span class="op" id="7415120">(</span><span class="ident" id="7415121">msg</span><span class="op" id="7415124">)</span><span class="op" id="7415125">,</span>&nbsp;<span class="op" id="7415127">&amp;</span><span class="ident" id="7415128">data</span><span class="op" id="7415132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415135">if</span>&nbsp;<span class="ident" id="7415138">err</span>&nbsp;<span class="op" id="7415142">!=</span>&nbsp;<span class="ident" id="7415145">nil</span>&nbsp;<span class="op" id="7415149">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415153">t</span><span class="op" id="7415154">.</span><span class="ident" id="7415155">Fatalf</span><span class="op" id="7415161">(</span><span class="string" id="7415162">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="7415177">,</span>&nbsp;<span class="ident" id="7415179">err</span><span class="op" id="7415182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415188">if</span>&nbsp;<span class="ident" id="7415191">data</span><span class="op" id="7415195">.</span><span class="ident" id="7415196">Id</span>&nbsp;<span class="op" id="7415199">!=</span>&nbsp;<span class="ident" id="7415202">nil</span>&nbsp;<span class="op" id="7415206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415210">t</span><span class="op" id="7415211">.</span><span class="ident" id="7415212">Fatalf</span><span class="op" id="7415218">(</span><span class="string" id="7415219">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7415257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415260">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415263">b</span><span class="op" id="7415264">,</span>&nbsp;<span class="ident" id="7415266">err</span>&nbsp;<span class="op" id="7415270">:=</span>&nbsp;<span class="ident" id="7415273">Marshal</span><span class="op" id="7415280">(</span><span class="op" id="7415281">&amp;</span><span class="ident" id="7415282">data</span><span class="op" id="7415286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415289">if</span>&nbsp;<span class="ident" id="7415292">err</span>&nbsp;<span class="op" id="7415296">!=</span>&nbsp;<span class="ident" id="7415299">nil</span>&nbsp;<span class="op" id="7415303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415307">t</span><span class="op" id="7415308">.</span><span class="ident" id="7415309">Fatalf</span><span class="op" id="7415315">(</span><span class="string" id="7415316">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="7415329">,</span>&nbsp;<span class="ident" id="7415331">err</span><span class="op" id="7415334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415340">if</span>&nbsp;<span class="builtintype" id="7415343">string</span><span class="op" id="7415349">(</span><span class="ident" id="7415350">b</span><span class="op" id="7415351">)</span>&nbsp;<span class="op" id="7415353">!=</span>&nbsp;<span class="ident" id="7415356">msg</span>&nbsp;<span class="op" id="7415360">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415364">t</span><span class="op" id="7415365">.</span><span class="ident" id="7415366">Fatalf</span><span class="op" id="7415372">(</span><span class="string" id="7415373">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="7415401">,</span>&nbsp;<span class="ident" id="7415403">b</span><span class="op" id="7415404">,</span>&nbsp;<span class="ident" id="7415406">msg</span><span class="op" id="7415409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415412">}</span><br>
<span class="lineno"></span><span class="op" id="7415414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7415417">var</span>&nbsp;<span class="ident" id="7415421">blockingTests</span>&nbsp;<span class="op" id="7415435">=</span>&nbsp;<span class="op" id="7415437">[</span><span class="op" id="7415438">]</span><span class="builtintype" id="7415439">string</span><span class="op" id="7415445">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7415448">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="7415458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7415461">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="7415472">,</span><br>
<span class="lineno"></span><span class="op" id="7415474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7415477">func</span>&nbsp;<span class="ident" id="7415482">TestBlocking</span><span class="op" id="7415494">(</span><span class="ident" id="7415495">t</span>&nbsp;<span class="op" id="7415497">*</span><span class="ident" id="7415498">testing</span><span class="op" id="7415505">.</span><span class="ident" id="7415506">T</span><span class="op" id="7415507">)</span>&nbsp;<span class="op" id="7415509">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415512">for</span>&nbsp;<span class="ident" id="7415516">_</span><span class="op" id="7415517">,</span>&nbsp;<span class="ident" id="7415519">enc</span>&nbsp;<span class="op" id="7415523">:=</span>&nbsp;<span class="keyword" id="7415526">range</span>&nbsp;<span class="ident" id="7415532">blockingTests</span>&nbsp;<span class="op" id="7415546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415550">r</span><span class="op" id="7415551">,</span>&nbsp;<span class="ident" id="7415553">w</span>&nbsp;<span class="op" id="7415555">:=</span>&nbsp;<span class="ident" id="7415558">net</span><span class="op" id="7415561">.</span><span class="ident" id="7415562">Pipe</span><span class="op" id="7415566">(</span><span class="op" id="7415567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415571">go</span>&nbsp;<span class="ident" id="7415574">w</span><span class="op" id="7415575">.</span><span class="ident" id="7415576">Write</span><span class="op" id="7415581">(</span><span class="op" id="7415582">[</span><span class="op" id="7415583">]</span><span class="builtintype" id="7415584">byte</span><span class="op" id="7415588">(</span><span class="ident" id="7415589">enc</span><span class="op" id="7415592">)</span><span class="op" id="7415593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415597">var</span>&nbsp;<span class="ident" id="7415601">val</span>&nbsp;<span class="keyword" id="7415605">interface</span><span class="op" id="7415614">{</span><span class="op" id="7415615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7415620">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7415675">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415723">if</span>&nbsp;<span class="ident" id="7415726">err</span>&nbsp;<span class="op" id="7415730">:=</span>&nbsp;<span class="ident" id="7415733">NewDecoder</span><span class="op" id="7415743">(</span><span class="ident" id="7415744">r</span><span class="op" id="7415745">)</span><span class="op" id="7415746">.</span><span class="ident" id="7415747">Decode</span><span class="op" id="7415753">(</span><span class="op" id="7415754">&amp;</span><span class="ident" id="7415755">val</span><span class="op" id="7415758">)</span><span class="op" id="7415759">;</span>&nbsp;<span class="ident" id="7415761">err</span>&nbsp;<span class="op" id="7415765">!=</span>&nbsp;<span class="ident" id="7415768">nil</span>&nbsp;<span class="op" id="7415772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415777">t</span><span class="op" id="7415778">.</span><span class="ident" id="7415779">Errorf</span><span class="op" id="7415785">(</span><span class="string" id="7415786">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7415803">,</span>&nbsp;<span class="ident" id="7415805">enc</span><span class="op" id="7415808">,</span>&nbsp;<span class="ident" id="7415810">err</span><span class="op" id="7415813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415817">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415821">r</span><span class="op" id="7415822">.</span><span class="ident" id="7415823">Close</span><span class="op" id="7415828">(</span><span class="op" id="7415829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415833">w</span><span class="op" id="7415834">.</span><span class="ident" id="7415835">Close</span><span class="op" id="7415840">(</span><span class="op" id="7415841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415844">}</span><br>
<span class="lineno"></span><span class="op" id="7415846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="7415849">func</span>&nbsp;<span class="ident" id="7415854">BenchmarkEncoderEncode</span><span class="op" id="7415876">(</span><span class="ident" id="7415877">b</span>&nbsp;<span class="op" id="7415879">*</span><span class="ident" id="7415880">testing</span><span class="op" id="7415887">.</span><span class="ident" id="7415888">B</span><span class="op" id="7415889">)</span>&nbsp;<span class="op" id="7415891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415894">b</span><span class="op" id="7415895">.</span><span class="ident" id="7415896">ReportAllocs</span><span class="op" id="7415908">(</span><span class="op" id="7415909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415912">type</span>&nbsp;<span class="ident" id="7415917">T</span>&nbsp;<span class="keyword" id="7415919">struct</span>&nbsp;<span class="op" id="7415926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415930">X</span><span class="op" id="7415931">,</span>&nbsp;<span class="ident" id="7415933">Y</span>&nbsp;<span class="builtintype" id="7415935">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7415943">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7415946">v</span>&nbsp;<span class="op" id="7415948">:=</span>&nbsp;<span class="op" id="7415951">&amp;</span><span class="ident" id="7415952">T</span><span class="op" id="7415953">{</span><span class="string" id="7415954">&#34;foo&#34;</span><span class="op" id="7415959">,</span>&nbsp;<span class="string" id="7415961">&#34;bar&#34;</span><span class="op" id="7415966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415969">for</span>&nbsp;<span class="ident" id="7415973">i</span>&nbsp;<span class="op" id="7415975">:=</span>&nbsp;<span class="num" id="7415978">0</span><span class="op" id="7415979">;</span>&nbsp;<span class="ident" id="7415981">i</span>&nbsp;<span class="op" id="7415983">&lt;</span>&nbsp;<span class="ident" id="7415985">b</span><span class="op" id="7415986">.</span><span class="ident" id="7415987">N</span><span class="op" id="7415988">;</span>&nbsp;<span class="ident" id="7415990">i</span><span class="op" id="7415991">++</span>&nbsp;<span class="op" id="7415994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7415998">if</span>&nbsp;<span class="ident" id="7416001">err</span>&nbsp;<span class="op" id="7416005">:=</span>&nbsp;<span class="ident" id="7416008">NewEncoder</span><span class="op" id="7416018">(</span><span class="ident" id="7416019">ioutil</span><span class="op" id="7416025">.</span><span class="ident" id="7416026">Discard</span><span class="op" id="7416033">)</span><span class="op" id="7416034">.</span><span class="ident" id="7416035">Encode</span><span class="op" id="7416041">(</span><span class="ident" id="7416042">v</span><span class="op" id="7416043">)</span><span class="op" id="7416044">;</span>&nbsp;<span class="ident" id="7416046">err</span>&nbsp;<span class="op" id="7416050">!=</span>&nbsp;<span class="ident" id="7416053">nil</span>&nbsp;<span class="op" id="7416057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416062">b</span><span class="op" id="7416063">.</span><span class="ident" id="7416064">Fatal</span><span class="op" id="7416069">(</span><span class="ident" id="7416070">err</span><span class="op" id="7416073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7416077">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7416080">}</span><br>
<span class="lineno"></span><span class="op" id="7416082">}</span>
</div>
</body>
</html>
