<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3342189">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3342245">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3342299">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3342350">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342428">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3342475">package</span>&nbsp;<span class="ident" id="3342483">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3342488">import</span>&nbsp;<span class="op" id="3342495">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342498">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342509">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3342516">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3342519">func</span>&nbsp;<span class="ident" id="3342524">probeIPv4Stack</span><span class="op" id="3342538">(</span><span class="op" id="3342539">)</span>&nbsp;<span class="builtintype" id="3342541">bool</span>&nbsp;<span class="op" id="3342546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342549">s</span><span class="op" id="3342550">,</span>&nbsp;<span class="ident" id="3342552">err</span>&nbsp;<span class="op" id="3342556">:=</span>&nbsp;<span class="ident" id="3342559">syscall</span><span class="op" id="3342566">.</span><span class="ident" id="3342567">Socket</span><span class="op" id="3342573">(</span><span class="ident" id="3342574">syscall</span><span class="op" id="3342581">.</span><span class="ident" id="3342582">AF_INET</span><span class="op" id="3342589">,</span>&nbsp;<span class="ident" id="3342591">syscall</span><span class="op" id="3342598">.</span><span class="ident" id="3342599">SOCK_STREAM</span><span class="op" id="3342610">,</span>&nbsp;<span class="ident" id="3342612">syscall</span><span class="op" id="3342619">.</span><span class="ident" id="3342620">IPPROTO_TCP</span><span class="op" id="3342631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342634">switch</span>&nbsp;<span class="ident" id="3342641">err</span>&nbsp;<span class="op" id="3342645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342648">case</span>&nbsp;<span class="ident" id="3342653">syscall</span><span class="op" id="3342660">.</span><span class="ident" id="3342661">EAFNOSUPPORT</span><span class="op" id="3342673">,</span>&nbsp;<span class="ident" id="3342675">syscall</span><span class="op" id="3342682">.</span><span class="ident" id="3342683">EPROTONOSUPPORT</span><span class="op" id="3342698">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342702">return</span>&nbsp;<span class="builtintype" id="3342709">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342716">case</span>&nbsp;<span class="ident" id="3342721">nil</span><span class="op" id="3342724">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342728">closesocket</span><span class="op" id="3342739">(</span><span class="ident" id="3342740">s</span><span class="op" id="3342741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342747">return</span>&nbsp;<span class="builtintype" id="3342754">true</span><br>
<span class="lineno">25</span><span class="op" id="3342759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342762">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3342821">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3342884">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3342950">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3343011">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3343074">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3343129">//</span><br>
<span class="lineno"></span><span class="comment" id="3343132">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3343199">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3343263">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3343317">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3343382">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3343448">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3343509">func</span>&nbsp;<span class="ident" id="3343514">probeIPv6Stack</span><span class="op" id="3343528">(</span><span class="op" id="3343529">)</span>&nbsp;<span class="op" id="3343531">(</span><span class="ident" id="3343532">supportsIPv6</span><span class="op" id="3343544">,</span>&nbsp;<span class="ident" id="3343546">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3343562">bool</span><span class="op" id="3343566">)</span>&nbsp;<span class="op" id="3343568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343571">var</span>&nbsp;<span class="ident" id="3343575">probes</span>&nbsp;<span class="op" id="3343582">=</span>&nbsp;<span class="op" id="3343584">[</span><span class="op" id="3343585">]</span><span class="keyword" id="3343586">struct</span>&nbsp;<span class="op" id="3343593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343597">laddr</span>&nbsp;<span class="ident" id="3343603">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343613">value</span>&nbsp;<span class="builtintype" id="3343619">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343625">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3343631">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343637">}</span><span class="op" id="3343638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343642">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343677">{</span><span class="ident" id="3343678">laddr</span><span class="op" id="3343683">:</span>&nbsp;<span class="ident" id="3343685">TCPAddr</span><span class="op" id="3343692">{</span><span class="ident" id="3343693">IP</span><span class="op" id="3343695">:</span>&nbsp;<span class="ident" id="3343697">ParseIP</span><span class="op" id="3343704">(</span><span class="string" id="3343705">&#34;::1&#34;</span><span class="op" id="3343710">)</span><span class="op" id="3343711">}</span><span class="op" id="3343712">,</span>&nbsp;<span class="ident" id="3343714">value</span><span class="op" id="3343719">:</span>&nbsp;<span class="num" id="3343721">1</span><span class="op" id="3343722">}</span><span class="op" id="3343723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343727">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343782">{</span><span class="ident" id="3343783">laddr</span><span class="op" id="3343788">:</span>&nbsp;<span class="ident" id="3343790">TCPAddr</span><span class="op" id="3343797">{</span><span class="ident" id="3343798">IP</span><span class="op" id="3343800">:</span>&nbsp;<span class="ident" id="3343802">IPv4</span><span class="op" id="3343806">(</span><span class="num" id="3343807">127</span><span class="op" id="3343810">,</span>&nbsp;<span class="num" id="3343812">0</span><span class="op" id="3343813">,</span>&nbsp;<span class="num" id="3343815">0</span><span class="op" id="3343816">,</span>&nbsp;<span class="num" id="3343818">1</span><span class="op" id="3343819">)</span><span class="op" id="3343820">}</span><span class="op" id="3343821">,</span>&nbsp;<span class="ident" id="3343823">value</span><span class="op" id="3343828">:</span>&nbsp;<span class="num" id="3343830">0</span><span class="op" id="3343831">}</span><span class="op" id="3343832">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343839">for</span>&nbsp;<span class="ident" id="3343843">i</span>&nbsp;<span class="op" id="3343845">:=</span>&nbsp;<span class="keyword" id="3343848">range</span>&nbsp;<span class="ident" id="3343854">probes</span>&nbsp;<span class="op" id="3343861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343865">s</span><span class="op" id="3343866">,</span>&nbsp;<span class="ident" id="3343868">err</span>&nbsp;<span class="op" id="3343872">:=</span>&nbsp;<span class="ident" id="3343875">syscall</span><span class="op" id="3343882">.</span><span class="ident" id="3343883">Socket</span><span class="op" id="3343889">(</span><span class="ident" id="3343890">syscall</span><span class="op" id="3343897">.</span><span class="ident" id="3343898">AF_INET6</span><span class="op" id="3343906">,</span>&nbsp;<span class="ident" id="3343908">syscall</span><span class="op" id="3343915">.</span><span class="ident" id="3343916">SOCK_STREAM</span><span class="op" id="3343927">,</span>&nbsp;<span class="ident" id="3343929">syscall</span><span class="op" id="3343936">.</span><span class="ident" id="3343937">IPPROTO_TCP</span><span class="op" id="3343948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343952">if</span>&nbsp;<span class="ident" id="3343955">err</span>&nbsp;<span class="op" id="3343959">!=</span>&nbsp;<span class="ident" id="3343962">nil</span>&nbsp;<span class="op" id="3343966">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343971">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343986">defer</span>&nbsp;<span class="ident" id="3343992">closesocket</span><span class="op" id="3344003">(</span><span class="ident" id="3344004">s</span><span class="op" id="3344005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344009">syscall</span><span class="op" id="3344016">.</span><span class="ident" id="3344017">SetsockoptInt</span><span class="op" id="3344030">(</span><span class="ident" id="3344031">s</span><span class="op" id="3344032">,</span>&nbsp;<span class="ident" id="3344034">syscall</span><span class="op" id="3344041">.</span><span class="ident" id="3344042">IPPROTO_IPV6</span><span class="op" id="3344054">,</span>&nbsp;<span class="ident" id="3344056">syscall</span><span class="op" id="3344063">.</span><span class="ident" id="3344064">IPV6_V6ONLY</span><span class="op" id="3344075">,</span>&nbsp;<span class="ident" id="3344077">probes</span><span class="op" id="3344083">[</span><span class="ident" id="3344084">i</span><span class="op" id="3344085">]</span><span class="op" id="3344086">.</span><span class="ident" id="3344087">value</span><span class="op" id="3344092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344096">sa</span><span class="op" id="3344098">,</span>&nbsp;<span class="ident" id="3344100">err</span>&nbsp;<span class="op" id="3344104">:=</span>&nbsp;<span class="ident" id="3344107">probes</span><span class="op" id="3344113">[</span><span class="ident" id="3344114">i</span><span class="op" id="3344115">]</span><span class="op" id="3344116">.</span><span class="ident" id="3344117">laddr</span><span class="op" id="3344122">.</span><span class="ident" id="3344123">sockaddr</span><span class="op" id="3344131">(</span><span class="ident" id="3344132">syscall</span><span class="op" id="3344139">.</span><span class="ident" id="3344140">AF_INET6</span><span class="op" id="3344148">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344152">if</span>&nbsp;<span class="ident" id="3344155">err</span>&nbsp;<span class="op" id="3344159">!=</span>&nbsp;<span class="ident" id="3344162">nil</span>&nbsp;<span class="op" id="3344166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344171">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344186">if</span>&nbsp;<span class="ident" id="3344189">err</span>&nbsp;<span class="op" id="3344193">:=</span>&nbsp;<span class="ident" id="3344196">syscall</span><span class="op" id="3344203">.</span><span class="ident" id="3344204">Bind</span><span class="op" id="3344208">(</span><span class="ident" id="3344209">s</span><span class="op" id="3344210">,</span>&nbsp;<span class="ident" id="3344212">sa</span><span class="op" id="3344214">)</span><span class="op" id="3344215">;</span>&nbsp;<span class="ident" id="3344217">err</span>&nbsp;<span class="op" id="3344221">!=</span>&nbsp;<span class="ident" id="3344224">nil</span>&nbsp;<span class="op" id="3344228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344233">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344248">probes</span><span class="op" id="3344254">[</span><span class="ident" id="3344255">i</span><span class="op" id="3344256">]</span><span class="op" id="3344257">.</span><span class="ident" id="3344258">ok</span>&nbsp;<span class="op" id="3344261">=</span>&nbsp;<span class="builtintype" id="3344263">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344273">return</span>&nbsp;<span class="ident" id="3344280">probes</span><span class="op" id="3344286">[</span><span class="num" id="3344287">0</span><span class="op" id="3344288">]</span><span class="op" id="3344289">.</span><span class="ident" id="3344290">ok</span><span class="op" id="3344292">,</span>&nbsp;<span class="ident" id="3344294">probes</span><span class="op" id="3344300">[</span><span class="num" id="3344301">1</span><span class="op" id="3344302">]</span><span class="op" id="3344303">.</span><span class="ident" id="3344304">ok</span><br>
<span class="lineno">70</span><span class="op" id="3344307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3344310">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3344374">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3344436">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3344500">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3344562">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3344628">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3344692">//</span><br>
<span class="lineno"></span><span class="comment" id="3344695">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3344732">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3344792">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3344851">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3344907">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3344966">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3345017">//</span><br>
<span class="lineno"></span><span class="comment" id="3345020">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3345068">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3345082">//</span><br>
<span class="lineno"></span><span class="comment" id="3345085">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3345130">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3345189">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3345247">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3345307">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3345330">//</span><br>
<span class="lineno">95</span><span class="comment" id="3345333">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3345388">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3345441">//</span><br>
<span class="lineno"></span><span class="comment" id="3345444">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3345496">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3345557">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3345568">//</span><br>
<span class="lineno"></span><span class="comment" id="3345571">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3345639">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3345706">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3345740">//</span><br>
<span class="lineno"></span><span class="comment" id="3345743">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3345811">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3345872">func</span>&nbsp;<span class="ident" id="3345877">favoriteAddrFamily</span><span class="op" id="3345895">(</span><span class="ident" id="3345896">net</span>&nbsp;<span class="builtintype" id="3345900">string</span><span class="op" id="3345906">,</span>&nbsp;<span class="ident" id="3345908">laddr</span><span class="op" id="3345913">,</span>&nbsp;<span class="ident" id="3345915">raddr</span>&nbsp;<span class="ident" id="3345921">sockaddr</span><span class="op" id="3345929">,</span>&nbsp;<span class="ident" id="3345931">mode</span>&nbsp;<span class="builtintype" id="3345936">string</span><span class="op" id="3345942">)</span>&nbsp;<span class="op" id="3345944">(</span><span class="ident" id="3345945">family</span>&nbsp;<span class="builtintype" id="3345952">int</span><span class="op" id="3345955">,</span>&nbsp;<span class="ident" id="3345957">ipv6only</span>&nbsp;<span class="builtintype" id="3345966">bool</span><span class="op" id="3345970">)</span>&nbsp;<span class="op" id="3345972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345975">switch</span>&nbsp;<span class="ident" id="3345982">net</span><span class="op" id="3345985">[</span><span class="builtinfunc" id="3345986">len</span><span class="op" id="3345989">(</span><span class="ident" id="3345990">net</span><span class="op" id="3345993">)</span><span class="op" id="3345994">-</span><span class="num" id="3345995">1</span><span class="op" id="3345996">]</span>&nbsp;<span class="op" id="3345998">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346001">case</span>&nbsp;<span class="string" id="3346006">&#39;4&#39;</span><span class="op" id="3346009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346013">return</span>&nbsp;<span class="ident" id="3346020">syscall</span><span class="op" id="3346027">.</span><span class="ident" id="3346028">AF_INET</span><span class="op" id="3346035">,</span>&nbsp;<span class="builtintype" id="3346037">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346044">case</span>&nbsp;<span class="string" id="3346049">&#39;6&#39;</span><span class="op" id="3346052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346056">return</span>&nbsp;<span class="ident" id="3346063">syscall</span><span class="op" id="3346070">.</span><span class="ident" id="3346071">AF_INET6</span><span class="op" id="3346079">,</span>&nbsp;<span class="builtintype" id="3346081">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346087">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346091">if</span>&nbsp;<span class="ident" id="3346094">mode</span>&nbsp;<span class="op" id="3346099">==</span>&nbsp;<span class="string" id="3346102">&#34;listen&#34;</span>&nbsp;<span class="op" id="3346111">&amp;&amp;</span>&nbsp;<span class="op" id="3346114">(</span><span class="ident" id="3346115">laddr</span>&nbsp;<span class="op" id="3346121">==</span>&nbsp;<span class="ident" id="3346124">nil</span>&nbsp;<span class="op" id="3346128">||</span>&nbsp;<span class="ident" id="3346131">laddr</span><span class="op" id="3346136">.</span><span class="ident" id="3346137">isWildcard</span><span class="op" id="3346147">(</span><span class="op" id="3346148">)</span><span class="op" id="3346149">)</span>&nbsp;<span class="op" id="3346151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346155">if</span>&nbsp;<span class="ident" id="3346158">supportsIPv4map</span>&nbsp;<span class="op" id="3346174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346179">return</span>&nbsp;<span class="ident" id="3346186">syscall</span><span class="op" id="3346193">.</span><span class="ident" id="3346194">AF_INET6</span><span class="op" id="3346202">,</span>&nbsp;<span class="builtintype" id="3346204">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346212">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346216">if</span>&nbsp;<span class="ident" id="3346219">laddr</span>&nbsp;<span class="op" id="3346225">==</span>&nbsp;<span class="ident" id="3346228">nil</span>&nbsp;<span class="op" id="3346232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346237">return</span>&nbsp;<span class="ident" id="3346244">syscall</span><span class="op" id="3346251">.</span><span class="ident" id="3346252">AF_INET</span><span class="op" id="3346259">,</span>&nbsp;<span class="builtintype" id="3346261">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346273">return</span>&nbsp;<span class="ident" id="3346280">laddr</span><span class="op" id="3346285">.</span><span class="ident" id="3346286">family</span><span class="op" id="3346292">(</span><span class="op" id="3346293">)</span><span class="op" id="3346294">,</span>&nbsp;<span class="builtintype" id="3346296">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346303">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346307">if</span>&nbsp;<span class="op" id="3346310">(</span><span class="ident" id="3346311">laddr</span>&nbsp;<span class="op" id="3346317">==</span>&nbsp;<span class="ident" id="3346320">nil</span>&nbsp;<span class="op" id="3346324">||</span>&nbsp;<span class="ident" id="3346327">laddr</span><span class="op" id="3346332">.</span><span class="ident" id="3346333">family</span><span class="op" id="3346339">(</span><span class="op" id="3346340">)</span>&nbsp;<span class="op" id="3346342">==</span>&nbsp;<span class="ident" id="3346345">syscall</span><span class="op" id="3346352">.</span><span class="ident" id="3346353">AF_INET</span><span class="op" id="3346360">)</span>&nbsp;<span class="op" id="3346362">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346367">(</span><span class="ident" id="3346368">raddr</span>&nbsp;<span class="op" id="3346374">==</span>&nbsp;<span class="ident" id="3346377">nil</span>&nbsp;<span class="op" id="3346381">||</span>&nbsp;<span class="ident" id="3346384">raddr</span><span class="op" id="3346389">.</span><span class="ident" id="3346390">family</span><span class="op" id="3346396">(</span><span class="op" id="3346397">)</span>&nbsp;<span class="op" id="3346399">==</span>&nbsp;<span class="ident" id="3346402">syscall</span><span class="op" id="3346409">.</span><span class="ident" id="3346410">AF_INET</span><span class="op" id="3346417">)</span>&nbsp;<span class="op" id="3346419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346423">return</span>&nbsp;<span class="ident" id="3346430">syscall</span><span class="op" id="3346437">.</span><span class="ident" id="3346438">AF_INET</span><span class="op" id="3346445">,</span>&nbsp;<span class="builtintype" id="3346447">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346454">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346457">return</span>&nbsp;<span class="ident" id="3346464">syscall</span><span class="op" id="3346471">.</span><span class="ident" id="3346472">AF_INET6</span><span class="op" id="3346480">,</span>&nbsp;<span class="builtintype" id="3346482">false</span><br>
<span class="lineno"></span><span class="op" id="3346488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3346491">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3346527">func</span>&nbsp;<span class="ident" id="3346532">internetSocket</span><span class="op" id="3346546">(</span><span class="ident" id="3346547">net</span>&nbsp;<span class="builtintype" id="3346551">string</span><span class="op" id="3346557">,</span>&nbsp;<span class="ident" id="3346559">laddr</span><span class="op" id="3346564">,</span>&nbsp;<span class="ident" id="3346566">raddr</span>&nbsp;<span class="ident" id="3346572">sockaddr</span><span class="op" id="3346580">,</span>&nbsp;<span class="ident" id="3346582">deadline</span>&nbsp;<span class="ident" id="3346591">time</span><span class="op" id="3346595">.</span><span class="ident" id="3346596">Time</span><span class="op" id="3346600">,</span>&nbsp;<span class="ident" id="3346602">sotype</span><span class="op" id="3346608">,</span>&nbsp;<span class="ident" id="3346610">proto</span>&nbsp;<span class="builtintype" id="3346616">int</span><span class="op" id="3346619">,</span>&nbsp;<span class="ident" id="3346621">mode</span>&nbsp;<span class="builtintype" id="3346626">string</span><span class="op" id="3346632">)</span>&nbsp;<span class="op" id="3346634">(</span><span class="ident" id="3346635">fd</span>&nbsp;<span class="op" id="3346638">*</span><span class="ident" id="3346639">netFD</span><span class="op" id="3346644">,</span>&nbsp;<span class="ident" id="3346646">err</span>&nbsp;<span class="builtintype" id="3346650">error</span><span class="op" id="3346655">)</span>&nbsp;<span class="op" id="3346657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346660">family</span><span class="op" id="3346666">,</span>&nbsp;<span class="ident" id="3346668">ipv6only</span>&nbsp;<span class="op" id="3346677">:=</span>&nbsp;<span class="ident" id="3346680">favoriteAddrFamily</span><span class="op" id="3346698">(</span><span class="ident" id="3346699">net</span><span class="op" id="3346702">,</span>&nbsp;<span class="ident" id="3346704">laddr</span><span class="op" id="3346709">,</span>&nbsp;<span class="ident" id="3346711">raddr</span><span class="op" id="3346716">,</span>&nbsp;<span class="ident" id="3346718">mode</span><span class="op" id="3346722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346725">return</span>&nbsp;<span class="ident" id="3346732">socket</span><span class="op" id="3346738">(</span><span class="ident" id="3346739">net</span><span class="op" id="3346742">,</span>&nbsp;<span class="ident" id="3346744">family</span><span class="op" id="3346750">,</span>&nbsp;<span class="ident" id="3346752">sotype</span><span class="op" id="3346758">,</span>&nbsp;<span class="ident" id="3346760">proto</span><span class="op" id="3346765">,</span>&nbsp;<span class="ident" id="3346767">ipv6only</span><span class="op" id="3346775">,</span>&nbsp;<span class="ident" id="3346777">laddr</span><span class="op" id="3346782">,</span>&nbsp;<span class="ident" id="3346784">raddr</span><span class="op" id="3346789">,</span>&nbsp;<span class="ident" id="3346791">deadline</span><span class="op" id="3346799">)</span><br>
<span class="lineno"></span><span class="op" id="3346801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3346804">func</span>&nbsp;<span class="ident" id="3346809">ipToSockaddr</span><span class="op" id="3346821">(</span><span class="ident" id="3346822">family</span>&nbsp;<span class="builtintype" id="3346829">int</span><span class="op" id="3346832">,</span>&nbsp;<span class="ident" id="3346834">ip</span>&nbsp;<span class="ident" id="3346837">IP</span><span class="op" id="3346839">,</span>&nbsp;<span class="ident" id="3346841">port</span>&nbsp;<span class="builtintype" id="3346846">int</span><span class="op" id="3346849">,</span>&nbsp;<span class="ident" id="3346851">zone</span>&nbsp;<span class="builtintype" id="3346856">string</span><span class="op" id="3346862">)</span>&nbsp;<span class="op" id="3346864">(</span><span class="ident" id="3346865">syscall</span><span class="op" id="3346872">.</span><span class="ident" id="3346873">Sockaddr</span><span class="op" id="3346881">,</span>&nbsp;<span class="builtintype" id="3346883">error</span><span class="op" id="3346888">)</span>&nbsp;<span class="op" id="3346890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346893">switch</span>&nbsp;<span class="ident" id="3346900">family</span>&nbsp;<span class="op" id="3346907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346910">case</span>&nbsp;<span class="ident" id="3346915">syscall</span><span class="op" id="3346922">.</span><span class="ident" id="3346923">AF_INET</span><span class="op" id="3346930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346934">if</span>&nbsp;<span class="builtinfunc" id="3346937">len</span><span class="op" id="3346940">(</span><span class="ident" id="3346941">ip</span><span class="op" id="3346943">)</span>&nbsp;<span class="op" id="3346945">==</span>&nbsp;<span class="num" id="3346948">0</span>&nbsp;<span class="op" id="3346950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346955">ip</span>&nbsp;<span class="op" id="3346958">=</span>&nbsp;<span class="ident" id="3346960">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346975">if</span>&nbsp;<span class="ident" id="3346978">ip</span>&nbsp;<span class="op" id="3346981">=</span>&nbsp;<span class="ident" id="3346983">ip</span><span class="op" id="3346985">.</span><span class="ident" id="3346986">To4</span><span class="op" id="3346989">(</span><span class="op" id="3346990">)</span><span class="op" id="3346991">;</span>&nbsp;<span class="ident" id="3346993">ip</span>&nbsp;<span class="op" id="3346996">==</span>&nbsp;<span class="ident" id="3346999">nil</span>&nbsp;<span class="op" id="3347003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347008">return</span>&nbsp;<span class="ident" id="3347015">nil</span><span class="op" id="3347018">,</span>&nbsp;<span class="ident" id="3347020">InvalidAddrError</span><span class="op" id="3347036">(</span><span class="string" id="3347037">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3347055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347063">sa</span>&nbsp;<span class="op" id="3347066">:=</span>&nbsp;<span class="builtinfunc" id="3347069">new</span><span class="op" id="3347072">(</span><span class="ident" id="3347073">syscall</span><span class="op" id="3347080">.</span><span class="ident" id="3347081">SockaddrInet4</span><span class="op" id="3347094">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347098">for</span>&nbsp;<span class="ident" id="3347102">i</span>&nbsp;<span class="op" id="3347104">:=</span>&nbsp;<span class="num" id="3347107">0</span><span class="op" id="3347108">;</span>&nbsp;<span class="ident" id="3347110">i</span>&nbsp;<span class="op" id="3347112">&lt;</span>&nbsp;<span class="ident" id="3347114">IPv4len</span><span class="op" id="3347121">;</span>&nbsp;<span class="ident" id="3347123">i</span><span class="op" id="3347124">++</span>&nbsp;<span class="op" id="3347127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347132">sa</span><span class="op" id="3347134">.</span><span class="ident" id="3347135">Addr</span><span class="op" id="3347139">[</span><span class="ident" id="3347140">i</span><span class="op" id="3347141">]</span>&nbsp;<span class="op" id="3347143">=</span>&nbsp;<span class="ident" id="3347145">ip</span><span class="op" id="3347147">[</span><span class="ident" id="3347148">i</span><span class="op" id="3347149">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347157">sa</span><span class="op" id="3347159">.</span><span class="ident" id="3347160">Port</span>&nbsp;<span class="op" id="3347165">=</span>&nbsp;<span class="ident" id="3347167">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347174">return</span>&nbsp;<span class="ident" id="3347181">sa</span><span class="op" id="3347183">,</span>&nbsp;<span class="ident" id="3347185">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347190">case</span>&nbsp;<span class="ident" id="3347195">syscall</span><span class="op" id="3347202">.</span><span class="ident" id="3347203">AF_INET6</span><span class="op" id="3347211">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347215">if</span>&nbsp;<span class="builtinfunc" id="3347218">len</span><span class="op" id="3347221">(</span><span class="ident" id="3347222">ip</span><span class="op" id="3347224">)</span>&nbsp;<span class="op" id="3347226">==</span>&nbsp;<span class="num" id="3347229">0</span>&nbsp;<span class="op" id="3347231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347236">ip</span>&nbsp;<span class="op" id="3347239">=</span>&nbsp;<span class="ident" id="3347241">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3347256">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3347331">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3347402">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347473">if</span>&nbsp;<span class="ident" id="3347476">ip</span><span class="op" id="3347478">.</span><span class="ident" id="3347479">Equal</span><span class="op" id="3347484">(</span><span class="ident" id="3347485">IPv4zero</span><span class="op" id="3347493">)</span>&nbsp;<span class="op" id="3347495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347500">ip</span>&nbsp;<span class="op" id="3347503">=</span>&nbsp;<span class="ident" id="3347505">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347516">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347520">if</span>&nbsp;<span class="ident" id="3347523">ip</span>&nbsp;<span class="op" id="3347526">=</span>&nbsp;<span class="ident" id="3347528">ip</span><span class="op" id="3347530">.</span><span class="ident" id="3347531">To16</span><span class="op" id="3347535">(</span><span class="op" id="3347536">)</span><span class="op" id="3347537">;</span>&nbsp;<span class="ident" id="3347539">ip</span>&nbsp;<span class="op" id="3347542">==</span>&nbsp;<span class="ident" id="3347545">nil</span>&nbsp;<span class="op" id="3347549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347554">return</span>&nbsp;<span class="ident" id="3347561">nil</span><span class="op" id="3347564">,</span>&nbsp;<span class="ident" id="3347566">InvalidAddrError</span><span class="op" id="3347582">(</span><span class="string" id="3347583">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3347601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347609">sa</span>&nbsp;<span class="op" id="3347612">:=</span>&nbsp;<span class="builtinfunc" id="3347615">new</span><span class="op" id="3347618">(</span><span class="ident" id="3347619">syscall</span><span class="op" id="3347626">.</span><span class="ident" id="3347627">SockaddrInet6</span><span class="op" id="3347640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347644">for</span>&nbsp;<span class="ident" id="3347648">i</span>&nbsp;<span class="op" id="3347650">:=</span>&nbsp;<span class="num" id="3347653">0</span><span class="op" id="3347654">;</span>&nbsp;<span class="ident" id="3347656">i</span>&nbsp;<span class="op" id="3347658">&lt;</span>&nbsp;<span class="ident" id="3347660">IPv6len</span><span class="op" id="3347667">;</span>&nbsp;<span class="ident" id="3347669">i</span><span class="op" id="3347670">++</span>&nbsp;<span class="op" id="3347673">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347678">sa</span><span class="op" id="3347680">.</span><span class="ident" id="3347681">Addr</span><span class="op" id="3347685">[</span><span class="ident" id="3347686">i</span><span class="op" id="3347687">]</span>&nbsp;<span class="op" id="3347689">=</span>&nbsp;<span class="ident" id="3347691">ip</span><span class="op" id="3347693">[</span><span class="ident" id="3347694">i</span><span class="op" id="3347695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347703">sa</span><span class="op" id="3347705">.</span><span class="ident" id="3347706">Port</span>&nbsp;<span class="op" id="3347711">=</span>&nbsp;<span class="ident" id="3347713">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347720">sa</span><span class="op" id="3347722">.</span><span class="ident" id="3347723">ZoneId</span>&nbsp;<span class="op" id="3347730">=</span>&nbsp;<span class="builtintype" id="3347732">uint32</span><span class="op" id="3347738">(</span><span class="ident" id="3347739">zoneToInt</span><span class="op" id="3347748">(</span><span class="ident" id="3347749">zone</span><span class="op" id="3347753">)</span><span class="op" id="3347754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347758">return</span>&nbsp;<span class="ident" id="3347765">sa</span><span class="op" id="3347767">,</span>&nbsp;<span class="ident" id="3347769">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347777">return</span>&nbsp;<span class="ident" id="3347784">nil</span><span class="op" id="3347787">,</span>&nbsp;<span class="ident" id="3347789">InvalidAddrError</span><span class="op" id="3347805">(</span><span class="string" id="3347806">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3347832">)</span><br>
<span class="lineno"></span><span class="op" id="3347834">}</span>
</div>
</body>
</html>
