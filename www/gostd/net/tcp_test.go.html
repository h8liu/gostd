<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6697659">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6697714">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6697768">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6697819">package</span>&nbsp;<span class="ident" id="6697827">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6697832">import</span>&nbsp;<span class="op" id="6697839">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697842">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697849">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697855">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697866">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697877">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697885">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6697896">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6697903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6697906">func</span>&nbsp;<span class="ident" id="6697911">BenchmarkTCP4OneShot</span><span class="op" id="6697931">(</span><span class="ident" id="6697932">b</span>&nbsp;<span class="op" id="6697934">*</span><span class="ident" id="6697935">testing</span><span class="op" id="6697942">.</span><span class="ident" id="6697943">B</span><span class="op" id="6697944">)</span>&nbsp;<span class="op" id="6697946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6697949">benchmarkTCP</span><span class="op" id="6697961">(</span><span class="ident" id="6697962">b</span><span class="op" id="6697963">,</span>&nbsp;<span class="builtintype" id="6697965">false</span><span class="op" id="6697970">,</span>&nbsp;<span class="builtintype" id="6697972">false</span><span class="op" id="6697977">,</span>&nbsp;<span class="string" id="6697979">&#34;127.0.0.1:0&#34;</span><span class="op" id="6697992">)</span><br>
<span class="lineno"></span><span class="op" id="6697994">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6697997">func</span>&nbsp;<span class="ident" id="6698002">BenchmarkTCP4OneShotTimeout</span><span class="op" id="6698029">(</span><span class="ident" id="6698030">b</span>&nbsp;<span class="op" id="6698032">*</span><span class="ident" id="6698033">testing</span><span class="op" id="6698040">.</span><span class="ident" id="6698041">B</span><span class="op" id="6698042">)</span>&nbsp;<span class="op" id="6698044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698047">benchmarkTCP</span><span class="op" id="6698059">(</span><span class="ident" id="6698060">b</span><span class="op" id="6698061">,</span>&nbsp;<span class="builtintype" id="6698063">false</span><span class="op" id="6698068">,</span>&nbsp;<span class="builtintype" id="6698070">true</span><span class="op" id="6698074">,</span>&nbsp;<span class="string" id="6698076">&#34;127.0.0.1:0&#34;</span><span class="op" id="6698089">)</span><br>
<span class="lineno"></span><span class="op" id="6698091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6698094">func</span>&nbsp;<span class="ident" id="6698099">BenchmarkTCP4Persistent</span><span class="op" id="6698122">(</span><span class="ident" id="6698123">b</span>&nbsp;<span class="op" id="6698125">*</span><span class="ident" id="6698126">testing</span><span class="op" id="6698133">.</span><span class="ident" id="6698134">B</span><span class="op" id="6698135">)</span>&nbsp;<span class="op" id="6698137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698140">benchmarkTCP</span><span class="op" id="6698152">(</span><span class="ident" id="6698153">b</span><span class="op" id="6698154">,</span>&nbsp;<span class="builtintype" id="6698156">true</span><span class="op" id="6698160">,</span>&nbsp;<span class="builtintype" id="6698162">false</span><span class="op" id="6698167">,</span>&nbsp;<span class="string" id="6698169">&#34;127.0.0.1:0&#34;</span><span class="op" id="6698182">)</span><br>
<span class="lineno"></span><span class="op" id="6698184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6698187">func</span>&nbsp;<span class="ident" id="6698192">BenchmarkTCP4PersistentTimeout</span><span class="op" id="6698222">(</span><span class="ident" id="6698223">b</span>&nbsp;<span class="op" id="6698225">*</span><span class="ident" id="6698226">testing</span><span class="op" id="6698233">.</span><span class="ident" id="6698234">B</span><span class="op" id="6698235">)</span>&nbsp;<span class="op" id="6698237">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698240">benchmarkTCP</span><span class="op" id="6698252">(</span><span class="ident" id="6698253">b</span><span class="op" id="6698254">,</span>&nbsp;<span class="builtintype" id="6698256">true</span><span class="op" id="6698260">,</span>&nbsp;<span class="builtintype" id="6698262">true</span><span class="op" id="6698266">,</span>&nbsp;<span class="string" id="6698268">&#34;127.0.0.1:0&#34;</span><span class="op" id="6698281">)</span><br>
<span class="lineno"></span><span class="op" id="6698283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6698286">func</span>&nbsp;<span class="ident" id="6698291">BenchmarkTCP6OneShot</span><span class="op" id="6698311">(</span><span class="ident" id="6698312">b</span>&nbsp;<span class="op" id="6698314">*</span><span class="ident" id="6698315">testing</span><span class="op" id="6698322">.</span><span class="ident" id="6698323">B</span><span class="op" id="6698324">)</span>&nbsp;<span class="op" id="6698326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6698329">if</span>&nbsp;<span class="op" id="6698332">!</span><span class="ident" id="6698333">supportsIPv6</span>&nbsp;<span class="op" id="6698346">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698350">b</span><span class="op" id="6698351">.</span><span class="ident" id="6698352">Skip</span><span class="op" id="6698356">(</span><span class="string" id="6698357">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6698380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6698383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698386">benchmarkTCP</span><span class="op" id="6698398">(</span><span class="ident" id="6698399">b</span><span class="op" id="6698400">,</span>&nbsp;<span class="builtintype" id="6698402">false</span><span class="op" id="6698407">,</span>&nbsp;<span class="builtintype" id="6698409">false</span><span class="op" id="6698414">,</span>&nbsp;<span class="string" id="6698416">&#34;[::1]:0&#34;</span><span class="op" id="6698425">)</span><br>
<span class="lineno"></span><span class="op" id="6698427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6698430">func</span>&nbsp;<span class="ident" id="6698435">BenchmarkTCP6OneShotTimeout</span><span class="op" id="6698462">(</span><span class="ident" id="6698463">b</span>&nbsp;<span class="op" id="6698465">*</span><span class="ident" id="6698466">testing</span><span class="op" id="6698473">.</span><span class="ident" id="6698474">B</span><span class="op" id="6698475">)</span>&nbsp;<span class="op" id="6698477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6698480">if</span>&nbsp;<span class="op" id="6698483">!</span><span class="ident" id="6698484">supportsIPv6</span>&nbsp;<span class="op" id="6698497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698501">b</span><span class="op" id="6698502">.</span><span class="ident" id="6698503">Skip</span><span class="op" id="6698507">(</span><span class="string" id="6698508">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6698531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6698534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698537">benchmarkTCP</span><span class="op" id="6698549">(</span><span class="ident" id="6698550">b</span><span class="op" id="6698551">,</span>&nbsp;<span class="builtintype" id="6698553">false</span><span class="op" id="6698558">,</span>&nbsp;<span class="builtintype" id="6698560">true</span><span class="op" id="6698564">,</span>&nbsp;<span class="string" id="6698566">&#34;[::1]:0&#34;</span><span class="op" id="6698575">)</span><br>
<span class="lineno">45</span><span class="op" id="6698577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6698580">func</span>&nbsp;<span class="ident" id="6698585">BenchmarkTCP6Persistent</span><span class="op" id="6698608">(</span><span class="ident" id="6698609">b</span>&nbsp;<span class="op" id="6698611">*</span><span class="ident" id="6698612">testing</span><span class="op" id="6698619">.</span><span class="ident" id="6698620">B</span><span class="op" id="6698621">)</span>&nbsp;<span class="op" id="6698623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6698626">if</span>&nbsp;<span class="op" id="6698629">!</span><span class="ident" id="6698630">supportsIPv6</span>&nbsp;<span class="op" id="6698643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698647">b</span><span class="op" id="6698648">.</span><span class="ident" id="6698649">Skip</span><span class="op" id="6698653">(</span><span class="string" id="6698654">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6698677">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6698680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698683">benchmarkTCP</span><span class="op" id="6698695">(</span><span class="ident" id="6698696">b</span><span class="op" id="6698697">,</span>&nbsp;<span class="builtintype" id="6698699">true</span><span class="op" id="6698703">,</span>&nbsp;<span class="builtintype" id="6698705">false</span><span class="op" id="6698710">,</span>&nbsp;<span class="string" id="6698712">&#34;[::1]:0&#34;</span><span class="op" id="6698721">)</span><br>
<span class="lineno"></span><span class="op" id="6698723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6698726">func</span>&nbsp;<span class="ident" id="6698731">BenchmarkTCP6PersistentTimeout</span><span class="op" id="6698761">(</span><span class="ident" id="6698762">b</span>&nbsp;<span class="op" id="6698764">*</span><span class="ident" id="6698765">testing</span><span class="op" id="6698772">.</span><span class="ident" id="6698773">B</span><span class="op" id="6698774">)</span>&nbsp;<span class="op" id="6698776">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6698779">if</span>&nbsp;<span class="op" id="6698782">!</span><span class="ident" id="6698783">supportsIPv6</span>&nbsp;<span class="op" id="6698796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698800">b</span><span class="op" id="6698801">.</span><span class="ident" id="6698802">Skip</span><span class="op" id="6698806">(</span><span class="string" id="6698807">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6698830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6698833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698836">benchmarkTCP</span><span class="op" id="6698848">(</span><span class="ident" id="6698849">b</span><span class="op" id="6698850">,</span>&nbsp;<span class="builtintype" id="6698852">true</span><span class="op" id="6698856">,</span>&nbsp;<span class="builtintype" id="6698858">true</span><span class="op" id="6698862">,</span>&nbsp;<span class="string" id="6698864">&#34;[::1]:0&#34;</span><span class="op" id="6698873">)</span><br>
<span class="lineno"></span><span class="op" id="6698875">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6698878">func</span>&nbsp;<span class="ident" id="6698883">benchmarkTCP</span><span class="op" id="6698895">(</span><span class="ident" id="6698896">b</span>&nbsp;<span class="op" id="6698898">*</span><span class="ident" id="6698899">testing</span><span class="op" id="6698906">.</span><span class="ident" id="6698907">B</span><span class="op" id="6698908">,</span>&nbsp;<span class="ident" id="6698910">persistent</span><span class="op" id="6698920">,</span>&nbsp;<span class="ident" id="6698922">timeout</span>&nbsp;<span class="builtintype" id="6698930">bool</span><span class="op" id="6698934">,</span>&nbsp;<span class="ident" id="6698936">laddr</span>&nbsp;<span class="builtintype" id="6698942">string</span><span class="op" id="6698948">)</span>&nbsp;<span class="op" id="6698950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6698953">const</span>&nbsp;<span class="ident" id="6698959">msgLen</span>&nbsp;<span class="op" id="6698966">=</span>&nbsp;<span class="num" id="6698968">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698973">conns</span>&nbsp;<span class="op" id="6698979">:=</span>&nbsp;<span class="ident" id="6698982">b</span><span class="op" id="6698983">.</span><span class="ident" id="6698984">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6698987">numConcurrent</span>&nbsp;<span class="op" id="6699001">:=</span>&nbsp;<span class="ident" id="6699004">runtime</span><span class="op" id="6699011">.</span><span class="ident" id="6699012">GOMAXPROCS</span><span class="op" id="6699022">(</span><span class="op" id="6699023">-</span><span class="num" id="6699024">1</span><span class="op" id="6699025">)</span>&nbsp;<span class="op" id="6699027">*</span>&nbsp;<span class="num" id="6699029">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699032">msgs</span>&nbsp;<span class="op" id="6699037">:=</span>&nbsp;<span class="num" id="6699040">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699043">if</span>&nbsp;<span class="ident" id="6699046">persistent</span>&nbsp;<span class="op" id="6699057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699061">conns</span>&nbsp;<span class="op" id="6699067">=</span>&nbsp;<span class="ident" id="6699069">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699085">msgs</span>&nbsp;<span class="op" id="6699090">=</span>&nbsp;<span class="ident" id="6699092">b</span><span class="op" id="6699093">.</span><span class="ident" id="6699094">N</span>&nbsp;<span class="op" id="6699096">/</span>&nbsp;<span class="ident" id="6699098">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699106">if</span>&nbsp;<span class="ident" id="6699109">msgs</span>&nbsp;<span class="op" id="6699114">==</span>&nbsp;<span class="num" id="6699117">0</span>&nbsp;<span class="op" id="6699119">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699124">msgs</span>&nbsp;<span class="op" id="6699129">=</span>&nbsp;<span class="num" id="6699131">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699139">if</span>&nbsp;<span class="ident" id="6699142">conns</span>&nbsp;<span class="op" id="6699148">&gt;</span>&nbsp;<span class="ident" id="6699150">b</span><span class="op" id="6699151">.</span><span class="ident" id="6699152">N</span>&nbsp;<span class="op" id="6699154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699159">conns</span>&nbsp;<span class="op" id="6699165">=</span>&nbsp;<span class="ident" id="6699167">b</span><span class="op" id="6699168">.</span><span class="ident" id="6699169">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699173">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699179">sendMsg</span>&nbsp;<span class="op" id="6699187">:=</span>&nbsp;<span class="keyword" id="6699190">func</span><span class="op" id="6699194">(</span><span class="ident" id="6699195">c</span>&nbsp;<span class="ident" id="6699197">Conn</span><span class="op" id="6699201">,</span>&nbsp;<span class="ident" id="6699203">buf</span>&nbsp;<span class="op" id="6699207">[</span><span class="op" id="6699208">]</span><span class="builtintype" id="6699209">byte</span><span class="op" id="6699213">)</span>&nbsp;<span class="builtintype" id="6699215">bool</span>&nbsp;<span class="op" id="6699220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699224">n</span><span class="op" id="6699225">,</span>&nbsp;<span class="ident" id="6699227">err</span>&nbsp;<span class="op" id="6699231">:=</span>&nbsp;<span class="ident" id="6699234">c</span><span class="op" id="6699235">.</span><span class="ident" id="6699236">Write</span><span class="op" id="6699241">(</span><span class="ident" id="6699242">buf</span><span class="op" id="6699245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699249">if</span>&nbsp;<span class="ident" id="6699252">n</span>&nbsp;<span class="op" id="6699254">!=</span>&nbsp;<span class="builtinfunc" id="6699257">len</span><span class="op" id="6699260">(</span><span class="ident" id="6699261">buf</span><span class="op" id="6699264">)</span>&nbsp;<span class="op" id="6699266">||</span>&nbsp;<span class="ident" id="6699269">err</span>&nbsp;<span class="op" id="6699273">!=</span>&nbsp;<span class="ident" id="6699276">nil</span>&nbsp;<span class="op" id="6699280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699285">b</span><span class="op" id="6699286">.</span><span class="ident" id="6699287">Logf</span><span class="op" id="6699291">(</span><span class="string" id="6699292">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6699310">,</span>&nbsp;<span class="ident" id="6699312">err</span><span class="op" id="6699315">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699320">return</span>&nbsp;<span class="builtintype" id="6699327">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699339">return</span>&nbsp;<span class="builtintype" id="6699346">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699355">recvMsg</span>&nbsp;<span class="op" id="6699363">:=</span>&nbsp;<span class="keyword" id="6699366">func</span><span class="op" id="6699370">(</span><span class="ident" id="6699371">c</span>&nbsp;<span class="ident" id="6699373">Conn</span><span class="op" id="6699377">,</span>&nbsp;<span class="ident" id="6699379">buf</span>&nbsp;<span class="op" id="6699383">[</span><span class="op" id="6699384">]</span><span class="builtintype" id="6699385">byte</span><span class="op" id="6699389">)</span>&nbsp;<span class="builtintype" id="6699391">bool</span>&nbsp;<span class="op" id="6699396">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699400">for</span>&nbsp;<span class="ident" id="6699404">read</span>&nbsp;<span class="op" id="6699409">:=</span>&nbsp;<span class="num" id="6699412">0</span><span class="op" id="6699413">;</span>&nbsp;<span class="ident" id="6699415">read</span>&nbsp;<span class="op" id="6699420">!=</span>&nbsp;<span class="builtinfunc" id="6699423">len</span><span class="op" id="6699426">(</span><span class="ident" id="6699427">buf</span><span class="op" id="6699430">)</span><span class="op" id="6699431">;</span>&nbsp;<span class="op" id="6699433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699438">n</span><span class="op" id="6699439">,</span>&nbsp;<span class="ident" id="6699441">err</span>&nbsp;<span class="op" id="6699445">:=</span>&nbsp;<span class="ident" id="6699448">c</span><span class="op" id="6699449">.</span><span class="ident" id="6699450">Read</span><span class="op" id="6699454">(</span><span class="ident" id="6699455">buf</span><span class="op" id="6699458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699463">read</span>&nbsp;<span class="op" id="6699468">+=</span>&nbsp;<span class="ident" id="6699471">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699476">if</span>&nbsp;<span class="ident" id="6699479">err</span>&nbsp;<span class="op" id="6699483">!=</span>&nbsp;<span class="ident" id="6699486">nil</span>&nbsp;<span class="op" id="6699490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699496">b</span><span class="op" id="6699497">.</span><span class="ident" id="6699498">Logf</span><span class="op" id="6699502">(</span><span class="string" id="6699503">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6699520">,</span>&nbsp;<span class="ident" id="6699522">err</span><span class="op" id="6699525">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699531">return</span>&nbsp;<span class="builtintype" id="6699538">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699555">return</span>&nbsp;<span class="builtintype" id="6699562">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699568">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699571">ln</span><span class="op" id="6699573">,</span>&nbsp;<span class="ident" id="6699575">err</span>&nbsp;<span class="op" id="6699579">:=</span>&nbsp;<span class="ident" id="6699582">Listen</span><span class="op" id="6699588">(</span><span class="string" id="6699589">&#34;tcp&#34;</span><span class="op" id="6699594">,</span>&nbsp;<span class="ident" id="6699596">laddr</span><span class="op" id="6699601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699604">if</span>&nbsp;<span class="ident" id="6699607">err</span>&nbsp;<span class="op" id="6699611">!=</span>&nbsp;<span class="ident" id="6699614">nil</span>&nbsp;<span class="op" id="6699618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699622">b</span><span class="op" id="6699623">.</span><span class="ident" id="6699624">Fatalf</span><span class="op" id="6699630">(</span><span class="string" id="6699631">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6699650">,</span>&nbsp;<span class="ident" id="6699652">err</span><span class="op" id="6699655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699661">defer</span>&nbsp;<span class="ident" id="6699667">ln</span><span class="op" id="6699669">.</span><span class="ident" id="6699670">Close</span><span class="op" id="6699675">(</span><span class="op" id="6699676">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699679">serverSem</span>&nbsp;<span class="op" id="6699689">:=</span>&nbsp;<span class="builtinfunc" id="6699692">make</span><span class="op" id="6699696">(</span><span class="keyword" id="6699697">chan</span>&nbsp;<span class="builtintype" id="6699702">bool</span><span class="op" id="6699706">,</span>&nbsp;<span class="ident" id="6699708">numConcurrent</span><span class="op" id="6699721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6699724">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699738">go</span>&nbsp;<span class="keyword" id="6699741">func</span><span class="op" id="6699745">(</span><span class="op" id="6699746">)</span>&nbsp;<span class="op" id="6699748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699752">for</span>&nbsp;<span class="op" id="6699756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699761">c</span><span class="op" id="6699762">,</span>&nbsp;<span class="ident" id="6699764">err</span>&nbsp;<span class="op" id="6699768">:=</span>&nbsp;<span class="ident" id="6699771">ln</span><span class="op" id="6699773">.</span><span class="ident" id="6699774">Accept</span><span class="op" id="6699780">(</span><span class="op" id="6699781">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699786">if</span>&nbsp;<span class="ident" id="6699789">err</span>&nbsp;<span class="op" id="6699793">!=</span>&nbsp;<span class="ident" id="6699796">nil</span>&nbsp;<span class="op" id="6699800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699806">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699820">serverSem</span>&nbsp;<span class="op" id="6699830">&lt;-</span>&nbsp;<span class="builtintype" id="6699833">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6699841">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699866">go</span>&nbsp;<span class="keyword" id="6699869">func</span><span class="op" id="6699873">(</span><span class="ident" id="6699874">c</span>&nbsp;<span class="ident" id="6699876">Conn</span><span class="op" id="6699880">)</span>&nbsp;<span class="op" id="6699882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699888">defer</span>&nbsp;<span class="keyword" id="6699894">func</span><span class="op" id="6699898">(</span><span class="op" id="6699899">)</span>&nbsp;<span class="op" id="6699901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699908">c</span><span class="op" id="6699909">.</span><span class="ident" id="6699910">Close</span><span class="op" id="6699915">(</span><span class="op" id="6699916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699923">&lt;-</span><span class="ident" id="6699925">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6699939">}</span><span class="op" id="6699940">(</span><span class="op" id="6699941">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6699947">if</span>&nbsp;<span class="ident" id="6699950">timeout</span>&nbsp;<span class="op" id="6699958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6699965">c</span><span class="op" id="6699966">.</span><span class="ident" id="6699967">SetDeadline</span><span class="op" id="6699978">(</span><span class="ident" id="6699979">time</span><span class="op" id="6699983">.</span><span class="ident" id="6699984">Now</span><span class="op" id="6699987">(</span><span class="op" id="6699988">)</span><span class="op" id="6699989">.</span><span class="ident" id="6699990">Add</span><span class="op" id="6699993">(</span><span class="ident" id="6699994">time</span><span class="op" id="6699998">.</span><span class="ident" id="6699999">Hour</span><span class="op" id="6700003">)</span><span class="op" id="6700004">)</span>&nbsp;<span class="comment" id="6700006">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700041">var</span>&nbsp;<span class="ident" id="6700045">buf</span>&nbsp;<span class="op" id="6700049">[</span><span class="ident" id="6700050">msgLen</span><span class="op" id="6700056">]</span><span class="builtintype" id="6700057">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700066">for</span>&nbsp;<span class="ident" id="6700070">m</span>&nbsp;<span class="op" id="6700072">:=</span>&nbsp;<span class="num" id="6700075">0</span><span class="op" id="6700076">;</span>&nbsp;<span class="ident" id="6700078">m</span>&nbsp;<span class="op" id="6700080">&lt;</span>&nbsp;<span class="ident" id="6700082">msgs</span><span class="op" id="6700086">;</span>&nbsp;<span class="ident" id="6700088">m</span><span class="op" id="6700089">++</span>&nbsp;<span class="op" id="6700092">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700099">if</span>&nbsp;<span class="op" id="6700102">!</span><span class="ident" id="6700103">recvMsg</span><span class="op" id="6700110">(</span><span class="ident" id="6700111">c</span><span class="op" id="6700112">,</span>&nbsp;<span class="ident" id="6700114">buf</span><span class="op" id="6700117">[</span><span class="op" id="6700118">:</span><span class="op" id="6700119">]</span><span class="op" id="6700120">)</span>&nbsp;<span class="op" id="6700122">||</span>&nbsp;<span class="op" id="6700125">!</span><span class="ident" id="6700126">sendMsg</span><span class="op" id="6700133">(</span><span class="ident" id="6700134">c</span><span class="op" id="6700135">,</span>&nbsp;<span class="ident" id="6700137">buf</span><span class="op" id="6700140">[</span><span class="op" id="6700141">:</span><span class="op" id="6700142">]</span><span class="op" id="6700143">)</span>&nbsp;<span class="op" id="6700145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700153">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700175">}</span><span class="op" id="6700176">(</span><span class="ident" id="6700177">c</span><span class="op" id="6700178">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700185">}</span><span class="op" id="6700186">(</span><span class="op" id="6700187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700190">clientSem</span>&nbsp;<span class="op" id="6700200">:=</span>&nbsp;<span class="builtinfunc" id="6700203">make</span><span class="op" id="6700207">(</span><span class="keyword" id="6700208">chan</span>&nbsp;<span class="builtintype" id="6700213">bool</span><span class="op" id="6700217">,</span>&nbsp;<span class="ident" id="6700219">numConcurrent</span><span class="op" id="6700232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700235">for</span>&nbsp;<span class="ident" id="6700239">i</span>&nbsp;<span class="op" id="6700241">:=</span>&nbsp;<span class="num" id="6700244">0</span><span class="op" id="6700245">;</span>&nbsp;<span class="ident" id="6700247">i</span>&nbsp;<span class="op" id="6700249">&lt;</span>&nbsp;<span class="ident" id="6700251">conns</span><span class="op" id="6700256">;</span>&nbsp;<span class="ident" id="6700258">i</span><span class="op" id="6700259">++</span>&nbsp;<span class="op" id="6700262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700266">clientSem</span>&nbsp;<span class="op" id="6700276">&lt;-</span>&nbsp;<span class="builtintype" id="6700279">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6700286">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700310">go</span>&nbsp;<span class="keyword" id="6700313">func</span><span class="op" id="6700317">(</span><span class="op" id="6700318">)</span>&nbsp;<span class="op" id="6700320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700325">defer</span>&nbsp;<span class="keyword" id="6700331">func</span><span class="op" id="6700335">(</span><span class="op" id="6700336">)</span>&nbsp;<span class="op" id="6700338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700344">&lt;-</span><span class="ident" id="6700346">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700359">}</span><span class="op" id="6700360">(</span><span class="op" id="6700361">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700366">c</span><span class="op" id="6700367">,</span>&nbsp;<span class="ident" id="6700369">err</span>&nbsp;<span class="op" id="6700373">:=</span>&nbsp;<span class="ident" id="6700376">Dial</span><span class="op" id="6700380">(</span><span class="string" id="6700381">&#34;tcp&#34;</span><span class="op" id="6700386">,</span>&nbsp;<span class="ident" id="6700388">ln</span><span class="op" id="6700390">.</span><span class="ident" id="6700391">Addr</span><span class="op" id="6700395">(</span><span class="op" id="6700396">)</span><span class="op" id="6700397">.</span><span class="ident" id="6700398">String</span><span class="op" id="6700404">(</span><span class="op" id="6700405">)</span><span class="op" id="6700406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700411">if</span>&nbsp;<span class="ident" id="6700414">err</span>&nbsp;<span class="op" id="6700418">!=</span>&nbsp;<span class="ident" id="6700421">nil</span>&nbsp;<span class="op" id="6700425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700431">b</span><span class="op" id="6700432">.</span><span class="ident" id="6700433">Logf</span><span class="op" id="6700437">(</span><span class="string" id="6700438">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6700455">,</span>&nbsp;<span class="ident" id="6700457">err</span><span class="op" id="6700460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700466">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700476">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700481">defer</span>&nbsp;<span class="ident" id="6700487">c</span><span class="op" id="6700488">.</span><span class="ident" id="6700489">Close</span><span class="op" id="6700494">(</span><span class="op" id="6700495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700500">if</span>&nbsp;<span class="ident" id="6700503">timeout</span>&nbsp;<span class="op" id="6700511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700517">c</span><span class="op" id="6700518">.</span><span class="ident" id="6700519">SetDeadline</span><span class="op" id="6700530">(</span><span class="ident" id="6700531">time</span><span class="op" id="6700535">.</span><span class="ident" id="6700536">Now</span><span class="op" id="6700539">(</span><span class="op" id="6700540">)</span><span class="op" id="6700541">.</span><span class="ident" id="6700542">Add</span><span class="op" id="6700545">(</span><span class="ident" id="6700546">time</span><span class="op" id="6700550">.</span><span class="ident" id="6700551">Hour</span><span class="op" id="6700555">)</span><span class="op" id="6700556">)</span>&nbsp;<span class="comment" id="6700558">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700591">var</span>&nbsp;<span class="ident" id="6700595">buf</span>&nbsp;<span class="op" id="6700599">[</span><span class="ident" id="6700600">msgLen</span><span class="op" id="6700606">]</span><span class="builtintype" id="6700607">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700615">for</span>&nbsp;<span class="ident" id="6700619">m</span>&nbsp;<span class="op" id="6700621">:=</span>&nbsp;<span class="num" id="6700624">0</span><span class="op" id="6700625">;</span>&nbsp;<span class="ident" id="6700627">m</span>&nbsp;<span class="op" id="6700629">&lt;</span>&nbsp;<span class="ident" id="6700631">msgs</span><span class="op" id="6700635">;</span>&nbsp;<span class="ident" id="6700637">m</span><span class="op" id="6700638">++</span>&nbsp;<span class="op" id="6700641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700647">if</span>&nbsp;<span class="op" id="6700650">!</span><span class="ident" id="6700651">sendMsg</span><span class="op" id="6700658">(</span><span class="ident" id="6700659">c</span><span class="op" id="6700660">,</span>&nbsp;<span class="ident" id="6700662">buf</span><span class="op" id="6700665">[</span><span class="op" id="6700666">:</span><span class="op" id="6700667">]</span><span class="op" id="6700668">)</span>&nbsp;<span class="op" id="6700670">||</span>&nbsp;<span class="op" id="6700673">!</span><span class="ident" id="6700674">recvMsg</span><span class="op" id="6700681">(</span><span class="ident" id="6700682">c</span><span class="op" id="6700683">,</span>&nbsp;<span class="ident" id="6700685">buf</span><span class="op" id="6700688">[</span><span class="op" id="6700689">:</span><span class="op" id="6700690">]</span><span class="op" id="6700691">)</span>&nbsp;<span class="op" id="6700693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700715">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700719">}</span><span class="op" id="6700720">(</span><span class="op" id="6700721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700727">for</span>&nbsp;<span class="ident" id="6700731">i</span>&nbsp;<span class="op" id="6700733">:=</span>&nbsp;<span class="num" id="6700736">0</span><span class="op" id="6700737">;</span>&nbsp;<span class="ident" id="6700739">i</span>&nbsp;<span class="op" id="6700741">&lt;</span>&nbsp;<span class="ident" id="6700743">numConcurrent</span><span class="op" id="6700756">;</span>&nbsp;<span class="ident" id="6700758">i</span><span class="op" id="6700759">++</span>&nbsp;<span class="op" id="6700762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700766">clientSem</span>&nbsp;<span class="op" id="6700776">&lt;-</span>&nbsp;<span class="builtintype" id="6700779">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700786">serverSem</span>&nbsp;<span class="op" id="6700796">&lt;-</span>&nbsp;<span class="builtintype" id="6700799">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6700805">}</span><br>
<span class="lineno"></span><span class="op" id="6700807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6700810">func</span>&nbsp;<span class="ident" id="6700815">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="6700847">(</span><span class="ident" id="6700848">b</span>&nbsp;<span class="op" id="6700850">*</span><span class="ident" id="6700851">testing</span><span class="op" id="6700858">.</span><span class="ident" id="6700859">B</span><span class="op" id="6700860">)</span>&nbsp;<span class="op" id="6700862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700865">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6700896">(</span><span class="ident" id="6700897">b</span><span class="op" id="6700898">,</span>&nbsp;<span class="string" id="6700900">&#34;127.0.0.1:0&#34;</span><span class="op" id="6700913">)</span><br>
<span class="lineno">160</span><span class="op" id="6700915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6700918">func</span>&nbsp;<span class="ident" id="6700923">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="6700955">(</span><span class="ident" id="6700956">b</span>&nbsp;<span class="op" id="6700958">*</span><span class="ident" id="6700959">testing</span><span class="op" id="6700966">.</span><span class="ident" id="6700967">B</span><span class="op" id="6700968">)</span>&nbsp;<span class="op" id="6700970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6700973">if</span>&nbsp;<span class="op" id="6700976">!</span><span class="ident" id="6700977">supportsIPv6</span>&nbsp;<span class="op" id="6700990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6700994">b</span><span class="op" id="6700995">.</span><span class="ident" id="6700996">Skip</span><span class="op" id="6701000">(</span><span class="string" id="6701001">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6701024">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6701027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701030">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6701061">(</span><span class="ident" id="6701062">b</span><span class="op" id="6701063">,</span>&nbsp;<span class="string" id="6701065">&#34;[::1]:0&#34;</span><span class="op" id="6701074">)</span><br>
<span class="lineno"></span><span class="op" id="6701076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6701079">func</span>&nbsp;<span class="ident" id="6701084">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6701115">(</span><span class="ident" id="6701116">b</span>&nbsp;<span class="op" id="6701118">*</span><span class="ident" id="6701119">testing</span><span class="op" id="6701126">.</span><span class="ident" id="6701127">B</span><span class="op" id="6701128">,</span>&nbsp;<span class="ident" id="6701130">laddr</span>&nbsp;<span class="builtintype" id="6701136">string</span><span class="op" id="6701142">)</span>&nbsp;<span class="op" id="6701144">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6701147">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6701205">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6701288">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6701370">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701421">b</span><span class="op" id="6701422">.</span><span class="ident" id="6701423">StopTimer</span><span class="op" id="6701432">(</span><span class="op" id="6701433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701437">P</span>&nbsp;<span class="op" id="6701439">:=</span>&nbsp;<span class="ident" id="6701442">runtime</span><span class="op" id="6701449">.</span><span class="ident" id="6701450">GOMAXPROCS</span><span class="op" id="6701460">(</span><span class="num" id="6701461">0</span><span class="op" id="6701462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701465">N</span>&nbsp;<span class="op" id="6701467">:=</span>&nbsp;<span class="ident" id="6701470">b</span><span class="op" id="6701471">.</span><span class="ident" id="6701472">N</span>&nbsp;<span class="op" id="6701474">/</span>&nbsp;<span class="ident" id="6701476">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701479">W</span>&nbsp;<span class="op" id="6701481">:=</span>&nbsp;<span class="num" id="6701484">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6701491">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701530">clients</span>&nbsp;<span class="op" id="6701538">:=</span>&nbsp;<span class="builtinfunc" id="6701541">make</span><span class="op" id="6701545">(</span><span class="op" id="6701546">[</span><span class="op" id="6701547">]</span><span class="ident" id="6701548">Conn</span><span class="op" id="6701552">,</span>&nbsp;<span class="ident" id="6701554">P</span><span class="op" id="6701555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701558">servers</span>&nbsp;<span class="op" id="6701566">:=</span>&nbsp;<span class="builtinfunc" id="6701569">make</span><span class="op" id="6701573">(</span><span class="op" id="6701574">[</span><span class="op" id="6701575">]</span><span class="ident" id="6701576">Conn</span><span class="op" id="6701580">,</span>&nbsp;<span class="ident" id="6701582">P</span><span class="op" id="6701583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701586">ln</span><span class="op" id="6701588">,</span>&nbsp;<span class="ident" id="6701590">err</span>&nbsp;<span class="op" id="6701594">:=</span>&nbsp;<span class="ident" id="6701597">Listen</span><span class="op" id="6701603">(</span><span class="string" id="6701604">&#34;tcp&#34;</span><span class="op" id="6701609">,</span>&nbsp;<span class="ident" id="6701611">laddr</span><span class="op" id="6701616">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701619">if</span>&nbsp;<span class="ident" id="6701622">err</span>&nbsp;<span class="op" id="6701626">!=</span>&nbsp;<span class="ident" id="6701629">nil</span>&nbsp;<span class="op" id="6701633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701637">b</span><span class="op" id="6701638">.</span><span class="ident" id="6701639">Fatalf</span><span class="op" id="6701645">(</span><span class="string" id="6701646">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6701665">,</span>&nbsp;<span class="ident" id="6701667">err</span><span class="op" id="6701670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6701673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701676">defer</span>&nbsp;<span class="ident" id="6701682">ln</span><span class="op" id="6701684">.</span><span class="ident" id="6701685">Close</span><span class="op" id="6701690">(</span><span class="op" id="6701691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701694">done</span>&nbsp;<span class="op" id="6701699">:=</span>&nbsp;<span class="builtinfunc" id="6701702">make</span><span class="op" id="6701706">(</span><span class="keyword" id="6701707">chan</span>&nbsp;<span class="builtintype" id="6701712">bool</span><span class="op" id="6701716">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701719">go</span>&nbsp;<span class="keyword" id="6701722">func</span><span class="op" id="6701726">(</span><span class="op" id="6701727">)</span>&nbsp;<span class="op" id="6701729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701733">for</span>&nbsp;<span class="ident" id="6701737">p</span>&nbsp;<span class="op" id="6701739">:=</span>&nbsp;<span class="num" id="6701742">0</span><span class="op" id="6701743">;</span>&nbsp;<span class="ident" id="6701745">p</span>&nbsp;<span class="op" id="6701747">&lt;</span>&nbsp;<span class="ident" id="6701749">P</span><span class="op" id="6701750">;</span>&nbsp;<span class="ident" id="6701752">p</span><span class="op" id="6701753">++</span>&nbsp;<span class="op" id="6701756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701761">s</span><span class="op" id="6701762">,</span>&nbsp;<span class="ident" id="6701764">err</span>&nbsp;<span class="op" id="6701768">:=</span>&nbsp;<span class="ident" id="6701771">ln</span><span class="op" id="6701773">.</span><span class="ident" id="6701774">Accept</span><span class="op" id="6701780">(</span><span class="op" id="6701781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701786">if</span>&nbsp;<span class="ident" id="6701789">err</span>&nbsp;<span class="op" id="6701793">!=</span>&nbsp;<span class="ident" id="6701796">nil</span>&nbsp;<span class="op" id="6701800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701806">b</span><span class="op" id="6701807">.</span><span class="ident" id="6701808">Errorf</span><span class="op" id="6701814">(</span><span class="string" id="6701815">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6701834">,</span>&nbsp;<span class="ident" id="6701836">err</span><span class="op" id="6701839">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701845">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6701855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701860">servers</span><span class="op" id="6701867">[</span><span class="ident" id="6701868">p</span><span class="op" id="6701869">]</span>&nbsp;<span class="op" id="6701871">=</span>&nbsp;<span class="ident" id="6701873">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6701877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701881">done</span>&nbsp;<span class="op" id="6701886">&lt;-</span>&nbsp;<span class="builtintype" id="6701889">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6701895">}</span><span class="op" id="6701896">(</span><span class="op" id="6701897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701900">for</span>&nbsp;<span class="ident" id="6701904">p</span>&nbsp;<span class="op" id="6701906">:=</span>&nbsp;<span class="num" id="6701909">0</span><span class="op" id="6701910">;</span>&nbsp;<span class="ident" id="6701912">p</span>&nbsp;<span class="op" id="6701914">&lt;</span>&nbsp;<span class="ident" id="6701916">P</span><span class="op" id="6701917">;</span>&nbsp;<span class="ident" id="6701919">p</span><span class="op" id="6701920">++</span>&nbsp;<span class="op" id="6701923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701927">c</span><span class="op" id="6701928">,</span>&nbsp;<span class="ident" id="6701930">err</span>&nbsp;<span class="op" id="6701934">:=</span>&nbsp;<span class="ident" id="6701937">Dial</span><span class="op" id="6701941">(</span><span class="string" id="6701942">&#34;tcp&#34;</span><span class="op" id="6701947">,</span>&nbsp;<span class="ident" id="6701949">ln</span><span class="op" id="6701951">.</span><span class="ident" id="6701952">Addr</span><span class="op" id="6701956">(</span><span class="op" id="6701957">)</span><span class="op" id="6701958">.</span><span class="ident" id="6701959">String</span><span class="op" id="6701965">(</span><span class="op" id="6701966">)</span><span class="op" id="6701967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6701971">if</span>&nbsp;<span class="ident" id="6701974">err</span>&nbsp;<span class="op" id="6701978">!=</span>&nbsp;<span class="ident" id="6701981">nil</span>&nbsp;<span class="op" id="6701985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6701990">b</span><span class="op" id="6701991">.</span><span class="ident" id="6701992">Fatalf</span><span class="op" id="6701998">(</span><span class="string" id="6701999">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6702016">,</span>&nbsp;<span class="ident" id="6702018">err</span><span class="op" id="6702021">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702029">clients</span><span class="op" id="6702036">[</span><span class="ident" id="6702037">p</span><span class="op" id="6702038">]</span>&nbsp;<span class="op" id="6702040">=</span>&nbsp;<span class="ident" id="6702042">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702048">&lt;-</span><span class="ident" id="6702050">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702057">b</span><span class="op" id="6702058">.</span><span class="ident" id="6702059">StartTimer</span><span class="op" id="6702069">(</span><span class="op" id="6702070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702074">var</span>&nbsp;<span class="ident" id="6702078">wg</span>&nbsp;<span class="ident" id="6702081">sync</span><span class="op" id="6702085">.</span><span class="ident" id="6702086">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702097">wg</span><span class="op" id="6702099">.</span><span class="ident" id="6702100">Add</span><span class="op" id="6702103">(</span><span class="num" id="6702104">4</span>&nbsp;<span class="op" id="6702106">*</span>&nbsp;<span class="ident" id="6702108">P</span><span class="op" id="6702109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702112">for</span>&nbsp;<span class="ident" id="6702116">p</span>&nbsp;<span class="op" id="6702118">:=</span>&nbsp;<span class="num" id="6702121">0</span><span class="op" id="6702122">;</span>&nbsp;<span class="ident" id="6702124">p</span>&nbsp;<span class="op" id="6702126">&lt;</span>&nbsp;<span class="ident" id="6702128">P</span><span class="op" id="6702129">;</span>&nbsp;<span class="ident" id="6702131">p</span><span class="op" id="6702132">++</span>&nbsp;<span class="op" id="6702135">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6702139">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702159">go</span>&nbsp;<span class="keyword" id="6702162">func</span><span class="op" id="6702166">(</span><span class="ident" id="6702167">c</span>&nbsp;<span class="ident" id="6702169">Conn</span><span class="op" id="6702173">)</span>&nbsp;<span class="op" id="6702175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702180">defer</span>&nbsp;<span class="ident" id="6702186">wg</span><span class="op" id="6702188">.</span><span class="ident" id="6702189">Done</span><span class="op" id="6702193">(</span><span class="op" id="6702194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702199">var</span>&nbsp;<span class="ident" id="6702203">buf</span>&nbsp;<span class="op" id="6702207">[</span><span class="num" id="6702208">1</span><span class="op" id="6702209">]</span><span class="builtintype" id="6702210">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702218">for</span>&nbsp;<span class="ident" id="6702222">i</span>&nbsp;<span class="op" id="6702224">:=</span>&nbsp;<span class="num" id="6702227">0</span><span class="op" id="6702228">;</span>&nbsp;<span class="ident" id="6702230">i</span>&nbsp;<span class="op" id="6702232">&lt;</span>&nbsp;<span class="ident" id="6702234">N</span><span class="op" id="6702235">;</span>&nbsp;<span class="ident" id="6702237">i</span><span class="op" id="6702238">++</span>&nbsp;<span class="op" id="6702241">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702247">v</span>&nbsp;<span class="op" id="6702249">:=</span>&nbsp;<span class="builtintype" id="6702252">byte</span><span class="op" id="6702256">(</span><span class="ident" id="6702257">i</span><span class="op" id="6702258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702264">for</span>&nbsp;<span class="ident" id="6702268">w</span>&nbsp;<span class="op" id="6702270">:=</span>&nbsp;<span class="num" id="6702273">0</span><span class="op" id="6702274">;</span>&nbsp;<span class="ident" id="6702276">w</span>&nbsp;<span class="op" id="6702278">&lt;</span>&nbsp;<span class="ident" id="6702280">W</span><span class="op" id="6702281">;</span>&nbsp;<span class="ident" id="6702283">w</span><span class="op" id="6702284">++</span>&nbsp;<span class="op" id="6702287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702294">v</span>&nbsp;<span class="op" id="6702296">*=</span>&nbsp;<span class="ident" id="6702299">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702311">buf</span><span class="op" id="6702314">[</span><span class="num" id="6702315">0</span><span class="op" id="6702316">]</span>&nbsp;<span class="op" id="6702318">=</span>&nbsp;<span class="ident" id="6702320">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702326">_</span><span class="op" id="6702327">,</span>&nbsp;<span class="ident" id="6702329">err</span>&nbsp;<span class="op" id="6702333">:=</span>&nbsp;<span class="ident" id="6702336">c</span><span class="op" id="6702337">.</span><span class="ident" id="6702338">Write</span><span class="op" id="6702343">(</span><span class="ident" id="6702344">buf</span><span class="op" id="6702347">[</span><span class="op" id="6702348">:</span><span class="op" id="6702349">]</span><span class="op" id="6702350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702356">if</span>&nbsp;<span class="ident" id="6702359">err</span>&nbsp;<span class="op" id="6702363">!=</span>&nbsp;<span class="ident" id="6702366">nil</span>&nbsp;<span class="op" id="6702370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702377">b</span><span class="op" id="6702378">.</span><span class="ident" id="6702379">Errorf</span><span class="op" id="6702385">(</span><span class="string" id="6702386">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6702404">,</span>&nbsp;<span class="ident" id="6702406">err</span><span class="op" id="6702409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702416">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702427">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702436">}</span><span class="op" id="6702437">(</span><span class="ident" id="6702438">clients</span><span class="op" id="6702445">[</span><span class="ident" id="6702446">p</span><span class="op" id="6702447">]</span><span class="op" id="6702448">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6702453">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702504">pipe</span>&nbsp;<span class="op" id="6702509">:=</span>&nbsp;<span class="builtinfunc" id="6702512">make</span><span class="op" id="6702516">(</span><span class="keyword" id="6702517">chan</span>&nbsp;<span class="builtintype" id="6702522">byte</span><span class="op" id="6702526">,</span>&nbsp;<span class="num" id="6702528">128</span><span class="op" id="6702531">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6702536">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702556">go</span>&nbsp;<span class="keyword" id="6702559">func</span><span class="op" id="6702563">(</span><span class="ident" id="6702564">s</span>&nbsp;<span class="ident" id="6702566">Conn</span><span class="op" id="6702570">)</span>&nbsp;<span class="op" id="6702572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702577">defer</span>&nbsp;<span class="ident" id="6702583">wg</span><span class="op" id="6702585">.</span><span class="ident" id="6702586">Done</span><span class="op" id="6702590">(</span><span class="op" id="6702591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702596">var</span>&nbsp;<span class="ident" id="6702600">buf</span>&nbsp;<span class="op" id="6702604">[</span><span class="num" id="6702605">1</span><span class="op" id="6702606">]</span><span class="builtintype" id="6702607">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702615">for</span>&nbsp;<span class="ident" id="6702619">i</span>&nbsp;<span class="op" id="6702621">:=</span>&nbsp;<span class="num" id="6702624">0</span><span class="op" id="6702625">;</span>&nbsp;<span class="ident" id="6702627">i</span>&nbsp;<span class="op" id="6702629">&lt;</span>&nbsp;<span class="ident" id="6702631">N</span><span class="op" id="6702632">;</span>&nbsp;<span class="ident" id="6702634">i</span><span class="op" id="6702635">++</span>&nbsp;<span class="op" id="6702638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702644">_</span><span class="op" id="6702645">,</span>&nbsp;<span class="ident" id="6702647">err</span>&nbsp;<span class="op" id="6702651">:=</span>&nbsp;<span class="ident" id="6702654">s</span><span class="op" id="6702655">.</span><span class="ident" id="6702656">Read</span><span class="op" id="6702660">(</span><span class="ident" id="6702661">buf</span><span class="op" id="6702664">[</span><span class="op" id="6702665">:</span><span class="op" id="6702666">]</span><span class="op" id="6702667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702673">if</span>&nbsp;<span class="ident" id="6702676">err</span>&nbsp;<span class="op" id="6702680">!=</span>&nbsp;<span class="ident" id="6702683">nil</span>&nbsp;<span class="op" id="6702687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702694">b</span><span class="op" id="6702695">.</span><span class="ident" id="6702696">Errorf</span><span class="op" id="6702702">(</span><span class="string" id="6702703">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6702720">,</span>&nbsp;<span class="ident" id="6702722">err</span><span class="op" id="6702725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702732">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702749">pipe</span>&nbsp;<span class="op" id="6702754">&lt;-</span>&nbsp;<span class="ident" id="6702757">buf</span><span class="op" id="6702760">[</span><span class="num" id="6702761">0</span><span class="op" id="6702762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702771">}</span><span class="op" id="6702772">(</span><span class="ident" id="6702773">servers</span><span class="op" id="6702780">[</span><span class="ident" id="6702781">p</span><span class="op" id="6702782">]</span><span class="op" id="6702783">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6702788">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702808">go</span>&nbsp;<span class="keyword" id="6702811">func</span><span class="op" id="6702815">(</span><span class="ident" id="6702816">s</span>&nbsp;<span class="ident" id="6702818">Conn</span><span class="op" id="6702822">)</span>&nbsp;<span class="op" id="6702824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702829">defer</span>&nbsp;<span class="ident" id="6702835">wg</span><span class="op" id="6702837">.</span><span class="ident" id="6702838">Done</span><span class="op" id="6702842">(</span><span class="op" id="6702843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702848">var</span>&nbsp;<span class="ident" id="6702852">buf</span>&nbsp;<span class="op" id="6702856">[</span><span class="num" id="6702857">1</span><span class="op" id="6702858">]</span><span class="builtintype" id="6702859">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702867">for</span>&nbsp;<span class="ident" id="6702871">i</span>&nbsp;<span class="op" id="6702873">:=</span>&nbsp;<span class="num" id="6702876">0</span><span class="op" id="6702877">;</span>&nbsp;<span class="ident" id="6702879">i</span>&nbsp;<span class="op" id="6702881">&lt;</span>&nbsp;<span class="ident" id="6702883">N</span><span class="op" id="6702884">;</span>&nbsp;<span class="ident" id="6702886">i</span><span class="op" id="6702887">++</span>&nbsp;<span class="op" id="6702890">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702896">v</span>&nbsp;<span class="op" id="6702898">:=</span>&nbsp;<span class="op" id="6702901">&lt;-</span><span class="ident" id="6702903">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6702912">for</span>&nbsp;<span class="ident" id="6702916">w</span>&nbsp;<span class="op" id="6702918">:=</span>&nbsp;<span class="num" id="6702921">0</span><span class="op" id="6702922">;</span>&nbsp;<span class="ident" id="6702924">w</span>&nbsp;<span class="op" id="6702926">&lt;</span>&nbsp;<span class="ident" id="6702928">W</span><span class="op" id="6702929">;</span>&nbsp;<span class="ident" id="6702931">w</span><span class="op" id="6702932">++</span>&nbsp;<span class="op" id="6702935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702942">v</span>&nbsp;<span class="op" id="6702944">*=</span>&nbsp;<span class="ident" id="6702947">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6702953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702959">buf</span><span class="op" id="6702962">[</span><span class="num" id="6702963">0</span><span class="op" id="6702964">]</span>&nbsp;<span class="op" id="6702966">=</span>&nbsp;<span class="ident" id="6702968">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6702974">_</span><span class="op" id="6702975">,</span>&nbsp;<span class="ident" id="6702977">err</span>&nbsp;<span class="op" id="6702981">:=</span>&nbsp;<span class="ident" id="6702984">s</span><span class="op" id="6702985">.</span><span class="ident" id="6702986">Write</span><span class="op" id="6702991">(</span><span class="ident" id="6702992">buf</span><span class="op" id="6702995">[</span><span class="op" id="6702996">:</span><span class="op" id="6702997">]</span><span class="op" id="6702998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703004">if</span>&nbsp;<span class="ident" id="6703007">err</span>&nbsp;<span class="op" id="6703011">!=</span>&nbsp;<span class="ident" id="6703014">nil</span>&nbsp;<span class="op" id="6703018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703025">b</span><span class="op" id="6703026">.</span><span class="ident" id="6703027">Errorf</span><span class="op" id="6703033">(</span><span class="string" id="6703034">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6703052">,</span>&nbsp;<span class="ident" id="6703054">err</span><span class="op" id="6703057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703064">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703075">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703085">s</span><span class="op" id="6703086">.</span><span class="ident" id="6703087">Close</span><span class="op" id="6703092">(</span><span class="op" id="6703093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703097">}</span><span class="op" id="6703098">(</span><span class="ident" id="6703099">servers</span><span class="op" id="6703106">[</span><span class="ident" id="6703107">p</span><span class="op" id="6703108">]</span><span class="op" id="6703109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6703114">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703134">go</span>&nbsp;<span class="keyword" id="6703137">func</span><span class="op" id="6703141">(</span><span class="ident" id="6703142">c</span>&nbsp;<span class="ident" id="6703144">Conn</span><span class="op" id="6703148">)</span>&nbsp;<span class="op" id="6703150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703155">defer</span>&nbsp;<span class="ident" id="6703161">wg</span><span class="op" id="6703163">.</span><span class="ident" id="6703164">Done</span><span class="op" id="6703168">(</span><span class="op" id="6703169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703174">var</span>&nbsp;<span class="ident" id="6703178">buf</span>&nbsp;<span class="op" id="6703182">[</span><span class="num" id="6703183">1</span><span class="op" id="6703184">]</span><span class="builtintype" id="6703185">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703193">for</span>&nbsp;<span class="ident" id="6703197">i</span>&nbsp;<span class="op" id="6703199">:=</span>&nbsp;<span class="num" id="6703202">0</span><span class="op" id="6703203">;</span>&nbsp;<span class="ident" id="6703205">i</span>&nbsp;<span class="op" id="6703207">&lt;</span>&nbsp;<span class="ident" id="6703209">N</span><span class="op" id="6703210">;</span>&nbsp;<span class="ident" id="6703212">i</span><span class="op" id="6703213">++</span>&nbsp;<span class="op" id="6703216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703222">_</span><span class="op" id="6703223">,</span>&nbsp;<span class="ident" id="6703225">err</span>&nbsp;<span class="op" id="6703229">:=</span>&nbsp;<span class="ident" id="6703232">c</span><span class="op" id="6703233">.</span><span class="ident" id="6703234">Read</span><span class="op" id="6703238">(</span><span class="ident" id="6703239">buf</span><span class="op" id="6703242">[</span><span class="op" id="6703243">:</span><span class="op" id="6703244">]</span><span class="op" id="6703245">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703251">if</span>&nbsp;<span class="ident" id="6703254">err</span>&nbsp;<span class="op" id="6703258">!=</span>&nbsp;<span class="ident" id="6703261">nil</span>&nbsp;<span class="op" id="6703265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703272">b</span><span class="op" id="6703273">.</span><span class="ident" id="6703274">Errorf</span><span class="op" id="6703280">(</span><span class="string" id="6703281">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6703298">,</span>&nbsp;<span class="ident" id="6703300">err</span><span class="op" id="6703303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6703310">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703326">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703331">c</span><span class="op" id="6703332">.</span><span class="ident" id="6703333">Close</span><span class="op" id="6703338">(</span><span class="op" id="6703339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703343">}</span><span class="op" id="6703344">(</span><span class="ident" id="6703345">clients</span><span class="op" id="6703352">[</span><span class="ident" id="6703353">p</span><span class="op" id="6703354">]</span><span class="op" id="6703355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703361">wg</span><span class="op" id="6703363">.</span><span class="ident" id="6703364">Wait</span><span class="op" id="6703368">(</span><span class="op" id="6703369">)</span><br>
<span class="lineno"></span><span class="op" id="6703371">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="6703374">type</span>&nbsp;<span class="ident" id="6703379">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="6703398">struct</span>&nbsp;<span class="op" id="6703405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703408">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6703422">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703430">litAddrOrName</span>&nbsp;<span class="builtintype" id="6703444">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703452">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6703466">*</span><span class="ident" id="6703467">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6703476">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6703490">error</span><br>
<span class="lineno"></span><span class="op" id="6703496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6703499">var</span>&nbsp;<span class="ident" id="6703503">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6703523">=</span>&nbsp;<span class="op" id="6703525">[</span><span class="op" id="6703526">]</span><span class="ident" id="6703527">resolveTCPAddrTest</span><span class="op" id="6703545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703548">{</span><span class="string" id="6703549">&#34;tcp&#34;</span><span class="op" id="6703554">,</span>&nbsp;<span class="string" id="6703556">&#34;127.0.0.1:0&#34;</span><span class="op" id="6703569">,</span>&nbsp;<span class="op" id="6703571">&amp;</span><span class="ident" id="6703572">TCPAddr</span><span class="op" id="6703579">{</span><span class="ident" id="6703580">IP</span><span class="op" id="6703582">:</span>&nbsp;<span class="ident" id="6703584">IPv4</span><span class="op" id="6703588">(</span><span class="num" id="6703589">127</span><span class="op" id="6703592">,</span>&nbsp;<span class="num" id="6703594">0</span><span class="op" id="6703595">,</span>&nbsp;<span class="num" id="6703597">0</span><span class="op" id="6703598">,</span>&nbsp;<span class="num" id="6703600">1</span><span class="op" id="6703601">)</span><span class="op" id="6703602">,</span>&nbsp;<span class="ident" id="6703604">Port</span><span class="op" id="6703608">:</span>&nbsp;<span class="num" id="6703610">0</span><span class="op" id="6703611">}</span><span class="op" id="6703612">,</span>&nbsp;<span class="ident" id="6703614">nil</span><span class="op" id="6703617">}</span><span class="op" id="6703618">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703621">{</span><span class="string" id="6703622">&#34;tcp4&#34;</span><span class="op" id="6703628">,</span>&nbsp;<span class="string" id="6703630">&#34;127.0.0.1:65535&#34;</span><span class="op" id="6703647">,</span>&nbsp;<span class="op" id="6703649">&amp;</span><span class="ident" id="6703650">TCPAddr</span><span class="op" id="6703657">{</span><span class="ident" id="6703658">IP</span><span class="op" id="6703660">:</span>&nbsp;<span class="ident" id="6703662">IPv4</span><span class="op" id="6703666">(</span><span class="num" id="6703667">127</span><span class="op" id="6703670">,</span>&nbsp;<span class="num" id="6703672">0</span><span class="op" id="6703673">,</span>&nbsp;<span class="num" id="6703675">0</span><span class="op" id="6703676">,</span>&nbsp;<span class="num" id="6703678">1</span><span class="op" id="6703679">)</span><span class="op" id="6703680">,</span>&nbsp;<span class="ident" id="6703682">Port</span><span class="op" id="6703686">:</span>&nbsp;<span class="num" id="6703688">65535</span><span class="op" id="6703693">}</span><span class="op" id="6703694">,</span>&nbsp;<span class="ident" id="6703696">nil</span><span class="op" id="6703699">}</span><span class="op" id="6703700">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703704">{</span><span class="string" id="6703705">&#34;tcp&#34;</span><span class="op" id="6703710">,</span>&nbsp;<span class="string" id="6703712">&#34;[::1]:1&#34;</span><span class="op" id="6703721">,</span>&nbsp;<span class="op" id="6703723">&amp;</span><span class="ident" id="6703724">TCPAddr</span><span class="op" id="6703731">{</span><span class="ident" id="6703732">IP</span><span class="op" id="6703734">:</span>&nbsp;<span class="ident" id="6703736">ParseIP</span><span class="op" id="6703743">(</span><span class="string" id="6703744">&#34;::1&#34;</span><span class="op" id="6703749">)</span><span class="op" id="6703750">,</span>&nbsp;<span class="ident" id="6703752">Port</span><span class="op" id="6703756">:</span>&nbsp;<span class="num" id="6703758">1</span><span class="op" id="6703759">}</span><span class="op" id="6703760">,</span>&nbsp;<span class="ident" id="6703762">nil</span><span class="op" id="6703765">}</span><span class="op" id="6703766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703769">{</span><span class="string" id="6703770">&#34;tcp6&#34;</span><span class="op" id="6703776">,</span>&nbsp;<span class="string" id="6703778">&#34;[::1]:65534&#34;</span><span class="op" id="6703791">,</span>&nbsp;<span class="op" id="6703793">&amp;</span><span class="ident" id="6703794">TCPAddr</span><span class="op" id="6703801">{</span><span class="ident" id="6703802">IP</span><span class="op" id="6703804">:</span>&nbsp;<span class="ident" id="6703806">ParseIP</span><span class="op" id="6703813">(</span><span class="string" id="6703814">&#34;::1&#34;</span><span class="op" id="6703819">)</span><span class="op" id="6703820">,</span>&nbsp;<span class="ident" id="6703822">Port</span><span class="op" id="6703826">:</span>&nbsp;<span class="num" id="6703828">65534</span><span class="op" id="6703833">}</span><span class="op" id="6703834">,</span>&nbsp;<span class="ident" id="6703836">nil</span><span class="op" id="6703839">}</span><span class="op" id="6703840">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703844">{</span><span class="string" id="6703845">&#34;tcp&#34;</span><span class="op" id="6703850">,</span>&nbsp;<span class="string" id="6703852">&#34;[::1%en0]:1&#34;</span><span class="op" id="6703865">,</span>&nbsp;<span class="op" id="6703867">&amp;</span><span class="ident" id="6703868">TCPAddr</span><span class="op" id="6703875">{</span><span class="ident" id="6703876">IP</span><span class="op" id="6703878">:</span>&nbsp;<span class="ident" id="6703880">ParseIP</span><span class="op" id="6703887">(</span><span class="string" id="6703888">&#34;::1&#34;</span><span class="op" id="6703893">)</span><span class="op" id="6703894">,</span>&nbsp;<span class="ident" id="6703896">Port</span><span class="op" id="6703900">:</span>&nbsp;<span class="num" id="6703902">1</span><span class="op" id="6703903">,</span>&nbsp;<span class="ident" id="6703905">Zone</span><span class="op" id="6703909">:</span>&nbsp;<span class="string" id="6703911">&#34;en0&#34;</span><span class="op" id="6703916">}</span><span class="op" id="6703917">,</span>&nbsp;<span class="ident" id="6703919">nil</span><span class="op" id="6703922">}</span><span class="op" id="6703923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6703926">{</span><span class="string" id="6703927">&#34;tcp6&#34;</span><span class="op" id="6703933">,</span>&nbsp;<span class="string" id="6703935">&#34;[::1%911]:2&#34;</span><span class="op" id="6703948">,</span>&nbsp;<span class="op" id="6703950">&amp;</span><span class="ident" id="6703951">TCPAddr</span><span class="op" id="6703958">{</span><span class="ident" id="6703959">IP</span><span class="op" id="6703961">:</span>&nbsp;<span class="ident" id="6703963">ParseIP</span><span class="op" id="6703970">(</span><span class="string" id="6703971">&#34;::1&#34;</span><span class="op" id="6703976">)</span><span class="op" id="6703977">,</span>&nbsp;<span class="ident" id="6703979">Port</span><span class="op" id="6703983">:</span>&nbsp;<span class="num" id="6703985">2</span><span class="op" id="6703986">,</span>&nbsp;<span class="ident" id="6703988">Zone</span><span class="op" id="6703992">:</span>&nbsp;<span class="string" id="6703994">&#34;911&#34;</span><span class="op" id="6703999">}</span><span class="op" id="6704000">,</span>&nbsp;<span class="ident" id="6704002">nil</span><span class="op" id="6704005">}</span><span class="op" id="6704006">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704010">{</span><span class="string" id="6704011">&#34;&#34;</span><span class="op" id="6704013">,</span>&nbsp;<span class="string" id="6704015">&#34;127.0.0.1:0&#34;</span><span class="op" id="6704028">,</span>&nbsp;<span class="op" id="6704030">&amp;</span><span class="ident" id="6704031">TCPAddr</span><span class="op" id="6704038">{</span><span class="ident" id="6704039">IP</span><span class="op" id="6704041">:</span>&nbsp;<span class="ident" id="6704043">IPv4</span><span class="op" id="6704047">(</span><span class="num" id="6704048">127</span><span class="op" id="6704051">,</span>&nbsp;<span class="num" id="6704053">0</span><span class="op" id="6704054">,</span>&nbsp;<span class="num" id="6704056">0</span><span class="op" id="6704057">,</span>&nbsp;<span class="num" id="6704059">1</span><span class="op" id="6704060">)</span><span class="op" id="6704061">,</span>&nbsp;<span class="ident" id="6704063">Port</span><span class="op" id="6704067">:</span>&nbsp;<span class="num" id="6704069">0</span><span class="op" id="6704070">}</span><span class="op" id="6704071">,</span>&nbsp;<span class="ident" id="6704073">nil</span><span class="op" id="6704076">}</span><span class="op" id="6704077">,</span>&nbsp;<span class="comment" id="6704079">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704099">{</span><span class="string" id="6704100">&#34;&#34;</span><span class="op" id="6704102">,</span>&nbsp;<span class="string" id="6704104">&#34;[::1]:0&#34;</span><span class="op" id="6704113">,</span>&nbsp;<span class="op" id="6704115">&amp;</span><span class="ident" id="6704116">TCPAddr</span><span class="op" id="6704123">{</span><span class="ident" id="6704124">IP</span><span class="op" id="6704126">:</span>&nbsp;<span class="ident" id="6704128">ParseIP</span><span class="op" id="6704135">(</span><span class="string" id="6704136">&#34;::1&#34;</span><span class="op" id="6704141">)</span><span class="op" id="6704142">,</span>&nbsp;<span class="ident" id="6704144">Port</span><span class="op" id="6704148">:</span>&nbsp;<span class="num" id="6704150">0</span><span class="op" id="6704151">}</span><span class="op" id="6704152">,</span>&nbsp;<span class="ident" id="6704154">nil</span><span class="op" id="6704157">}</span><span class="op" id="6704158">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6704168">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704189">{</span><span class="string" id="6704190">&#34;tcp&#34;</span><span class="op" id="6704195">,</span>&nbsp;<span class="string" id="6704197">&#34;:12345&#34;</span><span class="op" id="6704205">,</span>&nbsp;<span class="op" id="6704207">&amp;</span><span class="ident" id="6704208">TCPAddr</span><span class="op" id="6704215">{</span><span class="ident" id="6704216">Port</span><span class="op" id="6704220">:</span>&nbsp;<span class="num" id="6704222">12345</span><span class="op" id="6704227">}</span><span class="op" id="6704228">,</span>&nbsp;<span class="ident" id="6704230">nil</span><span class="op" id="6704233">}</span><span class="op" id="6704234">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704238">{</span><span class="string" id="6704239">&#34;http&#34;</span><span class="op" id="6704245">,</span>&nbsp;<span class="string" id="6704247">&#34;127.0.0.1:0&#34;</span><span class="op" id="6704260">,</span>&nbsp;<span class="ident" id="6704262">nil</span><span class="op" id="6704265">,</span>&nbsp;<span class="ident" id="6704267">UnknownNetworkError</span><span class="op" id="6704286">(</span><span class="string" id="6704287">&#34;http&#34;</span><span class="op" id="6704293">)</span><span class="op" id="6704294">}</span><span class="op" id="6704295">,</span><br>
<span class="lineno"></span><span class="op" id="6704297">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="6704300">func</span>&nbsp;<span class="ident" id="6704305">init</span><span class="op" id="6704309">(</span><span class="op" id="6704310">)</span>&nbsp;<span class="op" id="6704312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6704315">if</span>&nbsp;<span class="ident" id="6704318">ifi</span>&nbsp;<span class="op" id="6704322">:=</span>&nbsp;<span class="ident" id="6704325">loopbackInterface</span><span class="op" id="6704342">(</span><span class="op" id="6704343">)</span><span class="op" id="6704344">;</span>&nbsp;<span class="ident" id="6704346">ifi</span>&nbsp;<span class="op" id="6704350">!=</span>&nbsp;<span class="ident" id="6704353">nil</span>&nbsp;<span class="op" id="6704357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6704361">index</span>&nbsp;<span class="op" id="6704367">:=</span>&nbsp;<span class="ident" id="6704370">fmt</span><span class="op" id="6704373">.</span><span class="ident" id="6704374">Sprintf</span><span class="op" id="6704381">(</span><span class="string" id="6704382">&#34;%v&#34;</span><span class="op" id="6704386">,</span>&nbsp;<span class="ident" id="6704388">ifi</span><span class="op" id="6704391">.</span><span class="ident" id="6704392">Index</span><span class="op" id="6704397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6704401">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6704421">=</span>&nbsp;<span class="builtinfunc" id="6704423">append</span><span class="op" id="6704429">(</span><span class="ident" id="6704430">resolveTCPAddrTests</span><span class="op" id="6704449">,</span>&nbsp;<span class="op" id="6704451">[</span><span class="op" id="6704452">]</span><span class="ident" id="6704453">resolveTCPAddrTest</span><span class="op" id="6704471">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704476">{</span><span class="string" id="6704477">&#34;tcp6&#34;</span><span class="op" id="6704483">,</span>&nbsp;<span class="string" id="6704485">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6704497">+</span>&nbsp;<span class="ident" id="6704499">ifi</span><span class="op" id="6704502">.</span><span class="ident" id="6704503">Name</span>&nbsp;<span class="op" id="6704508">+</span>&nbsp;<span class="string" id="6704510">&#34;]:3&#34;</span><span class="op" id="6704515">,</span>&nbsp;<span class="op" id="6704517">&amp;</span><span class="ident" id="6704518">TCPAddr</span><span class="op" id="6704525">{</span><span class="ident" id="6704526">IP</span><span class="op" id="6704528">:</span>&nbsp;<span class="ident" id="6704530">ParseIP</span><span class="op" id="6704537">(</span><span class="string" id="6704538">&#34;fe80::1&#34;</span><span class="op" id="6704547">)</span><span class="op" id="6704548">,</span>&nbsp;<span class="ident" id="6704550">Port</span><span class="op" id="6704554">:</span>&nbsp;<span class="num" id="6704556">3</span><span class="op" id="6704557">,</span>&nbsp;<span class="ident" id="6704559">Zone</span><span class="op" id="6704563">:</span>&nbsp;<span class="ident" id="6704565">zoneToString</span><span class="op" id="6704577">(</span><span class="ident" id="6704578">ifi</span><span class="op" id="6704581">.</span><span class="ident" id="6704582">Index</span><span class="op" id="6704587">)</span><span class="op" id="6704588">}</span><span class="op" id="6704589">,</span>&nbsp;<span class="ident" id="6704591">nil</span><span class="op" id="6704594">}</span><span class="op" id="6704595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704600">{</span><span class="string" id="6704601">&#34;tcp6&#34;</span><span class="op" id="6704607">,</span>&nbsp;<span class="string" id="6704609">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6704621">+</span>&nbsp;<span class="ident" id="6704623">index</span>&nbsp;<span class="op" id="6704629">+</span>&nbsp;<span class="string" id="6704631">&#34;]:4&#34;</span><span class="op" id="6704636">,</span>&nbsp;<span class="op" id="6704638">&amp;</span><span class="ident" id="6704639">TCPAddr</span><span class="op" id="6704646">{</span><span class="ident" id="6704647">IP</span><span class="op" id="6704649">:</span>&nbsp;<span class="ident" id="6704651">ParseIP</span><span class="op" id="6704658">(</span><span class="string" id="6704659">&#34;fe80::1&#34;</span><span class="op" id="6704668">)</span><span class="op" id="6704669">,</span>&nbsp;<span class="ident" id="6704671">Port</span><span class="op" id="6704675">:</span>&nbsp;<span class="num" id="6704677">4</span><span class="op" id="6704678">,</span>&nbsp;<span class="ident" id="6704680">Zone</span><span class="op" id="6704684">:</span>&nbsp;<span class="ident" id="6704686">index</span><span class="op" id="6704691">}</span><span class="op" id="6704692">,</span>&nbsp;<span class="ident" id="6704694">nil</span><span class="op" id="6704697">}</span><span class="op" id="6704698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704702">}</span><span class="op" id="6704703">...</span><span class="op" id="6704706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6704712">if</span>&nbsp;<span class="ident" id="6704715">ips</span><span class="op" id="6704718">,</span>&nbsp;<span class="ident" id="6704720">err</span>&nbsp;<span class="op" id="6704724">:=</span>&nbsp;<span class="ident" id="6704727">LookupIP</span><span class="op" id="6704735">(</span><span class="string" id="6704736">&#34;localhost&#34;</span><span class="op" id="6704747">)</span><span class="op" id="6704748">;</span>&nbsp;<span class="ident" id="6704750">err</span>&nbsp;<span class="op" id="6704754">==</span>&nbsp;<span class="ident" id="6704757">nil</span>&nbsp;<span class="op" id="6704761">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6704764">len</span><span class="op" id="6704767">(</span><span class="ident" id="6704768">ips</span><span class="op" id="6704771">)</span>&nbsp;<span class="op" id="6704773">&gt;</span>&nbsp;<span class="num" id="6704775">1</span>&nbsp;<span class="op" id="6704777">&amp;&amp;</span>&nbsp;<span class="ident" id="6704780">supportsIPv4</span>&nbsp;<span class="op" id="6704793">&amp;&amp;</span>&nbsp;<span class="ident" id="6704796">supportsIPv6</span>&nbsp;<span class="op" id="6704809">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6704813">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6704833">=</span>&nbsp;<span class="builtinfunc" id="6704835">append</span><span class="op" id="6704841">(</span><span class="ident" id="6704842">resolveTCPAddrTests</span><span class="op" id="6704861">,</span>&nbsp;<span class="op" id="6704863">[</span><span class="op" id="6704864">]</span><span class="ident" id="6704865">resolveTCPAddrTest</span><span class="op" id="6704883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704888">{</span><span class="string" id="6704889">&#34;tcp&#34;</span><span class="op" id="6704894">,</span>&nbsp;<span class="string" id="6704896">&#34;localhost:5&#34;</span><span class="op" id="6704909">,</span>&nbsp;<span class="op" id="6704911">&amp;</span><span class="ident" id="6704912">TCPAddr</span><span class="op" id="6704919">{</span><span class="ident" id="6704920">IP</span><span class="op" id="6704922">:</span>&nbsp;<span class="ident" id="6704924">IPv4</span><span class="op" id="6704928">(</span><span class="num" id="6704929">127</span><span class="op" id="6704932">,</span>&nbsp;<span class="num" id="6704934">0</span><span class="op" id="6704935">,</span>&nbsp;<span class="num" id="6704937">0</span><span class="op" id="6704938">,</span>&nbsp;<span class="num" id="6704940">1</span><span class="op" id="6704941">)</span><span class="op" id="6704942">,</span>&nbsp;<span class="ident" id="6704944">Port</span><span class="op" id="6704948">:</span>&nbsp;<span class="num" id="6704950">5</span><span class="op" id="6704951">}</span><span class="op" id="6704952">,</span>&nbsp;<span class="ident" id="6704954">nil</span><span class="op" id="6704957">}</span><span class="op" id="6704958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6704963">{</span><span class="string" id="6704964">&#34;tcp4&#34;</span><span class="op" id="6704970">,</span>&nbsp;<span class="string" id="6704972">&#34;localhost:6&#34;</span><span class="op" id="6704985">,</span>&nbsp;<span class="op" id="6704987">&amp;</span><span class="ident" id="6704988">TCPAddr</span><span class="op" id="6704995">{</span><span class="ident" id="6704996">IP</span><span class="op" id="6704998">:</span>&nbsp;<span class="ident" id="6705000">IPv4</span><span class="op" id="6705004">(</span><span class="num" id="6705005">127</span><span class="op" id="6705008">,</span>&nbsp;<span class="num" id="6705010">0</span><span class="op" id="6705011">,</span>&nbsp;<span class="num" id="6705013">0</span><span class="op" id="6705014">,</span>&nbsp;<span class="num" id="6705016">1</span><span class="op" id="6705017">)</span><span class="op" id="6705018">,</span>&nbsp;<span class="ident" id="6705020">Port</span><span class="op" id="6705024">:</span>&nbsp;<span class="num" id="6705026">6</span><span class="op" id="6705027">}</span><span class="op" id="6705028">,</span>&nbsp;<span class="ident" id="6705030">nil</span><span class="op" id="6705033">}</span><span class="op" id="6705034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705039">{</span><span class="string" id="6705040">&#34;tcp6&#34;</span><span class="op" id="6705046">,</span>&nbsp;<span class="string" id="6705048">&#34;localhost:7&#34;</span><span class="op" id="6705061">,</span>&nbsp;<span class="op" id="6705063">&amp;</span><span class="ident" id="6705064">TCPAddr</span><span class="op" id="6705071">{</span><span class="ident" id="6705072">IP</span><span class="op" id="6705074">:</span>&nbsp;<span class="ident" id="6705076">IPv6loopback</span><span class="op" id="6705088">,</span>&nbsp;<span class="ident" id="6705090">Port</span><span class="op" id="6705094">:</span>&nbsp;<span class="num" id="6705096">7</span><span class="op" id="6705097">}</span><span class="op" id="6705098">,</span>&nbsp;<span class="ident" id="6705100">nil</span><span class="op" id="6705103">}</span><span class="op" id="6705104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705108">}</span><span class="op" id="6705109">...</span><span class="op" id="6705112">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705115">}</span><br>
<span class="lineno"></span><span class="op" id="6705117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6705120">func</span>&nbsp;<span class="ident" id="6705125">TestResolveTCPAddr</span><span class="op" id="6705143">(</span><span class="ident" id="6705144">t</span>&nbsp;<span class="op" id="6705146">*</span><span class="ident" id="6705147">testing</span><span class="op" id="6705154">.</span><span class="ident" id="6705155">T</span><span class="op" id="6705156">)</span>&nbsp;<span class="op" id="6705158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705161">for</span>&nbsp;<span class="ident" id="6705165">_</span><span class="op" id="6705166">,</span>&nbsp;<span class="ident" id="6705168">tt</span>&nbsp;<span class="op" id="6705171">:=</span>&nbsp;<span class="keyword" id="6705174">range</span>&nbsp;<span class="ident" id="6705180">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6705200">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705204">addr</span><span class="op" id="6705208">,</span>&nbsp;<span class="ident" id="6705210">err</span>&nbsp;<span class="op" id="6705214">:=</span>&nbsp;<span class="ident" id="6705217">ResolveTCPAddr</span><span class="op" id="6705231">(</span><span class="ident" id="6705232">tt</span><span class="op" id="6705234">.</span><span class="ident" id="6705235">net</span><span class="op" id="6705238">,</span>&nbsp;<span class="ident" id="6705240">tt</span><span class="op" id="6705242">.</span><span class="ident" id="6705243">litAddrOrName</span><span class="op" id="6705256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705260">if</span>&nbsp;<span class="ident" id="6705263">err</span>&nbsp;<span class="op" id="6705267">!=</span>&nbsp;<span class="ident" id="6705270">tt</span><span class="op" id="6705272">.</span><span class="ident" id="6705273">err</span>&nbsp;<span class="op" id="6705277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705282">t</span><span class="op" id="6705283">.</span><span class="ident" id="6705284">Fatalf</span><span class="op" id="6705290">(</span><span class="string" id="6705291">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6705326">,</span>&nbsp;<span class="ident" id="6705328">tt</span><span class="op" id="6705330">.</span><span class="ident" id="6705331">net</span><span class="op" id="6705334">,</span>&nbsp;<span class="ident" id="6705336">tt</span><span class="op" id="6705338">.</span><span class="ident" id="6705339">litAddrOrName</span><span class="op" id="6705352">,</span>&nbsp;<span class="ident" id="6705354">err</span><span class="op" id="6705357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705365">if</span>&nbsp;<span class="op" id="6705368">!</span><span class="ident" id="6705369">reflect</span><span class="op" id="6705376">.</span><span class="ident" id="6705377">DeepEqual</span><span class="op" id="6705386">(</span><span class="ident" id="6705387">addr</span><span class="op" id="6705391">,</span>&nbsp;<span class="ident" id="6705393">tt</span><span class="op" id="6705395">.</span><span class="ident" id="6705396">addr</span><span class="op" id="6705400">)</span>&nbsp;<span class="op" id="6705402">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705407">t</span><span class="op" id="6705408">.</span><span class="ident" id="6705409">Fatalf</span><span class="op" id="6705415">(</span><span class="string" id="6705416">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6705456">,</span>&nbsp;<span class="ident" id="6705458">tt</span><span class="op" id="6705460">.</span><span class="ident" id="6705461">net</span><span class="op" id="6705464">,</span>&nbsp;<span class="ident" id="6705466">tt</span><span class="op" id="6705468">.</span><span class="ident" id="6705469">litAddrOrName</span><span class="op" id="6705482">,</span>&nbsp;<span class="ident" id="6705484">addr</span><span class="op" id="6705488">,</span>&nbsp;<span class="ident" id="6705490">tt</span><span class="op" id="6705492">.</span><span class="ident" id="6705493">addr</span><span class="op" id="6705497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705505">if</span>&nbsp;<span class="ident" id="6705508">err</span>&nbsp;<span class="op" id="6705512">==</span>&nbsp;<span class="ident" id="6705515">nil</span>&nbsp;<span class="op" id="6705519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705524">str</span>&nbsp;<span class="op" id="6705528">:=</span>&nbsp;<span class="ident" id="6705531">addr</span><span class="op" id="6705535">.</span><span class="ident" id="6705536">String</span><span class="op" id="6705542">(</span><span class="op" id="6705543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705548">addr1</span><span class="op" id="6705553">,</span>&nbsp;<span class="ident" id="6705555">err</span>&nbsp;<span class="op" id="6705559">:=</span>&nbsp;<span class="ident" id="6705562">ResolveTCPAddr</span><span class="op" id="6705576">(</span><span class="ident" id="6705577">tt</span><span class="op" id="6705579">.</span><span class="ident" id="6705580">net</span><span class="op" id="6705583">,</span>&nbsp;<span class="ident" id="6705585">str</span><span class="op" id="6705588">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705593">if</span>&nbsp;<span class="ident" id="6705596">err</span>&nbsp;<span class="op" id="6705600">!=</span>&nbsp;<span class="ident" id="6705603">nil</span>&nbsp;<span class="op" id="6705607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705613">t</span><span class="op" id="6705614">.</span><span class="ident" id="6705615">Fatalf</span><span class="op" id="6705621">(</span><span class="string" id="6705622">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="6705660">,</span>&nbsp;<span class="ident" id="6705662">tt</span><span class="op" id="6705664">.</span><span class="ident" id="6705665">net</span><span class="op" id="6705668">,</span>&nbsp;<span class="ident" id="6705670">str</span><span class="op" id="6705673">,</span>&nbsp;<span class="ident" id="6705675">tt</span><span class="op" id="6705677">.</span><span class="ident" id="6705678">litAddrOrName</span><span class="op" id="6705691">,</span>&nbsp;<span class="ident" id="6705693">err</span><span class="op" id="6705696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6705706">if</span>&nbsp;<span class="op" id="6705709">!</span><span class="ident" id="6705710">reflect</span><span class="op" id="6705717">.</span><span class="ident" id="6705718">DeepEqual</span><span class="op" id="6705727">(</span><span class="ident" id="6705728">addr1</span><span class="op" id="6705733">,</span>&nbsp;<span class="ident" id="6705735">addr</span><span class="op" id="6705739">)</span>&nbsp;<span class="op" id="6705741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705747">t</span><span class="op" id="6705748">.</span><span class="ident" id="6705749">Fatalf</span><span class="op" id="6705755">(</span><span class="string" id="6705756">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6705806">,</span>&nbsp;<span class="ident" id="6705808">tt</span><span class="op" id="6705810">.</span><span class="ident" id="6705811">net</span><span class="op" id="6705814">,</span>&nbsp;<span class="ident" id="6705816">str</span><span class="op" id="6705819">,</span>&nbsp;<span class="ident" id="6705821">tt</span><span class="op" id="6705823">.</span><span class="ident" id="6705824">litAddrOrName</span><span class="op" id="6705837">,</span>&nbsp;<span class="ident" id="6705839">addr1</span><span class="op" id="6705844">,</span>&nbsp;<span class="ident" id="6705846">addr</span><span class="op" id="6705850">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705862">}</span><br>
<span class="lineno"></span><span class="op" id="6705864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="6705867">var</span>&nbsp;<span class="ident" id="6705871">tcpListenerNameTests</span>&nbsp;<span class="op" id="6705892">=</span>&nbsp;<span class="op" id="6705894">[</span><span class="op" id="6705895">]</span><span class="keyword" id="6705896">struct</span>&nbsp;<span class="op" id="6705903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705906">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6705912">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6705920">laddr</span>&nbsp;<span class="op" id="6705926">*</span><span class="ident" id="6705927">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="6705935">}</span><span class="op" id="6705936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705939">{</span><span class="string" id="6705940">&#34;tcp4&#34;</span><span class="op" id="6705946">,</span>&nbsp;<span class="op" id="6705948">&amp;</span><span class="ident" id="6705949">TCPAddr</span><span class="op" id="6705956">{</span><span class="ident" id="6705957">IP</span><span class="op" id="6705959">:</span>&nbsp;<span class="ident" id="6705961">IPv4</span><span class="op" id="6705965">(</span><span class="num" id="6705966">127</span><span class="op" id="6705969">,</span>&nbsp;<span class="num" id="6705971">0</span><span class="op" id="6705972">,</span>&nbsp;<span class="num" id="6705974">0</span><span class="op" id="6705975">,</span>&nbsp;<span class="num" id="6705977">1</span><span class="op" id="6705978">)</span><span class="op" id="6705979">}</span><span class="op" id="6705980">}</span><span class="op" id="6705981">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6705984">{</span><span class="string" id="6705985">&#34;tcp4&#34;</span><span class="op" id="6705991">,</span>&nbsp;<span class="op" id="6705993">&amp;</span><span class="ident" id="6705994">TCPAddr</span><span class="op" id="6706001">{</span><span class="op" id="6706002">}</span><span class="op" id="6706003">}</span><span class="op" id="6706004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706007">{</span><span class="string" id="6706008">&#34;tcp4&#34;</span><span class="op" id="6706014">,</span>&nbsp;<span class="ident" id="6706016">nil</span><span class="op" id="6706019">}</span><span class="op" id="6706020">,</span><br>
<span class="lineno"></span><span class="op" id="6706022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6706025">func</span>&nbsp;<span class="ident" id="6706030">TestTCPListenerName</span><span class="op" id="6706049">(</span><span class="ident" id="6706050">t</span>&nbsp;<span class="op" id="6706052">*</span><span class="ident" id="6706053">testing</span><span class="op" id="6706060">.</span><span class="ident" id="6706061">T</span><span class="op" id="6706062">)</span>&nbsp;<span class="op" id="6706064">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706067">if</span>&nbsp;<span class="ident" id="6706070">testing</span><span class="op" id="6706077">.</span><span class="ident" id="6706078">Short</span><span class="op" id="6706083">(</span><span class="op" id="6706084">)</span>&nbsp;<span class="op" id="6706086">||</span>&nbsp;<span class="op" id="6706089">!</span><span class="op" id="6706090">*</span><span class="ident" id="6706091">testExternal</span>&nbsp;<span class="op" id="6706104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706108">t</span><span class="op" id="6706109">.</span><span class="ident" id="6706110">Skip</span><span class="op" id="6706114">(</span><span class="string" id="6706115">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6706156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706163">for</span>&nbsp;<span class="ident" id="6706167">_</span><span class="op" id="6706168">,</span>&nbsp;<span class="ident" id="6706170">tt</span>&nbsp;<span class="op" id="6706173">:=</span>&nbsp;<span class="keyword" id="6706176">range</span>&nbsp;<span class="ident" id="6706182">tcpListenerNameTests</span>&nbsp;<span class="op" id="6706203">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706207">ln</span><span class="op" id="6706209">,</span>&nbsp;<span class="ident" id="6706211">err</span>&nbsp;<span class="op" id="6706215">:=</span>&nbsp;<span class="ident" id="6706218">ListenTCP</span><span class="op" id="6706227">(</span><span class="ident" id="6706228">tt</span><span class="op" id="6706230">.</span><span class="ident" id="6706231">net</span><span class="op" id="6706234">,</span>&nbsp;<span class="ident" id="6706236">tt</span><span class="op" id="6706238">.</span><span class="ident" id="6706239">laddr</span><span class="op" id="6706244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706248">if</span>&nbsp;<span class="ident" id="6706251">err</span>&nbsp;<span class="op" id="6706255">!=</span>&nbsp;<span class="ident" id="6706258">nil</span>&nbsp;<span class="op" id="6706262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706267">t</span><span class="op" id="6706268">.</span><span class="ident" id="6706269">Fatalf</span><span class="op" id="6706275">(</span><span class="string" id="6706276">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6706298">,</span>&nbsp;<span class="ident" id="6706300">err</span><span class="op" id="6706303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706311">defer</span>&nbsp;<span class="ident" id="6706317">ln</span><span class="op" id="6706319">.</span><span class="ident" id="6706320">Close</span><span class="op" id="6706325">(</span><span class="op" id="6706326">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706330">la</span>&nbsp;<span class="op" id="6706333">:=</span>&nbsp;<span class="ident" id="6706336">ln</span><span class="op" id="6706338">.</span><span class="ident" id="6706339">Addr</span><span class="op" id="6706343">(</span><span class="op" id="6706344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706348">if</span>&nbsp;<span class="ident" id="6706351">a</span><span class="op" id="6706352">,</span>&nbsp;<span class="ident" id="6706354">ok</span>&nbsp;<span class="op" id="6706357">:=</span>&nbsp;<span class="ident" id="6706360">la</span><span class="op" id="6706362">.</span><span class="op" id="6706363">(</span><span class="op" id="6706364">*</span><span class="ident" id="6706365">TCPAddr</span><span class="op" id="6706372">)</span><span class="op" id="6706373">;</span>&nbsp;<span class="op" id="6706375">!</span><span class="ident" id="6706376">ok</span>&nbsp;<span class="op" id="6706379">||</span>&nbsp;<span class="ident" id="6706382">a</span><span class="op" id="6706383">.</span><span class="ident" id="6706384">Port</span>&nbsp;<span class="op" id="6706389">==</span>&nbsp;<span class="num" id="6706392">0</span>&nbsp;<span class="op" id="6706394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706399">t</span><span class="op" id="6706400">.</span><span class="ident" id="6706401">Fatalf</span><span class="op" id="6706407">(</span><span class="string" id="6706408">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="6706469">,</span>&nbsp;<span class="ident" id="6706471">la</span><span class="op" id="6706473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706480">}</span><br>
<span class="lineno">375</span><span class="op" id="6706482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6706485">func</span>&nbsp;<span class="ident" id="6706490">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="6706517">(</span><span class="ident" id="6706518">t</span>&nbsp;<span class="op" id="6706520">*</span><span class="ident" id="6706521">testing</span><span class="op" id="6706528">.</span><span class="ident" id="6706529">T</span><span class="op" id="6706530">)</span>&nbsp;<span class="op" id="6706532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706535">if</span>&nbsp;<span class="ident" id="6706538">testing</span><span class="op" id="6706545">.</span><span class="ident" id="6706546">Short</span><span class="op" id="6706551">(</span><span class="op" id="6706552">)</span>&nbsp;<span class="op" id="6706554">||</span>&nbsp;<span class="op" id="6706557">!</span><span class="op" id="6706558">*</span><span class="ident" id="6706559">testExternal</span>&nbsp;<span class="op" id="6706572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706576">t</span><span class="op" id="6706577">.</span><span class="ident" id="6706578">Skip</span><span class="op" id="6706582">(</span><span class="string" id="6706583">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6706624">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706630">if</span>&nbsp;<span class="op" id="6706633">!</span><span class="ident" id="6706634">supportsIPv6</span>&nbsp;<span class="op" id="6706647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706651">t</span><span class="op" id="6706652">.</span><span class="ident" id="6706653">Skip</span><span class="op" id="6706657">(</span><span class="string" id="6706658">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6706681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706687">ifi</span>&nbsp;<span class="op" id="6706691">:=</span>&nbsp;<span class="ident" id="6706694">loopbackInterface</span><span class="op" id="6706711">(</span><span class="op" id="6706712">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706715">if</span>&nbsp;<span class="ident" id="6706718">ifi</span>&nbsp;<span class="op" id="6706722">==</span>&nbsp;<span class="ident" id="6706725">nil</span>&nbsp;<span class="op" id="6706729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706733">t</span><span class="op" id="6706734">.</span><span class="ident" id="6706735">Skip</span><span class="op" id="6706739">(</span><span class="string" id="6706740">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="6706770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706776">laddr</span>&nbsp;<span class="op" id="6706782">:=</span>&nbsp;<span class="ident" id="6706785">ipv6LinkLocalUnicastAddr</span><span class="op" id="6706809">(</span><span class="ident" id="6706810">ifi</span><span class="op" id="6706813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706816">if</span>&nbsp;<span class="ident" id="6706819">laddr</span>&nbsp;<span class="op" id="6706825">==</span>&nbsp;<span class="string" id="6706828">&#34;&#34;</span>&nbsp;<span class="op" id="6706831">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706835">t</span><span class="op" id="6706836">.</span><span class="ident" id="6706837">Skip</span><span class="op" id="6706841">(</span><span class="string" id="6706842">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="6706886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706893">type</span>&nbsp;<span class="ident" id="6706898">test</span>&nbsp;<span class="keyword" id="6706903">struct</span>&nbsp;<span class="op" id="6706910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706914">net</span><span class="op" id="6706917">,</span>&nbsp;<span class="ident" id="6706919">addr</span>&nbsp;&nbsp;<span class="builtintype" id="6706925">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6706934">nameLookup</span>&nbsp;<span class="builtintype" id="6706945">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6706954">var</span>&nbsp;<span class="ident" id="6706958">tests</span>&nbsp;<span class="op" id="6706964">=</span>&nbsp;<span class="op" id="6706966">[</span><span class="op" id="6706967">]</span><span class="ident" id="6706968">test</span><span class="op" id="6706972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6706976">{</span><span class="string" id="6706977">&#34;tcp&#34;</span><span class="op" id="6706982">,</span>&nbsp;<span class="string" id="6706984">&#34;[&#34;</span>&nbsp;<span class="op" id="6706988">+</span>&nbsp;<span class="ident" id="6706990">laddr</span>&nbsp;<span class="op" id="6706996">+</span>&nbsp;<span class="string" id="6706998">&#34;%&#34;</span>&nbsp;<span class="op" id="6707002">+</span>&nbsp;<span class="ident" id="6707004">ifi</span><span class="op" id="6707007">.</span><span class="ident" id="6707008">Name</span>&nbsp;<span class="op" id="6707013">+</span>&nbsp;<span class="string" id="6707015">&#34;]:0&#34;</span><span class="op" id="6707020">,</span>&nbsp;<span class="builtintype" id="6707022">false</span><span class="op" id="6707027">}</span><span class="op" id="6707028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707032">{</span><span class="string" id="6707033">&#34;tcp6&#34;</span><span class="op" id="6707039">,</span>&nbsp;<span class="string" id="6707041">&#34;[&#34;</span>&nbsp;<span class="op" id="6707045">+</span>&nbsp;<span class="ident" id="6707047">laddr</span>&nbsp;<span class="op" id="6707053">+</span>&nbsp;<span class="string" id="6707055">&#34;%&#34;</span>&nbsp;<span class="op" id="6707059">+</span>&nbsp;<span class="ident" id="6707061">ifi</span><span class="op" id="6707064">.</span><span class="ident" id="6707065">Name</span>&nbsp;<span class="op" id="6707070">+</span>&nbsp;<span class="string" id="6707072">&#34;]:0&#34;</span><span class="op" id="6707077">,</span>&nbsp;<span class="builtintype" id="6707079">false</span><span class="op" id="6707084">}</span><span class="op" id="6707085">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707091">switch</span>&nbsp;<span class="ident" id="6707098">runtime</span><span class="op" id="6707105">.</span><span class="ident" id="6707106">GOOS</span>&nbsp;<span class="op" id="6707111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707114">case</span>&nbsp;<span class="string" id="6707119">&#34;darwin&#34;</span><span class="op" id="6707127">,</span>&nbsp;<span class="string" id="6707129">&#34;freebsd&#34;</span><span class="op" id="6707138">,</span>&nbsp;<span class="string" id="6707140">&#34;openbsd&#34;</span><span class="op" id="6707149">,</span>&nbsp;<span class="string" id="6707151">&#34;netbsd&#34;</span><span class="op" id="6707159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707163">tests</span>&nbsp;<span class="op" id="6707169">=</span>&nbsp;<span class="builtinfunc" id="6707171">append</span><span class="op" id="6707177">(</span><span class="ident" id="6707178">tests</span><span class="op" id="6707183">,</span>&nbsp;<span class="op" id="6707185">[</span><span class="op" id="6707186">]</span><span class="ident" id="6707187">test</span><span class="op" id="6707191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707196">{</span><span class="string" id="6707197">&#34;tcp&#34;</span><span class="op" id="6707202">,</span>&nbsp;<span class="string" id="6707204">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6707218">+</span>&nbsp;<span class="ident" id="6707220">ifi</span><span class="op" id="6707223">.</span><span class="ident" id="6707224">Name</span>&nbsp;<span class="op" id="6707229">+</span>&nbsp;<span class="string" id="6707231">&#34;]:0&#34;</span><span class="op" id="6707236">,</span>&nbsp;<span class="builtintype" id="6707238">true</span><span class="op" id="6707242">}</span><span class="op" id="6707243">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707248">{</span><span class="string" id="6707249">&#34;tcp6&#34;</span><span class="op" id="6707255">,</span>&nbsp;<span class="string" id="6707257">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6707271">+</span>&nbsp;<span class="ident" id="6707273">ifi</span><span class="op" id="6707276">.</span><span class="ident" id="6707277">Name</span>&nbsp;<span class="op" id="6707282">+</span>&nbsp;<span class="string" id="6707284">&#34;]:0&#34;</span><span class="op" id="6707289">,</span>&nbsp;<span class="builtintype" id="6707291">true</span><span class="op" id="6707295">}</span><span class="op" id="6707296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707300">}</span><span class="op" id="6707301">...</span><span class="op" id="6707304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707307">case</span>&nbsp;<span class="string" id="6707312">&#34;linux&#34;</span><span class="op" id="6707319">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707323">tests</span>&nbsp;<span class="op" id="6707329">=</span>&nbsp;<span class="builtinfunc" id="6707331">append</span><span class="op" id="6707337">(</span><span class="ident" id="6707338">tests</span><span class="op" id="6707343">,</span>&nbsp;<span class="op" id="6707345">[</span><span class="op" id="6707346">]</span><span class="ident" id="6707347">test</span><span class="op" id="6707351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707356">{</span><span class="string" id="6707357">&#34;tcp&#34;</span><span class="op" id="6707362">,</span>&nbsp;<span class="string" id="6707364">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6707382">+</span>&nbsp;<span class="ident" id="6707384">ifi</span><span class="op" id="6707387">.</span><span class="ident" id="6707388">Name</span>&nbsp;<span class="op" id="6707393">+</span>&nbsp;<span class="string" id="6707395">&#34;]:0&#34;</span><span class="op" id="6707400">,</span>&nbsp;<span class="builtintype" id="6707402">true</span><span class="op" id="6707406">}</span><span class="op" id="6707407">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707412">{</span><span class="string" id="6707413">&#34;tcp6&#34;</span><span class="op" id="6707419">,</span>&nbsp;<span class="string" id="6707421">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6707439">+</span>&nbsp;<span class="ident" id="6707441">ifi</span><span class="op" id="6707444">.</span><span class="ident" id="6707445">Name</span>&nbsp;<span class="op" id="6707450">+</span>&nbsp;<span class="string" id="6707452">&#34;]:0&#34;</span><span class="op" id="6707457">,</span>&nbsp;<span class="builtintype" id="6707459">true</span><span class="op" id="6707463">}</span><span class="op" id="6707464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707468">}</span><span class="op" id="6707469">...</span><span class="op" id="6707472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707478">for</span>&nbsp;<span class="ident" id="6707482">_</span><span class="op" id="6707483">,</span>&nbsp;<span class="ident" id="6707485">tt</span>&nbsp;<span class="op" id="6707488">:=</span>&nbsp;<span class="keyword" id="6707491">range</span>&nbsp;<span class="ident" id="6707497">tests</span>&nbsp;<span class="op" id="6707503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707507">ln</span><span class="op" id="6707509">,</span>&nbsp;<span class="ident" id="6707511">err</span>&nbsp;<span class="op" id="6707515">:=</span>&nbsp;<span class="ident" id="6707518">Listen</span><span class="op" id="6707524">(</span><span class="ident" id="6707525">tt</span><span class="op" id="6707527">.</span><span class="ident" id="6707528">net</span><span class="op" id="6707531">,</span>&nbsp;<span class="ident" id="6707533">tt</span><span class="op" id="6707535">.</span><span class="ident" id="6707536">addr</span><span class="op" id="6707540">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707544">if</span>&nbsp;<span class="ident" id="6707547">err</span>&nbsp;<span class="op" id="6707551">!=</span>&nbsp;<span class="ident" id="6707554">nil</span>&nbsp;<span class="op" id="6707558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6707563">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6707609">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707658">t</span><span class="op" id="6707659">.</span><span class="ident" id="6707660">Logf</span><span class="op" id="6707664">(</span><span class="string" id="6707665">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6707684">,</span>&nbsp;<span class="ident" id="6707686">err</span><span class="op" id="6707689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707694">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707709">defer</span>&nbsp;<span class="ident" id="6707715">ln</span><span class="op" id="6707717">.</span><span class="ident" id="6707718">Close</span><span class="op" id="6707723">(</span><span class="op" id="6707724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707728">if</span>&nbsp;<span class="ident" id="6707731">la</span><span class="op" id="6707733">,</span>&nbsp;<span class="ident" id="6707735">ok</span>&nbsp;<span class="op" id="6707738">:=</span>&nbsp;<span class="ident" id="6707741">ln</span><span class="op" id="6707743">.</span><span class="ident" id="6707744">Addr</span><span class="op" id="6707748">(</span><span class="op" id="6707749">)</span><span class="op" id="6707750">.</span><span class="op" id="6707751">(</span><span class="op" id="6707752">*</span><span class="ident" id="6707753">TCPAddr</span><span class="op" id="6707760">)</span><span class="op" id="6707761">;</span>&nbsp;<span class="op" id="6707763">!</span><span class="ident" id="6707764">ok</span>&nbsp;<span class="op" id="6707767">||</span>&nbsp;<span class="op" id="6707770">!</span><span class="ident" id="6707771">tt</span><span class="op" id="6707773">.</span><span class="ident" id="6707774">nameLookup</span>&nbsp;<span class="op" id="6707785">&amp;&amp;</span>&nbsp;<span class="ident" id="6707788">la</span><span class="op" id="6707790">.</span><span class="ident" id="6707791">Zone</span>&nbsp;<span class="op" id="6707796">==</span>&nbsp;<span class="string" id="6707799">&#34;&#34;</span>&nbsp;<span class="op" id="6707802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707807">t</span><span class="op" id="6707808">.</span><span class="ident" id="6707809">Fatalf</span><span class="op" id="6707815">(</span><span class="string" id="6707816">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6707872">,</span>&nbsp;<span class="ident" id="6707874">la</span><span class="op" id="6707876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6707880">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707885">done</span>&nbsp;<span class="op" id="6707890">:=</span>&nbsp;<span class="builtinfunc" id="6707893">make</span><span class="op" id="6707897">(</span><span class="keyword" id="6707898">chan</span>&nbsp;<span class="builtintype" id="6707903">int</span><span class="op" id="6707906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707910">go</span>&nbsp;<span class="ident" id="6707913">transponder</span><span class="op" id="6707924">(</span><span class="ident" id="6707925">t</span><span class="op" id="6707926">,</span>&nbsp;<span class="ident" id="6707928">ln</span><span class="op" id="6707930">,</span>&nbsp;<span class="ident" id="6707932">done</span><span class="op" id="6707936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6707941">c</span><span class="op" id="6707942">,</span>&nbsp;<span class="ident" id="6707944">err</span>&nbsp;<span class="op" id="6707948">:=</span>&nbsp;<span class="ident" id="6707951">Dial</span><span class="op" id="6707955">(</span><span class="ident" id="6707956">tt</span><span class="op" id="6707958">.</span><span class="ident" id="6707959">net</span><span class="op" id="6707962">,</span>&nbsp;<span class="ident" id="6707964">ln</span><span class="op" id="6707966">.</span><span class="ident" id="6707967">Addr</span><span class="op" id="6707971">(</span><span class="op" id="6707972">)</span><span class="op" id="6707973">.</span><span class="ident" id="6707974">String</span><span class="op" id="6707980">(</span><span class="op" id="6707981">)</span><span class="op" id="6707982">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6707986">if</span>&nbsp;<span class="ident" id="6707989">err</span>&nbsp;<span class="op" id="6707993">!=</span>&nbsp;<span class="ident" id="6707996">nil</span>&nbsp;<span class="op" id="6708000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708005">t</span><span class="op" id="6708006">.</span><span class="ident" id="6708007">Fatalf</span><span class="op" id="6708013">(</span><span class="string" id="6708014">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6708031">,</span>&nbsp;<span class="ident" id="6708033">err</span><span class="op" id="6708036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708044">defer</span>&nbsp;<span class="ident" id="6708050">c</span><span class="op" id="6708051">.</span><span class="ident" id="6708052">Close</span><span class="op" id="6708057">(</span><span class="op" id="6708058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708062">if</span>&nbsp;<span class="ident" id="6708065">la</span><span class="op" id="6708067">,</span>&nbsp;<span class="ident" id="6708069">ok</span>&nbsp;<span class="op" id="6708072">:=</span>&nbsp;<span class="ident" id="6708075">c</span><span class="op" id="6708076">.</span><span class="ident" id="6708077">LocalAddr</span><span class="op" id="6708086">(</span><span class="op" id="6708087">)</span><span class="op" id="6708088">.</span><span class="op" id="6708089">(</span><span class="op" id="6708090">*</span><span class="ident" id="6708091">TCPAddr</span><span class="op" id="6708098">)</span><span class="op" id="6708099">;</span>&nbsp;<span class="op" id="6708101">!</span><span class="ident" id="6708102">ok</span>&nbsp;<span class="op" id="6708105">||</span>&nbsp;<span class="op" id="6708108">!</span><span class="ident" id="6708109">tt</span><span class="op" id="6708111">.</span><span class="ident" id="6708112">nameLookup</span>&nbsp;<span class="op" id="6708123">&amp;&amp;</span>&nbsp;<span class="ident" id="6708126">la</span><span class="op" id="6708128">.</span><span class="ident" id="6708129">Zone</span>&nbsp;<span class="op" id="6708134">==</span>&nbsp;<span class="string" id="6708137">&#34;&#34;</span>&nbsp;<span class="op" id="6708140">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708145">t</span><span class="op" id="6708146">.</span><span class="ident" id="6708147">Fatalf</span><span class="op" id="6708153">(</span><span class="string" id="6708154">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6708210">,</span>&nbsp;<span class="ident" id="6708212">la</span><span class="op" id="6708214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708222">if</span>&nbsp;<span class="ident" id="6708225">ra</span><span class="op" id="6708227">,</span>&nbsp;<span class="ident" id="6708229">ok</span>&nbsp;<span class="op" id="6708232">:=</span>&nbsp;<span class="ident" id="6708235">c</span><span class="op" id="6708236">.</span><span class="ident" id="6708237">RemoteAddr</span><span class="op" id="6708247">(</span><span class="op" id="6708248">)</span><span class="op" id="6708249">.</span><span class="op" id="6708250">(</span><span class="op" id="6708251">*</span><span class="ident" id="6708252">TCPAddr</span><span class="op" id="6708259">)</span><span class="op" id="6708260">;</span>&nbsp;<span class="op" id="6708262">!</span><span class="ident" id="6708263">ok</span>&nbsp;<span class="op" id="6708266">||</span>&nbsp;<span class="op" id="6708269">!</span><span class="ident" id="6708270">tt</span><span class="op" id="6708272">.</span><span class="ident" id="6708273">nameLookup</span>&nbsp;<span class="op" id="6708284">&amp;&amp;</span>&nbsp;<span class="ident" id="6708287">ra</span><span class="op" id="6708289">.</span><span class="ident" id="6708290">Zone</span>&nbsp;<span class="op" id="6708295">==</span>&nbsp;<span class="string" id="6708298">&#34;&#34;</span>&nbsp;<span class="op" id="6708301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708306">t</span><span class="op" id="6708307">.</span><span class="ident" id="6708308">Fatalf</span><span class="op" id="6708314">(</span><span class="string" id="6708315">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6708371">,</span>&nbsp;<span class="ident" id="6708373">ra</span><span class="op" id="6708375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708379">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708384">if</span>&nbsp;<span class="ident" id="6708387">_</span><span class="op" id="6708388">,</span>&nbsp;<span class="ident" id="6708390">err</span>&nbsp;<span class="op" id="6708394">:=</span>&nbsp;<span class="ident" id="6708397">c</span><span class="op" id="6708398">.</span><span class="ident" id="6708399">Write</span><span class="op" id="6708404">(</span><span class="op" id="6708405">[</span><span class="op" id="6708406">]</span><span class="builtintype" id="6708407">byte</span><span class="op" id="6708411">(</span><span class="string" id="6708412">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="6708442">)</span><span class="op" id="6708443">)</span><span class="op" id="6708444">;</span>&nbsp;<span class="ident" id="6708446">err</span>&nbsp;<span class="op" id="6708450">!=</span>&nbsp;<span class="ident" id="6708453">nil</span>&nbsp;<span class="op" id="6708457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708462">t</span><span class="op" id="6708463">.</span><span class="ident" id="6708464">Fatalf</span><span class="op" id="6708470">(</span><span class="string" id="6708471">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6708494">,</span>&nbsp;<span class="ident" id="6708496">err</span><span class="op" id="6708499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708507">b</span>&nbsp;<span class="op" id="6708509">:=</span>&nbsp;<span class="builtinfunc" id="6708512">make</span><span class="op" id="6708516">(</span><span class="op" id="6708517">[</span><span class="op" id="6708518">]</span><span class="builtintype" id="6708519">byte</span><span class="op" id="6708523">,</span>&nbsp;<span class="num" id="6708525">32</span><span class="op" id="6708527">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708531">if</span>&nbsp;<span class="ident" id="6708534">_</span><span class="op" id="6708535">,</span>&nbsp;<span class="ident" id="6708537">err</span>&nbsp;<span class="op" id="6708541">:=</span>&nbsp;<span class="ident" id="6708544">c</span><span class="op" id="6708545">.</span><span class="ident" id="6708546">Read</span><span class="op" id="6708550">(</span><span class="ident" id="6708551">b</span><span class="op" id="6708552">)</span><span class="op" id="6708553">;</span>&nbsp;<span class="ident" id="6708555">err</span>&nbsp;<span class="op" id="6708559">!=</span>&nbsp;<span class="ident" id="6708562">nil</span>&nbsp;<span class="op" id="6708566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708571">t</span><span class="op" id="6708572">.</span><span class="ident" id="6708573">Fatalf</span><span class="op" id="6708579">(</span><span class="string" id="6708580">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6708602">,</span>&nbsp;<span class="ident" id="6708604">err</span><span class="op" id="6708607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708616">&lt;-</span><span class="ident" id="6708618">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708624">}</span><br>
<span class="lineno"></span><span class="op" id="6708626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6708629">func</span>&nbsp;<span class="ident" id="6708634">TestTCPConcurrentAccept</span><span class="op" id="6708657">(</span><span class="ident" id="6708658">t</span>&nbsp;<span class="op" id="6708660">*</span><span class="ident" id="6708661">testing</span><span class="op" id="6708668">.</span><span class="ident" id="6708669">T</span><span class="op" id="6708670">)</span>&nbsp;<span class="op" id="6708672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708675">defer</span>&nbsp;<span class="ident" id="6708681">runtime</span><span class="op" id="6708688">.</span><span class="ident" id="6708689">GOMAXPROCS</span><span class="op" id="6708699">(</span><span class="ident" id="6708700">runtime</span><span class="op" id="6708707">.</span><span class="ident" id="6708708">GOMAXPROCS</span><span class="op" id="6708718">(</span><span class="num" id="6708719">4</span><span class="op" id="6708720">)</span><span class="op" id="6708721">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708724">ln</span><span class="op" id="6708726">,</span>&nbsp;<span class="ident" id="6708728">err</span>&nbsp;<span class="op" id="6708732">:=</span>&nbsp;<span class="ident" id="6708735">Listen</span><span class="op" id="6708741">(</span><span class="string" id="6708742">&#34;tcp&#34;</span><span class="op" id="6708747">,</span>&nbsp;<span class="string" id="6708749">&#34;127.0.0.1:0&#34;</span><span class="op" id="6708762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708765">if</span>&nbsp;<span class="ident" id="6708768">err</span>&nbsp;<span class="op" id="6708772">!=</span>&nbsp;<span class="ident" id="6708775">nil</span>&nbsp;<span class="op" id="6708779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708783">t</span><span class="op" id="6708784">.</span><span class="ident" id="6708785">Fatalf</span><span class="op" id="6708791">(</span><span class="string" id="6708792">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6708811">,</span>&nbsp;<span class="ident" id="6708813">err</span><span class="op" id="6708816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708822">const</span>&nbsp;<span class="ident" id="6708828">N</span>&nbsp;<span class="op" id="6708830">=</span>&nbsp;<span class="num" id="6708832">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708836">var</span>&nbsp;<span class="ident" id="6708840">wg</span>&nbsp;<span class="ident" id="6708843">sync</span><span class="op" id="6708847">.</span><span class="ident" id="6708848">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708859">wg</span><span class="op" id="6708861">.</span><span class="ident" id="6708862">Add</span><span class="op" id="6708865">(</span><span class="ident" id="6708866">N</span><span class="op" id="6708867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708870">for</span>&nbsp;<span class="ident" id="6708874">i</span>&nbsp;<span class="op" id="6708876">:=</span>&nbsp;<span class="num" id="6708879">0</span><span class="op" id="6708880">;</span>&nbsp;<span class="ident" id="6708882">i</span>&nbsp;<span class="op" id="6708884">&lt;</span>&nbsp;<span class="ident" id="6708886">N</span><span class="op" id="6708887">;</span>&nbsp;<span class="ident" id="6708889">i</span><span class="op" id="6708890">++</span>&nbsp;<span class="op" id="6708893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708897">go</span>&nbsp;<span class="keyword" id="6708900">func</span><span class="op" id="6708904">(</span><span class="op" id="6708905">)</span>&nbsp;<span class="op" id="6708907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708912">for</span>&nbsp;<span class="op" id="6708916">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708922">c</span><span class="op" id="6708923">,</span>&nbsp;<span class="ident" id="6708925">err</span>&nbsp;<span class="op" id="6708929">:=</span>&nbsp;<span class="ident" id="6708932">ln</span><span class="op" id="6708934">.</span><span class="ident" id="6708935">Accept</span><span class="op" id="6708941">(</span><span class="op" id="6708942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708948">if</span>&nbsp;<span class="ident" id="6708951">err</span>&nbsp;<span class="op" id="6708955">!=</span>&nbsp;<span class="ident" id="6708958">nil</span>&nbsp;<span class="op" id="6708962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6708969">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6708985">c</span><span class="op" id="6708986">.</span><span class="ident" id="6708987">Close</span><span class="op" id="6708992">(</span><span class="op" id="6708993">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6708998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709003">wg</span><span class="op" id="6709005">.</span><span class="ident" id="6709006">Done</span><span class="op" id="6709010">(</span><span class="op" id="6709011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709015">}</span><span class="op" id="6709016">(</span><span class="op" id="6709017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709023">attempts</span>&nbsp;<span class="op" id="6709032">:=</span>&nbsp;<span class="num" id="6709035">10</span>&nbsp;<span class="op" id="6709038">*</span>&nbsp;<span class="ident" id="6709040">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709043">fails</span>&nbsp;<span class="op" id="6709049">:=</span>&nbsp;<span class="num" id="6709052">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709055">d</span>&nbsp;<span class="op" id="6709057">:=</span>&nbsp;<span class="op" id="6709060">&amp;</span><span class="ident" id="6709061">Dialer</span><span class="op" id="6709067">{</span><span class="ident" id="6709068">Timeout</span><span class="op" id="6709075">:</span>&nbsp;<span class="num" id="6709077">200</span>&nbsp;<span class="op" id="6709081">*</span>&nbsp;<span class="ident" id="6709083">time</span><span class="op" id="6709087">.</span><span class="ident" id="6709088">Millisecond</span><span class="op" id="6709099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709102">for</span>&nbsp;<span class="ident" id="6709106">i</span>&nbsp;<span class="op" id="6709108">:=</span>&nbsp;<span class="num" id="6709111">0</span><span class="op" id="6709112">;</span>&nbsp;<span class="ident" id="6709114">i</span>&nbsp;<span class="op" id="6709116">&lt;</span>&nbsp;<span class="ident" id="6709118">attempts</span><span class="op" id="6709126">;</span>&nbsp;<span class="ident" id="6709128">i</span><span class="op" id="6709129">++</span>&nbsp;<span class="op" id="6709132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709136">c</span><span class="op" id="6709137">,</span>&nbsp;<span class="ident" id="6709139">err</span>&nbsp;<span class="op" id="6709143">:=</span>&nbsp;<span class="ident" id="6709146">d</span><span class="op" id="6709147">.</span><span class="ident" id="6709148">Dial</span><span class="op" id="6709152">(</span><span class="string" id="6709153">&#34;tcp&#34;</span><span class="op" id="6709158">,</span>&nbsp;<span class="ident" id="6709160">ln</span><span class="op" id="6709162">.</span><span class="ident" id="6709163">Addr</span><span class="op" id="6709167">(</span><span class="op" id="6709168">)</span><span class="op" id="6709169">.</span><span class="ident" id="6709170">String</span><span class="op" id="6709176">(</span><span class="op" id="6709177">)</span><span class="op" id="6709178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709182">if</span>&nbsp;<span class="ident" id="6709185">err</span>&nbsp;<span class="op" id="6709189">!=</span>&nbsp;<span class="ident" id="6709192">nil</span>&nbsp;<span class="op" id="6709196">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709201">fails</span><span class="op" id="6709206">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709211">}</span>&nbsp;<span class="keyword" id="6709213">else</span>&nbsp;<span class="op" id="6709218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709223">c</span><span class="op" id="6709224">.</span><span class="ident" id="6709225">Close</span><span class="op" id="6709230">(</span><span class="op" id="6709231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709238">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709241">ln</span><span class="op" id="6709243">.</span><span class="ident" id="6709244">Close</span><span class="op" id="6709249">(</span><span class="op" id="6709250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709253">wg</span><span class="op" id="6709255">.</span><span class="ident" id="6709256">Wait</span><span class="op" id="6709260">(</span><span class="op" id="6709261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709264">if</span>&nbsp;<span class="ident" id="6709267">fails</span>&nbsp;<span class="op" id="6709273">&gt;</span>&nbsp;<span class="ident" id="6709275">attempts</span><span class="op" id="6709283">/</span><span class="num" id="6709284">9</span>&nbsp;<span class="op" id="6709286">{</span>&nbsp;<span class="comment" id="6709288">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709318">t</span><span class="op" id="6709319">.</span><span class="ident" id="6709320">Fatalf</span><span class="op" id="6709326">(</span><span class="string" id="6709327">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6709353">,</span>&nbsp;<span class="ident" id="6709355">fails</span><span class="op" id="6709360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709363">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709366">if</span>&nbsp;<span class="ident" id="6709369">fails</span>&nbsp;<span class="op" id="6709375">&gt;</span>&nbsp;<span class="num" id="6709377">0</span>&nbsp;<span class="op" id="6709379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709383">t</span><span class="op" id="6709384">.</span><span class="ident" id="6709385">Logf</span><span class="op" id="6709389">(</span><span class="string" id="6709390">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="6709413">,</span>&nbsp;<span class="ident" id="6709415">fails</span><span class="op" id="6709420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709423">}</span><br>
<span class="lineno"></span><span class="op" id="6709425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="6709428">func</span>&nbsp;<span class="ident" id="6709433">TestTCPReadWriteMallocs</span><span class="op" id="6709456">(</span><span class="ident" id="6709457">t</span>&nbsp;<span class="op" id="6709459">*</span><span class="ident" id="6709460">testing</span><span class="op" id="6709467">.</span><span class="ident" id="6709468">T</span><span class="op" id="6709469">)</span>&nbsp;<span class="op" id="6709471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709474">if</span>&nbsp;<span class="ident" id="6709477">testing</span><span class="op" id="6709484">.</span><span class="ident" id="6709485">Short</span><span class="op" id="6709490">(</span><span class="op" id="6709491">)</span>&nbsp;<span class="op" id="6709493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709497">t</span><span class="op" id="6709498">.</span><span class="ident" id="6709499">Skip</span><span class="op" id="6709503">(</span><span class="string" id="6709504">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6709541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709547">ln</span><span class="op" id="6709549">,</span>&nbsp;<span class="ident" id="6709551">err</span>&nbsp;<span class="op" id="6709555">:=</span>&nbsp;<span class="ident" id="6709558">Listen</span><span class="op" id="6709564">(</span><span class="string" id="6709565">&#34;tcp&#34;</span><span class="op" id="6709570">,</span>&nbsp;<span class="string" id="6709572">&#34;127.0.0.1:0&#34;</span><span class="op" id="6709585">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709588">if</span>&nbsp;<span class="ident" id="6709591">err</span>&nbsp;<span class="op" id="6709595">!=</span>&nbsp;<span class="ident" id="6709598">nil</span>&nbsp;<span class="op" id="6709602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709606">t</span><span class="op" id="6709607">.</span><span class="ident" id="6709608">Fatalf</span><span class="op" id="6709614">(</span><span class="string" id="6709615">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6709634">,</span>&nbsp;<span class="ident" id="6709636">err</span><span class="op" id="6709639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709645">defer</span>&nbsp;<span class="ident" id="6709651">ln</span><span class="op" id="6709653">.</span><span class="ident" id="6709654">Close</span><span class="op" id="6709659">(</span><span class="op" id="6709660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709663">var</span>&nbsp;<span class="ident" id="6709667">server</span>&nbsp;<span class="ident" id="6709674">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709680">errc</span>&nbsp;<span class="op" id="6709685">:=</span>&nbsp;<span class="builtinfunc" id="6709688">make</span><span class="op" id="6709692">(</span><span class="keyword" id="6709693">chan</span>&nbsp;<span class="builtintype" id="6709698">error</span><span class="op" id="6709703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709706">go</span>&nbsp;<span class="keyword" id="6709709">func</span><span class="op" id="6709713">(</span><span class="op" id="6709714">)</span>&nbsp;<span class="op" id="6709716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709720">var</span>&nbsp;<span class="ident" id="6709724">err</span>&nbsp;<span class="builtintype" id="6709728">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709736">server</span><span class="op" id="6709742">,</span>&nbsp;<span class="ident" id="6709744">err</span>&nbsp;<span class="op" id="6709748">=</span>&nbsp;<span class="ident" id="6709750">ln</span><span class="op" id="6709752">.</span><span class="ident" id="6709753">Accept</span><span class="op" id="6709759">(</span><span class="op" id="6709760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709764">errc</span>&nbsp;<span class="op" id="6709769">&lt;-</span>&nbsp;<span class="ident" id="6709772">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709777">}</span><span class="op" id="6709778">(</span><span class="op" id="6709779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709782">client</span><span class="op" id="6709788">,</span>&nbsp;<span class="ident" id="6709790">err</span>&nbsp;<span class="op" id="6709794">:=</span>&nbsp;<span class="ident" id="6709797">Dial</span><span class="op" id="6709801">(</span><span class="string" id="6709802">&#34;tcp&#34;</span><span class="op" id="6709807">,</span>&nbsp;<span class="ident" id="6709809">ln</span><span class="op" id="6709811">.</span><span class="ident" id="6709812">Addr</span><span class="op" id="6709816">(</span><span class="op" id="6709817">)</span><span class="op" id="6709818">.</span><span class="ident" id="6709819">String</span><span class="op" id="6709825">(</span><span class="op" id="6709826">)</span><span class="op" id="6709827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709830">if</span>&nbsp;<span class="ident" id="6709833">err</span>&nbsp;<span class="op" id="6709837">!=</span>&nbsp;<span class="ident" id="6709840">nil</span>&nbsp;<span class="op" id="6709844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709848">t</span><span class="op" id="6709849">.</span><span class="ident" id="6709850">Fatalf</span><span class="op" id="6709856">(</span><span class="string" id="6709857">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6709874">,</span>&nbsp;<span class="ident" id="6709876">err</span><span class="op" id="6709879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709882">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709885">if</span>&nbsp;<span class="ident" id="6709888">err</span>&nbsp;<span class="op" id="6709892">:=</span>&nbsp;<span class="op" id="6709895">&lt;-</span><span class="ident" id="6709897">errc</span><span class="op" id="6709901">;</span>&nbsp;<span class="ident" id="6709903">err</span>&nbsp;<span class="op" id="6709907">!=</span>&nbsp;<span class="ident" id="6709910">nil</span>&nbsp;<span class="op" id="6709914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709918">t</span><span class="op" id="6709919">.</span><span class="ident" id="6709920">Fatalf</span><span class="op" id="6709926">(</span><span class="string" id="6709927">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6709946">,</span>&nbsp;<span class="ident" id="6709948">err</span><span class="op" id="6709951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6709954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709957">defer</span>&nbsp;<span class="ident" id="6709963">server</span><span class="op" id="6709969">.</span><span class="ident" id="6709970">Close</span><span class="op" id="6709975">(</span><span class="op" id="6709976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6709979">var</span>&nbsp;<span class="ident" id="6709983">buf</span>&nbsp;<span class="op" id="6709987">[</span><span class="num" id="6709988">128</span><span class="op" id="6709991">]</span><span class="builtintype" id="6709992">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6709998">mallocs</span>&nbsp;<span class="op" id="6710006">:=</span>&nbsp;<span class="ident" id="6710009">testing</span><span class="op" id="6710016">.</span><span class="ident" id="6710017">AllocsPerRun</span><span class="op" id="6710029">(</span><span class="num" id="6710030">1000</span><span class="op" id="6710034">,</span>&nbsp;<span class="keyword" id="6710036">func</span><span class="op" id="6710040">(</span><span class="op" id="6710041">)</span>&nbsp;<span class="op" id="6710043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710047">_</span><span class="op" id="6710048">,</span>&nbsp;<span class="ident" id="6710050">err</span>&nbsp;<span class="op" id="6710054">:=</span>&nbsp;<span class="ident" id="6710057">server</span><span class="op" id="6710063">.</span><span class="ident" id="6710064">Write</span><span class="op" id="6710069">(</span><span class="ident" id="6710070">buf</span><span class="op" id="6710073">[</span><span class="op" id="6710074">:</span><span class="op" id="6710075">]</span><span class="op" id="6710076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710080">if</span>&nbsp;<span class="ident" id="6710083">err</span>&nbsp;<span class="op" id="6710087">!=</span>&nbsp;<span class="ident" id="6710090">nil</span>&nbsp;<span class="op" id="6710094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710099">t</span><span class="op" id="6710100">.</span><span class="ident" id="6710101">Fatalf</span><span class="op" id="6710107">(</span><span class="string" id="6710108">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6710126">,</span>&nbsp;<span class="ident" id="6710128">err</span><span class="op" id="6710131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710135">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710139">_</span><span class="op" id="6710140">,</span>&nbsp;<span class="ident" id="6710142">err</span>&nbsp;<span class="op" id="6710146">=</span>&nbsp;<span class="ident" id="6710148">io</span><span class="op" id="6710150">.</span><span class="ident" id="6710151">ReadFull</span><span class="op" id="6710159">(</span><span class="ident" id="6710160">client</span><span class="op" id="6710166">,</span>&nbsp;<span class="ident" id="6710168">buf</span><span class="op" id="6710171">[</span><span class="op" id="6710172">:</span><span class="op" id="6710173">]</span><span class="op" id="6710174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710178">if</span>&nbsp;<span class="ident" id="6710181">err</span>&nbsp;<span class="op" id="6710185">!=</span>&nbsp;<span class="ident" id="6710188">nil</span>&nbsp;<span class="op" id="6710192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710197">t</span><span class="op" id="6710198">.</span><span class="ident" id="6710199">Fatalf</span><span class="op" id="6710205">(</span><span class="string" id="6710206">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6710223">,</span>&nbsp;<span class="ident" id="6710225">err</span><span class="op" id="6710228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710235">}</span><span class="op" id="6710236">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710239">if</span>&nbsp;<span class="ident" id="6710242">mallocs</span>&nbsp;<span class="op" id="6710250">&gt;</span>&nbsp;<span class="num" id="6710252">0</span>&nbsp;<span class="op" id="6710254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710258">t</span><span class="op" id="6710259">.</span><span class="ident" id="6710260">Fatalf</span><span class="op" id="6710266">(</span><span class="string" id="6710267">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="6710290">,</span>&nbsp;<span class="ident" id="6710292">mallocs</span><span class="op" id="6710299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710302">}</span><br>
<span class="lineno"></span><span class="op" id="6710304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6710307">func</span>&nbsp;<span class="ident" id="6710312">TestTCPStress</span><span class="op" id="6710325">(</span><span class="ident" id="6710326">t</span>&nbsp;<span class="op" id="6710328">*</span><span class="ident" id="6710329">testing</span><span class="op" id="6710336">.</span><span class="ident" id="6710337">T</span><span class="op" id="6710338">)</span>&nbsp;<span class="op" id="6710340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710343">const</span>&nbsp;<span class="ident" id="6710349">conns</span>&nbsp;<span class="op" id="6710355">=</span>&nbsp;<span class="num" id="6710357">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710360">const</span>&nbsp;<span class="ident" id="6710366">msgLen</span>&nbsp;<span class="op" id="6710373">=</span>&nbsp;<span class="num" id="6710375">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710380">msgs</span>&nbsp;<span class="op" id="6710385">:=</span>&nbsp;<span class="builtintype" id="6710388">int</span><span class="op" id="6710391">(</span><span class="num" id="6710392">1e4</span><span class="op" id="6710395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710398">if</span>&nbsp;<span class="ident" id="6710401">testing</span><span class="op" id="6710408">.</span><span class="ident" id="6710409">Short</span><span class="op" id="6710414">(</span><span class="op" id="6710415">)</span>&nbsp;<span class="op" id="6710417">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710421">msgs</span>&nbsp;<span class="op" id="6710426">=</span>&nbsp;<span class="num" id="6710428">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710437">sendMsg</span>&nbsp;<span class="op" id="6710445">:=</span>&nbsp;<span class="keyword" id="6710448">func</span><span class="op" id="6710452">(</span><span class="ident" id="6710453">c</span>&nbsp;<span class="ident" id="6710455">Conn</span><span class="op" id="6710459">,</span>&nbsp;<span class="ident" id="6710461">buf</span>&nbsp;<span class="op" id="6710465">[</span><span class="op" id="6710466">]</span><span class="builtintype" id="6710467">byte</span><span class="op" id="6710471">)</span>&nbsp;<span class="builtintype" id="6710473">bool</span>&nbsp;<span class="op" id="6710478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710482">n</span><span class="op" id="6710483">,</span>&nbsp;<span class="ident" id="6710485">err</span>&nbsp;<span class="op" id="6710489">:=</span>&nbsp;<span class="ident" id="6710492">c</span><span class="op" id="6710493">.</span><span class="ident" id="6710494">Write</span><span class="op" id="6710499">(</span><span class="ident" id="6710500">buf</span><span class="op" id="6710503">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710507">if</span>&nbsp;<span class="ident" id="6710510">n</span>&nbsp;<span class="op" id="6710512">!=</span>&nbsp;<span class="builtinfunc" id="6710515">len</span><span class="op" id="6710518">(</span><span class="ident" id="6710519">buf</span><span class="op" id="6710522">)</span>&nbsp;<span class="op" id="6710524">||</span>&nbsp;<span class="ident" id="6710527">err</span>&nbsp;<span class="op" id="6710531">!=</span>&nbsp;<span class="ident" id="6710534">nil</span>&nbsp;<span class="op" id="6710538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710543">t</span><span class="op" id="6710544">.</span><span class="ident" id="6710545">Logf</span><span class="op" id="6710549">(</span><span class="string" id="6710550">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6710568">,</span>&nbsp;<span class="ident" id="6710570">err</span><span class="op" id="6710573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710578">return</span>&nbsp;<span class="builtintype" id="6710585">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710597">return</span>&nbsp;<span class="builtintype" id="6710604">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710613">recvMsg</span>&nbsp;<span class="op" id="6710621">:=</span>&nbsp;<span class="keyword" id="6710624">func</span><span class="op" id="6710628">(</span><span class="ident" id="6710629">c</span>&nbsp;<span class="ident" id="6710631">Conn</span><span class="op" id="6710635">,</span>&nbsp;<span class="ident" id="6710637">buf</span>&nbsp;<span class="op" id="6710641">[</span><span class="op" id="6710642">]</span><span class="builtintype" id="6710643">byte</span><span class="op" id="6710647">)</span>&nbsp;<span class="builtintype" id="6710649">bool</span>&nbsp;<span class="op" id="6710654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710658">for</span>&nbsp;<span class="ident" id="6710662">read</span>&nbsp;<span class="op" id="6710667">:=</span>&nbsp;<span class="num" id="6710670">0</span><span class="op" id="6710671">;</span>&nbsp;<span class="ident" id="6710673">read</span>&nbsp;<span class="op" id="6710678">!=</span>&nbsp;<span class="builtinfunc" id="6710681">len</span><span class="op" id="6710684">(</span><span class="ident" id="6710685">buf</span><span class="op" id="6710688">)</span><span class="op" id="6710689">;</span>&nbsp;<span class="op" id="6710691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710696">n</span><span class="op" id="6710697">,</span>&nbsp;<span class="ident" id="6710699">err</span>&nbsp;<span class="op" id="6710703">:=</span>&nbsp;<span class="ident" id="6710706">c</span><span class="op" id="6710707">.</span><span class="ident" id="6710708">Read</span><span class="op" id="6710712">(</span><span class="ident" id="6710713">buf</span><span class="op" id="6710716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710721">read</span>&nbsp;<span class="op" id="6710726">+=</span>&nbsp;<span class="ident" id="6710729">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710734">if</span>&nbsp;<span class="ident" id="6710737">err</span>&nbsp;<span class="op" id="6710741">!=</span>&nbsp;<span class="ident" id="6710744">nil</span>&nbsp;<span class="op" id="6710748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710754">t</span><span class="op" id="6710755">.</span><span class="ident" id="6710756">Logf</span><span class="op" id="6710760">(</span><span class="string" id="6710761">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6710778">,</span>&nbsp;<span class="ident" id="6710780">err</span><span class="op" id="6710783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710789">return</span>&nbsp;<span class="builtintype" id="6710796">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710809">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710813">return</span>&nbsp;<span class="builtintype" id="6710820">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710830">ln</span><span class="op" id="6710832">,</span>&nbsp;<span class="ident" id="6710834">err</span>&nbsp;<span class="op" id="6710838">:=</span>&nbsp;<span class="ident" id="6710841">Listen</span><span class="op" id="6710847">(</span><span class="string" id="6710848">&#34;tcp&#34;</span><span class="op" id="6710853">,</span>&nbsp;<span class="string" id="6710855">&#34;127.0.0.1:0&#34;</span><span class="op" id="6710868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710871">if</span>&nbsp;<span class="ident" id="6710874">err</span>&nbsp;<span class="op" id="6710878">!=</span>&nbsp;<span class="ident" id="6710881">nil</span>&nbsp;<span class="op" id="6710885">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710889">t</span><span class="op" id="6710890">.</span><span class="ident" id="6710891">Fatalf</span><span class="op" id="6710897">(</span><span class="string" id="6710898">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6710917">,</span>&nbsp;<span class="ident" id="6710919">err</span><span class="op" id="6710922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6710925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710928">defer</span>&nbsp;<span class="ident" id="6710934">ln</span><span class="op" id="6710936">.</span><span class="ident" id="6710937">Close</span><span class="op" id="6710942">(</span><span class="op" id="6710943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6710946">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710960">go</span>&nbsp;<span class="keyword" id="6710963">func</span><span class="op" id="6710967">(</span><span class="op" id="6710968">)</span>&nbsp;<span class="op" id="6710970">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6710974">for</span>&nbsp;<span class="op" id="6710978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6710983">c</span><span class="op" id="6710984">,</span>&nbsp;<span class="ident" id="6710986">err</span>&nbsp;<span class="op" id="6710990">:=</span>&nbsp;<span class="ident" id="6710993">ln</span><span class="op" id="6710995">.</span><span class="ident" id="6710996">Accept</span><span class="op" id="6711002">(</span><span class="op" id="6711003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711008">if</span>&nbsp;<span class="ident" id="6711011">err</span>&nbsp;<span class="op" id="6711015">!=</span>&nbsp;<span class="ident" id="6711018">nil</span>&nbsp;<span class="op" id="6711022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711028">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711037">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6711042">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711067">go</span>&nbsp;<span class="keyword" id="6711070">func</span><span class="op" id="6711074">(</span><span class="ident" id="6711075">c</span>&nbsp;<span class="ident" id="6711077">Conn</span><span class="op" id="6711081">)</span>&nbsp;<span class="op" id="6711083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711089">defer</span>&nbsp;<span class="ident" id="6711095">c</span><span class="op" id="6711096">.</span><span class="ident" id="6711097">Close</span><span class="op" id="6711102">(</span><span class="op" id="6711103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711109">var</span>&nbsp;<span class="ident" id="6711113">buf</span>&nbsp;<span class="op" id="6711117">[</span><span class="ident" id="6711118">msgLen</span><span class="op" id="6711124">]</span><span class="builtintype" id="6711125">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711134">for</span>&nbsp;<span class="ident" id="6711138">m</span>&nbsp;<span class="op" id="6711140">:=</span>&nbsp;<span class="num" id="6711143">0</span><span class="op" id="6711144">;</span>&nbsp;<span class="ident" id="6711146">m</span>&nbsp;<span class="op" id="6711148">&lt;</span>&nbsp;<span class="ident" id="6711150">msgs</span><span class="op" id="6711154">;</span>&nbsp;<span class="ident" id="6711156">m</span><span class="op" id="6711157">++</span>&nbsp;<span class="op" id="6711160">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711167">if</span>&nbsp;<span class="op" id="6711170">!</span><span class="ident" id="6711171">recvMsg</span><span class="op" id="6711178">(</span><span class="ident" id="6711179">c</span><span class="op" id="6711180">,</span>&nbsp;<span class="ident" id="6711182">buf</span><span class="op" id="6711185">[</span><span class="op" id="6711186">:</span><span class="op" id="6711187">]</span><span class="op" id="6711188">)</span>&nbsp;<span class="op" id="6711190">||</span>&nbsp;<span class="op" id="6711193">!</span><span class="ident" id="6711194">sendMsg</span><span class="op" id="6711201">(</span><span class="ident" id="6711202">c</span><span class="op" id="6711203">,</span>&nbsp;<span class="ident" id="6711205">buf</span><span class="op" id="6711208">[</span><span class="op" id="6711209">:</span><span class="op" id="6711210">]</span><span class="op" id="6711211">)</span>&nbsp;<span class="op" id="6711213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711221">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711243">}</span><span class="op" id="6711244">(</span><span class="ident" id="6711245">c</span><span class="op" id="6711246">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711253">}</span><span class="op" id="6711254">(</span><span class="op" id="6711255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711258">done</span>&nbsp;<span class="op" id="6711263">:=</span>&nbsp;<span class="builtinfunc" id="6711266">make</span><span class="op" id="6711270">(</span><span class="keyword" id="6711271">chan</span>&nbsp;<span class="builtintype" id="6711276">bool</span><span class="op" id="6711280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711283">for</span>&nbsp;<span class="ident" id="6711287">i</span>&nbsp;<span class="op" id="6711289">:=</span>&nbsp;<span class="num" id="6711292">0</span><span class="op" id="6711293">;</span>&nbsp;<span class="ident" id="6711295">i</span>&nbsp;<span class="op" id="6711297">&lt;</span>&nbsp;<span class="ident" id="6711299">conns</span><span class="op" id="6711304">;</span>&nbsp;<span class="ident" id="6711306">i</span><span class="op" id="6711307">++</span>&nbsp;<span class="op" id="6711310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6711314">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711338">go</span>&nbsp;<span class="keyword" id="6711341">func</span><span class="op" id="6711345">(</span><span class="op" id="6711346">)</span>&nbsp;<span class="op" id="6711348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711353">defer</span>&nbsp;<span class="keyword" id="6711359">func</span><span class="op" id="6711363">(</span><span class="op" id="6711364">)</span>&nbsp;<span class="op" id="6711366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711372">done</span>&nbsp;<span class="op" id="6711377">&lt;-</span>&nbsp;<span class="builtintype" id="6711380">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711388">}</span><span class="op" id="6711389">(</span><span class="op" id="6711390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711395">c</span><span class="op" id="6711396">,</span>&nbsp;<span class="ident" id="6711398">err</span>&nbsp;<span class="op" id="6711402">:=</span>&nbsp;<span class="ident" id="6711405">Dial</span><span class="op" id="6711409">(</span><span class="string" id="6711410">&#34;tcp&#34;</span><span class="op" id="6711415">,</span>&nbsp;<span class="ident" id="6711417">ln</span><span class="op" id="6711419">.</span><span class="ident" id="6711420">Addr</span><span class="op" id="6711424">(</span><span class="op" id="6711425">)</span><span class="op" id="6711426">.</span><span class="ident" id="6711427">String</span><span class="op" id="6711433">(</span><span class="op" id="6711434">)</span><span class="op" id="6711435">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711440">if</span>&nbsp;<span class="ident" id="6711443">err</span>&nbsp;<span class="op" id="6711447">!=</span>&nbsp;<span class="ident" id="6711450">nil</span>&nbsp;<span class="op" id="6711454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6711460">t</span><span class="op" id="6711461">.</span><span class="ident" id="6711462">Logf</span><span class="op" id="6711466">(</span><span class="string" id="6711467">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6711484">,</span>&nbsp;<span class="ident" id="6711486">err</span><span class="op" id="6711489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711495">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711510">defer</span>&nbsp;<span class="ident" id="6711516">c</span><span class="op" id="6711517">.</span><span class="ident" id="6711518">Close</span><span class="op" id="6711523">(</span><span class="op" id="6711524">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711529">var</span>&nbsp;<span class="ident" id="6711533">buf</span>&nbsp;<span class="op" id="6711537">[</span><span class="ident" id="6711538">msgLen</span><span class="op" id="6711544">]</span><span class="builtintype" id="6711545">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711553">for</span>&nbsp;<span class="ident" id="6711557">m</span>&nbsp;<span class="op" id="6711559">:=</span>&nbsp;<span class="num" id="6711562">0</span><span class="op" id="6711563">;</span>&nbsp;<span class="ident" id="6711565">m</span>&nbsp;<span class="op" id="6711567">&lt;</span>&nbsp;<span class="ident" id="6711569">msgs</span><span class="op" id="6711573">;</span>&nbsp;<span class="ident" id="6711575">m</span><span class="op" id="6711576">++</span>&nbsp;<span class="op" id="6711579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711585">if</span>&nbsp;<span class="op" id="6711588">!</span><span class="ident" id="6711589">sendMsg</span><span class="op" id="6711596">(</span><span class="ident" id="6711597">c</span><span class="op" id="6711598">,</span>&nbsp;<span class="ident" id="6711600">buf</span><span class="op" id="6711603">[</span><span class="op" id="6711604">:</span><span class="op" id="6711605">]</span><span class="op" id="6711606">)</span>&nbsp;<span class="op" id="6711608">||</span>&nbsp;<span class="op" id="6711611">!</span><span class="ident" id="6711612">recvMsg</span><span class="op" id="6711619">(</span><span class="ident" id="6711620">c</span><span class="op" id="6711621">,</span>&nbsp;<span class="ident" id="6711623">buf</span><span class="op" id="6711626">[</span><span class="op" id="6711627">:</span><span class="op" id="6711628">]</span><span class="op" id="6711629">)</span>&nbsp;<span class="op" id="6711631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711638">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711648">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711657">}</span><span class="op" id="6711658">(</span><span class="op" id="6711659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6711665">for</span>&nbsp;<span class="ident" id="6711669">i</span>&nbsp;<span class="op" id="6711671">:=</span>&nbsp;<span class="num" id="6711674">0</span><span class="op" id="6711675">;</span>&nbsp;<span class="ident" id="6711677">i</span>&nbsp;<span class="op" id="6711679">&lt;</span>&nbsp;<span class="ident" id="6711681">conns</span><span class="op" id="6711686">;</span>&nbsp;<span class="ident" id="6711688">i</span><span class="op" id="6711689">++</span>&nbsp;<span class="op" id="6711692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711696">&lt;-</span><span class="ident" id="6711698">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6711704">}</span><br>
<span class="lineno"></span><span class="op" id="6711706">}</span>
</div>
</body>
</html>
