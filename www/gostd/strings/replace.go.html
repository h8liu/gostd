<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2799634">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2799689">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2799743">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2799794">package</span>&nbsp;<span class="ident" id="2799802">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2799811">import</span>&nbsp;<span class="string" id="2799818">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2799824">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2799882">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2799939">type</span>&nbsp;<span class="ident" id="2799944">Replacer</span>&nbsp;<span class="keyword" id="2799953">struct</span>&nbsp;<span class="op" id="2799960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2799963">r</span>&nbsp;<span class="ident" id="2799965">replacer</span><br>
<span class="lineno"></span><span class="op" id="2799974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2799977">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2800055">type</span>&nbsp;<span class="ident" id="2800060">replacer</span>&nbsp;<span class="keyword" id="2800069">interface</span>&nbsp;<span class="op" id="2800079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800082">Replace</span><span class="op" id="2800089">(</span><span class="ident" id="2800090">s</span>&nbsp;<span class="builtintype" id="2800092">string</span><span class="op" id="2800098">)</span>&nbsp;<span class="builtintype" id="2800100">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800108">WriteString</span><span class="op" id="2800119">(</span><span class="ident" id="2800120">w</span>&nbsp;<span class="ident" id="2800122">io</span><span class="op" id="2800124">.</span><span class="ident" id="2800125">Writer</span><span class="op" id="2800131">,</span>&nbsp;<span class="ident" id="2800133">s</span>&nbsp;<span class="builtintype" id="2800135">string</span><span class="op" id="2800141">)</span>&nbsp;<span class="op" id="2800143">(</span><span class="ident" id="2800144">n</span>&nbsp;<span class="builtintype" id="2800146">int</span><span class="op" id="2800149">,</span>&nbsp;<span class="ident" id="2800151">err</span>&nbsp;<span class="builtintype" id="2800155">error</span><span class="op" id="2800160">)</span><br>
<span class="lineno"></span><span class="op" id="2800162">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2800165">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2800241">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2800310">func</span>&nbsp;<span class="ident" id="2800315">NewReplacer</span><span class="op" id="2800326">(</span><span class="ident" id="2800327">oldnew</span>&nbsp;<span class="op" id="2800334">...</span><span class="builtintype" id="2800337">string</span><span class="op" id="2800343">)</span>&nbsp;<span class="op" id="2800345">*</span><span class="ident" id="2800346">Replacer</span>&nbsp;<span class="op" id="2800355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800358">if</span>&nbsp;<span class="builtinfunc" id="2800361">len</span><span class="op" id="2800364">(</span><span class="ident" id="2800365">oldnew</span><span class="op" id="2800371">)</span><span class="op" id="2800372">%</span><span class="num" id="2800373">2</span>&nbsp;<span class="op" id="2800375">==</span>&nbsp;<span class="num" id="2800378">1</span>&nbsp;<span class="op" id="2800380">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2800384">panic</span><span class="op" id="2800389">(</span><span class="string" id="2800390">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2800431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800438">if</span>&nbsp;<span class="builtinfunc" id="2800441">len</span><span class="op" id="2800444">(</span><span class="ident" id="2800445">oldnew</span><span class="op" id="2800451">)</span>&nbsp;<span class="op" id="2800453">==</span>&nbsp;<span class="num" id="2800456">2</span>&nbsp;<span class="op" id="2800458">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2800461">len</span><span class="op" id="2800464">(</span><span class="ident" id="2800465">oldnew</span><span class="op" id="2800471">[</span><span class="num" id="2800472">0</span><span class="op" id="2800473">]</span><span class="op" id="2800474">)</span>&nbsp;<span class="op" id="2800476">&gt;</span>&nbsp;<span class="num" id="2800478">1</span>&nbsp;<span class="op" id="2800480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800484">return</span>&nbsp;<span class="op" id="2800491">&amp;</span><span class="ident" id="2800492">Replacer</span><span class="op" id="2800500">{</span><span class="ident" id="2800501">r</span><span class="op" id="2800502">:</span>&nbsp;<span class="ident" id="2800504">makeSingleStringReplacer</span><span class="op" id="2800528">(</span><span class="ident" id="2800529">oldnew</span><span class="op" id="2800535">[</span><span class="num" id="2800536">0</span><span class="op" id="2800537">]</span><span class="op" id="2800538">,</span>&nbsp;<span class="ident" id="2800540">oldnew</span><span class="op" id="2800546">[</span><span class="num" id="2800547">1</span><span class="op" id="2800548">]</span><span class="op" id="2800549">)</span><span class="op" id="2800550">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800557">allNewBytes</span>&nbsp;<span class="op" id="2800569">:=</span>&nbsp;<span class="builtintype" id="2800572">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800578">for</span>&nbsp;<span class="ident" id="2800582">i</span>&nbsp;<span class="op" id="2800584">:=</span>&nbsp;<span class="num" id="2800587">0</span><span class="op" id="2800588">;</span>&nbsp;<span class="ident" id="2800590">i</span>&nbsp;<span class="op" id="2800592">&lt;</span>&nbsp;<span class="builtinfunc" id="2800594">len</span><span class="op" id="2800597">(</span><span class="ident" id="2800598">oldnew</span><span class="op" id="2800604">)</span><span class="op" id="2800605">;</span>&nbsp;<span class="ident" id="2800607">i</span>&nbsp;<span class="op" id="2800609">+=</span>&nbsp;<span class="num" id="2800612">2</span>&nbsp;<span class="op" id="2800614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800618">if</span>&nbsp;<span class="builtinfunc" id="2800621">len</span><span class="op" id="2800624">(</span><span class="ident" id="2800625">oldnew</span><span class="op" id="2800631">[</span><span class="ident" id="2800632">i</span><span class="op" id="2800633">]</span><span class="op" id="2800634">)</span>&nbsp;<span class="op" id="2800636">!=</span>&nbsp;<span class="num" id="2800639">1</span>&nbsp;<span class="op" id="2800641">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800646">return</span>&nbsp;<span class="op" id="2800653">&amp;</span><span class="ident" id="2800654">Replacer</span><span class="op" id="2800662">{</span><span class="ident" id="2800663">r</span><span class="op" id="2800664">:</span>&nbsp;<span class="ident" id="2800666">makeGenericReplacer</span><span class="op" id="2800685">(</span><span class="ident" id="2800686">oldnew</span><span class="op" id="2800692">)</span><span class="op" id="2800693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800701">if</span>&nbsp;<span class="builtinfunc" id="2800704">len</span><span class="op" id="2800707">(</span><span class="ident" id="2800708">oldnew</span><span class="op" id="2800714">[</span><span class="ident" id="2800715">i</span><span class="op" id="2800716">+</span><span class="num" id="2800717">1</span><span class="op" id="2800718">]</span><span class="op" id="2800719">)</span>&nbsp;<span class="op" id="2800721">!=</span>&nbsp;<span class="num" id="2800724">1</span>&nbsp;<span class="op" id="2800726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800731">allNewBytes</span>&nbsp;<span class="op" id="2800743">=</span>&nbsp;<span class="builtintype" id="2800745">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800753">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800760">if</span>&nbsp;<span class="ident" id="2800763">allNewBytes</span>&nbsp;<span class="op" id="2800775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800779">r</span>&nbsp;<span class="op" id="2800781">:=</span>&nbsp;<span class="ident" id="2800784">byteReplacer</span><span class="op" id="2800796">{</span><span class="op" id="2800797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800801">for</span>&nbsp;<span class="ident" id="2800805">i</span>&nbsp;<span class="op" id="2800807">:=</span>&nbsp;<span class="keyword" id="2800810">range</span>&nbsp;<span class="ident" id="2800816">r</span>&nbsp;<span class="op" id="2800818">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800823">r</span><span class="op" id="2800824">[</span><span class="ident" id="2800825">i</span><span class="op" id="2800826">]</span>&nbsp;<span class="op" id="2800828">=</span>&nbsp;<span class="builtintype" id="2800830">byte</span><span class="op" id="2800834">(</span><span class="ident" id="2800835">i</span><span class="op" id="2800836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2800840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2800844">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2800903">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2800950">for</span>&nbsp;<span class="ident" id="2800954">i</span>&nbsp;<span class="op" id="2800956">:=</span>&nbsp;<span class="builtinfunc" id="2800959">len</span><span class="op" id="2800962">(</span><span class="ident" id="2800963">oldnew</span><span class="op" id="2800969">)</span>&nbsp;<span class="op" id="2800971">-</span>&nbsp;<span class="num" id="2800973">2</span><span class="op" id="2800974">;</span>&nbsp;<span class="ident" id="2800976">i</span>&nbsp;<span class="op" id="2800978">&gt;=</span>&nbsp;<span class="num" id="2800981">0</span><span class="op" id="2800982">;</span>&nbsp;<span class="ident" id="2800984">i</span>&nbsp;<span class="op" id="2800986">-=</span>&nbsp;<span class="num" id="2800989">2</span>&nbsp;<span class="op" id="2800991">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2800996">o</span>&nbsp;<span class="op" id="2800998">:=</span>&nbsp;<span class="ident" id="2801001">oldnew</span><span class="op" id="2801007">[</span><span class="ident" id="2801008">i</span><span class="op" id="2801009">]</span><span class="op" id="2801010">[</span><span class="num" id="2801011">0</span><span class="op" id="2801012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801017">n</span>&nbsp;<span class="op" id="2801019">:=</span>&nbsp;<span class="ident" id="2801022">oldnew</span><span class="op" id="2801028">[</span><span class="ident" id="2801029">i</span><span class="op" id="2801030">+</span><span class="num" id="2801031">1</span><span class="op" id="2801032">]</span><span class="op" id="2801033">[</span><span class="num" id="2801034">0</span><span class="op" id="2801035">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801040">r</span><span class="op" id="2801041">[</span><span class="ident" id="2801042">o</span><span class="op" id="2801043">]</span>&nbsp;<span class="op" id="2801045">=</span>&nbsp;<span class="ident" id="2801047">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2801051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801055">return</span>&nbsp;<span class="op" id="2801062">&amp;</span><span class="ident" id="2801063">Replacer</span><span class="op" id="2801071">{</span><span class="ident" id="2801072">r</span><span class="op" id="2801073">:</span>&nbsp;<span class="op" id="2801075">&amp;</span><span class="ident" id="2801076">r</span><span class="op" id="2801077">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2801080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801084">r</span>&nbsp;<span class="op" id="2801086">:=</span>&nbsp;<span class="ident" id="2801089">byteStringReplacer</span><span class="op" id="2801107">{</span><span class="op" id="2801108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801111">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2801169">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801215">for</span>&nbsp;<span class="ident" id="2801219">i</span>&nbsp;<span class="op" id="2801221">:=</span>&nbsp;<span class="builtinfunc" id="2801224">len</span><span class="op" id="2801227">(</span><span class="ident" id="2801228">oldnew</span><span class="op" id="2801234">)</span>&nbsp;<span class="op" id="2801236">-</span>&nbsp;<span class="num" id="2801238">2</span><span class="op" id="2801239">;</span>&nbsp;<span class="ident" id="2801241">i</span>&nbsp;<span class="op" id="2801243">&gt;=</span>&nbsp;<span class="num" id="2801246">0</span><span class="op" id="2801247">;</span>&nbsp;<span class="ident" id="2801249">i</span>&nbsp;<span class="op" id="2801251">-=</span>&nbsp;<span class="num" id="2801254">2</span>&nbsp;<span class="op" id="2801256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801260">o</span>&nbsp;<span class="op" id="2801262">:=</span>&nbsp;<span class="ident" id="2801265">oldnew</span><span class="op" id="2801271">[</span><span class="ident" id="2801272">i</span><span class="op" id="2801273">]</span><span class="op" id="2801274">[</span><span class="num" id="2801275">0</span><span class="op" id="2801276">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801280">n</span>&nbsp;<span class="op" id="2801282">:=</span>&nbsp;<span class="ident" id="2801285">oldnew</span><span class="op" id="2801291">[</span><span class="ident" id="2801292">i</span><span class="op" id="2801293">+</span><span class="num" id="2801294">1</span><span class="op" id="2801295">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2801299">r</span><span class="op" id="2801300">[</span><span class="ident" id="2801301">o</span><span class="op" id="2801302">]</span>&nbsp;<span class="op" id="2801304">=</span>&nbsp;<span class="op" id="2801306">[</span><span class="op" id="2801307">]</span><span class="builtintype" id="2801308">byte</span><span class="op" id="2801312">(</span><span class="ident" id="2801313">n</span><span class="op" id="2801314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2801317">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801320">return</span>&nbsp;<span class="op" id="2801327">&amp;</span><span class="ident" id="2801328">Replacer</span><span class="op" id="2801336">{</span><span class="ident" id="2801337">r</span><span class="op" id="2801338">:</span>&nbsp;<span class="op" id="2801340">&amp;</span><span class="ident" id="2801341">r</span><span class="op" id="2801342">}</span><br>
<span class="lineno"></span><span class="op" id="2801344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2801347">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2801411">func</span>&nbsp;<span class="op" id="2801416">(</span><span class="ident" id="2801417">r</span>&nbsp;<span class="op" id="2801419">*</span><span class="ident" id="2801420">Replacer</span><span class="op" id="2801428">)</span>&nbsp;<span class="ident" id="2801430">Replace</span><span class="op" id="2801437">(</span><span class="ident" id="2801438">s</span>&nbsp;<span class="builtintype" id="2801440">string</span><span class="op" id="2801446">)</span>&nbsp;<span class="builtintype" id="2801448">string</span>&nbsp;<span class="op" id="2801455">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801458">return</span>&nbsp;<span class="ident" id="2801465">r</span><span class="op" id="2801466">.</span><span class="ident" id="2801467">r</span><span class="op" id="2801468">.</span><span class="ident" id="2801469">Replace</span><span class="op" id="2801476">(</span><span class="ident" id="2801477">s</span><span class="op" id="2801478">)</span><br>
<span class="lineno"></span><span class="op" id="2801480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2801483">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2801545">func</span>&nbsp;<span class="op" id="2801550">(</span><span class="ident" id="2801551">r</span>&nbsp;<span class="op" id="2801553">*</span><span class="ident" id="2801554">Replacer</span><span class="op" id="2801562">)</span>&nbsp;<span class="ident" id="2801564">WriteString</span><span class="op" id="2801575">(</span><span class="ident" id="2801576">w</span>&nbsp;<span class="ident" id="2801578">io</span><span class="op" id="2801580">.</span><span class="ident" id="2801581">Writer</span><span class="op" id="2801587">,</span>&nbsp;<span class="ident" id="2801589">s</span>&nbsp;<span class="builtintype" id="2801591">string</span><span class="op" id="2801597">)</span>&nbsp;<span class="op" id="2801599">(</span><span class="ident" id="2801600">n</span>&nbsp;<span class="builtintype" id="2801602">int</span><span class="op" id="2801605">,</span>&nbsp;<span class="ident" id="2801607">err</span>&nbsp;<span class="builtintype" id="2801611">error</span><span class="op" id="2801616">)</span>&nbsp;<span class="op" id="2801618">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2801621">return</span>&nbsp;<span class="ident" id="2801628">r</span><span class="op" id="2801629">.</span><span class="ident" id="2801630">r</span><span class="op" id="2801631">.</span><span class="ident" id="2801632">WriteString</span><span class="op" id="2801643">(</span><span class="ident" id="2801644">w</span><span class="op" id="2801645">,</span>&nbsp;<span class="ident" id="2801647">s</span><span class="op" id="2801648">)</span><br>
<span class="lineno"></span><span class="op" id="2801650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2801653">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2801730">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2801808">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2801856">//</span><br>
<span class="lineno"></span><span class="comment" id="2801859">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2801869">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2801880">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2801892">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2801904">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2801915">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2801929">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2801940">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2801952">//</span><br>
<span class="lineno"></span><span class="comment" id="2801955">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2802033">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2802111">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2802185">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2802236">type</span>&nbsp;<span class="ident" id="2802241">trieNode</span>&nbsp;<span class="keyword" id="2802250">struct</span>&nbsp;<span class="op" id="2802257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802260">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802333">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2802370">value</span>&nbsp;<span class="builtintype" id="2802376">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802384">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802459">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802534">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802607">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802680">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2802712">priority</span>&nbsp;<span class="builtintype" id="2802721">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802727">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802783">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802847">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802915">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802973">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2802977">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803049">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803107">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803181">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803258">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2803333">prefix</span>&nbsp;<span class="builtintype" id="2803340">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2803348">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2803355">*</span><span class="ident" id="2803356">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803367">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803438">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803512">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803586">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803660">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803725">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2803800">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2803822">table</span>&nbsp;<span class="op" id="2803828">[</span><span class="op" id="2803829">]</span><span class="op" id="2803830">*</span><span class="ident" id="2803831">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2803840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2803843">func</span>&nbsp;<span class="op" id="2803848">(</span><span class="ident" id="2803849">t</span>&nbsp;<span class="op" id="2803851">*</span><span class="ident" id="2803852">trieNode</span><span class="op" id="2803860">)</span>&nbsp;<span class="ident" id="2803862">add</span><span class="op" id="2803865">(</span><span class="ident" id="2803866">key</span><span class="op" id="2803869">,</span>&nbsp;<span class="ident" id="2803871">val</span>&nbsp;<span class="builtintype" id="2803875">string</span><span class="op" id="2803881">,</span>&nbsp;<span class="ident" id="2803883">priority</span>&nbsp;<span class="builtintype" id="2803892">int</span><span class="op" id="2803895">,</span>&nbsp;<span class="ident" id="2803897">r</span>&nbsp;<span class="op" id="2803899">*</span><span class="ident" id="2803900">genericReplacer</span><span class="op" id="2803915">)</span>&nbsp;<span class="op" id="2803917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2803920">if</span>&nbsp;<span class="ident" id="2803923">key</span>&nbsp;<span class="op" id="2803927">==</span>&nbsp;<span class="string" id="2803930">&#34;&#34;</span>&nbsp;<span class="op" id="2803933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2803937">if</span>&nbsp;<span class="ident" id="2803940">t</span><span class="op" id="2803941">.</span><span class="ident" id="2803942">priority</span>&nbsp;<span class="op" id="2803951">==</span>&nbsp;<span class="num" id="2803954">0</span>&nbsp;<span class="op" id="2803956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2803961">t</span><span class="op" id="2803962">.</span><span class="ident" id="2803963">value</span>&nbsp;<span class="op" id="2803969">=</span>&nbsp;<span class="ident" id="2803971">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2803978">t</span><span class="op" id="2803979">.</span><span class="ident" id="2803980">priority</span>&nbsp;<span class="op" id="2803989">=</span>&nbsp;<span class="ident" id="2803991">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804006">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804018">if</span>&nbsp;<span class="ident" id="2804021">t</span><span class="op" id="2804022">.</span><span class="ident" id="2804023">prefix</span>&nbsp;<span class="op" id="2804030">!=</span>&nbsp;<span class="string" id="2804033">&#34;&#34;</span>&nbsp;<span class="op" id="2804036">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2804040">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804092">var</span>&nbsp;<span class="ident" id="2804096">n</span>&nbsp;<span class="builtintype" id="2804098">int</span>&nbsp;<span class="comment" id="2804102">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804143">for</span>&nbsp;<span class="op" id="2804147">;</span>&nbsp;<span class="ident" id="2804149">n</span>&nbsp;<span class="op" id="2804151">&lt;</span>&nbsp;<span class="builtinfunc" id="2804153">len</span><span class="op" id="2804156">(</span><span class="ident" id="2804157">t</span><span class="op" id="2804158">.</span><span class="ident" id="2804159">prefix</span><span class="op" id="2804165">)</span>&nbsp;<span class="op" id="2804167">&amp;&amp;</span>&nbsp;<span class="ident" id="2804170">n</span>&nbsp;<span class="op" id="2804172">&lt;</span>&nbsp;<span class="builtinfunc" id="2804174">len</span><span class="op" id="2804177">(</span><span class="ident" id="2804178">key</span><span class="op" id="2804181">)</span><span class="op" id="2804182">;</span>&nbsp;<span class="ident" id="2804184">n</span><span class="op" id="2804185">++</span>&nbsp;<span class="op" id="2804188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804193">if</span>&nbsp;<span class="ident" id="2804196">t</span><span class="op" id="2804197">.</span><span class="ident" id="2804198">prefix</span><span class="op" id="2804204">[</span><span class="ident" id="2804205">n</span><span class="op" id="2804206">]</span>&nbsp;<span class="op" id="2804208">!=</span>&nbsp;<span class="ident" id="2804211">key</span><span class="op" id="2804214">[</span><span class="ident" id="2804215">n</span><span class="op" id="2804216">]</span>&nbsp;<span class="op" id="2804218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804224">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804241">if</span>&nbsp;<span class="ident" id="2804244">n</span>&nbsp;<span class="op" id="2804246">==</span>&nbsp;<span class="builtinfunc" id="2804249">len</span><span class="op" id="2804252">(</span><span class="ident" id="2804253">t</span><span class="op" id="2804254">.</span><span class="ident" id="2804255">prefix</span><span class="op" id="2804261">)</span>&nbsp;<span class="op" id="2804263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804268">t</span><span class="op" id="2804269">.</span><span class="ident" id="2804270">next</span><span class="op" id="2804274">.</span><span class="ident" id="2804275">add</span><span class="op" id="2804278">(</span><span class="ident" id="2804279">key</span><span class="op" id="2804282">[</span><span class="ident" id="2804283">n</span><span class="op" id="2804284">:</span><span class="op" id="2804285">]</span><span class="op" id="2804286">,</span>&nbsp;<span class="ident" id="2804288">val</span><span class="op" id="2804291">,</span>&nbsp;<span class="ident" id="2804293">priority</span><span class="op" id="2804301">,</span>&nbsp;<span class="ident" id="2804303">r</span><span class="op" id="2804304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804308">}</span>&nbsp;<span class="keyword" id="2804310">else</span>&nbsp;<span class="keyword" id="2804315">if</span>&nbsp;<span class="ident" id="2804318">n</span>&nbsp;<span class="op" id="2804320">==</span>&nbsp;<span class="num" id="2804323">0</span>&nbsp;<span class="op" id="2804325">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2804330">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2804398">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2804463">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804509">var</span>&nbsp;<span class="ident" id="2804513">prefixNode</span>&nbsp;<span class="op" id="2804524">*</span><span class="ident" id="2804525">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2804537">if</span>&nbsp;<span class="builtinfunc" id="2804540">len</span><span class="op" id="2804543">(</span><span class="ident" id="2804544">t</span><span class="op" id="2804545">.</span><span class="ident" id="2804546">prefix</span><span class="op" id="2804552">)</span>&nbsp;<span class="op" id="2804554">==</span>&nbsp;<span class="num" id="2804557">1</span>&nbsp;<span class="op" id="2804559">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804565">prefixNode</span>&nbsp;<span class="op" id="2804576">=</span>&nbsp;<span class="ident" id="2804578">t</span><span class="op" id="2804579">.</span><span class="ident" id="2804580">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804588">}</span>&nbsp;<span class="keyword" id="2804590">else</span>&nbsp;<span class="op" id="2804595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804601">prefixNode</span>&nbsp;<span class="op" id="2804612">=</span>&nbsp;<span class="op" id="2804614">&amp;</span><span class="ident" id="2804615">trieNode</span><span class="op" id="2804623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804630">prefix</span><span class="op" id="2804636">:</span>&nbsp;<span class="ident" id="2804638">t</span><span class="op" id="2804639">.</span><span class="ident" id="2804640">prefix</span><span class="op" id="2804646">[</span><span class="num" id="2804647">1</span><span class="op" id="2804648">:</span><span class="op" id="2804649">]</span><span class="op" id="2804650">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804657">next</span><span class="op" id="2804661">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2804665">t</span><span class="op" id="2804666">.</span><span class="ident" id="2804667">next</span><span class="op" id="2804671">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804687">keyNode</span>&nbsp;<span class="op" id="2804695">:=</span>&nbsp;<span class="builtinfunc" id="2804698">new</span><span class="op" id="2804701">(</span><span class="ident" id="2804702">trieNode</span><span class="op" id="2804710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804715">t</span><span class="op" id="2804716">.</span><span class="ident" id="2804717">table</span>&nbsp;<span class="op" id="2804723">=</span>&nbsp;<span class="builtinfunc" id="2804725">make</span><span class="op" id="2804729">(</span><span class="op" id="2804730">[</span><span class="op" id="2804731">]</span><span class="op" id="2804732">*</span><span class="ident" id="2804733">trieNode</span><span class="op" id="2804741">,</span>&nbsp;<span class="ident" id="2804743">r</span><span class="op" id="2804744">.</span><span class="ident" id="2804745">tableSize</span><span class="op" id="2804754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804759">t</span><span class="op" id="2804760">.</span><span class="ident" id="2804761">table</span><span class="op" id="2804766">[</span><span class="ident" id="2804767">r</span><span class="op" id="2804768">.</span><span class="ident" id="2804769">mapping</span><span class="op" id="2804776">[</span><span class="ident" id="2804777">t</span><span class="op" id="2804778">.</span><span class="ident" id="2804779">prefix</span><span class="op" id="2804785">[</span><span class="num" id="2804786">0</span><span class="op" id="2804787">]</span><span class="op" id="2804788">]</span><span class="op" id="2804789">]</span>&nbsp;<span class="op" id="2804791">=</span>&nbsp;<span class="ident" id="2804793">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804807">t</span><span class="op" id="2804808">.</span><span class="ident" id="2804809">table</span><span class="op" id="2804814">[</span><span class="ident" id="2804815">r</span><span class="op" id="2804816">.</span><span class="ident" id="2804817">mapping</span><span class="op" id="2804824">[</span><span class="ident" id="2804825">key</span><span class="op" id="2804828">[</span><span class="num" id="2804829">0</span><span class="op" id="2804830">]</span><span class="op" id="2804831">]</span><span class="op" id="2804832">]</span>&nbsp;<span class="op" id="2804834">=</span>&nbsp;<span class="ident" id="2804836">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804847">t</span><span class="op" id="2804848">.</span><span class="ident" id="2804849">prefix</span>&nbsp;<span class="op" id="2804856">=</span>&nbsp;<span class="string" id="2804858">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804864">t</span><span class="op" id="2804865">.</span><span class="ident" id="2804866">next</span>&nbsp;<span class="op" id="2804871">=</span>&nbsp;<span class="ident" id="2804873">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804880">keyNode</span><span class="op" id="2804887">.</span><span class="ident" id="2804888">add</span><span class="op" id="2804891">(</span><span class="ident" id="2804892">key</span><span class="op" id="2804895">[</span><span class="num" id="2804896">1</span><span class="op" id="2804897">:</span><span class="op" id="2804898">]</span><span class="op" id="2804899">,</span>&nbsp;<span class="ident" id="2804901">val</span><span class="op" id="2804904">,</span>&nbsp;<span class="ident" id="2804906">priority</span><span class="op" id="2804914">,</span>&nbsp;<span class="ident" id="2804916">r</span><span class="op" id="2804917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2804921">}</span>&nbsp;<span class="keyword" id="2804923">else</span>&nbsp;<span class="op" id="2804928">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2804933">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2804995">next</span>&nbsp;<span class="op" id="2805000">:=</span>&nbsp;<span class="op" id="2805003">&amp;</span><span class="ident" id="2805004">trieNode</span><span class="op" id="2805012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805018">prefix</span><span class="op" id="2805024">:</span>&nbsp;<span class="ident" id="2805026">t</span><span class="op" id="2805027">.</span><span class="ident" id="2805028">prefix</span><span class="op" id="2805034">[</span><span class="ident" id="2805035">n</span><span class="op" id="2805036">:</span><span class="op" id="2805037">]</span><span class="op" id="2805038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805044">next</span><span class="op" id="2805048">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2805052">t</span><span class="op" id="2805053">.</span><span class="ident" id="2805054">next</span><span class="op" id="2805058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805063">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805068">t</span><span class="op" id="2805069">.</span><span class="ident" id="2805070">prefix</span>&nbsp;<span class="op" id="2805077">=</span>&nbsp;<span class="ident" id="2805079">t</span><span class="op" id="2805080">.</span><span class="ident" id="2805081">prefix</span><span class="op" id="2805087">[</span><span class="op" id="2805088">:</span><span class="ident" id="2805089">n</span><span class="op" id="2805090">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805095">t</span><span class="op" id="2805096">.</span><span class="ident" id="2805097">next</span>&nbsp;<span class="op" id="2805102">=</span>&nbsp;<span class="ident" id="2805104">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805112">next</span><span class="op" id="2805116">.</span><span class="ident" id="2805117">add</span><span class="op" id="2805120">(</span><span class="ident" id="2805121">key</span><span class="op" id="2805124">[</span><span class="ident" id="2805125">n</span><span class="op" id="2805126">:</span><span class="op" id="2805127">]</span><span class="op" id="2805128">,</span>&nbsp;<span class="ident" id="2805130">val</span><span class="op" id="2805133">,</span>&nbsp;<span class="ident" id="2805135">priority</span><span class="op" id="2805143">,</span>&nbsp;<span class="ident" id="2805145">r</span><span class="op" id="2805146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805153">}</span>&nbsp;<span class="keyword" id="2805155">else</span>&nbsp;<span class="keyword" id="2805160">if</span>&nbsp;<span class="ident" id="2805163">t</span><span class="op" id="2805164">.</span><span class="ident" id="2805165">table</span>&nbsp;<span class="op" id="2805171">!=</span>&nbsp;<span class="ident" id="2805174">nil</span>&nbsp;<span class="op" id="2805178">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2805182">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805215">m</span>&nbsp;<span class="op" id="2805217">:=</span>&nbsp;<span class="ident" id="2805220">r</span><span class="op" id="2805221">.</span><span class="ident" id="2805222">mapping</span><span class="op" id="2805229">[</span><span class="ident" id="2805230">key</span><span class="op" id="2805233">[</span><span class="num" id="2805234">0</span><span class="op" id="2805235">]</span><span class="op" id="2805236">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805240">if</span>&nbsp;<span class="ident" id="2805243">t</span><span class="op" id="2805244">.</span><span class="ident" id="2805245">table</span><span class="op" id="2805250">[</span><span class="ident" id="2805251">m</span><span class="op" id="2805252">]</span>&nbsp;<span class="op" id="2805254">==</span>&nbsp;<span class="ident" id="2805257">nil</span>&nbsp;<span class="op" id="2805261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805266">t</span><span class="op" id="2805267">.</span><span class="ident" id="2805268">table</span><span class="op" id="2805273">[</span><span class="ident" id="2805274">m</span><span class="op" id="2805275">]</span>&nbsp;<span class="op" id="2805277">=</span>&nbsp;<span class="builtinfunc" id="2805279">new</span><span class="op" id="2805282">(</span><span class="ident" id="2805283">trieNode</span><span class="op" id="2805291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805295">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805299">t</span><span class="op" id="2805300">.</span><span class="ident" id="2805301">table</span><span class="op" id="2805306">[</span><span class="ident" id="2805307">m</span><span class="op" id="2805308">]</span><span class="op" id="2805309">.</span><span class="ident" id="2805310">add</span><span class="op" id="2805313">(</span><span class="ident" id="2805314">key</span><span class="op" id="2805317">[</span><span class="num" id="2805318">1</span><span class="op" id="2805319">:</span><span class="op" id="2805320">]</span><span class="op" id="2805321">,</span>&nbsp;<span class="ident" id="2805323">val</span><span class="op" id="2805326">,</span>&nbsp;<span class="ident" id="2805328">priority</span><span class="op" id="2805336">,</span>&nbsp;<span class="ident" id="2805338">r</span><span class="op" id="2805339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805342">}</span>&nbsp;<span class="keyword" id="2805344">else</span>&nbsp;<span class="op" id="2805349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805353">t</span><span class="op" id="2805354">.</span><span class="ident" id="2805355">prefix</span>&nbsp;<span class="op" id="2805362">=</span>&nbsp;<span class="ident" id="2805364">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805370">t</span><span class="op" id="2805371">.</span><span class="ident" id="2805372">next</span>&nbsp;<span class="op" id="2805377">=</span>&nbsp;<span class="builtinfunc" id="2805379">new</span><span class="op" id="2805382">(</span><span class="ident" id="2805383">trieNode</span><span class="op" id="2805391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805395">t</span><span class="op" id="2805396">.</span><span class="ident" id="2805397">next</span><span class="op" id="2805401">.</span><span class="ident" id="2805402">add</span><span class="op" id="2805405">(</span><span class="string" id="2805406">&#34;&#34;</span><span class="op" id="2805408">,</span>&nbsp;<span class="ident" id="2805410">val</span><span class="op" id="2805413">,</span>&nbsp;<span class="ident" id="2805415">priority</span><span class="op" id="2805423">,</span>&nbsp;<span class="ident" id="2805425">r</span><span class="op" id="2805426">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805429">}</span><br>
<span class="lineno"></span><span class="op" id="2805431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2805434">func</span>&nbsp;<span class="op" id="2805439">(</span><span class="ident" id="2805440">r</span>&nbsp;<span class="op" id="2805442">*</span><span class="ident" id="2805443">genericReplacer</span><span class="op" id="2805458">)</span>&nbsp;<span class="ident" id="2805460">lookup</span><span class="op" id="2805466">(</span><span class="ident" id="2805467">s</span>&nbsp;<span class="builtintype" id="2805469">string</span><span class="op" id="2805475">,</span>&nbsp;<span class="ident" id="2805477">ignoreRoot</span>&nbsp;<span class="builtintype" id="2805488">bool</span><span class="op" id="2805492">)</span>&nbsp;<span class="op" id="2805494">(</span><span class="ident" id="2805495">val</span>&nbsp;<span class="builtintype" id="2805499">string</span><span class="op" id="2805505">,</span>&nbsp;<span class="ident" id="2805507">keylen</span>&nbsp;<span class="builtintype" id="2805514">int</span><span class="op" id="2805517">,</span>&nbsp;<span class="ident" id="2805519">found</span>&nbsp;<span class="builtintype" id="2805525">bool</span><span class="op" id="2805529">)</span>&nbsp;<span class="op" id="2805531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2805534">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2805607">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805633">bestPriority</span>&nbsp;<span class="op" id="2805646">:=</span>&nbsp;<span class="num" id="2805649">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805652">node</span>&nbsp;<span class="op" id="2805657">:=</span>&nbsp;<span class="op" id="2805660">&amp;</span><span class="ident" id="2805661">r</span><span class="op" id="2805662">.</span><span class="ident" id="2805663">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805669">n</span>&nbsp;<span class="op" id="2805671">:=</span>&nbsp;<span class="num" id="2805674">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805677">for</span>&nbsp;<span class="ident" id="2805681">node</span>&nbsp;<span class="op" id="2805686">!=</span>&nbsp;<span class="ident" id="2805689">nil</span>&nbsp;<span class="op" id="2805693">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805697">if</span>&nbsp;<span class="ident" id="2805700">node</span><span class="op" id="2805704">.</span><span class="ident" id="2805705">priority</span>&nbsp;<span class="op" id="2805714">&gt;</span>&nbsp;<span class="ident" id="2805716">bestPriority</span>&nbsp;<span class="op" id="2805729">&amp;&amp;</span>&nbsp;<span class="op" id="2805732">!</span><span class="op" id="2805733">(</span><span class="ident" id="2805734">ignoreRoot</span>&nbsp;<span class="op" id="2805745">&amp;&amp;</span>&nbsp;<span class="ident" id="2805748">node</span>&nbsp;<span class="op" id="2805753">==</span>&nbsp;<span class="op" id="2805756">&amp;</span><span class="ident" id="2805757">r</span><span class="op" id="2805758">.</span><span class="ident" id="2805759">root</span><span class="op" id="2805763">)</span>&nbsp;<span class="op" id="2805765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805770">bestPriority</span>&nbsp;<span class="op" id="2805783">=</span>&nbsp;<span class="ident" id="2805785">node</span><span class="op" id="2805789">.</span><span class="ident" id="2805790">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805802">val</span>&nbsp;<span class="op" id="2805806">=</span>&nbsp;<span class="ident" id="2805808">node</span><span class="op" id="2805812">.</span><span class="ident" id="2805813">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805822">keylen</span>&nbsp;<span class="op" id="2805829">=</span>&nbsp;<span class="ident" id="2805831">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805836">found</span>&nbsp;<span class="op" id="2805842">=</span>&nbsp;<span class="builtintype" id="2805844">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805856">if</span>&nbsp;<span class="ident" id="2805859">s</span>&nbsp;<span class="op" id="2805861">==</span>&nbsp;<span class="string" id="2805864">&#34;&#34;</span>&nbsp;<span class="op" id="2805867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805872">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805880">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805884">if</span>&nbsp;<span class="ident" id="2805887">node</span><span class="op" id="2805891">.</span><span class="ident" id="2805892">table</span>&nbsp;<span class="op" id="2805898">!=</span>&nbsp;<span class="ident" id="2805901">nil</span>&nbsp;<span class="op" id="2805905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805910">index</span>&nbsp;<span class="op" id="2805916">:=</span>&nbsp;<span class="ident" id="2805919">r</span><span class="op" id="2805920">.</span><span class="ident" id="2805921">mapping</span><span class="op" id="2805928">[</span><span class="ident" id="2805929">s</span><span class="op" id="2805930">[</span><span class="num" id="2805931">0</span><span class="op" id="2805932">]</span><span class="op" id="2805933">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805938">if</span>&nbsp;<span class="builtintype" id="2805941">int</span><span class="op" id="2805944">(</span><span class="ident" id="2805945">index</span><span class="op" id="2805950">)</span>&nbsp;<span class="op" id="2805952">==</span>&nbsp;<span class="ident" id="2805955">r</span><span class="op" id="2805956">.</span><span class="ident" id="2805957">tableSize</span>&nbsp;<span class="op" id="2805967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2805973">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2805982">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2805987">node</span>&nbsp;<span class="op" id="2805992">=</span>&nbsp;<span class="ident" id="2805994">node</span><span class="op" id="2805998">.</span><span class="ident" id="2805999">table</span><span class="op" id="2806004">[</span><span class="ident" id="2806005">index</span><span class="op" id="2806010">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806015">s</span>&nbsp;<span class="op" id="2806017">=</span>&nbsp;<span class="ident" id="2806019">s</span><span class="op" id="2806020">[</span><span class="num" id="2806021">1</span><span class="op" id="2806022">:</span><span class="op" id="2806023">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806028">n</span><span class="op" id="2806029">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806034">}</span>&nbsp;<span class="keyword" id="2806036">else</span>&nbsp;<span class="keyword" id="2806041">if</span>&nbsp;<span class="ident" id="2806044">node</span><span class="op" id="2806048">.</span><span class="ident" id="2806049">prefix</span>&nbsp;<span class="op" id="2806056">!=</span>&nbsp;<span class="string" id="2806059">&#34;&#34;</span>&nbsp;<span class="op" id="2806062">&amp;&amp;</span>&nbsp;<span class="ident" id="2806065">HasPrefix</span><span class="op" id="2806074">(</span><span class="ident" id="2806075">s</span><span class="op" id="2806076">,</span>&nbsp;<span class="ident" id="2806078">node</span><span class="op" id="2806082">.</span><span class="ident" id="2806083">prefix</span><span class="op" id="2806089">)</span>&nbsp;<span class="op" id="2806091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806096">n</span>&nbsp;<span class="op" id="2806098">+=</span>&nbsp;<span class="builtinfunc" id="2806101">len</span><span class="op" id="2806104">(</span><span class="ident" id="2806105">node</span><span class="op" id="2806109">.</span><span class="ident" id="2806110">prefix</span><span class="op" id="2806116">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806121">s</span>&nbsp;<span class="op" id="2806123">=</span>&nbsp;<span class="ident" id="2806125">s</span><span class="op" id="2806126">[</span><span class="builtinfunc" id="2806127">len</span><span class="op" id="2806130">(</span><span class="ident" id="2806131">node</span><span class="op" id="2806135">.</span><span class="ident" id="2806136">prefix</span><span class="op" id="2806142">)</span><span class="op" id="2806143">:</span><span class="op" id="2806144">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806149">node</span>&nbsp;<span class="op" id="2806154">=</span>&nbsp;<span class="ident" id="2806156">node</span><span class="op" id="2806160">.</span><span class="ident" id="2806161">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806168">}</span>&nbsp;<span class="keyword" id="2806170">else</span>&nbsp;<span class="op" id="2806175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806180">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806188">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806194">return</span><br>
<span class="lineno"></span><span class="op" id="2806201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2806204">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2806255">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2806315">type</span>&nbsp;<span class="ident" id="2806320">genericReplacer</span>&nbsp;<span class="keyword" id="2806336">struct</span>&nbsp;<span class="op" id="2806343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806346">root</span>&nbsp;<span class="ident" id="2806351">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2806361">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2806435">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806460">tableSize</span>&nbsp;<span class="builtintype" id="2806470">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2806475">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806544">mapping</span>&nbsp;<span class="op" id="2806552">[</span><span class="num" id="2806553">256</span><span class="op" id="2806556">]</span><span class="builtintype" id="2806557">byte</span><br>
<span class="lineno"></span><span class="op" id="2806562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2806565">func</span>&nbsp;<span class="ident" id="2806570">makeGenericReplacer</span><span class="op" id="2806589">(</span><span class="ident" id="2806590">oldnew</span>&nbsp;<span class="op" id="2806597">[</span><span class="op" id="2806598">]</span><span class="builtintype" id="2806599">string</span><span class="op" id="2806605">)</span>&nbsp;<span class="op" id="2806607">*</span><span class="ident" id="2806608">genericReplacer</span>&nbsp;<span class="op" id="2806624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806627">r</span>&nbsp;<span class="op" id="2806629">:=</span>&nbsp;<span class="builtinfunc" id="2806632">new</span><span class="op" id="2806635">(</span><span class="ident" id="2806636">genericReplacer</span><span class="op" id="2806651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2806654">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806711">for</span>&nbsp;<span class="ident" id="2806715">i</span>&nbsp;<span class="op" id="2806717">:=</span>&nbsp;<span class="num" id="2806720">0</span><span class="op" id="2806721">;</span>&nbsp;<span class="ident" id="2806723">i</span>&nbsp;<span class="op" id="2806725">&lt;</span>&nbsp;<span class="builtinfunc" id="2806727">len</span><span class="op" id="2806730">(</span><span class="ident" id="2806731">oldnew</span><span class="op" id="2806737">)</span><span class="op" id="2806738">;</span>&nbsp;<span class="ident" id="2806740">i</span>&nbsp;<span class="op" id="2806742">+=</span>&nbsp;<span class="num" id="2806745">2</span>&nbsp;<span class="op" id="2806747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806751">key</span>&nbsp;<span class="op" id="2806755">:=</span>&nbsp;<span class="ident" id="2806758">oldnew</span><span class="op" id="2806764">[</span><span class="ident" id="2806765">i</span><span class="op" id="2806766">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806770">for</span>&nbsp;<span class="ident" id="2806774">j</span>&nbsp;<span class="op" id="2806776">:=</span>&nbsp;<span class="num" id="2806779">0</span><span class="op" id="2806780">;</span>&nbsp;<span class="ident" id="2806782">j</span>&nbsp;<span class="op" id="2806784">&lt;</span>&nbsp;<span class="builtinfunc" id="2806786">len</span><span class="op" id="2806789">(</span><span class="ident" id="2806790">key</span><span class="op" id="2806793">)</span><span class="op" id="2806794">;</span>&nbsp;<span class="ident" id="2806796">j</span><span class="op" id="2806797">++</span>&nbsp;<span class="op" id="2806800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806805">r</span><span class="op" id="2806806">.</span><span class="ident" id="2806807">mapping</span><span class="op" id="2806814">[</span><span class="ident" id="2806815">key</span><span class="op" id="2806818">[</span><span class="ident" id="2806819">j</span><span class="op" id="2806820">]</span><span class="op" id="2806821">]</span>&nbsp;<span class="op" id="2806823">=</span>&nbsp;<span class="num" id="2806825">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806836">for</span>&nbsp;<span class="ident" id="2806840">_</span><span class="op" id="2806841">,</span>&nbsp;<span class="ident" id="2806843">b</span>&nbsp;<span class="op" id="2806845">:=</span>&nbsp;<span class="keyword" id="2806848">range</span>&nbsp;<span class="ident" id="2806854">r</span><span class="op" id="2806855">.</span><span class="ident" id="2806856">mapping</span>&nbsp;<span class="op" id="2806864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806868">r</span><span class="op" id="2806869">.</span><span class="ident" id="2806870">tableSize</span>&nbsp;<span class="op" id="2806880">+=</span>&nbsp;<span class="builtintype" id="2806883">int</span><span class="op" id="2806886">(</span><span class="ident" id="2806887">b</span><span class="op" id="2806888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806895">var</span>&nbsp;<span class="ident" id="2806899">index</span>&nbsp;<span class="builtintype" id="2806905">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806911">for</span>&nbsp;<span class="ident" id="2806915">i</span><span class="op" id="2806916">,</span>&nbsp;<span class="ident" id="2806918">b</span>&nbsp;<span class="op" id="2806920">:=</span>&nbsp;<span class="keyword" id="2806923">range</span>&nbsp;<span class="ident" id="2806929">r</span><span class="op" id="2806930">.</span><span class="ident" id="2806931">mapping</span>&nbsp;<span class="op" id="2806939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2806943">if</span>&nbsp;<span class="ident" id="2806946">b</span>&nbsp;<span class="op" id="2806948">==</span>&nbsp;<span class="num" id="2806951">0</span>&nbsp;<span class="op" id="2806953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2806958">r</span><span class="op" id="2806959">.</span><span class="ident" id="2806960">mapping</span><span class="op" id="2806967">[</span><span class="ident" id="2806968">i</span><span class="op" id="2806969">]</span>&nbsp;<span class="op" id="2806971">=</span>&nbsp;<span class="builtintype" id="2806973">byte</span><span class="op" id="2806977">(</span><span class="ident" id="2806978">r</span><span class="op" id="2806979">.</span><span class="ident" id="2806980">tableSize</span><span class="op" id="2806989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2806993">}</span>&nbsp;<span class="keyword" id="2806995">else</span>&nbsp;<span class="op" id="2807000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807005">r</span><span class="op" id="2807006">.</span><span class="ident" id="2807007">mapping</span><span class="op" id="2807014">[</span><span class="ident" id="2807015">i</span><span class="op" id="2807016">]</span>&nbsp;<span class="op" id="2807018">=</span>&nbsp;<span class="ident" id="2807020">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807029">index</span><span class="op" id="2807034">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2807045">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807105">r</span><span class="op" id="2807106">.</span><span class="ident" id="2807107">root</span><span class="op" id="2807111">.</span><span class="ident" id="2807112">table</span>&nbsp;<span class="op" id="2807118">=</span>&nbsp;<span class="builtinfunc" id="2807120">make</span><span class="op" id="2807124">(</span><span class="op" id="2807125">[</span><span class="op" id="2807126">]</span><span class="op" id="2807127">*</span><span class="ident" id="2807128">trieNode</span><span class="op" id="2807136">,</span>&nbsp;<span class="ident" id="2807138">r</span><span class="op" id="2807139">.</span><span class="ident" id="2807140">tableSize</span><span class="op" id="2807149">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807153">for</span>&nbsp;<span class="ident" id="2807157">i</span>&nbsp;<span class="op" id="2807159">:=</span>&nbsp;<span class="num" id="2807162">0</span><span class="op" id="2807163">;</span>&nbsp;<span class="ident" id="2807165">i</span>&nbsp;<span class="op" id="2807167">&lt;</span>&nbsp;<span class="builtinfunc" id="2807169">len</span><span class="op" id="2807172">(</span><span class="ident" id="2807173">oldnew</span><span class="op" id="2807179">)</span><span class="op" id="2807180">;</span>&nbsp;<span class="ident" id="2807182">i</span>&nbsp;<span class="op" id="2807184">+=</span>&nbsp;<span class="num" id="2807187">2</span>&nbsp;<span class="op" id="2807189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807193">r</span><span class="op" id="2807194">.</span><span class="ident" id="2807195">root</span><span class="op" id="2807199">.</span><span class="ident" id="2807200">add</span><span class="op" id="2807203">(</span><span class="ident" id="2807204">oldnew</span><span class="op" id="2807210">[</span><span class="ident" id="2807211">i</span><span class="op" id="2807212">]</span><span class="op" id="2807213">,</span>&nbsp;<span class="ident" id="2807215">oldnew</span><span class="op" id="2807221">[</span><span class="ident" id="2807222">i</span><span class="op" id="2807223">+</span><span class="num" id="2807224">1</span><span class="op" id="2807225">]</span><span class="op" id="2807226">,</span>&nbsp;<span class="builtinfunc" id="2807228">len</span><span class="op" id="2807231">(</span><span class="ident" id="2807232">oldnew</span><span class="op" id="2807238">)</span><span class="op" id="2807239">-</span><span class="ident" id="2807240">i</span><span class="op" id="2807241">,</span>&nbsp;<span class="ident" id="2807243">r</span><span class="op" id="2807244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807250">return</span>&nbsp;<span class="ident" id="2807257">r</span><br>
<span class="lineno">270</span><span class="op" id="2807259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2807262">type</span>&nbsp;<span class="ident" id="2807267">appendSliceWriter</span>&nbsp;<span class="op" id="2807285">[</span><span class="op" id="2807286">]</span><span class="builtintype" id="2807287">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2807293">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2807345">func</span>&nbsp;<span class="op" id="2807350">(</span><span class="ident" id="2807351">w</span>&nbsp;<span class="op" id="2807353">*</span><span class="ident" id="2807354">appendSliceWriter</span><span class="op" id="2807371">)</span>&nbsp;<span class="ident" id="2807373">Write</span><span class="op" id="2807378">(</span><span class="ident" id="2807379">p</span>&nbsp;<span class="op" id="2807381">[</span><span class="op" id="2807382">]</span><span class="builtintype" id="2807383">byte</span><span class="op" id="2807387">)</span>&nbsp;<span class="op" id="2807389">(</span><span class="builtintype" id="2807390">int</span><span class="op" id="2807393">,</span>&nbsp;<span class="builtintype" id="2807395">error</span><span class="op" id="2807400">)</span>&nbsp;<span class="op" id="2807402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807405">*</span><span class="ident" id="2807406">w</span>&nbsp;<span class="op" id="2807408">=</span>&nbsp;<span class="builtinfunc" id="2807410">append</span><span class="op" id="2807416">(</span><span class="op" id="2807417">*</span><span class="ident" id="2807418">w</span><span class="op" id="2807419">,</span>&nbsp;<span class="ident" id="2807421">p</span><span class="op" id="2807422">...</span><span class="op" id="2807425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807428">return</span>&nbsp;<span class="builtinfunc" id="2807435">len</span><span class="op" id="2807438">(</span><span class="ident" id="2807439">p</span><span class="op" id="2807440">)</span><span class="op" id="2807441">,</span>&nbsp;<span class="ident" id="2807443">nil</span><br>
<span class="lineno"></span><span class="op" id="2807447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2807450">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2807530">func</span>&nbsp;<span class="op" id="2807535">(</span><span class="ident" id="2807536">w</span>&nbsp;<span class="op" id="2807538">*</span><span class="ident" id="2807539">appendSliceWriter</span><span class="op" id="2807556">)</span>&nbsp;<span class="ident" id="2807558">WriteString</span><span class="op" id="2807569">(</span><span class="ident" id="2807570">s</span>&nbsp;<span class="builtintype" id="2807572">string</span><span class="op" id="2807578">)</span>&nbsp;<span class="op" id="2807580">(</span><span class="builtintype" id="2807581">int</span><span class="op" id="2807584">,</span>&nbsp;<span class="builtintype" id="2807586">error</span><span class="op" id="2807591">)</span>&nbsp;<span class="op" id="2807593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807596">*</span><span class="ident" id="2807597">w</span>&nbsp;<span class="op" id="2807599">=</span>&nbsp;<span class="builtinfunc" id="2807601">append</span><span class="op" id="2807607">(</span><span class="op" id="2807608">*</span><span class="ident" id="2807609">w</span><span class="op" id="2807610">,</span>&nbsp;<span class="ident" id="2807612">s</span><span class="op" id="2807613">...</span><span class="op" id="2807616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807619">return</span>&nbsp;<span class="builtinfunc" id="2807626">len</span><span class="op" id="2807629">(</span><span class="ident" id="2807630">s</span><span class="op" id="2807631">)</span><span class="op" id="2807632">,</span>&nbsp;<span class="ident" id="2807634">nil</span><br>
<span class="lineno"></span><span class="op" id="2807638">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2807641">type</span>&nbsp;<span class="ident" id="2807646">stringWriterIface</span>&nbsp;<span class="keyword" id="2807664">interface</span>&nbsp;<span class="op" id="2807674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807677">WriteString</span><span class="op" id="2807688">(</span><span class="builtintype" id="2807689">string</span><span class="op" id="2807695">)</span>&nbsp;<span class="op" id="2807697">(</span><span class="builtintype" id="2807698">int</span><span class="op" id="2807701">,</span>&nbsp;<span class="builtintype" id="2807703">error</span><span class="op" id="2807708">)</span><br>
<span class="lineno"></span><span class="op" id="2807710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2807713">type</span>&nbsp;<span class="ident" id="2807718">stringWriter</span>&nbsp;<span class="keyword" id="2807731">struct</span>&nbsp;<span class="op" id="2807738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807741">w</span>&nbsp;<span class="ident" id="2807743">io</span><span class="op" id="2807745">.</span><span class="ident" id="2807746">Writer</span><br>
<span class="lineno"></span><span class="op" id="2807753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2807756">func</span>&nbsp;<span class="op" id="2807761">(</span><span class="ident" id="2807762">w</span>&nbsp;<span class="ident" id="2807764">stringWriter</span><span class="op" id="2807776">)</span>&nbsp;<span class="ident" id="2807778">WriteString</span><span class="op" id="2807789">(</span><span class="ident" id="2807790">s</span>&nbsp;<span class="builtintype" id="2807792">string</span><span class="op" id="2807798">)</span>&nbsp;<span class="op" id="2807800">(</span><span class="builtintype" id="2807801">int</span><span class="op" id="2807804">,</span>&nbsp;<span class="builtintype" id="2807806">error</span><span class="op" id="2807811">)</span>&nbsp;<span class="op" id="2807813">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807816">return</span>&nbsp;<span class="ident" id="2807823">w</span><span class="op" id="2807824">.</span><span class="ident" id="2807825">w</span><span class="op" id="2807826">.</span><span class="ident" id="2807827">Write</span><span class="op" id="2807832">(</span><span class="op" id="2807833">[</span><span class="op" id="2807834">]</span><span class="builtintype" id="2807835">byte</span><span class="op" id="2807839">(</span><span class="ident" id="2807840">s</span><span class="op" id="2807841">)</span><span class="op" id="2807842">)</span><br>
<span class="lineno"></span><span class="op" id="2807844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2807847">func</span>&nbsp;<span class="ident" id="2807852">getStringWriter</span><span class="op" id="2807867">(</span><span class="ident" id="2807868">w</span>&nbsp;<span class="ident" id="2807870">io</span><span class="op" id="2807872">.</span><span class="ident" id="2807873">Writer</span><span class="op" id="2807879">)</span>&nbsp;<span class="ident" id="2807881">stringWriterIface</span>&nbsp;<span class="op" id="2807899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807902">sw</span><span class="op" id="2807904">,</span>&nbsp;<span class="ident" id="2807906">ok</span>&nbsp;<span class="op" id="2807909">:=</span>&nbsp;<span class="ident" id="2807912">w</span><span class="op" id="2807913">.</span><span class="op" id="2807914">(</span><span class="ident" id="2807915">stringWriterIface</span><span class="op" id="2807932">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807935">if</span>&nbsp;<span class="op" id="2807938">!</span><span class="ident" id="2807939">ok</span>&nbsp;<span class="op" id="2807942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2807946">sw</span>&nbsp;<span class="op" id="2807949">=</span>&nbsp;<span class="ident" id="2807951">stringWriter</span><span class="op" id="2807963">{</span><span class="ident" id="2807964">w</span><span class="op" id="2807965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2807968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2807971">return</span>&nbsp;<span class="ident" id="2807978">sw</span><br>
<span class="lineno"></span><span class="op" id="2807981">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2807984">func</span>&nbsp;<span class="op" id="2807989">(</span><span class="ident" id="2807990">r</span>&nbsp;<span class="op" id="2807992">*</span><span class="ident" id="2807993">genericReplacer</span><span class="op" id="2808008">)</span>&nbsp;<span class="ident" id="2808010">Replace</span><span class="op" id="2808017">(</span><span class="ident" id="2808018">s</span>&nbsp;<span class="builtintype" id="2808020">string</span><span class="op" id="2808026">)</span>&nbsp;<span class="builtintype" id="2808028">string</span>&nbsp;<span class="op" id="2808035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808038">buf</span>&nbsp;<span class="op" id="2808042">:=</span>&nbsp;<span class="builtinfunc" id="2808045">make</span><span class="op" id="2808049">(</span><span class="ident" id="2808050">appendSliceWriter</span><span class="op" id="2808067">,</span>&nbsp;<span class="num" id="2808069">0</span><span class="op" id="2808070">,</span>&nbsp;<span class="builtinfunc" id="2808072">len</span><span class="op" id="2808075">(</span><span class="ident" id="2808076">s</span><span class="op" id="2808077">)</span><span class="op" id="2808078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808081">r</span><span class="op" id="2808082">.</span><span class="ident" id="2808083">WriteString</span><span class="op" id="2808094">(</span><span class="op" id="2808095">&amp;</span><span class="ident" id="2808096">buf</span><span class="op" id="2808099">,</span>&nbsp;<span class="ident" id="2808101">s</span><span class="op" id="2808102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808105">return</span>&nbsp;<span class="builtintype" id="2808112">string</span><span class="op" id="2808118">(</span><span class="ident" id="2808119">buf</span><span class="op" id="2808122">)</span><br>
<span class="lineno">310</span><span class="op" id="2808124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2808127">func</span>&nbsp;<span class="op" id="2808132">(</span><span class="ident" id="2808133">r</span>&nbsp;<span class="op" id="2808135">*</span><span class="ident" id="2808136">genericReplacer</span><span class="op" id="2808151">)</span>&nbsp;<span class="ident" id="2808153">WriteString</span><span class="op" id="2808164">(</span><span class="ident" id="2808165">w</span>&nbsp;<span class="ident" id="2808167">io</span><span class="op" id="2808169">.</span><span class="ident" id="2808170">Writer</span><span class="op" id="2808176">,</span>&nbsp;<span class="ident" id="2808178">s</span>&nbsp;<span class="builtintype" id="2808180">string</span><span class="op" id="2808186">)</span>&nbsp;<span class="op" id="2808188">(</span><span class="ident" id="2808189">n</span>&nbsp;<span class="builtintype" id="2808191">int</span><span class="op" id="2808194">,</span>&nbsp;<span class="ident" id="2808196">err</span>&nbsp;<span class="builtintype" id="2808200">error</span><span class="op" id="2808205">)</span>&nbsp;<span class="op" id="2808207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808210">sw</span>&nbsp;<span class="op" id="2808213">:=</span>&nbsp;<span class="ident" id="2808216">getStringWriter</span><span class="op" id="2808231">(</span><span class="ident" id="2808232">w</span><span class="op" id="2808233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808236">var</span>&nbsp;<span class="ident" id="2808240">last</span><span class="op" id="2808244">,</span>&nbsp;<span class="ident" id="2808246">wn</span>&nbsp;<span class="builtintype" id="2808249">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808254">var</span>&nbsp;<span class="ident" id="2808258">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2808273">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808279">for</span>&nbsp;<span class="ident" id="2808283">i</span>&nbsp;<span class="op" id="2808285">:=</span>&nbsp;<span class="num" id="2808288">0</span><span class="op" id="2808289">;</span>&nbsp;<span class="ident" id="2808291">i</span>&nbsp;<span class="op" id="2808293">&lt;=</span>&nbsp;<span class="builtinfunc" id="2808296">len</span><span class="op" id="2808299">(</span><span class="ident" id="2808300">s</span><span class="op" id="2808301">)</span><span class="op" id="2808302">;</span>&nbsp;<span class="op" id="2808304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808308">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808361">if</span>&nbsp;<span class="ident" id="2808364">i</span>&nbsp;<span class="op" id="2808366">!=</span>&nbsp;<span class="builtinfunc" id="2808369">len</span><span class="op" id="2808372">(</span><span class="ident" id="2808373">s</span><span class="op" id="2808374">)</span>&nbsp;<span class="op" id="2808376">&amp;&amp;</span>&nbsp;<span class="ident" id="2808379">r</span><span class="op" id="2808380">.</span><span class="ident" id="2808381">root</span><span class="op" id="2808385">.</span><span class="ident" id="2808386">priority</span>&nbsp;<span class="op" id="2808395">==</span>&nbsp;<span class="num" id="2808398">0</span>&nbsp;<span class="op" id="2808400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808405">index</span>&nbsp;<span class="op" id="2808411">:=</span>&nbsp;<span class="builtintype" id="2808414">int</span><span class="op" id="2808417">(</span><span class="ident" id="2808418">r</span><span class="op" id="2808419">.</span><span class="ident" id="2808420">mapping</span><span class="op" id="2808427">[</span><span class="ident" id="2808428">s</span><span class="op" id="2808429">[</span><span class="ident" id="2808430">i</span><span class="op" id="2808431">]</span><span class="op" id="2808432">]</span><span class="op" id="2808433">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808438">if</span>&nbsp;<span class="ident" id="2808441">index</span>&nbsp;<span class="op" id="2808447">==</span>&nbsp;<span class="ident" id="2808450">r</span><span class="op" id="2808451">.</span><span class="ident" id="2808452">tableSize</span>&nbsp;<span class="op" id="2808462">||</span>&nbsp;<span class="ident" id="2808465">r</span><span class="op" id="2808466">.</span><span class="ident" id="2808467">root</span><span class="op" id="2808471">.</span><span class="ident" id="2808472">table</span><span class="op" id="2808477">[</span><span class="ident" id="2808478">index</span><span class="op" id="2808483">]</span>&nbsp;<span class="op" id="2808485">==</span>&nbsp;<span class="ident" id="2808488">nil</span>&nbsp;<span class="op" id="2808492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808498">i</span><span class="op" id="2808499">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808506">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808522">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2808527">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808600">val</span><span class="op" id="2808603">,</span>&nbsp;<span class="ident" id="2808605">keylen</span><span class="op" id="2808611">,</span>&nbsp;<span class="ident" id="2808613">match</span>&nbsp;<span class="op" id="2808619">:=</span>&nbsp;<span class="ident" id="2808622">r</span><span class="op" id="2808623">.</span><span class="ident" id="2808624">lookup</span><span class="op" id="2808630">(</span><span class="ident" id="2808631">s</span><span class="op" id="2808632">[</span><span class="ident" id="2808633">i</span><span class="op" id="2808634">:</span><span class="op" id="2808635">]</span><span class="op" id="2808636">,</span>&nbsp;<span class="ident" id="2808638">prevMatchEmpty</span><span class="op" id="2808652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808656">prevMatchEmpty</span>&nbsp;<span class="op" id="2808671">=</span>&nbsp;<span class="ident" id="2808673">match</span>&nbsp;<span class="op" id="2808679">&amp;&amp;</span>&nbsp;<span class="ident" id="2808682">keylen</span>&nbsp;<span class="op" id="2808689">==</span>&nbsp;<span class="num" id="2808692">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808696">if</span>&nbsp;<span class="ident" id="2808699">match</span>&nbsp;<span class="op" id="2808705">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808710">wn</span><span class="op" id="2808712">,</span>&nbsp;<span class="ident" id="2808714">err</span>&nbsp;<span class="op" id="2808718">=</span>&nbsp;<span class="ident" id="2808720">sw</span><span class="op" id="2808722">.</span><span class="ident" id="2808723">WriteString</span><span class="op" id="2808734">(</span><span class="ident" id="2808735">s</span><span class="op" id="2808736">[</span><span class="ident" id="2808737">last</span><span class="op" id="2808741">:</span><span class="ident" id="2808742">i</span><span class="op" id="2808743">]</span><span class="op" id="2808744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808749">n</span>&nbsp;<span class="op" id="2808751">+=</span>&nbsp;<span class="ident" id="2808754">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808760">if</span>&nbsp;<span class="ident" id="2808763">err</span>&nbsp;<span class="op" id="2808767">!=</span>&nbsp;<span class="ident" id="2808770">nil</span>&nbsp;<span class="op" id="2808774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808780">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808790">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808795">wn</span><span class="op" id="2808797">,</span>&nbsp;<span class="ident" id="2808799">err</span>&nbsp;<span class="op" id="2808803">=</span>&nbsp;<span class="ident" id="2808805">sw</span><span class="op" id="2808807">.</span><span class="ident" id="2808808">WriteString</span><span class="op" id="2808819">(</span><span class="ident" id="2808820">val</span><span class="op" id="2808823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808828">n</span>&nbsp;<span class="op" id="2808830">+=</span>&nbsp;<span class="ident" id="2808833">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808839">if</span>&nbsp;<span class="ident" id="2808842">err</span>&nbsp;<span class="op" id="2808846">!=</span>&nbsp;<span class="ident" id="2808849">nil</span>&nbsp;<span class="op" id="2808853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808859">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808869">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808874">i</span>&nbsp;<span class="op" id="2808876">+=</span>&nbsp;<span class="ident" id="2808879">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808889">last</span>&nbsp;<span class="op" id="2808894">=</span>&nbsp;<span class="ident" id="2808896">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808901">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808916">i</span><span class="op" id="2808917">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808924">if</span>&nbsp;<span class="ident" id="2808927">last</span>&nbsp;<span class="op" id="2808932">!=</span>&nbsp;<span class="builtinfunc" id="2808935">len</span><span class="op" id="2808938">(</span><span class="ident" id="2808939">s</span><span class="op" id="2808940">)</span>&nbsp;<span class="op" id="2808942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808946">wn</span><span class="op" id="2808948">,</span>&nbsp;<span class="ident" id="2808950">err</span>&nbsp;<span class="op" id="2808954">=</span>&nbsp;<span class="ident" id="2808956">sw</span><span class="op" id="2808958">.</span><span class="ident" id="2808959">WriteString</span><span class="op" id="2808970">(</span><span class="ident" id="2808971">s</span><span class="op" id="2808972">[</span><span class="ident" id="2808973">last</span><span class="op" id="2808977">:</span><span class="op" id="2808978">]</span><span class="op" id="2808979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2808983">n</span>&nbsp;<span class="op" id="2808985">+=</span>&nbsp;<span class="ident" id="2808988">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2808992">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2808995">return</span><br>
<span class="lineno"></span><span class="op" id="2809002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2809005">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2809082">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2809149">type</span>&nbsp;<span class="ident" id="2809154">singleStringReplacer</span>&nbsp;<span class="keyword" id="2809175">struct</span>&nbsp;<span class="op" id="2809182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809185">finder</span>&nbsp;<span class="op" id="2809192">*</span><span class="ident" id="2809193">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2809207">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809279">value</span>&nbsp;<span class="builtintype" id="2809285">string</span><br>
<span class="lineno"></span><span class="op" id="2809292">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2809295">func</span>&nbsp;<span class="ident" id="2809300">makeSingleStringReplacer</span><span class="op" id="2809324">(</span><span class="ident" id="2809325">pattern</span>&nbsp;<span class="builtintype" id="2809333">string</span><span class="op" id="2809339">,</span>&nbsp;<span class="ident" id="2809341">value</span>&nbsp;<span class="builtintype" id="2809347">string</span><span class="op" id="2809353">)</span>&nbsp;<span class="op" id="2809355">*</span><span class="ident" id="2809356">singleStringReplacer</span>&nbsp;<span class="op" id="2809377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809380">return</span>&nbsp;<span class="op" id="2809387">&amp;</span><span class="ident" id="2809388">singleStringReplacer</span><span class="op" id="2809408">{</span><span class="ident" id="2809409">finder</span><span class="op" id="2809415">:</span>&nbsp;<span class="ident" id="2809417">makeStringFinder</span><span class="op" id="2809433">(</span><span class="ident" id="2809434">pattern</span><span class="op" id="2809441">)</span><span class="op" id="2809442">,</span>&nbsp;<span class="ident" id="2809444">value</span><span class="op" id="2809449">:</span>&nbsp;<span class="ident" id="2809451">value</span><span class="op" id="2809456">}</span><br>
<span class="lineno"></span><span class="op" id="2809458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2809461">func</span>&nbsp;<span class="op" id="2809466">(</span><span class="ident" id="2809467">r</span>&nbsp;<span class="op" id="2809469">*</span><span class="ident" id="2809470">singleStringReplacer</span><span class="op" id="2809490">)</span>&nbsp;<span class="ident" id="2809492">Replace</span><span class="op" id="2809499">(</span><span class="ident" id="2809500">s</span>&nbsp;<span class="builtintype" id="2809502">string</span><span class="op" id="2809508">)</span>&nbsp;<span class="builtintype" id="2809510">string</span>&nbsp;<span class="op" id="2809517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809520">var</span>&nbsp;<span class="ident" id="2809524">buf</span>&nbsp;<span class="op" id="2809528">[</span><span class="op" id="2809529">]</span><span class="builtintype" id="2809530">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809536">i</span><span class="op" id="2809537">,</span>&nbsp;<span class="ident" id="2809539">matched</span>&nbsp;<span class="op" id="2809547">:=</span>&nbsp;<span class="num" id="2809550">0</span><span class="op" id="2809551">,</span>&nbsp;<span class="builtintype" id="2809553">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809560">for</span>&nbsp;<span class="op" id="2809564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809568">match</span>&nbsp;<span class="op" id="2809574">:=</span>&nbsp;<span class="ident" id="2809577">r</span><span class="op" id="2809578">.</span><span class="ident" id="2809579">finder</span><span class="op" id="2809585">.</span><span class="ident" id="2809586">next</span><span class="op" id="2809590">(</span><span class="ident" id="2809591">s</span><span class="op" id="2809592">[</span><span class="ident" id="2809593">i</span><span class="op" id="2809594">:</span><span class="op" id="2809595">]</span><span class="op" id="2809596">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809600">if</span>&nbsp;<span class="ident" id="2809603">match</span>&nbsp;<span class="op" id="2809609">==</span>&nbsp;<span class="op" id="2809612">-</span><span class="num" id="2809613">1</span>&nbsp;<span class="op" id="2809615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809620">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2809628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809632">matched</span>&nbsp;<span class="op" id="2809640">=</span>&nbsp;<span class="builtintype" id="2809642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809649">buf</span>&nbsp;<span class="op" id="2809653">=</span>&nbsp;<span class="builtinfunc" id="2809655">append</span><span class="op" id="2809661">(</span><span class="ident" id="2809662">buf</span><span class="op" id="2809665">,</span>&nbsp;<span class="ident" id="2809667">s</span><span class="op" id="2809668">[</span><span class="ident" id="2809669">i</span><span class="op" id="2809670">:</span><span class="ident" id="2809671">i</span><span class="op" id="2809672">+</span><span class="ident" id="2809673">match</span><span class="op" id="2809678">]</span><span class="op" id="2809679">...</span><span class="op" id="2809682">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809686">buf</span>&nbsp;<span class="op" id="2809690">=</span>&nbsp;<span class="builtinfunc" id="2809692">append</span><span class="op" id="2809698">(</span><span class="ident" id="2809699">buf</span><span class="op" id="2809702">,</span>&nbsp;<span class="ident" id="2809704">r</span><span class="op" id="2809705">.</span><span class="ident" id="2809706">value</span><span class="op" id="2809711">...</span><span class="op" id="2809714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809718">i</span>&nbsp;<span class="op" id="2809720">+=</span>&nbsp;<span class="ident" id="2809723">match</span>&nbsp;<span class="op" id="2809729">+</span>&nbsp;<span class="builtinfunc" id="2809731">len</span><span class="op" id="2809734">(</span><span class="ident" id="2809735">r</span><span class="op" id="2809736">.</span><span class="ident" id="2809737">finder</span><span class="op" id="2809743">.</span><span class="ident" id="2809744">pattern</span><span class="op" id="2809751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2809754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809757">if</span>&nbsp;<span class="op" id="2809760">!</span><span class="ident" id="2809761">matched</span>&nbsp;<span class="op" id="2809769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809773">return</span>&nbsp;<span class="ident" id="2809780">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2809783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809786">buf</span>&nbsp;<span class="op" id="2809790">=</span>&nbsp;<span class="builtinfunc" id="2809792">append</span><span class="op" id="2809798">(</span><span class="ident" id="2809799">buf</span><span class="op" id="2809802">,</span>&nbsp;<span class="ident" id="2809804">s</span><span class="op" id="2809805">[</span><span class="ident" id="2809806">i</span><span class="op" id="2809807">:</span><span class="op" id="2809808">]</span><span class="op" id="2809809">...</span><span class="op" id="2809812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809815">return</span>&nbsp;<span class="builtintype" id="2809822">string</span><span class="op" id="2809828">(</span><span class="ident" id="2809829">buf</span><span class="op" id="2809832">)</span><br>
<span class="lineno"></span><span class="op" id="2809834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2809837">func</span>&nbsp;<span class="op" id="2809842">(</span><span class="ident" id="2809843">r</span>&nbsp;<span class="op" id="2809845">*</span><span class="ident" id="2809846">singleStringReplacer</span><span class="op" id="2809866">)</span>&nbsp;<span class="ident" id="2809868">WriteString</span><span class="op" id="2809879">(</span><span class="ident" id="2809880">w</span>&nbsp;<span class="ident" id="2809882">io</span><span class="op" id="2809884">.</span><span class="ident" id="2809885">Writer</span><span class="op" id="2809891">,</span>&nbsp;<span class="ident" id="2809893">s</span>&nbsp;<span class="builtintype" id="2809895">string</span><span class="op" id="2809901">)</span>&nbsp;<span class="op" id="2809903">(</span><span class="ident" id="2809904">n</span>&nbsp;<span class="builtintype" id="2809906">int</span><span class="op" id="2809909">,</span>&nbsp;<span class="ident" id="2809911">err</span>&nbsp;<span class="builtintype" id="2809915">error</span><span class="op" id="2809920">)</span>&nbsp;<span class="op" id="2809922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809925">sw</span>&nbsp;<span class="op" id="2809928">:=</span>&nbsp;<span class="ident" id="2809931">getStringWriter</span><span class="op" id="2809946">(</span><span class="ident" id="2809947">w</span><span class="op" id="2809948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809951">var</span>&nbsp;<span class="ident" id="2809955">i</span><span class="op" id="2809956">,</span>&nbsp;<span class="ident" id="2809958">wn</span>&nbsp;<span class="builtintype" id="2809961">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2809966">for</span>&nbsp;<span class="op" id="2809970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2809974">match</span>&nbsp;<span class="op" id="2809980">:=</span>&nbsp;<span class="ident" id="2809983">r</span><span class="op" id="2809984">.</span><span class="ident" id="2809985">finder</span><span class="op" id="2809991">.</span><span class="ident" id="2809992">next</span><span class="op" id="2809996">(</span><span class="ident" id="2809997">s</span><span class="op" id="2809998">[</span><span class="ident" id="2809999">i</span><span class="op" id="2810000">:</span><span class="op" id="2810001">]</span><span class="op" id="2810002">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810006">if</span>&nbsp;<span class="ident" id="2810009">match</span>&nbsp;<span class="op" id="2810015">==</span>&nbsp;<span class="op" id="2810018">-</span><span class="num" id="2810019">1</span>&nbsp;<span class="op" id="2810021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810026">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810038">wn</span><span class="op" id="2810040">,</span>&nbsp;<span class="ident" id="2810042">err</span>&nbsp;<span class="op" id="2810046">=</span>&nbsp;<span class="ident" id="2810048">sw</span><span class="op" id="2810050">.</span><span class="ident" id="2810051">WriteString</span><span class="op" id="2810062">(</span><span class="ident" id="2810063">s</span><span class="op" id="2810064">[</span><span class="ident" id="2810065">i</span>&nbsp;<span class="op" id="2810067">:</span>&nbsp;<span class="ident" id="2810069">i</span><span class="op" id="2810070">+</span><span class="ident" id="2810071">match</span><span class="op" id="2810076">]</span><span class="op" id="2810077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810081">n</span>&nbsp;<span class="op" id="2810083">+=</span>&nbsp;<span class="ident" id="2810086">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810091">if</span>&nbsp;<span class="ident" id="2810094">err</span>&nbsp;<span class="op" id="2810098">!=</span>&nbsp;<span class="ident" id="2810101">nil</span>&nbsp;<span class="op" id="2810105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810123">wn</span><span class="op" id="2810125">,</span>&nbsp;<span class="ident" id="2810127">err</span>&nbsp;<span class="op" id="2810131">=</span>&nbsp;<span class="ident" id="2810133">sw</span><span class="op" id="2810135">.</span><span class="ident" id="2810136">WriteString</span><span class="op" id="2810147">(</span><span class="ident" id="2810148">r</span><span class="op" id="2810149">.</span><span class="ident" id="2810150">value</span><span class="op" id="2810155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810159">n</span>&nbsp;<span class="op" id="2810161">+=</span>&nbsp;<span class="ident" id="2810164">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810169">if</span>&nbsp;<span class="ident" id="2810172">err</span>&nbsp;<span class="op" id="2810176">!=</span>&nbsp;<span class="ident" id="2810179">nil</span>&nbsp;<span class="op" id="2810183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810188">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810201">i</span>&nbsp;<span class="op" id="2810203">+=</span>&nbsp;<span class="ident" id="2810206">match</span>&nbsp;<span class="op" id="2810212">+</span>&nbsp;<span class="builtinfunc" id="2810214">len</span><span class="op" id="2810217">(</span><span class="ident" id="2810218">r</span><span class="op" id="2810219">.</span><span class="ident" id="2810220">finder</span><span class="op" id="2810226">.</span><span class="ident" id="2810227">pattern</span><span class="op" id="2810234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810237">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810240">wn</span><span class="op" id="2810242">,</span>&nbsp;<span class="ident" id="2810244">err</span>&nbsp;<span class="op" id="2810248">=</span>&nbsp;<span class="ident" id="2810250">sw</span><span class="op" id="2810252">.</span><span class="ident" id="2810253">WriteString</span><span class="op" id="2810264">(</span><span class="ident" id="2810265">s</span><span class="op" id="2810266">[</span><span class="ident" id="2810267">i</span><span class="op" id="2810268">:</span><span class="op" id="2810269">]</span><span class="op" id="2810270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810273">n</span>&nbsp;<span class="op" id="2810275">+=</span>&nbsp;<span class="ident" id="2810278">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810282">return</span><br>
<span class="lineno"></span><span class="op" id="2810289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2810292">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2810361">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2810405">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2810466">type</span>&nbsp;<span class="ident" id="2810471">byteReplacer</span>&nbsp;<span class="op" id="2810484">[</span><span class="num" id="2810485">256</span><span class="op" id="2810488">]</span><span class="builtintype" id="2810489">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2810495">func</span>&nbsp;<span class="op" id="2810500">(</span><span class="ident" id="2810501">r</span>&nbsp;<span class="op" id="2810503">*</span><span class="ident" id="2810504">byteReplacer</span><span class="op" id="2810516">)</span>&nbsp;<span class="ident" id="2810518">Replace</span><span class="op" id="2810525">(</span><span class="ident" id="2810526">s</span>&nbsp;<span class="builtintype" id="2810528">string</span><span class="op" id="2810534">)</span>&nbsp;<span class="builtintype" id="2810536">string</span>&nbsp;<span class="op" id="2810543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810546">var</span>&nbsp;<span class="ident" id="2810550">buf</span>&nbsp;<span class="op" id="2810554">[</span><span class="op" id="2810555">]</span><span class="builtintype" id="2810556">byte</span>&nbsp;<span class="comment" id="2810561">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810582">for</span>&nbsp;<span class="ident" id="2810586">i</span>&nbsp;<span class="op" id="2810588">:=</span>&nbsp;<span class="num" id="2810591">0</span><span class="op" id="2810592">;</span>&nbsp;<span class="ident" id="2810594">i</span>&nbsp;<span class="op" id="2810596">&lt;</span>&nbsp;<span class="builtinfunc" id="2810598">len</span><span class="op" id="2810601">(</span><span class="ident" id="2810602">s</span><span class="op" id="2810603">)</span><span class="op" id="2810604">;</span>&nbsp;<span class="ident" id="2810606">i</span><span class="op" id="2810607">++</span>&nbsp;<span class="op" id="2810610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810614">b</span>&nbsp;<span class="op" id="2810616">:=</span>&nbsp;<span class="ident" id="2810619">s</span><span class="op" id="2810620">[</span><span class="ident" id="2810621">i</span><span class="op" id="2810622">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810626">if</span>&nbsp;<span class="ident" id="2810629">r</span><span class="op" id="2810630">[</span><span class="ident" id="2810631">b</span><span class="op" id="2810632">]</span>&nbsp;<span class="op" id="2810634">!=</span>&nbsp;<span class="ident" id="2810637">b</span>&nbsp;<span class="op" id="2810639">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810644">if</span>&nbsp;<span class="ident" id="2810647">buf</span>&nbsp;<span class="op" id="2810651">==</span>&nbsp;<span class="ident" id="2810654">nil</span>&nbsp;<span class="op" id="2810658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810664">buf</span>&nbsp;<span class="op" id="2810668">=</span>&nbsp;<span class="op" id="2810670">[</span><span class="op" id="2810671">]</span><span class="builtintype" id="2810672">byte</span><span class="op" id="2810676">(</span><span class="ident" id="2810677">s</span><span class="op" id="2810678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810688">buf</span><span class="op" id="2810691">[</span><span class="ident" id="2810692">i</span><span class="op" id="2810693">]</span>&nbsp;<span class="op" id="2810695">=</span>&nbsp;<span class="ident" id="2810697">r</span><span class="op" id="2810698">[</span><span class="ident" id="2810699">b</span><span class="op" id="2810700">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810704">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810710">if</span>&nbsp;<span class="ident" id="2810713">buf</span>&nbsp;<span class="op" id="2810717">==</span>&nbsp;<span class="ident" id="2810720">nil</span>&nbsp;<span class="op" id="2810724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810728">return</span>&nbsp;<span class="ident" id="2810735">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810741">return</span>&nbsp;<span class="builtintype" id="2810748">string</span><span class="op" id="2810754">(</span><span class="ident" id="2810755">buf</span><span class="op" id="2810758">)</span><br>
<span class="lineno">430</span><span class="op" id="2810760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2810763">func</span>&nbsp;<span class="op" id="2810768">(</span><span class="ident" id="2810769">r</span>&nbsp;<span class="op" id="2810771">*</span><span class="ident" id="2810772">byteReplacer</span><span class="op" id="2810784">)</span>&nbsp;<span class="ident" id="2810786">WriteString</span><span class="op" id="2810797">(</span><span class="ident" id="2810798">w</span>&nbsp;<span class="ident" id="2810800">io</span><span class="op" id="2810802">.</span><span class="ident" id="2810803">Writer</span><span class="op" id="2810809">,</span>&nbsp;<span class="ident" id="2810811">s</span>&nbsp;<span class="builtintype" id="2810813">string</span><span class="op" id="2810819">)</span>&nbsp;<span class="op" id="2810821">(</span><span class="ident" id="2810822">n</span>&nbsp;<span class="builtintype" id="2810824">int</span><span class="op" id="2810827">,</span>&nbsp;<span class="ident" id="2810829">err</span>&nbsp;<span class="builtintype" id="2810833">error</span><span class="op" id="2810838">)</span>&nbsp;<span class="op" id="2810840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2810843">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810921">bufsize</span>&nbsp;<span class="op" id="2810929">:=</span>&nbsp;<span class="num" id="2810932">32</span>&nbsp;<span class="op" id="2810935">&lt;&lt;</span>&nbsp;<span class="num" id="2810938">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2810942">if</span>&nbsp;<span class="builtinfunc" id="2810945">len</span><span class="op" id="2810948">(</span><span class="ident" id="2810949">s</span><span class="op" id="2810950">)</span>&nbsp;<span class="op" id="2810952">&lt;</span>&nbsp;<span class="ident" id="2810954">bufsize</span>&nbsp;<span class="op" id="2810962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810966">bufsize</span>&nbsp;<span class="op" id="2810974">=</span>&nbsp;<span class="builtinfunc" id="2810976">len</span><span class="op" id="2810979">(</span><span class="ident" id="2810980">s</span><span class="op" id="2810981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2810984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2810987">buf</span>&nbsp;<span class="op" id="2810991">:=</span>&nbsp;<span class="builtinfunc" id="2810994">make</span><span class="op" id="2810998">(</span><span class="op" id="2810999">[</span><span class="op" id="2811000">]</span><span class="builtintype" id="2811001">byte</span><span class="op" id="2811005">,</span>&nbsp;<span class="ident" id="2811007">bufsize</span><span class="op" id="2811014">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811018">for</span>&nbsp;<span class="builtinfunc" id="2811022">len</span><span class="op" id="2811025">(</span><span class="ident" id="2811026">s</span><span class="op" id="2811027">)</span>&nbsp;<span class="op" id="2811029">&gt;</span>&nbsp;<span class="num" id="2811031">0</span>&nbsp;<span class="op" id="2811033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811037">ncopy</span>&nbsp;<span class="op" id="2811043">:=</span>&nbsp;<span class="builtinfunc" id="2811046">copy</span><span class="op" id="2811050">(</span><span class="ident" id="2811051">buf</span><span class="op" id="2811054">,</span>&nbsp;<span class="ident" id="2811056">s</span><span class="op" id="2811057">[</span><span class="op" id="2811058">:</span><span class="op" id="2811059">]</span><span class="op" id="2811060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811064">s</span>&nbsp;<span class="op" id="2811066">=</span>&nbsp;<span class="ident" id="2811068">s</span><span class="op" id="2811069">[</span><span class="ident" id="2811070">ncopy</span><span class="op" id="2811075">:</span><span class="op" id="2811076">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811080">for</span>&nbsp;<span class="ident" id="2811084">i</span><span class="op" id="2811085">,</span>&nbsp;<span class="ident" id="2811087">b</span>&nbsp;<span class="op" id="2811089">:=</span>&nbsp;<span class="keyword" id="2811092">range</span>&nbsp;<span class="ident" id="2811098">buf</span><span class="op" id="2811101">[</span><span class="op" id="2811102">:</span><span class="ident" id="2811103">ncopy</span><span class="op" id="2811108">]</span>&nbsp;<span class="op" id="2811110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811115">buf</span><span class="op" id="2811118">[</span><span class="ident" id="2811119">i</span><span class="op" id="2811120">]</span>&nbsp;<span class="op" id="2811122">=</span>&nbsp;<span class="ident" id="2811124">r</span><span class="op" id="2811125">[</span><span class="ident" id="2811126">b</span><span class="op" id="2811127">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811135">wn</span><span class="op" id="2811137">,</span>&nbsp;<span class="ident" id="2811139">err</span>&nbsp;<span class="op" id="2811143">:=</span>&nbsp;<span class="ident" id="2811146">w</span><span class="op" id="2811147">.</span><span class="ident" id="2811148">Write</span><span class="op" id="2811153">(</span><span class="ident" id="2811154">buf</span><span class="op" id="2811157">[</span><span class="op" id="2811158">:</span><span class="ident" id="2811159">ncopy</span><span class="op" id="2811164">]</span><span class="op" id="2811165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811169">n</span>&nbsp;<span class="op" id="2811171">+=</span>&nbsp;<span class="ident" id="2811174">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811179">if</span>&nbsp;<span class="ident" id="2811182">err</span>&nbsp;<span class="op" id="2811186">!=</span>&nbsp;<span class="ident" id="2811189">nil</span>&nbsp;<span class="op" id="2811193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811198">return</span>&nbsp;<span class="ident" id="2811205">n</span><span class="op" id="2811206">,</span>&nbsp;<span class="ident" id="2811208">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811220">return</span>&nbsp;<span class="ident" id="2811227">n</span><span class="op" id="2811228">,</span>&nbsp;<span class="ident" id="2811230">nil</span><br>
<span class="lineno"></span><span class="op" id="2811234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2811237">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2811306">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2811380">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2811447">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2811511">type</span>&nbsp;<span class="ident" id="2811516">byteStringReplacer</span>&nbsp;<span class="op" id="2811535">[</span><span class="num" id="2811536">256</span><span class="op" id="2811539">]</span><span class="op" id="2811540">[</span><span class="op" id="2811541">]</span><span class="builtintype" id="2811542">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2811548">func</span>&nbsp;<span class="op" id="2811553">(</span><span class="ident" id="2811554">r</span>&nbsp;<span class="op" id="2811556">*</span><span class="ident" id="2811557">byteStringReplacer</span><span class="op" id="2811575">)</span>&nbsp;<span class="ident" id="2811577">Replace</span><span class="op" id="2811584">(</span><span class="ident" id="2811585">s</span>&nbsp;<span class="builtintype" id="2811587">string</span><span class="op" id="2811593">)</span>&nbsp;<span class="builtintype" id="2811595">string</span>&nbsp;<span class="op" id="2811602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811605">newSize</span>&nbsp;<span class="op" id="2811613">:=</span>&nbsp;<span class="builtinfunc" id="2811616">len</span><span class="op" id="2811619">(</span><span class="ident" id="2811620">s</span><span class="op" id="2811621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811624">anyChanges</span>&nbsp;<span class="op" id="2811635">:=</span>&nbsp;<span class="builtintype" id="2811638">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811645">for</span>&nbsp;<span class="ident" id="2811649">i</span>&nbsp;<span class="op" id="2811651">:=</span>&nbsp;<span class="num" id="2811654">0</span><span class="op" id="2811655">;</span>&nbsp;<span class="ident" id="2811657">i</span>&nbsp;<span class="op" id="2811659">&lt;</span>&nbsp;<span class="builtinfunc" id="2811661">len</span><span class="op" id="2811664">(</span><span class="ident" id="2811665">s</span><span class="op" id="2811666">)</span><span class="op" id="2811667">;</span>&nbsp;<span class="ident" id="2811669">i</span><span class="op" id="2811670">++</span>&nbsp;<span class="op" id="2811673">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811677">b</span>&nbsp;<span class="op" id="2811679">:=</span>&nbsp;<span class="ident" id="2811682">s</span><span class="op" id="2811683">[</span><span class="ident" id="2811684">i</span><span class="op" id="2811685">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811689">if</span>&nbsp;<span class="ident" id="2811692">r</span><span class="op" id="2811693">[</span><span class="ident" id="2811694">b</span><span class="op" id="2811695">]</span>&nbsp;<span class="op" id="2811697">!=</span>&nbsp;<span class="ident" id="2811700">nil</span>&nbsp;<span class="op" id="2811704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811709">anyChanges</span>&nbsp;<span class="op" id="2811720">=</span>&nbsp;<span class="builtintype" id="2811722">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2811730">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811800">newSize</span>&nbsp;<span class="op" id="2811808">+=</span>&nbsp;<span class="builtinfunc" id="2811811">len</span><span class="op" id="2811814">(</span><span class="ident" id="2811815">r</span><span class="op" id="2811816">[</span><span class="ident" id="2811817">b</span><span class="op" id="2811818">]</span><span class="op" id="2811819">)</span>&nbsp;<span class="op" id="2811821">-</span>&nbsp;<span class="num" id="2811823">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811833">if</span>&nbsp;<span class="op" id="2811836">!</span><span class="ident" id="2811837">anyChanges</span>&nbsp;<span class="op" id="2811848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811852">return</span>&nbsp;<span class="ident" id="2811859">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2811862">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811865">buf</span>&nbsp;<span class="op" id="2811869">:=</span>&nbsp;<span class="builtinfunc" id="2811872">make</span><span class="op" id="2811876">(</span><span class="op" id="2811877">[</span><span class="op" id="2811878">]</span><span class="builtintype" id="2811879">byte</span><span class="op" id="2811883">,</span>&nbsp;<span class="ident" id="2811885">newSize</span><span class="op" id="2811892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811895">bi</span>&nbsp;<span class="op" id="2811898">:=</span>&nbsp;<span class="ident" id="2811901">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811906">for</span>&nbsp;<span class="ident" id="2811910">i</span>&nbsp;<span class="op" id="2811912">:=</span>&nbsp;<span class="num" id="2811915">0</span><span class="op" id="2811916">;</span>&nbsp;<span class="ident" id="2811918">i</span>&nbsp;<span class="op" id="2811920">&lt;</span>&nbsp;<span class="builtinfunc" id="2811922">len</span><span class="op" id="2811925">(</span><span class="ident" id="2811926">s</span><span class="op" id="2811927">)</span><span class="op" id="2811928">;</span>&nbsp;<span class="ident" id="2811930">i</span><span class="op" id="2811931">++</span>&nbsp;<span class="op" id="2811934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811938">b</span>&nbsp;<span class="op" id="2811940">:=</span>&nbsp;<span class="ident" id="2811943">s</span><span class="op" id="2811944">[</span><span class="ident" id="2811945">i</span><span class="op" id="2811946">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2811950">if</span>&nbsp;<span class="ident" id="2811953">r</span><span class="op" id="2811954">[</span><span class="ident" id="2811955">b</span><span class="op" id="2811956">]</span>&nbsp;<span class="op" id="2811958">!=</span>&nbsp;<span class="ident" id="2811961">nil</span>&nbsp;<span class="op" id="2811965">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811970">n</span>&nbsp;<span class="op" id="2811972">:=</span>&nbsp;<span class="builtinfunc" id="2811975">copy</span><span class="op" id="2811979">(</span><span class="ident" id="2811980">bi</span><span class="op" id="2811982">,</span>&nbsp;<span class="ident" id="2811984">r</span><span class="op" id="2811985">[</span><span class="ident" id="2811986">b</span><span class="op" id="2811987">]</span><span class="op" id="2811988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2811993">bi</span>&nbsp;<span class="op" id="2811996">=</span>&nbsp;<span class="ident" id="2811998">bi</span><span class="op" id="2812000">[</span><span class="ident" id="2812001">n</span><span class="op" id="2812002">:</span><span class="op" id="2812003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812007">}</span>&nbsp;<span class="keyword" id="2812009">else</span>&nbsp;<span class="op" id="2812014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812019">bi</span><span class="op" id="2812021">[</span><span class="num" id="2812022">0</span><span class="op" id="2812023">]</span>&nbsp;<span class="op" id="2812025">=</span>&nbsp;<span class="ident" id="2812027">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812032">bi</span>&nbsp;<span class="op" id="2812035">=</span>&nbsp;<span class="ident" id="2812037">bi</span><span class="op" id="2812039">[</span><span class="num" id="2812040">1</span><span class="op" id="2812041">:</span><span class="op" id="2812042">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812052">return</span>&nbsp;<span class="builtintype" id="2812059">string</span><span class="op" id="2812065">(</span><span class="ident" id="2812066">buf</span><span class="op" id="2812069">)</span><br>
<span class="lineno"></span><span class="op" id="2812071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2812074">func</span>&nbsp;<span class="op" id="2812079">(</span><span class="ident" id="2812080">r</span>&nbsp;<span class="op" id="2812082">*</span><span class="ident" id="2812083">byteStringReplacer</span><span class="op" id="2812101">)</span>&nbsp;<span class="ident" id="2812103">WriteString</span><span class="op" id="2812114">(</span><span class="ident" id="2812115">w</span>&nbsp;<span class="ident" id="2812117">io</span><span class="op" id="2812119">.</span><span class="ident" id="2812120">Writer</span><span class="op" id="2812126">,</span>&nbsp;<span class="ident" id="2812128">s</span>&nbsp;<span class="builtintype" id="2812130">string</span><span class="op" id="2812136">)</span>&nbsp;<span class="op" id="2812138">(</span><span class="ident" id="2812139">n</span>&nbsp;<span class="builtintype" id="2812141">int</span><span class="op" id="2812144">,</span>&nbsp;<span class="ident" id="2812146">err</span>&nbsp;<span class="builtintype" id="2812150">error</span><span class="op" id="2812155">)</span>&nbsp;<span class="op" id="2812157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812160">sw</span>&nbsp;<span class="op" id="2812163">:=</span>&nbsp;<span class="ident" id="2812166">getStringWriter</span><span class="op" id="2812181">(</span><span class="ident" id="2812182">w</span><span class="op" id="2812183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812186">last</span>&nbsp;<span class="op" id="2812191">:=</span>&nbsp;<span class="num" id="2812194">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812197">for</span>&nbsp;<span class="ident" id="2812201">i</span>&nbsp;<span class="op" id="2812203">:=</span>&nbsp;<span class="num" id="2812206">0</span><span class="op" id="2812207">;</span>&nbsp;<span class="ident" id="2812209">i</span>&nbsp;<span class="op" id="2812211">&lt;</span>&nbsp;<span class="builtinfunc" id="2812213">len</span><span class="op" id="2812216">(</span><span class="ident" id="2812217">s</span><span class="op" id="2812218">)</span><span class="op" id="2812219">;</span>&nbsp;<span class="ident" id="2812221">i</span><span class="op" id="2812222">++</span>&nbsp;<span class="op" id="2812225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812229">b</span>&nbsp;<span class="op" id="2812231">:=</span>&nbsp;<span class="ident" id="2812234">s</span><span class="op" id="2812235">[</span><span class="ident" id="2812236">i</span><span class="op" id="2812237">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812241">if</span>&nbsp;<span class="ident" id="2812244">r</span><span class="op" id="2812245">[</span><span class="ident" id="2812246">b</span><span class="op" id="2812247">]</span>&nbsp;<span class="op" id="2812249">==</span>&nbsp;<span class="ident" id="2812252">nil</span>&nbsp;<span class="op" id="2812256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812261">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812276">if</span>&nbsp;<span class="ident" id="2812279">last</span>&nbsp;<span class="op" id="2812284">!=</span>&nbsp;<span class="ident" id="2812287">i</span>&nbsp;<span class="op" id="2812289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812294">nw</span><span class="op" id="2812296">,</span>&nbsp;<span class="ident" id="2812298">err</span>&nbsp;<span class="op" id="2812302">:=</span>&nbsp;<span class="ident" id="2812305">sw</span><span class="op" id="2812307">.</span><span class="ident" id="2812308">WriteString</span><span class="op" id="2812319">(</span><span class="ident" id="2812320">s</span><span class="op" id="2812321">[</span><span class="ident" id="2812322">last</span><span class="op" id="2812326">:</span><span class="ident" id="2812327">i</span><span class="op" id="2812328">]</span><span class="op" id="2812329">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812334">n</span>&nbsp;<span class="op" id="2812336">+=</span>&nbsp;<span class="ident" id="2812339">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812345">if</span>&nbsp;<span class="ident" id="2812348">err</span>&nbsp;<span class="op" id="2812352">!=</span>&nbsp;<span class="ident" id="2812355">nil</span>&nbsp;<span class="op" id="2812359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812365">return</span>&nbsp;<span class="ident" id="2812372">n</span><span class="op" id="2812373">,</span>&nbsp;<span class="ident" id="2812375">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812386">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812390">last</span>&nbsp;<span class="op" id="2812395">=</span>&nbsp;<span class="ident" id="2812397">i</span>&nbsp;<span class="op" id="2812399">+</span>&nbsp;<span class="num" id="2812401">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812405">nw</span><span class="op" id="2812407">,</span>&nbsp;<span class="ident" id="2812409">err</span>&nbsp;<span class="op" id="2812413">:=</span>&nbsp;<span class="ident" id="2812416">w</span><span class="op" id="2812417">.</span><span class="ident" id="2812418">Write</span><span class="op" id="2812423">(</span><span class="ident" id="2812424">r</span><span class="op" id="2812425">[</span><span class="ident" id="2812426">b</span><span class="op" id="2812427">]</span><span class="op" id="2812428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812432">n</span>&nbsp;<span class="op" id="2812434">+=</span>&nbsp;<span class="ident" id="2812437">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812442">if</span>&nbsp;<span class="ident" id="2812445">err</span>&nbsp;<span class="op" id="2812449">!=</span>&nbsp;<span class="ident" id="2812452">nil</span>&nbsp;<span class="op" id="2812456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812461">return</span>&nbsp;<span class="ident" id="2812468">n</span><span class="op" id="2812469">,</span>&nbsp;<span class="ident" id="2812471">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812483">if</span>&nbsp;<span class="ident" id="2812486">last</span>&nbsp;<span class="op" id="2812491">!=</span>&nbsp;<span class="builtinfunc" id="2812494">len</span><span class="op" id="2812497">(</span><span class="ident" id="2812498">s</span><span class="op" id="2812499">)</span>&nbsp;<span class="op" id="2812501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812505">var</span>&nbsp;<span class="ident" id="2812509">nw</span>&nbsp;<span class="builtintype" id="2812512">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812518">nw</span><span class="op" id="2812520">,</span>&nbsp;<span class="ident" id="2812522">err</span>&nbsp;<span class="op" id="2812526">=</span>&nbsp;<span class="ident" id="2812528">sw</span><span class="op" id="2812530">.</span><span class="ident" id="2812531">WriteString</span><span class="op" id="2812542">(</span><span class="ident" id="2812543">s</span><span class="op" id="2812544">[</span><span class="ident" id="2812545">last</span><span class="op" id="2812549">:</span><span class="op" id="2812550">]</span><span class="op" id="2812551">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2812555">n</span>&nbsp;<span class="op" id="2812557">+=</span>&nbsp;<span class="ident" id="2812560">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2812564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2812567">return</span><br>
<span class="lineno"></span><span class="op" id="2812574">}</span>
</div>
</body>
</html>
