<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1792221">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1792276">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1792330">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1792381">package</span>&nbsp;<span class="ident" id="1792389">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1792395">import</span>&nbsp;<span class="op" id="1792402">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1792405">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1792420">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1792429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1792432">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1792495">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1792548">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1792604">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1792661">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1792726">type</span>&nbsp;<span class="ident" id="1792731">WaitGroup</span>&nbsp;<span class="keyword" id="1792741">struct</span>&nbsp;<span class="op" id="1792748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792751">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1792759">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792766">counter</span>&nbsp;<span class="builtintype" id="1792774">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792781">waiters</span>&nbsp;<span class="builtintype" id="1792789">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792796">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1792804">*</span><span class="builtintype" id="1792805">uint32</span><br>
<span class="lineno"></span><span class="op" id="1792812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1792815">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1792880">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1792933">//</span><br>
<span class="lineno"></span><span class="comment" id="1792936">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1792950">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1792965">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1793037">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1793118">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1793184">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1793235">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1793250">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1793325">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1793393">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1793470">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1793515">//</span><br>
<span class="lineno">40</span><span class="comment" id="1793518">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1793595">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1793670">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1793749">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1793765">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1793842">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1793901">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1793931">func</span>&nbsp;<span class="op" id="1793936">(</span><span class="ident" id="1793937">wg</span>&nbsp;<span class="op" id="1793940">*</span><span class="ident" id="1793941">WaitGroup</span><span class="op" id="1793950">)</span>&nbsp;<span class="ident" id="1793952">Add</span><span class="op" id="1793955">(</span><span class="ident" id="1793956">delta</span>&nbsp;<span class="builtintype" id="1793962">int</span><span class="op" id="1793965">)</span>&nbsp;<span class="op" id="1793967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793970">if</span>&nbsp;<span class="ident" id="1793973">raceenabled</span>&nbsp;<span class="op" id="1793985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793989">_</span>&nbsp;<span class="op" id="1793991">=</span>&nbsp;<span class="ident" id="1793993">wg</span><span class="op" id="1793995">.</span><span class="ident" id="1793996">m</span><span class="op" id="1793997">.</span><span class="ident" id="1793998">state</span>&nbsp;<span class="comment" id="1794004">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794033">if</span>&nbsp;<span class="ident" id="1794036">delta</span>&nbsp;<span class="op" id="1794042">&lt;</span>&nbsp;<span class="num" id="1794044">0</span>&nbsp;<span class="op" id="1794046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1794051">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794091">raceReleaseMerge</span><span class="op" id="1794107">(</span><span class="ident" id="1794108">unsafe</span><span class="op" id="1794114">.</span><span class="ident" id="1794115">Pointer</span><span class="op" id="1794122">(</span><span class="ident" id="1794123">wg</span><span class="op" id="1794125">)</span><span class="op" id="1794126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794134">raceDisable</span><span class="op" id="1794145">(</span><span class="op" id="1794146">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794150">defer</span>&nbsp;<span class="ident" id="1794156">raceEnable</span><span class="op" id="1794166">(</span><span class="op" id="1794167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794173">v</span>&nbsp;<span class="op" id="1794175">:=</span>&nbsp;<span class="ident" id="1794178">atomic</span><span class="op" id="1794184">.</span><span class="ident" id="1794185">AddInt32</span><span class="op" id="1794193">(</span><span class="op" id="1794194">&amp;</span><span class="ident" id="1794195">wg</span><span class="op" id="1794197">.</span><span class="ident" id="1794198">counter</span><span class="op" id="1794205">,</span>&nbsp;<span class="builtintype" id="1794207">int32</span><span class="op" id="1794212">(</span><span class="ident" id="1794213">delta</span><span class="op" id="1794218">)</span><span class="op" id="1794219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794222">if</span>&nbsp;<span class="ident" id="1794225">raceenabled</span>&nbsp;<span class="op" id="1794237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794241">if</span>&nbsp;<span class="ident" id="1794244">delta</span>&nbsp;<span class="op" id="1794250">&gt;</span>&nbsp;<span class="num" id="1794252">0</span>&nbsp;<span class="op" id="1794254">&amp;&amp;</span>&nbsp;<span class="ident" id="1794257">v</span>&nbsp;<span class="op" id="1794259">==</span>&nbsp;<span class="builtintype" id="1794262">int32</span><span class="op" id="1794267">(</span><span class="ident" id="1794268">delta</span><span class="op" id="1794273">)</span>&nbsp;<span class="op" id="1794275">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1794280">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1794338">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1794395">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794451">raceRead</span><span class="op" id="1794459">(</span><span class="ident" id="1794460">unsafe</span><span class="op" id="1794466">.</span><span class="ident" id="1794467">Pointer</span><span class="op" id="1794474">(</span><span class="op" id="1794475">&amp;</span><span class="ident" id="1794476">wg</span><span class="op" id="1794478">.</span><span class="ident" id="1794479">sema</span><span class="op" id="1794483">)</span><span class="op" id="1794484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794488">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794494">if</span>&nbsp;<span class="ident" id="1794497">v</span>&nbsp;<span class="op" id="1794499">&lt;</span>&nbsp;<span class="num" id="1794501">0</span>&nbsp;<span class="op" id="1794503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1794507">panic</span><span class="op" id="1794512">(</span><span class="string" id="1794513">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1794547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794553">if</span>&nbsp;<span class="ident" id="1794556">v</span>&nbsp;<span class="op" id="1794558">&gt;</span>&nbsp;<span class="num" id="1794560">0</span>&nbsp;<span class="op" id="1794562">||</span>&nbsp;<span class="ident" id="1794565">atomic</span><span class="op" id="1794571">.</span><span class="ident" id="1794572">LoadInt32</span><span class="op" id="1794581">(</span><span class="op" id="1794582">&amp;</span><span class="ident" id="1794583">wg</span><span class="op" id="1794585">.</span><span class="ident" id="1794586">waiters</span><span class="op" id="1794593">)</span>&nbsp;<span class="op" id="1794595">==</span>&nbsp;<span class="num" id="1794598">0</span>&nbsp;<span class="op" id="1794600">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794604">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794615">wg</span><span class="op" id="1794617">.</span><span class="ident" id="1794618">m</span><span class="op" id="1794619">.</span><span class="ident" id="1794620">Lock</span><span class="op" id="1794624">(</span><span class="op" id="1794625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794628">if</span>&nbsp;<span class="ident" id="1794631">atomic</span><span class="op" id="1794637">.</span><span class="ident" id="1794638">LoadInt32</span><span class="op" id="1794647">(</span><span class="op" id="1794648">&amp;</span><span class="ident" id="1794649">wg</span><span class="op" id="1794651">.</span><span class="ident" id="1794652">counter</span><span class="op" id="1794659">)</span>&nbsp;<span class="op" id="1794661">==</span>&nbsp;<span class="num" id="1794664">0</span>&nbsp;<span class="op" id="1794666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794670">for</span>&nbsp;<span class="ident" id="1794674">i</span>&nbsp;<span class="op" id="1794676">:=</span>&nbsp;<span class="builtintype" id="1794679">int32</span><span class="op" id="1794684">(</span><span class="num" id="1794685">0</span><span class="op" id="1794686">)</span><span class="op" id="1794687">;</span>&nbsp;<span class="ident" id="1794689">i</span>&nbsp;<span class="op" id="1794691">&lt;</span>&nbsp;<span class="ident" id="1794693">wg</span><span class="op" id="1794695">.</span><span class="ident" id="1794696">waiters</span><span class="op" id="1794703">;</span>&nbsp;<span class="ident" id="1794705">i</span><span class="op" id="1794706">++</span>&nbsp;<span class="op" id="1794709">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794714">runtime_Semrelease</span><span class="op" id="1794732">(</span><span class="ident" id="1794733">wg</span><span class="op" id="1794735">.</span><span class="ident" id="1794736">sema</span><span class="op" id="1794740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794748">wg</span><span class="op" id="1794750">.</span><span class="ident" id="1794751">waiters</span>&nbsp;<span class="op" id="1794759">=</span>&nbsp;<span class="num" id="1794761">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794765">wg</span><span class="op" id="1794767">.</span><span class="ident" id="1794768">sema</span>&nbsp;<span class="op" id="1794773">=</span>&nbsp;<span class="ident" id="1794775">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794780">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794783">wg</span><span class="op" id="1794785">.</span><span class="ident" id="1794786">m</span><span class="op" id="1794787">.</span><span class="ident" id="1794788">Unlock</span><span class="op" id="1794794">(</span><span class="op" id="1794795">)</span><br>
<span class="lineno"></span><span class="op" id="1794797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1794800">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1794842">func</span>&nbsp;<span class="op" id="1794847">(</span><span class="ident" id="1794848">wg</span>&nbsp;<span class="op" id="1794851">*</span><span class="ident" id="1794852">WaitGroup</span><span class="op" id="1794861">)</span>&nbsp;<span class="ident" id="1794863">Done</span><span class="op" id="1794867">(</span><span class="op" id="1794868">)</span>&nbsp;<span class="op" id="1794870">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794873">wg</span><span class="op" id="1794875">.</span><span class="ident" id="1794876">Add</span><span class="op" id="1794879">(</span><span class="op" id="1794880">-</span><span class="num" id="1794881">1</span><span class="op" id="1794882">)</span><br>
<span class="lineno"></span><span class="op" id="1794884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1794887">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1794939">func</span>&nbsp;<span class="op" id="1794944">(</span><span class="ident" id="1794945">wg</span>&nbsp;<span class="op" id="1794948">*</span><span class="ident" id="1794949">WaitGroup</span><span class="op" id="1794958">)</span>&nbsp;<span class="ident" id="1794960">Wait</span><span class="op" id="1794964">(</span><span class="op" id="1794965">)</span>&nbsp;<span class="op" id="1794967">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794970">if</span>&nbsp;<span class="ident" id="1794973">raceenabled</span>&nbsp;<span class="op" id="1794985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794989">_</span>&nbsp;<span class="op" id="1794991">=</span>&nbsp;<span class="ident" id="1794993">wg</span><span class="op" id="1794995">.</span><span class="ident" id="1794996">m</span><span class="op" id="1794997">.</span><span class="ident" id="1794998">state</span>&nbsp;<span class="comment" id="1795004">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795033">raceDisable</span><span class="op" id="1795044">(</span><span class="op" id="1795045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795051">if</span>&nbsp;<span class="ident" id="1795054">atomic</span><span class="op" id="1795060">.</span><span class="ident" id="1795061">LoadInt32</span><span class="op" id="1795070">(</span><span class="op" id="1795071">&amp;</span><span class="ident" id="1795072">wg</span><span class="op" id="1795074">.</span><span class="ident" id="1795075">counter</span><span class="op" id="1795082">)</span>&nbsp;<span class="op" id="1795084">==</span>&nbsp;<span class="num" id="1795087">0</span>&nbsp;<span class="op" id="1795089">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795093">if</span>&nbsp;<span class="ident" id="1795096">raceenabled</span>&nbsp;<span class="op" id="1795108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795113">raceEnable</span><span class="op" id="1795123">(</span><span class="op" id="1795124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795129">raceAcquire</span><span class="op" id="1795140">(</span><span class="ident" id="1795141">unsafe</span><span class="op" id="1795147">.</span><span class="ident" id="1795148">Pointer</span><span class="op" id="1795155">(</span><span class="ident" id="1795156">wg</span><span class="op" id="1795158">)</span><span class="op" id="1795159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795167">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795178">wg</span><span class="op" id="1795180">.</span><span class="ident" id="1795181">m</span><span class="op" id="1795182">.</span><span class="ident" id="1795183">Lock</span><span class="op" id="1795187">(</span><span class="op" id="1795188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795191">w</span>&nbsp;<span class="op" id="1795193">:=</span>&nbsp;<span class="ident" id="1795196">atomic</span><span class="op" id="1795202">.</span><span class="ident" id="1795203">AddInt32</span><span class="op" id="1795211">(</span><span class="op" id="1795212">&amp;</span><span class="ident" id="1795213">wg</span><span class="op" id="1795215">.</span><span class="ident" id="1795216">waiters</span><span class="op" id="1795223">,</span>&nbsp;<span class="num" id="1795225">1</span><span class="op" id="1795226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795229">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795290">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795350">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795420">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795449">if</span>&nbsp;<span class="ident" id="1795452">atomic</span><span class="op" id="1795458">.</span><span class="ident" id="1795459">LoadInt32</span><span class="op" id="1795468">(</span><span class="op" id="1795469">&amp;</span><span class="ident" id="1795470">wg</span><span class="op" id="1795472">.</span><span class="ident" id="1795473">counter</span><span class="op" id="1795480">)</span>&nbsp;<span class="op" id="1795482">==</span>&nbsp;<span class="num" id="1795485">0</span>&nbsp;<span class="op" id="1795487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795491">atomic</span><span class="op" id="1795497">.</span><span class="ident" id="1795498">AddInt32</span><span class="op" id="1795506">(</span><span class="op" id="1795507">&amp;</span><span class="ident" id="1795508">wg</span><span class="op" id="1795510">.</span><span class="ident" id="1795511">waiters</span><span class="op" id="1795518">,</span>&nbsp;<span class="op" id="1795520">-</span><span class="num" id="1795521">1</span><span class="op" id="1795522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795526">if</span>&nbsp;<span class="ident" id="1795529">raceenabled</span>&nbsp;<span class="op" id="1795541">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795546">raceEnable</span><span class="op" id="1795556">(</span><span class="op" id="1795557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795562">raceAcquire</span><span class="op" id="1795573">(</span><span class="ident" id="1795574">unsafe</span><span class="op" id="1795580">.</span><span class="ident" id="1795581">Pointer</span><span class="op" id="1795588">(</span><span class="ident" id="1795589">wg</span><span class="op" id="1795591">)</span><span class="op" id="1795592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795597">raceDisable</span><span class="op" id="1795608">(</span><span class="op" id="1795609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795617">wg</span><span class="op" id="1795619">.</span><span class="ident" id="1795620">m</span><span class="op" id="1795621">.</span><span class="ident" id="1795622">Unlock</span><span class="op" id="1795628">(</span><span class="op" id="1795629">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795633">if</span>&nbsp;<span class="ident" id="1795636">raceenabled</span>&nbsp;<span class="op" id="1795648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795653">raceEnable</span><span class="op" id="1795663">(</span><span class="op" id="1795664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795672">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795680">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795683">if</span>&nbsp;<span class="ident" id="1795686">raceenabled</span>&nbsp;<span class="op" id="1795698">&amp;&amp;</span>&nbsp;<span class="ident" id="1795701">w</span>&nbsp;<span class="op" id="1795703">==</span>&nbsp;<span class="num" id="1795706">1</span>&nbsp;<span class="op" id="1795708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795712">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795763">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795831">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795898">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795957">raceWrite</span><span class="op" id="1795966">(</span><span class="ident" id="1795967">unsafe</span><span class="op" id="1795973">.</span><span class="ident" id="1795974">Pointer</span><span class="op" id="1795981">(</span><span class="op" id="1795982">&amp;</span><span class="ident" id="1795983">wg</span><span class="op" id="1795985">.</span><span class="ident" id="1795986">sema</span><span class="op" id="1795990">)</span><span class="op" id="1795991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1795994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795997">if</span>&nbsp;<span class="ident" id="1796000">wg</span><span class="op" id="1796002">.</span><span class="ident" id="1796003">sema</span>&nbsp;<span class="op" id="1796008">==</span>&nbsp;<span class="ident" id="1796011">nil</span>&nbsp;<span class="op" id="1796015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796019">wg</span><span class="op" id="1796021">.</span><span class="ident" id="1796022">sema</span>&nbsp;<span class="op" id="1796027">=</span>&nbsp;<span class="builtinfunc" id="1796029">new</span><span class="op" id="1796032">(</span><span class="builtintype" id="1796033">uint32</span><span class="op" id="1796039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796042">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796045">s</span>&nbsp;<span class="op" id="1796047">:=</span>&nbsp;<span class="ident" id="1796050">wg</span><span class="op" id="1796052">.</span><span class="ident" id="1796053">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796059">wg</span><span class="op" id="1796061">.</span><span class="ident" id="1796062">m</span><span class="op" id="1796063">.</span><span class="ident" id="1796064">Unlock</span><span class="op" id="1796070">(</span><span class="op" id="1796071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796074">runtime_Semacquire</span><span class="op" id="1796092">(</span><span class="ident" id="1796093">s</span><span class="op" id="1796094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796097">if</span>&nbsp;<span class="ident" id="1796100">raceenabled</span>&nbsp;<span class="op" id="1796112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796116">raceEnable</span><span class="op" id="1796126">(</span><span class="op" id="1796127">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796131">raceAcquire</span><span class="op" id="1796142">(</span><span class="ident" id="1796143">unsafe</span><span class="op" id="1796149">.</span><span class="ident" id="1796150">Pointer</span><span class="op" id="1796157">(</span><span class="ident" id="1796158">wg</span><span class="op" id="1796160">)</span><span class="op" id="1796161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796164">}</span><br>
<span class="lineno"></span><span class="op" id="1796166">}</span>
</div>
</body>
</html>
