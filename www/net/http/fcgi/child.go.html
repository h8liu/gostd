<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6099749">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6099804">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6099858">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6099909">package</span>&nbsp;<span class="ident" id="6099917">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6099923">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6099997">import</span>&nbsp;<span class="op" id="6100004">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100007">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100017">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100024">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100030">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100043">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100050">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100062">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100078">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100084">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100095">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6100103">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6100110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6100113">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6100194">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6100232">type</span>&nbsp;<span class="ident" id="6100237">request</span>&nbsp;<span class="keyword" id="6100245">struct</span>&nbsp;<span class="op" id="6100252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100255">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100265">*</span><span class="ident" id="6100266"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6100268">.</span><span class="ident" id="6100269">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100281">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6100291">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100299">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100309">map</span><span class="op" id="6100312">[</span><span class="builtintype" id="6100313">string</span><span class="op" id="6100319">]</span><span class="builtintype" id="6100320">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100328">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100338">[</span><span class="num" id="6100339">1024</span><span class="op" id="6100343">]</span><span class="builtintype" id="6100344">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100350">rawParams</span>&nbsp;<span class="op" id="6100360">[</span><span class="op" id="6100361">]</span><span class="builtintype" id="6100362">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100368">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6100378">bool</span><br>
<span class="lineno"></span><span class="op" id="6100383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6100386">func</span>&nbsp;<span class="ident" id="6100391">newRequest</span><span class="op" id="6100401">(</span><span class="ident" id="6100402">reqId</span>&nbsp;<span class="builtintype" id="6100408">uint16</span><span class="op" id="6100414">,</span>&nbsp;<span class="ident" id="6100416">flags</span>&nbsp;<span class="builtintype" id="6100422">uint8</span><span class="op" id="6100427">)</span>&nbsp;<span class="op" id="6100429">*</span><span class="ident" id="6100430"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span>&nbsp;<span class="op" id="6100438">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100441">r</span>&nbsp;<span class="op" id="6100443">:=</span>&nbsp;<span class="op" id="6100446">&amp;</span><span class="ident" id="6100447"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><span class="op" id="6100454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100458">reqId</span><span class="op" id="6100463">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6100468"><a href="/net/http/fcgi/child.go.html#6100402">reqId</a></span><span class="op" id="6100473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100477">params</span><span class="op" id="6100483">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100487">map</span><span class="op" id="6100490">[</span><span class="builtintype" id="6100491">string</span><span class="op" id="6100497">]</span><span class="builtintype" id="6100498">string</span><span class="op" id="6100504">{</span><span class="op" id="6100505">}</span><span class="op" id="6100506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100510">keepConn</span><span class="op" id="6100518">:</span>&nbsp;<span class="ident" id="6100520"><a href="/net/http/fcgi/child.go.html#6100416">flags</a></span><span class="op" id="6100525">&amp;</span><span class="ident" id="6100526"><a href="/net/http/fcgi/fcgi.go.html#6108022">flagKeepConn</a></span>&nbsp;<span class="op" id="6100539">!=</span>&nbsp;<span class="num" id="6100542">0</span><span class="op" id="6100543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6100546">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100549"><a href="/net/http/fcgi/child.go.html#6100441">r</a></span><span class="op" id="6100550">.</span><span class="ident" id="6100551">rawParams</span>&nbsp;<span class="op" id="6100561">=</span>&nbsp;<span class="ident" id="6100563"><a href="/net/http/fcgi/child.go.html#6100441">r</a></span><span class="op" id="6100564">.</span><span class="ident" id="6100565">buf</span><span class="op" id="6100568">[</span><span class="op" id="6100569">:</span><span class="num" id="6100570">0</span><span class="op" id="6100571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100574">return</span>&nbsp;<span class="ident" id="6100581"><a href="/net/http/fcgi/child.go.html#6100441">r</a></span><br>
<span class="lineno"></span><span class="op" id="6100583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6100586">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6100638">func</span>&nbsp;<span class="op" id="6100643">(</span><span class="ident" id="6100644">r</span>&nbsp;<span class="op" id="6100646">*</span><span class="ident" id="6100647"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><span class="op" id="6100654">)</span>&nbsp;<span class="ident" id="6100656">parseParams</span><span class="op" id="6100667">(</span><span class="op" id="6100668">)</span>&nbsp;<span class="op" id="6100670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100673">text</span>&nbsp;<span class="op" id="6100678">:=</span>&nbsp;<span class="ident" id="6100681"><a href="/net/http/fcgi/child.go.html#6100644">r</a></span><span class="op" id="6100682">.</span><span class="ident" id="6100683">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100694"><a href="/net/http/fcgi/child.go.html#6100644">r</a></span><span class="op" id="6100695">.</span><span class="ident" id="6100696">rawParams</span>&nbsp;<span class="op" id="6100706">=</span>&nbsp;<span class="ident" id="6100708">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100713">for</span>&nbsp;<span class="builtinfunc" id="6100717">len</span><span class="op" id="6100720">(</span><span class="ident" id="6100721"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100725">)</span>&nbsp;<span class="op" id="6100727">&gt;</span>&nbsp;<span class="num" id="6100729">0</span>&nbsp;<span class="op" id="6100731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100735">keyLen</span><span class="op" id="6100741">,</span>&nbsp;<span class="ident" id="6100743">n</span>&nbsp;<span class="op" id="6100745">:=</span>&nbsp;<span class="ident" id="6100748"><a href="/net/http/fcgi/fcgi.go.html#6111344">readSize</a></span><span class="op" id="6100756">(</span><span class="ident" id="6100757"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100761">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100765">if</span>&nbsp;<span class="ident" id="6100768"><a href="/net/http/fcgi/child.go.html#6100743">n</a></span>&nbsp;<span class="op" id="6100770">==</span>&nbsp;<span class="num" id="6100773">0</span>&nbsp;<span class="op" id="6100775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100780">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6100789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100793"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span>&nbsp;<span class="op" id="6100798">=</span>&nbsp;<span class="ident" id="6100800"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100804">[</span><span class="ident" id="6100805"><a href="/net/http/fcgi/child.go.html#6100743">n</a></span><span class="op" id="6100806">:</span><span class="op" id="6100807">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100811">valLen</span><span class="op" id="6100817">,</span>&nbsp;<span class="ident" id="6100819"><a href="/net/http/fcgi/child.go.html#6100743">n</a></span>&nbsp;<span class="op" id="6100821">:=</span>&nbsp;<span class="ident" id="6100824"><a href="/net/http/fcgi/fcgi.go.html#6111344">readSize</a></span><span class="op" id="6100832">(</span><span class="ident" id="6100833"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100837">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100841">if</span>&nbsp;<span class="ident" id="6100844"><a href="/net/http/fcgi/child.go.html#6100743">n</a></span>&nbsp;<span class="op" id="6100846">==</span>&nbsp;<span class="num" id="6100849">0</span>&nbsp;<span class="op" id="6100851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6100856">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6100865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100869"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span>&nbsp;<span class="op" id="6100874">=</span>&nbsp;<span class="ident" id="6100876"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100880">[</span><span class="ident" id="6100881"><a href="/net/http/fcgi/child.go.html#6100743">n</a></span><span class="op" id="6100882">:</span><span class="op" id="6100883">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100887">key</span>&nbsp;<span class="op" id="6100891">:=</span>&nbsp;<span class="ident" id="6100894"><a href="/net/http/fcgi/fcgi.go.html#6111592">readString</a></span><span class="op" id="6100904">(</span><span class="ident" id="6100905"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100909">,</span>&nbsp;<span class="ident" id="6100911"><a href="/net/http/fcgi/child.go.html#6100735">keyLen</a></span><span class="op" id="6100917">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100921"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span>&nbsp;<span class="op" id="6100926">=</span>&nbsp;<span class="ident" id="6100928"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100932">[</span><span class="ident" id="6100933"><a href="/net/http/fcgi/child.go.html#6100735">keyLen</a></span><span class="op" id="6100939">:</span><span class="op" id="6100940">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100944">val</span>&nbsp;<span class="op" id="6100948">:=</span>&nbsp;<span class="ident" id="6100951"><a href="/net/http/fcgi/fcgi.go.html#6111592">readString</a></span><span class="op" id="6100961">(</span><span class="ident" id="6100962"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100966">,</span>&nbsp;<span class="ident" id="6100968"><a href="/net/http/fcgi/child.go.html#6100811">valLen</a></span><span class="op" id="6100974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6100978"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span>&nbsp;<span class="op" id="6100983">=</span>&nbsp;<span class="ident" id="6100985"><a href="/net/http/fcgi/child.go.html#6100673">text</a></span><span class="op" id="6100989">[</span><span class="ident" id="6100990"><a href="/net/http/fcgi/child.go.html#6100811">valLen</a></span><span class="op" id="6100996">:</span><span class="op" id="6100997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101001"><a href="/net/http/fcgi/child.go.html#6100644">r</a></span><span class="op" id="6101002">.</span><span class="ident" id="6101003">params</span><span class="op" id="6101009">[</span><span class="ident" id="6101010"><a href="/net/http/fcgi/child.go.html#6100887">key</a></span><span class="op" id="6101013">]</span>&nbsp;<span class="op" id="6101015">=</span>&nbsp;<span class="ident" id="6101017"><a href="/net/http/fcgi/child.go.html#6100944">val</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101022">}</span><br>
<span class="lineno">65</span><span class="op" id="6101024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6101027">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6101071">type</span>&nbsp;<span class="ident" id="6101076">response</span>&nbsp;<span class="keyword" id="6101085">struct</span>&nbsp;<span class="op" id="6101092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101095">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101107">*</span><span class="ident" id="6101108"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101117">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101129"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6101133">.</span><span class="ident" id="6101134">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101142">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101154">*</span><span class="ident" id="6101155"><a href="/net/http/fcgi/fcgi.go.html#6111968">bufWriter</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101166">wroteHeader</span>&nbsp;<span class="builtintype" id="6101178">bool</span><br>
<span class="lineno"></span><span class="op" id="6101183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6101186">func</span>&nbsp;<span class="ident" id="6101191">newResponse</span><span class="op" id="6101202">(</span><span class="ident" id="6101203">c</span>&nbsp;<span class="op" id="6101205">*</span><span class="ident" id="6101206"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span><span class="op" id="6101211">,</span>&nbsp;<span class="ident" id="6101213">req</span>&nbsp;<span class="op" id="6101217">*</span><span class="ident" id="6101218"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><span class="op" id="6101225">)</span>&nbsp;<span class="op" id="6101227">*</span><span class="ident" id="6101228"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span>&nbsp;<span class="op" id="6101237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101240">return</span>&nbsp;<span class="op" id="6101247">&amp;</span><span class="ident" id="6101248"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6101256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101260">req</span><span class="op" id="6101263">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101268"><a href="/net/http/fcgi/child.go.html#6101213">req</a></span><span class="op" id="6101271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101275">header</span><span class="op" id="6101281">:</span>&nbsp;<span class="ident" id="6101283"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6101287">.</span><span class="ident" id="6101288">Header</span><span class="op" id="6101294">{</span><span class="op" id="6101295">}</span><span class="op" id="6101296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101300">w</span><span class="op" id="6101301">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101308"><a href="/net/http/fcgi/fcgi.go.html#6112169">newWriter</a></span><span class="op" id="6101317">(</span><span class="ident" id="6101318"><a href="/net/http/fcgi/child.go.html#6101203">c</a></span><span class="op" id="6101319">.</span><span class="ident" id="6101320">conn</span><span class="op" id="6101324">,</span>&nbsp;<span class="ident" id="6101326"><a href="/net/http/fcgi/fcgi.go.html#6107739">typeStdout</a></span><span class="op" id="6101336">,</span>&nbsp;<span class="ident" id="6101338"><a href="/net/http/fcgi/child.go.html#6101213">req</a></span><span class="op" id="6101341">.</span><span class="ident" id="6101342">reqId</span><span class="op" id="6101347">)</span><span class="op" id="6101348">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101351">}</span><br>
<span class="lineno"></span><span class="op" id="6101353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6101356">func</span>&nbsp;<span class="op" id="6101361">(</span><span class="ident" id="6101362">r</span>&nbsp;<span class="op" id="6101364">*</span><span class="ident" id="6101365"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6101373">)</span>&nbsp;<span class="ident" id="6101375">Header</span><span class="op" id="6101381">(</span><span class="op" id="6101382">)</span>&nbsp;<span class="ident" id="6101384"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6101388">.</span><span class="ident" id="6101389">Header</span>&nbsp;<span class="op" id="6101396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101399">return</span>&nbsp;<span class="ident" id="6101406"><a href="/net/http/fcgi/child.go.html#6101362">r</a></span><span class="op" id="6101407">.</span><span class="ident" id="6101408">header</span><br>
<span class="lineno">85</span><span class="op" id="6101415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6101418">func</span>&nbsp;<span class="op" id="6101423">(</span><span class="ident" id="6101424">r</span>&nbsp;<span class="op" id="6101426">*</span><span class="ident" id="6101427"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6101435">)</span>&nbsp;<span class="ident" id="6101437">Write</span><span class="op" id="6101442">(</span><span class="ident" id="6101443">data</span>&nbsp;<span class="op" id="6101448">[</span><span class="op" id="6101449">]</span><span class="builtintype" id="6101450">byte</span><span class="op" id="6101454">)</span>&nbsp;<span class="op" id="6101456">(</span><span class="builtintype" id="6101457">int</span><span class="op" id="6101460">,</span>&nbsp;<span class="builtintype" id="6101462">error</span><span class="op" id="6101467">)</span>&nbsp;<span class="op" id="6101469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101472">if</span>&nbsp;<span class="op" id="6101475">!</span><span class="ident" id="6101476"><a href="/net/http/fcgi/child.go.html#6101424">r</a></span><span class="op" id="6101477">.</span><span class="ident" id="6101478">wroteHeader</span>&nbsp;<span class="op" id="6101490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101494"><a href="/net/http/fcgi/child.go.html#6101424">r</a></span><span class="op" id="6101495">.</span><span class="ident" id="6101496">WriteHeader</span><span class="op" id="6101507">(</span><span class="ident" id="6101508"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6101512">.</span><span class="ident" id="6101513">StatusOK</span><span class="op" id="6101521">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101527">return</span>&nbsp;<span class="ident" id="6101534"><a href="/net/http/fcgi/child.go.html#6101424">r</a></span><span class="op" id="6101535">.</span><span class="ident" id="6101536">w</span><span class="op" id="6101537">.</span><span class="ident" id="6101538">Write</span><span class="op" id="6101543">(</span><span class="ident" id="6101544"><a href="/net/http/fcgi/child.go.html#6101443">data</a></span><span class="op" id="6101548">)</span><br>
<span class="lineno"></span><span class="op" id="6101550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6101553">func</span>&nbsp;<span class="op" id="6101558">(</span><span class="ident" id="6101559">r</span>&nbsp;<span class="op" id="6101561">*</span><span class="ident" id="6101562"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6101570">)</span>&nbsp;<span class="ident" id="6101572">WriteHeader</span><span class="op" id="6101583">(</span><span class="ident" id="6101584">code</span>&nbsp;<span class="builtintype" id="6101589">int</span><span class="op" id="6101592">)</span>&nbsp;<span class="op" id="6101594">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101597">if</span>&nbsp;<span class="ident" id="6101600"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101601">.</span><span class="ident" id="6101602">wroteHeader</span>&nbsp;<span class="op" id="6101614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101629"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101630">.</span><span class="ident" id="6101631">wroteHeader</span>&nbsp;<span class="op" id="6101643">=</span>&nbsp;<span class="ident" id="6101645">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101651">if</span>&nbsp;<span class="ident" id="6101654"><a href="/net/http/fcgi/child.go.html#6101584">code</a></span>&nbsp;<span class="op" id="6101659">==</span>&nbsp;<span class="ident" id="6101662"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6101666">.</span><span class="ident" id="6101667">StatusNotModified</span>&nbsp;<span class="op" id="6101685">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6101689">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101714"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101715">.</span><span class="ident" id="6101716">header</span><span class="op" id="6101722">.</span><span class="ident" id="6101723">Del</span><span class="op" id="6101726">(</span><span class="string" id="6101727">&#34;Content-Type&#34;</span><span class="op" id="6101741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101745"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101746">.</span><span class="ident" id="6101747">header</span><span class="op" id="6101753">.</span><span class="ident" id="6101754">Del</span><span class="op" id="6101757">(</span><span class="string" id="6101758">&#34;Content-Length&#34;</span><span class="op" id="6101774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101778"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101779">.</span><span class="ident" id="6101780">header</span><span class="op" id="6101786">.</span><span class="ident" id="6101787">Del</span><span class="op" id="6101790">(</span><span class="string" id="6101791">&#34;Transfer-Encoding&#34;</span><span class="op" id="6101810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101813">}</span>&nbsp;<span class="keyword" id="6101815">else</span>&nbsp;<span class="keyword" id="6101820">if</span>&nbsp;<span class="ident" id="6101823"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101824">.</span><span class="ident" id="6101825">header</span><span class="op" id="6101831">.</span><span class="ident" id="6101832">Get</span><span class="op" id="6101835">(</span><span class="string" id="6101836">&#34;Content-Type&#34;</span><span class="op" id="6101850">)</span>&nbsp;<span class="op" id="6101852">==</span>&nbsp;<span class="string" id="6101855">&#34;&#34;</span>&nbsp;<span class="op" id="6101858">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101862"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101863">.</span><span class="ident" id="6101864">header</span><span class="op" id="6101870">.</span><span class="ident" id="6101871">Set</span><span class="op" id="6101874">(</span><span class="string" id="6101875">&#34;Content-Type&#34;</span><span class="op" id="6101889">,</span>&nbsp;<span class="string" id="6101891">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6101917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6101920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6101924">if</span>&nbsp;<span class="ident" id="6101927"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101928">.</span><span class="ident" id="6101929">header</span><span class="op" id="6101935">.</span><span class="ident" id="6101936">Get</span><span class="op" id="6101939">(</span><span class="string" id="6101940">&#34;Date&#34;</span><span class="op" id="6101946">)</span>&nbsp;<span class="op" id="6101948">==</span>&nbsp;<span class="string" id="6101951">&#34;&#34;</span>&nbsp;<span class="op" id="6101954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6101958"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6101959">.</span><span class="ident" id="6101960">header</span><span class="op" id="6101966">.</span><span class="ident" id="6101967">Set</span><span class="op" id="6101970">(</span><span class="string" id="6101971">&#34;Date&#34;</span><span class="op" id="6101977">,</span>&nbsp;<span class="ident" id="6101979"><a href="/net/http/fcgi/child.go.html#6100103">time</a></span><span class="op" id="6101983">.</span><span class="ident" id="6101984">Now</span><span class="op" id="6101987">(</span><span class="op" id="6101988">)</span><span class="op" id="6101989">.</span><span class="ident" id="6101990">UTC</span><span class="op" id="6101993">(</span><span class="op" id="6101994">)</span><span class="op" id="6101995">.</span><span class="ident" id="6101996">Format</span><span class="op" id="6102002">(</span><span class="ident" id="6102003"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6102007">.</span><span class="ident" id="6102008">TimeFormat</span><span class="op" id="6102018">)</span><span class="op" id="6102019">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102026"><a href="/net/http/fcgi/child.go.html#6100017">fmt</a></span><span class="op" id="6102029">.</span><span class="ident" id="6102030">Fprintf</span><span class="op" id="6102037">(</span><span class="ident" id="6102038"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6102039">.</span><span class="ident" id="6102040">w</span><span class="op" id="6102041">,</span>&nbsp;<span class="string" id="6102043">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6102062">,</span>&nbsp;<span class="ident" id="6102064"><a href="/net/http/fcgi/child.go.html#6101584">code</a></span><span class="op" id="6102068">,</span>&nbsp;<span class="ident" id="6102070"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6102074">.</span><span class="ident" id="6102075">StatusText</span><span class="op" id="6102085">(</span><span class="ident" id="6102086"><a href="/net/http/fcgi/child.go.html#6101584">code</a></span><span class="op" id="6102090">)</span><span class="op" id="6102091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102094"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6102095">.</span><span class="ident" id="6102096">header</span><span class="op" id="6102102">.</span><span class="ident" id="6102103">Write</span><span class="op" id="6102108">(</span><span class="ident" id="6102109"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6102110">.</span><span class="ident" id="6102111">w</span><span class="op" id="6102112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102115"><a href="/net/http/fcgi/child.go.html#6101559">r</a></span><span class="op" id="6102116">.</span><span class="ident" id="6102117">w</span><span class="op" id="6102118">.</span><span class="ident" id="6102119">WriteString</span><span class="op" id="6102130">(</span><span class="string" id="6102131">&#34;\r\n&#34;</span><span class="op" id="6102137">)</span><br>
<span class="lineno">115</span><span class="op" id="6102139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102142">func</span>&nbsp;<span class="op" id="6102147">(</span><span class="ident" id="6102148">r</span>&nbsp;<span class="op" id="6102150">*</span><span class="ident" id="6102151"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6102159">)</span>&nbsp;<span class="ident" id="6102161">Flush</span><span class="op" id="6102166">(</span><span class="op" id="6102167">)</span>&nbsp;<span class="op" id="6102169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102172">if</span>&nbsp;<span class="op" id="6102175">!</span><span class="ident" id="6102176"><a href="/net/http/fcgi/child.go.html#6102148">r</a></span><span class="op" id="6102177">.</span><span class="ident" id="6102178">wroteHeader</span>&nbsp;<span class="op" id="6102190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102194"><a href="/net/http/fcgi/child.go.html#6102148">r</a></span><span class="op" id="6102195">.</span><span class="ident" id="6102196">WriteHeader</span><span class="op" id="6102207">(</span><span class="ident" id="6102208"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6102212">.</span><span class="ident" id="6102213">StatusOK</span><span class="op" id="6102221">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102227"><a href="/net/http/fcgi/child.go.html#6102148">r</a></span><span class="op" id="6102228">.</span><span class="ident" id="6102229">w</span><span class="op" id="6102230">.</span><span class="ident" id="6102231">Flush</span><span class="op" id="6102236">(</span><span class="op" id="6102237">)</span><br>
<span class="lineno"></span><span class="op" id="6102239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102242">func</span>&nbsp;<span class="op" id="6102247">(</span><span class="ident" id="6102248">r</span>&nbsp;<span class="op" id="6102250">*</span><span class="ident" id="6102251"><a href="/net/http/fcgi/child.go.html#6101076">response</a></span><span class="op" id="6102259">)</span>&nbsp;<span class="ident" id="6102261">Close</span><span class="op" id="6102266">(</span><span class="op" id="6102267">)</span>&nbsp;<span class="builtintype" id="6102269">error</span>&nbsp;<span class="op" id="6102275">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102278"><a href="/net/http/fcgi/child.go.html#6102248">r</a></span><span class="op" id="6102279">.</span><span class="ident" id="6102280">Flush</span><span class="op" id="6102285">(</span><span class="op" id="6102286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102289">return</span>&nbsp;<span class="ident" id="6102296"><a href="/net/http/fcgi/child.go.html#6102248">r</a></span><span class="op" id="6102297">.</span><span class="ident" id="6102298">w</span><span class="op" id="6102299">.</span><span class="ident" id="6102300">Close</span><span class="op" id="6102305">(</span><span class="op" id="6102306">)</span><br>
<span class="lineno"></span><span class="op" id="6102308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102311">type</span>&nbsp;<span class="ident" id="6102316">child</span>&nbsp;<span class="keyword" id="6102322">struct</span>&nbsp;<span class="op" id="6102329">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102332">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6102340">*</span><span class="ident" id="6102341"><a href="/net/http/fcgi/fcgi.go.html#6109174">conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102347">handler</span>&nbsp;<span class="ident" id="6102355"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6102359">.</span><span class="ident" id="6102360">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102370">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102379"><a href="/net/http/fcgi/child.go.html#6100095">sync</a></span><span class="op" id="6102383">.</span><span class="ident" id="6102384">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102399">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102422">requests</span>&nbsp;<span class="keyword" id="6102431">map</span><span class="op" id="6102434">[</span><span class="builtintype" id="6102435">uint16</span><span class="op" id="6102441">]</span><span class="op" id="6102442">*</span><span class="ident" id="6102443"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span>&nbsp;<span class="comment" id="6102451">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6102474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102477">func</span>&nbsp;<span class="ident" id="6102482">newChild</span><span class="op" id="6102490">(</span><span class="ident" id="6102491">rwc</span>&nbsp;<span class="ident" id="6102495"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6102497">.</span><span class="ident" id="6102498">ReadWriteCloser</span><span class="op" id="6102513">,</span>&nbsp;<span class="ident" id="6102515">handler</span>&nbsp;<span class="ident" id="6102523"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6102527">.</span><span class="ident" id="6102528">Handler</span><span class="op" id="6102535">)</span>&nbsp;<span class="op" id="6102537">*</span><span class="ident" id="6102538"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span>&nbsp;<span class="op" id="6102544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102547">return</span>&nbsp;<span class="op" id="6102554">&amp;</span><span class="ident" id="6102555"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span><span class="op" id="6102560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102564">conn</span><span class="op" id="6102568">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102574"><a href="/net/http/fcgi/fcgi.go.html#6109296">newConn</a></span><span class="op" id="6102581">(</span><span class="ident" id="6102582"><a href="/net/http/fcgi/child.go.html#6102491">rwc</a></span><span class="op" id="6102585">)</span><span class="op" id="6102586">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102590">handler</span><span class="op" id="6102597">:</span>&nbsp;&nbsp;<span class="ident" id="6102600"><a href="/net/http/fcgi/child.go.html#6102515">handler</a></span><span class="op" id="6102607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6102611">requests</span><span class="op" id="6102619">:</span>&nbsp;<span class="builtinfunc" id="6102621">make</span><span class="op" id="6102625">(</span><span class="keyword" id="6102626">map</span><span class="op" id="6102629">[</span><span class="builtintype" id="6102630">uint16</span><span class="op" id="6102636">]</span><span class="op" id="6102637">*</span><span class="ident" id="6102638"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><span class="op" id="6102645">)</span><span class="op" id="6102646">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102649">}</span><br>
<span class="lineno"></span><span class="op" id="6102651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6102654">func</span>&nbsp;<span class="op" id="6102659">(</span><span class="ident" id="6102660">c</span>&nbsp;<span class="op" id="6102662">*</span><span class="ident" id="6102663"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span><span class="op" id="6102668">)</span>&nbsp;<span class="ident" id="6102670">serve</span><span class="op" id="6102675">(</span><span class="op" id="6102676">)</span>&nbsp;<span class="op" id="6102678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102681">defer</span>&nbsp;<span class="ident" id="6102687"><a href="/net/http/fcgi/child.go.html#6102660">c</a></span><span class="op" id="6102688">.</span><span class="ident" id="6102689">conn</span><span class="op" id="6102693">.</span><span class="ident" id="6102694">Close</span><span class="op" id="6102699">(</span><span class="op" id="6102700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102703">var</span>&nbsp;<span class="ident" id="6102707">rec</span>&nbsp;<span class="ident" id="6102711"><a href="/net/http/fcgi/fcgi.go.html#6109464">record</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102719">for</span>&nbsp;<span class="op" id="6102723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102727">if</span>&nbsp;<span class="ident" id="6102730">err</span>&nbsp;<span class="op" id="6102734">:=</span>&nbsp;<span class="ident" id="6102737"><a href="/net/http/fcgi/child.go.html#6102707">rec</a></span><span class="op" id="6102740">.</span><span class="ident" id="6102741">read</span><span class="op" id="6102745">(</span><span class="ident" id="6102746"><a href="/net/http/fcgi/child.go.html#6102660">c</a></span><span class="op" id="6102747">.</span><span class="ident" id="6102748">conn</span><span class="op" id="6102752">.</span><span class="ident" id="6102753">rwc</span><span class="op" id="6102756">)</span><span class="op" id="6102757">;</span>&nbsp;<span class="ident" id="6102759"><a href="/net/http/fcgi/child.go.html#6102730">err</a></span>&nbsp;<span class="op" id="6102763">!=</span>&nbsp;<span class="ident" id="6102766">nil</span>&nbsp;<span class="op" id="6102770">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102775">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102788">if</span>&nbsp;<span class="ident" id="6102791">err</span>&nbsp;<span class="op" id="6102795">:=</span>&nbsp;<span class="ident" id="6102798"><a href="/net/http/fcgi/child.go.html#6102660">c</a></span><span class="op" id="6102799">.</span><span class="ident" id="6102800">handleRecord</span><span class="op" id="6102812">(</span><span class="op" id="6102813">&amp;</span><span class="ident" id="6102814"><a href="/net/http/fcgi/child.go.html#6102707">rec</a></span><span class="op" id="6102817">)</span><span class="op" id="6102818">;</span>&nbsp;<span class="ident" id="6102820"><a href="/net/http/fcgi/child.go.html#6102791">err</a></span>&nbsp;<span class="op" id="6102824">!=</span>&nbsp;<span class="ident" id="6102827">nil</span>&nbsp;<span class="op" id="6102831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6102836">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102845">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6102848">}</span><br>
<span class="lineno"></span><span class="op" id="6102850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102853">var</span>&nbsp;<span class="ident" id="6102857">errCloseConn</span>&nbsp;<span class="op" id="6102870">=</span>&nbsp;<span class="ident" id="6102872"><a href="/net/http/fcgi/child.go.html#6100007">errors</a></span><span class="op" id="6102878">.</span><span class="ident" id="6102879">New</span><span class="op" id="6102882">(</span><span class="string" id="6102883">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6102918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6102921">var</span>&nbsp;<span class="ident" id="6102925">emptyBody</span>&nbsp;<span class="op" id="6102935">=</span>&nbsp;<span class="ident" id="6102937"><a href="/net/http/fcgi/child.go.html#6100030">ioutil</a></span><span class="op" id="6102943">.</span><span class="ident" id="6102944">NopCloser</span><span class="op" id="6102953">(</span><span class="ident" id="6102954"><a href="/net/http/fcgi/child.go.html#6100084">strings</a></span><span class="op" id="6102961">.</span><span class="ident" id="6102962">NewReader</span><span class="op" id="6102971">(</span><span class="string" id="6102972">&#34;&#34;</span><span class="op" id="6102974">)</span><span class="op" id="6102975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6102978">func</span>&nbsp;<span class="op" id="6102983">(</span><span class="ident" id="6102984">c</span>&nbsp;<span class="op" id="6102986">*</span><span class="ident" id="6102987"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span><span class="op" id="6102992">)</span>&nbsp;<span class="ident" id="6102994">handleRecord</span><span class="op" id="6103006">(</span><span class="ident" id="6103007">rec</span>&nbsp;<span class="op" id="6103011">*</span><span class="ident" id="6103012"><a href="/net/http/fcgi/fcgi.go.html#6109464">record</a></span><span class="op" id="6103018">)</span>&nbsp;<span class="builtintype" id="6103020">error</span>&nbsp;<span class="op" id="6103026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103029"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103030">.</span><span class="ident" id="6103031">mu</span><span class="op" id="6103033">.</span><span class="ident" id="6103034">Lock</span><span class="op" id="6103038">(</span><span class="op" id="6103039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103042">req</span><span class="op" id="6103045">,</span>&nbsp;<span class="ident" id="6103047">ok</span>&nbsp;<span class="op" id="6103050">:=</span>&nbsp;<span class="ident" id="6103053"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103054">.</span><span class="ident" id="6103055">requests</span><span class="op" id="6103063">[</span><span class="ident" id="6103064"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103067">.</span><span class="ident" id="6103068">h</span><span class="op" id="6103069">.</span><span class="ident" id="6103070">Id</span><span class="op" id="6103072">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103075"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103076">.</span><span class="ident" id="6103077">mu</span><span class="op" id="6103079">.</span><span class="ident" id="6103080">Unlock</span><span class="op" id="6103086">(</span><span class="op" id="6103087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103090">if</span>&nbsp;<span class="op" id="6103093">!</span><span class="ident" id="6103094"><a href="/net/http/fcgi/child.go.html#6103047">ok</a></span>&nbsp;<span class="op" id="6103097">&amp;&amp;</span>&nbsp;<span class="ident" id="6103100"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103103">.</span><span class="ident" id="6103104">h</span><span class="op" id="6103105">.</span><span class="ident" id="6103106">Type</span>&nbsp;<span class="op" id="6103111">!=</span>&nbsp;<span class="ident" id="6103114"><a href="/net/http/fcgi/fcgi.go.html#6107574">typeBeginRequest</a></span>&nbsp;<span class="op" id="6103131">&amp;&amp;</span>&nbsp;<span class="ident" id="6103134"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103137">.</span><span class="ident" id="6103138">h</span><span class="op" id="6103139">.</span><span class="ident" id="6103140">Type</span>&nbsp;<span class="op" id="6103145">!=</span>&nbsp;<span class="ident" id="6103148"><a href="/net/http/fcgi/fcgi.go.html#6107838">typeGetValues</a></span>&nbsp;<span class="op" id="6103162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6103166">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103216">return</span>&nbsp;<span class="ident" id="6103223">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6103228">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103232">switch</span>&nbsp;<span class="ident" id="6103239"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103242">.</span><span class="ident" id="6103243">h</span><span class="op" id="6103244">.</span><span class="ident" id="6103245">Type</span>&nbsp;<span class="op" id="6103250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103253">case</span>&nbsp;<span class="ident" id="6103258"><a href="/net/http/fcgi/fcgi.go.html#6107574">typeBeginRequest</a></span><span class="op" id="6103274">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103278">if</span>&nbsp;<span class="ident" id="6103281"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span>&nbsp;<span class="op" id="6103285">!=</span>&nbsp;<span class="ident" id="6103288">nil</span>&nbsp;<span class="op" id="6103292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6103297">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6103360">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103411">return</span>&nbsp;<span class="ident" id="6103418"><a href="/net/http/fcgi/child.go.html#6100007">errors</a></span><span class="op" id="6103424">.</span><span class="ident" id="6103425">New</span><span class="op" id="6103428">(</span><span class="string" id="6103429">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6103474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6103478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103483">var</span>&nbsp;<span class="ident" id="6103487">br</span>&nbsp;<span class="ident" id="6103490"><a href="/net/http/fcgi/fcgi.go.html#6108488">beginRequest</a></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103505">if</span>&nbsp;<span class="ident" id="6103508">err</span>&nbsp;<span class="op" id="6103512">:=</span>&nbsp;<span class="ident" id="6103515"><a href="/net/http/fcgi/child.go.html#6103487">br</a></span><span class="op" id="6103517">.</span><span class="ident" id="6103518">read</span><span class="op" id="6103522">(</span><span class="ident" id="6103523"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103526">.</span><span class="ident" id="6103527">content</span><span class="op" id="6103534">(</span><span class="op" id="6103535">)</span><span class="op" id="6103536">)</span><span class="op" id="6103537">;</span>&nbsp;<span class="ident" id="6103539"><a href="/net/http/fcgi/child.go.html#6103508">err</a></span>&nbsp;<span class="op" id="6103543">!=</span>&nbsp;<span class="ident" id="6103546">nil</span>&nbsp;<span class="op" id="6103550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103555">return</span>&nbsp;<span class="ident" id="6103562"><a href="/net/http/fcgi/child.go.html#6103508">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6103568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103572">if</span>&nbsp;<span class="ident" id="6103575"><a href="/net/http/fcgi/child.go.html#6103487">br</a></span><span class="op" id="6103577">.</span><span class="ident" id="6103578">role</span>&nbsp;<span class="op" id="6103583">!=</span>&nbsp;<span class="ident" id="6103586"><a href="/net/http/fcgi/fcgi.go.html#6108117">roleResponder</a></span>&nbsp;<span class="op" id="6103600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103605"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103606">.</span><span class="ident" id="6103607">conn</span><span class="op" id="6103611">.</span><span class="ident" id="6103612">writeEndRequest</span><span class="op" id="6103627">(</span><span class="ident" id="6103628"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103631">.</span><span class="ident" id="6103632">h</span><span class="op" id="6103633">.</span><span class="ident" id="6103634">Id</span><span class="op" id="6103636">,</span>&nbsp;<span class="num" id="6103638">0</span><span class="op" id="6103639">,</span>&nbsp;<span class="ident" id="6103641"><a href="/net/http/fcgi/fcgi.go.html#6108287">statusUnknownRole</a></span><span class="op" id="6103658">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103663">return</span>&nbsp;<span class="ident" id="6103670">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6103676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103680"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span>&nbsp;<span class="op" id="6103684">=</span>&nbsp;<span class="ident" id="6103686"><a href="/net/http/fcgi/child.go.html#6100391">newRequest</a></span><span class="op" id="6103696">(</span><span class="ident" id="6103697"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103700">.</span><span class="ident" id="6103701">h</span><span class="op" id="6103702">.</span><span class="ident" id="6103703">Id</span><span class="op" id="6103705">,</span>&nbsp;<span class="ident" id="6103707"><a href="/net/http/fcgi/child.go.html#6103487">br</a></span><span class="op" id="6103709">.</span><span class="ident" id="6103710">flags</span><span class="op" id="6103715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103719"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103720">.</span><span class="ident" id="6103721">mu</span><span class="op" id="6103723">.</span><span class="ident" id="6103724">Lock</span><span class="op" id="6103728">(</span><span class="op" id="6103729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103733"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103734">.</span><span class="ident" id="6103735">requests</span><span class="op" id="6103743">[</span><span class="ident" id="6103744"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103747">.</span><span class="ident" id="6103748">h</span><span class="op" id="6103749">.</span><span class="ident" id="6103750">Id</span><span class="op" id="6103752">]</span>&nbsp;<span class="op" id="6103754">=</span>&nbsp;<span class="ident" id="6103756"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103762"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6103763">.</span><span class="ident" id="6103764">mu</span><span class="op" id="6103766">.</span><span class="ident" id="6103767">Unlock</span><span class="op" id="6103773">(</span><span class="op" id="6103774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103778">return</span>&nbsp;<span class="ident" id="6103785">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103790">case</span>&nbsp;<span class="ident" id="6103795"><a href="/net/http/fcgi/fcgi.go.html#6107673">typeParams</a></span><span class="op" id="6103805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6103809">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6103880">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6103953">if</span>&nbsp;<span class="builtinfunc" id="6103956">len</span><span class="op" id="6103959">(</span><span class="ident" id="6103960"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6103963">.</span><span class="ident" id="6103964">content</span><span class="op" id="6103971">(</span><span class="op" id="6103972">)</span><span class="op" id="6103973">)</span>&nbsp;<span class="op" id="6103975">&gt;</span>&nbsp;<span class="num" id="6103977">0</span>&nbsp;<span class="op" id="6103979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6103984"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6103987">.</span><span class="ident" id="6103988">rawParams</span>&nbsp;<span class="op" id="6103998">=</span>&nbsp;<span class="builtinfunc" id="6104000">append</span><span class="op" id="6104006">(</span><span class="ident" id="6104007"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104010">.</span><span class="ident" id="6104011">rawParams</span><span class="op" id="6104020">,</span>&nbsp;<span class="ident" id="6104022"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6104025">.</span><span class="ident" id="6104026">content</span><span class="op" id="6104033">(</span><span class="op" id="6104034">)</span><span class="op" id="6104035">...</span><span class="op" id="6104038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104043">return</span>&nbsp;<span class="ident" id="6104050">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104060"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104063">.</span><span class="ident" id="6104064">parseParams</span><span class="op" id="6104075">(</span><span class="op" id="6104076">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104080">return</span>&nbsp;<span class="ident" id="6104087">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104092">case</span>&nbsp;<span class="ident" id="6104097"><a href="/net/http/fcgi/fcgi.go.html#6107706">typeStdin</a></span><span class="op" id="6104106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104110">content</span>&nbsp;<span class="op" id="6104118">:=</span>&nbsp;<span class="ident" id="6104121"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6104124">.</span><span class="ident" id="6104125">content</span><span class="op" id="6104132">(</span><span class="op" id="6104133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104137">if</span>&nbsp;<span class="ident" id="6104140"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104143">.</span><span class="ident" id="6104144">pw</span>&nbsp;<span class="op" id="6104147">==</span>&nbsp;<span class="ident" id="6104150">nil</span>&nbsp;<span class="op" id="6104154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104159">var</span>&nbsp;<span class="ident" id="6104163">body</span>&nbsp;<span class="ident" id="6104168"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6104170">.</span><span class="ident" id="6104171">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104185">if</span>&nbsp;<span class="builtinfunc" id="6104188">len</span><span class="op" id="6104191">(</span><span class="ident" id="6104192"><a href="/net/http/fcgi/child.go.html#6104110">content</a></span><span class="op" id="6104199">)</span>&nbsp;<span class="op" id="6104201">&gt;</span>&nbsp;<span class="num" id="6104203">0</span>&nbsp;<span class="op" id="6104205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6104211">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6104275">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104318"><a href="/net/http/fcgi/child.go.html#6104163">body</a></span><span class="op" id="6104322">,</span>&nbsp;<span class="ident" id="6104324"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104327">.</span><span class="ident" id="6104328">pw</span>&nbsp;<span class="op" id="6104331">=</span>&nbsp;<span class="ident" id="6104333"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6104335">.</span><span class="ident" id="6104336">Pipe</span><span class="op" id="6104340">(</span><span class="op" id="6104341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104346">}</span>&nbsp;<span class="keyword" id="6104348">else</span>&nbsp;<span class="op" id="6104353">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104359"><a href="/net/http/fcgi/child.go.html#6104163">body</a></span>&nbsp;<span class="op" id="6104364">=</span>&nbsp;<span class="ident" id="6104366"><a href="/net/http/fcgi/child.go.html#6102925">emptyBody</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104384">go</span>&nbsp;<span class="ident" id="6104387"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6104388">.</span><span class="ident" id="6104389">serveRequest</span><span class="op" id="6104401">(</span><span class="ident" id="6104402"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104405">,</span>&nbsp;<span class="ident" id="6104407"><a href="/net/http/fcgi/child.go.html#6104163">body</a></span><span class="op" id="6104411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104419">if</span>&nbsp;<span class="builtinfunc" id="6104422">len</span><span class="op" id="6104425">(</span><span class="ident" id="6104426"><a href="/net/http/fcgi/child.go.html#6104110">content</a></span><span class="op" id="6104433">)</span>&nbsp;<span class="op" id="6104435">&gt;</span>&nbsp;<span class="num" id="6104437">0</span>&nbsp;<span class="op" id="6104439">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6104444">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6104512">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104575"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104578">.</span><span class="ident" id="6104579">pw</span><span class="op" id="6104581">.</span><span class="ident" id="6104582">Write</span><span class="op" id="6104587">(</span><span class="ident" id="6104588"><a href="/net/http/fcgi/child.go.html#6104110">content</a></span><span class="op" id="6104595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104599">}</span>&nbsp;<span class="keyword" id="6104601">else</span>&nbsp;<span class="keyword" id="6104606">if</span>&nbsp;<span class="ident" id="6104609"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104612">.</span><span class="ident" id="6104613">pw</span>&nbsp;<span class="op" id="6104616">!=</span>&nbsp;<span class="ident" id="6104619">nil</span>&nbsp;<span class="op" id="6104623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104628"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6104631">.</span><span class="ident" id="6104632">pw</span><span class="op" id="6104634">.</span><span class="ident" id="6104635">Close</span><span class="op" id="6104640">(</span><span class="op" id="6104641">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6104645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104649">return</span>&nbsp;<span class="ident" id="6104656">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104661">case</span>&nbsp;<span class="ident" id="6104666"><a href="/net/http/fcgi/fcgi.go.html#6107838">typeGetValues</a></span><span class="op" id="6104679">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104683">values</span>&nbsp;<span class="op" id="6104690">:=</span>&nbsp;<span class="keyword" id="6104693">map</span><span class="op" id="6104696">[</span><span class="builtintype" id="6104697">string</span><span class="op" id="6104703">]</span><span class="builtintype" id="6104704">string</span><span class="op" id="6104710">{</span><span class="string" id="6104711">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6104728">:</span>&nbsp;<span class="string" id="6104730">&#34;1&#34;</span><span class="op" id="6104733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104737"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6104738">.</span><span class="ident" id="6104739">conn</span><span class="op" id="6104743">.</span><span class="ident" id="6104744">writePairs</span><span class="op" id="6104754">(</span><span class="ident" id="6104755"><a href="/net/http/fcgi/fcgi.go.html#6107871">typeGetValuesResult</a></span><span class="op" id="6104774">,</span>&nbsp;<span class="num" id="6104776">0</span><span class="op" id="6104777">,</span>&nbsp;<span class="ident" id="6104779"><a href="/net/http/fcgi/child.go.html#6104683">values</a></span><span class="op" id="6104785">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104789">return</span>&nbsp;<span class="ident" id="6104796">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104801">case</span>&nbsp;<span class="ident" id="6104806"><a href="/net/http/fcgi/fcgi.go.html#6107805">typeData</a></span><span class="op" id="6104814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6104818">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104885">return</span>&nbsp;<span class="ident" id="6104892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6104897">case</span>&nbsp;<span class="ident" id="6104902"><a href="/net/http/fcgi/fcgi.go.html#6107607">typeAbortRequest</a></span><span class="op" id="6104918">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6104922">println</span><span class="op" id="6104929">(</span><span class="string" id="6104930">&#34;abort&#34;</span><span class="op" id="6104937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104941"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6104942">.</span><span class="ident" id="6104943">mu</span><span class="op" id="6104945">.</span><span class="ident" id="6104946">Lock</span><span class="op" id="6104950">(</span><span class="op" id="6104951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6104955">delete</span><span class="op" id="6104961">(</span><span class="ident" id="6104962"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6104963">.</span><span class="ident" id="6104964">requests</span><span class="op" id="6104972">,</span>&nbsp;<span class="ident" id="6104974"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6104977">.</span><span class="ident" id="6104978">h</span><span class="op" id="6104979">.</span><span class="ident" id="6104980">Id</span><span class="op" id="6104982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6104986"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6104987">.</span><span class="ident" id="6104988">mu</span><span class="op" id="6104990">.</span><span class="ident" id="6104991">Unlock</span><span class="op" id="6104997">(</span><span class="op" id="6104998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105002"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6105003">.</span><span class="ident" id="6105004">conn</span><span class="op" id="6105008">.</span><span class="ident" id="6105009">writeEndRequest</span><span class="op" id="6105024">(</span><span class="ident" id="6105025"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6105028">.</span><span class="ident" id="6105029">h</span><span class="op" id="6105030">.</span><span class="ident" id="6105031">Id</span><span class="op" id="6105033">,</span>&nbsp;<span class="num" id="6105035">0</span><span class="op" id="6105036">,</span>&nbsp;<span class="ident" id="6105038"><a href="/net/http/fcgi/fcgi.go.html#6108218">statusRequestComplete</a></span><span class="op" id="6105059">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105063">if</span>&nbsp;<span class="op" id="6105066">!</span><span class="ident" id="6105067"><a href="/net/http/fcgi/child.go.html#6103042">req</a></span><span class="op" id="6105070">.</span><span class="ident" id="6105071">keepConn</span>&nbsp;<span class="op" id="6105080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105085">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105125">return</span>&nbsp;<span class="ident" id="6105132"><a href="/net/http/fcgi/child.go.html#6102857">errCloseConn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6105147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105151">return</span>&nbsp;<span class="ident" id="6105158">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105163">default</span><span class="op" id="6105170">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105174">b</span>&nbsp;<span class="op" id="6105176">:=</span>&nbsp;<span class="builtinfunc" id="6105179">make</span><span class="op" id="6105183">(</span><span class="op" id="6105184">[</span><span class="op" id="6105185">]</span><span class="builtintype" id="6105186">byte</span><span class="op" id="6105190">,</span>&nbsp;<span class="num" id="6105192">8</span><span class="op" id="6105193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105197"><a href="/net/http/fcgi/child.go.html#6105174">b</a></span><span class="op" id="6105198">[</span><span class="num" id="6105199">0</span><span class="op" id="6105200">]</span>&nbsp;<span class="op" id="6105202">=</span>&nbsp;<span class="builtintype" id="6105204">byte</span><span class="op" id="6105208">(</span><span class="ident" id="6105209"><a href="/net/http/fcgi/child.go.html#6103007">rec</a></span><span class="op" id="6105212">.</span><span class="ident" id="6105213">h</span><span class="op" id="6105214">.</span><span class="ident" id="6105215">Type</span><span class="op" id="6105219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105223"><a href="/net/http/fcgi/child.go.html#6102984">c</a></span><span class="op" id="6105224">.</span><span class="ident" id="6105225">conn</span><span class="op" id="6105229">.</span><span class="ident" id="6105230">writeRecord</span><span class="op" id="6105241">(</span><span class="ident" id="6105242"><a href="/net/http/fcgi/fcgi.go.html#6107905">typeUnknownType</a></span><span class="op" id="6105257">,</span>&nbsp;<span class="num" id="6105259">0</span><span class="op" id="6105260">,</span>&nbsp;<span class="ident" id="6105262"><a href="/net/http/fcgi/child.go.html#6105174">b</a></span><span class="op" id="6105263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105267">return</span>&nbsp;<span class="ident" id="6105274">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6105279">}</span><br>
<span class="lineno"></span><span class="op" id="6105281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6105284">func</span>&nbsp;<span class="op" id="6105289">(</span><span class="ident" id="6105290">c</span>&nbsp;<span class="op" id="6105292">*</span><span class="ident" id="6105293"><a href="/net/http/fcgi/child.go.html#6102316">child</a></span><span class="op" id="6105298">)</span>&nbsp;<span class="ident" id="6105300">serveRequest</span><span class="op" id="6105312">(</span><span class="ident" id="6105313">req</span>&nbsp;<span class="op" id="6105317">*</span><span class="ident" id="6105318"><a href="/net/http/fcgi/child.go.html#6100237">request</a></span><span class="op" id="6105325">,</span>&nbsp;<span class="ident" id="6105327">body</span>&nbsp;<span class="ident" id="6105332"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6105334">.</span><span class="ident" id="6105335">ReadCloser</span><span class="op" id="6105345">)</span>&nbsp;<span class="op" id="6105347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105350">r</span>&nbsp;<span class="op" id="6105352">:=</span>&nbsp;<span class="ident" id="6105355"><a href="/net/http/fcgi/child.go.html#6101191">newResponse</a></span><span class="op" id="6105366">(</span><span class="ident" id="6105367"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105368">,</span>&nbsp;<span class="ident" id="6105370"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6105373">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105376">httpReq</span><span class="op" id="6105383">,</span>&nbsp;<span class="ident" id="6105385">err</span>&nbsp;<span class="op" id="6105389">:=</span>&nbsp;<span class="ident" id="6105392"><a href="/net/http/fcgi/child.go.html#6100062">cgi</a></span><span class="op" id="6105395">.</span><span class="ident" id="6105396">RequestFromMap</span><span class="op" id="6105410">(</span><span class="ident" id="6105411"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6105414">.</span><span class="ident" id="6105415">params</span><span class="op" id="6105421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6105424">if</span>&nbsp;<span class="ident" id="6105427"><a href="/net/http/fcgi/child.go.html#6105385">err</a></span>&nbsp;<span class="op" id="6105431">!=</span>&nbsp;<span class="ident" id="6105434">nil</span>&nbsp;<span class="op" id="6105438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105442">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105486"><a href="/net/http/fcgi/child.go.html#6105350">r</a></span><span class="op" id="6105487">.</span><span class="ident" id="6105488">WriteHeader</span><span class="op" id="6105499">(</span><span class="ident" id="6105500"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6105504">.</span><span class="ident" id="6105505">StatusInternalServerError</span><span class="op" id="6105530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105534"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105535">.</span><span class="ident" id="6105536">conn</span><span class="op" id="6105540">.</span><span class="ident" id="6105541">writeRecord</span><span class="op" id="6105552">(</span><span class="ident" id="6105553"><a href="/net/http/fcgi/fcgi.go.html#6107772">typeStderr</a></span><span class="op" id="6105563">,</span>&nbsp;<span class="ident" id="6105565"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6105568">.</span><span class="ident" id="6105569">reqId</span><span class="op" id="6105574">,</span>&nbsp;<span class="op" id="6105576">[</span><span class="op" id="6105577">]</span><span class="builtintype" id="6105578">byte</span><span class="op" id="6105582">(</span><span class="ident" id="6105583"><a href="/net/http/fcgi/child.go.html#6105385">err</a></span><span class="op" id="6105586">.</span><span class="ident" id="6105587">Error</span><span class="op" id="6105592">(</span><span class="op" id="6105593">)</span><span class="op" id="6105594">)</span><span class="op" id="6105595">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6105598">}</span>&nbsp;<span class="keyword" id="6105600">else</span>&nbsp;<span class="op" id="6105605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105609"><a href="/net/http/fcgi/child.go.html#6105376">httpReq</a></span><span class="op" id="6105616">.</span><span class="ident" id="6105617">Body</span>&nbsp;<span class="op" id="6105622">=</span>&nbsp;<span class="ident" id="6105624"><a href="/net/http/fcgi/child.go.html#6105327">body</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105631"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105632">.</span><span class="ident" id="6105633">handler</span><span class="op" id="6105640">.</span><span class="ident" id="6105641">ServeHTTP</span><span class="op" id="6105650">(</span><span class="ident" id="6105651"><a href="/net/http/fcgi/child.go.html#6105350">r</a></span><span class="op" id="6105652">,</span>&nbsp;<span class="ident" id="6105654"><a href="/net/http/fcgi/child.go.html#6105376">httpReq</a></span><span class="op" id="6105661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6105664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105667"><a href="/net/http/fcgi/child.go.html#6105350">r</a></span><span class="op" id="6105668">.</span><span class="ident" id="6105669">Close</span><span class="op" id="6105674">(</span><span class="op" id="6105675">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105678"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105679">.</span><span class="ident" id="6105680">mu</span><span class="op" id="6105682">.</span><span class="ident" id="6105683">Lock</span><span class="op" id="6105687">(</span><span class="op" id="6105688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6105691">delete</span><span class="op" id="6105697">(</span><span class="ident" id="6105698"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105699">.</span><span class="ident" id="6105700">requests</span><span class="op" id="6105708">,</span>&nbsp;<span class="ident" id="6105710"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6105713">.</span><span class="ident" id="6105714">reqId</span><span class="op" id="6105719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105722"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105723">.</span><span class="ident" id="6105724">mu</span><span class="op" id="6105726">.</span><span class="ident" id="6105727">Unlock</span><span class="op" id="6105733">(</span><span class="op" id="6105734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6105737"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6105738">.</span><span class="ident" id="6105739">conn</span><span class="op" id="6105743">.</span><span class="ident" id="6105744">writeEndRequest</span><span class="op" id="6105759">(</span><span class="ident" id="6105760"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6105763">.</span><span class="ident" id="6105764">reqId</span><span class="op" id="6105769">,</span>&nbsp;<span class="num" id="6105771">0</span><span class="op" id="6105772">,</span>&nbsp;<span class="ident" id="6105774"><a href="/net/http/fcgi/fcgi.go.html#6108218">statusRequestComplete</a></span><span class="op" id="6105795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105799">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105863">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105924">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6105979">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6106037">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6106093">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6106151">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106190"><a href="/net/http/fcgi/child.go.html#6100024">io</a></span><span class="op" id="6106192">.</span><span class="ident" id="6106193">CopyN</span><span class="op" id="6106198">(</span><span class="ident" id="6106199"><a href="/net/http/fcgi/child.go.html#6100030">ioutil</a></span><span class="op" id="6106205">.</span><span class="ident" id="6106206">Discard</span><span class="op" id="6106213">,</span>&nbsp;<span class="ident" id="6106215"><a href="/net/http/fcgi/child.go.html#6105327">body</a></span><span class="op" id="6106219">,</span>&nbsp;<span class="num" id="6106221">100</span><span class="op" id="6106224">&lt;&lt;</span><span class="num" id="6106226">20</span><span class="op" id="6106228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106231"><a href="/net/http/fcgi/child.go.html#6105327">body</a></span><span class="op" id="6106235">.</span><span class="ident" id="6106236">Close</span><span class="op" id="6106241">(</span><span class="op" id="6106242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106246">if</span>&nbsp;<span class="op" id="6106249">!</span><span class="ident" id="6106250"><a href="/net/http/fcgi/child.go.html#6105313">req</a></span><span class="op" id="6106253">.</span><span class="ident" id="6106254">keepConn</span>&nbsp;<span class="op" id="6106263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106267"><a href="/net/http/fcgi/child.go.html#6105290">c</a></span><span class="op" id="6106268">.</span><span class="ident" id="6106269">conn</span><span class="op" id="6106273">.</span><span class="ident" id="6106274">Close</span><span class="op" id="6106279">(</span><span class="op" id="6106280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106283">}</span><br>
<span class="lineno"></span><span class="op" id="6106285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6106288">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6106368">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6106443">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6106464">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6106521">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6106573">func</span>&nbsp;<span class="ident" id="6106578">Serve</span><span class="op" id="6106583">(</span><span class="ident" id="6106584">l</span>&nbsp;<span class="ident" id="6106586"><a href="/net/http/fcgi/child.go.html#6100043">net</a></span><span class="op" id="6106589">.</span><span class="ident" id="6106590">Listener</span><span class="op" id="6106598">,</span>&nbsp;<span class="ident" id="6106600">handler</span>&nbsp;<span class="ident" id="6106608"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6106612">.</span><span class="ident" id="6106613">Handler</span><span class="op" id="6106620">)</span>&nbsp;<span class="builtintype" id="6106622">error</span>&nbsp;<span class="op" id="6106628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106631">if</span>&nbsp;<span class="ident" id="6106634"><a href="/net/http/fcgi/child.go.html#6106584">l</a></span>&nbsp;<span class="op" id="6106636">==</span>&nbsp;<span class="ident" id="6106639">nil</span>&nbsp;<span class="op" id="6106643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106647">var</span>&nbsp;<span class="ident" id="6106651">err</span>&nbsp;<span class="builtintype" id="6106655">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106663"><a href="/net/http/fcgi/child.go.html#6106584">l</a></span><span class="op" id="6106664">,</span>&nbsp;<span class="ident" id="6106666"><a href="/net/http/fcgi/child.go.html#6106651">err</a></span>&nbsp;<span class="op" id="6106670">=</span>&nbsp;<span class="ident" id="6106672"><a href="/net/http/fcgi/child.go.html#6100043">net</a></span><span class="op" id="6106675">.</span><span class="ident" id="6106676">FileListener</span><span class="op" id="6106688">(</span><span class="ident" id="6106689"><a href="/net/http/fcgi/child.go.html#6100078">os</a></span><span class="op" id="6106691">.</span><span class="ident" id="6106692">Stdin</span><span class="op" id="6106697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106701">if</span>&nbsp;<span class="ident" id="6106704"><a href="/net/http/fcgi/child.go.html#6106651">err</a></span>&nbsp;<span class="op" id="6106708">!=</span>&nbsp;<span class="ident" id="6106711">nil</span>&nbsp;<span class="op" id="6106715">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106720">return</span>&nbsp;<span class="ident" id="6106727"><a href="/net/http/fcgi/child.go.html#6106651">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106737">defer</span>&nbsp;<span class="ident" id="6106743"><a href="/net/http/fcgi/child.go.html#6106584">l</a></span><span class="op" id="6106744">.</span><span class="ident" id="6106745">Close</span><span class="op" id="6106750">(</span><span class="op" id="6106751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106757">if</span>&nbsp;<span class="ident" id="6106760"><a href="/net/http/fcgi/child.go.html#6106600">handler</a></span>&nbsp;<span class="op" id="6106768">==</span>&nbsp;<span class="ident" id="6106771">nil</span>&nbsp;<span class="op" id="6106775">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106779"><a href="/net/http/fcgi/child.go.html#6106600">handler</a></span>&nbsp;<span class="op" id="6106787">=</span>&nbsp;<span class="ident" id="6106789"><a href="/net/http/fcgi/child.go.html#6100050">http</a></span><span class="op" id="6106793">.</span><span class="ident" id="6106794">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106814">for</span>&nbsp;<span class="op" id="6106818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106822">rw</span><span class="op" id="6106824">,</span>&nbsp;<span class="ident" id="6106826">err</span>&nbsp;<span class="op" id="6106830">:=</span>&nbsp;<span class="ident" id="6106833"><a href="/net/http/fcgi/child.go.html#6106584">l</a></span><span class="op" id="6106834">.</span><span class="ident" id="6106835">Accept</span><span class="op" id="6106841">(</span><span class="op" id="6106842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106846">if</span>&nbsp;<span class="ident" id="6106849"><a href="/net/http/fcgi/child.go.html#6106826">err</a></span>&nbsp;<span class="op" id="6106853">!=</span>&nbsp;<span class="ident" id="6106856">nil</span>&nbsp;<span class="op" id="6106860">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106865">return</span>&nbsp;<span class="ident" id="6106872"><a href="/net/http/fcgi/child.go.html#6106826">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6106882">c</span>&nbsp;<span class="op" id="6106884">:=</span>&nbsp;<span class="ident" id="6106887"><a href="/net/http/fcgi/child.go.html#6102482">newChild</a></span><span class="op" id="6106895">(</span><span class="ident" id="6106896"><a href="/net/http/fcgi/child.go.html#6106822">rw</a></span><span class="op" id="6106898">,</span>&nbsp;<span class="ident" id="6106900"><a href="/net/http/fcgi/child.go.html#6106600">handler</a></span><span class="op" id="6106907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6106911">go</span>&nbsp;<span class="ident" id="6106914"><a href="/net/http/fcgi/child.go.html#6106882">c</a></span><span class="op" id="6106915">.</span><span class="ident" id="6106916">serve</span><span class="op" id="6106921">(</span><span class="op" id="6106922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6106925">}</span><br>
<span class="lineno">305</span><span class="op" id="6106927">}</span>
</div>
</body>
</html>
