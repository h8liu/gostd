<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html" class="current">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2379089">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2379144">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2379198">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2379249">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2379314">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2379341">package</span>&nbsp;<span class="ident" id="2379349">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2379358">import</span>&nbsp;<span class="op" id="2379365">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2379368">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2379379">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2379387">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2379396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2379399">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2379465">//</span><br>
<span class="lineno"></span><span class="comment" id="2379468">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2379533">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2379594">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2379658">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2379714">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2379778">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2379840">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2379907">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2379971">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2380016">//</span><br>
<span class="lineno"></span><span class="comment" id="2380019">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2380087">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2380158">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2380227">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2380260">//</span><br>
<span class="lineno"></span><span class="comment" id="2380263">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2380327">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2380393">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2380459">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2380496">//</span><br>
<span class="lineno"></span><span class="comment" id="2380499">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2380560">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2380633">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2380701">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2380767">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2380836">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2380901">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2380943">//</span><br>
<span class="lineno"></span><span class="comment" id="2380946">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2381010">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2381077">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2381140">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2381193">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2381260">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2381288">//</span><br>
<span class="lineno"></span><span class="comment" id="2381291">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2381341">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2381391">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2381452">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2381498">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2381561">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2381607">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2381657">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2381714">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2381781">var</span>&nbsp;<span class="ident" id="2381785">ForkLock</span>&nbsp;<span class="ident" id="2381794">sync</span><span class="op" id="2381798">.</span><span class="ident" id="2381799">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2381808">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2381874">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2381940">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2381966">func</span>&nbsp;<span class="ident" id="2381971">StringSlicePtr</span><span class="op" id="2381985">(</span><span class="ident" id="2381986">ss</span>&nbsp;<span class="op" id="2381989">[</span><span class="op" id="2381990">]</span><span class="builtintype" id="2381991">string</span><span class="op" id="2381997">)</span>&nbsp;<span class="op" id="2381999">[</span><span class="op" id="2382000">]</span><span class="op" id="2382001">*</span><span class="builtintype" id="2382002">byte</span>&nbsp;<span class="op" id="2382007">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382010">bb</span>&nbsp;<span class="op" id="2382013">:=</span>&nbsp;<span class="builtinfunc" id="2382016">make</span><span class="op" id="2382020">(</span><span class="op" id="2382021">[</span><span class="op" id="2382022">]</span><span class="op" id="2382023">*</span><span class="builtintype" id="2382024">byte</span><span class="op" id="2382028">,</span>&nbsp;<span class="builtinfunc" id="2382030">len</span><span class="op" id="2382033">(</span><span class="ident" id="2382034">ss</span><span class="op" id="2382036">)</span><span class="op" id="2382037">+</span><span class="num" id="2382038">1</span><span class="op" id="2382039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382042">for</span>&nbsp;<span class="ident" id="2382046">i</span>&nbsp;<span class="op" id="2382048">:=</span>&nbsp;<span class="num" id="2382051">0</span><span class="op" id="2382052">;</span>&nbsp;<span class="ident" id="2382054">i</span>&nbsp;<span class="op" id="2382056">&lt;</span>&nbsp;<span class="builtinfunc" id="2382058">len</span><span class="op" id="2382061">(</span><span class="ident" id="2382062">ss</span><span class="op" id="2382064">)</span><span class="op" id="2382065">;</span>&nbsp;<span class="ident" id="2382067">i</span><span class="op" id="2382068">++</span>&nbsp;<span class="op" id="2382071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382075">bb</span><span class="op" id="2382077">[</span><span class="ident" id="2382078">i</span><span class="op" id="2382079">]</span>&nbsp;<span class="op" id="2382081">=</span>&nbsp;<span class="ident" id="2382083">StringBytePtr</span><span class="op" id="2382096">(</span><span class="ident" id="2382097">ss</span><span class="op" id="2382099">[</span><span class="ident" id="2382100">i</span><span class="op" id="2382101">]</span><span class="op" id="2382102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382108">bb</span><span class="op" id="2382110">[</span><span class="builtinfunc" id="2382111">len</span><span class="op" id="2382114">(</span><span class="ident" id="2382115">ss</span><span class="op" id="2382117">)</span><span class="op" id="2382118">]</span>&nbsp;<span class="op" id="2382120">=</span>&nbsp;<span class="ident" id="2382122">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382127">return</span>&nbsp;<span class="ident" id="2382134">bb</span><br>
<span class="lineno"></span><span class="op" id="2382137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2382140">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2382205">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2382271">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2382312">func</span>&nbsp;<span class="ident" id="2382317">SlicePtrFromStrings</span><span class="op" id="2382336">(</span><span class="ident" id="2382337">ss</span>&nbsp;<span class="op" id="2382340">[</span><span class="op" id="2382341">]</span><span class="builtintype" id="2382342">string</span><span class="op" id="2382348">)</span>&nbsp;<span class="op" id="2382350">(</span><span class="op" id="2382351">[</span><span class="op" id="2382352">]</span><span class="op" id="2382353">*</span><span class="builtintype" id="2382354">byte</span><span class="op" id="2382358">,</span>&nbsp;<span class="builtintype" id="2382360">error</span><span class="op" id="2382365">)</span>&nbsp;<span class="op" id="2382367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382370">var</span>&nbsp;<span class="ident" id="2382374">err</span>&nbsp;<span class="builtintype" id="2382378">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382385">bb</span>&nbsp;<span class="op" id="2382388">:=</span>&nbsp;<span class="builtinfunc" id="2382391">make</span><span class="op" id="2382395">(</span><span class="op" id="2382396">[</span><span class="op" id="2382397">]</span><span class="op" id="2382398">*</span><span class="builtintype" id="2382399">byte</span><span class="op" id="2382403">,</span>&nbsp;<span class="builtinfunc" id="2382405">len</span><span class="op" id="2382408">(</span><span class="ident" id="2382409">ss</span><span class="op" id="2382411">)</span><span class="op" id="2382412">+</span><span class="num" id="2382413">1</span><span class="op" id="2382414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382417">for</span>&nbsp;<span class="ident" id="2382421">i</span>&nbsp;<span class="op" id="2382423">:=</span>&nbsp;<span class="num" id="2382426">0</span><span class="op" id="2382427">;</span>&nbsp;<span class="ident" id="2382429">i</span>&nbsp;<span class="op" id="2382431">&lt;</span>&nbsp;<span class="builtinfunc" id="2382433">len</span><span class="op" id="2382436">(</span><span class="ident" id="2382437">ss</span><span class="op" id="2382439">)</span><span class="op" id="2382440">;</span>&nbsp;<span class="ident" id="2382442">i</span><span class="op" id="2382443">++</span>&nbsp;<span class="op" id="2382446">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382450">bb</span><span class="op" id="2382452">[</span><span class="ident" id="2382453">i</span><span class="op" id="2382454">]</span><span class="op" id="2382455">,</span>&nbsp;<span class="ident" id="2382457">err</span>&nbsp;<span class="op" id="2382461">=</span>&nbsp;<span class="ident" id="2382463">BytePtrFromString</span><span class="op" id="2382480">(</span><span class="ident" id="2382481">ss</span><span class="op" id="2382483">[</span><span class="ident" id="2382484">i</span><span class="op" id="2382485">]</span><span class="op" id="2382486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382490">if</span>&nbsp;<span class="ident" id="2382493">err</span>&nbsp;<span class="op" id="2382497">!=</span>&nbsp;<span class="ident" id="2382500">nil</span>&nbsp;<span class="op" id="2382504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382509">return</span>&nbsp;<span class="ident" id="2382516">nil</span><span class="op" id="2382519">,</span>&nbsp;<span class="ident" id="2382521">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382530">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382533">bb</span><span class="op" id="2382535">[</span><span class="builtinfunc" id="2382536">len</span><span class="op" id="2382539">(</span><span class="ident" id="2382540">ss</span><span class="op" id="2382542">)</span><span class="op" id="2382543">]</span>&nbsp;<span class="op" id="2382545">=</span>&nbsp;<span class="ident" id="2382547">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382552">return</span>&nbsp;<span class="ident" id="2382559">bb</span><span class="op" id="2382561">,</span>&nbsp;<span class="ident" id="2382563">nil</span><br>
<span class="lineno"></span><span class="op" id="2382567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2382570">func</span>&nbsp;<span class="ident" id="2382575">CloseOnExec</span><span class="op" id="2382586">(</span><span class="ident" id="2382587">fd</span>&nbsp;<span class="builtintype" id="2382590">int</span><span class="op" id="2382593">)</span>&nbsp;<span class="op" id="2382595">{</span>&nbsp;<span class="ident" id="2382597">fcntl</span><span class="op" id="2382602">(</span><span class="ident" id="2382603">fd</span><span class="op" id="2382605">,</span>&nbsp;<span class="ident" id="2382607">F_SETFD</span><span class="op" id="2382614">,</span>&nbsp;<span class="ident" id="2382616">FD_CLOEXEC</span><span class="op" id="2382626">)</span>&nbsp;<span class="op" id="2382628">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2382631">func</span>&nbsp;<span class="ident" id="2382636">SetNonblock</span><span class="op" id="2382647">(</span><span class="ident" id="2382648">fd</span>&nbsp;<span class="builtintype" id="2382651">int</span><span class="op" id="2382654">,</span>&nbsp;<span class="ident" id="2382656">nonblocking</span>&nbsp;<span class="builtintype" id="2382668">bool</span><span class="op" id="2382672">)</span>&nbsp;<span class="op" id="2382674">(</span><span class="ident" id="2382675">err</span>&nbsp;<span class="builtintype" id="2382679">error</span><span class="op" id="2382684">)</span>&nbsp;<span class="op" id="2382686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382689">flag</span><span class="op" id="2382693">,</span>&nbsp;<span class="ident" id="2382695">err</span>&nbsp;<span class="op" id="2382699">:=</span>&nbsp;<span class="ident" id="2382702">fcntl</span><span class="op" id="2382707">(</span><span class="ident" id="2382708">fd</span><span class="op" id="2382710">,</span>&nbsp;<span class="ident" id="2382712">F_GETFL</span><span class="op" id="2382719">,</span>&nbsp;<span class="num" id="2382721">0</span><span class="op" id="2382722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382725">if</span>&nbsp;<span class="ident" id="2382728">err</span>&nbsp;<span class="op" id="2382732">!=</span>&nbsp;<span class="ident" id="2382735">nil</span>&nbsp;<span class="op" id="2382739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382743">return</span>&nbsp;<span class="ident" id="2382750">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382758">if</span>&nbsp;<span class="ident" id="2382761">nonblocking</span>&nbsp;<span class="op" id="2382773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382777">flag</span>&nbsp;<span class="op" id="2382782">|=</span>&nbsp;<span class="ident" id="2382785">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382797">}</span>&nbsp;<span class="keyword" id="2382799">else</span>&nbsp;<span class="op" id="2382804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382808">flag</span>&nbsp;<span class="op" id="2382813">&amp;=</span>&nbsp;<span class="op" id="2382816">^</span><span class="ident" id="2382817">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2382829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2382832">_</span><span class="op" id="2382833">,</span>&nbsp;<span class="ident" id="2382835">err</span>&nbsp;<span class="op" id="2382839">=</span>&nbsp;<span class="ident" id="2382841">fcntl</span><span class="op" id="2382846">(</span><span class="ident" id="2382847">fd</span><span class="op" id="2382849">,</span>&nbsp;<span class="ident" id="2382851">F_SETFL</span><span class="op" id="2382858">,</span>&nbsp;<span class="ident" id="2382860">flag</span><span class="op" id="2382864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2382867">return</span>&nbsp;<span class="ident" id="2382874">err</span><br>
<span class="lineno"></span><span class="op" id="2382878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2382881">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2382941">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2382988">type</span>&nbsp;<span class="ident" id="2382993">Credential</span>&nbsp;<span class="keyword" id="2383004">struct</span>&nbsp;<span class="op" id="2383011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383014">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2383021">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2383030">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383043">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2383050">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2383059">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383073">Groups</span>&nbsp;<span class="op" id="2383080">[</span><span class="op" id="2383081">]</span><span class="builtintype" id="2383082">uint32</span>&nbsp;<span class="comment" id="2383089">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2383117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2383120">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2383195">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2383215">type</span>&nbsp;<span class="ident" id="2383220">ProcAttr</span>&nbsp;<span class="keyword" id="2383229">struct</span>&nbsp;<span class="op" id="2383236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383239">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2383245">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2383255">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383286">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2383292">[</span><span class="op" id="2383293">]</span><span class="builtintype" id="2383294">string</span>&nbsp;&nbsp;<span class="comment" id="2383302">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383319">Files</span>&nbsp;<span class="op" id="2383325">[</span><span class="op" id="2383326">]</span><span class="builtintype" id="2383327">uintptr</span>&nbsp;<span class="comment" id="2383335">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383357">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2383363">*</span><span class="ident" id="2383364">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2383376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2383379">var</span>&nbsp;<span class="ident" id="2383383">zeroProcAttr</span>&nbsp;<span class="ident" id="2383396">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2383405">var</span>&nbsp;<span class="ident" id="2383409">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2383425">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2383438">func</span>&nbsp;<span class="ident" id="2383443">forkExec</span><span class="op" id="2383451">(</span><span class="ident" id="2383452">argv0</span>&nbsp;<span class="builtintype" id="2383458">string</span><span class="op" id="2383464">,</span>&nbsp;<span class="ident" id="2383466">argv</span>&nbsp;<span class="op" id="2383471">[</span><span class="op" id="2383472">]</span><span class="builtintype" id="2383473">string</span><span class="op" id="2383479">,</span>&nbsp;<span class="ident" id="2383481">attr</span>&nbsp;<span class="op" id="2383486">*</span><span class="ident" id="2383487">ProcAttr</span><span class="op" id="2383495">)</span>&nbsp;<span class="op" id="2383497">(</span><span class="ident" id="2383498">pid</span>&nbsp;<span class="builtintype" id="2383502">int</span><span class="op" id="2383505">,</span>&nbsp;<span class="ident" id="2383507">err</span>&nbsp;<span class="builtintype" id="2383511">error</span><span class="op" id="2383516">)</span>&nbsp;<span class="op" id="2383518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383521">var</span>&nbsp;<span class="ident" id="2383525">p</span>&nbsp;<span class="op" id="2383527">[</span><span class="num" id="2383528">2</span><span class="op" id="2383529">]</span><span class="builtintype" id="2383530">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383535">var</span>&nbsp;<span class="ident" id="2383539">n</span>&nbsp;<span class="builtintype" id="2383541">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383546">var</span>&nbsp;<span class="ident" id="2383550">err1</span>&nbsp;<span class="ident" id="2383555">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383562">var</span>&nbsp;<span class="ident" id="2383566">wstatus</span>&nbsp;<span class="ident" id="2383574">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383587">if</span>&nbsp;<span class="ident" id="2383590">attr</span>&nbsp;<span class="op" id="2383595">==</span>&nbsp;<span class="ident" id="2383598">nil</span>&nbsp;<span class="op" id="2383602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383606">attr</span>&nbsp;<span class="op" id="2383611">=</span>&nbsp;<span class="op" id="2383613">&amp;</span><span class="ident" id="2383614">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2383628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383631">sys</span>&nbsp;<span class="op" id="2383635">:=</span>&nbsp;<span class="ident" id="2383638">attr</span><span class="op" id="2383642">.</span><span class="ident" id="2383643">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383648">if</span>&nbsp;<span class="ident" id="2383651">sys</span>&nbsp;<span class="op" id="2383655">==</span>&nbsp;<span class="ident" id="2383658">nil</span>&nbsp;<span class="op" id="2383662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383666">sys</span>&nbsp;<span class="op" id="2383670">=</span>&nbsp;<span class="op" id="2383672">&amp;</span><span class="ident" id="2383673">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2383690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383694">p</span><span class="op" id="2383695">[</span><span class="num" id="2383696">0</span><span class="op" id="2383697">]</span>&nbsp;<span class="op" id="2383699">=</span>&nbsp;<span class="op" id="2383701">-</span><span class="num" id="2383702">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383705">p</span><span class="op" id="2383706">[</span><span class="num" id="2383707">1</span><span class="op" id="2383708">]</span>&nbsp;<span class="op" id="2383710">=</span>&nbsp;<span class="op" id="2383712">-</span><span class="num" id="2383713">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2383717">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383745">argv0p</span><span class="op" id="2383751">,</span>&nbsp;<span class="ident" id="2383753">err</span>&nbsp;<span class="op" id="2383757">:=</span>&nbsp;<span class="ident" id="2383760">BytePtrFromString</span><span class="op" id="2383777">(</span><span class="ident" id="2383778">argv0</span><span class="op" id="2383783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383786">if</span>&nbsp;<span class="ident" id="2383789">err</span>&nbsp;<span class="op" id="2383793">!=</span>&nbsp;<span class="ident" id="2383796">nil</span>&nbsp;<span class="op" id="2383800">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383804">return</span>&nbsp;<span class="num" id="2383811">0</span><span class="op" id="2383812">,</span>&nbsp;<span class="ident" id="2383814">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2383819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383822">argvp</span><span class="op" id="2383827">,</span>&nbsp;<span class="ident" id="2383829">err</span>&nbsp;<span class="op" id="2383833">:=</span>&nbsp;<span class="ident" id="2383836">SlicePtrFromStrings</span><span class="op" id="2383855">(</span><span class="ident" id="2383856">argv</span><span class="op" id="2383860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383863">if</span>&nbsp;<span class="ident" id="2383866">err</span>&nbsp;<span class="op" id="2383870">!=</span>&nbsp;<span class="ident" id="2383873">nil</span>&nbsp;<span class="op" id="2383877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383881">return</span>&nbsp;<span class="num" id="2383888">0</span><span class="op" id="2383889">,</span>&nbsp;<span class="ident" id="2383891">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2383896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2383899">envvp</span><span class="op" id="2383904">,</span>&nbsp;<span class="ident" id="2383906">err</span>&nbsp;<span class="op" id="2383910">:=</span>&nbsp;<span class="ident" id="2383913">SlicePtrFromStrings</span><span class="op" id="2383932">(</span><span class="ident" id="2383933">attr</span><span class="op" id="2383937">.</span><span class="ident" id="2383938">Env</span><span class="op" id="2383941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383944">if</span>&nbsp;<span class="ident" id="2383947">err</span>&nbsp;<span class="op" id="2383951">!=</span>&nbsp;<span class="ident" id="2383954">nil</span>&nbsp;<span class="op" id="2383958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383962">return</span>&nbsp;<span class="num" id="2383969">0</span><span class="op" id="2383970">,</span>&nbsp;<span class="ident" id="2383972">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2383977">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2383981">if</span>&nbsp;<span class="op" id="2383984">(</span><span class="ident" id="2383985">runtime</span><span class="op" id="2383992">.</span><span class="ident" id="2383993">GOOS</span>&nbsp;<span class="op" id="2383998">==</span>&nbsp;<span class="string" id="2384001">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2384011">||</span>&nbsp;<span class="ident" id="2384014">runtime</span><span class="op" id="2384021">.</span><span class="ident" id="2384022">GOOS</span>&nbsp;<span class="op" id="2384027">==</span>&nbsp;<span class="string" id="2384030">&#34;dragonfly&#34;</span><span class="op" id="2384041">)</span>&nbsp;<span class="op" id="2384043">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2384046">len</span><span class="op" id="2384049">(</span><span class="ident" id="2384050">argv</span><span class="op" id="2384054">[</span><span class="num" id="2384055">0</span><span class="op" id="2384056">]</span><span class="op" id="2384057">)</span>&nbsp;<span class="op" id="2384059">&gt;</span>&nbsp;<span class="builtinfunc" id="2384061">len</span><span class="op" id="2384064">(</span><span class="ident" id="2384065">argv0</span><span class="op" id="2384070">)</span>&nbsp;<span class="op" id="2384072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384076">argvp</span><span class="op" id="2384081">[</span><span class="num" id="2384082">0</span><span class="op" id="2384083">]</span>&nbsp;<span class="op" id="2384085">=</span>&nbsp;<span class="ident" id="2384087">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384099">var</span>&nbsp;<span class="ident" id="2384103">chroot</span>&nbsp;<span class="op" id="2384110">*</span><span class="builtintype" id="2384111">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384117">if</span>&nbsp;<span class="ident" id="2384120">sys</span><span class="op" id="2384123">.</span><span class="ident" id="2384124">Chroot</span>&nbsp;<span class="op" id="2384131">!=</span>&nbsp;<span class="string" id="2384134">&#34;&#34;</span>&nbsp;<span class="op" id="2384137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384141">chroot</span><span class="op" id="2384147">,</span>&nbsp;<span class="ident" id="2384149">err</span>&nbsp;<span class="op" id="2384153">=</span>&nbsp;<span class="ident" id="2384155">BytePtrFromString</span><span class="op" id="2384172">(</span><span class="ident" id="2384173">sys</span><span class="op" id="2384176">.</span><span class="ident" id="2384177">Chroot</span><span class="op" id="2384183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384187">if</span>&nbsp;<span class="ident" id="2384190">err</span>&nbsp;<span class="op" id="2384194">!=</span>&nbsp;<span class="ident" id="2384197">nil</span>&nbsp;<span class="op" id="2384201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384206">return</span>&nbsp;<span class="num" id="2384213">0</span><span class="op" id="2384214">,</span>&nbsp;<span class="ident" id="2384216">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384228">var</span>&nbsp;<span class="ident" id="2384232">dir</span>&nbsp;<span class="op" id="2384236">*</span><span class="builtintype" id="2384237">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384243">if</span>&nbsp;<span class="ident" id="2384246">attr</span><span class="op" id="2384250">.</span><span class="ident" id="2384251">Dir</span>&nbsp;<span class="op" id="2384255">!=</span>&nbsp;<span class="string" id="2384258">&#34;&#34;</span>&nbsp;<span class="op" id="2384261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384265">dir</span><span class="op" id="2384268">,</span>&nbsp;<span class="ident" id="2384270">err</span>&nbsp;<span class="op" id="2384274">=</span>&nbsp;<span class="ident" id="2384276">BytePtrFromString</span><span class="op" id="2384293">(</span><span class="ident" id="2384294">attr</span><span class="op" id="2384298">.</span><span class="ident" id="2384299">Dir</span><span class="op" id="2384302">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384306">if</span>&nbsp;<span class="ident" id="2384309">err</span>&nbsp;<span class="op" id="2384313">!=</span>&nbsp;<span class="ident" id="2384316">nil</span>&nbsp;<span class="op" id="2384320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384325">return</span>&nbsp;<span class="num" id="2384332">0</span><span class="op" id="2384333">,</span>&nbsp;<span class="ident" id="2384335">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384348">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384399">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384449">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384469">ForkLock</span><span class="op" id="2384477">.</span><span class="ident" id="2384478">Lock</span><span class="op" id="2384482">(</span><span class="op" id="2384483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384487">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384533">if</span>&nbsp;<span class="ident" id="2384536">err</span>&nbsp;<span class="op" id="2384540">=</span>&nbsp;<span class="ident" id="2384542">forkExecPipe</span><span class="op" id="2384554">(</span><span class="ident" id="2384555">p</span><span class="op" id="2384556">[</span><span class="op" id="2384557">:</span><span class="op" id="2384558">]</span><span class="op" id="2384559">)</span><span class="op" id="2384560">;</span>&nbsp;<span class="ident" id="2384562">err</span>&nbsp;<span class="op" id="2384566">!=</span>&nbsp;<span class="ident" id="2384569">nil</span>&nbsp;<span class="op" id="2384573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384577">goto</span>&nbsp;<span class="builtintype" id="2384582">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384593">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384613">pid</span><span class="op" id="2384616">,</span>&nbsp;<span class="ident" id="2384618">err1</span>&nbsp;<span class="op" id="2384623">=</span>&nbsp;<span class="ident" id="2384625">forkAndExecInChild</span><span class="op" id="2384643">(</span><span class="ident" id="2384644">argv0p</span><span class="op" id="2384650">,</span>&nbsp;<span class="ident" id="2384652">argvp</span><span class="op" id="2384657">,</span>&nbsp;<span class="ident" id="2384659">envvp</span><span class="op" id="2384664">,</span>&nbsp;<span class="ident" id="2384666">chroot</span><span class="op" id="2384672">,</span>&nbsp;<span class="ident" id="2384674">dir</span><span class="op" id="2384677">,</span>&nbsp;<span class="ident" id="2384679">attr</span><span class="op" id="2384683">,</span>&nbsp;<span class="ident" id="2384685">sys</span><span class="op" id="2384688">,</span>&nbsp;<span class="ident" id="2384690">p</span><span class="op" id="2384691">[</span><span class="num" id="2384692">1</span><span class="op" id="2384693">]</span><span class="op" id="2384694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384697">if</span>&nbsp;<span class="ident" id="2384700">err1</span>&nbsp;<span class="op" id="2384705">!=</span>&nbsp;<span class="num" id="2384708">0</span>&nbsp;<span class="op" id="2384710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384714">err</span>&nbsp;<span class="op" id="2384718">=</span>&nbsp;<span class="ident" id="2384720">Errno</span><span class="op" id="2384725">(</span><span class="ident" id="2384726">err1</span><span class="op" id="2384730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384734">goto</span>&nbsp;<span class="builtintype" id="2384739">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2384746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384749">ForkLock</span><span class="op" id="2384757">.</span><span class="ident" id="2384758">Unlock</span><span class="op" id="2384764">(</span><span class="op" id="2384765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2384769">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384808">Close</span><span class="op" id="2384813">(</span><span class="ident" id="2384814">p</span><span class="op" id="2384815">[</span><span class="num" id="2384816">1</span><span class="op" id="2384817">]</span><span class="op" id="2384818">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384821">n</span><span class="op" id="2384822">,</span>&nbsp;<span class="ident" id="2384824">err</span>&nbsp;<span class="op" id="2384828">=</span>&nbsp;<span class="ident" id="2384830">readlen</span><span class="op" id="2384837">(</span><span class="ident" id="2384838">p</span><span class="op" id="2384839">[</span><span class="num" id="2384840">0</span><span class="op" id="2384841">]</span><span class="op" id="2384842">,</span>&nbsp;<span class="op" id="2384844">(</span><span class="op" id="2384845">*</span><span class="builtintype" id="2384846">byte</span><span class="op" id="2384850">)</span><span class="op" id="2384851">(</span><span class="ident" id="2384852">unsafe</span><span class="op" id="2384858">.</span><span class="ident" id="2384859">Pointer</span><span class="op" id="2384866">(</span><span class="op" id="2384867">&amp;</span><span class="ident" id="2384868">err1</span><span class="op" id="2384872">)</span><span class="op" id="2384873">)</span><span class="op" id="2384874">,</span>&nbsp;<span class="builtintype" id="2384876">int</span><span class="op" id="2384879">(</span><span class="ident" id="2384880">unsafe</span><span class="op" id="2384886">.</span><span class="ident" id="2384887">Sizeof</span><span class="op" id="2384893">(</span><span class="ident" id="2384894">err1</span><span class="op" id="2384898">)</span><span class="op" id="2384899">)</span><span class="op" id="2384900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384903">Close</span><span class="op" id="2384908">(</span><span class="ident" id="2384909">p</span><span class="op" id="2384910">[</span><span class="num" id="2384911">0</span><span class="op" id="2384912">]</span><span class="op" id="2384913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384916">if</span>&nbsp;<span class="ident" id="2384919">err</span>&nbsp;<span class="op" id="2384923">!=</span>&nbsp;<span class="ident" id="2384926">nil</span>&nbsp;<span class="op" id="2384930">||</span>&nbsp;<span class="ident" id="2384933">n</span>&nbsp;<span class="op" id="2384935">!=</span>&nbsp;<span class="num" id="2384938">0</span>&nbsp;<span class="op" id="2384940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2384944">if</span>&nbsp;<span class="ident" id="2384947">n</span>&nbsp;<span class="op" id="2384949">==</span>&nbsp;<span class="builtintype" id="2384952">int</span><span class="op" id="2384955">(</span><span class="ident" id="2384956">unsafe</span><span class="op" id="2384962">.</span><span class="ident" id="2384963">Sizeof</span><span class="op" id="2384969">(</span><span class="ident" id="2384970">err1</span><span class="op" id="2384974">)</span><span class="op" id="2384975">)</span>&nbsp;<span class="op" id="2384977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2384982">err</span>&nbsp;<span class="op" id="2384986">=</span>&nbsp;<span class="ident" id="2384988">Errno</span><span class="op" id="2384993">(</span><span class="ident" id="2384994">err1</span><span class="op" id="2384998">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385006">if</span>&nbsp;<span class="ident" id="2385009">err</span>&nbsp;<span class="op" id="2385013">==</span>&nbsp;<span class="ident" id="2385016">nil</span>&nbsp;<span class="op" id="2385020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385025">err</span>&nbsp;<span class="op" id="2385029">=</span>&nbsp;<span class="ident" id="2385031">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2385044">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2385097">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385132">_</span><span class="op" id="2385133">,</span>&nbsp;<span class="ident" id="2385135">err1</span>&nbsp;<span class="op" id="2385140">:=</span>&nbsp;<span class="ident" id="2385143">Wait4</span><span class="op" id="2385148">(</span><span class="ident" id="2385149">pid</span><span class="op" id="2385152">,</span>&nbsp;<span class="op" id="2385154">&amp;</span><span class="ident" id="2385155">wstatus</span><span class="op" id="2385162">,</span>&nbsp;<span class="num" id="2385164">0</span><span class="op" id="2385165">,</span>&nbsp;<span class="ident" id="2385167">nil</span><span class="op" id="2385170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385174">for</span>&nbsp;<span class="ident" id="2385178">err1</span>&nbsp;<span class="op" id="2385183">==</span>&nbsp;<span class="ident" id="2385186">EINTR</span>&nbsp;<span class="op" id="2385192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385197">_</span><span class="op" id="2385198">,</span>&nbsp;<span class="ident" id="2385200">err1</span>&nbsp;<span class="op" id="2385205">=</span>&nbsp;<span class="ident" id="2385207">Wait4</span><span class="op" id="2385212">(</span><span class="ident" id="2385213">pid</span><span class="op" id="2385216">,</span>&nbsp;<span class="op" id="2385218">&amp;</span><span class="ident" id="2385219">wstatus</span><span class="op" id="2385226">,</span>&nbsp;<span class="num" id="2385228">0</span><span class="op" id="2385229">,</span>&nbsp;<span class="ident" id="2385231">nil</span><span class="op" id="2385234">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385242">return</span>&nbsp;<span class="num" id="2385249">0</span><span class="op" id="2385250">,</span>&nbsp;<span class="ident" id="2385252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2385261">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385322">return</span>&nbsp;<span class="ident" id="2385329">pid</span><span class="op" id="2385332">,</span>&nbsp;<span class="ident" id="2385334">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2385339">error</span><span class="op" id="2385344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385347">if</span>&nbsp;<span class="ident" id="2385350">p</span><span class="op" id="2385351">[</span><span class="num" id="2385352">0</span><span class="op" id="2385353">]</span>&nbsp;<span class="op" id="2385355">&gt;=</span>&nbsp;<span class="num" id="2385358">0</span>&nbsp;<span class="op" id="2385360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385364">Close</span><span class="op" id="2385369">(</span><span class="ident" id="2385370">p</span><span class="op" id="2385371">[</span><span class="num" id="2385372">0</span><span class="op" id="2385373">]</span><span class="op" id="2385374">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385378">Close</span><span class="op" id="2385383">(</span><span class="ident" id="2385384">p</span><span class="op" id="2385385">[</span><span class="num" id="2385386">1</span><span class="op" id="2385387">]</span><span class="op" id="2385388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385394">ForkLock</span><span class="op" id="2385402">.</span><span class="ident" id="2385403">Unlock</span><span class="op" id="2385409">(</span><span class="op" id="2385410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385413">return</span>&nbsp;<span class="num" id="2385420">0</span><span class="op" id="2385421">,</span>&nbsp;<span class="ident" id="2385423">err</span><br>
<span class="lineno"></span><span class="op" id="2385427">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2385430">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2385490">func</span>&nbsp;<span class="ident" id="2385495">ForkExec</span><span class="op" id="2385503">(</span><span class="ident" id="2385504">argv0</span>&nbsp;<span class="builtintype" id="2385510">string</span><span class="op" id="2385516">,</span>&nbsp;<span class="ident" id="2385518">argv</span>&nbsp;<span class="op" id="2385523">[</span><span class="op" id="2385524">]</span><span class="builtintype" id="2385525">string</span><span class="op" id="2385531">,</span>&nbsp;<span class="ident" id="2385533">attr</span>&nbsp;<span class="op" id="2385538">*</span><span class="ident" id="2385539">ProcAttr</span><span class="op" id="2385547">)</span>&nbsp;<span class="op" id="2385549">(</span><span class="ident" id="2385550">pid</span>&nbsp;<span class="builtintype" id="2385554">int</span><span class="op" id="2385557">,</span>&nbsp;<span class="ident" id="2385559">err</span>&nbsp;<span class="builtintype" id="2385563">error</span><span class="op" id="2385568">)</span>&nbsp;<span class="op" id="2385570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385573">return</span>&nbsp;<span class="ident" id="2385580">forkExec</span><span class="op" id="2385588">(</span><span class="ident" id="2385589">argv0</span><span class="op" id="2385594">,</span>&nbsp;<span class="ident" id="2385596">argv</span><span class="op" id="2385600">,</span>&nbsp;<span class="ident" id="2385602">attr</span><span class="op" id="2385606">)</span><br>
<span class="lineno"></span><span class="op" id="2385608">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2385611">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2385658">func</span>&nbsp;<span class="ident" id="2385663">StartProcess</span><span class="op" id="2385675">(</span><span class="ident" id="2385676">argv0</span>&nbsp;<span class="builtintype" id="2385682">string</span><span class="op" id="2385688">,</span>&nbsp;<span class="ident" id="2385690">argv</span>&nbsp;<span class="op" id="2385695">[</span><span class="op" id="2385696">]</span><span class="builtintype" id="2385697">string</span><span class="op" id="2385703">,</span>&nbsp;<span class="ident" id="2385705">attr</span>&nbsp;<span class="op" id="2385710">*</span><span class="ident" id="2385711">ProcAttr</span><span class="op" id="2385719">)</span>&nbsp;<span class="op" id="2385721">(</span><span class="ident" id="2385722">pid</span>&nbsp;<span class="builtintype" id="2385726">int</span><span class="op" id="2385729">,</span>&nbsp;<span class="ident" id="2385731">handle</span>&nbsp;<span class="builtintype" id="2385738">uintptr</span><span class="op" id="2385745">,</span>&nbsp;<span class="ident" id="2385747">err</span>&nbsp;<span class="builtintype" id="2385751">error</span><span class="op" id="2385756">)</span>&nbsp;<span class="op" id="2385758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385761">pid</span><span class="op" id="2385764">,</span>&nbsp;<span class="ident" id="2385766">err</span>&nbsp;<span class="op" id="2385770">=</span>&nbsp;<span class="ident" id="2385772">forkExec</span><span class="op" id="2385780">(</span><span class="ident" id="2385781">argv0</span><span class="op" id="2385786">,</span>&nbsp;<span class="ident" id="2385788">argv</span><span class="op" id="2385792">,</span>&nbsp;<span class="ident" id="2385794">attr</span><span class="op" id="2385798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385801">return</span>&nbsp;<span class="ident" id="2385808">pid</span><span class="op" id="2385811">,</span>&nbsp;<span class="num" id="2385813">0</span><span class="op" id="2385814">,</span>&nbsp;<span class="ident" id="2385816">err</span><br>
<span class="lineno">240</span><span class="op" id="2385820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2385823">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2385841">func</span>&nbsp;<span class="ident" id="2385846">Exec</span><span class="op" id="2385850">(</span><span class="ident" id="2385851">argv0</span>&nbsp;<span class="builtintype" id="2385857">string</span><span class="op" id="2385863">,</span>&nbsp;<span class="ident" id="2385865">argv</span>&nbsp;<span class="op" id="2385870">[</span><span class="op" id="2385871">]</span><span class="builtintype" id="2385872">string</span><span class="op" id="2385878">,</span>&nbsp;<span class="ident" id="2385880">envv</span>&nbsp;<span class="op" id="2385885">[</span><span class="op" id="2385886">]</span><span class="builtintype" id="2385887">string</span><span class="op" id="2385893">)</span>&nbsp;<span class="op" id="2385895">(</span><span class="ident" id="2385896">err</span>&nbsp;<span class="builtintype" id="2385900">error</span><span class="op" id="2385905">)</span>&nbsp;<span class="op" id="2385907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385910">argv0p</span><span class="op" id="2385916">,</span>&nbsp;<span class="ident" id="2385918">err</span>&nbsp;<span class="op" id="2385922">:=</span>&nbsp;<span class="ident" id="2385925">BytePtrFromString</span><span class="op" id="2385942">(</span><span class="ident" id="2385943">argv0</span><span class="op" id="2385948">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385951">if</span>&nbsp;<span class="ident" id="2385954">err</span>&nbsp;<span class="op" id="2385958">!=</span>&nbsp;<span class="ident" id="2385961">nil</span>&nbsp;<span class="op" id="2385965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2385969">return</span>&nbsp;<span class="ident" id="2385976">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2385981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2385984">argvp</span><span class="op" id="2385989">,</span>&nbsp;<span class="ident" id="2385991">err</span>&nbsp;<span class="op" id="2385995">:=</span>&nbsp;<span class="ident" id="2385998">SlicePtrFromStrings</span><span class="op" id="2386017">(</span><span class="ident" id="2386018">argv</span><span class="op" id="2386022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2386025">if</span>&nbsp;<span class="ident" id="2386028">err</span>&nbsp;<span class="op" id="2386032">!=</span>&nbsp;<span class="ident" id="2386035">nil</span>&nbsp;<span class="op" id="2386039">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2386043">return</span>&nbsp;<span class="ident" id="2386050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2386055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2386058">envvp</span><span class="op" id="2386063">,</span>&nbsp;<span class="ident" id="2386065">err</span>&nbsp;<span class="op" id="2386069">:=</span>&nbsp;<span class="ident" id="2386072">SlicePtrFromStrings</span><span class="op" id="2386091">(</span><span class="ident" id="2386092">envv</span><span class="op" id="2386096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2386099">if</span>&nbsp;<span class="ident" id="2386102">err</span>&nbsp;<span class="op" id="2386106">!=</span>&nbsp;<span class="ident" id="2386109">nil</span>&nbsp;<span class="op" id="2386113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2386117">return</span>&nbsp;<span class="ident" id="2386124">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2386129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2386132">_</span><span class="op" id="2386133">,</span>&nbsp;<span class="ident" id="2386135">_</span><span class="op" id="2386136">,</span>&nbsp;<span class="ident" id="2386138">err1</span>&nbsp;<span class="op" id="2386143">:=</span>&nbsp;<span class="ident" id="2386146">RawSyscall</span><span class="op" id="2386156">(</span><span class="ident" id="2386157">SYS_EXECVE</span><span class="op" id="2386167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2386171">uintptr</span><span class="op" id="2386178">(</span><span class="ident" id="2386179">unsafe</span><span class="op" id="2386185">.</span><span class="ident" id="2386186">Pointer</span><span class="op" id="2386193">(</span><span class="ident" id="2386194">argv0p</span><span class="op" id="2386200">)</span><span class="op" id="2386201">)</span><span class="op" id="2386202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2386206">uintptr</span><span class="op" id="2386213">(</span><span class="ident" id="2386214">unsafe</span><span class="op" id="2386220">.</span><span class="ident" id="2386221">Pointer</span><span class="op" id="2386228">(</span><span class="op" id="2386229">&amp;</span><span class="ident" id="2386230">argvp</span><span class="op" id="2386235">[</span><span class="num" id="2386236">0</span><span class="op" id="2386237">]</span><span class="op" id="2386238">)</span><span class="op" id="2386239">)</span><span class="op" id="2386240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2386244">uintptr</span><span class="op" id="2386251">(</span><span class="ident" id="2386252">unsafe</span><span class="op" id="2386258">.</span><span class="ident" id="2386259">Pointer</span><span class="op" id="2386266">(</span><span class="op" id="2386267">&amp;</span><span class="ident" id="2386268">envvp</span><span class="op" id="2386273">[</span><span class="num" id="2386274">0</span><span class="op" id="2386275">]</span><span class="op" id="2386276">)</span><span class="op" id="2386277">)</span><span class="op" id="2386278">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2386281">return</span>&nbsp;<span class="ident" id="2386288">Errno</span><span class="op" id="2386293">(</span><span class="ident" id="2386294">err1</span><span class="op" id="2386298">)</span><br>
<span class="lineno"></span><span class="op" id="2386300">}</span>
</div>
</body>
</html>
