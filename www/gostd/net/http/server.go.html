<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4169064">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4169119">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4169173">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4169224">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4169256">package</span>&nbsp;<span class="ident" id="4169264">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4169270">import</span>&nbsp;<span class="op" id="4169277">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169280">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169289">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169303">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169313">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169320">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169326">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169339">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169346">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169353">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169364">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169370">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169378">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169389">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169400">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169411">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169419">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4169434">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4169441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4169444">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="4169485">var</span>&nbsp;<span class="op" id="4169489">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169492">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="4169511">=</span>&nbsp;<span class="ident" id="4169513"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4169519">.</span><span class="ident" id="4169520"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4169523">(</span><span class="string" id="4169524">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="4169555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169558">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="4169577">=</span>&nbsp;<span class="ident" id="4169579"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4169585">.</span><span class="ident" id="4169586"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4169589">(</span><span class="string" id="4169590">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="4169656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169659">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4169678">=</span>&nbsp;<span class="ident" id="4169680"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4169686">.</span><span class="ident" id="4169687"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4169690">(</span><span class="string" id="4169691">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="4169715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169718">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4169737">=</span>&nbsp;<span class="ident" id="4169739"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4169745">.</span><span class="ident" id="4169746"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4169749">(</span><span class="string" id="4169750">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="4169806">)</span><br>
<span class="lineno">35</span><span class="op" id="4169808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4169811">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4169864">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="4169916">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="4169939">//</span><br>
<span class="lineno"></span><span class="comment" id="4169942">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4170013">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4170081">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4170144">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="4170163">//</span><br>
<span class="lineno"></span><span class="comment" id="4170166">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="4170235">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4170303">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="4170373">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="4170405">//</span><br>
<span class="lineno"></span><span class="keyword" id="4170408">type</span>&nbsp;<span class="ident" id="4170413">Handler</span>&nbsp;<span class="keyword" id="4170421">interface</span>&nbsp;<span class="op" id="4170431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170434">ServeHTTP</span><span class="op" id="4170443">(</span><span class="ident" id="4170444"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4170458">,</span>&nbsp;<span class="op" id="4170460">*</span><span class="ident" id="4170461"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4170468">)</span><br>
<span class="lineno"></span><span class="op" id="4170470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4170473">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4170533">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4170564">type</span>&nbsp;<span class="ident" id="4170569">ResponseWriter</span>&nbsp;<span class="keyword" id="4170584">interface</span>&nbsp;<span class="op" id="4170594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170597">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170665">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170732">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170747">Header</span><span class="op" id="4170753">(</span><span class="op" id="4170754">)</span>&nbsp;<span class="ident" id="4170756"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170765">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170835">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170918">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170981">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171059">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171123">Write</span><span class="op" id="4171128">(</span><span class="op" id="4171129">[</span><span class="op" id="4171130">]</span><span class="builtintype" id="4171131">byte</span><span class="op" id="4171135">)</span>&nbsp;<span class="op" id="4171137">(</span><span class="builtintype" id="4171138">int</span><span class="op" id="4171141">,</span>&nbsp;<span class="builtintype" id="4171143">error</span><span class="op" id="4171148">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171152">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171216">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171285">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171342">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171400">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171422">WriteHeader</span><span class="op" id="4171433">(</span><span class="builtintype" id="4171434">int</span><span class="op" id="4171437">)</span><br>
<span class="lineno"></span><span class="op" id="4171439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171442">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4171512">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="4171569">//</span><br>
<span class="lineno"></span><span class="comment" id="4171572">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="4171630">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4171683">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4171748">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="4171762">type</span>&nbsp;<span class="ident" id="4171767">Flusher</span>&nbsp;<span class="keyword" id="4171775">interface</span>&nbsp;<span class="op" id="4171785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171788">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171837">Flush</span><span class="op" id="4171842">(</span><span class="op" id="4171843">)</span><br>
<span class="lineno"></span><span class="op" id="4171845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4171848">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4171919">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4171967">type</span>&nbsp;<span class="ident" id="4171972">Hijacker</span>&nbsp;<span class="keyword" id="4171981">interface</span>&nbsp;<span class="op" id="4171991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4171994">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172047">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172101">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172152">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172205">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172235">Hijack</span><span class="op" id="4172241">(</span><span class="op" id="4172242">)</span>&nbsp;<span class="op" id="4172244">(</span><span class="ident" id="4172245"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4172248">.</span><span class="ident" id="4172249"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4172253">,</span>&nbsp;<span class="op" id="4172255">*</span><span class="ident" id="4172256"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4172261">.</span><span class="ident" id="4172262"><a href="/gostd/bufio/bufio.go.html#1370925">ReadWriter</a></span><span class="op" id="4172272">,</span>&nbsp;<span class="builtintype" id="4172274">error</span><span class="op" id="4172279">)</span><br>
<span class="lineno"></span><span class="op" id="4172281">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4172284">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4172355">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="4172420">//</span><br>
<span class="lineno"></span><span class="comment" id="4172423">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="4172493">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4172557">type</span>&nbsp;<span class="ident" id="4172562">CloseNotifier</span>&nbsp;<span class="keyword" id="4172576">interface</span>&nbsp;<span class="op" id="4172586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172589">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172652">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172698">CloseNotify</span><span class="op" id="4172709">(</span><span class="op" id="4172710">)</span>&nbsp;<span class="op" id="4172712">&lt;-</span><span class="keyword" id="4172714">chan</span>&nbsp;<span class="builtintype" id="4172719">bool</span><br>
<span class="lineno">110</span><span class="op" id="4172724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4172727">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4172787">type</span>&nbsp;<span class="ident" id="4172792">conn</span>&nbsp;<span class="keyword" id="4172797">struct</span>&nbsp;<span class="op" id="4172804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172807">remoteAddr</span>&nbsp;<span class="builtintype" id="4172818">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172839">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172874">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4172885">*</span><span class="ident" id="4172886"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172906">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172953">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172964"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4172967">.</span><span class="ident" id="4172968"><a href="/gostd/net/net.go.html#3334417">Conn</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4172985">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173004">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173015"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4173017">.</span><span class="ident" id="4173018"><a href="/gostd/io/io.go.html#1422314">Writer</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173036">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173097">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4173108">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173129">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173157">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173168"><a href="/gostd/net/http/server.go.html#4175293">liveSwitchReader</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173189">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173243">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173254">*</span><span class="ident" id="4173255"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4173257">.</span><span class="ident" id="4173258"><a href="/gostd/io/io.go.html#1432050">LimitedReader</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173275">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173298">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173309">*</span><span class="ident" id="4173310"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4173315">.</span><span class="ident" id="4173316"><a href="/gostd/bufio/bufio.go.html#1370925">ReadWriter</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173330">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173393">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4173404">*</span><span class="ident" id="4173405"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4173408">.</span><span class="ident" id="4173409"><a href="/gostd/crypto/tls/common.go.html#4446494">ConnectionState</a></span>&nbsp;<span class="comment" id="4173425">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173456">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173469"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4173473">.</span><span class="ident" id="4173474"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span>&nbsp;<span class="comment" id="4173480">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173505">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4173518">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173529">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173572">closeNotifyc</span>&nbsp;<span class="keyword" id="4173585">chan</span>&nbsp;<span class="builtintype" id="4173590">bool</span>&nbsp;&nbsp;<span class="comment" id="4173596">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173612">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4173625">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173636">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="4173679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4173682">func</span>&nbsp;<span class="op" id="4173687">(</span><span class="ident" id="4173688">c</span>&nbsp;<span class="op" id="4173690">*</span><span class="ident" id="4173691"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4173695">)</span>&nbsp;<span class="ident" id="4173697">hijacked</span><span class="op" id="4173705">(</span><span class="op" id="4173706">)</span>&nbsp;<span class="builtintype" id="4173708">bool</span>&nbsp;<span class="op" id="4173713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173716"><a href="/gostd/net/http/server.go.html#4173688">c</a></span><span class="op" id="4173717">.</span><span class="ident" id="4173718"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4173720">.</span><span class="ident" id="4173721"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4173725">(</span><span class="op" id="4173726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173729">defer</span>&nbsp;<span class="ident" id="4173735"><a href="/gostd/net/http/server.go.html#4173688">c</a></span><span class="op" id="4173736">.</span><span class="ident" id="4173737"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4173739">.</span><span class="ident" id="4173740"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4173746">(</span><span class="op" id="4173747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173750">return</span>&nbsp;<span class="ident" id="4173757"><a href="/gostd/net/http/server.go.html#4173688">c</a></span><span class="op" id="4173758">.</span><span class="ident" id="4173759"><a href="/gostd/net/http/server.go.html#4173612">hijackedv</a></span><br>
<span class="lineno"></span><span class="op" id="4173769">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="4173772">func</span>&nbsp;<span class="op" id="4173777">(</span><span class="ident" id="4173778">c</span>&nbsp;<span class="op" id="4173780">*</span><span class="ident" id="4173781"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4173785">)</span>&nbsp;<span class="ident" id="4173787">hijack</span><span class="op" id="4173793">(</span><span class="op" id="4173794">)</span>&nbsp;<span class="op" id="4173796">(</span><span class="ident" id="4173797">rwc</span>&nbsp;<span class="ident" id="4173801"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4173804">.</span><span class="ident" id="4173805"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4173809">,</span>&nbsp;<span class="ident" id="4173811">buf</span>&nbsp;<span class="op" id="4173815">*</span><span class="ident" id="4173816"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4173821">.</span><span class="ident" id="4173822"><a href="/gostd/bufio/bufio.go.html#1370925">ReadWriter</a></span><span class="op" id="4173832">,</span>&nbsp;<span class="ident" id="4173834">err</span>&nbsp;<span class="builtintype" id="4173838">error</span><span class="op" id="4173843">)</span>&nbsp;<span class="op" id="4173845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173848"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4173849">.</span><span class="ident" id="4173850"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4173852">.</span><span class="ident" id="4173853"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4173857">(</span><span class="op" id="4173858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173861">defer</span>&nbsp;<span class="ident" id="4173867"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4173868">.</span><span class="ident" id="4173869"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4173871">.</span><span class="ident" id="4173872"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4173878">(</span><span class="op" id="4173879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173882">if</span>&nbsp;<span class="ident" id="4173885"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4173886">.</span><span class="ident" id="4173887"><a href="/gostd/net/http/server.go.html#4173612">hijackedv</a></span>&nbsp;<span class="op" id="4173897">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173901">return</span>&nbsp;<span class="builtintype" id="4173908">nil</span><span class="op" id="4173911">,</span>&nbsp;<span class="builtintype" id="4173913">nil</span><span class="op" id="4173916">,</span>&nbsp;<span class="ident" id="4173918"><a href="/gostd/net/http/server.go.html#4169659">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173934">if</span>&nbsp;<span class="ident" id="4173937"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4173938">.</span><span class="ident" id="4173939"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span>&nbsp;<span class="op" id="4173952">!=</span>&nbsp;<span class="builtintype" id="4173955">nil</span>&nbsp;<span class="op" id="4173959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173963">return</span>&nbsp;<span class="builtintype" id="4173970">nil</span><span class="op" id="4173973">,</span>&nbsp;<span class="builtintype" id="4173975">nil</span><span class="op" id="4173978">,</span>&nbsp;<span class="ident" id="4173980"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4173986">.</span><span class="ident" id="4173987"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4173990">(</span><span class="string" id="4173991">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="4174047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174050">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174053"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174054">.</span><span class="ident" id="4174055"><a href="/gostd/net/http/server.go.html#4173612">hijackedv</a></span>&nbsp;<span class="op" id="4174065">=</span>&nbsp;<span class="builtintype" id="4174067">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174073"><a href="/gostd/net/http/server.go.html#4173797">rwc</a></span>&nbsp;<span class="op" id="4174077">=</span>&nbsp;<span class="ident" id="4174079"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174080">.</span><span class="ident" id="4174081"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174086"><a href="/gostd/net/http/server.go.html#4173811">buf</a></span>&nbsp;<span class="op" id="4174090">=</span>&nbsp;<span class="ident" id="4174092"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174093">.</span><span class="ident" id="4174094"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174099"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174100">.</span><span class="ident" id="4174101"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="op" id="4174105">=</span>&nbsp;<span class="builtintype" id="4174107">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174112"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174113">.</span><span class="ident" id="4174114"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span>&nbsp;<span class="op" id="4174118">=</span>&nbsp;<span class="builtintype" id="4174120">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174125"><a href="/gostd/net/http/server.go.html#4173778">c</a></span><span class="op" id="4174126">.</span><span class="ident" id="4174127"><a href="/gostd/net/http/server.go.html#4201256">setState</a></span><span class="op" id="4174135">(</span><span class="ident" id="4174136"><a href="/gostd/net/http/server.go.html#4173797">rwc</a></span><span class="op" id="4174139">,</span>&nbsp;<span class="ident" id="4174141"><a href="/gostd/net/http/server.go.html#4219141">StateHijacked</a></span><span class="op" id="4174154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174157">return</span><br>
<span class="lineno"></span><span class="op" id="4174164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4174167">func</span>&nbsp;<span class="op" id="4174172">(</span><span class="ident" id="4174173">c</span>&nbsp;<span class="op" id="4174175">*</span><span class="ident" id="4174176"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4174180">)</span>&nbsp;<span class="ident" id="4174182">closeNotify</span><span class="op" id="4174193">(</span><span class="op" id="4174194">)</span>&nbsp;<span class="op" id="4174196">&lt;-</span><span class="keyword" id="4174198">chan</span>&nbsp;<span class="builtintype" id="4174203">bool</span>&nbsp;<span class="op" id="4174208">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174211"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174212">.</span><span class="ident" id="4174213"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4174215">.</span><span class="ident" id="4174216"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4174220">(</span><span class="op" id="4174221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174224">defer</span>&nbsp;<span class="ident" id="4174230"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174231">.</span><span class="ident" id="4174232"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4174234">.</span><span class="ident" id="4174235"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4174241">(</span><span class="op" id="4174242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174245">if</span>&nbsp;<span class="ident" id="4174248"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174249">.</span><span class="ident" id="4174250"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span>&nbsp;<span class="op" id="4174263">==</span>&nbsp;<span class="builtintype" id="4174266">nil</span>&nbsp;<span class="op" id="4174270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174274"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174275">.</span><span class="ident" id="4174276"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span>&nbsp;<span class="op" id="4174289">=</span>&nbsp;<span class="builtinfunc" id="4174291">make</span><span class="op" id="4174295">(</span><span class="keyword" id="4174296">chan</span>&nbsp;<span class="builtintype" id="4174301">bool</span><span class="op" id="4174305">,</span>&nbsp;<span class="num" id="4174307">1</span><span class="op" id="4174308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174312">if</span>&nbsp;<span class="ident" id="4174315"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174316">.</span><span class="ident" id="4174317"><a href="/gostd/net/http/server.go.html#4173612">hijackedv</a></span>&nbsp;<span class="op" id="4174327">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4174332">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4174382">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174417">return</span>&nbsp;<span class="ident" id="4174424"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174425">.</span><span class="ident" id="4174426"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174445">pr</span><span class="op" id="4174447">,</span>&nbsp;<span class="ident" id="4174449">pw</span>&nbsp;<span class="op" id="4174452">:=</span>&nbsp;<span class="ident" id="4174455"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4174457">.</span><span class="ident" id="4174458"><a href="/gostd/io/pipe.go.html#1440333">Pipe</a></span><span class="op" id="4174462">(</span><span class="op" id="4174463">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174468">readSource</span>&nbsp;<span class="op" id="4174479">:=</span>&nbsp;<span class="ident" id="4174482"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174483">.</span><span class="ident" id="4174484"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span><span class="op" id="4174486">.</span><span class="ident" id="4174487"><a href="/gostd/net/http/server.go.html#4175332">r</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174491"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174492">.</span><span class="ident" id="4174493"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span><span class="op" id="4174495">.</span><span class="ident" id="4174496"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4174500">(</span><span class="op" id="4174501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174505"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174506">.</span><span class="ident" id="4174507"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span><span class="op" id="4174509">.</span><span class="ident" id="4174510"><a href="/gostd/net/http/server.go.html#4175332">r</a></span>&nbsp;<span class="op" id="4174512">=</span>&nbsp;<span class="ident" id="4174514"><a href="/gostd/net/http/server.go.html#4174445">pr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174519"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174520">.</span><span class="ident" id="4174521"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span><span class="op" id="4174523">.</span><span class="ident" id="4174524"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4174530">(</span><span class="op" id="4174531">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174535">go</span>&nbsp;<span class="keyword" id="4174538">func</span><span class="op" id="4174542">(</span><span class="op" id="4174543">)</span>&nbsp;<span class="op" id="4174545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174550">_</span><span class="op" id="4174551">,</span>&nbsp;<span class="ident" id="4174553">err</span>&nbsp;<span class="op" id="4174557">:=</span>&nbsp;<span class="ident" id="4174560"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4174562">.</span><span class="ident" id="4174563"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="4174567">(</span><span class="ident" id="4174568"><a href="/gostd/net/http/server.go.html#4174449">pw</a></span><span class="op" id="4174570">,</span>&nbsp;<span class="ident" id="4174572"><a href="/gostd/net/http/server.go.html#4174468">readSource</a></span><span class="op" id="4174582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174587">if</span>&nbsp;<span class="ident" id="4174590"><a href="/gostd/net/http/server.go.html#4174553">err</a></span>&nbsp;<span class="op" id="4174594">==</span>&nbsp;<span class="builtintype" id="4174597">nil</span>&nbsp;<span class="op" id="4174601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174607"><a href="/gostd/net/http/server.go.html#4174553">err</a></span>&nbsp;<span class="op" id="4174611">=</span>&nbsp;<span class="ident" id="4174613"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4174615">.</span><span class="ident" id="4174616"><a href="/gostd/io/io.go.html#1419950">EOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174623">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174628"><a href="/gostd/net/http/server.go.html#4174449">pw</a></span><span class="op" id="4174630">.</span><span class="ident" id="4174631"><a href="/gostd/io/pipe.go.html#1439738">CloseWithError</a></span><span class="op" id="4174645">(</span><span class="ident" id="4174646"><a href="/gostd/net/http/server.go.html#4174553">err</a></span><span class="op" id="4174649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174654"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174655">.</span><span class="ident" id="4174656"><a href="/gostd/net/http/server.go.html#4174723">noteClientGone</a></span><span class="op" id="4174670">(</span><span class="op" id="4174671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174675">}</span><span class="op" id="4174676">(</span><span class="op" id="4174677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174683">return</span>&nbsp;<span class="ident" id="4174690"><a href="/gostd/net/http/server.go.html#4174173">c</a></span><span class="op" id="4174691">.</span><span class="ident" id="4174692"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span><br>
<span class="lineno">180</span><span class="op" id="4174705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4174708">func</span>&nbsp;<span class="op" id="4174713">(</span><span class="ident" id="4174714">c</span>&nbsp;<span class="op" id="4174716">*</span><span class="ident" id="4174717"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4174721">)</span>&nbsp;<span class="ident" id="4174723">noteClientGone</span><span class="op" id="4174737">(</span><span class="op" id="4174738">)</span>&nbsp;<span class="op" id="4174740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174743"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174744">.</span><span class="ident" id="4174745"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4174747">.</span><span class="ident" id="4174748"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4174752">(</span><span class="op" id="4174753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174756">defer</span>&nbsp;<span class="ident" id="4174762"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174763">.</span><span class="ident" id="4174764"><a href="/gostd/net/http/server.go.html#4173456">mu</a></span><span class="op" id="4174766">.</span><span class="ident" id="4174767"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4174773">(</span><span class="op" id="4174774">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174777">if</span>&nbsp;<span class="ident" id="4174780"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174781">.</span><span class="ident" id="4174782"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span>&nbsp;<span class="op" id="4174795">!=</span>&nbsp;<span class="builtintype" id="4174798">nil</span>&nbsp;<span class="op" id="4174802">&amp;&amp;</span>&nbsp;<span class="op" id="4174805">!</span><span class="ident" id="4174806"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174807">.</span><span class="ident" id="4174808"><a href="/gostd/net/http/server.go.html#4173505">clientGone</a></span>&nbsp;<span class="op" id="4174819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174823"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174824">.</span><span class="ident" id="4174825"><a href="/gostd/net/http/server.go.html#4173572">closeNotifyc</a></span>&nbsp;<span class="op" id="4174838">&lt;-</span>&nbsp;<span class="builtintype" id="4174841">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174850"><a href="/gostd/net/http/server.go.html#4174714">c</a></span><span class="op" id="4174851">.</span><span class="ident" id="4174852"><a href="/gostd/net/http/server.go.html#4173505">clientGone</a></span>&nbsp;<span class="op" id="4174863">=</span>&nbsp;<span class="builtintype" id="4174865">true</span><br>
<span class="lineno"></span><span class="op" id="4174870">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4174873">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4174931">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4174983">type</span>&nbsp;<span class="ident" id="4174988">switchReader</span>&nbsp;<span class="keyword" id="4175001">struct</span>&nbsp;<span class="op" id="4175008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175011"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4175013">.</span><span class="ident" id="4175014"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><br>
<span class="lineno">195</span><span class="op" id="4175021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4175024">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4175082">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4175135">type</span>&nbsp;<span class="ident" id="4175140">switchWriter</span>&nbsp;<span class="keyword" id="4175153">struct</span>&nbsp;<span class="op" id="4175160">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175163"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4175165">.</span><span class="ident" id="4175166"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><br>
<span class="lineno"></span><span class="op" id="4175173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4175176">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="4175243">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="4175288">type</span>&nbsp;<span class="ident" id="4175293">liveSwitchReader</span>&nbsp;<span class="keyword" id="4175310">struct</span>&nbsp;<span class="op" id="4175317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175320"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4175324">.</span><span class="ident" id="4175325"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175332">r</span>&nbsp;<span class="ident" id="4175334"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4175336">.</span><span class="ident" id="4175337"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><br>
<span class="lineno"></span><span class="op" id="4175344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="4175347">func</span>&nbsp;<span class="op" id="4175352">(</span><span class="ident" id="4175353">sr</span>&nbsp;<span class="op" id="4175356">*</span><span class="ident" id="4175357"><a href="/gostd/net/http/server.go.html#4175293">liveSwitchReader</a></span><span class="op" id="4175373">)</span>&nbsp;<span class="ident" id="4175375">Read</span><span class="op" id="4175379">(</span><span class="ident" id="4175380">p</span>&nbsp;<span class="op" id="4175382">[</span><span class="op" id="4175383">]</span><span class="builtintype" id="4175384">byte</span><span class="op" id="4175388">)</span>&nbsp;<span class="op" id="4175390">(</span><span class="ident" id="4175391">n</span>&nbsp;<span class="builtintype" id="4175393">int</span><span class="op" id="4175396">,</span>&nbsp;<span class="ident" id="4175398">err</span>&nbsp;<span class="builtintype" id="4175402">error</span><span class="op" id="4175407">)</span>&nbsp;<span class="op" id="4175409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175412"><a href="/gostd/net/http/server.go.html#4175353">sr</a></span><span class="op" id="4175414">.</span><span class="ident" id="4175415"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4175419">(</span><span class="op" id="4175420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175423">r</span>&nbsp;<span class="op" id="4175425">:=</span>&nbsp;<span class="ident" id="4175428"><a href="/gostd/net/http/server.go.html#4175353">sr</a></span><span class="op" id="4175430">.</span><span class="ident" id="4175431"><a href="/gostd/net/http/server.go.html#4175332">r</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175434"><a href="/gostd/net/http/server.go.html#4175353">sr</a></span><span class="op" id="4175436">.</span><span class="ident" id="4175437"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4175443">(</span><span class="op" id="4175444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175447">return</span>&nbsp;<span class="ident" id="4175454"><a href="/gostd/net/http/server.go.html#4175423">r</a></span><span class="op" id="4175455">.</span><span class="ident" id="4175456"><a href="/gostd/io/io.go.html#1421843">Read</a></span><span class="op" id="4175460">(</span><span class="ident" id="4175461"><a href="/gostd/net/http/server.go.html#4175380">p</a></span><span class="op" id="4175462">)</span><br>
<span class="lineno">215</span><span class="op" id="4175464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4175467">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="4175521">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="4175563">const</span>&nbsp;<span class="ident" id="4175569">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="4175594">=</span>&nbsp;<span class="num" id="4175596">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4175602">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="4175671">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4175720">//</span><br>
<span class="lineno"></span><span class="comment" id="4175723">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="4175795">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="4175866">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4175938">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="4176012">//</span><br>
<span class="lineno"></span><span class="comment" id="4176015">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="4176085">type</span>&nbsp;<span class="ident" id="4176090">chunkWriter</span>&nbsp;<span class="keyword" id="4176102">struct</span>&nbsp;<span class="op" id="4176109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176112">res</span>&nbsp;<span class="op" id="4176116">*</span><span class="ident" id="4176117"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176128">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176190">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176248">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176306">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176346">header</span>&nbsp;<span class="ident" id="4176353"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176362">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176426">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176476">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176537">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176560">wroteHeader</span>&nbsp;<span class="builtintype" id="4176572">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176579">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176614">chunking</span>&nbsp;<span class="builtintype" id="4176623">bool</span>&nbsp;<span class="comment" id="4176628">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="4176678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4176681">var</span>&nbsp;<span class="op" id="4176685">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176688">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176699">=</span>&nbsp;<span class="op" id="4176701">[</span><span class="op" id="4176702">]</span><span class="builtintype" id="4176703">byte</span><span class="op" id="4176707">(</span><span class="string" id="4176708">&#34;\r\n&#34;</span><span class="op" id="4176714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176717">colonSpace</span>&nbsp;<span class="op" id="4176728">=</span>&nbsp;<span class="op" id="4176730">[</span><span class="op" id="4176731">]</span><span class="builtintype" id="4176732">byte</span><span class="op" id="4176736">(</span><span class="string" id="4176737">&#34;:&nbsp;&#34;</span><span class="op" id="4176741">)</span><br>
<span class="lineno"></span><span class="op" id="4176743">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4176746">func</span>&nbsp;<span class="op" id="4176751">(</span><span class="ident" id="4176752">cw</span>&nbsp;<span class="op" id="4176755">*</span><span class="ident" id="4176756"><a href="/gostd/net/http/server.go.html#4176090">chunkWriter</a></span><span class="op" id="4176767">)</span>&nbsp;<span class="ident" id="4176769">Write</span><span class="op" id="4176774">(</span><span class="ident" id="4176775">p</span>&nbsp;<span class="op" id="4176777">[</span><span class="op" id="4176778">]</span><span class="builtintype" id="4176779">byte</span><span class="op" id="4176783">)</span>&nbsp;<span class="op" id="4176785">(</span><span class="ident" id="4176786">n</span>&nbsp;<span class="builtintype" id="4176788">int</span><span class="op" id="4176791">,</span>&nbsp;<span class="ident" id="4176793">err</span>&nbsp;<span class="builtintype" id="4176797">error</span><span class="op" id="4176802">)</span>&nbsp;<span class="op" id="4176804">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176807">if</span>&nbsp;<span class="op" id="4176810">!</span><span class="ident" id="4176811"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4176813">.</span><span class="ident" id="4176814"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4176826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176830"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4176832">.</span><span class="ident" id="4176833"><a href="/gostd/net/http/server.go.html#4189133">writeHeader</a></span><span class="op" id="4176844">(</span><span class="ident" id="4176845"><a href="/gostd/net/http/server.go.html#4176775">p</a></span><span class="op" id="4176846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176852">if</span>&nbsp;<span class="ident" id="4176855"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4176857">.</span><span class="ident" id="4176858"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4176861">.</span><span class="ident" id="4176862"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4176865">.</span><span class="ident" id="4176866"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4176873">==</span>&nbsp;<span class="string" id="4176876">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4176883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176887">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176904">return</span>&nbsp;<span class="builtinfunc" id="4176911">len</span><span class="op" id="4176914">(</span><span class="ident" id="4176915"><a href="/gostd/net/http/server.go.html#4176775">p</a></span><span class="op" id="4176916">)</span><span class="op" id="4176917">,</span>&nbsp;<span class="builtintype" id="4176919">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176927">if</span>&nbsp;<span class="ident" id="4176930"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4176932">.</span><span class="ident" id="4176933"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4176942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176946">_</span><span class="op" id="4176947">,</span>&nbsp;<span class="ident" id="4176949"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4176953">=</span>&nbsp;<span class="ident" id="4176955"><a href="/gostd/net/http/server.go.html#4169313">fmt</a></span><span class="op" id="4176958">.</span><span class="ident" id="4176959"><a href="/gostd/fmt/print.go.html#2143118">Fprintf</a></span><span class="op" id="4176966">(</span><span class="ident" id="4176967"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4176969">.</span><span class="ident" id="4176970"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4176973">.</span><span class="ident" id="4176974"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4176978">.</span><span class="ident" id="4176979"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4176982">,</span>&nbsp;<span class="string" id="4176984">&#34;%x\r\n&#34;</span><span class="op" id="4176992">,</span>&nbsp;<span class="builtinfunc" id="4176994">len</span><span class="op" id="4176997">(</span><span class="ident" id="4176998"><a href="/gostd/net/http/server.go.html#4176775">p</a></span><span class="op" id="4176999">)</span><span class="op" id="4177000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177004">if</span>&nbsp;<span class="ident" id="4177007"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4177011">!=</span>&nbsp;<span class="builtintype" id="4177014">nil</span>&nbsp;<span class="op" id="4177018">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177023"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4177025">.</span><span class="ident" id="4177026"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177029">.</span><span class="ident" id="4177030"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177034">.</span><span class="ident" id="4177035"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4177038">.</span><span class="ident" id="4177039"><a href="/gostd/net/net.go.html#3334987">Close</a></span><span class="op" id="4177044">(</span><span class="op" id="4177045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177050">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177065"><a href="/gostd/net/http/server.go.html#4176786">n</a></span><span class="op" id="4177066">,</span>&nbsp;<span class="ident" id="4177068"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4177072">=</span>&nbsp;<span class="ident" id="4177074"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4177076">.</span><span class="ident" id="4177077"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177080">.</span><span class="ident" id="4177081"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177085">.</span><span class="ident" id="4177086"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4177089">.</span><span class="ident" id="4177090"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4177095">(</span><span class="ident" id="4177096"><a href="/gostd/net/http/server.go.html#4176775">p</a></span><span class="op" id="4177097">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177100">if</span>&nbsp;<span class="ident" id="4177103"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4177105">.</span><span class="ident" id="4177106"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4177115">&amp;&amp;</span>&nbsp;<span class="ident" id="4177118"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4177122">==</span>&nbsp;<span class="builtintype" id="4177125">nil</span>&nbsp;<span class="op" id="4177129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177133">_</span><span class="op" id="4177134">,</span>&nbsp;<span class="ident" id="4177136"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4177140">=</span>&nbsp;<span class="ident" id="4177142"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4177144">.</span><span class="ident" id="4177145"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177148">.</span><span class="ident" id="4177149"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177153">.</span><span class="ident" id="4177154"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4177157">.</span><span class="ident" id="4177158"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4177163">(</span><span class="ident" id="4177164"><a href="/gostd/net/http/server.go.html#4176688">crlf</a></span><span class="op" id="4177168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177174">if</span>&nbsp;<span class="ident" id="4177177"><a href="/gostd/net/http/server.go.html#4176793">err</a></span>&nbsp;<span class="op" id="4177181">!=</span>&nbsp;<span class="builtintype" id="4177184">nil</span>&nbsp;<span class="op" id="4177188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177192"><a href="/gostd/net/http/server.go.html#4176752">cw</a></span><span class="op" id="4177194">.</span><span class="ident" id="4177195"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177198">.</span><span class="ident" id="4177199"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177203">.</span><span class="ident" id="4177204"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4177207">.</span><span class="ident" id="4177208"><a href="/gostd/net/net.go.html#3334987">Close</a></span><span class="op" id="4177213">(</span><span class="op" id="4177214">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177220">return</span><br>
<span class="lineno"></span><span class="op" id="4177227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4177230">func</span>&nbsp;<span class="op" id="4177235">(</span><span class="ident" id="4177236">cw</span>&nbsp;<span class="op" id="4177239">*</span><span class="ident" id="4177240"><a href="/gostd/net/http/server.go.html#4176090">chunkWriter</a></span><span class="op" id="4177251">)</span>&nbsp;<span class="ident" id="4177253">flush</span><span class="op" id="4177258">(</span><span class="op" id="4177259">)</span>&nbsp;<span class="op" id="4177261">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177264">if</span>&nbsp;<span class="op" id="4177267">!</span><span class="ident" id="4177268"><a href="/gostd/net/http/server.go.html#4177236">cw</a></span><span class="op" id="4177270">.</span><span class="ident" id="4177271"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4177283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177287"><a href="/gostd/net/http/server.go.html#4177236">cw</a></span><span class="op" id="4177289">.</span><span class="ident" id="4177290"><a href="/gostd/net/http/server.go.html#4189133">writeHeader</a></span><span class="op" id="4177301">(</span><span class="builtintype" id="4177302">nil</span><span class="op" id="4177305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177311"><a href="/gostd/net/http/server.go.html#4177236">cw</a></span><span class="op" id="4177313">.</span><span class="ident" id="4177314"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177317">.</span><span class="ident" id="4177318"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177322">.</span><span class="ident" id="4177323"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4177326">.</span><span class="ident" id="4177327"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4177332">(</span><span class="op" id="4177333">)</span><br>
<span class="lineno"></span><span class="op" id="4177335">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="4177338">func</span>&nbsp;<span class="op" id="4177343">(</span><span class="ident" id="4177344">cw</span>&nbsp;<span class="op" id="4177347">*</span><span class="ident" id="4177348"><a href="/gostd/net/http/server.go.html#4176090">chunkWriter</a></span><span class="op" id="4177359">)</span>&nbsp;<span class="builtinfunc" id="4177361">close</span><span class="op" id="4177366">(</span><span class="op" id="4177367">)</span>&nbsp;<span class="op" id="4177369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177372">if</span>&nbsp;<span class="op" id="4177375">!</span><span class="ident" id="4177376"><a href="/gostd/net/http/server.go.html#4177344">cw</a></span><span class="op" id="4177378">.</span><span class="ident" id="4177379"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4177391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177395"><a href="/gostd/net/http/server.go.html#4177344">cw</a></span><span class="op" id="4177397">.</span><span class="ident" id="4177398"><a href="/gostd/net/http/server.go.html#4189133">writeHeader</a></span><span class="op" id="4177409">(</span><span class="builtintype" id="4177410">nil</span><span class="op" id="4177413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177416">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4177419">if</span>&nbsp;<span class="ident" id="4177422"><a href="/gostd/net/http/server.go.html#4177344">cw</a></span><span class="op" id="4177424">.</span><span class="ident" id="4177425"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4177434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177438">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177494">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177548">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177559"><a href="/gostd/net/http/server.go.html#4177344">cw</a></span><span class="op" id="4177561">.</span><span class="ident" id="4177562"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4177565">.</span><span class="ident" id="4177566"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4177570">.</span><span class="ident" id="4177571"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4177574">.</span><span class="ident" id="4177575"><a href="/gostd/bufio/bufio.go.html#1369779">WriteString</a></span><span class="op" id="4177586">(</span><span class="string" id="4177587">&#34;0\r\n\r\n&#34;</span><span class="op" id="4177598">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177601">}</span><br>
<span class="lineno"></span><span class="op" id="4177603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4177606">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4177668">type</span>&nbsp;<span class="ident" id="4177673">response</span>&nbsp;<span class="keyword" id="4177682">struct</span>&nbsp;<span class="op" id="4177689">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177692">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177706">*</span><span class="ident" id="4177707"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177713">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177727">*</span><span class="ident" id="4177728"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span>&nbsp;<span class="comment" id="4177736">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177766">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4177780">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177789">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177835">wroteContinue</span>&nbsp;<span class="builtintype" id="4177849">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177858">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177897">w</span>&nbsp;&nbsp;<span class="op" id="4177900">*</span><span class="ident" id="4177901"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4177906">.</span><span class="ident" id="4177907"><a href="/gostd/bufio/bufio.go.html#1366565">Writer</a></span>&nbsp;<span class="comment" id="4177914">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177958">cw</span>&nbsp;<span class="ident" id="4177961"><a href="/gostd/net/http/server.go.html#4176090">chunkWriter</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177974">sw</span>&nbsp;<span class="op" id="4177977">*</span><span class="ident" id="4177978"><a href="/gostd/net/http/server.go.html#4175140">switchWriter</a></span>&nbsp;<span class="comment" id="4177991">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178046">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178107">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178169">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178227">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178271">handlerHeader</span>&nbsp;<span class="ident" id="4178285"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178293">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="4178307">bool</span>&nbsp;<span class="comment" id="4178312">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178359">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4178373">int64</span>&nbsp;<span class="comment" id="4178379">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178415">contentLength</span>&nbsp;<span class="builtintype" id="4178429">int64</span>&nbsp;<span class="comment" id="4178435">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178481">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4178495">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4178501">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178540">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178599">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178652">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178703">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178723">closeAfterReply</span>&nbsp;<span class="builtintype" id="4178739">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178746">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178801">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178856">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178907">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178969">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179025">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179085">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179104">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="4179124">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179131">handlerDone</span>&nbsp;<span class="builtintype" id="4179143">bool</span>&nbsp;<span class="comment" id="4179148">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179185">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179225">dateBuf</span>&nbsp;<span class="op" id="4179233">[</span><span class="builtinfunc" id="4179234">len</span><span class="op" id="4179237">(</span><span class="ident" id="4179238"><a href="/gostd/net/http/server.go.html#4184253">TimeFormat</a></span><span class="op" id="4179248">)</span><span class="op" id="4179249">]</span><span class="builtintype" id="4179250">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179256">clenBuf</span>&nbsp;<span class="op" id="4179264">[</span><span class="num" id="4179265">10</span><span class="op" id="4179267">]</span><span class="builtintype" id="4179268">byte</span><br>
<span class="lineno">340</span><span class="op" id="4179273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179276">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4179347">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4179377">func</span>&nbsp;<span class="op" id="4179382">(</span><span class="ident" id="4179383">w</span>&nbsp;<span class="op" id="4179385">*</span><span class="ident" id="4179386"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4179394">)</span>&nbsp;<span class="ident" id="4179396">requestTooLarge</span><span class="op" id="4179411">(</span><span class="op" id="4179412">)</span>&nbsp;<span class="op" id="4179414">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179417"><a href="/gostd/net/http/server.go.html#4179383">w</a></span><span class="op" id="4179418">.</span><span class="ident" id="4179419"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4179435">=</span>&nbsp;<span class="builtintype" id="4179437">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179443"><a href="/gostd/net/http/server.go.html#4179383">w</a></span><span class="op" id="4179444">.</span><span class="ident" id="4179445"><a href="/gostd/net/http/server.go.html#4179104">requestBodyLimitHit</a></span>&nbsp;<span class="op" id="4179465">=</span>&nbsp;<span class="builtintype" id="4179467">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4179473">if</span>&nbsp;<span class="op" id="4179476">!</span><span class="ident" id="4179477"><a href="/gostd/net/http/server.go.html#4179383">w</a></span><span class="op" id="4179478">.</span><span class="ident" id="4179479"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4179491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179495"><a href="/gostd/net/http/server.go.html#4179383">w</a></span><span class="op" id="4179496">.</span><span class="ident" id="4179497"><a href="/gostd/net/http/server.go.html#4185881">Header</a></span><span class="op" id="4179503">(</span><span class="op" id="4179504">)</span><span class="op" id="4179505">.</span><span class="ident" id="4179506"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4179509">(</span><span class="string" id="4179510">&#34;Connection&#34;</span><span class="op" id="4179522">,</span>&nbsp;<span class="string" id="4179524">&#34;close&#34;</span><span class="op" id="4179531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4179534">}</span><br>
<span class="lineno">350</span><span class="op" id="4179536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179539">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="4179611">func</span>&nbsp;<span class="op" id="4179616">(</span><span class="ident" id="4179617">w</span>&nbsp;<span class="op" id="4179619">*</span><span class="ident" id="4179620"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4179628">)</span>&nbsp;<span class="ident" id="4179630">needsSniff</span><span class="op" id="4179640">(</span><span class="op" id="4179641">)</span>&nbsp;<span class="builtintype" id="4179643">bool</span>&nbsp;<span class="op" id="4179648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179651">_</span><span class="op" id="4179652">,</span>&nbsp;<span class="ident" id="4179654">haveType</span>&nbsp;<span class="op" id="4179663">:=</span>&nbsp;<span class="ident" id="4179666"><a href="/gostd/net/http/server.go.html#4179617">w</a></span><span class="op" id="4179667">.</span><span class="ident" id="4179668"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4179681">[</span><span class="string" id="4179682">&#34;Content-Type&#34;</span><span class="op" id="4179696">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4179699">return</span>&nbsp;<span class="op" id="4179706">!</span><span class="ident" id="4179707"><a href="/gostd/net/http/server.go.html#4179617">w</a></span><span class="op" id="4179708">.</span><span class="ident" id="4179709"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4179711">.</span><span class="ident" id="4179712"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4179724">&amp;&amp;</span>&nbsp;<span class="op" id="4179727">!</span><span class="ident" id="4179728"><a href="/gostd/net/http/server.go.html#4179654">haveType</a></span>&nbsp;<span class="op" id="4179737">&amp;&amp;</span>&nbsp;<span class="ident" id="4179740"><a href="/gostd/net/http/server.go.html#4179617">w</a></span><span class="op" id="4179741">.</span><span class="ident" id="4179742"><a href="/gostd/net/http/server.go.html#4178359">written</a></span>&nbsp;<span class="op" id="4179750">&lt;</span>&nbsp;<span class="ident" id="4179752"><a href="/gostd/net/http/sniff.go.html#4230912">sniffLen</a></span><br>
<span class="lineno"></span><span class="op" id="4179761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179764">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="4179830">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="4179847">type</span>&nbsp;<span class="ident" id="4179852">writerOnly</span>&nbsp;<span class="keyword" id="4179863">struct</span>&nbsp;<span class="op" id="4179870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179873"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4179875">.</span><span class="ident" id="4179876"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><br>
<span class="lineno"></span><span class="op" id="4179883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4179886">func</span>&nbsp;<span class="ident" id="4179891">srcIsRegularFile</span><span class="op" id="4179907">(</span><span class="ident" id="4179908">src</span>&nbsp;<span class="ident" id="4179912"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4179914">.</span><span class="ident" id="4179915"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><span class="op" id="4179921">)</span>&nbsp;<span class="op" id="4179923">(</span><span class="ident" id="4179924">isRegular</span>&nbsp;<span class="builtintype" id="4179934">bool</span><span class="op" id="4179938">,</span>&nbsp;<span class="ident" id="4179940">err</span>&nbsp;<span class="builtintype" id="4179944">error</span><span class="op" id="4179949">)</span>&nbsp;<span class="op" id="4179951">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4179954">switch</span>&nbsp;<span class="ident" id="4179961">v</span>&nbsp;<span class="op" id="4179963">:=</span>&nbsp;<span class="ident" id="4179966"><a href="/gostd/net/http/server.go.html#4179908">src</a></span><span class="op" id="4179969">.</span><span class="op" id="4179970">(</span><span class="keyword" id="4179971">type</span><span class="op" id="4179975">)</span>&nbsp;<span class="op" id="4179977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4179980">case</span>&nbsp;<span class="op" id="4179985">*</span><span class="ident" id="4179986"><a href="/gostd/net/http/server.go.html#4169364">os</a></span><span class="op" id="4179988">.</span><span class="ident" id="4179989"><a href="/gostd/os/file_unix.go.html#2452288">File</a></span><span class="op" id="4179993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179997">fi</span><span class="op" id="4179999">,</span>&nbsp;<span class="ident" id="4180001">err</span>&nbsp;<span class="op" id="4180005">:=</span>&nbsp;<span class="ident" id="4180008"><a href="/gostd/net/http/server.go.html#4179961">v</a></span><span class="op" id="4180009">.</span><span class="ident" id="4180010"><a href="/gostd/os/file_unix.go.html#2455146">Stat</a></span><span class="op" id="4180014">(</span><span class="op" id="4180015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180019">if</span>&nbsp;<span class="ident" id="4180022"><a href="/gostd/net/http/server.go.html#4180001">err</a></span>&nbsp;<span class="op" id="4180026">!=</span>&nbsp;<span class="builtintype" id="4180029">nil</span>&nbsp;<span class="op" id="4180033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180038">return</span>&nbsp;<span class="builtintype" id="4180045">false</span><span class="op" id="4180050">,</span>&nbsp;<span class="ident" id="4180052"><a href="/gostd/net/http/server.go.html#4180001">err</a></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180062">return</span>&nbsp;<span class="ident" id="4180069"><a href="/gostd/net/http/server.go.html#4179997">fi</a></span><span class="op" id="4180071">.</span><span class="ident" id="4180072"><a href="/gostd/os/types.go.html#2472615">Mode</a></span><span class="op" id="4180076">(</span><span class="op" id="4180077">)</span><span class="op" id="4180078">.</span><span class="ident" id="4180079"><a href="/gostd/os/types.go.html#2475321">IsRegular</a></span><span class="op" id="4180088">(</span><span class="op" id="4180089">)</span><span class="op" id="4180090">,</span>&nbsp;<span class="builtintype" id="4180092">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180097">case</span>&nbsp;<span class="op" id="4180102">*</span><span class="ident" id="4180103"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180105">.</span><span class="ident" id="4180106"><a href="/gostd/io/io.go.html#1432050">LimitedReader</a></span><span class="op" id="4180119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180123">return</span>&nbsp;<span class="ident" id="4180130"><a href="/gostd/net/http/server.go.html#4179891">srcIsRegularFile</a></span><span class="op" id="4180146">(</span><span class="ident" id="4180147"><a href="/gostd/net/http/server.go.html#4179961">v</a></span><span class="op" id="4180148">.</span><span class="ident" id="4180149"><a href="/gostd/io/io.go.html#1432074">R</a></span><span class="op" id="4180150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180153">default</span><span class="op" id="4180160">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180164">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180172">}</span><br>
<span class="lineno"></span><span class="op" id="4180174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4180177">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="4180247">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="4180283">func</span>&nbsp;<span class="op" id="4180288">(</span><span class="ident" id="4180289">w</span>&nbsp;<span class="op" id="4180291">*</span><span class="ident" id="4180292"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4180300">)</span>&nbsp;<span class="ident" id="4180302">ReadFrom</span><span class="op" id="4180310">(</span><span class="ident" id="4180311">src</span>&nbsp;<span class="ident" id="4180315"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180317">.</span><span class="ident" id="4180318"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><span class="op" id="4180324">)</span>&nbsp;<span class="op" id="4180326">(</span><span class="ident" id="4180327">n</span>&nbsp;<span class="builtintype" id="4180329">int64</span><span class="op" id="4180334">,</span>&nbsp;<span class="ident" id="4180336">err</span>&nbsp;<span class="builtintype" id="4180340">error</span><span class="op" id="4180345">)</span>&nbsp;<span class="op" id="4180347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180350">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180412">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180476">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180528">rf</span><span class="op" id="4180530">,</span>&nbsp;<span class="ident" id="4180532">ok</span>&nbsp;<span class="op" id="4180535">:=</span>&nbsp;<span class="ident" id="4180538"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180539">.</span><span class="ident" id="4180540"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4180544">.</span><span class="ident" id="4180545"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4180548">.</span><span class="op" id="4180549">(</span><span class="ident" id="4180550"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180552">.</span><span class="ident" id="4180553"><a href="/gostd/io/io.go.html#1424428">ReaderFrom</a></span><span class="op" id="4180563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180566">regFile</span><span class="op" id="4180573">,</span>&nbsp;<span class="ident" id="4180575"><a href="/gostd/net/http/server.go.html#4180336">err</a></span>&nbsp;<span class="op" id="4180579">:=</span>&nbsp;<span class="ident" id="4180582"><a href="/gostd/net/http/server.go.html#4179891">srcIsRegularFile</a></span><span class="op" id="4180598">(</span><span class="ident" id="4180599"><a href="/gostd/net/http/server.go.html#4180311">src</a></span><span class="op" id="4180602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180605">if</span>&nbsp;<span class="ident" id="4180608"><a href="/gostd/net/http/server.go.html#4180336">err</a></span>&nbsp;<span class="op" id="4180612">!=</span>&nbsp;<span class="builtintype" id="4180615">nil</span>&nbsp;<span class="op" id="4180619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180623">return</span>&nbsp;<span class="num" id="4180630">0</span><span class="op" id="4180631">,</span>&nbsp;<span class="ident" id="4180633"><a href="/gostd/net/http/server.go.html#4180336">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180638">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180641">if</span>&nbsp;<span class="op" id="4180644">!</span><span class="ident" id="4180645"><a href="/gostd/net/http/server.go.html#4180532">ok</a></span>&nbsp;<span class="op" id="4180648">||</span>&nbsp;<span class="op" id="4180651">!</span><span class="ident" id="4180652"><a href="/gostd/net/http/server.go.html#4180566">regFile</a></span>&nbsp;<span class="op" id="4180660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180664">return</span>&nbsp;<span class="ident" id="4180671"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180673">.</span><span class="ident" id="4180674"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="4180678">(</span><span class="ident" id="4180679"><a href="/gostd/net/http/server.go.html#4179852">writerOnly</a></span><span class="op" id="4180689">{</span><span class="ident" id="4180690"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180691">}</span><span class="op" id="4180692">,</span>&nbsp;<span class="ident" id="4180694"><a href="/gostd/net/http/server.go.html#4180311">src</a></span><span class="op" id="4180697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180704">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180724">if</span>&nbsp;<span class="op" id="4180727">!</span><span class="ident" id="4180728"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180729">.</span><span class="ident" id="4180730"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4180742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180746"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180747">.</span><span class="ident" id="4180748"><a href="/gostd/net/http/server.go.html#4186739">WriteHeader</a></span><span class="op" id="4180759">(</span><span class="ident" id="4180760"><a href="/gostd/net/http/status.go.html#4236210">StatusOK</a></span><span class="op" id="4180768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180775">if</span>&nbsp;<span class="ident" id="4180778"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180779">.</span><span class="ident" id="4180780"><a href="/gostd/net/http/server.go.html#4179630">needsSniff</a></span><span class="op" id="4180790">(</span><span class="op" id="4180791">)</span>&nbsp;<span class="op" id="4180793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180797">n0</span><span class="op" id="4180799">,</span>&nbsp;<span class="ident" id="4180801">err</span>&nbsp;<span class="op" id="4180805">:=</span>&nbsp;<span class="ident" id="4180808"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180810">.</span><span class="ident" id="4180811"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="4180815">(</span><span class="ident" id="4180816"><a href="/gostd/net/http/server.go.html#4179852">writerOnly</a></span><span class="op" id="4180826">{</span><span class="ident" id="4180827"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180828">}</span><span class="op" id="4180829">,</span>&nbsp;<span class="ident" id="4180831"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4180833">.</span><span class="ident" id="4180834"><a href="/gostd/io/io.go.html#1431815">LimitReader</a></span><span class="op" id="4180845">(</span><span class="ident" id="4180846"><a href="/gostd/net/http/server.go.html#4180311">src</a></span><span class="op" id="4180849">,</span>&nbsp;<span class="ident" id="4180851"><a href="/gostd/net/http/sniff.go.html#4230912">sniffLen</a></span><span class="op" id="4180859">)</span><span class="op" id="4180860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180864"><a href="/gostd/net/http/server.go.html#4180327">n</a></span>&nbsp;<span class="op" id="4180866">+=</span>&nbsp;<span class="ident" id="4180869"><a href="/gostd/net/http/server.go.html#4180797">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180874">if</span>&nbsp;<span class="ident" id="4180877"><a href="/gostd/net/http/server.go.html#4180801">err</a></span>&nbsp;<span class="op" id="4180881">!=</span>&nbsp;<span class="builtintype" id="4180884">nil</span>&nbsp;<span class="op" id="4180888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4180893">return</span>&nbsp;<span class="ident" id="4180900"><a href="/gostd/net/http/server.go.html#4180327">n</a></span><span class="op" id="4180901">,</span>&nbsp;<span class="ident" id="4180903"><a href="/gostd/net/http/server.go.html#4180801">err</a></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4180912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180916"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180917">.</span><span class="ident" id="4180918"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4180919">.</span><span class="ident" id="4180920"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4180925">(</span><span class="op" id="4180926">)</span>&nbsp;&nbsp;<span class="comment" id="4180929">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180964"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4180965">.</span><span class="ident" id="4180966"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4180968">.</span><span class="ident" id="4180969"><a href="/gostd/net/http/server.go.html#4177253">flush</a></span><span class="op" id="4180974">(</span><span class="op" id="4180975">)</span>&nbsp;<span class="comment" id="4180977">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4181029">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181109">if</span>&nbsp;<span class="op" id="4181112">!</span><span class="ident" id="4181113"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4181114">.</span><span class="ident" id="4181115"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4181117">.</span><span class="ident" id="4181118"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4181127">&amp;&amp;</span>&nbsp;<span class="ident" id="4181130"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4181131">.</span><span class="ident" id="4181132"><a href="/gostd/net/http/server.go.html#4195957">bodyAllowed</a></span><span class="op" id="4181143">(</span><span class="op" id="4181144">)</span>&nbsp;<span class="op" id="4181146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181150">n0</span><span class="op" id="4181152">,</span>&nbsp;<span class="ident" id="4181154">err</span>&nbsp;<span class="op" id="4181158">:=</span>&nbsp;<span class="ident" id="4181161"><a href="/gostd/net/http/server.go.html#4180528">rf</a></span><span class="op" id="4181163">.</span><span class="ident" id="4181164"><a href="/gostd/io/io.go.html#1424452">ReadFrom</a></span><span class="op" id="4181172">(</span><span class="ident" id="4181173"><a href="/gostd/net/http/server.go.html#4180311">src</a></span><span class="op" id="4181176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181180"><a href="/gostd/net/http/server.go.html#4180327">n</a></span>&nbsp;<span class="op" id="4181182">+=</span>&nbsp;<span class="ident" id="4181185"><a href="/gostd/net/http/server.go.html#4181150">n0</a></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181190"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4181191">.</span><span class="ident" id="4181192"><a href="/gostd/net/http/server.go.html#4178359">written</a></span>&nbsp;<span class="op" id="4181200">+=</span>&nbsp;<span class="ident" id="4181203"><a href="/gostd/net/http/server.go.html#4181150">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181208">return</span>&nbsp;<span class="ident" id="4181215"><a href="/gostd/net/http/server.go.html#4180327">n</a></span><span class="op" id="4181216">,</span>&nbsp;<span class="ident" id="4181218"><a href="/gostd/net/http/server.go.html#4181154">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181227">n0</span><span class="op" id="4181229">,</span>&nbsp;<span class="ident" id="4181231"><a href="/gostd/net/http/server.go.html#4180336">err</a></span>&nbsp;<span class="op" id="4181235">:=</span>&nbsp;<span class="ident" id="4181238"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4181240">.</span><span class="ident" id="4181241"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="4181245">(</span><span class="ident" id="4181246"><a href="/gostd/net/http/server.go.html#4179852">writerOnly</a></span><span class="op" id="4181256">{</span><span class="ident" id="4181257"><a href="/gostd/net/http/server.go.html#4180289">w</a></span><span class="op" id="4181258">}</span><span class="op" id="4181259">,</span>&nbsp;<span class="ident" id="4181261"><a href="/gostd/net/http/server.go.html#4180311">src</a></span><span class="op" id="4181264">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181267"><a href="/gostd/net/http/server.go.html#4180327">n</a></span>&nbsp;<span class="op" id="4181269">+=</span>&nbsp;<span class="ident" id="4181272"><a href="/gostd/net/http/server.go.html#4181227">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181276">return</span>&nbsp;<span class="ident" id="4181283"><a href="/gostd/net/http/server.go.html#4180327">n</a></span><span class="op" id="4181284">,</span>&nbsp;<span class="ident" id="4181286"><a href="/gostd/net/http/server.go.html#4180336">err</a></span><br>
<span class="lineno"></span><span class="op" id="4181290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4181293">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="4181362">const</span>&nbsp;<span class="ident" id="4181368">noLimit</span>&nbsp;<span class="builtintype" id="4181376">int64</span>&nbsp;<span class="op" id="4181382">=</span>&nbsp;<span class="op" id="4181384">(</span><span class="num" id="4181385">1</span>&nbsp;<span class="op" id="4181387">&lt;&lt;</span>&nbsp;<span class="num" id="4181390">63</span><span class="op" id="4181392">)</span>&nbsp;<span class="op" id="4181394">-</span>&nbsp;<span class="num" id="4181396">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4181399">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="4181477">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="4181512">const</span>&nbsp;<span class="ident" id="4181518">debugServerConnections</span>&nbsp;<span class="op" id="4181541">=</span>&nbsp;<span class="builtintype" id="4181543">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="4181550">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="4181585">func</span>&nbsp;<span class="op" id="4181590">(</span><span class="ident" id="4181591">srv</span>&nbsp;<span class="op" id="4181595">*</span><span class="ident" id="4181596"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4181602">)</span>&nbsp;<span class="ident" id="4181604">newConn</span><span class="op" id="4181611">(</span><span class="ident" id="4181612">rwc</span>&nbsp;<span class="ident" id="4181616"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4181619">.</span><span class="ident" id="4181620"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4181624">)</span>&nbsp;<span class="op" id="4181626">(</span><span class="ident" id="4181627">c</span>&nbsp;<span class="op" id="4181629">*</span><span class="ident" id="4181630"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4181634">,</span>&nbsp;<span class="ident" id="4181636">err</span>&nbsp;<span class="builtintype" id="4181640">error</span><span class="op" id="4181645">)</span>&nbsp;<span class="op" id="4181647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181650"><a href="/gostd/net/http/server.go.html#4181627">c</a></span>&nbsp;<span class="op" id="4181652">=</span>&nbsp;<span class="builtinfunc" id="4181654">new</span><span class="op" id="4181657">(</span><span class="ident" id="4181658"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4181662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181665"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181666">.</span><span class="ident" id="4181667"><a href="/gostd/net/http/server.go.html#4172807">remoteAddr</a></span>&nbsp;<span class="op" id="4181678">=</span>&nbsp;<span class="ident" id="4181680"><a href="/gostd/net/http/server.go.html#4181612">rwc</a></span><span class="op" id="4181683">.</span><span class="ident" id="4181684"><a href="/gostd/net/net.go.html#3335122">RemoteAddr</a></span><span class="op" id="4181694">(</span><span class="op" id="4181695">)</span><span class="op" id="4181696">.</span><span class="ident" id="4181697"><a href="/gostd/net/net.go.html#3334238">String</a></span><span class="op" id="4181703">(</span><span class="op" id="4181704">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181707"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181708">.</span><span class="ident" id="4181709"><a href="/gostd/net/http/server.go.html#4172874">server</a></span>&nbsp;<span class="op" id="4181716">=</span>&nbsp;<span class="ident" id="4181718"><a href="/gostd/net/http/server.go.html#4181591">srv</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181723"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181724">.</span><span class="ident" id="4181725"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="op" id="4181729">=</span>&nbsp;<span class="ident" id="4181731"><a href="/gostd/net/http/server.go.html#4181612">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181736"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181737">.</span><span class="ident" id="4181738"><a href="/gostd/net/http/server.go.html#4173004">w</a></span>&nbsp;<span class="op" id="4181740">=</span>&nbsp;<span class="ident" id="4181742"><a href="/gostd/net/http/server.go.html#4181612">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181747">if</span>&nbsp;<span class="ident" id="4181750"><a href="/gostd/net/http/server.go.html#4181518">debugServerConnections</a></span>&nbsp;<span class="op" id="4181773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181777"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181778">.</span><span class="ident" id="4181779"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="op" id="4181783">=</span>&nbsp;<span class="ident" id="4181785"><a href="/gostd/net/http/server.go.html#4229352">newLoggingConn</a></span><span class="op" id="4181799">(</span><span class="string" id="4181800">&#34;server&#34;</span><span class="op" id="4181808">,</span>&nbsp;<span class="ident" id="4181810"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181811">.</span><span class="ident" id="4181812"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4181815">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181821"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181822">.</span><span class="ident" id="4181823"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span>&nbsp;<span class="op" id="4181826">=</span>&nbsp;<span class="ident" id="4181828"><a href="/gostd/net/http/server.go.html#4175293">liveSwitchReader</a></span><span class="op" id="4181844">{</span><span class="ident" id="4181845"><a href="/gostd/net/http/server.go.html#4175332">r</a></span><span class="op" id="4181846">:</span>&nbsp;<span class="ident" id="4181848"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181849">.</span><span class="ident" id="4181850"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4181853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181856"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181857">.</span><span class="ident" id="4181858"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span>&nbsp;<span class="op" id="4181861">=</span>&nbsp;<span class="ident" id="4181863"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4181865">.</span><span class="ident" id="4181866"><a href="/gostd/io/io.go.html#1431815">LimitReader</a></span><span class="op" id="4181877">(</span><span class="op" id="4181878">&amp;</span><span class="ident" id="4181879"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181880">.</span><span class="ident" id="4181881"><a href="/gostd/net/http/server.go.html#4173157">sr</a></span><span class="op" id="4181883">,</span>&nbsp;<span class="ident" id="4181885"><a href="/gostd/net/http/server.go.html#4181368">noLimit</a></span><span class="op" id="4181892">)</span><span class="op" id="4181893">.</span><span class="op" id="4181894">(</span><span class="op" id="4181895">*</span><span class="ident" id="4181896"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4181898">.</span><span class="ident" id="4181899"><a href="/gostd/io/io.go.html#1432050">LimitedReader</a></span><span class="op" id="4181912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181915">br</span>&nbsp;<span class="op" id="4181918">:=</span>&nbsp;<span class="ident" id="4181921"><a href="/gostd/net/http/server.go.html#4182319">newBufioReader</a></span><span class="op" id="4181935">(</span><span class="ident" id="4181936"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181937">.</span><span class="ident" id="4181938"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span><span class="op" id="4181940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181943">bw</span>&nbsp;<span class="op" id="4181946">:=</span>&nbsp;<span class="ident" id="4181949"><a href="/gostd/net/http/server.go.html#4182579">newBufioWriterSize</a></span><span class="op" id="4181967">(</span><span class="ident" id="4181968"><a href="/gostd/net/http/server.go.html#4230366">checkConnErrorWriter</a></span><span class="op" id="4181988">{</span><span class="ident" id="4181989"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4181990">}</span><span class="op" id="4181991">,</span>&nbsp;<span class="num" id="4181993">4</span><span class="op" id="4181994">&lt;&lt;</span><span class="num" id="4181996">10</span><span class="op" id="4181998">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182001"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4182002">.</span><span class="ident" id="4182003"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span>&nbsp;<span class="op" id="4182007">=</span>&nbsp;<span class="ident" id="4182009"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182014">.</span><span class="ident" id="4182015"><a href="/gostd/bufio/bufio.go.html#1371043">NewReadWriter</a></span><span class="op" id="4182028">(</span><span class="ident" id="4182029"><a href="/gostd/net/http/server.go.html#4181915">br</a></span><span class="op" id="4182031">,</span>&nbsp;<span class="ident" id="4182033"><a href="/gostd/net/http/server.go.html#4181943">bw</a></span><span class="op" id="4182035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182038">return</span>&nbsp;<span class="ident" id="4182045"><a href="/gostd/net/http/server.go.html#4181627">c</a></span><span class="op" id="4182046">,</span>&nbsp;<span class="builtintype" id="4182048">nil</span><br>
<span class="lineno"></span><span class="op" id="4182052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4182055">var</span>&nbsp;<span class="op" id="4182059">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182062">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4182080"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4182084">.</span><span class="ident" id="4182085"><a href="/gostd/sync/pool.go.html#1448866">Pool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182091">bufioWriter2kPool</span>&nbsp;<span class="ident" id="4182109"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4182113">.</span><span class="ident" id="4182114"><a href="/gostd/sync/pool.go.html#1448866">Pool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182120">bufioWriter4kPool</span>&nbsp;<span class="ident" id="4182138"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4182142">.</span><span class="ident" id="4182143"><a href="/gostd/sync/pool.go.html#1448866">Pool</a></span><br>
<span class="lineno"></span><span class="op" id="4182148">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="4182151">func</span>&nbsp;<span class="ident" id="4182156">bufioWriterPool</span><span class="op" id="4182171">(</span><span class="ident" id="4182172">size</span>&nbsp;<span class="builtintype" id="4182177">int</span><span class="op" id="4182180">)</span>&nbsp;<span class="op" id="4182182">*</span><span class="ident" id="4182183"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4182187">.</span><span class="ident" id="4182188"><a href="/gostd/sync/pool.go.html#1448866">Pool</a></span>&nbsp;<span class="op" id="4182193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182196">switch</span>&nbsp;<span class="ident" id="4182203"><a href="/gostd/net/http/server.go.html#4182172">size</a></span>&nbsp;<span class="op" id="4182208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182211">case</span>&nbsp;<span class="num" id="4182216">2</span>&nbsp;<span class="op" id="4182218">&lt;&lt;</span>&nbsp;<span class="num" id="4182221">10</span><span class="op" id="4182223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182227">return</span>&nbsp;<span class="op" id="4182234">&amp;</span><span class="ident" id="4182235"><a href="/gostd/net/http/server.go.html#4182091">bufioWriter2kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182254">case</span>&nbsp;<span class="num" id="4182259">4</span>&nbsp;<span class="op" id="4182261">&lt;&lt;</span>&nbsp;<span class="num" id="4182264">10</span><span class="op" id="4182266">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182270">return</span>&nbsp;<span class="op" id="4182277">&amp;</span><span class="ident" id="4182278"><a href="/gostd/net/http/server.go.html#4182120">bufioWriter4kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182300">return</span>&nbsp;<span class="builtintype" id="4182307">nil</span><br>
<span class="lineno"></span><span class="op" id="4182311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="4182314">func</span>&nbsp;<span class="ident" id="4182319">newBufioReader</span><span class="op" id="4182333">(</span><span class="ident" id="4182334">r</span>&nbsp;<span class="ident" id="4182336"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4182338">.</span><span class="ident" id="4182339"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><span class="op" id="4182345">)</span>&nbsp;<span class="op" id="4182347">*</span><span class="ident" id="4182348"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182353">.</span><span class="ident" id="4182354"><a href="/gostd/bufio/bufio.go.html#1354974">Reader</a></span>&nbsp;<span class="op" id="4182361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182364">if</span>&nbsp;<span class="ident" id="4182367">v</span>&nbsp;<span class="op" id="4182369">:=</span>&nbsp;<span class="ident" id="4182372"><a href="/gostd/net/http/server.go.html#4182062">bufioReaderPool</a></span><span class="op" id="4182387">.</span><span class="ident" id="4182388"><a href="/gostd/sync/pool.go.html#1450329">Get</a></span><span class="op" id="4182391">(</span><span class="op" id="4182392">)</span><span class="op" id="4182393">;</span>&nbsp;<span class="ident" id="4182395"><a href="/gostd/net/http/server.go.html#4182367">v</a></span>&nbsp;<span class="op" id="4182397">!=</span>&nbsp;<span class="builtintype" id="4182400">nil</span>&nbsp;<span class="op" id="4182404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182408">br</span>&nbsp;<span class="op" id="4182411">:=</span>&nbsp;<span class="ident" id="4182414"><a href="/gostd/net/http/server.go.html#4182367">v</a></span><span class="op" id="4182415">.</span><span class="op" id="4182416">(</span><span class="op" id="4182417">*</span><span class="ident" id="4182418"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182423">.</span><span class="ident" id="4182424"><a href="/gostd/bufio/bufio.go.html#1354974">Reader</a></span><span class="op" id="4182430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182434"><a href="/gostd/net/http/server.go.html#4182408">br</a></span><span class="op" id="4182436">.</span><span class="ident" id="4182437"><a href="/gostd/bufio/bufio.go.html#1355995">Reset</a></span><span class="op" id="4182442">(</span><span class="ident" id="4182443"><a href="/gostd/net/http/server.go.html#4182334">r</a></span><span class="op" id="4182444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182448">return</span>&nbsp;<span class="ident" id="4182455"><a href="/gostd/net/http/server.go.html#4182408">br</a></span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182462">return</span>&nbsp;<span class="ident" id="4182469"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182474">.</span><span class="ident" id="4182475"><a href="/gostd/bufio/bufio.go.html#1355792">NewReader</a></span><span class="op" id="4182484">(</span><span class="ident" id="4182485"><a href="/gostd/net/http/server.go.html#4182334">r</a></span><span class="op" id="4182486">)</span><br>
<span class="lineno"></span><span class="op" id="4182488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4182491">func</span>&nbsp;<span class="ident" id="4182496">putBufioReader</span><span class="op" id="4182510">(</span><span class="ident" id="4182511">br</span>&nbsp;<span class="op" id="4182514">*</span><span class="ident" id="4182515"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182520">.</span><span class="ident" id="4182521"><a href="/gostd/bufio/bufio.go.html#1354974">Reader</a></span><span class="op" id="4182527">)</span>&nbsp;<span class="op" id="4182529">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182532"><a href="/gostd/net/http/server.go.html#4182511">br</a></span><span class="op" id="4182534">.</span><span class="ident" id="4182535"><a href="/gostd/bufio/bufio.go.html#1355995">Reset</a></span><span class="op" id="4182540">(</span><span class="builtintype" id="4182541">nil</span><span class="op" id="4182544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182547"><a href="/gostd/net/http/server.go.html#4182062">bufioReaderPool</a></span><span class="op" id="4182562">.</span><span class="ident" id="4182563"><a href="/gostd/sync/pool.go.html#1449510">Put</a></span><span class="op" id="4182566">(</span><span class="ident" id="4182567"><a href="/gostd/net/http/server.go.html#4182511">br</a></span><span class="op" id="4182569">)</span><br>
<span class="lineno"></span><span class="op" id="4182571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4182574">func</span>&nbsp;<span class="ident" id="4182579">newBufioWriterSize</span><span class="op" id="4182597">(</span><span class="ident" id="4182598">w</span>&nbsp;<span class="ident" id="4182600"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4182602">.</span><span class="ident" id="4182603"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><span class="op" id="4182609">,</span>&nbsp;<span class="ident" id="4182611">size</span>&nbsp;<span class="builtintype" id="4182616">int</span><span class="op" id="4182619">)</span>&nbsp;<span class="op" id="4182621">*</span><span class="ident" id="4182622"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182627">.</span><span class="ident" id="4182628"><a href="/gostd/bufio/bufio.go.html#1366565">Writer</a></span>&nbsp;<span class="op" id="4182635">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182638">pool</span>&nbsp;<span class="op" id="4182643">:=</span>&nbsp;<span class="ident" id="4182646"><a href="/gostd/net/http/server.go.html#4182156">bufioWriterPool</a></span><span class="op" id="4182661">(</span><span class="ident" id="4182662"><a href="/gostd/net/http/server.go.html#4182611">size</a></span><span class="op" id="4182666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182669">if</span>&nbsp;<span class="ident" id="4182672"><a href="/gostd/net/http/server.go.html#4182638">pool</a></span>&nbsp;<span class="op" id="4182677">!=</span>&nbsp;<span class="builtintype" id="4182680">nil</span>&nbsp;<span class="op" id="4182684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182688">if</span>&nbsp;<span class="ident" id="4182691">v</span>&nbsp;<span class="op" id="4182693">:=</span>&nbsp;<span class="ident" id="4182696"><a href="/gostd/net/http/server.go.html#4182638">pool</a></span><span class="op" id="4182700">.</span><span class="ident" id="4182701"><a href="/gostd/sync/pool.go.html#1450329">Get</a></span><span class="op" id="4182704">(</span><span class="op" id="4182705">)</span><span class="op" id="4182706">;</span>&nbsp;<span class="ident" id="4182708"><a href="/gostd/net/http/server.go.html#4182691">v</a></span>&nbsp;<span class="op" id="4182710">!=</span>&nbsp;<span class="builtintype" id="4182713">nil</span>&nbsp;<span class="op" id="4182717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182722">bw</span>&nbsp;<span class="op" id="4182725">:=</span>&nbsp;<span class="ident" id="4182728"><a href="/gostd/net/http/server.go.html#4182691">v</a></span><span class="op" id="4182729">.</span><span class="op" id="4182730">(</span><span class="op" id="4182731">*</span><span class="ident" id="4182732"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182737">.</span><span class="ident" id="4182738"><a href="/gostd/bufio/bufio.go.html#1366565">Writer</a></span><span class="op" id="4182744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182749"><a href="/gostd/net/http/server.go.html#4182722">bw</a></span><span class="op" id="4182751">.</span><span class="ident" id="4182752"><a href="/gostd/bufio/bufio.go.html#1367350">Reset</a></span><span class="op" id="4182757">(</span><span class="ident" id="4182758"><a href="/gostd/net/http/server.go.html#4182598">w</a></span><span class="op" id="4182759">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182764">return</span>&nbsp;<span class="ident" id="4182771"><a href="/gostd/net/http/server.go.html#4182722">bw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182782">return</span>&nbsp;<span class="ident" id="4182789"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182794">.</span><span class="ident" id="4182795"><a href="/gostd/bufio/bufio.go.html#1366830">NewWriterSize</a></span><span class="op" id="4182808">(</span><span class="ident" id="4182809"><a href="/gostd/net/http/server.go.html#4182598">w</a></span><span class="op" id="4182810">,</span>&nbsp;<span class="ident" id="4182812"><a href="/gostd/net/http/server.go.html#4182611">size</a></span><span class="op" id="4182816">)</span><br>
<span class="lineno"></span><span class="op" id="4182818">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="4182821">func</span>&nbsp;<span class="ident" id="4182826">putBufioWriter</span><span class="op" id="4182840">(</span><span class="ident" id="4182841">bw</span>&nbsp;<span class="op" id="4182844">*</span><span class="ident" id="4182845"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4182850">.</span><span class="ident" id="4182851"><a href="/gostd/bufio/bufio.go.html#1366565">Writer</a></span><span class="op" id="4182857">)</span>&nbsp;<span class="op" id="4182859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182862"><a href="/gostd/net/http/server.go.html#4182841">bw</a></span><span class="op" id="4182864">.</span><span class="ident" id="4182865"><a href="/gostd/bufio/bufio.go.html#1367350">Reset</a></span><span class="op" id="4182870">(</span><span class="builtintype" id="4182871">nil</span><span class="op" id="4182874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182877">if</span>&nbsp;<span class="ident" id="4182880">pool</span>&nbsp;<span class="op" id="4182885">:=</span>&nbsp;<span class="ident" id="4182888"><a href="/gostd/net/http/server.go.html#4182156">bufioWriterPool</a></span><span class="op" id="4182903">(</span><span class="ident" id="4182904"><a href="/gostd/net/http/server.go.html#4182841">bw</a></span><span class="op" id="4182906">.</span><span class="ident" id="4182907"><a href="/gostd/bufio/bufio.go.html#1367955">Available</a></span><span class="op" id="4182916">(</span><span class="op" id="4182917">)</span><span class="op" id="4182918">)</span><span class="op" id="4182919">;</span>&nbsp;<span class="ident" id="4182921"><a href="/gostd/net/http/server.go.html#4182880">pool</a></span>&nbsp;<span class="op" id="4182926">!=</span>&nbsp;<span class="builtintype" id="4182929">nil</span>&nbsp;<span class="op" id="4182933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182937"><a href="/gostd/net/http/server.go.html#4182880">pool</a></span><span class="op" id="4182941">.</span><span class="ident" id="4182942"><a href="/gostd/sync/pool.go.html#1449510">Put</a></span><span class="op" id="4182945">(</span><span class="ident" id="4182946"><a href="/gostd/net/http/server.go.html#4182841">bw</a></span><span class="op" id="4182948">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182951">}</span><br>
<span class="lineno"></span><span class="op" id="4182953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4182956">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="4183026">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="4183049">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4183109">const</span>&nbsp;<span class="ident" id="4183115">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="4183137">=</span>&nbsp;<span class="num" id="4183139">1</span>&nbsp;<span class="op" id="4183141">&lt;&lt;</span>&nbsp;<span class="num" id="4183144">20</span>&nbsp;<span class="comment" id="4183147">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4183156">func</span>&nbsp;<span class="op" id="4183161">(</span><span class="ident" id="4183162">srv</span>&nbsp;<span class="op" id="4183166">*</span><span class="ident" id="4183167"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4183173">)</span>&nbsp;<span class="ident" id="4183175">maxHeaderBytes</span><span class="op" id="4183189">(</span><span class="op" id="4183190">)</span>&nbsp;<span class="builtintype" id="4183192">int</span>&nbsp;<span class="op" id="4183196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183199">if</span>&nbsp;<span class="ident" id="4183202"><a href="/gostd/net/http/server.go.html#4183162">srv</a></span><span class="op" id="4183205">.</span><span class="ident" id="4183206"><a href="/gostd/net/http/server.go.html#4216912">MaxHeaderBytes</a></span>&nbsp;<span class="op" id="4183221">&gt;</span>&nbsp;<span class="num" id="4183223">0</span>&nbsp;<span class="op" id="4183225">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183229">return</span>&nbsp;<span class="ident" id="4183236"><a href="/gostd/net/http/server.go.html#4183162">srv</a></span><span class="op" id="4183239">.</span><span class="ident" id="4183240"><a href="/gostd/net/http/server.go.html#4216912">MaxHeaderBytes</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183259">return</span>&nbsp;<span class="ident" id="4183266"><a href="/gostd/net/http/server.go.html#4183115">DefaultMaxHeaderBytes</a></span><br>
<span class="lineno"></span><span class="op" id="4183288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="4183291">func</span>&nbsp;<span class="op" id="4183296">(</span><span class="ident" id="4183297">srv</span>&nbsp;<span class="op" id="4183301">*</span><span class="ident" id="4183302"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4183308">)</span>&nbsp;<span class="ident" id="4183310">initialLimitedReaderSize</span><span class="op" id="4183334">(</span><span class="op" id="4183335">)</span>&nbsp;<span class="builtintype" id="4183337">int64</span>&nbsp;<span class="op" id="4183343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183346">return</span>&nbsp;<span class="builtintype" id="4183353">int64</span><span class="op" id="4183358">(</span><span class="ident" id="4183359"><a href="/gostd/net/http/server.go.html#4183297">srv</a></span><span class="op" id="4183362">.</span><span class="ident" id="4183363"><a href="/gostd/net/http/server.go.html#4183175">maxHeaderBytes</a></span><span class="op" id="4183377">(</span><span class="op" id="4183378">)</span><span class="op" id="4183379">)</span>&nbsp;<span class="op" id="4183381">+</span>&nbsp;<span class="num" id="4183383">4096</span>&nbsp;<span class="comment" id="4183388">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="4183402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4183405">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="4183469">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4183501">type</span>&nbsp;<span class="ident" id="4183506">expectContinueReader</span>&nbsp;<span class="keyword" id="4183527">struct</span>&nbsp;<span class="op" id="4183534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183537">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183548">*</span><span class="ident" id="4183549"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183559">readCloser</span>&nbsp;<span class="ident" id="4183570"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4183572">.</span><span class="ident" id="4183573"><a href="/gostd/io/io.go.html#1423414">ReadCloser</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183585">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4183596">bool</span><br>
<span class="lineno">520</span><span class="op" id="4183601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4183604">func</span>&nbsp;<span class="op" id="4183609">(</span><span class="ident" id="4183610">ecr</span>&nbsp;<span class="op" id="4183614">*</span><span class="ident" id="4183615"><a href="/gostd/net/http/server.go.html#4183506">expectContinueReader</a></span><span class="op" id="4183635">)</span>&nbsp;<span class="ident" id="4183637">Read</span><span class="op" id="4183641">(</span><span class="ident" id="4183642">p</span>&nbsp;<span class="op" id="4183644">[</span><span class="op" id="4183645">]</span><span class="builtintype" id="4183646">byte</span><span class="op" id="4183650">)</span>&nbsp;<span class="op" id="4183652">(</span><span class="ident" id="4183653">n</span>&nbsp;<span class="builtintype" id="4183655">int</span><span class="op" id="4183658">,</span>&nbsp;<span class="ident" id="4183660">err</span>&nbsp;<span class="builtintype" id="4183664">error</span><span class="op" id="4183669">)</span>&nbsp;<span class="op" id="4183671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183674">if</span>&nbsp;<span class="ident" id="4183677"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183680">.</span><span class="ident" id="4183681"><a href="/gostd/net/http/server.go.html#4183585">closed</a></span>&nbsp;<span class="op" id="4183688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183692">return</span>&nbsp;<span class="num" id="4183699">0</span><span class="op" id="4183700">,</span>&nbsp;<span class="ident" id="4183702"><a href="/gostd/net/http/transfer.go.html#4255422">ErrBodyReadAfterClose</a></span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183728">if</span>&nbsp;<span class="op" id="4183731">!</span><span class="ident" id="4183732"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183735">.</span><span class="ident" id="4183736"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4183740">.</span><span class="ident" id="4183741"><a href="/gostd/net/http/server.go.html#4177835">wroteContinue</a></span>&nbsp;<span class="op" id="4183755">&amp;&amp;</span>&nbsp;<span class="op" id="4183758">!</span><span class="ident" id="4183759"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183762">.</span><span class="ident" id="4183763"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4183767">.</span><span class="ident" id="4183768"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4183772">.</span><span class="ident" id="4183773"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4183781">(</span><span class="op" id="4183782">)</span>&nbsp;<span class="op" id="4183784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183788"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183791">.</span><span class="ident" id="4183792"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4183796">.</span><span class="ident" id="4183797"><a href="/gostd/net/http/server.go.html#4177835">wroteContinue</a></span>&nbsp;<span class="op" id="4183811">=</span>&nbsp;<span class="builtintype" id="4183813">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183820"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183823">.</span><span class="ident" id="4183824"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4183828">.</span><span class="ident" id="4183829"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4183833">.</span><span class="ident" id="4183834"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4183837">.</span><span class="ident" id="4183838"><a href="/gostd/bufio/bufio.go.html#1369779">WriteString</a></span><span class="op" id="4183849">(</span><span class="string" id="4183850">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="4183881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183885"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183888">.</span><span class="ident" id="4183889"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4183893">.</span><span class="ident" id="4183894"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4183898">.</span><span class="ident" id="4183899"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4183902">.</span><span class="ident" id="4183903"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4183908">(</span><span class="op" id="4183909">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183915">return</span>&nbsp;<span class="ident" id="4183922"><a href="/gostd/net/http/server.go.html#4183610">ecr</a></span><span class="op" id="4183925">.</span><span class="ident" id="4183926"><a href="/gostd/net/http/server.go.html#4183559">readCloser</a></span><span class="op" id="4183936">.</span><span class="ident" id="4183937"><a href="/gostd/io/io.go.html#1421843">Read</a></span><span class="op" id="4183941">(</span><span class="ident" id="4183942"><a href="/gostd/net/http/server.go.html#4183642">p</a></span><span class="op" id="4183943">)</span><br>
<span class="lineno"></span><span class="op" id="4183945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4183948">func</span>&nbsp;<span class="op" id="4183953">(</span><span class="ident" id="4183954">ecr</span>&nbsp;<span class="op" id="4183958">*</span><span class="ident" id="4183959"><a href="/gostd/net/http/server.go.html#4183506">expectContinueReader</a></span><span class="op" id="4183979">)</span>&nbsp;<span class="ident" id="4183981">Close</span><span class="op" id="4183986">(</span><span class="op" id="4183987">)</span>&nbsp;<span class="builtintype" id="4183989">error</span>&nbsp;<span class="op" id="4183995">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183998"><a href="/gostd/net/http/server.go.html#4183954">ecr</a></span><span class="op" id="4184001">.</span><span class="ident" id="4184002"><a href="/gostd/net/http/server.go.html#4183585">closed</a></span>&nbsp;<span class="op" id="4184009">=</span>&nbsp;<span class="builtintype" id="4184011">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4184017">return</span>&nbsp;<span class="ident" id="4184024"><a href="/gostd/net/http/server.go.html#4183954">ecr</a></span><span class="op" id="4184027">.</span><span class="ident" id="4184028"><a href="/gostd/net/http/server.go.html#4183559">readCloser</a></span><span class="op" id="4184038">.</span><span class="ident" id="4184039"><a href="/gostd/io/io.go.html#1422583">Close</a></span><span class="op" id="4184044">(</span><span class="op" id="4184045">)</span><br>
<span class="lineno"></span><span class="op" id="4184047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4184050">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="4184095">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="4184143">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="4184183">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="4184247">const</span>&nbsp;<span class="ident" id="4184253">TimeFormat</span>&nbsp;<span class="op" id="4184264">=</span>&nbsp;<span class="string" id="4184266">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="4184299">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="4184379">func</span>&nbsp;<span class="ident" id="4184384">appendTime</span><span class="op" id="4184394">(</span><span class="ident" id="4184395">b</span>&nbsp;<span class="op" id="4184397">[</span><span class="op" id="4184398">]</span><span class="builtintype" id="4184399">byte</span><span class="op" id="4184403">,</span>&nbsp;<span class="ident" id="4184405">t</span>&nbsp;<span class="ident" id="4184407"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4184411">.</span><span class="ident" id="4184412"><a href="/gostd/time/time.go.html#2722087">Time</a></span><span class="op" id="4184416">)</span>&nbsp;<span class="op" id="4184418">[</span><span class="op" id="4184419">]</span><span class="builtintype" id="4184420">byte</span>&nbsp;<span class="op" id="4184425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4184428">const</span>&nbsp;<span class="ident" id="4184434">days</span>&nbsp;<span class="op" id="4184439">=</span>&nbsp;<span class="string" id="4184441">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4184466">const</span>&nbsp;<span class="ident" id="4184472">months</span>&nbsp;<span class="op" id="4184479">=</span>&nbsp;<span class="string" id="4184481">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184522"><a href="/gostd/net/http/server.go.html#4184405">t</a></span>&nbsp;<span class="op" id="4184524">=</span>&nbsp;<span class="ident" id="4184526"><a href="/gostd/net/http/server.go.html#4184405">t</a></span><span class="op" id="4184527">.</span><span class="ident" id="4184528"><a href="/gostd/time/time.go.html#2743233">UTC</a></span><span class="op" id="4184531">(</span><span class="op" id="4184532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184535">yy</span><span class="op" id="4184537">,</span>&nbsp;<span class="ident" id="4184539">mm</span><span class="op" id="4184541">,</span>&nbsp;<span class="ident" id="4184543">dd</span>&nbsp;<span class="op" id="4184546">:=</span>&nbsp;<span class="ident" id="4184549"><a href="/gostd/net/http/server.go.html#4184405">t</a></span><span class="op" id="4184550">.</span><span class="ident" id="4184551"><a href="/gostd/time/time.go.html#2730103">Date</a></span><span class="op" id="4184555">(</span><span class="op" id="4184556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184559">hh</span><span class="op" id="4184561">,</span>&nbsp;<span class="ident" id="4184563">mn</span><span class="op" id="4184565">,</span>&nbsp;<span class="ident" id="4184567">ss</span>&nbsp;<span class="op" id="4184570">:=</span>&nbsp;<span class="ident" id="4184573"><a href="/gostd/net/http/server.go.html#4184405">t</a></span><span class="op" id="4184574">.</span><span class="ident" id="4184575"><a href="/gostd/time/time.go.html#2732811">Clock</a></span><span class="op" id="4184580">(</span><span class="op" id="4184581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184584">day</span>&nbsp;<span class="op" id="4184588">:=</span>&nbsp;<span class="ident" id="4184591"><a href="/gostd/net/http/server.go.html#4184434">days</a></span><span class="op" id="4184595">[</span><span class="num" id="4184596">3</span><span class="op" id="4184597">*</span><span class="ident" id="4184598"><a href="/gostd/net/http/server.go.html#4184405">t</a></span><span class="op" id="4184599">.</span><span class="ident" id="4184600"><a href="/gostd/time/time.go.html#2730637">Weekday</a></span><span class="op" id="4184607">(</span><span class="op" id="4184608">)</span><span class="op" id="4184609">:</span><span class="op" id="4184610">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184613">mon</span>&nbsp;<span class="op" id="4184617">:=</span>&nbsp;<span class="ident" id="4184620"><a href="/gostd/net/http/server.go.html#4184472">months</a></span><span class="op" id="4184626">[</span><span class="num" id="4184627">3</span><span class="op" id="4184628">*</span><span class="op" id="4184629">(</span><span class="ident" id="4184630"><a href="/gostd/net/http/server.go.html#4184539">mm</a></span><span class="op" id="4184632">-</span><span class="num" id="4184633">1</span><span class="op" id="4184634">)</span><span class="op" id="4184635">:</span><span class="op" id="4184636">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4184640">return</span>&nbsp;<span class="builtinfunc" id="4184647">append</span><span class="op" id="4184653">(</span><span class="ident" id="4184654"><a href="/gostd/net/http/server.go.html#4184395">b</a></span><span class="op" id="4184655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184659"><a href="/gostd/net/http/server.go.html#4184584">day</a></span><span class="op" id="4184662">[</span><span class="num" id="4184663">0</span><span class="op" id="4184664">]</span><span class="op" id="4184665">,</span>&nbsp;<span class="ident" id="4184667"><a href="/gostd/net/http/server.go.html#4184584">day</a></span><span class="op" id="4184670">[</span><span class="num" id="4184671">1</span><span class="op" id="4184672">]</span><span class="op" id="4184673">,</span>&nbsp;<span class="ident" id="4184675"><a href="/gostd/net/http/server.go.html#4184584">day</a></span><span class="op" id="4184678">[</span><span class="num" id="4184679">2</span><span class="op" id="4184680">]</span><span class="op" id="4184681">,</span>&nbsp;<span class="string" id="4184683">&#39;,&#39;</span><span class="op" id="4184686">,</span>&nbsp;<span class="string" id="4184688">&#39;&nbsp;&#39;</span><span class="op" id="4184691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4184695">byte</span><span class="op" id="4184699">(</span><span class="string" id="4184700">&#39;0&#39;</span><span class="op" id="4184703">+</span><span class="ident" id="4184704"><a href="/gostd/net/http/server.go.html#4184543">dd</a></span><span class="op" id="4184706">/</span><span class="num" id="4184707">10</span><span class="op" id="4184709">)</span><span class="op" id="4184710">,</span>&nbsp;<span class="builtintype" id="4184712">byte</span><span class="op" id="4184716">(</span><span class="string" id="4184717">&#39;0&#39;</span><span class="op" id="4184720">+</span><span class="ident" id="4184721"><a href="/gostd/net/http/server.go.html#4184543">dd</a></span><span class="op" id="4184723">%</span><span class="num" id="4184724">10</span><span class="op" id="4184726">)</span><span class="op" id="4184727">,</span>&nbsp;<span class="string" id="4184729">&#39;&nbsp;&#39;</span><span class="op" id="4184732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184736"><a href="/gostd/net/http/server.go.html#4184613">mon</a></span><span class="op" id="4184739">[</span><span class="num" id="4184740">0</span><span class="op" id="4184741">]</span><span class="op" id="4184742">,</span>&nbsp;<span class="ident" id="4184744"><a href="/gostd/net/http/server.go.html#4184613">mon</a></span><span class="op" id="4184747">[</span><span class="num" id="4184748">1</span><span class="op" id="4184749">]</span><span class="op" id="4184750">,</span>&nbsp;<span class="ident" id="4184752"><a href="/gostd/net/http/server.go.html#4184613">mon</a></span><span class="op" id="4184755">[</span><span class="num" id="4184756">2</span><span class="op" id="4184757">]</span><span class="op" id="4184758">,</span>&nbsp;<span class="string" id="4184760">&#39;&nbsp;&#39;</span><span class="op" id="4184763">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4184767">byte</span><span class="op" id="4184771">(</span><span class="string" id="4184772">&#39;0&#39;</span><span class="op" id="4184775">+</span><span class="ident" id="4184776"><a href="/gostd/net/http/server.go.html#4184535">yy</a></span><span class="op" id="4184778">/</span><span class="num" id="4184779">1000</span><span class="op" id="4184783">)</span><span class="op" id="4184784">,</span>&nbsp;<span class="builtintype" id="4184786">byte</span><span class="op" id="4184790">(</span><span class="string" id="4184791">&#39;0&#39;</span><span class="op" id="4184794">+</span><span class="op" id="4184795">(</span><span class="ident" id="4184796"><a href="/gostd/net/http/server.go.html#4184535">yy</a></span><span class="op" id="4184798">/</span><span class="num" id="4184799">100</span><span class="op" id="4184802">)</span><span class="op" id="4184803">%</span><span class="num" id="4184804">10</span><span class="op" id="4184806">)</span><span class="op" id="4184807">,</span>&nbsp;<span class="builtintype" id="4184809">byte</span><span class="op" id="4184813">(</span><span class="string" id="4184814">&#39;0&#39;</span><span class="op" id="4184817">+</span><span class="op" id="4184818">(</span><span class="ident" id="4184819"><a href="/gostd/net/http/server.go.html#4184535">yy</a></span><span class="op" id="4184821">/</span><span class="num" id="4184822">10</span><span class="op" id="4184824">)</span><span class="op" id="4184825">%</span><span class="num" id="4184826">10</span><span class="op" id="4184828">)</span><span class="op" id="4184829">,</span>&nbsp;<span class="builtintype" id="4184831">byte</span><span class="op" id="4184835">(</span><span class="string" id="4184836">&#39;0&#39;</span><span class="op" id="4184839">+</span><span class="ident" id="4184840"><a href="/gostd/net/http/server.go.html#4184535">yy</a></span><span class="op" id="4184842">%</span><span class="num" id="4184843">10</span><span class="op" id="4184845">)</span><span class="op" id="4184846">,</span>&nbsp;<span class="string" id="4184848">&#39;&nbsp;&#39;</span><span class="op" id="4184851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4184855">byte</span><span class="op" id="4184859">(</span><span class="string" id="4184860">&#39;0&#39;</span><span class="op" id="4184863">+</span><span class="ident" id="4184864"><a href="/gostd/net/http/server.go.html#4184559">hh</a></span><span class="op" id="4184866">/</span><span class="num" id="4184867">10</span><span class="op" id="4184869">)</span><span class="op" id="4184870">,</span>&nbsp;<span class="builtintype" id="4184872">byte</span><span class="op" id="4184876">(</span><span class="string" id="4184877">&#39;0&#39;</span><span class="op" id="4184880">+</span><span class="ident" id="4184881"><a href="/gostd/net/http/server.go.html#4184559">hh</a></span><span class="op" id="4184883">%</span><span class="num" id="4184884">10</span><span class="op" id="4184886">)</span><span class="op" id="4184887">,</span>&nbsp;<span class="string" id="4184889">&#39;:&#39;</span><span class="op" id="4184892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4184896">byte</span><span class="op" id="4184900">(</span><span class="string" id="4184901">&#39;0&#39;</span><span class="op" id="4184904">+</span><span class="ident" id="4184905"><a href="/gostd/net/http/server.go.html#4184563">mn</a></span><span class="op" id="4184907">/</span><span class="num" id="4184908">10</span><span class="op" id="4184910">)</span><span class="op" id="4184911">,</span>&nbsp;<span class="builtintype" id="4184913">byte</span><span class="op" id="4184917">(</span><span class="string" id="4184918">&#39;0&#39;</span><span class="op" id="4184921">+</span><span class="ident" id="4184922"><a href="/gostd/net/http/server.go.html#4184563">mn</a></span><span class="op" id="4184924">%</span><span class="num" id="4184925">10</span><span class="op" id="4184927">)</span><span class="op" id="4184928">,</span>&nbsp;<span class="string" id="4184930">&#39;:&#39;</span><span class="op" id="4184933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4184937">byte</span><span class="op" id="4184941">(</span><span class="string" id="4184942">&#39;0&#39;</span><span class="op" id="4184945">+</span><span class="ident" id="4184946"><a href="/gostd/net/http/server.go.html#4184567">ss</a></span><span class="op" id="4184948">/</span><span class="num" id="4184949">10</span><span class="op" id="4184951">)</span><span class="op" id="4184952">,</span>&nbsp;<span class="builtintype" id="4184954">byte</span><span class="op" id="4184958">(</span><span class="string" id="4184959">&#39;0&#39;</span><span class="op" id="4184962">+</span><span class="ident" id="4184963"><a href="/gostd/net/http/server.go.html#4184567">ss</a></span><span class="op" id="4184965">%</span><span class="num" id="4184966">10</span><span class="op" id="4184968">)</span><span class="op" id="4184969">,</span>&nbsp;<span class="string" id="4184971">&#39;&nbsp;&#39;</span><span class="op" id="4184974">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4184978">&#39;G&#39;</span><span class="op" id="4184981">,</span>&nbsp;<span class="string" id="4184983">&#39;M&#39;</span><span class="op" id="4184986">,</span>&nbsp;<span class="string" id="4184988">&#39;T&#39;</span><span class="op" id="4184991">)</span><br>
<span class="lineno">565</span><span class="op" id="4184993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4184996">var</span>&nbsp;<span class="ident" id="4185000">errTooLarge</span>&nbsp;<span class="op" id="4185012">=</span>&nbsp;<span class="ident" id="4185014"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4185020">.</span><span class="ident" id="4185021"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4185024">(</span><span class="string" id="4185025">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="4185050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4185053">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="4185091">func</span>&nbsp;<span class="op" id="4185096">(</span><span class="ident" id="4185097">c</span>&nbsp;<span class="op" id="4185099">*</span><span class="ident" id="4185100"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4185104">)</span>&nbsp;<span class="ident" id="4185106">readRequest</span><span class="op" id="4185117">(</span><span class="op" id="4185118">)</span>&nbsp;<span class="op" id="4185120">(</span><span class="ident" id="4185121">w</span>&nbsp;<span class="op" id="4185123">*</span><span class="ident" id="4185124"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4185132">,</span>&nbsp;<span class="ident" id="4185134">err</span>&nbsp;<span class="builtintype" id="4185138">error</span><span class="op" id="4185143">)</span>&nbsp;<span class="op" id="4185145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185148">if</span>&nbsp;<span class="ident" id="4185151"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185152">.</span><span class="ident" id="4185153"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4185161">(</span><span class="op" id="4185162">)</span>&nbsp;<span class="op" id="4185164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185168">return</span>&nbsp;<span class="builtintype" id="4185175">nil</span><span class="op" id="4185178">,</span>&nbsp;<span class="ident" id="4185180"><a href="/gostd/net/http/server.go.html#4169659">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185197">if</span>&nbsp;<span class="ident" id="4185200">d</span>&nbsp;<span class="op" id="4185202">:=</span>&nbsp;<span class="ident" id="4185205"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185206">.</span><span class="ident" id="4185207"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4185213">.</span><span class="ident" id="4185214"><a href="/gostd/net/http/server.go.html#4216734">ReadTimeout</a></span><span class="op" id="4185225">;</span>&nbsp;<span class="ident" id="4185227"><a href="/gostd/net/http/server.go.html#4185200">d</a></span>&nbsp;<span class="op" id="4185229">!=</span>&nbsp;<span class="num" id="4185232">0</span>&nbsp;<span class="op" id="4185234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185238"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185239">.</span><span class="ident" id="4185240"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4185243">.</span><span class="ident" id="4185244"><a href="/gostd/net/net.go.html#3335873">SetReadDeadline</a></span><span class="op" id="4185259">(</span><span class="ident" id="4185260"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4185264">.</span><span class="ident" id="4185265"><a href="/gostd/time/time.go.html#2743088">Now</a></span><span class="op" id="4185268">(</span><span class="op" id="4185269">)</span><span class="op" id="4185270">.</span><span class="ident" id="4185271"><a href="/gostd/time/time.go.html#2738615">Add</a></span><span class="op" id="4185274">(</span><span class="ident" id="4185275"><a href="/gostd/net/http/server.go.html#4185200">d</a></span><span class="op" id="4185276">)</span><span class="op" id="4185277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185283">if</span>&nbsp;<span class="ident" id="4185286">d</span>&nbsp;<span class="op" id="4185288">:=</span>&nbsp;<span class="ident" id="4185291"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185292">.</span><span class="ident" id="4185293"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4185299">.</span><span class="ident" id="4185300"><a href="/gostd/net/http/server.go.html#4216822">WriteTimeout</a></span><span class="op" id="4185312">;</span>&nbsp;<span class="ident" id="4185314"><a href="/gostd/net/http/server.go.html#4185286">d</a></span>&nbsp;<span class="op" id="4185316">!=</span>&nbsp;<span class="num" id="4185319">0</span>&nbsp;<span class="op" id="4185321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185325">defer</span>&nbsp;<span class="keyword" id="4185331">func</span><span class="op" id="4185335">(</span><span class="op" id="4185336">)</span>&nbsp;<span class="op" id="4185338">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185343"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185344">.</span><span class="ident" id="4185345"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4185348">.</span><span class="ident" id="4185349"><a href="/gostd/net/net.go.html#3336140">SetWriteDeadline</a></span><span class="op" id="4185365">(</span><span class="ident" id="4185366"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4185370">.</span><span class="ident" id="4185371"><a href="/gostd/time/time.go.html#2743088">Now</a></span><span class="op" id="4185374">(</span><span class="op" id="4185375">)</span><span class="op" id="4185376">.</span><span class="ident" id="4185377"><a href="/gostd/time/time.go.html#2738615">Add</a></span><span class="op" id="4185380">(</span><span class="ident" id="4185381"><a href="/gostd/net/http/server.go.html#4185286">d</a></span><span class="op" id="4185382">)</span><span class="op" id="4185383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185387">}</span><span class="op" id="4185388">(</span><span class="op" id="4185389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185396"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185397">.</span><span class="ident" id="4185398"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span><span class="op" id="4185400">.</span><span class="ident" id="4185401"><a href="/gostd/io/io.go.html#1432105">N</a></span>&nbsp;<span class="op" id="4185403">=</span>&nbsp;<span class="ident" id="4185405"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185406">.</span><span class="ident" id="4185407"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4185413">.</span><span class="ident" id="4185414"><a href="/gostd/net/http/server.go.html#4183310">initialLimitedReaderSize</a></span><span class="op" id="4185438">(</span><span class="op" id="4185439">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185442">var</span>&nbsp;<span class="ident" id="4185446">req</span>&nbsp;<span class="op" id="4185450">*</span><span class="ident" id="4185451"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185460">if</span>&nbsp;<span class="ident" id="4185463"><a href="/gostd/net/http/server.go.html#4185446">req</a></span><span class="op" id="4185466">,</span>&nbsp;<span class="ident" id="4185468"><a href="/gostd/net/http/server.go.html#4185134">err</a></span>&nbsp;<span class="op" id="4185472">=</span>&nbsp;<span class="ident" id="4185474"><a href="/gostd/net/http/request.go.html#4152095">ReadRequest</a></span><span class="op" id="4185485">(</span><span class="ident" id="4185486"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185487">.</span><span class="ident" id="4185488"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4185491">.</span><span class="ident" id="4185492"><a href="/gostd/bufio/bufio.go.html#1370946">Reader</a></span><span class="op" id="4185498">)</span><span class="op" id="4185499">;</span>&nbsp;<span class="ident" id="4185501"><a href="/gostd/net/http/server.go.html#4185134">err</a></span>&nbsp;<span class="op" id="4185505">!=</span>&nbsp;<span class="builtintype" id="4185508">nil</span>&nbsp;<span class="op" id="4185512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185516">if</span>&nbsp;<span class="ident" id="4185519"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185520">.</span><span class="ident" id="4185521"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span><span class="op" id="4185523">.</span><span class="ident" id="4185524"><a href="/gostd/io/io.go.html#1432105">N</a></span>&nbsp;<span class="op" id="4185526">==</span>&nbsp;<span class="num" id="4185529">0</span>&nbsp;<span class="op" id="4185531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185536">return</span>&nbsp;<span class="builtintype" id="4185543">nil</span><span class="op" id="4185546">,</span>&nbsp;<span class="ident" id="4185548"><a href="/gostd/net/http/server.go.html#4185000">errTooLarge</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185562">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185566">return</span>&nbsp;<span class="builtintype" id="4185573">nil</span><span class="op" id="4185576">,</span>&nbsp;<span class="ident" id="4185578"><a href="/gostd/net/http/server.go.html#4185134">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185586"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185587">.</span><span class="ident" id="4185588"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span><span class="op" id="4185590">.</span><span class="ident" id="4185591"><a href="/gostd/io/io.go.html#1432105">N</a></span>&nbsp;<span class="op" id="4185593">=</span>&nbsp;<span class="ident" id="4185595"><a href="/gostd/net/http/server.go.html#4181368">noLimit</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185605"><a href="/gostd/net/http/server.go.html#4185446">req</a></span><span class="op" id="4185608">.</span><span class="ident" id="4185609"><a href="/gostd/net/http/request.go.html#4141200">RemoteAddr</a></span>&nbsp;<span class="op" id="4185620">=</span>&nbsp;<span class="ident" id="4185622"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185623">.</span><span class="ident" id="4185624"><a href="/gostd/net/http/server.go.html#4172807">remoteAddr</a></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185636"><a href="/gostd/net/http/server.go.html#4185446">req</a></span><span class="op" id="4185639">.</span><span class="ident" id="4185640"><a href="/gostd/net/http/request.go.html#4141858">TLS</a></span>&nbsp;<span class="op" id="4185644">=</span>&nbsp;<span class="ident" id="4185646"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185647">.</span><span class="ident" id="4185648"><a href="/gostd/net/http/server.go.html#4173393">tlsState</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185659"><a href="/gostd/net/http/server.go.html#4185121">w</a></span>&nbsp;<span class="op" id="4185661">=</span>&nbsp;<span class="op" id="4185663">&amp;</span><span class="ident" id="4185664"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4185672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185676"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4185680">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185691"><a href="/gostd/net/http/server.go.html#4185097">c</a></span><span class="op" id="4185692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185696"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4185699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185711"><a href="/gostd/net/http/server.go.html#4185446">req</a></span><span class="op" id="4185714">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185718"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4185731">:</span>&nbsp;<span class="builtinfunc" id="4185733">make</span><span class="op" id="4185737">(</span><span class="ident" id="4185738"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><span class="op" id="4185744">)</span><span class="op" id="4185745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185749"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span><span class="op" id="4185762">:</span>&nbsp;<span class="op" id="4185764">-</span><span class="num" id="4185765">1</span><span class="op" id="4185766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4185769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185772"><a href="/gostd/net/http/server.go.html#4185121">w</a></span><span class="op" id="4185773">.</span><span class="ident" id="4185774"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4185776">.</span><span class="ident" id="4185777"><a href="/gostd/net/http/server.go.html#4176112">res</a></span>&nbsp;<span class="op" id="4185781">=</span>&nbsp;<span class="ident" id="4185783"><a href="/gostd/net/http/server.go.html#4185121">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185786"><a href="/gostd/net/http/server.go.html#4185121">w</a></span><span class="op" id="4185787">.</span><span class="ident" id="4185788"><a href="/gostd/net/http/server.go.html#4177897">w</a></span>&nbsp;<span class="op" id="4185790">=</span>&nbsp;<span class="ident" id="4185792"><a href="/gostd/net/http/server.go.html#4182579">newBufioWriterSize</a></span><span class="op" id="4185810">(</span><span class="op" id="4185811">&amp;</span><span class="ident" id="4185812"><a href="/gostd/net/http/server.go.html#4185121">w</a></span><span class="op" id="4185813">.</span><span class="ident" id="4185814"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4185816">,</span>&nbsp;<span class="ident" id="4185818"><a href="/gostd/net/http/server.go.html#4175569">bufferBeforeChunkingSize</a></span><span class="op" id="4185842">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185845">return</span>&nbsp;<span class="ident" id="4185852"><a href="/gostd/net/http/server.go.html#4185121">w</a></span><span class="op" id="4185853">,</span>&nbsp;<span class="builtintype" id="4185855">nil</span><br>
<span class="lineno"></span><span class="op" id="4185859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4185862">func</span>&nbsp;<span class="op" id="4185867">(</span><span class="ident" id="4185868">w</span>&nbsp;<span class="op" id="4185870">*</span><span class="ident" id="4185871"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4185879">)</span>&nbsp;<span class="ident" id="4185881">Header</span><span class="op" id="4185887">(</span><span class="op" id="4185888">)</span>&nbsp;<span class="ident" id="4185890"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span>&nbsp;<span class="op" id="4185897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185900">if</span>&nbsp;<span class="ident" id="4185903"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4185904">.</span><span class="ident" id="4185905"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4185907">.</span><span class="ident" id="4185908"><a href="/gostd/net/http/server.go.html#4176346">header</a></span>&nbsp;<span class="op" id="4185915">==</span>&nbsp;<span class="builtintype" id="4185918">nil</span>&nbsp;<span class="op" id="4185922">&amp;&amp;</span>&nbsp;<span class="ident" id="4185925"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4185926">.</span><span class="ident" id="4185927"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4185939">&amp;&amp;</span>&nbsp;<span class="op" id="4185942">!</span><span class="ident" id="4185943"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4185944">.</span><span class="ident" id="4185945"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4185947">.</span><span class="ident" id="4185948"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4185960">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4185964">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4186019">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4186076">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186130"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4186131">.</span><span class="ident" id="4186132"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4186134">.</span><span class="ident" id="4186135"><a href="/gostd/net/http/server.go.html#4176346">header</a></span>&nbsp;<span class="op" id="4186142">=</span>&nbsp;<span class="ident" id="4186144"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4186145">.</span><span class="ident" id="4186146"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4186159">.</span><span class="ident" id="4186160"><a href="/gostd/net/http/header.go.html#4127287">clone</a></span><span class="op" id="4186165">(</span><span class="op" id="4186166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186169">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186172"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4186173">.</span><span class="ident" id="4186174"><a href="/gostd/net/http/server.go.html#4178293">calledHeader</a></span>&nbsp;<span class="op" id="4186187">=</span>&nbsp;<span class="builtintype" id="4186189">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186195">return</span>&nbsp;<span class="ident" id="4186202"><a href="/gostd/net/http/server.go.html#4185868">w</a></span><span class="op" id="4186203">.</span><span class="ident" id="4186204"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><br>
<span class="lineno"></span><span class="op" id="4186218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4186221">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="4186292">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4186359">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="4186429">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="4186497">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4186517">//</span><br>
<span class="lineno">625</span><span class="comment" id="4186520">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4186588">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4186658">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="4186677">const</span>&nbsp;<span class="ident" id="4186683">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4186707">=</span>&nbsp;<span class="num" id="4186709">256</span>&nbsp;<span class="op" id="4186713">&lt;&lt;</span>&nbsp;<span class="num" id="4186716">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="4186720">func</span>&nbsp;<span class="op" id="4186725">(</span><span class="ident" id="4186726">w</span>&nbsp;<span class="op" id="4186728">*</span><span class="ident" id="4186729"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4186737">)</span>&nbsp;<span class="ident" id="4186739">WriteHeader</span><span class="op" id="4186750">(</span><span class="ident" id="4186751">code</span>&nbsp;<span class="builtintype" id="4186756">int</span><span class="op" id="4186759">)</span>&nbsp;<span class="op" id="4186761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186764">if</span>&nbsp;<span class="ident" id="4186767"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186768">.</span><span class="ident" id="4186769"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4186773">.</span><span class="ident" id="4186774"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4186782">(</span><span class="op" id="4186783">)</span>&nbsp;<span class="op" id="4186785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186789"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186790">.</span><span class="ident" id="4186791"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4186795">.</span><span class="ident" id="4186796"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4186802">.</span><span class="ident" id="4186803"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4186807">(</span><span class="string" id="4186808">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4186859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186871">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186874">if</span>&nbsp;<span class="ident" id="4186877"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186878">.</span><span class="ident" id="4186879"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4186891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186895"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186896">.</span><span class="ident" id="4186897"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4186901">.</span><span class="ident" id="4186902"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4186908">.</span><span class="ident" id="4186909"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4186913">(</span><span class="string" id="4186914">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="4186957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186961">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186972"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186973">.</span><span class="ident" id="4186974"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4186986">=</span>&nbsp;<span class="builtintype" id="4186988">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186994"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4186995">.</span><span class="ident" id="4186996"><a href="/gostd/net/http/server.go.html#4178481">status</a></span>&nbsp;<span class="op" id="4187003">=</span>&nbsp;<span class="ident" id="4187005"><a href="/gostd/net/http/server.go.html#4186751">code</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187012">if</span>&nbsp;<span class="ident" id="4187015"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187016">.</span><span class="ident" id="4187017"><a href="/gostd/net/http/server.go.html#4178293">calledHeader</a></span>&nbsp;<span class="op" id="4187030">&amp;&amp;</span>&nbsp;<span class="ident" id="4187033"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187034">.</span><span class="ident" id="4187035"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4187037">.</span><span class="ident" id="4187038"><a href="/gostd/net/http/server.go.html#4176346">header</a></span>&nbsp;<span class="op" id="4187045">==</span>&nbsp;<span class="builtintype" id="4187048">nil</span>&nbsp;<span class="op" id="4187052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187056"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187057">.</span><span class="ident" id="4187058"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4187060">.</span><span class="ident" id="4187061"><a href="/gostd/net/http/server.go.html#4176346">header</a></span>&nbsp;<span class="op" id="4187068">=</span>&nbsp;<span class="ident" id="4187070"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187071">.</span><span class="ident" id="4187072"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4187085">.</span><span class="ident" id="4187086"><a href="/gostd/net/http/header.go.html#4127287">clone</a></span><span class="op" id="4187091">(</span><span class="op" id="4187092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187095">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187099">if</span>&nbsp;<span class="ident" id="4187102">cl</span>&nbsp;<span class="op" id="4187105">:=</span>&nbsp;<span class="ident" id="4187108"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187109">.</span><span class="ident" id="4187110"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4187123">.</span><span class="ident" id="4187124"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4187127">(</span><span class="string" id="4187128">&#34;Content-Length&#34;</span><span class="op" id="4187144">)</span><span class="op" id="4187145">;</span>&nbsp;<span class="ident" id="4187147"><a href="/gostd/net/http/server.go.html#4187102">cl</a></span>&nbsp;<span class="op" id="4187150">!=</span>&nbsp;<span class="string" id="4187153">&#34;&#34;</span>&nbsp;<span class="op" id="4187156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187160">v</span><span class="op" id="4187161">,</span>&nbsp;<span class="ident" id="4187163">err</span>&nbsp;<span class="op" id="4187167">:=</span>&nbsp;<span class="ident" id="4187170"><a href="/gostd/net/http/server.go.html#4169389">strconv</a></span><span class="op" id="4187177">.</span><span class="ident" id="4187178"><a href="/gostd/strconv/atoi.go.html#2356133">ParseInt</a></span><span class="op" id="4187186">(</span><span class="ident" id="4187187"><a href="/gostd/net/http/server.go.html#4187102">cl</a></span><span class="op" id="4187189">,</span>&nbsp;<span class="num" id="4187191">10</span><span class="op" id="4187193">,</span>&nbsp;<span class="num" id="4187195">64</span><span class="op" id="4187197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187201">if</span>&nbsp;<span class="ident" id="4187204"><a href="/gostd/net/http/server.go.html#4187163">err</a></span>&nbsp;<span class="op" id="4187208">==</span>&nbsp;<span class="builtintype" id="4187211">nil</span>&nbsp;<span class="op" id="4187215">&amp;&amp;</span>&nbsp;<span class="ident" id="4187218"><a href="/gostd/net/http/server.go.html#4187160">v</a></span>&nbsp;<span class="op" id="4187220">&gt;=</span>&nbsp;<span class="num" id="4187223">0</span>&nbsp;<span class="op" id="4187225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187230"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187231">.</span><span class="ident" id="4187232"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4187246">=</span>&nbsp;<span class="ident" id="4187248"><a href="/gostd/net/http/server.go.html#4187160">v</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187252">}</span>&nbsp;<span class="keyword" id="4187254">else</span>&nbsp;<span class="op" id="4187259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187264"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187265">.</span><span class="ident" id="4187266"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4187270">.</span><span class="ident" id="4187271"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4187277">.</span><span class="ident" id="4187278"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4187282">(</span><span class="string" id="4187283">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="4187319">,</span>&nbsp;<span class="ident" id="4187321"><a href="/gostd/net/http/server.go.html#4187102">cl</a></span><span class="op" id="4187323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187328"><a href="/gostd/net/http/server.go.html#4186726">w</a></span><span class="op" id="4187329">.</span><span class="ident" id="4187330"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><span class="op" id="4187343">.</span><span class="ident" id="4187344"><a href="/gostd/net/http/header.go.html#4127099">Del</a></span><span class="op" id="4187347">(</span><span class="string" id="4187348">&#34;Content-Length&#34;</span><span class="op" id="4187364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187371">}</span><br>
<span class="lineno">655</span><span class="op" id="4187373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4187376">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="4187457">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="4187536">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="4187593">type</span>&nbsp;<span class="ident" id="4187598">extraHeader</span>&nbsp;<span class="keyword" id="4187610">struct</span>&nbsp;<span class="op" id="4187617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187620">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4187637">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187645">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4187662">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187670">transferEncoding</span>&nbsp;<span class="builtintype" id="4187687">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187695">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187712">[</span><span class="op" id="4187713">]</span><span class="builtintype" id="4187714">byte</span>&nbsp;<span class="comment" id="4187719">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187742">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187759">[</span><span class="op" id="4187760">]</span><span class="builtintype" id="4187761">byte</span>&nbsp;<span class="comment" id="4187766">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4187788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4187791">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="4187839">var</span>&nbsp;<span class="ident" id="4187843">extraHeaderKeys</span>&nbsp;<span class="op" id="4187859">=</span>&nbsp;<span class="op" id="4187861">[</span><span class="op" id="4187862">]</span><span class="op" id="4187863">[</span><span class="op" id="4187864">]</span><span class="builtintype" id="4187865">byte</span><span class="op" id="4187869">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187872">[</span><span class="op" id="4187873">]</span><span class="builtintype" id="4187874">byte</span><span class="op" id="4187878">(</span><span class="string" id="4187879">&#34;Content-Type&#34;</span><span class="op" id="4187893">)</span><span class="op" id="4187894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187897">[</span><span class="op" id="4187898">]</span><span class="builtintype" id="4187899">byte</span><span class="op" id="4187903">(</span><span class="string" id="4187904">&#34;Connection&#34;</span><span class="op" id="4187916">)</span><span class="op" id="4187917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187920">[</span><span class="op" id="4187921">]</span><span class="builtintype" id="4187922">byte</span><span class="op" id="4187926">(</span><span class="string" id="4187927">&#34;Transfer-Encoding&#34;</span><span class="op" id="4187946">)</span><span class="op" id="4187947">,</span><br>
<span class="lineno"></span><span class="op" id="4187949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="4187952">var</span>&nbsp;<span class="op" id="4187956">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187959">headerContentLength</span>&nbsp;<span class="op" id="4187979">=</span>&nbsp;<span class="op" id="4187981">[</span><span class="op" id="4187982">]</span><span class="builtintype" id="4187983">byte</span><span class="op" id="4187987">(</span><span class="string" id="4187988">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4188006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188009">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188029">=</span>&nbsp;<span class="op" id="4188031">[</span><span class="op" id="4188032">]</span><span class="builtintype" id="4188033">byte</span><span class="op" id="4188037">(</span><span class="string" id="4188038">&#34;Date:&nbsp;&#34;</span><span class="op" id="4188046">)</span><br>
<span class="lineno"></span><span class="op" id="4188048">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="4188051">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4188100">//</span><br>
<span class="lineno"></span><span class="comment" id="4188103">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="4188172">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4188242">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="4188301">func</span>&nbsp;<span class="op" id="4188306">(</span><span class="ident" id="4188307">h</span>&nbsp;<span class="ident" id="4188309"><a href="/gostd/net/http/server.go.html#4187598">extraHeader</a></span><span class="op" id="4188320">)</span>&nbsp;<span class="ident" id="4188322">Write</span><span class="op" id="4188327">(</span><span class="ident" id="4188328">w</span>&nbsp;<span class="op" id="4188330">*</span><span class="ident" id="4188331"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4188336">.</span><span class="ident" id="4188337"><a href="/gostd/bufio/bufio.go.html#1366565">Writer</a></span><span class="op" id="4188343">)</span>&nbsp;<span class="op" id="4188345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188348">if</span>&nbsp;<span class="ident" id="4188351"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188352">.</span><span class="ident" id="4188353"><a href="/gostd/net/http/server.go.html#4187695">date</a></span>&nbsp;<span class="op" id="4188358">!=</span>&nbsp;<span class="builtintype" id="4188361">nil</span>&nbsp;<span class="op" id="4188365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188369"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188370">.</span><span class="ident" id="4188371"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188376">(</span><span class="ident" id="4188377"><a href="/gostd/net/http/server.go.html#4188009">headerDate</a></span><span class="op" id="4188387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188391"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188392">.</span><span class="ident" id="4188393"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188398">(</span><span class="ident" id="4188399"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188400">.</span><span class="ident" id="4188401"><a href="/gostd/net/http/server.go.html#4187695">date</a></span><span class="op" id="4188405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188409"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188410">.</span><span class="ident" id="4188411"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188416">(</span><span class="ident" id="4188417"><a href="/gostd/net/http/server.go.html#4176688">crlf</a></span><span class="op" id="4188421">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188427">if</span>&nbsp;<span class="ident" id="4188430"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188431">.</span><span class="ident" id="4188432"><a href="/gostd/net/http/server.go.html#4187742">contentLength</a></span>&nbsp;<span class="op" id="4188446">!=</span>&nbsp;<span class="builtintype" id="4188449">nil</span>&nbsp;<span class="op" id="4188453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188457"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188458">.</span><span class="ident" id="4188459"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188464">(</span><span class="ident" id="4188465"><a href="/gostd/net/http/server.go.html#4187959">headerContentLength</a></span><span class="op" id="4188484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188488"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188489">.</span><span class="ident" id="4188490"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188495">(</span><span class="ident" id="4188496"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188497">.</span><span class="ident" id="4188498"><a href="/gostd/net/http/server.go.html#4187742">contentLength</a></span><span class="op" id="4188511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188515"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188516">.</span><span class="ident" id="4188517"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188522">(</span><span class="ident" id="4188523"><a href="/gostd/net/http/server.go.html#4176688">crlf</a></span><span class="op" id="4188527">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188533">for</span>&nbsp;<span class="ident" id="4188537">i</span><span class="op" id="4188538">,</span>&nbsp;<span class="ident" id="4188540">v</span>&nbsp;<span class="op" id="4188542">:=</span>&nbsp;<span class="keyword" id="4188545">range</span>&nbsp;<span class="op" id="4188551">[</span><span class="op" id="4188552">]</span><span class="builtintype" id="4188553">string</span><span class="op" id="4188559">{</span><span class="ident" id="4188560"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188561">.</span><span class="ident" id="4188562"><a href="/gostd/net/http/server.go.html#4187620">contentType</a></span><span class="op" id="4188573">,</span>&nbsp;<span class="ident" id="4188575"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188576">.</span><span class="ident" id="4188577"><a href="/gostd/net/http/server.go.html#4187645">connection</a></span><span class="op" id="4188587">,</span>&nbsp;<span class="ident" id="4188589"><a href="/gostd/net/http/server.go.html#4188307">h</a></span><span class="op" id="4188590">.</span><span class="ident" id="4188591"><a href="/gostd/net/http/server.go.html#4187670">transferEncoding</a></span><span class="op" id="4188607">}</span>&nbsp;<span class="op" id="4188609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188613">if</span>&nbsp;<span class="ident" id="4188616"><a href="/gostd/net/http/server.go.html#4188540">v</a></span>&nbsp;<span class="op" id="4188618">!=</span>&nbsp;<span class="string" id="4188621">&#34;&#34;</span>&nbsp;<span class="op" id="4188624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188629"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188630">.</span><span class="ident" id="4188631"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188636">(</span><span class="ident" id="4188637"><a href="/gostd/net/http/server.go.html#4187843">extraHeaderKeys</a></span><span class="op" id="4188652">[</span><span class="ident" id="4188653"><a href="/gostd/net/http/server.go.html#4188537">i</a></span><span class="op" id="4188654">]</span><span class="op" id="4188655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188660"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188661">.</span><span class="ident" id="4188662"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188667">(</span><span class="ident" id="4188668"><a href="/gostd/net/http/server.go.html#4176717">colonSpace</a></span><span class="op" id="4188678">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188683"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188684">.</span><span class="ident" id="4188685"><a href="/gostd/bufio/bufio.go.html#1369779">WriteString</a></span><span class="op" id="4188696">(</span><span class="ident" id="4188697"><a href="/gostd/net/http/server.go.html#4188540">v</a></span><span class="op" id="4188698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188703"><a href="/gostd/net/http/server.go.html#4188328">w</a></span><span class="op" id="4188704">.</span><span class="ident" id="4188705"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4188710">(</span><span class="ident" id="4188711"><a href="/gostd/net/http/server.go.html#4176688">crlf</a></span><span class="op" id="4188715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188722">}</span><br>
<span class="lineno"></span><span class="op" id="4188724">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="4188727">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4188796">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="4188819">//</span><br>
<span class="lineno"></span><span class="comment" id="4188822">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="4188893">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4188963">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4189032">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4189098">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="4189110">func</span>&nbsp;<span class="op" id="4189115">(</span><span class="ident" id="4189116">cw</span>&nbsp;<span class="op" id="4189119">*</span><span class="ident" id="4189120"><a href="/gostd/net/http/server.go.html#4176090">chunkWriter</a></span><span class="op" id="4189131">)</span>&nbsp;<span class="ident" id="4189133">writeHeader</span><span class="op" id="4189144">(</span><span class="ident" id="4189145">p</span>&nbsp;<span class="op" id="4189147">[</span><span class="op" id="4189148">]</span><span class="builtintype" id="4189149">byte</span><span class="op" id="4189153">)</span>&nbsp;<span class="op" id="4189155">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189158">if</span>&nbsp;<span class="ident" id="4189161"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4189163">.</span><span class="ident" id="4189164"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4189176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189180">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189191"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4189193">.</span><span class="ident" id="4189194"><a href="/gostd/net/http/server.go.html#4176560">wroteHeader</a></span>&nbsp;<span class="op" id="4189206">=</span>&nbsp;<span class="builtintype" id="4189208">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189215">w</span>&nbsp;<span class="op" id="4189217">:=</span>&nbsp;<span class="ident" id="4189220"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4189222">.</span><span class="ident" id="4189223"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189228">keepAlivesEnabled</span>&nbsp;<span class="op" id="4189246">:=</span>&nbsp;<span class="ident" id="4189249"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4189250">.</span><span class="ident" id="4189251"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4189255">.</span><span class="ident" id="4189256"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4189262">.</span><span class="ident" id="4189263"><a href="/gostd/net/http/server.go.html#4221280">doKeepAlives</a></span><span class="op" id="4189275">(</span><span class="op" id="4189276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189279">isHEAD</span>&nbsp;<span class="op" id="4189286">:=</span>&nbsp;<span class="ident" id="4189289"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4189290">.</span><span class="ident" id="4189291"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4189294">.</span><span class="ident" id="4189295"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4189302">==</span>&nbsp;<span class="string" id="4189305">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189314">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189378">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189440">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189496">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189558">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189586">header</span>&nbsp;<span class="op" id="4189593">:=</span>&nbsp;<span class="ident" id="4189596"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4189598">.</span><span class="ident" id="4189599"><a href="/gostd/net/http/server.go.html#4176346">header</a></span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189607">owned</span>&nbsp;<span class="op" id="4189613">:=</span>&nbsp;<span class="ident" id="4189616"><a href="/gostd/net/http/server.go.html#4189586">header</a></span>&nbsp;<span class="op" id="4189623">!=</span>&nbsp;<span class="builtintype" id="4189626">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189631">if</span>&nbsp;<span class="op" id="4189634">!</span><span class="ident" id="4189635"><a href="/gostd/net/http/server.go.html#4189607">owned</a></span>&nbsp;<span class="op" id="4189641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189645"><a href="/gostd/net/http/server.go.html#4189586">header</a></span>&nbsp;<span class="op" id="4189652">=</span>&nbsp;<span class="ident" id="4189654"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4189655">.</span><span class="ident" id="4189656"><a href="/gostd/net/http/server.go.html#4178271">handlerHeader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189674">var</span>&nbsp;<span class="ident" id="4189678">excludeHeader</span>&nbsp;<span class="keyword" id="4189692">map</span><span class="op" id="4189695">[</span><span class="builtintype" id="4189696">string</span><span class="op" id="4189702">]</span><span class="builtintype" id="4189703">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189709">delHeader</span>&nbsp;<span class="op" id="4189719">:=</span>&nbsp;<span class="keyword" id="4189722">func</span><span class="op" id="4189726">(</span><span class="ident" id="4189727">key</span>&nbsp;<span class="builtintype" id="4189731">string</span><span class="op" id="4189737">)</span>&nbsp;<span class="op" id="4189739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189743">if</span>&nbsp;<span class="ident" id="4189746"><a href="/gostd/net/http/server.go.html#4189607">owned</a></span>&nbsp;<span class="op" id="4189752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189757"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4189763">.</span><span class="ident" id="4189764"><a href="/gostd/net/http/header.go.html#4127099">Del</a></span><span class="op" id="4189767">(</span><span class="ident" id="4189768"><a href="/gostd/net/http/server.go.html#4189727">key</a></span><span class="op" id="4189771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189776">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189785">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189789">if</span>&nbsp;<span class="ident" id="4189792">_</span><span class="op" id="4189793">,</span>&nbsp;<span class="ident" id="4189795">ok</span>&nbsp;<span class="op" id="4189798">:=</span>&nbsp;<span class="ident" id="4189801"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4189807">[</span><span class="ident" id="4189808"><a href="/gostd/net/http/server.go.html#4189727">key</a></span><span class="op" id="4189811">]</span><span class="op" id="4189812">;</span>&nbsp;<span class="op" id="4189814">!</span><span class="ident" id="4189815"><a href="/gostd/net/http/server.go.html#4189795">ok</a></span>&nbsp;<span class="op" id="4189818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189823">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189836">if</span>&nbsp;<span class="ident" id="4189839"><a href="/gostd/net/http/server.go.html#4189678">excludeHeader</a></span>&nbsp;<span class="op" id="4189853">==</span>&nbsp;<span class="builtintype" id="4189856">nil</span>&nbsp;<span class="op" id="4189860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189865"><a href="/gostd/net/http/server.go.html#4189678">excludeHeader</a></span>&nbsp;<span class="op" id="4189879">=</span>&nbsp;<span class="builtinfunc" id="4189881">make</span><span class="op" id="4189885">(</span><span class="keyword" id="4189886">map</span><span class="op" id="4189889">[</span><span class="builtintype" id="4189890">string</span><span class="op" id="4189896">]</span><span class="builtintype" id="4189897">bool</span><span class="op" id="4189901">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189909"><a href="/gostd/net/http/server.go.html#4189678">excludeHeader</a></span><span class="op" id="4189922">[</span><span class="ident" id="4189923"><a href="/gostd/net/http/server.go.html#4189727">key</a></span><span class="op" id="4189926">]</span>&nbsp;<span class="op" id="4189928">=</span>&nbsp;<span class="builtintype" id="4189930">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189939">var</span>&nbsp;<span class="ident" id="4189943">setHeader</span>&nbsp;<span class="ident" id="4189953"><a href="/gostd/net/http/server.go.html#4187598">extraHeader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189967">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190026">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190090">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190151">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190187">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190258">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190322">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190384">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190448">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190512">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190572">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190634">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190668">if</span>&nbsp;<span class="ident" id="4190671"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4190672">.</span><span class="ident" id="4190673"><a href="/gostd/net/http/server.go.html#4179131">handlerDone</a></span>&nbsp;<span class="op" id="4190685">&amp;&amp;</span>&nbsp;<span class="ident" id="4190688"><a href="/gostd/net/http/transfer.go.html#4247111">bodyAllowedForStatus</a></span><span class="op" id="4190708">(</span><span class="ident" id="4190709"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4190710">.</span><span class="ident" id="4190711"><a href="/gostd/net/http/server.go.html#4178481">status</a></span><span class="op" id="4190717">)</span>&nbsp;<span class="op" id="4190719">&amp;&amp;</span>&nbsp;<span class="ident" id="4190722"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4190728">.</span><span class="ident" id="4190729"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4190732">(</span><span class="string" id="4190733">&#34;Content-Length&#34;</span><span class="op" id="4190749">)</span>&nbsp;<span class="op" id="4190751">==</span>&nbsp;<span class="string" id="4190754">&#34;&#34;</span>&nbsp;<span class="op" id="4190757">&amp;&amp;</span>&nbsp;<span class="op" id="4190760">(</span><span class="op" id="4190761">!</span><span class="ident" id="4190762"><a href="/gostd/net/http/server.go.html#4189279">isHEAD</a></span>&nbsp;<span class="op" id="4190769">||</span>&nbsp;<span class="builtinfunc" id="4190772">len</span><span class="op" id="4190775">(</span><span class="ident" id="4190776"><a href="/gostd/net/http/server.go.html#4189145">p</a></span><span class="op" id="4190777">)</span>&nbsp;<span class="op" id="4190779">&gt;</span>&nbsp;<span class="num" id="4190781">0</span><span class="op" id="4190782">)</span>&nbsp;<span class="op" id="4190784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190788"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4190789">.</span><span class="ident" id="4190790"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4190804">=</span>&nbsp;<span class="builtintype" id="4190806">int64</span><span class="op" id="4190811">(</span><span class="builtinfunc" id="4190812">len</span><span class="op" id="4190815">(</span><span class="ident" id="4190816"><a href="/gostd/net/http/server.go.html#4189145">p</a></span><span class="op" id="4190817">)</span><span class="op" id="4190818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190822"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4190831">.</span><span class="ident" id="4190832"><a href="/gostd/net/http/server.go.html#4187742">contentLength</a></span>&nbsp;<span class="op" id="4190846">=</span>&nbsp;<span class="ident" id="4190848"><a href="/gostd/net/http/server.go.html#4169389">strconv</a></span><span class="op" id="4190855">.</span><span class="ident" id="4190856"><a href="/gostd/strconv/itoa.go.html#2407474">AppendInt</a></span><span class="op" id="4190865">(</span><span class="ident" id="4190866"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4190868">.</span><span class="ident" id="4190869"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4190872">.</span><span class="ident" id="4190873"><a href="/gostd/net/http/server.go.html#4179256">clenBuf</a></span><span class="op" id="4190880">[</span><span class="op" id="4190881">:</span><span class="num" id="4190882">0</span><span class="op" id="4190883">]</span><span class="op" id="4190884">,</span>&nbsp;<span class="builtintype" id="4190886">int64</span><span class="op" id="4190891">(</span><span class="builtinfunc" id="4190892">len</span><span class="op" id="4190895">(</span><span class="ident" id="4190896"><a href="/gostd/net/http/server.go.html#4189145">p</a></span><span class="op" id="4190897">)</span><span class="op" id="4190898">)</span><span class="op" id="4190899">,</span>&nbsp;<span class="num" id="4190901">10</span><span class="op" id="4190903">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190910">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4190976">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191044">if</span>&nbsp;<span class="ident" id="4191047"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191048">.</span><span class="ident" id="4191049"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4191052">.</span><span class="ident" id="4191053"><a href="/gostd/net/http/request.go.html#4160667">wantsHttp10KeepAlive</a></span><span class="op" id="4191073">(</span><span class="op" id="4191074">)</span>&nbsp;<span class="op" id="4191076">&amp;&amp;</span>&nbsp;<span class="ident" id="4191079"><a href="/gostd/net/http/server.go.html#4189228">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="4191097">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191101">sentLength</span>&nbsp;<span class="op" id="4191112">:=</span>&nbsp;<span class="ident" id="4191115"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4191121">.</span><span class="ident" id="4191122"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4191125">(</span><span class="string" id="4191126">&#34;Content-Length&#34;</span><span class="op" id="4191142">)</span>&nbsp;<span class="op" id="4191144">!=</span>&nbsp;<span class="string" id="4191147">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191152">if</span>&nbsp;<span class="ident" id="4191155"><a href="/gostd/net/http/server.go.html#4191101">sentLength</a></span>&nbsp;<span class="op" id="4191166">&amp;&amp;</span>&nbsp;<span class="ident" id="4191169"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4191175">.</span><span class="ident" id="4191176"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4191179">(</span><span class="string" id="4191180">&#34;Connection&#34;</span><span class="op" id="4191192">)</span>&nbsp;<span class="op" id="4191194">==</span>&nbsp;<span class="string" id="4191197">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="4191210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191215"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191216">.</span><span class="ident" id="4191217"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4191233">=</span>&nbsp;<span class="builtintype" id="4191235">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191246">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191250">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191310">hasCL</span>&nbsp;<span class="op" id="4191316">:=</span>&nbsp;<span class="ident" id="4191319"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191320">.</span><span class="ident" id="4191321"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4191335">!=</span>&nbsp;<span class="op" id="4191338">-</span><span class="num" id="4191339">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191343">if</span>&nbsp;<span class="ident" id="4191346"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191347">.</span><span class="ident" id="4191348"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4191351">.</span><span class="ident" id="4191352"><a href="/gostd/net/http/request.go.html#4160667">wantsHttp10KeepAlive</a></span><span class="op" id="4191372">(</span><span class="op" id="4191373">)</span>&nbsp;<span class="op" id="4191375">&amp;&amp;</span>&nbsp;<span class="op" id="4191378">(</span><span class="ident" id="4191379"><a href="/gostd/net/http/server.go.html#4189279">isHEAD</a></span>&nbsp;<span class="op" id="4191386">||</span>&nbsp;<span class="ident" id="4191389"><a href="/gostd/net/http/server.go.html#4191310">hasCL</a></span><span class="op" id="4191394">)</span>&nbsp;<span class="op" id="4191396">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191400">_</span><span class="op" id="4191401">,</span>&nbsp;<span class="ident" id="4191403">connectionHeaderSet</span>&nbsp;<span class="op" id="4191423">:=</span>&nbsp;<span class="ident" id="4191426"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4191432">[</span><span class="string" id="4191433">&#34;Connection&#34;</span><span class="op" id="4191445">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191449">if</span>&nbsp;<span class="op" id="4191452">!</span><span class="ident" id="4191453"><a href="/gostd/net/http/server.go.html#4191403">connectionHeaderSet</a></span>&nbsp;<span class="op" id="4191473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191478"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4191487">.</span><span class="ident" id="4191488"><a href="/gostd/net/http/server.go.html#4187645">connection</a></span>&nbsp;<span class="op" id="4191499">=</span>&nbsp;<span class="string" id="4191501">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191519">}</span>&nbsp;<span class="keyword" id="4191521">else</span>&nbsp;<span class="keyword" id="4191526">if</span>&nbsp;<span class="op" id="4191529">!</span><span class="ident" id="4191530"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191531">.</span><span class="ident" id="4191532"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4191535">.</span><span class="ident" id="4191536"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4191548">(</span><span class="num" id="4191549">1</span><span class="op" id="4191550">,</span>&nbsp;<span class="num" id="4191552">1</span><span class="op" id="4191553">)</span>&nbsp;<span class="op" id="4191555">||</span>&nbsp;<span class="ident" id="4191558"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191559">.</span><span class="ident" id="4191560"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4191563">.</span><span class="ident" id="4191564"><a href="/gostd/net/http/request.go.html#4160840">wantsClose</a></span><span class="op" id="4191574">(</span><span class="op" id="4191575">)</span>&nbsp;<span class="op" id="4191577">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191581"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191582">.</span><span class="ident" id="4191583"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4191599">=</span>&nbsp;<span class="builtintype" id="4191601">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191611">if</span>&nbsp;<span class="ident" id="4191614"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4191620">.</span><span class="ident" id="4191621"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4191624">(</span><span class="string" id="4191625">&#34;Connection&#34;</span><span class="op" id="4191637">)</span>&nbsp;<span class="op" id="4191639">==</span>&nbsp;<span class="string" id="4191642">&#34;close&#34;</span>&nbsp;<span class="op" id="4191650">||</span>&nbsp;<span class="op" id="4191653">!</span><span class="ident" id="4191654"><a href="/gostd/net/http/server.go.html#4189228">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="4191672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191676"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191677">.</span><span class="ident" id="4191678"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4191694">=</span>&nbsp;<span class="builtintype" id="4191696">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191706">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191766">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191827">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4191888">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191939">if</span>&nbsp;<span class="ident" id="4191942"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191943">.</span><span class="ident" id="4191944"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4191947">.</span><span class="ident" id="4191948"><a href="/gostd/net/http/request.go.html#4138292">ContentLength</a></span>&nbsp;<span class="op" id="4191962">!=</span>&nbsp;<span class="num" id="4191965">0</span>&nbsp;<span class="op" id="4191967">&amp;&amp;</span>&nbsp;<span class="op" id="4191970">!</span><span class="ident" id="4191971"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4191972">.</span><span class="ident" id="4191973"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4191989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191993">ecr</span><span class="op" id="4191996">,</span>&nbsp;<span class="ident" id="4191998">isExpecter</span>&nbsp;<span class="op" id="4192009">:=</span>&nbsp;<span class="ident" id="4192012"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192013">.</span><span class="ident" id="4192014"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4192017">.</span><span class="ident" id="4192018"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4192022">.</span><span class="op" id="4192023">(</span><span class="op" id="4192024">*</span><span class="ident" id="4192025"><a href="/gostd/net/http/server.go.html#4183506">expectContinueReader</a></span><span class="op" id="4192045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192049">if</span>&nbsp;<span class="op" id="4192052">!</span><span class="ident" id="4192053"><a href="/gostd/net/http/server.go.html#4191998">isExpecter</a></span>&nbsp;<span class="op" id="4192064">||</span>&nbsp;<span class="ident" id="4192067"><a href="/gostd/net/http/server.go.html#4191993">ecr</a></span><span class="op" id="4192070">.</span><span class="ident" id="4192071"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4192075">.</span><span class="ident" id="4192076"><a href="/gostd/net/http/server.go.html#4177835">wroteContinue</a></span>&nbsp;<span class="op" id="4192090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192095">n</span><span class="op" id="4192096">,</span>&nbsp;<span class="ident" id="4192098">_</span>&nbsp;<span class="op" id="4192100">:=</span>&nbsp;<span class="ident" id="4192103"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4192105">.</span><span class="ident" id="4192106"><a href="/gostd/io/io.go.html#1430100">CopyN</a></span><span class="op" id="4192111">(</span><span class="ident" id="4192112"><a href="/gostd/net/http/server.go.html#4169326">ioutil</a></span><span class="op" id="4192118">.</span><span class="ident" id="4192119"><a href="/gostd/io/ioutil/ioutil.go.html#3768458">Discard</a></span><span class="op" id="4192126">,</span>&nbsp;<span class="ident" id="4192128"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192129">.</span><span class="ident" id="4192130"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4192133">.</span><span class="ident" id="4192134"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4192138">,</span>&nbsp;<span class="ident" id="4192140"><a href="/gostd/net/http/server.go.html#4186683">maxPostHandlerReadBytes</a></span><span class="op" id="4192163">+</span><span class="num" id="4192164">1</span><span class="op" id="4192165">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192170">if</span>&nbsp;<span class="ident" id="4192173"><a href="/gostd/net/http/server.go.html#4192095">n</a></span>&nbsp;<span class="op" id="4192175">&gt;=</span>&nbsp;<span class="ident" id="4192178"><a href="/gostd/net/http/server.go.html#4186683">maxPostHandlerReadBytes</a></span>&nbsp;<span class="op" id="4192202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192208"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192209">.</span><span class="ident" id="4192210"><a href="/gostd/net/http/server.go.html#4179396">requestTooLarge</a></span><span class="op" id="4192225">(</span><span class="op" id="4192226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192232"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4192241">(</span><span class="string" id="4192242">&#34;Connection&#34;</span><span class="op" id="4192254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192260"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4192269">.</span><span class="ident" id="4192270"><a href="/gostd/net/http/server.go.html#4187645">connection</a></span>&nbsp;<span class="op" id="4192281">=</span>&nbsp;<span class="string" id="4192283">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192294">}</span>&nbsp;<span class="keyword" id="4192296">else</span>&nbsp;<span class="op" id="4192301">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192307"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192308">.</span><span class="ident" id="4192309"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4192312">.</span><span class="ident" id="4192313"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4192317">.</span><span class="ident" id="4192318"><a href="/gostd/io/io.go.html#1422583">Close</a></span><span class="op" id="4192323">(</span><span class="op" id="4192324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192340">code</span>&nbsp;<span class="op" id="4192345">:=</span>&nbsp;<span class="ident" id="4192348"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192349">.</span><span class="ident" id="4192350"><a href="/gostd/net/http/server.go.html#4178481">status</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192358">if</span>&nbsp;<span class="ident" id="4192361"><a href="/gostd/net/http/transfer.go.html#4247111">bodyAllowedForStatus</a></span><span class="op" id="4192381">(</span><span class="ident" id="4192382"><a href="/gostd/net/http/server.go.html#4192340">code</a></span><span class="op" id="4192386">)</span>&nbsp;<span class="op" id="4192388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192392">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192451">_</span><span class="op" id="4192452">,</span>&nbsp;<span class="ident" id="4192454">haveType</span>&nbsp;<span class="op" id="4192463">:=</span>&nbsp;<span class="ident" id="4192466"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4192472">[</span><span class="string" id="4192473">&#34;Content-Type&#34;</span><span class="op" id="4192487">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192491">if</span>&nbsp;<span class="op" id="4192494">!</span><span class="ident" id="4192495"><a href="/gostd/net/http/server.go.html#4192454">haveType</a></span>&nbsp;<span class="op" id="4192504">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192509"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4192518">.</span><span class="ident" id="4192519"><a href="/gostd/net/http/server.go.html#4187620">contentType</a></span>&nbsp;<span class="op" id="4192531">=</span>&nbsp;<span class="ident" id="4192533"><a href="/gostd/net/http/sniff.go.html#4231277">DetectContentType</a></span><span class="op" id="4192550">(</span><span class="ident" id="4192551"><a href="/gostd/net/http/server.go.html#4189145">p</a></span><span class="op" id="4192552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192559">}</span>&nbsp;<span class="keyword" id="4192561">else</span>&nbsp;<span class="op" id="4192566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192570">for</span>&nbsp;<span class="ident" id="4192574">_</span><span class="op" id="4192575">,</span>&nbsp;<span class="ident" id="4192577">k</span>&nbsp;<span class="op" id="4192579">:=</span>&nbsp;<span class="keyword" id="4192582">range</span>&nbsp;<span class="ident" id="4192588"><a href="/gostd/net/http/transfer.go.html#4247485">suppressedHeaders</a></span><span class="op" id="4192605">(</span><span class="ident" id="4192606"><a href="/gostd/net/http/server.go.html#4192340">code</a></span><span class="op" id="4192610">)</span>&nbsp;<span class="op" id="4192612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192617"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4192626">(</span><span class="ident" id="4192627"><a href="/gostd/net/http/server.go.html#4192577">k</a></span><span class="op" id="4192628">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192639">if</span>&nbsp;<span class="ident" id="4192642">_</span><span class="op" id="4192643">,</span>&nbsp;<span class="ident" id="4192645">ok</span>&nbsp;<span class="op" id="4192648">:=</span>&nbsp;<span class="ident" id="4192651"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4192657">[</span><span class="string" id="4192658">&#34;Date&#34;</span><span class="op" id="4192664">]</span><span class="op" id="4192665">;</span>&nbsp;<span class="op" id="4192667">!</span><span class="ident" id="4192668"><a href="/gostd/net/http/server.go.html#4192645">ok</a></span>&nbsp;<span class="op" id="4192671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192675"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4192684">.</span><span class="ident" id="4192685"><a href="/gostd/net/http/server.go.html#4187695">date</a></span>&nbsp;<span class="op" id="4192690">=</span>&nbsp;<span class="ident" id="4192692"><a href="/gostd/net/http/server.go.html#4184384">appendTime</a></span><span class="op" id="4192702">(</span><span class="ident" id="4192703"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4192705">.</span><span class="ident" id="4192706"><a href="/gostd/net/http/server.go.html#4176112">res</a></span><span class="op" id="4192709">.</span><span class="ident" id="4192710"><a href="/gostd/net/http/server.go.html#4179225">dateBuf</a></span><span class="op" id="4192717">[</span><span class="op" id="4192718">:</span><span class="num" id="4192719">0</span><span class="op" id="4192720">]</span><span class="op" id="4192721">,</span>&nbsp;<span class="ident" id="4192723"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4192727">.</span><span class="ident" id="4192728"><a href="/gostd/time/time.go.html#2743088">Now</a></span><span class="op" id="4192731">(</span><span class="op" id="4192732">)</span><span class="op" id="4192733">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192740">te</span>&nbsp;<span class="op" id="4192743">:=</span>&nbsp;<span class="ident" id="4192746"><a href="/gostd/net/http/server.go.html#4189586">header</a></span><span class="op" id="4192752">.</span><span class="ident" id="4192753"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4192756">(</span><span class="string" id="4192757">&#34;Transfer-Encoding&#34;</span><span class="op" id="4192776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192779">hasTE</span>&nbsp;<span class="op" id="4192785">:=</span>&nbsp;<span class="ident" id="4192788"><a href="/gostd/net/http/server.go.html#4192740">te</a></span>&nbsp;<span class="op" id="4192791">!=</span>&nbsp;<span class="string" id="4192794">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192798">if</span>&nbsp;<span class="ident" id="4192801"><a href="/gostd/net/http/server.go.html#4191310">hasCL</a></span>&nbsp;<span class="op" id="4192807">&amp;&amp;</span>&nbsp;<span class="ident" id="4192810"><a href="/gostd/net/http/server.go.html#4192779">hasTE</a></span>&nbsp;<span class="op" id="4192816">&amp;&amp;</span>&nbsp;<span class="ident" id="4192819"><a href="/gostd/net/http/server.go.html#4192740">te</a></span>&nbsp;<span class="op" id="4192822">!=</span>&nbsp;<span class="string" id="4192825">&#34;identity&#34;</span>&nbsp;<span class="op" id="4192836">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192840">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192906">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192951"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4192952">.</span><span class="ident" id="4192953"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4192957">.</span><span class="ident" id="4192958"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4192964">.</span><span class="ident" id="4192965"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4192969">(</span><span class="string" id="4192970">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="4193057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193062"><a href="/gostd/net/http/server.go.html#4192740">te</a></span><span class="op" id="4193064">,</span>&nbsp;<span class="ident" id="4193066"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4193067">.</span><span class="ident" id="4193068"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span><span class="op" id="4193081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193085"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4193094">(</span><span class="string" id="4193095">&#34;Content-Length&#34;</span><span class="op" id="4193111">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193115"><a href="/gostd/net/http/server.go.html#4191310">hasCL</a></span>&nbsp;<span class="op" id="4193121">=</span>&nbsp;<span class="builtintype" id="4193123">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193134">if</span>&nbsp;<span class="ident" id="4193137"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4193138">.</span><span class="ident" id="4193139"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4193142">.</span><span class="ident" id="4193143"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4193150">==</span>&nbsp;<span class="string" id="4193153">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4193160">||</span>&nbsp;<span class="op" id="4193163">!</span><span class="ident" id="4193164"><a href="/gostd/net/http/transfer.go.html#4247111">bodyAllowedForStatus</a></span><span class="op" id="4193184">(</span><span class="ident" id="4193185"><a href="/gostd/net/http/server.go.html#4192340">code</a></span><span class="op" id="4193189">)</span>&nbsp;<span class="op" id="4193191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193195">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193210">}</span>&nbsp;<span class="keyword" id="4193212">else</span>&nbsp;<span class="keyword" id="4193217">if</span>&nbsp;<span class="ident" id="4193220"><a href="/gostd/net/http/server.go.html#4192340">code</a></span>&nbsp;<span class="op" id="4193225">==</span>&nbsp;<span class="ident" id="4193228"><a href="/gostd/net/http/status.go.html#4236346">StatusNoContent</a></span>&nbsp;<span class="op" id="4193244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193248"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4193257">(</span><span class="string" id="4193258">&#34;Transfer-Encoding&#34;</span><span class="op" id="4193277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193280">}</span>&nbsp;<span class="keyword" id="4193282">else</span>&nbsp;<span class="keyword" id="4193287">if</span>&nbsp;<span class="ident" id="4193290"><a href="/gostd/net/http/server.go.html#4191310">hasCL</a></span>&nbsp;<span class="op" id="4193296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193300"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4193309">(</span><span class="string" id="4193310">&#34;Transfer-Encoding&#34;</span><span class="op" id="4193329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193332">}</span>&nbsp;<span class="keyword" id="4193334">else</span>&nbsp;<span class="keyword" id="4193339">if</span>&nbsp;<span class="ident" id="4193342"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4193343">.</span><span class="ident" id="4193344"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4193347">.</span><span class="ident" id="4193348"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4193360">(</span><span class="num" id="4193361">1</span><span class="op" id="4193362">,</span>&nbsp;<span class="num" id="4193364">1</span><span class="op" id="4193365">)</span>&nbsp;<span class="op" id="4193367">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193371">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193449">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193528">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193600">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193672">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193688">if</span>&nbsp;<span class="ident" id="4193691"><a href="/gostd/net/http/server.go.html#4192779">hasTE</a></span>&nbsp;<span class="op" id="4193697">&amp;&amp;</span>&nbsp;<span class="ident" id="4193700"><a href="/gostd/net/http/server.go.html#4192740">te</a></span>&nbsp;<span class="op" id="4193703">==</span>&nbsp;<span class="string" id="4193706">&#34;identity&#34;</span>&nbsp;<span class="op" id="4193717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193722"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4193724">.</span><span class="ident" id="4193725"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4193734">=</span>&nbsp;<span class="builtintype" id="4193736">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193745"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4193746">.</span><span class="ident" id="4193747"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4193763">=</span>&nbsp;<span class="builtintype" id="4193765">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193772">}</span>&nbsp;<span class="keyword" id="4193774">else</span>&nbsp;<span class="op" id="4193779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193784">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193841">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193887"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4193889">.</span><span class="ident" id="4193890"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4193899">=</span>&nbsp;<span class="builtintype" id="4193901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193909"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4193918">.</span><span class="ident" id="4193919"><a href="/gostd/net/http/server.go.html#4187670">transferEncoding</a></span>&nbsp;<span class="op" id="4193936">=</span>&nbsp;<span class="string" id="4193938">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193953">}</span>&nbsp;<span class="keyword" id="4193955">else</span>&nbsp;<span class="op" id="4193960">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193964">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4194016">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4194070">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194109"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194110">.</span><span class="ident" id="4194111"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4194127">=</span>&nbsp;<span class="builtintype" id="4194129">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194136"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4194145">(</span><span class="string" id="4194146">&#34;Transfer-Encoding&#34;</span><span class="op" id="4194165">)</span>&nbsp;<span class="comment" id="4194167">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4194195">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194262">if</span>&nbsp;<span class="ident" id="4194265"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4194267">.</span><span class="ident" id="4194268"><a href="/gostd/net/http/server.go.html#4176614">chunking</a></span>&nbsp;<span class="op" id="4194277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194281"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4194290">(</span><span class="string" id="4194291">&#34;Content-Length&#34;</span><span class="op" id="4194307">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194313">if</span>&nbsp;<span class="op" id="4194316">!</span><span class="ident" id="4194317"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194318">.</span><span class="ident" id="4194319"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4194322">.</span><span class="ident" id="4194323"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4194335">(</span><span class="num" id="4194336">1</span><span class="op" id="4194337">,</span>&nbsp;<span class="num" id="4194339">0</span><span class="op" id="4194340">)</span>&nbsp;<span class="op" id="4194342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194346">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194358">if</span>&nbsp;<span class="ident" id="4194361"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194362">.</span><span class="ident" id="4194363"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4194379">&amp;&amp;</span>&nbsp;<span class="op" id="4194382">(</span><span class="op" id="4194383">!</span><span class="ident" id="4194384"><a href="/gostd/net/http/server.go.html#4189228">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="4194402">||</span>&nbsp;<span class="op" id="4194405">!</span><span class="ident" id="4194406"><a href="/gostd/net/http/header.go.html#4130492">hasToken</a></span><span class="op" id="4194414">(</span><span class="ident" id="4194415"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4194417">.</span><span class="ident" id="4194418"><a href="/gostd/net/http/server.go.html#4176346">header</a></span><span class="op" id="4194424">.</span><span class="ident" id="4194425"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4194428">(</span><span class="string" id="4194429">&#34;Connection&#34;</span><span class="op" id="4194441">)</span><span class="op" id="4194442">,</span>&nbsp;<span class="string" id="4194444">&#34;close&#34;</span><span class="op" id="4194451">)</span><span class="op" id="4194452">)</span>&nbsp;<span class="op" id="4194454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194458"><a href="/gostd/net/http/server.go.html#4189709">delHeader</a></span><span class="op" id="4194467">(</span><span class="string" id="4194468">&#34;Connection&#34;</span><span class="op" id="4194480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194484">if</span>&nbsp;<span class="ident" id="4194487"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194488">.</span><span class="ident" id="4194489"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4194492">.</span><span class="ident" id="4194493"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4194505">(</span><span class="num" id="4194506">1</span><span class="op" id="4194507">,</span>&nbsp;<span class="num" id="4194509">1</span><span class="op" id="4194510">)</span>&nbsp;<span class="op" id="4194512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194517"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4194526">.</span><span class="ident" id="4194527"><a href="/gostd/net/http/server.go.html#4187645">connection</a></span>&nbsp;<span class="op" id="4194538">=</span>&nbsp;<span class="string" id="4194540">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194550">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194557"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194558">.</span><span class="ident" id="4194559"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4194563">.</span><span class="ident" id="4194564"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4194567">.</span><span class="ident" id="4194568"><a href="/gostd/bufio/bufio.go.html#1369779">WriteString</a></span><span class="op" id="4194579">(</span><span class="ident" id="4194580"><a href="/gostd/net/http/server.go.html#4195225">statusLine</a></span><span class="op" id="4194590">(</span><span class="ident" id="4194591"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194592">.</span><span class="ident" id="4194593"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4194596">,</span>&nbsp;<span class="ident" id="4194598"><a href="/gostd/net/http/server.go.html#4192340">code</a></span><span class="op" id="4194602">)</span><span class="op" id="4194603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194606"><a href="/gostd/net/http/server.go.html#4189116">cw</a></span><span class="op" id="4194608">.</span><span class="ident" id="4194609"><a href="/gostd/net/http/server.go.html#4176346">header</a></span><span class="op" id="4194615">.</span><span class="ident" id="4194616"><a href="/gostd/net/http/header.go.html#4129454">WriteSubset</a></span><span class="op" id="4194627">(</span><span class="ident" id="4194628"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194629">.</span><span class="ident" id="4194630"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4194634">.</span><span class="ident" id="4194635"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4194638">,</span>&nbsp;<span class="ident" id="4194640"><a href="/gostd/net/http/server.go.html#4189678">excludeHeader</a></span><span class="op" id="4194653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194656"><a href="/gostd/net/http/server.go.html#4189943">setHeader</a></span><span class="op" id="4194665">.</span><span class="ident" id="4194666"><a href="/gostd/net/http/server.go.html#4188322">Write</a></span><span class="op" id="4194671">(</span><span class="ident" id="4194672"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194673">.</span><span class="ident" id="4194674"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4194678">.</span><span class="ident" id="4194679"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4194682">.</span><span class="ident" id="4194683"><a href="/gostd/bufio/bufio.go.html#1370955">Writer</a></span><span class="op" id="4194689">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194692"><a href="/gostd/net/http/server.go.html#4189215">w</a></span><span class="op" id="4194693">.</span><span class="ident" id="4194694"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4194698">.</span><span class="ident" id="4194699"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4194702">.</span><span class="ident" id="4194703"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4194708">(</span><span class="ident" id="4194709"><a href="/gostd/net/http/server.go.html#4176688">crlf</a></span><span class="op" id="4194713">)</span><br>
<span class="lineno"></span><span class="op" id="4194715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4194718">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="4194787">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="4194855">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="4194924">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="4194992">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="4195030">var</span>&nbsp;<span class="op" id="4195034">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195037">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195049"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4195053">.</span><span class="ident" id="4195054"><a href="/gostd/sync/rwmutex.go.html#1456076">RWMutex</a></span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195063">statusLines</span>&nbsp;<span class="op" id="4195075">=</span>&nbsp;<span class="builtinfunc" id="4195077">make</span><span class="op" id="4195081">(</span><span class="keyword" id="4195082">map</span><span class="op" id="4195085">[</span><span class="builtintype" id="4195086">int</span><span class="op" id="4195089">]</span><span class="builtintype" id="4195090">string</span><span class="op" id="4195096">)</span><br>
<span class="lineno"></span><span class="op" id="4195098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4195101">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="4195169">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="4195220">func</span>&nbsp;<span class="ident" id="4195225">statusLine</span><span class="op" id="4195235">(</span><span class="ident" id="4195236">req</span>&nbsp;<span class="op" id="4195240">*</span><span class="ident" id="4195241"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4195248">,</span>&nbsp;<span class="ident" id="4195250">code</span>&nbsp;<span class="builtintype" id="4195255">int</span><span class="op" id="4195258">)</span>&nbsp;<span class="builtintype" id="4195260">string</span>&nbsp;<span class="op" id="4195267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4195270">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195285">key</span>&nbsp;<span class="op" id="4195289">:=</span>&nbsp;<span class="ident" id="4195292"><a href="/gostd/net/http/server.go.html#4195250">code</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195298">proto11</span>&nbsp;<span class="op" id="4195306">:=</span>&nbsp;<span class="ident" id="4195309"><a href="/gostd/net/http/server.go.html#4195236">req</a></span><span class="op" id="4195312">.</span><span class="ident" id="4195313"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4195325">(</span><span class="num" id="4195326">1</span><span class="op" id="4195327">,</span>&nbsp;<span class="num" id="4195329">1</span><span class="op" id="4195330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195333">if</span>&nbsp;<span class="op" id="4195336">!</span><span class="ident" id="4195337"><a href="/gostd/net/http/server.go.html#4195298">proto11</a></span>&nbsp;<span class="op" id="4195345">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195349"><a href="/gostd/net/http/server.go.html#4195285">key</a></span>&nbsp;<span class="op" id="4195353">=</span>&nbsp;<span class="op" id="4195355">-</span><span class="ident" id="4195356"><a href="/gostd/net/http/server.go.html#4195285">key</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195364"><a href="/gostd/net/http/server.go.html#4195037">statusMu</a></span><span class="op" id="4195372">.</span><span class="ident" id="4195373"><a href="/gostd/sync/rwmutex.go.html#1456490">RLock</a></span><span class="op" id="4195378">(</span><span class="op" id="4195379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195382">line</span><span class="op" id="4195386">,</span>&nbsp;<span class="ident" id="4195388">ok</span>&nbsp;<span class="op" id="4195391">:=</span>&nbsp;<span class="ident" id="4195394"><a href="/gostd/net/http/server.go.html#4195063">statusLines</a></span><span class="op" id="4195405">[</span><span class="ident" id="4195406"><a href="/gostd/net/http/server.go.html#4195285">key</a></span><span class="op" id="4195409">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195412"><a href="/gostd/net/http/server.go.html#4195037">statusMu</a></span><span class="op" id="4195420">.</span><span class="ident" id="4195421"><a href="/gostd/sync/rwmutex.go.html#1456952">RUnlock</a></span><span class="op" id="4195428">(</span><span class="op" id="4195429">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195432">if</span>&nbsp;<span class="ident" id="4195435"><a href="/gostd/net/http/server.go.html#4195388">ok</a></span>&nbsp;<span class="op" id="4195438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195442">return</span>&nbsp;<span class="ident" id="4195449"><a href="/gostd/net/http/server.go.html#4195382">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4195459">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195474">proto</span>&nbsp;<span class="op" id="4195480">:=</span>&nbsp;<span class="string" id="4195483">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195495">if</span>&nbsp;<span class="ident" id="4195498"><a href="/gostd/net/http/server.go.html#4195298">proto11</a></span>&nbsp;<span class="op" id="4195506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195510"><a href="/gostd/net/http/server.go.html#4195474">proto</a></span>&nbsp;<span class="op" id="4195516">=</span>&nbsp;<span class="string" id="4195518">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195533">codestring</span>&nbsp;<span class="op" id="4195544">:=</span>&nbsp;<span class="ident" id="4195547"><a href="/gostd/net/http/server.go.html#4169389">strconv</a></span><span class="op" id="4195554">.</span><span class="ident" id="4195555"><a href="/gostd/strconv/itoa.go.html#2407288">Itoa</a></span><span class="op" id="4195559">(</span><span class="ident" id="4195560"><a href="/gostd/net/http/server.go.html#4195250">code</a></span><span class="op" id="4195564">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195567">text</span><span class="op" id="4195571">,</span>&nbsp;<span class="ident" id="4195573"><a href="/gostd/net/http/server.go.html#4195388">ok</a></span>&nbsp;<span class="op" id="4195576">:=</span>&nbsp;<span class="ident" id="4195579"><a href="/gostd/net/http/status.go.html#4237998">statusText</a></span><span class="op" id="4195589">[</span><span class="ident" id="4195590"><a href="/gostd/net/http/server.go.html#4195250">code</a></span><span class="op" id="4195594">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195597">if</span>&nbsp;<span class="op" id="4195600">!</span><span class="ident" id="4195601"><a href="/gostd/net/http/server.go.html#4195388">ok</a></span>&nbsp;<span class="op" id="4195604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195608"><a href="/gostd/net/http/server.go.html#4195567">text</a></span>&nbsp;<span class="op" id="4195613">=</span>&nbsp;<span class="string" id="4195615">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4195630">+</span>&nbsp;<span class="ident" id="4195632"><a href="/gostd/net/http/server.go.html#4195533">codestring</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195647"><a href="/gostd/net/http/server.go.html#4195382">line</a></span>&nbsp;<span class="op" id="4195652">=</span>&nbsp;<span class="ident" id="4195654"><a href="/gostd/net/http/server.go.html#4195474">proto</a></span>&nbsp;<span class="op" id="4195660">+</span>&nbsp;<span class="string" id="4195662">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4195666">+</span>&nbsp;<span class="ident" id="4195668"><a href="/gostd/net/http/server.go.html#4195533">codestring</a></span>&nbsp;<span class="op" id="4195679">+</span>&nbsp;<span class="string" id="4195681">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4195685">+</span>&nbsp;<span class="ident" id="4195687"><a href="/gostd/net/http/server.go.html#4195567">text</a></span>&nbsp;<span class="op" id="4195692">+</span>&nbsp;<span class="string" id="4195694">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195702">if</span>&nbsp;<span class="ident" id="4195705"><a href="/gostd/net/http/server.go.html#4195388">ok</a></span>&nbsp;<span class="op" id="4195708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195712"><a href="/gostd/net/http/server.go.html#4195037">statusMu</a></span><span class="op" id="4195720">.</span><span class="ident" id="4195721"><a href="/gostd/sync/rwmutex.go.html#1457713">Lock</a></span><span class="op" id="4195725">(</span><span class="op" id="4195726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195730">defer</span>&nbsp;<span class="ident" id="4195736"><a href="/gostd/net/http/server.go.html#4195037">statusMu</a></span><span class="op" id="4195744">.</span><span class="ident" id="4195745"><a href="/gostd/sync/rwmutex.go.html#1458554">Unlock</a></span><span class="op" id="4195751">(</span><span class="op" id="4195752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195756"><a href="/gostd/net/http/server.go.html#4195063">statusLines</a></span><span class="op" id="4195767">[</span><span class="ident" id="4195768"><a href="/gostd/net/http/server.go.html#4195285">key</a></span><span class="op" id="4195771">]</span>&nbsp;<span class="op" id="4195773">=</span>&nbsp;<span class="ident" id="4195775"><a href="/gostd/net/http/server.go.html#4195382">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195781">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195784">return</span>&nbsp;<span class="ident" id="4195791"><a href="/gostd/net/http/server.go.html#4195382">line</a></span><br>
<span class="lineno"></span><span class="op" id="4195796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4195799">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4195873">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="4195938">func</span>&nbsp;<span class="op" id="4195943">(</span><span class="ident" id="4195944">w</span>&nbsp;<span class="op" id="4195946">*</span><span class="ident" id="4195947"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4195955">)</span>&nbsp;<span class="ident" id="4195957">bodyAllowed</span><span class="op" id="4195968">(</span><span class="op" id="4195969">)</span>&nbsp;<span class="builtintype" id="4195971">bool</span>&nbsp;<span class="op" id="4195976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195979">if</span>&nbsp;<span class="op" id="4195982">!</span><span class="ident" id="4195983"><a href="/gostd/net/http/server.go.html#4195944">w</a></span><span class="op" id="4195984">.</span><span class="ident" id="4195985"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4195997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4196001">panic</span><span class="op" id="4196006">(</span><span class="string" id="4196007">&#34;&#34;</span><span class="op" id="4196009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196015">return</span>&nbsp;<span class="ident" id="4196022"><a href="/gostd/net/http/transfer.go.html#4247111">bodyAllowedForStatus</a></span><span class="op" id="4196042">(</span><span class="ident" id="4196043"><a href="/gostd/net/http/server.go.html#4195944">w</a></span><span class="op" id="4196044">.</span><span class="ident" id="4196045"><a href="/gostd/net/http/server.go.html#4178481">status</a></span><span class="op" id="4196051">)</span><br>
<span class="lineno">940</span><span class="op" id="4196053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4196056">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="4196093">//</span><br>
<span class="lineno"></span><span class="comment" id="4196096">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="4196163">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="4196238">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4196282">//</span><br>
<span class="lineno"></span><span class="comment" id="4196285">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="4196355">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="4196423">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4196494">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="4196520">//</span><br>
<span class="lineno"></span><span class="comment" id="4196523">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4196592">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="4196629">//</span><br>
<span class="lineno"></span><span class="comment" id="4196632">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="4196672">//</span><br>
<span class="lineno"></span><span class="comment" id="4196675">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4196715">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="4196786">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="4196861">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="4196914">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4196983">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="4197053">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="4197120">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="4197149">//</span><br>
<span class="lineno"></span><span class="comment" id="4197152">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4197216">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="4197283">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="4197351">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4197416">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4197486">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4197555">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4197626">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="4197697">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4197719">func</span>&nbsp;<span class="op" id="4197724">(</span><span class="ident" id="4197725">w</span>&nbsp;<span class="op" id="4197727">*</span><span class="ident" id="4197728"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4197736">)</span>&nbsp;<span class="ident" id="4197738">Write</span><span class="op" id="4197743">(</span><span class="ident" id="4197744">data</span>&nbsp;<span class="op" id="4197749">[</span><span class="op" id="4197750">]</span><span class="builtintype" id="4197751">byte</span><span class="op" id="4197755">)</span>&nbsp;<span class="op" id="4197757">(</span><span class="ident" id="4197758">n</span>&nbsp;<span class="builtintype" id="4197760">int</span><span class="op" id="4197763">,</span>&nbsp;<span class="ident" id="4197765">err</span>&nbsp;<span class="builtintype" id="4197769">error</span><span class="op" id="4197774">)</span>&nbsp;<span class="op" id="4197776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197779">return</span>&nbsp;<span class="ident" id="4197786"><a href="/gostd/net/http/server.go.html#4197725">w</a></span><span class="op" id="4197787">.</span><span class="ident" id="4197788"><a href="/gostd/net/http/server.go.html#4197981">write</a></span><span class="op" id="4197793">(</span><span class="builtinfunc" id="4197794">len</span><span class="op" id="4197797">(</span><span class="ident" id="4197798"><a href="/gostd/net/http/server.go.html#4197744">data</a></span><span class="op" id="4197802">)</span><span class="op" id="4197803">,</span>&nbsp;<span class="ident" id="4197805"><a href="/gostd/net/http/server.go.html#4197744">data</a></span><span class="op" id="4197809">,</span>&nbsp;<span class="string" id="4197811">&#34;&#34;</span><span class="op" id="4197813">)</span><br>
<span class="lineno"></span><span class="op" id="4197815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="4197818">func</span>&nbsp;<span class="op" id="4197823">(</span><span class="ident" id="4197824">w</span>&nbsp;<span class="op" id="4197826">*</span><span class="ident" id="4197827"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4197835">)</span>&nbsp;<span class="ident" id="4197837">WriteString</span><span class="op" id="4197848">(</span><span class="ident" id="4197849">data</span>&nbsp;<span class="builtintype" id="4197854">string</span><span class="op" id="4197860">)</span>&nbsp;<span class="op" id="4197862">(</span><span class="ident" id="4197863">n</span>&nbsp;<span class="builtintype" id="4197865">int</span><span class="op" id="4197868">,</span>&nbsp;<span class="ident" id="4197870">err</span>&nbsp;<span class="builtintype" id="4197874">error</span><span class="op" id="4197879">)</span>&nbsp;<span class="op" id="4197881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197884">return</span>&nbsp;<span class="ident" id="4197891"><a href="/gostd/net/http/server.go.html#4197824">w</a></span><span class="op" id="4197892">.</span><span class="ident" id="4197893"><a href="/gostd/net/http/server.go.html#4197981">write</a></span><span class="op" id="4197898">(</span><span class="builtinfunc" id="4197899">len</span><span class="op" id="4197902">(</span><span class="ident" id="4197903"><a href="/gostd/net/http/server.go.html#4197849">data</a></span><span class="op" id="4197907">)</span><span class="op" id="4197908">,</span>&nbsp;<span class="builtintype" id="4197910">nil</span><span class="op" id="4197913">,</span>&nbsp;<span class="ident" id="4197915"><a href="/gostd/net/http/server.go.html#4197849">data</a></span><span class="op" id="4197919">)</span><br>
<span class="lineno"></span><span class="op" id="4197921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4197924">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="4197962">func</span>&nbsp;<span class="op" id="4197967">(</span><span class="ident" id="4197968">w</span>&nbsp;<span class="op" id="4197970">*</span><span class="ident" id="4197971"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4197979">)</span>&nbsp;<span class="ident" id="4197981">write</span><span class="op" id="4197986">(</span><span class="ident" id="4197987">lenData</span>&nbsp;<span class="builtintype" id="4197995">int</span><span class="op" id="4197998">,</span>&nbsp;<span class="ident" id="4198000">dataB</span>&nbsp;<span class="op" id="4198006">[</span><span class="op" id="4198007">]</span><span class="builtintype" id="4198008">byte</span><span class="op" id="4198012">,</span>&nbsp;<span class="ident" id="4198014">dataS</span>&nbsp;<span class="builtintype" id="4198020">string</span><span class="op" id="4198026">)</span>&nbsp;<span class="op" id="4198028">(</span><span class="ident" id="4198029">n</span>&nbsp;<span class="builtintype" id="4198031">int</span><span class="op" id="4198034">,</span>&nbsp;<span class="ident" id="4198036">err</span>&nbsp;<span class="builtintype" id="4198040">error</span><span class="op" id="4198045">)</span>&nbsp;<span class="op" id="4198047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198050">if</span>&nbsp;<span class="ident" id="4198053"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198054">.</span><span class="ident" id="4198055"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4198059">.</span><span class="ident" id="4198060"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4198068">(</span><span class="op" id="4198069">)</span>&nbsp;<span class="op" id="4198071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198075"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198076">.</span><span class="ident" id="4198077"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4198081">.</span><span class="ident" id="4198082"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4198088">.</span><span class="ident" id="4198089"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4198093">(</span><span class="string" id="4198094">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4198139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198143">return</span>&nbsp;<span class="num" id="4198150">0</span><span class="op" id="4198151">,</span>&nbsp;<span class="ident" id="4198153"><a href="/gostd/net/http/server.go.html#4169659">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198166">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198169">if</span>&nbsp;<span class="op" id="4198172">!</span><span class="ident" id="4198173"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198174">.</span><span class="ident" id="4198175"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4198187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198191"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198192">.</span><span class="ident" id="4198193"><a href="/gostd/net/http/server.go.html#4186739">WriteHeader</a></span><span class="op" id="4198204">(</span><span class="ident" id="4198205"><a href="/gostd/net/http/status.go.html#4236210">StatusOK</a></span><span class="op" id="4198213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198219">if</span>&nbsp;<span class="ident" id="4198222"><a href="/gostd/net/http/server.go.html#4197987">lenData</a></span>&nbsp;<span class="op" id="4198230">==</span>&nbsp;<span class="num" id="4198233">0</span>&nbsp;<span class="op" id="4198235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198239">return</span>&nbsp;<span class="num" id="4198246">0</span><span class="op" id="4198247">,</span>&nbsp;<span class="builtintype" id="4198249">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198257">if</span>&nbsp;<span class="op" id="4198260">!</span><span class="ident" id="4198261"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198262">.</span><span class="ident" id="4198263"><a href="/gostd/net/http/server.go.html#4195957">bodyAllowed</a></span><span class="op" id="4198274">(</span><span class="op" id="4198275">)</span>&nbsp;<span class="op" id="4198277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198281">return</span>&nbsp;<span class="num" id="4198288">0</span><span class="op" id="4198289">,</span>&nbsp;<span class="ident" id="4198291"><a href="/gostd/net/http/server.go.html#4169558">ErrBodyNotAllowed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198314"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198315">.</span><span class="ident" id="4198316"><a href="/gostd/net/http/server.go.html#4178359">written</a></span>&nbsp;<span class="op" id="4198324">+=</span>&nbsp;<span class="builtintype" id="4198327">int64</span><span class="op" id="4198332">(</span><span class="ident" id="4198333"><a href="/gostd/net/http/server.go.html#4197987">lenData</a></span><span class="op" id="4198340">)</span>&nbsp;<span class="comment" id="4198342">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198379">if</span>&nbsp;<span class="ident" id="4198382"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198383">.</span><span class="ident" id="4198384"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4198398">!=</span>&nbsp;<span class="op" id="4198401">-</span><span class="num" id="4198402">1</span>&nbsp;<span class="op" id="4198404">&amp;&amp;</span>&nbsp;<span class="ident" id="4198407"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198408">.</span><span class="ident" id="4198409"><a href="/gostd/net/http/server.go.html#4178359">written</a></span>&nbsp;<span class="op" id="4198417">&gt;</span>&nbsp;<span class="ident" id="4198419"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198420">.</span><span class="ident" id="4198421"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4198435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198439">return</span>&nbsp;<span class="num" id="4198446">0</span><span class="op" id="4198447">,</span>&nbsp;<span class="ident" id="4198449"><a href="/gostd/net/http/server.go.html#4169718">ErrContentLength</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198470">if</span>&nbsp;<span class="ident" id="4198473"><a href="/gostd/net/http/server.go.html#4198000">dataB</a></span>&nbsp;<span class="op" id="4198479">!=</span>&nbsp;<span class="builtintype" id="4198482">nil</span>&nbsp;<span class="op" id="4198486">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198490">return</span>&nbsp;<span class="ident" id="4198497"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198498">.</span><span class="ident" id="4198499"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4198500">.</span><span class="ident" id="4198501"><a href="/gostd/bufio/bufio.go.html#1368329">Write</a></span><span class="op" id="4198506">(</span><span class="ident" id="4198507"><a href="/gostd/net/http/server.go.html#4198000">dataB</a></span><span class="op" id="4198512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198515">}</span>&nbsp;<span class="keyword" id="4198517">else</span>&nbsp;<span class="op" id="4198522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198526">return</span>&nbsp;<span class="ident" id="4198533"><a href="/gostd/net/http/server.go.html#4197968">w</a></span><span class="op" id="4198534">.</span><span class="ident" id="4198535"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4198536">.</span><span class="ident" id="4198537"><a href="/gostd/bufio/bufio.go.html#1369779">WriteString</a></span><span class="op" id="4198548">(</span><span class="ident" id="4198549"><a href="/gostd/net/http/server.go.html#4198014">dataS</a></span><span class="op" id="4198554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198557">}</span><br>
<span class="lineno"></span><span class="op" id="4198559">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="4198562">func</span>&nbsp;<span class="op" id="4198567">(</span><span class="ident" id="4198568">w</span>&nbsp;<span class="op" id="4198570">*</span><span class="ident" id="4198571"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4198579">)</span>&nbsp;<span class="ident" id="4198581">finishRequest</span><span class="op" id="4198594">(</span><span class="op" id="4198595">)</span>&nbsp;<span class="op" id="4198597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198600"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198601">.</span><span class="ident" id="4198602"><a href="/gostd/net/http/server.go.html#4179131">handlerDone</a></span>&nbsp;<span class="op" id="4198614">=</span>&nbsp;<span class="builtintype" id="4198616">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198623">if</span>&nbsp;<span class="op" id="4198626">!</span><span class="ident" id="4198627"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198628">.</span><span class="ident" id="4198629"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4198641">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198645"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198646">.</span><span class="ident" id="4198647"><a href="/gostd/net/http/server.go.html#4186739">WriteHeader</a></span><span class="op" id="4198658">(</span><span class="ident" id="4198659"><a href="/gostd/net/http/status.go.html#4236210">StatusOK</a></span><span class="op" id="4198667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198674"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198675">.</span><span class="ident" id="4198676"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4198677">.</span><span class="ident" id="4198678"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4198683">(</span><span class="op" id="4198684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198687"><a href="/gostd/net/http/server.go.html#4182826">putBufioWriter</a></span><span class="op" id="4198701">(</span><span class="ident" id="4198702"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198703">.</span><span class="ident" id="4198704"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4198705">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198708"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198709">.</span><span class="ident" id="4198710"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4198712">.</span><span class="builtinfunc" id="4198713"><a href="/gostd/net/http/server.go.html#4177361">close</a></span><span class="op" id="4198718">(</span><span class="op" id="4198719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198722"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198723">.</span><span class="ident" id="4198724"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4198728">.</span><span class="ident" id="4198729"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4198732">.</span><span class="ident" id="4198733"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4198738">(</span><span class="op" id="4198739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4198743">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4198806">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198848"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198849">.</span><span class="ident" id="4198850"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4198853">.</span><span class="ident" id="4198854"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4198858">.</span><span class="ident" id="4198859"><a href="/gostd/io/io.go.html#1422583">Close</a></span><span class="op" id="4198864">(</span><span class="op" id="4198865">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198869">if</span>&nbsp;<span class="ident" id="4198872"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198873">.</span><span class="ident" id="4198874"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4198877">.</span><span class="ident" id="4198878"><a href="/gostd/net/http/request.go.html#4139864">MultipartForm</a></span>&nbsp;<span class="op" id="4198892">!=</span>&nbsp;<span class="builtintype" id="4198895">nil</span>&nbsp;<span class="op" id="4198899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198903"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198904">.</span><span class="ident" id="4198905"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4198908">.</span><span class="ident" id="4198909"><a href="/gostd/net/http/request.go.html#4139864">MultipartForm</a></span><span class="op" id="4198922">.</span><span class="ident" id="4198923"><a href="/gostd/mime/multipart/formdata.go.html#4309807">RemoveAll</a></span><span class="op" id="4198932">(</span><span class="op" id="4198933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198936">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198940">if</span>&nbsp;<span class="ident" id="4198943"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198944">.</span><span class="ident" id="4198945"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4198948">.</span><span class="ident" id="4198949"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4198956">!=</span>&nbsp;<span class="string" id="4198959">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4198966">&amp;&amp;</span>&nbsp;<span class="ident" id="4198969"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198970">.</span><span class="ident" id="4198971"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4198985">!=</span>&nbsp;<span class="op" id="4198988">-</span><span class="num" id="4198989">1</span>&nbsp;<span class="op" id="4198991">&amp;&amp;</span>&nbsp;<span class="ident" id="4198994"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4198995">.</span><span class="ident" id="4198996"><a href="/gostd/net/http/server.go.html#4195957">bodyAllowed</a></span><span class="op" id="4199007">(</span><span class="op" id="4199008">)</span>&nbsp;<span class="op" id="4199010">&amp;&amp;</span>&nbsp;<span class="ident" id="4199013"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4199014">.</span><span class="ident" id="4199015"><a href="/gostd/net/http/server.go.html#4178415">contentLength</a></span>&nbsp;<span class="op" id="4199029">!=</span>&nbsp;<span class="ident" id="4199032"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4199033">.</span><span class="ident" id="4199034"><a href="/gostd/net/http/server.go.html#4178359">written</a></span>&nbsp;<span class="op" id="4199042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199046">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199100"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4199101">.</span><span class="ident" id="4199102"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4199118">=</span>&nbsp;<span class="builtintype" id="4199120">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199126">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199130">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199192">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199243">if</span>&nbsp;<span class="ident" id="4199246"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4199247">.</span><span class="ident" id="4199248"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4199252">.</span><span class="ident" id="4199253"><a href="/gostd/net/http/server.go.html#4173097">werr</a></span>&nbsp;<span class="op" id="4199258">!=</span>&nbsp;<span class="builtintype" id="4199261">nil</span>&nbsp;<span class="op" id="4199265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199269"><a href="/gostd/net/http/server.go.html#4198568">w</a></span><span class="op" id="4199270">.</span><span class="ident" id="4199271"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4199287">=</span>&nbsp;<span class="builtintype" id="4199289">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199295">}</span><br>
<span class="lineno"></span><span class="op" id="4199297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4199300">func</span>&nbsp;<span class="op" id="4199305">(</span><span class="ident" id="4199306">w</span>&nbsp;<span class="op" id="4199308">*</span><span class="ident" id="4199309"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4199317">)</span>&nbsp;<span class="ident" id="4199319">Flush</span><span class="op" id="4199324">(</span><span class="op" id="4199325">)</span>&nbsp;<span class="op" id="4199327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199330">if</span>&nbsp;<span class="op" id="4199333">!</span><span class="ident" id="4199334"><a href="/gostd/net/http/server.go.html#4199306">w</a></span><span class="op" id="4199335">.</span><span class="ident" id="4199336"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4199348">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199352"><a href="/gostd/net/http/server.go.html#4199306">w</a></span><span class="op" id="4199353">.</span><span class="ident" id="4199354"><a href="/gostd/net/http/server.go.html#4186739">WriteHeader</a></span><span class="op" id="4199365">(</span><span class="ident" id="4199366"><a href="/gostd/net/http/status.go.html#4236210">StatusOK</a></span><span class="op" id="4199374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199380"><a href="/gostd/net/http/server.go.html#4199306">w</a></span><span class="op" id="4199381">.</span><span class="ident" id="4199382"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4199383">.</span><span class="ident" id="4199384"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4199389">(</span><span class="op" id="4199390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199393"><a href="/gostd/net/http/server.go.html#4199306">w</a></span><span class="op" id="4199394">.</span><span class="ident" id="4199395"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4199397">.</span><span class="ident" id="4199398"><a href="/gostd/net/http/server.go.html#4177253">flush</a></span><span class="op" id="4199403">(</span><span class="op" id="4199404">)</span><br>
<span class="lineno"></span><span class="op" id="4199406">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="4199409">func</span>&nbsp;<span class="op" id="4199414">(</span><span class="ident" id="4199415">c</span>&nbsp;<span class="op" id="4199417">*</span><span class="ident" id="4199418"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4199422">)</span>&nbsp;<span class="ident" id="4199424">finalFlush</span><span class="op" id="4199434">(</span><span class="op" id="4199435">)</span>&nbsp;<span class="op" id="4199437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199440">if</span>&nbsp;<span class="ident" id="4199443"><a href="/gostd/net/http/server.go.html#4199415">c</a></span><span class="op" id="4199444">.</span><span class="ident" id="4199445"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span>&nbsp;<span class="op" id="4199449">!=</span>&nbsp;<span class="builtintype" id="4199452">nil</span>&nbsp;<span class="op" id="4199456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199460"><a href="/gostd/net/http/server.go.html#4199415">c</a></span><span class="op" id="4199461">.</span><span class="ident" id="4199462"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4199465">.</span><span class="ident" id="4199466"><a href="/gostd/bufio/bufio.go.html#1367486">Flush</a></span><span class="op" id="4199471">(</span><span class="op" id="4199472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199477">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199547">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199584"><a href="/gostd/net/http/server.go.html#4182496">putBufioReader</a></span><span class="op" id="4199598">(</span><span class="ident" id="4199599"><a href="/gostd/net/http/server.go.html#4199415">c</a></span><span class="op" id="4199600">.</span><span class="ident" id="4199601"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4199604">.</span><span class="ident" id="4199605"><a href="/gostd/bufio/bufio.go.html#1370946">Reader</a></span><span class="op" id="4199611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199616">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4199686">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199723"><a href="/gostd/net/http/server.go.html#4182826">putBufioWriter</a></span><span class="op" id="4199737">(</span><span class="ident" id="4199738"><a href="/gostd/net/http/server.go.html#4199415">c</a></span><span class="op" id="4199739">.</span><span class="ident" id="4199740"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span><span class="op" id="4199743">.</span><span class="ident" id="4199744"><a href="/gostd/bufio/bufio.go.html#1370955">Writer</a></span><span class="op" id="4199750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199755"><a href="/gostd/net/http/server.go.html#4199415">c</a></span><span class="op" id="4199756">.</span><span class="ident" id="4199757"><a href="/gostd/net/http/server.go.html#4173298">buf</a></span>&nbsp;<span class="op" id="4199761">=</span>&nbsp;<span class="builtintype" id="4199763">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199768">}</span><br>
<span class="lineno">1065</span><span class="op" id="4199770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4199773">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4199798">func</span>&nbsp;<span class="op" id="4199803">(</span><span class="ident" id="4199804">c</span>&nbsp;<span class="op" id="4199806">*</span><span class="ident" id="4199807"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4199811">)</span>&nbsp;<span class="builtinfunc" id="4199813">close</span><span class="op" id="4199818">(</span><span class="op" id="4199819">)</span>&nbsp;<span class="op" id="4199821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199824"><a href="/gostd/net/http/server.go.html#4199804">c</a></span><span class="op" id="4199825">.</span><span class="ident" id="4199826"><a href="/gostd/net/http/server.go.html#4199424">finalFlush</a></span><span class="op" id="4199836">(</span><span class="op" id="4199837">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199840">if</span>&nbsp;<span class="ident" id="4199843"><a href="/gostd/net/http/server.go.html#4199804">c</a></span><span class="op" id="4199844">.</span><span class="ident" id="4199845"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="op" id="4199849">!=</span>&nbsp;<span class="builtintype" id="4199852">nil</span>&nbsp;<span class="op" id="4199856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199860"><a href="/gostd/net/http/server.go.html#4199804">c</a></span><span class="op" id="4199861">.</span><span class="ident" id="4199862"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4199865">.</span><span class="ident" id="4199866"><a href="/gostd/net/net.go.html#3334987">Close</a></span><span class="op" id="4199871">(</span><span class="op" id="4199872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199876"><a href="/gostd/net/http/server.go.html#4199804">c</a></span><span class="op" id="4199877">.</span><span class="ident" id="4199878"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="op" id="4199882">=</span>&nbsp;<span class="builtintype" id="4199884">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199889">}</span><br>
<span class="lineno"></span><span class="op" id="4199891">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="4199894">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4199964">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="4200032">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="4200101">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="4200172">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4200225">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="4200290">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="4200358">const</span>&nbsp;<span class="ident" id="4200364">rstAvoidanceDelay</span>&nbsp;<span class="op" id="4200382">=</span>&nbsp;<span class="num" id="4200384">500</span>&nbsp;<span class="op" id="4200388">*</span>&nbsp;<span class="ident" id="4200390"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4200394">.</span><span class="ident" id="4200395"><a href="/gostd/time/time.go.html#2734819">Millisecond</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="4200408">type</span>&nbsp;<span class="ident" id="4200413">closeWriter</span>&nbsp;<span class="keyword" id="4200425">interface</span>&nbsp;<span class="op" id="4200435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200438">CloseWrite</span><span class="op" id="4200448">(</span><span class="op" id="4200449">)</span>&nbsp;<span class="builtintype" id="4200451">error</span><br>
<span class="lineno"></span><span class="op" id="4200457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4200460">var</span>&nbsp;<span class="ident" id="4200464">_</span>&nbsp;<span class="ident" id="4200466"><a href="/gostd/net/http/server.go.html#4200413">closeWriter</a></span>&nbsp;<span class="op" id="4200478">=</span>&nbsp;<span class="op" id="4200480">(</span><span class="op" id="4200481">*</span><span class="ident" id="4200482"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4200485">.</span><span class="ident" id="4200486"><a href="/gostd/net/tcpsock_posix.go.html#3376101">TCPConn</a></span><span class="op" id="4200493">)</span><span class="op" id="4200494">(</span><span class="builtintype" id="4200495">nil</span><span class="op" id="4200498">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="4200501">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="4200571">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4200641">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4200703">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="4200722">//</span><br>
<span class="lineno"></span><span class="comment" id="4200725">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="4200761">func</span>&nbsp;<span class="op" id="4200766">(</span><span class="ident" id="4200767">c</span>&nbsp;<span class="op" id="4200769">*</span><span class="ident" id="4200770"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4200774">)</span>&nbsp;<span class="ident" id="4200776">closeWriteAndWait</span><span class="op" id="4200793">(</span><span class="op" id="4200794">)</span>&nbsp;<span class="op" id="4200796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200799"><a href="/gostd/net/http/server.go.html#4200767">c</a></span><span class="op" id="4200800">.</span><span class="ident" id="4200801"><a href="/gostd/net/http/server.go.html#4199424">finalFlush</a></span><span class="op" id="4200811">(</span><span class="op" id="4200812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200815">if</span>&nbsp;<span class="ident" id="4200818">tcp</span><span class="op" id="4200821">,</span>&nbsp;<span class="ident" id="4200823">ok</span>&nbsp;<span class="op" id="4200826">:=</span>&nbsp;<span class="ident" id="4200829"><a href="/gostd/net/http/server.go.html#4200767">c</a></span><span class="op" id="4200830">.</span><span class="ident" id="4200831"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4200834">.</span><span class="op" id="4200835">(</span><span class="ident" id="4200836"><a href="/gostd/net/http/server.go.html#4200413">closeWriter</a></span><span class="op" id="4200847">)</span><span class="op" id="4200848">;</span>&nbsp;<span class="ident" id="4200850"><a href="/gostd/net/http/server.go.html#4200823">ok</a></span>&nbsp;<span class="op" id="4200853">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200857"><a href="/gostd/net/http/server.go.html#4200818">tcp</a></span><span class="op" id="4200860">.</span><span class="ident" id="4200861"><a href="/gostd/net/http/server.go.html#4200438">CloseWrite</a></span><span class="op" id="4200871">(</span><span class="op" id="4200872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4200875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200878"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4200882">.</span><span class="ident" id="4200883"><a href="/gostd/time/sleep.go.html#2713940">Sleep</a></span><span class="op" id="4200888">(</span><span class="ident" id="4200889"><a href="/gostd/net/http/server.go.html#4200364">rstAvoidanceDelay</a></span><span class="op" id="4200906">)</span><br>
<span class="lineno"></span><span class="op" id="4200908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="4200911">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="4200975">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="4201044">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="4201102">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="4201122">func</span>&nbsp;<span class="ident" id="4201127">validNPN</span><span class="op" id="4201135">(</span><span class="ident" id="4201136">proto</span>&nbsp;<span class="builtintype" id="4201142">string</span><span class="op" id="4201148">)</span>&nbsp;<span class="builtintype" id="4201150">bool</span>&nbsp;<span class="op" id="4201155">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201158">switch</span>&nbsp;<span class="ident" id="4201165"><a href="/gostd/net/http/server.go.html#4201136">proto</a></span>&nbsp;<span class="op" id="4201171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201174">case</span>&nbsp;<span class="string" id="4201179">&#34;&#34;</span><span class="op" id="4201181">,</span>&nbsp;<span class="string" id="4201183">&#34;http/1.1&#34;</span><span class="op" id="4201193">,</span>&nbsp;<span class="string" id="4201195">&#34;http/1.0&#34;</span><span class="op" id="4201205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201209">return</span>&nbsp;<span class="builtintype" id="4201216">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201226">return</span>&nbsp;<span class="builtintype" id="4201233">true</span><br>
<span class="lineno">1115</span><span class="op" id="4201238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4201241">func</span>&nbsp;<span class="op" id="4201246">(</span><span class="ident" id="4201247">c</span>&nbsp;<span class="op" id="4201249">*</span><span class="ident" id="4201250"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4201254">)</span>&nbsp;<span class="ident" id="4201256">setState</span><span class="op" id="4201264">(</span><span class="ident" id="4201265">nc</span>&nbsp;<span class="ident" id="4201268"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4201271">.</span><span class="ident" id="4201272"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4201276">,</span>&nbsp;<span class="ident" id="4201278">state</span>&nbsp;<span class="ident" id="4201284"><a href="/gostd/net/http/server.go.html#4218180">ConnState</a></span><span class="op" id="4201293">)</span>&nbsp;<span class="op" id="4201295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201298">if</span>&nbsp;<span class="ident" id="4201301">hook</span>&nbsp;<span class="op" id="4201306">:=</span>&nbsp;<span class="ident" id="4201309"><a href="/gostd/net/http/server.go.html#4201247">c</a></span><span class="op" id="4201310">.</span><span class="ident" id="4201311"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4201317">.</span><span class="ident" id="4201318"><a href="/gostd/net/http/server.go.html#4217740">ConnState</a></span><span class="op" id="4201327">;</span>&nbsp;<span class="ident" id="4201329"><a href="/gostd/net/http/server.go.html#4201301">hook</a></span>&nbsp;<span class="op" id="4201334">!=</span>&nbsp;<span class="builtintype" id="4201337">nil</span>&nbsp;<span class="op" id="4201341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201345"><a href="/gostd/net/http/server.go.html#4201301">hook</a></span><span class="op" id="4201349">(</span><span class="ident" id="4201350"><a href="/gostd/net/http/server.go.html#4201265">nc</a></span><span class="op" id="4201352">,</span>&nbsp;<span class="ident" id="4201354"><a href="/gostd/net/http/server.go.html#4201278">state</a></span><span class="op" id="4201359">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201362">}</span><br>
<span class="lineno"></span><span class="op" id="4201364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4201367">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4201394">func</span>&nbsp;<span class="op" id="4201399">(</span><span class="ident" id="4201400">c</span>&nbsp;<span class="op" id="4201402">*</span><span class="ident" id="4201403"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><span class="op" id="4201407">)</span>&nbsp;<span class="ident" id="4201409">serve</span><span class="op" id="4201414">(</span><span class="op" id="4201415">)</span>&nbsp;<span class="op" id="4201417">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201420">origConn</span>&nbsp;<span class="op" id="4201429">:=</span>&nbsp;<span class="ident" id="4201432"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201433">.</span><span class="ident" id="4201434"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span>&nbsp;<span class="comment" id="4201438">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201489">defer</span>&nbsp;<span class="keyword" id="4201495">func</span><span class="op" id="4201499">(</span><span class="op" id="4201500">)</span>&nbsp;<span class="op" id="4201502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201506">if</span>&nbsp;<span class="ident" id="4201509">err</span>&nbsp;<span class="op" id="4201513">:=</span>&nbsp;<span class="builtinfunc" id="4201516">recover</span><span class="op" id="4201523">(</span><span class="op" id="4201524">)</span><span class="op" id="4201525">;</span>&nbsp;<span class="ident" id="4201527"><a href="/gostd/net/http/server.go.html#4201509">err</a></span>&nbsp;<span class="op" id="4201531">!=</span>&nbsp;<span class="builtintype" id="4201534">nil</span>&nbsp;<span class="op" id="4201538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201543">const</span>&nbsp;<span class="ident" id="4201549">size</span>&nbsp;<span class="op" id="4201554">=</span>&nbsp;<span class="num" id="4201556">64</span>&nbsp;<span class="op" id="4201559">&lt;&lt;</span>&nbsp;<span class="num" id="4201562">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201568">buf</span>&nbsp;<span class="op" id="4201572">:=</span>&nbsp;<span class="builtinfunc" id="4201575">make</span><span class="op" id="4201579">(</span><span class="op" id="4201580">[</span><span class="op" id="4201581">]</span><span class="builtintype" id="4201582">byte</span><span class="op" id="4201586">,</span>&nbsp;<span class="ident" id="4201588"><a href="/gostd/net/http/server.go.html#4201549">size</a></span><span class="op" id="4201592">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201597"><a href="/gostd/net/http/server.go.html#4201568">buf</a></span>&nbsp;<span class="op" id="4201601">=</span>&nbsp;<span class="ident" id="4201603"><a href="/gostd/net/http/server.go.html#4201568">buf</a></span><span class="op" id="4201606">[</span><span class="op" id="4201607">:</span><span class="ident" id="4201608"><a href="/gostd/net/http/server.go.html#4169378">runtime</a></span><span class="op" id="4201615">.</span><span class="ident" id="4201616"><a href="/gostd/runtime/mprof.go.html#1634979">Stack</a></span><span class="op" id="4201621">(</span><span class="ident" id="4201622"><a href="/gostd/net/http/server.go.html#4201568">buf</a></span><span class="op" id="4201625">,</span>&nbsp;<span class="builtintype" id="4201627">false</span><span class="op" id="4201632">)</span><span class="op" id="4201633">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201638"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201639">.</span><span class="ident" id="4201640"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4201646">.</span><span class="ident" id="4201647"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4201651">(</span><span class="string" id="4201652">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="4201684">,</span>&nbsp;<span class="ident" id="4201686"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201687">.</span><span class="ident" id="4201688"><a href="/gostd/net/http/server.go.html#4172807">remoteAddr</a></span><span class="op" id="4201698">,</span>&nbsp;<span class="ident" id="4201700"><a href="/gostd/net/http/server.go.html#4201509">err</a></span><span class="op" id="4201703">,</span>&nbsp;<span class="ident" id="4201705"><a href="/gostd/net/http/server.go.html#4201568">buf</a></span><span class="op" id="4201708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201716">if</span>&nbsp;<span class="op" id="4201719">!</span><span class="ident" id="4201720"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201721">.</span><span class="ident" id="4201722"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4201730">(</span><span class="op" id="4201731">)</span>&nbsp;<span class="op" id="4201733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201738"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201739">.</span><span class="builtinfunc" id="4201740"><a href="/gostd/net/http/server.go.html#4199813">close</a></span><span class="op" id="4201745">(</span><span class="op" id="4201746">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201751"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201752">.</span><span class="ident" id="4201753"><a href="/gostd/net/http/server.go.html#4201256">setState</a></span><span class="op" id="4201761">(</span><span class="ident" id="4201762"><a href="/gostd/net/http/server.go.html#4201420">origConn</a></span><span class="op" id="4201770">,</span>&nbsp;<span class="ident" id="4201772"><a href="/gostd/net/http/server.go.html#4219294">StateClosed</a></span><span class="op" id="4201783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201790">}</span><span class="op" id="4201791">(</span><span class="op" id="4201792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201796">if</span>&nbsp;<span class="ident" id="4201799">tlsConn</span><span class="op" id="4201806">,</span>&nbsp;<span class="ident" id="4201808">ok</span>&nbsp;<span class="op" id="4201811">:=</span>&nbsp;<span class="ident" id="4201814"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201815">.</span><span class="ident" id="4201816"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4201819">.</span><span class="op" id="4201820">(</span><span class="op" id="4201821">*</span><span class="ident" id="4201822"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4201825">.</span><span class="ident" id="4201826"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4201830">)</span><span class="op" id="4201831">;</span>&nbsp;<span class="ident" id="4201833"><a href="/gostd/net/http/server.go.html#4201808">ok</a></span>&nbsp;<span class="op" id="4201836">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201840">if</span>&nbsp;<span class="ident" id="4201843">d</span>&nbsp;<span class="op" id="4201845">:=</span>&nbsp;<span class="ident" id="4201848"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201849">.</span><span class="ident" id="4201850"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4201856">.</span><span class="ident" id="4201857"><a href="/gostd/net/http/server.go.html#4216734">ReadTimeout</a></span><span class="op" id="4201868">;</span>&nbsp;<span class="ident" id="4201870"><a href="/gostd/net/http/server.go.html#4201843">d</a></span>&nbsp;<span class="op" id="4201872">!=</span>&nbsp;<span class="num" id="4201875">0</span>&nbsp;<span class="op" id="4201877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201882"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201883">.</span><span class="ident" id="4201884"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4201887">.</span><span class="ident" id="4201888"><a href="/gostd/net/net.go.html#3335873">SetReadDeadline</a></span><span class="op" id="4201903">(</span><span class="ident" id="4201904"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4201908">.</span><span class="ident" id="4201909"><a href="/gostd/time/time.go.html#2743088">Now</a></span><span class="op" id="4201912">(</span><span class="op" id="4201913">)</span><span class="op" id="4201914">.</span><span class="ident" id="4201915"><a href="/gostd/time/time.go.html#2738615">Add</a></span><span class="op" id="4201918">(</span><span class="ident" id="4201919"><a href="/gostd/net/http/server.go.html#4201843">d</a></span><span class="op" id="4201920">)</span><span class="op" id="4201921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201929">if</span>&nbsp;<span class="ident" id="4201932">d</span>&nbsp;<span class="op" id="4201934">:=</span>&nbsp;<span class="ident" id="4201937"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201938">.</span><span class="ident" id="4201939"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4201945">.</span><span class="ident" id="4201946"><a href="/gostd/net/http/server.go.html#4216822">WriteTimeout</a></span><span class="op" id="4201958">;</span>&nbsp;<span class="ident" id="4201960"><a href="/gostd/net/http/server.go.html#4201932">d</a></span>&nbsp;<span class="op" id="4201962">!=</span>&nbsp;<span class="num" id="4201965">0</span>&nbsp;<span class="op" id="4201967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201972"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4201973">.</span><span class="ident" id="4201974"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4201977">.</span><span class="ident" id="4201978"><a href="/gostd/net/net.go.html#3336140">SetWriteDeadline</a></span><span class="op" id="4201994">(</span><span class="ident" id="4201995"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4201999">.</span><span class="ident" id="4202000"><a href="/gostd/time/time.go.html#2743088">Now</a></span><span class="op" id="4202003">(</span><span class="op" id="4202004">)</span><span class="op" id="4202005">.</span><span class="ident" id="4202006"><a href="/gostd/time/time.go.html#2738615">Add</a></span><span class="op" id="4202009">(</span><span class="ident" id="4202010"><a href="/gostd/net/http/server.go.html#4201932">d</a></span><span class="op" id="4202011">)</span><span class="op" id="4202012">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202020">if</span>&nbsp;<span class="ident" id="4202023">err</span>&nbsp;<span class="op" id="4202027">:=</span>&nbsp;<span class="ident" id="4202030"><a href="/gostd/net/http/server.go.html#4201799">tlsConn</a></span><span class="op" id="4202037">.</span><span class="ident" id="4202038"><a href="/gostd/crypto/tls/conn.go.html#4488474">Handshake</a></span><span class="op" id="4202047">(</span><span class="op" id="4202048">)</span><span class="op" id="4202049">;</span>&nbsp;<span class="ident" id="4202051"><a href="/gostd/net/http/server.go.html#4202023">err</a></span>&nbsp;<span class="op" id="4202055">!=</span>&nbsp;<span class="builtintype" id="4202058">nil</span>&nbsp;<span class="op" id="4202062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202067"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202068">.</span><span class="ident" id="4202069"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4202075">.</span><span class="ident" id="4202076"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4202080">(</span><span class="string" id="4202081">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4202120">,</span>&nbsp;<span class="ident" id="4202122"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202123">.</span><span class="ident" id="4202124"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4202127">.</span><span class="ident" id="4202128"><a href="/gostd/net/net.go.html#3335122">RemoteAddr</a></span><span class="op" id="4202138">(</span><span class="op" id="4202139">)</span><span class="op" id="4202140">,</span>&nbsp;<span class="ident" id="4202142"><a href="/gostd/net/http/server.go.html#4202023">err</a></span><span class="op" id="4202145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202150">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202159">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202163"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202164">.</span><span class="ident" id="4202165"><a href="/gostd/net/http/server.go.html#4173393">tlsState</a></span>&nbsp;<span class="op" id="4202174">=</span>&nbsp;<span class="builtinfunc" id="4202176">new</span><span class="op" id="4202179">(</span><span class="ident" id="4202180"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4202183">.</span><span class="ident" id="4202184"><a href="/gostd/crypto/tls/common.go.html#4446494">ConnectionState</a></span><span class="op" id="4202199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202203">*</span><span class="ident" id="4202204"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202205">.</span><span class="ident" id="4202206"><a href="/gostd/net/http/server.go.html#4173393">tlsState</a></span>&nbsp;<span class="op" id="4202215">=</span>&nbsp;<span class="ident" id="4202217"><a href="/gostd/net/http/server.go.html#4201799">tlsConn</a></span><span class="op" id="4202224">.</span><span class="ident" id="4202225"><a href="/gostd/crypto/tls/conn.go.html#4488867">ConnectionState</a></span><span class="op" id="4202240">(</span><span class="op" id="4202241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202245">if</span>&nbsp;<span class="ident" id="4202248">proto</span>&nbsp;<span class="op" id="4202254">:=</span>&nbsp;<span class="ident" id="4202257"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202258">.</span><span class="ident" id="4202259"><a href="/gostd/net/http/server.go.html#4173393">tlsState</a></span><span class="op" id="4202267">.</span><span class="ident" id="4202268"><a href="/gostd/crypto/tls/common.go.html#4446910">NegotiatedProtocol</a></span><span class="op" id="4202286">;</span>&nbsp;<span class="ident" id="4202288"><a href="/gostd/net/http/server.go.html#4201127">validNPN</a></span><span class="op" id="4202296">(</span><span class="ident" id="4202297"><a href="/gostd/net/http/server.go.html#4202248">proto</a></span><span class="op" id="4202302">)</span>&nbsp;<span class="op" id="4202304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202309">if</span>&nbsp;<span class="ident" id="4202312">fn</span>&nbsp;<span class="op" id="4202315">:=</span>&nbsp;<span class="ident" id="4202318"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202319">.</span><span class="ident" id="4202320"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4202326">.</span><span class="ident" id="4202327"><a href="/gostd/net/http/server.go.html#4217502">TLSNextProto</a></span><span class="op" id="4202339">[</span><span class="ident" id="4202340"><a href="/gostd/net/http/server.go.html#4202248">proto</a></span><span class="op" id="4202345">]</span><span class="op" id="4202346">;</span>&nbsp;<span class="ident" id="4202348"><a href="/gostd/net/http/server.go.html#4202312">fn</a></span>&nbsp;<span class="op" id="4202351">!=</span>&nbsp;<span class="builtintype" id="4202354">nil</span>&nbsp;<span class="op" id="4202358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202364">h</span>&nbsp;<span class="op" id="4202366">:=</span>&nbsp;<span class="ident" id="4202369"><a href="/gostd/net/http/server.go.html#4228816">initNPNRequest</a></span><span class="op" id="4202383">{</span><span class="ident" id="4202384"><a href="/gostd/net/http/server.go.html#4201799">tlsConn</a></span><span class="op" id="4202391">,</span>&nbsp;<span class="ident" id="4202393"><a href="/gostd/net/http/server.go.html#4219662">serverHandler</a></span><span class="op" id="4202406">{</span><span class="ident" id="4202407"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202408">.</span><span class="ident" id="4202409"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4202415">}</span><span class="op" id="4202416">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202422"><a href="/gostd/net/http/server.go.html#4202312">fn</a></span><span class="op" id="4202424">(</span><span class="ident" id="4202425"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202426">.</span><span class="ident" id="4202427"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4202433">,</span>&nbsp;<span class="ident" id="4202435"><a href="/gostd/net/http/server.go.html#4201799">tlsConn</a></span><span class="op" id="4202442">,</span>&nbsp;<span class="ident" id="4202444"><a href="/gostd/net/http/server.go.html#4202364">h</a></span><span class="op" id="4202445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202455">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202467">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202471">for</span>&nbsp;<span class="op" id="4202475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202479">w</span><span class="op" id="4202480">,</span>&nbsp;<span class="ident" id="4202482">err</span>&nbsp;<span class="op" id="4202486">:=</span>&nbsp;<span class="ident" id="4202489"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202490">.</span><span class="ident" id="4202491"><a href="/gostd/net/http/server.go.html#4185106">readRequest</a></span><span class="op" id="4202502">(</span><span class="op" id="4202503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202507">if</span>&nbsp;<span class="ident" id="4202510"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202511">.</span><span class="ident" id="4202512"><a href="/gostd/net/http/server.go.html#4173243">lr</a></span><span class="op" id="4202514">.</span><span class="ident" id="4202515"><a href="/gostd/io/io.go.html#1432105">N</a></span>&nbsp;<span class="op" id="4202517">!=</span>&nbsp;<span class="ident" id="4202520"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202521">.</span><span class="ident" id="4202522"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4202528">.</span><span class="ident" id="4202529"><a href="/gostd/net/http/server.go.html#4183310">initialLimitedReaderSize</a></span><span class="op" id="4202553">(</span><span class="op" id="4202554">)</span>&nbsp;<span class="op" id="4202556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202561">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202616"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202617">.</span><span class="ident" id="4202618"><a href="/gostd/net/http/server.go.html#4201256">setState</a></span><span class="op" id="4202626">(</span><span class="ident" id="4202627"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202628">.</span><span class="ident" id="4202629"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4202632">,</span>&nbsp;<span class="ident" id="4202634"><a href="/gostd/net/http/server.go.html#4218772">StateActive</a></span><span class="op" id="4202645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202653">if</span>&nbsp;<span class="ident" id="4202656"><a href="/gostd/net/http/server.go.html#4202482">err</a></span>&nbsp;<span class="op" id="4202660">!=</span>&nbsp;<span class="builtintype" id="4202663">nil</span>&nbsp;<span class="op" id="4202667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202672">if</span>&nbsp;<span class="ident" id="4202675"><a href="/gostd/net/http/server.go.html#4202482">err</a></span>&nbsp;<span class="op" id="4202679">==</span>&nbsp;<span class="ident" id="4202682"><a href="/gostd/net/http/server.go.html#4185000">errTooLarge</a></span>&nbsp;<span class="op" id="4202694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202700">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202743">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202777">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202818">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202859">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202896"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4202898">.</span><span class="ident" id="4202899"><a href="/gostd/io/io.go.html#1428475">WriteString</a></span><span class="op" id="4202910">(</span><span class="ident" id="4202911"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202912">.</span><span class="ident" id="4202913"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4202916">,</span>&nbsp;<span class="string" id="4202918">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="4202965">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202971"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4202972">.</span><span class="ident" id="4202973"><a href="/gostd/net/http/server.go.html#4200776">closeWriteAndWait</a></span><span class="op" id="4202990">(</span><span class="op" id="4202991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202997">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203006">}</span>&nbsp;<span class="keyword" id="4203008">else</span>&nbsp;<span class="keyword" id="4203013">if</span>&nbsp;<span class="ident" id="4203016"><a href="/gostd/net/http/server.go.html#4202482">err</a></span>&nbsp;<span class="op" id="4203020">==</span>&nbsp;<span class="ident" id="4203023"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4203025">.</span><span class="ident" id="4203026"><a href="/gostd/io/io.go.html#1419950">EOF</a></span>&nbsp;<span class="op" id="4203030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203036">break</span>&nbsp;<span class="comment" id="4203042">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203060">}</span>&nbsp;<span class="keyword" id="4203062">else</span>&nbsp;<span class="keyword" id="4203067">if</span>&nbsp;<span class="ident" id="4203070">neterr</span><span class="op" id="4203076">,</span>&nbsp;<span class="ident" id="4203078">ok</span>&nbsp;<span class="op" id="4203081">:=</span>&nbsp;<span class="ident" id="4203084"><a href="/gostd/net/http/server.go.html#4202482">err</a></span><span class="op" id="4203087">.</span><span class="op" id="4203088">(</span><span class="ident" id="4203089"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4203092">.</span><span class="ident" id="4203093"><a href="/gostd/net/net.go.html#3338570">Error</a></span><span class="op" id="4203098">)</span><span class="op" id="4203099">;</span>&nbsp;<span class="ident" id="4203101"><a href="/gostd/net/http/server.go.html#4203078">ok</a></span>&nbsp;<span class="op" id="4203104">&amp;&amp;</span>&nbsp;<span class="ident" id="4203107"><a href="/gostd/net/http/server.go.html#4203070">neterr</a></span><span class="op" id="4203113">.</span><span class="ident" id="4203114"><a href="/gostd/net/net.go.html#3338596">Timeout</a></span><span class="op" id="4203121">(</span><span class="op" id="4203122">)</span>&nbsp;<span class="op" id="4203124">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203130">break</span>&nbsp;<span class="comment" id="4203136">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203159"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4203161">.</span><span class="ident" id="4203162"><a href="/gostd/io/io.go.html#1428475">WriteString</a></span><span class="op" id="4203173">(</span><span class="ident" id="4203174"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4203175">.</span><span class="ident" id="4203176"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4203179">,</span>&nbsp;<span class="string" id="4203181">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="4203215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203220">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203228">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203233">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203266">req</span>&nbsp;<span class="op" id="4203270">:=</span>&nbsp;<span class="ident" id="4203273"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4203274">.</span><span class="ident" id="4203275"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203281">if</span>&nbsp;<span class="ident" id="4203284"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203287">.</span><span class="ident" id="4203288"><a href="/gostd/net/http/request.go.html#4160564">expectsContinue</a></span><span class="op" id="4203303">(</span><span class="op" id="4203304">)</span>&nbsp;<span class="op" id="4203306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203311">if</span>&nbsp;<span class="ident" id="4203314"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203317">.</span><span class="ident" id="4203318"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4203330">(</span><span class="num" id="4203331">1</span><span class="op" id="4203332">,</span>&nbsp;<span class="num" id="4203334">1</span><span class="op" id="4203335">)</span>&nbsp;<span class="op" id="4203337">&amp;&amp;</span>&nbsp;<span class="ident" id="4203340"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203343">.</span><span class="ident" id="4203344"><a href="/gostd/net/http/request.go.html#4138292">ContentLength</a></span>&nbsp;<span class="op" id="4203358">!=</span>&nbsp;<span class="num" id="4203361">0</span>&nbsp;<span class="op" id="4203363">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203369">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203437"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203440">.</span><span class="ident" id="4203441"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span>&nbsp;<span class="op" id="4203446">=</span>&nbsp;<span class="op" id="4203448">&amp;</span><span class="ident" id="4203449"><a href="/gostd/net/http/server.go.html#4183506">expectContinueReader</a></span><span class="op" id="4203469">{</span><span class="ident" id="4203470"><a href="/gostd/net/http/server.go.html#4183559">readCloser</a></span><span class="op" id="4203480">:</span>&nbsp;<span class="ident" id="4203482"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203485">.</span><span class="ident" id="4203486"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4203490">,</span>&nbsp;<span class="ident" id="4203492"><a href="/gostd/net/http/server.go.html#4183537">resp</a></span><span class="op" id="4203496">:</span>&nbsp;<span class="ident" id="4203498"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4203499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203509"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203512">.</span><span class="ident" id="4203513"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="4203519">.</span><span class="ident" id="4203520"><a href="/gostd/net/http/header.go.html#4127099">Del</a></span><span class="op" id="4203523">(</span><span class="string" id="4203524">&#34;Expect&#34;</span><span class="op" id="4203532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203536">}</span>&nbsp;<span class="keyword" id="4203538">else</span>&nbsp;<span class="keyword" id="4203543">if</span>&nbsp;<span class="ident" id="4203546"><a href="/gostd/net/http/server.go.html#4203266">req</a></span><span class="op" id="4203549">.</span><span class="ident" id="4203550"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="4203556">.</span><span class="ident" id="4203557"><a href="/gostd/net/http/header.go.html#4126950">get</a></span><span class="op" id="4203560">(</span><span class="string" id="4203561">&#34;Expect&#34;</span><span class="op" id="4203569">)</span>&nbsp;<span class="op" id="4203571">!=</span>&nbsp;<span class="string" id="4203574">&#34;&#34;</span>&nbsp;<span class="op" id="4203577">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203582"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4203583">.</span><span class="ident" id="4203584"><a href="/gostd/net/http/server.go.html#4204211">sendExpectationFailed</a></span><span class="op" id="4203605">(</span><span class="op" id="4203606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203611">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203624">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203688">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203758">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203818">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203894">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203958"><a href="/gostd/net/http/server.go.html#4219662">serverHandler</a></span><span class="op" id="4203971">{</span><span class="ident" id="4203972"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4203973">.</span><span class="ident" id="4203974"><a href="/gostd/net/http/server.go.html#4172874">server</a></span><span class="op" id="4203980">}</span><span class="op" id="4203981">.</span><span class="ident" id="4203982"><a href="/gostd/net/http/server.go.html#4219725">ServeHTTP</a></span><span class="op" id="4203991">(</span><span class="ident" id="4203992"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4203993">,</span>&nbsp;<span class="ident" id="4203995"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4203996">.</span><span class="ident" id="4203997"><a href="/gostd/net/http/server.go.html#4177713">req</a></span><span class="op" id="4204000">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204004">if</span>&nbsp;<span class="ident" id="4204007"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4204008">.</span><span class="ident" id="4204009"><a href="/gostd/net/http/server.go.html#4173697">hijacked</a></span><span class="op" id="4204017">(</span><span class="op" id="4204018">)</span>&nbsp;<span class="op" id="4204020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204038"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4204039">.</span><span class="ident" id="4204040"><a href="/gostd/net/http/server.go.html#4198581">finishRequest</a></span><span class="op" id="4204053">(</span><span class="op" id="4204054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204058">if</span>&nbsp;<span class="ident" id="4204061"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4204062">.</span><span class="ident" id="4204063"><a href="/gostd/net/http/server.go.html#4178723">closeAfterReply</a></span>&nbsp;<span class="op" id="4204079">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204084">if</span>&nbsp;<span class="ident" id="4204087"><a href="/gostd/net/http/server.go.html#4202479">w</a></span><span class="op" id="4204088">.</span><span class="ident" id="4204089"><a href="/gostd/net/http/server.go.html#4179104">requestBodyLimitHit</a></span>&nbsp;<span class="op" id="4204109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204115"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4204116">.</span><span class="ident" id="4204117"><a href="/gostd/net/http/server.go.html#4200776">closeWriteAndWait</a></span><span class="op" id="4204134">(</span><span class="op" id="4204135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204145">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204153">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204157"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4204158">.</span><span class="ident" id="4204159"><a href="/gostd/net/http/server.go.html#4201256">setState</a></span><span class="op" id="4204167">(</span><span class="ident" id="4204168"><a href="/gostd/net/http/server.go.html#4201400">c</a></span><span class="op" id="4204169">.</span><span class="ident" id="4204170"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4204173">,</span>&nbsp;<span class="ident" id="4204175"><a href="/gostd/net/http/server.go.html#4219008">StateIdle</a></span><span class="op" id="4204184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204187">}</span><br>
<span class="lineno"></span><span class="op" id="4204189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4204192">func</span>&nbsp;<span class="op" id="4204197">(</span><span class="ident" id="4204198">w</span>&nbsp;<span class="op" id="4204200">*</span><span class="ident" id="4204201"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4204209">)</span>&nbsp;<span class="ident" id="4204211">sendExpectationFailed</span><span class="op" id="4204232">(</span><span class="op" id="4204233">)</span>&nbsp;<span class="op" id="4204235">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204238">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204288">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204341">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204391">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204441">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204481">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204525">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204529">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204583">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204633">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204680">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204728">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204781"><a href="/gostd/net/http/server.go.html#4204198">w</a></span><span class="op" id="4204782">.</span><span class="ident" id="4204783"><a href="/gostd/net/http/server.go.html#4185881">Header</a></span><span class="op" id="4204789">(</span><span class="op" id="4204790">)</span><span class="op" id="4204791">.</span><span class="ident" id="4204792"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4204795">(</span><span class="string" id="4204796">&#34;Connection&#34;</span><span class="op" id="4204808">,</span>&nbsp;<span class="string" id="4204810">&#34;close&#34;</span><span class="op" id="4204817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204820"><a href="/gostd/net/http/server.go.html#4204198">w</a></span><span class="op" id="4204821">.</span><span class="ident" id="4204822"><a href="/gostd/net/http/server.go.html#4186739">WriteHeader</a></span><span class="op" id="4204833">(</span><span class="ident" id="4204834"><a href="/gostd/net/http/status.go.html#4237381">StatusExpectationFailed</a></span><span class="op" id="4204857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204860"><a href="/gostd/net/http/server.go.html#4204198">w</a></span><span class="op" id="4204861">.</span><span class="ident" id="4204862"><a href="/gostd/net/http/server.go.html#4198581">finishRequest</a></span><span class="op" id="4204875">(</span><span class="op" id="4204876">)</span><br>
<span class="lineno">1235</span><span class="op" id="4204878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4204881">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4204968">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="4204987">func</span>&nbsp;<span class="op" id="4204992">(</span><span class="ident" id="4204993">w</span>&nbsp;<span class="op" id="4204995">*</span><span class="ident" id="4204996"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4205004">)</span>&nbsp;<span class="ident" id="4205006">Hijack</span><span class="op" id="4205012">(</span><span class="op" id="4205013">)</span>&nbsp;<span class="op" id="4205015">(</span><span class="ident" id="4205016">rwc</span>&nbsp;<span class="ident" id="4205020"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4205023">.</span><span class="ident" id="4205024"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4205028">,</span>&nbsp;<span class="ident" id="4205030">buf</span>&nbsp;<span class="op" id="4205034">*</span><span class="ident" id="4205035"><a href="/gostd/net/http/server.go.html#4169280">bufio</a></span><span class="op" id="4205040">.</span><span class="ident" id="4205041"><a href="/gostd/bufio/bufio.go.html#1370925">ReadWriter</a></span><span class="op" id="4205051">,</span>&nbsp;<span class="ident" id="4205053">err</span>&nbsp;<span class="builtintype" id="4205057">error</span><span class="op" id="4205062">)</span>&nbsp;<span class="op" id="4205064">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205067">if</span>&nbsp;<span class="ident" id="4205070"><a href="/gostd/net/http/server.go.html#4204993">w</a></span><span class="op" id="4205071">.</span><span class="ident" id="4205072"><a href="/gostd/net/http/server.go.html#4177766">wroteHeader</a></span>&nbsp;<span class="op" id="4205084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205088"><a href="/gostd/net/http/server.go.html#4204993">w</a></span><span class="op" id="4205089">.</span><span class="ident" id="4205090"><a href="/gostd/net/http/server.go.html#4177958">cw</a></span><span class="op" id="4205092">.</span><span class="ident" id="4205093"><a href="/gostd/net/http/server.go.html#4177253">flush</a></span><span class="op" id="4205098">(</span><span class="op" id="4205099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205105">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205176">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205223"><a href="/gostd/net/http/server.go.html#4205016">rwc</a></span><span class="op" id="4205226">,</span>&nbsp;<span class="ident" id="4205228"><a href="/gostd/net/http/server.go.html#4205030">buf</a></span><span class="op" id="4205231">,</span>&nbsp;<span class="ident" id="4205233"><a href="/gostd/net/http/server.go.html#4205053">err</a></span>&nbsp;<span class="op" id="4205237">=</span>&nbsp;<span class="ident" id="4205239"><a href="/gostd/net/http/server.go.html#4204993">w</a></span><span class="op" id="4205240">.</span><span class="ident" id="4205241"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4205245">.</span><span class="ident" id="4205246"><a href="/gostd/net/http/server.go.html#4173787">hijack</a></span><span class="op" id="4205252">(</span><span class="op" id="4205253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205256">if</span>&nbsp;<span class="ident" id="4205259"><a href="/gostd/net/http/server.go.html#4205053">err</a></span>&nbsp;<span class="op" id="4205263">==</span>&nbsp;<span class="builtintype" id="4205266">nil</span>&nbsp;<span class="op" id="4205270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205274"><a href="/gostd/net/http/server.go.html#4182826">putBufioWriter</a></span><span class="op" id="4205288">(</span><span class="ident" id="4205289"><a href="/gostd/net/http/server.go.html#4204993">w</a></span><span class="op" id="4205290">.</span><span class="ident" id="4205291"><a href="/gostd/net/http/server.go.html#4177897">w</a></span><span class="op" id="4205292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205296"><a href="/gostd/net/http/server.go.html#4204993">w</a></span><span class="op" id="4205297">.</span><span class="ident" id="4205298"><a href="/gostd/net/http/server.go.html#4177897">w</a></span>&nbsp;<span class="op" id="4205300">=</span>&nbsp;<span class="builtintype" id="4205302">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205307">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205310">return</span>&nbsp;<span class="ident" id="4205317"><a href="/gostd/net/http/server.go.html#4205016">rwc</a></span><span class="op" id="4205320">,</span>&nbsp;<span class="ident" id="4205322"><a href="/gostd/net/http/server.go.html#4205030">buf</a></span><span class="op" id="4205325">,</span>&nbsp;<span class="ident" id="4205327"><a href="/gostd/net/http/server.go.html#4205053">err</a></span><br>
<span class="lineno"></span><span class="op" id="4205331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4205334">func</span>&nbsp;<span class="op" id="4205339">(</span><span class="ident" id="4205340">w</span>&nbsp;<span class="op" id="4205342">*</span><span class="ident" id="4205343"><a href="/gostd/net/http/server.go.html#4177673">response</a></span><span class="op" id="4205351">)</span>&nbsp;<span class="ident" id="4205353">CloseNotify</span><span class="op" id="4205364">(</span><span class="op" id="4205365">)</span>&nbsp;<span class="op" id="4205367">&lt;-</span><span class="keyword" id="4205369">chan</span>&nbsp;<span class="builtintype" id="4205374">bool</span>&nbsp;<span class="op" id="4205379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205382">return</span>&nbsp;<span class="ident" id="4205389"><a href="/gostd/net/http/server.go.html#4205340">w</a></span><span class="op" id="4205390">.</span><span class="ident" id="4205391"><a href="/gostd/net/http/server.go.html#4177692">conn</a></span><span class="op" id="4205395">.</span><span class="ident" id="4205396"><a href="/gostd/net/http/server.go.html#4174182">closeNotify</a></span><span class="op" id="4205407">(</span><span class="op" id="4205408">)</span><br>
<span class="lineno">1255</span><span class="op" id="4205410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4205413">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4205471">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="4205531">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="4205586">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="4205618">type</span>&nbsp;<span class="ident" id="4205623">HandlerFunc</span>&nbsp;<span class="keyword" id="4205635">func</span><span class="op" id="4205639">(</span><span class="ident" id="4205640"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4205654">,</span>&nbsp;<span class="op" id="4205656">*</span><span class="ident" id="4205657"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4205664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4205667">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="4205695">func</span>&nbsp;<span class="op" id="4205700">(</span><span class="ident" id="4205701">f</span>&nbsp;<span class="ident" id="4205703"><a href="/gostd/net/http/server.go.html#4205623">HandlerFunc</a></span><span class="op" id="4205714">)</span>&nbsp;<span class="ident" id="4205716">ServeHTTP</span><span class="op" id="4205725">(</span><span class="ident" id="4205726">w</span>&nbsp;<span class="ident" id="4205728"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4205742">,</span>&nbsp;<span class="ident" id="4205744">r</span>&nbsp;<span class="op" id="4205746">*</span><span class="ident" id="4205747"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4205754">)</span>&nbsp;<span class="op" id="4205756">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205759"><a href="/gostd/net/http/server.go.html#4205701">f</a></span><span class="op" id="4205760">(</span><span class="ident" id="4205761"><a href="/gostd/net/http/server.go.html#4205726">w</a></span><span class="op" id="4205762">,</span>&nbsp;<span class="ident" id="4205764"><a href="/gostd/net/http/server.go.html#4205744">r</a></span><span class="op" id="4205765">)</span><br>
<span class="lineno"></span><span class="op" id="4205767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4205770">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="4205790">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4205870">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="4205913">func</span>&nbsp;<span class="ident" id="4205918">Error</span><span class="op" id="4205923">(</span><span class="ident" id="4205924">w</span>&nbsp;<span class="ident" id="4205926"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4205940">,</span>&nbsp;<span class="builtintype" id="4205942">error</span>&nbsp;<span class="builtintype" id="4205948">string</span><span class="op" id="4205954">,</span>&nbsp;<span class="ident" id="4205956">code</span>&nbsp;<span class="builtintype" id="4205961">int</span><span class="op" id="4205964">)</span>&nbsp;<span class="op" id="4205966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205969"><a href="/gostd/net/http/server.go.html#4205924">w</a></span><span class="op" id="4205970">.</span><span class="ident" id="4205971"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="4205977">(</span><span class="op" id="4205978">)</span><span class="op" id="4205979">.</span><span class="ident" id="4205980"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4205983">(</span><span class="string" id="4205984">&#34;Content-Type&#34;</span><span class="op" id="4205998">,</span>&nbsp;<span class="string" id="4206000">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4206027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206030"><a href="/gostd/net/http/server.go.html#4205924">w</a></span><span class="op" id="4206031">.</span><span class="ident" id="4206032"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="4206043">(</span><span class="ident" id="4206044"><a href="/gostd/net/http/server.go.html#4205956">code</a></span><span class="op" id="4206048">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206051"><a href="/gostd/net/http/server.go.html#4169313">fmt</a></span><span class="op" id="4206054">.</span><span class="ident" id="4206055"><a href="/gostd/fmt/print.go.html#2145376">Fprintln</a></span><span class="op" id="4206063">(</span><span class="ident" id="4206064"><a href="/gostd/net/http/server.go.html#4205924">w</a></span><span class="op" id="4206065">,</span>&nbsp;<span class="builtintype" id="4206067"><a href="/gostd/net/http/server.go.html#4205942">error</a></span><span class="op" id="4206072">)</span><br>
<span class="lineno"></span><span class="op" id="4206074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4206077">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4206146">func</span>&nbsp;<span class="ident" id="4206151">NotFound</span><span class="op" id="4206159">(</span><span class="ident" id="4206160">w</span>&nbsp;<span class="ident" id="4206162"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4206176">,</span>&nbsp;<span class="ident" id="4206178">r</span>&nbsp;<span class="op" id="4206180">*</span><span class="ident" id="4206181"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4206188">)</span>&nbsp;<span class="op" id="4206190">{</span>&nbsp;<span class="ident" id="4206192"><a href="/gostd/net/http/server.go.html#4205918">Error</a></span><span class="op" id="4206197">(</span><span class="ident" id="4206198"><a href="/gostd/net/http/server.go.html#4206160">w</a></span><span class="op" id="4206199">,</span>&nbsp;<span class="string" id="4206201">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="4206221">,</span>&nbsp;<span class="ident" id="4206223"><a href="/gostd/net/http/status.go.html#4236835">StatusNotFound</a></span><span class="op" id="4206237">)</span>&nbsp;<span class="op" id="4206239">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="4206242">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4206294">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4206363">func</span>&nbsp;<span class="ident" id="4206368">NotFoundHandler</span><span class="op" id="4206383">(</span><span class="op" id="4206384">)</span>&nbsp;<span class="ident" id="4206386"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span>&nbsp;<span class="op" id="4206394">{</span>&nbsp;<span class="keyword" id="4206396">return</span>&nbsp;<span class="ident" id="4206403"><a href="/gostd/net/http/server.go.html#4205623">HandlerFunc</a></span><span class="op" id="4206414">(</span><span class="ident" id="4206415"><a href="/gostd/net/http/server.go.html#4206151">NotFound</a></span><span class="op" id="4206423">)</span>&nbsp;<span class="op" id="4206425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="4206428">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4206487">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="4206547">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4206600">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4206656">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="4206702">func</span>&nbsp;<span class="ident" id="4206707">StripPrefix</span><span class="op" id="4206718">(</span><span class="ident" id="4206719">prefix</span>&nbsp;<span class="builtintype" id="4206726">string</span><span class="op" id="4206732">,</span>&nbsp;<span class="ident" id="4206734">h</span>&nbsp;<span class="ident" id="4206736"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4206743">)</span>&nbsp;<span class="ident" id="4206745"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span>&nbsp;<span class="op" id="4206753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206756">if</span>&nbsp;<span class="ident" id="4206759"><a href="/gostd/net/http/server.go.html#4206719">prefix</a></span>&nbsp;<span class="op" id="4206766">==</span>&nbsp;<span class="string" id="4206769">&#34;&#34;</span>&nbsp;<span class="op" id="4206772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206776">return</span>&nbsp;<span class="ident" id="4206783"><a href="/gostd/net/http/server.go.html#4206734">h</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206789">return</span>&nbsp;<span class="ident" id="4206796"><a href="/gostd/net/http/server.go.html#4205623">HandlerFunc</a></span><span class="op" id="4206807">(</span><span class="keyword" id="4206808">func</span><span class="op" id="4206812">(</span><span class="ident" id="4206813">w</span>&nbsp;<span class="ident" id="4206815"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4206829">,</span>&nbsp;<span class="ident" id="4206831">r</span>&nbsp;<span class="op" id="4206833">*</span><span class="ident" id="4206834"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4206841">)</span>&nbsp;<span class="op" id="4206843">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206847">if</span>&nbsp;<span class="ident" id="4206850">p</span>&nbsp;<span class="op" id="4206852">:=</span>&nbsp;<span class="ident" id="4206855"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4206862">.</span><span class="ident" id="4206863"><a href="/gostd/strings/strings.go.html#2982727">TrimPrefix</a></span><span class="op" id="4206873">(</span><span class="ident" id="4206874"><a href="/gostd/net/http/server.go.html#4206831">r</a></span><span class="op" id="4206875">.</span><span class="ident" id="4206876"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4206879">.</span><span class="ident" id="4206880"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="4206884">,</span>&nbsp;<span class="ident" id="4206886"><a href="/gostd/net/http/server.go.html#4206719">prefix</a></span><span class="op" id="4206892">)</span><span class="op" id="4206893">;</span>&nbsp;<span class="builtinfunc" id="4206895">len</span><span class="op" id="4206898">(</span><span class="ident" id="4206899"><a href="/gostd/net/http/server.go.html#4206850">p</a></span><span class="op" id="4206900">)</span>&nbsp;<span class="op" id="4206902">&lt;</span>&nbsp;<span class="builtinfunc" id="4206904">len</span><span class="op" id="4206907">(</span><span class="ident" id="4206908"><a href="/gostd/net/http/server.go.html#4206831">r</a></span><span class="op" id="4206909">.</span><span class="ident" id="4206910"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4206913">.</span><span class="ident" id="4206914"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="4206918">)</span>&nbsp;<span class="op" id="4206920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206925"><a href="/gostd/net/http/server.go.html#4206831">r</a></span><span class="op" id="4206926">.</span><span class="ident" id="4206927"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4206930">.</span><span class="ident" id="4206931"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span>&nbsp;<span class="op" id="4206936">=</span>&nbsp;<span class="ident" id="4206938"><a href="/gostd/net/http/server.go.html#4206850">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206943"><a href="/gostd/net/http/server.go.html#4206734">h</a></span><span class="op" id="4206944">.</span><span class="ident" id="4206945"><a href="/gostd/net/http/server.go.html#4170434">ServeHTTP</a></span><span class="op" id="4206954">(</span><span class="ident" id="4206955"><a href="/gostd/net/http/server.go.html#4206813">w</a></span><span class="op" id="4206956">,</span>&nbsp;<span class="ident" id="4206958"><a href="/gostd/net/http/server.go.html#4206831">r</a></span><span class="op" id="4206959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206963">}</span>&nbsp;<span class="keyword" id="4206965">else</span>&nbsp;<span class="op" id="4206970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206975"><a href="/gostd/net/http/server.go.html#4206151">NotFound</a></span><span class="op" id="4206983">(</span><span class="ident" id="4206984"><a href="/gostd/net/http/server.go.html#4206813">w</a></span><span class="op" id="4206985">,</span>&nbsp;<span class="ident" id="4206987"><a href="/gostd/net/http/server.go.html#4206831">r</a></span><span class="op" id="4206988">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206995">}</span><span class="op" id="4206996">)</span><br>
<span class="lineno"></span><span class="op" id="4206998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4207001">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="4207060">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4207113">func</span>&nbsp;<span class="ident" id="4207118">Redirect</span><span class="op" id="4207126">(</span><span class="ident" id="4207127">w</span>&nbsp;<span class="ident" id="4207129"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4207143">,</span>&nbsp;<span class="ident" id="4207145">r</span>&nbsp;<span class="op" id="4207147">*</span><span class="ident" id="4207148"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4207155">,</span>&nbsp;<span class="ident" id="4207157">urlStr</span>&nbsp;<span class="builtintype" id="4207164">string</span><span class="op" id="4207170">,</span>&nbsp;<span class="ident" id="4207172">code</span>&nbsp;<span class="builtintype" id="4207177">int</span><span class="op" id="4207180">)</span>&nbsp;<span class="op" id="4207182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207185">if</span>&nbsp;<span class="ident" id="4207188">u</span><span class="op" id="4207189">,</span>&nbsp;<span class="ident" id="4207191">err</span>&nbsp;<span class="op" id="4207195">:=</span>&nbsp;<span class="ident" id="4207198"><a href="/gostd/net/http/server.go.html#4169353">url</a></span><span class="op" id="4207201">.</span><span class="ident" id="4207202"><a href="/gostd/net/url/url.go.html#3754169">Parse</a></span><span class="op" id="4207207">(</span><span class="ident" id="4207208"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4207214">)</span><span class="op" id="4207215">;</span>&nbsp;<span class="ident" id="4207217"><a href="/gostd/net/http/server.go.html#4207191">err</a></span>&nbsp;<span class="op" id="4207221">==</span>&nbsp;<span class="builtintype" id="4207224">nil</span>&nbsp;<span class="op" id="4207228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207232">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207275">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207309">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207357">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207404">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207452">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207492">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207532">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207567">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207609">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207654">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207702">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207749">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207801">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207854">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207869">oldpath</span>&nbsp;<span class="op" id="4207877">:=</span>&nbsp;<span class="ident" id="4207880"><a href="/gostd/net/http/server.go.html#4207145">r</a></span><span class="op" id="4207881">.</span><span class="ident" id="4207882"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4207885">.</span><span class="ident" id="4207886"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207893">if</span>&nbsp;<span class="ident" id="4207896"><a href="/gostd/net/http/server.go.html#4207869">oldpath</a></span>&nbsp;<span class="op" id="4207904">==</span>&nbsp;<span class="string" id="4207907">&#34;&#34;</span>&nbsp;<span class="op" id="4207910">{</span>&nbsp;<span class="comment" id="4207912">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207966"><a href="/gostd/net/http/server.go.html#4207869">oldpath</a></span>&nbsp;<span class="op" id="4207974">=</span>&nbsp;<span class="string" id="4207976">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207986">if</span>&nbsp;<span class="ident" id="4207989"><a href="/gostd/net/http/server.go.html#4207188">u</a></span><span class="op" id="4207990">.</span><span class="ident" id="4207991"><a href="/gostd/net/url/url.go.html#3751208">Scheme</a></span>&nbsp;<span class="op" id="4207998">==</span>&nbsp;<span class="string" id="4208001">&#34;&#34;</span>&nbsp;<span class="op" id="4208004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208009">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208040">if</span>&nbsp;<span class="ident" id="4208043"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span>&nbsp;<span class="op" id="4208050">==</span>&nbsp;<span class="string" id="4208053">&#34;&#34;</span>&nbsp;<span class="op" id="4208056">||</span>&nbsp;<span class="ident" id="4208059"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208065">[</span><span class="num" id="4208066">0</span><span class="op" id="4208067">]</span>&nbsp;<span class="op" id="4208069">!=</span>&nbsp;<span class="string" id="4208072">&#39;/&#39;</span>&nbsp;<span class="op" id="4208076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208082">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208117">olddir</span><span class="op" id="4208123">,</span>&nbsp;<span class="ident" id="4208125">_</span>&nbsp;<span class="op" id="4208127">:=</span>&nbsp;<span class="ident" id="4208130"><a href="/gostd/net/http/server.go.html#4169370">path</a></span><span class="op" id="4208134">.</span><span class="ident" id="4208135"><a href="/gostd/path/path.go.html#3923666">Split</a></span><span class="op" id="4208140">(</span><span class="ident" id="4208141"><a href="/gostd/net/http/server.go.html#4207869">oldpath</a></span><span class="op" id="4208148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208154"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span>&nbsp;<span class="op" id="4208161">=</span>&nbsp;<span class="ident" id="4208163"><a href="/gostd/net/http/server.go.html#4208117">olddir</a></span>&nbsp;<span class="op" id="4208170">+</span>&nbsp;<span class="ident" id="4208172"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208182">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208188">var</span>&nbsp;<span class="ident" id="4208192">query</span>&nbsp;<span class="builtintype" id="4208198">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208208">if</span>&nbsp;<span class="ident" id="4208211">i</span>&nbsp;<span class="op" id="4208213">:=</span>&nbsp;<span class="ident" id="4208216"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4208223">.</span><span class="ident" id="4208224"><a href="/gostd/strings/strings.go.html#2968883">Index</a></span><span class="op" id="4208229">(</span><span class="ident" id="4208230"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208236">,</span>&nbsp;<span class="string" id="4208238">&#34;?&#34;</span><span class="op" id="4208241">)</span><span class="op" id="4208242">;</span>&nbsp;<span class="ident" id="4208244"><a href="/gostd/net/http/server.go.html#4208211">i</a></span>&nbsp;<span class="op" id="4208246">!=</span>&nbsp;<span class="op" id="4208249">-</span><span class="num" id="4208250">1</span>&nbsp;<span class="op" id="4208252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208258"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208264">,</span>&nbsp;<span class="ident" id="4208266"><a href="/gostd/net/http/server.go.html#4208192">query</a></span>&nbsp;<span class="op" id="4208272">=</span>&nbsp;<span class="ident" id="4208274"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208280">[</span><span class="op" id="4208281">:</span><span class="ident" id="4208282"><a href="/gostd/net/http/server.go.html#4208211">i</a></span><span class="op" id="4208283">]</span><span class="op" id="4208284">,</span>&nbsp;<span class="ident" id="4208286"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208292">[</span><span class="ident" id="4208293"><a href="/gostd/net/http/server.go.html#4208211">i</a></span><span class="op" id="4208294">:</span><span class="op" id="4208295">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208300">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208306">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208349">trailing</span>&nbsp;<span class="op" id="4208358">:=</span>&nbsp;<span class="ident" id="4208361"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4208368">.</span><span class="ident" id="4208369"><a href="/gostd/strings/strings.go.html#2975527">HasSuffix</a></span><span class="op" id="4208378">(</span><span class="ident" id="4208379"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208385">,</span>&nbsp;<span class="string" id="4208387">&#34;/&#34;</span><span class="op" id="4208390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208395"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span>&nbsp;<span class="op" id="4208402">=</span>&nbsp;<span class="ident" id="4208404"><a href="/gostd/net/http/server.go.html#4169370">path</a></span><span class="op" id="4208408">.</span><span class="ident" id="4208409"><a href="/gostd/path/path.go.html#3922001">Clean</a></span><span class="op" id="4208414">(</span><span class="ident" id="4208415"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208426">if</span>&nbsp;<span class="ident" id="4208429"><a href="/gostd/net/http/server.go.html#4208349">trailing</a></span>&nbsp;<span class="op" id="4208438">&amp;&amp;</span>&nbsp;<span class="op" id="4208441">!</span><span class="ident" id="4208442"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4208449">.</span><span class="ident" id="4208450"><a href="/gostd/strings/strings.go.html#2975527">HasSuffix</a></span><span class="op" id="4208459">(</span><span class="ident" id="4208460"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208466">,</span>&nbsp;<span class="string" id="4208468">&#34;/&#34;</span><span class="op" id="4208471">)</span>&nbsp;<span class="op" id="4208473">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208479"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span>&nbsp;<span class="op" id="4208486">+=</span>&nbsp;<span class="string" id="4208489">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208501"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span>&nbsp;<span class="op" id="4208508">+=</span>&nbsp;<span class="ident" id="4208511"><a href="/gostd/net/http/server.go.html#4208192">query</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208522">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208526"><a href="/gostd/net/http/server.go.html#4207127">w</a></span><span class="op" id="4208527">.</span><span class="ident" id="4208528"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="4208534">(</span><span class="op" id="4208535">)</span><span class="op" id="4208536">.</span><span class="ident" id="4208537"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4208540">(</span><span class="string" id="4208541">&#34;Location&#34;</span><span class="op" id="4208551">,</span>&nbsp;<span class="ident" id="4208553"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208562"><a href="/gostd/net/http/server.go.html#4207127">w</a></span><span class="op" id="4208563">.</span><span class="ident" id="4208564"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="4208575">(</span><span class="ident" id="4208576"><a href="/gostd/net/http/server.go.html#4207172">code</a></span><span class="op" id="4208580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208584">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208653">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208720">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208787">if</span>&nbsp;<span class="ident" id="4208790"><a href="/gostd/net/http/server.go.html#4207145">r</a></span><span class="op" id="4208791">.</span><span class="ident" id="4208792"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4208799">==</span>&nbsp;<span class="string" id="4208802">&#34;GET&#34;</span>&nbsp;<span class="op" id="4208808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208812">note</span>&nbsp;<span class="op" id="4208817">:=</span>&nbsp;<span class="string" id="4208820">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="4208833">+</span>&nbsp;<span class="ident" id="4208835"><a href="/gostd/net/http/server.go.html#4209157">htmlEscape</a></span><span class="op" id="4208845">(</span><span class="ident" id="4208846"><a href="/gostd/net/http/server.go.html#4207157">urlStr</a></span><span class="op" id="4208852">)</span>&nbsp;<span class="op" id="4208854">+</span>&nbsp;<span class="string" id="4208856">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="4208862">+</span>&nbsp;<span class="ident" id="4208864"><a href="/gostd/net/http/status.go.html#4237998">statusText</a></span><span class="op" id="4208874">[</span><span class="ident" id="4208875"><a href="/gostd/net/http/server.go.html#4207172">code</a></span><span class="op" id="4208879">]</span>&nbsp;<span class="op" id="4208881">+</span>&nbsp;<span class="string" id="4208883">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208895"><a href="/gostd/net/http/server.go.html#4169313">fmt</a></span><span class="op" id="4208898">.</span><span class="ident" id="4208899"><a href="/gostd/fmt/print.go.html#2145376">Fprintln</a></span><span class="op" id="4208907">(</span><span class="ident" id="4208908"><a href="/gostd/net/http/server.go.html#4207127">w</a></span><span class="op" id="4208909">,</span>&nbsp;<span class="ident" id="4208911"><a href="/gostd/net/http/server.go.html#4208812">note</a></span><span class="op" id="4208915">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208918">}</span><br>
<span class="lineno"></span><span class="op" id="4208920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4208923">var</span>&nbsp;<span class="ident" id="4208927">htmlReplacer</span>&nbsp;<span class="op" id="4208940">=</span>&nbsp;<span class="ident" id="4208942"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4208949">.</span><span class="ident" id="4208950"><a href="/gostd/strings/replace.go.html#2949056">NewReplacer</a></span><span class="op" id="4208961">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208964">&#34;&amp;&#34;</span><span class="op" id="4208967">,</span>&nbsp;<span class="string" id="4208969">&#34;&amp;amp;&#34;</span><span class="op" id="4208976">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208979">&#34;&lt;&#34;</span><span class="op" id="4208982">,</span>&nbsp;<span class="string" id="4208984">&#34;&amp;lt;&#34;</span><span class="op" id="4208990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208993">&#34;&gt;&#34;</span><span class="op" id="4208996">,</span>&nbsp;<span class="string" id="4208998">&#34;&amp;gt;&#34;</span><span class="op" id="4209004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209007">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4209045">`&#34;`</span><span class="op" id="4209048">,</span>&nbsp;<span class="string" id="4209050">&#34;&amp;#34;&#34;</span><span class="op" id="4209057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209060">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4209135">&#34;&#39;&#34;</span><span class="op" id="4209138">,</span>&nbsp;<span class="string" id="4209140">&#34;&amp;#39;&#34;</span><span class="op" id="4209147">,</span><br>
<span class="lineno"></span><span class="op" id="4209149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209152">func</span>&nbsp;<span class="ident" id="4209157">htmlEscape</span><span class="op" id="4209167">(</span><span class="ident" id="4209168">s</span>&nbsp;<span class="builtintype" id="4209170">string</span><span class="op" id="4209176">)</span>&nbsp;<span class="builtintype" id="4209178">string</span>&nbsp;<span class="op" id="4209185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209188">return</span>&nbsp;<span class="ident" id="4209195"><a href="/gostd/net/http/server.go.html#4208927">htmlReplacer</a></span><span class="op" id="4209207">.</span><span class="ident" id="4209208"><a href="/gostd/strings/replace.go.html#2950171">Replace</a></span><span class="op" id="4209215">(</span><span class="ident" id="4209216"><a href="/gostd/net/http/server.go.html#4209168">s</a></span><span class="op" id="4209217">)</span><br>
<span class="lineno">1375</span><span class="op" id="4209219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4209222">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="4209249">type</span>&nbsp;<span class="ident" id="4209254">redirectHandler</span>&nbsp;<span class="keyword" id="4209270">struct</span>&nbsp;<span class="op" id="4209277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209280">url</span>&nbsp;&nbsp;<span class="builtintype" id="4209285">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209293">code</span>&nbsp;<span class="builtintype" id="4209298">int</span><br>
<span class="lineno"></span><span class="op" id="4209302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209305">func</span>&nbsp;<span class="op" id="4209310">(</span><span class="ident" id="4209311">rh</span>&nbsp;<span class="op" id="4209314">*</span><span class="ident" id="4209315"><a href="/gostd/net/http/server.go.html#4209254">redirectHandler</a></span><span class="op" id="4209330">)</span>&nbsp;<span class="ident" id="4209332">ServeHTTP</span><span class="op" id="4209341">(</span><span class="ident" id="4209342">w</span>&nbsp;<span class="ident" id="4209344"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4209358">,</span>&nbsp;<span class="ident" id="4209360">r</span>&nbsp;<span class="op" id="4209362">*</span><span class="ident" id="4209363"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4209370">)</span>&nbsp;<span class="op" id="4209372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209375"><a href="/gostd/net/http/server.go.html#4207118">Redirect</a></span><span class="op" id="4209383">(</span><span class="ident" id="4209384"><a href="/gostd/net/http/server.go.html#4209342">w</a></span><span class="op" id="4209385">,</span>&nbsp;<span class="ident" id="4209387"><a href="/gostd/net/http/server.go.html#4209360">r</a></span><span class="op" id="4209388">,</span>&nbsp;<span class="ident" id="4209390"><a href="/gostd/net/http/server.go.html#4209311">rh</a></span><span class="op" id="4209392">.</span><span class="ident" id="4209393"><a href="/gostd/net/http/server.go.html#4209280">url</a></span><span class="op" id="4209396">,</span>&nbsp;<span class="ident" id="4209398"><a href="/gostd/net/http/server.go.html#4209311">rh</a></span><span class="op" id="4209400">.</span><span class="ident" id="4209401"><a href="/gostd/net/http/server.go.html#4209293">code</a></span><span class="op" id="4209405">)</span><br>
<span class="lineno">1385</span><span class="op" id="4209407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4209410">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="4209470">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="4209531">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="4209547">func</span>&nbsp;<span class="ident" id="4209552">RedirectHandler</span><span class="op" id="4209567">(</span><span class="ident" id="4209568">url</span>&nbsp;<span class="builtintype" id="4209572">string</span><span class="op" id="4209578">,</span>&nbsp;<span class="ident" id="4209580">code</span>&nbsp;<span class="builtintype" id="4209585">int</span><span class="op" id="4209588">)</span>&nbsp;<span class="ident" id="4209590"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span>&nbsp;<span class="op" id="4209598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209601">return</span>&nbsp;<span class="op" id="4209608">&amp;</span><span class="ident" id="4209609"><a href="/gostd/net/http/server.go.html#4209254">redirectHandler</a></span><span class="op" id="4209624">{</span><span class="ident" id="4209625"><a href="/gostd/net/http/server.go.html#4209568">url</a></span><span class="op" id="4209628">,</span>&nbsp;<span class="ident" id="4209630"><a href="/gostd/net/http/server.go.html#4209580">code</a></span><span class="op" id="4209634">}</span><br>
<span class="lineno"></span><span class="op" id="4209636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4209639">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="4209683">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="4209759">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4209814">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="4209847">//</span><br>
<span class="lineno"></span><span class="comment" id="4209850">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="4209909">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="4209975">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4210037">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4210093">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4210150">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="4210210">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4210269">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="4210292">//</span><br>
<span class="lineno"></span><span class="comment" id="4210295">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="4210366">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="4210435">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4210483">//</span><br>
<span class="lineno"></span><span class="comment" id="4210486">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4210560">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4210632">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="4210707">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4210778">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4210820">//</span><br>
<span class="lineno"></span><span class="comment" id="4210823">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="4210887">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="4210948">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4210982">type</span>&nbsp;<span class="ident" id="4210987">ServeMux</span>&nbsp;<span class="keyword" id="4210996">struct</span>&nbsp;<span class="op" id="4211003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211006">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211012"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4211016">.</span><span class="ident" id="4211017"><a href="/gostd/sync/rwmutex.go.html#1456076">RWMutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211026">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211032">map</span><span class="op" id="4211035">[</span><span class="builtintype" id="4211036">string</span><span class="op" id="4211042">]</span><span class="ident" id="4211043"><a href="/gostd/net/http/server.go.html#4211114">muxEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211053">hosts</span>&nbsp;<span class="builtintype" id="4211059">bool</span>&nbsp;<span class="comment" id="4211064">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="4211106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4211109">type</span>&nbsp;<span class="ident" id="4211114">muxEntry</span>&nbsp;<span class="keyword" id="4211123">struct</span>&nbsp;<span class="op" id="4211130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211133">explicit</span>&nbsp;<span class="builtintype" id="4211142">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211148">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211157"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211166">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="4211175">string</span><br>
<span class="lineno"></span><span class="op" id="4211182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211185">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4211238">func</span>&nbsp;<span class="ident" id="4211243">NewServeMux</span><span class="op" id="4211254">(</span><span class="op" id="4211255">)</span>&nbsp;<span class="op" id="4211257">*</span><span class="ident" id="4211258"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span>&nbsp;<span class="op" id="4211267">{</span>&nbsp;<span class="keyword" id="4211269">return</span>&nbsp;<span class="op" id="4211276">&amp;</span><span class="ident" id="4211277"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4211285">{</span><span class="ident" id="4211286"><a href="/gostd/net/http/server.go.html#4211026">m</a></span><span class="op" id="4211287">:</span>&nbsp;<span class="builtinfunc" id="4211289">make</span><span class="op" id="4211293">(</span><span class="keyword" id="4211294">map</span><span class="op" id="4211297">[</span><span class="builtintype" id="4211298">string</span><span class="op" id="4211304">]</span><span class="ident" id="4211305"><a href="/gostd/net/http/server.go.html#4211114">muxEntry</a></span><span class="op" id="4211313">)</span><span class="op" id="4211314">}</span>&nbsp;<span class="op" id="4211316">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="4211319">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="4211377">var</span>&nbsp;<span class="ident" id="4211381">DefaultServeMux</span>&nbsp;<span class="op" id="4211397">=</span>&nbsp;<span class="ident" id="4211399"><a href="/gostd/net/http/server.go.html#4211243">NewServeMux</a></span><span class="op" id="4211410">(</span><span class="op" id="4211411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211414">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="4211442">func</span>&nbsp;<span class="ident" id="4211447">pathMatch</span><span class="op" id="4211456">(</span><span class="ident" id="4211457">pattern</span><span class="op" id="4211464">,</span>&nbsp;<span class="ident" id="4211466">path</span>&nbsp;<span class="builtintype" id="4211471">string</span><span class="op" id="4211477">)</span>&nbsp;<span class="builtintype" id="4211479">bool</span>&nbsp;<span class="op" id="4211484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211487">if</span>&nbsp;<span class="builtinfunc" id="4211490">len</span><span class="op" id="4211493">(</span><span class="ident" id="4211494"><a href="/gostd/net/http/server.go.html#4211457">pattern</a></span><span class="op" id="4211501">)</span>&nbsp;<span class="op" id="4211503">==</span>&nbsp;<span class="num" id="4211506">0</span>&nbsp;<span class="op" id="4211508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211512">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211535">return</span>&nbsp;<span class="builtintype" id="4211542">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211549">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211552">n</span>&nbsp;<span class="op" id="4211554">:=</span>&nbsp;<span class="builtinfunc" id="4211557">len</span><span class="op" id="4211560">(</span><span class="ident" id="4211561"><a href="/gostd/net/http/server.go.html#4211457">pattern</a></span><span class="op" id="4211568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211571">if</span>&nbsp;<span class="ident" id="4211574"><a href="/gostd/net/http/server.go.html#4211457">pattern</a></span><span class="op" id="4211581">[</span><span class="ident" id="4211582"><a href="/gostd/net/http/server.go.html#4211552">n</a></span><span class="op" id="4211583">-</span><span class="num" id="4211584">1</span><span class="op" id="4211585">]</span>&nbsp;<span class="op" id="4211587">!=</span>&nbsp;<span class="string" id="4211590">&#39;/&#39;</span>&nbsp;<span class="op" id="4211594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211598">return</span>&nbsp;<span class="ident" id="4211605"><a href="/gostd/net/http/server.go.html#4211457">pattern</a></span>&nbsp;<span class="op" id="4211613">==</span>&nbsp;<span class="ident" id="4211616"><a href="/gostd/net/http/server.go.html#4211466">path</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211625">return</span>&nbsp;<span class="builtinfunc" id="4211632">len</span><span class="op" id="4211635">(</span><span class="ident" id="4211636"><a href="/gostd/net/http/server.go.html#4211466">path</a></span><span class="op" id="4211640">)</span>&nbsp;<span class="op" id="4211642">&gt;=</span>&nbsp;<span class="ident" id="4211645"><a href="/gostd/net/http/server.go.html#4211552">n</a></span>&nbsp;<span class="op" id="4211647">&amp;&amp;</span>&nbsp;<span class="ident" id="4211650"><a href="/gostd/net/http/server.go.html#4211466">path</a></span><span class="op" id="4211654">[</span><span class="num" id="4211655">0</span><span class="op" id="4211656">:</span><span class="ident" id="4211657"><a href="/gostd/net/http/server.go.html#4211552">n</a></span><span class="op" id="4211658">]</span>&nbsp;<span class="op" id="4211660">==</span>&nbsp;<span class="ident" id="4211663"><a href="/gostd/net/http/server.go.html#4211457">pattern</a></span><br>
<span class="lineno">1450</span><span class="op" id="4211671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211674">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="4211741">func</span>&nbsp;<span class="ident" id="4211746">cleanPath</span><span class="op" id="4211755">(</span><span class="ident" id="4211756">p</span>&nbsp;<span class="builtintype" id="4211758">string</span><span class="op" id="4211764">)</span>&nbsp;<span class="builtintype" id="4211766">string</span>&nbsp;<span class="op" id="4211773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211776">if</span>&nbsp;<span class="ident" id="4211779"><a href="/gostd/net/http/server.go.html#4211756">p</a></span>&nbsp;<span class="op" id="4211781">==</span>&nbsp;<span class="string" id="4211784">&#34;&#34;</span>&nbsp;<span class="op" id="4211787">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211791">return</span>&nbsp;<span class="string" id="4211798">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211806">if</span>&nbsp;<span class="ident" id="4211809"><a href="/gostd/net/http/server.go.html#4211756">p</a></span><span class="op" id="4211810">[</span><span class="num" id="4211811">0</span><span class="op" id="4211812">]</span>&nbsp;<span class="op" id="4211814">!=</span>&nbsp;<span class="string" id="4211817">&#39;/&#39;</span>&nbsp;<span class="op" id="4211821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211825"><a href="/gostd/net/http/server.go.html#4211756">p</a></span>&nbsp;<span class="op" id="4211827">=</span>&nbsp;<span class="string" id="4211829">&#34;/&#34;</span>&nbsp;<span class="op" id="4211833">+</span>&nbsp;<span class="ident" id="4211835"><a href="/gostd/net/http/server.go.html#4211756">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211838">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211841">np</span>&nbsp;<span class="op" id="4211844">:=</span>&nbsp;<span class="ident" id="4211847"><a href="/gostd/net/http/server.go.html#4169370">path</a></span><span class="op" id="4211851">.</span><span class="ident" id="4211852"><a href="/gostd/path/path.go.html#3922001">Clean</a></span><span class="op" id="4211857">(</span><span class="ident" id="4211858"><a href="/gostd/net/http/server.go.html#4211756">p</a></span><span class="op" id="4211859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211862">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211917">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211963">if</span>&nbsp;<span class="ident" id="4211966"><a href="/gostd/net/http/server.go.html#4211756">p</a></span><span class="op" id="4211967">[</span><span class="builtinfunc" id="4211968">len</span><span class="op" id="4211971">(</span><span class="ident" id="4211972"><a href="/gostd/net/http/server.go.html#4211756">p</a></span><span class="op" id="4211973">)</span><span class="op" id="4211974">-</span><span class="num" id="4211975">1</span><span class="op" id="4211976">]</span>&nbsp;<span class="op" id="4211978">==</span>&nbsp;<span class="string" id="4211981">&#39;/&#39;</span>&nbsp;<span class="op" id="4211985">&amp;&amp;</span>&nbsp;<span class="ident" id="4211988"><a href="/gostd/net/http/server.go.html#4211841">np</a></span>&nbsp;<span class="op" id="4211991">!=</span>&nbsp;<span class="string" id="4211994">&#34;/&#34;</span>&nbsp;<span class="op" id="4211998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212002"><a href="/gostd/net/http/server.go.html#4211841">np</a></span>&nbsp;<span class="op" id="4212005">+=</span>&nbsp;<span class="string" id="4212008">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212016">return</span>&nbsp;<span class="ident" id="4212023"><a href="/gostd/net/http/server.go.html#4211841">np</a></span><br>
<span class="lineno"></span><span class="op" id="4212026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4212029">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="4212084">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="4212124">func</span>&nbsp;<span class="op" id="4212129">(</span><span class="ident" id="4212130">mux</span>&nbsp;<span class="op" id="4212134">*</span><span class="ident" id="4212135"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4212143">)</span>&nbsp;<span class="ident" id="4212145">match</span><span class="op" id="4212150">(</span><span class="ident" id="4212151">path</span>&nbsp;<span class="builtintype" id="4212156">string</span><span class="op" id="4212162">)</span>&nbsp;<span class="op" id="4212164">(</span><span class="ident" id="4212165">h</span>&nbsp;<span class="ident" id="4212167"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4212174">,</span>&nbsp;<span class="ident" id="4212176">pattern</span>&nbsp;<span class="builtintype" id="4212184">string</span><span class="op" id="4212190">)</span>&nbsp;<span class="op" id="4212192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212195">var</span>&nbsp;<span class="ident" id="4212199">n</span>&nbsp;<span class="op" id="4212201">=</span>&nbsp;<span class="num" id="4212203">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212206">for</span>&nbsp;<span class="ident" id="4212210">k</span><span class="op" id="4212211">,</span>&nbsp;<span class="ident" id="4212213">v</span>&nbsp;<span class="op" id="4212215">:=</span>&nbsp;<span class="keyword" id="4212218">range</span>&nbsp;<span class="ident" id="4212224"><a href="/gostd/net/http/server.go.html#4212130">mux</a></span><span class="op" id="4212227">.</span><span class="ident" id="4212228"><a href="/gostd/net/http/server.go.html#4211026">m</a></span>&nbsp;<span class="op" id="4212230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212234">if</span>&nbsp;<span class="op" id="4212237">!</span><span class="ident" id="4212238"><a href="/gostd/net/http/server.go.html#4211447">pathMatch</a></span><span class="op" id="4212247">(</span><span class="ident" id="4212248"><a href="/gostd/net/http/server.go.html#4212210">k</a></span><span class="op" id="4212249">,</span>&nbsp;<span class="ident" id="4212251"><a href="/gostd/net/http/server.go.html#4212151">path</a></span><span class="op" id="4212255">)</span>&nbsp;<span class="op" id="4212257">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212262">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212277">if</span>&nbsp;<span class="ident" id="4212280"><a href="/gostd/net/http/server.go.html#4212165">h</a></span>&nbsp;<span class="op" id="4212282">==</span>&nbsp;<span class="builtintype" id="4212285">nil</span>&nbsp;<span class="op" id="4212289">||</span>&nbsp;<span class="builtinfunc" id="4212292">len</span><span class="op" id="4212295">(</span><span class="ident" id="4212296"><a href="/gostd/net/http/server.go.html#4212210">k</a></span><span class="op" id="4212297">)</span>&nbsp;<span class="op" id="4212299">&gt;</span>&nbsp;<span class="ident" id="4212301"><a href="/gostd/net/http/server.go.html#4212199">n</a></span>&nbsp;<span class="op" id="4212303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212308"><a href="/gostd/net/http/server.go.html#4212199">n</a></span>&nbsp;<span class="op" id="4212310">=</span>&nbsp;<span class="builtinfunc" id="4212312">len</span><span class="op" id="4212315">(</span><span class="ident" id="4212316"><a href="/gostd/net/http/server.go.html#4212210">k</a></span><span class="op" id="4212317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212322"><a href="/gostd/net/http/server.go.html#4212165">h</a></span>&nbsp;<span class="op" id="4212324">=</span>&nbsp;<span class="ident" id="4212326"><a href="/gostd/net/http/server.go.html#4212213">v</a></span><span class="op" id="4212327">.</span><span class="ident" id="4212328"><a href="/gostd/net/http/server.go.html#4211148">h</a></span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212333"><a href="/gostd/net/http/server.go.html#4212176">pattern</a></span>&nbsp;<span class="op" id="4212341">=</span>&nbsp;<span class="ident" id="4212343"><a href="/gostd/net/http/server.go.html#4212213">v</a></span><span class="op" id="4212344">.</span><span class="ident" id="4212345"><a href="/gostd/net/http/server.go.html#4211166">pattern</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212361">return</span><br>
<span class="lineno"></span><span class="op" id="4212368">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="4212371">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4212432">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4212498">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4212566">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="4212632">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="4212658">//</span><br>
<span class="lineno"></span><span class="comment" id="4212661">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4212725">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="4212787">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="4212848">//</span><br>
<span class="lineno"></span><span class="comment" id="4212851">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4212917">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4212987">func</span>&nbsp;<span class="op" id="4212992">(</span><span class="ident" id="4212993">mux</span>&nbsp;<span class="op" id="4212997">*</span><span class="ident" id="4212998"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4213006">)</span>&nbsp;<span class="ident" id="4213008">Handler</span><span class="op" id="4213015">(</span><span class="ident" id="4213016">r</span>&nbsp;<span class="op" id="4213018">*</span><span class="ident" id="4213019"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4213026">)</span>&nbsp;<span class="op" id="4213028">(</span><span class="ident" id="4213029">h</span>&nbsp;<span class="ident" id="4213031"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4213038">,</span>&nbsp;<span class="ident" id="4213040">pattern</span>&nbsp;<span class="builtintype" id="4213048">string</span><span class="op" id="4213054">)</span>&nbsp;<span class="op" id="4213056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213059">if</span>&nbsp;<span class="ident" id="4213062"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213063">.</span><span class="ident" id="4213064"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4213071">!=</span>&nbsp;<span class="string" id="4213074">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4213084">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213088">if</span>&nbsp;<span class="ident" id="4213091">p</span>&nbsp;<span class="op" id="4213093">:=</span>&nbsp;<span class="ident" id="4213096"><a href="/gostd/net/http/server.go.html#4211746">cleanPath</a></span><span class="op" id="4213105">(</span><span class="ident" id="4213106"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213107">.</span><span class="ident" id="4213108"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4213111">.</span><span class="ident" id="4213112"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="4213116">)</span><span class="op" id="4213117">;</span>&nbsp;<span class="ident" id="4213119"><a href="/gostd/net/http/server.go.html#4213091">p</a></span>&nbsp;<span class="op" id="4213121">!=</span>&nbsp;<span class="ident" id="4213124"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213125">.</span><span class="ident" id="4213126"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4213129">.</span><span class="ident" id="4213130"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span>&nbsp;<span class="op" id="4213135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213140">_</span><span class="op" id="4213141">,</span>&nbsp;<span class="ident" id="4213143"><a href="/gostd/net/http/server.go.html#4213040">pattern</a></span>&nbsp;<span class="op" id="4213151">=</span>&nbsp;<span class="ident" id="4213153"><a href="/gostd/net/http/server.go.html#4212993">mux</a></span><span class="op" id="4213156">.</span><span class="ident" id="4213157"><a href="/gostd/net/http/server.go.html#4213478">handler</a></span><span class="op" id="4213164">(</span><span class="ident" id="4213165"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213166">.</span><span class="ident" id="4213167"><a href="/gostd/net/http/request.go.html#4139164">Host</a></span><span class="op" id="4213171">,</span>&nbsp;<span class="ident" id="4213173"><a href="/gostd/net/http/server.go.html#4213091">p</a></span><span class="op" id="4213174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213179">url</span>&nbsp;<span class="op" id="4213183">:=</span>&nbsp;<span class="op" id="4213186">*</span><span class="ident" id="4213187"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213188">.</span><span class="ident" id="4213189"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213196"><a href="/gostd/net/http/server.go.html#4213179">url</a></span><span class="op" id="4213199">.</span><span class="ident" id="4213200"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span>&nbsp;<span class="op" id="4213205">=</span>&nbsp;<span class="ident" id="4213207"><a href="/gostd/net/http/server.go.html#4213091">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213212">return</span>&nbsp;<span class="ident" id="4213219"><a href="/gostd/net/http/server.go.html#4209552">RedirectHandler</a></span><span class="op" id="4213234">(</span><span class="ident" id="4213235"><a href="/gostd/net/http/server.go.html#4213179">url</a></span><span class="op" id="4213238">.</span><span class="ident" id="4213239"><a href="/gostd/net/url/url.go.html#3757924">String</a></span><span class="op" id="4213245">(</span><span class="op" id="4213246">)</span><span class="op" id="4213247">,</span>&nbsp;<span class="ident" id="4213249"><a href="/gostd/net/http/status.go.html#4236480">StatusMovedPermanently</a></span><span class="op" id="4213271">)</span><span class="op" id="4213272">,</span>&nbsp;<span class="ident" id="4213274"><a href="/gostd/net/http/server.go.html#4213040">pattern</a></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213291">return</span>&nbsp;<span class="ident" id="4213298"><a href="/gostd/net/http/server.go.html#4212993">mux</a></span><span class="op" id="4213301">.</span><span class="ident" id="4213302"><a href="/gostd/net/http/server.go.html#4213478">handler</a></span><span class="op" id="4213309">(</span><span class="ident" id="4213310"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213311">.</span><span class="ident" id="4213312"><a href="/gostd/net/http/request.go.html#4139164">Host</a></span><span class="op" id="4213316">,</span>&nbsp;<span class="ident" id="4213318"><a href="/gostd/net/http/server.go.html#4213016">r</a></span><span class="op" id="4213319">.</span><span class="ident" id="4213320"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="4213323">.</span><span class="ident" id="4213324"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="4213328">)</span><br>
<span class="lineno"></span><span class="op" id="4213330">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="4213333">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="4213383">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="4213457">func</span>&nbsp;<span class="op" id="4213462">(</span><span class="ident" id="4213463">mux</span>&nbsp;<span class="op" id="4213467">*</span><span class="ident" id="4213468"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4213476">)</span>&nbsp;<span class="ident" id="4213478">handler</span><span class="op" id="4213485">(</span><span class="ident" id="4213486">host</span><span class="op" id="4213490">,</span>&nbsp;<span class="ident" id="4213492">path</span>&nbsp;<span class="builtintype" id="4213497">string</span><span class="op" id="4213503">)</span>&nbsp;<span class="op" id="4213505">(</span><span class="ident" id="4213506">h</span>&nbsp;<span class="ident" id="4213508"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4213515">,</span>&nbsp;<span class="ident" id="4213517">pattern</span>&nbsp;<span class="builtintype" id="4213525">string</span><span class="op" id="4213531">)</span>&nbsp;<span class="op" id="4213533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213536"><a href="/gostd/net/http/server.go.html#4213463">mux</a></span><span class="op" id="4213539">.</span><span class="ident" id="4213540"><a href="/gostd/net/http/server.go.html#4211006">mu</a></span><span class="op" id="4213542">.</span><span class="ident" id="4213543"><a href="/gostd/sync/rwmutex.go.html#1456490">RLock</a></span><span class="op" id="4213548">(</span><span class="op" id="4213549">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213552">defer</span>&nbsp;<span class="ident" id="4213558"><a href="/gostd/net/http/server.go.html#4213463">mux</a></span><span class="op" id="4213561">.</span><span class="ident" id="4213562"><a href="/gostd/net/http/server.go.html#4211006">mu</a></span><span class="op" id="4213564">.</span><span class="ident" id="4213565"><a href="/gostd/sync/rwmutex.go.html#1456952">RUnlock</a></span><span class="op" id="4213572">(</span><span class="op" id="4213573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213577">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213638">if</span>&nbsp;<span class="ident" id="4213641"><a href="/gostd/net/http/server.go.html#4213463">mux</a></span><span class="op" id="4213644">.</span><span class="ident" id="4213645"><a href="/gostd/net/http/server.go.html#4211053">hosts</a></span>&nbsp;<span class="op" id="4213651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213655"><a href="/gostd/net/http/server.go.html#4213506">h</a></span><span class="op" id="4213656">,</span>&nbsp;<span class="ident" id="4213658"><a href="/gostd/net/http/server.go.html#4213517">pattern</a></span>&nbsp;<span class="op" id="4213666">=</span>&nbsp;<span class="ident" id="4213668"><a href="/gostd/net/http/server.go.html#4213463">mux</a></span><span class="op" id="4213671">.</span><span class="ident" id="4213672"><a href="/gostd/net/http/server.go.html#4212145">match</a></span><span class="op" id="4213677">(</span><span class="ident" id="4213678"><a href="/gostd/net/http/server.go.html#4213486">host</a></span>&nbsp;<span class="op" id="4213683">+</span>&nbsp;<span class="ident" id="4213685"><a href="/gostd/net/http/server.go.html#4213492">path</a></span><span class="op" id="4213689">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213695">if</span>&nbsp;<span class="ident" id="4213698"><a href="/gostd/net/http/server.go.html#4213506">h</a></span>&nbsp;<span class="op" id="4213700">==</span>&nbsp;<span class="builtintype" id="4213703">nil</span>&nbsp;<span class="op" id="4213707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213711"><a href="/gostd/net/http/server.go.html#4213506">h</a></span><span class="op" id="4213712">,</span>&nbsp;<span class="ident" id="4213714"><a href="/gostd/net/http/server.go.html#4213517">pattern</a></span>&nbsp;<span class="op" id="4213722">=</span>&nbsp;<span class="ident" id="4213724"><a href="/gostd/net/http/server.go.html#4213463">mux</a></span><span class="op" id="4213727">.</span><span class="ident" id="4213728"><a href="/gostd/net/http/server.go.html#4212145">match</a></span><span class="op" id="4213733">(</span><span class="ident" id="4213734"><a href="/gostd/net/http/server.go.html#4213492">path</a></span><span class="op" id="4213738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213744">if</span>&nbsp;<span class="ident" id="4213747"><a href="/gostd/net/http/server.go.html#4213506">h</a></span>&nbsp;<span class="op" id="4213749">==</span>&nbsp;<span class="builtintype" id="4213752">nil</span>&nbsp;<span class="op" id="4213756">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213760"><a href="/gostd/net/http/server.go.html#4213506">h</a></span><span class="op" id="4213761">,</span>&nbsp;<span class="ident" id="4213763"><a href="/gostd/net/http/server.go.html#4213517">pattern</a></span>&nbsp;<span class="op" id="4213771">=</span>&nbsp;<span class="ident" id="4213773"><a href="/gostd/net/http/server.go.html#4206368">NotFoundHandler</a></span><span class="op" id="4213788">(</span><span class="op" id="4213789">)</span><span class="op" id="4213790">,</span>&nbsp;<span class="string" id="4213792">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213799">return</span><br>
<span class="lineno"></span><span class="op" id="4213806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="4213809">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="4213866">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4213915">func</span>&nbsp;<span class="op" id="4213920">(</span><span class="ident" id="4213921">mux</span>&nbsp;<span class="op" id="4213925">*</span><span class="ident" id="4213926"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4213934">)</span>&nbsp;<span class="ident" id="4213936">ServeHTTP</span><span class="op" id="4213945">(</span><span class="ident" id="4213946">w</span>&nbsp;<span class="ident" id="4213948"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4213962">,</span>&nbsp;<span class="ident" id="4213964">r</span>&nbsp;<span class="op" id="4213966">*</span><span class="ident" id="4213967"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4213974">)</span>&nbsp;<span class="op" id="4213976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213979">if</span>&nbsp;<span class="ident" id="4213982"><a href="/gostd/net/http/server.go.html#4213964">r</a></span><span class="op" id="4213983">.</span><span class="ident" id="4213984"><a href="/gostd/net/http/request.go.html#4141462">RequestURI</a></span>&nbsp;<span class="op" id="4213995">==</span>&nbsp;<span class="string" id="4213998">&#34;*&#34;</span>&nbsp;<span class="op" id="4214002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214006">if</span>&nbsp;<span class="ident" id="4214009"><a href="/gostd/net/http/server.go.html#4213964">r</a></span><span class="op" id="4214010">.</span><span class="ident" id="4214011"><a href="/gostd/net/http/request.go.html#4142002">ProtoAtLeast</a></span><span class="op" id="4214023">(</span><span class="num" id="4214024">1</span><span class="op" id="4214025">,</span>&nbsp;<span class="num" id="4214027">1</span><span class="op" id="4214028">)</span>&nbsp;<span class="op" id="4214030">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214035"><a href="/gostd/net/http/server.go.html#4213946">w</a></span><span class="op" id="4214036">.</span><span class="ident" id="4214037"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="4214043">(</span><span class="op" id="4214044">)</span><span class="op" id="4214045">.</span><span class="ident" id="4214046"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4214049">(</span><span class="string" id="4214050">&#34;Connection&#34;</span><span class="op" id="4214062">,</span>&nbsp;<span class="string" id="4214064">&#34;close&#34;</span><span class="op" id="4214071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214079"><a href="/gostd/net/http/server.go.html#4213946">w</a></span><span class="op" id="4214080">.</span><span class="ident" id="4214081"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="4214092">(</span><span class="ident" id="4214093"><a href="/gostd/net/http/status.go.html#4236667">StatusBadRequest</a></span><span class="op" id="4214109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214113">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214121">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214124">h</span><span class="op" id="4214125">,</span>&nbsp;<span class="ident" id="4214127">_</span>&nbsp;<span class="op" id="4214129">:=</span>&nbsp;<span class="ident" id="4214132"><a href="/gostd/net/http/server.go.html#4213921">mux</a></span><span class="op" id="4214135">.</span><span class="ident" id="4214136"><a href="/gostd/net/http/server.go.html#4213008">Handler</a></span><span class="op" id="4214143">(</span><span class="ident" id="4214144"><a href="/gostd/net/http/server.go.html#4213964">r</a></span><span class="op" id="4214145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214148"><a href="/gostd/net/http/server.go.html#4214124">h</a></span><span class="op" id="4214149">.</span><span class="ident" id="4214150"><a href="/gostd/net/http/server.go.html#4170434">ServeHTTP</a></span><span class="op" id="4214159">(</span><span class="ident" id="4214160"><a href="/gostd/net/http/server.go.html#4213946">w</a></span><span class="op" id="4214161">,</span>&nbsp;<span class="ident" id="4214163"><a href="/gostd/net/http/server.go.html#4213964">r</a></span><span class="op" id="4214164">)</span><br>
<span class="lineno"></span><span class="op" id="4214166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4214169">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="4214224">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="4214283">func</span>&nbsp;<span class="op" id="4214288">(</span><span class="ident" id="4214289">mux</span>&nbsp;<span class="op" id="4214293">*</span><span class="ident" id="4214294"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4214302">)</span>&nbsp;<span class="ident" id="4214304">Handle</span><span class="op" id="4214310">(</span><span class="ident" id="4214311">pattern</span>&nbsp;<span class="builtintype" id="4214319">string</span><span class="op" id="4214325">,</span>&nbsp;<span class="ident" id="4214327">handler</span>&nbsp;<span class="ident" id="4214335"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4214342">)</span>&nbsp;<span class="op" id="4214344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214347"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214350">.</span><span class="ident" id="4214351"><a href="/gostd/net/http/server.go.html#4211006">mu</a></span><span class="op" id="4214353">.</span><span class="ident" id="4214354"><a href="/gostd/sync/rwmutex.go.html#1457713">Lock</a></span><span class="op" id="4214358">(</span><span class="op" id="4214359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214362">defer</span>&nbsp;<span class="ident" id="4214368"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214371">.</span><span class="ident" id="4214372"><a href="/gostd/net/http/server.go.html#4211006">mu</a></span><span class="op" id="4214374">.</span><span class="ident" id="4214375"><a href="/gostd/sync/rwmutex.go.html#1458554">Unlock</a></span><span class="op" id="4214381">(</span><span class="op" id="4214382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214386">if</span>&nbsp;<span class="ident" id="4214389"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span>&nbsp;<span class="op" id="4214397">==</span>&nbsp;<span class="string" id="4214400">&#34;&#34;</span>&nbsp;<span class="op" id="4214403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214407">panic</span><span class="op" id="4214412">(</span><span class="string" id="4214413">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="4214438">+</span>&nbsp;<span class="ident" id="4214440"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214453">if</span>&nbsp;<span class="ident" id="4214456"><a href="/gostd/net/http/server.go.html#4214327">handler</a></span>&nbsp;<span class="op" id="4214464">==</span>&nbsp;<span class="builtintype" id="4214467">nil</span>&nbsp;<span class="op" id="4214471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214475">panic</span><span class="op" id="4214480">(</span><span class="string" id="4214481">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="4214500">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214506">if</span>&nbsp;<span class="ident" id="4214509"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214512">.</span><span class="ident" id="4214513"><a href="/gostd/net/http/server.go.html#4211026">m</a></span><span class="op" id="4214514">[</span><span class="ident" id="4214515"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214522">]</span><span class="op" id="4214523">.</span><span class="ident" id="4214524"><a href="/gostd/net/http/server.go.html#4211133">explicit</a></span>&nbsp;<span class="op" id="4214533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214537">panic</span><span class="op" id="4214542">(</span><span class="string" id="4214543">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4214579">+</span>&nbsp;<span class="ident" id="4214581"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214595"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214598">.</span><span class="ident" id="4214599"><a href="/gostd/net/http/server.go.html#4211026">m</a></span><span class="op" id="4214600">[</span><span class="ident" id="4214601"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214608">]</span>&nbsp;<span class="op" id="4214610">=</span>&nbsp;<span class="ident" id="4214612"><a href="/gostd/net/http/server.go.html#4211114">muxEntry</a></span><span class="op" id="4214620">{</span><span class="ident" id="4214621"><a href="/gostd/net/http/server.go.html#4211133">explicit</a></span><span class="op" id="4214629">:</span>&nbsp;<span class="builtintype" id="4214631">true</span><span class="op" id="4214635">,</span>&nbsp;<span class="ident" id="4214637"><a href="/gostd/net/http/server.go.html#4211148">h</a></span><span class="op" id="4214638">:</span>&nbsp;<span class="ident" id="4214640"><a href="/gostd/net/http/server.go.html#4214327">handler</a></span><span class="op" id="4214647">,</span>&nbsp;<span class="ident" id="4214649"><a href="/gostd/net/http/server.go.html#4211166">pattern</a></span><span class="op" id="4214656">:</span>&nbsp;<span class="ident" id="4214658"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214669">if</span>&nbsp;<span class="ident" id="4214672"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214679">[</span><span class="num" id="4214680">0</span><span class="op" id="4214681">]</span>&nbsp;<span class="op" id="4214683">!=</span>&nbsp;<span class="string" id="4214686">&#39;/&#39;</span>&nbsp;<span class="op" id="4214690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214694"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214697">.</span><span class="ident" id="4214698"><a href="/gostd/net/http/server.go.html#4211053">hosts</a></span>&nbsp;<span class="op" id="4214704">=</span>&nbsp;<span class="builtintype" id="4214706">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214712">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214716">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214738">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214813">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214867">n</span>&nbsp;<span class="op" id="4214869">:=</span>&nbsp;<span class="builtinfunc" id="4214872">len</span><span class="op" id="4214875">(</span><span class="ident" id="4214876"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214883">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214886">if</span>&nbsp;<span class="ident" id="4214889"><a href="/gostd/net/http/server.go.html#4214867">n</a></span>&nbsp;<span class="op" id="4214891">&gt;</span>&nbsp;<span class="num" id="4214893">0</span>&nbsp;<span class="op" id="4214895">&amp;&amp;</span>&nbsp;<span class="ident" id="4214898"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214905">[</span><span class="ident" id="4214906"><a href="/gostd/net/http/server.go.html#4214867">n</a></span><span class="op" id="4214907">-</span><span class="num" id="4214908">1</span><span class="op" id="4214909">]</span>&nbsp;<span class="op" id="4214911">==</span>&nbsp;<span class="string" id="4214914">&#39;/&#39;</span>&nbsp;<span class="op" id="4214918">&amp;&amp;</span>&nbsp;<span class="op" id="4214921">!</span><span class="ident" id="4214922"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4214925">.</span><span class="ident" id="4214926"><a href="/gostd/net/http/server.go.html#4211026">m</a></span><span class="op" id="4214927">[</span><span class="ident" id="4214928"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4214935">[</span><span class="num" id="4214936">0</span><span class="op" id="4214937">:</span><span class="ident" id="4214938"><a href="/gostd/net/http/server.go.html#4214867">n</a></span><span class="op" id="4214939">-</span><span class="num" id="4214940">1</span><span class="op" id="4214941">]</span><span class="op" id="4214942">]</span><span class="op" id="4214943">.</span><span class="ident" id="4214944"><a href="/gostd/net/http/server.go.html#4211133">explicit</a></span>&nbsp;<span class="op" id="4214953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214957">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215022">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215046">path</span>&nbsp;<span class="op" id="4215051">:=</span>&nbsp;<span class="ident" id="4215054"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215064">if</span>&nbsp;<span class="ident" id="4215067"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4215074">[</span><span class="num" id="4215075">0</span><span class="op" id="4215076">]</span>&nbsp;<span class="op" id="4215078">!=</span>&nbsp;<span class="string" id="4215081">&#39;/&#39;</span>&nbsp;<span class="op" id="4215085">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215090">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215149">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215182"><a href="/gostd/net/http/server.go.html#4215046">path</a></span>&nbsp;<span class="op" id="4215187">=</span>&nbsp;<span class="ident" id="4215189"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4215196">[</span><span class="ident" id="4215197"><a href="/gostd/net/http/server.go.html#4169400">strings</a></span><span class="op" id="4215204">.</span><span class="ident" id="4215205"><a href="/gostd/strings/strings.go.html#2968883">Index</a></span><span class="op" id="4215210">(</span><span class="ident" id="4215211"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4215218">,</span>&nbsp;<span class="string" id="4215220">&#34;/&#34;</span><span class="op" id="4215223">)</span><span class="op" id="4215224">:</span><span class="op" id="4215225">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215233"><a href="/gostd/net/http/server.go.html#4214289">mux</a></span><span class="op" id="4215236">.</span><span class="ident" id="4215237"><a href="/gostd/net/http/server.go.html#4211026">m</a></span><span class="op" id="4215238">[</span><span class="ident" id="4215239"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4215246">[</span><span class="num" id="4215247">0</span><span class="op" id="4215248">:</span><span class="ident" id="4215249"><a href="/gostd/net/http/server.go.html#4214867">n</a></span><span class="op" id="4215250">-</span><span class="num" id="4215251">1</span><span class="op" id="4215252">]</span><span class="op" id="4215253">]</span>&nbsp;<span class="op" id="4215255">=</span>&nbsp;<span class="ident" id="4215257"><a href="/gostd/net/http/server.go.html#4211114">muxEntry</a></span><span class="op" id="4215265">{</span><span class="ident" id="4215266"><a href="/gostd/net/http/server.go.html#4211148">h</a></span><span class="op" id="4215267">:</span>&nbsp;<span class="ident" id="4215269"><a href="/gostd/net/http/server.go.html#4209552">RedirectHandler</a></span><span class="op" id="4215284">(</span><span class="ident" id="4215285"><a href="/gostd/net/http/server.go.html#4215046">path</a></span><span class="op" id="4215289">,</span>&nbsp;<span class="ident" id="4215291"><a href="/gostd/net/http/status.go.html#4236480">StatusMovedPermanently</a></span><span class="op" id="4215313">)</span><span class="op" id="4215314">,</span>&nbsp;<span class="ident" id="4215316"><a href="/gostd/net/http/server.go.html#4211166">pattern</a></span><span class="op" id="4215323">:</span>&nbsp;<span class="ident" id="4215325"><a href="/gostd/net/http/server.go.html#4214311">pattern</a></span><span class="op" id="4215332">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215335">}</span><br>
<span class="lineno"></span><span class="op" id="4215337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215340">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4215408">func</span>&nbsp;<span class="op" id="4215413">(</span><span class="ident" id="4215414">mux</span>&nbsp;<span class="op" id="4215418">*</span><span class="ident" id="4215419"><a href="/gostd/net/http/server.go.html#4210987">ServeMux</a></span><span class="op" id="4215427">)</span>&nbsp;<span class="ident" id="4215429">HandleFunc</span><span class="op" id="4215439">(</span><span class="ident" id="4215440">pattern</span>&nbsp;<span class="builtintype" id="4215448">string</span><span class="op" id="4215454">,</span>&nbsp;<span class="ident" id="4215456">handler</span>&nbsp;<span class="keyword" id="4215464">func</span><span class="op" id="4215468">(</span><span class="ident" id="4215469"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4215483">,</span>&nbsp;<span class="op" id="4215485">*</span><span class="ident" id="4215486"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4215493">)</span><span class="op" id="4215494">)</span>&nbsp;<span class="op" id="4215496">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215499"><a href="/gostd/net/http/server.go.html#4215414">mux</a></span><span class="op" id="4215502">.</span><span class="ident" id="4215503"><a href="/gostd/net/http/server.go.html#4214304">Handle</a></span><span class="op" id="4215509">(</span><span class="ident" id="4215510"><a href="/gostd/net/http/server.go.html#4215440">pattern</a></span><span class="op" id="4215517">,</span>&nbsp;<span class="ident" id="4215519"><a href="/gostd/net/http/server.go.html#4205623">HandlerFunc</a></span><span class="op" id="4215530">(</span><span class="ident" id="4215531"><a href="/gostd/net/http/server.go.html#4215456">handler</a></span><span class="op" id="4215538">)</span><span class="op" id="4215539">)</span><br>
<span class="lineno"></span><span class="op" id="4215541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215544">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4215598">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="4215625">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4215694">func</span>&nbsp;<span class="ident" id="4215699">Handle</span><span class="op" id="4215705">(</span><span class="ident" id="4215706">pattern</span>&nbsp;<span class="builtintype" id="4215714">string</span><span class="op" id="4215720">,</span>&nbsp;<span class="ident" id="4215722">handler</span>&nbsp;<span class="ident" id="4215730"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4215737">)</span>&nbsp;<span class="op" id="4215739">{</span>&nbsp;<span class="ident" id="4215741"><a href="/gostd/net/http/server.go.html#4211381">DefaultServeMux</a></span><span class="op" id="4215756">.</span><span class="ident" id="4215757"><a href="/gostd/net/http/server.go.html#4214304">Handle</a></span><span class="op" id="4215763">(</span><span class="ident" id="4215764"><a href="/gostd/net/http/server.go.html#4215706">pattern</a></span><span class="op" id="4215771">,</span>&nbsp;<span class="ident" id="4215773"><a href="/gostd/net/http/server.go.html#4215722">handler</a></span><span class="op" id="4215780">)</span>&nbsp;<span class="op" id="4215782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215785">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4215852">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="4215879">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4215948">func</span>&nbsp;<span class="ident" id="4215953">HandleFunc</span><span class="op" id="4215963">(</span><span class="ident" id="4215964">pattern</span>&nbsp;<span class="builtintype" id="4215972">string</span><span class="op" id="4215978">,</span>&nbsp;<span class="ident" id="4215980">handler</span>&nbsp;<span class="keyword" id="4215988">func</span><span class="op" id="4215992">(</span><span class="ident" id="4215993"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4216007">,</span>&nbsp;<span class="op" id="4216009">*</span><span class="ident" id="4216010"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4216017">)</span><span class="op" id="4216018">)</span>&nbsp;<span class="op" id="4216020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216023"><a href="/gostd/net/http/server.go.html#4211381">DefaultServeMux</a></span><span class="op" id="4216038">.</span><span class="ident" id="4216039"><a href="/gostd/net/http/server.go.html#4215429">HandleFunc</a></span><span class="op" id="4216049">(</span><span class="ident" id="4216050"><a href="/gostd/net/http/server.go.html#4215964">pattern</a></span><span class="op" id="4216057">,</span>&nbsp;<span class="ident" id="4216059"><a href="/gostd/net/http/server.go.html#4215980">handler</a></span><span class="op" id="4216066">)</span><br>
<span class="lineno"></span><span class="op" id="4216068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="4216071">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="4216133">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="4216203">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="4216260">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4216332">func</span>&nbsp;<span class="ident" id="4216337">Serve</span><span class="op" id="4216342">(</span><span class="ident" id="4216343">l</span>&nbsp;<span class="ident" id="4216345"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4216348">.</span><span class="ident" id="4216349"><a href="/gostd/net/net.go.html#3340703">Listener</a></span><span class="op" id="4216357">,</span>&nbsp;<span class="ident" id="4216359">handler</span>&nbsp;<span class="ident" id="4216367"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4216374">)</span>&nbsp;<span class="builtintype" id="4216376">error</span>&nbsp;<span class="op" id="4216382">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216385">srv</span>&nbsp;<span class="op" id="4216389">:=</span>&nbsp;<span class="op" id="4216392">&amp;</span><span class="ident" id="4216393"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4216399">{</span><span class="ident" id="4216400"><a href="/gostd/net/http/server.go.html#4216654">Handler</a></span><span class="op" id="4216407">:</span>&nbsp;<span class="ident" id="4216409"><a href="/gostd/net/http/server.go.html#4216359">handler</a></span><span class="op" id="4216416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216419">return</span>&nbsp;<span class="ident" id="4216426"><a href="/gostd/net/http/server.go.html#4216385">srv</a></span><span class="op" id="4216429">.</span><span class="ident" id="4216430"><a href="/gostd/net/http/server.go.html#4220587">Serve</a></span><span class="op" id="4216435">(</span><span class="ident" id="4216436"><a href="/gostd/net/http/server.go.html#4216343">l</a></span><span class="op" id="4216437">)</span><br>
<span class="lineno"></span><span class="op" id="4216439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4216442">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="4216501">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="4216556">type</span>&nbsp;<span class="ident" id="4216561">Server</span>&nbsp;<span class="keyword" id="4216568">struct</span>&nbsp;<span class="op" id="4216575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216578">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4216593">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216607">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216654">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216669"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216683">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216734">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216749"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4216753">.</span><span class="ident" id="4216754"><a href="/gostd/time/time.go.html#2734212">Duration</a></span>&nbsp;<span class="comment" id="4216763">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216822">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4216837"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4216841">.</span><span class="ident" id="4216842"><a href="/gostd/time/time.go.html#2734212">Duration</a></span>&nbsp;<span class="comment" id="4216851">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216912">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="4216927">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216941">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217005">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217020">*</span><span class="ident" id="4217021"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4217024">.</span><span class="ident" id="4217025"><a href="/gostd/crypto/tls/common.go.html#4450481">Config</a></span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4217034">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217086">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217148">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217205">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217269">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217329">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217392">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217450">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217502">TLSNextProto</span>&nbsp;<span class="keyword" id="4217515">map</span><span class="op" id="4217518">[</span><span class="builtintype" id="4217519">string</span><span class="op" id="4217525">]</span><span class="keyword" id="4217526">func</span><span class="op" id="4217530">(</span><span class="op" id="4217531">*</span><span class="ident" id="4217532"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4217538">,</span>&nbsp;<span class="op" id="4217540">*</span><span class="ident" id="4217541"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4217544">.</span><span class="ident" id="4217545"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4217549">,</span>&nbsp;<span class="ident" id="4217551"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4217558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217562">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217624">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217683">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217740">ConnState</span>&nbsp;<span class="keyword" id="4217750">func</span><span class="op" id="4217754">(</span><span class="ident" id="4217755"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4217758">.</span><span class="ident" id="4217759"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4217763">,</span>&nbsp;<span class="ident" id="4217765"><a href="/gostd/net/http/server.go.html#4218180">ConnState</a></span><span class="op" id="4217774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217778">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217841">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217896">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217956">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217977">ErrorLog</span>&nbsp;<span class="op" id="4217986">*</span><span class="ident" id="4217987"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4217990">.</span><span class="ident" id="4217991"><a href="/gostd/log/log.go.html#4072441">Logger</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218000">disableKeepAlives</span>&nbsp;<span class="builtintype" id="4218018">int32</span>&nbsp;<span class="comment" id="4218024">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="4218048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4218051">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="4218123">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="4218175">type</span>&nbsp;<span class="ident" id="4218180">ConnState</span>&nbsp;<span class="builtintype" id="4218190">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="4218195">const</span>&nbsp;<span class="op" id="4218201">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218204">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218265">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218323">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218378">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218395">StateNew</span>&nbsp;<span class="ident" id="4218404"><a href="/gostd/net/http/server.go.html#4218180">ConnState</a></span>&nbsp;<span class="op" id="4218414">=</span>&nbsp;<span class="ident" id="4218416">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218423">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218487">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218541">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218604">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218658">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218711">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218772">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218786">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218842">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218905">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4218966">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219008">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219020">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219072">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219141">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219157">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219205">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219263">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219294">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="4219306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4219309">var</span>&nbsp;<span class="ident" id="4219313">stateName</span>&nbsp;<span class="op" id="4219323">=</span>&nbsp;<span class="keyword" id="4219325">map</span><span class="op" id="4219328">[</span><span class="ident" id="4219329"><a href="/gostd/net/http/server.go.html#4218180">ConnState</a></span><span class="op" id="4219338">]</span><span class="builtintype" id="4219339">string</span><span class="op" id="4219345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219348"><a href="/gostd/net/http/server.go.html#4218395">StateNew</a></span><span class="op" id="4219356">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4219363">&#34;new&#34;</span><span class="op" id="4219368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219371"><a href="/gostd/net/http/server.go.html#4218772">StateActive</a></span><span class="op" id="4219382">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4219386">&#34;active&#34;</span><span class="op" id="4219394">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219397"><a href="/gostd/net/http/server.go.html#4219008">StateIdle</a></span><span class="op" id="4219406">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4219412">&#34;idle&#34;</span><span class="op" id="4219418">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219421"><a href="/gostd/net/http/server.go.html#4219141">StateHijacked</a></span><span class="op" id="4219434">:</span>&nbsp;<span class="string" id="4219436">&#34;hijacked&#34;</span><span class="op" id="4219446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219449"><a href="/gostd/net/http/server.go.html#4219294">StateClosed</a></span><span class="op" id="4219460">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4219464">&#34;closed&#34;</span><span class="op" id="4219472">,</span><br>
<span class="lineno"></span><span class="op" id="4219474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="4219477">func</span>&nbsp;<span class="op" id="4219482">(</span><span class="ident" id="4219483">c</span>&nbsp;<span class="ident" id="4219485"><a href="/gostd/net/http/server.go.html#4218180">ConnState</a></span><span class="op" id="4219494">)</span>&nbsp;<span class="ident" id="4219496">String</span><span class="op" id="4219502">(</span><span class="op" id="4219503">)</span>&nbsp;<span class="builtintype" id="4219505">string</span>&nbsp;<span class="op" id="4219512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219515">return</span>&nbsp;<span class="ident" id="4219522"><a href="/gostd/net/http/server.go.html#4219313">stateName</a></span><span class="op" id="4219531">[</span><span class="ident" id="4219532"><a href="/gostd/net/http/server.go.html#4219483">c</a></span><span class="op" id="4219533">]</span><br>
<span class="lineno"></span><span class="op" id="4219535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4219538">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="4219599">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4219657">type</span>&nbsp;<span class="ident" id="4219662">serverHandler</span>&nbsp;<span class="keyword" id="4219676">struct</span>&nbsp;<span class="op" id="4219683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219686">srv</span>&nbsp;<span class="op" id="4219690">*</span><span class="ident" id="4219691"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><br>
<span class="lineno"></span><span class="op" id="4219698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="4219701">func</span>&nbsp;<span class="op" id="4219706">(</span><span class="ident" id="4219707">sh</span>&nbsp;<span class="ident" id="4219710"><a href="/gostd/net/http/server.go.html#4219662">serverHandler</a></span><span class="op" id="4219723">)</span>&nbsp;<span class="ident" id="4219725">ServeHTTP</span><span class="op" id="4219734">(</span><span class="ident" id="4219735">rw</span>&nbsp;<span class="ident" id="4219738"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4219752">,</span>&nbsp;<span class="ident" id="4219754">req</span>&nbsp;<span class="op" id="4219758">*</span><span class="ident" id="4219759"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4219766">)</span>&nbsp;<span class="op" id="4219768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219771">handler</span>&nbsp;<span class="op" id="4219779">:=</span>&nbsp;<span class="ident" id="4219782"><a href="/gostd/net/http/server.go.html#4219707">sh</a></span><span class="op" id="4219784">.</span><span class="ident" id="4219785"><a href="/gostd/net/http/server.go.html#4219686">srv</a></span><span class="op" id="4219788">.</span><span class="ident" id="4219789"><a href="/gostd/net/http/server.go.html#4216654">Handler</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219798">if</span>&nbsp;<span class="ident" id="4219801"><a href="/gostd/net/http/server.go.html#4219771">handler</a></span>&nbsp;<span class="op" id="4219809">==</span>&nbsp;<span class="builtintype" id="4219812">nil</span>&nbsp;<span class="op" id="4219816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219820"><a href="/gostd/net/http/server.go.html#4219771">handler</a></span>&nbsp;<span class="op" id="4219828">=</span>&nbsp;<span class="ident" id="4219830"><a href="/gostd/net/http/server.go.html#4211381">DefaultServeMux</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219847">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219850">if</span>&nbsp;<span class="ident" id="4219853"><a href="/gostd/net/http/server.go.html#4219754">req</a></span><span class="op" id="4219856">.</span><span class="ident" id="4219857"><a href="/gostd/net/http/request.go.html#4141462">RequestURI</a></span>&nbsp;<span class="op" id="4219868">==</span>&nbsp;<span class="string" id="4219871">&#34;*&#34;</span>&nbsp;<span class="op" id="4219875">&amp;&amp;</span>&nbsp;<span class="ident" id="4219878"><a href="/gostd/net/http/server.go.html#4219754">req</a></span><span class="op" id="4219881">.</span><span class="ident" id="4219882"><a href="/gostd/net/http/request.go.html#4136084">Method</a></span>&nbsp;<span class="op" id="4219889">==</span>&nbsp;<span class="string" id="4219892">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="4219902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219906"><a href="/gostd/net/http/server.go.html#4219771">handler</a></span>&nbsp;<span class="op" id="4219914">=</span>&nbsp;<span class="ident" id="4219916"><a href="/gostd/net/http/server.go.html#4227576">globalOptionsHandler</a></span><span class="op" id="4219936">{</span><span class="op" id="4219937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219943"><a href="/gostd/net/http/server.go.html#4219771">handler</a></span><span class="op" id="4219950">.</span><span class="ident" id="4219951"><a href="/gostd/net/http/server.go.html#4170434">ServeHTTP</a></span><span class="op" id="4219960">(</span><span class="ident" id="4219961"><a href="/gostd/net/http/server.go.html#4219735">rw</a></span><span class="op" id="4219963">,</span>&nbsp;<span class="ident" id="4219965"><a href="/gostd/net/http/server.go.html#4219754">req</a></span><span class="op" id="4219968">)</span><br>
<span class="lineno"></span><span class="op" id="4219970">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="4219973">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4220044">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4220107">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4220146">func</span>&nbsp;<span class="op" id="4220151">(</span><span class="ident" id="4220152">srv</span>&nbsp;<span class="op" id="4220156">*</span><span class="ident" id="4220157"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4220163">)</span>&nbsp;<span class="ident" id="4220165">ListenAndServe</span><span class="op" id="4220179">(</span><span class="op" id="4220180">)</span>&nbsp;<span class="builtintype" id="4220182">error</span>&nbsp;<span class="op" id="4220188">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220191">addr</span>&nbsp;<span class="op" id="4220196">:=</span>&nbsp;<span class="ident" id="4220199"><a href="/gostd/net/http/server.go.html#4220152">srv</a></span><span class="op" id="4220202">.</span><span class="ident" id="4220203"><a href="/gostd/net/http/server.go.html#4216578">Addr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220209">if</span>&nbsp;<span class="ident" id="4220212"><a href="/gostd/net/http/server.go.html#4220191">addr</a></span>&nbsp;<span class="op" id="4220217">==</span>&nbsp;<span class="string" id="4220220">&#34;&#34;</span>&nbsp;<span class="op" id="4220223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220227"><a href="/gostd/net/http/server.go.html#4220191">addr</a></span>&nbsp;<span class="op" id="4220232">=</span>&nbsp;<span class="string" id="4220234">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220246">ln</span><span class="op" id="4220248">,</span>&nbsp;<span class="ident" id="4220250">err</span>&nbsp;<span class="op" id="4220254">:=</span>&nbsp;<span class="ident" id="4220257"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4220260">.</span><span class="ident" id="4220261"><a href="/gostd/net/dial.go.html#3207117">Listen</a></span><span class="op" id="4220267">(</span><span class="string" id="4220268">&#34;tcp&#34;</span><span class="op" id="4220273">,</span>&nbsp;<span class="ident" id="4220275"><a href="/gostd/net/http/server.go.html#4220191">addr</a></span><span class="op" id="4220279">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220282">if</span>&nbsp;<span class="ident" id="4220285"><a href="/gostd/net/http/server.go.html#4220250">err</a></span>&nbsp;<span class="op" id="4220289">!=</span>&nbsp;<span class="builtintype" id="4220292">nil</span>&nbsp;<span class="op" id="4220296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220300">return</span>&nbsp;<span class="ident" id="4220307"><a href="/gostd/net/http/server.go.html#4220250">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220315">return</span>&nbsp;<span class="ident" id="4220322"><a href="/gostd/net/http/server.go.html#4220152">srv</a></span><span class="op" id="4220325">.</span><span class="ident" id="4220326"><a href="/gostd/net/http/server.go.html#4220587">Serve</a></span><span class="op" id="4220331">(</span><span class="ident" id="4220332"><a href="/gostd/net/http/server.go.html#4227258">tcpKeepAliveListener</a></span><span class="op" id="4220352">{</span><span class="ident" id="4220353"><a href="/gostd/net/http/server.go.html#4220246">ln</a></span><span class="op" id="4220355">.</span><span class="op" id="4220356">(</span><span class="op" id="4220357">*</span><span class="ident" id="4220358"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4220361">.</span><span class="ident" id="4220362"><a href="/gostd/net/tcpsock_posix.go.html#3381906">TCPListener</a></span><span class="op" id="4220373">)</span><span class="op" id="4220374">}</span><span class="op" id="4220375">)</span><br>
<span class="lineno"></span><span class="op" id="4220377">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="4220380">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4220448">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4220525">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4220568">func</span>&nbsp;<span class="op" id="4220573">(</span><span class="ident" id="4220574">srv</span>&nbsp;<span class="op" id="4220578">*</span><span class="ident" id="4220579"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4220585">)</span>&nbsp;<span class="ident" id="4220587">Serve</span><span class="op" id="4220592">(</span><span class="ident" id="4220593">l</span>&nbsp;<span class="ident" id="4220595"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4220598">.</span><span class="ident" id="4220599"><a href="/gostd/net/net.go.html#3340703">Listener</a></span><span class="op" id="4220607">)</span>&nbsp;<span class="builtintype" id="4220609">error</span>&nbsp;<span class="op" id="4220615">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220618">defer</span>&nbsp;<span class="ident" id="4220624"><a href="/gostd/net/http/server.go.html#4220593">l</a></span><span class="op" id="4220625">.</span><span class="ident" id="4220626"><a href="/gostd/net/net.go.html#3340928">Close</a></span><span class="op" id="4220631">(</span><span class="op" id="4220632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220635">var</span>&nbsp;<span class="ident" id="4220639">tempDelay</span>&nbsp;<span class="ident" id="4220649"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4220653">.</span><span class="ident" id="4220654"><a href="/gostd/time/time.go.html#2734212">Duration</a></span>&nbsp;<span class="comment" id="4220663">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220703">for</span>&nbsp;<span class="op" id="4220707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220711">rw</span><span class="op" id="4220713">,</span>&nbsp;<span class="ident" id="4220715">e</span>&nbsp;<span class="op" id="4220717">:=</span>&nbsp;<span class="ident" id="4220720"><a href="/gostd/net/http/server.go.html#4220593">l</a></span><span class="op" id="4220721">.</span><span class="ident" id="4220722"><a href="/gostd/net/net.go.html#3340795">Accept</a></span><span class="op" id="4220728">(</span><span class="op" id="4220729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220733">if</span>&nbsp;<span class="ident" id="4220736"><a href="/gostd/net/http/server.go.html#4220715">e</a></span>&nbsp;<span class="op" id="4220738">!=</span>&nbsp;<span class="builtintype" id="4220741">nil</span>&nbsp;<span class="op" id="4220745">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220750">if</span>&nbsp;<span class="ident" id="4220753">ne</span><span class="op" id="4220755">,</span>&nbsp;<span class="ident" id="4220757">ok</span>&nbsp;<span class="op" id="4220760">:=</span>&nbsp;<span class="ident" id="4220763"><a href="/gostd/net/http/server.go.html#4220715">e</a></span><span class="op" id="4220764">.</span><span class="op" id="4220765">(</span><span class="ident" id="4220766"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4220769">.</span><span class="ident" id="4220770"><a href="/gostd/net/net.go.html#3338570">Error</a></span><span class="op" id="4220775">)</span><span class="op" id="4220776">;</span>&nbsp;<span class="ident" id="4220778"><a href="/gostd/net/http/server.go.html#4220757">ok</a></span>&nbsp;<span class="op" id="4220781">&amp;&amp;</span>&nbsp;<span class="ident" id="4220784"><a href="/gostd/net/http/server.go.html#4220753">ne</a></span><span class="op" id="4220786">.</span><span class="ident" id="4220787"><a href="/gostd/net/net.go.html#3338641">Temporary</a></span><span class="op" id="4220796">(</span><span class="op" id="4220797">)</span>&nbsp;<span class="op" id="4220799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220805">if</span>&nbsp;<span class="ident" id="4220808"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4220818">==</span>&nbsp;<span class="num" id="4220821">0</span>&nbsp;<span class="op" id="4220823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220830"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4220840">=</span>&nbsp;<span class="num" id="4220842">5</span>&nbsp;<span class="op" id="4220844">*</span>&nbsp;<span class="ident" id="4220846"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4220850">.</span><span class="ident" id="4220851"><a href="/gostd/time/time.go.html#2734819">Millisecond</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220867">}</span>&nbsp;<span class="keyword" id="4220869">else</span>&nbsp;<span class="op" id="4220874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220881"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4220891">*=</span>&nbsp;<span class="num" id="4220894">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220906">if</span>&nbsp;<span class="ident" id="4220909">max</span>&nbsp;<span class="op" id="4220913">:=</span>&nbsp;<span class="num" id="4220916">1</span>&nbsp;<span class="op" id="4220918">*</span>&nbsp;<span class="ident" id="4220920"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4220924">.</span><span class="ident" id="4220925"><a href="/gostd/time/time.go.html#2734862">Second</a></span><span class="op" id="4220931">;</span>&nbsp;<span class="ident" id="4220933"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4220943">&gt;</span>&nbsp;<span class="ident" id="4220945"><a href="/gostd/net/http/server.go.html#4220909">max</a></span>&nbsp;<span class="op" id="4220949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220956"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4220966">=</span>&nbsp;<span class="ident" id="4220968"><a href="/gostd/net/http/server.go.html#4220909">max</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220982"><a href="/gostd/net/http/server.go.html#4220574">srv</a></span><span class="op" id="4220985">.</span><span class="ident" id="4220986"><a href="/gostd/net/http/server.go.html#4221768">logf</a></span><span class="op" id="4220990">(</span><span class="string" id="4220991">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="4221031">,</span>&nbsp;<span class="ident" id="4221033"><a href="/gostd/net/http/server.go.html#4220715">e</a></span><span class="op" id="4221034">,</span>&nbsp;<span class="ident" id="4221036"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span><span class="op" id="4221045">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221051"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4221055">.</span><span class="ident" id="4221056"><a href="/gostd/time/sleep.go.html#2713940">Sleep</a></span><span class="op" id="4221061">(</span><span class="ident" id="4221062"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span><span class="op" id="4221071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221077">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221094">return</span>&nbsp;<span class="ident" id="4221101"><a href="/gostd/net/http/server.go.html#4220715">e</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221105">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221109"><a href="/gostd/net/http/server.go.html#4220639">tempDelay</a></span>&nbsp;<span class="op" id="4221119">=</span>&nbsp;<span class="num" id="4221121">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221125">c</span><span class="op" id="4221126">,</span>&nbsp;<span class="ident" id="4221128">err</span>&nbsp;<span class="op" id="4221132">:=</span>&nbsp;<span class="ident" id="4221135"><a href="/gostd/net/http/server.go.html#4220574">srv</a></span><span class="op" id="4221138">.</span><span class="ident" id="4221139"><a href="/gostd/net/http/server.go.html#4181604">newConn</a></span><span class="op" id="4221146">(</span><span class="ident" id="4221147"><a href="/gostd/net/http/server.go.html#4220711">rw</a></span><span class="op" id="4221149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221153">if</span>&nbsp;<span class="ident" id="4221156"><a href="/gostd/net/http/server.go.html#4221128">err</a></span>&nbsp;<span class="op" id="4221160">!=</span>&nbsp;<span class="builtintype" id="4221163">nil</span>&nbsp;<span class="op" id="4221167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221172">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221183">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221187"><a href="/gostd/net/http/server.go.html#4221125">c</a></span><span class="op" id="4221188">.</span><span class="ident" id="4221189"><a href="/gostd/net/http/server.go.html#4201256">setState</a></span><span class="op" id="4221197">(</span><span class="ident" id="4221198"><a href="/gostd/net/http/server.go.html#4221125">c</a></span><span class="op" id="4221199">.</span><span class="ident" id="4221200"><a href="/gostd/net/http/server.go.html#4172953">rwc</a></span><span class="op" id="4221203">,</span>&nbsp;<span class="ident" id="4221205"><a href="/gostd/net/http/server.go.html#4218395">StateNew</a></span><span class="op" id="4221213">)</span>&nbsp;<span class="comment" id="4221215">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221244">go</span>&nbsp;<span class="ident" id="4221247"><a href="/gostd/net/http/server.go.html#4221125">c</a></span><span class="op" id="4221248">.</span><span class="ident" id="4221249"><a href="/gostd/net/http/server.go.html#4201409">serve</a></span><span class="op" id="4221254">(</span><span class="op" id="4221255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221258">}</span><br>
<span class="lineno"></span><span class="op" id="4221260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="4221263">func</span>&nbsp;<span class="op" id="4221268">(</span><span class="ident" id="4221269">s</span>&nbsp;<span class="op" id="4221271">*</span><span class="ident" id="4221272"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4221278">)</span>&nbsp;<span class="ident" id="4221280">doKeepAlives</span><span class="op" id="4221292">(</span><span class="op" id="4221293">)</span>&nbsp;<span class="builtintype" id="4221295">bool</span>&nbsp;<span class="op" id="4221300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221303">return</span>&nbsp;<span class="ident" id="4221310"><a href="/gostd/net/http/server.go.html#4169419">atomic</a></span><span class="op" id="4221316">.</span><span class="ident" id="4221317"><a href="/gostd/sync/atomic/doc.go.html#1467846">LoadInt32</a></span><span class="op" id="4221326">(</span><span class="op" id="4221327">&amp;</span><span class="ident" id="4221328"><a href="/gostd/net/http/server.go.html#4221269">s</a></span><span class="op" id="4221329">.</span><span class="ident" id="4221330"><a href="/gostd/net/http/server.go.html#4218000">disableKeepAlives</a></span><span class="op" id="4221347">)</span>&nbsp;<span class="op" id="4221349">==</span>&nbsp;<span class="num" id="4221352">0</span><br>
<span class="lineno"></span><span class="op" id="4221354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4221357">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="4221428">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="4221485">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4221551">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4221589">func</span>&nbsp;<span class="op" id="4221594">(</span><span class="ident" id="4221595">s</span>&nbsp;<span class="op" id="4221597">*</span><span class="ident" id="4221598"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4221604">)</span>&nbsp;<span class="ident" id="4221606">SetKeepAlivesEnabled</span><span class="op" id="4221626">(</span><span class="ident" id="4221627">v</span>&nbsp;<span class="builtintype" id="4221629">bool</span><span class="op" id="4221633">)</span>&nbsp;<span class="op" id="4221635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221638">if</span>&nbsp;<span class="ident" id="4221641"><a href="/gostd/net/http/server.go.html#4221627">v</a></span>&nbsp;<span class="op" id="4221643">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221647"><a href="/gostd/net/http/server.go.html#4169419">atomic</a></span><span class="op" id="4221653">.</span><span class="ident" id="4221654"><a href="/gostd/sync/atomic/doc.go.html#1468363">StoreInt32</a></span><span class="op" id="4221664">(</span><span class="op" id="4221665">&amp;</span><span class="ident" id="4221666"><a href="/gostd/net/http/server.go.html#4221595">s</a></span><span class="op" id="4221667">.</span><span class="ident" id="4221668"><a href="/gostd/net/http/server.go.html#4218000">disableKeepAlives</a></span><span class="op" id="4221685">,</span>&nbsp;<span class="num" id="4221687">0</span><span class="op" id="4221688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221691">}</span>&nbsp;<span class="keyword" id="4221693">else</span>&nbsp;<span class="op" id="4221698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221702"><a href="/gostd/net/http/server.go.html#4169419">atomic</a></span><span class="op" id="4221708">.</span><span class="ident" id="4221709"><a href="/gostd/sync/atomic/doc.go.html#1468363">StoreInt32</a></span><span class="op" id="4221719">(</span><span class="op" id="4221720">&amp;</span><span class="ident" id="4221721"><a href="/gostd/net/http/server.go.html#4221595">s</a></span><span class="op" id="4221722">.</span><span class="ident" id="4221723"><a href="/gostd/net/http/server.go.html#4218000">disableKeepAlives</a></span><span class="op" id="4221740">,</span>&nbsp;<span class="num" id="4221742">1</span><span class="op" id="4221743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221746">}</span><br>
<span class="lineno"></span><span class="op" id="4221748">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="4221751">func</span>&nbsp;<span class="op" id="4221756">(</span><span class="ident" id="4221757">s</span>&nbsp;<span class="op" id="4221759">*</span><span class="ident" id="4221760"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4221766">)</span>&nbsp;<span class="ident" id="4221768">logf</span><span class="op" id="4221772">(</span><span class="ident" id="4221773">format</span>&nbsp;<span class="builtintype" id="4221780">string</span><span class="op" id="4221786">,</span>&nbsp;<span class="ident" id="4221788">args</span>&nbsp;<span class="op" id="4221793">...</span><span class="keyword" id="4221796">interface</span><span class="op" id="4221805">{</span><span class="op" id="4221806">}</span><span class="op" id="4221807">)</span>&nbsp;<span class="op" id="4221809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221812">if</span>&nbsp;<span class="ident" id="4221815"><a href="/gostd/net/http/server.go.html#4221757">s</a></span><span class="op" id="4221816">.</span><span class="ident" id="4221817"><a href="/gostd/net/http/server.go.html#4217977">ErrorLog</a></span>&nbsp;<span class="op" id="4221826">!=</span>&nbsp;<span class="builtintype" id="4221829">nil</span>&nbsp;<span class="op" id="4221833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221837"><a href="/gostd/net/http/server.go.html#4221757">s</a></span><span class="op" id="4221838">.</span><span class="ident" id="4221839"><a href="/gostd/net/http/server.go.html#4217977">ErrorLog</a></span><span class="op" id="4221847">.</span><span class="ident" id="4221848"><a href="/gostd/log/log.go.html#4075692">Printf</a></span><span class="op" id="4221854">(</span><span class="ident" id="4221855"><a href="/gostd/net/http/server.go.html#4221773">format</a></span><span class="op" id="4221861">,</span>&nbsp;<span class="ident" id="4221863"><a href="/gostd/net/http/server.go.html#4221788">args</a></span><span class="op" id="4221867">...</span><span class="op" id="4221870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221873">}</span>&nbsp;<span class="keyword" id="4221875">else</span>&nbsp;<span class="op" id="4221880">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221884"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4221887">.</span><span class="ident" id="4221888"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4221894">(</span><span class="ident" id="4221895"><a href="/gostd/net/http/server.go.html#4221773">format</a></span><span class="op" id="4221901">,</span>&nbsp;<span class="ident" id="4221903"><a href="/gostd/net/http/server.go.html#4221788">args</a></span><span class="op" id="4221907">...</span><span class="op" id="4221910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221913">}</span><br>
<span class="lineno"></span><span class="op" id="4221915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4221918">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="4221976">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4222032">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="4222087">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4222133">//</span><br>
<span class="lineno"></span><span class="comment" id="4222136">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="4222168">//</span><br>
<span class="lineno"></span><span class="comment" id="4222171">//&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="4222187">//</span><br>
<span class="lineno"></span><span class="comment" id="4222190">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="4222202">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="4222211">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4222226">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4222236">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="4222241">//</span><br>
<span class="lineno"></span><span class="comment" id="4222244">//&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="4222278">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4222342">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4222383">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4222388">//</span><br>
<span class="lineno"></span><span class="comment" id="4222391">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="4222408">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="4222451">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4222497">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4222517">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="4222557">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">1805</span><span class="comment" id="4222563">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="4222568">func</span>&nbsp;<span class="ident" id="4222573">ListenAndServe</span><span class="op" id="4222587">(</span><span class="ident" id="4222588">addr</span>&nbsp;<span class="builtintype" id="4222593">string</span><span class="op" id="4222599">,</span>&nbsp;<span class="ident" id="4222601">handler</span>&nbsp;<span class="ident" id="4222609"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4222616">)</span>&nbsp;<span class="builtintype" id="4222618">error</span>&nbsp;<span class="op" id="4222624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222627">server</span>&nbsp;<span class="op" id="4222634">:=</span>&nbsp;<span class="op" id="4222637">&amp;</span><span class="ident" id="4222638"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4222644">{</span><span class="ident" id="4222645"><a href="/gostd/net/http/server.go.html#4216578">Addr</a></span><span class="op" id="4222649">:</span>&nbsp;<span class="ident" id="4222651"><a href="/gostd/net/http/server.go.html#4222588">addr</a></span><span class="op" id="4222655">,</span>&nbsp;<span class="ident" id="4222657"><a href="/gostd/net/http/server.go.html#4216654">Handler</a></span><span class="op" id="4222664">:</span>&nbsp;<span class="ident" id="4222666"><a href="/gostd/net/http/server.go.html#4222601">handler</a></span><span class="op" id="4222673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222676">return</span>&nbsp;<span class="ident" id="4222683"><a href="/gostd/net/http/server.go.html#4222627">server</a></span><span class="op" id="4222689">.</span><span class="ident" id="4222690"><a href="/gostd/net/http/server.go.html#4220165">ListenAndServe</a></span><span class="op" id="4222704">(</span><span class="op" id="4222705">)</span><br>
<span class="lineno"></span><span class="op" id="4222707">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="4222710">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4222782">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4222861">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="4222937">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="4223019">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4223084">//</span><br>
<span class="lineno"></span><span class="comment" id="4223087">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="4223119">//</span><br>
<span class="lineno"></span><span class="comment" id="4223122">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="4223134">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4223144">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4223159">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="4223164">//</span><br>
<span class="lineno"></span><span class="comment" id="4223167">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="4223227">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4223276">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="4223328">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4223333">//</span><br>
<span class="lineno"></span><span class="comment" id="4223336">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="4223353">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="4223387">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4223462">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4223534">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4223554">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="4223574">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4223580">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4223585">//</span><br>
<span class="lineno"></span><span class="comment" id="4223588">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="4223668">func</span>&nbsp;<span class="ident" id="4223673">ListenAndServeTLS</span><span class="op" id="4223690">(</span><span class="ident" id="4223691">addr</span>&nbsp;<span class="builtintype" id="4223696">string</span><span class="op" id="4223702">,</span>&nbsp;<span class="ident" id="4223704">certFile</span>&nbsp;<span class="builtintype" id="4223713">string</span><span class="op" id="4223719">,</span>&nbsp;<span class="ident" id="4223721">keyFile</span>&nbsp;<span class="builtintype" id="4223729">string</span><span class="op" id="4223735">,</span>&nbsp;<span class="ident" id="4223737">handler</span>&nbsp;<span class="ident" id="4223745"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4223752">)</span>&nbsp;<span class="builtintype" id="4223754">error</span>&nbsp;<span class="op" id="4223760">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223763">server</span>&nbsp;<span class="op" id="4223770">:=</span>&nbsp;<span class="op" id="4223773">&amp;</span><span class="ident" id="4223774"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4223780">{</span><span class="ident" id="4223781"><a href="/gostd/net/http/server.go.html#4216578">Addr</a></span><span class="op" id="4223785">:</span>&nbsp;<span class="ident" id="4223787"><a href="/gostd/net/http/server.go.html#4223691">addr</a></span><span class="op" id="4223791">,</span>&nbsp;<span class="ident" id="4223793"><a href="/gostd/net/http/server.go.html#4216654">Handler</a></span><span class="op" id="4223800">:</span>&nbsp;<span class="ident" id="4223802"><a href="/gostd/net/http/server.go.html#4223737">handler</a></span><span class="op" id="4223809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223812">return</span>&nbsp;<span class="ident" id="4223819"><a href="/gostd/net/http/server.go.html#4223763">server</a></span><span class="op" id="4223825">.</span><span class="ident" id="4223826"><a href="/gostd/net/http/server.go.html#4224336">ListenAndServeTLS</a></span><span class="op" id="4223843">(</span><span class="ident" id="4223844"><a href="/gostd/net/http/server.go.html#4223704">certFile</a></span><span class="op" id="4223852">,</span>&nbsp;<span class="ident" id="4223854"><a href="/gostd/net/http/server.go.html#4223721">keyFile</a></span><span class="op" id="4223861">)</span><br>
<span class="lineno"></span><span class="op" id="4223863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4223866">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="4223935">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="4224003">//</span><br>
<span class="lineno"></span><span class="comment" id="4224006">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4224073">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4224139">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="4224206">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4224271">//</span><br>
<span class="lineno"></span><span class="comment" id="4224274">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4224317">func</span>&nbsp;<span class="op" id="4224322">(</span><span class="ident" id="4224323">srv</span>&nbsp;<span class="op" id="4224327">*</span><span class="ident" id="4224328"><a href="/gostd/net/http/server.go.html#4216561">Server</a></span><span class="op" id="4224334">)</span>&nbsp;<span class="ident" id="4224336">ListenAndServeTLS</span><span class="op" id="4224353">(</span><span class="ident" id="4224354">certFile</span><span class="op" id="4224362">,</span>&nbsp;<span class="ident" id="4224364">keyFile</span>&nbsp;<span class="builtintype" id="4224372">string</span><span class="op" id="4224378">)</span>&nbsp;<span class="builtintype" id="4224380">error</span>&nbsp;<span class="op" id="4224386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224389">addr</span>&nbsp;<span class="op" id="4224394">:=</span>&nbsp;<span class="ident" id="4224397"><a href="/gostd/net/http/server.go.html#4224323">srv</a></span><span class="op" id="4224400">.</span><span class="ident" id="4224401"><a href="/gostd/net/http/server.go.html#4216578">Addr</a></span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224407">if</span>&nbsp;<span class="ident" id="4224410"><a href="/gostd/net/http/server.go.html#4224389">addr</a></span>&nbsp;<span class="op" id="4224415">==</span>&nbsp;<span class="string" id="4224418">&#34;&#34;</span>&nbsp;<span class="op" id="4224421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224425"><a href="/gostd/net/http/server.go.html#4224389">addr</a></span>&nbsp;<span class="op" id="4224430">=</span>&nbsp;<span class="string" id="4224432">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224445">config</span>&nbsp;<span class="op" id="4224452">:=</span>&nbsp;<span class="op" id="4224455">&amp;</span><span class="ident" id="4224456"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4224459">.</span><span class="ident" id="4224460"><a href="/gostd/crypto/tls/common.go.html#4450481">Config</a></span><span class="op" id="4224466">{</span><span class="op" id="4224467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224470">if</span>&nbsp;<span class="ident" id="4224473"><a href="/gostd/net/http/server.go.html#4224323">srv</a></span><span class="op" id="4224476">.</span><span class="ident" id="4224477"><a href="/gostd/net/http/server.go.html#4217005">TLSConfig</a></span>&nbsp;<span class="op" id="4224487">!=</span>&nbsp;<span class="builtintype" id="4224490">nil</span>&nbsp;<span class="op" id="4224494">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224498">*</span><span class="ident" id="4224499"><a href="/gostd/net/http/server.go.html#4224445">config</a></span>&nbsp;<span class="op" id="4224506">=</span>&nbsp;<span class="op" id="4224508">*</span><span class="ident" id="4224509"><a href="/gostd/net/http/server.go.html#4224323">srv</a></span><span class="op" id="4224512">.</span><span class="ident" id="4224513"><a href="/gostd/net/http/server.go.html#4217005">TLSConfig</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224527">if</span>&nbsp;<span class="ident" id="4224530"><a href="/gostd/net/http/server.go.html#4224445">config</a></span><span class="op" id="4224536">.</span><span class="ident" id="4224537"><a href="/gostd/crypto/tls/common.go.html#4452064">NextProtos</a></span>&nbsp;<span class="op" id="4224548">==</span>&nbsp;<span class="builtintype" id="4224551">nil</span>&nbsp;<span class="op" id="4224555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224559"><a href="/gostd/net/http/server.go.html#4224445">config</a></span><span class="op" id="4224565">.</span><span class="ident" id="4224566"><a href="/gostd/crypto/tls/common.go.html#4452064">NextProtos</a></span>&nbsp;<span class="op" id="4224577">=</span>&nbsp;<span class="op" id="4224579">[</span><span class="op" id="4224580">]</span><span class="builtintype" id="4224581">string</span><span class="op" id="4224587">{</span><span class="string" id="4224588">&#34;http/1.1&#34;</span><span class="op" id="4224598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224601">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224605">var</span>&nbsp;<span class="ident" id="4224609">err</span>&nbsp;<span class="builtintype" id="4224613">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224620"><a href="/gostd/net/http/server.go.html#4224445">config</a></span><span class="op" id="4224626">.</span><span class="ident" id="4224627"><a href="/gostd/crypto/tls/common.go.html#4451046">Certificates</a></span>&nbsp;<span class="op" id="4224640">=</span>&nbsp;<span class="builtinfunc" id="4224642">make</span><span class="op" id="4224646">(</span><span class="op" id="4224647">[</span><span class="op" id="4224648">]</span><span class="ident" id="4224649"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4224652">.</span><span class="ident" id="4224653"><a href="/gostd/crypto/tls/common.go.html#4457987">Certificate</a></span><span class="op" id="4224664">,</span>&nbsp;<span class="num" id="4224666">1</span><span class="op" id="4224667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224670"><a href="/gostd/net/http/server.go.html#4224445">config</a></span><span class="op" id="4224676">.</span><span class="ident" id="4224677"><a href="/gostd/crypto/tls/common.go.html#4451046">Certificates</a></span><span class="op" id="4224689">[</span><span class="num" id="4224690">0</span><span class="op" id="4224691">]</span><span class="op" id="4224692">,</span>&nbsp;<span class="ident" id="4224694"><a href="/gostd/net/http/server.go.html#4224609">err</a></span>&nbsp;<span class="op" id="4224698">=</span>&nbsp;<span class="ident" id="4224700"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4224703">.</span><span class="ident" id="4224704"><a href="/gostd/crypto/tls/tls.go.html#4587932">LoadX509KeyPair</a></span><span class="op" id="4224719">(</span><span class="ident" id="4224720"><a href="/gostd/net/http/server.go.html#4224354">certFile</a></span><span class="op" id="4224728">,</span>&nbsp;<span class="ident" id="4224730"><a href="/gostd/net/http/server.go.html#4224364">keyFile</a></span><span class="op" id="4224737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224740">if</span>&nbsp;<span class="ident" id="4224743"><a href="/gostd/net/http/server.go.html#4224609">err</a></span>&nbsp;<span class="op" id="4224747">!=</span>&nbsp;<span class="builtintype" id="4224750">nil</span>&nbsp;<span class="op" id="4224754">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224758">return</span>&nbsp;<span class="ident" id="4224765"><a href="/gostd/net/http/server.go.html#4224609">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224774">ln</span><span class="op" id="4224776">,</span>&nbsp;<span class="ident" id="4224778"><a href="/gostd/net/http/server.go.html#4224609">err</a></span>&nbsp;<span class="op" id="4224782">:=</span>&nbsp;<span class="ident" id="4224785"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4224788">.</span><span class="ident" id="4224789"><a href="/gostd/net/dial.go.html#3207117">Listen</a></span><span class="op" id="4224795">(</span><span class="string" id="4224796">&#34;tcp&#34;</span><span class="op" id="4224801">,</span>&nbsp;<span class="ident" id="4224803"><a href="/gostd/net/http/server.go.html#4224389">addr</a></span><span class="op" id="4224807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224810">if</span>&nbsp;<span class="ident" id="4224813"><a href="/gostd/net/http/server.go.html#4224609">err</a></span>&nbsp;<span class="op" id="4224817">!=</span>&nbsp;<span class="builtintype" id="4224820">nil</span>&nbsp;<span class="op" id="4224824">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224828">return</span>&nbsp;<span class="ident" id="4224835"><a href="/gostd/net/http/server.go.html#4224609">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4224840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224844">tlsListener</span>&nbsp;<span class="op" id="4224856">:=</span>&nbsp;<span class="ident" id="4224859"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4224862">.</span><span class="ident" id="4224863"><a href="/gostd/crypto/tls/tls.go.html#4584756">NewListener</a></span><span class="op" id="4224874">(</span><span class="ident" id="4224875"><a href="/gostd/net/http/server.go.html#4227258">tcpKeepAliveListener</a></span><span class="op" id="4224895">{</span><span class="ident" id="4224896"><a href="/gostd/net/http/server.go.html#4224774">ln</a></span><span class="op" id="4224898">.</span><span class="op" id="4224899">(</span><span class="op" id="4224900">*</span><span class="ident" id="4224901"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4224904">.</span><span class="ident" id="4224905"><a href="/gostd/net/tcpsock_posix.go.html#3381906">TCPListener</a></span><span class="op" id="4224916">)</span><span class="op" id="4224917">}</span><span class="op" id="4224918">,</span>&nbsp;<span class="ident" id="4224920"><a href="/gostd/net/http/server.go.html#4224445">config</a></span><span class="op" id="4224926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4224929">return</span>&nbsp;<span class="ident" id="4224936"><a href="/gostd/net/http/server.go.html#4224323">srv</a></span><span class="op" id="4224939">.</span><span class="ident" id="4224940"><a href="/gostd/net/http/server.go.html#4220587">Serve</a></span><span class="op" id="4224945">(</span><span class="ident" id="4224946"><a href="/gostd/net/http/server.go.html#4224844">tlsListener</a></span><span class="op" id="4224957">)</span><br>
<span class="lineno">1880</span><span class="op" id="4224959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4224962">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="4225037">//</span><br>
<span class="lineno"></span><span class="comment" id="4225040">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="4225110">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4225181">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="4225251">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="4225314">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="4225385">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="4225407">func</span>&nbsp;<span class="ident" id="4225412">TimeoutHandler</span><span class="op" id="4225426">(</span><span class="ident" id="4225427">h</span>&nbsp;<span class="ident" id="4225429"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><span class="op" id="4225436">,</span>&nbsp;<span class="ident" id="4225438">dt</span>&nbsp;<span class="ident" id="4225441"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4225445">.</span><span class="ident" id="4225446"><a href="/gostd/time/time.go.html#2734212">Duration</a></span><span class="op" id="4225454">,</span>&nbsp;<span class="ident" id="4225456">msg</span>&nbsp;<span class="builtintype" id="4225460">string</span><span class="op" id="4225466">)</span>&nbsp;<span class="ident" id="4225468"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span>&nbsp;<span class="op" id="4225476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225479">f</span>&nbsp;<span class="op" id="4225481">:=</span>&nbsp;<span class="keyword" id="4225484">func</span><span class="op" id="4225488">(</span><span class="op" id="4225489">)</span>&nbsp;<span class="op" id="4225491">&lt;-</span><span class="keyword" id="4225493">chan</span>&nbsp;<span class="ident" id="4225498"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4225502">.</span><span class="ident" id="4225503"><a href="/gostd/time/time.go.html#2722087">Time</a></span>&nbsp;<span class="op" id="4225508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225512">return</span>&nbsp;<span class="ident" id="4225519"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4225523">.</span><span class="ident" id="4225524"><a href="/gostd/time/sleep.go.html#2716644">After</a></span><span class="op" id="4225529">(</span><span class="ident" id="4225530"><a href="/gostd/net/http/server.go.html#4225438">dt</a></span><span class="op" id="4225532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225538">return</span>&nbsp;<span class="op" id="4225545">&amp;</span><span class="ident" id="4225546"><a href="/gostd/net/http/server.go.html#4225741">timeoutHandler</a></span><span class="op" id="4225560">{</span><span class="ident" id="4225561"><a href="/gostd/net/http/server.go.html#4225427">h</a></span><span class="op" id="4225562">,</span>&nbsp;<span class="ident" id="4225564"><a href="/gostd/net/http/server.go.html#4225479">f</a></span><span class="op" id="4225565">,</span>&nbsp;<span class="ident" id="4225567"><a href="/gostd/net/http/server.go.html#4225456">msg</a></span><span class="op" id="4225570">}</span><br>
<span class="lineno">1895</span><span class="op" id="4225572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4225575">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4225638">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4225675">var</span>&nbsp;<span class="ident" id="4225679">ErrHandlerTimeout</span>&nbsp;<span class="op" id="4225697">=</span>&nbsp;<span class="ident" id="4225699"><a href="/gostd/net/http/server.go.html#4169303">errors</a></span><span class="op" id="4225705">.</span><span class="ident" id="4225706"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4225709">(</span><span class="string" id="4225710">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="4225733">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="4225736">type</span>&nbsp;<span class="ident" id="4225741">timeoutHandler</span>&nbsp;<span class="keyword" id="4225756">struct</span>&nbsp;<span class="op" id="4225763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225766">handler</span>&nbsp;<span class="ident" id="4225774"><a href="/gostd/net/http/server.go.html#4170413">Handler</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225783">timeout</span>&nbsp;<span class="keyword" id="4225791">func</span><span class="op" id="4225795">(</span><span class="op" id="4225796">)</span>&nbsp;<span class="op" id="4225798">&lt;-</span><span class="keyword" id="4225800">chan</span>&nbsp;<span class="ident" id="4225805"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4225809">.</span><span class="ident" id="4225810"><a href="/gostd/time/time.go.html#2722087">Time</a></span>&nbsp;<span class="comment" id="4225815">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225855">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4225863">string</span><br>
<span class="lineno">1905</span><span class="op" id="4225870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4225873">func</span>&nbsp;<span class="op" id="4225878">(</span><span class="ident" id="4225879">h</span>&nbsp;<span class="op" id="4225881">*</span><span class="ident" id="4225882"><a href="/gostd/net/http/server.go.html#4225741">timeoutHandler</a></span><span class="op" id="4225896">)</span>&nbsp;<span class="ident" id="4225898">errorBody</span><span class="op" id="4225907">(</span><span class="op" id="4225908">)</span>&nbsp;<span class="builtintype" id="4225910">string</span>&nbsp;<span class="op" id="4225917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225920">if</span>&nbsp;<span class="ident" id="4225923"><a href="/gostd/net/http/server.go.html#4225879">h</a></span><span class="op" id="4225924">.</span><span class="ident" id="4225925"><a href="/gostd/net/http/server.go.html#4225855">body</a></span>&nbsp;<span class="op" id="4225930">!=</span>&nbsp;<span class="string" id="4225933">&#34;&#34;</span>&nbsp;<span class="op" id="4225936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225940">return</span>&nbsp;<span class="ident" id="4225947"><a href="/gostd/net/http/server.go.html#4225879">h</a></span><span class="op" id="4225948">.</span><span class="ident" id="4225949"><a href="/gostd/net/http/server.go.html#4225855">body</a></span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4225955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4225958">return</span>&nbsp;<span class="string" id="4225965">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4226045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226048">func</span>&nbsp;<span class="op" id="4226053">(</span><span class="ident" id="4226054">h</span>&nbsp;<span class="op" id="4226056">*</span><span class="ident" id="4226057"><a href="/gostd/net/http/server.go.html#4225741">timeoutHandler</a></span><span class="op" id="4226071">)</span>&nbsp;<span class="ident" id="4226073">ServeHTTP</span><span class="op" id="4226082">(</span><span class="ident" id="4226083">w</span>&nbsp;<span class="ident" id="4226085"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4226099">,</span>&nbsp;<span class="ident" id="4226101">r</span>&nbsp;<span class="op" id="4226103">*</span><span class="ident" id="4226104"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4226111">)</span>&nbsp;<span class="op" id="4226113">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226116">done</span>&nbsp;<span class="op" id="4226121">:=</span>&nbsp;<span class="builtinfunc" id="4226124">make</span><span class="op" id="4226128">(</span><span class="keyword" id="4226129">chan</span>&nbsp;<span class="builtintype" id="4226134">bool</span><span class="op" id="4226138">,</span>&nbsp;<span class="num" id="4226140">1</span><span class="op" id="4226141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226144">tw</span>&nbsp;<span class="op" id="4226147">:=</span>&nbsp;<span class="op" id="4226150">&amp;</span><span class="ident" id="4226151"><a href="/gostd/net/http/server.go.html#4226467">timeoutWriter</a></span><span class="op" id="4226164">{</span><span class="ident" id="4226165"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4226166">:</span>&nbsp;<span class="ident" id="4226168"><a href="/gostd/net/http/server.go.html#4226083">w</a></span><span class="op" id="4226169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226172">go</span>&nbsp;<span class="keyword" id="4226175">func</span><span class="op" id="4226179">(</span><span class="op" id="4226180">)</span>&nbsp;<span class="op" id="4226182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226186"><a href="/gostd/net/http/server.go.html#4226054">h</a></span><span class="op" id="4226187">.</span><span class="ident" id="4226188"><a href="/gostd/net/http/server.go.html#4225766">handler</a></span><span class="op" id="4226195">.</span><span class="ident" id="4226196"><a href="/gostd/net/http/server.go.html#4170434">ServeHTTP</a></span><span class="op" id="4226205">(</span><span class="ident" id="4226206"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226208">,</span>&nbsp;<span class="ident" id="4226210"><a href="/gostd/net/http/server.go.html#4226101">r</a></span><span class="op" id="4226211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226215"><a href="/gostd/net/http/server.go.html#4226116">done</a></span>&nbsp;<span class="op" id="4226220">&lt;-</span>&nbsp;<span class="builtintype" id="4226223">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226229">}</span><span class="op" id="4226230">(</span><span class="op" id="4226231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226234">select</span>&nbsp;<span class="op" id="4226241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226244">case</span>&nbsp;<span class="op" id="4226249">&lt;-</span><span class="ident" id="4226251"><a href="/gostd/net/http/server.go.html#4226116">done</a></span><span class="op" id="4226255">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226259">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226267">case</span>&nbsp;<span class="op" id="4226272">&lt;-</span><span class="ident" id="4226274"><a href="/gostd/net/http/server.go.html#4226054">h</a></span><span class="op" id="4226275">.</span><span class="ident" id="4226276"><a href="/gostd/net/http/server.go.html#4225783">timeout</a></span><span class="op" id="4226283">(</span><span class="op" id="4226284">)</span><span class="op" id="4226285">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226289"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226291">.</span><span class="ident" id="4226292"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226294">.</span><span class="ident" id="4226295"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4226299">(</span><span class="op" id="4226300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226304">defer</span>&nbsp;<span class="ident" id="4226310"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226312">.</span><span class="ident" id="4226313"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226315">.</span><span class="ident" id="4226316"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4226322">(</span><span class="op" id="4226323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226327">if</span>&nbsp;<span class="op" id="4226330">!</span><span class="ident" id="4226331"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226333">.</span><span class="ident" id="4226334"><a href="/gostd/net/http/server.go.html#4226552">wroteHeader</a></span>&nbsp;<span class="op" id="4226346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226351"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226353">.</span><span class="ident" id="4226354"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4226355">.</span><span class="ident" id="4226356"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="4226367">(</span><span class="ident" id="4226368"><a href="/gostd/net/http/status.go.html#4237577">StatusServiceUnavailable</a></span><span class="op" id="4226392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226397"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226399">.</span><span class="ident" id="4226400"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4226401">.</span><span class="ident" id="4226402"><a href="/gostd/net/http/server.go.html#4171123">Write</a></span><span class="op" id="4226407">(</span><span class="op" id="4226408">[</span><span class="op" id="4226409">]</span><span class="builtintype" id="4226410">byte</span><span class="op" id="4226414">(</span><span class="ident" id="4226415"><a href="/gostd/net/http/server.go.html#4226054">h</a></span><span class="op" id="4226416">.</span><span class="ident" id="4226417"><a href="/gostd/net/http/server.go.html#4225898">errorBody</a></span><span class="op" id="4226426">(</span><span class="op" id="4226427">)</span><span class="op" id="4226428">)</span><span class="op" id="4226429">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226437"><a href="/gostd/net/http/server.go.html#4226144">tw</a></span><span class="op" id="4226439">.</span><span class="ident" id="4226440"><a href="/gostd/net/http/server.go.html#4226534">timedOut</a></span>&nbsp;<span class="op" id="4226449">=</span>&nbsp;<span class="builtintype" id="4226451">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226457">}</span><br>
<span class="lineno"></span><span class="op" id="4226459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="4226462">type</span>&nbsp;<span class="ident" id="4226467">timeoutWriter</span>&nbsp;<span class="keyword" id="4226481">struct</span>&nbsp;<span class="op" id="4226488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226491">w</span>&nbsp;<span class="ident" id="4226493"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226510">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226522"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4226526">.</span><span class="ident" id="4226527"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226534">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4226546">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226552">wroteHeader</span>&nbsp;<span class="builtintype" id="4226564">bool</span><br>
<span class="lineno"></span><span class="op" id="4226569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226572">func</span>&nbsp;<span class="op" id="4226577">(</span><span class="ident" id="4226578">tw</span>&nbsp;<span class="op" id="4226581">*</span><span class="ident" id="4226582"><a href="/gostd/net/http/server.go.html#4226467">timeoutWriter</a></span><span class="op" id="4226595">)</span>&nbsp;<span class="ident" id="4226597">Header</span><span class="op" id="4226603">(</span><span class="op" id="4226604">)</span>&nbsp;<span class="ident" id="4226606"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span>&nbsp;<span class="op" id="4226613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226616">return</span>&nbsp;<span class="ident" id="4226623"><a href="/gostd/net/http/server.go.html#4226578">tw</a></span><span class="op" id="4226625">.</span><span class="ident" id="4226626"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4226627">.</span><span class="ident" id="4226628"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="4226634">(</span><span class="op" id="4226635">)</span><br>
<span class="lineno">1945</span><span class="op" id="4226637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226640">func</span>&nbsp;<span class="op" id="4226645">(</span><span class="ident" id="4226646">tw</span>&nbsp;<span class="op" id="4226649">*</span><span class="ident" id="4226650"><a href="/gostd/net/http/server.go.html#4226467">timeoutWriter</a></span><span class="op" id="4226663">)</span>&nbsp;<span class="ident" id="4226665">Write</span><span class="op" id="4226670">(</span><span class="ident" id="4226671">p</span>&nbsp;<span class="op" id="4226673">[</span><span class="op" id="4226674">]</span><span class="builtintype" id="4226675">byte</span><span class="op" id="4226679">)</span>&nbsp;<span class="op" id="4226681">(</span><span class="builtintype" id="4226682">int</span><span class="op" id="4226685">,</span>&nbsp;<span class="builtintype" id="4226687">error</span><span class="op" id="4226692">)</span>&nbsp;<span class="op" id="4226694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226697"><a href="/gostd/net/http/server.go.html#4226646">tw</a></span><span class="op" id="4226699">.</span><span class="ident" id="4226700"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226702">.</span><span class="ident" id="4226703"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4226707">(</span><span class="op" id="4226708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226711">defer</span>&nbsp;<span class="ident" id="4226717"><a href="/gostd/net/http/server.go.html#4226646">tw</a></span><span class="op" id="4226719">.</span><span class="ident" id="4226720"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226722">.</span><span class="ident" id="4226723"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4226729">(</span><span class="op" id="4226730">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226733"><a href="/gostd/net/http/server.go.html#4226646">tw</a></span><span class="op" id="4226735">.</span><span class="ident" id="4226736"><a href="/gostd/net/http/server.go.html#4226552">wroteHeader</a></span>&nbsp;<span class="op" id="4226748">=</span>&nbsp;<span class="builtintype" id="4226750">true</span>&nbsp;<span class="comment" id="4226755">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226779">if</span>&nbsp;<span class="ident" id="4226782"><a href="/gostd/net/http/server.go.html#4226646">tw</a></span><span class="op" id="4226784">.</span><span class="ident" id="4226785"><a href="/gostd/net/http/server.go.html#4226534">timedOut</a></span>&nbsp;<span class="op" id="4226794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226798">return</span>&nbsp;<span class="num" id="4226805">0</span><span class="op" id="4226806">,</span>&nbsp;<span class="ident" id="4226808"><a href="/gostd/net/http/server.go.html#4225679">ErrHandlerTimeout</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226830">return</span>&nbsp;<span class="ident" id="4226837"><a href="/gostd/net/http/server.go.html#4226646">tw</a></span><span class="op" id="4226839">.</span><span class="ident" id="4226840"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4226841">.</span><span class="ident" id="4226842"><a href="/gostd/net/http/server.go.html#4171123">Write</a></span><span class="op" id="4226847">(</span><span class="ident" id="4226848"><a href="/gostd/net/http/server.go.html#4226671">p</a></span><span class="op" id="4226849">)</span><br>
<span class="lineno">1955</span><span class="op" id="4226851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226854">func</span>&nbsp;<span class="op" id="4226859">(</span><span class="ident" id="4226860">tw</span>&nbsp;<span class="op" id="4226863">*</span><span class="ident" id="4226864"><a href="/gostd/net/http/server.go.html#4226467">timeoutWriter</a></span><span class="op" id="4226877">)</span>&nbsp;<span class="ident" id="4226879">WriteHeader</span><span class="op" id="4226890">(</span><span class="ident" id="4226891">code</span>&nbsp;<span class="builtintype" id="4226896">int</span><span class="op" id="4226899">)</span>&nbsp;<span class="op" id="4226901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226904"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4226906">.</span><span class="ident" id="4226907"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226909">.</span><span class="ident" id="4226910"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4226914">(</span><span class="op" id="4226915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226918">defer</span>&nbsp;<span class="ident" id="4226924"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4226926">.</span><span class="ident" id="4226927"><a href="/gostd/net/http/server.go.html#4226510">mu</a></span><span class="op" id="4226929">.</span><span class="ident" id="4226930"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4226936">(</span><span class="op" id="4226937">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226940">if</span>&nbsp;<span class="ident" id="4226943"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4226945">.</span><span class="ident" id="4226946"><a href="/gostd/net/http/server.go.html#4226534">timedOut</a></span>&nbsp;<span class="op" id="4226955">||</span>&nbsp;<span class="ident" id="4226958"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4226960">.</span><span class="ident" id="4226961"><a href="/gostd/net/http/server.go.html#4226552">wroteHeader</a></span>&nbsp;<span class="op" id="4226973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226977">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226988"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4226990">.</span><span class="ident" id="4226991"><a href="/gostd/net/http/server.go.html#4226552">wroteHeader</a></span>&nbsp;<span class="op" id="4227003">=</span>&nbsp;<span class="builtintype" id="4227005">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227011"><a href="/gostd/net/http/server.go.html#4226860">tw</a></span><span class="op" id="4227013">.</span><span class="ident" id="4227014"><a href="/gostd/net/http/server.go.html#4226491">w</a></span><span class="op" id="4227015">.</span><span class="ident" id="4227016"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="4227027">(</span><span class="ident" id="4227028"><a href="/gostd/net/http/server.go.html#4226891">code</a></span><span class="op" id="4227032">)</span><br>
<span class="lineno">1965</span><span class="op" id="4227034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4227037">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="4227102">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="4227171">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="4227241">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="4227253">type</span>&nbsp;<span class="ident" id="4227258">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="4227279">struct</span>&nbsp;<span class="op" id="4227286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227289">*</span><span class="ident" id="4227290"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4227293">.</span><span class="ident" id="4227294"><a href="/gostd/net/tcpsock_posix.go.html#3381906">TCPListener</a></span><br>
<span class="lineno"></span><span class="op" id="4227306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="4227309">func</span>&nbsp;<span class="op" id="4227314">(</span><span class="ident" id="4227315">ln</span>&nbsp;<span class="ident" id="4227318"><a href="/gostd/net/http/server.go.html#4227258">tcpKeepAliveListener</a></span><span class="op" id="4227338">)</span>&nbsp;<span class="ident" id="4227340">Accept</span><span class="op" id="4227346">(</span><span class="op" id="4227347">)</span>&nbsp;<span class="op" id="4227349">(</span><span class="ident" id="4227350">c</span>&nbsp;<span class="ident" id="4227352"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4227355">.</span><span class="ident" id="4227356"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4227360">,</span>&nbsp;<span class="ident" id="4227362">err</span>&nbsp;<span class="builtintype" id="4227366">error</span><span class="op" id="4227371">)</span>&nbsp;<span class="op" id="4227373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227376">tc</span><span class="op" id="4227378">,</span>&nbsp;<span class="ident" id="4227380"><a href="/gostd/net/http/server.go.html#4227362">err</a></span>&nbsp;<span class="op" id="4227384">:=</span>&nbsp;<span class="ident" id="4227387"><a href="/gostd/net/http/server.go.html#4227315">ln</a></span><span class="op" id="4227389">.</span><span class="ident" id="4227390"><a href="/gostd/net/tcpsock_posix.go.html#3382042">AcceptTCP</a></span><span class="op" id="4227399">(</span><span class="op" id="4227400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227403">if</span>&nbsp;<span class="ident" id="4227406"><a href="/gostd/net/http/server.go.html#4227362">err</a></span>&nbsp;<span class="op" id="4227410">!=</span>&nbsp;<span class="builtintype" id="4227413">nil</span>&nbsp;<span class="op" id="4227417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227421">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227429">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227432"><a href="/gostd/net/http/server.go.html#4227376">tc</a></span><span class="op" id="4227434">.</span><span class="ident" id="4227435"><a href="/gostd/net/tcpsock_posix.go.html#3377591">SetKeepAlive</a></span><span class="op" id="4227447">(</span><span class="builtintype" id="4227448">true</span><span class="op" id="4227452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227455"><a href="/gostd/net/http/server.go.html#4227376">tc</a></span><span class="op" id="4227457">.</span><span class="ident" id="4227458"><a href="/gostd/net/tcpsock_posix.go.html#3377783">SetKeepAlivePeriod</a></span><span class="op" id="4227476">(</span><span class="num" id="4227477">3</span>&nbsp;<span class="op" id="4227479">*</span>&nbsp;<span class="ident" id="4227481"><a href="/gostd/net/http/server.go.html#4169434">time</a></span><span class="op" id="4227485">.</span><span class="ident" id="4227486"><a href="/gostd/time/time.go.html#2734905">Minute</a></span><span class="op" id="4227492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227495">return</span>&nbsp;<span class="ident" id="4227502"><a href="/gostd/net/http/server.go.html#4227376">tc</a></span><span class="op" id="4227504">,</span>&nbsp;<span class="builtintype" id="4227506">nil</span><br>
<span class="lineno"></span><span class="op" id="4227510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="4227513">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4227571">type</span>&nbsp;<span class="ident" id="4227576">globalOptionsHandler</span>&nbsp;<span class="keyword" id="4227597">struct</span><span class="op" id="4227603">{</span><span class="op" id="4227604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4227607">func</span>&nbsp;<span class="op" id="4227612">(</span><span class="ident" id="4227613"><a href="/gostd/net/http/server.go.html#4227576">globalOptionsHandler</a></span><span class="op" id="4227633">)</span>&nbsp;<span class="ident" id="4227635">ServeHTTP</span><span class="op" id="4227644">(</span><span class="ident" id="4227645">w</span>&nbsp;<span class="ident" id="4227647"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4227661">,</span>&nbsp;<span class="ident" id="4227663">r</span>&nbsp;<span class="op" id="4227665">*</span><span class="ident" id="4227666"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4227673">)</span>&nbsp;<span class="op" id="4227675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227678"><a href="/gostd/net/http/server.go.html#4227645">w</a></span><span class="op" id="4227679">.</span><span class="ident" id="4227680"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="4227686">(</span><span class="op" id="4227687">)</span><span class="op" id="4227688">.</span><span class="ident" id="4227689"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="4227692">(</span><span class="string" id="4227693">&#34;Content-Length&#34;</span><span class="op" id="4227709">,</span>&nbsp;<span class="string" id="4227711">&#34;0&#34;</span><span class="op" id="4227714">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227717">if</span>&nbsp;<span class="ident" id="4227720"><a href="/gostd/net/http/server.go.html#4227663">r</a></span><span class="op" id="4227721">.</span><span class="ident" id="4227722"><a href="/gostd/net/http/request.go.html#4138292">ContentLength</a></span>&nbsp;<span class="op" id="4227736">!=</span>&nbsp;<span class="num" id="4227739">0</span>&nbsp;<span class="op" id="4227741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227745">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227802">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227860">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227917">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227976">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228024">mb</span>&nbsp;<span class="op" id="4228027">:=</span>&nbsp;<span class="ident" id="4228030"><a href="/gostd/net/http/request.go.html#4154732">MaxBytesReader</a></span><span class="op" id="4228044">(</span><span class="ident" id="4228045"><a href="/gostd/net/http/server.go.html#4227645">w</a></span><span class="op" id="4228046">,</span>&nbsp;<span class="ident" id="4228048"><a href="/gostd/net/http/server.go.html#4227663">r</a></span><span class="op" id="4228049">.</span><span class="ident" id="4228050"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span><span class="op" id="4228054">,</span>&nbsp;<span class="num" id="4228056">4</span><span class="op" id="4228057">&lt;&lt;</span><span class="num" id="4228059">10</span><span class="op" id="4228061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228065"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4228067">.</span><span class="ident" id="4228068"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="4228072">(</span><span class="ident" id="4228073"><a href="/gostd/net/http/server.go.html#4169326">ioutil</a></span><span class="op" id="4228079">.</span><span class="ident" id="4228080"><a href="/gostd/io/ioutil/ioutil.go.html#3768458">Discard</a></span><span class="op" id="4228087">,</span>&nbsp;<span class="ident" id="4228089"><a href="/gostd/net/http/server.go.html#4228024">mb</a></span><span class="op" id="4228091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228094">}</span><br>
<span class="lineno"></span><span class="op" id="4228096">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="4228099">type</span>&nbsp;<span class="ident" id="4228104">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="4228125">struct</span><span class="op" id="4228131">{</span><span class="op" id="4228132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4228135">func</span>&nbsp;<span class="op" id="4228140">(</span><span class="ident" id="4228141"><a href="/gostd/net/http/server.go.html#4228104">eofReaderWithWriteTo</a></span><span class="op" id="4228161">)</span>&nbsp;<span class="ident" id="4228163">WriteTo</span><span class="op" id="4228170">(</span><span class="ident" id="4228171"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4228173">.</span><span class="ident" id="4228174"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><span class="op" id="4228180">)</span>&nbsp;<span class="op" id="4228182">(</span><span class="builtintype" id="4228183">int64</span><span class="op" id="4228188">,</span>&nbsp;<span class="builtintype" id="4228190">error</span><span class="op" id="4228195">)</span>&nbsp;<span class="op" id="4228197">{</span>&nbsp;<span class="keyword" id="4228199">return</span>&nbsp;<span class="num" id="4228206">0</span><span class="op" id="4228207">,</span>&nbsp;<span class="builtintype" id="4228209">nil</span>&nbsp;<span class="op" id="4228213">}</span><br>
<span class="lineno"></span><span class="keyword" id="4228215">func</span>&nbsp;<span class="op" id="4228220">(</span><span class="ident" id="4228221"><a href="/gostd/net/http/server.go.html#4228104">eofReaderWithWriteTo</a></span><span class="op" id="4228241">)</span>&nbsp;<span class="ident" id="4228243">Read</span><span class="op" id="4228247">(</span><span class="op" id="4228248">[</span><span class="op" id="4228249">]</span><span class="builtintype" id="4228250">byte</span><span class="op" id="4228254">)</span>&nbsp;<span class="op" id="4228256">(</span><span class="builtintype" id="4228257">int</span><span class="op" id="4228260">,</span>&nbsp;<span class="builtintype" id="4228262">error</span><span class="op" id="4228267">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228277">{</span>&nbsp;<span class="keyword" id="4228279">return</span>&nbsp;<span class="num" id="4228286">0</span><span class="op" id="4228287">,</span>&nbsp;<span class="ident" id="4228289"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4228291">.</span><span class="ident" id="4228292"><a href="/gostd/io/io.go.html#1419950">EOF</a></span>&nbsp;<span class="op" id="4228296">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="4228299">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="4228364">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4228423">var</span>&nbsp;<span class="ident" id="4228427">eofReader</span>&nbsp;<span class="op" id="4228437">=</span>&nbsp;<span class="op" id="4228439">&amp;</span><span class="keyword" id="4228440">struct</span>&nbsp;<span class="op" id="4228447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228450"><a href="/gostd/net/http/server.go.html#4228104">eofReaderWithWriteTo</a></span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228472"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4228474">.</span><span class="ident" id="4228475"><a href="/gostd/io/io.go.html#1422563">Closer</a></span><br>
<span class="lineno"></span><span class="op" id="4228482">}</span><span class="op" id="4228483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228486"><a href="/gostd/net/http/server.go.html#4228104">eofReaderWithWriteTo</a></span><span class="op" id="4228506">{</span><span class="op" id="4228507">}</span><span class="op" id="4228508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228511"><a href="/gostd/net/http/server.go.html#4169326">ioutil</a></span><span class="op" id="4228517">.</span><span class="ident" id="4228518"><a href="/gostd/io/ioutil/ioutil.go.html#3767601">NopCloser</a></span><span class="op" id="4228527">(</span><span class="builtintype" id="4228528">nil</span><span class="op" id="4228531">)</span><span class="op" id="4228532">,</span><br>
<span class="lineno"></span><span class="op" id="4228534">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="4228537">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4228605">var</span>&nbsp;<span class="ident" id="4228609">_</span>&nbsp;<span class="ident" id="4228611"><a href="/gostd/net/http/server.go.html#4169320">io</a></span><span class="op" id="4228613">.</span><span class="ident" id="4228614"><a href="/gostd/io/io.go.html#1424818">WriterTo</a></span>&nbsp;<span class="op" id="4228623">=</span>&nbsp;<span class="ident" id="4228625"><a href="/gostd/net/http/server.go.html#4228427">eofReader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4228636">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="4228698">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="4228766">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="4228811">type</span>&nbsp;<span class="ident" id="4228816">initNPNRequest</span>&nbsp;<span class="keyword" id="4228831">struct</span>&nbsp;<span class="op" id="4228838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228841">c</span>&nbsp;<span class="op" id="4228843">*</span><span class="ident" id="4228844"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4228847">.</span><span class="ident" id="4228848"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228854">h</span>&nbsp;<span class="ident" id="4228856"><a href="/gostd/net/http/server.go.html#4219662">serverHandler</a></span><br>
<span class="lineno">2025</span><span class="op" id="4228870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4228873">func</span>&nbsp;<span class="op" id="4228878">(</span><span class="ident" id="4228879">h</span>&nbsp;<span class="ident" id="4228881"><a href="/gostd/net/http/server.go.html#4228816">initNPNRequest</a></span><span class="op" id="4228895">)</span>&nbsp;<span class="ident" id="4228897">ServeHTTP</span><span class="op" id="4228906">(</span><span class="ident" id="4228907">rw</span>&nbsp;<span class="ident" id="4228910"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="4228924">,</span>&nbsp;<span class="ident" id="4228926">req</span>&nbsp;<span class="op" id="4228930">*</span><span class="ident" id="4228931"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="4228938">)</span>&nbsp;<span class="op" id="4228940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228943">if</span>&nbsp;<span class="ident" id="4228946"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4228949">.</span><span class="ident" id="4228950"><a href="/gostd/net/http/request.go.html#4141858">TLS</a></span>&nbsp;<span class="op" id="4228954">==</span>&nbsp;<span class="builtintype" id="4228957">nil</span>&nbsp;<span class="op" id="4228961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228965"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4228968">.</span><span class="ident" id="4228969"><a href="/gostd/net/http/request.go.html#4141858">TLS</a></span>&nbsp;<span class="op" id="4228973">=</span>&nbsp;<span class="op" id="4228975">&amp;</span><span class="ident" id="4228976"><a href="/gostd/net/http/server.go.html#4169289">tls</a></span><span class="op" id="4228979">.</span><span class="ident" id="4228980"><a href="/gostd/crypto/tls/common.go.html#4446494">ConnectionState</a></span><span class="op" id="4228995">{</span><span class="op" id="4228996">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229000">*</span><span class="ident" id="4229001"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229004">.</span><span class="ident" id="4229005"><a href="/gostd/net/http/request.go.html#4141858">TLS</a></span>&nbsp;<span class="op" id="4229009">=</span>&nbsp;<span class="ident" id="4229011"><a href="/gostd/net/http/server.go.html#4228879">h</a></span><span class="op" id="4229012">.</span><span class="ident" id="4229013"><a href="/gostd/net/http/server.go.html#4228841">c</a></span><span class="op" id="4229014">.</span><span class="ident" id="4229015"><a href="/gostd/crypto/tls/conn.go.html#4488867">ConnectionState</a></span><span class="op" id="4229030">(</span><span class="op" id="4229031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229037">if</span>&nbsp;<span class="ident" id="4229040"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229043">.</span><span class="ident" id="4229044"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span>&nbsp;<span class="op" id="4229049">==</span>&nbsp;<span class="builtintype" id="4229052">nil</span>&nbsp;<span class="op" id="4229056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229060"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229063">.</span><span class="ident" id="4229064"><a href="/gostd/net/http/request.go.html#4137997">Body</a></span>&nbsp;<span class="op" id="4229069">=</span>&nbsp;<span class="ident" id="4229071"><a href="/gostd/net/http/server.go.html#4228427">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229082">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229085">if</span>&nbsp;<span class="ident" id="4229088"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229091">.</span><span class="ident" id="4229092"><a href="/gostd/net/http/request.go.html#4141200">RemoteAddr</a></span>&nbsp;<span class="op" id="4229103">==</span>&nbsp;<span class="string" id="4229106">&#34;&#34;</span>&nbsp;<span class="op" id="4229109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229113"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229116">.</span><span class="ident" id="4229117"><a href="/gostd/net/http/request.go.html#4141200">RemoteAddr</a></span>&nbsp;<span class="op" id="4229128">=</span>&nbsp;<span class="ident" id="4229130"><a href="/gostd/net/http/server.go.html#4228879">h</a></span><span class="op" id="4229131">.</span><span class="ident" id="4229132"><a href="/gostd/net/http/server.go.html#4228841">c</a></span><span class="op" id="4229133">.</span><span class="ident" id="4229134"><a href="/gostd/crypto/tls/conn.go.html#4463576">RemoteAddr</a></span><span class="op" id="4229144">(</span><span class="op" id="4229145">)</span><span class="op" id="4229146">.</span><span class="ident" id="4229147"><a href="/gostd/net/net.go.html#3334238">String</a></span><span class="op" id="4229153">(</span><span class="op" id="4229154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229160"><a href="/gostd/net/http/server.go.html#4228879">h</a></span><span class="op" id="4229161">.</span><span class="ident" id="4229162"><a href="/gostd/net/http/server.go.html#4228854">h</a></span><span class="op" id="4229163">.</span><span class="ident" id="4229164"><a href="/gostd/net/http/server.go.html#4219725">ServeHTTP</a></span><span class="op" id="4229173">(</span><span class="ident" id="4229174"><a href="/gostd/net/http/server.go.html#4228907">rw</a></span><span class="op" id="4229176">,</span>&nbsp;<span class="ident" id="4229178"><a href="/gostd/net/http/server.go.html#4228926">req</a></span><span class="op" id="4229181">)</span><br>
<span class="lineno"></span><span class="op" id="4229183">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="4229186">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="4229224">type</span>&nbsp;<span class="ident" id="4229229">loggingConn</span>&nbsp;<span class="keyword" id="4229241">struct</span>&nbsp;<span class="op" id="4229248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229251">name</span>&nbsp;<span class="builtintype" id="4229256">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229264"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4229267">.</span><span class="ident" id="4229268"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><br>
<span class="lineno">2045</span><span class="op" id="4229273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4229276">var</span>&nbsp;<span class="op" id="4229280">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229283">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4229296"><a href="/gostd/net/http/server.go.html#4169411">sync</a></span><span class="op" id="4229300">.</span><span class="ident" id="4229301"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229308">uniqNameNext</span>&nbsp;<span class="op" id="4229321">=</span>&nbsp;<span class="builtinfunc" id="4229323">make</span><span class="op" id="4229327">(</span><span class="keyword" id="4229328">map</span><span class="op" id="4229331">[</span><span class="builtintype" id="4229332">string</span><span class="op" id="4229338">]</span><span class="builtintype" id="4229339">int</span><span class="op" id="4229342">)</span><br>
<span class="lineno">2050</span><span class="op" id="4229344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4229347">func</span>&nbsp;<span class="ident" id="4229352">newLoggingConn</span><span class="op" id="4229366">(</span><span class="ident" id="4229367">baseName</span>&nbsp;<span class="builtintype" id="4229376">string</span><span class="op" id="4229382">,</span>&nbsp;<span class="ident" id="4229384">c</span>&nbsp;<span class="ident" id="4229386"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4229389">.</span><span class="ident" id="4229390"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><span class="op" id="4229394">)</span>&nbsp;<span class="ident" id="4229396"><a href="/gostd/net/http/server.go.html#4169346">net</a></span><span class="op" id="4229399">.</span><span class="ident" id="4229400"><a href="/gostd/net/net.go.html#3334417">Conn</a></span>&nbsp;<span class="op" id="4229405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229408"><a href="/gostd/net/http/server.go.html#4229283">uniqNameMu</a></span><span class="op" id="4229418">.</span><span class="ident" id="4229419"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4229423">(</span><span class="op" id="4229424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229427">defer</span>&nbsp;<span class="ident" id="4229433"><a href="/gostd/net/http/server.go.html#4229283">uniqNameMu</a></span><span class="op" id="4229443">.</span><span class="ident" id="4229444"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4229450">(</span><span class="op" id="4229451">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229454"><a href="/gostd/net/http/server.go.html#4229308">uniqNameNext</a></span><span class="op" id="4229466">[</span><span class="ident" id="4229467"><a href="/gostd/net/http/server.go.html#4229367">baseName</a></span><span class="op" id="4229475">]</span><span class="op" id="4229476">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229480">return</span>&nbsp;<span class="op" id="4229487">&amp;</span><span class="ident" id="4229488"><a href="/gostd/net/http/server.go.html#4229229">loggingConn</a></span><span class="op" id="4229499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229503"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4229507">:</span>&nbsp;<span class="ident" id="4229509"><a href="/gostd/net/http/server.go.html#4169313">fmt</a></span><span class="op" id="4229512">.</span><span class="ident" id="4229513"><a href="/gostd/fmt/print.go.html#2143637">Sprintf</a></span><span class="op" id="4229520">(</span><span class="string" id="4229521">&#34;%s-%d&#34;</span><span class="op" id="4229528">,</span>&nbsp;<span class="ident" id="4229530"><a href="/gostd/net/http/server.go.html#4229367">baseName</a></span><span class="op" id="4229538">,</span>&nbsp;<span class="ident" id="4229540"><a href="/gostd/net/http/server.go.html#4229308">uniqNameNext</a></span><span class="op" id="4229552">[</span><span class="ident" id="4229553"><a href="/gostd/net/http/server.go.html#4229367">baseName</a></span><span class="op" id="4229561">]</span><span class="op" id="4229562">)</span><span class="op" id="4229563">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229567"><a href="/gostd/net/http/server.go.html#4229264">Conn</a></span><span class="op" id="4229571">:</span>&nbsp;<span class="ident" id="4229573"><a href="/gostd/net/http/server.go.html#4229384">c</a></span><span class="op" id="4229574">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229577">}</span><br>
<span class="lineno">2060</span><span class="op" id="4229579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4229582">func</span>&nbsp;<span class="op" id="4229587">(</span><span class="ident" id="4229588">c</span>&nbsp;<span class="op" id="4229590">*</span><span class="ident" id="4229591"><a href="/gostd/net/http/server.go.html#4229229">loggingConn</a></span><span class="op" id="4229602">)</span>&nbsp;<span class="ident" id="4229604">Write</span><span class="op" id="4229609">(</span><span class="ident" id="4229610">p</span>&nbsp;<span class="op" id="4229612">[</span><span class="op" id="4229613">]</span><span class="builtintype" id="4229614">byte</span><span class="op" id="4229618">)</span>&nbsp;<span class="op" id="4229620">(</span><span class="ident" id="4229621">n</span>&nbsp;<span class="builtintype" id="4229623">int</span><span class="op" id="4229626">,</span>&nbsp;<span class="ident" id="4229628">err</span>&nbsp;<span class="builtintype" id="4229632">error</span><span class="op" id="4229637">)</span>&nbsp;<span class="op" id="4229639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229642"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4229645">.</span><span class="ident" id="4229646"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4229652">(</span><span class="string" id="4229653">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4229674">,</span>&nbsp;<span class="ident" id="4229676"><a href="/gostd/net/http/server.go.html#4229588">c</a></span><span class="op" id="4229677">.</span><span class="ident" id="4229678"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4229682">,</span>&nbsp;<span class="builtinfunc" id="4229684">len</span><span class="op" id="4229687">(</span><span class="ident" id="4229688"><a href="/gostd/net/http/server.go.html#4229610">p</a></span><span class="op" id="4229689">)</span><span class="op" id="4229690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229693"><a href="/gostd/net/http/server.go.html#4229621">n</a></span><span class="op" id="4229694">,</span>&nbsp;<span class="ident" id="4229696"><a href="/gostd/net/http/server.go.html#4229628">err</a></span>&nbsp;<span class="op" id="4229700">=</span>&nbsp;<span class="ident" id="4229702"><a href="/gostd/net/http/server.go.html#4229588">c</a></span><span class="op" id="4229703">.</span><span class="ident" id="4229704"><a href="/gostd/net/http/server.go.html#4229264">Conn</a></span><span class="op" id="4229708">.</span><span class="ident" id="4229709"><a href="/gostd/net/net.go.html#3334839">Write</a></span><span class="op" id="4229714">(</span><span class="ident" id="4229715"><a href="/gostd/net/http/server.go.html#4229610">p</a></span><span class="op" id="4229716">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229719"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4229722">.</span><span class="ident" id="4229723"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4229729">(</span><span class="string" id="4229730">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4229753">,</span>&nbsp;<span class="ident" id="4229755"><a href="/gostd/net/http/server.go.html#4229588">c</a></span><span class="op" id="4229756">.</span><span class="ident" id="4229757"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4229761">,</span>&nbsp;<span class="builtinfunc" id="4229763">len</span><span class="op" id="4229766">(</span><span class="ident" id="4229767"><a href="/gostd/net/http/server.go.html#4229610">p</a></span><span class="op" id="4229768">)</span><span class="op" id="4229769">,</span>&nbsp;<span class="ident" id="4229771"><a href="/gostd/net/http/server.go.html#4229621">n</a></span><span class="op" id="4229772">,</span>&nbsp;<span class="ident" id="4229774"><a href="/gostd/net/http/server.go.html#4229628">err</a></span><span class="op" id="4229777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229780">return</span><br>
<span class="lineno"></span><span class="op" id="4229787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4229790">func</span>&nbsp;<span class="op" id="4229795">(</span><span class="ident" id="4229796">c</span>&nbsp;<span class="op" id="4229798">*</span><span class="ident" id="4229799"><a href="/gostd/net/http/server.go.html#4229229">loggingConn</a></span><span class="op" id="4229810">)</span>&nbsp;<span class="ident" id="4229812">Read</span><span class="op" id="4229816">(</span><span class="ident" id="4229817">p</span>&nbsp;<span class="op" id="4229819">[</span><span class="op" id="4229820">]</span><span class="builtintype" id="4229821">byte</span><span class="op" id="4229825">)</span>&nbsp;<span class="op" id="4229827">(</span><span class="ident" id="4229828">n</span>&nbsp;<span class="builtintype" id="4229830">int</span><span class="op" id="4229833">,</span>&nbsp;<span class="ident" id="4229835">err</span>&nbsp;<span class="builtintype" id="4229839">error</span><span class="op" id="4229844">)</span>&nbsp;<span class="op" id="4229846">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229849"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4229852">.</span><span class="ident" id="4229853"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4229859">(</span><span class="string" id="4229860">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4229880">,</span>&nbsp;<span class="ident" id="4229882"><a href="/gostd/net/http/server.go.html#4229796">c</a></span><span class="op" id="4229883">.</span><span class="ident" id="4229884"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4229888">,</span>&nbsp;<span class="builtinfunc" id="4229890">len</span><span class="op" id="4229893">(</span><span class="ident" id="4229894"><a href="/gostd/net/http/server.go.html#4229817">p</a></span><span class="op" id="4229895">)</span><span class="op" id="4229896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229899"><a href="/gostd/net/http/server.go.html#4229828">n</a></span><span class="op" id="4229900">,</span>&nbsp;<span class="ident" id="4229902"><a href="/gostd/net/http/server.go.html#4229835">err</a></span>&nbsp;<span class="op" id="4229906">=</span>&nbsp;<span class="ident" id="4229908"><a href="/gostd/net/http/server.go.html#4229796">c</a></span><span class="op" id="4229909">.</span><span class="ident" id="4229910"><a href="/gostd/net/http/server.go.html#4229264">Conn</a></span><span class="op" id="4229914">.</span><span class="ident" id="4229915"><a href="/gostd/net/net.go.html#3334618">Read</a></span><span class="op" id="4229919">(</span><span class="ident" id="4229920"><a href="/gostd/net/http/server.go.html#4229817">p</a></span><span class="op" id="4229921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229924"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4229927">.</span><span class="ident" id="4229928"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4229934">(</span><span class="string" id="4229935">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4229957">,</span>&nbsp;<span class="ident" id="4229959"><a href="/gostd/net/http/server.go.html#4229796">c</a></span><span class="op" id="4229960">.</span><span class="ident" id="4229961"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4229965">,</span>&nbsp;<span class="builtinfunc" id="4229967">len</span><span class="op" id="4229970">(</span><span class="ident" id="4229971"><a href="/gostd/net/http/server.go.html#4229817">p</a></span><span class="op" id="4229972">)</span><span class="op" id="4229973">,</span>&nbsp;<span class="ident" id="4229975"><a href="/gostd/net/http/server.go.html#4229828">n</a></span><span class="op" id="4229976">,</span>&nbsp;<span class="ident" id="4229978"><a href="/gostd/net/http/server.go.html#4229835">err</a></span><span class="op" id="4229981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229984">return</span><br>
<span class="lineno"></span><span class="op" id="4229991">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="4229994">func</span>&nbsp;<span class="op" id="4229999">(</span><span class="ident" id="4230000">c</span>&nbsp;<span class="op" id="4230002">*</span><span class="ident" id="4230003"><a href="/gostd/net/http/server.go.html#4229229">loggingConn</a></span><span class="op" id="4230014">)</span>&nbsp;<span class="ident" id="4230016">Close</span><span class="op" id="4230021">(</span><span class="op" id="4230022">)</span>&nbsp;<span class="op" id="4230024">(</span><span class="ident" id="4230025">err</span>&nbsp;<span class="builtintype" id="4230029">error</span><span class="op" id="4230034">)</span>&nbsp;<span class="op" id="4230036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230039"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4230042">.</span><span class="ident" id="4230043"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4230049">(</span><span class="string" id="4230050">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="4230068">,</span>&nbsp;<span class="ident" id="4230070"><a href="/gostd/net/http/server.go.html#4230000">c</a></span><span class="op" id="4230071">.</span><span class="ident" id="4230072"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4230076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230079"><a href="/gostd/net/http/server.go.html#4230025">err</a></span>&nbsp;<span class="op" id="4230083">=</span>&nbsp;<span class="ident" id="4230085"><a href="/gostd/net/http/server.go.html#4230000">c</a></span><span class="op" id="4230086">.</span><span class="ident" id="4230087"><a href="/gostd/net/http/server.go.html#4229264">Conn</a></span><span class="op" id="4230091">.</span><span class="ident" id="4230092"><a href="/gostd/net/net.go.html#3334987">Close</a></span><span class="op" id="4230097">(</span><span class="op" id="4230098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230101"><a href="/gostd/net/http/server.go.html#4169339">log</a></span><span class="op" id="4230104">.</span><span class="ident" id="4230105"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="4230111">(</span><span class="string" id="4230112">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="4230129">,</span>&nbsp;<span class="ident" id="4230131"><a href="/gostd/net/http/server.go.html#4230000">c</a></span><span class="op" id="4230132">.</span><span class="ident" id="4230133"><a href="/gostd/net/http/server.go.html#4229251">name</a></span><span class="op" id="4230137">,</span>&nbsp;<span class="ident" id="4230139"><a href="/gostd/net/http/server.go.html#4230025">err</a></span><span class="op" id="4230142">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230145">return</span><br>
<span class="lineno"></span><span class="op" id="4230152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4230155">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="4230235">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="4230302">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4230361">type</span>&nbsp;<span class="ident" id="4230366">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="4230387">struct</span>&nbsp;<span class="op" id="4230394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230397">c</span>&nbsp;<span class="op" id="4230399">*</span><span class="ident" id="4230400"><a href="/gostd/net/http/server.go.html#4172792">conn</a></span><br>
<span class="lineno"></span><span class="op" id="4230405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="4230408">func</span>&nbsp;<span class="op" id="4230413">(</span><span class="ident" id="4230414">w</span>&nbsp;<span class="ident" id="4230416"><a href="/gostd/net/http/server.go.html#4230366">checkConnErrorWriter</a></span><span class="op" id="4230436">)</span>&nbsp;<span class="ident" id="4230438">Write</span><span class="op" id="4230443">(</span><span class="ident" id="4230444">p</span>&nbsp;<span class="op" id="4230446">[</span><span class="op" id="4230447">]</span><span class="builtintype" id="4230448">byte</span><span class="op" id="4230452">)</span>&nbsp;<span class="op" id="4230454">(</span><span class="ident" id="4230455">n</span>&nbsp;<span class="builtintype" id="4230457">int</span><span class="op" id="4230460">,</span>&nbsp;<span class="ident" id="4230462">err</span>&nbsp;<span class="builtintype" id="4230466">error</span><span class="op" id="4230471">)</span>&nbsp;<span class="op" id="4230473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230476"><a href="/gostd/net/http/server.go.html#4230455">n</a></span><span class="op" id="4230477">,</span>&nbsp;<span class="ident" id="4230479"><a href="/gostd/net/http/server.go.html#4230462">err</a></span>&nbsp;<span class="op" id="4230483">=</span>&nbsp;<span class="ident" id="4230485"><a href="/gostd/net/http/server.go.html#4230414">w</a></span><span class="op" id="4230486">.</span><span class="ident" id="4230487"><a href="/gostd/net/http/server.go.html#4230397">c</a></span><span class="op" id="4230488">.</span><span class="ident" id="4230489"><a href="/gostd/net/http/server.go.html#4173004">w</a></span><span class="op" id="4230490">.</span><span class="ident" id="4230491"><a href="/gostd/io/io.go.html#1422334">Write</a></span><span class="op" id="4230496">(</span><span class="ident" id="4230497"><a href="/gostd/net/http/server.go.html#4230444">p</a></span><span class="op" id="4230498">)</span>&nbsp;<span class="comment" id="4230500">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230558">if</span>&nbsp;<span class="ident" id="4230561"><a href="/gostd/net/http/server.go.html#4230462">err</a></span>&nbsp;<span class="op" id="4230565">!=</span>&nbsp;<span class="builtintype" id="4230568">nil</span>&nbsp;<span class="op" id="4230572">&amp;&amp;</span>&nbsp;<span class="ident" id="4230575"><a href="/gostd/net/http/server.go.html#4230414">w</a></span><span class="op" id="4230576">.</span><span class="ident" id="4230577"><a href="/gostd/net/http/server.go.html#4230397">c</a></span><span class="op" id="4230578">.</span><span class="ident" id="4230579"><a href="/gostd/net/http/server.go.html#4173097">werr</a></span>&nbsp;<span class="op" id="4230584">==</span>&nbsp;<span class="builtintype" id="4230587">nil</span>&nbsp;<span class="op" id="4230591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230595"><a href="/gostd/net/http/server.go.html#4230414">w</a></span><span class="op" id="4230596">.</span><span class="ident" id="4230597"><a href="/gostd/net/http/server.go.html#4230397">c</a></span><span class="op" id="4230598">.</span><span class="ident" id="4230599"><a href="/gostd/net/http/server.go.html#4173097">werr</a></span>&nbsp;<span class="op" id="4230604">=</span>&nbsp;<span class="ident" id="4230606"><a href="/gostd/net/http/server.go.html#4230462">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230611">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230614">return</span><br>
<span class="lineno"></span><span class="op" id="4230621">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
