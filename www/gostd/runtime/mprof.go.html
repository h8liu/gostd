<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1789280">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1789335">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1789389">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1789440">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1789461">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1789518">package</span>&nbsp;<span class="ident" id="1789526">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1789535">import</span>&nbsp;<span class="op" id="1789542">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1789545">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1789554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1789557">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1789632">var</span>&nbsp;<span class="ident" id="1789636">proflock</span>&nbsp;<span class="ident" id="1789645">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1789652">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1789731">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1789805">const</span>&nbsp;<span class="op" id="1789811">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1789814">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789832">memProfile</span>&nbsp;<span class="ident" id="1789843">bucketType</span>&nbsp;<span class="op" id="1789854">=</span>&nbsp;<span class="num" id="1789856">1</span>&nbsp;<span class="op" id="1789858">+</span>&nbsp;<span class="ident" id="1789860">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789866">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1789881">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789911">buckHashSize</span>&nbsp;<span class="op" id="1789924">=</span>&nbsp;<span class="num" id="1789926">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1789935">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1789978">maxStack</span>&nbsp;<span class="op" id="1789987">=</span>&nbsp;<span class="num" id="1789989">32</span><br>
<span class="lineno">30</span><span class="op" id="1789992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1789995">type</span>&nbsp;<span class="ident" id="1790000">bucketType</span>&nbsp;<span class="builtintype" id="1790011">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1790016">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1790072">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1790129">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1790189">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1790245">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1790291">//</span><br>
<span class="lineno">40</span><span class="comment" id="1790294">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1790335">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1790398">type</span>&nbsp;<span class="ident" id="1790403">bucket</span>&nbsp;<span class="keyword" id="1790410">struct</span>&nbsp;<span class="op" id="1790417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790420">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1790428">*</span><span class="ident" id="1790429">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790437">allnext</span>&nbsp;<span class="op" id="1790445">*</span><span class="ident" id="1790446">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790454">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1790462">bucketType</span>&nbsp;<span class="comment" id="1790473">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790502">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1790510">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790519">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1790527">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1790536">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1790544">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1790552">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1790555">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1790622">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1790653">type</span>&nbsp;<span class="ident" id="1790658">memRecord</span>&nbsp;<span class="keyword" id="1790668">struct</span>&nbsp;<span class="op" id="1790675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790678">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790741">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790809">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790837">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790900">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1790968">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791028">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791032">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791075">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791125">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791167">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791220">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791264">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791276">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791285">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791297">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791306">alloc_bytes</span>&nbsp;<span class="builtintype" id="1791318">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791327">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1791339">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791349">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791397">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791414">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791423">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791440">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791449">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1791466">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791475">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1791492">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1791502">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791528">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791547">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791556">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1791575">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791584">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1791603">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791612">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1791631">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1791639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1791642">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1791713">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1791746">type</span>&nbsp;<span class="ident" id="1791751">blockRecord</span>&nbsp;<span class="keyword" id="1791763">struct</span>&nbsp;<span class="op" id="1791770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791773">count</span>&nbsp;&nbsp;<span class="ident" id="1791780">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791787">cycles</span>&nbsp;<span class="ident" id="1791794">int64</span><br>
<span class="lineno"></span><span class="op" id="1791800">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1791803">var</span>&nbsp;<span class="op" id="1791807">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791810">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1791820">*</span><span class="ident" id="1791821">bucket</span>&nbsp;<span class="comment" id="1791828">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791855">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1791865">*</span><span class="ident" id="1791866">bucket</span>&nbsp;<span class="comment" id="1791873">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791902">buckhash</span>&nbsp;&nbsp;<span class="op" id="1791912">*</span><span class="op" id="1791913">[</span><span class="num" id="1791914">179999</span><span class="op" id="1791920">]</span><span class="op" id="1791921">*</span><span class="ident" id="1791922">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1791930">bucketmem</span>&nbsp;<span class="builtintype" id="1791940">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1791948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1791951">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1792032">func</span>&nbsp;<span class="ident" id="1792037">newBucket</span><span class="op" id="1792046">(</span><span class="ident" id="1792047">typ</span>&nbsp;<span class="ident" id="1792051">bucketType</span><span class="op" id="1792061">,</span>&nbsp;<span class="ident" id="1792063">nstk</span>&nbsp;<span class="builtintype" id="1792068">int</span><span class="op" id="1792071">)</span>&nbsp;<span class="op" id="1792073">*</span><span class="ident" id="1792074">bucket</span>&nbsp;<span class="op" id="1792081">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792084">size</span>&nbsp;<span class="op" id="1792089">:=</span>&nbsp;<span class="ident" id="1792092">unsafe</span><span class="op" id="1792098">.</span><span class="ident" id="1792099">Sizeof</span><span class="op" id="1792105">(</span><span class="ident" id="1792106">bucket</span><span class="op" id="1792112">{</span><span class="op" id="1792113">}</span><span class="op" id="1792114">)</span>&nbsp;<span class="op" id="1792116">+</span>&nbsp;<span class="builtintype" id="1792118">uintptr</span><span class="op" id="1792125">(</span><span class="ident" id="1792126">nstk</span><span class="op" id="1792130">)</span><span class="op" id="1792131">*</span><span class="ident" id="1792132">unsafe</span><span class="op" id="1792138">.</span><span class="ident" id="1792139">Sizeof</span><span class="op" id="1792145">(</span><span class="builtintype" id="1792146">uintptr</span><span class="op" id="1792153">(</span><span class="num" id="1792154">0</span><span class="op" id="1792155">)</span><span class="op" id="1792156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792159">switch</span>&nbsp;<span class="ident" id="1792166">typ</span>&nbsp;<span class="op" id="1792170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792173">default</span><span class="op" id="1792180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792184">gothrow</span><span class="op" id="1792191">(</span><span class="string" id="1792192">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1792221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792224">case</span>&nbsp;<span class="ident" id="1792229">memProfile</span><span class="op" id="1792239">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792243">size</span>&nbsp;<span class="op" id="1792248">+=</span>&nbsp;<span class="ident" id="1792251">unsafe</span><span class="op" id="1792257">.</span><span class="ident" id="1792258">Sizeof</span><span class="op" id="1792264">(</span><span class="ident" id="1792265">memRecord</span><span class="op" id="1792274">{</span><span class="op" id="1792275">}</span><span class="op" id="1792276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792279">case</span>&nbsp;<span class="ident" id="1792284">blockProfile</span><span class="op" id="1792296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792300">size</span>&nbsp;<span class="op" id="1792305">+=</span>&nbsp;<span class="ident" id="1792308">unsafe</span><span class="op" id="1792314">.</span><span class="ident" id="1792315">Sizeof</span><span class="op" id="1792321">(</span><span class="ident" id="1792322">blockRecord</span><span class="op" id="1792333">{</span><span class="op" id="1792334">}</span><span class="op" id="1792335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1792338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792342">b</span>&nbsp;<span class="op" id="1792344">:=</span>&nbsp;<span class="op" id="1792347">(</span><span class="op" id="1792348">*</span><span class="ident" id="1792349">bucket</span><span class="op" id="1792355">)</span><span class="op" id="1792356">(</span><span class="ident" id="1792357">persistentalloc</span><span class="op" id="1792372">(</span><span class="ident" id="1792373">size</span><span class="op" id="1792377">,</span>&nbsp;<span class="num" id="1792379">0</span><span class="op" id="1792380">,</span>&nbsp;<span class="op" id="1792382">&amp;</span><span class="ident" id="1792383">memstats</span><span class="op" id="1792391">.</span><span class="ident" id="1792392">buckhash_sys</span><span class="op" id="1792404">)</span><span class="op" id="1792405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792408">bucketmem</span>&nbsp;<span class="op" id="1792418">+=</span>&nbsp;<span class="ident" id="1792421">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792427">b</span><span class="op" id="1792428">.</span><span class="ident" id="1792429">typ</span>&nbsp;<span class="op" id="1792433">=</span>&nbsp;<span class="ident" id="1792435">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792440">b</span><span class="op" id="1792441">.</span><span class="ident" id="1792442">nstk</span>&nbsp;<span class="op" id="1792447">=</span>&nbsp;<span class="builtintype" id="1792449">uintptr</span><span class="op" id="1792456">(</span><span class="ident" id="1792457">nstk</span><span class="op" id="1792461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792464">return</span>&nbsp;<span class="ident" id="1792471">b</span><br>
<span class="lineno">115</span><span class="op" id="1792473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1792476">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1792525">func</span>&nbsp;<span class="op" id="1792530">(</span><span class="ident" id="1792531">b</span>&nbsp;<span class="op" id="1792533">*</span><span class="ident" id="1792534">bucket</span><span class="op" id="1792540">)</span>&nbsp;<span class="ident" id="1792542">stk</span><span class="op" id="1792545">(</span><span class="op" id="1792546">)</span>&nbsp;<span class="op" id="1792548">[</span><span class="op" id="1792549">]</span><span class="builtintype" id="1792550">uintptr</span>&nbsp;<span class="op" id="1792558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792561">stk</span>&nbsp;<span class="op" id="1792565">:=</span>&nbsp;<span class="op" id="1792568">(</span><span class="op" id="1792569">*</span><span class="op" id="1792570">[</span><span class="ident" id="1792571">maxStack</span><span class="op" id="1792579">]</span><span class="builtintype" id="1792580">uintptr</span><span class="op" id="1792587">)</span><span class="op" id="1792588">(</span><span class="ident" id="1792589">add</span><span class="op" id="1792592">(</span><span class="ident" id="1792593">unsafe</span><span class="op" id="1792599">.</span><span class="ident" id="1792600">Pointer</span><span class="op" id="1792607">(</span><span class="ident" id="1792608">b</span><span class="op" id="1792609">)</span><span class="op" id="1792610">,</span>&nbsp;<span class="ident" id="1792612">unsafe</span><span class="op" id="1792618">.</span><span class="ident" id="1792619">Sizeof</span><span class="op" id="1792625">(</span><span class="op" id="1792626">*</span><span class="ident" id="1792627">b</span><span class="op" id="1792628">)</span><span class="op" id="1792629">)</span><span class="op" id="1792630">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792633">return</span>&nbsp;<span class="ident" id="1792640">stk</span><span class="op" id="1792643">[</span><span class="op" id="1792644">:</span><span class="ident" id="1792645">b</span><span class="op" id="1792646">.</span><span class="ident" id="1792647">nstk</span><span class="op" id="1792651">:</span><span class="ident" id="1792652">b</span><span class="op" id="1792653">.</span><span class="ident" id="1792654">nstk</span><span class="op" id="1792658">]</span><br>
<span class="lineno"></span><span class="op" id="1792660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1792663">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1792732">func</span>&nbsp;<span class="op" id="1792737">(</span><span class="ident" id="1792738">b</span>&nbsp;<span class="op" id="1792740">*</span><span class="ident" id="1792741">bucket</span><span class="op" id="1792747">)</span>&nbsp;<span class="ident" id="1792749">mp</span><span class="op" id="1792751">(</span><span class="op" id="1792752">)</span>&nbsp;<span class="op" id="1792754">*</span><span class="ident" id="1792755">memRecord</span>&nbsp;<span class="op" id="1792765">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792768">if</span>&nbsp;<span class="ident" id="1792771">b</span><span class="op" id="1792772">.</span><span class="ident" id="1792773">typ</span>&nbsp;<span class="op" id="1792777">!=</span>&nbsp;<span class="ident" id="1792780">memProfile</span>&nbsp;<span class="op" id="1792791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792795">gothrow</span><span class="op" id="1792802">(</span><span class="string" id="1792803">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1792825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1792828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1792831">data</span>&nbsp;<span class="op" id="1792836">:=</span>&nbsp;<span class="ident" id="1792839">add</span><span class="op" id="1792842">(</span><span class="ident" id="1792843">unsafe</span><span class="op" id="1792849">.</span><span class="ident" id="1792850">Pointer</span><span class="op" id="1792857">(</span><span class="ident" id="1792858">b</span><span class="op" id="1792859">)</span><span class="op" id="1792860">,</span>&nbsp;<span class="ident" id="1792862">unsafe</span><span class="op" id="1792868">.</span><span class="ident" id="1792869">Sizeof</span><span class="op" id="1792875">(</span><span class="op" id="1792876">*</span><span class="ident" id="1792877">b</span><span class="op" id="1792878">)</span><span class="op" id="1792879">+</span><span class="ident" id="1792880">b</span><span class="op" id="1792881">.</span><span class="ident" id="1792882">nstk</span><span class="op" id="1792886">*</span><span class="ident" id="1792887">unsafe</span><span class="op" id="1792893">.</span><span class="ident" id="1792894">Sizeof</span><span class="op" id="1792900">(</span><span class="builtintype" id="1792901">uintptr</span><span class="op" id="1792908">(</span><span class="num" id="1792909">0</span><span class="op" id="1792910">)</span><span class="op" id="1792911">)</span><span class="op" id="1792912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1792915">return</span>&nbsp;<span class="op" id="1792922">(</span><span class="op" id="1792923">*</span><span class="ident" id="1792924">memRecord</span><span class="op" id="1792933">)</span><span class="op" id="1792934">(</span><span class="ident" id="1792935">data</span><span class="op" id="1792939">)</span><br>
<span class="lineno">130</span><span class="op" id="1792941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1792944">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1793017">func</span>&nbsp;<span class="op" id="1793022">(</span><span class="ident" id="1793023">b</span>&nbsp;<span class="op" id="1793025">*</span><span class="ident" id="1793026">bucket</span><span class="op" id="1793032">)</span>&nbsp;<span class="ident" id="1793034">bp</span><span class="op" id="1793036">(</span><span class="op" id="1793037">)</span>&nbsp;<span class="op" id="1793039">*</span><span class="ident" id="1793040">blockRecord</span>&nbsp;<span class="op" id="1793052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793055">if</span>&nbsp;<span class="ident" id="1793058">b</span><span class="op" id="1793059">.</span><span class="ident" id="1793060">typ</span>&nbsp;<span class="op" id="1793064">!=</span>&nbsp;<span class="ident" id="1793067">blockProfile</span>&nbsp;<span class="op" id="1793080">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793084">gothrow</span><span class="op" id="1793091">(</span><span class="string" id="1793092">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1793114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793120">data</span>&nbsp;<span class="op" id="1793125">:=</span>&nbsp;<span class="ident" id="1793128">add</span><span class="op" id="1793131">(</span><span class="ident" id="1793132">unsafe</span><span class="op" id="1793138">.</span><span class="ident" id="1793139">Pointer</span><span class="op" id="1793146">(</span><span class="ident" id="1793147">b</span><span class="op" id="1793148">)</span><span class="op" id="1793149">,</span>&nbsp;<span class="ident" id="1793151">unsafe</span><span class="op" id="1793157">.</span><span class="ident" id="1793158">Sizeof</span><span class="op" id="1793164">(</span><span class="op" id="1793165">*</span><span class="ident" id="1793166">b</span><span class="op" id="1793167">)</span><span class="op" id="1793168">+</span><span class="ident" id="1793169">b</span><span class="op" id="1793170">.</span><span class="ident" id="1793171">nstk</span><span class="op" id="1793175">*</span><span class="ident" id="1793176">unsafe</span><span class="op" id="1793182">.</span><span class="ident" id="1793183">Sizeof</span><span class="op" id="1793189">(</span><span class="builtintype" id="1793190">uintptr</span><span class="op" id="1793197">(</span><span class="num" id="1793198">0</span><span class="op" id="1793199">)</span><span class="op" id="1793200">)</span><span class="op" id="1793201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793204">return</span>&nbsp;<span class="op" id="1793211">(</span><span class="op" id="1793212">*</span><span class="ident" id="1793213">blockRecord</span><span class="op" id="1793224">)</span><span class="op" id="1793225">(</span><span class="ident" id="1793226">data</span><span class="op" id="1793230">)</span><br>
<span class="lineno"></span><span class="op" id="1793232">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1793235">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1793306">func</span>&nbsp;<span class="ident" id="1793311">stkbucket</span><span class="op" id="1793320">(</span><span class="ident" id="1793321">typ</span>&nbsp;<span class="ident" id="1793325">bucketType</span><span class="op" id="1793335">,</span>&nbsp;<span class="ident" id="1793337">size</span>&nbsp;<span class="builtintype" id="1793342">uintptr</span><span class="op" id="1793349">,</span>&nbsp;<span class="ident" id="1793351">stk</span>&nbsp;<span class="op" id="1793355">[</span><span class="op" id="1793356">]</span><span class="builtintype" id="1793357">uintptr</span><span class="op" id="1793364">,</span>&nbsp;<span class="ident" id="1793366">alloc</span>&nbsp;<span class="builtintype" id="1793372">bool</span><span class="op" id="1793376">)</span>&nbsp;<span class="op" id="1793378">*</span><span class="ident" id="1793379">bucket</span>&nbsp;<span class="op" id="1793386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793389">if</span>&nbsp;<span class="ident" id="1793392">buckhash</span>&nbsp;<span class="op" id="1793401">==</span>&nbsp;<span class="ident" id="1793404">nil</span>&nbsp;<span class="op" id="1793408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793412">buckhash</span>&nbsp;<span class="op" id="1793421">=</span>&nbsp;<span class="op" id="1793423">(</span><span class="op" id="1793424">*</span><span class="op" id="1793425">[</span><span class="ident" id="1793426">buckHashSize</span><span class="op" id="1793438">]</span><span class="op" id="1793439">*</span><span class="ident" id="1793440">bucket</span><span class="op" id="1793446">)</span><span class="op" id="1793447">(</span><span class="ident" id="1793448">sysAlloc</span><span class="op" id="1793456">(</span><span class="ident" id="1793457">unsafe</span><span class="op" id="1793463">.</span><span class="ident" id="1793464">Sizeof</span><span class="op" id="1793470">(</span><span class="op" id="1793471">*</span><span class="ident" id="1793472">buckhash</span><span class="op" id="1793480">)</span><span class="op" id="1793481">,</span>&nbsp;<span class="op" id="1793483">&amp;</span><span class="ident" id="1793484">memstats</span><span class="op" id="1793492">.</span><span class="ident" id="1793493">buckhash_sys</span><span class="op" id="1793505">)</span><span class="op" id="1793506">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793510">if</span>&nbsp;<span class="ident" id="1793513">buckhash</span>&nbsp;<span class="op" id="1793522">==</span>&nbsp;<span class="ident" id="1793525">nil</span>&nbsp;<span class="op" id="1793529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793534">gothrow</span><span class="op" id="1793541">(</span><span class="string" id="1793542">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1793575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1793586">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793602">var</span>&nbsp;<span class="ident" id="1793606">h</span>&nbsp;<span class="builtintype" id="1793608">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793617">for</span>&nbsp;<span class="ident" id="1793621">_</span><span class="op" id="1793622">,</span>&nbsp;<span class="ident" id="1793624">pc</span>&nbsp;<span class="op" id="1793627">:=</span>&nbsp;<span class="keyword" id="1793630">range</span>&nbsp;<span class="ident" id="1793636">stk</span>&nbsp;<span class="op" id="1793640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793644">h</span>&nbsp;<span class="op" id="1793646">+=</span>&nbsp;<span class="ident" id="1793649">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793654">h</span>&nbsp;<span class="op" id="1793656">+=</span>&nbsp;<span class="ident" id="1793659">h</span>&nbsp;<span class="op" id="1793661">&lt;&lt;</span>&nbsp;<span class="num" id="1793664">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793669">h</span>&nbsp;<span class="op" id="1793671">^=</span>&nbsp;<span class="ident" id="1793674">h</span>&nbsp;<span class="op" id="1793676">&gt;&gt;</span>&nbsp;<span class="num" id="1793679">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1793685">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793702">h</span>&nbsp;<span class="op" id="1793704">+=</span>&nbsp;<span class="ident" id="1793707">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793713">h</span>&nbsp;<span class="op" id="1793715">+=</span>&nbsp;<span class="ident" id="1793718">h</span>&nbsp;<span class="op" id="1793720">&lt;&lt;</span>&nbsp;<span class="num" id="1793723">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793727">h</span>&nbsp;<span class="op" id="1793729">^=</span>&nbsp;<span class="ident" id="1793732">h</span>&nbsp;<span class="op" id="1793734">&gt;&gt;</span>&nbsp;<span class="num" id="1793737">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1793740">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793753">h</span>&nbsp;<span class="op" id="1793755">+=</span>&nbsp;<span class="ident" id="1793758">h</span>&nbsp;<span class="op" id="1793760">&lt;&lt;</span>&nbsp;<span class="num" id="1793763">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793766">h</span>&nbsp;<span class="op" id="1793768">^=</span>&nbsp;<span class="ident" id="1793771">h</span>&nbsp;<span class="op" id="1793773">&gt;&gt;</span>&nbsp;<span class="num" id="1793776">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1793781">i</span>&nbsp;<span class="op" id="1793783">:=</span>&nbsp;<span class="builtintype" id="1793786">int</span><span class="op" id="1793789">(</span><span class="ident" id="1793790">h</span>&nbsp;<span class="op" id="1793792">%</span>&nbsp;<span class="ident" id="1793794">buckHashSize</span><span class="op" id="1793806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793809">for</span>&nbsp;<span class="ident" id="1793813">b</span>&nbsp;<span class="op" id="1793815">:=</span>&nbsp;<span class="ident" id="1793818">buckhash</span><span class="op" id="1793826">[</span><span class="ident" id="1793827">i</span><span class="op" id="1793828">]</span><span class="op" id="1793829">;</span>&nbsp;<span class="ident" id="1793831">b</span>&nbsp;<span class="op" id="1793833">!=</span>&nbsp;<span class="ident" id="1793836">nil</span><span class="op" id="1793839">;</span>&nbsp;<span class="ident" id="1793841">b</span>&nbsp;<span class="op" id="1793843">=</span>&nbsp;<span class="ident" id="1793845">b</span><span class="op" id="1793846">.</span><span class="ident" id="1793847">next</span>&nbsp;<span class="op" id="1793852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793856">if</span>&nbsp;<span class="ident" id="1793859">b</span><span class="op" id="1793860">.</span><span class="ident" id="1793861">typ</span>&nbsp;<span class="op" id="1793865">==</span>&nbsp;<span class="ident" id="1793868">typ</span>&nbsp;<span class="op" id="1793872">&amp;&amp;</span>&nbsp;<span class="ident" id="1793875">b</span><span class="op" id="1793876">.</span><span class="ident" id="1793877">hash</span>&nbsp;<span class="op" id="1793882">==</span>&nbsp;<span class="ident" id="1793885">h</span>&nbsp;<span class="op" id="1793887">&amp;&amp;</span>&nbsp;<span class="ident" id="1793890">b</span><span class="op" id="1793891">.</span><span class="ident" id="1793892">size</span>&nbsp;<span class="op" id="1793897">==</span>&nbsp;<span class="ident" id="1793900">size</span>&nbsp;<span class="op" id="1793905">&amp;&amp;</span>&nbsp;<span class="ident" id="1793908">eqslice</span><span class="op" id="1793915">(</span><span class="ident" id="1793916">b</span><span class="op" id="1793917">.</span><span class="ident" id="1793918">stk</span><span class="op" id="1793921">(</span><span class="op" id="1793922">)</span><span class="op" id="1793923">,</span>&nbsp;<span class="ident" id="1793925">stk</span><span class="op" id="1793928">)</span>&nbsp;<span class="op" id="1793930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793935">return</span>&nbsp;<span class="ident" id="1793942">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793946">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793953">if</span>&nbsp;<span class="op" id="1793956">!</span><span class="ident" id="1793957">alloc</span>&nbsp;<span class="op" id="1793963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1793967">return</span>&nbsp;<span class="ident" id="1793974">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1793979">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1793983">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794006">b</span>&nbsp;<span class="op" id="1794008">:=</span>&nbsp;<span class="ident" id="1794011">newBucket</span><span class="op" id="1794020">(</span><span class="ident" id="1794021">typ</span><span class="op" id="1794024">,</span>&nbsp;<span class="builtinfunc" id="1794026">len</span><span class="op" id="1794029">(</span><span class="ident" id="1794030">stk</span><span class="op" id="1794033">)</span><span class="op" id="1794034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1794037">copy</span><span class="op" id="1794041">(</span><span class="ident" id="1794042">b</span><span class="op" id="1794043">.</span><span class="ident" id="1794044">stk</span><span class="op" id="1794047">(</span><span class="op" id="1794048">)</span><span class="op" id="1794049">,</span>&nbsp;<span class="ident" id="1794051">stk</span><span class="op" id="1794054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794057">b</span><span class="op" id="1794058">.</span><span class="ident" id="1794059">hash</span>&nbsp;<span class="op" id="1794064">=</span>&nbsp;<span class="ident" id="1794066">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794069">b</span><span class="op" id="1794070">.</span><span class="ident" id="1794071">size</span>&nbsp;<span class="op" id="1794076">=</span>&nbsp;<span class="ident" id="1794078">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794084">b</span><span class="op" id="1794085">.</span><span class="ident" id="1794086">next</span>&nbsp;<span class="op" id="1794091">=</span>&nbsp;<span class="ident" id="1794093">buckhash</span><span class="op" id="1794101">[</span><span class="ident" id="1794102">i</span><span class="op" id="1794103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794106">buckhash</span><span class="op" id="1794114">[</span><span class="ident" id="1794115">i</span><span class="op" id="1794116">]</span>&nbsp;<span class="op" id="1794118">=</span>&nbsp;<span class="ident" id="1794120">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794123">if</span>&nbsp;<span class="ident" id="1794126">typ</span>&nbsp;<span class="op" id="1794130">==</span>&nbsp;<span class="ident" id="1794133">memProfile</span>&nbsp;<span class="op" id="1794144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794148">b</span><span class="op" id="1794149">.</span><span class="ident" id="1794150">allnext</span>&nbsp;<span class="op" id="1794158">=</span>&nbsp;<span class="ident" id="1794160">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794171">mbuckets</span>&nbsp;<span class="op" id="1794180">=</span>&nbsp;<span class="ident" id="1794182">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794185">}</span>&nbsp;<span class="keyword" id="1794187">else</span>&nbsp;<span class="op" id="1794192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794196">b</span><span class="op" id="1794197">.</span><span class="ident" id="1794198">allnext</span>&nbsp;<span class="op" id="1794206">=</span>&nbsp;<span class="ident" id="1794208">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794219">bbuckets</span>&nbsp;<span class="op" id="1794228">=</span>&nbsp;<span class="ident" id="1794230">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794233">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794236">return</span>&nbsp;<span class="ident" id="1794243">b</span><br>
<span class="lineno"></span><span class="op" id="1794245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1794248">func</span>&nbsp;<span class="ident" id="1794253">sysAlloc</span><span class="op" id="1794261">(</span><span class="ident" id="1794262">n</span>&nbsp;<span class="builtintype" id="1794264">uintptr</span><span class="op" id="1794271">,</span>&nbsp;<span class="ident" id="1794273">stat</span>&nbsp;<span class="op" id="1794278">*</span><span class="ident" id="1794279">uint64</span><span class="op" id="1794285">)</span>&nbsp;<span class="ident" id="1794287">unsafe</span><span class="op" id="1794293">.</span><span class="ident" id="1794294">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1794303">func</span>&nbsp;<span class="ident" id="1794308">eqslice</span><span class="op" id="1794315">(</span><span class="ident" id="1794316">x</span><span class="op" id="1794317">,</span>&nbsp;<span class="ident" id="1794319">y</span>&nbsp;<span class="op" id="1794321">[</span><span class="op" id="1794322">]</span><span class="builtintype" id="1794323">uintptr</span><span class="op" id="1794330">)</span>&nbsp;<span class="builtintype" id="1794332">bool</span>&nbsp;<span class="op" id="1794337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794340">if</span>&nbsp;<span class="builtinfunc" id="1794343">len</span><span class="op" id="1794346">(</span><span class="ident" id="1794347">x</span><span class="op" id="1794348">)</span>&nbsp;<span class="op" id="1794350">!=</span>&nbsp;<span class="builtinfunc" id="1794353">len</span><span class="op" id="1794356">(</span><span class="ident" id="1794357">y</span><span class="op" id="1794358">)</span>&nbsp;<span class="op" id="1794360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794364">return</span>&nbsp;<span class="builtintype" id="1794371">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794381">for</span>&nbsp;<span class="ident" id="1794385">i</span><span class="op" id="1794386">,</span>&nbsp;<span class="ident" id="1794388">xi</span>&nbsp;<span class="op" id="1794391">:=</span>&nbsp;<span class="keyword" id="1794394">range</span>&nbsp;<span class="ident" id="1794400">x</span>&nbsp;<span class="op" id="1794402">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794406">if</span>&nbsp;<span class="ident" id="1794409">xi</span>&nbsp;<span class="op" id="1794412">!=</span>&nbsp;<span class="ident" id="1794415">y</span><span class="op" id="1794416">[</span><span class="ident" id="1794417">i</span><span class="op" id="1794418">]</span>&nbsp;<span class="op" id="1794420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794425">return</span>&nbsp;<span class="builtintype" id="1794432">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794446">return</span>&nbsp;<span class="builtintype" id="1794453">true</span><br>
<span class="lineno">205</span><span class="op" id="1794458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1794461">func</span>&nbsp;<span class="ident" id="1794466">mprof_GC</span><span class="op" id="1794474">(</span><span class="op" id="1794475">)</span>&nbsp;<span class="op" id="1794477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1794480">for</span>&nbsp;<span class="ident" id="1794484">b</span>&nbsp;<span class="op" id="1794486">:=</span>&nbsp;<span class="ident" id="1794489">mbuckets</span><span class="op" id="1794497">;</span>&nbsp;<span class="ident" id="1794499">b</span>&nbsp;<span class="op" id="1794501">!=</span>&nbsp;<span class="ident" id="1794504">nil</span><span class="op" id="1794507">;</span>&nbsp;<span class="ident" id="1794509">b</span>&nbsp;<span class="op" id="1794511">=</span>&nbsp;<span class="ident" id="1794513">b</span><span class="op" id="1794514">.</span><span class="ident" id="1794515">allnext</span>&nbsp;<span class="op" id="1794523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794527">mp</span>&nbsp;<span class="op" id="1794530">:=</span>&nbsp;<span class="ident" id="1794533">b</span><span class="op" id="1794534">.</span><span class="ident" id="1794535">mp</span><span class="op" id="1794537">(</span><span class="op" id="1794538">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794542">mp</span><span class="op" id="1794544">.</span><span class="ident" id="1794545">allocs</span>&nbsp;<span class="op" id="1794552">+=</span>&nbsp;<span class="ident" id="1794555">mp</span><span class="op" id="1794557">.</span><span class="ident" id="1794558">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794572">mp</span><span class="op" id="1794574">.</span><span class="ident" id="1794575">frees</span>&nbsp;<span class="op" id="1794581">+=</span>&nbsp;<span class="ident" id="1794584">mp</span><span class="op" id="1794586">.</span><span class="ident" id="1794587">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794600">mp</span><span class="op" id="1794602">.</span><span class="ident" id="1794603">alloc_bytes</span>&nbsp;<span class="op" id="1794615">+=</span>&nbsp;<span class="ident" id="1794618">mp</span><span class="op" id="1794620">.</span><span class="ident" id="1794621">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794640">mp</span><span class="op" id="1794642">.</span><span class="ident" id="1794643">free_bytes</span>&nbsp;<span class="op" id="1794654">+=</span>&nbsp;<span class="ident" id="1794657">mp</span><span class="op" id="1794659">.</span><span class="ident" id="1794660">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794679">mp</span><span class="op" id="1794681">.</span><span class="ident" id="1794682">prev_allocs</span>&nbsp;<span class="op" id="1794694">=</span>&nbsp;<span class="ident" id="1794696">mp</span><span class="op" id="1794698">.</span><span class="ident" id="1794699">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794715">mp</span><span class="op" id="1794717">.</span><span class="ident" id="1794718">prev_frees</span>&nbsp;<span class="op" id="1794729">=</span>&nbsp;<span class="ident" id="1794731">mp</span><span class="op" id="1794733">.</span><span class="ident" id="1794734">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794749">mp</span><span class="op" id="1794751">.</span><span class="ident" id="1794752">prev_alloc_bytes</span>&nbsp;<span class="op" id="1794769">=</span>&nbsp;<span class="ident" id="1794771">mp</span><span class="op" id="1794773">.</span><span class="ident" id="1794774">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794795">mp</span><span class="op" id="1794797">.</span><span class="ident" id="1794798">prev_free_bytes</span>&nbsp;<span class="op" id="1794814">=</span>&nbsp;<span class="ident" id="1794816">mp</span><span class="op" id="1794818">.</span><span class="ident" id="1794819">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794840">mp</span><span class="op" id="1794842">.</span><span class="ident" id="1794843">recent_allocs</span>&nbsp;<span class="op" id="1794857">=</span>&nbsp;<span class="num" id="1794859">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794863">mp</span><span class="op" id="1794865">.</span><span class="ident" id="1794866">recent_frees</span>&nbsp;<span class="op" id="1794879">=</span>&nbsp;<span class="num" id="1794881">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794885">mp</span><span class="op" id="1794887">.</span><span class="ident" id="1794888">recent_alloc_bytes</span>&nbsp;<span class="op" id="1794907">=</span>&nbsp;<span class="num" id="1794909">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1794913">mp</span><span class="op" id="1794915">.</span><span class="ident" id="1794916">recent_free_bytes</span>&nbsp;<span class="op" id="1794934">=</span>&nbsp;<span class="num" id="1794936">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1794939">}</span><br>
<span class="lineno">225</span><span class="op" id="1794941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1794944">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1795021">func</span>&nbsp;<span class="ident" id="1795026">mProf_GC</span><span class="op" id="1795034">(</span><span class="op" id="1795035">)</span>&nbsp;<span class="op" id="1795037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795040">lock</span><span class="op" id="1795044">(</span><span class="op" id="1795045">&amp;</span><span class="ident" id="1795046">proflock</span><span class="op" id="1795054">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795057">mprof_GC</span><span class="op" id="1795065">(</span><span class="op" id="1795066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795069">unlock</span><span class="op" id="1795075">(</span><span class="op" id="1795076">&amp;</span><span class="ident" id="1795077">proflock</span><span class="op" id="1795085">)</span><br>
<span class="lineno"></span><span class="op" id="1795087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1795090">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1795138">func</span>&nbsp;<span class="ident" id="1795143">mProf_Malloc</span><span class="op" id="1795155">(</span><span class="ident" id="1795156">p</span>&nbsp;<span class="ident" id="1795158">unsafe</span><span class="op" id="1795164">.</span><span class="ident" id="1795165">Pointer</span><span class="op" id="1795172">,</span>&nbsp;<span class="ident" id="1795174">size</span>&nbsp;<span class="builtintype" id="1795179">uintptr</span><span class="op" id="1795186">)</span>&nbsp;<span class="op" id="1795188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1795191">var</span>&nbsp;<span class="ident" id="1795195">stk</span>&nbsp;<span class="op" id="1795199">[</span><span class="ident" id="1795200">maxStack</span><span class="op" id="1795208">]</span><span class="builtintype" id="1795209">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795218">nstk</span>&nbsp;<span class="op" id="1795223">:=</span>&nbsp;<span class="ident" id="1795226">callers</span><span class="op" id="1795233">(</span><span class="num" id="1795234">4</span><span class="op" id="1795235">,</span>&nbsp;<span class="op" id="1795237">&amp;</span><span class="ident" id="1795238">stk</span><span class="op" id="1795241">[</span><span class="num" id="1795242">0</span><span class="op" id="1795243">]</span><span class="op" id="1795244">,</span>&nbsp;<span class="builtinfunc" id="1795246">len</span><span class="op" id="1795249">(</span><span class="ident" id="1795250">stk</span><span class="op" id="1795253">)</span><span class="op" id="1795254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795257">lock</span><span class="op" id="1795261">(</span><span class="op" id="1795262">&amp;</span><span class="ident" id="1795263">proflock</span><span class="op" id="1795271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795274">b</span>&nbsp;<span class="op" id="1795276">:=</span>&nbsp;<span class="ident" id="1795279">stkbucket</span><span class="op" id="1795288">(</span><span class="ident" id="1795289">memProfile</span><span class="op" id="1795299">,</span>&nbsp;<span class="ident" id="1795301">size</span><span class="op" id="1795305">,</span>&nbsp;<span class="ident" id="1795307">stk</span><span class="op" id="1795310">[</span><span class="op" id="1795311">:</span><span class="ident" id="1795312">nstk</span><span class="op" id="1795316">]</span><span class="op" id="1795317">,</span>&nbsp;<span class="builtintype" id="1795319">true</span><span class="op" id="1795323">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795326">mp</span>&nbsp;<span class="op" id="1795329">:=</span>&nbsp;<span class="ident" id="1795332">b</span><span class="op" id="1795333">.</span><span class="ident" id="1795334">mp</span><span class="op" id="1795336">(</span><span class="op" id="1795337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795340">mp</span><span class="op" id="1795342">.</span><span class="ident" id="1795343">recent_allocs</span><span class="op" id="1795356">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795360">mp</span><span class="op" id="1795362">.</span><span class="ident" id="1795363">recent_alloc_bytes</span>&nbsp;<span class="op" id="1795382">+=</span>&nbsp;<span class="ident" id="1795385">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795391">unlock</span><span class="op" id="1795397">(</span><span class="op" id="1795398">&amp;</span><span class="ident" id="1795399">proflock</span><span class="op" id="1795407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795411">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795499">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795563">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1795627">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795668">setprofilebucket</span><span class="op" id="1795684">(</span><span class="ident" id="1795685">p</span><span class="op" id="1795686">,</span>&nbsp;<span class="ident" id="1795688">b</span><span class="op" id="1795689">)</span><br>
<span class="lineno">250</span><span class="op" id="1795691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1795694">func</span>&nbsp;<span class="ident" id="1795699">setprofilebucket_m</span><span class="op" id="1795717">(</span><span class="op" id="1795718">)</span>&nbsp;<span class="comment" id="1795720">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1795732">func</span>&nbsp;<span class="ident" id="1795737">setprofilebucket</span><span class="op" id="1795753">(</span><span class="ident" id="1795754">p</span>&nbsp;<span class="ident" id="1795756">unsafe</span><span class="op" id="1795762">.</span><span class="ident" id="1795763">Pointer</span><span class="op" id="1795770">,</span>&nbsp;<span class="ident" id="1795772">b</span>&nbsp;<span class="op" id="1795774">*</span><span class="ident" id="1795775">bucket</span><span class="op" id="1795781">)</span>&nbsp;<span class="op" id="1795783">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795786">g</span>&nbsp;<span class="op" id="1795788">:=</span>&nbsp;<span class="ident" id="1795791">getg</span><span class="op" id="1795795">(</span><span class="op" id="1795796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795799">g</span><span class="op" id="1795800">.</span><span class="ident" id="1795801">m</span><span class="op" id="1795802">.</span><span class="ident" id="1795803">ptrarg</span><span class="op" id="1795809">[</span><span class="num" id="1795810">0</span><span class="op" id="1795811">]</span>&nbsp;<span class="op" id="1795813">=</span>&nbsp;<span class="ident" id="1795815">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795818">g</span><span class="op" id="1795819">.</span><span class="ident" id="1795820">m</span><span class="op" id="1795821">.</span><span class="ident" id="1795822">ptrarg</span><span class="op" id="1795828">[</span><span class="num" id="1795829">1</span><span class="op" id="1795830">]</span>&nbsp;<span class="op" id="1795832">=</span>&nbsp;<span class="ident" id="1795834">unsafe</span><span class="op" id="1795840">.</span><span class="ident" id="1795841">Pointer</span><span class="op" id="1795848">(</span><span class="ident" id="1795849">b</span><span class="op" id="1795850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795853">onM</span><span class="op" id="1795856">(</span><span class="ident" id="1795857">setprofilebucket_m</span><span class="op" id="1795875">)</span><br>
<span class="lineno"></span><span class="op" id="1795877">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1795880">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1795921">func</span>&nbsp;<span class="ident" id="1795926">mProf_Free</span><span class="op" id="1795936">(</span><span class="ident" id="1795937">b</span>&nbsp;<span class="op" id="1795939">*</span><span class="ident" id="1795940">bucket</span><span class="op" id="1795946">,</span>&nbsp;<span class="ident" id="1795948">size</span>&nbsp;<span class="builtintype" id="1795953">uintptr</span><span class="op" id="1795960">,</span>&nbsp;<span class="ident" id="1795962">freed</span>&nbsp;<span class="builtintype" id="1795968">bool</span><span class="op" id="1795972">)</span>&nbsp;<span class="op" id="1795974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795977">lock</span><span class="op" id="1795981">(</span><span class="op" id="1795982">&amp;</span><span class="ident" id="1795983">proflock</span><span class="op" id="1795991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1795994">mp</span>&nbsp;<span class="op" id="1795997">:=</span>&nbsp;<span class="ident" id="1796000">b</span><span class="op" id="1796001">.</span><span class="ident" id="1796002">mp</span><span class="op" id="1796004">(</span><span class="op" id="1796005">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796008">if</span>&nbsp;<span class="ident" id="1796011">freed</span>&nbsp;<span class="op" id="1796017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796021">mp</span><span class="op" id="1796023">.</span><span class="ident" id="1796024">recent_frees</span><span class="op" id="1796036">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796041">mp</span><span class="op" id="1796043">.</span><span class="ident" id="1796044">recent_free_bytes</span>&nbsp;<span class="op" id="1796062">+=</span>&nbsp;<span class="ident" id="1796065">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796071">}</span>&nbsp;<span class="keyword" id="1796073">else</span>&nbsp;<span class="op" id="1796078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796082">mp</span><span class="op" id="1796084">.</span><span class="ident" id="1796085">prev_frees</span><span class="op" id="1796095">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796100">mp</span><span class="op" id="1796102">.</span><span class="ident" id="1796103">prev_free_bytes</span>&nbsp;<span class="op" id="1796119">+=</span>&nbsp;<span class="ident" id="1796122">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796131">unlock</span><span class="op" id="1796137">(</span><span class="op" id="1796138">&amp;</span><span class="ident" id="1796139">proflock</span><span class="op" id="1796147">)</span><br>
<span class="lineno"></span><span class="op" id="1796149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1796152">var</span>&nbsp;<span class="ident" id="1796156">blockprofilerate</span>&nbsp;<span class="ident" id="1796173">uint64</span>&nbsp;<span class="comment" id="1796180">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1796197">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1796271">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1796346">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1796418">//</span><br>
<span class="lineno"></span><span class="comment" id="1796421">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1796487">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1796538">func</span>&nbsp;<span class="ident" id="1796543">SetBlockProfileRate</span><span class="op" id="1796562">(</span><span class="ident" id="1796563">rate</span>&nbsp;<span class="builtintype" id="1796568">int</span><span class="op" id="1796571">)</span>&nbsp;<span class="op" id="1796573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796576">var</span>&nbsp;<span class="ident" id="1796580">r</span>&nbsp;<span class="ident" id="1796582">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796589">if</span>&nbsp;<span class="ident" id="1796592">rate</span>&nbsp;<span class="op" id="1796597">&lt;=</span>&nbsp;<span class="num" id="1796600">0</span>&nbsp;<span class="op" id="1796602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796606">r</span>&nbsp;<span class="op" id="1796608">=</span>&nbsp;<span class="num" id="1796610">0</span>&nbsp;<span class="comment" id="1796612">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796634">}</span>&nbsp;<span class="keyword" id="1796636">else</span>&nbsp;<span class="keyword" id="1796641">if</span>&nbsp;<span class="ident" id="1796644">rate</span>&nbsp;<span class="op" id="1796649">==</span>&nbsp;<span class="num" id="1796652">1</span>&nbsp;<span class="op" id="1796654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796658">r</span>&nbsp;<span class="op" id="1796660">=</span>&nbsp;<span class="num" id="1796662">1</span>&nbsp;<span class="comment" id="1796664">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796687">}</span>&nbsp;<span class="keyword" id="1796689">else</span>&nbsp;<span class="op" id="1796694">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1796698">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796779">r</span>&nbsp;<span class="op" id="1796781">=</span>&nbsp;<span class="ident" id="1796783">int64</span><span class="op" id="1796788">(</span><span class="builtintype" id="1796789">float64</span><span class="op" id="1796796">(</span><span class="ident" id="1796797">rate</span><span class="op" id="1796801">)</span>&nbsp;<span class="op" id="1796803">*</span>&nbsp;<span class="builtintype" id="1796805">float64</span><span class="op" id="1796812">(</span><span class="ident" id="1796813">tickspersecond</span><span class="op" id="1796827">(</span><span class="op" id="1796828">)</span><span class="op" id="1796829">)</span>&nbsp;<span class="op" id="1796831">/</span>&nbsp;<span class="op" id="1796833">(</span><span class="num" id="1796834">1000</span>&nbsp;<span class="op" id="1796839">*</span>&nbsp;<span class="num" id="1796841">1000</span>&nbsp;<span class="op" id="1796846">*</span>&nbsp;<span class="num" id="1796848">1000</span><span class="op" id="1796852">)</span><span class="op" id="1796853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796857">if</span>&nbsp;<span class="ident" id="1796860">r</span>&nbsp;<span class="op" id="1796862">==</span>&nbsp;<span class="num" id="1796865">0</span>&nbsp;<span class="op" id="1796867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796872">r</span>&nbsp;<span class="op" id="1796874">=</span>&nbsp;<span class="num" id="1796876">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796880">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1796883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796887">atomicstore64</span><span class="op" id="1796900">(</span><span class="op" id="1796901">&amp;</span><span class="ident" id="1796902">blockprofilerate</span><span class="op" id="1796918">,</span>&nbsp;<span class="ident" id="1796920">uint64</span><span class="op" id="1796926">(</span><span class="ident" id="1796927">r</span><span class="op" id="1796928">)</span><span class="op" id="1796929">)</span><br>
<span class="lineno"></span><span class="op" id="1796931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1796934">func</span>&nbsp;<span class="ident" id="1796939">blockevent</span><span class="op" id="1796949">(</span><span class="ident" id="1796950">cycles</span>&nbsp;<span class="ident" id="1796957">int64</span><span class="op" id="1796962">,</span>&nbsp;<span class="ident" id="1796964">skip</span>&nbsp;<span class="builtintype" id="1796969">int</span><span class="op" id="1796972">)</span>&nbsp;<span class="op" id="1796974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1796977">if</span>&nbsp;<span class="ident" id="1796980">cycles</span>&nbsp;<span class="op" id="1796987">&lt;=</span>&nbsp;<span class="num" id="1796990">0</span>&nbsp;<span class="op" id="1796992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1796996">cycles</span>&nbsp;<span class="op" id="1797003">=</span>&nbsp;<span class="num" id="1797005">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797011">rate</span>&nbsp;<span class="op" id="1797016">:=</span>&nbsp;<span class="ident" id="1797019">int64</span><span class="op" id="1797024">(</span><span class="ident" id="1797025">atomicload64</span><span class="op" id="1797037">(</span><span class="op" id="1797038">&amp;</span><span class="ident" id="1797039">blockprofilerate</span><span class="op" id="1797055">)</span><span class="op" id="1797056">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797059">if</span>&nbsp;<span class="ident" id="1797062">rate</span>&nbsp;<span class="op" id="1797067">&lt;=</span>&nbsp;<span class="num" id="1797070">0</span>&nbsp;<span class="op" id="1797072">||</span>&nbsp;<span class="op" id="1797075">(</span><span class="ident" id="1797076">rate</span>&nbsp;<span class="op" id="1797081">&gt;</span>&nbsp;<span class="ident" id="1797083">cycles</span>&nbsp;<span class="op" id="1797090">&amp;&amp;</span>&nbsp;<span class="ident" id="1797093">int64</span><span class="op" id="1797098">(</span><span class="ident" id="1797099">fastrand1</span><span class="op" id="1797108">(</span><span class="op" id="1797109">)</span><span class="op" id="1797110">)</span><span class="op" id="1797111">%</span><span class="ident" id="1797112">rate</span>&nbsp;<span class="op" id="1797117">&gt;</span>&nbsp;<span class="ident" id="1797119">cycles</span><span class="op" id="1797125">)</span>&nbsp;<span class="op" id="1797127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797131">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797142">gp</span>&nbsp;<span class="op" id="1797145">:=</span>&nbsp;<span class="ident" id="1797148">getg</span><span class="op" id="1797152">(</span><span class="op" id="1797153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797156">var</span>&nbsp;<span class="ident" id="1797160">nstk</span>&nbsp;<span class="builtintype" id="1797165">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797170">var</span>&nbsp;<span class="ident" id="1797174">stk</span>&nbsp;<span class="op" id="1797178">[</span><span class="ident" id="1797179">maxStack</span><span class="op" id="1797187">]</span><span class="builtintype" id="1797188">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797197">if</span>&nbsp;<span class="ident" id="1797200">gp</span><span class="op" id="1797202">.</span><span class="ident" id="1797203">m</span><span class="op" id="1797204">.</span><span class="ident" id="1797205">curg</span>&nbsp;<span class="op" id="1797210">==</span>&nbsp;<span class="ident" id="1797213">nil</span>&nbsp;<span class="op" id="1797217">||</span>&nbsp;<span class="ident" id="1797220">gp</span><span class="op" id="1797222">.</span><span class="ident" id="1797223">m</span><span class="op" id="1797224">.</span><span class="ident" id="1797225">curg</span>&nbsp;<span class="op" id="1797230">==</span>&nbsp;<span class="ident" id="1797233">gp</span>&nbsp;<span class="op" id="1797236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797240">nstk</span>&nbsp;<span class="op" id="1797245">=</span>&nbsp;<span class="ident" id="1797247">callers</span><span class="op" id="1797254">(</span><span class="ident" id="1797255">skip</span><span class="op" id="1797259">,</span>&nbsp;<span class="op" id="1797261">&amp;</span><span class="ident" id="1797262">stk</span><span class="op" id="1797265">[</span><span class="num" id="1797266">0</span><span class="op" id="1797267">]</span><span class="op" id="1797268">,</span>&nbsp;<span class="builtinfunc" id="1797270">len</span><span class="op" id="1797273">(</span><span class="ident" id="1797274">stk</span><span class="op" id="1797277">)</span><span class="op" id="1797278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797281">}</span>&nbsp;<span class="keyword" id="1797283">else</span>&nbsp;<span class="op" id="1797288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797292">nstk</span>&nbsp;<span class="op" id="1797297">=</span>&nbsp;<span class="ident" id="1797299">gcallers</span><span class="op" id="1797307">(</span><span class="ident" id="1797308">gp</span><span class="op" id="1797310">.</span><span class="ident" id="1797311">m</span><span class="op" id="1797312">.</span><span class="ident" id="1797313">curg</span><span class="op" id="1797317">,</span>&nbsp;<span class="ident" id="1797319">skip</span><span class="op" id="1797323">,</span>&nbsp;<span class="op" id="1797325">&amp;</span><span class="ident" id="1797326">stk</span><span class="op" id="1797329">[</span><span class="num" id="1797330">0</span><span class="op" id="1797331">]</span><span class="op" id="1797332">,</span>&nbsp;<span class="builtinfunc" id="1797334">len</span><span class="op" id="1797337">(</span><span class="ident" id="1797338">stk</span><span class="op" id="1797341">)</span><span class="op" id="1797342">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797348">lock</span><span class="op" id="1797352">(</span><span class="op" id="1797353">&amp;</span><span class="ident" id="1797354">proflock</span><span class="op" id="1797362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797365">b</span>&nbsp;<span class="op" id="1797367">:=</span>&nbsp;<span class="ident" id="1797370">stkbucket</span><span class="op" id="1797379">(</span><span class="ident" id="1797380">blockProfile</span><span class="op" id="1797392">,</span>&nbsp;<span class="num" id="1797394">0</span><span class="op" id="1797395">,</span>&nbsp;<span class="ident" id="1797397">stk</span><span class="op" id="1797400">[</span><span class="op" id="1797401">:</span><span class="ident" id="1797402">nstk</span><span class="op" id="1797406">]</span><span class="op" id="1797407">,</span>&nbsp;<span class="builtintype" id="1797409">true</span><span class="op" id="1797413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797416">b</span><span class="op" id="1797417">.</span><span class="ident" id="1797418">bp</span><span class="op" id="1797420">(</span><span class="op" id="1797421">)</span><span class="op" id="1797422">.</span><span class="ident" id="1797423">count</span><span class="op" id="1797428">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797432">b</span><span class="op" id="1797433">.</span><span class="ident" id="1797434">bp</span><span class="op" id="1797436">(</span><span class="op" id="1797437">)</span><span class="op" id="1797438">.</span><span class="ident" id="1797439">cycles</span>&nbsp;<span class="op" id="1797446">+=</span>&nbsp;<span class="ident" id="1797449">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797457">unlock</span><span class="op" id="1797463">(</span><span class="op" id="1797464">&amp;</span><span class="ident" id="1797465">proflock</span><span class="op" id="1797473">)</span><br>
<span class="lineno"></span><span class="op" id="1797475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1797478">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1797512">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1797565">type</span>&nbsp;<span class="ident" id="1797570">StackRecord</span>&nbsp;<span class="keyword" id="1797582">struct</span>&nbsp;<span class="op" id="1797589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1797592">Stack0</span>&nbsp;<span class="op" id="1797599">[</span><span class="num" id="1797600">32</span><span class="op" id="1797602">]</span><span class="builtintype" id="1797603">uintptr</span>&nbsp;<span class="comment" id="1797611">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1797665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1797668">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1797729">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1797754">func</span>&nbsp;<span class="op" id="1797759">(</span><span class="ident" id="1797760">r</span>&nbsp;<span class="op" id="1797762">*</span><span class="ident" id="1797763">StackRecord</span><span class="op" id="1797774">)</span>&nbsp;<span class="ident" id="1797776">Stack</span><span class="op" id="1797781">(</span><span class="op" id="1797782">)</span>&nbsp;<span class="op" id="1797784">[</span><span class="op" id="1797785">]</span><span class="builtintype" id="1797786">uintptr</span>&nbsp;<span class="op" id="1797794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797797">for</span>&nbsp;<span class="ident" id="1797801">i</span><span class="op" id="1797802">,</span>&nbsp;<span class="ident" id="1797804">v</span>&nbsp;<span class="op" id="1797806">:=</span>&nbsp;<span class="keyword" id="1797809">range</span>&nbsp;<span class="ident" id="1797815">r</span><span class="op" id="1797816">.</span><span class="ident" id="1797817">Stack0</span>&nbsp;<span class="op" id="1797824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797828">if</span>&nbsp;<span class="ident" id="1797831">v</span>&nbsp;<span class="op" id="1797833">==</span>&nbsp;<span class="num" id="1797836">0</span>&nbsp;<span class="op" id="1797838">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797843">return</span>&nbsp;<span class="ident" id="1797850">r</span><span class="op" id="1797851">.</span><span class="ident" id="1797852">Stack0</span><span class="op" id="1797858">[</span><span class="num" id="1797859">0</span><span class="op" id="1797860">:</span><span class="ident" id="1797861">i</span><span class="op" id="1797862">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1797869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1797872">return</span>&nbsp;<span class="ident" id="1797879">r</span><span class="op" id="1797880">.</span><span class="ident" id="1797881">Stack0</span><span class="op" id="1797887">[</span><span class="num" id="1797888">0</span><span class="op" id="1797889">:</span><span class="op" id="1797890">]</span><br>
<span class="lineno"></span><span class="op" id="1797892">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1797895">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1797957">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1798014">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1798059">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1798113">//</span><br>
<span class="lineno"></span><span class="comment" id="1798116">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1798193">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1798253">//</span><br>
<span class="lineno"></span><span class="comment" id="1798256">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1798318">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1798381">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1798442">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1798503">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1798561">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1798591">var</span>&nbsp;<span class="ident" id="1798595">MemProfileRate</span>&nbsp;<span class="builtintype" id="1798610">int</span>&nbsp;<span class="op" id="1798614">=</span>&nbsp;<span class="num" id="1798616">512</span>&nbsp;<span class="op" id="1798620">*</span>&nbsp;<span class="num" id="1798622">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1798628">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1798687">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1798735">type</span>&nbsp;<span class="ident" id="1798740">MemProfileRecord</span>&nbsp;<span class="keyword" id="1798757">struct</span>&nbsp;<span class="op" id="1798764">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1798767">AllocBytes</span><span class="op" id="1798777">,</span>&nbsp;<span class="ident" id="1798779">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1798793">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1798805">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1798842">AllocObjects</span><span class="op" id="1798854">,</span>&nbsp;<span class="ident" id="1798856">FreeObjects</span>&nbsp;<span class="ident" id="1798868">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1798880">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1798919">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1798945">[</span><span class="num" id="1798946">32</span><span class="op" id="1798948">]</span><span class="builtintype" id="1798949">uintptr</span>&nbsp;<span class="comment" id="1798957">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1799011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1799014">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1799089">func</span>&nbsp;<span class="op" id="1799094">(</span><span class="ident" id="1799095">r</span>&nbsp;<span class="op" id="1799097">*</span><span class="ident" id="1799098">MemProfileRecord</span><span class="op" id="1799114">)</span>&nbsp;<span class="ident" id="1799116">InUseBytes</span><span class="op" id="1799126">(</span><span class="op" id="1799127">)</span>&nbsp;<span class="ident" id="1799129">int64</span>&nbsp;<span class="op" id="1799135">{</span>&nbsp;<span class="keyword" id="1799137">return</span>&nbsp;<span class="ident" id="1799144">r</span><span class="op" id="1799145">.</span><span class="ident" id="1799146">AllocBytes</span>&nbsp;<span class="op" id="1799157">-</span>&nbsp;<span class="ident" id="1799159">r</span><span class="op" id="1799160">.</span><span class="ident" id="1799161">FreeBytes</span>&nbsp;<span class="op" id="1799171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1799174">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1799257">func</span>&nbsp;<span class="op" id="1799262">(</span><span class="ident" id="1799263">r</span>&nbsp;<span class="op" id="1799265">*</span><span class="ident" id="1799266">MemProfileRecord</span><span class="op" id="1799282">)</span>&nbsp;<span class="ident" id="1799284">InUseObjects</span><span class="op" id="1799296">(</span><span class="op" id="1799297">)</span>&nbsp;<span class="ident" id="1799299">int64</span>&nbsp;<span class="op" id="1799305">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1799308">return</span>&nbsp;<span class="ident" id="1799315">r</span><span class="op" id="1799316">.</span><span class="ident" id="1799317">AllocObjects</span>&nbsp;<span class="op" id="1799330">-</span>&nbsp;<span class="ident" id="1799332">r</span><span class="op" id="1799333">.</span><span class="ident" id="1799334">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1799346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1799349">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1799410">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1799435">func</span>&nbsp;<span class="op" id="1799440">(</span><span class="ident" id="1799441">r</span>&nbsp;<span class="op" id="1799443">*</span><span class="ident" id="1799444">MemProfileRecord</span><span class="op" id="1799460">)</span>&nbsp;<span class="ident" id="1799462">Stack</span><span class="op" id="1799467">(</span><span class="op" id="1799468">)</span>&nbsp;<span class="op" id="1799470">[</span><span class="op" id="1799471">]</span><span class="builtintype" id="1799472">uintptr</span>&nbsp;<span class="op" id="1799480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1799483">for</span>&nbsp;<span class="ident" id="1799487">i</span><span class="op" id="1799488">,</span>&nbsp;<span class="ident" id="1799490">v</span>&nbsp;<span class="op" id="1799492">:=</span>&nbsp;<span class="keyword" id="1799495">range</span>&nbsp;<span class="ident" id="1799501">r</span><span class="op" id="1799502">.</span><span class="ident" id="1799503">Stack0</span>&nbsp;<span class="op" id="1799510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1799514">if</span>&nbsp;<span class="ident" id="1799517">v</span>&nbsp;<span class="op" id="1799519">==</span>&nbsp;<span class="num" id="1799522">0</span>&nbsp;<span class="op" id="1799524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1799529">return</span>&nbsp;<span class="ident" id="1799536">r</span><span class="op" id="1799537">.</span><span class="ident" id="1799538">Stack0</span><span class="op" id="1799544">[</span><span class="num" id="1799545">0</span><span class="op" id="1799546">:</span><span class="ident" id="1799547">i</span><span class="op" id="1799548">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1799552">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1799555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1799558">return</span>&nbsp;<span class="ident" id="1799565">r</span><span class="op" id="1799566">.</span><span class="ident" id="1799567">Stack0</span><span class="op" id="1799573">[</span><span class="num" id="1799574">0</span><span class="op" id="1799575">:</span><span class="op" id="1799576">]</span><br>
<span class="lineno"></span><span class="op" id="1799578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1799581">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1799659">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1799736">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1799805">//</span><br>
<span class="lineno"></span><span class="comment" id="1799808">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1799873">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1799932">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1799994">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1800032">//</span><br>
<span class="lineno"></span><span class="comment" id="1800035">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1800091">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1800146">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1800181">func</span>&nbsp;<span class="ident" id="1800186">MemProfile</span><span class="op" id="1800196">(</span><span class="ident" id="1800197">p</span>&nbsp;<span class="op" id="1800199">[</span><span class="op" id="1800200">]</span><span class="ident" id="1800201">MemProfileRecord</span><span class="op" id="1800217">,</span>&nbsp;<span class="ident" id="1800219">inuseZero</span>&nbsp;<span class="builtintype" id="1800229">bool</span><span class="op" id="1800233">)</span>&nbsp;<span class="op" id="1800235">(</span><span class="ident" id="1800236">n</span>&nbsp;<span class="builtintype" id="1800238">int</span><span class="op" id="1800241">,</span>&nbsp;<span class="ident" id="1800243">ok</span>&nbsp;<span class="builtintype" id="1800246">bool</span><span class="op" id="1800250">)</span>&nbsp;<span class="op" id="1800252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800255">lock</span><span class="op" id="1800259">(</span><span class="op" id="1800260">&amp;</span><span class="ident" id="1800261">proflock</span><span class="op" id="1800269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800272">clear</span>&nbsp;<span class="op" id="1800278">:=</span>&nbsp;<span class="builtintype" id="1800281">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800287">for</span>&nbsp;<span class="ident" id="1800291">b</span>&nbsp;<span class="op" id="1800293">:=</span>&nbsp;<span class="ident" id="1800296">mbuckets</span><span class="op" id="1800304">;</span>&nbsp;<span class="ident" id="1800306">b</span>&nbsp;<span class="op" id="1800308">!=</span>&nbsp;<span class="ident" id="1800311">nil</span><span class="op" id="1800314">;</span>&nbsp;<span class="ident" id="1800316">b</span>&nbsp;<span class="op" id="1800318">=</span>&nbsp;<span class="ident" id="1800320">b</span><span class="op" id="1800321">.</span><span class="ident" id="1800322">allnext</span>&nbsp;<span class="op" id="1800330">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800334">mp</span>&nbsp;<span class="op" id="1800337">:=</span>&nbsp;<span class="ident" id="1800340">b</span><span class="op" id="1800341">.</span><span class="ident" id="1800342">mp</span><span class="op" id="1800344">(</span><span class="op" id="1800345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800349">if</span>&nbsp;<span class="ident" id="1800352">inuseZero</span>&nbsp;<span class="op" id="1800362">||</span>&nbsp;<span class="ident" id="1800365">mp</span><span class="op" id="1800367">.</span><span class="ident" id="1800368">alloc_bytes</span>&nbsp;<span class="op" id="1800380">!=</span>&nbsp;<span class="ident" id="1800383">mp</span><span class="op" id="1800385">.</span><span class="ident" id="1800386">free_bytes</span>&nbsp;<span class="op" id="1800397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800402">n</span><span class="op" id="1800403">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800412">if</span>&nbsp;<span class="ident" id="1800415">mp</span><span class="op" id="1800417">.</span><span class="ident" id="1800418">allocs</span>&nbsp;<span class="op" id="1800425">!=</span>&nbsp;<span class="num" id="1800428">0</span>&nbsp;<span class="op" id="1800430">||</span>&nbsp;<span class="ident" id="1800433">mp</span><span class="op" id="1800435">.</span><span class="ident" id="1800436">frees</span>&nbsp;<span class="op" id="1800442">!=</span>&nbsp;<span class="num" id="1800445">0</span>&nbsp;<span class="op" id="1800447">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800452">clear</span>&nbsp;<span class="op" id="1800458">=</span>&nbsp;<span class="builtintype" id="1800460">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800474">if</span>&nbsp;<span class="ident" id="1800477">clear</span>&nbsp;<span class="op" id="1800483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1800487">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1800549">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1800609">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1800678">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800747">mprof_GC</span><span class="op" id="1800755">(</span><span class="op" id="1800756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800760">mprof_GC</span><span class="op" id="1800768">(</span><span class="op" id="1800769">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800773">n</span>&nbsp;<span class="op" id="1800775">=</span>&nbsp;<span class="num" id="1800777">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800781">for</span>&nbsp;<span class="ident" id="1800785">b</span>&nbsp;<span class="op" id="1800787">:=</span>&nbsp;<span class="ident" id="1800790">mbuckets</span><span class="op" id="1800798">;</span>&nbsp;<span class="ident" id="1800800">b</span>&nbsp;<span class="op" id="1800802">!=</span>&nbsp;<span class="ident" id="1800805">nil</span><span class="op" id="1800808">;</span>&nbsp;<span class="ident" id="1800810">b</span>&nbsp;<span class="op" id="1800812">=</span>&nbsp;<span class="ident" id="1800814">b</span><span class="op" id="1800815">.</span><span class="ident" id="1800816">allnext</span>&nbsp;<span class="op" id="1800824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800829">mp</span>&nbsp;<span class="op" id="1800832">:=</span>&nbsp;<span class="ident" id="1800835">b</span><span class="op" id="1800836">.</span><span class="ident" id="1800837">mp</span><span class="op" id="1800839">(</span><span class="op" id="1800840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800845">if</span>&nbsp;<span class="ident" id="1800848">inuseZero</span>&nbsp;<span class="op" id="1800858">||</span>&nbsp;<span class="ident" id="1800861">mp</span><span class="op" id="1800863">.</span><span class="ident" id="1800864">alloc_bytes</span>&nbsp;<span class="op" id="1800876">!=</span>&nbsp;<span class="ident" id="1800879">mp</span><span class="op" id="1800881">.</span><span class="ident" id="1800882">free_bytes</span>&nbsp;<span class="op" id="1800893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800899">n</span><span class="op" id="1800900">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1800913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800916">if</span>&nbsp;<span class="ident" id="1800919">n</span>&nbsp;<span class="op" id="1800921">&lt;=</span>&nbsp;<span class="builtinfunc" id="1800924">len</span><span class="op" id="1800927">(</span><span class="ident" id="1800928">p</span><span class="op" id="1800929">)</span>&nbsp;<span class="op" id="1800931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800935">ok</span>&nbsp;<span class="op" id="1800938">=</span>&nbsp;<span class="builtintype" id="1800940">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1800947">idx</span>&nbsp;<span class="op" id="1800951">:=</span>&nbsp;<span class="num" id="1800954">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1800958">for</span>&nbsp;<span class="ident" id="1800962">b</span>&nbsp;<span class="op" id="1800964">:=</span>&nbsp;<span class="ident" id="1800967">mbuckets</span><span class="op" id="1800975">;</span>&nbsp;<span class="ident" id="1800977">b</span>&nbsp;<span class="op" id="1800979">!=</span>&nbsp;<span class="ident" id="1800982">nil</span><span class="op" id="1800985">;</span>&nbsp;<span class="ident" id="1800987">b</span>&nbsp;<span class="op" id="1800989">=</span>&nbsp;<span class="ident" id="1800991">b</span><span class="op" id="1800992">.</span><span class="ident" id="1800993">allnext</span>&nbsp;<span class="op" id="1801001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801006">mp</span>&nbsp;<span class="op" id="1801009">:=</span>&nbsp;<span class="ident" id="1801012">b</span><span class="op" id="1801013">.</span><span class="ident" id="1801014">mp</span><span class="op" id="1801016">(</span><span class="op" id="1801017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1801022">if</span>&nbsp;<span class="ident" id="1801025">inuseZero</span>&nbsp;<span class="op" id="1801035">||</span>&nbsp;<span class="ident" id="1801038">mp</span><span class="op" id="1801040">.</span><span class="ident" id="1801041">alloc_bytes</span>&nbsp;<span class="op" id="1801053">!=</span>&nbsp;<span class="ident" id="1801056">mp</span><span class="op" id="1801058">.</span><span class="ident" id="1801059">free_bytes</span>&nbsp;<span class="op" id="1801070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801076">record</span><span class="op" id="1801082">(</span><span class="op" id="1801083">&amp;</span><span class="ident" id="1801084">p</span><span class="op" id="1801085">[</span><span class="ident" id="1801086">idx</span><span class="op" id="1801089">]</span><span class="op" id="1801090">,</span>&nbsp;<span class="ident" id="1801092">b</span><span class="op" id="1801093">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801099">idx</span><span class="op" id="1801102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1801108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1801112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1801115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801118">unlock</span><span class="op" id="1801124">(</span><span class="op" id="1801125">&amp;</span><span class="ident" id="1801126">proflock</span><span class="op" id="1801134">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1801137">return</span><br>
<span class="lineno"></span><span class="op" id="1801144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1801147">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1801171">func</span>&nbsp;<span class="ident" id="1801176">record</span><span class="op" id="1801182">(</span><span class="ident" id="1801183">r</span>&nbsp;<span class="op" id="1801185">*</span><span class="ident" id="1801186">MemProfileRecord</span><span class="op" id="1801202">,</span>&nbsp;<span class="ident" id="1801204">b</span>&nbsp;<span class="op" id="1801206">*</span><span class="ident" id="1801207">bucket</span><span class="op" id="1801213">)</span>&nbsp;<span class="op" id="1801215">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801218">mp</span>&nbsp;<span class="op" id="1801221">:=</span>&nbsp;<span class="ident" id="1801224">b</span><span class="op" id="1801225">.</span><span class="ident" id="1801226">mp</span><span class="op" id="1801228">(</span><span class="op" id="1801229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801232">r</span><span class="op" id="1801233">.</span><span class="ident" id="1801234">AllocBytes</span>&nbsp;<span class="op" id="1801245">=</span>&nbsp;<span class="ident" id="1801247">int64</span><span class="op" id="1801252">(</span><span class="ident" id="1801253">mp</span><span class="op" id="1801255">.</span><span class="ident" id="1801256">alloc_bytes</span><span class="op" id="1801267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801270">r</span><span class="op" id="1801271">.</span><span class="ident" id="1801272">FreeBytes</span>&nbsp;<span class="op" id="1801282">=</span>&nbsp;<span class="ident" id="1801284">int64</span><span class="op" id="1801289">(</span><span class="ident" id="1801290">mp</span><span class="op" id="1801292">.</span><span class="ident" id="1801293">free_bytes</span><span class="op" id="1801303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801306">r</span><span class="op" id="1801307">.</span><span class="ident" id="1801308">AllocObjects</span>&nbsp;<span class="op" id="1801321">=</span>&nbsp;<span class="ident" id="1801323">int64</span><span class="op" id="1801328">(</span><span class="ident" id="1801329">mp</span><span class="op" id="1801331">.</span><span class="ident" id="1801332">allocs</span><span class="op" id="1801338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801341">r</span><span class="op" id="1801342">.</span><span class="ident" id="1801343">FreeObjects</span>&nbsp;<span class="op" id="1801355">=</span>&nbsp;<span class="ident" id="1801357">int64</span><span class="op" id="1801362">(</span><span class="ident" id="1801363">mp</span><span class="op" id="1801365">.</span><span class="ident" id="1801366">frees</span><span class="op" id="1801371">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1801374">copy</span><span class="op" id="1801378">(</span><span class="ident" id="1801379">r</span><span class="op" id="1801380">.</span><span class="ident" id="1801381">Stack0</span><span class="op" id="1801387">[</span><span class="op" id="1801388">:</span><span class="op" id="1801389">]</span><span class="op" id="1801390">,</span>&nbsp;<span class="ident" id="1801392">b</span><span class="op" id="1801393">.</span><span class="ident" id="1801394">stk</span><span class="op" id="1801397">(</span><span class="op" id="1801398">)</span><span class="op" id="1801399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1801402">for</span>&nbsp;<span class="ident" id="1801406">i</span>&nbsp;<span class="op" id="1801408">:=</span>&nbsp;<span class="builtintype" id="1801411">int</span><span class="op" id="1801414">(</span><span class="ident" id="1801415">b</span><span class="op" id="1801416">.</span><span class="ident" id="1801417">nstk</span><span class="op" id="1801421">)</span><span class="op" id="1801422">;</span>&nbsp;<span class="ident" id="1801424">i</span>&nbsp;<span class="op" id="1801426">&lt;</span>&nbsp;<span class="builtinfunc" id="1801428">len</span><span class="op" id="1801431">(</span><span class="ident" id="1801432">r</span><span class="op" id="1801433">.</span><span class="ident" id="1801434">Stack0</span><span class="op" id="1801440">)</span><span class="op" id="1801441">;</span>&nbsp;<span class="ident" id="1801443">i</span><span class="op" id="1801444">++</span>&nbsp;<span class="op" id="1801447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801451">r</span><span class="op" id="1801452">.</span><span class="ident" id="1801453">Stack0</span><span class="op" id="1801459">[</span><span class="ident" id="1801460">i</span><span class="op" id="1801461">]</span>&nbsp;<span class="op" id="1801463">=</span>&nbsp;<span class="num" id="1801465">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1801468">}</span><br>
<span class="lineno"></span><span class="op" id="1801470">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1801473">func</span>&nbsp;<span class="ident" id="1801478">iterate_memprof</span><span class="op" id="1801493">(</span><span class="ident" id="1801494">fn</span>&nbsp;<span class="keyword" id="1801497">func</span><span class="op" id="1801501">(</span><span class="op" id="1801502">*</span><span class="ident" id="1801503">bucket</span><span class="op" id="1801509">,</span>&nbsp;<span class="builtintype" id="1801511">uintptr</span><span class="op" id="1801518">,</span>&nbsp;<span class="op" id="1801520">*</span><span class="builtintype" id="1801521">uintptr</span><span class="op" id="1801528">,</span>&nbsp;<span class="builtintype" id="1801530">uintptr</span><span class="op" id="1801537">,</span>&nbsp;<span class="builtintype" id="1801539">uintptr</span><span class="op" id="1801546">,</span>&nbsp;<span class="builtintype" id="1801548">uintptr</span><span class="op" id="1801555">)</span><span class="op" id="1801556">)</span>&nbsp;<span class="op" id="1801558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801561">lock</span><span class="op" id="1801565">(</span><span class="op" id="1801566">&amp;</span><span class="ident" id="1801567">proflock</span><span class="op" id="1801575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1801578">for</span>&nbsp;<span class="ident" id="1801582">b</span>&nbsp;<span class="op" id="1801584">:=</span>&nbsp;<span class="ident" id="1801587">mbuckets</span><span class="op" id="1801595">;</span>&nbsp;<span class="ident" id="1801597">b</span>&nbsp;<span class="op" id="1801599">!=</span>&nbsp;<span class="ident" id="1801602">nil</span><span class="op" id="1801605">;</span>&nbsp;<span class="ident" id="1801607">b</span>&nbsp;<span class="op" id="1801609">=</span>&nbsp;<span class="ident" id="1801611">b</span><span class="op" id="1801612">.</span><span class="ident" id="1801613">allnext</span>&nbsp;<span class="op" id="1801621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801625">mp</span>&nbsp;<span class="op" id="1801628">:=</span>&nbsp;<span class="ident" id="1801631">b</span><span class="op" id="1801632">.</span><span class="ident" id="1801633">mp</span><span class="op" id="1801635">(</span><span class="op" id="1801636">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801640">fn</span><span class="op" id="1801642">(</span><span class="ident" id="1801643">b</span><span class="op" id="1801644">,</span>&nbsp;<span class="builtintype" id="1801646">uintptr</span><span class="op" id="1801653">(</span><span class="ident" id="1801654">b</span><span class="op" id="1801655">.</span><span class="ident" id="1801656">nstk</span><span class="op" id="1801660">)</span><span class="op" id="1801661">,</span>&nbsp;<span class="op" id="1801663">&amp;</span><span class="ident" id="1801664">b</span><span class="op" id="1801665">.</span><span class="ident" id="1801666">stk</span><span class="op" id="1801669">(</span><span class="op" id="1801670">)</span><span class="op" id="1801671">[</span><span class="num" id="1801672">0</span><span class="op" id="1801673">]</span><span class="op" id="1801674">,</span>&nbsp;<span class="ident" id="1801676">b</span><span class="op" id="1801677">.</span><span class="ident" id="1801678">size</span><span class="op" id="1801682">,</span>&nbsp;<span class="ident" id="1801684">mp</span><span class="op" id="1801686">.</span><span class="ident" id="1801687">allocs</span><span class="op" id="1801693">,</span>&nbsp;<span class="ident" id="1801695">mp</span><span class="op" id="1801697">.</span><span class="ident" id="1801698">frees</span><span class="op" id="1801703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1801706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801709">unlock</span><span class="op" id="1801715">(</span><span class="op" id="1801716">&amp;</span><span class="ident" id="1801717">proflock</span><span class="op" id="1801725">)</span><br>
<span class="lineno"></span><span class="op" id="1801727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1801730">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1801789">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1801837">type</span>&nbsp;<span class="ident" id="1801842">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1801861">struct</span>&nbsp;<span class="op" id="1801868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801871">Count</span>&nbsp;&nbsp;<span class="ident" id="1801878">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801885">Cycles</span>&nbsp;<span class="ident" id="1801892">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1801899">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1801911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1801914">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1801996">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1802075">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1802146">//</span><br>
<span class="lineno"></span><span class="comment" id="1802149">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1802205">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1802262">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1802299">func</span>&nbsp;<span class="ident" id="1802304">BlockProfile</span><span class="op" id="1802316">(</span><span class="ident" id="1802317">p</span>&nbsp;<span class="op" id="1802319">[</span><span class="op" id="1802320">]</span><span class="ident" id="1802321">BlockProfileRecord</span><span class="op" id="1802339">)</span>&nbsp;<span class="op" id="1802341">(</span><span class="ident" id="1802342">n</span>&nbsp;<span class="builtintype" id="1802344">int</span><span class="op" id="1802347">,</span>&nbsp;<span class="ident" id="1802349">ok</span>&nbsp;<span class="builtintype" id="1802352">bool</span><span class="op" id="1802356">)</span>&nbsp;<span class="op" id="1802358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802361">lock</span><span class="op" id="1802365">(</span><span class="op" id="1802366">&amp;</span><span class="ident" id="1802367">proflock</span><span class="op" id="1802375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1802378">for</span>&nbsp;<span class="ident" id="1802382">b</span>&nbsp;<span class="op" id="1802384">:=</span>&nbsp;<span class="ident" id="1802387">bbuckets</span><span class="op" id="1802395">;</span>&nbsp;<span class="ident" id="1802397">b</span>&nbsp;<span class="op" id="1802399">!=</span>&nbsp;<span class="ident" id="1802402">nil</span><span class="op" id="1802405">;</span>&nbsp;<span class="ident" id="1802407">b</span>&nbsp;<span class="op" id="1802409">=</span>&nbsp;<span class="ident" id="1802411">b</span><span class="op" id="1802412">.</span><span class="ident" id="1802413">allnext</span>&nbsp;<span class="op" id="1802421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802425">n</span><span class="op" id="1802426">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1802430">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1802433">if</span>&nbsp;<span class="ident" id="1802436">n</span>&nbsp;<span class="op" id="1802438">&lt;=</span>&nbsp;<span class="builtinfunc" id="1802441">len</span><span class="op" id="1802444">(</span><span class="ident" id="1802445">p</span><span class="op" id="1802446">)</span>&nbsp;<span class="op" id="1802448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802452">ok</span>&nbsp;<span class="op" id="1802455">=</span>&nbsp;<span class="builtintype" id="1802457">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1802464">for</span>&nbsp;<span class="ident" id="1802468">b</span>&nbsp;<span class="op" id="1802470">:=</span>&nbsp;<span class="ident" id="1802473">bbuckets</span><span class="op" id="1802481">;</span>&nbsp;<span class="ident" id="1802483">b</span>&nbsp;<span class="op" id="1802485">!=</span>&nbsp;<span class="ident" id="1802488">nil</span><span class="op" id="1802491">;</span>&nbsp;<span class="ident" id="1802493">b</span>&nbsp;<span class="op" id="1802495">=</span>&nbsp;<span class="ident" id="1802497">b</span><span class="op" id="1802498">.</span><span class="ident" id="1802499">allnext</span>&nbsp;<span class="op" id="1802507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802512">bp</span>&nbsp;<span class="op" id="1802515">:=</span>&nbsp;<span class="ident" id="1802518">b</span><span class="op" id="1802519">.</span><span class="ident" id="1802520">bp</span><span class="op" id="1802522">(</span><span class="op" id="1802523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802528">r</span>&nbsp;<span class="op" id="1802530">:=</span>&nbsp;<span class="op" id="1802533">&amp;</span><span class="ident" id="1802534">p</span><span class="op" id="1802535">[</span><span class="num" id="1802536">0</span><span class="op" id="1802537">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802542">r</span><span class="op" id="1802543">.</span><span class="ident" id="1802544">Count</span>&nbsp;<span class="op" id="1802550">=</span>&nbsp;<span class="ident" id="1802552">int64</span><span class="op" id="1802557">(</span><span class="ident" id="1802558">bp</span><span class="op" id="1802560">.</span><span class="ident" id="1802561">count</span><span class="op" id="1802566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802571">r</span><span class="op" id="1802572">.</span><span class="ident" id="1802573">Cycles</span>&nbsp;<span class="op" id="1802580">=</span>&nbsp;<span class="ident" id="1802582">int64</span><span class="op" id="1802587">(</span><span class="ident" id="1802588">bp</span><span class="op" id="1802590">.</span><span class="ident" id="1802591">cycles</span><span class="op" id="1802597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802602">i</span>&nbsp;<span class="op" id="1802604">:=</span>&nbsp;<span class="builtinfunc" id="1802607">copy</span><span class="op" id="1802611">(</span><span class="ident" id="1802612">r</span><span class="op" id="1802613">.</span><span class="ident" id="1802614">Stack0</span><span class="op" id="1802620">[</span><span class="op" id="1802621">:</span><span class="op" id="1802622">]</span><span class="op" id="1802623">,</span>&nbsp;<span class="ident" id="1802625">b</span><span class="op" id="1802626">.</span><span class="ident" id="1802627">stk</span><span class="op" id="1802630">(</span><span class="op" id="1802631">)</span><span class="op" id="1802632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1802637">for</span>&nbsp;<span class="op" id="1802641">;</span>&nbsp;<span class="ident" id="1802643">i</span>&nbsp;<span class="op" id="1802645">&lt;</span>&nbsp;<span class="builtinfunc" id="1802647">len</span><span class="op" id="1802650">(</span><span class="ident" id="1802651">r</span><span class="op" id="1802652">.</span><span class="ident" id="1802653">Stack0</span><span class="op" id="1802659">)</span><span class="op" id="1802660">;</span>&nbsp;<span class="ident" id="1802662">i</span><span class="op" id="1802663">++</span>&nbsp;<span class="op" id="1802666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802672">r</span><span class="op" id="1802673">.</span><span class="ident" id="1802674">Stack0</span><span class="op" id="1802680">[</span><span class="ident" id="1802681">i</span><span class="op" id="1802682">]</span>&nbsp;<span class="op" id="1802684">=</span>&nbsp;<span class="num" id="1802686">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1802691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802696">p</span>&nbsp;<span class="op" id="1802698">=</span>&nbsp;<span class="ident" id="1802700">p</span><span class="op" id="1802701">[</span><span class="num" id="1802702">1</span><span class="op" id="1802703">:</span><span class="op" id="1802704">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1802708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1802711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1802714">unlock</span><span class="op" id="1802720">(</span><span class="op" id="1802721">&amp;</span><span class="ident" id="1802722">proflock</span><span class="op" id="1802730">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1802733">return</span><br>
<span class="lineno"></span><span class="op" id="1802740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1802743">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1802831">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1802917">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1802995">//</span><br>
<span class="lineno"></span><span class="comment" id="1802998">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1803059">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1803103">func</span>&nbsp;<span class="ident" id="1803108">ThreadCreateProfile</span><span class="op" id="1803127">(</span><span class="ident" id="1803128">p</span>&nbsp;<span class="op" id="1803130">[</span><span class="op" id="1803131">]</span><span class="ident" id="1803132">StackRecord</span><span class="op" id="1803143">)</span>&nbsp;<span class="op" id="1803145">(</span><span class="ident" id="1803146">n</span>&nbsp;<span class="builtintype" id="1803148">int</span><span class="op" id="1803151">,</span>&nbsp;<span class="ident" id="1803153">ok</span>&nbsp;<span class="builtintype" id="1803156">bool</span><span class="op" id="1803160">)</span>&nbsp;<span class="op" id="1803162">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803165">first</span>&nbsp;<span class="op" id="1803171">:=</span>&nbsp;<span class="op" id="1803174">(</span><span class="op" id="1803175">*</span><span class="ident" id="1803176">m</span><span class="op" id="1803177">)</span><span class="op" id="1803178">(</span><span class="ident" id="1803179">atomicloadp</span><span class="op" id="1803190">(</span><span class="ident" id="1803191">unsafe</span><span class="op" id="1803197">.</span><span class="ident" id="1803198">Pointer</span><span class="op" id="1803205">(</span><span class="op" id="1803206">&amp;</span><span class="ident" id="1803207">allm</span><span class="op" id="1803211">)</span><span class="op" id="1803212">)</span><span class="op" id="1803213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803216">for</span>&nbsp;<span class="ident" id="1803220">mp</span>&nbsp;<span class="op" id="1803223">:=</span>&nbsp;<span class="ident" id="1803226">first</span><span class="op" id="1803231">;</span>&nbsp;<span class="ident" id="1803233">mp</span>&nbsp;<span class="op" id="1803236">!=</span>&nbsp;<span class="ident" id="1803239">nil</span><span class="op" id="1803242">;</span>&nbsp;<span class="ident" id="1803244">mp</span>&nbsp;<span class="op" id="1803247">=</span>&nbsp;<span class="ident" id="1803249">mp</span><span class="op" id="1803251">.</span><span class="ident" id="1803252">alllink</span>&nbsp;<span class="op" id="1803260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803264">n</span><span class="op" id="1803265">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1803269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803272">if</span>&nbsp;<span class="ident" id="1803275">n</span>&nbsp;<span class="op" id="1803277">&lt;=</span>&nbsp;<span class="builtinfunc" id="1803280">len</span><span class="op" id="1803283">(</span><span class="ident" id="1803284">p</span><span class="op" id="1803285">)</span>&nbsp;<span class="op" id="1803287">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803291">ok</span>&nbsp;<span class="op" id="1803294">=</span>&nbsp;<span class="builtintype" id="1803296">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803303">i</span>&nbsp;<span class="op" id="1803305">:=</span>&nbsp;<span class="num" id="1803308">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803312">for</span>&nbsp;<span class="ident" id="1803316">mp</span>&nbsp;<span class="op" id="1803319">:=</span>&nbsp;<span class="ident" id="1803322">first</span><span class="op" id="1803327">;</span>&nbsp;<span class="ident" id="1803329">mp</span>&nbsp;<span class="op" id="1803332">!=</span>&nbsp;<span class="ident" id="1803335">nil</span><span class="op" id="1803338">;</span>&nbsp;<span class="ident" id="1803340">mp</span>&nbsp;<span class="op" id="1803343">=</span>&nbsp;<span class="ident" id="1803345">mp</span><span class="op" id="1803347">.</span><span class="ident" id="1803348">alllink</span>&nbsp;<span class="op" id="1803356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803361">for</span>&nbsp;<span class="ident" id="1803365">s</span>&nbsp;<span class="op" id="1803367">:=</span>&nbsp;<span class="keyword" id="1803370">range</span>&nbsp;<span class="ident" id="1803376">mp</span><span class="op" id="1803378">.</span><span class="ident" id="1803379">createstack</span>&nbsp;<span class="op" id="1803391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803397">p</span><span class="op" id="1803398">[</span><span class="ident" id="1803399">i</span><span class="op" id="1803400">]</span><span class="op" id="1803401">.</span><span class="ident" id="1803402">Stack0</span><span class="op" id="1803408">[</span><span class="ident" id="1803409">s</span><span class="op" id="1803410">]</span>&nbsp;<span class="op" id="1803412">=</span>&nbsp;<span class="builtintype" id="1803414">uintptr</span><span class="op" id="1803421">(</span><span class="ident" id="1803422">mp</span><span class="op" id="1803424">.</span><span class="ident" id="1803425">createstack</span><span class="op" id="1803436">[</span><span class="ident" id="1803437">s</span><span class="op" id="1803438">]</span><span class="op" id="1803439">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1803444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803449">i</span><span class="op" id="1803450">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1803455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1803458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803461">return</span><br>
<span class="lineno">520</span><span class="op" id="1803468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1803471">var</span>&nbsp;<span class="ident" id="1803475">allgs</span>&nbsp;<span class="op" id="1803481">[</span><span class="op" id="1803482">]</span><span class="op" id="1803483">*</span><span class="ident" id="1803484">g</span>&nbsp;<span class="comment" id="1803486">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1803497">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1803589">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1803672">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1803747">//</span><br>
<span class="lineno"></span><span class="comment" id="1803750">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1803811">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1803852">func</span>&nbsp;<span class="ident" id="1803857">GoroutineProfile</span><span class="op" id="1803873">(</span><span class="ident" id="1803874">p</span>&nbsp;<span class="op" id="1803876">[</span><span class="op" id="1803877">]</span><span class="ident" id="1803878">StackRecord</span><span class="op" id="1803889">)</span>&nbsp;<span class="op" id="1803891">(</span><span class="ident" id="1803892">n</span>&nbsp;<span class="builtintype" id="1803894">int</span><span class="op" id="1803897">,</span>&nbsp;<span class="ident" id="1803899">ok</span>&nbsp;<span class="builtintype" id="1803902">bool</span><span class="op" id="1803906">)</span>&nbsp;<span class="op" id="1803908">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803912">n</span>&nbsp;<span class="op" id="1803914">=</span>&nbsp;<span class="ident" id="1803916">NumGoroutine</span><span class="op" id="1803928">(</span><span class="op" id="1803929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1803932">if</span>&nbsp;<span class="ident" id="1803935">n</span>&nbsp;<span class="op" id="1803937">&lt;=</span>&nbsp;<span class="builtinfunc" id="1803940">len</span><span class="op" id="1803943">(</span><span class="ident" id="1803944">p</span><span class="op" id="1803945">)</span>&nbsp;<span class="op" id="1803947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803951">gp</span>&nbsp;<span class="op" id="1803954">:=</span>&nbsp;<span class="ident" id="1803957">getg</span><span class="op" id="1803961">(</span><span class="op" id="1803962">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803966">semacquire</span><span class="op" id="1803976">(</span><span class="op" id="1803977">&amp;</span><span class="ident" id="1803978">worldsema</span><span class="op" id="1803987">,</span>&nbsp;<span class="builtintype" id="1803989">false</span><span class="op" id="1803994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1803998">gp</span><span class="op" id="1804000">.</span><span class="ident" id="1804001">m</span><span class="op" id="1804002">.</span><span class="ident" id="1804003">gcing</span>&nbsp;<span class="op" id="1804009">=</span>&nbsp;<span class="num" id="1804011">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804015">onM</span><span class="op" id="1804018">(</span><span class="ident" id="1804019">stoptheworld</span><span class="op" id="1804031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804036">n</span>&nbsp;<span class="op" id="1804038">=</span>&nbsp;<span class="ident" id="1804040">NumGoroutine</span><span class="op" id="1804052">(</span><span class="op" id="1804053">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804057">if</span>&nbsp;<span class="ident" id="1804060">n</span>&nbsp;<span class="op" id="1804062">&lt;=</span>&nbsp;<span class="builtinfunc" id="1804065">len</span><span class="op" id="1804068">(</span><span class="ident" id="1804069">p</span><span class="op" id="1804070">)</span>&nbsp;<span class="op" id="1804072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804077">ok</span>&nbsp;<span class="op" id="1804080">=</span>&nbsp;<span class="builtintype" id="1804082">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804090">r</span>&nbsp;<span class="op" id="1804092">:=</span>&nbsp;<span class="ident" id="1804095">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804100">sp</span>&nbsp;<span class="op" id="1804103">:=</span>&nbsp;<span class="ident" id="1804106">getcallersp</span><span class="op" id="1804117">(</span><span class="ident" id="1804118">unsafe</span><span class="op" id="1804124">.</span><span class="ident" id="1804125">Pointer</span><span class="op" id="1804132">(</span><span class="op" id="1804133">&amp;</span><span class="ident" id="1804134">p</span><span class="op" id="1804135">)</span><span class="op" id="1804136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804141">pc</span>&nbsp;<span class="op" id="1804144">:=</span>&nbsp;<span class="ident" id="1804147">getcallerpc</span><span class="op" id="1804158">(</span><span class="ident" id="1804159">unsafe</span><span class="op" id="1804165">.</span><span class="ident" id="1804166">Pointer</span><span class="op" id="1804173">(</span><span class="op" id="1804174">&amp;</span><span class="ident" id="1804175">p</span><span class="op" id="1804176">)</span><span class="op" id="1804177">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804182">onM</span><span class="op" id="1804185">(</span><span class="keyword" id="1804186">func</span><span class="op" id="1804190">(</span><span class="op" id="1804191">)</span>&nbsp;<span class="op" id="1804193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804199">saveg</span><span class="op" id="1804204">(</span><span class="ident" id="1804205">pc</span><span class="op" id="1804207">,</span>&nbsp;<span class="ident" id="1804209">sp</span><span class="op" id="1804211">,</span>&nbsp;<span class="ident" id="1804213">gp</span><span class="op" id="1804215">,</span>&nbsp;<span class="op" id="1804217">&amp;</span><span class="ident" id="1804218">r</span><span class="op" id="1804219">[</span><span class="num" id="1804220">0</span><span class="op" id="1804221">]</span><span class="op" id="1804222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804227">}</span><span class="op" id="1804228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804233">r</span>&nbsp;<span class="op" id="1804235">=</span>&nbsp;<span class="ident" id="1804237">r</span><span class="op" id="1804238">[</span><span class="num" id="1804239">1</span><span class="op" id="1804240">:</span><span class="op" id="1804241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804246">for</span>&nbsp;<span class="ident" id="1804250">_</span><span class="op" id="1804251">,</span>&nbsp;<span class="ident" id="1804253">gp1</span>&nbsp;<span class="op" id="1804257">:=</span>&nbsp;<span class="keyword" id="1804260">range</span>&nbsp;<span class="ident" id="1804266">allgs</span>&nbsp;<span class="op" id="1804272">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804278">if</span>&nbsp;<span class="ident" id="1804281">gp1</span>&nbsp;<span class="op" id="1804285">==</span>&nbsp;<span class="ident" id="1804288">gp</span>&nbsp;<span class="op" id="1804291">||</span>&nbsp;<span class="ident" id="1804294">readgstatus</span><span class="op" id="1804305">(</span><span class="ident" id="1804306">gp1</span><span class="op" id="1804309">)</span>&nbsp;<span class="op" id="1804311">==</span>&nbsp;<span class="ident" id="1804314">_Gdead</span>&nbsp;<span class="op" id="1804321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804328">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804347">saveg</span><span class="op" id="1804352">(</span><span class="op" id="1804353">^</span><span class="builtintype" id="1804354">uintptr</span><span class="op" id="1804361">(</span><span class="num" id="1804362">0</span><span class="op" id="1804363">)</span><span class="op" id="1804364">,</span>&nbsp;<span class="op" id="1804366">^</span><span class="builtintype" id="1804367">uintptr</span><span class="op" id="1804374">(</span><span class="num" id="1804375">0</span><span class="op" id="1804376">)</span><span class="op" id="1804377">,</span>&nbsp;<span class="ident" id="1804379">gp1</span><span class="op" id="1804382">,</span>&nbsp;<span class="op" id="1804384">&amp;</span><span class="ident" id="1804385">r</span><span class="op" id="1804386">[</span><span class="num" id="1804387">0</span><span class="op" id="1804388">]</span><span class="op" id="1804389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804395">r</span>&nbsp;<span class="op" id="1804397">=</span>&nbsp;<span class="ident" id="1804399">r</span><span class="op" id="1804400">[</span><span class="num" id="1804401">1</span><span class="op" id="1804402">:</span><span class="op" id="1804403">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804417">gp</span><span class="op" id="1804419">.</span><span class="ident" id="1804420">m</span><span class="op" id="1804421">.</span><span class="ident" id="1804422">gcing</span>&nbsp;<span class="op" id="1804428">=</span>&nbsp;<span class="num" id="1804430">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804434">semrelease</span><span class="op" id="1804444">(</span><span class="op" id="1804445">&amp;</span><span class="ident" id="1804446">worldsema</span><span class="op" id="1804455">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804459">onM</span><span class="op" id="1804462">(</span><span class="ident" id="1804463">starttheworld</span><span class="op" id="1804476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804483">return</span>&nbsp;<span class="ident" id="1804490">n</span><span class="op" id="1804491">,</span>&nbsp;<span class="ident" id="1804493">ok</span><br>
<span class="lineno"></span><span class="op" id="1804496">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1804499">func</span>&nbsp;<span class="ident" id="1804504">saveg</span><span class="op" id="1804509">(</span><span class="ident" id="1804510">pc</span><span class="op" id="1804512">,</span>&nbsp;<span class="ident" id="1804514">sp</span>&nbsp;<span class="builtintype" id="1804517">uintptr</span><span class="op" id="1804524">,</span>&nbsp;<span class="ident" id="1804526">gp</span>&nbsp;<span class="op" id="1804529">*</span><span class="ident" id="1804530">g</span><span class="op" id="1804531">,</span>&nbsp;<span class="ident" id="1804533">r</span>&nbsp;<span class="op" id="1804535">*</span><span class="ident" id="1804536">StackRecord</span><span class="op" id="1804547">)</span>&nbsp;<span class="op" id="1804549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804552">n</span>&nbsp;<span class="op" id="1804554">:=</span>&nbsp;<span class="ident" id="1804557">gentraceback</span><span class="op" id="1804569">(</span><span class="ident" id="1804570">pc</span><span class="op" id="1804572">,</span>&nbsp;<span class="ident" id="1804574">sp</span><span class="op" id="1804576">,</span>&nbsp;<span class="num" id="1804578">0</span><span class="op" id="1804579">,</span>&nbsp;<span class="ident" id="1804581">gp</span><span class="op" id="1804583">,</span>&nbsp;<span class="num" id="1804585">0</span><span class="op" id="1804586">,</span>&nbsp;<span class="op" id="1804588">&amp;</span><span class="ident" id="1804589">r</span><span class="op" id="1804590">.</span><span class="ident" id="1804591">Stack0</span><span class="op" id="1804597">[</span><span class="num" id="1804598">0</span><span class="op" id="1804599">]</span><span class="op" id="1804600">,</span>&nbsp;<span class="builtinfunc" id="1804602">len</span><span class="op" id="1804605">(</span><span class="ident" id="1804606">r</span><span class="op" id="1804607">.</span><span class="ident" id="1804608">Stack0</span><span class="op" id="1804614">)</span><span class="op" id="1804615">,</span>&nbsp;<span class="ident" id="1804617">nil</span><span class="op" id="1804620">,</span>&nbsp;<span class="ident" id="1804622">nil</span><span class="op" id="1804625">,</span>&nbsp;<span class="num" id="1804627">0</span><span class="op" id="1804628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804631">if</span>&nbsp;<span class="ident" id="1804634">n</span>&nbsp;<span class="op" id="1804636">&lt;</span>&nbsp;<span class="builtinfunc" id="1804638">len</span><span class="op" id="1804641">(</span><span class="ident" id="1804642">r</span><span class="op" id="1804643">.</span><span class="ident" id="1804644">Stack0</span><span class="op" id="1804650">)</span>&nbsp;<span class="op" id="1804652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804656">r</span><span class="op" id="1804657">.</span><span class="ident" id="1804658">Stack0</span><span class="op" id="1804664">[</span><span class="ident" id="1804665">n</span><span class="op" id="1804666">]</span>&nbsp;<span class="op" id="1804668">=</span>&nbsp;<span class="num" id="1804670">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1804673">}</span><br>
<span class="lineno"></span><span class="op" id="1804675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1804678">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1804743">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1804794">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1804864">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1804919">func</span>&nbsp;<span class="ident" id="1804924">Stack</span><span class="op" id="1804929">(</span><span class="ident" id="1804930">buf</span>&nbsp;<span class="op" id="1804934">[</span><span class="op" id="1804935">]</span><span class="builtintype" id="1804936">byte</span><span class="op" id="1804940">,</span>&nbsp;<span class="ident" id="1804942">all</span>&nbsp;<span class="builtintype" id="1804946">bool</span><span class="op" id="1804950">)</span>&nbsp;<span class="builtintype" id="1804952">int</span>&nbsp;<span class="op" id="1804956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804959">mp</span>&nbsp;<span class="op" id="1804962">:=</span>&nbsp;<span class="ident" id="1804965">acquirem</span><span class="op" id="1804973">(</span><span class="op" id="1804974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1804977">gp</span>&nbsp;<span class="op" id="1804980">:=</span>&nbsp;<span class="ident" id="1804983">mp</span><span class="op" id="1804985">.</span><span class="ident" id="1804986">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1804992">if</span>&nbsp;<span class="ident" id="1804995">all</span>&nbsp;<span class="op" id="1804999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805003">semacquire</span><span class="op" id="1805013">(</span><span class="op" id="1805014">&amp;</span><span class="ident" id="1805015">worldsema</span><span class="op" id="1805024">,</span>&nbsp;<span class="builtintype" id="1805026">false</span><span class="op" id="1805031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805035">mp</span><span class="op" id="1805037">.</span><span class="ident" id="1805038">gcing</span>&nbsp;<span class="op" id="1805044">=</span>&nbsp;<span class="num" id="1805046">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805050">releasem</span><span class="op" id="1805058">(</span><span class="ident" id="1805059">mp</span><span class="op" id="1805061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805065">onM</span><span class="op" id="1805068">(</span><span class="ident" id="1805069">stoptheworld</span><span class="op" id="1805081">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805085">if</span>&nbsp;<span class="ident" id="1805088">mp</span>&nbsp;<span class="op" id="1805091">!=</span>&nbsp;<span class="ident" id="1805094">acquirem</span><span class="op" id="1805102">(</span><span class="op" id="1805103">)</span>&nbsp;<span class="op" id="1805105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805110">gothrow</span><span class="op" id="1805117">(</span><span class="string" id="1805118">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1805138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805149">n</span>&nbsp;<span class="op" id="1805151">:=</span>&nbsp;<span class="num" id="1805154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805157">if</span>&nbsp;<span class="builtinfunc" id="1805160">len</span><span class="op" id="1805163">(</span><span class="ident" id="1805164">buf</span><span class="op" id="1805167">)</span>&nbsp;<span class="op" id="1805169">&gt;</span>&nbsp;<span class="num" id="1805171">0</span>&nbsp;<span class="op" id="1805173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805177">sp</span>&nbsp;<span class="op" id="1805180">:=</span>&nbsp;<span class="ident" id="1805183">getcallersp</span><span class="op" id="1805194">(</span><span class="ident" id="1805195">unsafe</span><span class="op" id="1805201">.</span><span class="ident" id="1805202">Pointer</span><span class="op" id="1805209">(</span><span class="op" id="1805210">&amp;</span><span class="ident" id="1805211">buf</span><span class="op" id="1805214">)</span><span class="op" id="1805215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805219">pc</span>&nbsp;<span class="op" id="1805222">:=</span>&nbsp;<span class="ident" id="1805225">getcallerpc</span><span class="op" id="1805236">(</span><span class="ident" id="1805237">unsafe</span><span class="op" id="1805243">.</span><span class="ident" id="1805244">Pointer</span><span class="op" id="1805251">(</span><span class="op" id="1805252">&amp;</span><span class="ident" id="1805253">buf</span><span class="op" id="1805256">)</span><span class="op" id="1805257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805261">onM</span><span class="op" id="1805264">(</span><span class="keyword" id="1805265">func</span><span class="op" id="1805269">(</span><span class="op" id="1805270">)</span>&nbsp;<span class="op" id="1805272">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805277">g0</span>&nbsp;<span class="op" id="1805280">:=</span>&nbsp;<span class="ident" id="1805283">getg</span><span class="op" id="1805287">(</span><span class="op" id="1805288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805293">g0</span><span class="op" id="1805295">.</span><span class="ident" id="1805296">writebuf</span>&nbsp;<span class="op" id="1805305">=</span>&nbsp;<span class="ident" id="1805307">buf</span><span class="op" id="1805310">[</span><span class="num" id="1805311">0</span><span class="op" id="1805312">:</span><span class="num" id="1805313">0</span><span class="op" id="1805314">:</span><span class="builtinfunc" id="1805315">len</span><span class="op" id="1805318">(</span><span class="ident" id="1805319">buf</span><span class="op" id="1805322">)</span><span class="op" id="1805323">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805328">goroutineheader</span><span class="op" id="1805343">(</span><span class="ident" id="1805344">gp</span><span class="op" id="1805346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805351">traceback</span><span class="op" id="1805360">(</span><span class="ident" id="1805361">pc</span><span class="op" id="1805363">,</span>&nbsp;<span class="ident" id="1805365">sp</span><span class="op" id="1805367">,</span>&nbsp;<span class="num" id="1805369">0</span><span class="op" id="1805370">,</span>&nbsp;<span class="ident" id="1805372">gp</span><span class="op" id="1805374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805379">if</span>&nbsp;<span class="ident" id="1805382">all</span>&nbsp;<span class="op" id="1805386">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805392">tracebackothers</span><span class="op" id="1805407">(</span><span class="ident" id="1805408">gp</span><span class="op" id="1805410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805420">n</span>&nbsp;<span class="op" id="1805422">=</span>&nbsp;<span class="builtinfunc" id="1805424">len</span><span class="op" id="1805427">(</span><span class="ident" id="1805428">g0</span><span class="op" id="1805430">.</span><span class="ident" id="1805431">writebuf</span><span class="op" id="1805439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805444">g0</span><span class="op" id="1805446">.</span><span class="ident" id="1805447">writebuf</span>&nbsp;<span class="op" id="1805456">=</span>&nbsp;<span class="ident" id="1805458">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805464">}</span><span class="op" id="1805465">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805472">if</span>&nbsp;<span class="ident" id="1805475">all</span>&nbsp;<span class="op" id="1805479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805483">mp</span><span class="op" id="1805485">.</span><span class="ident" id="1805486">gcing</span>&nbsp;<span class="op" id="1805492">=</span>&nbsp;<span class="num" id="1805494">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805498">semrelease</span><span class="op" id="1805508">(</span><span class="op" id="1805509">&amp;</span><span class="ident" id="1805510">worldsema</span><span class="op" id="1805519">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805523">onM</span><span class="op" id="1805526">(</span><span class="ident" id="1805527">starttheworld</span><span class="op" id="1805540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805546">releasem</span><span class="op" id="1805554">(</span><span class="ident" id="1805555">mp</span><span class="op" id="1805557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805560">return</span>&nbsp;<span class="ident" id="1805567">n</span><br>
<span class="lineno"></span><span class="op" id="1805569">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1805572">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1805602">var</span>&nbsp;<span class="ident" id="1805606">tracelock</span>&nbsp;<span class="ident" id="1805616">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1805623">func</span>&nbsp;<span class="ident" id="1805628">tracealloc</span><span class="op" id="1805638">(</span><span class="ident" id="1805639">p</span>&nbsp;<span class="ident" id="1805641">unsafe</span><span class="op" id="1805647">.</span><span class="ident" id="1805648">Pointer</span><span class="op" id="1805655">,</span>&nbsp;<span class="ident" id="1805657">size</span>&nbsp;<span class="builtintype" id="1805662">uintptr</span><span class="op" id="1805669">,</span>&nbsp;<span class="ident" id="1805671">typ</span>&nbsp;<span class="op" id="1805675">*</span><span class="ident" id="1805676">_type</span><span class="op" id="1805681">)</span>&nbsp;<span class="op" id="1805683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805686">lock</span><span class="op" id="1805690">(</span><span class="op" id="1805691">&amp;</span><span class="ident" id="1805692">tracelock</span><span class="op" id="1805701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805704">gp</span>&nbsp;<span class="op" id="1805707">:=</span>&nbsp;<span class="ident" id="1805710">getg</span><span class="op" id="1805714">(</span><span class="op" id="1805715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805718">gp</span><span class="op" id="1805720">.</span><span class="ident" id="1805721">m</span><span class="op" id="1805722">.</span><span class="ident" id="1805723">traceback</span>&nbsp;<span class="op" id="1805733">=</span>&nbsp;<span class="num" id="1805735">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805738">if</span>&nbsp;<span class="ident" id="1805741">typ</span>&nbsp;<span class="op" id="1805745">==</span>&nbsp;<span class="ident" id="1805748">nil</span>&nbsp;<span class="op" id="1805752">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1805756">print</span><span class="op" id="1805761">(</span><span class="string" id="1805762">&#34;tracealloc(&#34;</span><span class="op" id="1805775">,</span>&nbsp;<span class="ident" id="1805777">p</span><span class="op" id="1805778">,</span>&nbsp;<span class="string" id="1805780">&#34;,&nbsp;&#34;</span><span class="op" id="1805784">,</span>&nbsp;<span class="ident" id="1805786">hex</span><span class="op" id="1805789">(</span><span class="ident" id="1805790">size</span><span class="op" id="1805794">)</span><span class="op" id="1805795">,</span>&nbsp;<span class="string" id="1805797">&#34;)\n&#34;</span><span class="op" id="1805802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805805">}</span>&nbsp;<span class="keyword" id="1805807">else</span>&nbsp;<span class="op" id="1805812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1805816">print</span><span class="op" id="1805821">(</span><span class="string" id="1805822">&#34;tracealloc(&#34;</span><span class="op" id="1805835">,</span>&nbsp;<span class="ident" id="1805837">p</span><span class="op" id="1805838">,</span>&nbsp;<span class="string" id="1805840">&#34;,&nbsp;&#34;</span><span class="op" id="1805844">,</span>&nbsp;<span class="ident" id="1805846">hex</span><span class="op" id="1805849">(</span><span class="ident" id="1805850">size</span><span class="op" id="1805854">)</span><span class="op" id="1805855">,</span>&nbsp;<span class="string" id="1805857">&#34;,&nbsp;&#34;</span><span class="op" id="1805861">,</span>&nbsp;<span class="op" id="1805863">*</span><span class="ident" id="1805864">typ</span><span class="op" id="1805867">.</span><span class="ident" id="1805868">_string</span><span class="op" id="1805875">,</span>&nbsp;<span class="string" id="1805877">&#34;)\n&#34;</span><span class="op" id="1805882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1805885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1805888">if</span>&nbsp;<span class="ident" id="1805891">gp</span><span class="op" id="1805893">.</span><span class="ident" id="1805894">m</span><span class="op" id="1805895">.</span><span class="ident" id="1805896">curg</span>&nbsp;<span class="op" id="1805901">==</span>&nbsp;<span class="ident" id="1805904">nil</span>&nbsp;<span class="op" id="1805908">||</span>&nbsp;<span class="ident" id="1805911">gp</span>&nbsp;<span class="op" id="1805914">==</span>&nbsp;<span class="ident" id="1805917">gp</span><span class="op" id="1805919">.</span><span class="ident" id="1805920">m</span><span class="op" id="1805921">.</span><span class="ident" id="1805922">curg</span>&nbsp;<span class="op" id="1805927">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805931">goroutineheader</span><span class="op" id="1805946">(</span><span class="ident" id="1805947">gp</span><span class="op" id="1805949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805953">pc</span>&nbsp;<span class="op" id="1805956">:=</span>&nbsp;<span class="ident" id="1805959">getcallerpc</span><span class="op" id="1805970">(</span><span class="ident" id="1805971">unsafe</span><span class="op" id="1805977">.</span><span class="ident" id="1805978">Pointer</span><span class="op" id="1805985">(</span><span class="op" id="1805986">&amp;</span><span class="ident" id="1805987">p</span><span class="op" id="1805988">)</span><span class="op" id="1805989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1805993">sp</span>&nbsp;<span class="op" id="1805996">:=</span>&nbsp;<span class="ident" id="1805999">getcallersp</span><span class="op" id="1806010">(</span><span class="ident" id="1806011">unsafe</span><span class="op" id="1806017">.</span><span class="ident" id="1806018">Pointer</span><span class="op" id="1806025">(</span><span class="op" id="1806026">&amp;</span><span class="ident" id="1806027">p</span><span class="op" id="1806028">)</span><span class="op" id="1806029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806033">onM</span><span class="op" id="1806036">(</span><span class="keyword" id="1806037">func</span><span class="op" id="1806041">(</span><span class="op" id="1806042">)</span>&nbsp;<span class="op" id="1806044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806049">traceback</span><span class="op" id="1806058">(</span><span class="ident" id="1806059">pc</span><span class="op" id="1806061">,</span>&nbsp;<span class="ident" id="1806063">sp</span><span class="op" id="1806065">,</span>&nbsp;<span class="num" id="1806067">0</span><span class="op" id="1806068">,</span>&nbsp;<span class="ident" id="1806070">gp</span><span class="op" id="1806072">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1806076">}</span><span class="op" id="1806077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1806080">}</span>&nbsp;<span class="keyword" id="1806082">else</span>&nbsp;<span class="op" id="1806087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806091">goroutineheader</span><span class="op" id="1806106">(</span><span class="ident" id="1806107">gp</span><span class="op" id="1806109">.</span><span class="ident" id="1806110">m</span><span class="op" id="1806111">.</span><span class="ident" id="1806112">curg</span><span class="op" id="1806116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806120">traceback</span><span class="op" id="1806129">(</span><span class="op" id="1806130">^</span><span class="builtintype" id="1806131">uintptr</span><span class="op" id="1806138">(</span><span class="num" id="1806139">0</span><span class="op" id="1806140">)</span><span class="op" id="1806141">,</span>&nbsp;<span class="op" id="1806143">^</span><span class="builtintype" id="1806144">uintptr</span><span class="op" id="1806151">(</span><span class="num" id="1806152">0</span><span class="op" id="1806153">)</span><span class="op" id="1806154">,</span>&nbsp;<span class="num" id="1806156">0</span><span class="op" id="1806157">,</span>&nbsp;<span class="ident" id="1806159">gp</span><span class="op" id="1806161">.</span><span class="ident" id="1806162">m</span><span class="op" id="1806163">.</span><span class="ident" id="1806164">curg</span><span class="op" id="1806168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1806171">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806174">print</span><span class="op" id="1806179">(</span><span class="string" id="1806180">&#34;\n&#34;</span><span class="op" id="1806184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806187">gp</span><span class="op" id="1806189">.</span><span class="ident" id="1806190">m</span><span class="op" id="1806191">.</span><span class="ident" id="1806192">traceback</span>&nbsp;<span class="op" id="1806202">=</span>&nbsp;<span class="num" id="1806204">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806207">unlock</span><span class="op" id="1806213">(</span><span class="op" id="1806214">&amp;</span><span class="ident" id="1806215">tracelock</span><span class="op" id="1806224">)</span><br>
<span class="lineno"></span><span class="op" id="1806226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1806229">func</span>&nbsp;<span class="ident" id="1806234">tracefree</span><span class="op" id="1806243">(</span><span class="ident" id="1806244">p</span>&nbsp;<span class="ident" id="1806246">unsafe</span><span class="op" id="1806252">.</span><span class="ident" id="1806253">Pointer</span><span class="op" id="1806260">,</span>&nbsp;<span class="ident" id="1806262">size</span>&nbsp;<span class="builtintype" id="1806267">uintptr</span><span class="op" id="1806274">)</span>&nbsp;<span class="op" id="1806276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806279">lock</span><span class="op" id="1806283">(</span><span class="op" id="1806284">&amp;</span><span class="ident" id="1806285">tracelock</span><span class="op" id="1806294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806297">gp</span>&nbsp;<span class="op" id="1806300">:=</span>&nbsp;<span class="ident" id="1806303">getg</span><span class="op" id="1806307">(</span><span class="op" id="1806308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806311">gp</span><span class="op" id="1806313">.</span><span class="ident" id="1806314">m</span><span class="op" id="1806315">.</span><span class="ident" id="1806316">traceback</span>&nbsp;<span class="op" id="1806326">=</span>&nbsp;<span class="num" id="1806328">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806331">print</span><span class="op" id="1806336">(</span><span class="string" id="1806337">&#34;tracefree(&#34;</span><span class="op" id="1806349">,</span>&nbsp;<span class="ident" id="1806351">p</span><span class="op" id="1806352">,</span>&nbsp;<span class="string" id="1806354">&#34;,&nbsp;&#34;</span><span class="op" id="1806358">,</span>&nbsp;<span class="ident" id="1806360">hex</span><span class="op" id="1806363">(</span><span class="ident" id="1806364">size</span><span class="op" id="1806368">)</span><span class="op" id="1806369">,</span>&nbsp;<span class="string" id="1806371">&#34;)\n&#34;</span><span class="op" id="1806376">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806379">goroutineheader</span><span class="op" id="1806394">(</span><span class="ident" id="1806395">gp</span><span class="op" id="1806397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806400">pc</span>&nbsp;<span class="op" id="1806403">:=</span>&nbsp;<span class="ident" id="1806406">getcallerpc</span><span class="op" id="1806417">(</span><span class="ident" id="1806418">unsafe</span><span class="op" id="1806424">.</span><span class="ident" id="1806425">Pointer</span><span class="op" id="1806432">(</span><span class="op" id="1806433">&amp;</span><span class="ident" id="1806434">p</span><span class="op" id="1806435">)</span><span class="op" id="1806436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806439">sp</span>&nbsp;<span class="op" id="1806442">:=</span>&nbsp;<span class="ident" id="1806445">getcallersp</span><span class="op" id="1806456">(</span><span class="ident" id="1806457">unsafe</span><span class="op" id="1806463">.</span><span class="ident" id="1806464">Pointer</span><span class="op" id="1806471">(</span><span class="op" id="1806472">&amp;</span><span class="ident" id="1806473">p</span><span class="op" id="1806474">)</span><span class="op" id="1806475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806478">onM</span><span class="op" id="1806481">(</span><span class="keyword" id="1806482">func</span><span class="op" id="1806486">(</span><span class="op" id="1806487">)</span>&nbsp;<span class="op" id="1806489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806493">traceback</span><span class="op" id="1806502">(</span><span class="ident" id="1806503">pc</span><span class="op" id="1806505">,</span>&nbsp;<span class="ident" id="1806507">sp</span><span class="op" id="1806509">,</span>&nbsp;<span class="num" id="1806511">0</span><span class="op" id="1806512">,</span>&nbsp;<span class="ident" id="1806514">gp</span><span class="op" id="1806516">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1806519">}</span><span class="op" id="1806520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806523">print</span><span class="op" id="1806528">(</span><span class="string" id="1806529">&#34;\n&#34;</span><span class="op" id="1806533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806536">gp</span><span class="op" id="1806538">.</span><span class="ident" id="1806539">m</span><span class="op" id="1806540">.</span><span class="ident" id="1806541">traceback</span>&nbsp;<span class="op" id="1806551">=</span>&nbsp;<span class="num" id="1806553">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806556">unlock</span><span class="op" id="1806562">(</span><span class="op" id="1806563">&amp;</span><span class="ident" id="1806564">tracelock</span><span class="op" id="1806573">)</span><br>
<span class="lineno"></span><span class="op" id="1806575">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1806578">func</span>&nbsp;<span class="ident" id="1806583">tracegc</span><span class="op" id="1806590">(</span><span class="op" id="1806591">)</span>&nbsp;<span class="op" id="1806593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806596">lock</span><span class="op" id="1806600">(</span><span class="op" id="1806601">&amp;</span><span class="ident" id="1806602">tracelock</span><span class="op" id="1806611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806614">gp</span>&nbsp;<span class="op" id="1806617">:=</span>&nbsp;<span class="ident" id="1806620">getg</span><span class="op" id="1806624">(</span><span class="op" id="1806625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806628">gp</span><span class="op" id="1806630">.</span><span class="ident" id="1806631">m</span><span class="op" id="1806632">.</span><span class="ident" id="1806633">traceback</span>&nbsp;<span class="op" id="1806643">=</span>&nbsp;<span class="num" id="1806645">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806648">print</span><span class="op" id="1806653">(</span><span class="string" id="1806654">&#34;tracegc()\n&#34;</span><span class="op" id="1806667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1806670">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806725">tracebackothers</span><span class="op" id="1806740">(</span><span class="ident" id="1806741">gp</span><span class="op" id="1806743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806746">print</span><span class="op" id="1806751">(</span><span class="string" id="1806752">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1806767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1806770">print</span><span class="op" id="1806775">(</span><span class="string" id="1806776">&#34;\n&#34;</span><span class="op" id="1806780">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806783">gp</span><span class="op" id="1806785">.</span><span class="ident" id="1806786">m</span><span class="op" id="1806787">.</span><span class="ident" id="1806788">traceback</span>&nbsp;<span class="op" id="1806798">=</span>&nbsp;<span class="num" id="1806800">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1806803">unlock</span><span class="op" id="1806809">(</span><span class="op" id="1806810">&amp;</span><span class="ident" id="1806811">tracelock</span><span class="op" id="1806820">)</span><br>
<span class="lineno"></span><span class="op" id="1806822">}</span>
</div>
</body>
</html>
