<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4208200">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4208255">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4208309">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4208360">package</span>&nbsp;<span class="ident" id="4208368">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4208375">import</span>&nbsp;<span class="op" id="4208382">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208385">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208392">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4208398">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4208405">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4208408">const</span>&nbsp;<span class="op" id="4208414">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208417">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208436">=</span>&nbsp;<span class="num" id="4208438">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208441">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208460">=</span>&nbsp;<span class="num" id="4208462">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208465">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208484">=</span>&nbsp;<span class="num" id="4208486">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208489">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208508">=</span>&nbsp;<span class="num" id="4208510">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208513">DefaultCompression</span>&nbsp;<span class="op" id="4208532">=</span>&nbsp;<span class="op" id="4208534">-</span><span class="num" id="4208535">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208538">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208557">=</span>&nbsp;<span class="num" id="4208559">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208563">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208582">=</span>&nbsp;<span class="num" id="4208584">1</span>&nbsp;<span class="op" id="4208586">&lt;&lt;</span>&nbsp;<span class="ident" id="4208589">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208604">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208623">=</span>&nbsp;<span class="ident" id="4208625">windowSize</span>&nbsp;<span class="op" id="4208636">-</span>&nbsp;<span class="num" id="4208638">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208641">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4208660">=</span>&nbsp;<span class="num" id="4208662">15</span>&nbsp;&nbsp;<span class="comment" id="4208666">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208687">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208706">=</span>&nbsp;<span class="num" id="4208708">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4208712">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208765">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208784">=</span>&nbsp;<span class="num" id="4208786">258</span>&nbsp;<span class="comment" id="4208790">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208831">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208850">=</span>&nbsp;<span class="num" id="4208852">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4208856">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208902">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208977">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209017">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4209037">=</span>&nbsp;<span class="num" id="4209039">1</span>&nbsp;<span class="op" id="4209041">&lt;&lt;</span>&nbsp;<span class="num" id="4209044">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209048">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4209068">=</span>&nbsp;<span class="num" id="4209070">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209077">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209097">=</span>&nbsp;<span class="num" id="4209099">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209103">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209123">=</span>&nbsp;<span class="num" id="4209125">1</span>&nbsp;<span class="op" id="4209127">&lt;&lt;</span>&nbsp;<span class="ident" id="4209130">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209140">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209160">=</span>&nbsp;<span class="op" id="4209162">(</span><span class="num" id="4209163">1</span>&nbsp;<span class="op" id="4209165">&lt;&lt;</span>&nbsp;<span class="ident" id="4209168">hashBits</span><span class="op" id="4209176">)</span>&nbsp;<span class="op" id="4209178">-</span>&nbsp;<span class="num" id="4209180">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209183">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209203">=</span>&nbsp;<span class="op" id="4209205">(</span><span class="ident" id="4209206">hashBits</span>&nbsp;<span class="op" id="4209215">+</span>&nbsp;<span class="ident" id="4209217">minMatchLength</span>&nbsp;<span class="op" id="4209232">-</span>&nbsp;<span class="num" id="4209234">1</span><span class="op" id="4209235">)</span>&nbsp;<span class="op" id="4209237">/</span>&nbsp;<span class="ident" id="4209239">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209255">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209275">=</span>&nbsp;<span class="num" id="4209277">1</span>&nbsp;<span class="op" id="4209279">&lt;&lt;</span>&nbsp;<span class="num" id="4209282">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209287">skipNever</span>&nbsp;<span class="op" id="4209297">=</span>&nbsp;<span class="ident" id="4209299">math</span><span class="op" id="4209303">.</span><span class="ident" id="4209304">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4209313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4209316">type</span>&nbsp;<span class="ident" id="4209321">compressionLevel</span>&nbsp;<span class="keyword" id="4209338">struct</span>&nbsp;<span class="op" id="4209345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209348">good</span><span class="op" id="4209352">,</span>&nbsp;<span class="ident" id="4209354">lazy</span><span class="op" id="4209358">,</span>&nbsp;<span class="ident" id="4209360">nice</span><span class="op" id="4209364">,</span>&nbsp;<span class="ident" id="4209366">chain</span><span class="op" id="4209371">,</span>&nbsp;<span class="ident" id="4209373">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4209389">int</span><br>
<span class="lineno"></span><span class="op" id="4209393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209396">var</span>&nbsp;<span class="ident" id="4209400">levels</span>&nbsp;<span class="op" id="4209407">=</span>&nbsp;<span class="op" id="4209409">[</span><span class="op" id="4209410">]</span><span class="ident" id="4209411">compressionLevel</span><span class="op" id="4209427">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209430">{</span><span class="op" id="4209431">}</span><span class="op" id="4209432">,</span>&nbsp;<span class="comment" id="4209434">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209440">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209500">{</span><span class="num" id="4209501">3</span><span class="op" id="4209502">,</span>&nbsp;<span class="num" id="4209504">0</span><span class="op" id="4209505">,</span>&nbsp;<span class="num" id="4209507">8</span><span class="op" id="4209508">,</span>&nbsp;<span class="num" id="4209510">4</span><span class="op" id="4209511">,</span>&nbsp;<span class="num" id="4209513">4</span><span class="op" id="4209514">}</span><span class="op" id="4209515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209518">{</span><span class="num" id="4209519">3</span><span class="op" id="4209520">,</span>&nbsp;<span class="num" id="4209522">0</span><span class="op" id="4209523">,</span>&nbsp;<span class="num" id="4209525">16</span><span class="op" id="4209527">,</span>&nbsp;<span class="num" id="4209529">8</span><span class="op" id="4209530">,</span>&nbsp;<span class="num" id="4209532">5</span><span class="op" id="4209533">}</span><span class="op" id="4209534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209537">{</span><span class="num" id="4209538">3</span><span class="op" id="4209539">,</span>&nbsp;<span class="num" id="4209541">0</span><span class="op" id="4209542">,</span>&nbsp;<span class="num" id="4209544">32</span><span class="op" id="4209546">,</span>&nbsp;<span class="num" id="4209548">32</span><span class="op" id="4209550">,</span>&nbsp;<span class="num" id="4209552">6</span><span class="op" id="4209553">}</span><span class="op" id="4209554">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209557">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209608">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209669">{</span><span class="num" id="4209670">4</span><span class="op" id="4209671">,</span>&nbsp;<span class="num" id="4209673">4</span><span class="op" id="4209674">,</span>&nbsp;<span class="num" id="4209676">16</span><span class="op" id="4209678">,</span>&nbsp;<span class="num" id="4209680">16</span><span class="op" id="4209682">,</span>&nbsp;<span class="ident" id="4209684">skipNever</span><span class="op" id="4209693">}</span><span class="op" id="4209694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209697">{</span><span class="num" id="4209698">8</span><span class="op" id="4209699">,</span>&nbsp;<span class="num" id="4209701">16</span><span class="op" id="4209703">,</span>&nbsp;<span class="num" id="4209705">32</span><span class="op" id="4209707">,</span>&nbsp;<span class="num" id="4209709">32</span><span class="op" id="4209711">,</span>&nbsp;<span class="ident" id="4209713">skipNever</span><span class="op" id="4209722">}</span><span class="op" id="4209723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209726">{</span><span class="num" id="4209727">8</span><span class="op" id="4209728">,</span>&nbsp;<span class="num" id="4209730">16</span><span class="op" id="4209732">,</span>&nbsp;<span class="num" id="4209734">128</span><span class="op" id="4209737">,</span>&nbsp;<span class="num" id="4209739">128</span><span class="op" id="4209742">,</span>&nbsp;<span class="ident" id="4209744">skipNever</span><span class="op" id="4209753">}</span><span class="op" id="4209754">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209757">{</span><span class="num" id="4209758">8</span><span class="op" id="4209759">,</span>&nbsp;<span class="num" id="4209761">32</span><span class="op" id="4209763">,</span>&nbsp;<span class="num" id="4209765">128</span><span class="op" id="4209768">,</span>&nbsp;<span class="num" id="4209770">256</span><span class="op" id="4209773">,</span>&nbsp;<span class="ident" id="4209775">skipNever</span><span class="op" id="4209784">}</span><span class="op" id="4209785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209788">{</span><span class="num" id="4209789">32</span><span class="op" id="4209791">,</span>&nbsp;<span class="num" id="4209793">128</span><span class="op" id="4209796">,</span>&nbsp;<span class="num" id="4209798">258</span><span class="op" id="4209801">,</span>&nbsp;<span class="num" id="4209803">1024</span><span class="op" id="4209807">,</span>&nbsp;<span class="ident" id="4209809">skipNever</span><span class="op" id="4209818">}</span><span class="op" id="4209819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209822">{</span><span class="num" id="4209823">32</span><span class="op" id="4209825">,</span>&nbsp;<span class="num" id="4209827">258</span><span class="op" id="4209830">,</span>&nbsp;<span class="num" id="4209832">258</span><span class="op" id="4209835">,</span>&nbsp;<span class="num" id="4209837">4096</span><span class="op" id="4209841">,</span>&nbsp;<span class="ident" id="4209843">skipNever</span><span class="op" id="4209852">}</span><span class="op" id="4209853">,</span><br>
<span class="lineno"></span><span class="op" id="4209855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4209858">type</span>&nbsp;<span class="ident" id="4209863">compressor</span>&nbsp;<span class="keyword" id="4209874">struct</span>&nbsp;<span class="op" id="4209881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209884">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209903">w</span>&nbsp;<span class="op" id="4209905">*</span><span class="ident" id="4209906">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209925">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209951">fill</span>&nbsp;<span class="keyword" id="4209956">func</span><span class="op" id="4209960">(</span><span class="op" id="4209961">*</span><span class="ident" id="4209962">compressor</span><span class="op" id="4209972">,</span>&nbsp;<span class="op" id="4209974">[</span><span class="op" id="4209975">]</span><span class="builtintype" id="4209976">byte</span><span class="op" id="4209980">)</span>&nbsp;<span class="builtintype" id="4209982">int</span>&nbsp;<span class="comment" id="4209986">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210010">step</span>&nbsp;<span class="keyword" id="4210015">func</span><span class="op" id="4210019">(</span><span class="op" id="4210020">*</span><span class="ident" id="4210021">compressor</span><span class="op" id="4210031">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210045">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210064">sync</span>&nbsp;<span class="builtintype" id="4210069">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210099">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210121">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210143">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210229">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210291">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210366">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210396">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4210407">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210412">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4210423">[</span><span class="op" id="4210424">]</span><span class="builtintype" id="4210425">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210430">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4210441">[</span><span class="op" id="4210442">]</span><span class="builtintype" id="4210443">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210448">hashOffset</span>&nbsp;<span class="builtintype" id="4210459">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210465">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210527">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210541">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210546">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210560">[</span><span class="op" id="4210561">]</span><span class="builtintype" id="4210562">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210568">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210582">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210587">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210601">int</span>&nbsp;&nbsp;<span class="comment" id="4210606">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210650">byteAvailable</span>&nbsp;<span class="builtintype" id="4210664">bool</span>&nbsp;<span class="comment" id="4210669">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210722">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210747">tokens</span>&nbsp;<span class="op" id="4210754">[</span><span class="op" id="4210755">]</span><span class="ident" id="4210756">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210764">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210782">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210797">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210802">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210817">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210822">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210837">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210842">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4210857">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210862">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4210877">error</span><br>
<span class="lineno"></span><span class="op" id="4210883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4210886">func</span>&nbsp;<span class="op" id="4210891">(</span><span class="ident" id="4210892">d</span>&nbsp;<span class="op" id="4210894">*</span><span class="ident" id="4210895">compressor</span><span class="op" id="4210905">)</span>&nbsp;<span class="ident" id="4210907">fillDeflate</span><span class="op" id="4210918">(</span><span class="ident" id="4210919">b</span>&nbsp;<span class="op" id="4210921">[</span><span class="op" id="4210922">]</span><span class="builtintype" id="4210923">byte</span><span class="op" id="4210927">)</span>&nbsp;<span class="builtintype" id="4210929">int</span>&nbsp;<span class="op" id="4210933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210936">if</span>&nbsp;<span class="ident" id="4210939">d</span><span class="op" id="4210940">.</span><span class="ident" id="4210941">index</span>&nbsp;<span class="op" id="4210947">&gt;=</span>&nbsp;<span class="num" id="4210950">2</span><span class="op" id="4210951">*</span><span class="ident" id="4210952">windowSize</span><span class="op" id="4210962">-</span><span class="op" id="4210963">(</span><span class="ident" id="4210964">minMatchLength</span><span class="op" id="4210978">+</span><span class="ident" id="4210979">maxMatchLength</span><span class="op" id="4210993">)</span>&nbsp;<span class="op" id="4210995">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210999">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4211035">copy</span><span class="op" id="4211039">(</span><span class="ident" id="4211040">d</span><span class="op" id="4211041">.</span><span class="ident" id="4211042">window</span><span class="op" id="4211048">,</span>&nbsp;<span class="ident" id="4211050">d</span><span class="op" id="4211051">.</span><span class="ident" id="4211052">window</span><span class="op" id="4211058">[</span><span class="ident" id="4211059">windowSize</span><span class="op" id="4211069">:</span><span class="num" id="4211070">2</span><span class="op" id="4211071">*</span><span class="ident" id="4211072">windowSize</span><span class="op" id="4211082">]</span><span class="op" id="4211083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211087">d</span><span class="op" id="4211088">.</span><span class="ident" id="4211089">index</span>&nbsp;<span class="op" id="4211095">-=</span>&nbsp;<span class="ident" id="4211098">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211111">d</span><span class="op" id="4211112">.</span><span class="ident" id="4211113">windowEnd</span>&nbsp;<span class="op" id="4211123">-=</span>&nbsp;<span class="ident" id="4211126">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211139">if</span>&nbsp;<span class="ident" id="4211142">d</span><span class="op" id="4211143">.</span><span class="ident" id="4211144">blockStart</span>&nbsp;<span class="op" id="4211155">&gt;=</span>&nbsp;<span class="ident" id="4211158">windowSize</span>&nbsp;<span class="op" id="4211169">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211174">d</span><span class="op" id="4211175">.</span><span class="ident" id="4211176">blockStart</span>&nbsp;<span class="op" id="4211187">-=</span>&nbsp;<span class="ident" id="4211190">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211203">}</span>&nbsp;<span class="keyword" id="4211205">else</span>&nbsp;<span class="op" id="4211210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211215">d</span><span class="op" id="4211216">.</span><span class="ident" id="4211217">blockStart</span>&nbsp;<span class="op" id="4211228">=</span>&nbsp;<span class="ident" id="4211230">math</span><span class="op" id="4211234">.</span><span class="ident" id="4211235">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211250">d</span><span class="op" id="4211251">.</span><span class="ident" id="4211252">hashOffset</span>&nbsp;<span class="op" id="4211263">+=</span>&nbsp;<span class="ident" id="4211266">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211279">if</span>&nbsp;<span class="ident" id="4211282">d</span><span class="op" id="4211283">.</span><span class="ident" id="4211284">hashOffset</span>&nbsp;<span class="op" id="4211295">&gt;</span>&nbsp;<span class="ident" id="4211297">maxHashOffset</span>&nbsp;<span class="op" id="4211311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211316">delta</span>&nbsp;<span class="op" id="4211322">:=</span>&nbsp;<span class="ident" id="4211325">d</span><span class="op" id="4211326">.</span><span class="ident" id="4211327">hashOffset</span>&nbsp;<span class="op" id="4211338">-</span>&nbsp;<span class="num" id="4211340">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211345">d</span><span class="op" id="4211346">.</span><span class="ident" id="4211347">hashOffset</span>&nbsp;<span class="op" id="4211358">-=</span>&nbsp;<span class="ident" id="4211361">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211370">d</span><span class="op" id="4211371">.</span><span class="ident" id="4211372">chainHead</span>&nbsp;<span class="op" id="4211382">-=</span>&nbsp;<span class="ident" id="4211385">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211394">for</span>&nbsp;<span class="ident" id="4211398">i</span><span class="op" id="4211399">,</span>&nbsp;<span class="ident" id="4211401">v</span>&nbsp;<span class="op" id="4211403">:=</span>&nbsp;<span class="keyword" id="4211406">range</span>&nbsp;<span class="ident" id="4211412">d</span><span class="op" id="4211413">.</span><span class="ident" id="4211414">hashPrev</span>&nbsp;<span class="op" id="4211423">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211429">if</span>&nbsp;<span class="ident" id="4211432">v</span>&nbsp;<span class="op" id="4211434">&gt;</span>&nbsp;<span class="ident" id="4211436">delta</span>&nbsp;<span class="op" id="4211442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211449">d</span><span class="op" id="4211450">.</span><span class="ident" id="4211451">hashPrev</span><span class="op" id="4211459">[</span><span class="ident" id="4211460">i</span><span class="op" id="4211461">]</span>&nbsp;<span class="op" id="4211463">-=</span>&nbsp;<span class="ident" id="4211466">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211476">}</span>&nbsp;<span class="keyword" id="4211478">else</span>&nbsp;<span class="op" id="4211483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211490">d</span><span class="op" id="4211491">.</span><span class="ident" id="4211492">hashPrev</span><span class="op" id="4211500">[</span><span class="ident" id="4211501">i</span><span class="op" id="4211502">]</span>&nbsp;<span class="op" id="4211504">=</span>&nbsp;<span class="num" id="4211506">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211512">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211522">for</span>&nbsp;<span class="ident" id="4211526">i</span><span class="op" id="4211527">,</span>&nbsp;<span class="ident" id="4211529">v</span>&nbsp;<span class="op" id="4211531">:=</span>&nbsp;<span class="keyword" id="4211534">range</span>&nbsp;<span class="ident" id="4211540">d</span><span class="op" id="4211541">.</span><span class="ident" id="4211542">hashHead</span>&nbsp;<span class="op" id="4211551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211557">if</span>&nbsp;<span class="ident" id="4211560">v</span>&nbsp;<span class="op" id="4211562">&gt;</span>&nbsp;<span class="ident" id="4211564">delta</span>&nbsp;<span class="op" id="4211570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211577">d</span><span class="op" id="4211578">.</span><span class="ident" id="4211579">hashHead</span><span class="op" id="4211587">[</span><span class="ident" id="4211588">i</span><span class="op" id="4211589">]</span>&nbsp;<span class="op" id="4211591">-=</span>&nbsp;<span class="ident" id="4211594">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211604">}</span>&nbsp;<span class="keyword" id="4211606">else</span>&nbsp;<span class="op" id="4211611">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211618">d</span><span class="op" id="4211619">.</span><span class="ident" id="4211620">hashHead</span><span class="op" id="4211628">[</span><span class="ident" id="4211629">i</span><span class="op" id="4211630">]</span>&nbsp;<span class="op" id="4211632">=</span>&nbsp;<span class="num" id="4211634">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211652">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211655">n</span>&nbsp;<span class="op" id="4211657">:=</span>&nbsp;<span class="builtinfunc" id="4211660">copy</span><span class="op" id="4211664">(</span><span class="ident" id="4211665">d</span><span class="op" id="4211666">.</span><span class="ident" id="4211667">window</span><span class="op" id="4211673">[</span><span class="ident" id="4211674">d</span><span class="op" id="4211675">.</span><span class="ident" id="4211676">windowEnd</span><span class="op" id="4211685">:</span><span class="op" id="4211686">]</span><span class="op" id="4211687">,</span>&nbsp;<span class="ident" id="4211689">b</span><span class="op" id="4211690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211693">d</span><span class="op" id="4211694">.</span><span class="ident" id="4211695">windowEnd</span>&nbsp;<span class="op" id="4211705">+=</span>&nbsp;<span class="ident" id="4211708">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211711">return</span>&nbsp;<span class="ident" id="4211718">n</span><br>
<span class="lineno"></span><span class="op" id="4211720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4211723">func</span>&nbsp;<span class="op" id="4211728">(</span><span class="ident" id="4211729">d</span>&nbsp;<span class="op" id="4211731">*</span><span class="ident" id="4211732">compressor</span><span class="op" id="4211742">)</span>&nbsp;<span class="ident" id="4211744">writeBlock</span><span class="op" id="4211754">(</span><span class="ident" id="4211755">tokens</span>&nbsp;<span class="op" id="4211762">[</span><span class="op" id="4211763">]</span><span class="ident" id="4211764">token</span><span class="op" id="4211769">,</span>&nbsp;<span class="ident" id="4211771">index</span>&nbsp;<span class="builtintype" id="4211777">int</span><span class="op" id="4211780">,</span>&nbsp;<span class="ident" id="4211782">eof</span>&nbsp;<span class="builtintype" id="4211786">bool</span><span class="op" id="4211790">)</span>&nbsp;<span class="builtintype" id="4211792">error</span>&nbsp;<span class="op" id="4211798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211801">if</span>&nbsp;<span class="ident" id="4211804">index</span>&nbsp;<span class="op" id="4211810">&gt;</span>&nbsp;<span class="num" id="4211812">0</span>&nbsp;<span class="op" id="4211814">||</span>&nbsp;<span class="ident" id="4211817">eof</span>&nbsp;<span class="op" id="4211821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211825">var</span>&nbsp;<span class="ident" id="4211829">window</span>&nbsp;<span class="op" id="4211836">[</span><span class="op" id="4211837">]</span><span class="builtintype" id="4211838">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211845">if</span>&nbsp;<span class="ident" id="4211848">d</span><span class="op" id="4211849">.</span><span class="ident" id="4211850">blockStart</span>&nbsp;<span class="op" id="4211861">&lt;=</span>&nbsp;<span class="ident" id="4211864">index</span>&nbsp;<span class="op" id="4211870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211875">window</span>&nbsp;<span class="op" id="4211882">=</span>&nbsp;<span class="ident" id="4211884">d</span><span class="op" id="4211885">.</span><span class="ident" id="4211886">window</span><span class="op" id="4211892">[</span><span class="ident" id="4211893">d</span><span class="op" id="4211894">.</span><span class="ident" id="4211895">blockStart</span><span class="op" id="4211905">:</span><span class="ident" id="4211906">index</span><span class="op" id="4211911">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211919">d</span><span class="op" id="4211920">.</span><span class="ident" id="4211921">blockStart</span>&nbsp;<span class="op" id="4211932">=</span>&nbsp;<span class="ident" id="4211934">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211942">d</span><span class="op" id="4211943">.</span><span class="ident" id="4211944">w</span><span class="op" id="4211945">.</span><span class="ident" id="4211946">writeBlock</span><span class="op" id="4211956">(</span><span class="ident" id="4211957">tokens</span><span class="op" id="4211963">,</span>&nbsp;<span class="ident" id="4211965">eof</span><span class="op" id="4211968">,</span>&nbsp;<span class="ident" id="4211970">window</span><span class="op" id="4211976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211980">return</span>&nbsp;<span class="ident" id="4211987">d</span><span class="op" id="4211988">.</span><span class="ident" id="4211989">w</span><span class="op" id="4211990">.</span><span class="ident" id="4211991">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211996">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211999">return</span>&nbsp;<span class="builtintype" id="4212006">nil</span><br>
<span class="lineno"></span><span class="op" id="4212010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4212013">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4212093">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4212155">func</span>&nbsp;<span class="op" id="4212160">(</span><span class="ident" id="4212161">d</span>&nbsp;<span class="op" id="4212163">*</span><span class="ident" id="4212164">compressor</span><span class="op" id="4212174">)</span>&nbsp;<span class="ident" id="4212176">findMatch</span><span class="op" id="4212185">(</span><span class="ident" id="4212186">pos</span>&nbsp;<span class="builtintype" id="4212190">int</span><span class="op" id="4212193">,</span>&nbsp;<span class="ident" id="4212195">prevHead</span>&nbsp;<span class="builtintype" id="4212204">int</span><span class="op" id="4212207">,</span>&nbsp;<span class="ident" id="4212209">prevLength</span>&nbsp;<span class="builtintype" id="4212220">int</span><span class="op" id="4212223">,</span>&nbsp;<span class="ident" id="4212225">lookahead</span>&nbsp;<span class="builtintype" id="4212235">int</span><span class="op" id="4212238">)</span>&nbsp;<span class="op" id="4212240">(</span><span class="ident" id="4212241">length</span><span class="op" id="4212247">,</span>&nbsp;<span class="ident" id="4212249">offset</span>&nbsp;<span class="builtintype" id="4212256">int</span><span class="op" id="4212259">,</span>&nbsp;<span class="ident" id="4212261">ok</span>&nbsp;<span class="builtintype" id="4212264">bool</span><span class="op" id="4212268">)</span>&nbsp;<span class="op" id="4212270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212273">minMatchLook</span>&nbsp;<span class="op" id="4212286">:=</span>&nbsp;<span class="ident" id="4212289">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212305">if</span>&nbsp;<span class="ident" id="4212308">lookahead</span>&nbsp;<span class="op" id="4212318">&lt;</span>&nbsp;<span class="ident" id="4212320">minMatchLook</span>&nbsp;<span class="op" id="4212333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212337">minMatchLook</span>&nbsp;<span class="op" id="4212350">=</span>&nbsp;<span class="ident" id="4212352">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212363">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212367">win</span>&nbsp;<span class="op" id="4212371">:=</span>&nbsp;<span class="ident" id="4212374">d</span><span class="op" id="4212375">.</span><span class="ident" id="4212376">window</span><span class="op" id="4212382">[</span><span class="num" id="4212383">0</span>&nbsp;<span class="op" id="4212385">:</span>&nbsp;<span class="ident" id="4212387">pos</span><span class="op" id="4212390">+</span><span class="ident" id="4212391">minMatchLook</span><span class="op" id="4212403">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212407">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212465">nice</span>&nbsp;<span class="op" id="4212470">:=</span>&nbsp;<span class="builtinfunc" id="4212473">len</span><span class="op" id="4212476">(</span><span class="ident" id="4212477">win</span><span class="op" id="4212480">)</span>&nbsp;<span class="op" id="4212482">-</span>&nbsp;<span class="ident" id="4212484">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212489">if</span>&nbsp;<span class="ident" id="4212492">d</span><span class="op" id="4212493">.</span><span class="ident" id="4212494">nice</span>&nbsp;<span class="op" id="4212499">&lt;</span>&nbsp;<span class="ident" id="4212501">nice</span>&nbsp;<span class="op" id="4212506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212510">nice</span>&nbsp;<span class="op" id="4212515">=</span>&nbsp;<span class="ident" id="4212517">d</span><span class="op" id="4212518">.</span><span class="ident" id="4212519">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212529">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212602">tries</span>&nbsp;<span class="op" id="4212608">:=</span>&nbsp;<span class="ident" id="4212611">d</span><span class="op" id="4212612">.</span><span class="ident" id="4212613">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212620">length</span>&nbsp;<span class="op" id="4212627">=</span>&nbsp;<span class="ident" id="4212629">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212641">if</span>&nbsp;<span class="ident" id="4212644">length</span>&nbsp;<span class="op" id="4212651">&gt;=</span>&nbsp;<span class="ident" id="4212654">d</span><span class="op" id="4212655">.</span><span class="ident" id="4212656">good</span>&nbsp;<span class="op" id="4212661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212665">tries</span>&nbsp;<span class="op" id="4212671">&gt;&gt;=</span>&nbsp;<span class="num" id="4212675">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212678">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212682">w0</span>&nbsp;<span class="op" id="4212685">:=</span>&nbsp;<span class="ident" id="4212688">win</span><span class="op" id="4212691">[</span><span class="ident" id="4212692">pos</span><span class="op" id="4212695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212698">w1</span>&nbsp;<span class="op" id="4212701">:=</span>&nbsp;<span class="ident" id="4212704">win</span><span class="op" id="4212707">[</span><span class="ident" id="4212708">pos</span><span class="op" id="4212711">+</span><span class="num" id="4212712">1</span><span class="op" id="4212713">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212716">wEnd</span>&nbsp;<span class="op" id="4212721">:=</span>&nbsp;<span class="ident" id="4212724">win</span><span class="op" id="4212727">[</span><span class="ident" id="4212728">pos</span><span class="op" id="4212731">+</span><span class="ident" id="4212732">length</span><span class="op" id="4212738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212741">minIndex</span>&nbsp;<span class="op" id="4212750">:=</span>&nbsp;<span class="ident" id="4212753">pos</span>&nbsp;<span class="op" id="4212757">-</span>&nbsp;<span class="ident" id="4212759">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212772">for</span>&nbsp;<span class="ident" id="4212776">i</span>&nbsp;<span class="op" id="4212778">:=</span>&nbsp;<span class="ident" id="4212781">prevHead</span><span class="op" id="4212789">;</span>&nbsp;<span class="ident" id="4212791">tries</span>&nbsp;<span class="op" id="4212797">&gt;</span>&nbsp;<span class="num" id="4212799">0</span><span class="op" id="4212800">;</span>&nbsp;<span class="ident" id="4212802">tries</span><span class="op" id="4212807">--</span>&nbsp;<span class="op" id="4212810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212814">if</span>&nbsp;<span class="ident" id="4212817">w0</span>&nbsp;<span class="op" id="4212820">==</span>&nbsp;<span class="ident" id="4212823">win</span><span class="op" id="4212826">[</span><span class="ident" id="4212827">i</span><span class="op" id="4212828">]</span>&nbsp;<span class="op" id="4212830">&amp;&amp;</span>&nbsp;<span class="ident" id="4212833">w1</span>&nbsp;<span class="op" id="4212836">==</span>&nbsp;<span class="ident" id="4212839">win</span><span class="op" id="4212842">[</span><span class="ident" id="4212843">i</span><span class="op" id="4212844">+</span><span class="num" id="4212845">1</span><span class="op" id="4212846">]</span>&nbsp;<span class="op" id="4212848">&amp;&amp;</span>&nbsp;<span class="ident" id="4212851">wEnd</span>&nbsp;<span class="op" id="4212856">==</span>&nbsp;<span class="ident" id="4212859">win</span><span class="op" id="4212862">[</span><span class="ident" id="4212863">i</span><span class="op" id="4212864">+</span><span class="ident" id="4212865">length</span><span class="op" id="4212871">]</span>&nbsp;<span class="op" id="4212873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212878">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212963">n</span>&nbsp;<span class="op" id="4212965">:=</span>&nbsp;<span class="num" id="4212968">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212973">for</span>&nbsp;<span class="ident" id="4212977">pos</span><span class="op" id="4212980">+</span><span class="ident" id="4212981">n</span>&nbsp;<span class="op" id="4212983">&lt;</span>&nbsp;<span class="builtinfunc" id="4212985">len</span><span class="op" id="4212988">(</span><span class="ident" id="4212989">win</span><span class="op" id="4212992">)</span>&nbsp;<span class="op" id="4212994">&amp;&amp;</span>&nbsp;<span class="ident" id="4212997">win</span><span class="op" id="4213000">[</span><span class="ident" id="4213001">i</span><span class="op" id="4213002">+</span><span class="ident" id="4213003">n</span><span class="op" id="4213004">]</span>&nbsp;<span class="op" id="4213006">==</span>&nbsp;<span class="ident" id="4213009">win</span><span class="op" id="4213012">[</span><span class="ident" id="4213013">pos</span><span class="op" id="4213016">+</span><span class="ident" id="4213017">n</span><span class="op" id="4213018">]</span>&nbsp;<span class="op" id="4213020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213026">n</span><span class="op" id="4213027">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213038">if</span>&nbsp;<span class="ident" id="4213041">n</span>&nbsp;<span class="op" id="4213043">&gt;</span>&nbsp;<span class="ident" id="4213045">length</span>&nbsp;<span class="op" id="4213052">&amp;&amp;</span>&nbsp;<span class="op" id="4213055">(</span><span class="ident" id="4213056">n</span>&nbsp;<span class="op" id="4213058">&gt;</span>&nbsp;<span class="num" id="4213060">3</span>&nbsp;<span class="op" id="4213062">||</span>&nbsp;<span class="ident" id="4213065">pos</span><span class="op" id="4213068">-</span><span class="ident" id="4213069">i</span>&nbsp;<span class="op" id="4213071">&lt;=</span>&nbsp;<span class="num" id="4213074">4096</span><span class="op" id="4213078">)</span>&nbsp;<span class="op" id="4213080">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213086">length</span>&nbsp;<span class="op" id="4213093">=</span>&nbsp;<span class="ident" id="4213095">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213101">offset</span>&nbsp;<span class="op" id="4213108">=</span>&nbsp;<span class="ident" id="4213110">pos</span>&nbsp;<span class="op" id="4213114">-</span>&nbsp;<span class="ident" id="4213116">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213122">ok</span>&nbsp;<span class="op" id="4213125">=</span>&nbsp;<span class="builtintype" id="4213127">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213136">if</span>&nbsp;<span class="ident" id="4213139">n</span>&nbsp;<span class="op" id="4213141">&gt;=</span>&nbsp;<span class="ident" id="4213144">nice</span>&nbsp;<span class="op" id="4213149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213156">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213229">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213245">wEnd</span>&nbsp;<span class="op" id="4213250">=</span>&nbsp;<span class="ident" id="4213252">win</span><span class="op" id="4213255">[</span><span class="ident" id="4213256">pos</span><span class="op" id="4213259">+</span><span class="ident" id="4213260">n</span><span class="op" id="4213261">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213270">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213274">if</span>&nbsp;<span class="ident" id="4213277">i</span>&nbsp;<span class="op" id="4213279">==</span>&nbsp;<span class="ident" id="4213282">minIndex</span>&nbsp;<span class="op" id="4213291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4213296">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213370">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213382">if</span>&nbsp;<span class="ident" id="4213385">i</span>&nbsp;<span class="op" id="4213387">=</span>&nbsp;<span class="ident" id="4213389">d</span><span class="op" id="4213390">.</span><span class="ident" id="4213391">hashPrev</span><span class="op" id="4213399">[</span><span class="ident" id="4213400">i</span><span class="op" id="4213401">&amp;</span><span class="ident" id="4213402">windowMask</span><span class="op" id="4213412">]</span>&nbsp;<span class="op" id="4213414">-</span>&nbsp;<span class="ident" id="4213416">d</span><span class="op" id="4213417">.</span><span class="ident" id="4213418">hashOffset</span><span class="op" id="4213428">;</span>&nbsp;<span class="ident" id="4213430">i</span>&nbsp;<span class="op" id="4213432">&lt;</span>&nbsp;<span class="ident" id="4213434">minIndex</span>&nbsp;<span class="op" id="4213443">||</span>&nbsp;<span class="ident" id="4213446">i</span>&nbsp;<span class="op" id="4213448">&lt;</span>&nbsp;<span class="num" id="4213450">0</span>&nbsp;<span class="op" id="4213452">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213457">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213471">return</span><br>
<span class="lineno"></span><span class="op" id="4213478">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4213481">func</span>&nbsp;<span class="op" id="4213486">(</span><span class="ident" id="4213487">d</span>&nbsp;<span class="op" id="4213489">*</span><span class="ident" id="4213490">compressor</span><span class="op" id="4213500">)</span>&nbsp;<span class="ident" id="4213502">writeStoredBlock</span><span class="op" id="4213518">(</span><span class="ident" id="4213519">buf</span>&nbsp;<span class="op" id="4213523">[</span><span class="op" id="4213524">]</span><span class="builtintype" id="4213525">byte</span><span class="op" id="4213529">)</span>&nbsp;<span class="builtintype" id="4213531">error</span>&nbsp;<span class="op" id="4213537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213540">if</span>&nbsp;<span class="ident" id="4213543">d</span><span class="op" id="4213544">.</span><span class="ident" id="4213545">w</span><span class="op" id="4213546">.</span><span class="ident" id="4213547">writeStoredHeader</span><span class="op" id="4213564">(</span><span class="builtinfunc" id="4213565">len</span><span class="op" id="4213568">(</span><span class="ident" id="4213569">buf</span><span class="op" id="4213572">)</span><span class="op" id="4213573">,</span>&nbsp;<span class="builtintype" id="4213575">false</span><span class="op" id="4213580">)</span><span class="op" id="4213581">;</span>&nbsp;<span class="ident" id="4213583">d</span><span class="op" id="4213584">.</span><span class="ident" id="4213585">w</span><span class="op" id="4213586">.</span><span class="ident" id="4213587">err</span>&nbsp;<span class="op" id="4213591">!=</span>&nbsp;<span class="builtintype" id="4213594">nil</span>&nbsp;<span class="op" id="4213598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213602">return</span>&nbsp;<span class="ident" id="4213609">d</span><span class="op" id="4213610">.</span><span class="ident" id="4213611">w</span><span class="op" id="4213612">.</span><span class="ident" id="4213613">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213618">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213621">d</span><span class="op" id="4213622">.</span><span class="ident" id="4213623">w</span><span class="op" id="4213624">.</span><span class="ident" id="4213625">writeBytes</span><span class="op" id="4213635">(</span><span class="ident" id="4213636">buf</span><span class="op" id="4213639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213642">return</span>&nbsp;<span class="ident" id="4213649">d</span><span class="op" id="4213650">.</span><span class="ident" id="4213651">w</span><span class="op" id="4213652">.</span><span class="ident" id="4213653">err</span><br>
<span class="lineno"></span><span class="op" id="4213657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4213660">func</span>&nbsp;<span class="op" id="4213665">(</span><span class="ident" id="4213666">d</span>&nbsp;<span class="op" id="4213668">*</span><span class="ident" id="4213669">compressor</span><span class="op" id="4213679">)</span>&nbsp;<span class="ident" id="4213681">initDeflate</span><span class="op" id="4213692">(</span><span class="op" id="4213693">)</span>&nbsp;<span class="op" id="4213695">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213698">d</span><span class="op" id="4213699">.</span><span class="ident" id="4213700">hashHead</span>&nbsp;<span class="op" id="4213709">=</span>&nbsp;<span class="builtinfunc" id="4213711">make</span><span class="op" id="4213715">(</span><span class="op" id="4213716">[</span><span class="op" id="4213717">]</span><span class="builtintype" id="4213718">int</span><span class="op" id="4213721">,</span>&nbsp;<span class="ident" id="4213723">hashSize</span><span class="op" id="4213731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213734">d</span><span class="op" id="4213735">.</span><span class="ident" id="4213736">hashPrev</span>&nbsp;<span class="op" id="4213745">=</span>&nbsp;<span class="builtinfunc" id="4213747">make</span><span class="op" id="4213751">(</span><span class="op" id="4213752">[</span><span class="op" id="4213753">]</span><span class="builtintype" id="4213754">int</span><span class="op" id="4213757">,</span>&nbsp;<span class="ident" id="4213759">windowSize</span><span class="op" id="4213769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213772">d</span><span class="op" id="4213773">.</span><span class="ident" id="4213774">window</span>&nbsp;<span class="op" id="4213781">=</span>&nbsp;<span class="builtinfunc" id="4213783">make</span><span class="op" id="4213787">(</span><span class="op" id="4213788">[</span><span class="op" id="4213789">]</span><span class="builtintype" id="4213790">byte</span><span class="op" id="4213794">,</span>&nbsp;<span class="num" id="4213796">2</span><span class="op" id="4213797">*</span><span class="ident" id="4213798">windowSize</span><span class="op" id="4213808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213811">d</span><span class="op" id="4213812">.</span><span class="ident" id="4213813">hashOffset</span>&nbsp;<span class="op" id="4213824">=</span>&nbsp;<span class="num" id="4213826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213829">d</span><span class="op" id="4213830">.</span><span class="ident" id="4213831">tokens</span>&nbsp;<span class="op" id="4213838">=</span>&nbsp;<span class="builtinfunc" id="4213840">make</span><span class="op" id="4213844">(</span><span class="op" id="4213845">[</span><span class="op" id="4213846">]</span><span class="ident" id="4213847">token</span><span class="op" id="4213852">,</span>&nbsp;<span class="num" id="4213854">0</span><span class="op" id="4213855">,</span>&nbsp;<span class="ident" id="4213857">maxFlateBlockTokens</span><span class="op" id="4213876">+</span><span class="num" id="4213877">1</span><span class="op" id="4213878">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213881">d</span><span class="op" id="4213882">.</span><span class="ident" id="4213883">length</span>&nbsp;<span class="op" id="4213890">=</span>&nbsp;<span class="ident" id="4213892">minMatchLength</span>&nbsp;<span class="op" id="4213907">-</span>&nbsp;<span class="num" id="4213909">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213912">d</span><span class="op" id="4213913">.</span><span class="ident" id="4213914">offset</span>&nbsp;<span class="op" id="4213921">=</span>&nbsp;<span class="num" id="4213923">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213926">d</span><span class="op" id="4213927">.</span><span class="ident" id="4213928">byteAvailable</span>&nbsp;<span class="op" id="4213942">=</span>&nbsp;<span class="builtintype" id="4213944">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213951">d</span><span class="op" id="4213952">.</span><span class="ident" id="4213953">index</span>&nbsp;<span class="op" id="4213959">=</span>&nbsp;<span class="num" id="4213961">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213964">d</span><span class="op" id="4213965">.</span><span class="ident" id="4213966">hash</span>&nbsp;<span class="op" id="4213971">=</span>&nbsp;<span class="num" id="4213973">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213976">d</span><span class="op" id="4213977">.</span><span class="ident" id="4213978">chainHead</span>&nbsp;<span class="op" id="4213988">=</span>&nbsp;<span class="op" id="4213990">-</span><span class="num" id="4213991">1</span><br>
<span class="lineno"></span><span class="op" id="4213993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4213996">func</span>&nbsp;<span class="op" id="4214001">(</span><span class="ident" id="4214002">d</span>&nbsp;<span class="op" id="4214004">*</span><span class="ident" id="4214005">compressor</span><span class="op" id="4214015">)</span>&nbsp;<span class="ident" id="4214017">deflate</span><span class="op" id="4214024">(</span><span class="op" id="4214025">)</span>&nbsp;<span class="op" id="4214027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214030">if</span>&nbsp;<span class="ident" id="4214033">d</span><span class="op" id="4214034">.</span><span class="ident" id="4214035">windowEnd</span><span class="op" id="4214044">-</span><span class="ident" id="4214045">d</span><span class="op" id="4214046">.</span><span class="ident" id="4214047">index</span>&nbsp;<span class="op" id="4214053">&lt;</span>&nbsp;<span class="ident" id="4214055">minMatchLength</span><span class="op" id="4214069">+</span><span class="ident" id="4214070">maxMatchLength</span>&nbsp;<span class="op" id="4214085">&amp;&amp;</span>&nbsp;<span class="op" id="4214088">!</span><span class="ident" id="4214089">d</span><span class="op" id="4214090">.</span><span class="ident" id="4214091">sync</span>&nbsp;<span class="op" id="4214096">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214100">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214112">d</span><span class="op" id="4214113">.</span><span class="ident" id="4214114">maxInsertIndex</span>&nbsp;<span class="op" id="4214129">=</span>&nbsp;<span class="ident" id="4214131">d</span><span class="op" id="4214132">.</span><span class="ident" id="4214133">windowEnd</span>&nbsp;<span class="op" id="4214143">-</span>&nbsp;<span class="op" id="4214145">(</span><span class="ident" id="4214146">minMatchLength</span>&nbsp;<span class="op" id="4214161">-</span>&nbsp;<span class="num" id="4214163">1</span><span class="op" id="4214164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214167">if</span>&nbsp;<span class="ident" id="4214170">d</span><span class="op" id="4214171">.</span><span class="ident" id="4214172">index</span>&nbsp;<span class="op" id="4214178">&lt;</span>&nbsp;<span class="ident" id="4214180">d</span><span class="op" id="4214181">.</span><span class="ident" id="4214182">maxInsertIndex</span>&nbsp;<span class="op" id="4214197">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214201">d</span><span class="op" id="4214202">.</span><span class="ident" id="4214203">hash</span>&nbsp;<span class="op" id="4214208">=</span>&nbsp;<span class="builtintype" id="4214210">int</span><span class="op" id="4214213">(</span><span class="ident" id="4214214">d</span><span class="op" id="4214215">.</span><span class="ident" id="4214216">window</span><span class="op" id="4214222">[</span><span class="ident" id="4214223">d</span><span class="op" id="4214224">.</span><span class="ident" id="4214225">index</span><span class="op" id="4214230">]</span><span class="op" id="4214231">)</span><span class="op" id="4214232">&lt;&lt;</span><span class="ident" id="4214234">hashShift</span>&nbsp;<span class="op" id="4214244">+</span>&nbsp;<span class="builtintype" id="4214246">int</span><span class="op" id="4214249">(</span><span class="ident" id="4214250">d</span><span class="op" id="4214251">.</span><span class="ident" id="4214252">window</span><span class="op" id="4214258">[</span><span class="ident" id="4214259">d</span><span class="op" id="4214260">.</span><span class="ident" id="4214261">index</span><span class="op" id="4214266">+</span><span class="num" id="4214267">1</span><span class="op" id="4214268">]</span><span class="op" id="4214269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4214275">Loop</span><span class="op" id="4214279">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214282">for</span>&nbsp;<span class="op" id="4214286">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214290">if</span>&nbsp;<span class="ident" id="4214293">d</span><span class="op" id="4214294">.</span><span class="ident" id="4214295">index</span>&nbsp;<span class="op" id="4214301">&gt;</span>&nbsp;<span class="ident" id="4214303">d</span><span class="op" id="4214304">.</span><span class="ident" id="4214305">windowEnd</span>&nbsp;<span class="op" id="4214315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214320">panic</span><span class="op" id="4214325">(</span><span class="string" id="4214326">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4214345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214353">lookahead</span>&nbsp;<span class="op" id="4214363">:=</span>&nbsp;<span class="ident" id="4214366">d</span><span class="op" id="4214367">.</span><span class="ident" id="4214368">windowEnd</span>&nbsp;<span class="op" id="4214378">-</span>&nbsp;<span class="ident" id="4214380">d</span><span class="op" id="4214381">.</span><span class="ident" id="4214382">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214390">if</span>&nbsp;<span class="ident" id="4214393">lookahead</span>&nbsp;<span class="op" id="4214403">&lt;</span>&nbsp;<span class="ident" id="4214405">minMatchLength</span><span class="op" id="4214419">+</span><span class="ident" id="4214420">maxMatchLength</span>&nbsp;<span class="op" id="4214435">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214440">if</span>&nbsp;<span class="op" id="4214443">!</span><span class="ident" id="4214444">d</span><span class="op" id="4214445">.</span><span class="ident" id="4214446">sync</span>&nbsp;<span class="op" id="4214451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214457">break</span>&nbsp;<span class="ident" id="4214463">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214476">if</span>&nbsp;<span class="ident" id="4214479">d</span><span class="op" id="4214480">.</span><span class="ident" id="4214481">index</span>&nbsp;<span class="op" id="4214487">&gt;</span>&nbsp;<span class="ident" id="4214489">d</span><span class="op" id="4214490">.</span><span class="ident" id="4214491">windowEnd</span>&nbsp;<span class="op" id="4214501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4214507">panic</span><span class="op" id="4214512">(</span><span class="string" id="4214513">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4214532">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214542">if</span>&nbsp;<span class="ident" id="4214545">lookahead</span>&nbsp;<span class="op" id="4214555">==</span>&nbsp;<span class="num" id="4214558">0</span>&nbsp;<span class="op" id="4214560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214566">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214608">if</span>&nbsp;<span class="ident" id="4214611">d</span><span class="op" id="4214612">.</span><span class="ident" id="4214613">byteAvailable</span>&nbsp;<span class="op" id="4214627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214634">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214700">d</span><span class="op" id="4214701">.</span><span class="ident" id="4214702">tokens</span>&nbsp;<span class="op" id="4214709">=</span>&nbsp;<span class="builtinfunc" id="4214711">append</span><span class="op" id="4214717">(</span><span class="ident" id="4214718">d</span><span class="op" id="4214719">.</span><span class="ident" id="4214720">tokens</span><span class="op" id="4214726">,</span>&nbsp;<span class="ident" id="4214728">literalToken</span><span class="op" id="4214740">(</span><span class="builtintype" id="4214741">uint32</span><span class="op" id="4214747">(</span><span class="ident" id="4214748">d</span><span class="op" id="4214749">.</span><span class="ident" id="4214750">window</span><span class="op" id="4214756">[</span><span class="ident" id="4214757">d</span><span class="op" id="4214758">.</span><span class="ident" id="4214759">index</span><span class="op" id="4214764">-</span><span class="num" id="4214765">1</span><span class="op" id="4214766">]</span><span class="op" id="4214767">)</span><span class="op" id="4214768">)</span><span class="op" id="4214769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214776">d</span><span class="op" id="4214777">.</span><span class="ident" id="4214778">byteAvailable</span>&nbsp;<span class="op" id="4214792">=</span>&nbsp;<span class="builtintype" id="4214794">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214810">if</span>&nbsp;<span class="builtinfunc" id="4214813">len</span><span class="op" id="4214816">(</span><span class="ident" id="4214817">d</span><span class="op" id="4214818">.</span><span class="ident" id="4214819">tokens</span><span class="op" id="4214825">)</span>&nbsp;<span class="op" id="4214827">&gt;</span>&nbsp;<span class="num" id="4214829">0</span>&nbsp;<span class="op" id="4214831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214838">if</span>&nbsp;<span class="ident" id="4214841">d</span><span class="op" id="4214842">.</span><span class="ident" id="4214843">err</span>&nbsp;<span class="op" id="4214847">=</span>&nbsp;<span class="ident" id="4214849">d</span><span class="op" id="4214850">.</span><span class="ident" id="4214851">writeBlock</span><span class="op" id="4214861">(</span><span class="ident" id="4214862">d</span><span class="op" id="4214863">.</span><span class="ident" id="4214864">tokens</span><span class="op" id="4214870">,</span>&nbsp;<span class="ident" id="4214872">d</span><span class="op" id="4214873">.</span><span class="ident" id="4214874">index</span><span class="op" id="4214879">,</span>&nbsp;<span class="builtintype" id="4214881">false</span><span class="op" id="4214886">)</span><span class="op" id="4214887">;</span>&nbsp;<span class="ident" id="4214889">d</span><span class="op" id="4214890">.</span><span class="ident" id="4214891">err</span>&nbsp;<span class="op" id="4214895">!=</span>&nbsp;<span class="builtintype" id="4214898">nil</span>&nbsp;<span class="op" id="4214902">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214910">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214929">d</span><span class="op" id="4214930">.</span><span class="ident" id="4214931">tokens</span>&nbsp;<span class="op" id="4214938">=</span>&nbsp;<span class="ident" id="4214940">d</span><span class="op" id="4214941">.</span><span class="ident" id="4214942">tokens</span><span class="op" id="4214948">[</span><span class="op" id="4214949">:</span><span class="num" id="4214950">0</span><span class="op" id="4214951">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214963">break</span>&nbsp;<span class="ident" id="4214969">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214985">if</span>&nbsp;<span class="ident" id="4214988">d</span><span class="op" id="4214989">.</span><span class="ident" id="4214990">index</span>&nbsp;<span class="op" id="4214996">&lt;</span>&nbsp;<span class="ident" id="4214998">d</span><span class="op" id="4214999">.</span><span class="ident" id="4215000">maxInsertIndex</span>&nbsp;<span class="op" id="4215015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215020">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215042">d</span><span class="op" id="4215043">.</span><span class="ident" id="4215044">hash</span>&nbsp;<span class="op" id="4215049">=</span>&nbsp;<span class="op" id="4215051">(</span><span class="ident" id="4215052">d</span><span class="op" id="4215053">.</span><span class="ident" id="4215054">hash</span><span class="op" id="4215058">&lt;&lt;</span><span class="ident" id="4215060">hashShift</span>&nbsp;<span class="op" id="4215070">+</span>&nbsp;<span class="builtintype" id="4215072">int</span><span class="op" id="4215075">(</span><span class="ident" id="4215076">d</span><span class="op" id="4215077">.</span><span class="ident" id="4215078">window</span><span class="op" id="4215084">[</span><span class="ident" id="4215085">d</span><span class="op" id="4215086">.</span><span class="ident" id="4215087">index</span><span class="op" id="4215092">+</span><span class="num" id="4215093">2</span><span class="op" id="4215094">]</span><span class="op" id="4215095">)</span><span class="op" id="4215096">)</span>&nbsp;<span class="op" id="4215098">&amp;</span>&nbsp;<span class="ident" id="4215100">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215112">d</span><span class="op" id="4215113">.</span><span class="ident" id="4215114">chainHead</span>&nbsp;<span class="op" id="4215124">=</span>&nbsp;<span class="ident" id="4215126">d</span><span class="op" id="4215127">.</span><span class="ident" id="4215128">hashHead</span><span class="op" id="4215136">[</span><span class="ident" id="4215137">d</span><span class="op" id="4215138">.</span><span class="ident" id="4215139">hash</span><span class="op" id="4215143">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215148">d</span><span class="op" id="4215149">.</span><span class="ident" id="4215150">hashPrev</span><span class="op" id="4215158">[</span><span class="ident" id="4215159">d</span><span class="op" id="4215160">.</span><span class="ident" id="4215161">index</span><span class="op" id="4215166">&amp;</span><span class="ident" id="4215167">windowMask</span><span class="op" id="4215177">]</span>&nbsp;<span class="op" id="4215179">=</span>&nbsp;<span class="ident" id="4215181">d</span><span class="op" id="4215182">.</span><span class="ident" id="4215183">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215196">d</span><span class="op" id="4215197">.</span><span class="ident" id="4215198">hashHead</span><span class="op" id="4215206">[</span><span class="ident" id="4215207">d</span><span class="op" id="4215208">.</span><span class="ident" id="4215209">hash</span><span class="op" id="4215213">]</span>&nbsp;<span class="op" id="4215215">=</span>&nbsp;<span class="ident" id="4215217">d</span><span class="op" id="4215218">.</span><span class="ident" id="4215219">index</span>&nbsp;<span class="op" id="4215225">+</span>&nbsp;<span class="ident" id="4215227">d</span><span class="op" id="4215228">.</span><span class="ident" id="4215229">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215246">prevLength</span>&nbsp;<span class="op" id="4215257">:=</span>&nbsp;<span class="ident" id="4215260">d</span><span class="op" id="4215261">.</span><span class="ident" id="4215262">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215271">prevOffset</span>&nbsp;<span class="op" id="4215282">:=</span>&nbsp;<span class="ident" id="4215285">d</span><span class="op" id="4215286">.</span><span class="ident" id="4215287">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215296">d</span><span class="op" id="4215297">.</span><span class="ident" id="4215298">length</span>&nbsp;<span class="op" id="4215305">=</span>&nbsp;<span class="ident" id="4215307">minMatchLength</span>&nbsp;<span class="op" id="4215322">-</span>&nbsp;<span class="num" id="4215324">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215328">d</span><span class="op" id="4215329">.</span><span class="ident" id="4215330">offset</span>&nbsp;<span class="op" id="4215337">=</span>&nbsp;<span class="num" id="4215339">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215343">minIndex</span>&nbsp;<span class="op" id="4215352">:=</span>&nbsp;<span class="ident" id="4215355">d</span><span class="op" id="4215356">.</span><span class="ident" id="4215357">index</span>&nbsp;<span class="op" id="4215363">-</span>&nbsp;<span class="ident" id="4215365">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215378">if</span>&nbsp;<span class="ident" id="4215381">minIndex</span>&nbsp;<span class="op" id="4215390">&lt;</span>&nbsp;<span class="num" id="4215392">0</span>&nbsp;<span class="op" id="4215394">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215399">minIndex</span>&nbsp;<span class="op" id="4215408">=</span>&nbsp;<span class="num" id="4215410">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215419">if</span>&nbsp;<span class="ident" id="4215422">d</span><span class="op" id="4215423">.</span><span class="ident" id="4215424">chainHead</span><span class="op" id="4215433">-</span><span class="ident" id="4215434">d</span><span class="op" id="4215435">.</span><span class="ident" id="4215436">hashOffset</span>&nbsp;<span class="op" id="4215447">&gt;=</span>&nbsp;<span class="ident" id="4215450">minIndex</span>&nbsp;<span class="op" id="4215459">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215465">(</span><span class="ident" id="4215466">d</span><span class="op" id="4215467">.</span><span class="ident" id="4215468">fastSkipHashing</span>&nbsp;<span class="op" id="4215484">!=</span>&nbsp;<span class="ident" id="4215487">skipNever</span>&nbsp;<span class="op" id="4215497">&amp;&amp;</span>&nbsp;<span class="ident" id="4215500">lookahead</span>&nbsp;<span class="op" id="4215510">&gt;</span>&nbsp;<span class="ident" id="4215512">minMatchLength</span><span class="op" id="4215526">-</span><span class="num" id="4215527">1</span>&nbsp;<span class="op" id="4215529">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215536">d</span><span class="op" id="4215537">.</span><span class="ident" id="4215538">fastSkipHashing</span>&nbsp;<span class="op" id="4215554">==</span>&nbsp;<span class="ident" id="4215557">skipNever</span>&nbsp;<span class="op" id="4215567">&amp;&amp;</span>&nbsp;<span class="ident" id="4215570">lookahead</span>&nbsp;<span class="op" id="4215580">&gt;</span>&nbsp;<span class="ident" id="4215582">prevLength</span>&nbsp;<span class="op" id="4215593">&amp;&amp;</span>&nbsp;<span class="ident" id="4215596">prevLength</span>&nbsp;<span class="op" id="4215607">&lt;</span>&nbsp;<span class="ident" id="4215609">d</span><span class="op" id="4215610">.</span><span class="ident" id="4215611">lazy</span><span class="op" id="4215615">)</span>&nbsp;<span class="op" id="4215617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215622">if</span>&nbsp;<span class="ident" id="4215625">newLength</span><span class="op" id="4215634">,</span>&nbsp;<span class="ident" id="4215636">newOffset</span><span class="op" id="4215645">,</span>&nbsp;<span class="ident" id="4215647">ok</span>&nbsp;<span class="op" id="4215650">:=</span>&nbsp;<span class="ident" id="4215653">d</span><span class="op" id="4215654">.</span><span class="ident" id="4215655">findMatch</span><span class="op" id="4215664">(</span><span class="ident" id="4215665">d</span><span class="op" id="4215666">.</span><span class="ident" id="4215667">index</span><span class="op" id="4215672">,</span>&nbsp;<span class="ident" id="4215674">d</span><span class="op" id="4215675">.</span><span class="ident" id="4215676">chainHead</span><span class="op" id="4215685">-</span><span class="ident" id="4215686">d</span><span class="op" id="4215687">.</span><span class="ident" id="4215688">hashOffset</span><span class="op" id="4215698">,</span>&nbsp;<span class="ident" id="4215700">minMatchLength</span><span class="op" id="4215714">-</span><span class="num" id="4215715">1</span><span class="op" id="4215716">,</span>&nbsp;<span class="ident" id="4215718">lookahead</span><span class="op" id="4215727">)</span><span class="op" id="4215728">;</span>&nbsp;<span class="ident" id="4215730">ok</span>&nbsp;<span class="op" id="4215733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215739">d</span><span class="op" id="4215740">.</span><span class="ident" id="4215741">length</span>&nbsp;<span class="op" id="4215748">=</span>&nbsp;<span class="ident" id="4215750">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215764">d</span><span class="op" id="4215765">.</span><span class="ident" id="4215766">offset</span>&nbsp;<span class="op" id="4215773">=</span>&nbsp;<span class="ident" id="4215775">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215788">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215796">if</span>&nbsp;<span class="ident" id="4215799">d</span><span class="op" id="4215800">.</span><span class="ident" id="4215801">fastSkipHashing</span>&nbsp;<span class="op" id="4215817">!=</span>&nbsp;<span class="ident" id="4215820">skipNever</span>&nbsp;<span class="op" id="4215830">&amp;&amp;</span>&nbsp;<span class="ident" id="4215833">d</span><span class="op" id="4215834">.</span><span class="ident" id="4215835">length</span>&nbsp;<span class="op" id="4215842">&gt;=</span>&nbsp;<span class="ident" id="4215845">minMatchLength</span>&nbsp;<span class="op" id="4215860">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215866">d</span><span class="op" id="4215867">.</span><span class="ident" id="4215868">fastSkipHashing</span>&nbsp;<span class="op" id="4215884">==</span>&nbsp;<span class="ident" id="4215887">skipNever</span>&nbsp;<span class="op" id="4215897">&amp;&amp;</span>&nbsp;<span class="ident" id="4215900">prevLength</span>&nbsp;<span class="op" id="4215911">&gt;=</span>&nbsp;<span class="ident" id="4215914">minMatchLength</span>&nbsp;<span class="op" id="4215929">&amp;&amp;</span>&nbsp;<span class="ident" id="4215932">d</span><span class="op" id="4215933">.</span><span class="ident" id="4215934">length</span>&nbsp;<span class="op" id="4215941">&lt;=</span>&nbsp;<span class="ident" id="4215944">prevLength</span>&nbsp;<span class="op" id="4215955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215960">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216031">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216076">if</span>&nbsp;<span class="ident" id="4216079">d</span><span class="op" id="4216080">.</span><span class="ident" id="4216081">fastSkipHashing</span>&nbsp;<span class="op" id="4216097">!=</span>&nbsp;<span class="ident" id="4216100">skipNever</span>&nbsp;<span class="op" id="4216110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216116">d</span><span class="op" id="4216117">.</span><span class="ident" id="4216118">tokens</span>&nbsp;<span class="op" id="4216125">=</span>&nbsp;<span class="builtinfunc" id="4216127">append</span><span class="op" id="4216133">(</span><span class="ident" id="4216134">d</span><span class="op" id="4216135">.</span><span class="ident" id="4216136">tokens</span><span class="op" id="4216142">,</span>&nbsp;<span class="ident" id="4216144">matchToken</span><span class="op" id="4216154">(</span><span class="builtintype" id="4216155">uint32</span><span class="op" id="4216161">(</span><span class="ident" id="4216162">d</span><span class="op" id="4216163">.</span><span class="ident" id="4216164">length</span><span class="op" id="4216170">-</span><span class="ident" id="4216171">minMatchLength</span><span class="op" id="4216185">)</span><span class="op" id="4216186">,</span>&nbsp;<span class="builtintype" id="4216188">uint32</span><span class="op" id="4216194">(</span><span class="ident" id="4216195">d</span><span class="op" id="4216196">.</span><span class="ident" id="4216197">offset</span><span class="op" id="4216203">-</span><span class="ident" id="4216204">minOffsetSize</span><span class="op" id="4216217">)</span><span class="op" id="4216218">)</span><span class="op" id="4216219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216224">}</span>&nbsp;<span class="keyword" id="4216226">else</span>&nbsp;<span class="op" id="4216231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216237">d</span><span class="op" id="4216238">.</span><span class="ident" id="4216239">tokens</span>&nbsp;<span class="op" id="4216246">=</span>&nbsp;<span class="builtinfunc" id="4216248">append</span><span class="op" id="4216254">(</span><span class="ident" id="4216255">d</span><span class="op" id="4216256">.</span><span class="ident" id="4216257">tokens</span><span class="op" id="4216263">,</span>&nbsp;<span class="ident" id="4216265">matchToken</span><span class="op" id="4216275">(</span><span class="builtintype" id="4216276">uint32</span><span class="op" id="4216282">(</span><span class="ident" id="4216283">prevLength</span><span class="op" id="4216293">-</span><span class="ident" id="4216294">minMatchLength</span><span class="op" id="4216308">)</span><span class="op" id="4216309">,</span>&nbsp;<span class="builtintype" id="4216311">uint32</span><span class="op" id="4216317">(</span><span class="ident" id="4216318">prevOffset</span><span class="op" id="4216328">-</span><span class="ident" id="4216329">minOffsetSize</span><span class="op" id="4216342">)</span><span class="op" id="4216343">)</span><span class="op" id="4216344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216349">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216354">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216425">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216494">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216563">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216576">if</span>&nbsp;<span class="ident" id="4216579">d</span><span class="op" id="4216580">.</span><span class="ident" id="4216581">length</span>&nbsp;<span class="op" id="4216588">&lt;=</span>&nbsp;<span class="ident" id="4216591">d</span><span class="op" id="4216592">.</span><span class="ident" id="4216593">fastSkipHashing</span>&nbsp;<span class="op" id="4216609">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216615">var</span>&nbsp;<span class="ident" id="4216619">newIndex</span>&nbsp;<span class="builtintype" id="4216628">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216636">if</span>&nbsp;<span class="ident" id="4216639">d</span><span class="op" id="4216640">.</span><span class="ident" id="4216641">fastSkipHashing</span>&nbsp;<span class="op" id="4216657">!=</span>&nbsp;<span class="ident" id="4216660">skipNever</span>&nbsp;<span class="op" id="4216670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216677">newIndex</span>&nbsp;<span class="op" id="4216686">=</span>&nbsp;<span class="ident" id="4216688">d</span><span class="op" id="4216689">.</span><span class="ident" id="4216690">index</span>&nbsp;<span class="op" id="4216696">+</span>&nbsp;<span class="ident" id="4216698">d</span><span class="op" id="4216699">.</span><span class="ident" id="4216700">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216711">}</span>&nbsp;<span class="keyword" id="4216713">else</span>&nbsp;<span class="op" id="4216718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216725">newIndex</span>&nbsp;<span class="op" id="4216734">=</span>&nbsp;<span class="ident" id="4216736">d</span><span class="op" id="4216737">.</span><span class="ident" id="4216738">index</span>&nbsp;<span class="op" id="4216744">+</span>&nbsp;<span class="ident" id="4216746">prevLength</span>&nbsp;<span class="op" id="4216757">-</span>&nbsp;<span class="num" id="4216759">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216771">for</span>&nbsp;<span class="ident" id="4216775">d</span><span class="op" id="4216776">.</span><span class="ident" id="4216777">index</span><span class="op" id="4216782">++</span><span class="op" id="4216784">;</span>&nbsp;<span class="ident" id="4216786">d</span><span class="op" id="4216787">.</span><span class="ident" id="4216788">index</span>&nbsp;<span class="op" id="4216794">&lt;</span>&nbsp;<span class="ident" id="4216796">newIndex</span><span class="op" id="4216804">;</span>&nbsp;<span class="ident" id="4216806">d</span><span class="op" id="4216807">.</span><span class="ident" id="4216808">index</span><span class="op" id="4216813">++</span>&nbsp;<span class="op" id="4216816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216823">if</span>&nbsp;<span class="ident" id="4216826">d</span><span class="op" id="4216827">.</span><span class="ident" id="4216828">index</span>&nbsp;<span class="op" id="4216834">&lt;</span>&nbsp;<span class="ident" id="4216836">d</span><span class="op" id="4216837">.</span><span class="ident" id="4216838">maxInsertIndex</span>&nbsp;<span class="op" id="4216853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216861">d</span><span class="op" id="4216862">.</span><span class="ident" id="4216863">hash</span>&nbsp;<span class="op" id="4216868">=</span>&nbsp;<span class="op" id="4216870">(</span><span class="ident" id="4216871">d</span><span class="op" id="4216872">.</span><span class="ident" id="4216873">hash</span><span class="op" id="4216877">&lt;&lt;</span><span class="ident" id="4216879">hashShift</span>&nbsp;<span class="op" id="4216889">+</span>&nbsp;<span class="builtintype" id="4216891">int</span><span class="op" id="4216894">(</span><span class="ident" id="4216895">d</span><span class="op" id="4216896">.</span><span class="ident" id="4216897">window</span><span class="op" id="4216903">[</span><span class="ident" id="4216904">d</span><span class="op" id="4216905">.</span><span class="ident" id="4216906">index</span><span class="op" id="4216911">+</span><span class="num" id="4216912">2</span><span class="op" id="4216913">]</span><span class="op" id="4216914">)</span><span class="op" id="4216915">)</span>&nbsp;<span class="op" id="4216917">&amp;</span>&nbsp;<span class="ident" id="4216919">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216934">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216982">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217037">d</span><span class="op" id="4217038">.</span><span class="ident" id="4217039">hashPrev</span><span class="op" id="4217047">[</span><span class="ident" id="4217048">d</span><span class="op" id="4217049">.</span><span class="ident" id="4217050">index</span><span class="op" id="4217055">&amp;</span><span class="ident" id="4217056">windowMask</span><span class="op" id="4217066">]</span>&nbsp;<span class="op" id="4217068">=</span>&nbsp;<span class="ident" id="4217070">d</span><span class="op" id="4217071">.</span><span class="ident" id="4217072">hashHead</span><span class="op" id="4217080">[</span><span class="ident" id="4217081">d</span><span class="op" id="4217082">.</span><span class="ident" id="4217083">hash</span><span class="op" id="4217087">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217095">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217142">d</span><span class="op" id="4217143">.</span><span class="ident" id="4217144">hashHead</span><span class="op" id="4217152">[</span><span class="ident" id="4217153">d</span><span class="op" id="4217154">.</span><span class="ident" id="4217155">hash</span><span class="op" id="4217159">]</span>&nbsp;<span class="op" id="4217161">=</span>&nbsp;<span class="ident" id="4217163">d</span><span class="op" id="4217164">.</span><span class="ident" id="4217165">index</span>&nbsp;<span class="op" id="4217171">+</span>&nbsp;<span class="ident" id="4217173">d</span><span class="op" id="4217174">.</span><span class="ident" id="4217175">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217191">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217203">if</span>&nbsp;<span class="ident" id="4217206">d</span><span class="op" id="4217207">.</span><span class="ident" id="4217208">fastSkipHashing</span>&nbsp;<span class="op" id="4217224">==</span>&nbsp;<span class="ident" id="4217227">skipNever</span>&nbsp;<span class="op" id="4217237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217244">d</span><span class="op" id="4217245">.</span><span class="ident" id="4217246">byteAvailable</span>&nbsp;<span class="op" id="4217260">=</span>&nbsp;<span class="builtintype" id="4217262">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217273">d</span><span class="op" id="4217274">.</span><span class="ident" id="4217275">length</span>&nbsp;<span class="op" id="4217282">=</span>&nbsp;<span class="ident" id="4217284">minMatchLength</span>&nbsp;<span class="op" id="4217299">-</span>&nbsp;<span class="num" id="4217301">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217307">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217312">}</span>&nbsp;<span class="keyword" id="4217314">else</span>&nbsp;<span class="op" id="4217319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217325">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217397">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217425">d</span><span class="op" id="4217426">.</span><span class="ident" id="4217427">index</span>&nbsp;<span class="op" id="4217433">+=</span>&nbsp;<span class="ident" id="4217436">d</span><span class="op" id="4217437">.</span><span class="ident" id="4217438">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217449">if</span>&nbsp;<span class="ident" id="4217452">d</span><span class="op" id="4217453">.</span><span class="ident" id="4217454">index</span>&nbsp;<span class="op" id="4217460">&lt;</span>&nbsp;<span class="ident" id="4217462">d</span><span class="op" id="4217463">.</span><span class="ident" id="4217464">maxInsertIndex</span>&nbsp;<span class="op" id="4217479">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217486">d</span><span class="op" id="4217487">.</span><span class="ident" id="4217488">hash</span>&nbsp;<span class="op" id="4217493">=</span>&nbsp;<span class="op" id="4217495">(</span><span class="builtintype" id="4217496">int</span><span class="op" id="4217499">(</span><span class="ident" id="4217500">d</span><span class="op" id="4217501">.</span><span class="ident" id="4217502">window</span><span class="op" id="4217508">[</span><span class="ident" id="4217509">d</span><span class="op" id="4217510">.</span><span class="ident" id="4217511">index</span><span class="op" id="4217516">]</span><span class="op" id="4217517">)</span><span class="op" id="4217518">&lt;&lt;</span><span class="ident" id="4217520">hashShift</span>&nbsp;<span class="op" id="4217530">+</span>&nbsp;<span class="builtintype" id="4217532">int</span><span class="op" id="4217535">(</span><span class="ident" id="4217536">d</span><span class="op" id="4217537">.</span><span class="ident" id="4217538">window</span><span class="op" id="4217544">[</span><span class="ident" id="4217545">d</span><span class="op" id="4217546">.</span><span class="ident" id="4217547">index</span><span class="op" id="4217552">+</span><span class="num" id="4217553">1</span><span class="op" id="4217554">]</span><span class="op" id="4217555">)</span><span class="op" id="4217556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217572">if</span>&nbsp;<span class="builtinfunc" id="4217575">len</span><span class="op" id="4217578">(</span><span class="ident" id="4217579">d</span><span class="op" id="4217580">.</span><span class="ident" id="4217581">tokens</span><span class="op" id="4217587">)</span>&nbsp;<span class="op" id="4217589">==</span>&nbsp;<span class="ident" id="4217592">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4217612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217618">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217666">if</span>&nbsp;<span class="ident" id="4217669">d</span><span class="op" id="4217670">.</span><span class="ident" id="4217671">err</span>&nbsp;<span class="op" id="4217675">=</span>&nbsp;<span class="ident" id="4217677">d</span><span class="op" id="4217678">.</span><span class="ident" id="4217679">writeBlock</span><span class="op" id="4217689">(</span><span class="ident" id="4217690">d</span><span class="op" id="4217691">.</span><span class="ident" id="4217692">tokens</span><span class="op" id="4217698">,</span>&nbsp;<span class="ident" id="4217700">d</span><span class="op" id="4217701">.</span><span class="ident" id="4217702">index</span><span class="op" id="4217707">,</span>&nbsp;<span class="builtintype" id="4217709">false</span><span class="op" id="4217714">)</span><span class="op" id="4217715">;</span>&nbsp;<span class="ident" id="4217717">d</span><span class="op" id="4217718">.</span><span class="ident" id="4217719">err</span>&nbsp;<span class="op" id="4217723">!=</span>&nbsp;<span class="builtintype" id="4217726">nil</span>&nbsp;<span class="op" id="4217730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217737">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217754">d</span><span class="op" id="4217755">.</span><span class="ident" id="4217756">tokens</span>&nbsp;<span class="op" id="4217763">=</span>&nbsp;<span class="ident" id="4217765">d</span><span class="op" id="4217766">.</span><span class="ident" id="4217767">tokens</span><span class="op" id="4217773">[</span><span class="op" id="4217774">:</span><span class="num" id="4217775">0</span><span class="op" id="4217776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217781">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217785">}</span>&nbsp;<span class="keyword" id="4217787">else</span>&nbsp;<span class="op" id="4217792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217797">if</span>&nbsp;<span class="ident" id="4217800">d</span><span class="op" id="4217801">.</span><span class="ident" id="4217802">fastSkipHashing</span>&nbsp;<span class="op" id="4217818">!=</span>&nbsp;<span class="ident" id="4217821">skipNever</span>&nbsp;<span class="op" id="4217831">||</span>&nbsp;<span class="ident" id="4217834">d</span><span class="op" id="4217835">.</span><span class="ident" id="4217836">byteAvailable</span>&nbsp;<span class="op" id="4217850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217856">i</span>&nbsp;<span class="op" id="4217858">:=</span>&nbsp;<span class="ident" id="4217861">d</span><span class="op" id="4217862">.</span><span class="ident" id="4217863">index</span>&nbsp;<span class="op" id="4217869">-</span>&nbsp;<span class="num" id="4217871">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217877">if</span>&nbsp;<span class="ident" id="4217880">d</span><span class="op" id="4217881">.</span><span class="ident" id="4217882">fastSkipHashing</span>&nbsp;<span class="op" id="4217898">!=</span>&nbsp;<span class="ident" id="4217901">skipNever</span>&nbsp;<span class="op" id="4217911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217918">i</span>&nbsp;<span class="op" id="4217920">=</span>&nbsp;<span class="ident" id="4217922">d</span><span class="op" id="4217923">.</span><span class="ident" id="4217924">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217940">d</span><span class="op" id="4217941">.</span><span class="ident" id="4217942">tokens</span>&nbsp;<span class="op" id="4217949">=</span>&nbsp;<span class="builtinfunc" id="4217951">append</span><span class="op" id="4217957">(</span><span class="ident" id="4217958">d</span><span class="op" id="4217959">.</span><span class="ident" id="4217960">tokens</span><span class="op" id="4217966">,</span>&nbsp;<span class="ident" id="4217968">literalToken</span><span class="op" id="4217980">(</span><span class="builtintype" id="4217981">uint32</span><span class="op" id="4217987">(</span><span class="ident" id="4217988">d</span><span class="op" id="4217989">.</span><span class="ident" id="4217990">window</span><span class="op" id="4217996">[</span><span class="ident" id="4217997">i</span><span class="op" id="4217998">]</span><span class="op" id="4217999">)</span><span class="op" id="4218000">)</span><span class="op" id="4218001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218007">if</span>&nbsp;<span class="builtinfunc" id="4218010">len</span><span class="op" id="4218013">(</span><span class="ident" id="4218014">d</span><span class="op" id="4218015">.</span><span class="ident" id="4218016">tokens</span><span class="op" id="4218022">)</span>&nbsp;<span class="op" id="4218024">==</span>&nbsp;<span class="ident" id="4218027">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4218047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218054">if</span>&nbsp;<span class="ident" id="4218057">d</span><span class="op" id="4218058">.</span><span class="ident" id="4218059">err</span>&nbsp;<span class="op" id="4218063">=</span>&nbsp;<span class="ident" id="4218065">d</span><span class="op" id="4218066">.</span><span class="ident" id="4218067">writeBlock</span><span class="op" id="4218077">(</span><span class="ident" id="4218078">d</span><span class="op" id="4218079">.</span><span class="ident" id="4218080">tokens</span><span class="op" id="4218086">,</span>&nbsp;<span class="ident" id="4218088">i</span><span class="op" id="4218089">+</span><span class="num" id="4218090">1</span><span class="op" id="4218091">,</span>&nbsp;<span class="builtintype" id="4218093">false</span><span class="op" id="4218098">)</span><span class="op" id="4218099">;</span>&nbsp;<span class="ident" id="4218101">d</span><span class="op" id="4218102">.</span><span class="ident" id="4218103">err</span>&nbsp;<span class="op" id="4218107">!=</span>&nbsp;<span class="builtintype" id="4218110">nil</span>&nbsp;<span class="op" id="4218114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218122">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218141">d</span><span class="op" id="4218142">.</span><span class="ident" id="4218143">tokens</span>&nbsp;<span class="op" id="4218150">=</span>&nbsp;<span class="ident" id="4218152">d</span><span class="op" id="4218153">.</span><span class="ident" id="4218154">tokens</span><span class="op" id="4218160">[</span><span class="op" id="4218161">:</span><span class="num" id="4218162">0</span><span class="op" id="4218163">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218179">d</span><span class="op" id="4218180">.</span><span class="ident" id="4218181">index</span><span class="op" id="4218186">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218192">if</span>&nbsp;<span class="ident" id="4218195">d</span><span class="op" id="4218196">.</span><span class="ident" id="4218197">fastSkipHashing</span>&nbsp;<span class="op" id="4218213">==</span>&nbsp;<span class="ident" id="4218216">skipNever</span>&nbsp;<span class="op" id="4218226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218232">d</span><span class="op" id="4218233">.</span><span class="ident" id="4218234">byteAvailable</span>&nbsp;<span class="op" id="4218248">=</span>&nbsp;<span class="builtintype" id="4218250">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218265">}</span><br>
<span class="lineno">360</span><span class="op" id="4218267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218270">func</span>&nbsp;<span class="op" id="4218275">(</span><span class="ident" id="4218276">d</span>&nbsp;<span class="op" id="4218278">*</span><span class="ident" id="4218279">compressor</span><span class="op" id="4218289">)</span>&nbsp;<span class="ident" id="4218291">fillStore</span><span class="op" id="4218300">(</span><span class="ident" id="4218301">b</span>&nbsp;<span class="op" id="4218303">[</span><span class="op" id="4218304">]</span><span class="builtintype" id="4218305">byte</span><span class="op" id="4218309">)</span>&nbsp;<span class="builtintype" id="4218311">int</span>&nbsp;<span class="op" id="4218315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218318">n</span>&nbsp;<span class="op" id="4218320">:=</span>&nbsp;<span class="builtinfunc" id="4218323">copy</span><span class="op" id="4218327">(</span><span class="ident" id="4218328">d</span><span class="op" id="4218329">.</span><span class="ident" id="4218330">window</span><span class="op" id="4218336">[</span><span class="ident" id="4218337">d</span><span class="op" id="4218338">.</span><span class="ident" id="4218339">windowEnd</span><span class="op" id="4218348">:</span><span class="op" id="4218349">]</span><span class="op" id="4218350">,</span>&nbsp;<span class="ident" id="4218352">b</span><span class="op" id="4218353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218356">d</span><span class="op" id="4218357">.</span><span class="ident" id="4218358">windowEnd</span>&nbsp;<span class="op" id="4218368">+=</span>&nbsp;<span class="ident" id="4218371">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218374">return</span>&nbsp;<span class="ident" id="4218381">n</span><br>
<span class="lineno"></span><span class="op" id="4218383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218386">func</span>&nbsp;<span class="op" id="4218391">(</span><span class="ident" id="4218392">d</span>&nbsp;<span class="op" id="4218394">*</span><span class="ident" id="4218395">compressor</span><span class="op" id="4218405">)</span>&nbsp;<span class="ident" id="4218407">store</span><span class="op" id="4218412">(</span><span class="op" id="4218413">)</span>&nbsp;<span class="op" id="4218415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218418">if</span>&nbsp;<span class="ident" id="4218421">d</span><span class="op" id="4218422">.</span><span class="ident" id="4218423">windowEnd</span>&nbsp;<span class="op" id="4218433">&gt;</span>&nbsp;<span class="num" id="4218435">0</span>&nbsp;<span class="op" id="4218437">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218441">d</span><span class="op" id="4218442">.</span><span class="ident" id="4218443">err</span>&nbsp;<span class="op" id="4218447">=</span>&nbsp;<span class="ident" id="4218449">d</span><span class="op" id="4218450">.</span><span class="ident" id="4218451">writeStoredBlock</span><span class="op" id="4218467">(</span><span class="ident" id="4218468">d</span><span class="op" id="4218469">.</span><span class="ident" id="4218470">window</span><span class="op" id="4218476">[</span><span class="op" id="4218477">:</span><span class="ident" id="4218478">d</span><span class="op" id="4218479">.</span><span class="ident" id="4218480">windowEnd</span><span class="op" id="4218489">]</span><span class="op" id="4218490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218496">d</span><span class="op" id="4218497">.</span><span class="ident" id="4218498">windowEnd</span>&nbsp;<span class="op" id="4218508">=</span>&nbsp;<span class="num" id="4218510">0</span><br>
<span class="lineno"></span><span class="op" id="4218512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4218515">func</span>&nbsp;<span class="op" id="4218520">(</span><span class="ident" id="4218521">d</span>&nbsp;<span class="op" id="4218523">*</span><span class="ident" id="4218524">compressor</span><span class="op" id="4218534">)</span>&nbsp;<span class="ident" id="4218536">write</span><span class="op" id="4218541">(</span><span class="ident" id="4218542">b</span>&nbsp;<span class="op" id="4218544">[</span><span class="op" id="4218545">]</span><span class="builtintype" id="4218546">byte</span><span class="op" id="4218550">)</span>&nbsp;<span class="op" id="4218552">(</span><span class="ident" id="4218553">n</span>&nbsp;<span class="builtintype" id="4218555">int</span><span class="op" id="4218558">,</span>&nbsp;<span class="ident" id="4218560">err</span>&nbsp;<span class="builtintype" id="4218564">error</span><span class="op" id="4218569">)</span>&nbsp;<span class="op" id="4218571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218574">n</span>&nbsp;<span class="op" id="4218576">=</span>&nbsp;<span class="builtinfunc" id="4218578">len</span><span class="op" id="4218581">(</span><span class="ident" id="4218582">b</span><span class="op" id="4218583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218586">b</span>&nbsp;<span class="op" id="4218588">=</span>&nbsp;<span class="ident" id="4218590">b</span><span class="op" id="4218591">[</span><span class="ident" id="4218592">d</span><span class="op" id="4218593">.</span><span class="ident" id="4218594">fill</span><span class="op" id="4218598">(</span><span class="ident" id="4218599">d</span><span class="op" id="4218600">,</span>&nbsp;<span class="ident" id="4218602">b</span><span class="op" id="4218603">)</span><span class="op" id="4218604">:</span><span class="op" id="4218605">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218608">for</span>&nbsp;<span class="builtinfunc" id="4218612">len</span><span class="op" id="4218615">(</span><span class="ident" id="4218616">b</span><span class="op" id="4218617">)</span>&nbsp;<span class="op" id="4218619">&gt;</span>&nbsp;<span class="num" id="4218621">0</span>&nbsp;<span class="op" id="4218623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218627">d</span><span class="op" id="4218628">.</span><span class="ident" id="4218629">step</span><span class="op" id="4218633">(</span><span class="ident" id="4218634">d</span><span class="op" id="4218635">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218639">b</span>&nbsp;<span class="op" id="4218641">=</span>&nbsp;<span class="ident" id="4218643">b</span><span class="op" id="4218644">[</span><span class="ident" id="4218645">d</span><span class="op" id="4218646">.</span><span class="ident" id="4218647">fill</span><span class="op" id="4218651">(</span><span class="ident" id="4218652">d</span><span class="op" id="4218653">,</span>&nbsp;<span class="ident" id="4218655">b</span><span class="op" id="4218656">)</span><span class="op" id="4218657">:</span><span class="op" id="4218658">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218664">return</span>&nbsp;<span class="ident" id="4218671">n</span><span class="op" id="4218672">,</span>&nbsp;<span class="ident" id="4218674">d</span><span class="op" id="4218675">.</span><span class="ident" id="4218676">err</span><br>
<span class="lineno"></span><span class="op" id="4218680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4218683">func</span>&nbsp;<span class="op" id="4218688">(</span><span class="ident" id="4218689">d</span>&nbsp;<span class="op" id="4218691">*</span><span class="ident" id="4218692">compressor</span><span class="op" id="4218702">)</span>&nbsp;<span class="ident" id="4218704">syncFlush</span><span class="op" id="4218713">(</span><span class="op" id="4218714">)</span>&nbsp;<span class="builtintype" id="4218716">error</span>&nbsp;<span class="op" id="4218722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218725">d</span><span class="op" id="4218726">.</span><span class="ident" id="4218727">sync</span>&nbsp;<span class="op" id="4218732">=</span>&nbsp;<span class="builtintype" id="4218734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218740">d</span><span class="op" id="4218741">.</span><span class="ident" id="4218742">step</span><span class="op" id="4218746">(</span><span class="ident" id="4218747">d</span><span class="op" id="4218748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218751">if</span>&nbsp;<span class="ident" id="4218754">d</span><span class="op" id="4218755">.</span><span class="ident" id="4218756">err</span>&nbsp;<span class="op" id="4218760">==</span>&nbsp;<span class="builtintype" id="4218763">nil</span>&nbsp;<span class="op" id="4218767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218771">d</span><span class="op" id="4218772">.</span><span class="ident" id="4218773">w</span><span class="op" id="4218774">.</span><span class="ident" id="4218775">writeStoredHeader</span><span class="op" id="4218792">(</span><span class="num" id="4218793">0</span><span class="op" id="4218794">,</span>&nbsp;<span class="builtintype" id="4218796">false</span><span class="op" id="4218801">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218805">d</span><span class="op" id="4218806">.</span><span class="ident" id="4218807">w</span><span class="op" id="4218808">.</span><span class="ident" id="4218809">flush</span><span class="op" id="4218814">(</span><span class="op" id="4218815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218819">d</span><span class="op" id="4218820">.</span><span class="ident" id="4218821">err</span>&nbsp;<span class="op" id="4218825">=</span>&nbsp;<span class="ident" id="4218827">d</span><span class="op" id="4218828">.</span><span class="ident" id="4218829">w</span><span class="op" id="4218830">.</span><span class="ident" id="4218831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218839">d</span><span class="op" id="4218840">.</span><span class="ident" id="4218841">sync</span>&nbsp;<span class="op" id="4218846">=</span>&nbsp;<span class="builtintype" id="4218848">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218855">return</span>&nbsp;<span class="ident" id="4218862">d</span><span class="op" id="4218863">.</span><span class="ident" id="4218864">err</span><br>
<span class="lineno">395</span><span class="op" id="4218868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218871">func</span>&nbsp;<span class="op" id="4218876">(</span><span class="ident" id="4218877">d</span>&nbsp;<span class="op" id="4218879">*</span><span class="ident" id="4218880">compressor</span><span class="op" id="4218890">)</span>&nbsp;<span class="ident" id="4218892">init</span><span class="op" id="4218896">(</span><span class="ident" id="4218897">w</span>&nbsp;<span class="ident" id="4218899">io</span><span class="op" id="4218901">.</span><span class="ident" id="4218902">Writer</span><span class="op" id="4218908">,</span>&nbsp;<span class="ident" id="4218910">level</span>&nbsp;<span class="builtintype" id="4218916">int</span><span class="op" id="4218919">)</span>&nbsp;<span class="op" id="4218921">(</span><span class="ident" id="4218922">err</span>&nbsp;<span class="builtintype" id="4218926">error</span><span class="op" id="4218931">)</span>&nbsp;<span class="op" id="4218933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218936">d</span><span class="op" id="4218937">.</span><span class="ident" id="4218938">w</span>&nbsp;<span class="op" id="4218940">=</span>&nbsp;<span class="ident" id="4218942">newHuffmanBitWriter</span><span class="op" id="4218961">(</span><span class="ident" id="4218962">w</span><span class="op" id="4218963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218967">switch</span>&nbsp;<span class="op" id="4218974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218977">case</span>&nbsp;<span class="ident" id="4218982">level</span>&nbsp;<span class="op" id="4218988">==</span>&nbsp;<span class="ident" id="4218991">NoCompression</span><span class="op" id="4219004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219008">d</span><span class="op" id="4219009">.</span><span class="ident" id="4219010">window</span>&nbsp;<span class="op" id="4219017">=</span>&nbsp;<span class="builtinfunc" id="4219019">make</span><span class="op" id="4219023">(</span><span class="op" id="4219024">[</span><span class="op" id="4219025">]</span><span class="builtintype" id="4219026">byte</span><span class="op" id="4219030">,</span>&nbsp;<span class="ident" id="4219032">maxStoreBlockSize</span><span class="op" id="4219049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219053">d</span><span class="op" id="4219054">.</span><span class="ident" id="4219055">fill</span>&nbsp;<span class="op" id="4219060">=</span>&nbsp;<span class="op" id="4219062">(</span><span class="op" id="4219063">*</span><span class="ident" id="4219064">compressor</span><span class="op" id="4219074">)</span><span class="op" id="4219075">.</span><span class="ident" id="4219076">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219088">d</span><span class="op" id="4219089">.</span><span class="ident" id="4219090">step</span>&nbsp;<span class="op" id="4219095">=</span>&nbsp;<span class="op" id="4219097">(</span><span class="op" id="4219098">*</span><span class="ident" id="4219099">compressor</span><span class="op" id="4219109">)</span><span class="op" id="4219110">.</span><span class="ident" id="4219111">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219118">case</span>&nbsp;<span class="ident" id="4219123">level</span>&nbsp;<span class="op" id="4219129">==</span>&nbsp;<span class="ident" id="4219132">DefaultCompression</span><span class="op" id="4219150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219154">level</span>&nbsp;<span class="op" id="4219160">=</span>&nbsp;<span class="num" id="4219162">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219166">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219179">case</span>&nbsp;<span class="num" id="4219184">1</span>&nbsp;<span class="op" id="4219186">&lt;=</span>&nbsp;<span class="ident" id="4219189">level</span>&nbsp;<span class="op" id="4219195">&amp;&amp;</span>&nbsp;<span class="ident" id="4219198">level</span>&nbsp;<span class="op" id="4219204">&lt;=</span>&nbsp;<span class="num" id="4219207">9</span><span class="op" id="4219208">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219212">d</span><span class="op" id="4219213">.</span><span class="ident" id="4219214">compressionLevel</span>&nbsp;<span class="op" id="4219231">=</span>&nbsp;<span class="ident" id="4219233">levels</span><span class="op" id="4219239">[</span><span class="ident" id="4219240">level</span><span class="op" id="4219245">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219249">d</span><span class="op" id="4219250">.</span><span class="ident" id="4219251">initDeflate</span><span class="op" id="4219262">(</span><span class="op" id="4219263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219267">d</span><span class="op" id="4219268">.</span><span class="ident" id="4219269">fill</span>&nbsp;<span class="op" id="4219274">=</span>&nbsp;<span class="op" id="4219276">(</span><span class="op" id="4219277">*</span><span class="ident" id="4219278">compressor</span><span class="op" id="4219288">)</span><span class="op" id="4219289">.</span><span class="ident" id="4219290">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219304">d</span><span class="op" id="4219305">.</span><span class="ident" id="4219306">step</span>&nbsp;<span class="op" id="4219311">=</span>&nbsp;<span class="op" id="4219313">(</span><span class="op" id="4219314">*</span><span class="ident" id="4219315">compressor</span><span class="op" id="4219325">)</span><span class="op" id="4219326">.</span><span class="ident" id="4219327">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219336">default</span><span class="op" id="4219343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219347">return</span>&nbsp;<span class="ident" id="4219354">fmt</span><span class="op" id="4219357">.</span><span class="ident" id="4219358">Errorf</span><span class="op" id="4219364">(</span><span class="string" id="4219365">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4219431">,</span>&nbsp;<span class="ident" id="4219433">level</span><span class="op" id="4219438">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219444">return</span>&nbsp;<span class="builtintype" id="4219451">nil</span><br>
<span class="lineno"></span><span class="op" id="4219455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4219458">var</span>&nbsp;<span class="ident" id="4219462">zeroes</span>&nbsp;<span class="op" id="4219469">[</span><span class="num" id="4219470">32</span><span class="op" id="4219472">]</span><span class="builtintype" id="4219473">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4219477">var</span>&nbsp;<span class="ident" id="4219481">bzeroes</span>&nbsp;<span class="op" id="4219489">[</span><span class="num" id="4219490">256</span><span class="op" id="4219493">]</span><span class="builtintype" id="4219494">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4219500">func</span>&nbsp;<span class="op" id="4219505">(</span><span class="ident" id="4219506">d</span>&nbsp;<span class="op" id="4219508">*</span><span class="ident" id="4219509">compressor</span><span class="op" id="4219519">)</span>&nbsp;<span class="ident" id="4219521">reset</span><span class="op" id="4219526">(</span><span class="ident" id="4219527">w</span>&nbsp;<span class="ident" id="4219529">io</span><span class="op" id="4219531">.</span><span class="ident" id="4219532">Writer</span><span class="op" id="4219538">)</span>&nbsp;<span class="op" id="4219540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219543">d</span><span class="op" id="4219544">.</span><span class="ident" id="4219545">w</span><span class="op" id="4219546">.</span><span class="ident" id="4219547">reset</span><span class="op" id="4219552">(</span><span class="ident" id="4219553">w</span><span class="op" id="4219554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219557">d</span><span class="op" id="4219558">.</span><span class="ident" id="4219559">sync</span>&nbsp;<span class="op" id="4219564">=</span>&nbsp;<span class="builtintype" id="4219566">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219573">d</span><span class="op" id="4219574">.</span><span class="ident" id="4219575">err</span>&nbsp;<span class="op" id="4219579">=</span>&nbsp;<span class="builtintype" id="4219581">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219586">switch</span>&nbsp;<span class="ident" id="4219593">d</span><span class="op" id="4219594">.</span><span class="ident" id="4219595">compressionLevel</span><span class="op" id="4219611">.</span><span class="ident" id="4219612">chain</span>&nbsp;<span class="op" id="4219618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219621">case</span>&nbsp;<span class="num" id="4219626">0</span><span class="op" id="4219627">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4219631">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219661">for</span>&nbsp;<span class="ident" id="4219665">i</span>&nbsp;<span class="op" id="4219667">:=</span>&nbsp;<span class="keyword" id="4219670">range</span>&nbsp;<span class="ident" id="4219676">d</span><span class="op" id="4219677">.</span><span class="ident" id="4219678">window</span>&nbsp;<span class="op" id="4219685">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219690">d</span><span class="op" id="4219691">.</span><span class="ident" id="4219692">window</span><span class="op" id="4219698">[</span><span class="ident" id="4219699">i</span><span class="op" id="4219700">]</span>&nbsp;<span class="op" id="4219702">=</span>&nbsp;<span class="num" id="4219704">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219712">d</span><span class="op" id="4219713">.</span><span class="ident" id="4219714">windowEnd</span>&nbsp;<span class="op" id="4219724">=</span>&nbsp;<span class="num" id="4219726">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219729">default</span><span class="op" id="4219736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219740">d</span><span class="op" id="4219741">.</span><span class="ident" id="4219742">chainHead</span>&nbsp;<span class="op" id="4219752">=</span>&nbsp;<span class="op" id="4219754">-</span><span class="num" id="4219755">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219759">for</span>&nbsp;<span class="ident" id="4219763">s</span>&nbsp;<span class="op" id="4219765">:=</span>&nbsp;<span class="ident" id="4219768">d</span><span class="op" id="4219769">.</span><span class="ident" id="4219770">hashHead</span><span class="op" id="4219778">;</span>&nbsp;<span class="builtinfunc" id="4219780">len</span><span class="op" id="4219783">(</span><span class="ident" id="4219784">s</span><span class="op" id="4219785">)</span>&nbsp;<span class="op" id="4219787">&gt;</span>&nbsp;<span class="num" id="4219789">0</span><span class="op" id="4219790">;</span>&nbsp;<span class="op" id="4219792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219797">n</span>&nbsp;<span class="op" id="4219799">:=</span>&nbsp;<span class="builtinfunc" id="4219802">copy</span><span class="op" id="4219806">(</span><span class="ident" id="4219807">s</span><span class="op" id="4219808">,</span>&nbsp;<span class="ident" id="4219810">zeroes</span><span class="op" id="4219816">[</span><span class="op" id="4219817">:</span><span class="op" id="4219818">]</span><span class="op" id="4219819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219824">s</span>&nbsp;<span class="op" id="4219826">=</span>&nbsp;<span class="ident" id="4219828">s</span><span class="op" id="4219829">[</span><span class="ident" id="4219830">n</span><span class="op" id="4219831">:</span><span class="op" id="4219832">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219840">for</span>&nbsp;<span class="ident" id="4219844">s</span>&nbsp;<span class="op" id="4219846">:=</span>&nbsp;<span class="ident" id="4219849">d</span><span class="op" id="4219850">.</span><span class="ident" id="4219851">hashPrev</span><span class="op" id="4219859">;</span>&nbsp;<span class="builtinfunc" id="4219861">len</span><span class="op" id="4219864">(</span><span class="ident" id="4219865">s</span><span class="op" id="4219866">)</span>&nbsp;<span class="op" id="4219868">&gt;</span>&nbsp;<span class="num" id="4219870">0</span><span class="op" id="4219871">;</span>&nbsp;<span class="ident" id="4219873">s</span>&nbsp;<span class="op" id="4219875">=</span>&nbsp;<span class="ident" id="4219877">s</span><span class="op" id="4219878">[</span><span class="builtinfunc" id="4219879">len</span><span class="op" id="4219882">(</span><span class="ident" id="4219883">zeroes</span><span class="op" id="4219889">)</span><span class="op" id="4219890">:</span><span class="op" id="4219891">]</span>&nbsp;<span class="op" id="4219893">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4219898">copy</span><span class="op" id="4219902">(</span><span class="ident" id="4219903">s</span><span class="op" id="4219904">,</span>&nbsp;<span class="ident" id="4219906">zeroes</span><span class="op" id="4219912">[</span><span class="op" id="4219913">:</span><span class="op" id="4219914">]</span><span class="op" id="4219915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219923">d</span><span class="op" id="4219924">.</span><span class="ident" id="4219925">hashOffset</span>&nbsp;<span class="op" id="4219936">=</span>&nbsp;<span class="num" id="4219938">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219943">d</span><span class="op" id="4219944">.</span><span class="ident" id="4219945">index</span><span class="op" id="4219950">,</span>&nbsp;<span class="ident" id="4219952">d</span><span class="op" id="4219953">.</span><span class="ident" id="4219954">windowEnd</span>&nbsp;<span class="op" id="4219964">=</span>&nbsp;<span class="num" id="4219966">0</span><span class="op" id="4219967">,</span>&nbsp;<span class="num" id="4219969">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219973">for</span>&nbsp;<span class="ident" id="4219977">s</span>&nbsp;<span class="op" id="4219979">:=</span>&nbsp;<span class="ident" id="4219982">d</span><span class="op" id="4219983">.</span><span class="ident" id="4219984">window</span><span class="op" id="4219990">;</span>&nbsp;<span class="builtinfunc" id="4219992">len</span><span class="op" id="4219995">(</span><span class="ident" id="4219996">s</span><span class="op" id="4219997">)</span>&nbsp;<span class="op" id="4219999">&gt;</span>&nbsp;<span class="num" id="4220001">0</span><span class="op" id="4220002">;</span>&nbsp;<span class="op" id="4220004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220009">n</span>&nbsp;<span class="op" id="4220011">:=</span>&nbsp;<span class="builtinfunc" id="4220014">copy</span><span class="op" id="4220018">(</span><span class="ident" id="4220019">s</span><span class="op" id="4220020">,</span>&nbsp;<span class="ident" id="4220022">bzeroes</span><span class="op" id="4220029">[</span><span class="op" id="4220030">:</span><span class="op" id="4220031">]</span><span class="op" id="4220032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220037">s</span>&nbsp;<span class="op" id="4220039">=</span>&nbsp;<span class="ident" id="4220041">s</span><span class="op" id="4220042">[</span><span class="ident" id="4220043">n</span><span class="op" id="4220044">:</span><span class="op" id="4220045">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220053">d</span><span class="op" id="4220054">.</span><span class="ident" id="4220055">blockStart</span><span class="op" id="4220065">,</span>&nbsp;<span class="ident" id="4220067">d</span><span class="op" id="4220068">.</span><span class="ident" id="4220069">byteAvailable</span>&nbsp;<span class="op" id="4220083">=</span>&nbsp;<span class="num" id="4220085">0</span><span class="op" id="4220086">,</span>&nbsp;<span class="builtintype" id="4220088">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220097">d</span><span class="op" id="4220098">.</span><span class="ident" id="4220099">tokens</span>&nbsp;<span class="op" id="4220106">=</span>&nbsp;<span class="ident" id="4220108">d</span><span class="op" id="4220109">.</span><span class="ident" id="4220110">tokens</span><span class="op" id="4220116">[</span><span class="op" id="4220117">:</span><span class="ident" id="4220118">maxFlateBlockTokens</span><span class="op" id="4220137">+</span><span class="num" id="4220138">1</span><span class="op" id="4220139">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220143">for</span>&nbsp;<span class="ident" id="4220147">i</span>&nbsp;<span class="op" id="4220149">:=</span>&nbsp;<span class="num" id="4220152">0</span><span class="op" id="4220153">;</span>&nbsp;<span class="ident" id="4220155">i</span>&nbsp;<span class="op" id="4220157">&lt;=</span>&nbsp;<span class="ident" id="4220160">maxFlateBlockTokens</span><span class="op" id="4220179">;</span>&nbsp;<span class="ident" id="4220181">i</span><span class="op" id="4220182">++</span>&nbsp;<span class="op" id="4220185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220190">d</span><span class="op" id="4220191">.</span><span class="ident" id="4220192">tokens</span><span class="op" id="4220198">[</span><span class="ident" id="4220199">i</span><span class="op" id="4220200">]</span>&nbsp;<span class="op" id="4220202">=</span>&nbsp;<span class="num" id="4220204">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220208">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220212">d</span><span class="op" id="4220213">.</span><span class="ident" id="4220214">tokens</span>&nbsp;<span class="op" id="4220221">=</span>&nbsp;<span class="ident" id="4220223">d</span><span class="op" id="4220224">.</span><span class="ident" id="4220225">tokens</span><span class="op" id="4220231">[</span><span class="op" id="4220232">:</span><span class="num" id="4220233">0</span><span class="op" id="4220234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220238">d</span><span class="op" id="4220239">.</span><span class="ident" id="4220240">length</span>&nbsp;<span class="op" id="4220247">=</span>&nbsp;<span class="ident" id="4220249">minMatchLength</span>&nbsp;<span class="op" id="4220264">-</span>&nbsp;<span class="num" id="4220266">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220270">d</span><span class="op" id="4220271">.</span><span class="ident" id="4220272">offset</span>&nbsp;<span class="op" id="4220279">=</span>&nbsp;<span class="num" id="4220281">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220285">d</span><span class="op" id="4220286">.</span><span class="ident" id="4220287">hash</span>&nbsp;<span class="op" id="4220292">=</span>&nbsp;<span class="num" id="4220294">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220298">d</span><span class="op" id="4220299">.</span><span class="ident" id="4220300">maxInsertIndex</span>&nbsp;<span class="op" id="4220315">=</span>&nbsp;<span class="num" id="4220317">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220320">}</span><br>
<span class="lineno"></span><span class="op" id="4220322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4220325">func</span>&nbsp;<span class="op" id="4220330">(</span><span class="ident" id="4220331">d</span>&nbsp;<span class="op" id="4220333">*</span><span class="ident" id="4220334">compressor</span><span class="op" id="4220344">)</span>&nbsp;<span class="builtinfunc" id="4220346">close</span><span class="op" id="4220351">(</span><span class="op" id="4220352">)</span>&nbsp;<span class="builtintype" id="4220354">error</span>&nbsp;<span class="op" id="4220360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220363">d</span><span class="op" id="4220364">.</span><span class="ident" id="4220365">sync</span>&nbsp;<span class="op" id="4220370">=</span>&nbsp;<span class="builtintype" id="4220372">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220378">d</span><span class="op" id="4220379">.</span><span class="ident" id="4220380">step</span><span class="op" id="4220384">(</span><span class="ident" id="4220385">d</span><span class="op" id="4220386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220389">if</span>&nbsp;<span class="ident" id="4220392">d</span><span class="op" id="4220393">.</span><span class="ident" id="4220394">err</span>&nbsp;<span class="op" id="4220398">!=</span>&nbsp;<span class="builtintype" id="4220401">nil</span>&nbsp;<span class="op" id="4220405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220409">return</span>&nbsp;<span class="ident" id="4220416">d</span><span class="op" id="4220417">.</span><span class="ident" id="4220418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220426">if</span>&nbsp;<span class="ident" id="4220429">d</span><span class="op" id="4220430">.</span><span class="ident" id="4220431">w</span><span class="op" id="4220432">.</span><span class="ident" id="4220433">writeStoredHeader</span><span class="op" id="4220450">(</span><span class="num" id="4220451">0</span><span class="op" id="4220452">,</span>&nbsp;<span class="builtintype" id="4220454">true</span><span class="op" id="4220458">)</span><span class="op" id="4220459">;</span>&nbsp;<span class="ident" id="4220461">d</span><span class="op" id="4220462">.</span><span class="ident" id="4220463">w</span><span class="op" id="4220464">.</span><span class="ident" id="4220465">err</span>&nbsp;<span class="op" id="4220469">!=</span>&nbsp;<span class="builtintype" id="4220472">nil</span>&nbsp;<span class="op" id="4220476">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220480">return</span>&nbsp;<span class="ident" id="4220487">d</span><span class="op" id="4220488">.</span><span class="ident" id="4220489">w</span><span class="op" id="4220490">.</span><span class="ident" id="4220491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220499">d</span><span class="op" id="4220500">.</span><span class="ident" id="4220501">w</span><span class="op" id="4220502">.</span><span class="ident" id="4220503">flush</span><span class="op" id="4220508">(</span><span class="op" id="4220509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220512">return</span>&nbsp;<span class="ident" id="4220519">d</span><span class="op" id="4220520">.</span><span class="ident" id="4220521">w</span><span class="op" id="4220522">.</span><span class="ident" id="4220523">err</span><br>
<span class="lineno"></span><span class="op" id="4220527">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4220530">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4220601">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4220676">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4220741">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4220811">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4220888">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4220910">//</span><br>
<span class="lineno"></span><span class="comment" id="4220913">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4220986">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4221035">func</span>&nbsp;<span class="ident" id="4221040">NewWriter</span><span class="op" id="4221049">(</span><span class="ident" id="4221050">w</span>&nbsp;<span class="ident" id="4221052">io</span><span class="op" id="4221054">.</span><span class="ident" id="4221055">Writer</span><span class="op" id="4221061">,</span>&nbsp;<span class="ident" id="4221063">level</span>&nbsp;<span class="builtintype" id="4221069">int</span><span class="op" id="4221072">)</span>&nbsp;<span class="op" id="4221074">(</span><span class="op" id="4221075">*</span><span class="ident" id="4221076">Writer</span><span class="op" id="4221082">,</span>&nbsp;<span class="builtintype" id="4221084">error</span><span class="op" id="4221089">)</span>&nbsp;<span class="op" id="4221091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221094">var</span>&nbsp;<span class="ident" id="4221098">dw</span>&nbsp;<span class="ident" id="4221101">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221109">if</span>&nbsp;<span class="ident" id="4221112">err</span>&nbsp;<span class="op" id="4221116">:=</span>&nbsp;<span class="ident" id="4221119">dw</span><span class="op" id="4221121">.</span><span class="ident" id="4221122">d</span><span class="op" id="4221123">.</span><span class="ident" id="4221124">init</span><span class="op" id="4221128">(</span><span class="ident" id="4221129">w</span><span class="op" id="4221130">,</span>&nbsp;<span class="ident" id="4221132">level</span><span class="op" id="4221137">)</span><span class="op" id="4221138">;</span>&nbsp;<span class="ident" id="4221140">err</span>&nbsp;<span class="op" id="4221144">!=</span>&nbsp;<span class="builtintype" id="4221147">nil</span>&nbsp;<span class="op" id="4221151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221155">return</span>&nbsp;<span class="builtintype" id="4221162">nil</span><span class="op" id="4221165">,</span>&nbsp;<span class="ident" id="4221167">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221172">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221175">return</span>&nbsp;<span class="op" id="4221182">&amp;</span><span class="ident" id="4221183">dw</span><span class="op" id="4221185">,</span>&nbsp;<span class="builtintype" id="4221187">nil</span><br>
<span class="lineno"></span><span class="op" id="4221191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4221194">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4221253">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4221318">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4221383">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4221443">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4221504">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4221524">func</span>&nbsp;<span class="ident" id="4221529">NewWriterDict</span><span class="op" id="4221542">(</span><span class="ident" id="4221543">w</span>&nbsp;<span class="ident" id="4221545">io</span><span class="op" id="4221547">.</span><span class="ident" id="4221548">Writer</span><span class="op" id="4221554">,</span>&nbsp;<span class="ident" id="4221556">level</span>&nbsp;<span class="builtintype" id="4221562">int</span><span class="op" id="4221565">,</span>&nbsp;<span class="ident" id="4221567">dict</span>&nbsp;<span class="op" id="4221572">[</span><span class="op" id="4221573">]</span><span class="builtintype" id="4221574">byte</span><span class="op" id="4221578">)</span>&nbsp;<span class="op" id="4221580">(</span><span class="op" id="4221581">*</span><span class="ident" id="4221582">Writer</span><span class="op" id="4221588">,</span>&nbsp;<span class="builtintype" id="4221590">error</span><span class="op" id="4221595">)</span>&nbsp;<span class="op" id="4221597">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221600">dw</span>&nbsp;<span class="op" id="4221603">:=</span>&nbsp;<span class="op" id="4221606">&amp;</span><span class="ident" id="4221607">dictWriter</span><span class="op" id="4221617">{</span><span class="ident" id="4221618">w</span><span class="op" id="4221619">,</span>&nbsp;<span class="builtintype" id="4221621">false</span><span class="op" id="4221626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221629">zw</span><span class="op" id="4221631">,</span>&nbsp;<span class="ident" id="4221633">err</span>&nbsp;<span class="op" id="4221637">:=</span>&nbsp;<span class="ident" id="4221640">NewWriter</span><span class="op" id="4221649">(</span><span class="ident" id="4221650">dw</span><span class="op" id="4221652">,</span>&nbsp;<span class="ident" id="4221654">level</span><span class="op" id="4221659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221662">if</span>&nbsp;<span class="ident" id="4221665">err</span>&nbsp;<span class="op" id="4221669">!=</span>&nbsp;<span class="builtintype" id="4221672">nil</span>&nbsp;<span class="op" id="4221676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221680">return</span>&nbsp;<span class="builtintype" id="4221687">nil</span><span class="op" id="4221690">,</span>&nbsp;<span class="ident" id="4221692">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4221697">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221700">zw</span><span class="op" id="4221702">.</span><span class="ident" id="4221703">Write</span><span class="op" id="4221708">(</span><span class="ident" id="4221709">dict</span><span class="op" id="4221713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221716">zw</span><span class="op" id="4221718">.</span><span class="ident" id="4221719">Flush</span><span class="op" id="4221724">(</span><span class="op" id="4221725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221728">dw</span><span class="op" id="4221730">.</span><span class="ident" id="4221731">enabled</span>&nbsp;<span class="op" id="4221739">=</span>&nbsp;<span class="builtintype" id="4221741">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221747">zw</span><span class="op" id="4221749">.</span><span class="ident" id="4221750">dict</span>&nbsp;<span class="op" id="4221755">=</span>&nbsp;<span class="builtinfunc" id="4221757">append</span><span class="op" id="4221763">(</span><span class="ident" id="4221764">zw</span><span class="op" id="4221766">.</span><span class="ident" id="4221767">dict</span><span class="op" id="4221771">,</span>&nbsp;<span class="ident" id="4221773">dict</span><span class="op" id="4221777">...</span><span class="op" id="4221780">)</span>&nbsp;<span class="comment" id="4221782">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221825">return</span>&nbsp;<span class="ident" id="4221832">zw</span><span class="op" id="4221834">,</span>&nbsp;<span class="ident" id="4221836">err</span><br>
<span class="lineno">510</span><span class="op" id="4221840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4221843">type</span>&nbsp;<span class="ident" id="4221848">dictWriter</span>&nbsp;<span class="keyword" id="4221859">struct</span>&nbsp;<span class="op" id="4221866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221869">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221877">io</span><span class="op" id="4221879">.</span><span class="ident" id="4221880">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4221888">enabled</span>&nbsp;<span class="builtintype" id="4221896">bool</span><br>
<span class="lineno">515</span><span class="op" id="4221901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4221904">func</span>&nbsp;<span class="op" id="4221909">(</span><span class="ident" id="4221910">w</span>&nbsp;<span class="op" id="4221912">*</span><span class="ident" id="4221913">dictWriter</span><span class="op" id="4221923">)</span>&nbsp;<span class="ident" id="4221925">Write</span><span class="op" id="4221930">(</span><span class="ident" id="4221931">b</span>&nbsp;<span class="op" id="4221933">[</span><span class="op" id="4221934">]</span><span class="builtintype" id="4221935">byte</span><span class="op" id="4221939">)</span>&nbsp;<span class="op" id="4221941">(</span><span class="ident" id="4221942">n</span>&nbsp;<span class="builtintype" id="4221944">int</span><span class="op" id="4221947">,</span>&nbsp;<span class="ident" id="4221949">err</span>&nbsp;<span class="builtintype" id="4221953">error</span><span class="op" id="4221958">)</span>&nbsp;<span class="op" id="4221960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221963">if</span>&nbsp;<span class="ident" id="4221966">w</span><span class="op" id="4221967">.</span><span class="ident" id="4221968">enabled</span>&nbsp;<span class="op" id="4221976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4221980">return</span>&nbsp;<span class="ident" id="4221987">w</span><span class="op" id="4221988">.</span><span class="ident" id="4221989">w</span><span class="op" id="4221990">.</span><span class="ident" id="4221991">Write</span><span class="op" id="4221996">(</span><span class="ident" id="4221997">b</span><span class="op" id="4221998">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222004">return</span>&nbsp;<span class="builtinfunc" id="4222011">len</span><span class="op" id="4222014">(</span><span class="ident" id="4222015">b</span><span class="op" id="4222016">)</span><span class="op" id="4222017">,</span>&nbsp;<span class="builtintype" id="4222019">nil</span><br>
<span class="lineno"></span><span class="op" id="4222023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4222026">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4222089">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4222151">type</span>&nbsp;<span class="ident" id="4222156">Writer</span>&nbsp;<span class="keyword" id="4222163">struct</span>&nbsp;<span class="op" id="4222170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222173">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222178">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222190">dict</span>&nbsp;<span class="op" id="4222195">[</span><span class="op" id="4222196">]</span><span class="builtintype" id="4222197">byte</span><br>
<span class="lineno"></span><span class="op" id="4222202">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4222205">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4222264">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4222317">func</span>&nbsp;<span class="op" id="4222322">(</span><span class="ident" id="4222323">w</span>&nbsp;<span class="op" id="4222325">*</span><span class="ident" id="4222326">Writer</span><span class="op" id="4222332">)</span>&nbsp;<span class="ident" id="4222334">Write</span><span class="op" id="4222339">(</span><span class="ident" id="4222340">data</span>&nbsp;<span class="op" id="4222345">[</span><span class="op" id="4222346">]</span><span class="builtintype" id="4222347">byte</span><span class="op" id="4222351">)</span>&nbsp;<span class="op" id="4222353">(</span><span class="ident" id="4222354">n</span>&nbsp;<span class="builtintype" id="4222356">int</span><span class="op" id="4222359">,</span>&nbsp;<span class="ident" id="4222361">err</span>&nbsp;<span class="builtintype" id="4222365">error</span><span class="op" id="4222370">)</span>&nbsp;<span class="op" id="4222372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222375">return</span>&nbsp;<span class="ident" id="4222382">w</span><span class="op" id="4222383">.</span><span class="ident" id="4222384">d</span><span class="op" id="4222385">.</span><span class="ident" id="4222386">write</span><span class="op" id="4222391">(</span><span class="ident" id="4222392">data</span><span class="op" id="4222396">)</span><br>
<span class="lineno">535</span><span class="op" id="4222398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4222401">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4222472">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4222543">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4222603">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4222661">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4222733">//</span><br>
<span class="lineno"></span><span class="comment" id="4222736">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4222816">func</span>&nbsp;<span class="op" id="4222821">(</span><span class="ident" id="4222822">w</span>&nbsp;<span class="op" id="4222824">*</span><span class="ident" id="4222825">Writer</span><span class="op" id="4222831">)</span>&nbsp;<span class="ident" id="4222833">Flush</span><span class="op" id="4222838">(</span><span class="op" id="4222839">)</span>&nbsp;<span class="builtintype" id="4222841">error</span>&nbsp;<span class="op" id="4222847">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4222850">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4222879">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222931">return</span>&nbsp;<span class="ident" id="4222938">w</span><span class="op" id="4222939">.</span><span class="ident" id="4222940">d</span><span class="op" id="4222941">.</span><span class="ident" id="4222942">syncFlush</span><span class="op" id="4222951">(</span><span class="op" id="4222952">)</span><br>
<span class="lineno"></span><span class="op" id="4222954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4222957">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4222997">func</span>&nbsp;<span class="op" id="4223002">(</span><span class="ident" id="4223003">w</span>&nbsp;<span class="op" id="4223005">*</span><span class="ident" id="4223006">Writer</span><span class="op" id="4223012">)</span>&nbsp;<span class="ident" id="4223014">Close</span><span class="op" id="4223019">(</span><span class="op" id="4223020">)</span>&nbsp;<span class="builtintype" id="4223022">error</span>&nbsp;<span class="op" id="4223028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223031">return</span>&nbsp;<span class="ident" id="4223038">w</span><span class="op" id="4223039">.</span><span class="ident" id="4223040">d</span><span class="op" id="4223041">.</span><span class="builtinfunc" id="4223042">close</span><span class="op" id="4223047">(</span><span class="op" id="4223048">)</span><br>
<span class="lineno"></span><span class="op" id="4223050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4223053">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4223117">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4223177">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4223210">func</span>&nbsp;<span class="op" id="4223215">(</span><span class="ident" id="4223216">w</span>&nbsp;<span class="op" id="4223218">*</span><span class="ident" id="4223219">Writer</span><span class="op" id="4223225">)</span>&nbsp;<span class="ident" id="4223227">Reset</span><span class="op" id="4223232">(</span><span class="ident" id="4223233">dst</span>&nbsp;<span class="ident" id="4223237">io</span><span class="op" id="4223239">.</span><span class="ident" id="4223240">Writer</span><span class="op" id="4223246">)</span>&nbsp;<span class="op" id="4223248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4223251">if</span>&nbsp;<span class="ident" id="4223254">dw</span><span class="op" id="4223256">,</span>&nbsp;<span class="ident" id="4223258">ok</span>&nbsp;<span class="op" id="4223261">:=</span>&nbsp;<span class="ident" id="4223264">w</span><span class="op" id="4223265">.</span><span class="ident" id="4223266">d</span><span class="op" id="4223267">.</span><span class="ident" id="4223268">w</span><span class="op" id="4223269">.</span><span class="ident" id="4223270">w</span><span class="op" id="4223271">.</span><span class="op" id="4223272">(</span><span class="op" id="4223273">*</span><span class="ident" id="4223274">dictWriter</span><span class="op" id="4223284">)</span><span class="op" id="4223285">;</span>&nbsp;<span class="ident" id="4223287">ok</span>&nbsp;<span class="op" id="4223290">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223294">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223332">dw</span><span class="op" id="4223334">.</span><span class="ident" id="4223335">w</span>&nbsp;<span class="op" id="4223337">=</span>&nbsp;<span class="ident" id="4223339">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223345">w</span><span class="op" id="4223346">.</span><span class="ident" id="4223347">d</span><span class="op" id="4223348">.</span><span class="ident" id="4223349">reset</span><span class="op" id="4223354">(</span><span class="ident" id="4223355">dw</span><span class="op" id="4223357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223361">dw</span><span class="op" id="4223363">.</span><span class="ident" id="4223364">enabled</span>&nbsp;<span class="op" id="4223372">=</span>&nbsp;<span class="builtintype" id="4223374">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223382">w</span><span class="op" id="4223383">.</span><span class="ident" id="4223384">Write</span><span class="op" id="4223389">(</span><span class="ident" id="4223390">w</span><span class="op" id="4223391">.</span><span class="ident" id="4223392">dict</span><span class="op" id="4223396">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223400">w</span><span class="op" id="4223401">.</span><span class="ident" id="4223402">Flush</span><span class="op" id="4223407">(</span><span class="op" id="4223408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223412">dw</span><span class="op" id="4223414">.</span><span class="ident" id="4223415">enabled</span>&nbsp;<span class="op" id="4223423">=</span>&nbsp;<span class="builtintype" id="4223425">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223431">}</span>&nbsp;<span class="keyword" id="4223433">else</span>&nbsp;<span class="op" id="4223438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223442">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223476">w</span><span class="op" id="4223477">.</span><span class="ident" id="4223478">d</span><span class="op" id="4223479">.</span><span class="ident" id="4223480">reset</span><span class="op" id="4223485">(</span><span class="ident" id="4223486">dst</span><span class="op" id="4223489">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4223492">}</span><br>
<span class="lineno"></span><span class="op" id="4223494">}</span>
</div>
</body>
</html>
