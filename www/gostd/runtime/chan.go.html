<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1451165">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1451220">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1451274">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1451325">package</span>&nbsp;<span class="ident" id="1451333">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451342">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1451400">import</span>&nbsp;<span class="string" id="1451407">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1451417">const</span>&nbsp;<span class="op" id="1451423">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451426">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1451436">=</span>&nbsp;<span class="num" id="1451438">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451441">hchanSize</span>&nbsp;<span class="op" id="1451451">=</span>&nbsp;<span class="ident" id="1451453">unsafe</span><span class="op" id="1451459">.</span><span class="ident" id="1451460">Sizeof</span><span class="op" id="1451466">(</span><span class="ident" id="1451467">hchan</span><span class="op" id="1451472">{</span><span class="op" id="1451473">}</span><span class="op" id="1451474">)</span>&nbsp;<span class="op" id="1451476">+</span>&nbsp;<span class="builtintype" id="1451478">uintptr</span><span class="op" id="1451485">(</span><span class="op" id="1451486">-</span><span class="builtintype" id="1451487">int</span><span class="op" id="1451490">(</span><span class="ident" id="1451491">unsafe</span><span class="op" id="1451497">.</span><span class="ident" id="1451498">Sizeof</span><span class="op" id="1451504">(</span><span class="ident" id="1451505">hchan</span><span class="op" id="1451510">{</span><span class="op" id="1451511">}</span><span class="op" id="1451512">)</span><span class="op" id="1451513">)</span><span class="op" id="1451514">&amp;</span><span class="op" id="1451515">(</span><span class="ident" id="1451516">maxAlign</span><span class="op" id="1451524">-</span><span class="num" id="1451525">1</span><span class="op" id="1451526">)</span><span class="op" id="1451527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451530">debugChan</span>&nbsp;<span class="op" id="1451540">=</span>&nbsp;<span class="builtintype" id="1451542">false</span><br>
<span class="lineno">15</span><span class="op" id="1451548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451551">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1451613">func</span>&nbsp;<span class="ident" id="1451618">makechan</span><span class="op" id="1451626">(</span><span class="ident" id="1451627">t</span>&nbsp;<span class="op" id="1451629">*</span><span class="ident" id="1451630">chantype</span><span class="op" id="1451638">,</span>&nbsp;<span class="ident" id="1451640">size</span>&nbsp;<span class="ident" id="1451645">int64</span><span class="op" id="1451650">)</span>&nbsp;<span class="op" id="1451652">*</span><span class="ident" id="1451653">hchan</span>&nbsp;<span class="op" id="1451659">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451662">elem</span>&nbsp;<span class="op" id="1451667">:=</span>&nbsp;<span class="ident" id="1451670">t</span><span class="op" id="1451671">.</span><span class="ident" id="1451672">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1451679">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451717">if</span>&nbsp;<span class="ident" id="1451720">elem</span><span class="op" id="1451724">.</span><span class="ident" id="1451725">size</span>&nbsp;<span class="op" id="1451730">&gt;=</span>&nbsp;<span class="num" id="1451733">1</span><span class="op" id="1451734">&lt;&lt;</span><span class="num" id="1451736">16</span>&nbsp;<span class="op" id="1451739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451743">gothrow</span><span class="op" id="1451750">(</span><span class="string" id="1451751">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1451791">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1451794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451797">if</span>&nbsp;<span class="ident" id="1451800">hchanSize</span><span class="op" id="1451809">%</span><span class="ident" id="1451810">maxAlign</span>&nbsp;<span class="op" id="1451819">!=</span>&nbsp;<span class="num" id="1451822">0</span>&nbsp;<span class="op" id="1451824">||</span>&nbsp;<span class="ident" id="1451827">elem</span><span class="op" id="1451831">.</span><span class="ident" id="1451832">align</span>&nbsp;<span class="op" id="1451838">&gt;</span>&nbsp;<span class="ident" id="1451840">maxAlign</span>&nbsp;<span class="op" id="1451849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1451853">gothrow</span><span class="op" id="1451860">(</span><span class="string" id="1451861">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1451886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1451889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1451892">if</span>&nbsp;<span class="ident" id="1451895">size</span>&nbsp;<span class="op" id="1451900">&lt;</span>&nbsp;<span class="num" id="1451902">0</span>&nbsp;<span class="op" id="1451904">||</span>&nbsp;<span class="ident" id="1451907">int64</span><span class="op" id="1451912">(</span><span class="builtintype" id="1451913">uintptr</span><span class="op" id="1451920">(</span><span class="ident" id="1451921">size</span><span class="op" id="1451925">)</span><span class="op" id="1451926">)</span>&nbsp;<span class="op" id="1451928">!=</span>&nbsp;<span class="ident" id="1451931">size</span>&nbsp;<span class="op" id="1451936">||</span>&nbsp;<span class="op" id="1451939">(</span><span class="ident" id="1451940">elem</span><span class="op" id="1451944">.</span><span class="ident" id="1451945">size</span>&nbsp;<span class="op" id="1451950">&gt;</span>&nbsp;<span class="num" id="1451952">0</span>&nbsp;<span class="op" id="1451954">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1451957">uintptr</span><span class="op" id="1451964">(</span><span class="ident" id="1451965">size</span><span class="op" id="1451969">)</span>&nbsp;<span class="op" id="1451971">&gt;</span>&nbsp;<span class="op" id="1451973">(</span><span class="ident" id="1451974">maxmem</span><span class="op" id="1451980">-</span><span class="ident" id="1451981">hchanSize</span><span class="op" id="1451990">)</span><span class="op" id="1451991">/</span><span class="builtintype" id="1451992">uintptr</span><span class="op" id="1451999">(</span><span class="ident" id="1452000">elem</span><span class="op" id="1452004">.</span><span class="ident" id="1452005">size</span><span class="op" id="1452009">)</span><span class="op" id="1452010">)</span>&nbsp;<span class="op" id="1452012">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1452016">panic</span><span class="op" id="1452021">(</span><span class="string" id="1452022">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1452051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452058">var</span>&nbsp;<span class="ident" id="1452062">c</span>&nbsp;<span class="op" id="1452064">*</span><span class="ident" id="1452065">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452072">if</span>&nbsp;<span class="ident" id="1452075">elem</span><span class="op" id="1452079">.</span><span class="ident" id="1452080">kind</span><span class="op" id="1452084">&amp;</span><span class="ident" id="1452085">kindNoPointers</span>&nbsp;<span class="op" id="1452100">!=</span>&nbsp;<span class="num" id="1452103">0</span>&nbsp;<span class="op" id="1452105">||</span>&nbsp;<span class="ident" id="1452108">size</span>&nbsp;<span class="op" id="1452113">==</span>&nbsp;<span class="num" id="1452116">0</span>&nbsp;<span class="op" id="1452118">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452122">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452156">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452226">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452292">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1452373">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452448">c</span>&nbsp;<span class="op" id="1452450">=</span>&nbsp;<span class="op" id="1452452">(</span><span class="op" id="1452453">*</span><span class="ident" id="1452454">hchan</span><span class="op" id="1452459">)</span><span class="op" id="1452460">(</span><span class="ident" id="1452461">mallocgc</span><span class="op" id="1452469">(</span><span class="ident" id="1452470">hchanSize</span><span class="op" id="1452479">+</span><span class="builtintype" id="1452480">uintptr</span><span class="op" id="1452487">(</span><span class="ident" id="1452488">size</span><span class="op" id="1452492">)</span><span class="op" id="1452493">*</span><span class="builtintype" id="1452494">uintptr</span><span class="op" id="1452501">(</span><span class="ident" id="1452502">elem</span><span class="op" id="1452506">.</span><span class="ident" id="1452507">size</span><span class="op" id="1452511">)</span><span class="op" id="1452512">,</span>&nbsp;<span class="builtintype" id="1452514">nil</span><span class="op" id="1452517">,</span>&nbsp;<span class="ident" id="1452519">flagNoScan</span><span class="op" id="1452529">)</span><span class="op" id="1452530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452534">if</span>&nbsp;<span class="ident" id="1452537">size</span>&nbsp;<span class="op" id="1452542">&gt;</span>&nbsp;<span class="num" id="1452544">0</span>&nbsp;<span class="op" id="1452546">&amp;&amp;</span>&nbsp;<span class="ident" id="1452549">elem</span><span class="op" id="1452553">.</span><span class="ident" id="1452554">size</span>&nbsp;<span class="op" id="1452559">!=</span>&nbsp;<span class="num" id="1452562">0</span>&nbsp;<span class="op" id="1452564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452569">c</span><span class="op" id="1452570">.</span><span class="ident" id="1452571">buf</span>&nbsp;<span class="op" id="1452575">=</span>&nbsp;<span class="op" id="1452577">(</span><span class="op" id="1452578">*</span><span class="builtintype" id="1452579">uint8</span><span class="op" id="1452584">)</span><span class="op" id="1452585">(</span><span class="ident" id="1452586">add</span><span class="op" id="1452589">(</span><span class="ident" id="1452590">unsafe</span><span class="op" id="1452596">.</span><span class="ident" id="1452597">Pointer</span><span class="op" id="1452604">(</span><span class="ident" id="1452605">c</span><span class="op" id="1452606">)</span><span class="op" id="1452607">,</span>&nbsp;<span class="ident" id="1452609">hchanSize</span><span class="op" id="1452618">)</span><span class="op" id="1452619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452623">}</span>&nbsp;<span class="keyword" id="1452625">else</span>&nbsp;<span class="op" id="1452630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452635">c</span><span class="op" id="1452636">.</span><span class="ident" id="1452637">buf</span>&nbsp;<span class="op" id="1452641">=</span>&nbsp;<span class="op" id="1452643">(</span><span class="op" id="1452644">*</span><span class="builtintype" id="1452645">uint8</span><span class="op" id="1452650">)</span><span class="op" id="1452651">(</span><span class="ident" id="1452652">unsafe</span><span class="op" id="1452658">.</span><span class="ident" id="1452659">Pointer</span><span class="op" id="1452666">(</span><span class="ident" id="1452667">c</span><span class="op" id="1452668">)</span><span class="op" id="1452669">)</span>&nbsp;<span class="comment" id="1452671">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452732">}</span>&nbsp;<span class="keyword" id="1452734">else</span>&nbsp;<span class="op" id="1452739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452743">c</span>&nbsp;<span class="op" id="1452745">=</span>&nbsp;<span class="builtinfunc" id="1452747">new</span><span class="op" id="1452750">(</span><span class="ident" id="1452751">hchan</span><span class="op" id="1452756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452760">c</span><span class="op" id="1452761">.</span><span class="ident" id="1452762">buf</span>&nbsp;<span class="op" id="1452766">=</span>&nbsp;<span class="op" id="1452768">(</span><span class="op" id="1452769">*</span><span class="builtintype" id="1452770">uint8</span><span class="op" id="1452775">)</span><span class="op" id="1452776">(</span><span class="ident" id="1452777">newarray</span><span class="op" id="1452785">(</span><span class="ident" id="1452786">elem</span><span class="op" id="1452790">,</span>&nbsp;<span class="builtintype" id="1452792">uintptr</span><span class="op" id="1452799">(</span><span class="ident" id="1452800">size</span><span class="op" id="1452804">)</span><span class="op" id="1452805">)</span><span class="op" id="1452806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1452809">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452812">c</span><span class="op" id="1452813">.</span><span class="ident" id="1452814">elemsize</span>&nbsp;<span class="op" id="1452823">=</span>&nbsp;<span class="builtintype" id="1452825">uint16</span><span class="op" id="1452831">(</span><span class="ident" id="1452832">elem</span><span class="op" id="1452836">.</span><span class="ident" id="1452837">size</span><span class="op" id="1452841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452844">c</span><span class="op" id="1452845">.</span><span class="ident" id="1452846">elemtype</span>&nbsp;<span class="op" id="1452855">=</span>&nbsp;<span class="ident" id="1452857">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1452863">c</span><span class="op" id="1452864">.</span><span class="ident" id="1452865">dataqsiz</span>&nbsp;<span class="op" id="1452874">=</span>&nbsp;<span class="builtintype" id="1452876">uint</span><span class="op" id="1452880">(</span><span class="ident" id="1452881">size</span><span class="op" id="1452885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1452889">if</span>&nbsp;<span class="ident" id="1452892">debugChan</span>&nbsp;<span class="op" id="1452902">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1452906">print</span><span class="op" id="1452911">(</span><span class="string" id="1452912">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1452929">,</span>&nbsp;<span class="ident" id="1452931">c</span><span class="op" id="1452932">,</span>&nbsp;<span class="string" id="1452934">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1452947">,</span>&nbsp;<span class="ident" id="1452949">elem</span><span class="op" id="1452953">.</span><span class="ident" id="1452954">size</span><span class="op" id="1452958">,</span>&nbsp;<span class="string" id="1452960">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1452972">,</span>&nbsp;<span class="ident" id="1452974">elem</span><span class="op" id="1452978">.</span><span class="ident" id="1452979">alg</span><span class="op" id="1452982">,</span>&nbsp;<span class="string" id="1452984">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1452997">,</span>&nbsp;<span class="ident" id="1452999">size</span><span class="op" id="1453003">,</span>&nbsp;<span class="string" id="1453005">&#34;\n&#34;</span><span class="op" id="1453009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453015">return</span>&nbsp;<span class="ident" id="1453022">c</span><br>
<span class="lineno"></span><span class="op" id="1453024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1453027">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1453087">func</span>&nbsp;<span class="ident" id="1453092">chanbuf</span><span class="op" id="1453099">(</span><span class="ident" id="1453100">c</span>&nbsp;<span class="op" id="1453102">*</span><span class="ident" id="1453103">hchan</span><span class="op" id="1453108">,</span>&nbsp;<span class="ident" id="1453110">i</span>&nbsp;<span class="builtintype" id="1453112">uint</span><span class="op" id="1453116">)</span>&nbsp;<span class="ident" id="1453118">unsafe</span><span class="op" id="1453124">.</span><span class="ident" id="1453125">Pointer</span>&nbsp;<span class="op" id="1453133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453136">return</span>&nbsp;<span class="ident" id="1453143">add</span><span class="op" id="1453146">(</span><span class="ident" id="1453147">unsafe</span><span class="op" id="1453153">.</span><span class="ident" id="1453154">Pointer</span><span class="op" id="1453161">(</span><span class="ident" id="1453162">c</span><span class="op" id="1453163">.</span><span class="ident" id="1453164">buf</span><span class="op" id="1453167">)</span><span class="op" id="1453168">,</span>&nbsp;<span class="builtintype" id="1453170">uintptr</span><span class="op" id="1453177">(</span><span class="ident" id="1453178">i</span><span class="op" id="1453179">)</span><span class="op" id="1453180">*</span><span class="builtintype" id="1453181">uintptr</span><span class="op" id="1453188">(</span><span class="ident" id="1453189">c</span><span class="op" id="1453190">.</span><span class="ident" id="1453191">elemsize</span><span class="op" id="1453199">)</span><span class="op" id="1453200">)</span><br>
<span class="lineno"></span><span class="op" id="1453202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1453205">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1453250">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1453263">func</span>&nbsp;<span class="ident" id="1453268">chansend1</span><span class="op" id="1453277">(</span><span class="ident" id="1453278">t</span>&nbsp;<span class="op" id="1453280">*</span><span class="ident" id="1453281">chantype</span><span class="op" id="1453289">,</span>&nbsp;<span class="ident" id="1453291">c</span>&nbsp;<span class="op" id="1453293">*</span><span class="ident" id="1453294">hchan</span><span class="op" id="1453299">,</span>&nbsp;<span class="ident" id="1453301">elem</span>&nbsp;<span class="ident" id="1453306">unsafe</span><span class="op" id="1453312">.</span><span class="ident" id="1453313">Pointer</span><span class="op" id="1453320">)</span>&nbsp;<span class="op" id="1453322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453325">chansend</span><span class="op" id="1453333">(</span><span class="ident" id="1453334">t</span><span class="op" id="1453335">,</span>&nbsp;<span class="ident" id="1453337">c</span><span class="op" id="1453338">,</span>&nbsp;<span class="ident" id="1453340">elem</span><span class="op" id="1453344">,</span>&nbsp;<span class="builtintype" id="1453346">true</span><span class="op" id="1453350">,</span>&nbsp;<span class="ident" id="1453352">getcallerpc</span><span class="op" id="1453363">(</span><span class="ident" id="1453364">unsafe</span><span class="op" id="1453370">.</span><span class="ident" id="1453371">Pointer</span><span class="op" id="1453378">(</span><span class="op" id="1453379">&amp;</span><span class="ident" id="1453380">t</span><span class="op" id="1453381">)</span><span class="op" id="1453382">)</span><span class="op" id="1453383">)</span><br>
<span class="lineno"></span><span class="op" id="1453385">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1453388">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1453722">func</span>&nbsp;<span class="ident" id="1453727">chansend</span><span class="op" id="1453735">(</span><span class="ident" id="1453736">t</span>&nbsp;<span class="op" id="1453738">*</span><span class="ident" id="1453739">chantype</span><span class="op" id="1453747">,</span>&nbsp;<span class="ident" id="1453749">c</span>&nbsp;<span class="op" id="1453751">*</span><span class="ident" id="1453752">hchan</span><span class="op" id="1453757">,</span>&nbsp;<span class="ident" id="1453759">ep</span>&nbsp;<span class="ident" id="1453762">unsafe</span><span class="op" id="1453768">.</span><span class="ident" id="1453769">Pointer</span><span class="op" id="1453776">,</span>&nbsp;<span class="ident" id="1453778">block</span>&nbsp;<span class="builtintype" id="1453784">bool</span><span class="op" id="1453788">,</span>&nbsp;<span class="ident" id="1453790">callerpc</span>&nbsp;<span class="builtintype" id="1453799">uintptr</span><span class="op" id="1453806">)</span>&nbsp;<span class="builtintype" id="1453808">bool</span>&nbsp;<span class="op" id="1453813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453816">if</span>&nbsp;<span class="ident" id="1453819">raceenabled</span>&nbsp;<span class="op" id="1453831">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453835">raceReadObjectPC</span><span class="op" id="1453851">(</span><span class="ident" id="1453852">t</span><span class="op" id="1453853">.</span><span class="ident" id="1453854">elem</span><span class="op" id="1453858">,</span>&nbsp;<span class="ident" id="1453860">ep</span><span class="op" id="1453862">,</span>&nbsp;<span class="ident" id="1453864">callerpc</span><span class="op" id="1453872">,</span>&nbsp;<span class="ident" id="1453874">funcPC</span><span class="op" id="1453880">(</span><span class="ident" id="1453881">chansend</span><span class="op" id="1453889">)</span><span class="op" id="1453890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453897">if</span>&nbsp;<span class="ident" id="1453900">c</span>&nbsp;<span class="op" id="1453902">==</span>&nbsp;<span class="builtintype" id="1453905">nil</span>&nbsp;<span class="op" id="1453909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453913">if</span>&nbsp;<span class="op" id="1453916">!</span><span class="ident" id="1453917">block</span>&nbsp;<span class="op" id="1453923">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1453928">return</span>&nbsp;<span class="builtintype" id="1453935">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1453943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453947">gopark</span><span class="op" id="1453953">(</span><span class="builtintype" id="1453954">nil</span><span class="op" id="1453957">,</span>&nbsp;<span class="builtintype" id="1453959">nil</span><span class="op" id="1453962">,</span>&nbsp;<span class="string" id="1453964">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1453986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1453990">gothrow</span><span class="op" id="1453997">(</span><span class="string" id="1453998">&#34;unreachable&#34;</span><span class="op" id="1454011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454014">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454018">if</span>&nbsp;<span class="ident" id="1454021">debugChan</span>&nbsp;<span class="op" id="1454031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1454035">print</span><span class="op" id="1454040">(</span><span class="string" id="1454041">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1454058">,</span>&nbsp;<span class="ident" id="1454060">c</span><span class="op" id="1454061">,</span>&nbsp;<span class="string" id="1454063">&#34;\n&#34;</span><span class="op" id="1454067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1454074">if</span>&nbsp;<span class="ident" id="1454077">raceenabled</span>&nbsp;<span class="op" id="1454089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1454093">racereadpc</span><span class="op" id="1454103">(</span><span class="ident" id="1454104">unsafe</span><span class="op" id="1454110">.</span><span class="ident" id="1454111">Pointer</span><span class="op" id="1454118">(</span><span class="ident" id="1454119">c</span><span class="op" id="1454120">)</span><span class="op" id="1454121">,</span>&nbsp;<span class="ident" id="1454123">callerpc</span><span class="op" id="1454131">,</span>&nbsp;<span class="ident" id="1454133">funcPC</span><span class="op" id="1454139">(</span><span class="ident" id="1454140">chansend</span><span class="op" id="1454148">)</span><span class="op" id="1454149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1454152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454156">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454239">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454243">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454326">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454408">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454496">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454571">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454660">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454741">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454828">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454873">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454877">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1454963">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1455047">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455103">if</span>&nbsp;<span class="op" id="1455106">!</span><span class="ident" id="1455107">block</span>&nbsp;<span class="op" id="1455113">&amp;&amp;</span>&nbsp;<span class="ident" id="1455116">c</span><span class="op" id="1455117">.</span><span class="ident" id="1455118">closed</span>&nbsp;<span class="op" id="1455125">==</span>&nbsp;<span class="num" id="1455128">0</span>&nbsp;<span class="op" id="1455130">&amp;&amp;</span>&nbsp;<span class="op" id="1455133">(</span><span class="op" id="1455134">(</span><span class="ident" id="1455135">c</span><span class="op" id="1455136">.</span><span class="ident" id="1455137">dataqsiz</span>&nbsp;<span class="op" id="1455146">==</span>&nbsp;<span class="num" id="1455149">0</span>&nbsp;<span class="op" id="1455151">&amp;&amp;</span>&nbsp;<span class="ident" id="1455154">c</span><span class="op" id="1455155">.</span><span class="ident" id="1455156">recvq</span><span class="op" id="1455161">.</span><span class="ident" id="1455162">first</span>&nbsp;<span class="op" id="1455168">==</span>&nbsp;<span class="builtintype" id="1455171">nil</span><span class="op" id="1455174">)</span>&nbsp;<span class="op" id="1455176">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455181">(</span><span class="ident" id="1455182">c</span><span class="op" id="1455183">.</span><span class="ident" id="1455184">dataqsiz</span>&nbsp;<span class="op" id="1455193">&gt;</span>&nbsp;<span class="num" id="1455195">0</span>&nbsp;<span class="op" id="1455197">&amp;&amp;</span>&nbsp;<span class="ident" id="1455200">c</span><span class="op" id="1455201">.</span><span class="ident" id="1455202">qcount</span>&nbsp;<span class="op" id="1455209">==</span>&nbsp;<span class="ident" id="1455212">c</span><span class="op" id="1455213">.</span><span class="ident" id="1455214">dataqsiz</span><span class="op" id="1455222">)</span><span class="op" id="1455223">)</span>&nbsp;<span class="op" id="1455225">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455229">return</span>&nbsp;<span class="builtintype" id="1455236">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455247">var</span>&nbsp;<span class="ident" id="1455251">t0</span>&nbsp;<span class="ident" id="1455254">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455261">if</span>&nbsp;<span class="ident" id="1455264">blockprofilerate</span>&nbsp;<span class="op" id="1455281">&gt;</span>&nbsp;<span class="num" id="1455283">0</span>&nbsp;<span class="op" id="1455285">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455289">t0</span>&nbsp;<span class="op" id="1455292">=</span>&nbsp;<span class="ident" id="1455294">cputicks</span><span class="op" id="1455302">(</span><span class="op" id="1455303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455310">lock</span><span class="op" id="1455314">(</span><span class="op" id="1455315">&amp;</span><span class="ident" id="1455316">c</span><span class="op" id="1455317">.</span><span class="ident" id="1455318">lock</span><span class="op" id="1455322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455325">if</span>&nbsp;<span class="ident" id="1455328">c</span><span class="op" id="1455329">.</span><span class="ident" id="1455330">closed</span>&nbsp;<span class="op" id="1455337">!=</span>&nbsp;<span class="num" id="1455340">0</span>&nbsp;<span class="op" id="1455342">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455346">unlock</span><span class="op" id="1455352">(</span><span class="op" id="1455353">&amp;</span><span class="ident" id="1455354">c</span><span class="op" id="1455355">.</span><span class="ident" id="1455356">lock</span><span class="op" id="1455360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1455364">panic</span><span class="op" id="1455369">(</span><span class="string" id="1455370">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1455394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455401">if</span>&nbsp;<span class="ident" id="1455404">c</span><span class="op" id="1455405">.</span><span class="ident" id="1455406">dataqsiz</span>&nbsp;<span class="op" id="1455415">==</span>&nbsp;<span class="num" id="1455418">0</span>&nbsp;<span class="op" id="1455420">{</span>&nbsp;<span class="comment" id="1455422">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455447">sg</span>&nbsp;<span class="op" id="1455450">:=</span>&nbsp;<span class="ident" id="1455453">c</span><span class="op" id="1455454">.</span><span class="ident" id="1455455">recvq</span><span class="op" id="1455460">.</span><span class="ident" id="1455461">dequeue</span><span class="op" id="1455468">(</span><span class="op" id="1455469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455473">if</span>&nbsp;<span class="ident" id="1455476">sg</span>&nbsp;<span class="op" id="1455479">!=</span>&nbsp;<span class="builtintype" id="1455482">nil</span>&nbsp;<span class="op" id="1455486">{</span>&nbsp;<span class="comment" id="1455488">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455519">if</span>&nbsp;<span class="ident" id="1455522">raceenabled</span>&nbsp;<span class="op" id="1455534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455540">racesync</span><span class="op" id="1455548">(</span><span class="ident" id="1455549">c</span><span class="op" id="1455550">,</span>&nbsp;<span class="ident" id="1455552">sg</span><span class="op" id="1455554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455559">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455564">unlock</span><span class="op" id="1455570">(</span><span class="op" id="1455571">&amp;</span><span class="ident" id="1455572">c</span><span class="op" id="1455573">.</span><span class="ident" id="1455574">lock</span><span class="op" id="1455578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455584">recvg</span>&nbsp;<span class="op" id="1455590">:=</span>&nbsp;<span class="ident" id="1455593">sg</span><span class="op" id="1455595">.</span><span class="ident" id="1455596">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455601">if</span>&nbsp;<span class="ident" id="1455604">sg</span><span class="op" id="1455606">.</span><span class="ident" id="1455607">elem</span>&nbsp;<span class="op" id="1455612">!=</span>&nbsp;<span class="builtintype" id="1455615">nil</span>&nbsp;<span class="op" id="1455619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455625">memmove</span><span class="op" id="1455632">(</span><span class="ident" id="1455633">unsafe</span><span class="op" id="1455639">.</span><span class="ident" id="1455640">Pointer</span><span class="op" id="1455647">(</span><span class="ident" id="1455648">sg</span><span class="op" id="1455650">.</span><span class="ident" id="1455651">elem</span><span class="op" id="1455655">)</span><span class="op" id="1455656">,</span>&nbsp;<span class="ident" id="1455658">ep</span><span class="op" id="1455660">,</span>&nbsp;<span class="builtintype" id="1455662">uintptr</span><span class="op" id="1455669">(</span><span class="ident" id="1455670">c</span><span class="op" id="1455671">.</span><span class="ident" id="1455672">elemsize</span><span class="op" id="1455680">)</span><span class="op" id="1455681">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455687">sg</span><span class="op" id="1455689">.</span><span class="ident" id="1455690">elem</span>&nbsp;<span class="op" id="1455695">=</span>&nbsp;<span class="builtintype" id="1455697">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455709">recvg</span><span class="op" id="1455714">.</span><span class="ident" id="1455715">param</span>&nbsp;<span class="op" id="1455721">=</span>&nbsp;<span class="ident" id="1455723">unsafe</span><span class="op" id="1455729">.</span><span class="ident" id="1455730">Pointer</span><span class="op" id="1455737">(</span><span class="ident" id="1455738">sg</span><span class="op" id="1455740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455745">if</span>&nbsp;<span class="ident" id="1455748">sg</span><span class="op" id="1455750">.</span><span class="ident" id="1455751">releasetime</span>&nbsp;<span class="op" id="1455763">!=</span>&nbsp;<span class="num" id="1455766">0</span>&nbsp;<span class="op" id="1455768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455774">sg</span><span class="op" id="1455776">.</span><span class="ident" id="1455777">releasetime</span>&nbsp;<span class="op" id="1455789">=</span>&nbsp;<span class="ident" id="1455791">cputicks</span><span class="op" id="1455799">(</span><span class="op" id="1455800">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455810">goready</span><span class="op" id="1455817">(</span><span class="ident" id="1455818">recvg</span><span class="op" id="1455823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455828">return</span>&nbsp;<span class="builtintype" id="1455835">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455847">if</span>&nbsp;<span class="op" id="1455850">!</span><span class="ident" id="1455851">block</span>&nbsp;<span class="op" id="1455857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455862">unlock</span><span class="op" id="1455868">(</span><span class="op" id="1455869">&amp;</span><span class="ident" id="1455870">c</span><span class="op" id="1455871">.</span><span class="ident" id="1455872">lock</span><span class="op" id="1455876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1455881">return</span>&nbsp;<span class="builtintype" id="1455888">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1455896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1455901">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455952">gp</span>&nbsp;<span class="op" id="1455955">:=</span>&nbsp;<span class="ident" id="1455958">getg</span><span class="op" id="1455962">(</span><span class="op" id="1455963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455967">mysg</span>&nbsp;<span class="op" id="1455972">:=</span>&nbsp;<span class="ident" id="1455975">acquireSudog</span><span class="op" id="1455987">(</span><span class="op" id="1455988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1455992">mysg</span><span class="op" id="1455996">.</span><span class="ident" id="1455997">releasetime</span>&nbsp;<span class="op" id="1456009">=</span>&nbsp;<span class="num" id="1456011">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456015">if</span>&nbsp;<span class="ident" id="1456018">t0</span>&nbsp;<span class="op" id="1456021">!=</span>&nbsp;<span class="num" id="1456024">0</span>&nbsp;<span class="op" id="1456026">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456031">mysg</span><span class="op" id="1456035">.</span><span class="ident" id="1456036">releasetime</span>&nbsp;<span class="op" id="1456048">=</span>&nbsp;<span class="op" id="1456050">-</span><span class="num" id="1456051">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456059">mysg</span><span class="op" id="1456063">.</span><span class="ident" id="1456064">elem</span>&nbsp;<span class="op" id="1456069">=</span>&nbsp;<span class="ident" id="1456071">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456076">mysg</span><span class="op" id="1456080">.</span><span class="ident" id="1456081">waitlink</span>&nbsp;<span class="op" id="1456090">=</span>&nbsp;<span class="builtintype" id="1456092">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456098">gp</span><span class="op" id="1456100">.</span><span class="ident" id="1456101">waiting</span>&nbsp;<span class="op" id="1456109">=</span>&nbsp;<span class="ident" id="1456111">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456118">mysg</span><span class="op" id="1456122">.</span><span class="ident" id="1456123">g</span>&nbsp;<span class="op" id="1456125">=</span>&nbsp;<span class="ident" id="1456127">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456132">mysg</span><span class="op" id="1456136">.</span><span class="ident" id="1456137">selectdone</span>&nbsp;<span class="op" id="1456148">=</span>&nbsp;<span class="builtintype" id="1456150">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456156">gp</span><span class="op" id="1456158">.</span><span class="ident" id="1456159">param</span>&nbsp;<span class="op" id="1456165">=</span>&nbsp;<span class="builtintype" id="1456167">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456173">c</span><span class="op" id="1456174">.</span><span class="ident" id="1456175">sendq</span><span class="op" id="1456180">.</span><span class="ident" id="1456181">enqueue</span><span class="op" id="1456188">(</span><span class="ident" id="1456189">mysg</span><span class="op" id="1456193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456197">goparkunlock</span><span class="op" id="1456209">(</span><span class="op" id="1456210">&amp;</span><span class="ident" id="1456211">c</span><span class="op" id="1456212">.</span><span class="ident" id="1456213">lock</span><span class="op" id="1456217">,</span>&nbsp;<span class="string" id="1456219">&#34;chan&nbsp;send&#34;</span><span class="op" id="1456230">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1456235">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456260">if</span>&nbsp;<span class="ident" id="1456263">mysg</span>&nbsp;<span class="op" id="1456268">!=</span>&nbsp;<span class="ident" id="1456271">gp</span><span class="op" id="1456273">.</span><span class="ident" id="1456274">waiting</span>&nbsp;<span class="op" id="1456282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456287">gothrow</span><span class="op" id="1456294">(</span><span class="string" id="1456295">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1456325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456329">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456333">gp</span><span class="op" id="1456335">.</span><span class="ident" id="1456336">waiting</span>&nbsp;<span class="op" id="1456344">=</span>&nbsp;<span class="builtintype" id="1456346">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456352">if</span>&nbsp;<span class="ident" id="1456355">gp</span><span class="op" id="1456357">.</span><span class="ident" id="1456358">param</span>&nbsp;<span class="op" id="1456364">==</span>&nbsp;<span class="builtintype" id="1456367">nil</span>&nbsp;<span class="op" id="1456371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456376">if</span>&nbsp;<span class="ident" id="1456379">c</span><span class="op" id="1456380">.</span><span class="ident" id="1456381">closed</span>&nbsp;<span class="op" id="1456388">==</span>&nbsp;<span class="num" id="1456391">0</span>&nbsp;<span class="op" id="1456393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456399">gothrow</span><span class="op" id="1456406">(</span><span class="string" id="1456407">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1456434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456439">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1456444">panic</span><span class="op" id="1456449">(</span><span class="string" id="1456450">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1456474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456482">gp</span><span class="op" id="1456484">.</span><span class="ident" id="1456485">param</span>&nbsp;<span class="op" id="1456491">=</span>&nbsp;<span class="builtintype" id="1456493">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456499">if</span>&nbsp;<span class="ident" id="1456502">mysg</span><span class="op" id="1456506">.</span><span class="ident" id="1456507">releasetime</span>&nbsp;<span class="op" id="1456519">&gt;</span>&nbsp;<span class="num" id="1456521">0</span>&nbsp;<span class="op" id="1456523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456528">blockevent</span><span class="op" id="1456538">(</span><span class="ident" id="1456539">int64</span><span class="op" id="1456544">(</span><span class="ident" id="1456545">mysg</span><span class="op" id="1456549">.</span><span class="ident" id="1456550">releasetime</span><span class="op" id="1456561">)</span><span class="op" id="1456562">-</span><span class="ident" id="1456563">t0</span><span class="op" id="1456565">,</span>&nbsp;<span class="num" id="1456567">2</span><span class="op" id="1456568">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456576">releaseSudog</span><span class="op" id="1456588">(</span><span class="ident" id="1456589">mysg</span><span class="op" id="1456593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456597">return</span>&nbsp;<span class="builtintype" id="1456604">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1456614">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1456639">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456681">var</span>&nbsp;<span class="ident" id="1456685">t1</span>&nbsp;<span class="ident" id="1456688">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456695">for</span>&nbsp;<span class="ident" id="1456699">c</span><span class="op" id="1456700">.</span><span class="ident" id="1456701">qcount</span>&nbsp;<span class="op" id="1456708">&gt;=</span>&nbsp;<span class="ident" id="1456711">c</span><span class="op" id="1456712">.</span><span class="ident" id="1456713">dataqsiz</span>&nbsp;<span class="op" id="1456722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456726">if</span>&nbsp;<span class="op" id="1456729">!</span><span class="ident" id="1456730">block</span>&nbsp;<span class="op" id="1456736">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456741">unlock</span><span class="op" id="1456747">(</span><span class="op" id="1456748">&amp;</span><span class="ident" id="1456749">c</span><span class="op" id="1456750">.</span><span class="ident" id="1456751">lock</span><span class="op" id="1456755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456760">return</span>&nbsp;<span class="builtintype" id="1456767">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456779">gp</span>&nbsp;<span class="op" id="1456782">:=</span>&nbsp;<span class="ident" id="1456785">getg</span><span class="op" id="1456789">(</span><span class="op" id="1456790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456794">mysg</span>&nbsp;<span class="op" id="1456799">:=</span>&nbsp;<span class="ident" id="1456802">acquireSudog</span><span class="op" id="1456814">(</span><span class="op" id="1456815">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456819">mysg</span><span class="op" id="1456823">.</span><span class="ident" id="1456824">releasetime</span>&nbsp;<span class="op" id="1456836">=</span>&nbsp;<span class="num" id="1456838">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1456842">if</span>&nbsp;<span class="ident" id="1456845">t0</span>&nbsp;<span class="op" id="1456848">!=</span>&nbsp;<span class="num" id="1456851">0</span>&nbsp;<span class="op" id="1456853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456858">mysg</span><span class="op" id="1456862">.</span><span class="ident" id="1456863">releasetime</span>&nbsp;<span class="op" id="1456875">=</span>&nbsp;<span class="op" id="1456877">-</span><span class="num" id="1456878">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456886">mysg</span><span class="op" id="1456890">.</span><span class="ident" id="1456891">g</span>&nbsp;<span class="op" id="1456893">=</span>&nbsp;<span class="ident" id="1456895">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456900">mysg</span><span class="op" id="1456904">.</span><span class="ident" id="1456905">elem</span>&nbsp;<span class="op" id="1456910">=</span>&nbsp;<span class="builtintype" id="1456912">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456918">mysg</span><span class="op" id="1456922">.</span><span class="ident" id="1456923">selectdone</span>&nbsp;<span class="op" id="1456934">=</span>&nbsp;<span class="builtintype" id="1456936">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456942">c</span><span class="op" id="1456943">.</span><span class="ident" id="1456944">sendq</span><span class="op" id="1456949">.</span><span class="ident" id="1456950">enqueue</span><span class="op" id="1456957">(</span><span class="ident" id="1456958">mysg</span><span class="op" id="1456962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456966">goparkunlock</span><span class="op" id="1456978">(</span><span class="op" id="1456979">&amp;</span><span class="ident" id="1456980">c</span><span class="op" id="1456981">.</span><span class="ident" id="1456982">lock</span><span class="op" id="1456986">,</span>&nbsp;<span class="string" id="1456988">&#34;chan&nbsp;send&#34;</span><span class="op" id="1456999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457004">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457040">if</span>&nbsp;<span class="ident" id="1457043">mysg</span><span class="op" id="1457047">.</span><span class="ident" id="1457048">releasetime</span>&nbsp;<span class="op" id="1457060">&gt;</span>&nbsp;<span class="num" id="1457062">0</span>&nbsp;<span class="op" id="1457064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457069">t1</span>&nbsp;<span class="op" id="1457072">=</span>&nbsp;<span class="ident" id="1457074">mysg</span><span class="op" id="1457078">.</span><span class="ident" id="1457079">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457097">releaseSudog</span><span class="op" id="1457109">(</span><span class="ident" id="1457110">mysg</span><span class="op" id="1457114">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457118">lock</span><span class="op" id="1457122">(</span><span class="op" id="1457123">&amp;</span><span class="ident" id="1457124">c</span><span class="op" id="1457125">.</span><span class="ident" id="1457126">lock</span><span class="op" id="1457130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457134">if</span>&nbsp;<span class="ident" id="1457137">c</span><span class="op" id="1457138">.</span><span class="ident" id="1457139">closed</span>&nbsp;<span class="op" id="1457146">!=</span>&nbsp;<span class="num" id="1457149">0</span>&nbsp;<span class="op" id="1457151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457156">unlock</span><span class="op" id="1457162">(</span><span class="op" id="1457163">&amp;</span><span class="ident" id="1457164">c</span><span class="op" id="1457165">.</span><span class="ident" id="1457166">lock</span><span class="op" id="1457170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1457175">panic</span><span class="op" id="1457180">(</span><span class="string" id="1457181">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1457205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457209">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457216">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457259">if</span>&nbsp;<span class="ident" id="1457262">raceenabled</span>&nbsp;<span class="op" id="1457274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457278">raceacquire</span><span class="op" id="1457289">(</span><span class="ident" id="1457290">chanbuf</span><span class="op" id="1457297">(</span><span class="ident" id="1457298">c</span><span class="op" id="1457299">,</span>&nbsp;<span class="ident" id="1457301">c</span><span class="op" id="1457302">.</span><span class="ident" id="1457303">sendx</span><span class="op" id="1457308">)</span><span class="op" id="1457309">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457313">racerelease</span><span class="op" id="1457324">(</span><span class="ident" id="1457325">chanbuf</span><span class="op" id="1457332">(</span><span class="ident" id="1457333">c</span><span class="op" id="1457334">,</span>&nbsp;<span class="ident" id="1457336">c</span><span class="op" id="1457337">.</span><span class="ident" id="1457338">sendx</span><span class="op" id="1457343">)</span><span class="op" id="1457344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457350">memmove</span><span class="op" id="1457357">(</span><span class="ident" id="1457358">chanbuf</span><span class="op" id="1457365">(</span><span class="ident" id="1457366">c</span><span class="op" id="1457367">,</span>&nbsp;<span class="ident" id="1457369">c</span><span class="op" id="1457370">.</span><span class="ident" id="1457371">sendx</span><span class="op" id="1457376">)</span><span class="op" id="1457377">,</span>&nbsp;<span class="ident" id="1457379">ep</span><span class="op" id="1457381">,</span>&nbsp;<span class="builtintype" id="1457383">uintptr</span><span class="op" id="1457390">(</span><span class="ident" id="1457391">c</span><span class="op" id="1457392">.</span><span class="ident" id="1457393">elemsize</span><span class="op" id="1457401">)</span><span class="op" id="1457402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457405">c</span><span class="op" id="1457406">.</span><span class="ident" id="1457407">sendx</span><span class="op" id="1457412">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457416">if</span>&nbsp;<span class="ident" id="1457419">c</span><span class="op" id="1457420">.</span><span class="ident" id="1457421">sendx</span>&nbsp;<span class="op" id="1457427">==</span>&nbsp;<span class="ident" id="1457430">c</span><span class="op" id="1457431">.</span><span class="ident" id="1457432">dataqsiz</span>&nbsp;<span class="op" id="1457441">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457445">c</span><span class="op" id="1457446">.</span><span class="ident" id="1457447">sendx</span>&nbsp;<span class="op" id="1457453">=</span>&nbsp;<span class="num" id="1457455">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457461">c</span><span class="op" id="1457462">.</span><span class="ident" id="1457463">qcount</span><span class="op" id="1457469">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1457474">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457505">sg</span>&nbsp;<span class="op" id="1457508">:=</span>&nbsp;<span class="ident" id="1457511">c</span><span class="op" id="1457512">.</span><span class="ident" id="1457513">recvq</span><span class="op" id="1457518">.</span><span class="ident" id="1457519">dequeue</span><span class="op" id="1457526">(</span><span class="op" id="1457527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457530">if</span>&nbsp;<span class="ident" id="1457533">sg</span>&nbsp;<span class="op" id="1457536">!=</span>&nbsp;<span class="builtintype" id="1457539">nil</span>&nbsp;<span class="op" id="1457543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457547">recvg</span>&nbsp;<span class="op" id="1457553">:=</span>&nbsp;<span class="ident" id="1457556">sg</span><span class="op" id="1457558">.</span><span class="ident" id="1457559">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457563">unlock</span><span class="op" id="1457569">(</span><span class="op" id="1457570">&amp;</span><span class="ident" id="1457571">c</span><span class="op" id="1457572">.</span><span class="ident" id="1457573">lock</span><span class="op" id="1457577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457581">if</span>&nbsp;<span class="ident" id="1457584">sg</span><span class="op" id="1457586">.</span><span class="ident" id="1457587">releasetime</span>&nbsp;<span class="op" id="1457599">!=</span>&nbsp;<span class="num" id="1457602">0</span>&nbsp;<span class="op" id="1457604">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457609">sg</span><span class="op" id="1457611">.</span><span class="ident" id="1457612">releasetime</span>&nbsp;<span class="op" id="1457624">=</span>&nbsp;<span class="ident" id="1457626">cputicks</span><span class="op" id="1457634">(</span><span class="op" id="1457635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457643">goready</span><span class="op" id="1457650">(</span><span class="ident" id="1457651">recvg</span><span class="op" id="1457656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457659">}</span>&nbsp;<span class="keyword" id="1457661">else</span>&nbsp;<span class="op" id="1457666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457670">unlock</span><span class="op" id="1457676">(</span><span class="op" id="1457677">&amp;</span><span class="ident" id="1457678">c</span><span class="op" id="1457679">.</span><span class="ident" id="1457680">lock</span><span class="op" id="1457684">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457690">if</span>&nbsp;<span class="ident" id="1457693">t1</span>&nbsp;<span class="op" id="1457696">&gt;</span>&nbsp;<span class="num" id="1457698">0</span>&nbsp;<span class="op" id="1457700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457704">blockevent</span><span class="op" id="1457714">(</span><span class="ident" id="1457715">t1</span><span class="op" id="1457717">-</span><span class="ident" id="1457718">t0</span><span class="op" id="1457720">,</span>&nbsp;<span class="num" id="1457722">2</span><span class="op" id="1457723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457729">return</span>&nbsp;<span class="builtintype" id="1457736">true</span><br>
<span class="lineno">255</span><span class="op" id="1457741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1457744">func</span>&nbsp;<span class="ident" id="1457749">closechan</span><span class="op" id="1457758">(</span><span class="ident" id="1457759">c</span>&nbsp;<span class="op" id="1457761">*</span><span class="ident" id="1457762">hchan</span><span class="op" id="1457767">)</span>&nbsp;<span class="op" id="1457769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457772">if</span>&nbsp;<span class="ident" id="1457775">c</span>&nbsp;<span class="op" id="1457777">==</span>&nbsp;<span class="builtintype" id="1457780">nil</span>&nbsp;<span class="op" id="1457784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1457788">panic</span><span class="op" id="1457793">(</span><span class="string" id="1457794">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1457816">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457823">lock</span><span class="op" id="1457827">(</span><span class="op" id="1457828">&amp;</span><span class="ident" id="1457829">c</span><span class="op" id="1457830">.</span><span class="ident" id="1457831">lock</span><span class="op" id="1457835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457838">if</span>&nbsp;<span class="ident" id="1457841">c</span><span class="op" id="1457842">.</span><span class="ident" id="1457843">closed</span>&nbsp;<span class="op" id="1457850">!=</span>&nbsp;<span class="num" id="1457853">0</span>&nbsp;<span class="op" id="1457855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457859">unlock</span><span class="op" id="1457865">(</span><span class="op" id="1457866">&amp;</span><span class="ident" id="1457867">c</span><span class="op" id="1457868">.</span><span class="ident" id="1457869">lock</span><span class="op" id="1457873">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1457877">panic</span><span class="op" id="1457882">(</span><span class="string" id="1457883">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1457908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1457915">if</span>&nbsp;<span class="ident" id="1457918">raceenabled</span>&nbsp;<span class="op" id="1457930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457934">callerpc</span>&nbsp;<span class="op" id="1457943">:=</span>&nbsp;<span class="ident" id="1457946">getcallerpc</span><span class="op" id="1457957">(</span><span class="ident" id="1457958">unsafe</span><span class="op" id="1457964">.</span><span class="ident" id="1457965">Pointer</span><span class="op" id="1457972">(</span><span class="op" id="1457973">&amp;</span><span class="ident" id="1457974">c</span><span class="op" id="1457975">)</span><span class="op" id="1457976">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457980">racewritepc</span><span class="op" id="1457991">(</span><span class="ident" id="1457992">unsafe</span><span class="op" id="1457998">.</span><span class="ident" id="1457999">Pointer</span><span class="op" id="1458006">(</span><span class="ident" id="1458007">c</span><span class="op" id="1458008">)</span><span class="op" id="1458009">,</span>&nbsp;<span class="ident" id="1458011">callerpc</span><span class="op" id="1458019">,</span>&nbsp;<span class="ident" id="1458021">funcPC</span><span class="op" id="1458027">(</span><span class="ident" id="1458028">closechan</span><span class="op" id="1458037">)</span><span class="op" id="1458038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458042">racerelease</span><span class="op" id="1458053">(</span><span class="ident" id="1458054">unsafe</span><span class="op" id="1458060">.</span><span class="ident" id="1458061">Pointer</span><span class="op" id="1458068">(</span><span class="ident" id="1458069">c</span><span class="op" id="1458070">)</span><span class="op" id="1458071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458078">c</span><span class="op" id="1458079">.</span><span class="ident" id="1458080">closed</span>&nbsp;<span class="op" id="1458087">=</span>&nbsp;<span class="num" id="1458089">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458093">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458117">for</span>&nbsp;<span class="op" id="1458121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458125">sg</span>&nbsp;<span class="op" id="1458128">:=</span>&nbsp;<span class="ident" id="1458131">c</span><span class="op" id="1458132">.</span><span class="ident" id="1458133">recvq</span><span class="op" id="1458138">.</span><span class="ident" id="1458139">dequeue</span><span class="op" id="1458146">(</span><span class="op" id="1458147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458151">if</span>&nbsp;<span class="ident" id="1458154">sg</span>&nbsp;<span class="op" id="1458157">==</span>&nbsp;<span class="builtintype" id="1458160">nil</span>&nbsp;<span class="op" id="1458164">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458169">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458181">gp</span>&nbsp;<span class="op" id="1458184">:=</span>&nbsp;<span class="ident" id="1458187">sg</span><span class="op" id="1458189">.</span><span class="ident" id="1458190">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458194">sg</span><span class="op" id="1458196">.</span><span class="ident" id="1458197">elem</span>&nbsp;<span class="op" id="1458202">=</span>&nbsp;<span class="builtintype" id="1458204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458210">gp</span><span class="op" id="1458212">.</span><span class="ident" id="1458213">param</span>&nbsp;<span class="op" id="1458219">=</span>&nbsp;<span class="builtintype" id="1458221">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458227">if</span>&nbsp;<span class="ident" id="1458230">sg</span><span class="op" id="1458232">.</span><span class="ident" id="1458233">releasetime</span>&nbsp;<span class="op" id="1458245">!=</span>&nbsp;<span class="num" id="1458248">0</span>&nbsp;<span class="op" id="1458250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458255">sg</span><span class="op" id="1458257">.</span><span class="ident" id="1458258">releasetime</span>&nbsp;<span class="op" id="1458270">=</span>&nbsp;<span class="ident" id="1458272">cputicks</span><span class="op" id="1458280">(</span><span class="op" id="1458281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458289">goready</span><span class="op" id="1458296">(</span><span class="ident" id="1458297">gp</span><span class="op" id="1458299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458302">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458306">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458330">for</span>&nbsp;<span class="op" id="1458334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458338">sg</span>&nbsp;<span class="op" id="1458341">:=</span>&nbsp;<span class="ident" id="1458344">c</span><span class="op" id="1458345">.</span><span class="ident" id="1458346">sendq</span><span class="op" id="1458351">.</span><span class="ident" id="1458352">dequeue</span><span class="op" id="1458359">(</span><span class="op" id="1458360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458364">if</span>&nbsp;<span class="ident" id="1458367">sg</span>&nbsp;<span class="op" id="1458370">==</span>&nbsp;<span class="builtintype" id="1458373">nil</span>&nbsp;<span class="op" id="1458377">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458382">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458394">gp</span>&nbsp;<span class="op" id="1458397">:=</span>&nbsp;<span class="ident" id="1458400">sg</span><span class="op" id="1458402">.</span><span class="ident" id="1458403">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458407">sg</span><span class="op" id="1458409">.</span><span class="ident" id="1458410">elem</span>&nbsp;<span class="op" id="1458415">=</span>&nbsp;<span class="builtintype" id="1458417">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458423">gp</span><span class="op" id="1458425">.</span><span class="ident" id="1458426">param</span>&nbsp;<span class="op" id="1458432">=</span>&nbsp;<span class="builtintype" id="1458434">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458440">if</span>&nbsp;<span class="ident" id="1458443">sg</span><span class="op" id="1458445">.</span><span class="ident" id="1458446">releasetime</span>&nbsp;<span class="op" id="1458458">!=</span>&nbsp;<span class="num" id="1458461">0</span>&nbsp;<span class="op" id="1458463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458468">sg</span><span class="op" id="1458470">.</span><span class="ident" id="1458471">releasetime</span>&nbsp;<span class="op" id="1458483">=</span>&nbsp;<span class="ident" id="1458485">cputicks</span><span class="op" id="1458493">(</span><span class="op" id="1458494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458502">goready</span><span class="op" id="1458509">(</span><span class="ident" id="1458510">gp</span><span class="op" id="1458512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458515">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458518">unlock</span><span class="op" id="1458524">(</span><span class="op" id="1458525">&amp;</span><span class="ident" id="1458526">c</span><span class="op" id="1458527">.</span><span class="ident" id="1458528">lock</span><span class="op" id="1458532">)</span><br>
<span class="lineno"></span><span class="op" id="1458534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1458537">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1458581">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1458594">func</span>&nbsp;<span class="ident" id="1458599">chanrecv1</span><span class="op" id="1458608">(</span><span class="ident" id="1458609">t</span>&nbsp;<span class="op" id="1458611">*</span><span class="ident" id="1458612">chantype</span><span class="op" id="1458620">,</span>&nbsp;<span class="ident" id="1458622">c</span>&nbsp;<span class="op" id="1458624">*</span><span class="ident" id="1458625">hchan</span><span class="op" id="1458630">,</span>&nbsp;<span class="ident" id="1458632">elem</span>&nbsp;<span class="ident" id="1458637">unsafe</span><span class="op" id="1458643">.</span><span class="ident" id="1458644">Pointer</span><span class="op" id="1458651">)</span>&nbsp;<span class="op" id="1458653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458656">chanrecv</span><span class="op" id="1458664">(</span><span class="ident" id="1458665">t</span><span class="op" id="1458666">,</span>&nbsp;<span class="ident" id="1458668">c</span><span class="op" id="1458669">,</span>&nbsp;<span class="ident" id="1458671">elem</span><span class="op" id="1458675">,</span>&nbsp;<span class="builtintype" id="1458677">true</span><span class="op" id="1458681">)</span><br>
<span class="lineno"></span><span class="op" id="1458683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1458686">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1458699">func</span>&nbsp;<span class="ident" id="1458704">chanrecv2</span><span class="op" id="1458713">(</span><span class="ident" id="1458714">t</span>&nbsp;<span class="op" id="1458716">*</span><span class="ident" id="1458717">chantype</span><span class="op" id="1458725">,</span>&nbsp;<span class="ident" id="1458727">c</span>&nbsp;<span class="op" id="1458729">*</span><span class="ident" id="1458730">hchan</span><span class="op" id="1458735">,</span>&nbsp;<span class="ident" id="1458737">elem</span>&nbsp;<span class="ident" id="1458742">unsafe</span><span class="op" id="1458748">.</span><span class="ident" id="1458749">Pointer</span><span class="op" id="1458756">)</span>&nbsp;<span class="op" id="1458758">(</span><span class="ident" id="1458759">received</span>&nbsp;<span class="builtintype" id="1458768">bool</span><span class="op" id="1458772">)</span>&nbsp;<span class="op" id="1458774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458777">_</span><span class="op" id="1458778">,</span>&nbsp;<span class="ident" id="1458780">received</span>&nbsp;<span class="op" id="1458789">=</span>&nbsp;<span class="ident" id="1458791">chanrecv</span><span class="op" id="1458799">(</span><span class="ident" id="1458800">t</span><span class="op" id="1458801">,</span>&nbsp;<span class="ident" id="1458803">c</span><span class="op" id="1458804">,</span>&nbsp;<span class="ident" id="1458806">elem</span><span class="op" id="1458810">,</span>&nbsp;<span class="builtintype" id="1458812">true</span><span class="op" id="1458816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1458819">return</span><br>
<span class="lineno"></span><span class="op" id="1458826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1458829">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1458899">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1458957">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1459033">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1459100">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1459169">func</span>&nbsp;<span class="ident" id="1459174">chanrecv</span><span class="op" id="1459182">(</span><span class="ident" id="1459183">t</span>&nbsp;<span class="op" id="1459185">*</span><span class="ident" id="1459186">chantype</span><span class="op" id="1459194">,</span>&nbsp;<span class="ident" id="1459196">c</span>&nbsp;<span class="op" id="1459198">*</span><span class="ident" id="1459199">hchan</span><span class="op" id="1459204">,</span>&nbsp;<span class="ident" id="1459206">ep</span>&nbsp;<span class="ident" id="1459209">unsafe</span><span class="op" id="1459215">.</span><span class="ident" id="1459216">Pointer</span><span class="op" id="1459223">,</span>&nbsp;<span class="ident" id="1459225">block</span>&nbsp;<span class="builtintype" id="1459231">bool</span><span class="op" id="1459235">)</span>&nbsp;<span class="op" id="1459237">(</span><span class="ident" id="1459238">selected</span><span class="op" id="1459246">,</span>&nbsp;<span class="ident" id="1459248">received</span>&nbsp;<span class="builtintype" id="1459257">bool</span><span class="op" id="1459261">)</span>&nbsp;<span class="op" id="1459263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459266">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459338">if</span>&nbsp;<span class="ident" id="1459341">debugChan</span>&nbsp;<span class="op" id="1459351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1459355">print</span><span class="op" id="1459360">(</span><span class="string" id="1459361">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1459378">,</span>&nbsp;<span class="ident" id="1459380">c</span><span class="op" id="1459381">,</span>&nbsp;<span class="string" id="1459383">&#34;\n&#34;</span><span class="op" id="1459387">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459394">if</span>&nbsp;<span class="ident" id="1459397">c</span>&nbsp;<span class="op" id="1459399">==</span>&nbsp;<span class="builtintype" id="1459402">nil</span>&nbsp;<span class="op" id="1459406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459410">if</span>&nbsp;<span class="op" id="1459413">!</span><span class="ident" id="1459414">block</span>&nbsp;<span class="op" id="1459420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459425">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459438">gopark</span><span class="op" id="1459444">(</span><span class="builtintype" id="1459445">nil</span><span class="op" id="1459448">,</span>&nbsp;<span class="builtintype" id="1459450">nil</span><span class="op" id="1459453">,</span>&nbsp;<span class="string" id="1459455">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1459480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459484">gothrow</span><span class="op" id="1459491">(</span><span class="string" id="1459492">&#34;unreachable&#34;</span><span class="op" id="1459505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459512">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459595">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459599">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459684">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459766">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459826">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459905">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459983">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460061">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460109">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460113">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460197">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460246">if</span>&nbsp;<span class="op" id="1460249">!</span><span class="ident" id="1460250">block</span>&nbsp;<span class="op" id="1460256">&amp;&amp;</span>&nbsp;<span class="op" id="1460259">(</span><span class="ident" id="1460260">c</span><span class="op" id="1460261">.</span><span class="ident" id="1460262">dataqsiz</span>&nbsp;<span class="op" id="1460271">==</span>&nbsp;<span class="num" id="1460274">0</span>&nbsp;<span class="op" id="1460276">&amp;&amp;</span>&nbsp;<span class="ident" id="1460279">c</span><span class="op" id="1460280">.</span><span class="ident" id="1460281">sendq</span><span class="op" id="1460286">.</span><span class="ident" id="1460287">first</span>&nbsp;<span class="op" id="1460293">==</span>&nbsp;<span class="builtintype" id="1460296">nil</span>&nbsp;<span class="op" id="1460300">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460305">c</span><span class="op" id="1460306">.</span><span class="ident" id="1460307">dataqsiz</span>&nbsp;<span class="op" id="1460316">&gt;</span>&nbsp;<span class="num" id="1460318">0</span>&nbsp;<span class="op" id="1460320">&amp;&amp;</span>&nbsp;<span class="ident" id="1460323">atomicloaduint</span><span class="op" id="1460337">(</span><span class="op" id="1460338">&amp;</span><span class="ident" id="1460339">c</span><span class="op" id="1460340">.</span><span class="ident" id="1460341">qcount</span><span class="op" id="1460347">)</span>&nbsp;<span class="op" id="1460349">==</span>&nbsp;<span class="num" id="1460352">0</span><span class="op" id="1460353">)</span>&nbsp;<span class="op" id="1460355">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460360">atomicload</span><span class="op" id="1460370">(</span><span class="op" id="1460371">&amp;</span><span class="ident" id="1460372">c</span><span class="op" id="1460373">.</span><span class="ident" id="1460374">closed</span><span class="op" id="1460380">)</span>&nbsp;<span class="op" id="1460382">==</span>&nbsp;<span class="num" id="1460385">0</span>&nbsp;<span class="op" id="1460387">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460391">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460403">var</span>&nbsp;<span class="ident" id="1460407">t0</span>&nbsp;<span class="ident" id="1460410">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460417">if</span>&nbsp;<span class="ident" id="1460420">blockprofilerate</span>&nbsp;<span class="op" id="1460437">&gt;</span>&nbsp;<span class="num" id="1460439">0</span>&nbsp;<span class="op" id="1460441">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460445">t0</span>&nbsp;<span class="op" id="1460448">=</span>&nbsp;<span class="ident" id="1460450">cputicks</span><span class="op" id="1460458">(</span><span class="op" id="1460459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460466">lock</span><span class="op" id="1460470">(</span><span class="op" id="1460471">&amp;</span><span class="ident" id="1460472">c</span><span class="op" id="1460473">.</span><span class="ident" id="1460474">lock</span><span class="op" id="1460478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460481">if</span>&nbsp;<span class="ident" id="1460484">c</span><span class="op" id="1460485">.</span><span class="ident" id="1460486">dataqsiz</span>&nbsp;<span class="op" id="1460495">==</span>&nbsp;<span class="num" id="1460498">0</span>&nbsp;<span class="op" id="1460500">{</span>&nbsp;<span class="comment" id="1460502">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460527">if</span>&nbsp;<span class="ident" id="1460530">c</span><span class="op" id="1460531">.</span><span class="ident" id="1460532">closed</span>&nbsp;<span class="op" id="1460539">!=</span>&nbsp;<span class="num" id="1460542">0</span>&nbsp;<span class="op" id="1460544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460549">return</span>&nbsp;<span class="ident" id="1460556">recvclosed</span><span class="op" id="1460566">(</span><span class="ident" id="1460567">c</span><span class="op" id="1460568">,</span>&nbsp;<span class="ident" id="1460570">ep</span><span class="op" id="1460572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460581">sg</span>&nbsp;<span class="op" id="1460584">:=</span>&nbsp;<span class="ident" id="1460587">c</span><span class="op" id="1460588">.</span><span class="ident" id="1460589">sendq</span><span class="op" id="1460594">.</span><span class="ident" id="1460595">dequeue</span><span class="op" id="1460602">(</span><span class="op" id="1460603">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460607">if</span>&nbsp;<span class="ident" id="1460610">sg</span>&nbsp;<span class="op" id="1460613">!=</span>&nbsp;<span class="builtintype" id="1460616">nil</span>&nbsp;<span class="op" id="1460620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460625">if</span>&nbsp;<span class="ident" id="1460628">raceenabled</span>&nbsp;<span class="op" id="1460640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460646">racesync</span><span class="op" id="1460654">(</span><span class="ident" id="1460655">c</span><span class="op" id="1460656">,</span>&nbsp;<span class="ident" id="1460658">sg</span><span class="op" id="1460660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460670">unlock</span><span class="op" id="1460676">(</span><span class="op" id="1460677">&amp;</span><span class="ident" id="1460678">c</span><span class="op" id="1460679">.</span><span class="ident" id="1460680">lock</span><span class="op" id="1460684">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460690">if</span>&nbsp;<span class="ident" id="1460693">ep</span>&nbsp;<span class="op" id="1460696">!=</span>&nbsp;<span class="builtintype" id="1460699">nil</span>&nbsp;<span class="op" id="1460703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460709">memmove</span><span class="op" id="1460716">(</span><span class="ident" id="1460717">ep</span><span class="op" id="1460719">,</span>&nbsp;<span class="ident" id="1460721">sg</span><span class="op" id="1460723">.</span><span class="ident" id="1460724">elem</span><span class="op" id="1460728">,</span>&nbsp;<span class="builtintype" id="1460730">uintptr</span><span class="op" id="1460737">(</span><span class="ident" id="1460738">c</span><span class="op" id="1460739">.</span><span class="ident" id="1460740">elemsize</span><span class="op" id="1460748">)</span><span class="op" id="1460749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460759">sg</span><span class="op" id="1460761">.</span><span class="ident" id="1460762">elem</span>&nbsp;<span class="op" id="1460767">=</span>&nbsp;<span class="builtintype" id="1460769">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460776">gp</span>&nbsp;<span class="op" id="1460779">:=</span>&nbsp;<span class="ident" id="1460782">sg</span><span class="op" id="1460784">.</span><span class="ident" id="1460785">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460790">gp</span><span class="op" id="1460792">.</span><span class="ident" id="1460793">param</span>&nbsp;<span class="op" id="1460799">=</span>&nbsp;<span class="ident" id="1460801">unsafe</span><span class="op" id="1460807">.</span><span class="ident" id="1460808">Pointer</span><span class="op" id="1460815">(</span><span class="ident" id="1460816">sg</span><span class="op" id="1460818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460823">if</span>&nbsp;<span class="ident" id="1460826">sg</span><span class="op" id="1460828">.</span><span class="ident" id="1460829">releasetime</span>&nbsp;<span class="op" id="1460841">!=</span>&nbsp;<span class="num" id="1460844">0</span>&nbsp;<span class="op" id="1460846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460852">sg</span><span class="op" id="1460854">.</span><span class="ident" id="1460855">releasetime</span>&nbsp;<span class="op" id="1460867">=</span>&nbsp;<span class="ident" id="1460869">cputicks</span><span class="op" id="1460877">(</span><span class="op" id="1460878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460883">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460888">goready</span><span class="op" id="1460895">(</span><span class="ident" id="1460896">gp</span><span class="op" id="1460898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460903">selected</span>&nbsp;<span class="op" id="1460912">=</span>&nbsp;<span class="builtintype" id="1460914">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460922">received</span>&nbsp;<span class="op" id="1460931">=</span>&nbsp;<span class="builtintype" id="1460933">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460941">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460950">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460955">if</span>&nbsp;<span class="op" id="1460958">!</span><span class="ident" id="1460959">block</span>&nbsp;<span class="op" id="1460965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460970">unlock</span><span class="op" id="1460976">(</span><span class="op" id="1460977">&amp;</span><span class="ident" id="1460978">c</span><span class="op" id="1460979">.</span><span class="ident" id="1460980">lock</span><span class="op" id="1460984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460989">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460998">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461003">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461052">gp</span>&nbsp;<span class="op" id="1461055">:=</span>&nbsp;<span class="ident" id="1461058">getg</span><span class="op" id="1461062">(</span><span class="op" id="1461063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461067">mysg</span>&nbsp;<span class="op" id="1461072">:=</span>&nbsp;<span class="ident" id="1461075">acquireSudog</span><span class="op" id="1461087">(</span><span class="op" id="1461088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461092">mysg</span><span class="op" id="1461096">.</span><span class="ident" id="1461097">releasetime</span>&nbsp;<span class="op" id="1461109">=</span>&nbsp;<span class="num" id="1461111">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461115">if</span>&nbsp;<span class="ident" id="1461118">t0</span>&nbsp;<span class="op" id="1461121">!=</span>&nbsp;<span class="num" id="1461124">0</span>&nbsp;<span class="op" id="1461126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461131">mysg</span><span class="op" id="1461135">.</span><span class="ident" id="1461136">releasetime</span>&nbsp;<span class="op" id="1461148">=</span>&nbsp;<span class="op" id="1461150">-</span><span class="num" id="1461151">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461159">mysg</span><span class="op" id="1461163">.</span><span class="ident" id="1461164">elem</span>&nbsp;<span class="op" id="1461169">=</span>&nbsp;<span class="ident" id="1461171">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461176">mysg</span><span class="op" id="1461180">.</span><span class="ident" id="1461181">waitlink</span>&nbsp;<span class="op" id="1461190">=</span>&nbsp;<span class="builtintype" id="1461192">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461198">gp</span><span class="op" id="1461200">.</span><span class="ident" id="1461201">waiting</span>&nbsp;<span class="op" id="1461209">=</span>&nbsp;<span class="ident" id="1461211">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461218">mysg</span><span class="op" id="1461222">.</span><span class="ident" id="1461223">g</span>&nbsp;<span class="op" id="1461225">=</span>&nbsp;<span class="ident" id="1461227">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461232">mysg</span><span class="op" id="1461236">.</span><span class="ident" id="1461237">selectdone</span>&nbsp;<span class="op" id="1461248">=</span>&nbsp;<span class="builtintype" id="1461250">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461256">gp</span><span class="op" id="1461258">.</span><span class="ident" id="1461259">param</span>&nbsp;<span class="op" id="1461265">=</span>&nbsp;<span class="builtintype" id="1461267">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461273">c</span><span class="op" id="1461274">.</span><span class="ident" id="1461275">recvq</span><span class="op" id="1461280">.</span><span class="ident" id="1461281">enqueue</span><span class="op" id="1461288">(</span><span class="ident" id="1461289">mysg</span><span class="op" id="1461293">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461297">goparkunlock</span><span class="op" id="1461309">(</span><span class="op" id="1461310">&amp;</span><span class="ident" id="1461311">c</span><span class="op" id="1461312">.</span><span class="ident" id="1461313">lock</span><span class="op" id="1461317">,</span>&nbsp;<span class="string" id="1461319">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1461333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461338">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461362">if</span>&nbsp;<span class="ident" id="1461365">mysg</span>&nbsp;<span class="op" id="1461370">!=</span>&nbsp;<span class="ident" id="1461373">gp</span><span class="op" id="1461375">.</span><span class="ident" id="1461376">waiting</span>&nbsp;<span class="op" id="1461384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461389">gothrow</span><span class="op" id="1461396">(</span><span class="string" id="1461397">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1461427">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461435">gp</span><span class="op" id="1461437">.</span><span class="ident" id="1461438">waiting</span>&nbsp;<span class="op" id="1461446">=</span>&nbsp;<span class="builtintype" id="1461448">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461454">if</span>&nbsp;<span class="ident" id="1461457">mysg</span><span class="op" id="1461461">.</span><span class="ident" id="1461462">releasetime</span>&nbsp;<span class="op" id="1461474">&gt;</span>&nbsp;<span class="num" id="1461476">0</span>&nbsp;<span class="op" id="1461478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461483">blockevent</span><span class="op" id="1461493">(</span><span class="ident" id="1461494">mysg</span><span class="op" id="1461498">.</span><span class="ident" id="1461499">releasetime</span><span class="op" id="1461510">-</span><span class="ident" id="1461511">t0</span><span class="op" id="1461513">,</span>&nbsp;<span class="num" id="1461515">2</span><span class="op" id="1461516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461520">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461524">haveData</span>&nbsp;<span class="op" id="1461533">:=</span>&nbsp;<span class="ident" id="1461536">gp</span><span class="op" id="1461538">.</span><span class="ident" id="1461539">param</span>&nbsp;<span class="op" id="1461545">!=</span>&nbsp;<span class="builtintype" id="1461548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461554">gp</span><span class="op" id="1461556">.</span><span class="ident" id="1461557">param</span>&nbsp;<span class="op" id="1461563">=</span>&nbsp;<span class="builtintype" id="1461565">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461571">releaseSudog</span><span class="op" id="1461583">(</span><span class="ident" id="1461584">mysg</span><span class="op" id="1461588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461593">if</span>&nbsp;<span class="ident" id="1461596">haveData</span>&nbsp;<span class="op" id="1461605">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461610">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461668">selected</span>&nbsp;<span class="op" id="1461677">=</span>&nbsp;<span class="builtintype" id="1461679">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461687">received</span>&nbsp;<span class="op" id="1461696">=</span>&nbsp;<span class="builtintype" id="1461698">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461706">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461715">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461720">lock</span><span class="op" id="1461724">(</span><span class="op" id="1461725">&amp;</span><span class="ident" id="1461726">c</span><span class="op" id="1461727">.</span><span class="ident" id="1461728">lock</span><span class="op" id="1461732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461736">if</span>&nbsp;<span class="ident" id="1461739">c</span><span class="op" id="1461740">.</span><span class="ident" id="1461741">closed</span>&nbsp;<span class="op" id="1461748">==</span>&nbsp;<span class="num" id="1461751">0</span>&nbsp;<span class="op" id="1461753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461758">gothrow</span><span class="op" id="1461765">(</span><span class="string" id="1461766">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1461793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461797">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461801">return</span>&nbsp;<span class="ident" id="1461808">recvclosed</span><span class="op" id="1461818">(</span><span class="ident" id="1461819">c</span><span class="op" id="1461820">,</span>&nbsp;<span class="ident" id="1461822">ep</span><span class="op" id="1461824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461831">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461856">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461889">var</span>&nbsp;<span class="ident" id="1461893">t1</span>&nbsp;<span class="ident" id="1461896">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461903">for</span>&nbsp;<span class="ident" id="1461907">c</span><span class="op" id="1461908">.</span><span class="ident" id="1461909">qcount</span>&nbsp;<span class="op" id="1461916">&lt;=</span>&nbsp;<span class="num" id="1461919">0</span>&nbsp;<span class="op" id="1461921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461925">if</span>&nbsp;<span class="ident" id="1461928">c</span><span class="op" id="1461929">.</span><span class="ident" id="1461930">closed</span>&nbsp;<span class="op" id="1461937">!=</span>&nbsp;<span class="num" id="1461940">0</span>&nbsp;<span class="op" id="1461942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461947">selected</span><span class="op" id="1461955">,</span>&nbsp;<span class="ident" id="1461957">received</span>&nbsp;<span class="op" id="1461966">=</span>&nbsp;<span class="ident" id="1461968">recvclosed</span><span class="op" id="1461978">(</span><span class="ident" id="1461979">c</span><span class="op" id="1461980">,</span>&nbsp;<span class="ident" id="1461982">ep</span><span class="op" id="1461984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461989">if</span>&nbsp;<span class="ident" id="1461992">t1</span>&nbsp;<span class="op" id="1461995">&gt;</span>&nbsp;<span class="num" id="1461997">0</span>&nbsp;<span class="op" id="1461999">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462005">blockevent</span><span class="op" id="1462015">(</span><span class="ident" id="1462016">t1</span><span class="op" id="1462018">-</span><span class="ident" id="1462019">t0</span><span class="op" id="1462021">,</span>&nbsp;<span class="num" id="1462023">2</span><span class="op" id="1462024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462034">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462048">if</span>&nbsp;<span class="op" id="1462051">!</span><span class="ident" id="1462052">block</span>&nbsp;<span class="op" id="1462058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462063">unlock</span><span class="op" id="1462069">(</span><span class="op" id="1462070">&amp;</span><span class="ident" id="1462071">c</span><span class="op" id="1462072">.</span><span class="ident" id="1462073">lock</span><span class="op" id="1462077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462082">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462096">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462137">gp</span>&nbsp;<span class="op" id="1462140">:=</span>&nbsp;<span class="ident" id="1462143">getg</span><span class="op" id="1462147">(</span><span class="op" id="1462148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462152">mysg</span>&nbsp;<span class="op" id="1462157">:=</span>&nbsp;<span class="ident" id="1462160">acquireSudog</span><span class="op" id="1462172">(</span><span class="op" id="1462173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462177">mysg</span><span class="op" id="1462181">.</span><span class="ident" id="1462182">releasetime</span>&nbsp;<span class="op" id="1462194">=</span>&nbsp;<span class="num" id="1462196">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462200">if</span>&nbsp;<span class="ident" id="1462203">t0</span>&nbsp;<span class="op" id="1462206">!=</span>&nbsp;<span class="num" id="1462209">0</span>&nbsp;<span class="op" id="1462211">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462216">mysg</span><span class="op" id="1462220">.</span><span class="ident" id="1462221">releasetime</span>&nbsp;<span class="op" id="1462233">=</span>&nbsp;<span class="op" id="1462235">-</span><span class="num" id="1462236">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462244">mysg</span><span class="op" id="1462248">.</span><span class="ident" id="1462249">elem</span>&nbsp;<span class="op" id="1462254">=</span>&nbsp;<span class="builtintype" id="1462256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462262">mysg</span><span class="op" id="1462266">.</span><span class="ident" id="1462267">g</span>&nbsp;<span class="op" id="1462269">=</span>&nbsp;<span class="ident" id="1462271">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462276">mysg</span><span class="op" id="1462280">.</span><span class="ident" id="1462281">selectdone</span>&nbsp;<span class="op" id="1462292">=</span>&nbsp;<span class="builtintype" id="1462294">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462301">c</span><span class="op" id="1462302">.</span><span class="ident" id="1462303">recvq</span><span class="op" id="1462308">.</span><span class="ident" id="1462309">enqueue</span><span class="op" id="1462316">(</span><span class="ident" id="1462317">mysg</span><span class="op" id="1462321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462325">goparkunlock</span><span class="op" id="1462337">(</span><span class="op" id="1462338">&amp;</span><span class="ident" id="1462339">c</span><span class="op" id="1462340">.</span><span class="ident" id="1462341">lock</span><span class="op" id="1462345">,</span>&nbsp;<span class="string" id="1462347">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1462361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462366">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462402">if</span>&nbsp;<span class="ident" id="1462405">mysg</span><span class="op" id="1462409">.</span><span class="ident" id="1462410">releasetime</span>&nbsp;<span class="op" id="1462422">&gt;</span>&nbsp;<span class="num" id="1462424">0</span>&nbsp;<span class="op" id="1462426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462431">t1</span>&nbsp;<span class="op" id="1462434">=</span>&nbsp;<span class="ident" id="1462436">mysg</span><span class="op" id="1462440">.</span><span class="ident" id="1462441">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462459">releaseSudog</span><span class="op" id="1462471">(</span><span class="ident" id="1462472">mysg</span><span class="op" id="1462476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462480">lock</span><span class="op" id="1462484">(</span><span class="op" id="1462485">&amp;</span><span class="ident" id="1462486">c</span><span class="op" id="1462487">.</span><span class="ident" id="1462488">lock</span><span class="op" id="1462492">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462499">if</span>&nbsp;<span class="ident" id="1462502">raceenabled</span>&nbsp;<span class="op" id="1462514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462518">raceacquire</span><span class="op" id="1462529">(</span><span class="ident" id="1462530">chanbuf</span><span class="op" id="1462537">(</span><span class="ident" id="1462538">c</span><span class="op" id="1462539">,</span>&nbsp;<span class="ident" id="1462541">c</span><span class="op" id="1462542">.</span><span class="ident" id="1462543">recvx</span><span class="op" id="1462548">)</span><span class="op" id="1462549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462553">racerelease</span><span class="op" id="1462564">(</span><span class="ident" id="1462565">chanbuf</span><span class="op" id="1462572">(</span><span class="ident" id="1462573">c</span><span class="op" id="1462574">,</span>&nbsp;<span class="ident" id="1462576">c</span><span class="op" id="1462577">.</span><span class="ident" id="1462578">recvx</span><span class="op" id="1462583">)</span><span class="op" id="1462584">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462590">if</span>&nbsp;<span class="ident" id="1462593">ep</span>&nbsp;<span class="op" id="1462596">!=</span>&nbsp;<span class="builtintype" id="1462599">nil</span>&nbsp;<span class="op" id="1462603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462607">memmove</span><span class="op" id="1462614">(</span><span class="ident" id="1462615">ep</span><span class="op" id="1462617">,</span>&nbsp;<span class="ident" id="1462619">chanbuf</span><span class="op" id="1462626">(</span><span class="ident" id="1462627">c</span><span class="op" id="1462628">,</span>&nbsp;<span class="ident" id="1462630">c</span><span class="op" id="1462631">.</span><span class="ident" id="1462632">recvx</span><span class="op" id="1462637">)</span><span class="op" id="1462638">,</span>&nbsp;<span class="builtintype" id="1462640">uintptr</span><span class="op" id="1462647">(</span><span class="ident" id="1462648">c</span><span class="op" id="1462649">.</span><span class="ident" id="1462650">elemsize</span><span class="op" id="1462658">)</span><span class="op" id="1462659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462665">memclr</span><span class="op" id="1462671">(</span><span class="ident" id="1462672">chanbuf</span><span class="op" id="1462679">(</span><span class="ident" id="1462680">c</span><span class="op" id="1462681">,</span>&nbsp;<span class="ident" id="1462683">c</span><span class="op" id="1462684">.</span><span class="ident" id="1462685">recvx</span><span class="op" id="1462690">)</span><span class="op" id="1462691">,</span>&nbsp;<span class="builtintype" id="1462693">uintptr</span><span class="op" id="1462700">(</span><span class="ident" id="1462701">c</span><span class="op" id="1462702">.</span><span class="ident" id="1462703">elemsize</span><span class="op" id="1462711">)</span><span class="op" id="1462712">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462716">c</span><span class="op" id="1462717">.</span><span class="ident" id="1462718">recvx</span><span class="op" id="1462723">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462727">if</span>&nbsp;<span class="ident" id="1462730">c</span><span class="op" id="1462731">.</span><span class="ident" id="1462732">recvx</span>&nbsp;<span class="op" id="1462738">==</span>&nbsp;<span class="ident" id="1462741">c</span><span class="op" id="1462742">.</span><span class="ident" id="1462743">dataqsiz</span>&nbsp;<span class="op" id="1462752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462756">c</span><span class="op" id="1462757">.</span><span class="ident" id="1462758">recvx</span>&nbsp;<span class="op" id="1462764">=</span>&nbsp;<span class="num" id="1462766">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462769">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462772">c</span><span class="op" id="1462773">.</span><span class="ident" id="1462774">qcount</span><span class="op" id="1462780">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462785">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462827">sg</span>&nbsp;<span class="op" id="1462830">:=</span>&nbsp;<span class="ident" id="1462833">c</span><span class="op" id="1462834">.</span><span class="ident" id="1462835">sendq</span><span class="op" id="1462840">.</span><span class="ident" id="1462841">dequeue</span><span class="op" id="1462848">(</span><span class="op" id="1462849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462852">if</span>&nbsp;<span class="ident" id="1462855">sg</span>&nbsp;<span class="op" id="1462858">!=</span>&nbsp;<span class="builtintype" id="1462861">nil</span>&nbsp;<span class="op" id="1462865">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462869">gp</span>&nbsp;<span class="op" id="1462872">:=</span>&nbsp;<span class="ident" id="1462875">sg</span><span class="op" id="1462877">.</span><span class="ident" id="1462878">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462882">unlock</span><span class="op" id="1462888">(</span><span class="op" id="1462889">&amp;</span><span class="ident" id="1462890">c</span><span class="op" id="1462891">.</span><span class="ident" id="1462892">lock</span><span class="op" id="1462896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462900">if</span>&nbsp;<span class="ident" id="1462903">sg</span><span class="op" id="1462905">.</span><span class="ident" id="1462906">releasetime</span>&nbsp;<span class="op" id="1462918">!=</span>&nbsp;<span class="num" id="1462921">0</span>&nbsp;<span class="op" id="1462923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462928">sg</span><span class="op" id="1462930">.</span><span class="ident" id="1462931">releasetime</span>&nbsp;<span class="op" id="1462943">=</span>&nbsp;<span class="ident" id="1462945">cputicks</span><span class="op" id="1462953">(</span><span class="op" id="1462954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462958">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462962">goready</span><span class="op" id="1462969">(</span><span class="ident" id="1462970">gp</span><span class="op" id="1462972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462975">}</span>&nbsp;<span class="keyword" id="1462977">else</span>&nbsp;<span class="op" id="1462982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462986">unlock</span><span class="op" id="1462992">(</span><span class="op" id="1462993">&amp;</span><span class="ident" id="1462994">c</span><span class="op" id="1462995">.</span><span class="ident" id="1462996">lock</span><span class="op" id="1463000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463007">if</span>&nbsp;<span class="ident" id="1463010">t1</span>&nbsp;<span class="op" id="1463013">&gt;</span>&nbsp;<span class="num" id="1463015">0</span>&nbsp;<span class="op" id="1463017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463021">blockevent</span><span class="op" id="1463031">(</span><span class="ident" id="1463032">t1</span><span class="op" id="1463034">-</span><span class="ident" id="1463035">t0</span><span class="op" id="1463037">,</span>&nbsp;<span class="num" id="1463039">2</span><span class="op" id="1463040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463046">selected</span>&nbsp;<span class="op" id="1463055">=</span>&nbsp;<span class="builtintype" id="1463057">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463063">received</span>&nbsp;<span class="op" id="1463072">=</span>&nbsp;<span class="builtintype" id="1463074">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463080">return</span><br>
<span class="lineno"></span><span class="op" id="1463087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1463090">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1463156">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1463206">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1463268">func</span>&nbsp;<span class="ident" id="1463273">recvclosed</span><span class="op" id="1463283">(</span><span class="ident" id="1463284">c</span>&nbsp;<span class="op" id="1463286">*</span><span class="ident" id="1463287">hchan</span><span class="op" id="1463292">,</span>&nbsp;<span class="ident" id="1463294">ep</span>&nbsp;<span class="ident" id="1463297">unsafe</span><span class="op" id="1463303">.</span><span class="ident" id="1463304">Pointer</span><span class="op" id="1463311">)</span>&nbsp;<span class="op" id="1463313">(</span><span class="ident" id="1463314">selected</span><span class="op" id="1463322">,</span>&nbsp;<span class="ident" id="1463324">recevied</span>&nbsp;<span class="builtintype" id="1463333">bool</span><span class="op" id="1463337">)</span>&nbsp;<span class="op" id="1463339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463342">if</span>&nbsp;<span class="ident" id="1463345">raceenabled</span>&nbsp;<span class="op" id="1463357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463361">raceacquire</span><span class="op" id="1463372">(</span><span class="ident" id="1463373">unsafe</span><span class="op" id="1463379">.</span><span class="ident" id="1463380">Pointer</span><span class="op" id="1463387">(</span><span class="ident" id="1463388">c</span><span class="op" id="1463389">)</span><span class="op" id="1463390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463393">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463396">unlock</span><span class="op" id="1463402">(</span><span class="op" id="1463403">&amp;</span><span class="ident" id="1463404">c</span><span class="op" id="1463405">.</span><span class="ident" id="1463406">lock</span><span class="op" id="1463410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463413">if</span>&nbsp;<span class="ident" id="1463416">ep</span>&nbsp;<span class="op" id="1463419">!=</span>&nbsp;<span class="builtintype" id="1463422">nil</span>&nbsp;<span class="op" id="1463426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463430">memclr</span><span class="op" id="1463436">(</span><span class="ident" id="1463437">ep</span><span class="op" id="1463439">,</span>&nbsp;<span class="builtintype" id="1463441">uintptr</span><span class="op" id="1463448">(</span><span class="ident" id="1463449">c</span><span class="op" id="1463450">.</span><span class="ident" id="1463451">elemsize</span><span class="op" id="1463459">)</span><span class="op" id="1463460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463466">return</span>&nbsp;<span class="builtintype" id="1463473">true</span><span class="op" id="1463477">,</span>&nbsp;<span class="builtintype" id="1463479">false</span><br>
<span class="lineno">525</span><span class="op" id="1463485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1463488">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1463511">//</span><br>
<span class="lineno"></span><span class="comment" id="1463514">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1463526">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1463542">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1463554">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1463566">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1463578">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">535</span><span class="comment" id="1463583">//</span><br>
<span class="lineno"></span><span class="comment" id="1463586">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1463592">//</span><br>
<span class="lineno"></span><span class="comment" id="1463595">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1463622">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1463634">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1463646">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1463658">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1463663">//</span><br>
<span class="lineno"></span><span class="keyword" id="1463666">func</span>&nbsp;<span class="ident" id="1463671">selectnbsend</span><span class="op" id="1463683">(</span><span class="ident" id="1463684">t</span>&nbsp;<span class="op" id="1463686">*</span><span class="ident" id="1463687">chantype</span><span class="op" id="1463695">,</span>&nbsp;<span class="ident" id="1463697">c</span>&nbsp;<span class="op" id="1463699">*</span><span class="ident" id="1463700">hchan</span><span class="op" id="1463705">,</span>&nbsp;<span class="ident" id="1463707">elem</span>&nbsp;<span class="ident" id="1463712">unsafe</span><span class="op" id="1463718">.</span><span class="ident" id="1463719">Pointer</span><span class="op" id="1463726">)</span>&nbsp;<span class="op" id="1463728">(</span><span class="ident" id="1463729">selected</span>&nbsp;<span class="builtintype" id="1463738">bool</span><span class="op" id="1463742">)</span>&nbsp;<span class="op" id="1463744">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463747">return</span>&nbsp;<span class="ident" id="1463754">chansend</span><span class="op" id="1463762">(</span><span class="ident" id="1463763">t</span><span class="op" id="1463764">,</span>&nbsp;<span class="ident" id="1463766">c</span><span class="op" id="1463767">,</span>&nbsp;<span class="ident" id="1463769">elem</span><span class="op" id="1463773">,</span>&nbsp;<span class="builtintype" id="1463775">false</span><span class="op" id="1463780">,</span>&nbsp;<span class="ident" id="1463782">getcallerpc</span><span class="op" id="1463793">(</span><span class="ident" id="1463794">unsafe</span><span class="op" id="1463800">.</span><span class="ident" id="1463801">Pointer</span><span class="op" id="1463808">(</span><span class="op" id="1463809">&amp;</span><span class="ident" id="1463810">t</span><span class="op" id="1463811">)</span><span class="op" id="1463812">)</span><span class="op" id="1463813">)</span><br>
<span class="lineno"></span><span class="op" id="1463815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1463818">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1463841">//</span><br>
<span class="lineno">550</span><span class="comment" id="1463844">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1463856">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1463873">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1463885">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1463897">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1463909">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1463914">//</span><br>
<span class="lineno"></span><span class="comment" id="1463917">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1463923">//</span><br>
<span class="lineno"></span><span class="comment" id="1463926">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1463954">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1463966">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1463978">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1463990">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1463995">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1463998">func</span>&nbsp;<span class="ident" id="1464003">selectnbrecv</span><span class="op" id="1464015">(</span><span class="ident" id="1464016">t</span>&nbsp;<span class="op" id="1464018">*</span><span class="ident" id="1464019">chantype</span><span class="op" id="1464027">,</span>&nbsp;<span class="ident" id="1464029">elem</span>&nbsp;<span class="ident" id="1464034">unsafe</span><span class="op" id="1464040">.</span><span class="ident" id="1464041">Pointer</span><span class="op" id="1464048">,</span>&nbsp;<span class="ident" id="1464050">c</span>&nbsp;<span class="op" id="1464052">*</span><span class="ident" id="1464053">hchan</span><span class="op" id="1464058">)</span>&nbsp;<span class="op" id="1464060">(</span><span class="ident" id="1464061">selected</span>&nbsp;<span class="builtintype" id="1464070">bool</span><span class="op" id="1464074">)</span>&nbsp;<span class="op" id="1464076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464079">selected</span><span class="op" id="1464087">,</span>&nbsp;<span class="ident" id="1464089">_</span>&nbsp;<span class="op" id="1464091">=</span>&nbsp;<span class="ident" id="1464093">chanrecv</span><span class="op" id="1464101">(</span><span class="ident" id="1464102">t</span><span class="op" id="1464103">,</span>&nbsp;<span class="ident" id="1464105">c</span><span class="op" id="1464106">,</span>&nbsp;<span class="ident" id="1464108">elem</span><span class="op" id="1464112">,</span>&nbsp;<span class="builtintype" id="1464114">false</span><span class="op" id="1464119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464122">return</span><br>
<span class="lineno"></span><span class="op" id="1464129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1464132">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1464155">//</span><br>
<span class="lineno"></span><span class="comment" id="1464158">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1464170">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1464191">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1464203">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1464215">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1464227">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1464232">//</span><br>
<span class="lineno"></span><span class="comment" id="1464235">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1464241">//</span><br>
<span class="lineno"></span><span class="comment" id="1464244">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1464290">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1464302">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1464314">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1464326">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1464331">//</span><br>
<span class="lineno"></span><span class="keyword" id="1464334">func</span>&nbsp;<span class="ident" id="1464339">selectnbrecv2</span><span class="op" id="1464352">(</span><span class="ident" id="1464353">t</span>&nbsp;<span class="op" id="1464355">*</span><span class="ident" id="1464356">chantype</span><span class="op" id="1464364">,</span>&nbsp;<span class="ident" id="1464366">elem</span>&nbsp;<span class="ident" id="1464371">unsafe</span><span class="op" id="1464377">.</span><span class="ident" id="1464378">Pointer</span><span class="op" id="1464385">,</span>&nbsp;<span class="ident" id="1464387">received</span>&nbsp;<span class="op" id="1464396">*</span><span class="builtintype" id="1464397">bool</span><span class="op" id="1464401">,</span>&nbsp;<span class="ident" id="1464403">c</span>&nbsp;<span class="op" id="1464405">*</span><span class="ident" id="1464406">hchan</span><span class="op" id="1464411">)</span>&nbsp;<span class="op" id="1464413">(</span><span class="ident" id="1464414">selected</span>&nbsp;<span class="builtintype" id="1464423">bool</span><span class="op" id="1464427">)</span>&nbsp;<span class="op" id="1464429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464432">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464510">selected</span><span class="op" id="1464518">,</span>&nbsp;<span class="op" id="1464520">*</span><span class="ident" id="1464521">received</span>&nbsp;<span class="op" id="1464530">=</span>&nbsp;<span class="ident" id="1464532">chanrecv</span><span class="op" id="1464540">(</span><span class="ident" id="1464541">t</span><span class="op" id="1464542">,</span>&nbsp;<span class="ident" id="1464544">c</span><span class="op" id="1464545">,</span>&nbsp;<span class="ident" id="1464547">elem</span><span class="op" id="1464551">,</span>&nbsp;<span class="builtintype" id="1464553">false</span><span class="op" id="1464558">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464561">return</span><br>
<span class="lineno"></span><span class="op" id="1464568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1464571">func</span>&nbsp;<span class="ident" id="1464576">reflect_chansend</span><span class="op" id="1464592">(</span><span class="ident" id="1464593">t</span>&nbsp;<span class="op" id="1464595">*</span><span class="ident" id="1464596">chantype</span><span class="op" id="1464604">,</span>&nbsp;<span class="ident" id="1464606">c</span>&nbsp;<span class="op" id="1464608">*</span><span class="ident" id="1464609">hchan</span><span class="op" id="1464614">,</span>&nbsp;<span class="ident" id="1464616">elem</span>&nbsp;<span class="ident" id="1464621">unsafe</span><span class="op" id="1464627">.</span><span class="ident" id="1464628">Pointer</span><span class="op" id="1464635">,</span>&nbsp;<span class="ident" id="1464637">nb</span>&nbsp;<span class="builtintype" id="1464640">bool</span><span class="op" id="1464644">)</span>&nbsp;<span class="op" id="1464646">(</span><span class="ident" id="1464647">selected</span>&nbsp;<span class="builtintype" id="1464656">bool</span><span class="op" id="1464660">)</span>&nbsp;<span class="op" id="1464662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464665">return</span>&nbsp;<span class="ident" id="1464672">chansend</span><span class="op" id="1464680">(</span><span class="ident" id="1464681">t</span><span class="op" id="1464682">,</span>&nbsp;<span class="ident" id="1464684">c</span><span class="op" id="1464685">,</span>&nbsp;<span class="ident" id="1464687">elem</span><span class="op" id="1464691">,</span>&nbsp;<span class="op" id="1464693">!</span><span class="ident" id="1464694">nb</span><span class="op" id="1464696">,</span>&nbsp;<span class="ident" id="1464698">getcallerpc</span><span class="op" id="1464709">(</span><span class="ident" id="1464710">unsafe</span><span class="op" id="1464716">.</span><span class="ident" id="1464717">Pointer</span><span class="op" id="1464724">(</span><span class="op" id="1464725">&amp;</span><span class="ident" id="1464726">t</span><span class="op" id="1464727">)</span><span class="op" id="1464728">)</span><span class="op" id="1464729">)</span><br>
<span class="lineno">595</span><span class="op" id="1464731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1464734">func</span>&nbsp;<span class="ident" id="1464739">reflect_chanrecv</span><span class="op" id="1464755">(</span><span class="ident" id="1464756">t</span>&nbsp;<span class="op" id="1464758">*</span><span class="ident" id="1464759">chantype</span><span class="op" id="1464767">,</span>&nbsp;<span class="ident" id="1464769">c</span>&nbsp;<span class="op" id="1464771">*</span><span class="ident" id="1464772">hchan</span><span class="op" id="1464777">,</span>&nbsp;<span class="ident" id="1464779">nb</span>&nbsp;<span class="builtintype" id="1464782">bool</span><span class="op" id="1464786">,</span>&nbsp;<span class="ident" id="1464788">elem</span>&nbsp;<span class="ident" id="1464793">unsafe</span><span class="op" id="1464799">.</span><span class="ident" id="1464800">Pointer</span><span class="op" id="1464807">)</span>&nbsp;<span class="op" id="1464809">(</span><span class="ident" id="1464810">selected</span>&nbsp;<span class="builtintype" id="1464819">bool</span><span class="op" id="1464823">,</span>&nbsp;<span class="ident" id="1464825">received</span>&nbsp;<span class="builtintype" id="1464834">bool</span><span class="op" id="1464838">)</span>&nbsp;<span class="op" id="1464840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464843">return</span>&nbsp;<span class="ident" id="1464850">chanrecv</span><span class="op" id="1464858">(</span><span class="ident" id="1464859">t</span><span class="op" id="1464860">,</span>&nbsp;<span class="ident" id="1464862">c</span><span class="op" id="1464863">,</span>&nbsp;<span class="ident" id="1464865">elem</span><span class="op" id="1464869">,</span>&nbsp;<span class="op" id="1464871">!</span><span class="ident" id="1464872">nb</span><span class="op" id="1464874">)</span><br>
<span class="lineno"></span><span class="op" id="1464876">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1464879">func</span>&nbsp;<span class="ident" id="1464884">reflect_chanlen</span><span class="op" id="1464899">(</span><span class="ident" id="1464900">c</span>&nbsp;<span class="op" id="1464902">*</span><span class="ident" id="1464903">hchan</span><span class="op" id="1464908">)</span>&nbsp;<span class="builtintype" id="1464910">int</span>&nbsp;<span class="op" id="1464914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464917">if</span>&nbsp;<span class="ident" id="1464920">c</span>&nbsp;<span class="op" id="1464922">==</span>&nbsp;<span class="builtintype" id="1464925">nil</span>&nbsp;<span class="op" id="1464929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464933">return</span>&nbsp;<span class="num" id="1464940">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464943">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464946">return</span>&nbsp;<span class="builtintype" id="1464953">int</span><span class="op" id="1464956">(</span><span class="ident" id="1464957">c</span><span class="op" id="1464958">.</span><span class="ident" id="1464959">qcount</span><span class="op" id="1464965">)</span><br>
<span class="lineno"></span><span class="op" id="1464967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1464970">func</span>&nbsp;<span class="ident" id="1464975">reflect_chancap</span><span class="op" id="1464990">(</span><span class="ident" id="1464991">c</span>&nbsp;<span class="op" id="1464993">*</span><span class="ident" id="1464994">hchan</span><span class="op" id="1464999">)</span>&nbsp;<span class="builtintype" id="1465001">int</span>&nbsp;<span class="op" id="1465005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465008">if</span>&nbsp;<span class="ident" id="1465011">c</span>&nbsp;<span class="op" id="1465013">==</span>&nbsp;<span class="builtintype" id="1465016">nil</span>&nbsp;<span class="op" id="1465020">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465024">return</span>&nbsp;<span class="num" id="1465031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465037">return</span>&nbsp;<span class="builtintype" id="1465044">int</span><span class="op" id="1465047">(</span><span class="ident" id="1465048">c</span><span class="op" id="1465049">.</span><span class="ident" id="1465050">dataqsiz</span><span class="op" id="1465058">)</span><br>
<span class="lineno"></span><span class="op" id="1465060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1465063">func</span>&nbsp;<span class="op" id="1465068">(</span><span class="ident" id="1465069">q</span>&nbsp;<span class="op" id="1465071">*</span><span class="ident" id="1465072">waitq</span><span class="op" id="1465077">)</span>&nbsp;<span class="ident" id="1465079">enqueue</span><span class="op" id="1465086">(</span><span class="ident" id="1465087">sgp</span>&nbsp;<span class="op" id="1465091">*</span><span class="ident" id="1465092">sudog</span><span class="op" id="1465097">)</span>&nbsp;<span class="op" id="1465099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465102">sgp</span><span class="op" id="1465105">.</span><span class="ident" id="1465106">next</span>&nbsp;<span class="op" id="1465111">=</span>&nbsp;<span class="builtintype" id="1465113">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465118">if</span>&nbsp;<span class="ident" id="1465121">q</span><span class="op" id="1465122">.</span><span class="ident" id="1465123">first</span>&nbsp;<span class="op" id="1465129">==</span>&nbsp;<span class="builtintype" id="1465132">nil</span>&nbsp;<span class="op" id="1465136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465140">q</span><span class="op" id="1465141">.</span><span class="ident" id="1465142">first</span>&nbsp;<span class="op" id="1465148">=</span>&nbsp;<span class="ident" id="1465150">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465156">q</span><span class="op" id="1465157">.</span><span class="ident" id="1465158">last</span>&nbsp;<span class="op" id="1465163">=</span>&nbsp;<span class="ident" id="1465165">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465171">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465182">q</span><span class="op" id="1465183">.</span><span class="ident" id="1465184">last</span><span class="op" id="1465188">.</span><span class="ident" id="1465189">next</span>&nbsp;<span class="op" id="1465194">=</span>&nbsp;<span class="ident" id="1465196">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465201">q</span><span class="op" id="1465202">.</span><span class="ident" id="1465203">last</span>&nbsp;<span class="op" id="1465208">=</span>&nbsp;<span class="ident" id="1465210">sgp</span><br>
<span class="lineno"></span><span class="op" id="1465214">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1465217">func</span>&nbsp;<span class="op" id="1465222">(</span><span class="ident" id="1465223">q</span>&nbsp;<span class="op" id="1465225">*</span><span class="ident" id="1465226">waitq</span><span class="op" id="1465231">)</span>&nbsp;<span class="ident" id="1465233">dequeue</span><span class="op" id="1465240">(</span><span class="op" id="1465241">)</span>&nbsp;<span class="op" id="1465243">*</span><span class="ident" id="1465244">sudog</span>&nbsp;<span class="op" id="1465250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465253">for</span>&nbsp;<span class="op" id="1465257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465261">sgp</span>&nbsp;<span class="op" id="1465265">:=</span>&nbsp;<span class="ident" id="1465268">q</span><span class="op" id="1465269">.</span><span class="ident" id="1465270">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465278">if</span>&nbsp;<span class="ident" id="1465281">sgp</span>&nbsp;<span class="op" id="1465285">==</span>&nbsp;<span class="builtintype" id="1465288">nil</span>&nbsp;<span class="op" id="1465292">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465297">return</span>&nbsp;<span class="builtintype" id="1465304">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465314">q</span><span class="op" id="1465315">.</span><span class="ident" id="1465316">first</span>&nbsp;<span class="op" id="1465322">=</span>&nbsp;<span class="ident" id="1465324">sgp</span><span class="op" id="1465327">.</span><span class="ident" id="1465328">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465335">sgp</span><span class="op" id="1465338">.</span><span class="ident" id="1465339">next</span>&nbsp;<span class="op" id="1465344">=</span>&nbsp;<span class="builtintype" id="1465346">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465352">if</span>&nbsp;<span class="ident" id="1465355">q</span><span class="op" id="1465356">.</span><span class="ident" id="1465357">last</span>&nbsp;<span class="op" id="1465362">==</span>&nbsp;<span class="ident" id="1465365">sgp</span>&nbsp;<span class="op" id="1465369">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465374">q</span><span class="op" id="1465375">.</span><span class="ident" id="1465376">last</span>&nbsp;<span class="op" id="1465381">=</span>&nbsp;<span class="builtintype" id="1465383">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465394">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465466">if</span>&nbsp;<span class="ident" id="1465469">sgp</span><span class="op" id="1465472">.</span><span class="ident" id="1465473">selectdone</span>&nbsp;<span class="op" id="1465484">!=</span>&nbsp;<span class="builtintype" id="1465487">nil</span>&nbsp;<span class="op" id="1465491">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465496">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465528">if</span>&nbsp;<span class="op" id="1465531">*</span><span class="ident" id="1465532">sgp</span><span class="op" id="1465535">.</span><span class="ident" id="1465536">selectdone</span>&nbsp;<span class="op" id="1465547">!=</span>&nbsp;<span class="num" id="1465550">0</span>&nbsp;<span class="op" id="1465552">||</span>&nbsp;<span class="op" id="1465555">!</span><span class="ident" id="1465556">cas</span><span class="op" id="1465559">(</span><span class="ident" id="1465560">sgp</span><span class="op" id="1465563">.</span><span class="ident" id="1465564">selectdone</span><span class="op" id="1465574">,</span>&nbsp;<span class="num" id="1465576">0</span><span class="op" id="1465577">,</span>&nbsp;<span class="num" id="1465579">1</span><span class="op" id="1465580">)</span>&nbsp;<span class="op" id="1465582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465588">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465604">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465609">return</span>&nbsp;<span class="ident" id="1465616">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465621">}</span><br>
<span class="lineno"></span><span class="op" id="1465623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1465626">func</span>&nbsp;<span class="ident" id="1465631">racesync</span><span class="op" id="1465639">(</span><span class="ident" id="1465640">c</span>&nbsp;<span class="op" id="1465642">*</span><span class="ident" id="1465643">hchan</span><span class="op" id="1465648">,</span>&nbsp;<span class="ident" id="1465650">sg</span>&nbsp;<span class="op" id="1465653">*</span><span class="ident" id="1465654">sudog</span><span class="op" id="1465659">)</span>&nbsp;<span class="op" id="1465661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465664">racerelease</span><span class="op" id="1465675">(</span><span class="ident" id="1465676">chanbuf</span><span class="op" id="1465683">(</span><span class="ident" id="1465684">c</span><span class="op" id="1465685">,</span>&nbsp;<span class="num" id="1465687">0</span><span class="op" id="1465688">)</span><span class="op" id="1465689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465692">raceacquireg</span><span class="op" id="1465704">(</span><span class="ident" id="1465705">sg</span><span class="op" id="1465707">.</span><span class="ident" id="1465708">g</span><span class="op" id="1465709">,</span>&nbsp;<span class="ident" id="1465711">chanbuf</span><span class="op" id="1465718">(</span><span class="ident" id="1465719">c</span><span class="op" id="1465720">,</span>&nbsp;<span class="num" id="1465722">0</span><span class="op" id="1465723">)</span><span class="op" id="1465724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465727">racereleaseg</span><span class="op" id="1465739">(</span><span class="ident" id="1465740">sg</span><span class="op" id="1465742">.</span><span class="ident" id="1465743">g</span><span class="op" id="1465744">,</span>&nbsp;<span class="ident" id="1465746">chanbuf</span><span class="op" id="1465753">(</span><span class="ident" id="1465754">c</span><span class="op" id="1465755">,</span>&nbsp;<span class="num" id="1465757">0</span><span class="op" id="1465758">)</span><span class="op" id="1465759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465762">raceacquire</span><span class="op" id="1465773">(</span><span class="ident" id="1465774">chanbuf</span><span class="op" id="1465781">(</span><span class="ident" id="1465782">c</span><span class="op" id="1465783">,</span>&nbsp;<span class="num" id="1465785">0</span><span class="op" id="1465786">)</span><span class="op" id="1465787">)</span><br>
<span class="lineno">655</span><span class="op" id="1465789">}</span>
</div>
</body>
</html>
