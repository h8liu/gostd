<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5903474">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5903529">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5903583">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5903634">package</span>&nbsp;<span class="ident" id="5903642">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5903647">import</span>&nbsp;<span class="op" id="5903654">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5903657">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5903666">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5903676">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5903683">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5903688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5903691">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5903736">type</span>&nbsp;<span class="ident" id="5903741">writer</span>&nbsp;<span class="keyword" id="5903748">interface</span>&nbsp;<span class="op" id="5903758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903761">io</span><span class="op" id="5903763">.</span><span class="ident" id="5903764">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903776">Flush</span><span class="op" id="5903781">(</span><span class="op" id="5903782">)</span>&nbsp;<span class="builtintype" id="5903784">error</span><br>
<span class="lineno"></span><span class="op" id="5903790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5903793">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5903870">type</span>&nbsp;<span class="ident" id="5903875">errWriteCloser</span>&nbsp;<span class="keyword" id="5903890">struct</span>&nbsp;<span class="op" id="5903897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5903900">err</span>&nbsp;<span class="builtintype" id="5903904">error</span><br>
<span class="lineno"></span><span class="op" id="5903910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5903913">func</span>&nbsp;<span class="op" id="5903918">(</span><span class="ident" id="5903919">e</span>&nbsp;<span class="op" id="5903921">*</span><span class="ident" id="5903922">errWriteCloser</span><span class="op" id="5903936">)</span>&nbsp;<span class="ident" id="5903938">Write</span><span class="op" id="5903943">(</span><span class="op" id="5903944">[</span><span class="op" id="5903945">]</span><span class="builtintype" id="5903946">byte</span><span class="op" id="5903950">)</span>&nbsp;<span class="op" id="5903952">(</span><span class="builtintype" id="5903953">int</span><span class="op" id="5903956">,</span>&nbsp;<span class="builtintype" id="5903958">error</span><span class="op" id="5903963">)</span>&nbsp;<span class="op" id="5903965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5903968">return</span>&nbsp;<span class="num" id="5903975">0</span><span class="op" id="5903976">,</span>&nbsp;<span class="ident" id="5903978">e</span><span class="op" id="5903979">.</span><span class="ident" id="5903980">err</span><br>
<span class="lineno"></span><span class="op" id="5903984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5903987">func</span>&nbsp;<span class="op" id="5903992">(</span><span class="ident" id="5903993">e</span>&nbsp;<span class="op" id="5903995">*</span><span class="ident" id="5903996">errWriteCloser</span><span class="op" id="5904010">)</span>&nbsp;<span class="ident" id="5904012">Close</span><span class="op" id="5904017">(</span><span class="op" id="5904018">)</span>&nbsp;<span class="builtintype" id="5904020">error</span>&nbsp;<span class="op" id="5904026">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5904029">return</span>&nbsp;<span class="ident" id="5904036">e</span><span class="op" id="5904037">.</span><span class="ident" id="5904038">err</span><br>
<span class="lineno"></span><span class="op" id="5904042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5904045">const</span>&nbsp;<span class="op" id="5904051">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904054">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904126">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904167">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5904179">=</span>&nbsp;<span class="num" id="5904181">1</span><span class="op" id="5904182">&lt;&lt;</span><span class="num" id="5904184">12</span>&nbsp;<span class="op" id="5904187">-</span>&nbsp;<span class="num" id="5904189">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904192">invalidCode</span>&nbsp;<span class="op" id="5904204">=</span>&nbsp;<span class="num" id="5904206">1</span><span class="op" id="5904207">&lt;&lt;</span><span class="num" id="5904209">32</span>&nbsp;<span class="op" id="5904212">-</span>&nbsp;<span class="num" id="5904214">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904217">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904294">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904373">tableSize</span>&nbsp;<span class="op" id="5904383">=</span>&nbsp;<span class="num" id="5904385">4</span>&nbsp;<span class="op" id="5904387">*</span>&nbsp;<span class="num" id="5904389">1</span>&nbsp;<span class="op" id="5904391">&lt;&lt;</span>&nbsp;<span class="num" id="5904394">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904398">tableMask</span>&nbsp;<span class="op" id="5904408">=</span>&nbsp;<span class="ident" id="5904410">tableSize</span>&nbsp;<span class="op" id="5904420">-</span>&nbsp;<span class="num" id="5904422">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904425">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904496">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904559">invalidEntry</span>&nbsp;<span class="op" id="5904572">=</span>&nbsp;<span class="num" id="5904574">0</span><br>
<span class="lineno">45</span><span class="op" id="5904576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5904579">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5904609">type</span>&nbsp;<span class="ident" id="5904614">encoder</span>&nbsp;<span class="keyword" id="5904622">struct</span>&nbsp;<span class="op" id="5904629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904632">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904690">w</span>&nbsp;<span class="ident" id="5904692">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904700">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904758">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904807">order</span>&nbsp;<span class="ident" id="5904813">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904820">write</span>&nbsp;<span class="keyword" id="5904826">func</span><span class="op" id="5904830">(</span><span class="op" id="5904831">*</span><span class="ident" id="5904832">encoder</span><span class="op" id="5904839">,</span>&nbsp;<span class="builtintype" id="5904841">uint32</span><span class="op" id="5904847">)</span>&nbsp;<span class="builtintype" id="5904849">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904856">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5904862">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904870">nBits</span>&nbsp;<span class="builtintype" id="5904876">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904882">width</span>&nbsp;<span class="builtintype" id="5904888">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904894">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5904946">litWidth</span>&nbsp;<span class="builtintype" id="5904955">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5904961">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905015">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905078">hi</span><span class="op" id="5905080">,</span>&nbsp;<span class="ident" id="5905082">overflow</span>&nbsp;<span class="builtintype" id="5905091">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905099">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905173">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905237">savedCode</span>&nbsp;<span class="builtintype" id="5905247">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905255">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905330">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905384">err</span>&nbsp;<span class="builtintype" id="5905388">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905395">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905469">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905542">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5905613">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905647">table</span>&nbsp;<span class="op" id="5905653">[</span><span class="ident" id="5905654">tableSize</span><span class="op" id="5905663">]</span><span class="builtintype" id="5905664">uint32</span><br>
<span class="lineno"></span><span class="op" id="5905671">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5905674">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5905745">func</span>&nbsp;<span class="op" id="5905750">(</span><span class="ident" id="5905751">e</span>&nbsp;<span class="op" id="5905753">*</span><span class="ident" id="5905754">encoder</span><span class="op" id="5905761">)</span>&nbsp;<span class="ident" id="5905763">writeLSB</span><span class="op" id="5905771">(</span><span class="ident" id="5905772">c</span>&nbsp;<span class="builtintype" id="5905774">uint32</span><span class="op" id="5905780">)</span>&nbsp;<span class="builtintype" id="5905782">error</span>&nbsp;<span class="op" id="5905788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905791">e</span><span class="op" id="5905792">.</span><span class="ident" id="5905793">bits</span>&nbsp;<span class="op" id="5905798">|=</span>&nbsp;<span class="ident" id="5905801">c</span>&nbsp;<span class="op" id="5905803">&lt;&lt;</span>&nbsp;<span class="ident" id="5905806">e</span><span class="op" id="5905807">.</span><span class="ident" id="5905808">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905815">e</span><span class="op" id="5905816">.</span><span class="ident" id="5905817">nBits</span>&nbsp;<span class="op" id="5905823">+=</span>&nbsp;<span class="ident" id="5905826">e</span><span class="op" id="5905827">.</span><span class="ident" id="5905828">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905835">for</span>&nbsp;<span class="ident" id="5905839">e</span><span class="op" id="5905840">.</span><span class="ident" id="5905841">nBits</span>&nbsp;<span class="op" id="5905847">&gt;=</span>&nbsp;<span class="num" id="5905850">8</span>&nbsp;<span class="op" id="5905852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905856">if</span>&nbsp;<span class="ident" id="5905859">err</span>&nbsp;<span class="op" id="5905863">:=</span>&nbsp;<span class="ident" id="5905866">e</span><span class="op" id="5905867">.</span><span class="ident" id="5905868">w</span><span class="op" id="5905869">.</span><span class="ident" id="5905870">WriteByte</span><span class="op" id="5905879">(</span><span class="builtintype" id="5905880">uint8</span><span class="op" id="5905885">(</span><span class="ident" id="5905886">e</span><span class="op" id="5905887">.</span><span class="ident" id="5905888">bits</span><span class="op" id="5905892">)</span><span class="op" id="5905893">)</span><span class="op" id="5905894">;</span>&nbsp;<span class="ident" id="5905896">err</span>&nbsp;<span class="op" id="5905900">!=</span>&nbsp;<span class="builtintype" id="5905903">nil</span>&nbsp;<span class="op" id="5905907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905912">return</span>&nbsp;<span class="ident" id="5905919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905929">e</span><span class="op" id="5905930">.</span><span class="ident" id="5905931">bits</span>&nbsp;<span class="op" id="5905936">&gt;&gt;=</span>&nbsp;<span class="num" id="5905940">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905944">e</span><span class="op" id="5905945">.</span><span class="ident" id="5905946">nBits</span>&nbsp;<span class="op" id="5905952">-=</span>&nbsp;<span class="num" id="5905955">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5905958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5905961">return</span>&nbsp;<span class="builtintype" id="5905968">nil</span><br>
<span class="lineno"></span><span class="op" id="5905972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5905975">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5906045">func</span>&nbsp;<span class="op" id="5906050">(</span><span class="ident" id="5906051">e</span>&nbsp;<span class="op" id="5906053">*</span><span class="ident" id="5906054">encoder</span><span class="op" id="5906061">)</span>&nbsp;<span class="ident" id="5906063">writeMSB</span><span class="op" id="5906071">(</span><span class="ident" id="5906072">c</span>&nbsp;<span class="builtintype" id="5906074">uint32</span><span class="op" id="5906080">)</span>&nbsp;<span class="builtintype" id="5906082">error</span>&nbsp;<span class="op" id="5906088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906091">e</span><span class="op" id="5906092">.</span><span class="ident" id="5906093">bits</span>&nbsp;<span class="op" id="5906098">|=</span>&nbsp;<span class="ident" id="5906101">c</span>&nbsp;<span class="op" id="5906103">&lt;&lt;</span>&nbsp;<span class="op" id="5906106">(</span><span class="num" id="5906107">32</span>&nbsp;<span class="op" id="5906110">-</span>&nbsp;<span class="ident" id="5906112">e</span><span class="op" id="5906113">.</span><span class="ident" id="5906114">width</span>&nbsp;<span class="op" id="5906120">-</span>&nbsp;<span class="ident" id="5906122">e</span><span class="op" id="5906123">.</span><span class="ident" id="5906124">nBits</span><span class="op" id="5906129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906132">e</span><span class="op" id="5906133">.</span><span class="ident" id="5906134">nBits</span>&nbsp;<span class="op" id="5906140">+=</span>&nbsp;<span class="ident" id="5906143">e</span><span class="op" id="5906144">.</span><span class="ident" id="5906145">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906152">for</span>&nbsp;<span class="ident" id="5906156">e</span><span class="op" id="5906157">.</span><span class="ident" id="5906158">nBits</span>&nbsp;<span class="op" id="5906164">&gt;=</span>&nbsp;<span class="num" id="5906167">8</span>&nbsp;<span class="op" id="5906169">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906173">if</span>&nbsp;<span class="ident" id="5906176">err</span>&nbsp;<span class="op" id="5906180">:=</span>&nbsp;<span class="ident" id="5906183">e</span><span class="op" id="5906184">.</span><span class="ident" id="5906185">w</span><span class="op" id="5906186">.</span><span class="ident" id="5906187">WriteByte</span><span class="op" id="5906196">(</span><span class="builtintype" id="5906197">uint8</span><span class="op" id="5906202">(</span><span class="ident" id="5906203">e</span><span class="op" id="5906204">.</span><span class="ident" id="5906205">bits</span>&nbsp;<span class="op" id="5906210">&gt;&gt;</span>&nbsp;<span class="num" id="5906213">24</span><span class="op" id="5906215">)</span><span class="op" id="5906216">)</span><span class="op" id="5906217">;</span>&nbsp;<span class="ident" id="5906219">err</span>&nbsp;<span class="op" id="5906223">!=</span>&nbsp;<span class="builtintype" id="5906226">nil</span>&nbsp;<span class="op" id="5906230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906235">return</span>&nbsp;<span class="ident" id="5906242">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906252">e</span><span class="op" id="5906253">.</span><span class="ident" id="5906254">bits</span>&nbsp;<span class="op" id="5906259">&lt;&lt;=</span>&nbsp;<span class="num" id="5906263">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906267">e</span><span class="op" id="5906268">.</span><span class="ident" id="5906269">nBits</span>&nbsp;<span class="op" id="5906275">-=</span>&nbsp;<span class="num" id="5906278">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906284">return</span>&nbsp;<span class="builtintype" id="5906291">nil</span><br>
<span class="lineno"></span><span class="op" id="5906295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5906298">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5906376">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5906435">var</span>&nbsp;<span class="ident" id="5906439">errOutOfCodes</span>&nbsp;<span class="op" id="5906453">=</span>&nbsp;<span class="ident" id="5906455">errors</span><span class="op" id="5906461">.</span><span class="ident" id="5906462">New</span><span class="op" id="5906465">(</span><span class="string" id="5906466">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5906485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5906488">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5906561">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5906635">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5906679">func</span>&nbsp;<span class="op" id="5906684">(</span><span class="ident" id="5906685">e</span>&nbsp;<span class="op" id="5906687">*</span><span class="ident" id="5906688">encoder</span><span class="op" id="5906695">)</span>&nbsp;<span class="ident" id="5906697">incHi</span><span class="op" id="5906702">(</span><span class="op" id="5906703">)</span>&nbsp;<span class="builtintype" id="5906705">error</span>&nbsp;<span class="op" id="5906711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906714">e</span><span class="op" id="5906715">.</span><span class="ident" id="5906716">hi</span><span class="op" id="5906718">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906722">if</span>&nbsp;<span class="ident" id="5906725">e</span><span class="op" id="5906726">.</span><span class="ident" id="5906727">hi</span>&nbsp;<span class="op" id="5906730">==</span>&nbsp;<span class="ident" id="5906733">e</span><span class="op" id="5906734">.</span><span class="ident" id="5906735">overflow</span>&nbsp;<span class="op" id="5906744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906748">e</span><span class="op" id="5906749">.</span><span class="ident" id="5906750">width</span><span class="op" id="5906755">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906760">e</span><span class="op" id="5906761">.</span><span class="ident" id="5906762">overflow</span>&nbsp;<span class="op" id="5906771">&lt;&lt;=</span>&nbsp;<span class="num" id="5906775">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906781">if</span>&nbsp;<span class="ident" id="5906784">e</span><span class="op" id="5906785">.</span><span class="ident" id="5906786">hi</span>&nbsp;<span class="op" id="5906789">==</span>&nbsp;<span class="ident" id="5906792">maxCode</span>&nbsp;<span class="op" id="5906800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906804">clear</span>&nbsp;<span class="op" id="5906810">:=</span>&nbsp;<span class="builtintype" id="5906813">uint32</span><span class="op" id="5906819">(</span><span class="num" id="5906820">1</span><span class="op" id="5906821">)</span>&nbsp;<span class="op" id="5906823">&lt;&lt;</span>&nbsp;<span class="ident" id="5906826">e</span><span class="op" id="5906827">.</span><span class="ident" id="5906828">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906839">if</span>&nbsp;<span class="ident" id="5906842">err</span>&nbsp;<span class="op" id="5906846">:=</span>&nbsp;<span class="ident" id="5906849">e</span><span class="op" id="5906850">.</span><span class="ident" id="5906851">write</span><span class="op" id="5906856">(</span><span class="ident" id="5906857">e</span><span class="op" id="5906858">,</span>&nbsp;<span class="ident" id="5906860">clear</span><span class="op" id="5906865">)</span><span class="op" id="5906866">;</span>&nbsp;<span class="ident" id="5906868">err</span>&nbsp;<span class="op" id="5906872">!=</span>&nbsp;<span class="builtintype" id="5906875">nil</span>&nbsp;<span class="op" id="5906879">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906884">return</span>&nbsp;<span class="ident" id="5906891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5906897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906901">e</span><span class="op" id="5906902">.</span><span class="ident" id="5906903">width</span>&nbsp;<span class="op" id="5906909">=</span>&nbsp;<span class="builtintype" id="5906911">uint</span><span class="op" id="5906915">(</span><span class="ident" id="5906916">e</span><span class="op" id="5906917">.</span><span class="ident" id="5906918">litWidth</span><span class="op" id="5906926">)</span>&nbsp;<span class="op" id="5906928">+</span>&nbsp;<span class="num" id="5906930">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906934">e</span><span class="op" id="5906935">.</span><span class="ident" id="5906936">hi</span>&nbsp;<span class="op" id="5906939">=</span>&nbsp;<span class="ident" id="5906941">clear</span>&nbsp;<span class="op" id="5906947">+</span>&nbsp;<span class="num" id="5906949">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5906953">e</span><span class="op" id="5906954">.</span><span class="ident" id="5906955">overflow</span>&nbsp;<span class="op" id="5906964">=</span>&nbsp;<span class="ident" id="5906966">clear</span>&nbsp;<span class="op" id="5906972">&lt;&lt;</span>&nbsp;<span class="num" id="5906975">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5906979">for</span>&nbsp;<span class="ident" id="5906983">i</span>&nbsp;<span class="op" id="5906985">:=</span>&nbsp;<span class="keyword" id="5906988">range</span>&nbsp;<span class="ident" id="5906994">e</span><span class="op" id="5906995">.</span><span class="ident" id="5906996">table</span>&nbsp;<span class="op" id="5907002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907007">e</span><span class="op" id="5907008">.</span><span class="ident" id="5907009">table</span><span class="op" id="5907014">[</span><span class="ident" id="5907015">i</span><span class="op" id="5907016">]</span>&nbsp;<span class="op" id="5907018">=</span>&nbsp;<span class="ident" id="5907020">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907039">return</span>&nbsp;<span class="ident" id="5907046">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907061">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907064">return</span>&nbsp;<span class="builtintype" id="5907071">nil</span><br>
<span class="lineno"></span><span class="op" id="5907075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5907078">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5907153">func</span>&nbsp;<span class="op" id="5907158">(</span><span class="ident" id="5907159">e</span>&nbsp;<span class="op" id="5907161">*</span><span class="ident" id="5907162">encoder</span><span class="op" id="5907169">)</span>&nbsp;<span class="ident" id="5907171">Write</span><span class="op" id="5907176">(</span><span class="ident" id="5907177">p</span>&nbsp;<span class="op" id="5907179">[</span><span class="op" id="5907180">]</span><span class="builtintype" id="5907181">byte</span><span class="op" id="5907185">)</span>&nbsp;<span class="op" id="5907187">(</span><span class="ident" id="5907188">n</span>&nbsp;<span class="builtintype" id="5907190">int</span><span class="op" id="5907193">,</span>&nbsp;<span class="ident" id="5907195">err</span>&nbsp;<span class="builtintype" id="5907199">error</span><span class="op" id="5907204">)</span>&nbsp;<span class="op" id="5907206">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907209">if</span>&nbsp;<span class="ident" id="5907212">e</span><span class="op" id="5907213">.</span><span class="ident" id="5907214">err</span>&nbsp;<span class="op" id="5907218">!=</span>&nbsp;<span class="builtintype" id="5907221">nil</span>&nbsp;<span class="op" id="5907225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907229">return</span>&nbsp;<span class="num" id="5907236">0</span><span class="op" id="5907237">,</span>&nbsp;<span class="ident" id="5907239">e</span><span class="op" id="5907240">.</span><span class="ident" id="5907241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907249">if</span>&nbsp;<span class="builtinfunc" id="5907252">len</span><span class="op" id="5907255">(</span><span class="ident" id="5907256">p</span><span class="op" id="5907257">)</span>&nbsp;<span class="op" id="5907259">==</span>&nbsp;<span class="num" id="5907262">0</span>&nbsp;<span class="op" id="5907264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907268">return</span>&nbsp;<span class="num" id="5907275">0</span><span class="op" id="5907276">,</span>&nbsp;<span class="builtintype" id="5907278">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907286">n</span>&nbsp;<span class="op" id="5907288">=</span>&nbsp;<span class="builtinfunc" id="5907290">len</span><span class="op" id="5907293">(</span><span class="ident" id="5907294">p</span><span class="op" id="5907295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907298">litMask</span>&nbsp;<span class="op" id="5907306">:=</span>&nbsp;<span class="builtintype" id="5907309">uint32</span><span class="op" id="5907315">(</span><span class="num" id="5907316">1</span><span class="op" id="5907317">&lt;&lt;</span><span class="ident" id="5907319">e</span><span class="op" id="5907320">.</span><span class="ident" id="5907321">litWidth</span>&nbsp;<span class="op" id="5907330">-</span>&nbsp;<span class="num" id="5907332">1</span><span class="op" id="5907333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907336">code</span>&nbsp;<span class="op" id="5907341">:=</span>&nbsp;<span class="ident" id="5907344">e</span><span class="op" id="5907345">.</span><span class="ident" id="5907346">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907357">if</span>&nbsp;<span class="ident" id="5907360">code</span>&nbsp;<span class="op" id="5907365">==</span>&nbsp;<span class="ident" id="5907368">invalidCode</span>&nbsp;<span class="op" id="5907380">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5907384">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907435">code</span><span class="op" id="5907439">,</span>&nbsp;<span class="ident" id="5907441">p</span>&nbsp;<span class="op" id="5907443">=</span>&nbsp;<span class="builtintype" id="5907445">uint32</span><span class="op" id="5907451">(</span><span class="ident" id="5907452">p</span><span class="op" id="5907453">[</span><span class="num" id="5907454">0</span><span class="op" id="5907455">]</span><span class="op" id="5907456">)</span><span class="op" id="5907457">&amp;</span><span class="ident" id="5907458">litMask</span><span class="op" id="5907465">,</span>&nbsp;<span class="ident" id="5907467">p</span><span class="op" id="5907468">[</span><span class="num" id="5907469">1</span><span class="op" id="5907470">:</span><span class="op" id="5907471">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907474">}</span><br>
<span class="lineno"></span><span class="ident" id="5907476">loop</span><span class="op" id="5907480">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907483">for</span>&nbsp;<span class="ident" id="5907487">_</span><span class="op" id="5907488">,</span>&nbsp;<span class="ident" id="5907490">x</span>&nbsp;<span class="op" id="5907492">:=</span>&nbsp;<span class="keyword" id="5907495">range</span>&nbsp;<span class="ident" id="5907501">p</span>&nbsp;<span class="op" id="5907503">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907507">literal</span>&nbsp;<span class="op" id="5907515">:=</span>&nbsp;<span class="builtintype" id="5907518">uint32</span><span class="op" id="5907524">(</span><span class="ident" id="5907525">x</span><span class="op" id="5907526">)</span>&nbsp;<span class="op" id="5907528">&amp;</span>&nbsp;<span class="ident" id="5907530">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907540">key</span>&nbsp;<span class="op" id="5907544">:=</span>&nbsp;<span class="ident" id="5907547">code</span><span class="op" id="5907551">&lt;&lt;</span><span class="num" id="5907553">8</span>&nbsp;<span class="op" id="5907555">|</span>&nbsp;<span class="ident" id="5907557">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5907567">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5907640">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907673">hash</span>&nbsp;<span class="op" id="5907678">:=</span>&nbsp;<span class="op" id="5907681">(</span><span class="ident" id="5907682">key</span><span class="op" id="5907685">&gt;&gt;</span><span class="num" id="5907687">12</span>&nbsp;<span class="op" id="5907690">^</span>&nbsp;<span class="ident" id="5907692">key</span><span class="op" id="5907695">)</span>&nbsp;<span class="op" id="5907697">&amp;</span>&nbsp;<span class="ident" id="5907699">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907711">for</span>&nbsp;<span class="ident" id="5907715">h</span><span class="op" id="5907716">,</span>&nbsp;<span class="ident" id="5907718">t</span>&nbsp;<span class="op" id="5907720">:=</span>&nbsp;<span class="ident" id="5907723">hash</span><span class="op" id="5907727">,</span>&nbsp;<span class="ident" id="5907729">e</span><span class="op" id="5907730">.</span><span class="ident" id="5907731">table</span><span class="op" id="5907736">[</span><span class="ident" id="5907737">hash</span><span class="op" id="5907741">]</span><span class="op" id="5907742">;</span>&nbsp;<span class="ident" id="5907744">t</span>&nbsp;<span class="op" id="5907746">!=</span>&nbsp;<span class="ident" id="5907749">invalidEntry</span><span class="op" id="5907761">;</span>&nbsp;<span class="op" id="5907763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907768">if</span>&nbsp;<span class="ident" id="5907771">key</span>&nbsp;<span class="op" id="5907775">==</span>&nbsp;<span class="ident" id="5907778">t</span><span class="op" id="5907779">&gt;&gt;</span><span class="num" id="5907781">12</span>&nbsp;<span class="op" id="5907784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907790">code</span>&nbsp;<span class="op" id="5907795">=</span>&nbsp;<span class="ident" id="5907797">t</span>&nbsp;<span class="op" id="5907799">&amp;</span>&nbsp;<span class="ident" id="5907801">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907813">continue</span>&nbsp;<span class="ident" id="5907822">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907830">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907835">h</span>&nbsp;<span class="op" id="5907837">=</span>&nbsp;<span class="op" id="5907839">(</span><span class="ident" id="5907840">h</span>&nbsp;<span class="op" id="5907842">+</span>&nbsp;<span class="num" id="5907844">1</span><span class="op" id="5907845">)</span>&nbsp;<span class="op" id="5907847">&amp;</span>&nbsp;<span class="ident" id="5907849">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5907862">t</span>&nbsp;<span class="op" id="5907864">=</span>&nbsp;<span class="ident" id="5907866">e</span><span class="op" id="5907867">.</span><span class="ident" id="5907868">table</span><span class="op" id="5907873">[</span><span class="ident" id="5907874">h</span><span class="op" id="5907875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5907879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5907883">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5907956">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5907984">if</span>&nbsp;<span class="ident" id="5907987">e</span><span class="op" id="5907988">.</span><span class="ident" id="5907989">err</span>&nbsp;<span class="op" id="5907993">=</span>&nbsp;<span class="ident" id="5907995">e</span><span class="op" id="5907996">.</span><span class="ident" id="5907997">write</span><span class="op" id="5908002">(</span><span class="ident" id="5908003">e</span><span class="op" id="5908004">,</span>&nbsp;<span class="ident" id="5908006">code</span><span class="op" id="5908010">)</span><span class="op" id="5908011">;</span>&nbsp;<span class="ident" id="5908013">e</span><span class="op" id="5908014">.</span><span class="ident" id="5908015">err</span>&nbsp;<span class="op" id="5908019">!=</span>&nbsp;<span class="builtintype" id="5908022">nil</span>&nbsp;<span class="op" id="5908026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908031">return</span>&nbsp;<span class="num" id="5908038">0</span><span class="op" id="5908039">,</span>&nbsp;<span class="ident" id="5908041">e</span><span class="op" id="5908042">.</span><span class="ident" id="5908043">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908053">code</span>&nbsp;<span class="op" id="5908058">=</span>&nbsp;<span class="ident" id="5908060">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5908070">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5908144">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908217">if</span>&nbsp;<span class="ident" id="5908220">err1</span>&nbsp;<span class="op" id="5908225">:=</span>&nbsp;<span class="ident" id="5908228">e</span><span class="op" id="5908229">.</span><span class="ident" id="5908230">incHi</span><span class="op" id="5908235">(</span><span class="op" id="5908236">)</span><span class="op" id="5908237">;</span>&nbsp;<span class="ident" id="5908239">err1</span>&nbsp;<span class="op" id="5908244">!=</span>&nbsp;<span class="builtintype" id="5908247">nil</span>&nbsp;<span class="op" id="5908251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908256">if</span>&nbsp;<span class="ident" id="5908259">err1</span>&nbsp;<span class="op" id="5908264">==</span>&nbsp;<span class="ident" id="5908267">errOutOfCodes</span>&nbsp;<span class="op" id="5908281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908287">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908299">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908304">e</span><span class="op" id="5908305">.</span><span class="ident" id="5908306">err</span>&nbsp;<span class="op" id="5908310">=</span>&nbsp;<span class="ident" id="5908312">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908320">return</span>&nbsp;<span class="num" id="5908327">0</span><span class="op" id="5908328">,</span>&nbsp;<span class="ident" id="5908330">e</span><span class="op" id="5908331">.</span><span class="ident" id="5908332">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5908342">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908415">for</span>&nbsp;<span class="op" id="5908419">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908424">if</span>&nbsp;<span class="ident" id="5908427">e</span><span class="op" id="5908428">.</span><span class="ident" id="5908429">table</span><span class="op" id="5908434">[</span><span class="ident" id="5908435">hash</span><span class="op" id="5908439">]</span>&nbsp;<span class="op" id="5908441">==</span>&nbsp;<span class="ident" id="5908444">invalidEntry</span>&nbsp;<span class="op" id="5908457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908463">e</span><span class="op" id="5908464">.</span><span class="ident" id="5908465">table</span><span class="op" id="5908470">[</span><span class="ident" id="5908471">hash</span><span class="op" id="5908475">]</span>&nbsp;<span class="op" id="5908477">=</span>&nbsp;<span class="op" id="5908479">(</span><span class="ident" id="5908480">key</span>&nbsp;<span class="op" id="5908484">&lt;&lt;</span>&nbsp;<span class="num" id="5908487">12</span><span class="op" id="5908489">)</span>&nbsp;<span class="op" id="5908491">|</span>&nbsp;<span class="ident" id="5908493">e</span><span class="op" id="5908494">.</span><span class="ident" id="5908495">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908502">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908516">hash</span>&nbsp;<span class="op" id="5908521">=</span>&nbsp;<span class="op" id="5908523">(</span><span class="ident" id="5908524">hash</span>&nbsp;<span class="op" id="5908529">+</span>&nbsp;<span class="num" id="5908531">1</span><span class="op" id="5908532">)</span>&nbsp;<span class="op" id="5908534">&amp;</span>&nbsp;<span class="ident" id="5908536">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908554">e</span><span class="op" id="5908555">.</span><span class="ident" id="5908556">savedCode</span>&nbsp;<span class="op" id="5908566">=</span>&nbsp;<span class="ident" id="5908568">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908574">return</span>&nbsp;<span class="ident" id="5908581">n</span><span class="op" id="5908582">,</span>&nbsp;<span class="builtintype" id="5908584">nil</span><br>
<span class="lineno"></span><span class="op" id="5908588">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5908591">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5908670">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5908702">func</span>&nbsp;<span class="op" id="5908707">(</span><span class="ident" id="5908708">e</span>&nbsp;<span class="op" id="5908710">*</span><span class="ident" id="5908711">encoder</span><span class="op" id="5908718">)</span>&nbsp;<span class="ident" id="5908720">Close</span><span class="op" id="5908725">(</span><span class="op" id="5908726">)</span>&nbsp;<span class="builtintype" id="5908728">error</span>&nbsp;<span class="op" id="5908734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908737">if</span>&nbsp;<span class="ident" id="5908740">e</span><span class="op" id="5908741">.</span><span class="ident" id="5908742">err</span>&nbsp;<span class="op" id="5908746">!=</span>&nbsp;<span class="builtintype" id="5908749">nil</span>&nbsp;<span class="op" id="5908753">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908757">if</span>&nbsp;<span class="ident" id="5908760">e</span><span class="op" id="5908761">.</span><span class="ident" id="5908762">err</span>&nbsp;<span class="op" id="5908766">==</span>&nbsp;<span class="ident" id="5908769">errClosed</span>&nbsp;<span class="op" id="5908779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908784">return</span>&nbsp;<span class="builtintype" id="5908791">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908801">return</span>&nbsp;<span class="ident" id="5908808">e</span><span class="op" id="5908809">.</span><span class="ident" id="5908810">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5908815">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5908818">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5908871">e</span><span class="op" id="5908872">.</span><span class="ident" id="5908873">err</span>&nbsp;<span class="op" id="5908877">=</span>&nbsp;<span class="ident" id="5908879">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5908890">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908924">if</span>&nbsp;<span class="ident" id="5908927">e</span><span class="op" id="5908928">.</span><span class="ident" id="5908929">savedCode</span>&nbsp;<span class="op" id="5908939">!=</span>&nbsp;<span class="ident" id="5908942">invalidCode</span>&nbsp;<span class="op" id="5908954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5908958">if</span>&nbsp;<span class="ident" id="5908961">err</span>&nbsp;<span class="op" id="5908965">:=</span>&nbsp;<span class="ident" id="5908968">e</span><span class="op" id="5908969">.</span><span class="ident" id="5908970">write</span><span class="op" id="5908975">(</span><span class="ident" id="5908976">e</span><span class="op" id="5908977">,</span>&nbsp;<span class="ident" id="5908979">e</span><span class="op" id="5908980">.</span><span class="ident" id="5908981">savedCode</span><span class="op" id="5908990">)</span><span class="op" id="5908991">;</span>&nbsp;<span class="ident" id="5908993">err</span>&nbsp;<span class="op" id="5908997">!=</span>&nbsp;<span class="builtintype" id="5909000">nil</span>&nbsp;<span class="op" id="5909004">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909009">return</span>&nbsp;<span class="ident" id="5909016">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909026">if</span>&nbsp;<span class="ident" id="5909029">err</span>&nbsp;<span class="op" id="5909033">:=</span>&nbsp;<span class="ident" id="5909036">e</span><span class="op" id="5909037">.</span><span class="ident" id="5909038">incHi</span><span class="op" id="5909043">(</span><span class="op" id="5909044">)</span><span class="op" id="5909045">;</span>&nbsp;<span class="ident" id="5909047">err</span>&nbsp;<span class="op" id="5909051">!=</span>&nbsp;<span class="builtintype" id="5909054">nil</span>&nbsp;<span class="op" id="5909058">&amp;&amp;</span>&nbsp;<span class="ident" id="5909061">err</span>&nbsp;<span class="op" id="5909065">!=</span>&nbsp;<span class="ident" id="5909068">errOutOfCodes</span>&nbsp;<span class="op" id="5909082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909087">return</span>&nbsp;<span class="ident" id="5909094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909100">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5909106">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909130">eof</span>&nbsp;<span class="op" id="5909134">:=</span>&nbsp;<span class="builtintype" id="5909137">uint32</span><span class="op" id="5909143">(</span><span class="num" id="5909144">1</span><span class="op" id="5909145">)</span><span class="op" id="5909146">&lt;&lt;</span><span class="ident" id="5909148">e</span><span class="op" id="5909149">.</span><span class="ident" id="5909150">litWidth</span>&nbsp;<span class="op" id="5909159">+</span>&nbsp;<span class="num" id="5909161">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909164">if</span>&nbsp;<span class="ident" id="5909167">err</span>&nbsp;<span class="op" id="5909171">:=</span>&nbsp;<span class="ident" id="5909174">e</span><span class="op" id="5909175">.</span><span class="ident" id="5909176">write</span><span class="op" id="5909181">(</span><span class="ident" id="5909182">e</span><span class="op" id="5909183">,</span>&nbsp;<span class="ident" id="5909185">eof</span><span class="op" id="5909188">)</span><span class="op" id="5909189">;</span>&nbsp;<span class="ident" id="5909191">err</span>&nbsp;<span class="op" id="5909195">!=</span>&nbsp;<span class="builtintype" id="5909198">nil</span>&nbsp;<span class="op" id="5909202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909206">return</span>&nbsp;<span class="ident" id="5909213">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5909221">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909247">if</span>&nbsp;<span class="ident" id="5909250">e</span><span class="op" id="5909251">.</span><span class="ident" id="5909252">nBits</span>&nbsp;<span class="op" id="5909258">&gt;</span>&nbsp;<span class="num" id="5909260">0</span>&nbsp;<span class="op" id="5909262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909266">if</span>&nbsp;<span class="ident" id="5909269">e</span><span class="op" id="5909270">.</span><span class="ident" id="5909271">order</span>&nbsp;<span class="op" id="5909277">==</span>&nbsp;<span class="ident" id="5909280">MSB</span>&nbsp;<span class="op" id="5909284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909289">e</span><span class="op" id="5909290">.</span><span class="ident" id="5909291">bits</span>&nbsp;<span class="op" id="5909296">&gt;&gt;=</span>&nbsp;<span class="num" id="5909300">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909309">if</span>&nbsp;<span class="ident" id="5909312">err</span>&nbsp;<span class="op" id="5909316">:=</span>&nbsp;<span class="ident" id="5909319">e</span><span class="op" id="5909320">.</span><span class="ident" id="5909321">w</span><span class="op" id="5909322">.</span><span class="ident" id="5909323">WriteByte</span><span class="op" id="5909332">(</span><span class="builtintype" id="5909333">uint8</span><span class="op" id="5909338">(</span><span class="ident" id="5909339">e</span><span class="op" id="5909340">.</span><span class="ident" id="5909341">bits</span><span class="op" id="5909345">)</span><span class="op" id="5909346">)</span><span class="op" id="5909347">;</span>&nbsp;<span class="ident" id="5909349">err</span>&nbsp;<span class="op" id="5909353">!=</span>&nbsp;<span class="builtintype" id="5909356">nil</span>&nbsp;<span class="op" id="5909360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909365">return</span>&nbsp;<span class="ident" id="5909372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5909381">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909384">return</span>&nbsp;<span class="ident" id="5909391">e</span><span class="op" id="5909392">.</span><span class="ident" id="5909393">w</span><span class="op" id="5909394">.</span><span class="ident" id="5909395">Flush</span><span class="op" id="5909400">(</span><span class="op" id="5909401">)</span><br>
<span class="lineno"></span><span class="op" id="5909403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5909406">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5909449">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5909523">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5909598">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5909619">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5909692">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5909727">func</span>&nbsp;<span class="ident" id="5909732">NewWriter</span><span class="op" id="5909741">(</span><span class="ident" id="5909742">w</span>&nbsp;<span class="ident" id="5909744">io</span><span class="op" id="5909746">.</span><span class="ident" id="5909747">Writer</span><span class="op" id="5909753">,</span>&nbsp;<span class="ident" id="5909755">order</span>&nbsp;<span class="ident" id="5909761">Order</span><span class="op" id="5909766">,</span>&nbsp;<span class="ident" id="5909768">litWidth</span>&nbsp;<span class="builtintype" id="5909777">int</span><span class="op" id="5909780">)</span>&nbsp;<span class="ident" id="5909782">io</span><span class="op" id="5909784">.</span><span class="ident" id="5909785">WriteCloser</span>&nbsp;<span class="op" id="5909797">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909800">var</span>&nbsp;<span class="ident" id="5909804">write</span>&nbsp;<span class="keyword" id="5909810">func</span><span class="op" id="5909814">(</span><span class="op" id="5909815">*</span><span class="ident" id="5909816">encoder</span><span class="op" id="5909823">,</span>&nbsp;<span class="builtintype" id="5909825">uint32</span><span class="op" id="5909831">)</span>&nbsp;<span class="builtintype" id="5909833">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909840">switch</span>&nbsp;<span class="ident" id="5909847">order</span>&nbsp;<span class="op" id="5909853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909856">case</span>&nbsp;<span class="ident" id="5909861">LSB</span><span class="op" id="5909864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909868">write</span>&nbsp;<span class="op" id="5909874">=</span>&nbsp;<span class="op" id="5909876">(</span><span class="op" id="5909877">*</span><span class="ident" id="5909878">encoder</span><span class="op" id="5909885">)</span><span class="op" id="5909886">.</span><span class="ident" id="5909887">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909897">case</span>&nbsp;<span class="ident" id="5909902">MSB</span><span class="op" id="5909905">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5909909">write</span>&nbsp;<span class="op" id="5909915">=</span>&nbsp;<span class="op" id="5909917">(</span><span class="op" id="5909918">*</span><span class="ident" id="5909919">encoder</span><span class="op" id="5909926">)</span><span class="op" id="5909927">.</span><span class="ident" id="5909928">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909938">default</span><span class="op" id="5909945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5909949">return</span>&nbsp;<span class="op" id="5909956">&amp;</span><span class="ident" id="5909957">errWriteCloser</span><span class="op" id="5909971">{</span><span class="ident" id="5909972">errors</span><span class="op" id="5909978">.</span><span class="ident" id="5909979">New</span><span class="op" id="5909982">(</span><span class="string" id="5909983">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5910003">)</span><span class="op" id="5910004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910010">if</span>&nbsp;<span class="ident" id="5910013">litWidth</span>&nbsp;<span class="op" id="5910022">&lt;</span>&nbsp;<span class="num" id="5910024">2</span>&nbsp;<span class="op" id="5910026">||</span>&nbsp;<span class="num" id="5910029">8</span>&nbsp;<span class="op" id="5910031">&lt;</span>&nbsp;<span class="ident" id="5910033">litWidth</span>&nbsp;<span class="op" id="5910042">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910046">return</span>&nbsp;<span class="op" id="5910053">&amp;</span><span class="ident" id="5910054">errWriteCloser</span><span class="op" id="5910068">{</span><span class="ident" id="5910069">fmt</span><span class="op" id="5910072">.</span><span class="ident" id="5910073">Errorf</span><span class="op" id="5910079">(</span><span class="string" id="5910080">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5910111">,</span>&nbsp;<span class="ident" id="5910113">litWidth</span><span class="op" id="5910121">)</span><span class="op" id="5910122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910128">bw</span><span class="op" id="5910130">,</span>&nbsp;<span class="ident" id="5910132">ok</span>&nbsp;<span class="op" id="5910135">:=</span>&nbsp;<span class="ident" id="5910138">w</span><span class="op" id="5910139">.</span><span class="op" id="5910140">(</span><span class="ident" id="5910141">writer</span><span class="op" id="5910147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910150">if</span>&nbsp;<span class="op" id="5910153">!</span><span class="ident" id="5910154">ok</span>&nbsp;<span class="op" id="5910157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910161">bw</span>&nbsp;<span class="op" id="5910164">=</span>&nbsp;<span class="ident" id="5910166">bufio</span><span class="op" id="5910171">.</span><span class="ident" id="5910172">NewWriter</span><span class="op" id="5910181">(</span><span class="ident" id="5910182">w</span><span class="op" id="5910183">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910189">lw</span>&nbsp;<span class="op" id="5910192">:=</span>&nbsp;<span class="builtintype" id="5910195">uint</span><span class="op" id="5910199">(</span><span class="ident" id="5910200">litWidth</span><span class="op" id="5910208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5910211">return</span>&nbsp;<span class="op" id="5910218">&amp;</span><span class="ident" id="5910219">encoder</span><span class="op" id="5910226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910230">w</span><span class="op" id="5910231">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910241">bw</span><span class="op" id="5910243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910247">order</span><span class="op" id="5910252">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910258">order</span><span class="op" id="5910263">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910267">write</span><span class="op" id="5910272">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910278">write</span><span class="op" id="5910283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910287">width</span><span class="op" id="5910292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5910298">1</span>&nbsp;<span class="op" id="5910300">+</span>&nbsp;<span class="ident" id="5910302">lw</span><span class="op" id="5910304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910308">litWidth</span><span class="op" id="5910316">:</span>&nbsp;&nbsp;<span class="ident" id="5910319">lw</span><span class="op" id="5910321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910325">hi</span><span class="op" id="5910327">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5910336">1</span><span class="op" id="5910337">&lt;&lt;</span><span class="ident" id="5910339">lw</span>&nbsp;<span class="op" id="5910342">+</span>&nbsp;<span class="num" id="5910344">1</span><span class="op" id="5910345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910349">overflow</span><span class="op" id="5910357">:</span>&nbsp;&nbsp;<span class="num" id="5910360">1</span>&nbsp;<span class="op" id="5910362">&lt;&lt;</span>&nbsp;<span class="op" id="5910365">(</span><span class="ident" id="5910366">lw</span>&nbsp;<span class="op" id="5910369">+</span>&nbsp;<span class="num" id="5910371">1</span><span class="op" id="5910372">)</span><span class="op" id="5910373">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5910377">savedCode</span><span class="op" id="5910386">:</span>&nbsp;<span class="ident" id="5910388">invalidCode</span><span class="op" id="5910399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5910402">}</span><br>
<span class="lineno"></span><span class="op" id="5910404">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
