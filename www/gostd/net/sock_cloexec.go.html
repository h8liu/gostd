<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html" class="current">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3357483">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3357538">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3357592">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3357643">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;sysSocket&nbsp;and&nbsp;accept&nbsp;for&nbsp;platforms&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3357707">//&nbsp;provide&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;setting&nbsp;SetNonblock&nbsp;and&nbsp;CloseOnExec.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3357772">//&nbsp;+build&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3357797">package</span>&nbsp;<span class="ident" id="3357805">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3357810">import</span>&nbsp;<span class="string" id="3357817">&#34;syscall&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3357828">//&nbsp;Wrapper&nbsp;around&nbsp;the&nbsp;socket&nbsp;system&nbsp;call&nbsp;that&nbsp;marks&nbsp;the&nbsp;returned&nbsp;file</span><br>
<span class="lineno">15</span><span class="comment" id="3357898">//&nbsp;descriptor&nbsp;as&nbsp;nonblocking&nbsp;and&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="keyword" id="3357946">func</span>&nbsp;<span class="ident" id="3357951">sysSocket</span><span class="op" id="3357960">(</span><span class="ident" id="3357961">family</span><span class="op" id="3357967">,</span>&nbsp;<span class="ident" id="3357969">sotype</span><span class="op" id="3357975">,</span>&nbsp;<span class="ident" id="3357977">proto</span>&nbsp;<span class="builtintype" id="3357983">int</span><span class="op" id="3357986">)</span>&nbsp;<span class="op" id="3357988">(</span><span class="builtintype" id="3357989">int</span><span class="op" id="3357992">,</span>&nbsp;<span class="builtintype" id="3357994">error</span><span class="op" id="3357999">)</span>&nbsp;<span class="op" id="3358001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358004">s</span><span class="op" id="3358005">,</span>&nbsp;<span class="ident" id="3358007">err</span>&nbsp;<span class="op" id="3358011">:=</span>&nbsp;<span class="ident" id="3358014"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358021">.</span><span class="ident" id="3358022"><a href="/gostd/syscall/syscall_unix.go.html#2549902">Socket</a></span><span class="op" id="3358028">(</span><span class="ident" id="3358029"><a href="/gostd/net/sock_cloexec.go.html#3357961">family</a></span><span class="op" id="3358035">,</span>&nbsp;<span class="ident" id="3358037"><a href="/gostd/net/sock_cloexec.go.html#3357969">sotype</a></span><span class="op" id="3358043">|</span><span class="ident" id="3358044"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358051">.</span><span class="ident" id="3358052"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2591828">SOCK_NONBLOCK</a></span><span class="op" id="3358065">|</span><span class="ident" id="3358066"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358073">.</span><span class="ident" id="3358074"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2591704">SOCK_CLOEXEC</a></span><span class="op" id="3358086">,</span>&nbsp;<span class="ident" id="3358088"><a href="/gostd/net/sock_cloexec.go.html#3357977">proto</a></span><span class="op" id="3358093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358096">//&nbsp;On&nbsp;Linux&nbsp;the&nbsp;SOCK_NONBLOCK&nbsp;and&nbsp;SOCK_CLOEXEC&nbsp;flags&nbsp;were</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358155">//&nbsp;introduced&nbsp;in&nbsp;2.6.27&nbsp;kernel&nbsp;and&nbsp;on&nbsp;FreeBSD&nbsp;both&nbsp;flags&nbsp;were</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358218">//&nbsp;introduced&nbsp;in&nbsp;10&nbsp;kernel.&nbsp;If&nbsp;we&nbsp;get&nbsp;an&nbsp;EINVAL&nbsp;error&nbsp;on&nbsp;Linux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358282">//&nbsp;or&nbsp;EPROTONOSUPPORT&nbsp;error&nbsp;on&nbsp;FreeBSD,&nbsp;fall&nbsp;back&nbsp;to&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358342">//&nbsp;socket&nbsp;without&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358367">if</span>&nbsp;<span class="ident" id="3358370"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358374">==</span>&nbsp;<span class="builtintype" id="3358377">nil</span>&nbsp;<span class="op" id="3358381">||</span>&nbsp;<span class="op" id="3358384">(</span><span class="ident" id="3358385"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358389">!=</span>&nbsp;<span class="ident" id="3358392"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358399">.</span><span class="ident" id="3358400"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2603432">EPROTONOSUPPORT</a></span>&nbsp;<span class="op" id="3358416">&amp;&amp;</span>&nbsp;<span class="ident" id="3358419"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358423">!=</span>&nbsp;<span class="ident" id="3358426"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358433">.</span><span class="ident" id="3358434"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2601331">EINVAL</a></span><span class="op" id="3358440">)</span>&nbsp;<span class="op" id="3358442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358446">return</span>&nbsp;<span class="ident" id="3358453"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358454">,</span>&nbsp;<span class="ident" id="3358456"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3358461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3358465">//&nbsp;See&nbsp;../syscall/exec_unix.go&nbsp;for&nbsp;description&nbsp;of&nbsp;ForkLock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358526"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358533">.</span><span class="ident" id="3358534"><a href="/gostd/syscall/exec_unix.go.html#2491879">ForkLock</a></span><span class="op" id="3358542">.</span><span class="ident" id="3358543"><a href="/gostd/sync/rwmutex.go.html#1456490">RLock</a></span><span class="op" id="3358548">(</span><span class="op" id="3358549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358552"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358553">,</span>&nbsp;<span class="ident" id="3358555"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358559">=</span>&nbsp;<span class="ident" id="3358561"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358568">.</span><span class="ident" id="3358569"><a href="/gostd/syscall/syscall_unix.go.html#2549902">Socket</a></span><span class="op" id="3358575">(</span><span class="ident" id="3358576"><a href="/gostd/net/sock_cloexec.go.html#3357961">family</a></span><span class="op" id="3358582">,</span>&nbsp;<span class="ident" id="3358584"><a href="/gostd/net/sock_cloexec.go.html#3357969">sotype</a></span><span class="op" id="3358590">,</span>&nbsp;<span class="ident" id="3358592"><a href="/gostd/net/sock_cloexec.go.html#3357977">proto</a></span><span class="op" id="3358597">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358600">if</span>&nbsp;<span class="ident" id="3358603"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358607">==</span>&nbsp;<span class="builtintype" id="3358610">nil</span>&nbsp;<span class="op" id="3358614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358618"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358625">.</span><span class="ident" id="3358626"><a href="/gostd/syscall/exec_unix.go.html#2492669">CloseOnExec</a></span><span class="op" id="3358637">(</span><span class="ident" id="3358638"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3358642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358645"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358652">.</span><span class="ident" id="3358653"><a href="/gostd/syscall/exec_unix.go.html#2491879">ForkLock</a></span><span class="op" id="3358661">.</span><span class="ident" id="3358662"><a href="/gostd/sync/rwmutex.go.html#1456952">RUnlock</a></span><span class="op" id="3358669">(</span><span class="op" id="3358670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358673">if</span>&nbsp;<span class="ident" id="3358676"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358680">!=</span>&nbsp;<span class="builtintype" id="3358683">nil</span>&nbsp;<span class="op" id="3358687">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358691">return</span>&nbsp;<span class="op" id="3358698">-</span><span class="num" id="3358699">1</span><span class="op" id="3358700">,</span>&nbsp;<span class="ident" id="3358702"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3358707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358710">if</span>&nbsp;<span class="ident" id="3358713"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358717">=</span>&nbsp;<span class="ident" id="3358719"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358726">.</span><span class="ident" id="3358727"><a href="/gostd/syscall/exec_unix.go.html#2492730">SetNonblock</a></span><span class="op" id="3358738">(</span><span class="ident" id="3358739"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358740">,</span>&nbsp;<span class="builtintype" id="3358742">true</span><span class="op" id="3358746">)</span><span class="op" id="3358747">;</span>&nbsp;<span class="ident" id="3358749"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span>&nbsp;<span class="op" id="3358753">!=</span>&nbsp;<span class="builtintype" id="3358756">nil</span>&nbsp;<span class="op" id="3358760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358764"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358771">.</span><span class="ident" id="3358772"><a href="/gostd/syscall/zsyscall_linux_amd64.go.html#2616725">Close</a></span><span class="op" id="3358777">(</span><span class="ident" id="3358778"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358783">return</span>&nbsp;<span class="op" id="3358790">-</span><span class="num" id="3358791">1</span><span class="op" id="3358792">,</span>&nbsp;<span class="ident" id="3358794"><a href="/gostd/net/sock_cloexec.go.html#3358007">err</a></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3358799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3358802">return</span>&nbsp;<span class="ident" id="3358809"><a href="/gostd/net/sock_cloexec.go.html#3358004">s</a></span><span class="op" id="3358810">,</span>&nbsp;<span class="builtintype" id="3358812">nil</span><br>
<span class="lineno"></span><span class="op" id="3358816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3358819">//&nbsp;Wrapper&nbsp;around&nbsp;the&nbsp;accept&nbsp;system&nbsp;call&nbsp;that&nbsp;marks&nbsp;the&nbsp;returned&nbsp;file</span><br>
<span class="lineno">45</span><span class="comment" id="3358889">//&nbsp;descriptor&nbsp;as&nbsp;nonblocking&nbsp;and&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="keyword" id="3358937">func</span>&nbsp;<span class="ident" id="3358942">accept</span><span class="op" id="3358948">(</span><span class="ident" id="3358949">s</span>&nbsp;<span class="builtintype" id="3358951">int</span><span class="op" id="3358954">)</span>&nbsp;<span class="op" id="3358956">(</span><span class="builtintype" id="3358957">int</span><span class="op" id="3358960">,</span>&nbsp;<span class="ident" id="3358962"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3358969">.</span><span class="ident" id="3358970"><a href="/gostd/syscall/syscall_unix.go.html#2547075">Sockaddr</a></span><span class="op" id="3358978">,</span>&nbsp;<span class="builtintype" id="3358980">error</span><span class="op" id="3358985">)</span>&nbsp;<span class="op" id="3358987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3358990">ns</span><span class="op" id="3358992">,</span>&nbsp;<span class="ident" id="3358994">sa</span><span class="op" id="3358996">,</span>&nbsp;<span class="ident" id="3358998">err</span>&nbsp;<span class="op" id="3359002">:=</span>&nbsp;<span class="ident" id="3359005"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359012">.</span><span class="ident" id="3359013"><a href="/gostd/syscall/syscall_linux.go.html#2521907">Accept4</a></span><span class="op" id="3359020">(</span><span class="ident" id="3359021"><a href="/gostd/net/sock_cloexec.go.html#3358949">s</a></span><span class="op" id="3359022">,</span>&nbsp;<span class="ident" id="3359024"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359031">.</span><span class="ident" id="3359032"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2591828">SOCK_NONBLOCK</a></span><span class="op" id="3359045">|</span><span class="ident" id="3359046"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359053">.</span><span class="ident" id="3359054"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2591704">SOCK_CLOEXEC</a></span><span class="op" id="3359066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359069">//&nbsp;On&nbsp;Linux&nbsp;the&nbsp;accept4&nbsp;system&nbsp;call&nbsp;was&nbsp;introduced&nbsp;in&nbsp;2.6.28</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359131">//&nbsp;kernel&nbsp;and&nbsp;on&nbsp;FreeBSD&nbsp;it&nbsp;was&nbsp;introduced&nbsp;in&nbsp;10&nbsp;kernel.&nbsp;If&nbsp;we</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359195">//&nbsp;get&nbsp;an&nbsp;ENOSYS&nbsp;error&nbsp;on&nbsp;both&nbsp;Linux&nbsp;and&nbsp;FreeBSD,&nbsp;or&nbsp;EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359256">//&nbsp;error&nbsp;on&nbsp;Linux,&nbsp;fall&nbsp;back&nbsp;to&nbsp;using&nbsp;accept.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359303">switch</span>&nbsp;<span class="ident" id="3359310"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3359314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359317">default</span><span class="op" id="3359324">:</span>&nbsp;<span class="comment" id="3359326">//&nbsp;nil&nbsp;and&nbsp;errors&nbsp;other&nbsp;than&nbsp;the&nbsp;ones&nbsp;listed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359373">return</span>&nbsp;<span class="ident" id="3359380"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3359382">,</span>&nbsp;<span class="ident" id="3359384"><a href="/gostd/net/sock_cloexec.go.html#3358994">sa</a></span><span class="op" id="3359386">,</span>&nbsp;<span class="ident" id="3359388"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359393">case</span>&nbsp;<span class="ident" id="3359398"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359405">.</span><span class="ident" id="3359406"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2602846">ENOSYS</a></span><span class="op" id="3359412">:</span>&nbsp;<span class="comment" id="3359414">//&nbsp;syscall&nbsp;missing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359434">case</span>&nbsp;<span class="ident" id="3359439"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359446">.</span><span class="ident" id="3359447"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2601331">EINVAL</a></span><span class="op" id="3359453">:</span>&nbsp;<span class="comment" id="3359455">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359497">case</span>&nbsp;<span class="ident" id="3359502"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359509">.</span><span class="ident" id="3359510"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2600159">EACCES</a></span><span class="op" id="3359516">:</span>&nbsp;<span class="comment" id="3359518">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359560">case</span>&nbsp;<span class="ident" id="3359565"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359572">.</span><span class="ident" id="3359573"><a href="/gostd/syscall/zerrors_linux_amd64.go.html#2601085">EFAULT</a></span><span class="op" id="3359579">:</span>&nbsp;<span class="comment" id="3359581">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3359623">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359627">//&nbsp;See&nbsp;../syscall/exec_unix.go&nbsp;for&nbsp;description&nbsp;of&nbsp;ForkLock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359688">//&nbsp;It&nbsp;is&nbsp;probably&nbsp;okay&nbsp;to&nbsp;hold&nbsp;the&nbsp;lock&nbsp;across&nbsp;syscall.Accept</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359751">//&nbsp;because&nbsp;we&nbsp;have&nbsp;put&nbsp;fd.sysfd&nbsp;into&nbsp;non-blocking&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359808">//&nbsp;However,&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;File&nbsp;method&nbsp;will&nbsp;put&nbsp;it&nbsp;back&nbsp;into</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3359869">//&nbsp;blocking&nbsp;mode.&nbsp;We&nbsp;can&#39;t&nbsp;take&nbsp;that&nbsp;risk,&nbsp;so&nbsp;no&nbsp;use&nbsp;of&nbsp;ForkLock&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3359941"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3359943">,</span>&nbsp;<span class="ident" id="3359945"><a href="/gostd/net/sock_cloexec.go.html#3358994">sa</a></span><span class="op" id="3359947">,</span>&nbsp;<span class="ident" id="3359949"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3359953">=</span>&nbsp;<span class="ident" id="3359955"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359962">.</span><span class="ident" id="3359963"><a href="/gostd/syscall/syscall_linux.go.html#2521640">Accept</a></span><span class="op" id="3359969">(</span><span class="ident" id="3359970"><a href="/gostd/net/sock_cloexec.go.html#3358949">s</a></span><span class="op" id="3359971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3359974">if</span>&nbsp;<span class="ident" id="3359977"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3359981">==</span>&nbsp;<span class="builtintype" id="3359984">nil</span>&nbsp;<span class="op" id="3359988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3359992"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3359999">.</span><span class="ident" id="3360000"><a href="/gostd/syscall/exec_unix.go.html#2492669">CloseOnExec</a></span><span class="op" id="3360011">(</span><span class="ident" id="3360012"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3360014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3360017">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3360020">if</span>&nbsp;<span class="ident" id="3360023"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3360027">!=</span>&nbsp;<span class="builtintype" id="3360030">nil</span>&nbsp;<span class="op" id="3360034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3360038">return</span>&nbsp;<span class="op" id="3360045">-</span><span class="num" id="3360046">1</span><span class="op" id="3360047">,</span>&nbsp;<span class="builtintype" id="3360049">nil</span><span class="op" id="3360052">,</span>&nbsp;<span class="ident" id="3360054"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3360059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3360062">if</span>&nbsp;<span class="ident" id="3360065"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3360069">=</span>&nbsp;<span class="ident" id="3360071"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3360078">.</span><span class="ident" id="3360079"><a href="/gostd/syscall/exec_unix.go.html#2492730">SetNonblock</a></span><span class="op" id="3360090">(</span><span class="ident" id="3360091"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3360093">,</span>&nbsp;<span class="builtintype" id="3360095">true</span><span class="op" id="3360099">)</span><span class="op" id="3360100">;</span>&nbsp;<span class="ident" id="3360102"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span>&nbsp;<span class="op" id="3360106">!=</span>&nbsp;<span class="builtintype" id="3360109">nil</span>&nbsp;<span class="op" id="3360113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3360117"><a href="/gostd/net/sock_cloexec.go.html#3357817">syscall</a></span><span class="op" id="3360124">.</span><span class="ident" id="3360125"><a href="/gostd/syscall/zsyscall_linux_amd64.go.html#2616725">Close</a></span><span class="op" id="3360130">(</span><span class="ident" id="3360131"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3360133">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3360137">return</span>&nbsp;<span class="op" id="3360144">-</span><span class="num" id="3360145">1</span><span class="op" id="3360146">,</span>&nbsp;<span class="builtintype" id="3360148">nil</span><span class="op" id="3360151">,</span>&nbsp;<span class="ident" id="3360153"><a href="/gostd/net/sock_cloexec.go.html#3358998">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3360158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3360161">return</span>&nbsp;<span class="ident" id="3360168"><a href="/gostd/net/sock_cloexec.go.html#3358990">ns</a></span><span class="op" id="3360170">,</span>&nbsp;<span class="ident" id="3360172"><a href="/gostd/net/sock_cloexec.go.html#3358994">sa</a></span><span class="op" id="3360174">,</span>&nbsp;<span class="builtintype" id="3360176">nil</span><br>
<span class="lineno"></span><span class="op" id="3360180">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
