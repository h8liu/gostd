<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3754126">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3754181">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3754235">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3754286">package</span>&nbsp;<span class="ident" id="3754294">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3754305">import</span>&nbsp;<span class="op" id="3754312">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754315">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754324">&#34;crypto/rand&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754339">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754349">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754356">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754362">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3754379">&#34;strings&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3754389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3754392">//&nbsp;A&nbsp;Writer&nbsp;generates&nbsp;multipart&nbsp;messages.</span><br>
<span class="lineno"></span><span class="keyword" id="3754434">type</span>&nbsp;<span class="ident" id="3754439">Writer</span>&nbsp;<span class="keyword" id="3754446">struct</span>&nbsp;<span class="op" id="3754453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3754456">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754465">io</span><span class="op" id="3754467">.</span><span class="ident" id="3754468">Writer</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3754476">boundary</span>&nbsp;<span class="builtintype" id="3754485">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3754493">lastpart</span>&nbsp;<span class="op" id="3754502">*</span><span class="ident" id="3754503">part</span><br>
<span class="lineno"></span><span class="op" id="3754508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3754511">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Writer&nbsp;with&nbsp;a&nbsp;random&nbsp;boundary,</span><br>
<span class="lineno">25</span><span class="comment" id="3754579">//&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="3754596">func</span>&nbsp;<span class="ident" id="3754601">NewWriter</span><span class="op" id="3754610">(</span><span class="ident" id="3754611">w</span>&nbsp;<span class="ident" id="3754613">io</span><span class="op" id="3754615">.</span><span class="ident" id="3754616">Writer</span><span class="op" id="3754622">)</span>&nbsp;<span class="op" id="3754624">*</span><span class="ident" id="3754625">Writer</span>&nbsp;<span class="op" id="3754632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3754635">return</span>&nbsp;<span class="op" id="3754642">&amp;</span><span class="ident" id="3754643">Writer</span><span class="op" id="3754649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3754653">w</span><span class="op" id="3754654">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3754663">w</span><span class="op" id="3754664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3754668">boundary</span><span class="op" id="3754676">:</span>&nbsp;<span class="ident" id="3754678">randomBoundary</span><span class="op" id="3754692">(</span><span class="op" id="3754693">)</span><span class="op" id="3754694">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3754697">}</span><br>
<span class="lineno"></span><span class="op" id="3754699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3754702">//&nbsp;Boundary&nbsp;returns&nbsp;the&nbsp;Writer&#39;s&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="keyword" id="3754745">func</span>&nbsp;<span class="op" id="3754750">(</span><span class="ident" id="3754751">w</span>&nbsp;<span class="op" id="3754753">*</span><span class="ident" id="3754754">Writer</span><span class="op" id="3754760">)</span>&nbsp;<span class="ident" id="3754762">Boundary</span><span class="op" id="3754770">(</span><span class="op" id="3754771">)</span>&nbsp;<span class="builtintype" id="3754773">string</span>&nbsp;<span class="op" id="3754780">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3754783">return</span>&nbsp;<span class="ident" id="3754790">w</span><span class="op" id="3754791">.</span><span class="ident" id="3754792">boundary</span><br>
<span class="lineno"></span><span class="op" id="3754801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3754804">//&nbsp;SetBoundary&nbsp;overrides&nbsp;the&nbsp;Writer&#39;s&nbsp;default&nbsp;randomly-generated</span><br>
<span class="lineno"></span><span class="comment" id="3754869">//&nbsp;boundary&nbsp;separator&nbsp;with&nbsp;an&nbsp;explicit&nbsp;value.</span><br>
<span class="lineno">40</span><span class="comment" id="3754915">//</span><br>
<span class="lineno"></span><span class="comment" id="3754918">//&nbsp;SetBoundary&nbsp;must&nbsp;be&nbsp;called&nbsp;before&nbsp;any&nbsp;parts&nbsp;are&nbsp;created,&nbsp;may&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3754987">//&nbsp;contain&nbsp;certain&nbsp;ASCII&nbsp;characters,&nbsp;and&nbsp;must&nbsp;be&nbsp;1-69&nbsp;bytes&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="3755053">func</span>&nbsp;<span class="op" id="3755058">(</span><span class="ident" id="3755059">w</span>&nbsp;<span class="op" id="3755061">*</span><span class="ident" id="3755062">Writer</span><span class="op" id="3755068">)</span>&nbsp;<span class="ident" id="3755070">SetBoundary</span><span class="op" id="3755081">(</span><span class="ident" id="3755082">boundary</span>&nbsp;<span class="builtintype" id="3755091">string</span><span class="op" id="3755097">)</span>&nbsp;<span class="builtintype" id="3755099">error</span>&nbsp;<span class="op" id="3755105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755108">if</span>&nbsp;<span class="ident" id="3755111">w</span><span class="op" id="3755112">.</span><span class="ident" id="3755113">lastpart</span>&nbsp;<span class="op" id="3755122">!=</span>&nbsp;<span class="ident" id="3755125">nil</span>&nbsp;<span class="op" id="3755129">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755133">return</span>&nbsp;<span class="ident" id="3755140">errors</span><span class="op" id="3755146">.</span><span class="ident" id="3755147">New</span><span class="op" id="3755150">(</span><span class="string" id="3755151">&#34;mime:&nbsp;SetBoundary&nbsp;called&nbsp;after&nbsp;write&#34;</span><span class="op" id="3755189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3755195">//&nbsp;rfc2046#section-5.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755221">if</span>&nbsp;<span class="builtinfunc" id="3755224">len</span><span class="op" id="3755227">(</span><span class="ident" id="3755228">boundary</span><span class="op" id="3755236">)</span>&nbsp;<span class="op" id="3755238">&lt;</span>&nbsp;<span class="num" id="3755240">1</span>&nbsp;<span class="op" id="3755242">||</span>&nbsp;<span class="builtinfunc" id="3755245">len</span><span class="op" id="3755248">(</span><span class="ident" id="3755249">boundary</span><span class="op" id="3755257">)</span>&nbsp;<span class="op" id="3755259">&gt;</span>&nbsp;<span class="num" id="3755261">69</span>&nbsp;<span class="op" id="3755264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755268">return</span>&nbsp;<span class="ident" id="3755275">errors</span><span class="op" id="3755281">.</span><span class="ident" id="3755282">New</span><span class="op" id="3755285">(</span><span class="string" id="3755286">&#34;mime:&nbsp;invalid&nbsp;boundary&nbsp;length&#34;</span><span class="op" id="3755317">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755323">for</span>&nbsp;<span class="ident" id="3755327">_</span><span class="op" id="3755328">,</span>&nbsp;<span class="ident" id="3755330">b</span>&nbsp;<span class="op" id="3755332">:=</span>&nbsp;<span class="keyword" id="3755335">range</span>&nbsp;<span class="ident" id="3755341">boundary</span>&nbsp;<span class="op" id="3755350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755354">if</span>&nbsp;<span class="string" id="3755357">&#39;A&#39;</span>&nbsp;<span class="op" id="3755361">&lt;=</span>&nbsp;<span class="ident" id="3755364">b</span>&nbsp;<span class="op" id="3755366">&amp;&amp;</span>&nbsp;<span class="ident" id="3755369">b</span>&nbsp;<span class="op" id="3755371">&lt;=</span>&nbsp;<span class="string" id="3755374">&#39;Z&#39;</span>&nbsp;<span class="op" id="3755378">||</span>&nbsp;<span class="string" id="3755381">&#39;a&#39;</span>&nbsp;<span class="op" id="3755385">&lt;=</span>&nbsp;<span class="ident" id="3755388">b</span>&nbsp;<span class="op" id="3755390">&amp;&amp;</span>&nbsp;<span class="ident" id="3755393">b</span>&nbsp;<span class="op" id="3755395">&lt;=</span>&nbsp;<span class="string" id="3755398">&#39;z&#39;</span>&nbsp;<span class="op" id="3755402">||</span>&nbsp;<span class="string" id="3755405">&#39;0&#39;</span>&nbsp;<span class="op" id="3755409">&lt;=</span>&nbsp;<span class="ident" id="3755412">b</span>&nbsp;<span class="op" id="3755414">&amp;&amp;</span>&nbsp;<span class="ident" id="3755417">b</span>&nbsp;<span class="op" id="3755419">&lt;=</span>&nbsp;<span class="string" id="3755422">&#39;9&#39;</span>&nbsp;<span class="op" id="3755426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755431">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755442">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755446">switch</span>&nbsp;<span class="ident" id="3755453">b</span>&nbsp;<span class="op" id="3755455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755459">case</span>&nbsp;<span class="string" id="3755464">&#39;\&#39;&#39;</span><span class="op" id="3755468">,</span>&nbsp;<span class="string" id="3755470">&#39;(&#39;</span><span class="op" id="3755473">,</span>&nbsp;<span class="string" id="3755475">&#39;)&#39;</span><span class="op" id="3755478">,</span>&nbsp;<span class="string" id="3755480">&#39;+&#39;</span><span class="op" id="3755483">,</span>&nbsp;<span class="string" id="3755485">&#39;_&#39;</span><span class="op" id="3755488">,</span>&nbsp;<span class="string" id="3755490">&#39;,&#39;</span><span class="op" id="3755493">,</span>&nbsp;<span class="string" id="3755495">&#39;-&#39;</span><span class="op" id="3755498">,</span>&nbsp;<span class="string" id="3755500">&#39;.&#39;</span><span class="op" id="3755503">,</span>&nbsp;<span class="string" id="3755505">&#39;/&#39;</span><span class="op" id="3755508">,</span>&nbsp;<span class="string" id="3755510">&#39;:&#39;</span><span class="op" id="3755513">,</span>&nbsp;<span class="string" id="3755515">&#39;=&#39;</span><span class="op" id="3755518">,</span>&nbsp;<span class="string" id="3755520">&#39;?&#39;</span><span class="op" id="3755523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755528">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755543">return</span>&nbsp;<span class="ident" id="3755550">errors</span><span class="op" id="3755556">.</span><span class="ident" id="3755557">New</span><span class="op" id="3755560">(</span><span class="string" id="3755561">&#34;mime:&nbsp;invalid&nbsp;boundary&nbsp;character&#34;</span><span class="op" id="3755595">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3755601">w</span><span class="op" id="3755602">.</span><span class="ident" id="3755603">boundary</span>&nbsp;<span class="op" id="3755612">=</span>&nbsp;<span class="ident" id="3755614">boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755624">return</span>&nbsp;<span class="ident" id="3755631">nil</span><br>
<span class="lineno"></span><span class="op" id="3755635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3755638">//&nbsp;FormDataContentType&nbsp;returns&nbsp;the&nbsp;Content-Type&nbsp;for&nbsp;an&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="3755698">//&nbsp;multipart/form-data&nbsp;with&nbsp;this&nbsp;Writer&#39;s&nbsp;Boundary.</span><br>
<span class="lineno"></span><span class="keyword" id="3755750">func</span>&nbsp;<span class="op" id="3755755">(</span><span class="ident" id="3755756">w</span>&nbsp;<span class="op" id="3755758">*</span><span class="ident" id="3755759">Writer</span><span class="op" id="3755765">)</span>&nbsp;<span class="ident" id="3755767">FormDataContentType</span><span class="op" id="3755786">(</span><span class="op" id="3755787">)</span>&nbsp;<span class="builtintype" id="3755789">string</span>&nbsp;<span class="op" id="3755796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755799">return</span>&nbsp;<span class="string" id="3755806">&#34;multipart/form-data;&nbsp;boundary=&#34;</span>&nbsp;<span class="op" id="3755839">+</span>&nbsp;<span class="ident" id="3755841">w</span><span class="op" id="3755842">.</span><span class="ident" id="3755843">boundary</span><br>
<span class="lineno"></span><span class="op" id="3755852">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3755855">func</span>&nbsp;<span class="ident" id="3755860">randomBoundary</span><span class="op" id="3755874">(</span><span class="op" id="3755875">)</span>&nbsp;<span class="builtintype" id="3755877">string</span>&nbsp;<span class="op" id="3755884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755887">var</span>&nbsp;<span class="ident" id="3755891">buf</span>&nbsp;<span class="op" id="3755895">[</span><span class="num" id="3755896">30</span><span class="op" id="3755898">]</span><span class="builtintype" id="3755899">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3755905">_</span><span class="op" id="3755906">,</span>&nbsp;<span class="ident" id="3755908">err</span>&nbsp;<span class="op" id="3755912">:=</span>&nbsp;<span class="ident" id="3755915">io</span><span class="op" id="3755917">.</span><span class="ident" id="3755918">ReadFull</span><span class="op" id="3755926">(</span><span class="ident" id="3755927">rand</span><span class="op" id="3755931">.</span><span class="ident" id="3755932">Reader</span><span class="op" id="3755938">,</span>&nbsp;<span class="ident" id="3755940">buf</span><span class="op" id="3755943">[</span><span class="op" id="3755944">:</span><span class="op" id="3755945">]</span><span class="op" id="3755946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755949">if</span>&nbsp;<span class="ident" id="3755952">err</span>&nbsp;<span class="op" id="3755956">!=</span>&nbsp;<span class="ident" id="3755959">nil</span>&nbsp;<span class="op" id="3755963">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3755967">panic</span><span class="op" id="3755972">(</span><span class="ident" id="3755973">err</span><span class="op" id="3755976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3755979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3755982">return</span>&nbsp;<span class="ident" id="3755989">fmt</span><span class="op" id="3755992">.</span><span class="ident" id="3755993">Sprintf</span><span class="op" id="3756000">(</span><span class="string" id="3756001">&#34;%x&#34;</span><span class="op" id="3756005">,</span>&nbsp;<span class="ident" id="3756007">buf</span><span class="op" id="3756010">[</span><span class="op" id="3756011">:</span><span class="op" id="3756012">]</span><span class="op" id="3756013">)</span><br>
<span class="lineno"></span><span class="op" id="3756015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3756018">//&nbsp;CreatePart&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;section&nbsp;with&nbsp;the&nbsp;provided</span><br>
<span class="lineno"></span><span class="comment" id="3756082">//&nbsp;header.&nbsp;The&nbsp;body&nbsp;of&nbsp;the&nbsp;part&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;the&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="3756148">//&nbsp;Writer.&nbsp;After&nbsp;calling&nbsp;CreatePart,&nbsp;any&nbsp;previous&nbsp;part&nbsp;may&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="3756217">//&nbsp;be&nbsp;written&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3756235">func</span>&nbsp;<span class="op" id="3756240">(</span><span class="ident" id="3756241">w</span>&nbsp;<span class="op" id="3756243">*</span><span class="ident" id="3756244">Writer</span><span class="op" id="3756250">)</span>&nbsp;<span class="ident" id="3756252">CreatePart</span><span class="op" id="3756262">(</span><span class="ident" id="3756263">header</span>&nbsp;<span class="ident" id="3756270">textproto</span><span class="op" id="3756279">.</span><span class="ident" id="3756280">MIMEHeader</span><span class="op" id="3756290">)</span>&nbsp;<span class="op" id="3756292">(</span><span class="ident" id="3756293">io</span><span class="op" id="3756295">.</span><span class="ident" id="3756296">Writer</span><span class="op" id="3756302">,</span>&nbsp;<span class="builtintype" id="3756304">error</span><span class="op" id="3756309">)</span>&nbsp;<span class="op" id="3756311">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756314">if</span>&nbsp;<span class="ident" id="3756317">w</span><span class="op" id="3756318">.</span><span class="ident" id="3756319">lastpart</span>&nbsp;<span class="op" id="3756328">!=</span>&nbsp;<span class="ident" id="3756331">nil</span>&nbsp;<span class="op" id="3756335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756339">if</span>&nbsp;<span class="ident" id="3756342">err</span>&nbsp;<span class="op" id="3756346">:=</span>&nbsp;<span class="ident" id="3756349">w</span><span class="op" id="3756350">.</span><span class="ident" id="3756351">lastpart</span><span class="op" id="3756359">.</span><span class="builtinfunc" id="3756360">close</span><span class="op" id="3756365">(</span><span class="op" id="3756366">)</span><span class="op" id="3756367">;</span>&nbsp;<span class="ident" id="3756369">err</span>&nbsp;<span class="op" id="3756373">!=</span>&nbsp;<span class="ident" id="3756376">nil</span>&nbsp;<span class="op" id="3756380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756385">return</span>&nbsp;<span class="ident" id="3756392">nil</span><span class="op" id="3756395">,</span>&nbsp;<span class="ident" id="3756397">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756406">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756409">var</span>&nbsp;<span class="ident" id="3756413">b</span>&nbsp;<span class="ident" id="3756415">bytes</span><span class="op" id="3756420">.</span><span class="ident" id="3756421">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756429">if</span>&nbsp;<span class="ident" id="3756432">w</span><span class="op" id="3756433">.</span><span class="ident" id="3756434">lastpart</span>&nbsp;<span class="op" id="3756443">!=</span>&nbsp;<span class="ident" id="3756446">nil</span>&nbsp;<span class="op" id="3756450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756454">fmt</span><span class="op" id="3756457">.</span><span class="ident" id="3756458">Fprintf</span><span class="op" id="3756465">(</span><span class="op" id="3756466">&amp;</span><span class="ident" id="3756467">b</span><span class="op" id="3756468">,</span>&nbsp;<span class="string" id="3756470">&#34;\r\n--%s\r\n&#34;</span><span class="op" id="3756484">,</span>&nbsp;<span class="ident" id="3756486">w</span><span class="op" id="3756487">.</span><span class="ident" id="3756488">boundary</span><span class="op" id="3756496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756499">}</span>&nbsp;<span class="keyword" id="3756501">else</span>&nbsp;<span class="op" id="3756506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756510">fmt</span><span class="op" id="3756513">.</span><span class="ident" id="3756514">Fprintf</span><span class="op" id="3756521">(</span><span class="op" id="3756522">&amp;</span><span class="ident" id="3756523">b</span><span class="op" id="3756524">,</span>&nbsp;<span class="string" id="3756526">&#34;--%s\r\n&#34;</span><span class="op" id="3756536">,</span>&nbsp;<span class="ident" id="3756538">w</span><span class="op" id="3756539">.</span><span class="ident" id="3756540">boundary</span><span class="op" id="3756548">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3756554">//&nbsp;TODO(bradfitz):&nbsp;move&nbsp;this&nbsp;to&nbsp;textproto.MimeHeader.Write(w),&nbsp;have&nbsp;it&nbsp;sort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3756631">//&nbsp;and&nbsp;clean,&nbsp;like&nbsp;http.Header.Write(w)&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756678">for</span>&nbsp;<span class="ident" id="3756682">k</span><span class="op" id="3756683">,</span>&nbsp;<span class="ident" id="3756685">vv</span>&nbsp;<span class="op" id="3756688">:=</span>&nbsp;<span class="keyword" id="3756691">range</span>&nbsp;<span class="ident" id="3756697">header</span>&nbsp;<span class="op" id="3756704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756708">for</span>&nbsp;<span class="ident" id="3756712">_</span><span class="op" id="3756713">,</span>&nbsp;<span class="ident" id="3756715">v</span>&nbsp;<span class="op" id="3756717">:=</span>&nbsp;<span class="keyword" id="3756720">range</span>&nbsp;<span class="ident" id="3756726">vv</span>&nbsp;<span class="op" id="3756729">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756734">fmt</span><span class="op" id="3756737">.</span><span class="ident" id="3756738">Fprintf</span><span class="op" id="3756745">(</span><span class="op" id="3756746">&amp;</span><span class="ident" id="3756747">b</span><span class="op" id="3756748">,</span>&nbsp;<span class="string" id="3756750">&#34;%s:&nbsp;%s\r\n&#34;</span><span class="op" id="3756762">,</span>&nbsp;<span class="ident" id="3756764">k</span><span class="op" id="3756765">,</span>&nbsp;<span class="ident" id="3756767">v</span><span class="op" id="3756768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756778">fmt</span><span class="op" id="3756781">.</span><span class="ident" id="3756782">Fprintf</span><span class="op" id="3756789">(</span><span class="op" id="3756790">&amp;</span><span class="ident" id="3756791">b</span><span class="op" id="3756792">,</span>&nbsp;<span class="string" id="3756794">&#34;\r\n&#34;</span><span class="op" id="3756800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756803">_</span><span class="op" id="3756804">,</span>&nbsp;<span class="ident" id="3756806">err</span>&nbsp;<span class="op" id="3756810">:=</span>&nbsp;<span class="ident" id="3756813">io</span><span class="op" id="3756815">.</span><span class="ident" id="3756816">Copy</span><span class="op" id="3756820">(</span><span class="ident" id="3756821">w</span><span class="op" id="3756822">.</span><span class="ident" id="3756823">w</span><span class="op" id="3756824">,</span>&nbsp;<span class="op" id="3756826">&amp;</span><span class="ident" id="3756827">b</span><span class="op" id="3756828">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756831">if</span>&nbsp;<span class="ident" id="3756834">err</span>&nbsp;<span class="op" id="3756838">!=</span>&nbsp;<span class="ident" id="3756841">nil</span>&nbsp;<span class="op" id="3756845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756849">return</span>&nbsp;<span class="ident" id="3756856">nil</span><span class="op" id="3756859">,</span>&nbsp;<span class="ident" id="3756861">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756869">p</span>&nbsp;<span class="op" id="3756871">:=</span>&nbsp;<span class="op" id="3756874">&amp;</span><span class="ident" id="3756875">part</span><span class="op" id="3756879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756883">mw</span><span class="op" id="3756885">:</span>&nbsp;<span class="ident" id="3756887">w</span><span class="op" id="3756888">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3756891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3756894">w</span><span class="op" id="3756895">.</span><span class="ident" id="3756896">lastpart</span>&nbsp;<span class="op" id="3756905">=</span>&nbsp;<span class="ident" id="3756907">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3756910">return</span>&nbsp;<span class="ident" id="3756917">p</span><span class="op" id="3756918">,</span>&nbsp;<span class="ident" id="3756920">nil</span><br>
<span class="lineno"></span><span class="op" id="3756924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3756927">var</span>&nbsp;<span class="ident" id="3756931">quoteEscaper</span>&nbsp;<span class="op" id="3756944">=</span>&nbsp;<span class="ident" id="3756946">strings</span><span class="op" id="3756953">.</span><span class="ident" id="3756954">NewReplacer</span><span class="op" id="3756965">(</span><span class="string" id="3756966">&#34;\\&#34;</span><span class="op" id="3756970">,</span>&nbsp;<span class="string" id="3756972">&#34;\\\\&#34;</span><span class="op" id="3756978">,</span>&nbsp;<span class="string" id="3756980">`&#34;`</span><span class="op" id="3756983">,</span>&nbsp;<span class="string" id="3756985">&#34;\\\&#34;&#34;</span><span class="op" id="3756991">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3756994">func</span>&nbsp;<span class="ident" id="3756999">escapeQuotes</span><span class="op" id="3757011">(</span><span class="ident" id="3757012">s</span>&nbsp;<span class="builtintype" id="3757014">string</span><span class="op" id="3757020">)</span>&nbsp;<span class="builtintype" id="3757022">string</span>&nbsp;<span class="op" id="3757029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3757032">return</span>&nbsp;<span class="ident" id="3757039">quoteEscaper</span><span class="op" id="3757051">.</span><span class="ident" id="3757052">Replace</span><span class="op" id="3757059">(</span><span class="ident" id="3757060">s</span><span class="op" id="3757061">)</span><br>
<span class="lineno"></span><span class="op" id="3757063">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3757066">//&nbsp;CreateFormFile&nbsp;is&nbsp;a&nbsp;convenience&nbsp;wrapper&nbsp;around&nbsp;CreatePart.&nbsp;It&nbsp;creates</span><br>
<span class="lineno"></span><span class="comment" id="3757139">//&nbsp;a&nbsp;new&nbsp;form-data&nbsp;header&nbsp;with&nbsp;the&nbsp;provided&nbsp;field&nbsp;name&nbsp;and&nbsp;file&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3757209">func</span>&nbsp;<span class="op" id="3757214">(</span><span class="ident" id="3757215">w</span>&nbsp;<span class="op" id="3757217">*</span><span class="ident" id="3757218">Writer</span><span class="op" id="3757224">)</span>&nbsp;<span class="ident" id="3757226">CreateFormFile</span><span class="op" id="3757240">(</span><span class="ident" id="3757241">fieldname</span><span class="op" id="3757250">,</span>&nbsp;<span class="ident" id="3757252">filename</span>&nbsp;<span class="builtintype" id="3757261">string</span><span class="op" id="3757267">)</span>&nbsp;<span class="op" id="3757269">(</span><span class="ident" id="3757270">io</span><span class="op" id="3757272">.</span><span class="ident" id="3757273">Writer</span><span class="op" id="3757279">,</span>&nbsp;<span class="builtintype" id="3757281">error</span><span class="op" id="3757286">)</span>&nbsp;<span class="op" id="3757288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757291">h</span>&nbsp;<span class="op" id="3757293">:=</span>&nbsp;<span class="builtinfunc" id="3757296">make</span><span class="op" id="3757300">(</span><span class="ident" id="3757301">textproto</span><span class="op" id="3757310">.</span><span class="ident" id="3757311">MIMEHeader</span><span class="op" id="3757321">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757324">h</span><span class="op" id="3757325">.</span><span class="ident" id="3757326">Set</span><span class="op" id="3757329">(</span><span class="string" id="3757330">&#34;Content-Disposition&#34;</span><span class="op" id="3757351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757355">fmt</span><span class="op" id="3757358">.</span><span class="ident" id="3757359">Sprintf</span><span class="op" id="3757366">(</span><span class="string" id="3757367">`form-data;&nbsp;name=&#34;%s&#34;;&nbsp;filename=&#34;%s&#34;`</span><span class="op" id="3757404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757409">escapeQuotes</span><span class="op" id="3757421">(</span><span class="ident" id="3757422">fieldname</span><span class="op" id="3757431">)</span><span class="op" id="3757432">,</span>&nbsp;<span class="ident" id="3757434">escapeQuotes</span><span class="op" id="3757446">(</span><span class="ident" id="3757447">filename</span><span class="op" id="3757455">)</span><span class="op" id="3757456">)</span><span class="op" id="3757457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757460">h</span><span class="op" id="3757461">.</span><span class="ident" id="3757462">Set</span><span class="op" id="3757465">(</span><span class="string" id="3757466">&#34;Content-Type&#34;</span><span class="op" id="3757480">,</span>&nbsp;<span class="string" id="3757482">&#34;application/octet-stream&#34;</span><span class="op" id="3757508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3757511">return</span>&nbsp;<span class="ident" id="3757518">w</span><span class="op" id="3757519">.</span><span class="ident" id="3757520">CreatePart</span><span class="op" id="3757530">(</span><span class="ident" id="3757531">h</span><span class="op" id="3757532">)</span><br>
<span class="lineno">130</span><span class="op" id="3757534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3757537">//&nbsp;CreateFormField&nbsp;calls&nbsp;CreatePart&nbsp;with&nbsp;a&nbsp;header&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3757597">//&nbsp;given&nbsp;field&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3757618">func</span>&nbsp;<span class="op" id="3757623">(</span><span class="ident" id="3757624">w</span>&nbsp;<span class="op" id="3757626">*</span><span class="ident" id="3757627">Writer</span><span class="op" id="3757633">)</span>&nbsp;<span class="ident" id="3757635">CreateFormField</span><span class="op" id="3757650">(</span><span class="ident" id="3757651">fieldname</span>&nbsp;<span class="builtintype" id="3757661">string</span><span class="op" id="3757667">)</span>&nbsp;<span class="op" id="3757669">(</span><span class="ident" id="3757670">io</span><span class="op" id="3757672">.</span><span class="ident" id="3757673">Writer</span><span class="op" id="3757679">,</span>&nbsp;<span class="builtintype" id="3757681">error</span><span class="op" id="3757686">)</span>&nbsp;<span class="op" id="3757688">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757691">h</span>&nbsp;<span class="op" id="3757693">:=</span>&nbsp;<span class="builtinfunc" id="3757696">make</span><span class="op" id="3757700">(</span><span class="ident" id="3757701">textproto</span><span class="op" id="3757710">.</span><span class="ident" id="3757711">MIMEHeader</span><span class="op" id="3757721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757724">h</span><span class="op" id="3757725">.</span><span class="ident" id="3757726">Set</span><span class="op" id="3757729">(</span><span class="string" id="3757730">&#34;Content-Disposition&#34;</span><span class="op" id="3757751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757755">fmt</span><span class="op" id="3757758">.</span><span class="ident" id="3757759">Sprintf</span><span class="op" id="3757766">(</span><span class="string" id="3757767">`form-data;&nbsp;name=&#34;%s&#34;`</span><span class="op" id="3757789">,</span>&nbsp;<span class="ident" id="3757791">escapeQuotes</span><span class="op" id="3757803">(</span><span class="ident" id="3757804">fieldname</span><span class="op" id="3757813">)</span><span class="op" id="3757814">)</span><span class="op" id="3757815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3757818">return</span>&nbsp;<span class="ident" id="3757825">w</span><span class="op" id="3757826">.</span><span class="ident" id="3757827">CreatePart</span><span class="op" id="3757837">(</span><span class="ident" id="3757838">h</span><span class="op" id="3757839">)</span><br>
<span class="lineno"></span><span class="op" id="3757841">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="3757844">//&nbsp;WriteField&nbsp;calls&nbsp;CreateFormField&nbsp;and&nbsp;then&nbsp;writes&nbsp;the&nbsp;given&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3757913">func</span>&nbsp;<span class="op" id="3757918">(</span><span class="ident" id="3757919">w</span>&nbsp;<span class="op" id="3757921">*</span><span class="ident" id="3757922">Writer</span><span class="op" id="3757928">)</span>&nbsp;<span class="ident" id="3757930">WriteField</span><span class="op" id="3757940">(</span><span class="ident" id="3757941">fieldname</span><span class="op" id="3757950">,</span>&nbsp;<span class="ident" id="3757952">value</span>&nbsp;<span class="builtintype" id="3757958">string</span><span class="op" id="3757964">)</span>&nbsp;<span class="builtintype" id="3757966">error</span>&nbsp;<span class="op" id="3757972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3757975">p</span><span class="op" id="3757976">,</span>&nbsp;<span class="ident" id="3757978">err</span>&nbsp;<span class="op" id="3757982">:=</span>&nbsp;<span class="ident" id="3757985">w</span><span class="op" id="3757986">.</span><span class="ident" id="3757987">CreateFormField</span><span class="op" id="3758002">(</span><span class="ident" id="3758003">fieldname</span><span class="op" id="3758012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758015">if</span>&nbsp;<span class="ident" id="3758018">err</span>&nbsp;<span class="op" id="3758022">!=</span>&nbsp;<span class="ident" id="3758025">nil</span>&nbsp;<span class="op" id="3758029">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758033">return</span>&nbsp;<span class="ident" id="3758040">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3758045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758048">_</span><span class="op" id="3758049">,</span>&nbsp;<span class="ident" id="3758051">err</span>&nbsp;<span class="op" id="3758055">=</span>&nbsp;<span class="ident" id="3758057">p</span><span class="op" id="3758058">.</span><span class="ident" id="3758059">Write</span><span class="op" id="3758064">(</span><span class="op" id="3758065">[</span><span class="op" id="3758066">]</span><span class="builtintype" id="3758067">byte</span><span class="op" id="3758071">(</span><span class="ident" id="3758072">value</span><span class="op" id="3758077">)</span><span class="op" id="3758078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758081">return</span>&nbsp;<span class="ident" id="3758088">err</span><br>
<span class="lineno"></span><span class="op" id="3758092">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="3758095">//&nbsp;Close&nbsp;finishes&nbsp;the&nbsp;multipart&nbsp;message&nbsp;and&nbsp;writes&nbsp;the&nbsp;trailing</span><br>
<span class="lineno"></span><span class="comment" id="3758159">//&nbsp;boundary&nbsp;end&nbsp;line&nbsp;to&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3758195">func</span>&nbsp;<span class="op" id="3758200">(</span><span class="ident" id="3758201">w</span>&nbsp;<span class="op" id="3758203">*</span><span class="ident" id="3758204">Writer</span><span class="op" id="3758210">)</span>&nbsp;<span class="ident" id="3758212">Close</span><span class="op" id="3758217">(</span><span class="op" id="3758218">)</span>&nbsp;<span class="builtintype" id="3758220">error</span>&nbsp;<span class="op" id="3758226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758229">if</span>&nbsp;<span class="ident" id="3758232">w</span><span class="op" id="3758233">.</span><span class="ident" id="3758234">lastpart</span>&nbsp;<span class="op" id="3758243">!=</span>&nbsp;<span class="ident" id="3758246">nil</span>&nbsp;<span class="op" id="3758250">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758254">if</span>&nbsp;<span class="ident" id="3758257">err</span>&nbsp;<span class="op" id="3758261">:=</span>&nbsp;<span class="ident" id="3758264">w</span><span class="op" id="3758265">.</span><span class="ident" id="3758266">lastpart</span><span class="op" id="3758274">.</span><span class="builtinfunc" id="3758275">close</span><span class="op" id="3758280">(</span><span class="op" id="3758281">)</span><span class="op" id="3758282">;</span>&nbsp;<span class="ident" id="3758284">err</span>&nbsp;<span class="op" id="3758288">!=</span>&nbsp;<span class="ident" id="3758291">nil</span>&nbsp;<span class="op" id="3758295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758300">return</span>&nbsp;<span class="ident" id="3758307">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3758313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758317">w</span><span class="op" id="3758318">.</span><span class="ident" id="3758319">lastpart</span>&nbsp;<span class="op" id="3758328">=</span>&nbsp;<span class="ident" id="3758330">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3758335">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758338">_</span><span class="op" id="3758339">,</span>&nbsp;<span class="ident" id="3758341">err</span>&nbsp;<span class="op" id="3758345">:=</span>&nbsp;<span class="ident" id="3758348">fmt</span><span class="op" id="3758351">.</span><span class="ident" id="3758352">Fprintf</span><span class="op" id="3758359">(</span><span class="ident" id="3758360">w</span><span class="op" id="3758361">.</span><span class="ident" id="3758362">w</span><span class="op" id="3758363">,</span>&nbsp;<span class="string" id="3758365">&#34;\r\n--%s--\r\n&#34;</span><span class="op" id="3758381">,</span>&nbsp;<span class="ident" id="3758383">w</span><span class="op" id="3758384">.</span><span class="ident" id="3758385">boundary</span><span class="op" id="3758393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758396">return</span>&nbsp;<span class="ident" id="3758403">err</span><br>
<span class="lineno"></span><span class="op" id="3758407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3758410">type</span>&nbsp;<span class="ident" id="3758415">part</span>&nbsp;<span class="keyword" id="3758420">struct</span>&nbsp;<span class="op" id="3758427">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758430">mw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3758437">*</span><span class="ident" id="3758438">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758446">closed</span>&nbsp;<span class="builtintype" id="3758453">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758459">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3758466">error</span>&nbsp;<span class="comment" id="3758472">//&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;writing</span><br>
<span class="lineno"></span><span class="op" id="3758508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="3758511">func</span>&nbsp;<span class="op" id="3758516">(</span><span class="ident" id="3758517">p</span>&nbsp;<span class="op" id="3758519">*</span><span class="ident" id="3758520">part</span><span class="op" id="3758524">)</span>&nbsp;<span class="builtinfunc" id="3758526">close</span><span class="op" id="3758531">(</span><span class="op" id="3758532">)</span>&nbsp;<span class="builtintype" id="3758534">error</span>&nbsp;<span class="op" id="3758540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758543">p</span><span class="op" id="3758544">.</span><span class="ident" id="3758545">closed</span>&nbsp;<span class="op" id="3758552">=</span>&nbsp;<span class="ident" id="3758554">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758560">return</span>&nbsp;<span class="ident" id="3758567">p</span><span class="op" id="3758568">.</span><span class="ident" id="3758569">we</span><br>
<span class="lineno"></span><span class="op" id="3758572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="3758575">func</span>&nbsp;<span class="op" id="3758580">(</span><span class="ident" id="3758581">p</span>&nbsp;<span class="op" id="3758583">*</span><span class="ident" id="3758584">part</span><span class="op" id="3758588">)</span>&nbsp;<span class="ident" id="3758590">Write</span><span class="op" id="3758595">(</span><span class="ident" id="3758596">d</span>&nbsp;<span class="op" id="3758598">[</span><span class="op" id="3758599">]</span><span class="builtintype" id="3758600">byte</span><span class="op" id="3758604">)</span>&nbsp;<span class="op" id="3758606">(</span><span class="ident" id="3758607">n</span>&nbsp;<span class="builtintype" id="3758609">int</span><span class="op" id="3758612">,</span>&nbsp;<span class="ident" id="3758614">err</span>&nbsp;<span class="builtintype" id="3758618">error</span><span class="op" id="3758623">)</span>&nbsp;<span class="op" id="3758625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758628">if</span>&nbsp;<span class="ident" id="3758631">p</span><span class="op" id="3758632">.</span><span class="ident" id="3758633">closed</span>&nbsp;<span class="op" id="3758640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758644">return</span>&nbsp;<span class="num" id="3758651">0</span><span class="op" id="3758652">,</span>&nbsp;<span class="ident" id="3758654">errors</span><span class="op" id="3758660">.</span><span class="ident" id="3758661">New</span><span class="op" id="3758664">(</span><span class="string" id="3758665">&#34;multipart:&nbsp;can&#39;t&nbsp;write&nbsp;to&nbsp;finished&nbsp;part&#34;</span><span class="op" id="3758706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3758709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758712">n</span><span class="op" id="3758713">,</span>&nbsp;<span class="ident" id="3758715">err</span>&nbsp;<span class="op" id="3758719">=</span>&nbsp;<span class="ident" id="3758721">p</span><span class="op" id="3758722">.</span><span class="ident" id="3758723">mw</span><span class="op" id="3758725">.</span><span class="ident" id="3758726">w</span><span class="op" id="3758727">.</span><span class="ident" id="3758728">Write</span><span class="op" id="3758733">(</span><span class="ident" id="3758734">d</span><span class="op" id="3758735">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758738">if</span>&nbsp;<span class="ident" id="3758741">err</span>&nbsp;<span class="op" id="3758745">!=</span>&nbsp;<span class="ident" id="3758748">nil</span>&nbsp;<span class="op" id="3758752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3758756">p</span><span class="op" id="3758757">.</span><span class="ident" id="3758758">we</span>&nbsp;<span class="op" id="3758761">=</span>&nbsp;<span class="ident" id="3758763">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3758768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3758771">return</span><br>
<span class="lineno"></span><span class="op" id="3758778">}</span>
</div>
</body>
</html>
