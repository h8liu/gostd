<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4023836">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4023891">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4023945">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4023996">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4024067">package</span>&nbsp;<span class="ident" id="4024075">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4024080">import</span>&nbsp;<span class="op" id="4024087">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024090">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024100">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024116">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024130">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024145">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024161">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024171">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024184">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024191">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4024202">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4024209">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4024212">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4024263">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4024306">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4024364">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4024393">func</span>&nbsp;<span class="ident" id="4024398">Server</span><span class="op" id="4024404">(</span><span class="ident" id="4024405">conn</span>&nbsp;<span class="ident" id="4024410">net</span><span class="op" id="4024413">.</span><span class="ident" id="4024414">Conn</span><span class="op" id="4024418">,</span>&nbsp;<span class="ident" id="4024420">config</span>&nbsp;<span class="op" id="4024427">*</span><span class="ident" id="4024428">Config</span><span class="op" id="4024434">)</span>&nbsp;<span class="op" id="4024436">*</span><span class="ident" id="4024437">Conn</span>&nbsp;<span class="op" id="4024442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024445">return</span>&nbsp;<span class="op" id="4024452">&amp;</span><span class="ident" id="4024453">Conn</span><span class="op" id="4024457">{</span><span class="ident" id="4024458">conn</span><span class="op" id="4024462">:</span>&nbsp;<span class="ident" id="4024464">conn</span><span class="op" id="4024468">,</span>&nbsp;<span class="ident" id="4024470">config</span><span class="op" id="4024476">:</span>&nbsp;<span class="ident" id="4024478">config</span><span class="op" id="4024484">}</span><br>
<span class="lineno"></span><span class="op" id="4024486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4024489">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4024540">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4024583">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4024648">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4024685">func</span>&nbsp;<span class="ident" id="4024690">Client</span><span class="op" id="4024696">(</span><span class="ident" id="4024697">conn</span>&nbsp;<span class="ident" id="4024702">net</span><span class="op" id="4024705">.</span><span class="ident" id="4024706">Conn</span><span class="op" id="4024710">,</span>&nbsp;<span class="ident" id="4024712">config</span>&nbsp;<span class="op" id="4024719">*</span><span class="ident" id="4024720">Config</span><span class="op" id="4024726">)</span>&nbsp;<span class="op" id="4024728">*</span><span class="ident" id="4024729">Conn</span>&nbsp;<span class="op" id="4024734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024737">return</span>&nbsp;<span class="op" id="4024744">&amp;</span><span class="ident" id="4024745">Conn</span><span class="op" id="4024749">{</span><span class="ident" id="4024750">conn</span><span class="op" id="4024754">:</span>&nbsp;<span class="ident" id="4024756">conn</span><span class="op" id="4024760">,</span>&nbsp;<span class="ident" id="4024762">config</span><span class="op" id="4024768">:</span>&nbsp;<span class="ident" id="4024770">config</span><span class="op" id="4024776">,</span>&nbsp;<span class="ident" id="4024778">isClient</span><span class="op" id="4024786">:</span>&nbsp;<span class="ident" id="4024788">true</span><span class="op" id="4024792">}</span><br>
<span class="lineno">35</span><span class="op" id="4024794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4024797">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4024877">type</span>&nbsp;<span class="ident" id="4024882">listener</span>&nbsp;<span class="keyword" id="4024891">struct</span>&nbsp;<span class="op" id="4024898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024901">net</span><span class="op" id="4024904">.</span><span class="ident" id="4024905">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024915">config</span>&nbsp;<span class="op" id="4024922">*</span><span class="ident" id="4024923">Config</span><br>
<span class="lineno"></span><span class="op" id="4024930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4024933">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4024999">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4025044">func</span>&nbsp;<span class="op" id="4025049">(</span><span class="ident" id="4025050">l</span>&nbsp;<span class="op" id="4025052">*</span><span class="ident" id="4025053">listener</span><span class="op" id="4025061">)</span>&nbsp;<span class="ident" id="4025063">Accept</span><span class="op" id="4025069">(</span><span class="op" id="4025070">)</span>&nbsp;<span class="op" id="4025072">(</span><span class="ident" id="4025073">c</span>&nbsp;<span class="ident" id="4025075">net</span><span class="op" id="4025078">.</span><span class="ident" id="4025079">Conn</span><span class="op" id="4025083">,</span>&nbsp;<span class="ident" id="4025085">err</span>&nbsp;<span class="builtintype" id="4025089">error</span><span class="op" id="4025094">)</span>&nbsp;<span class="op" id="4025096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025099">c</span><span class="op" id="4025100">,</span>&nbsp;<span class="ident" id="4025102">err</span>&nbsp;<span class="op" id="4025106">=</span>&nbsp;<span class="ident" id="4025108">l</span><span class="op" id="4025109">.</span><span class="ident" id="4025110">Listener</span><span class="op" id="4025118">.</span><span class="ident" id="4025119">Accept</span><span class="op" id="4025125">(</span><span class="op" id="4025126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025129">if</span>&nbsp;<span class="ident" id="4025132">err</span>&nbsp;<span class="op" id="4025136">!=</span>&nbsp;<span class="ident" id="4025139">nil</span>&nbsp;<span class="op" id="4025143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025147">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025155">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025158">c</span>&nbsp;<span class="op" id="4025160">=</span>&nbsp;<span class="ident" id="4025162">Server</span><span class="op" id="4025168">(</span><span class="ident" id="4025169">c</span><span class="op" id="4025170">,</span>&nbsp;<span class="ident" id="4025172">l</span><span class="op" id="4025173">.</span><span class="ident" id="4025174">config</span><span class="op" id="4025180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025183">return</span><br>
<span class="lineno"></span><span class="op" id="4025190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4025193">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4025267">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4025318">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4025376">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4025405">func</span>&nbsp;<span class="ident" id="4025410">NewListener</span><span class="op" id="4025421">(</span><span class="ident" id="4025422">inner</span>&nbsp;<span class="ident" id="4025428">net</span><span class="op" id="4025431">.</span><span class="ident" id="4025432">Listener</span><span class="op" id="4025440">,</span>&nbsp;<span class="ident" id="4025442">config</span>&nbsp;<span class="op" id="4025449">*</span><span class="ident" id="4025450">Config</span><span class="op" id="4025456">)</span>&nbsp;<span class="ident" id="4025458">net</span><span class="op" id="4025461">.</span><span class="ident" id="4025462">Listener</span>&nbsp;<span class="op" id="4025471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025474">l</span>&nbsp;<span class="op" id="4025476">:=</span>&nbsp;<span class="builtinfunc" id="4025479">new</span><span class="op" id="4025482">(</span><span class="ident" id="4025483">listener</span><span class="op" id="4025491">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025494">l</span><span class="op" id="4025495">.</span><span class="ident" id="4025496">Listener</span>&nbsp;<span class="op" id="4025505">=</span>&nbsp;<span class="ident" id="4025507">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025514">l</span><span class="op" id="4025515">.</span><span class="ident" id="4025516">config</span>&nbsp;<span class="op" id="4025523">=</span>&nbsp;<span class="ident" id="4025525">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025533">return</span>&nbsp;<span class="ident" id="4025540">l</span><br>
<span class="lineno"></span><span class="op" id="4025542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4025545">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4025607">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4025650">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4025708">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4025737">func</span>&nbsp;<span class="ident" id="4025742">Listen</span><span class="op" id="4025748">(</span><span class="ident" id="4025749">network</span><span class="op" id="4025756">,</span>&nbsp;<span class="ident" id="4025758">laddr</span>&nbsp;<span class="builtintype" id="4025764">string</span><span class="op" id="4025770">,</span>&nbsp;<span class="ident" id="4025772">config</span>&nbsp;<span class="op" id="4025779">*</span><span class="ident" id="4025780">Config</span><span class="op" id="4025786">)</span>&nbsp;<span class="op" id="4025788">(</span><span class="ident" id="4025789">net</span><span class="op" id="4025792">.</span><span class="ident" id="4025793">Listener</span><span class="op" id="4025801">,</span>&nbsp;<span class="builtintype" id="4025803">error</span><span class="op" id="4025808">)</span>&nbsp;<span class="op" id="4025810">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025813">if</span>&nbsp;<span class="ident" id="4025816">config</span>&nbsp;<span class="op" id="4025823">==</span>&nbsp;<span class="ident" id="4025826">nil</span>&nbsp;<span class="op" id="4025830">||</span>&nbsp;<span class="builtinfunc" id="4025833">len</span><span class="op" id="4025836">(</span><span class="ident" id="4025837">config</span><span class="op" id="4025843">.</span><span class="ident" id="4025844">Certificates</span><span class="op" id="4025856">)</span>&nbsp;<span class="op" id="4025858">==</span>&nbsp;<span class="num" id="4025861">0</span>&nbsp;<span class="op" id="4025863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025867">return</span>&nbsp;<span class="ident" id="4025874">nil</span><span class="op" id="4025877">,</span>&nbsp;<span class="ident" id="4025879">errors</span><span class="op" id="4025885">.</span><span class="ident" id="4025886">New</span><span class="op" id="4025889">(</span><span class="string" id="4025890">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4025936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025942">l</span><span class="op" id="4025943">,</span>&nbsp;<span class="ident" id="4025945">err</span>&nbsp;<span class="op" id="4025949">:=</span>&nbsp;<span class="ident" id="4025952">net</span><span class="op" id="4025955">.</span><span class="ident" id="4025956">Listen</span><span class="op" id="4025962">(</span><span class="ident" id="4025963">network</span><span class="op" id="4025970">,</span>&nbsp;<span class="ident" id="4025972">laddr</span><span class="op" id="4025977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025980">if</span>&nbsp;<span class="ident" id="4025983">err</span>&nbsp;<span class="op" id="4025987">!=</span>&nbsp;<span class="ident" id="4025990">nil</span>&nbsp;<span class="op" id="4025994">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025998">return</span>&nbsp;<span class="ident" id="4026005">nil</span><span class="op" id="4026008">,</span>&nbsp;<span class="ident" id="4026010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4026015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026018">return</span>&nbsp;<span class="ident" id="4026025">NewListener</span><span class="op" id="4026036">(</span><span class="ident" id="4026037">l</span><span class="op" id="4026038">,</span>&nbsp;<span class="ident" id="4026040">config</span><span class="op" id="4026046">)</span><span class="op" id="4026047">,</span>&nbsp;<span class="ident" id="4026049">nil</span><br>
<span class="lineno"></span><span class="op" id="4026053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4026056">type</span>&nbsp;<span class="ident" id="4026061">timeoutError</span>&nbsp;<span class="keyword" id="4026074">struct</span><span class="op" id="4026080">{</span><span class="op" id="4026081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4026084">func</span>&nbsp;<span class="op" id="4026089">(</span><span class="ident" id="4026090">timeoutError</span><span class="op" id="4026102">)</span>&nbsp;<span class="ident" id="4026104">Error</span><span class="op" id="4026109">(</span><span class="op" id="4026110">)</span>&nbsp;<span class="builtintype" id="4026112">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4026121">{</span>&nbsp;<span class="keyword" id="4026123">return</span>&nbsp;<span class="string" id="4026130">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4026162">}</span><br>
<span class="lineno"></span><span class="keyword" id="4026164">func</span>&nbsp;<span class="op" id="4026169">(</span><span class="ident" id="4026170">timeoutError</span><span class="op" id="4026182">)</span>&nbsp;<span class="ident" id="4026184">Timeout</span><span class="op" id="4026191">(</span><span class="op" id="4026192">)</span>&nbsp;<span class="builtintype" id="4026194">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4026201">{</span>&nbsp;<span class="keyword" id="4026203">return</span>&nbsp;<span class="ident" id="4026210">true</span>&nbsp;<span class="op" id="4026215">}</span><br>
<span class="lineno"></span><span class="keyword" id="4026217">func</span>&nbsp;<span class="op" id="4026222">(</span><span class="ident" id="4026223">timeoutError</span><span class="op" id="4026235">)</span>&nbsp;<span class="ident" id="4026237">Temporary</span><span class="op" id="4026246">(</span><span class="op" id="4026247">)</span>&nbsp;<span class="builtintype" id="4026249">bool</span>&nbsp;<span class="op" id="4026254">{</span>&nbsp;<span class="keyword" id="4026256">return</span>&nbsp;<span class="ident" id="4026263">true</span>&nbsp;<span class="op" id="4026268">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4026271">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4026349">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4026428">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4026499">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4026524">//</span><br>
<span class="lineno"></span><span class="comment" id="4026527">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4026602">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4026670">func</span>&nbsp;<span class="ident" id="4026675">DialWithDialer</span><span class="op" id="4026689">(</span><span class="ident" id="4026690">dialer</span>&nbsp;<span class="op" id="4026697">*</span><span class="ident" id="4026698">net</span><span class="op" id="4026701">.</span><span class="ident" id="4026702">Dialer</span><span class="op" id="4026708">,</span>&nbsp;<span class="ident" id="4026710">network</span><span class="op" id="4026717">,</span>&nbsp;<span class="ident" id="4026719">addr</span>&nbsp;<span class="builtintype" id="4026724">string</span><span class="op" id="4026730">,</span>&nbsp;<span class="ident" id="4026732">config</span>&nbsp;<span class="op" id="4026739">*</span><span class="ident" id="4026740">Config</span><span class="op" id="4026746">)</span>&nbsp;<span class="op" id="4026748">(</span><span class="op" id="4026749">*</span><span class="ident" id="4026750">Conn</span><span class="op" id="4026754">,</span>&nbsp;<span class="builtintype" id="4026756">error</span><span class="op" id="4026761">)</span>&nbsp;<span class="op" id="4026763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026766">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026835">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026907">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026950">timeout</span>&nbsp;<span class="op" id="4026958">:=</span>&nbsp;<span class="ident" id="4026961">dialer</span><span class="op" id="4026967">.</span><span class="ident" id="4026968">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026978">if</span>&nbsp;<span class="op" id="4026981">!</span><span class="ident" id="4026982">dialer</span><span class="op" id="4026988">.</span><span class="ident" id="4026989">Deadline</span><span class="op" id="4026997">.</span><span class="ident" id="4026998">IsZero</span><span class="op" id="4027004">(</span><span class="op" id="4027005">)</span>&nbsp;<span class="op" id="4027007">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027011">deadlineTimeout</span>&nbsp;<span class="op" id="4027027">:=</span>&nbsp;<span class="ident" id="4027030">dialer</span><span class="op" id="4027036">.</span><span class="ident" id="4027037">Deadline</span><span class="op" id="4027045">.</span><span class="ident" id="4027046">Sub</span><span class="op" id="4027049">(</span><span class="ident" id="4027050">time</span><span class="op" id="4027054">.</span><span class="ident" id="4027055">Now</span><span class="op" id="4027058">(</span><span class="op" id="4027059">)</span><span class="op" id="4027060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027064">if</span>&nbsp;<span class="ident" id="4027067">timeout</span>&nbsp;<span class="op" id="4027075">==</span>&nbsp;<span class="num" id="4027078">0</span>&nbsp;<span class="op" id="4027080">||</span>&nbsp;<span class="ident" id="4027083">deadlineTimeout</span>&nbsp;<span class="op" id="4027099">&lt;</span>&nbsp;<span class="ident" id="4027101">timeout</span>&nbsp;<span class="op" id="4027109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027114">timeout</span>&nbsp;<span class="op" id="4027122">=</span>&nbsp;<span class="ident" id="4027124">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027145">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027149">var</span>&nbsp;<span class="ident" id="4027153">errChannel</span>&nbsp;<span class="keyword" id="4027164">chan</span>&nbsp;<span class="builtintype" id="4027169">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027177">if</span>&nbsp;<span class="ident" id="4027180">timeout</span>&nbsp;<span class="op" id="4027188">!=</span>&nbsp;<span class="num" id="4027191">0</span>&nbsp;<span class="op" id="4027193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027197">errChannel</span>&nbsp;<span class="op" id="4027208">=</span>&nbsp;<span class="builtinfunc" id="4027210">make</span><span class="op" id="4027214">(</span><span class="keyword" id="4027215">chan</span>&nbsp;<span class="builtintype" id="4027220">error</span><span class="op" id="4027225">,</span>&nbsp;<span class="num" id="4027227">2</span><span class="op" id="4027228">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027232">time</span><span class="op" id="4027236">.</span><span class="ident" id="4027237">AfterFunc</span><span class="op" id="4027246">(</span><span class="ident" id="4027247">timeout</span><span class="op" id="4027254">,</span>&nbsp;<span class="keyword" id="4027256">func</span><span class="op" id="4027260">(</span><span class="op" id="4027261">)</span>&nbsp;<span class="op" id="4027263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027268">errChannel</span>&nbsp;<span class="op" id="4027279">&lt;-</span>&nbsp;<span class="ident" id="4027282">timeoutError</span><span class="op" id="4027294">{</span><span class="op" id="4027295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027299">}</span><span class="op" id="4027300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027307">rawConn</span><span class="op" id="4027314">,</span>&nbsp;<span class="ident" id="4027316">err</span>&nbsp;<span class="op" id="4027320">:=</span>&nbsp;<span class="ident" id="4027323">dialer</span><span class="op" id="4027329">.</span><span class="ident" id="4027330">Dial</span><span class="op" id="4027334">(</span><span class="ident" id="4027335">network</span><span class="op" id="4027342">,</span>&nbsp;<span class="ident" id="4027344">addr</span><span class="op" id="4027348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027351">if</span>&nbsp;<span class="ident" id="4027354">err</span>&nbsp;<span class="op" id="4027358">!=</span>&nbsp;<span class="ident" id="4027361">nil</span>&nbsp;<span class="op" id="4027365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027369">return</span>&nbsp;<span class="ident" id="4027376">nil</span><span class="op" id="4027379">,</span>&nbsp;<span class="ident" id="4027381">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027390">colonPos</span>&nbsp;<span class="op" id="4027399">:=</span>&nbsp;<span class="ident" id="4027402">strings</span><span class="op" id="4027409">.</span><span class="ident" id="4027410">LastIndex</span><span class="op" id="4027419">(</span><span class="ident" id="4027420">addr</span><span class="op" id="4027424">,</span>&nbsp;<span class="string" id="4027426">&#34;:&#34;</span><span class="op" id="4027429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027432">if</span>&nbsp;<span class="ident" id="4027435">colonPos</span>&nbsp;<span class="op" id="4027444">==</span>&nbsp;<span class="op" id="4027447">-</span><span class="num" id="4027448">1</span>&nbsp;<span class="op" id="4027450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027454">colonPos</span>&nbsp;<span class="op" id="4027463">=</span>&nbsp;<span class="builtinfunc" id="4027465">len</span><span class="op" id="4027468">(</span><span class="ident" id="4027469">addr</span><span class="op" id="4027473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027479">hostname</span>&nbsp;<span class="op" id="4027488">:=</span>&nbsp;<span class="ident" id="4027491">addr</span><span class="op" id="4027495">[</span><span class="op" id="4027496">:</span><span class="ident" id="4027497">colonPos</span><span class="op" id="4027505">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027509">if</span>&nbsp;<span class="ident" id="4027512">config</span>&nbsp;<span class="op" id="4027519">==</span>&nbsp;<span class="ident" id="4027522">nil</span>&nbsp;<span class="op" id="4027526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027530">config</span>&nbsp;<span class="op" id="4027537">=</span>&nbsp;<span class="ident" id="4027539">defaultConfig</span><span class="op" id="4027552">(</span><span class="op" id="4027553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4027559">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4027609">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027652">if</span>&nbsp;<span class="ident" id="4027655">config</span><span class="op" id="4027661">.</span><span class="ident" id="4027662">ServerName</span>&nbsp;<span class="op" id="4027673">==</span>&nbsp;<span class="string" id="4027676">&#34;&#34;</span>&nbsp;<span class="op" id="4027679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4027683">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027740">c</span>&nbsp;<span class="op" id="4027742">:=</span>&nbsp;<span class="op" id="4027745">*</span><span class="ident" id="4027746">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027755">c</span><span class="op" id="4027756">.</span><span class="ident" id="4027757">ServerName</span>&nbsp;<span class="op" id="4027768">=</span>&nbsp;<span class="ident" id="4027770">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027781">config</span>&nbsp;<span class="op" id="4027788">=</span>&nbsp;<span class="op" id="4027790">&amp;</span><span class="ident" id="4027791">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027798">conn</span>&nbsp;<span class="op" id="4027803">:=</span>&nbsp;<span class="ident" id="4027806">Client</span><span class="op" id="4027812">(</span><span class="ident" id="4027813">rawConn</span><span class="op" id="4027820">,</span>&nbsp;<span class="ident" id="4027822">config</span><span class="op" id="4027828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027832">if</span>&nbsp;<span class="ident" id="4027835">timeout</span>&nbsp;<span class="op" id="4027843">==</span>&nbsp;<span class="num" id="4027846">0</span>&nbsp;<span class="op" id="4027848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027852">err</span>&nbsp;<span class="op" id="4027856">=</span>&nbsp;<span class="ident" id="4027858">conn</span><span class="op" id="4027862">.</span><span class="ident" id="4027863">Handshake</span><span class="op" id="4027872">(</span><span class="op" id="4027873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027876">}</span>&nbsp;<span class="keyword" id="4027878">else</span>&nbsp;<span class="op" id="4027883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027887">go</span>&nbsp;<span class="keyword" id="4027890">func</span><span class="op" id="4027894">(</span><span class="op" id="4027895">)</span>&nbsp;<span class="op" id="4027897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027902">errChannel</span>&nbsp;<span class="op" id="4027913">&lt;-</span>&nbsp;<span class="ident" id="4027916">conn</span><span class="op" id="4027920">.</span><span class="ident" id="4027921">Handshake</span><span class="op" id="4027930">(</span><span class="op" id="4027931">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027935">}</span><span class="op" id="4027936">(</span><span class="op" id="4027937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027942">err</span>&nbsp;<span class="op" id="4027946">=</span>&nbsp;<span class="op" id="4027948">&lt;-</span><span class="ident" id="4027950">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027966">if</span>&nbsp;<span class="ident" id="4027969">err</span>&nbsp;<span class="op" id="4027973">!=</span>&nbsp;<span class="ident" id="4027976">nil</span>&nbsp;<span class="op" id="4027980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027984">rawConn</span><span class="op" id="4027991">.</span><span class="ident" id="4027992">Close</span><span class="op" id="4027997">(</span><span class="op" id="4027998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028002">return</span>&nbsp;<span class="ident" id="4028009">nil</span><span class="op" id="4028012">,</span>&nbsp;<span class="ident" id="4028014">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028023">return</span>&nbsp;<span class="ident" id="4028030">conn</span><span class="op" id="4028034">,</span>&nbsp;<span class="ident" id="4028036">nil</span><br>
<span class="lineno"></span><span class="op" id="4028040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4028043">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4028104">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4028167">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4028186">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4028242">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4028301">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4028322">func</span>&nbsp;<span class="ident" id="4028327">Dial</span><span class="op" id="4028331">(</span><span class="ident" id="4028332">network</span><span class="op" id="4028339">,</span>&nbsp;<span class="ident" id="4028341">addr</span>&nbsp;<span class="builtintype" id="4028346">string</span><span class="op" id="4028352">,</span>&nbsp;<span class="ident" id="4028354">config</span>&nbsp;<span class="op" id="4028361">*</span><span class="ident" id="4028362">Config</span><span class="op" id="4028368">)</span>&nbsp;<span class="op" id="4028370">(</span><span class="op" id="4028371">*</span><span class="ident" id="4028372">Conn</span><span class="op" id="4028376">,</span>&nbsp;<span class="builtintype" id="4028378">error</span><span class="op" id="4028383">)</span>&nbsp;<span class="op" id="4028385">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028388">return</span>&nbsp;<span class="ident" id="4028395">DialWithDialer</span><span class="op" id="4028409">(</span><span class="builtinfunc" id="4028410">new</span><span class="op" id="4028413">(</span><span class="ident" id="4028414">net</span><span class="op" id="4028417">.</span><span class="ident" id="4028418">Dialer</span><span class="op" id="4028424">)</span><span class="op" id="4028425">,</span>&nbsp;<span class="ident" id="4028427">network</span><span class="op" id="4028434">,</span>&nbsp;<span class="ident" id="4028436">addr</span><span class="op" id="4028440">,</span>&nbsp;<span class="ident" id="4028442">config</span><span class="op" id="4028448">)</span><br>
<span class="lineno"></span><span class="op" id="4028450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4028453">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4028530">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4028581">func</span>&nbsp;<span class="ident" id="4028586">LoadX509KeyPair</span><span class="op" id="4028601">(</span><span class="ident" id="4028602">certFile</span><span class="op" id="4028610">,</span>&nbsp;<span class="ident" id="4028612">keyFile</span>&nbsp;<span class="builtintype" id="4028620">string</span><span class="op" id="4028626">)</span>&nbsp;<span class="op" id="4028628">(</span><span class="ident" id="4028629">cert</span>&nbsp;<span class="ident" id="4028634">Certificate</span><span class="op" id="4028645">,</span>&nbsp;<span class="ident" id="4028647">err</span>&nbsp;<span class="builtintype" id="4028651">error</span><span class="op" id="4028656">)</span>&nbsp;<span class="op" id="4028658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028661">certPEMBlock</span><span class="op" id="4028673">,</span>&nbsp;<span class="ident" id="4028675">err</span>&nbsp;<span class="op" id="4028679">:=</span>&nbsp;<span class="ident" id="4028682">ioutil</span><span class="op" id="4028688">.</span><span class="ident" id="4028689">ReadFile</span><span class="op" id="4028697">(</span><span class="ident" id="4028698">certFile</span><span class="op" id="4028706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028709">if</span>&nbsp;<span class="ident" id="4028712">err</span>&nbsp;<span class="op" id="4028716">!=</span>&nbsp;<span class="ident" id="4028719">nil</span>&nbsp;<span class="op" id="4028723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028735">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028738">keyPEMBlock</span><span class="op" id="4028749">,</span>&nbsp;<span class="ident" id="4028751">err</span>&nbsp;<span class="op" id="4028755">:=</span>&nbsp;<span class="ident" id="4028758">ioutil</span><span class="op" id="4028764">.</span><span class="ident" id="4028765">ReadFile</span><span class="op" id="4028773">(</span><span class="ident" id="4028774">keyFile</span><span class="op" id="4028781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028784">if</span>&nbsp;<span class="ident" id="4028787">err</span>&nbsp;<span class="op" id="4028791">!=</span>&nbsp;<span class="ident" id="4028794">nil</span>&nbsp;<span class="op" id="4028798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028802">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028813">return</span>&nbsp;<span class="ident" id="4028820">X509KeyPair</span><span class="op" id="4028831">(</span><span class="ident" id="4028832">certPEMBlock</span><span class="op" id="4028844">,</span>&nbsp;<span class="ident" id="4028846">keyPEMBlock</span><span class="op" id="4028857">)</span><br>
<span class="lineno">180</span><span class="op" id="4028859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4028862">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4028925">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4028946">func</span>&nbsp;<span class="ident" id="4028951">X509KeyPair</span><span class="op" id="4028962">(</span><span class="ident" id="4028963">certPEMBlock</span><span class="op" id="4028975">,</span>&nbsp;<span class="ident" id="4028977">keyPEMBlock</span>&nbsp;<span class="op" id="4028989">[</span><span class="op" id="4028990">]</span><span class="builtintype" id="4028991">byte</span><span class="op" id="4028995">)</span>&nbsp;<span class="op" id="4028997">(</span><span class="ident" id="4028998">cert</span>&nbsp;<span class="ident" id="4029003">Certificate</span><span class="op" id="4029014">,</span>&nbsp;<span class="ident" id="4029016">err</span>&nbsp;<span class="builtintype" id="4029020">error</span><span class="op" id="4029025">)</span>&nbsp;<span class="op" id="4029027">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029030">var</span>&nbsp;<span class="ident" id="4029034">certDERBlock</span>&nbsp;<span class="op" id="4029047">*</span><span class="ident" id="4029048">pem</span><span class="op" id="4029051">.</span><span class="ident" id="4029052">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029059">for</span>&nbsp;<span class="op" id="4029063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029067">certDERBlock</span><span class="op" id="4029079">,</span>&nbsp;<span class="ident" id="4029081">certPEMBlock</span>&nbsp;<span class="op" id="4029094">=</span>&nbsp;<span class="ident" id="4029096">pem</span><span class="op" id="4029099">.</span><span class="ident" id="4029100">Decode</span><span class="op" id="4029106">(</span><span class="ident" id="4029107">certPEMBlock</span><span class="op" id="4029119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029123">if</span>&nbsp;<span class="ident" id="4029126">certDERBlock</span>&nbsp;<span class="op" id="4029139">==</span>&nbsp;<span class="ident" id="4029142">nil</span>&nbsp;<span class="op" id="4029146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029151">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029163">if</span>&nbsp;<span class="ident" id="4029166">certDERBlock</span><span class="op" id="4029178">.</span><span class="ident" id="4029179">Type</span>&nbsp;<span class="op" id="4029184">==</span>&nbsp;<span class="string" id="4029187">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4029201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029206">cert</span><span class="op" id="4029210">.</span><span class="ident" id="4029211">Certificate</span>&nbsp;<span class="op" id="4029223">=</span>&nbsp;<span class="builtinfunc" id="4029225">append</span><span class="op" id="4029231">(</span><span class="ident" id="4029232">cert</span><span class="op" id="4029236">.</span><span class="ident" id="4029237">Certificate</span><span class="op" id="4029248">,</span>&nbsp;<span class="ident" id="4029250">certDERBlock</span><span class="op" id="4029262">.</span><span class="ident" id="4029263">Bytes</span><span class="op" id="4029268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029275">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029279">if</span>&nbsp;<span class="builtinfunc" id="4029282">len</span><span class="op" id="4029285">(</span><span class="ident" id="4029286">cert</span><span class="op" id="4029290">.</span><span class="ident" id="4029291">Certificate</span><span class="op" id="4029302">)</span>&nbsp;<span class="op" id="4029304">==</span>&nbsp;<span class="num" id="4029307">0</span>&nbsp;<span class="op" id="4029309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029313">err</span>&nbsp;<span class="op" id="4029317">=</span>&nbsp;<span class="ident" id="4029319">errors</span><span class="op" id="4029325">.</span><span class="ident" id="4029326">New</span><span class="op" id="4029329">(</span><span class="string" id="4029330">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4029380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029384">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029392">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029396">var</span>&nbsp;<span class="ident" id="4029400">keyDERBlock</span>&nbsp;<span class="op" id="4029412">*</span><span class="ident" id="4029413">pem</span><span class="op" id="4029416">.</span><span class="ident" id="4029417">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029424">for</span>&nbsp;<span class="op" id="4029428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029432">keyDERBlock</span><span class="op" id="4029443">,</span>&nbsp;<span class="ident" id="4029445">keyPEMBlock</span>&nbsp;<span class="op" id="4029457">=</span>&nbsp;<span class="ident" id="4029459">pem</span><span class="op" id="4029462">.</span><span class="ident" id="4029463">Decode</span><span class="op" id="4029469">(</span><span class="ident" id="4029470">keyPEMBlock</span><span class="op" id="4029481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029485">if</span>&nbsp;<span class="ident" id="4029488">keyDERBlock</span>&nbsp;<span class="op" id="4029500">==</span>&nbsp;<span class="ident" id="4029503">nil</span>&nbsp;<span class="op" id="4029507">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029512">err</span>&nbsp;<span class="op" id="4029516">=</span>&nbsp;<span class="ident" id="4029518">errors</span><span class="op" id="4029524">.</span><span class="ident" id="4029525">New</span><span class="op" id="4029528">(</span><span class="string" id="4029529">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4029571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029576">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029589">if</span>&nbsp;<span class="ident" id="4029592">keyDERBlock</span><span class="op" id="4029603">.</span><span class="ident" id="4029604">Type</span>&nbsp;<span class="op" id="4029609">==</span>&nbsp;<span class="string" id="4029612">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4029626">||</span>&nbsp;<span class="ident" id="4029629">strings</span><span class="op" id="4029636">.</span><span class="ident" id="4029637">HasSuffix</span><span class="op" id="4029646">(</span><span class="ident" id="4029647">keyDERBlock</span><span class="op" id="4029658">.</span><span class="ident" id="4029659">Type</span><span class="op" id="4029663">,</span>&nbsp;<span class="string" id="4029665">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4029679">)</span>&nbsp;<span class="op" id="4029681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029686">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029701">cert</span><span class="op" id="4029705">.</span><span class="ident" id="4029706">PrivateKey</span><span class="op" id="4029716">,</span>&nbsp;<span class="ident" id="4029718">err</span>&nbsp;<span class="op" id="4029722">=</span>&nbsp;<span class="ident" id="4029724">parsePrivateKey</span><span class="op" id="4029739">(</span><span class="ident" id="4029740">keyDERBlock</span><span class="op" id="4029751">.</span><span class="ident" id="4029752">Bytes</span><span class="op" id="4029757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029760">if</span>&nbsp;<span class="ident" id="4029763">err</span>&nbsp;<span class="op" id="4029767">!=</span>&nbsp;<span class="ident" id="4029770">nil</span>&nbsp;<span class="op" id="4029774">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029778">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4029790">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4029861">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029922">x509Cert</span><span class="op" id="4029930">,</span>&nbsp;<span class="ident" id="4029932">err</span>&nbsp;<span class="op" id="4029936">:=</span>&nbsp;<span class="ident" id="4029939">x509</span><span class="op" id="4029943">.</span><span class="ident" id="4029944">ParseCertificate</span><span class="op" id="4029960">(</span><span class="ident" id="4029961">cert</span><span class="op" id="4029965">.</span><span class="ident" id="4029966">Certificate</span><span class="op" id="4029977">[</span><span class="num" id="4029978">0</span><span class="op" id="4029979">]</span><span class="op" id="4029980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029983">if</span>&nbsp;<span class="ident" id="4029986">err</span>&nbsp;<span class="op" id="4029990">!=</span>&nbsp;<span class="ident" id="4029993">nil</span>&nbsp;<span class="op" id="4029997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030001">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030013">switch</span>&nbsp;<span class="ident" id="4030020">pub</span>&nbsp;<span class="op" id="4030024">:=</span>&nbsp;<span class="ident" id="4030027">x509Cert</span><span class="op" id="4030035">.</span><span class="ident" id="4030036">PublicKey</span><span class="op" id="4030045">.</span><span class="op" id="4030046">(</span><span class="keyword" id="4030047">type</span><span class="op" id="4030051">)</span>&nbsp;<span class="op" id="4030053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030056">case</span>&nbsp;<span class="op" id="4030061">*</span><span class="ident" id="4030062">rsa</span><span class="op" id="4030065">.</span><span class="ident" id="4030066">PublicKey</span><span class="op" id="4030075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030079">priv</span><span class="op" id="4030083">,</span>&nbsp;<span class="ident" id="4030085">ok</span>&nbsp;<span class="op" id="4030088">:=</span>&nbsp;<span class="ident" id="4030091">cert</span><span class="op" id="4030095">.</span><span class="ident" id="4030096">PrivateKey</span><span class="op" id="4030106">.</span><span class="op" id="4030107">(</span><span class="op" id="4030108">*</span><span class="ident" id="4030109">rsa</span><span class="op" id="4030112">.</span><span class="ident" id="4030113">PrivateKey</span><span class="op" id="4030123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030127">if</span>&nbsp;<span class="op" id="4030130">!</span><span class="ident" id="4030131">ok</span>&nbsp;<span class="op" id="4030134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030139">err</span>&nbsp;<span class="op" id="4030143">=</span>&nbsp;<span class="ident" id="4030145">errors</span><span class="op" id="4030151">.</span><span class="ident" id="4030152">New</span><span class="op" id="4030155">(</span><span class="string" id="4030156">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4030217">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030222">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030235">if</span>&nbsp;<span class="ident" id="4030238">pub</span><span class="op" id="4030241">.</span><span class="ident" id="4030242">N</span><span class="op" id="4030243">.</span><span class="ident" id="4030244">Cmp</span><span class="op" id="4030247">(</span><span class="ident" id="4030248">priv</span><span class="op" id="4030252">.</span><span class="ident" id="4030253">N</span><span class="op" id="4030254">)</span>&nbsp;<span class="op" id="4030256">!=</span>&nbsp;<span class="num" id="4030259">0</span>&nbsp;<span class="op" id="4030261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030266">err</span>&nbsp;<span class="op" id="4030270">=</span>&nbsp;<span class="ident" id="4030272">errors</span><span class="op" id="4030278">.</span><span class="ident" id="4030279">New</span><span class="op" id="4030282">(</span><span class="string" id="4030283">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4030334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030339">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030351">case</span>&nbsp;<span class="op" id="4030356">*</span><span class="ident" id="4030357">ecdsa</span><span class="op" id="4030362">.</span><span class="ident" id="4030363">PublicKey</span><span class="op" id="4030372">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030376">priv</span><span class="op" id="4030380">,</span>&nbsp;<span class="ident" id="4030382">ok</span>&nbsp;<span class="op" id="4030385">:=</span>&nbsp;<span class="ident" id="4030388">cert</span><span class="op" id="4030392">.</span><span class="ident" id="4030393">PrivateKey</span><span class="op" id="4030403">.</span><span class="op" id="4030404">(</span><span class="op" id="4030405">*</span><span class="ident" id="4030406">ecdsa</span><span class="op" id="4030411">.</span><span class="ident" id="4030412">PrivateKey</span><span class="op" id="4030422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030426">if</span>&nbsp;<span class="op" id="4030429">!</span><span class="ident" id="4030430">ok</span>&nbsp;<span class="op" id="4030433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030438">err</span>&nbsp;<span class="op" id="4030442">=</span>&nbsp;<span class="ident" id="4030444">errors</span><span class="op" id="4030450">.</span><span class="ident" id="4030451">New</span><span class="op" id="4030454">(</span><span class="string" id="4030455">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4030516">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030521">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030535">if</span>&nbsp;<span class="ident" id="4030538">pub</span><span class="op" id="4030541">.</span><span class="ident" id="4030542">X</span><span class="op" id="4030543">.</span><span class="ident" id="4030544">Cmp</span><span class="op" id="4030547">(</span><span class="ident" id="4030548">priv</span><span class="op" id="4030552">.</span><span class="ident" id="4030553">X</span><span class="op" id="4030554">)</span>&nbsp;<span class="op" id="4030556">!=</span>&nbsp;<span class="num" id="4030559">0</span>&nbsp;<span class="op" id="4030561">||</span>&nbsp;<span class="ident" id="4030564">pub</span><span class="op" id="4030567">.</span><span class="ident" id="4030568">Y</span><span class="op" id="4030569">.</span><span class="ident" id="4030570">Cmp</span><span class="op" id="4030573">(</span><span class="ident" id="4030574">priv</span><span class="op" id="4030578">.</span><span class="ident" id="4030579">Y</span><span class="op" id="4030580">)</span>&nbsp;<span class="op" id="4030582">!=</span>&nbsp;<span class="num" id="4030585">0</span>&nbsp;<span class="op" id="4030587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030592">err</span>&nbsp;<span class="op" id="4030596">=</span>&nbsp;<span class="ident" id="4030598">errors</span><span class="op" id="4030604">.</span><span class="ident" id="4030605">New</span><span class="op" id="4030608">(</span><span class="string" id="4030609">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4030660">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030665">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030677">default</span><span class="op" id="4030684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030688">err</span>&nbsp;<span class="op" id="4030692">=</span>&nbsp;<span class="ident" id="4030694">errors</span><span class="op" id="4030700">.</span><span class="ident" id="4030701">New</span><span class="op" id="4030704">(</span><span class="string" id="4030705">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4030747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030751">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030763">return</span><br>
<span class="lineno"></span><span class="op" id="4030770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4030773">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4030850">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4030928">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4031007">func</span>&nbsp;<span class="ident" id="4031012">parsePrivateKey</span><span class="op" id="4031027">(</span><span class="ident" id="4031028">der</span>&nbsp;<span class="op" id="4031032">[</span><span class="op" id="4031033">]</span><span class="builtintype" id="4031034">byte</span><span class="op" id="4031038">)</span>&nbsp;<span class="op" id="4031040">(</span><span class="ident" id="4031041">crypto</span><span class="op" id="4031047">.</span><span class="ident" id="4031048">PrivateKey</span><span class="op" id="4031058">,</span>&nbsp;<span class="builtintype" id="4031060">error</span><span class="op" id="4031065">)</span>&nbsp;<span class="op" id="4031067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031070">if</span>&nbsp;<span class="ident" id="4031073">key</span><span class="op" id="4031076">,</span>&nbsp;<span class="ident" id="4031078">err</span>&nbsp;<span class="op" id="4031082">:=</span>&nbsp;<span class="ident" id="4031085">x509</span><span class="op" id="4031089">.</span><span class="ident" id="4031090">ParsePKCS1PrivateKey</span><span class="op" id="4031110">(</span><span class="ident" id="4031111">der</span><span class="op" id="4031114">)</span><span class="op" id="4031115">;</span>&nbsp;<span class="ident" id="4031117">err</span>&nbsp;<span class="op" id="4031121">==</span>&nbsp;<span class="ident" id="4031124">nil</span>&nbsp;<span class="op" id="4031128">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031132">return</span>&nbsp;<span class="ident" id="4031139">key</span><span class="op" id="4031142">,</span>&nbsp;<span class="ident" id="4031144">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031152">if</span>&nbsp;<span class="ident" id="4031155">key</span><span class="op" id="4031158">,</span>&nbsp;<span class="ident" id="4031160">err</span>&nbsp;<span class="op" id="4031164">:=</span>&nbsp;<span class="ident" id="4031167">x509</span><span class="op" id="4031171">.</span><span class="ident" id="4031172">ParsePKCS8PrivateKey</span><span class="op" id="4031192">(</span><span class="ident" id="4031193">der</span><span class="op" id="4031196">)</span><span class="op" id="4031197">;</span>&nbsp;<span class="ident" id="4031199">err</span>&nbsp;<span class="op" id="4031203">==</span>&nbsp;<span class="ident" id="4031206">nil</span>&nbsp;<span class="op" id="4031210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031214">switch</span>&nbsp;<span class="ident" id="4031221">key</span>&nbsp;<span class="op" id="4031225">:=</span>&nbsp;<span class="ident" id="4031228">key</span><span class="op" id="4031231">.</span><span class="op" id="4031232">(</span><span class="keyword" id="4031233">type</span><span class="op" id="4031237">)</span>&nbsp;<span class="op" id="4031239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031243">case</span>&nbsp;<span class="op" id="4031248">*</span><span class="ident" id="4031249">rsa</span><span class="op" id="4031252">.</span><span class="ident" id="4031253">PrivateKey</span><span class="op" id="4031263">,</span>&nbsp;<span class="op" id="4031265">*</span><span class="ident" id="4031266">ecdsa</span><span class="op" id="4031271">.</span><span class="ident" id="4031272">PrivateKey</span><span class="op" id="4031282">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031287">return</span>&nbsp;<span class="ident" id="4031294">key</span><span class="op" id="4031297">,</span>&nbsp;<span class="ident" id="4031299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031305">default</span><span class="op" id="4031312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031317">return</span>&nbsp;<span class="ident" id="4031324">nil</span><span class="op" id="4031327">,</span>&nbsp;<span class="ident" id="4031329">errors</span><span class="op" id="4031335">.</span><span class="ident" id="4031336">New</span><span class="op" id="4031339">(</span><span class="string" id="4031340">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4031403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031410">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031413">if</span>&nbsp;<span class="ident" id="4031416">key</span><span class="op" id="4031419">,</span>&nbsp;<span class="ident" id="4031421">err</span>&nbsp;<span class="op" id="4031425">:=</span>&nbsp;<span class="ident" id="4031428">x509</span><span class="op" id="4031432">.</span><span class="ident" id="4031433">ParseECPrivateKey</span><span class="op" id="4031450">(</span><span class="ident" id="4031451">der</span><span class="op" id="4031454">)</span><span class="op" id="4031455">;</span>&nbsp;<span class="ident" id="4031457">err</span>&nbsp;<span class="op" id="4031461">==</span>&nbsp;<span class="ident" id="4031464">nil</span>&nbsp;<span class="op" id="4031468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031472">return</span>&nbsp;<span class="ident" id="4031479">key</span><span class="op" id="4031482">,</span>&nbsp;<span class="ident" id="4031484">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031493">return</span>&nbsp;<span class="ident" id="4031500">nil</span><span class="op" id="4031503">,</span>&nbsp;<span class="ident" id="4031505">errors</span><span class="op" id="4031511">.</span><span class="ident" id="4031512">New</span><span class="op" id="4031515">(</span><span class="string" id="4031516">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4031557">)</span><br>
<span class="lineno">275</span><span class="op" id="4031559">}</span>
</div>
</body>
</html>
