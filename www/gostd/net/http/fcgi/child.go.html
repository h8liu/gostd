<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6476493">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6476548">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6476602">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6476653">package</span>&nbsp;<span class="ident" id="6476661">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6476667">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6476741">import</span>&nbsp;<span class="op" id="6476748">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476751">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476761">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476768">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476774">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476787">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476794">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476806">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476822">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476828">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476839">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6476847">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6476854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6476857">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6476938">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6476976">type</span>&nbsp;<span class="ident" id="6476981">request</span>&nbsp;<span class="keyword" id="6476989">struct</span>&nbsp;<span class="op" id="6476996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6476999">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6477009">*</span><span class="ident" id="6477010">io</span><span class="op" id="6477012">.</span><span class="ident" id="6477013">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477025">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6477035">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477043">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6477053">map</span><span class="op" id="6477056">[</span><span class="builtintype" id="6477057">string</span><span class="op" id="6477063">]</span><span class="builtintype" id="6477064">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477072">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6477082">[</span><span class="num" id="6477083">1024</span><span class="op" id="6477087">]</span><span class="builtintype" id="6477088">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477094">rawParams</span>&nbsp;<span class="op" id="6477104">[</span><span class="op" id="6477105">]</span><span class="builtintype" id="6477106">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477112">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6477122">bool</span><br>
<span class="lineno"></span><span class="op" id="6477127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6477130">func</span>&nbsp;<span class="ident" id="6477135">newRequest</span><span class="op" id="6477145">(</span><span class="ident" id="6477146">reqId</span>&nbsp;<span class="builtintype" id="6477152">uint16</span><span class="op" id="6477158">,</span>&nbsp;<span class="ident" id="6477160">flags</span>&nbsp;<span class="builtintype" id="6477166">uint8</span><span class="op" id="6477171">)</span>&nbsp;<span class="op" id="6477173">*</span><span class="ident" id="6477174">request</span>&nbsp;<span class="op" id="6477182">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477185">r</span>&nbsp;<span class="op" id="6477187">:=</span>&nbsp;<span class="op" id="6477190">&amp;</span><span class="ident" id="6477191">request</span><span class="op" id="6477198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477202">reqId</span><span class="op" id="6477207">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6477212">reqId</span><span class="op" id="6477217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477221">params</span><span class="op" id="6477227">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6477231">map</span><span class="op" id="6477234">[</span><span class="builtintype" id="6477235">string</span><span class="op" id="6477241">]</span><span class="builtintype" id="6477242">string</span><span class="op" id="6477248">{</span><span class="op" id="6477249">}</span><span class="op" id="6477250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477254">keepConn</span><span class="op" id="6477262">:</span>&nbsp;<span class="ident" id="6477264">flags</span><span class="op" id="6477269">&amp;</span><span class="ident" id="6477270">flagKeepConn</span>&nbsp;<span class="op" id="6477283">!=</span>&nbsp;<span class="num" id="6477286">0</span><span class="op" id="6477287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6477290">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477293">r</span><span class="op" id="6477294">.</span><span class="ident" id="6477295">rawParams</span>&nbsp;<span class="op" id="6477305">=</span>&nbsp;<span class="ident" id="6477307">r</span><span class="op" id="6477308">.</span><span class="ident" id="6477309">buf</span><span class="op" id="6477312">[</span><span class="op" id="6477313">:</span><span class="num" id="6477314">0</span><span class="op" id="6477315">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477318">return</span>&nbsp;<span class="ident" id="6477325">r</span><br>
<span class="lineno"></span><span class="op" id="6477327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6477330">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6477382">func</span>&nbsp;<span class="op" id="6477387">(</span><span class="ident" id="6477388">r</span>&nbsp;<span class="op" id="6477390">*</span><span class="ident" id="6477391">request</span><span class="op" id="6477398">)</span>&nbsp;<span class="ident" id="6477400">parseParams</span><span class="op" id="6477411">(</span><span class="op" id="6477412">)</span>&nbsp;<span class="op" id="6477414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477417">text</span>&nbsp;<span class="op" id="6477422">:=</span>&nbsp;<span class="ident" id="6477425">r</span><span class="op" id="6477426">.</span><span class="ident" id="6477427">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477438">r</span><span class="op" id="6477439">.</span><span class="ident" id="6477440">rawParams</span>&nbsp;<span class="op" id="6477450">=</span>&nbsp;<span class="ident" id="6477452">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477457">for</span>&nbsp;<span class="builtinfunc" id="6477461">len</span><span class="op" id="6477464">(</span><span class="ident" id="6477465">text</span><span class="op" id="6477469">)</span>&nbsp;<span class="op" id="6477471">&gt;</span>&nbsp;<span class="num" id="6477473">0</span>&nbsp;<span class="op" id="6477475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477479">keyLen</span><span class="op" id="6477485">,</span>&nbsp;<span class="ident" id="6477487">n</span>&nbsp;<span class="op" id="6477489">:=</span>&nbsp;<span class="ident" id="6477492">readSize</span><span class="op" id="6477500">(</span><span class="ident" id="6477501">text</span><span class="op" id="6477505">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477509">if</span>&nbsp;<span class="ident" id="6477512">n</span>&nbsp;<span class="op" id="6477514">==</span>&nbsp;<span class="num" id="6477517">0</span>&nbsp;<span class="op" id="6477519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477524">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6477533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477537">text</span>&nbsp;<span class="op" id="6477542">=</span>&nbsp;<span class="ident" id="6477544">text</span><span class="op" id="6477548">[</span><span class="ident" id="6477549">n</span><span class="op" id="6477550">:</span><span class="op" id="6477551">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477555">valLen</span><span class="op" id="6477561">,</span>&nbsp;<span class="ident" id="6477563">n</span>&nbsp;<span class="op" id="6477565">:=</span>&nbsp;<span class="ident" id="6477568">readSize</span><span class="op" id="6477576">(</span><span class="ident" id="6477577">text</span><span class="op" id="6477581">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477585">if</span>&nbsp;<span class="ident" id="6477588">n</span>&nbsp;<span class="op" id="6477590">==</span>&nbsp;<span class="num" id="6477593">0</span>&nbsp;<span class="op" id="6477595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6477609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477613">text</span>&nbsp;<span class="op" id="6477618">=</span>&nbsp;<span class="ident" id="6477620">text</span><span class="op" id="6477624">[</span><span class="ident" id="6477625">n</span><span class="op" id="6477626">:</span><span class="op" id="6477627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477631">key</span>&nbsp;<span class="op" id="6477635">:=</span>&nbsp;<span class="ident" id="6477638">readString</span><span class="op" id="6477648">(</span><span class="ident" id="6477649">text</span><span class="op" id="6477653">,</span>&nbsp;<span class="ident" id="6477655">keyLen</span><span class="op" id="6477661">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477665">text</span>&nbsp;<span class="op" id="6477670">=</span>&nbsp;<span class="ident" id="6477672">text</span><span class="op" id="6477676">[</span><span class="ident" id="6477677">keyLen</span><span class="op" id="6477683">:</span><span class="op" id="6477684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477688">val</span>&nbsp;<span class="op" id="6477692">:=</span>&nbsp;<span class="ident" id="6477695">readString</span><span class="op" id="6477705">(</span><span class="ident" id="6477706">text</span><span class="op" id="6477710">,</span>&nbsp;<span class="ident" id="6477712">valLen</span><span class="op" id="6477718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477722">text</span>&nbsp;<span class="op" id="6477727">=</span>&nbsp;<span class="ident" id="6477729">text</span><span class="op" id="6477733">[</span><span class="ident" id="6477734">valLen</span><span class="op" id="6477740">:</span><span class="op" id="6477741">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477745">r</span><span class="op" id="6477746">.</span><span class="ident" id="6477747">params</span><span class="op" id="6477753">[</span><span class="ident" id="6477754">key</span><span class="op" id="6477757">]</span>&nbsp;<span class="op" id="6477759">=</span>&nbsp;<span class="ident" id="6477761">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6477766">}</span><br>
<span class="lineno">65</span><span class="op" id="6477768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6477771">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6477815">type</span>&nbsp;<span class="ident" id="6477820">response</span>&nbsp;<span class="keyword" id="6477829">struct</span>&nbsp;<span class="op" id="6477836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477839">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6477851">*</span><span class="ident" id="6477852">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477861">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6477873">http</span><span class="op" id="6477877">.</span><span class="ident" id="6477878">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477886">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6477898">*</span><span class="ident" id="6477899">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6477910">wroteHeader</span>&nbsp;<span class="builtintype" id="6477922">bool</span><br>
<span class="lineno"></span><span class="op" id="6477927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6477930">func</span>&nbsp;<span class="ident" id="6477935">newResponse</span><span class="op" id="6477946">(</span><span class="ident" id="6477947">c</span>&nbsp;<span class="op" id="6477949">*</span><span class="ident" id="6477950">child</span><span class="op" id="6477955">,</span>&nbsp;<span class="ident" id="6477957">req</span>&nbsp;<span class="op" id="6477961">*</span><span class="ident" id="6477962">request</span><span class="op" id="6477969">)</span>&nbsp;<span class="op" id="6477971">*</span><span class="ident" id="6477972">response</span>&nbsp;<span class="op" id="6477981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6477984">return</span>&nbsp;<span class="op" id="6477991">&amp;</span><span class="ident" id="6477992">response</span><span class="op" id="6478000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478004">req</span><span class="op" id="6478007">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6478012">req</span><span class="op" id="6478015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478019">header</span><span class="op" id="6478025">:</span>&nbsp;<span class="ident" id="6478027">http</span><span class="op" id="6478031">.</span><span class="ident" id="6478032">Header</span><span class="op" id="6478038">{</span><span class="op" id="6478039">}</span><span class="op" id="6478040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478044">w</span><span class="op" id="6478045">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6478052">newWriter</span><span class="op" id="6478061">(</span><span class="ident" id="6478062">c</span><span class="op" id="6478063">.</span><span class="ident" id="6478064">conn</span><span class="op" id="6478068">,</span>&nbsp;<span class="ident" id="6478070">typeStdout</span><span class="op" id="6478080">,</span>&nbsp;<span class="ident" id="6478082">req</span><span class="op" id="6478085">.</span><span class="ident" id="6478086">reqId</span><span class="op" id="6478091">)</span><span class="op" id="6478092">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478095">}</span><br>
<span class="lineno"></span><span class="op" id="6478097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6478100">func</span>&nbsp;<span class="op" id="6478105">(</span><span class="ident" id="6478106">r</span>&nbsp;<span class="op" id="6478108">*</span><span class="ident" id="6478109">response</span><span class="op" id="6478117">)</span>&nbsp;<span class="ident" id="6478119">Header</span><span class="op" id="6478125">(</span><span class="op" id="6478126">)</span>&nbsp;<span class="ident" id="6478128">http</span><span class="op" id="6478132">.</span><span class="ident" id="6478133">Header</span>&nbsp;<span class="op" id="6478140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478143">return</span>&nbsp;<span class="ident" id="6478150">r</span><span class="op" id="6478151">.</span><span class="ident" id="6478152">header</span><br>
<span class="lineno">85</span><span class="op" id="6478159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6478162">func</span>&nbsp;<span class="op" id="6478167">(</span><span class="ident" id="6478168">r</span>&nbsp;<span class="op" id="6478170">*</span><span class="ident" id="6478171">response</span><span class="op" id="6478179">)</span>&nbsp;<span class="ident" id="6478181">Write</span><span class="op" id="6478186">(</span><span class="ident" id="6478187">data</span>&nbsp;<span class="op" id="6478192">[</span><span class="op" id="6478193">]</span><span class="builtintype" id="6478194">byte</span><span class="op" id="6478198">)</span>&nbsp;<span class="op" id="6478200">(</span><span class="builtintype" id="6478201">int</span><span class="op" id="6478204">,</span>&nbsp;<span class="builtintype" id="6478206">error</span><span class="op" id="6478211">)</span>&nbsp;<span class="op" id="6478213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478216">if</span>&nbsp;<span class="op" id="6478219">!</span><span class="ident" id="6478220">r</span><span class="op" id="6478221">.</span><span class="ident" id="6478222">wroteHeader</span>&nbsp;<span class="op" id="6478234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478238">r</span><span class="op" id="6478239">.</span><span class="ident" id="6478240">WriteHeader</span><span class="op" id="6478251">(</span><span class="ident" id="6478252">http</span><span class="op" id="6478256">.</span><span class="ident" id="6478257">StatusOK</span><span class="op" id="6478265">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478271">return</span>&nbsp;<span class="ident" id="6478278">r</span><span class="op" id="6478279">.</span><span class="ident" id="6478280">w</span><span class="op" id="6478281">.</span><span class="ident" id="6478282">Write</span><span class="op" id="6478287">(</span><span class="ident" id="6478288">data</span><span class="op" id="6478292">)</span><br>
<span class="lineno"></span><span class="op" id="6478294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6478297">func</span>&nbsp;<span class="op" id="6478302">(</span><span class="ident" id="6478303">r</span>&nbsp;<span class="op" id="6478305">*</span><span class="ident" id="6478306">response</span><span class="op" id="6478314">)</span>&nbsp;<span class="ident" id="6478316">WriteHeader</span><span class="op" id="6478327">(</span><span class="ident" id="6478328">code</span>&nbsp;<span class="builtintype" id="6478333">int</span><span class="op" id="6478336">)</span>&nbsp;<span class="op" id="6478338">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478341">if</span>&nbsp;<span class="ident" id="6478344">r</span><span class="op" id="6478345">.</span><span class="ident" id="6478346">wroteHeader</span>&nbsp;<span class="op" id="6478358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478373">r</span><span class="op" id="6478374">.</span><span class="ident" id="6478375">wroteHeader</span>&nbsp;<span class="op" id="6478387">=</span>&nbsp;<span class="builtintype" id="6478389">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478395">if</span>&nbsp;<span class="ident" id="6478398">code</span>&nbsp;<span class="op" id="6478403">==</span>&nbsp;<span class="ident" id="6478406">http</span><span class="op" id="6478410">.</span><span class="ident" id="6478411">StatusNotModified</span>&nbsp;<span class="op" id="6478429">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6478433">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478458">r</span><span class="op" id="6478459">.</span><span class="ident" id="6478460">header</span><span class="op" id="6478466">.</span><span class="ident" id="6478467">Del</span><span class="op" id="6478470">(</span><span class="string" id="6478471">&#34;Content-Type&#34;</span><span class="op" id="6478485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478489">r</span><span class="op" id="6478490">.</span><span class="ident" id="6478491">header</span><span class="op" id="6478497">.</span><span class="ident" id="6478498">Del</span><span class="op" id="6478501">(</span><span class="string" id="6478502">&#34;Content-Length&#34;</span><span class="op" id="6478518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478522">r</span><span class="op" id="6478523">.</span><span class="ident" id="6478524">header</span><span class="op" id="6478530">.</span><span class="ident" id="6478531">Del</span><span class="op" id="6478534">(</span><span class="string" id="6478535">&#34;Transfer-Encoding&#34;</span><span class="op" id="6478554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478557">}</span>&nbsp;<span class="keyword" id="6478559">else</span>&nbsp;<span class="keyword" id="6478564">if</span>&nbsp;<span class="ident" id="6478567">r</span><span class="op" id="6478568">.</span><span class="ident" id="6478569">header</span><span class="op" id="6478575">.</span><span class="ident" id="6478576">Get</span><span class="op" id="6478579">(</span><span class="string" id="6478580">&#34;Content-Type&#34;</span><span class="op" id="6478594">)</span>&nbsp;<span class="op" id="6478596">==</span>&nbsp;<span class="string" id="6478599">&#34;&#34;</span>&nbsp;<span class="op" id="6478602">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478606">r</span><span class="op" id="6478607">.</span><span class="ident" id="6478608">header</span><span class="op" id="6478614">.</span><span class="ident" id="6478615">Set</span><span class="op" id="6478618">(</span><span class="string" id="6478619">&#34;Content-Type&#34;</span><span class="op" id="6478633">,</span>&nbsp;<span class="string" id="6478635">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6478661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478668">if</span>&nbsp;<span class="ident" id="6478671">r</span><span class="op" id="6478672">.</span><span class="ident" id="6478673">header</span><span class="op" id="6478679">.</span><span class="ident" id="6478680">Get</span><span class="op" id="6478683">(</span><span class="string" id="6478684">&#34;Date&#34;</span><span class="op" id="6478690">)</span>&nbsp;<span class="op" id="6478692">==</span>&nbsp;<span class="string" id="6478695">&#34;&#34;</span>&nbsp;<span class="op" id="6478698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478702">r</span><span class="op" id="6478703">.</span><span class="ident" id="6478704">header</span><span class="op" id="6478710">.</span><span class="ident" id="6478711">Set</span><span class="op" id="6478714">(</span><span class="string" id="6478715">&#34;Date&#34;</span><span class="op" id="6478721">,</span>&nbsp;<span class="ident" id="6478723">time</span><span class="op" id="6478727">.</span><span class="ident" id="6478728">Now</span><span class="op" id="6478731">(</span><span class="op" id="6478732">)</span><span class="op" id="6478733">.</span><span class="ident" id="6478734">UTC</span><span class="op" id="6478737">(</span><span class="op" id="6478738">)</span><span class="op" id="6478739">.</span><span class="ident" id="6478740">Format</span><span class="op" id="6478746">(</span><span class="ident" id="6478747">http</span><span class="op" id="6478751">.</span><span class="ident" id="6478752">TimeFormat</span><span class="op" id="6478762">)</span><span class="op" id="6478763">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478770">fmt</span><span class="op" id="6478773">.</span><span class="ident" id="6478774">Fprintf</span><span class="op" id="6478781">(</span><span class="ident" id="6478782">r</span><span class="op" id="6478783">.</span><span class="ident" id="6478784">w</span><span class="op" id="6478785">,</span>&nbsp;<span class="string" id="6478787">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6478806">,</span>&nbsp;<span class="ident" id="6478808">code</span><span class="op" id="6478812">,</span>&nbsp;<span class="ident" id="6478814">http</span><span class="op" id="6478818">.</span><span class="ident" id="6478819">StatusText</span><span class="op" id="6478829">(</span><span class="ident" id="6478830">code</span><span class="op" id="6478834">)</span><span class="op" id="6478835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478838">r</span><span class="op" id="6478839">.</span><span class="ident" id="6478840">header</span><span class="op" id="6478846">.</span><span class="ident" id="6478847">Write</span><span class="op" id="6478852">(</span><span class="ident" id="6478853">r</span><span class="op" id="6478854">.</span><span class="ident" id="6478855">w</span><span class="op" id="6478856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478859">r</span><span class="op" id="6478860">.</span><span class="ident" id="6478861">w</span><span class="op" id="6478862">.</span><span class="ident" id="6478863">WriteString</span><span class="op" id="6478874">(</span><span class="string" id="6478875">&#34;\r\n&#34;</span><span class="op" id="6478881">)</span><br>
<span class="lineno">115</span><span class="op" id="6478883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6478886">func</span>&nbsp;<span class="op" id="6478891">(</span><span class="ident" id="6478892">r</span>&nbsp;<span class="op" id="6478894">*</span><span class="ident" id="6478895">response</span><span class="op" id="6478903">)</span>&nbsp;<span class="ident" id="6478905">Flush</span><span class="op" id="6478910">(</span><span class="op" id="6478911">)</span>&nbsp;<span class="op" id="6478913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6478916">if</span>&nbsp;<span class="op" id="6478919">!</span><span class="ident" id="6478920">r</span><span class="op" id="6478921">.</span><span class="ident" id="6478922">wroteHeader</span>&nbsp;<span class="op" id="6478934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478938">r</span><span class="op" id="6478939">.</span><span class="ident" id="6478940">WriteHeader</span><span class="op" id="6478951">(</span><span class="ident" id="6478952">http</span><span class="op" id="6478956">.</span><span class="ident" id="6478957">StatusOK</span><span class="op" id="6478965">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6478968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6478971">r</span><span class="op" id="6478972">.</span><span class="ident" id="6478973">w</span><span class="op" id="6478974">.</span><span class="ident" id="6478975">Flush</span><span class="op" id="6478980">(</span><span class="op" id="6478981">)</span><br>
<span class="lineno"></span><span class="op" id="6478983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6478986">func</span>&nbsp;<span class="op" id="6478991">(</span><span class="ident" id="6478992">r</span>&nbsp;<span class="op" id="6478994">*</span><span class="ident" id="6478995">response</span><span class="op" id="6479003">)</span>&nbsp;<span class="ident" id="6479005">Close</span><span class="op" id="6479010">(</span><span class="op" id="6479011">)</span>&nbsp;<span class="builtintype" id="6479013">error</span>&nbsp;<span class="op" id="6479019">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479022">r</span><span class="op" id="6479023">.</span><span class="ident" id="6479024">Flush</span><span class="op" id="6479029">(</span><span class="op" id="6479030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479033">return</span>&nbsp;<span class="ident" id="6479040">r</span><span class="op" id="6479041">.</span><span class="ident" id="6479042">w</span><span class="op" id="6479043">.</span><span class="ident" id="6479044">Close</span><span class="op" id="6479049">(</span><span class="op" id="6479050">)</span><br>
<span class="lineno"></span><span class="op" id="6479052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6479055">type</span>&nbsp;<span class="ident" id="6479060">child</span>&nbsp;<span class="keyword" id="6479066">struct</span>&nbsp;<span class="op" id="6479073">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479076">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6479084">*</span><span class="ident" id="6479085">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479091">handler</span>&nbsp;<span class="ident" id="6479099">http</span><span class="op" id="6479103">.</span><span class="ident" id="6479104">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479114">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6479123">sync</span><span class="op" id="6479127">.</span><span class="ident" id="6479128">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6479143">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479166">requests</span>&nbsp;<span class="keyword" id="6479175">map</span><span class="op" id="6479178">[</span><span class="builtintype" id="6479179">uint16</span><span class="op" id="6479185">]</span><span class="op" id="6479186">*</span><span class="ident" id="6479187">request</span>&nbsp;<span class="comment" id="6479195">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6479218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6479221">func</span>&nbsp;<span class="ident" id="6479226">newChild</span><span class="op" id="6479234">(</span><span class="ident" id="6479235">rwc</span>&nbsp;<span class="ident" id="6479239">io</span><span class="op" id="6479241">.</span><span class="ident" id="6479242">ReadWriteCloser</span><span class="op" id="6479257">,</span>&nbsp;<span class="ident" id="6479259">handler</span>&nbsp;<span class="ident" id="6479267">http</span><span class="op" id="6479271">.</span><span class="ident" id="6479272">Handler</span><span class="op" id="6479279">)</span>&nbsp;<span class="op" id="6479281">*</span><span class="ident" id="6479282">child</span>&nbsp;<span class="op" id="6479288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479291">return</span>&nbsp;<span class="op" id="6479298">&amp;</span><span class="ident" id="6479299">child</span><span class="op" id="6479304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479308">conn</span><span class="op" id="6479312">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6479318">newConn</span><span class="op" id="6479325">(</span><span class="ident" id="6479326">rwc</span><span class="op" id="6479329">)</span><span class="op" id="6479330">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479334">handler</span><span class="op" id="6479341">:</span>&nbsp;&nbsp;<span class="ident" id="6479344">handler</span><span class="op" id="6479351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479355">requests</span><span class="op" id="6479363">:</span>&nbsp;<span class="builtinfunc" id="6479365">make</span><span class="op" id="6479369">(</span><span class="keyword" id="6479370">map</span><span class="op" id="6479373">[</span><span class="builtintype" id="6479374">uint16</span><span class="op" id="6479380">]</span><span class="op" id="6479381">*</span><span class="ident" id="6479382">request</span><span class="op" id="6479389">)</span><span class="op" id="6479390">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6479393">}</span><br>
<span class="lineno"></span><span class="op" id="6479395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6479398">func</span>&nbsp;<span class="op" id="6479403">(</span><span class="ident" id="6479404">c</span>&nbsp;<span class="op" id="6479406">*</span><span class="ident" id="6479407">child</span><span class="op" id="6479412">)</span>&nbsp;<span class="ident" id="6479414">serve</span><span class="op" id="6479419">(</span><span class="op" id="6479420">)</span>&nbsp;<span class="op" id="6479422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479425">defer</span>&nbsp;<span class="ident" id="6479431">c</span><span class="op" id="6479432">.</span><span class="ident" id="6479433">conn</span><span class="op" id="6479437">.</span><span class="ident" id="6479438">Close</span><span class="op" id="6479443">(</span><span class="op" id="6479444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479447">var</span>&nbsp;<span class="ident" id="6479451">rec</span>&nbsp;<span class="ident" id="6479455">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479463">for</span>&nbsp;<span class="op" id="6479467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479471">if</span>&nbsp;<span class="ident" id="6479474">err</span>&nbsp;<span class="op" id="6479478">:=</span>&nbsp;<span class="ident" id="6479481">rec</span><span class="op" id="6479484">.</span><span class="ident" id="6479485">read</span><span class="op" id="6479489">(</span><span class="ident" id="6479490">c</span><span class="op" id="6479491">.</span><span class="ident" id="6479492">conn</span><span class="op" id="6479496">.</span><span class="ident" id="6479497">rwc</span><span class="op" id="6479500">)</span><span class="op" id="6479501">;</span>&nbsp;<span class="ident" id="6479503">err</span>&nbsp;<span class="op" id="6479507">!=</span>&nbsp;<span class="ident" id="6479510">nil</span>&nbsp;<span class="op" id="6479514">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479519">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6479528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479532">if</span>&nbsp;<span class="ident" id="6479535">err</span>&nbsp;<span class="op" id="6479539">:=</span>&nbsp;<span class="ident" id="6479542">c</span><span class="op" id="6479543">.</span><span class="ident" id="6479544">handleRecord</span><span class="op" id="6479556">(</span><span class="op" id="6479557">&amp;</span><span class="ident" id="6479558">rec</span><span class="op" id="6479561">)</span><span class="op" id="6479562">;</span>&nbsp;<span class="ident" id="6479564">err</span>&nbsp;<span class="op" id="6479568">!=</span>&nbsp;<span class="ident" id="6479571">nil</span>&nbsp;<span class="op" id="6479575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479580">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6479589">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6479592">}</span><br>
<span class="lineno"></span><span class="op" id="6479594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6479597">var</span>&nbsp;<span class="ident" id="6479601">errCloseConn</span>&nbsp;<span class="op" id="6479614">=</span>&nbsp;<span class="ident" id="6479616">errors</span><span class="op" id="6479622">.</span><span class="ident" id="6479623">New</span><span class="op" id="6479626">(</span><span class="string" id="6479627">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6479662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6479665">var</span>&nbsp;<span class="ident" id="6479669">emptyBody</span>&nbsp;<span class="op" id="6479679">=</span>&nbsp;<span class="ident" id="6479681">ioutil</span><span class="op" id="6479687">.</span><span class="ident" id="6479688">NopCloser</span><span class="op" id="6479697">(</span><span class="ident" id="6479698">strings</span><span class="op" id="6479705">.</span><span class="ident" id="6479706">NewReader</span><span class="op" id="6479715">(</span><span class="string" id="6479716">&#34;&#34;</span><span class="op" id="6479718">)</span><span class="op" id="6479719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6479722">func</span>&nbsp;<span class="op" id="6479727">(</span><span class="ident" id="6479728">c</span>&nbsp;<span class="op" id="6479730">*</span><span class="ident" id="6479731">child</span><span class="op" id="6479736">)</span>&nbsp;<span class="ident" id="6479738">handleRecord</span><span class="op" id="6479750">(</span><span class="ident" id="6479751">rec</span>&nbsp;<span class="op" id="6479755">*</span><span class="ident" id="6479756">record</span><span class="op" id="6479762">)</span>&nbsp;<span class="builtintype" id="6479764">error</span>&nbsp;<span class="op" id="6479770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479773">c</span><span class="op" id="6479774">.</span><span class="ident" id="6479775">mu</span><span class="op" id="6479777">.</span><span class="ident" id="6479778">Lock</span><span class="op" id="6479782">(</span><span class="op" id="6479783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479786">req</span><span class="op" id="6479789">,</span>&nbsp;<span class="ident" id="6479791">ok</span>&nbsp;<span class="op" id="6479794">:=</span>&nbsp;<span class="ident" id="6479797">c</span><span class="op" id="6479798">.</span><span class="ident" id="6479799">requests</span><span class="op" id="6479807">[</span><span class="ident" id="6479808">rec</span><span class="op" id="6479811">.</span><span class="ident" id="6479812">h</span><span class="op" id="6479813">.</span><span class="ident" id="6479814">Id</span><span class="op" id="6479816">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6479819">c</span><span class="op" id="6479820">.</span><span class="ident" id="6479821">mu</span><span class="op" id="6479823">.</span><span class="ident" id="6479824">Unlock</span><span class="op" id="6479830">(</span><span class="op" id="6479831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479834">if</span>&nbsp;<span class="op" id="6479837">!</span><span class="ident" id="6479838">ok</span>&nbsp;<span class="op" id="6479841">&amp;&amp;</span>&nbsp;<span class="ident" id="6479844">rec</span><span class="op" id="6479847">.</span><span class="ident" id="6479848">h</span><span class="op" id="6479849">.</span><span class="ident" id="6479850">Type</span>&nbsp;<span class="op" id="6479855">!=</span>&nbsp;<span class="ident" id="6479858">typeBeginRequest</span>&nbsp;<span class="op" id="6479875">&amp;&amp;</span>&nbsp;<span class="ident" id="6479878">rec</span><span class="op" id="6479881">.</span><span class="ident" id="6479882">h</span><span class="op" id="6479883">.</span><span class="ident" id="6479884">Type</span>&nbsp;<span class="op" id="6479889">!=</span>&nbsp;<span class="ident" id="6479892">typeGetValues</span>&nbsp;<span class="op" id="6479906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6479910">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479960">return</span>&nbsp;<span class="ident" id="6479967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6479972">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479976">switch</span>&nbsp;<span class="ident" id="6479983">rec</span><span class="op" id="6479986">.</span><span class="ident" id="6479987">h</span><span class="op" id="6479988">.</span><span class="ident" id="6479989">Type</span>&nbsp;<span class="op" id="6479994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6479997">case</span>&nbsp;<span class="ident" id="6480002">typeBeginRequest</span><span class="op" id="6480018">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480022">if</span>&nbsp;<span class="ident" id="6480025">req</span>&nbsp;<span class="op" id="6480029">!=</span>&nbsp;<span class="ident" id="6480032">nil</span>&nbsp;<span class="op" id="6480036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6480041">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6480104">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480155">return</span>&nbsp;<span class="ident" id="6480162">errors</span><span class="op" id="6480168">.</span><span class="ident" id="6480169">New</span><span class="op" id="6480172">(</span><span class="string" id="6480173">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6480218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6480222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480227">var</span>&nbsp;<span class="ident" id="6480231">br</span>&nbsp;<span class="ident" id="6480234">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480249">if</span>&nbsp;<span class="ident" id="6480252">err</span>&nbsp;<span class="op" id="6480256">:=</span>&nbsp;<span class="ident" id="6480259">br</span><span class="op" id="6480261">.</span><span class="ident" id="6480262">read</span><span class="op" id="6480266">(</span><span class="ident" id="6480267">rec</span><span class="op" id="6480270">.</span><span class="ident" id="6480271">content</span><span class="op" id="6480278">(</span><span class="op" id="6480279">)</span><span class="op" id="6480280">)</span><span class="op" id="6480281">;</span>&nbsp;<span class="ident" id="6480283">err</span>&nbsp;<span class="op" id="6480287">!=</span>&nbsp;<span class="ident" id="6480290">nil</span>&nbsp;<span class="op" id="6480294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480299">return</span>&nbsp;<span class="ident" id="6480306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6480312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480316">if</span>&nbsp;<span class="ident" id="6480319">br</span><span class="op" id="6480321">.</span><span class="ident" id="6480322">role</span>&nbsp;<span class="op" id="6480327">!=</span>&nbsp;<span class="ident" id="6480330">roleResponder</span>&nbsp;<span class="op" id="6480344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480349">c</span><span class="op" id="6480350">.</span><span class="ident" id="6480351">conn</span><span class="op" id="6480355">.</span><span class="ident" id="6480356">writeEndRequest</span><span class="op" id="6480371">(</span><span class="ident" id="6480372">rec</span><span class="op" id="6480375">.</span><span class="ident" id="6480376">h</span><span class="op" id="6480377">.</span><span class="ident" id="6480378">Id</span><span class="op" id="6480380">,</span>&nbsp;<span class="num" id="6480382">0</span><span class="op" id="6480383">,</span>&nbsp;<span class="ident" id="6480385">statusUnknownRole</span><span class="op" id="6480402">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480407">return</span>&nbsp;<span class="ident" id="6480414">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6480420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480424">req</span>&nbsp;<span class="op" id="6480428">=</span>&nbsp;<span class="ident" id="6480430">newRequest</span><span class="op" id="6480440">(</span><span class="ident" id="6480441">rec</span><span class="op" id="6480444">.</span><span class="ident" id="6480445">h</span><span class="op" id="6480446">.</span><span class="ident" id="6480447">Id</span><span class="op" id="6480449">,</span>&nbsp;<span class="ident" id="6480451">br</span><span class="op" id="6480453">.</span><span class="ident" id="6480454">flags</span><span class="op" id="6480459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480463">c</span><span class="op" id="6480464">.</span><span class="ident" id="6480465">mu</span><span class="op" id="6480467">.</span><span class="ident" id="6480468">Lock</span><span class="op" id="6480472">(</span><span class="op" id="6480473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480477">c</span><span class="op" id="6480478">.</span><span class="ident" id="6480479">requests</span><span class="op" id="6480487">[</span><span class="ident" id="6480488">rec</span><span class="op" id="6480491">.</span><span class="ident" id="6480492">h</span><span class="op" id="6480493">.</span><span class="ident" id="6480494">Id</span><span class="op" id="6480496">]</span>&nbsp;<span class="op" id="6480498">=</span>&nbsp;<span class="ident" id="6480500">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480506">c</span><span class="op" id="6480507">.</span><span class="ident" id="6480508">mu</span><span class="op" id="6480510">.</span><span class="ident" id="6480511">Unlock</span><span class="op" id="6480517">(</span><span class="op" id="6480518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480522">return</span>&nbsp;<span class="ident" id="6480529">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480534">case</span>&nbsp;<span class="ident" id="6480539">typeParams</span><span class="op" id="6480549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6480553">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6480624">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480697">if</span>&nbsp;<span class="builtinfunc" id="6480700">len</span><span class="op" id="6480703">(</span><span class="ident" id="6480704">rec</span><span class="op" id="6480707">.</span><span class="ident" id="6480708">content</span><span class="op" id="6480715">(</span><span class="op" id="6480716">)</span><span class="op" id="6480717">)</span>&nbsp;<span class="op" id="6480719">&gt;</span>&nbsp;<span class="num" id="6480721">0</span>&nbsp;<span class="op" id="6480723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480728">req</span><span class="op" id="6480731">.</span><span class="ident" id="6480732">rawParams</span>&nbsp;<span class="op" id="6480742">=</span>&nbsp;<span class="builtinfunc" id="6480744">append</span><span class="op" id="6480750">(</span><span class="ident" id="6480751">req</span><span class="op" id="6480754">.</span><span class="ident" id="6480755">rawParams</span><span class="op" id="6480764">,</span>&nbsp;<span class="ident" id="6480766">rec</span><span class="op" id="6480769">.</span><span class="ident" id="6480770">content</span><span class="op" id="6480777">(</span><span class="op" id="6480778">)</span><span class="op" id="6480779">...</span><span class="op" id="6480782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480787">return</span>&nbsp;<span class="ident" id="6480794">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6480800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480804">req</span><span class="op" id="6480807">.</span><span class="ident" id="6480808">parseParams</span><span class="op" id="6480819">(</span><span class="op" id="6480820">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480824">return</span>&nbsp;<span class="ident" id="6480831">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480836">case</span>&nbsp;<span class="ident" id="6480841">typeStdin</span><span class="op" id="6480850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6480854">content</span>&nbsp;<span class="op" id="6480862">:=</span>&nbsp;<span class="ident" id="6480865">rec</span><span class="op" id="6480868">.</span><span class="ident" id="6480869">content</span><span class="op" id="6480876">(</span><span class="op" id="6480877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480881">if</span>&nbsp;<span class="ident" id="6480884">req</span><span class="op" id="6480887">.</span><span class="ident" id="6480888">pw</span>&nbsp;<span class="op" id="6480891">==</span>&nbsp;<span class="ident" id="6480894">nil</span>&nbsp;<span class="op" id="6480898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480903">var</span>&nbsp;<span class="ident" id="6480907">body</span>&nbsp;<span class="ident" id="6480912">io</span><span class="op" id="6480914">.</span><span class="ident" id="6480915">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6480929">if</span>&nbsp;<span class="builtinfunc" id="6480932">len</span><span class="op" id="6480935">(</span><span class="ident" id="6480936">content</span><span class="op" id="6480943">)</span>&nbsp;<span class="op" id="6480945">&gt;</span>&nbsp;<span class="num" id="6480947">0</span>&nbsp;<span class="op" id="6480949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6480955">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6481019">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481062">body</span><span class="op" id="6481066">,</span>&nbsp;<span class="ident" id="6481068">req</span><span class="op" id="6481071">.</span><span class="ident" id="6481072">pw</span>&nbsp;<span class="op" id="6481075">=</span>&nbsp;<span class="ident" id="6481077">io</span><span class="op" id="6481079">.</span><span class="ident" id="6481080">Pipe</span><span class="op" id="6481084">(</span><span class="op" id="6481085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481090">}</span>&nbsp;<span class="keyword" id="6481092">else</span>&nbsp;<span class="op" id="6481097">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481103">body</span>&nbsp;<span class="op" id="6481108">=</span>&nbsp;<span class="ident" id="6481110">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481128">go</span>&nbsp;<span class="ident" id="6481131">c</span><span class="op" id="6481132">.</span><span class="ident" id="6481133">serveRequest</span><span class="op" id="6481145">(</span><span class="ident" id="6481146">req</span><span class="op" id="6481149">,</span>&nbsp;<span class="ident" id="6481151">body</span><span class="op" id="6481155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481163">if</span>&nbsp;<span class="builtinfunc" id="6481166">len</span><span class="op" id="6481169">(</span><span class="ident" id="6481170">content</span><span class="op" id="6481177">)</span>&nbsp;<span class="op" id="6481179">&gt;</span>&nbsp;<span class="num" id="6481181">0</span>&nbsp;<span class="op" id="6481183">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6481188">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6481256">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481319">req</span><span class="op" id="6481322">.</span><span class="ident" id="6481323">pw</span><span class="op" id="6481325">.</span><span class="ident" id="6481326">Write</span><span class="op" id="6481331">(</span><span class="ident" id="6481332">content</span><span class="op" id="6481339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481343">}</span>&nbsp;<span class="keyword" id="6481345">else</span>&nbsp;<span class="keyword" id="6481350">if</span>&nbsp;<span class="ident" id="6481353">req</span><span class="op" id="6481356">.</span><span class="ident" id="6481357">pw</span>&nbsp;<span class="op" id="6481360">!=</span>&nbsp;<span class="ident" id="6481363">nil</span>&nbsp;<span class="op" id="6481367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481372">req</span><span class="op" id="6481375">.</span><span class="ident" id="6481376">pw</span><span class="op" id="6481378">.</span><span class="ident" id="6481379">Close</span><span class="op" id="6481384">(</span><span class="op" id="6481385">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481393">return</span>&nbsp;<span class="ident" id="6481400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481405">case</span>&nbsp;<span class="ident" id="6481410">typeGetValues</span><span class="op" id="6481423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481427">values</span>&nbsp;<span class="op" id="6481434">:=</span>&nbsp;<span class="keyword" id="6481437">map</span><span class="op" id="6481440">[</span><span class="builtintype" id="6481441">string</span><span class="op" id="6481447">]</span><span class="builtintype" id="6481448">string</span><span class="op" id="6481454">{</span><span class="string" id="6481455">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6481472">:</span>&nbsp;<span class="string" id="6481474">&#34;1&#34;</span><span class="op" id="6481477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481481">c</span><span class="op" id="6481482">.</span><span class="ident" id="6481483">conn</span><span class="op" id="6481487">.</span><span class="ident" id="6481488">writePairs</span><span class="op" id="6481498">(</span><span class="ident" id="6481499">typeGetValuesResult</span><span class="op" id="6481518">,</span>&nbsp;<span class="num" id="6481520">0</span><span class="op" id="6481521">,</span>&nbsp;<span class="ident" id="6481523">values</span><span class="op" id="6481529">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481533">return</span>&nbsp;<span class="ident" id="6481540">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481545">case</span>&nbsp;<span class="ident" id="6481550">typeData</span><span class="op" id="6481558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6481562">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481629">return</span>&nbsp;<span class="ident" id="6481636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481641">case</span>&nbsp;<span class="ident" id="6481646">typeAbortRequest</span><span class="op" id="6481662">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6481666">println</span><span class="op" id="6481673">(</span><span class="string" id="6481674">&#34;abort&#34;</span><span class="op" id="6481681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481685">c</span><span class="op" id="6481686">.</span><span class="ident" id="6481687">mu</span><span class="op" id="6481689">.</span><span class="ident" id="6481690">Lock</span><span class="op" id="6481694">(</span><span class="op" id="6481695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6481699">delete</span><span class="op" id="6481705">(</span><span class="ident" id="6481706">c</span><span class="op" id="6481707">.</span><span class="ident" id="6481708">requests</span><span class="op" id="6481716">,</span>&nbsp;<span class="ident" id="6481718">rec</span><span class="op" id="6481721">.</span><span class="ident" id="6481722">h</span><span class="op" id="6481723">.</span><span class="ident" id="6481724">Id</span><span class="op" id="6481726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481730">c</span><span class="op" id="6481731">.</span><span class="ident" id="6481732">mu</span><span class="op" id="6481734">.</span><span class="ident" id="6481735">Unlock</span><span class="op" id="6481741">(</span><span class="op" id="6481742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481746">c</span><span class="op" id="6481747">.</span><span class="ident" id="6481748">conn</span><span class="op" id="6481752">.</span><span class="ident" id="6481753">writeEndRequest</span><span class="op" id="6481768">(</span><span class="ident" id="6481769">rec</span><span class="op" id="6481772">.</span><span class="ident" id="6481773">h</span><span class="op" id="6481774">.</span><span class="ident" id="6481775">Id</span><span class="op" id="6481777">,</span>&nbsp;<span class="num" id="6481779">0</span><span class="op" id="6481780">,</span>&nbsp;<span class="ident" id="6481782">statusRequestComplete</span><span class="op" id="6481803">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481807">if</span>&nbsp;<span class="op" id="6481810">!</span><span class="ident" id="6481811">req</span><span class="op" id="6481814">.</span><span class="ident" id="6481815">keepConn</span>&nbsp;<span class="op" id="6481824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6481829">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481869">return</span>&nbsp;<span class="ident" id="6481876">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6481891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481895">return</span>&nbsp;<span class="ident" id="6481902">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6481907">default</span><span class="op" id="6481914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481918">b</span>&nbsp;<span class="op" id="6481920">:=</span>&nbsp;<span class="builtinfunc" id="6481923">make</span><span class="op" id="6481927">(</span><span class="op" id="6481928">[</span><span class="op" id="6481929">]</span><span class="builtintype" id="6481930">byte</span><span class="op" id="6481934">,</span>&nbsp;<span class="num" id="6481936">8</span><span class="op" id="6481937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481941">b</span><span class="op" id="6481942">[</span><span class="num" id="6481943">0</span><span class="op" id="6481944">]</span>&nbsp;<span class="op" id="6481946">=</span>&nbsp;<span class="builtintype" id="6481948">byte</span><span class="op" id="6481952">(</span><span class="ident" id="6481953">rec</span><span class="op" id="6481956">.</span><span class="ident" id="6481957">h</span><span class="op" id="6481958">.</span><span class="ident" id="6481959">Type</span><span class="op" id="6481963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6481967">c</span><span class="op" id="6481968">.</span><span class="ident" id="6481969">conn</span><span class="op" id="6481973">.</span><span class="ident" id="6481974">writeRecord</span><span class="op" id="6481985">(</span><span class="ident" id="6481986">typeUnknownType</span><span class="op" id="6482001">,</span>&nbsp;<span class="num" id="6482003">0</span><span class="op" id="6482004">,</span>&nbsp;<span class="ident" id="6482006">b</span><span class="op" id="6482007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6482011">return</span>&nbsp;<span class="ident" id="6482018">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6482023">}</span><br>
<span class="lineno"></span><span class="op" id="6482025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6482028">func</span>&nbsp;<span class="op" id="6482033">(</span><span class="ident" id="6482034">c</span>&nbsp;<span class="op" id="6482036">*</span><span class="ident" id="6482037">child</span><span class="op" id="6482042">)</span>&nbsp;<span class="ident" id="6482044">serveRequest</span><span class="op" id="6482056">(</span><span class="ident" id="6482057">req</span>&nbsp;<span class="op" id="6482061">*</span><span class="ident" id="6482062">request</span><span class="op" id="6482069">,</span>&nbsp;<span class="ident" id="6482071">body</span>&nbsp;<span class="ident" id="6482076">io</span><span class="op" id="6482078">.</span><span class="ident" id="6482079">ReadCloser</span><span class="op" id="6482089">)</span>&nbsp;<span class="op" id="6482091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482094">r</span>&nbsp;<span class="op" id="6482096">:=</span>&nbsp;<span class="ident" id="6482099">newResponse</span><span class="op" id="6482110">(</span><span class="ident" id="6482111">c</span><span class="op" id="6482112">,</span>&nbsp;<span class="ident" id="6482114">req</span><span class="op" id="6482117">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482120">httpReq</span><span class="op" id="6482127">,</span>&nbsp;<span class="ident" id="6482129">err</span>&nbsp;<span class="op" id="6482133">:=</span>&nbsp;<span class="ident" id="6482136">cgi</span><span class="op" id="6482139">.</span><span class="ident" id="6482140">RequestFromMap</span><span class="op" id="6482154">(</span><span class="ident" id="6482155">req</span><span class="op" id="6482158">.</span><span class="ident" id="6482159">params</span><span class="op" id="6482165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6482168">if</span>&nbsp;<span class="ident" id="6482171">err</span>&nbsp;<span class="op" id="6482175">!=</span>&nbsp;<span class="ident" id="6482178">nil</span>&nbsp;<span class="op" id="6482182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482186">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482230">r</span><span class="op" id="6482231">.</span><span class="ident" id="6482232">WriteHeader</span><span class="op" id="6482243">(</span><span class="ident" id="6482244">http</span><span class="op" id="6482248">.</span><span class="ident" id="6482249">StatusInternalServerError</span><span class="op" id="6482274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482278">c</span><span class="op" id="6482279">.</span><span class="ident" id="6482280">conn</span><span class="op" id="6482284">.</span><span class="ident" id="6482285">writeRecord</span><span class="op" id="6482296">(</span><span class="ident" id="6482297">typeStderr</span><span class="op" id="6482307">,</span>&nbsp;<span class="ident" id="6482309">req</span><span class="op" id="6482312">.</span><span class="ident" id="6482313">reqId</span><span class="op" id="6482318">,</span>&nbsp;<span class="op" id="6482320">[</span><span class="op" id="6482321">]</span><span class="builtintype" id="6482322">byte</span><span class="op" id="6482326">(</span><span class="ident" id="6482327">err</span><span class="op" id="6482330">.</span><span class="ident" id="6482331">Error</span><span class="op" id="6482336">(</span><span class="op" id="6482337">)</span><span class="op" id="6482338">)</span><span class="op" id="6482339">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6482342">}</span>&nbsp;<span class="keyword" id="6482344">else</span>&nbsp;<span class="op" id="6482349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482353">httpReq</span><span class="op" id="6482360">.</span><span class="ident" id="6482361">Body</span>&nbsp;<span class="op" id="6482366">=</span>&nbsp;<span class="ident" id="6482368">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482375">c</span><span class="op" id="6482376">.</span><span class="ident" id="6482377">handler</span><span class="op" id="6482384">.</span><span class="ident" id="6482385">ServeHTTP</span><span class="op" id="6482394">(</span><span class="ident" id="6482395">r</span><span class="op" id="6482396">,</span>&nbsp;<span class="ident" id="6482398">httpReq</span><span class="op" id="6482405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6482408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482411">r</span><span class="op" id="6482412">.</span><span class="ident" id="6482413">Close</span><span class="op" id="6482418">(</span><span class="op" id="6482419">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482422">c</span><span class="op" id="6482423">.</span><span class="ident" id="6482424">mu</span><span class="op" id="6482426">.</span><span class="ident" id="6482427">Lock</span><span class="op" id="6482431">(</span><span class="op" id="6482432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6482435">delete</span><span class="op" id="6482441">(</span><span class="ident" id="6482442">c</span><span class="op" id="6482443">.</span><span class="ident" id="6482444">requests</span><span class="op" id="6482452">,</span>&nbsp;<span class="ident" id="6482454">req</span><span class="op" id="6482457">.</span><span class="ident" id="6482458">reqId</span><span class="op" id="6482463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482466">c</span><span class="op" id="6482467">.</span><span class="ident" id="6482468">mu</span><span class="op" id="6482470">.</span><span class="ident" id="6482471">Unlock</span><span class="op" id="6482477">(</span><span class="op" id="6482478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482481">c</span><span class="op" id="6482482">.</span><span class="ident" id="6482483">conn</span><span class="op" id="6482487">.</span><span class="ident" id="6482488">writeEndRequest</span><span class="op" id="6482503">(</span><span class="ident" id="6482504">req</span><span class="op" id="6482507">.</span><span class="ident" id="6482508">reqId</span><span class="op" id="6482513">,</span>&nbsp;<span class="num" id="6482515">0</span><span class="op" id="6482516">,</span>&nbsp;<span class="ident" id="6482518">statusRequestComplete</span><span class="op" id="6482539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482543">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482607">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482668">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482723">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482781">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482837">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6482895">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482934">io</span><span class="op" id="6482936">.</span><span class="ident" id="6482937">CopyN</span><span class="op" id="6482942">(</span><span class="ident" id="6482943">ioutil</span><span class="op" id="6482949">.</span><span class="ident" id="6482950">Discard</span><span class="op" id="6482957">,</span>&nbsp;<span class="ident" id="6482959">body</span><span class="op" id="6482963">,</span>&nbsp;<span class="num" id="6482965">100</span><span class="op" id="6482968">&lt;&lt;</span><span class="num" id="6482970">20</span><span class="op" id="6482972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6482975">body</span><span class="op" id="6482979">.</span><span class="ident" id="6482980">Close</span><span class="op" id="6482985">(</span><span class="op" id="6482986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6482990">if</span>&nbsp;<span class="op" id="6482993">!</span><span class="ident" id="6482994">req</span><span class="op" id="6482997">.</span><span class="ident" id="6482998">keepConn</span>&nbsp;<span class="op" id="6483007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6483011">c</span><span class="op" id="6483012">.</span><span class="ident" id="6483013">conn</span><span class="op" id="6483017">.</span><span class="ident" id="6483018">Close</span><span class="op" id="6483023">(</span><span class="op" id="6483024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483027">}</span><br>
<span class="lineno"></span><span class="op" id="6483029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6483032">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6483112">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6483187">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6483208">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6483265">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6483317">func</span>&nbsp;<span class="ident" id="6483322">Serve</span><span class="op" id="6483327">(</span><span class="ident" id="6483328">l</span>&nbsp;<span class="ident" id="6483330">net</span><span class="op" id="6483333">.</span><span class="ident" id="6483334">Listener</span><span class="op" id="6483342">,</span>&nbsp;<span class="ident" id="6483344">handler</span>&nbsp;<span class="ident" id="6483352">http</span><span class="op" id="6483356">.</span><span class="ident" id="6483357">Handler</span><span class="op" id="6483364">)</span>&nbsp;<span class="builtintype" id="6483366">error</span>&nbsp;<span class="op" id="6483372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483375">if</span>&nbsp;<span class="ident" id="6483378">l</span>&nbsp;<span class="op" id="6483380">==</span>&nbsp;<span class="ident" id="6483383">nil</span>&nbsp;<span class="op" id="6483387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483391">var</span>&nbsp;<span class="ident" id="6483395">err</span>&nbsp;<span class="builtintype" id="6483399">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6483407">l</span><span class="op" id="6483408">,</span>&nbsp;<span class="ident" id="6483410">err</span>&nbsp;<span class="op" id="6483414">=</span>&nbsp;<span class="ident" id="6483416">net</span><span class="op" id="6483419">.</span><span class="ident" id="6483420">FileListener</span><span class="op" id="6483432">(</span><span class="ident" id="6483433">os</span><span class="op" id="6483435">.</span><span class="ident" id="6483436">Stdin</span><span class="op" id="6483441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483445">if</span>&nbsp;<span class="ident" id="6483448">err</span>&nbsp;<span class="op" id="6483452">!=</span>&nbsp;<span class="ident" id="6483455">nil</span>&nbsp;<span class="op" id="6483459">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483464">return</span>&nbsp;<span class="ident" id="6483471">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483481">defer</span>&nbsp;<span class="ident" id="6483487">l</span><span class="op" id="6483488">.</span><span class="ident" id="6483489">Close</span><span class="op" id="6483494">(</span><span class="op" id="6483495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483501">if</span>&nbsp;<span class="ident" id="6483504">handler</span>&nbsp;<span class="op" id="6483512">==</span>&nbsp;<span class="ident" id="6483515">nil</span>&nbsp;<span class="op" id="6483519">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6483523">handler</span>&nbsp;<span class="op" id="6483531">=</span>&nbsp;<span class="ident" id="6483533">http</span><span class="op" id="6483537">.</span><span class="ident" id="6483538">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483558">for</span>&nbsp;<span class="op" id="6483562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6483566">rw</span><span class="op" id="6483568">,</span>&nbsp;<span class="ident" id="6483570">err</span>&nbsp;<span class="op" id="6483574">:=</span>&nbsp;<span class="ident" id="6483577">l</span><span class="op" id="6483578">.</span><span class="ident" id="6483579">Accept</span><span class="op" id="6483585">(</span><span class="op" id="6483586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483590">if</span>&nbsp;<span class="ident" id="6483593">err</span>&nbsp;<span class="op" id="6483597">!=</span>&nbsp;<span class="ident" id="6483600">nil</span>&nbsp;<span class="op" id="6483604">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483609">return</span>&nbsp;<span class="ident" id="6483616">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6483626">c</span>&nbsp;<span class="op" id="6483628">:=</span>&nbsp;<span class="ident" id="6483631">newChild</span><span class="op" id="6483639">(</span><span class="ident" id="6483640">rw</span><span class="op" id="6483642">,</span>&nbsp;<span class="ident" id="6483644">handler</span><span class="op" id="6483651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6483655">go</span>&nbsp;<span class="ident" id="6483658">c</span><span class="op" id="6483659">.</span><span class="ident" id="6483660">serve</span><span class="op" id="6483665">(</span><span class="op" id="6483666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6483669">}</span><br>
<span class="lineno">305</span><span class="op" id="6483671">}</span>
</div>
</body>
</html>
