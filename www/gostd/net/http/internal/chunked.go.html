<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html" class="current">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4639924">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4639979">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4640033">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4640084">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4640146">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4640213">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4640235">package</span>&nbsp;<span class="ident" id="4640243">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4640253">import</span>&nbsp;<span class="op" id="4640260">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4640263">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4640272">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4640281">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4640291">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4640298">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4640303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4640306">const</span>&nbsp;<span class="ident" id="4640312">maxLineLength</span>&nbsp;<span class="op" id="4640326">=</span>&nbsp;<span class="num" id="4640328">4096</span>&nbsp;<span class="comment" id="4640333">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4640369">var</span>&nbsp;<span class="ident" id="4640373">ErrLineTooLong</span>&nbsp;<span class="op" id="4640388">=</span>&nbsp;<span class="ident" id="4640390">errors</span><span class="op" id="4640396">.</span><span class="ident" id="4640397">New</span><span class="op" id="4640400">(</span><span class="string" id="4640401">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4640423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4640426">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4640511">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4640564">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4640639">//</span><br>
<span class="lineno"></span><span class="comment" id="4640642">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4640717">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4640781">func</span>&nbsp;<span class="ident" id="4640786">NewChunkedReader</span><span class="op" id="4640802">(</span><span class="ident" id="4640803">r</span>&nbsp;<span class="ident" id="4640805">io</span><span class="op" id="4640807">.</span><span class="ident" id="4640808">Reader</span><span class="op" id="4640814">)</span>&nbsp;<span class="ident" id="4640816">io</span><span class="op" id="4640818">.</span><span class="ident" id="4640819">Reader</span>&nbsp;<span class="op" id="4640826">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4640829">br</span><span class="op" id="4640831">,</span>&nbsp;<span class="ident" id="4640833">ok</span>&nbsp;<span class="op" id="4640836">:=</span>&nbsp;<span class="ident" id="4640839">r</span><span class="op" id="4640840">.</span><span class="op" id="4640841">(</span><span class="op" id="4640842">*</span><span class="ident" id="4640843">bufio</span><span class="op" id="4640848">.</span><span class="ident" id="4640849">Reader</span><span class="op" id="4640855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4640858">if</span>&nbsp;<span class="op" id="4640861">!</span><span class="ident" id="4640862">ok</span>&nbsp;<span class="op" id="4640865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4640869">br</span>&nbsp;<span class="op" id="4640872">=</span>&nbsp;<span class="ident" id="4640874">bufio</span><span class="op" id="4640879">.</span><span class="ident" id="4640880">NewReader</span><span class="op" id="4640889">(</span><span class="ident" id="4640890">r</span><span class="op" id="4640891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4640894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4640897">return</span>&nbsp;<span class="op" id="4640904">&amp;</span><span class="ident" id="4640905">chunkedReader</span><span class="op" id="4640918">{</span><span class="ident" id="4640919">r</span><span class="op" id="4640920">:</span>&nbsp;<span class="ident" id="4640922">br</span><span class="op" id="4640924">}</span><br>
<span class="lineno">35</span><span class="op" id="4640926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4640929">type</span>&nbsp;<span class="ident" id="4640934">chunkedReader</span>&nbsp;<span class="keyword" id="4640948">struct</span>&nbsp;<span class="op" id="4640955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4640958">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4640962">*</span><span class="ident" id="4640963">bufio</span><span class="op" id="4640968">.</span><span class="ident" id="4640969">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4640977">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4640981">uint64</span>&nbsp;<span class="comment" id="4640988">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641014">err</span>&nbsp;<span class="builtintype" id="4641018">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641025">buf</span>&nbsp;<span class="op" id="4641029">[</span><span class="num" id="4641030">2</span><span class="op" id="4641031">]</span><span class="builtintype" id="4641032">byte</span><br>
<span class="lineno"></span><span class="op" id="4641037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4641040">func</span>&nbsp;<span class="op" id="4641045">(</span><span class="ident" id="4641046">cr</span>&nbsp;<span class="op" id="4641049">*</span><span class="ident" id="4641050">chunkedReader</span><span class="op" id="4641063">)</span>&nbsp;<span class="ident" id="4641065">beginChunk</span><span class="op" id="4641075">(</span><span class="op" id="4641076">)</span>&nbsp;<span class="op" id="4641078">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4641081">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641101">var</span>&nbsp;<span class="ident" id="4641105">line</span>&nbsp;<span class="op" id="4641110">[</span><span class="op" id="4641111">]</span><span class="builtintype" id="4641112">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641118">line</span><span class="op" id="4641122">,</span>&nbsp;<span class="ident" id="4641124">cr</span><span class="op" id="4641126">.</span><span class="ident" id="4641127">err</span>&nbsp;<span class="op" id="4641131">=</span>&nbsp;<span class="ident" id="4641133">readLine</span><span class="op" id="4641141">(</span><span class="ident" id="4641142">cr</span><span class="op" id="4641144">.</span><span class="ident" id="4641145">r</span><span class="op" id="4641146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641149">if</span>&nbsp;<span class="ident" id="4641152">cr</span><span class="op" id="4641154">.</span><span class="ident" id="4641155">err</span>&nbsp;<span class="op" id="4641159">!=</span>&nbsp;<span class="builtintype" id="4641162">nil</span>&nbsp;<span class="op" id="4641166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641170">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641181">cr</span><span class="op" id="4641183">.</span><span class="ident" id="4641184">n</span><span class="op" id="4641185">,</span>&nbsp;<span class="ident" id="4641187">cr</span><span class="op" id="4641189">.</span><span class="ident" id="4641190">err</span>&nbsp;<span class="op" id="4641194">=</span>&nbsp;<span class="ident" id="4641196">parseHexUint</span><span class="op" id="4641208">(</span><span class="ident" id="4641209">line</span><span class="op" id="4641213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641216">if</span>&nbsp;<span class="ident" id="4641219">cr</span><span class="op" id="4641221">.</span><span class="ident" id="4641222">err</span>&nbsp;<span class="op" id="4641226">!=</span>&nbsp;<span class="builtintype" id="4641229">nil</span>&nbsp;<span class="op" id="4641233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641237">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641245">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641248">if</span>&nbsp;<span class="ident" id="4641251">cr</span><span class="op" id="4641253">.</span><span class="ident" id="4641254">n</span>&nbsp;<span class="op" id="4641256">==</span>&nbsp;<span class="num" id="4641259">0</span>&nbsp;<span class="op" id="4641261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641265">cr</span><span class="op" id="4641267">.</span><span class="ident" id="4641268">err</span>&nbsp;<span class="op" id="4641272">=</span>&nbsp;<span class="ident" id="4641274">io</span><span class="op" id="4641276">.</span><span class="ident" id="4641277">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641282">}</span><br>
<span class="lineno"></span><span class="op" id="4641284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4641287">func</span>&nbsp;<span class="op" id="4641292">(</span><span class="ident" id="4641293">cr</span>&nbsp;<span class="op" id="4641296">*</span><span class="ident" id="4641297">chunkedReader</span><span class="op" id="4641310">)</span>&nbsp;<span class="ident" id="4641312">chunkHeaderAvailable</span><span class="op" id="4641332">(</span><span class="op" id="4641333">)</span>&nbsp;<span class="builtintype" id="4641335">bool</span>&nbsp;<span class="op" id="4641340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641343">n</span>&nbsp;<span class="op" id="4641345">:=</span>&nbsp;<span class="ident" id="4641348">cr</span><span class="op" id="4641350">.</span><span class="ident" id="4641351">r</span><span class="op" id="4641352">.</span><span class="ident" id="4641353">Buffered</span><span class="op" id="4641361">(</span><span class="op" id="4641362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641365">if</span>&nbsp;<span class="ident" id="4641368">n</span>&nbsp;<span class="op" id="4641370">&gt;</span>&nbsp;<span class="num" id="4641372">0</span>&nbsp;<span class="op" id="4641374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641378">peek</span><span class="op" id="4641382">,</span>&nbsp;<span class="ident" id="4641384">_</span>&nbsp;<span class="op" id="4641386">:=</span>&nbsp;<span class="ident" id="4641389">cr</span><span class="op" id="4641391">.</span><span class="ident" id="4641392">r</span><span class="op" id="4641393">.</span><span class="ident" id="4641394">Peek</span><span class="op" id="4641398">(</span><span class="ident" id="4641399">n</span><span class="op" id="4641400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641404">return</span>&nbsp;<span class="ident" id="4641411">bytes</span><span class="op" id="4641416">.</span><span class="ident" id="4641417">IndexByte</span><span class="op" id="4641426">(</span><span class="ident" id="4641427">peek</span><span class="op" id="4641431">,</span>&nbsp;<span class="string" id="4641433">&#39;\n&#39;</span><span class="op" id="4641437">)</span>&nbsp;<span class="op" id="4641439">&gt;=</span>&nbsp;<span class="num" id="4641442">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641448">return</span>&nbsp;<span class="builtintype" id="4641455">false</span><br>
<span class="lineno"></span><span class="op" id="4641461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4641464">func</span>&nbsp;<span class="op" id="4641469">(</span><span class="ident" id="4641470">cr</span>&nbsp;<span class="op" id="4641473">*</span><span class="ident" id="4641474">chunkedReader</span><span class="op" id="4641487">)</span>&nbsp;<span class="ident" id="4641489">Read</span><span class="op" id="4641493">(</span><span class="ident" id="4641494">b</span>&nbsp;<span class="op" id="4641496">[</span><span class="op" id="4641497">]</span><span class="builtintype" id="4641498">uint8</span><span class="op" id="4641503">)</span>&nbsp;<span class="op" id="4641505">(</span><span class="ident" id="4641506">n</span>&nbsp;<span class="builtintype" id="4641508">int</span><span class="op" id="4641511">,</span>&nbsp;<span class="ident" id="4641513">err</span>&nbsp;<span class="builtintype" id="4641517">error</span><span class="op" id="4641522">)</span>&nbsp;<span class="op" id="4641524">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641527">for</span>&nbsp;<span class="ident" id="4641531">cr</span><span class="op" id="4641533">.</span><span class="ident" id="4641534">err</span>&nbsp;<span class="op" id="4641538">==</span>&nbsp;<span class="builtintype" id="4641541">nil</span>&nbsp;<span class="op" id="4641545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641549">if</span>&nbsp;<span class="ident" id="4641552">cr</span><span class="op" id="4641554">.</span><span class="ident" id="4641555">n</span>&nbsp;<span class="op" id="4641557">==</span>&nbsp;<span class="num" id="4641560">0</span>&nbsp;<span class="op" id="4641562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641567">if</span>&nbsp;<span class="ident" id="4641570">n</span>&nbsp;<span class="op" id="4641572">&gt;</span>&nbsp;<span class="num" id="4641574">0</span>&nbsp;<span class="op" id="4641576">&amp;&amp;</span>&nbsp;<span class="op" id="4641579">!</span><span class="ident" id="4641580">cr</span><span class="op" id="4641582">.</span><span class="ident" id="4641583">chunkHeaderAvailable</span><span class="op" id="4641603">(</span><span class="op" id="4641604">)</span>&nbsp;<span class="op" id="4641606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4641612">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4641662">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641697">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641711">cr</span><span class="op" id="4641713">.</span><span class="ident" id="4641714">beginChunk</span><span class="op" id="4641724">(</span><span class="op" id="4641725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641730">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641741">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641745">if</span>&nbsp;<span class="builtinfunc" id="4641748">len</span><span class="op" id="4641751">(</span><span class="ident" id="4641752">b</span><span class="op" id="4641753">)</span>&nbsp;<span class="op" id="4641755">==</span>&nbsp;<span class="num" id="4641758">0</span>&nbsp;<span class="op" id="4641760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641765">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641777">rbuf</span>&nbsp;<span class="op" id="4641782">:=</span>&nbsp;<span class="ident" id="4641785">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641789">if</span>&nbsp;<span class="builtintype" id="4641792">uint64</span><span class="op" id="4641798">(</span><span class="builtinfunc" id="4641799">len</span><span class="op" id="4641802">(</span><span class="ident" id="4641803">rbuf</span><span class="op" id="4641807">)</span><span class="op" id="4641808">)</span>&nbsp;<span class="op" id="4641810">&gt;</span>&nbsp;<span class="ident" id="4641812">cr</span><span class="op" id="4641814">.</span><span class="ident" id="4641815">n</span>&nbsp;<span class="op" id="4641817">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641822">rbuf</span>&nbsp;<span class="op" id="4641827">=</span>&nbsp;<span class="ident" id="4641829">rbuf</span><span class="op" id="4641833">[</span><span class="op" id="4641834">:</span><span class="ident" id="4641835">cr</span><span class="op" id="4641837">.</span><span class="ident" id="4641838">n</span><span class="op" id="4641839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4641843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4641847">var</span>&nbsp;<span class="ident" id="4641851">n0</span>&nbsp;<span class="builtintype" id="4641854">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641860">n0</span><span class="op" id="4641862">,</span>&nbsp;<span class="ident" id="4641864">cr</span><span class="op" id="4641866">.</span><span class="ident" id="4641867">err</span>&nbsp;<span class="op" id="4641871">=</span>&nbsp;<span class="ident" id="4641873">cr</span><span class="op" id="4641875">.</span><span class="ident" id="4641876">r</span><span class="op" id="4641877">.</span><span class="ident" id="4641878">Read</span><span class="op" id="4641882">(</span><span class="ident" id="4641883">rbuf</span><span class="op" id="4641887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641891">n</span>&nbsp;<span class="op" id="4641893">+=</span>&nbsp;<span class="ident" id="4641896">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641901">b</span>&nbsp;<span class="op" id="4641903">=</span>&nbsp;<span class="ident" id="4641905">b</span><span class="op" id="4641906">[</span><span class="ident" id="4641907">n0</span><span class="op" id="4641909">:</span><span class="op" id="4641910">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4641914">cr</span><span class="op" id="4641916">.</span><span class="ident" id="4641917">n</span>&nbsp;<span class="op" id="4641919">-=</span>&nbsp;<span class="builtintype" id="4641922">uint64</span><span class="op" id="4641928">(</span><span class="ident" id="4641929">n0</span><span class="op" id="4641931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4641935">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4641990">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642028">if</span>&nbsp;<span class="ident" id="4642031">cr</span><span class="op" id="4642033">.</span><span class="ident" id="4642034">n</span>&nbsp;<span class="op" id="4642036">==</span>&nbsp;<span class="num" id="4642039">0</span>&nbsp;<span class="op" id="4642041">&amp;&amp;</span>&nbsp;<span class="ident" id="4642044">cr</span><span class="op" id="4642046">.</span><span class="ident" id="4642047">err</span>&nbsp;<span class="op" id="4642051">==</span>&nbsp;<span class="builtintype" id="4642054">nil</span>&nbsp;<span class="op" id="4642058">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642063">if</span>&nbsp;<span class="ident" id="4642066">_</span><span class="op" id="4642067">,</span>&nbsp;<span class="ident" id="4642069">cr</span><span class="op" id="4642071">.</span><span class="ident" id="4642072">err</span>&nbsp;<span class="op" id="4642076">=</span>&nbsp;<span class="ident" id="4642078">io</span><span class="op" id="4642080">.</span><span class="ident" id="4642081">ReadFull</span><span class="op" id="4642089">(</span><span class="ident" id="4642090">cr</span><span class="op" id="4642092">.</span><span class="ident" id="4642093">r</span><span class="op" id="4642094">,</span>&nbsp;<span class="ident" id="4642096">cr</span><span class="op" id="4642098">.</span><span class="ident" id="4642099">buf</span><span class="op" id="4642102">[</span><span class="op" id="4642103">:</span><span class="num" id="4642104">2</span><span class="op" id="4642105">]</span><span class="op" id="4642106">)</span><span class="op" id="4642107">;</span>&nbsp;<span class="ident" id="4642109">cr</span><span class="op" id="4642111">.</span><span class="ident" id="4642112">err</span>&nbsp;<span class="op" id="4642116">==</span>&nbsp;<span class="builtintype" id="4642119">nil</span>&nbsp;<span class="op" id="4642123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642129">if</span>&nbsp;<span class="ident" id="4642132">cr</span><span class="op" id="4642134">.</span><span class="ident" id="4642135">buf</span><span class="op" id="4642138">[</span><span class="num" id="4642139">0</span><span class="op" id="4642140">]</span>&nbsp;<span class="op" id="4642142">!=</span>&nbsp;<span class="string" id="4642145">&#39;\r&#39;</span>&nbsp;<span class="op" id="4642150">||</span>&nbsp;<span class="ident" id="4642153">cr</span><span class="op" id="4642155">.</span><span class="ident" id="4642156">buf</span><span class="op" id="4642159">[</span><span class="num" id="4642160">1</span><span class="op" id="4642161">]</span>&nbsp;<span class="op" id="4642163">!=</span>&nbsp;<span class="string" id="4642166">&#39;\n&#39;</span>&nbsp;<span class="op" id="4642171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4642178">cr</span><span class="op" id="4642180">.</span><span class="ident" id="4642181">err</span>&nbsp;<span class="op" id="4642185">=</span>&nbsp;<span class="ident" id="4642187">errors</span><span class="op" id="4642193">.</span><span class="ident" id="4642194">New</span><span class="op" id="4642197">(</span><span class="string" id="4642198">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4642226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642237">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642247">return</span>&nbsp;<span class="ident" id="4642254">n</span><span class="op" id="4642255">,</span>&nbsp;<span class="ident" id="4642257">cr</span><span class="op" id="4642259">.</span><span class="ident" id="4642260">err</span><br>
<span class="lineno"></span><span class="op" id="4642264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4642267">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4642310">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4642356">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4642408">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4642472">func</span>&nbsp;<span class="ident" id="4642477">readLine</span><span class="op" id="4642485">(</span><span class="ident" id="4642486">b</span>&nbsp;<span class="op" id="4642488">*</span><span class="ident" id="4642489">bufio</span><span class="op" id="4642494">.</span><span class="ident" id="4642495">Reader</span><span class="op" id="4642501">)</span>&nbsp;<span class="op" id="4642503">(</span><span class="ident" id="4642504">p</span>&nbsp;<span class="op" id="4642506">[</span><span class="op" id="4642507">]</span><span class="builtintype" id="4642508">byte</span><span class="op" id="4642512">,</span>&nbsp;<span class="ident" id="4642514">err</span>&nbsp;<span class="builtintype" id="4642518">error</span><span class="op" id="4642523">)</span>&nbsp;<span class="op" id="4642525">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642528">if</span>&nbsp;<span class="ident" id="4642531">p</span><span class="op" id="4642532">,</span>&nbsp;<span class="ident" id="4642534">err</span>&nbsp;<span class="op" id="4642538">=</span>&nbsp;<span class="ident" id="4642540">b</span><span class="op" id="4642541">.</span><span class="ident" id="4642542">ReadSlice</span><span class="op" id="4642551">(</span><span class="string" id="4642552">&#39;\n&#39;</span><span class="op" id="4642556">)</span><span class="op" id="4642557">;</span>&nbsp;<span class="ident" id="4642559">err</span>&nbsp;<span class="op" id="4642563">!=</span>&nbsp;<span class="builtintype" id="4642566">nil</span>&nbsp;<span class="op" id="4642570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4642574">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4642614">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642675">if</span>&nbsp;<span class="ident" id="4642678">err</span>&nbsp;<span class="op" id="4642682">==</span>&nbsp;<span class="ident" id="4642685">io</span><span class="op" id="4642687">.</span><span class="ident" id="4642688">EOF</span>&nbsp;<span class="op" id="4642692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4642697">err</span>&nbsp;<span class="op" id="4642701">=</span>&nbsp;<span class="ident" id="4642703">io</span><span class="op" id="4642705">.</span><span class="ident" id="4642706">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642725">}</span>&nbsp;<span class="keyword" id="4642727">else</span>&nbsp;<span class="keyword" id="4642732">if</span>&nbsp;<span class="ident" id="4642735">err</span>&nbsp;<span class="op" id="4642739">==</span>&nbsp;<span class="ident" id="4642742">bufio</span><span class="op" id="4642747">.</span><span class="ident" id="4642748">ErrBufferFull</span>&nbsp;<span class="op" id="4642762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4642767">err</span>&nbsp;<span class="op" id="4642771">=</span>&nbsp;<span class="ident" id="4642773">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642794">return</span>&nbsp;<span class="builtintype" id="4642801">nil</span><span class="op" id="4642804">,</span>&nbsp;<span class="ident" id="4642806">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642811">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642814">if</span>&nbsp;<span class="builtinfunc" id="4642817">len</span><span class="op" id="4642820">(</span><span class="ident" id="4642821">p</span><span class="op" id="4642822">)</span>&nbsp;<span class="op" id="4642824">&gt;=</span>&nbsp;<span class="ident" id="4642827">maxLineLength</span>&nbsp;<span class="op" id="4642841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642845">return</span>&nbsp;<span class="builtintype" id="4642852">nil</span><span class="op" id="4642855">,</span>&nbsp;<span class="ident" id="4642857">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4642873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642876">return</span>&nbsp;<span class="ident" id="4642883">trimTrailingWhitespace</span><span class="op" id="4642905">(</span><span class="ident" id="4642906">p</span><span class="op" id="4642907">)</span><span class="op" id="4642908">,</span>&nbsp;<span class="builtintype" id="4642910">nil</span><br>
<span class="lineno"></span><span class="op" id="4642914">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4642917">func</span>&nbsp;<span class="ident" id="4642922">trimTrailingWhitespace</span><span class="op" id="4642944">(</span><span class="ident" id="4642945">b</span>&nbsp;<span class="op" id="4642947">[</span><span class="op" id="4642948">]</span><span class="builtintype" id="4642949">byte</span><span class="op" id="4642953">)</span>&nbsp;<span class="op" id="4642955">[</span><span class="op" id="4642956">]</span><span class="builtintype" id="4642957">byte</span>&nbsp;<span class="op" id="4642962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4642965">for</span>&nbsp;<span class="builtinfunc" id="4642969">len</span><span class="op" id="4642972">(</span><span class="ident" id="4642973">b</span><span class="op" id="4642974">)</span>&nbsp;<span class="op" id="4642976">&gt;</span>&nbsp;<span class="num" id="4642978">0</span>&nbsp;<span class="op" id="4642980">&amp;&amp;</span>&nbsp;<span class="ident" id="4642983">isASCIISpace</span><span class="op" id="4642995">(</span><span class="ident" id="4642996">b</span><span class="op" id="4642997">[</span><span class="builtinfunc" id="4642998">len</span><span class="op" id="4643001">(</span><span class="ident" id="4643002">b</span><span class="op" id="4643003">)</span><span class="op" id="4643004">-</span><span class="num" id="4643005">1</span><span class="op" id="4643006">]</span><span class="op" id="4643007">)</span>&nbsp;<span class="op" id="4643009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4643013">b</span>&nbsp;<span class="op" id="4643015">=</span>&nbsp;<span class="ident" id="4643017">b</span><span class="op" id="4643018">[</span><span class="op" id="4643019">:</span><span class="builtinfunc" id="4643020">len</span><span class="op" id="4643023">(</span><span class="ident" id="4643024">b</span><span class="op" id="4643025">)</span><span class="op" id="4643026">-</span><span class="num" id="4643027">1</span><span class="op" id="4643028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4643031">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4643034">return</span>&nbsp;<span class="ident" id="4643041">b</span><br>
<span class="lineno"></span><span class="op" id="4643043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4643046">func</span>&nbsp;<span class="ident" id="4643051">isASCIISpace</span><span class="op" id="4643063">(</span><span class="ident" id="4643064">b</span>&nbsp;<span class="builtintype" id="4643066">byte</span><span class="op" id="4643070">)</span>&nbsp;<span class="builtintype" id="4643072">bool</span>&nbsp;<span class="op" id="4643077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4643080">return</span>&nbsp;<span class="ident" id="4643087">b</span>&nbsp;<span class="op" id="4643089">==</span>&nbsp;<span class="string" id="4643092">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4643096">||</span>&nbsp;<span class="ident" id="4643099">b</span>&nbsp;<span class="op" id="4643101">==</span>&nbsp;<span class="string" id="4643104">&#39;\t&#39;</span>&nbsp;<span class="op" id="4643109">||</span>&nbsp;<span class="ident" id="4643112">b</span>&nbsp;<span class="op" id="4643114">==</span>&nbsp;<span class="string" id="4643117">&#39;\n&#39;</span>&nbsp;<span class="op" id="4643122">||</span>&nbsp;<span class="ident" id="4643125">b</span>&nbsp;<span class="op" id="4643127">==</span>&nbsp;<span class="string" id="4643130">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4643135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4643138">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4643219">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4643300">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4643368">//</span><br>
<span class="lineno"></span><span class="comment" id="4643371">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4643438">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4643501">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4643567">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4643636">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4643672">func</span>&nbsp;<span class="ident" id="4643677">NewChunkedWriter</span><span class="op" id="4643693">(</span><span class="ident" id="4643694">w</span>&nbsp;<span class="ident" id="4643696">io</span><span class="op" id="4643698">.</span><span class="ident" id="4643699">Writer</span><span class="op" id="4643705">)</span>&nbsp;<span class="ident" id="4643707">io</span><span class="op" id="4643709">.</span><span class="ident" id="4643710">WriteCloser</span>&nbsp;<span class="op" id="4643722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4643725">return</span>&nbsp;<span class="op" id="4643732">&amp;</span><span class="ident" id="4643733">chunkedWriter</span><span class="op" id="4643746">{</span><span class="ident" id="4643747">w</span><span class="op" id="4643748">}</span><br>
<span class="lineno"></span><span class="op" id="4643750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4643753">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4643828">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4643890">type</span>&nbsp;<span class="ident" id="4643895">chunkedWriter</span>&nbsp;<span class="keyword" id="4643909">struct</span>&nbsp;<span class="op" id="4643916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4643919">Wire</span>&nbsp;<span class="ident" id="4643924">io</span><span class="op" id="4643926">.</span><span class="ident" id="4643927">Writer</span><br>
<span class="lineno"></span><span class="op" id="4643934">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4643937">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4643989">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4644068">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4644131">func</span>&nbsp;<span class="op" id="4644136">(</span><span class="ident" id="4644137">cw</span>&nbsp;<span class="op" id="4644140">*</span><span class="ident" id="4644141">chunkedWriter</span><span class="op" id="4644154">)</span>&nbsp;<span class="ident" id="4644156">Write</span><span class="op" id="4644161">(</span><span class="ident" id="4644162">data</span>&nbsp;<span class="op" id="4644167">[</span><span class="op" id="4644168">]</span><span class="builtintype" id="4644169">byte</span><span class="op" id="4644173">)</span>&nbsp;<span class="op" id="4644175">(</span><span class="ident" id="4644176">n</span>&nbsp;<span class="builtintype" id="4644178">int</span><span class="op" id="4644181">,</span>&nbsp;<span class="ident" id="4644183">err</span>&nbsp;<span class="builtintype" id="4644187">error</span><span class="op" id="4644192">)</span>&nbsp;<span class="op" id="4644194">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4644198">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644268">if</span>&nbsp;<span class="builtinfunc" id="4644271">len</span><span class="op" id="4644274">(</span><span class="ident" id="4644275">data</span><span class="op" id="4644279">)</span>&nbsp;<span class="op" id="4644281">==</span>&nbsp;<span class="num" id="4644284">0</span>&nbsp;<span class="op" id="4644286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644290">return</span>&nbsp;<span class="num" id="4644297">0</span><span class="op" id="4644298">,</span>&nbsp;<span class="builtintype" id="4644300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644305">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644309">if</span>&nbsp;<span class="ident" id="4644312">_</span><span class="op" id="4644313">,</span>&nbsp;<span class="ident" id="4644315">err</span>&nbsp;<span class="op" id="4644319">=</span>&nbsp;<span class="ident" id="4644321">fmt</span><span class="op" id="4644324">.</span><span class="ident" id="4644325">Fprintf</span><span class="op" id="4644332">(</span><span class="ident" id="4644333">cw</span><span class="op" id="4644335">.</span><span class="ident" id="4644336">Wire</span><span class="op" id="4644340">,</span>&nbsp;<span class="string" id="4644342">&#34;%x\r\n&#34;</span><span class="op" id="4644350">,</span>&nbsp;<span class="builtinfunc" id="4644352">len</span><span class="op" id="4644355">(</span><span class="ident" id="4644356">data</span><span class="op" id="4644360">)</span><span class="op" id="4644361">)</span><span class="op" id="4644362">;</span>&nbsp;<span class="ident" id="4644364">err</span>&nbsp;<span class="op" id="4644368">!=</span>&nbsp;<span class="builtintype" id="4644371">nil</span>&nbsp;<span class="op" id="4644375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644379">return</span>&nbsp;<span class="num" id="4644386">0</span><span class="op" id="4644387">,</span>&nbsp;<span class="ident" id="4644389">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644397">if</span>&nbsp;<span class="ident" id="4644400">n</span><span class="op" id="4644401">,</span>&nbsp;<span class="ident" id="4644403">err</span>&nbsp;<span class="op" id="4644407">=</span>&nbsp;<span class="ident" id="4644409">cw</span><span class="op" id="4644411">.</span><span class="ident" id="4644412">Wire</span><span class="op" id="4644416">.</span><span class="ident" id="4644417">Write</span><span class="op" id="4644422">(</span><span class="ident" id="4644423">data</span><span class="op" id="4644427">)</span><span class="op" id="4644428">;</span>&nbsp;<span class="ident" id="4644430">err</span>&nbsp;<span class="op" id="4644434">!=</span>&nbsp;<span class="builtintype" id="4644437">nil</span>&nbsp;<span class="op" id="4644441">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644445">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644456">if</span>&nbsp;<span class="ident" id="4644459">n</span>&nbsp;<span class="op" id="4644461">!=</span>&nbsp;<span class="builtinfunc" id="4644464">len</span><span class="op" id="4644467">(</span><span class="ident" id="4644468">data</span><span class="op" id="4644472">)</span>&nbsp;<span class="op" id="4644474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644478">err</span>&nbsp;<span class="op" id="4644482">=</span>&nbsp;<span class="ident" id="4644484">io</span><span class="op" id="4644486">.</span><span class="ident" id="4644487">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644503">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644514">_</span><span class="op" id="4644515">,</span>&nbsp;<span class="ident" id="4644517">err</span>&nbsp;<span class="op" id="4644521">=</span>&nbsp;<span class="ident" id="4644523">io</span><span class="op" id="4644525">.</span><span class="ident" id="4644526">WriteString</span><span class="op" id="4644537">(</span><span class="ident" id="4644538">cw</span><span class="op" id="4644540">.</span><span class="ident" id="4644541">Wire</span><span class="op" id="4644545">,</span>&nbsp;<span class="string" id="4644547">&#34;\r\n&#34;</span><span class="op" id="4644553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644557">return</span><br>
<span class="lineno"></span><span class="op" id="4644564">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4644567">func</span>&nbsp;<span class="op" id="4644572">(</span><span class="ident" id="4644573">cw</span>&nbsp;<span class="op" id="4644576">*</span><span class="ident" id="4644577">chunkedWriter</span><span class="op" id="4644590">)</span>&nbsp;<span class="ident" id="4644592">Close</span><span class="op" id="4644597">(</span><span class="op" id="4644598">)</span>&nbsp;<span class="builtintype" id="4644600">error</span>&nbsp;<span class="op" id="4644606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644609">_</span><span class="op" id="4644610">,</span>&nbsp;<span class="ident" id="4644612">err</span>&nbsp;<span class="op" id="4644616">:=</span>&nbsp;<span class="ident" id="4644619">io</span><span class="op" id="4644621">.</span><span class="ident" id="4644622">WriteString</span><span class="op" id="4644633">(</span><span class="ident" id="4644634">cw</span><span class="op" id="4644636">.</span><span class="ident" id="4644637">Wire</span><span class="op" id="4644641">,</span>&nbsp;<span class="string" id="4644643">&#34;0\r\n&#34;</span><span class="op" id="4644650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644653">return</span>&nbsp;<span class="ident" id="4644660">err</span><br>
<span class="lineno"></span><span class="op" id="4644664">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4644667">func</span>&nbsp;<span class="ident" id="4644672">parseHexUint</span><span class="op" id="4644684">(</span><span class="ident" id="4644685">v</span>&nbsp;<span class="op" id="4644687">[</span><span class="op" id="4644688">]</span><span class="builtintype" id="4644689">byte</span><span class="op" id="4644693">)</span>&nbsp;<span class="op" id="4644695">(</span><span class="ident" id="4644696">n</span>&nbsp;<span class="builtintype" id="4644698">uint64</span><span class="op" id="4644704">,</span>&nbsp;<span class="ident" id="4644706">err</span>&nbsp;<span class="builtintype" id="4644710">error</span><span class="op" id="4644715">)</span>&nbsp;<span class="op" id="4644717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644720">for</span>&nbsp;<span class="ident" id="4644724">_</span><span class="op" id="4644725">,</span>&nbsp;<span class="ident" id="4644727">b</span>&nbsp;<span class="op" id="4644729">:=</span>&nbsp;<span class="keyword" id="4644732">range</span>&nbsp;<span class="ident" id="4644738">v</span>&nbsp;<span class="op" id="4644740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644744">n</span>&nbsp;<span class="op" id="4644746">&lt;&lt;=</span>&nbsp;<span class="num" id="4644750">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644754">switch</span>&nbsp;<span class="op" id="4644761">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644765">case</span>&nbsp;<span class="string" id="4644770">&#39;0&#39;</span>&nbsp;<span class="op" id="4644774">&lt;=</span>&nbsp;<span class="ident" id="4644777">b</span>&nbsp;<span class="op" id="4644779">&amp;&amp;</span>&nbsp;<span class="ident" id="4644782">b</span>&nbsp;<span class="op" id="4644784">&lt;=</span>&nbsp;<span class="string" id="4644787">&#39;9&#39;</span><span class="op" id="4644790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644795">b</span>&nbsp;<span class="op" id="4644797">=</span>&nbsp;<span class="ident" id="4644799">b</span>&nbsp;<span class="op" id="4644801">-</span>&nbsp;<span class="string" id="4644803">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644809">case</span>&nbsp;<span class="string" id="4644814">&#39;a&#39;</span>&nbsp;<span class="op" id="4644818">&lt;=</span>&nbsp;<span class="ident" id="4644821">b</span>&nbsp;<span class="op" id="4644823">&amp;&amp;</span>&nbsp;<span class="ident" id="4644826">b</span>&nbsp;<span class="op" id="4644828">&lt;=</span>&nbsp;<span class="string" id="4644831">&#39;f&#39;</span><span class="op" id="4644834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644839">b</span>&nbsp;<span class="op" id="4644841">=</span>&nbsp;<span class="ident" id="4644843">b</span>&nbsp;<span class="op" id="4644845">-</span>&nbsp;<span class="string" id="4644847">&#39;a&#39;</span>&nbsp;<span class="op" id="4644851">+</span>&nbsp;<span class="num" id="4644853">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644858">case</span>&nbsp;<span class="string" id="4644863">&#39;A&#39;</span>&nbsp;<span class="op" id="4644867">&lt;=</span>&nbsp;<span class="ident" id="4644870">b</span>&nbsp;<span class="op" id="4644872">&amp;&amp;</span>&nbsp;<span class="ident" id="4644875">b</span>&nbsp;<span class="op" id="4644877">&lt;=</span>&nbsp;<span class="string" id="4644880">&#39;F&#39;</span><span class="op" id="4644883">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644888">b</span>&nbsp;<span class="op" id="4644890">=</span>&nbsp;<span class="ident" id="4644892">b</span>&nbsp;<span class="op" id="4644894">-</span>&nbsp;<span class="string" id="4644896">&#39;A&#39;</span>&nbsp;<span class="op" id="4644900">+</span>&nbsp;<span class="num" id="4644902">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644907">default</span><span class="op" id="4644914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644919">return</span>&nbsp;<span class="num" id="4644926">0</span><span class="op" id="4644927">,</span>&nbsp;<span class="ident" id="4644929">errors</span><span class="op" id="4644935">.</span><span class="ident" id="4644936">New</span><span class="op" id="4644939">(</span><span class="string" id="4644940">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4644970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4644978">n</span>&nbsp;<span class="op" id="4644980">|=</span>&nbsp;<span class="builtintype" id="4644983">uint64</span><span class="op" id="4644989">(</span><span class="ident" id="4644990">b</span><span class="op" id="4644991">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4644994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4644997">return</span><br>
<span class="lineno"></span><span class="op" id="4645004">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
