<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3563792">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3563847">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3563901">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3563952">//&nbsp;HTTP&nbsp;Response&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563991">package</span>&nbsp;<span class="ident" id="3563999">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564005">import</span>&nbsp;<span class="op" id="3564012">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564015">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564024">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564033">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564047">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564057">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564063">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564080">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564091">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564102">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3564112">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3564115">var</span>&nbsp;<span class="ident" id="3564119">respExcludeHeader</span>&nbsp;<span class="op" id="3564137">=</span>&nbsp;<span class="keyword" id="3564139">map</span><span class="op" id="3564142">[</span><span class="builtintype" id="3564143">string</span><span class="op" id="3564149">]</span><span class="builtintype" id="3564150">bool</span><span class="op" id="3564154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564157">&#34;Content-Length&#34;</span><span class="op" id="3564173">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564178">true</span><span class="op" id="3564182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564185">&#34;Transfer-Encoding&#34;</span><span class="op" id="3564204">:</span>&nbsp;<span class="ident" id="3564206">true</span><span class="op" id="3564210">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3564213">&#34;Trailer&#34;</span><span class="op" id="3564222">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564234">true</span><span class="op" id="3564238">,</span><br>
<span class="lineno">25</span><span class="op" id="3564240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3564243">//&nbsp;Response&nbsp;represents&nbsp;the&nbsp;response&nbsp;from&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3564301">//</span><br>
<span class="lineno"></span><span class="keyword" id="3564304">type</span>&nbsp;<span class="ident" id="3564309">Response</span>&nbsp;<span class="keyword" id="3564318">struct</span>&nbsp;<span class="op" id="3564325">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564328">Status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3564339">string</span>&nbsp;<span class="comment" id="3564346">//&nbsp;e.g.&nbsp;&#34;200&nbsp;OK&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564364">StatusCode</span>&nbsp;<span class="builtintype" id="3564375">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3564382">//&nbsp;e.g.&nbsp;200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564395">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3564406">string</span>&nbsp;<span class="comment" id="3564413">//&nbsp;e.g.&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564433">ProtoMajor</span>&nbsp;<span class="builtintype" id="3564444">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3564451">//&nbsp;e.g.&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564462">ProtoMinor</span>&nbsp;<span class="builtintype" id="3564473">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3564480">//&nbsp;e.g.&nbsp;0</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564492">//&nbsp;Header&nbsp;maps&nbsp;header&nbsp;keys&nbsp;to&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;response&nbsp;had&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564561">//&nbsp;headers&nbsp;with&nbsp;the&nbsp;same&nbsp;key,&nbsp;they&nbsp;may&nbsp;be&nbsp;concatenated,&nbsp;with&nbsp;comma</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564629">//&nbsp;delimiters.&nbsp;&nbsp;(Section&nbsp;4.2&nbsp;of&nbsp;RFC&nbsp;2616&nbsp;requires&nbsp;that&nbsp;multiple&nbsp;headers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564702">//&nbsp;be&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;a&nbsp;comma-delimited&nbsp;sequence.)&nbsp;Values</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564772">//&nbsp;duplicated&nbsp;by&nbsp;other&nbsp;fields&nbsp;in&nbsp;this&nbsp;struct&nbsp;(e.g.,&nbsp;ContentLength)&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564844">//&nbsp;omitted&nbsp;from&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564869">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564873">//&nbsp;Keys&nbsp;in&nbsp;the&nbsp;map&nbsp;are&nbsp;canonicalized&nbsp;(see&nbsp;CanonicalHeaderKey).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564937">Header</span>&nbsp;<span class="ident" id="3564944">Header</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564953">//&nbsp;Body&nbsp;represents&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564992">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3564996">//&nbsp;The&nbsp;http&nbsp;Client&nbsp;and&nbsp;Transport&nbsp;guarantee&nbsp;that&nbsp;Body&nbsp;is&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565060">//&nbsp;non-nil,&nbsp;even&nbsp;on&nbsp;responses&nbsp;without&nbsp;a&nbsp;body&nbsp;or&nbsp;responses&nbsp;with</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565124">//&nbsp;a&nbsp;zero-length&nbsp;body.&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565185">//&nbsp;close&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565201">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565205">//&nbsp;The&nbsp;Body&nbsp;is&nbsp;automatically&nbsp;dechunked&nbsp;if&nbsp;the&nbsp;server&nbsp;replied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565267">//&nbsp;with&nbsp;a&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565307">Body</span>&nbsp;<span class="ident" id="3565312">io</span><span class="op" id="3565314">.</span><span class="ident" id="3565315">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565328">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.&nbsp;&nbsp;The</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565397">//&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.&nbsp;&nbsp;Unless&nbsp;Request.Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565471">//&nbsp;is&nbsp;&#34;HEAD&#34;,&nbsp;values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565542">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565565">ContentLength</span>&nbsp;<span class="ident" id="3565579">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565587">//&nbsp;Contains&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outer-most&nbsp;to&nbsp;inner-most.&nbsp;Value&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565659">//&nbsp;nil,&nbsp;means&nbsp;that&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565708">TransferEncoding</span>&nbsp;<span class="op" id="3565725">[</span><span class="op" id="3565726">]</span><span class="builtintype" id="3565727">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565736">//&nbsp;Close&nbsp;records&nbsp;whether&nbsp;the&nbsp;header&nbsp;directed&nbsp;that&nbsp;the&nbsp;connection&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565805">//&nbsp;closed&nbsp;after&nbsp;reading&nbsp;Body.&nbsp;&nbsp;The&nbsp;value&nbsp;is&nbsp;advice&nbsp;for&nbsp;clients:&nbsp;neither</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565878">//&nbsp;ReadResponse&nbsp;nor&nbsp;Response.Write&nbsp;ever&nbsp;closes&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565940">Close</span>&nbsp;<span class="builtintype" id="3565946">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3565953">//&nbsp;Trailer&nbsp;maps&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;values,&nbsp;in&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566006">//&nbsp;format&nbsp;as&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566032">Trailer</span>&nbsp;<span class="ident" id="3566040">Header</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566049">//&nbsp;The&nbsp;Request&nbsp;that&nbsp;was&nbsp;sent&nbsp;to&nbsp;obtain&nbsp;this&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566104">//&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;nil&nbsp;(having&nbsp;already&nbsp;been&nbsp;consumed).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566162">//&nbsp;This&nbsp;is&nbsp;only&nbsp;populated&nbsp;for&nbsp;Client&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566210">Request</span>&nbsp;<span class="op" id="3566218">*</span><span class="ident" id="3566219">Request</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566229">//&nbsp;TLS&nbsp;contains&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566296">//&nbsp;response&nbsp;was&nbsp;received.&nbsp;It&nbsp;is&nbsp;nil&nbsp;for&nbsp;unencrypted&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566360">//&nbsp;The&nbsp;pointer&nbsp;is&nbsp;shared&nbsp;between&nbsp;responses&nbsp;and&nbsp;should&nbsp;not&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3566422">//&nbsp;modified.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566436">TLS</span>&nbsp;<span class="op" id="3566440">*</span><span class="ident" id="3566441">tls</span><span class="op" id="3566444">.</span><span class="ident" id="3566445">ConnectionState</span><br>
<span class="lineno"></span><span class="op" id="3566461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3566464">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;cookies&nbsp;set&nbsp;in&nbsp;the&nbsp;Set-Cookie&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="3566537">func</span>&nbsp;<span class="op" id="3566542">(</span><span class="ident" id="3566543">r</span>&nbsp;<span class="op" id="3566545">*</span><span class="ident" id="3566546">Response</span><span class="op" id="3566554">)</span>&nbsp;<span class="ident" id="3566556">Cookies</span><span class="op" id="3566563">(</span><span class="op" id="3566564">)</span>&nbsp;<span class="op" id="3566566">[</span><span class="op" id="3566567">]</span><span class="op" id="3566568">*</span><span class="ident" id="3566569">Cookie</span>&nbsp;<span class="op" id="3566576">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566579">return</span>&nbsp;<span class="ident" id="3566586">readSetCookies</span><span class="op" id="3566600">(</span><span class="ident" id="3566601">r</span><span class="op" id="3566602">.</span><span class="ident" id="3566603">Header</span><span class="op" id="3566609">)</span><br>
<span class="lineno"></span><span class="op" id="3566611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3566614">var</span>&nbsp;<span class="ident" id="3566618">ErrNoLocation</span>&nbsp;<span class="op" id="3566632">=</span>&nbsp;<span class="ident" id="3566634">errors</span><span class="op" id="3566640">.</span><span class="ident" id="3566641">New</span><span class="op" id="3566644">(</span><span class="string" id="3566645">&#34;http:&nbsp;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="3566683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3566686">//&nbsp;Location&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;response&#39;s&nbsp;&#34;Location&#34;&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="3566751">//&nbsp;if&nbsp;present.&nbsp;&nbsp;Relative&nbsp;redirects&nbsp;are&nbsp;resolved&nbsp;relative&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3566811">//&nbsp;the&nbsp;Response&#39;s&nbsp;Request.&nbsp;&nbsp;ErrNoLocation&nbsp;is&nbsp;returned&nbsp;if&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3566871">//&nbsp;Location&nbsp;header&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span><span class="keyword" id="3566902">func</span>&nbsp;<span class="op" id="3566907">(</span><span class="ident" id="3566908">r</span>&nbsp;<span class="op" id="3566910">*</span><span class="ident" id="3566911">Response</span><span class="op" id="3566919">)</span>&nbsp;<span class="ident" id="3566921">Location</span><span class="op" id="3566929">(</span><span class="op" id="3566930">)</span>&nbsp;<span class="op" id="3566932">(</span><span class="op" id="3566933">*</span><span class="ident" id="3566934">url</span><span class="op" id="3566937">.</span><span class="ident" id="3566938">URL</span><span class="op" id="3566941">,</span>&nbsp;<span class="builtintype" id="3566943">error</span><span class="op" id="3566948">)</span>&nbsp;<span class="op" id="3566950">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566953">lv</span>&nbsp;<span class="op" id="3566956">:=</span>&nbsp;<span class="ident" id="3566959">r</span><span class="op" id="3566960">.</span><span class="ident" id="3566961">Header</span><span class="op" id="3566967">.</span><span class="ident" id="3566968">Get</span><span class="op" id="3566971">(</span><span class="string" id="3566972">&#34;Location&#34;</span><span class="op" id="3566982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566985">if</span>&nbsp;<span class="ident" id="3566988">lv</span>&nbsp;<span class="op" id="3566991">==</span>&nbsp;<span class="string" id="3566994">&#34;&#34;</span>&nbsp;<span class="op" id="3566997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567001">return</span>&nbsp;<span class="ident" id="3567008">nil</span><span class="op" id="3567011">,</span>&nbsp;<span class="ident" id="3567013">ErrNoLocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567031">if</span>&nbsp;<span class="ident" id="3567034">r</span><span class="op" id="3567035">.</span><span class="ident" id="3567036">Request</span>&nbsp;<span class="op" id="3567044">!=</span>&nbsp;<span class="ident" id="3567047">nil</span>&nbsp;<span class="op" id="3567051">&amp;&amp;</span>&nbsp;<span class="ident" id="3567054">r</span><span class="op" id="3567055">.</span><span class="ident" id="3567056">Request</span><span class="op" id="3567063">.</span><span class="ident" id="3567064">URL</span>&nbsp;<span class="op" id="3567068">!=</span>&nbsp;<span class="ident" id="3567071">nil</span>&nbsp;<span class="op" id="3567075">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567079">return</span>&nbsp;<span class="ident" id="3567086">r</span><span class="op" id="3567087">.</span><span class="ident" id="3567088">Request</span><span class="op" id="3567095">.</span><span class="ident" id="3567096">URL</span><span class="op" id="3567099">.</span><span class="ident" id="3567100">Parse</span><span class="op" id="3567105">(</span><span class="ident" id="3567106">lv</span><span class="op" id="3567108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567114">return</span>&nbsp;<span class="ident" id="3567121">url</span><span class="op" id="3567124">.</span><span class="ident" id="3567125">Parse</span><span class="op" id="3567130">(</span><span class="ident" id="3567131">lv</span><span class="op" id="3567133">)</span><br>
<span class="lineno"></span><span class="op" id="3567135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="3567138">//&nbsp;ReadResponse&nbsp;reads&nbsp;and&nbsp;returns&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="3567197">//&nbsp;The&nbsp;req&nbsp;parameter&nbsp;optionally&nbsp;specifies&nbsp;the&nbsp;Request&nbsp;that&nbsp;corresponds</span><br>
<span class="lineno"></span><span class="comment" id="3567268">//&nbsp;to&nbsp;this&nbsp;Response.&nbsp;If&nbsp;nil,&nbsp;a&nbsp;GET&nbsp;request&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3567323">//&nbsp;Clients&nbsp;must&nbsp;call&nbsp;resp.Body.Close&nbsp;when&nbsp;finished&nbsp;reading&nbsp;resp.Body.</span><br>
<span class="lineno"></span><span class="comment" id="3567393">//&nbsp;After&nbsp;that&nbsp;call,&nbsp;clients&nbsp;can&nbsp;inspect&nbsp;resp.Trailer&nbsp;to&nbsp;find&nbsp;key/value</span><br>
<span class="lineno">115</span><span class="comment" id="3567464">//&nbsp;pairs&nbsp;included&nbsp;in&nbsp;the&nbsp;response&nbsp;trailer.</span><br>
<span class="lineno"></span><span class="keyword" id="3567507">func</span>&nbsp;<span class="ident" id="3567512">ReadResponse</span><span class="op" id="3567524">(</span><span class="ident" id="3567525">r</span>&nbsp;<span class="op" id="3567527">*</span><span class="ident" id="3567528">bufio</span><span class="op" id="3567533">.</span><span class="ident" id="3567534">Reader</span><span class="op" id="3567540">,</span>&nbsp;<span class="ident" id="3567542">req</span>&nbsp;<span class="op" id="3567546">*</span><span class="ident" id="3567547">Request</span><span class="op" id="3567554">)</span>&nbsp;<span class="op" id="3567556">(</span><span class="op" id="3567557">*</span><span class="ident" id="3567558">Response</span><span class="op" id="3567566">,</span>&nbsp;<span class="builtintype" id="3567568">error</span><span class="op" id="3567573">)</span>&nbsp;<span class="op" id="3567575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567578">tp</span>&nbsp;<span class="op" id="3567581">:=</span>&nbsp;<span class="ident" id="3567584">textproto</span><span class="op" id="3567593">.</span><span class="ident" id="3567594">NewReader</span><span class="op" id="3567603">(</span><span class="ident" id="3567604">r</span><span class="op" id="3567605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567608">resp</span>&nbsp;<span class="op" id="3567613">:=</span>&nbsp;<span class="op" id="3567616">&amp;</span><span class="ident" id="3567617">Response</span><span class="op" id="3567625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567629">Request</span><span class="op" id="3567636">:</span>&nbsp;<span class="ident" id="3567638">req</span><span class="op" id="3567641">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3567648">//&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567690">line</span><span class="op" id="3567694">,</span>&nbsp;<span class="ident" id="3567696">err</span>&nbsp;<span class="op" id="3567700">:=</span>&nbsp;<span class="ident" id="3567703">tp</span><span class="op" id="3567705">.</span><span class="ident" id="3567706">ReadLine</span><span class="op" id="3567714">(</span><span class="op" id="3567715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567718">if</span>&nbsp;<span class="ident" id="3567721">err</span>&nbsp;<span class="op" id="3567725">!=</span>&nbsp;<span class="ident" id="3567728">nil</span>&nbsp;<span class="op" id="3567732">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567736">if</span>&nbsp;<span class="ident" id="3567739">err</span>&nbsp;<span class="op" id="3567743">==</span>&nbsp;<span class="ident" id="3567746">io</span><span class="op" id="3567748">.</span><span class="ident" id="3567749">EOF</span>&nbsp;<span class="op" id="3567753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567758">err</span>&nbsp;<span class="op" id="3567762">=</span>&nbsp;<span class="ident" id="3567764">io</span><span class="op" id="3567766">.</span><span class="ident" id="3567767">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567790">return</span>&nbsp;<span class="ident" id="3567797">nil</span><span class="op" id="3567800">,</span>&nbsp;<span class="ident" id="3567802">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567807">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567810">f</span>&nbsp;<span class="op" id="3567812">:=</span>&nbsp;<span class="ident" id="3567815">strings</span><span class="op" id="3567822">.</span><span class="ident" id="3567823">SplitN</span><span class="op" id="3567829">(</span><span class="ident" id="3567830">line</span><span class="op" id="3567834">,</span>&nbsp;<span class="string" id="3567836">&#34;&nbsp;&#34;</span><span class="op" id="3567839">,</span>&nbsp;<span class="num" id="3567841">3</span><span class="op" id="3567842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567845">if</span>&nbsp;<span class="builtinfunc" id="3567848">len</span><span class="op" id="3567851">(</span><span class="ident" id="3567852">f</span><span class="op" id="3567853">)</span>&nbsp;<span class="op" id="3567855">&lt;</span>&nbsp;<span class="num" id="3567857">2</span>&nbsp;<span class="op" id="3567859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567863">return</span>&nbsp;<span class="ident" id="3567870">nil</span><span class="op" id="3567873">,</span>&nbsp;<span class="op" id="3567875">&amp;</span><span class="ident" id="3567876">badStringError</span><span class="op" id="3567890">{</span><span class="string" id="3567891">&#34;malformed&nbsp;HTTP&nbsp;response&#34;</span><span class="op" id="3567916">,</span>&nbsp;<span class="ident" id="3567918">line</span><span class="op" id="3567922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567928">reasonPhrase</span>&nbsp;<span class="op" id="3567941">:=</span>&nbsp;<span class="string" id="3567944">&#34;&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567948">if</span>&nbsp;<span class="builtinfunc" id="3567951">len</span><span class="op" id="3567954">(</span><span class="ident" id="3567955">f</span><span class="op" id="3567956">)</span>&nbsp;<span class="op" id="3567958">&gt;</span>&nbsp;<span class="num" id="3567960">2</span>&nbsp;<span class="op" id="3567962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567966">reasonPhrase</span>&nbsp;<span class="op" id="3567979">=</span>&nbsp;<span class="ident" id="3567981">f</span><span class="op" id="3567982">[</span><span class="num" id="3567983">2</span><span class="op" id="3567984">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567990">resp</span><span class="op" id="3567994">.</span><span class="ident" id="3567995">Status</span>&nbsp;<span class="op" id="3568002">=</span>&nbsp;<span class="ident" id="3568004">f</span><span class="op" id="3568005">[</span><span class="num" id="3568006">1</span><span class="op" id="3568007">]</span>&nbsp;<span class="op" id="3568009">+</span>&nbsp;<span class="string" id="3568011">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3568015">+</span>&nbsp;<span class="ident" id="3568017">reasonPhrase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568031">resp</span><span class="op" id="3568035">.</span><span class="ident" id="3568036">StatusCode</span><span class="op" id="3568046">,</span>&nbsp;<span class="ident" id="3568048">err</span>&nbsp;<span class="op" id="3568052">=</span>&nbsp;<span class="ident" id="3568054">strconv</span><span class="op" id="3568061">.</span><span class="ident" id="3568062">Atoi</span><span class="op" id="3568066">(</span><span class="ident" id="3568067">f</span><span class="op" id="3568068">[</span><span class="num" id="3568069">1</span><span class="op" id="3568070">]</span><span class="op" id="3568071">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568074">if</span>&nbsp;<span class="ident" id="3568077">err</span>&nbsp;<span class="op" id="3568081">!=</span>&nbsp;<span class="ident" id="3568084">nil</span>&nbsp;<span class="op" id="3568088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568092">return</span>&nbsp;<span class="ident" id="3568099">nil</span><span class="op" id="3568102">,</span>&nbsp;<span class="op" id="3568104">&amp;</span><span class="ident" id="3568105">badStringError</span><span class="op" id="3568119">{</span><span class="string" id="3568120">&#34;malformed&nbsp;HTTP&nbsp;status&nbsp;code&#34;</span><span class="op" id="3568148">,</span>&nbsp;<span class="ident" id="3568150">f</span><span class="op" id="3568151">[</span><span class="num" id="3568152">1</span><span class="op" id="3568153">]</span><span class="op" id="3568154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568161">resp</span><span class="op" id="3568165">.</span><span class="ident" id="3568166">Proto</span>&nbsp;<span class="op" id="3568172">=</span>&nbsp;<span class="ident" id="3568174">f</span><span class="op" id="3568175">[</span><span class="num" id="3568176">0</span><span class="op" id="3568177">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568180">var</span>&nbsp;<span class="ident" id="3568184">ok</span>&nbsp;<span class="builtintype" id="3568187">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568193">if</span>&nbsp;<span class="ident" id="3568196">resp</span><span class="op" id="3568200">.</span><span class="ident" id="3568201">ProtoMajor</span><span class="op" id="3568211">,</span>&nbsp;<span class="ident" id="3568213">resp</span><span class="op" id="3568217">.</span><span class="ident" id="3568218">ProtoMinor</span><span class="op" id="3568228">,</span>&nbsp;<span class="ident" id="3568230">ok</span>&nbsp;<span class="op" id="3568233">=</span>&nbsp;<span class="ident" id="3568235">ParseHTTPVersion</span><span class="op" id="3568251">(</span><span class="ident" id="3568252">resp</span><span class="op" id="3568256">.</span><span class="ident" id="3568257">Proto</span><span class="op" id="3568262">)</span><span class="op" id="3568263">;</span>&nbsp;<span class="op" id="3568265">!</span><span class="ident" id="3568266">ok</span>&nbsp;<span class="op" id="3568269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568273">return</span>&nbsp;<span class="ident" id="3568280">nil</span><span class="op" id="3568283">,</span>&nbsp;<span class="op" id="3568285">&amp;</span><span class="ident" id="3568286">badStringError</span><span class="op" id="3568300">{</span><span class="string" id="3568301">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op" id="3568325">,</span>&nbsp;<span class="ident" id="3568327">resp</span><span class="op" id="3568331">.</span><span class="ident" id="3568332">Proto</span><span class="op" id="3568337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3568344">//&nbsp;Parse&nbsp;the&nbsp;response&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568376">mimeHeader</span><span class="op" id="3568386">,</span>&nbsp;<span class="ident" id="3568388">err</span>&nbsp;<span class="op" id="3568392">:=</span>&nbsp;<span class="ident" id="3568395">tp</span><span class="op" id="3568397">.</span><span class="ident" id="3568398">ReadMIMEHeader</span><span class="op" id="3568412">(</span><span class="op" id="3568413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568416">if</span>&nbsp;<span class="ident" id="3568419">err</span>&nbsp;<span class="op" id="3568423">!=</span>&nbsp;<span class="ident" id="3568426">nil</span>&nbsp;<span class="op" id="3568430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568434">if</span>&nbsp;<span class="ident" id="3568437">err</span>&nbsp;<span class="op" id="3568441">==</span>&nbsp;<span class="ident" id="3568444">io</span><span class="op" id="3568446">.</span><span class="ident" id="3568447">EOF</span>&nbsp;<span class="op" id="3568451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568456">err</span>&nbsp;<span class="op" id="3568460">=</span>&nbsp;<span class="ident" id="3568462">io</span><span class="op" id="3568464">.</span><span class="ident" id="3568465">ErrUnexpectedEOF</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568488">return</span>&nbsp;<span class="ident" id="3568495">nil</span><span class="op" id="3568498">,</span>&nbsp;<span class="ident" id="3568500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568508">resp</span><span class="op" id="3568512">.</span><span class="ident" id="3568513">Header</span>&nbsp;<span class="op" id="3568520">=</span>&nbsp;<span class="ident" id="3568522">Header</span><span class="op" id="3568528">(</span><span class="ident" id="3568529">mimeHeader</span><span class="op" id="3568539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568543">fixPragmaCacheControl</span><span class="op" id="3568564">(</span><span class="ident" id="3568565">resp</span><span class="op" id="3568569">.</span><span class="ident" id="3568570">Header</span><span class="op" id="3568576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568580">err</span>&nbsp;<span class="op" id="3568584">=</span>&nbsp;<span class="ident" id="3568586">readTransfer</span><span class="op" id="3568598">(</span><span class="ident" id="3568599">resp</span><span class="op" id="3568603">,</span>&nbsp;<span class="ident" id="3568605">r</span><span class="op" id="3568606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568609">if</span>&nbsp;<span class="ident" id="3568612">err</span>&nbsp;<span class="op" id="3568616">!=</span>&nbsp;<span class="ident" id="3568619">nil</span>&nbsp;<span class="op" id="3568623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568627">return</span>&nbsp;<span class="ident" id="3568634">nil</span><span class="op" id="3568637">,</span>&nbsp;<span class="ident" id="3568639">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568648">return</span>&nbsp;<span class="ident" id="3568655">resp</span><span class="op" id="3568659">,</span>&nbsp;<span class="ident" id="3568661">nil</span><br>
<span class="lineno"></span><span class="op" id="3568665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="3568668">//&nbsp;RFC2616:&nbsp;Should&nbsp;treat</span><br>
<span class="lineno"></span><span class="comment" id="3568693">//&nbsp;&nbsp;&nbsp;&nbspPragma:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="comment" id="3568713">//&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="3568721">//&nbsp;&nbsp;&nbsp;&nbspCache-Control:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="keyword" id="3568748">func</span>&nbsp;<span class="ident" id="3568753">fixPragmaCacheControl</span><span class="op" id="3568774">(</span><span class="ident" id="3568775">header</span>&nbsp;<span class="ident" id="3568782">Header</span><span class="op" id="3568788">)</span>&nbsp;<span class="op" id="3568790">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568793">if</span>&nbsp;<span class="ident" id="3568796">hp</span><span class="op" id="3568798">,</span>&nbsp;<span class="ident" id="3568800">ok</span>&nbsp;<span class="op" id="3568803">:=</span>&nbsp;<span class="ident" id="3568806">header</span><span class="op" id="3568812">[</span><span class="string" id="3568813">&#34;Pragma&#34;</span><span class="op" id="3568821">]</span><span class="op" id="3568822">;</span>&nbsp;<span class="ident" id="3568824">ok</span>&nbsp;<span class="op" id="3568827">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3568830">len</span><span class="op" id="3568833">(</span><span class="ident" id="3568834">hp</span><span class="op" id="3568836">)</span>&nbsp;<span class="op" id="3568838">&gt;</span>&nbsp;<span class="num" id="3568840">0</span>&nbsp;<span class="op" id="3568842">&amp;&amp;</span>&nbsp;<span class="ident" id="3568845">hp</span><span class="op" id="3568847">[</span><span class="num" id="3568848">0</span><span class="op" id="3568849">]</span>&nbsp;<span class="op" id="3568851">==</span>&nbsp;<span class="string" id="3568854">&#34;no-cache&#34;</span>&nbsp;<span class="op" id="3568865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3568869">if</span>&nbsp;<span class="ident" id="3568872">_</span><span class="op" id="3568873">,</span>&nbsp;<span class="ident" id="3568875">presentcc</span>&nbsp;<span class="op" id="3568885">:=</span>&nbsp;<span class="ident" id="3568888">header</span><span class="op" id="3568894">[</span><span class="string" id="3568895">&#34;Cache-Control&#34;</span><span class="op" id="3568910">]</span><span class="op" id="3568911">;</span>&nbsp;<span class="op" id="3568913">!</span><span class="ident" id="3568914">presentcc</span>&nbsp;<span class="op" id="3568924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3568929">header</span><span class="op" id="3568935">[</span><span class="string" id="3568936">&#34;Cache-Control&#34;</span><span class="op" id="3568951">]</span>&nbsp;<span class="op" id="3568953">=</span>&nbsp;<span class="op" id="3568955">[</span><span class="op" id="3568956">]</span><span class="builtintype" id="3568957">string</span><span class="op" id="3568963">{</span><span class="string" id="3568964">&#34;no-cache&#34;</span><span class="op" id="3568974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3568981">}</span><br>
<span class="lineno">180</span><span class="op" id="3568983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3568986">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="3569041">//&nbsp;in&nbsp;the&nbsp;response&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword" id="3569085">func</span>&nbsp;<span class="op" id="3569090">(</span><span class="ident" id="3569091">r</span>&nbsp;<span class="op" id="3569093">*</span><span class="ident" id="3569094">Response</span><span class="op" id="3569102">)</span>&nbsp;<span class="ident" id="3569104">ProtoAtLeast</span><span class="op" id="3569116">(</span><span class="ident" id="3569117">major</span><span class="op" id="3569122">,</span>&nbsp;<span class="ident" id="3569124">minor</span>&nbsp;<span class="builtintype" id="3569130">int</span><span class="op" id="3569133">)</span>&nbsp;<span class="builtintype" id="3569135">bool</span>&nbsp;<span class="op" id="3569140">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569143">return</span>&nbsp;<span class="ident" id="3569150">r</span><span class="op" id="3569151">.</span><span class="ident" id="3569152">ProtoMajor</span>&nbsp;<span class="op" id="3569163">&gt;</span>&nbsp;<span class="ident" id="3569165">major</span>&nbsp;<span class="op" id="3569171">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569176">r</span><span class="op" id="3569177">.</span><span class="ident" id="3569178">ProtoMajor</span>&nbsp;<span class="op" id="3569189">==</span>&nbsp;<span class="ident" id="3569192">major</span>&nbsp;<span class="op" id="3569198">&amp;&amp;</span>&nbsp;<span class="ident" id="3569201">r</span><span class="op" id="3569202">.</span><span class="ident" id="3569203">ProtoMinor</span>&nbsp;<span class="op" id="3569214">&gt;=</span>&nbsp;<span class="ident" id="3569217">minor</span><br>
<span class="lineno"></span><span class="op" id="3569223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3569226">//&nbsp;Writes&nbsp;the&nbsp;response&nbsp;(header,&nbsp;body&nbsp;and&nbsp;trailer)&nbsp;in&nbsp;wire&nbsp;format.&nbsp;This&nbsp;method</span><br>
<span class="lineno">190</span><span class="comment" id="3569304">//&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;response:</span><br>
<span class="lineno"></span><span class="comment" id="3569354">//</span><br>
<span class="lineno"></span><span class="comment" id="3569357">//&nbsp;&nbsp;StatusCode</span><br>
<span class="lineno"></span><span class="comment" id="3569372">//&nbsp;&nbsp;ProtoMajor</span><br>
<span class="lineno"></span><span class="comment" id="3569387">//&nbsp;&nbsp;ProtoMinor</span><br>
<span class="lineno">195</span><span class="comment" id="3569402">//&nbsp;&nbsp;Request.Method</span><br>
<span class="lineno"></span><span class="comment" id="3569421">//&nbsp;&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment" id="3569442">//&nbsp;&nbsp;Trailer</span><br>
<span class="lineno"></span><span class="comment" id="3569454">//&nbsp;&nbsp;Body</span><br>
<span class="lineno"></span><span class="comment" id="3569463">//&nbsp;&nbsp;ContentLength</span><br>
<span class="lineno">200</span><span class="comment" id="3569481">//&nbsp;&nbsp;Header,&nbsp;values&nbsp;for&nbsp;non-canonical&nbsp;keys&nbsp;will&nbsp;have&nbsp;unpredictable&nbsp;behavior</span><br>
<span class="lineno"></span><span class="comment" id="3569556">//</span><br>
<span class="lineno"></span><span class="comment" id="3569559">//&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="3569595">func</span>&nbsp;<span class="op" id="3569600">(</span><span class="ident" id="3569601">r</span>&nbsp;<span class="op" id="3569603">*</span><span class="ident" id="3569604">Response</span><span class="op" id="3569612">)</span>&nbsp;<span class="ident" id="3569614">Write</span><span class="op" id="3569619">(</span><span class="ident" id="3569620">w</span>&nbsp;<span class="ident" id="3569622">io</span><span class="op" id="3569624">.</span><span class="ident" id="3569625">Writer</span><span class="op" id="3569631">)</span>&nbsp;<span class="builtintype" id="3569633">error</span>&nbsp;<span class="op" id="3569639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3569642">//&nbsp;Status&nbsp;line</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569658">text</span>&nbsp;<span class="op" id="3569663">:=</span>&nbsp;<span class="ident" id="3569666">r</span><span class="op" id="3569667">.</span><span class="ident" id="3569668">Status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569676">if</span>&nbsp;<span class="ident" id="3569679">text</span>&nbsp;<span class="op" id="3569684">==</span>&nbsp;<span class="string" id="3569687">&#34;&#34;</span>&nbsp;<span class="op" id="3569690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569694">var</span>&nbsp;<span class="ident" id="3569698">ok</span>&nbsp;<span class="builtintype" id="3569701">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569708">text</span><span class="op" id="3569712">,</span>&nbsp;<span class="ident" id="3569714">ok</span>&nbsp;<span class="op" id="3569717">=</span>&nbsp;<span class="ident" id="3569719">statusText</span><span class="op" id="3569729">[</span><span class="ident" id="3569730">r</span><span class="op" id="3569731">.</span><span class="ident" id="3569732">StatusCode</span><span class="op" id="3569742">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569746">if</span>&nbsp;<span class="op" id="3569749">!</span><span class="ident" id="3569750">ok</span>&nbsp;<span class="op" id="3569753">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569758">text</span>&nbsp;<span class="op" id="3569763">=</span>&nbsp;<span class="string" id="3569765">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3569780">+</span>&nbsp;<span class="ident" id="3569782">strconv</span><span class="op" id="3569789">.</span><span class="ident" id="3569790">Itoa</span><span class="op" id="3569794">(</span><span class="ident" id="3569795">r</span><span class="op" id="3569796">.</span><span class="ident" id="3569797">StatusCode</span><span class="op" id="3569807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3569811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3569814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569817">protoMajor</span><span class="op" id="3569827">,</span>&nbsp;<span class="ident" id="3569829">protoMinor</span>&nbsp;<span class="op" id="3569840">:=</span>&nbsp;<span class="ident" id="3569843">strconv</span><span class="op" id="3569850">.</span><span class="ident" id="3569851">Itoa</span><span class="op" id="3569855">(</span><span class="ident" id="3569856">r</span><span class="op" id="3569857">.</span><span class="ident" id="3569858">ProtoMajor</span><span class="op" id="3569868">)</span><span class="op" id="3569869">,</span>&nbsp;<span class="ident" id="3569871">strconv</span><span class="op" id="3569878">.</span><span class="ident" id="3569879">Itoa</span><span class="op" id="3569883">(</span><span class="ident" id="3569884">r</span><span class="op" id="3569885">.</span><span class="ident" id="3569886">ProtoMinor</span><span class="op" id="3569896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569899">statusCode</span>&nbsp;<span class="op" id="3569910">:=</span>&nbsp;<span class="ident" id="3569913">strconv</span><span class="op" id="3569920">.</span><span class="ident" id="3569921">Itoa</span><span class="op" id="3569925">(</span><span class="ident" id="3569926">r</span><span class="op" id="3569927">.</span><span class="ident" id="3569928">StatusCode</span><span class="op" id="3569938">)</span>&nbsp;<span class="op" id="3569940">+</span>&nbsp;<span class="string" id="3569942">&#34;&nbsp;&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569947">text</span>&nbsp;<span class="op" id="3569952">=</span>&nbsp;<span class="ident" id="3569954">strings</span><span class="op" id="3569961">.</span><span class="ident" id="3569962">TrimPrefix</span><span class="op" id="3569972">(</span><span class="ident" id="3569973">text</span><span class="op" id="3569977">,</span>&nbsp;<span class="ident" id="3569979">statusCode</span><span class="op" id="3569989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569992">if</span>&nbsp;<span class="ident" id="3569995">_</span><span class="op" id="3569996">,</span>&nbsp;<span class="ident" id="3569998">err</span>&nbsp;<span class="op" id="3570002">:=</span>&nbsp;<span class="ident" id="3570005">io</span><span class="op" id="3570007">.</span><span class="ident" id="3570008">WriteString</span><span class="op" id="3570019">(</span><span class="ident" id="3570020">w</span><span class="op" id="3570021">,</span>&nbsp;<span class="string" id="3570023">&#34;HTTP/&#34;</span><span class="op" id="3570030">+</span><span class="ident" id="3570031">protoMajor</span><span class="op" id="3570041">+</span><span class="string" id="3570042">&#34;.&#34;</span><span class="op" id="3570045">+</span><span class="ident" id="3570046">protoMinor</span><span class="op" id="3570056">+</span><span class="string" id="3570057">&#34;&nbsp;&#34;</span><span class="op" id="3570060">+</span><span class="ident" id="3570061">statusCode</span><span class="op" id="3570071">+</span><span class="ident" id="3570072">text</span><span class="op" id="3570076">+</span><span class="string" id="3570077">&#34;\r\n&#34;</span><span class="op" id="3570083">)</span><span class="op" id="3570084">;</span>&nbsp;<span class="ident" id="3570086">err</span>&nbsp;<span class="op" id="3570090">!=</span>&nbsp;<span class="ident" id="3570093">nil</span>&nbsp;<span class="op" id="3570097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570101">return</span>&nbsp;<span class="ident" id="3570108">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570117">//&nbsp;Clone&nbsp;it,&nbsp;so&nbsp;we&nbsp;can&nbsp;modify&nbsp;r1&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570162">r1</span>&nbsp;<span class="op" id="3570165">:=</span>&nbsp;<span class="builtinfunc" id="3570168">new</span><span class="op" id="3570171">(</span><span class="ident" id="3570172">Response</span><span class="op" id="3570180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570183">*</span><span class="ident" id="3570184">r1</span>&nbsp;<span class="op" id="3570187">=</span>&nbsp;<span class="op" id="3570189">*</span><span class="ident" id="3570190">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570193">if</span>&nbsp;<span class="ident" id="3570196">r1</span><span class="op" id="3570198">.</span><span class="ident" id="3570199">ContentLength</span>&nbsp;<span class="op" id="3570213">==</span>&nbsp;<span class="num" id="3570216">0</span>&nbsp;<span class="op" id="3570218">&amp;&amp;</span>&nbsp;<span class="ident" id="3570221">r1</span><span class="op" id="3570223">.</span><span class="ident" id="3570224">Body</span>&nbsp;<span class="op" id="3570229">!=</span>&nbsp;<span class="ident" id="3570232">nil</span>&nbsp;<span class="op" id="3570236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570240">//&nbsp;Is&nbsp;it&nbsp;actually&nbsp;0&nbsp;length?&nbsp;Or&nbsp;just&nbsp;unknown?</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570287">var</span>&nbsp;<span class="ident" id="3570291">buf</span>&nbsp;<span class="op" id="3570295">[</span><span class="num" id="3570296">1</span><span class="op" id="3570297">]</span><span class="builtintype" id="3570298">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570305">n</span><span class="op" id="3570306">,</span>&nbsp;<span class="ident" id="3570308">err</span>&nbsp;<span class="op" id="3570312">:=</span>&nbsp;<span class="ident" id="3570315">r1</span><span class="op" id="3570317">.</span><span class="ident" id="3570318">Body</span><span class="op" id="3570322">.</span><span class="ident" id="3570323">Read</span><span class="op" id="3570327">(</span><span class="ident" id="3570328">buf</span><span class="op" id="3570331">[</span><span class="op" id="3570332">:</span><span class="op" id="3570333">]</span><span class="op" id="3570334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570338">if</span>&nbsp;<span class="ident" id="3570341">err</span>&nbsp;<span class="op" id="3570345">!=</span>&nbsp;<span class="ident" id="3570348">nil</span>&nbsp;<span class="op" id="3570352">&amp;&amp;</span>&nbsp;<span class="ident" id="3570355">err</span>&nbsp;<span class="op" id="3570359">!=</span>&nbsp;<span class="ident" id="3570362">io</span><span class="op" id="3570364">.</span><span class="ident" id="3570365">EOF</span>&nbsp;<span class="op" id="3570369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570374">return</span>&nbsp;<span class="ident" id="3570381">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570387">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570391">if</span>&nbsp;<span class="ident" id="3570394">n</span>&nbsp;<span class="op" id="3570396">==</span>&nbsp;<span class="num" id="3570399">0</span>&nbsp;<span class="op" id="3570401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570406">//&nbsp;Reset&nbsp;it&nbsp;to&nbsp;a&nbsp;known&nbsp;zero&nbsp;reader,&nbsp;in&nbsp;case&nbsp;underlying&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570468">//&nbsp;is&nbsp;unhappy&nbsp;being&nbsp;read&nbsp;repeatedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570508">r1</span><span class="op" id="3570510">.</span><span class="ident" id="3570511">Body</span>&nbsp;<span class="op" id="3570516">=</span>&nbsp;<span class="ident" id="3570518">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570530">}</span>&nbsp;<span class="keyword" id="3570532">else</span>&nbsp;<span class="op" id="3570537">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570542">r1</span><span class="op" id="3570544">.</span><span class="ident" id="3570545">ContentLength</span>&nbsp;<span class="op" id="3570559">=</span>&nbsp;<span class="op" id="3570561">-</span><span class="num" id="3570562">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570567">r1</span><span class="op" id="3570569">.</span><span class="ident" id="3570570">Body</span>&nbsp;<span class="op" id="3570575">=</span>&nbsp;<span class="keyword" id="3570577">struct</span>&nbsp;<span class="op" id="3570584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570590">io</span><span class="op" id="3570592">.</span><span class="ident" id="3570593">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570604">io</span><span class="op" id="3570606">.</span><span class="ident" id="3570607">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570617">}</span><span class="op" id="3570618">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570624">io</span><span class="op" id="3570626">.</span><span class="ident" id="3570627">MultiReader</span><span class="op" id="3570638">(</span><span class="ident" id="3570639">bytes</span><span class="op" id="3570644">.</span><span class="ident" id="3570645">NewReader</span><span class="op" id="3570654">(</span><span class="ident" id="3570655">buf</span><span class="op" id="3570658">[</span><span class="op" id="3570659">:</span><span class="num" id="3570660">1</span><span class="op" id="3570661">]</span><span class="op" id="3570662">)</span><span class="op" id="3570663">,</span>&nbsp;<span class="ident" id="3570665">r</span><span class="op" id="3570666">.</span><span class="ident" id="3570667">Body</span><span class="op" id="3570671">)</span><span class="op" id="3570672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570678">r</span><span class="op" id="3570679">.</span><span class="ident" id="3570680">Body</span><span class="op" id="3570684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570696">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570699">//&nbsp;If&nbsp;we&#39;re&nbsp;sending&nbsp;a&nbsp;non-chunked&nbsp;HTTP/1.1&nbsp;response&nbsp;without&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570762">//&nbsp;content-length,&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;do&nbsp;that&nbsp;is&nbsp;the&nbsp;old&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570826">//&nbsp;way,&nbsp;by&nbsp;noting&nbsp;the&nbsp;EOF&nbsp;with&nbsp;a&nbsp;connection&nbsp;close,&nbsp;so&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570889">//&nbsp;to&nbsp;set&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570907">if</span>&nbsp;<span class="ident" id="3570910">r1</span><span class="op" id="3570912">.</span><span class="ident" id="3570913">ContentLength</span>&nbsp;<span class="op" id="3570927">==</span>&nbsp;<span class="op" id="3570930">-</span><span class="num" id="3570931">1</span>&nbsp;<span class="op" id="3570933">&amp;&amp;</span>&nbsp;<span class="op" id="3570936">!</span><span class="ident" id="3570937">r1</span><span class="op" id="3570939">.</span><span class="ident" id="3570940">Close</span>&nbsp;<span class="op" id="3570946">&amp;&amp;</span>&nbsp;<span class="ident" id="3570949">r1</span><span class="op" id="3570951">.</span><span class="ident" id="3570952">ProtoAtLeast</span><span class="op" id="3570964">(</span><span class="num" id="3570965">1</span><span class="op" id="3570966">,</span>&nbsp;<span class="num" id="3570968">1</span><span class="op" id="3570969">)</span>&nbsp;<span class="op" id="3570971">&amp;&amp;</span>&nbsp;<span class="op" id="3570974">!</span><span class="ident" id="3570975">chunked</span><span class="op" id="3570982">(</span><span class="ident" id="3570983">r1</span><span class="op" id="3570985">.</span><span class="ident" id="3570986">TransferEncoding</span><span class="op" id="3571002">)</span>&nbsp;<span class="op" id="3571004">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571008">r1</span><span class="op" id="3571010">.</span><span class="ident" id="3571011">Close</span>&nbsp;<span class="op" id="3571017">=</span>&nbsp;<span class="ident" id="3571019">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571029">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571074">tw</span><span class="op" id="3571076">,</span>&nbsp;<span class="ident" id="3571078">err</span>&nbsp;<span class="op" id="3571082">:=</span>&nbsp;<span class="ident" id="3571085">newTransferWriter</span><span class="op" id="3571102">(</span><span class="ident" id="3571103">r1</span><span class="op" id="3571105">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571108">if</span>&nbsp;<span class="ident" id="3571111">err</span>&nbsp;<span class="op" id="3571115">!=</span>&nbsp;<span class="ident" id="3571118">nil</span>&nbsp;<span class="op" id="3571122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571126">return</span>&nbsp;<span class="ident" id="3571133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571141">err</span>&nbsp;<span class="op" id="3571145">=</span>&nbsp;<span class="ident" id="3571147">tw</span><span class="op" id="3571149">.</span><span class="ident" id="3571150">WriteHeader</span><span class="op" id="3571161">(</span><span class="ident" id="3571162">w</span><span class="op" id="3571163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571166">if</span>&nbsp;<span class="ident" id="3571169">err</span>&nbsp;<span class="op" id="3571173">!=</span>&nbsp;<span class="ident" id="3571176">nil</span>&nbsp;<span class="op" id="3571180">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571184">return</span>&nbsp;<span class="ident" id="3571191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571200">//&nbsp;Rest&nbsp;of&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571219">err</span>&nbsp;<span class="op" id="3571223">=</span>&nbsp;<span class="ident" id="3571225">r</span><span class="op" id="3571226">.</span><span class="ident" id="3571227">Header</span><span class="op" id="3571233">.</span><span class="ident" id="3571234">WriteSubset</span><span class="op" id="3571245">(</span><span class="ident" id="3571246">w</span><span class="op" id="3571247">,</span>&nbsp;<span class="ident" id="3571249">respExcludeHeader</span><span class="op" id="3571266">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571269">if</span>&nbsp;<span class="ident" id="3571272">err</span>&nbsp;<span class="op" id="3571276">!=</span>&nbsp;<span class="ident" id="3571279">nil</span>&nbsp;<span class="op" id="3571283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571287">return</span>&nbsp;<span class="ident" id="3571294">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571303">//&nbsp;contentLengthAlreadySent&nbsp;may&nbsp;have&nbsp;been&nbsp;already&nbsp;sent&nbsp;for</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571363">//&nbsp;POST/PUT&nbsp;requests,&nbsp;even&nbsp;if&nbsp;zero&nbsp;length.&nbsp;See&nbsp;Issue&nbsp;8180.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571423">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3571448">:=</span>&nbsp;<span class="ident" id="3571451">tw</span><span class="op" id="3571453">.</span><span class="ident" id="3571454">shouldSendContentLength</span><span class="op" id="3571477">(</span><span class="op" id="3571478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571481">if</span>&nbsp;<span class="ident" id="3571484">r1</span><span class="op" id="3571486">.</span><span class="ident" id="3571487">ContentLength</span>&nbsp;<span class="op" id="3571501">==</span>&nbsp;<span class="num" id="3571504">0</span>&nbsp;<span class="op" id="3571506">&amp;&amp;</span>&nbsp;<span class="op" id="3571509">!</span><span class="ident" id="3571510">chunked</span><span class="op" id="3571517">(</span><span class="ident" id="3571518">r1</span><span class="op" id="3571520">.</span><span class="ident" id="3571521">TransferEncoding</span><span class="op" id="3571537">)</span>&nbsp;<span class="op" id="3571539">&amp;&amp;</span>&nbsp;<span class="op" id="3571542">!</span><span class="ident" id="3571543">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3571568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571572">if</span>&nbsp;<span class="ident" id="3571575">_</span><span class="op" id="3571576">,</span>&nbsp;<span class="ident" id="3571578">err</span>&nbsp;<span class="op" id="3571582">:=</span>&nbsp;<span class="ident" id="3571585">io</span><span class="op" id="3571587">.</span><span class="ident" id="3571588">WriteString</span><span class="op" id="3571599">(</span><span class="ident" id="3571600">w</span><span class="op" id="3571601">,</span>&nbsp;<span class="string" id="3571603">&#34;Content-Length:&nbsp;0\r\n&#34;</span><span class="op" id="3571626">)</span><span class="op" id="3571627">;</span>&nbsp;<span class="ident" id="3571629">err</span>&nbsp;<span class="op" id="3571633">!=</span>&nbsp;<span class="ident" id="3571636">nil</span>&nbsp;<span class="op" id="3571640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571645">return</span>&nbsp;<span class="ident" id="3571652">err</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571665">//&nbsp;End-of-header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571683">if</span>&nbsp;<span class="ident" id="3571686">_</span><span class="op" id="3571687">,</span>&nbsp;<span class="ident" id="3571689">err</span>&nbsp;<span class="op" id="3571693">:=</span>&nbsp;<span class="ident" id="3571696">io</span><span class="op" id="3571698">.</span><span class="ident" id="3571699">WriteString</span><span class="op" id="3571710">(</span><span class="ident" id="3571711">w</span><span class="op" id="3571712">,</span>&nbsp;<span class="string" id="3571714">&#34;\r\n&#34;</span><span class="op" id="3571720">)</span><span class="op" id="3571721">;</span>&nbsp;<span class="ident" id="3571723">err</span>&nbsp;<span class="op" id="3571727">!=</span>&nbsp;<span class="ident" id="3571730">nil</span>&nbsp;<span class="op" id="3571734">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571738">return</span>&nbsp;<span class="ident" id="3571745">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571754">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571781">err</span>&nbsp;<span class="op" id="3571785">=</span>&nbsp;<span class="ident" id="3571787">tw</span><span class="op" id="3571789">.</span><span class="ident" id="3571790">WriteBody</span><span class="op" id="3571799">(</span><span class="ident" id="3571800">w</span><span class="op" id="3571801">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571804">if</span>&nbsp;<span class="ident" id="3571807">err</span>&nbsp;<span class="op" id="3571811">!=</span>&nbsp;<span class="ident" id="3571814">nil</span>&nbsp;<span class="op" id="3571818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571822">return</span>&nbsp;<span class="ident" id="3571829">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571838">//&nbsp;Success</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571850">return</span>&nbsp;<span class="ident" id="3571857">nil</span><br>
<span class="lineno"></span><span class="op" id="3571861">}</span>
</div>
</body>
</html>
