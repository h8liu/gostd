<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4029089">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4029144">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4029198">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4029249">//&nbsp;Package&nbsp;pem&nbsp;implements&nbsp;the&nbsp;PEM&nbsp;data&nbsp;encoding,&nbsp;which&nbsp;originated&nbsp;in&nbsp;Privacy</span><br>
<span class="lineno"></span><span class="comment" id="4029326">//&nbsp;Enhanced&nbsp;Mail.&nbsp;The&nbsp;most&nbsp;common&nbsp;use&nbsp;of&nbsp;PEM&nbsp;encoding&nbsp;today&nbsp;is&nbsp;in&nbsp;TLS&nbsp;keys&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4029405">//&nbsp;certificates.&nbsp;See&nbsp;RFC&nbsp;1421.</span><br>
<span class="lineno"></span><span class="keyword" id="4029436">package</span>&nbsp;<span class="ident" id="4029444">pem</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4029449">import</span>&nbsp;<span class="op" id="4029456">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4029459">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4029468">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4029487">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4029493">&#34;sort&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4029500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4029503">//&nbsp;A&nbsp;Block&nbsp;represents&nbsp;a&nbsp;PEM&nbsp;encoded&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4029550">//</span><br>
<span class="lineno"></span><span class="comment" id="4029553">//&nbsp;The&nbsp;encoded&nbsp;form&nbsp;is:</span><br>
<span class="lineno">20</span><span class="comment" id="4029577">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4029604">//&nbsp;&nbsp;&nbsp;&nbsp;Headers</span><br>
<span class="lineno"></span><span class="comment" id="4029618">//&nbsp;&nbsp;&nbsp;&nbsp;base64-encoded&nbsp;Bytes</span><br>
<span class="lineno"></span><span class="comment" id="4029645">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4029670">//&nbsp;where&nbsp;Headers&nbsp;is&nbsp;a&nbsp;possibly&nbsp;empty&nbsp;sequence&nbsp;of&nbsp;Key:&nbsp;Value&nbsp;lines.</span><br>
<span class="lineno">25</span><span class="keyword" id="4029737">type</span>&nbsp;<span class="ident" id="4029742">Block</span>&nbsp;<span class="keyword" id="4029748">struct</span>&nbsp;<span class="op" id="4029755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029758">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4029766">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4029784">//&nbsp;The&nbsp;type,&nbsp;taken&nbsp;from&nbsp;the&nbsp;preamble&nbsp;(i.e.&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029848">Headers</span>&nbsp;<span class="keyword" id="4029856">map</span><span class="op" id="4029859">[</span><span class="builtintype" id="4029860">string</span><span class="op" id="4029866">]</span><span class="builtintype" id="4029867">string</span>&nbsp;<span class="comment" id="4029874">//&nbsp;Optional&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029896">Bytes</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4029904">[</span><span class="op" id="4029905">]</span><span class="builtintype" id="4029906">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4029922">//&nbsp;The&nbsp;decoded&nbsp;bytes&nbsp;of&nbsp;the&nbsp;contents.&nbsp;Typically&nbsp;a&nbsp;DER&nbsp;encoded&nbsp;ASN.1&nbsp;structure.</span><br>
<span class="lineno"></span><span class="op" id="4030001">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4030004">//&nbsp;getLine&nbsp;results&nbsp;the&nbsp;first&nbsp;\r\n&nbsp;or&nbsp;\n&nbsp;delineated&nbsp;line&nbsp;from&nbsp;the&nbsp;given&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4030080">//&nbsp;array.&nbsp;The&nbsp;line&nbsp;does&nbsp;not&nbsp;include&nbsp;trailing&nbsp;whitespace&nbsp;or&nbsp;the&nbsp;trailing&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4030156">//&nbsp;line&nbsp;bytes.&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;byte&nbsp;array&nbsp;(also&nbsp;not&nbsp;including&nbsp;the&nbsp;new&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4030236">//&nbsp;bytes)&nbsp;is&nbsp;also&nbsp;returned&nbsp;and&nbsp;this&nbsp;will&nbsp;always&nbsp;be&nbsp;smaller&nbsp;than&nbsp;the&nbsp;original</span><br>
<span class="lineno">35</span><span class="comment" id="4030313">//&nbsp;argument.</span><br>
<span class="lineno"></span><span class="keyword" id="4030326">func</span>&nbsp;<span class="ident" id="4030331">getLine</span><span class="op" id="4030338">(</span><span class="ident" id="4030339">data</span>&nbsp;<span class="op" id="4030344">[</span><span class="op" id="4030345">]</span><span class="builtintype" id="4030346">byte</span><span class="op" id="4030350">)</span>&nbsp;<span class="op" id="4030352">(</span><span class="ident" id="4030353">line</span><span class="op" id="4030357">,</span>&nbsp;<span class="ident" id="4030359">rest</span>&nbsp;<span class="op" id="4030364">[</span><span class="op" id="4030365">]</span><span class="builtintype" id="4030366">byte</span><span class="op" id="4030370">)</span>&nbsp;<span class="op" id="4030372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030375">i</span>&nbsp;<span class="op" id="4030377">:=</span>&nbsp;<span class="ident" id="4030380">bytes</span><span class="op" id="4030385">.</span><span class="ident" id="4030386">Index</span><span class="op" id="4030391">(</span><span class="ident" id="4030392">data</span><span class="op" id="4030396">,</span>&nbsp;<span class="op" id="4030398">[</span><span class="op" id="4030399">]</span><span class="builtintype" id="4030400">byte</span><span class="op" id="4030404">{</span><span class="string" id="4030405">&#39;\n&#39;</span><span class="op" id="4030409">}</span><span class="op" id="4030410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030413">var</span>&nbsp;<span class="ident" id="4030417">j</span>&nbsp;<span class="builtintype" id="4030419">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030424">if</span>&nbsp;<span class="ident" id="4030427">i</span>&nbsp;<span class="op" id="4030429">&lt;</span>&nbsp;<span class="num" id="4030431">0</span>&nbsp;<span class="op" id="4030433">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030437">i</span>&nbsp;<span class="op" id="4030439">=</span>&nbsp;<span class="builtinfunc" id="4030441">len</span><span class="op" id="4030444">(</span><span class="ident" id="4030445">data</span><span class="op" id="4030449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030453">j</span>&nbsp;<span class="op" id="4030455">=</span>&nbsp;<span class="ident" id="4030457">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030460">}</span>&nbsp;<span class="keyword" id="4030462">else</span>&nbsp;<span class="op" id="4030467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030471">j</span>&nbsp;<span class="op" id="4030473">=</span>&nbsp;<span class="ident" id="4030475">i</span>&nbsp;<span class="op" id="4030477">+</span>&nbsp;<span class="num" id="4030479">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030483">if</span>&nbsp;<span class="ident" id="4030486">i</span>&nbsp;<span class="op" id="4030488">&gt;</span>&nbsp;<span class="num" id="4030490">0</span>&nbsp;<span class="op" id="4030492">&amp;&amp;</span>&nbsp;<span class="ident" id="4030495">data</span><span class="op" id="4030499">[</span><span class="ident" id="4030500">i</span><span class="op" id="4030501">-</span><span class="num" id="4030502">1</span><span class="op" id="4030503">]</span>&nbsp;<span class="op" id="4030505">==</span>&nbsp;<span class="string" id="4030508">&#39;\r&#39;</span>&nbsp;<span class="op" id="4030513">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030518">i</span><span class="op" id="4030519">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030530">return</span>&nbsp;<span class="ident" id="4030537">bytes</span><span class="op" id="4030542">.</span><span class="ident" id="4030543">TrimRight</span><span class="op" id="4030552">(</span><span class="ident" id="4030553">data</span><span class="op" id="4030557">[</span><span class="num" id="4030558">0</span><span class="op" id="4030559">:</span><span class="ident" id="4030560">i</span><span class="op" id="4030561">]</span><span class="op" id="4030562">,</span>&nbsp;<span class="string" id="4030564">&#34;&nbsp;\t&#34;</span><span class="op" id="4030569">)</span><span class="op" id="4030570">,</span>&nbsp;<span class="ident" id="4030572">data</span><span class="op" id="4030576">[</span><span class="ident" id="4030577">j</span><span class="op" id="4030578">:</span><span class="op" id="4030579">]</span><br>
<span class="lineno"></span><span class="op" id="4030581">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4030584">//&nbsp;removeWhitespace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;its&nbsp;input&nbsp;with&nbsp;all&nbsp;spaces,&nbsp;tab&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4030657">//&nbsp;newline&nbsp;characters&nbsp;removed.</span><br>
<span class="lineno"></span><span class="keyword" id="4030688">func</span>&nbsp;<span class="ident" id="4030693">removeWhitespace</span><span class="op" id="4030709">(</span><span class="ident" id="4030710">data</span>&nbsp;<span class="op" id="4030715">[</span><span class="op" id="4030716">]</span><span class="builtintype" id="4030717">byte</span><span class="op" id="4030721">)</span>&nbsp;<span class="op" id="4030723">[</span><span class="op" id="4030724">]</span><span class="builtintype" id="4030725">byte</span>&nbsp;<span class="op" id="4030730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030733">result</span>&nbsp;<span class="op" id="4030740">:=</span>&nbsp;<span class="builtinfunc" id="4030743">make</span><span class="op" id="4030747">(</span><span class="op" id="4030748">[</span><span class="op" id="4030749">]</span><span class="builtintype" id="4030750">byte</span><span class="op" id="4030754">,</span>&nbsp;<span class="builtinfunc" id="4030756">len</span><span class="op" id="4030759">(</span><span class="ident" id="4030760">data</span><span class="op" id="4030764">)</span><span class="op" id="4030765">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030768">n</span>&nbsp;<span class="op" id="4030770">:=</span>&nbsp;<span class="num" id="4030773">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030777">for</span>&nbsp;<span class="ident" id="4030781">_</span><span class="op" id="4030782">,</span>&nbsp;<span class="ident" id="4030784">b</span>&nbsp;<span class="op" id="4030786">:=</span>&nbsp;<span class="keyword" id="4030789">range</span>&nbsp;<span class="ident" id="4030795">data</span>&nbsp;<span class="op" id="4030800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030804">if</span>&nbsp;<span class="ident" id="4030807">b</span>&nbsp;<span class="op" id="4030809">==</span>&nbsp;<span class="string" id="4030812">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4030816">||</span>&nbsp;<span class="ident" id="4030819">b</span>&nbsp;<span class="op" id="4030821">==</span>&nbsp;<span class="string" id="4030824">&#39;\t&#39;</span>&nbsp;<span class="op" id="4030829">||</span>&nbsp;<span class="ident" id="4030832">b</span>&nbsp;<span class="op" id="4030834">==</span>&nbsp;<span class="string" id="4030837">&#39;\r&#39;</span>&nbsp;<span class="op" id="4030842">||</span>&nbsp;<span class="ident" id="4030845">b</span>&nbsp;<span class="op" id="4030847">==</span>&nbsp;<span class="string" id="4030850">&#39;\n&#39;</span>&nbsp;<span class="op" id="4030855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030860">continue</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030875">result</span><span class="op" id="4030881">[</span><span class="ident" id="4030882">n</span><span class="op" id="4030883">]</span>&nbsp;<span class="op" id="4030885">=</span>&nbsp;<span class="ident" id="4030887">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030891">n</span><span class="op" id="4030892">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030900">return</span>&nbsp;<span class="ident" id="4030907">result</span><span class="op" id="4030913">[</span><span class="num" id="4030914">0</span><span class="op" id="4030915">:</span><span class="ident" id="4030916">n</span><span class="op" id="4030917">]</span><br>
<span class="lineno"></span><span class="op" id="4030919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4030922">var</span>&nbsp;<span class="ident" id="4030926">pemStart</span>&nbsp;<span class="op" id="4030935">=</span>&nbsp;<span class="op" id="4030937">[</span><span class="op" id="4030938">]</span><span class="builtintype" id="4030939">byte</span><span class="op" id="4030943">(</span><span class="string" id="4030944">&#34;\n-----BEGIN&nbsp;&#34;</span><span class="op" id="4030959">)</span><br>
<span class="lineno"></span><span class="keyword" id="4030961">var</span>&nbsp;<span class="ident" id="4030965">pemEnd</span>&nbsp;<span class="op" id="4030972">=</span>&nbsp;<span class="op" id="4030974">[</span><span class="op" id="4030975">]</span><span class="builtintype" id="4030976">byte</span><span class="op" id="4030980">(</span><span class="string" id="4030981">&#34;\n-----END&nbsp;&#34;</span><span class="op" id="4030994">)</span><br>
<span class="lineno">70</span><span class="keyword" id="4030996">var</span>&nbsp;<span class="ident" id="4031000">pemEndOfLine</span>&nbsp;<span class="op" id="4031013">=</span>&nbsp;<span class="op" id="4031015">[</span><span class="op" id="4031016">]</span><span class="builtintype" id="4031017">byte</span><span class="op" id="4031021">(</span><span class="string" id="4031022">&#34;-----&#34;</span><span class="op" id="4031029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4031032">//&nbsp;Decode&nbsp;will&nbsp;find&nbsp;the&nbsp;next&nbsp;PEM&nbsp;formatted&nbsp;block&nbsp;(certificate,&nbsp;private&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="4031107">//&nbsp;etc)&nbsp;in&nbsp;the&nbsp;input.&nbsp;It&nbsp;returns&nbsp;that&nbsp;block&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;input.&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4031186">//&nbsp;no&nbsp;PEM&nbsp;data&nbsp;is&nbsp;found,&nbsp;p&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;is&nbsp;returned&nbsp;in</span><br>
<span class="lineno">75</span><span class="comment" id="4031262">//&nbsp;rest.</span><br>
<span class="lineno"></span><span class="keyword" id="4031271">func</span>&nbsp;<span class="ident" id="4031276">Decode</span><span class="op" id="4031282">(</span><span class="ident" id="4031283">data</span>&nbsp;<span class="op" id="4031288">[</span><span class="op" id="4031289">]</span><span class="builtintype" id="4031290">byte</span><span class="op" id="4031294">)</span>&nbsp;<span class="op" id="4031296">(</span><span class="ident" id="4031297">p</span>&nbsp;<span class="op" id="4031299">*</span><span class="ident" id="4031300">Block</span><span class="op" id="4031305">,</span>&nbsp;<span class="ident" id="4031307">rest</span>&nbsp;<span class="op" id="4031312">[</span><span class="op" id="4031313">]</span><span class="builtintype" id="4031314">byte</span><span class="op" id="4031318">)</span>&nbsp;<span class="op" id="4031320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031323">//&nbsp;pemStart&nbsp;begins&nbsp;with&nbsp;a&nbsp;newline.&nbsp;However,&nbsp;at&nbsp;the&nbsp;very&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031393">//&nbsp;the&nbsp;byte&nbsp;array,&nbsp;we&#39;ll&nbsp;accept&nbsp;the&nbsp;start&nbsp;string&nbsp;without&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031455">rest</span>&nbsp;<span class="op" id="4031460">=</span>&nbsp;<span class="ident" id="4031462">data</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031468">if</span>&nbsp;<span class="ident" id="4031471">bytes</span><span class="op" id="4031476">.</span><span class="ident" id="4031477">HasPrefix</span><span class="op" id="4031486">(</span><span class="ident" id="4031487">data</span><span class="op" id="4031491">,</span>&nbsp;<span class="ident" id="4031493">pemStart</span><span class="op" id="4031501">[</span><span class="num" id="4031502">1</span><span class="op" id="4031503">:</span><span class="op" id="4031504">]</span><span class="op" id="4031505">)</span>&nbsp;<span class="op" id="4031507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031511">rest</span>&nbsp;<span class="op" id="4031516">=</span>&nbsp;<span class="ident" id="4031518">rest</span><span class="op" id="4031522">[</span><span class="builtinfunc" id="4031523">len</span><span class="op" id="4031526">(</span><span class="ident" id="4031527">pemStart</span><span class="op" id="4031535">)</span><span class="op" id="4031536">-</span><span class="num" id="4031537">1</span>&nbsp;<span class="op" id="4031539">:</span>&nbsp;<span class="builtinfunc" id="4031541">len</span><span class="op" id="4031544">(</span><span class="ident" id="4031545">data</span><span class="op" id="4031549">)</span><span class="op" id="4031550">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031553">}</span>&nbsp;<span class="keyword" id="4031555">else</span>&nbsp;<span class="keyword" id="4031560">if</span>&nbsp;<span class="ident" id="4031563">i</span>&nbsp;<span class="op" id="4031565">:=</span>&nbsp;<span class="ident" id="4031568">bytes</span><span class="op" id="4031573">.</span><span class="ident" id="4031574">Index</span><span class="op" id="4031579">(</span><span class="ident" id="4031580">data</span><span class="op" id="4031584">,</span>&nbsp;<span class="ident" id="4031586">pemStart</span><span class="op" id="4031594">)</span><span class="op" id="4031595">;</span>&nbsp;<span class="ident" id="4031597">i</span>&nbsp;<span class="op" id="4031599">&gt;=</span>&nbsp;<span class="num" id="4031602">0</span>&nbsp;<span class="op" id="4031604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031608">rest</span>&nbsp;<span class="op" id="4031613">=</span>&nbsp;<span class="ident" id="4031615">rest</span><span class="op" id="4031619">[</span><span class="ident" id="4031620">i</span><span class="op" id="4031621">+</span><span class="builtinfunc" id="4031622">len</span><span class="op" id="4031625">(</span><span class="ident" id="4031626">pemStart</span><span class="op" id="4031634">)</span>&nbsp;<span class="op" id="4031636">:</span>&nbsp;<span class="builtinfunc" id="4031638">len</span><span class="op" id="4031641">(</span><span class="ident" id="4031642">data</span><span class="op" id="4031646">)</span><span class="op" id="4031647">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031650">}</span>&nbsp;<span class="keyword" id="4031652">else</span>&nbsp;<span class="op" id="4031657">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031661">return</span>&nbsp;<span class="ident" id="4031668">nil</span><span class="op" id="4031671">,</span>&nbsp;<span class="ident" id="4031673">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031683">typeLine</span><span class="op" id="4031691">,</span>&nbsp;<span class="ident" id="4031693">rest</span>&nbsp;<span class="op" id="4031698">:=</span>&nbsp;<span class="ident" id="4031701">getLine</span><span class="op" id="4031708">(</span><span class="ident" id="4031709">rest</span><span class="op" id="4031713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031716">if</span>&nbsp;<span class="op" id="4031719">!</span><span class="ident" id="4031720">bytes</span><span class="op" id="4031725">.</span><span class="ident" id="4031726">HasSuffix</span><span class="op" id="4031735">(</span><span class="ident" id="4031736">typeLine</span><span class="op" id="4031744">,</span>&nbsp;<span class="ident" id="4031746">pemEndOfLine</span><span class="op" id="4031758">)</span>&nbsp;<span class="op" id="4031760">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031764">return</span>&nbsp;<span class="ident" id="4031771">decodeError</span><span class="op" id="4031782">(</span><span class="ident" id="4031783">data</span><span class="op" id="4031787">,</span>&nbsp;<span class="ident" id="4031789">rest</span><span class="op" id="4031793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031799">typeLine</span>&nbsp;<span class="op" id="4031808">=</span>&nbsp;<span class="ident" id="4031810">typeLine</span><span class="op" id="4031818">[</span><span class="num" id="4031819">0</span>&nbsp;<span class="op" id="4031821">:</span>&nbsp;<span class="builtinfunc" id="4031823">len</span><span class="op" id="4031826">(</span><span class="ident" id="4031827">typeLine</span><span class="op" id="4031835">)</span><span class="op" id="4031836">-</span><span class="builtinfunc" id="4031837">len</span><span class="op" id="4031840">(</span><span class="ident" id="4031841">pemEndOfLine</span><span class="op" id="4031853">)</span><span class="op" id="4031854">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031858">p</span>&nbsp;<span class="op" id="4031860">=</span>&nbsp;<span class="op" id="4031862">&amp;</span><span class="ident" id="4031863">Block</span><span class="op" id="4031868">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031872">Headers</span><span class="op" id="4031879">:</span>&nbsp;<span class="builtinfunc" id="4031881">make</span><span class="op" id="4031885">(</span><span class="keyword" id="4031886">map</span><span class="op" id="4031889">[</span><span class="builtintype" id="4031890">string</span><span class="op" id="4031896">]</span><span class="builtintype" id="4031897">string</span><span class="op" id="4031903">)</span><span class="op" id="4031904">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031908">Type</span><span class="op" id="4031912">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4031917">string</span><span class="op" id="4031923">(</span><span class="ident" id="4031924">typeLine</span><span class="op" id="4031932">)</span><span class="op" id="4031933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031940">for</span>&nbsp;<span class="op" id="4031944">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031948">//&nbsp;This&nbsp;loop&nbsp;terminates&nbsp;because&nbsp;getLine&#39;s&nbsp;second&nbsp;result&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032009">//&nbsp;always&nbsp;smaller&nbsp;than&nbsp;its&nbsp;argument.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032048">if</span>&nbsp;<span class="builtinfunc" id="4032051">len</span><span class="op" id="4032054">(</span><span class="ident" id="4032055">rest</span><span class="op" id="4032059">)</span>&nbsp;<span class="op" id="4032061">==</span>&nbsp;<span class="num" id="4032064">0</span>&nbsp;<span class="op" id="4032066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032071">return</span>&nbsp;<span class="ident" id="4032078">nil</span><span class="op" id="4032081">,</span>&nbsp;<span class="ident" id="4032083">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032090">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032094">line</span><span class="op" id="4032098">,</span>&nbsp;<span class="ident" id="4032100">next</span>&nbsp;<span class="op" id="4032105">:=</span>&nbsp;<span class="ident" id="4032108">getLine</span><span class="op" id="4032115">(</span><span class="ident" id="4032116">rest</span><span class="op" id="4032120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032125">i</span>&nbsp;<span class="op" id="4032127">:=</span>&nbsp;<span class="ident" id="4032130">bytes</span><span class="op" id="4032135">.</span><span class="ident" id="4032136">Index</span><span class="op" id="4032141">(</span><span class="ident" id="4032142">line</span><span class="op" id="4032146">,</span>&nbsp;<span class="op" id="4032148">[</span><span class="op" id="4032149">]</span><span class="builtintype" id="4032150">byte</span><span class="op" id="4032154">{</span><span class="string" id="4032155">&#39;:&#39;</span><span class="op" id="4032158">}</span><span class="op" id="4032159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032163">if</span>&nbsp;<span class="ident" id="4032166">i</span>&nbsp;<span class="op" id="4032168">==</span>&nbsp;<span class="op" id="4032171">-</span><span class="num" id="4032172">1</span>&nbsp;<span class="op" id="4032174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032179">break</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032192">//&nbsp;TODO(agl):&nbsp;need&nbsp;to&nbsp;cope&nbsp;with&nbsp;values&nbsp;that&nbsp;spread&nbsp;across&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032259">key</span><span class="op" id="4032262">,</span>&nbsp;<span class="ident" id="4032264">val</span>&nbsp;<span class="op" id="4032268">:=</span>&nbsp;<span class="ident" id="4032271">line</span><span class="op" id="4032275">[</span><span class="num" id="4032276">0</span><span class="op" id="4032277">:</span><span class="ident" id="4032278">i</span><span class="op" id="4032279">]</span><span class="op" id="4032280">,</span>&nbsp;<span class="ident" id="4032282">line</span><span class="op" id="4032286">[</span><span class="ident" id="4032287">i</span><span class="op" id="4032288">+</span><span class="num" id="4032289">1</span><span class="op" id="4032290">:</span><span class="op" id="4032291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032295">key</span>&nbsp;<span class="op" id="4032299">=</span>&nbsp;<span class="ident" id="4032301">bytes</span><span class="op" id="4032306">.</span><span class="ident" id="4032307">TrimSpace</span><span class="op" id="4032316">(</span><span class="ident" id="4032317">key</span><span class="op" id="4032320">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032324">val</span>&nbsp;<span class="op" id="4032328">=</span>&nbsp;<span class="ident" id="4032330">bytes</span><span class="op" id="4032335">.</span><span class="ident" id="4032336">TrimSpace</span><span class="op" id="4032345">(</span><span class="ident" id="4032346">val</span><span class="op" id="4032349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032353">p</span><span class="op" id="4032354">.</span><span class="ident" id="4032355">Headers</span><span class="op" id="4032362">[</span><span class="builtintype" id="4032363">string</span><span class="op" id="4032369">(</span><span class="ident" id="4032370">key</span><span class="op" id="4032373">)</span><span class="op" id="4032374">]</span>&nbsp;<span class="op" id="4032376">=</span>&nbsp;<span class="builtintype" id="4032378">string</span><span class="op" id="4032384">(</span><span class="ident" id="4032385">val</span><span class="op" id="4032388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032392">rest</span>&nbsp;<span class="op" id="4032397">=</span>&nbsp;<span class="ident" id="4032399">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032409">i</span>&nbsp;<span class="op" id="4032411">:=</span>&nbsp;<span class="ident" id="4032414">bytes</span><span class="op" id="4032419">.</span><span class="ident" id="4032420">Index</span><span class="op" id="4032425">(</span><span class="ident" id="4032426">rest</span><span class="op" id="4032430">,</span>&nbsp;<span class="ident" id="4032432">pemEnd</span><span class="op" id="4032438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032441">if</span>&nbsp;<span class="ident" id="4032444">i</span>&nbsp;<span class="op" id="4032446">&lt;</span>&nbsp;<span class="num" id="4032448">0</span>&nbsp;<span class="op" id="4032450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032454">return</span>&nbsp;<span class="ident" id="4032461">decodeError</span><span class="op" id="4032472">(</span><span class="ident" id="4032473">data</span><span class="op" id="4032477">,</span>&nbsp;<span class="ident" id="4032479">rest</span><span class="op" id="4032483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032489">base64Data</span>&nbsp;<span class="op" id="4032500">:=</span>&nbsp;<span class="ident" id="4032503">removeWhitespace</span><span class="op" id="4032519">(</span><span class="ident" id="4032520">rest</span><span class="op" id="4032524">[</span><span class="num" id="4032525">0</span><span class="op" id="4032526">:</span><span class="ident" id="4032527">i</span><span class="op" id="4032528">]</span><span class="op" id="4032529">)</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032533">p</span><span class="op" id="4032534">.</span><span class="ident" id="4032535">Bytes</span>&nbsp;<span class="op" id="4032541">=</span>&nbsp;<span class="builtinfunc" id="4032543">make</span><span class="op" id="4032547">(</span><span class="op" id="4032548">[</span><span class="op" id="4032549">]</span><span class="builtintype" id="4032550">byte</span><span class="op" id="4032554">,</span>&nbsp;<span class="ident" id="4032556">base64</span><span class="op" id="4032562">.</span><span class="ident" id="4032563">StdEncoding</span><span class="op" id="4032574">.</span><span class="ident" id="4032575">DecodedLen</span><span class="op" id="4032585">(</span><span class="builtinfunc" id="4032586">len</span><span class="op" id="4032589">(</span><span class="ident" id="4032590">base64Data</span><span class="op" id="4032600">)</span><span class="op" id="4032601">)</span><span class="op" id="4032602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032605">n</span><span class="op" id="4032606">,</span>&nbsp;<span class="ident" id="4032608">err</span>&nbsp;<span class="op" id="4032612">:=</span>&nbsp;<span class="ident" id="4032615">base64</span><span class="op" id="4032621">.</span><span class="ident" id="4032622">StdEncoding</span><span class="op" id="4032633">.</span><span class="ident" id="4032634">Decode</span><span class="op" id="4032640">(</span><span class="ident" id="4032641">p</span><span class="op" id="4032642">.</span><span class="ident" id="4032643">Bytes</span><span class="op" id="4032648">,</span>&nbsp;<span class="ident" id="4032650">base64Data</span><span class="op" id="4032660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032663">if</span>&nbsp;<span class="ident" id="4032666">err</span>&nbsp;<span class="op" id="4032670">!=</span>&nbsp;<span class="ident" id="4032673">nil</span>&nbsp;<span class="op" id="4032677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032681">return</span>&nbsp;<span class="ident" id="4032688">decodeError</span><span class="op" id="4032699">(</span><span class="ident" id="4032700">data</span><span class="op" id="4032704">,</span>&nbsp;<span class="ident" id="4032706">rest</span><span class="op" id="4032710">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032716">p</span><span class="op" id="4032717">.</span><span class="ident" id="4032718">Bytes</span>&nbsp;<span class="op" id="4032724">=</span>&nbsp;<span class="ident" id="4032726">p</span><span class="op" id="4032727">.</span><span class="ident" id="4032728">Bytes</span><span class="op" id="4032733">[</span><span class="num" id="4032734">0</span><span class="op" id="4032735">:</span><span class="ident" id="4032736">n</span><span class="op" id="4032737">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032741">_</span><span class="op" id="4032742">,</span>&nbsp;<span class="ident" id="4032744">rest</span>&nbsp;<span class="op" id="4032749">=</span>&nbsp;<span class="ident" id="4032751">getLine</span><span class="op" id="4032758">(</span><span class="ident" id="4032759">rest</span><span class="op" id="4032763">[</span><span class="ident" id="4032764">i</span><span class="op" id="4032765">+</span><span class="builtinfunc" id="4032766">len</span><span class="op" id="4032769">(</span><span class="ident" id="4032770">pemEnd</span><span class="op" id="4032776">)</span><span class="op" id="4032777">:</span><span class="op" id="4032778">]</span><span class="op" id="4032779">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032783">return</span><br>
<span class="lineno"></span><span class="op" id="4032790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4032793">func</span>&nbsp;<span class="ident" id="4032798">decodeError</span><span class="op" id="4032809">(</span><span class="ident" id="4032810">data</span><span class="op" id="4032814">,</span>&nbsp;<span class="ident" id="4032816">rest</span>&nbsp;<span class="op" id="4032821">[</span><span class="op" id="4032822">]</span><span class="builtintype" id="4032823">byte</span><span class="op" id="4032827">)</span>&nbsp;<span class="op" id="4032829">(</span><span class="op" id="4032830">*</span><span class="ident" id="4032831">Block</span><span class="op" id="4032836">,</span>&nbsp;<span class="op" id="4032838">[</span><span class="op" id="4032839">]</span><span class="builtintype" id="4032840">byte</span><span class="op" id="4032844">)</span>&nbsp;<span class="op" id="4032846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032849">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here&nbsp;then&nbsp;we&nbsp;have&nbsp;rejected&nbsp;a&nbsp;likely&nbsp;looking,&nbsp;but</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032912">//&nbsp;ultimately&nbsp;invalid&nbsp;PEM&nbsp;block.&nbsp;We&nbsp;need&nbsp;to&nbsp;start&nbsp;over&nbsp;from&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032979">//&nbsp;position.&nbsp;&nbsp;We&nbsp;have&nbsp;consumed&nbsp;the&nbsp;preamble&nbsp;line&nbsp;and&nbsp;will&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033052">//&nbsp;any&nbsp;lines&nbsp;which&nbsp;could&nbsp;be&nbsp;header&nbsp;lines.&nbsp;However,&nbsp;a&nbsp;valid&nbsp;preamble</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033121">//&nbsp;line&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;header&nbsp;line,&nbsp;therefore&nbsp;we&nbsp;cannot&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033192">//&nbsp;the&nbsp;preamble&nbsp;line&nbsp;for&nbsp;the&nbsp;any&nbsp;subsequent&nbsp;block.&nbsp;Thus,&nbsp;we&nbsp;will&nbsp;always</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033265">//&nbsp;find&nbsp;any&nbsp;valid&nbsp;block,&nbsp;no&nbsp;matter&nbsp;what&nbsp;bytes&nbsp;precede&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033324">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033328">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;input&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033361">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033365">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;MALFORMED&nbsp;BLOCK-----</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033404">//&nbsp;&nbsp;&nbsp;&nbsp;junk&nbsp;that&nbsp;may&nbsp;look&nbsp;like&nbsp;header&nbsp;lines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033448">//&nbsp;&nbsp;&nbsp;or&nbsp;data&nbsp;lines,&nbsp;but&nbsp;no&nbsp;END&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033485">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033489">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033525">//&nbsp;&nbsp;&nbsp;&nbsp;realdata</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033541">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033575">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033579">//&nbsp;we&#39;ve&nbsp;failed&nbsp;to&nbsp;parse&nbsp;using&nbsp;the&nbsp;first&nbsp;BEGIN&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033632">//&nbsp;and&nbsp;now&nbsp;will&nbsp;try&nbsp;again,&nbsp;using&nbsp;the&nbsp;second&nbsp;BEGIN&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033689">p</span><span class="op" id="4033690">,</span>&nbsp;<span class="ident" id="4033692">rest</span>&nbsp;<span class="op" id="4033697">:=</span>&nbsp;<span class="ident" id="4033700">Decode</span><span class="op" id="4033706">(</span><span class="ident" id="4033707">rest</span><span class="op" id="4033711">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033714">if</span>&nbsp;<span class="ident" id="4033717">p</span>&nbsp;<span class="op" id="4033719">==</span>&nbsp;<span class="ident" id="4033722">nil</span>&nbsp;<span class="op" id="4033726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033730">rest</span>&nbsp;<span class="op" id="4033735">=</span>&nbsp;<span class="ident" id="4033737">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4033743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033746">return</span>&nbsp;<span class="ident" id="4033753">p</span><span class="op" id="4033754">,</span>&nbsp;<span class="ident" id="4033756">rest</span><br>
<span class="lineno"></span><span class="op" id="4033761">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4033764">const</span>&nbsp;<span class="ident" id="4033770">pemLineLength</span>&nbsp;<span class="op" id="4033784">=</span>&nbsp;<span class="num" id="4033786">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4033790">type</span>&nbsp;<span class="ident" id="4033795">lineBreaker</span>&nbsp;<span class="keyword" id="4033807">struct</span>&nbsp;<span class="op" id="4033814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033817">line</span>&nbsp;<span class="op" id="4033822">[</span><span class="ident" id="4033823">pemLineLength</span><span class="op" id="4033836">]</span><span class="builtintype" id="4033837">byte</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033843">used</span>&nbsp;<span class="builtintype" id="4033848">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033853">out</span>&nbsp;&nbsp;<span class="ident" id="4033858">io</span><span class="op" id="4033860">.</span><span class="ident" id="4033861">Writer</span><br>
<span class="lineno"></span><span class="op" id="4033868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4033871">func</span>&nbsp;<span class="op" id="4033876">(</span><span class="ident" id="4033877">l</span>&nbsp;<span class="op" id="4033879">*</span><span class="ident" id="4033880">lineBreaker</span><span class="op" id="4033891">)</span>&nbsp;<span class="ident" id="4033893">Write</span><span class="op" id="4033898">(</span><span class="ident" id="4033899">b</span>&nbsp;<span class="op" id="4033901">[</span><span class="op" id="4033902">]</span><span class="builtintype" id="4033903">byte</span><span class="op" id="4033907">)</span>&nbsp;<span class="op" id="4033909">(</span><span class="ident" id="4033910">n</span>&nbsp;<span class="builtintype" id="4033912">int</span><span class="op" id="4033915">,</span>&nbsp;<span class="ident" id="4033917">err</span>&nbsp;<span class="builtintype" id="4033921">error</span><span class="op" id="4033926">)</span>&nbsp;<span class="op" id="4033928">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033931">if</span>&nbsp;<span class="ident" id="4033934">l</span><span class="op" id="4033935">.</span><span class="ident" id="4033936">used</span><span class="op" id="4033940">+</span><span class="builtinfunc" id="4033941">len</span><span class="op" id="4033944">(</span><span class="ident" id="4033945">b</span><span class="op" id="4033946">)</span>&nbsp;<span class="op" id="4033948">&lt;</span>&nbsp;<span class="ident" id="4033950">pemLineLength</span>&nbsp;<span class="op" id="4033964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4033968">copy</span><span class="op" id="4033972">(</span><span class="ident" id="4033973">l</span><span class="op" id="4033974">.</span><span class="ident" id="4033975">line</span><span class="op" id="4033979">[</span><span class="ident" id="4033980">l</span><span class="op" id="4033981">.</span><span class="ident" id="4033982">used</span><span class="op" id="4033986">:</span><span class="op" id="4033987">]</span><span class="op" id="4033988">,</span>&nbsp;<span class="ident" id="4033990">b</span><span class="op" id="4033991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033995">l</span><span class="op" id="4033996">.</span><span class="ident" id="4033997">used</span>&nbsp;<span class="op" id="4034002">+=</span>&nbsp;<span class="builtinfunc" id="4034005">len</span><span class="op" id="4034008">(</span><span class="ident" id="4034009">b</span><span class="op" id="4034010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034014">return</span>&nbsp;<span class="builtinfunc" id="4034021">len</span><span class="op" id="4034024">(</span><span class="ident" id="4034025">b</span><span class="op" id="4034026">)</span><span class="op" id="4034027">,</span>&nbsp;<span class="ident" id="4034029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034034">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034038">n</span><span class="op" id="4034039">,</span>&nbsp;<span class="ident" id="4034041">err</span>&nbsp;<span class="op" id="4034045">=</span>&nbsp;<span class="ident" id="4034047">l</span><span class="op" id="4034048">.</span><span class="ident" id="4034049">out</span><span class="op" id="4034052">.</span><span class="ident" id="4034053">Write</span><span class="op" id="4034058">(</span><span class="ident" id="4034059">l</span><span class="op" id="4034060">.</span><span class="ident" id="4034061">line</span><span class="op" id="4034065">[</span><span class="num" id="4034066">0</span><span class="op" id="4034067">:</span><span class="ident" id="4034068">l</span><span class="op" id="4034069">.</span><span class="ident" id="4034070">used</span><span class="op" id="4034074">]</span><span class="op" id="4034075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034078">if</span>&nbsp;<span class="ident" id="4034081">err</span>&nbsp;<span class="op" id="4034085">!=</span>&nbsp;<span class="ident" id="4034088">nil</span>&nbsp;<span class="op" id="4034092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034104">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034107">excess</span>&nbsp;<span class="op" id="4034114">:=</span>&nbsp;<span class="ident" id="4034117">pemLineLength</span>&nbsp;<span class="op" id="4034131">-</span>&nbsp;<span class="ident" id="4034133">l</span><span class="op" id="4034134">.</span><span class="ident" id="4034135">used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034141">l</span><span class="op" id="4034142">.</span><span class="ident" id="4034143">used</span>&nbsp;<span class="op" id="4034148">=</span>&nbsp;<span class="num" id="4034150">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034154">n</span><span class="op" id="4034155">,</span>&nbsp;<span class="ident" id="4034157">err</span>&nbsp;<span class="op" id="4034161">=</span>&nbsp;<span class="ident" id="4034163">l</span><span class="op" id="4034164">.</span><span class="ident" id="4034165">out</span><span class="op" id="4034168">.</span><span class="ident" id="4034169">Write</span><span class="op" id="4034174">(</span><span class="ident" id="4034175">b</span><span class="op" id="4034176">[</span><span class="num" id="4034177">0</span><span class="op" id="4034178">:</span><span class="ident" id="4034179">excess</span><span class="op" id="4034185">]</span><span class="op" id="4034186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034189">if</span>&nbsp;<span class="ident" id="4034192">err</span>&nbsp;<span class="op" id="4034196">!=</span>&nbsp;<span class="ident" id="4034199">nil</span>&nbsp;<span class="op" id="4034203">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034207">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034219">n</span><span class="op" id="4034220">,</span>&nbsp;<span class="ident" id="4034222">err</span>&nbsp;<span class="op" id="4034226">=</span>&nbsp;<span class="ident" id="4034228">l</span><span class="op" id="4034229">.</span><span class="ident" id="4034230">out</span><span class="op" id="4034233">.</span><span class="ident" id="4034234">Write</span><span class="op" id="4034239">(</span><span class="op" id="4034240">[</span><span class="op" id="4034241">]</span><span class="builtintype" id="4034242">byte</span><span class="op" id="4034246">{</span><span class="string" id="4034247">&#39;\n&#39;</span><span class="op" id="4034251">}</span><span class="op" id="4034252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034255">if</span>&nbsp;<span class="ident" id="4034258">err</span>&nbsp;<span class="op" id="4034262">!=</span>&nbsp;<span class="ident" id="4034265">nil</span>&nbsp;<span class="op" id="4034269">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034273">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034285">return</span>&nbsp;<span class="ident" id="4034292">l</span><span class="op" id="4034293">.</span><span class="ident" id="4034294">Write</span><span class="op" id="4034299">(</span><span class="ident" id="4034300">b</span><span class="op" id="4034301">[</span><span class="ident" id="4034302">excess</span><span class="op" id="4034308">:</span><span class="op" id="4034309">]</span><span class="op" id="4034310">)</span><br>
<span class="lineno"></span><span class="op" id="4034312">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4034315">func</span>&nbsp;<span class="op" id="4034320">(</span><span class="ident" id="4034321">l</span>&nbsp;<span class="op" id="4034323">*</span><span class="ident" id="4034324">lineBreaker</span><span class="op" id="4034335">)</span>&nbsp;<span class="ident" id="4034337">Close</span><span class="op" id="4034342">(</span><span class="op" id="4034343">)</span>&nbsp;<span class="op" id="4034345">(</span><span class="ident" id="4034346">err</span>&nbsp;<span class="builtintype" id="4034350">error</span><span class="op" id="4034355">)</span>&nbsp;<span class="op" id="4034357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034360">if</span>&nbsp;<span class="ident" id="4034363">l</span><span class="op" id="4034364">.</span><span class="ident" id="4034365">used</span>&nbsp;<span class="op" id="4034370">&gt;</span>&nbsp;<span class="num" id="4034372">0</span>&nbsp;<span class="op" id="4034374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034378">_</span><span class="op" id="4034379">,</span>&nbsp;<span class="ident" id="4034381">err</span>&nbsp;<span class="op" id="4034385">=</span>&nbsp;<span class="ident" id="4034387">l</span><span class="op" id="4034388">.</span><span class="ident" id="4034389">out</span><span class="op" id="4034392">.</span><span class="ident" id="4034393">Write</span><span class="op" id="4034398">(</span><span class="ident" id="4034399">l</span><span class="op" id="4034400">.</span><span class="ident" id="4034401">line</span><span class="op" id="4034405">[</span><span class="num" id="4034406">0</span><span class="op" id="4034407">:</span><span class="ident" id="4034408">l</span><span class="op" id="4034409">.</span><span class="ident" id="4034410">used</span><span class="op" id="4034414">]</span><span class="op" id="4034415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034419">if</span>&nbsp;<span class="ident" id="4034422">err</span>&nbsp;<span class="op" id="4034426">!=</span>&nbsp;<span class="ident" id="4034429">nil</span>&nbsp;<span class="op" id="4034433">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034438">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034451">_</span><span class="op" id="4034452">,</span>&nbsp;<span class="ident" id="4034454">err</span>&nbsp;<span class="op" id="4034458">=</span>&nbsp;<span class="ident" id="4034460">l</span><span class="op" id="4034461">.</span><span class="ident" id="4034462">out</span><span class="op" id="4034465">.</span><span class="ident" id="4034466">Write</span><span class="op" id="4034471">(</span><span class="op" id="4034472">[</span><span class="op" id="4034473">]</span><span class="builtintype" id="4034474">byte</span><span class="op" id="4034478">{</span><span class="string" id="4034479">&#39;\n&#39;</span><span class="op" id="4034483">}</span><span class="op" id="4034484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034491">return</span><br>
<span class="lineno"></span><span class="op" id="4034498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4034501">func</span>&nbsp;<span class="ident" id="4034506">writeHeader</span><span class="op" id="4034517">(</span><span class="ident" id="4034518">out</span>&nbsp;<span class="ident" id="4034522">io</span><span class="op" id="4034524">.</span><span class="ident" id="4034525">Writer</span><span class="op" id="4034531">,</span>&nbsp;<span class="ident" id="4034533">k</span><span class="op" id="4034534">,</span>&nbsp;<span class="ident" id="4034536">v</span>&nbsp;<span class="builtintype" id="4034538">string</span><span class="op" id="4034544">)</span>&nbsp;<span class="builtintype" id="4034546">error</span>&nbsp;<span class="op" id="4034552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034555">_</span><span class="op" id="4034556">,</span>&nbsp;<span class="ident" id="4034558">err</span>&nbsp;<span class="op" id="4034562">:=</span>&nbsp;<span class="ident" id="4034565">out</span><span class="op" id="4034568">.</span><span class="ident" id="4034569">Write</span><span class="op" id="4034574">(</span><span class="op" id="4034575">[</span><span class="op" id="4034576">]</span><span class="builtintype" id="4034577">byte</span><span class="op" id="4034581">(</span><span class="ident" id="4034582">k</span>&nbsp;<span class="op" id="4034584">+</span>&nbsp;<span class="string" id="4034586">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4034591">+</span>&nbsp;<span class="ident" id="4034593">v</span>&nbsp;<span class="op" id="4034595">+</span>&nbsp;<span class="string" id="4034597">&#34;\n&#34;</span><span class="op" id="4034601">)</span><span class="op" id="4034602">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034605">return</span>&nbsp;<span class="ident" id="4034612">err</span><br>
<span class="lineno"></span><span class="op" id="4034616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4034619">func</span>&nbsp;<span class="ident" id="4034624">Encode</span><span class="op" id="4034630">(</span><span class="ident" id="4034631">out</span>&nbsp;<span class="ident" id="4034635">io</span><span class="op" id="4034637">.</span><span class="ident" id="4034638">Writer</span><span class="op" id="4034644">,</span>&nbsp;<span class="ident" id="4034646">b</span>&nbsp;<span class="op" id="4034648">*</span><span class="ident" id="4034649">Block</span><span class="op" id="4034654">)</span>&nbsp;<span class="builtintype" id="4034656">error</span>&nbsp;<span class="op" id="4034662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034665">if</span>&nbsp;<span class="ident" id="4034668">_</span><span class="op" id="4034669">,</span>&nbsp;<span class="ident" id="4034671">err</span>&nbsp;<span class="op" id="4034675">:=</span>&nbsp;<span class="ident" id="4034678">out</span><span class="op" id="4034681">.</span><span class="ident" id="4034682">Write</span><span class="op" id="4034687">(</span><span class="ident" id="4034688">pemStart</span><span class="op" id="4034696">[</span><span class="num" id="4034697">1</span><span class="op" id="4034698">:</span><span class="op" id="4034699">]</span><span class="op" id="4034700">)</span><span class="op" id="4034701">;</span>&nbsp;<span class="ident" id="4034703">err</span>&nbsp;<span class="op" id="4034707">!=</span>&nbsp;<span class="ident" id="4034710">nil</span>&nbsp;<span class="op" id="4034714">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034718">return</span>&nbsp;<span class="ident" id="4034725">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034733">if</span>&nbsp;<span class="ident" id="4034736">_</span><span class="op" id="4034737">,</span>&nbsp;<span class="ident" id="4034739">err</span>&nbsp;<span class="op" id="4034743">:=</span>&nbsp;<span class="ident" id="4034746">out</span><span class="op" id="4034749">.</span><span class="ident" id="4034750">Write</span><span class="op" id="4034755">(</span><span class="op" id="4034756">[</span><span class="op" id="4034757">]</span><span class="builtintype" id="4034758">byte</span><span class="op" id="4034762">(</span><span class="ident" id="4034763">b</span><span class="op" id="4034764">.</span><span class="ident" id="4034765">Type</span>&nbsp;<span class="op" id="4034770">+</span>&nbsp;<span class="string" id="4034772">&#34;-----\n&#34;</span><span class="op" id="4034781">)</span><span class="op" id="4034782">)</span><span class="op" id="4034783">;</span>&nbsp;<span class="ident" id="4034785">err</span>&nbsp;<span class="op" id="4034789">!=</span>&nbsp;<span class="ident" id="4034792">nil</span>&nbsp;<span class="op" id="4034796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034800">return</span>&nbsp;<span class="ident" id="4034807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034812">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034816">if</span>&nbsp;<span class="builtinfunc" id="4034819">len</span><span class="op" id="4034822">(</span><span class="ident" id="4034823">b</span><span class="op" id="4034824">.</span><span class="ident" id="4034825">Headers</span><span class="op" id="4034832">)</span>&nbsp;<span class="op" id="4034834">&gt;</span>&nbsp;<span class="num" id="4034836">0</span>&nbsp;<span class="op" id="4034838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034842">const</span>&nbsp;<span class="ident" id="4034848">procType</span>&nbsp;<span class="op" id="4034857">=</span>&nbsp;<span class="string" id="4034859">&#34;Proc-Type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034873">h</span>&nbsp;<span class="op" id="4034875">:=</span>&nbsp;<span class="builtinfunc" id="4034878">make</span><span class="op" id="4034882">(</span><span class="op" id="4034883">[</span><span class="op" id="4034884">]</span><span class="builtintype" id="4034885">string</span><span class="op" id="4034891">,</span>&nbsp;<span class="num" id="4034893">0</span><span class="op" id="4034894">,</span>&nbsp;<span class="builtinfunc" id="4034896">len</span><span class="op" id="4034899">(</span><span class="ident" id="4034900">b</span><span class="op" id="4034901">.</span><span class="ident" id="4034902">Headers</span><span class="op" id="4034909">)</span><span class="op" id="4034910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034914">hasProcType</span>&nbsp;<span class="op" id="4034926">:=</span>&nbsp;<span class="builtintype" id="4034929">false</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034937">for</span>&nbsp;<span class="ident" id="4034941">k</span>&nbsp;<span class="op" id="4034943">:=</span>&nbsp;<span class="keyword" id="4034946">range</span>&nbsp;<span class="ident" id="4034952">b</span><span class="op" id="4034953">.</span><span class="ident" id="4034954">Headers</span>&nbsp;<span class="op" id="4034962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034967">if</span>&nbsp;<span class="ident" id="4034970">k</span>&nbsp;<span class="op" id="4034972">==</span>&nbsp;<span class="ident" id="4034975">procType</span>&nbsp;<span class="op" id="4034984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034990">hasProcType</span>&nbsp;<span class="op" id="4035002">=</span>&nbsp;<span class="builtintype" id="4035004">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035013">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035025">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035030">h</span>&nbsp;<span class="op" id="4035032">=</span>&nbsp;<span class="builtinfunc" id="4035034">append</span><span class="op" id="4035040">(</span><span class="ident" id="4035041">h</span><span class="op" id="4035042">,</span>&nbsp;<span class="ident" id="4035044">k</span><span class="op" id="4035045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4035053">//&nbsp;The&nbsp;Proc-Type&nbsp;header&nbsp;must&nbsp;be&nbsp;written&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4035102">//&nbsp;See&nbsp;RFC&nbsp;1421,&nbsp;section&nbsp;4.6.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035137">if</span>&nbsp;<span class="ident" id="4035140">hasProcType</span>&nbsp;<span class="op" id="4035152">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035157">if</span>&nbsp;<span class="ident" id="4035160">err</span>&nbsp;<span class="op" id="4035164">:=</span>&nbsp;<span class="ident" id="4035167">writeHeader</span><span class="op" id="4035178">(</span><span class="ident" id="4035179">out</span><span class="op" id="4035182">,</span>&nbsp;<span class="ident" id="4035184">procType</span><span class="op" id="4035192">,</span>&nbsp;<span class="ident" id="4035194">b</span><span class="op" id="4035195">.</span><span class="ident" id="4035196">Headers</span><span class="op" id="4035203">[</span><span class="ident" id="4035204">procType</span><span class="op" id="4035212">]</span><span class="op" id="4035213">)</span><span class="op" id="4035214">;</span>&nbsp;<span class="ident" id="4035216">err</span>&nbsp;<span class="op" id="4035220">!=</span>&nbsp;<span class="ident" id="4035223">nil</span>&nbsp;<span class="op" id="4035227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035233">return</span>&nbsp;<span class="ident" id="4035240">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4035255">//&nbsp;For&nbsp;consistency&nbsp;of&nbsp;output,&nbsp;write&nbsp;other&nbsp;headers&nbsp;sorted&nbsp;by&nbsp;key.</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035322">sort</span><span class="op" id="4035326">.</span><span class="ident" id="4035327">Strings</span><span class="op" id="4035334">(</span><span class="ident" id="4035335">h</span><span class="op" id="4035336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035340">for</span>&nbsp;<span class="ident" id="4035344">_</span><span class="op" id="4035345">,</span>&nbsp;<span class="ident" id="4035347">k</span>&nbsp;<span class="op" id="4035349">:=</span>&nbsp;<span class="keyword" id="4035352">range</span>&nbsp;<span class="ident" id="4035358">h</span>&nbsp;<span class="op" id="4035360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035365">if</span>&nbsp;<span class="ident" id="4035368">err</span>&nbsp;<span class="op" id="4035372">:=</span>&nbsp;<span class="ident" id="4035375">writeHeader</span><span class="op" id="4035386">(</span><span class="ident" id="4035387">out</span><span class="op" id="4035390">,</span>&nbsp;<span class="ident" id="4035392">k</span><span class="op" id="4035393">,</span>&nbsp;<span class="ident" id="4035395">b</span><span class="op" id="4035396">.</span><span class="ident" id="4035397">Headers</span><span class="op" id="4035404">[</span><span class="ident" id="4035405">k</span><span class="op" id="4035406">]</span><span class="op" id="4035407">)</span><span class="op" id="4035408">;</span>&nbsp;<span class="ident" id="4035410">err</span>&nbsp;<span class="op" id="4035414">!=</span>&nbsp;<span class="ident" id="4035417">nil</span>&nbsp;<span class="op" id="4035421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035427">return</span>&nbsp;<span class="ident" id="4035434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035441">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035449">if</span>&nbsp;<span class="ident" id="4035452">_</span><span class="op" id="4035453">,</span>&nbsp;<span class="ident" id="4035455">err</span>&nbsp;<span class="op" id="4035459">:=</span>&nbsp;<span class="ident" id="4035462">out</span><span class="op" id="4035465">.</span><span class="ident" id="4035466">Write</span><span class="op" id="4035471">(</span><span class="op" id="4035472">[</span><span class="op" id="4035473">]</span><span class="builtintype" id="4035474">byte</span><span class="op" id="4035478">{</span><span class="string" id="4035479">&#39;\n&#39;</span><span class="op" id="4035483">}</span><span class="op" id="4035484">)</span><span class="op" id="4035485">;</span>&nbsp;<span class="ident" id="4035487">err</span>&nbsp;<span class="op" id="4035491">!=</span>&nbsp;<span class="ident" id="4035494">nil</span>&nbsp;<span class="op" id="4035498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035503">return</span>&nbsp;<span class="ident" id="4035510">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035519">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035523">var</span>&nbsp;<span class="ident" id="4035527">breaker</span>&nbsp;<span class="ident" id="4035535">lineBreaker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035548">breaker</span><span class="op" id="4035555">.</span><span class="ident" id="4035556">out</span>&nbsp;<span class="op" id="4035560">=</span>&nbsp;<span class="ident" id="4035562">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035568">b64</span>&nbsp;<span class="op" id="4035572">:=</span>&nbsp;<span class="ident" id="4035575">base64</span><span class="op" id="4035581">.</span><span class="ident" id="4035582">NewEncoder</span><span class="op" id="4035592">(</span><span class="ident" id="4035593">base64</span><span class="op" id="4035599">.</span><span class="ident" id="4035600">StdEncoding</span><span class="op" id="4035611">,</span>&nbsp;<span class="op" id="4035613">&amp;</span><span class="ident" id="4035614">breaker</span><span class="op" id="4035621">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035624">if</span>&nbsp;<span class="ident" id="4035627">_</span><span class="op" id="4035628">,</span>&nbsp;<span class="ident" id="4035630">err</span>&nbsp;<span class="op" id="4035634">:=</span>&nbsp;<span class="ident" id="4035637">b64</span><span class="op" id="4035640">.</span><span class="ident" id="4035641">Write</span><span class="op" id="4035646">(</span><span class="ident" id="4035647">b</span><span class="op" id="4035648">.</span><span class="ident" id="4035649">Bytes</span><span class="op" id="4035654">)</span><span class="op" id="4035655">;</span>&nbsp;<span class="ident" id="4035657">err</span>&nbsp;<span class="op" id="4035661">!=</span>&nbsp;<span class="ident" id="4035664">nil</span>&nbsp;<span class="op" id="4035668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035672">return</span>&nbsp;<span class="ident" id="4035679">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035687">b64</span><span class="op" id="4035690">.</span><span class="ident" id="4035691">Close</span><span class="op" id="4035696">(</span><span class="op" id="4035697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035700">breaker</span><span class="op" id="4035707">.</span><span class="ident" id="4035708">Close</span><span class="op" id="4035713">(</span><span class="op" id="4035714">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035718">if</span>&nbsp;<span class="ident" id="4035721">_</span><span class="op" id="4035722">,</span>&nbsp;<span class="ident" id="4035724">err</span>&nbsp;<span class="op" id="4035728">:=</span>&nbsp;<span class="ident" id="4035731">out</span><span class="op" id="4035734">.</span><span class="ident" id="4035735">Write</span><span class="op" id="4035740">(</span><span class="ident" id="4035741">pemEnd</span><span class="op" id="4035747">[</span><span class="num" id="4035748">1</span><span class="op" id="4035749">:</span><span class="op" id="4035750">]</span><span class="op" id="4035751">)</span><span class="op" id="4035752">;</span>&nbsp;<span class="ident" id="4035754">err</span>&nbsp;<span class="op" id="4035758">!=</span>&nbsp;<span class="ident" id="4035761">nil</span>&nbsp;<span class="op" id="4035765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035769">return</span>&nbsp;<span class="ident" id="4035776">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035784">_</span><span class="op" id="4035785">,</span>&nbsp;<span class="ident" id="4035787">err</span>&nbsp;<span class="op" id="4035791">:=</span>&nbsp;<span class="ident" id="4035794">out</span><span class="op" id="4035797">.</span><span class="ident" id="4035798">Write</span><span class="op" id="4035803">(</span><span class="op" id="4035804">[</span><span class="op" id="4035805">]</span><span class="builtintype" id="4035806">byte</span><span class="op" id="4035810">(</span><span class="ident" id="4035811">b</span><span class="op" id="4035812">.</span><span class="ident" id="4035813">Type</span>&nbsp;<span class="op" id="4035818">+</span>&nbsp;<span class="string" id="4035820">&#34;-----\n&#34;</span><span class="op" id="4035829">)</span><span class="op" id="4035830">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035833">return</span>&nbsp;<span class="ident" id="4035840">err</span><br>
<span class="lineno"></span><span class="op" id="4035844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4035847">func</span>&nbsp;<span class="ident" id="4035852">EncodeToMemory</span><span class="op" id="4035866">(</span><span class="ident" id="4035867">b</span>&nbsp;<span class="op" id="4035869">*</span><span class="ident" id="4035870">Block</span><span class="op" id="4035875">)</span>&nbsp;<span class="op" id="4035877">[</span><span class="op" id="4035878">]</span><span class="builtintype" id="4035879">byte</span>&nbsp;<span class="op" id="4035884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035887">var</span>&nbsp;<span class="ident" id="4035891">buf</span>&nbsp;<span class="ident" id="4035895">bytes</span><span class="op" id="4035900">.</span><span class="ident" id="4035901">Buffer</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035909">Encode</span><span class="op" id="4035915">(</span><span class="op" id="4035916">&amp;</span><span class="ident" id="4035917">buf</span><span class="op" id="4035920">,</span>&nbsp;<span class="ident" id="4035922">b</span><span class="op" id="4035923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035926">return</span>&nbsp;<span class="ident" id="4035933">buf</span><span class="op" id="4035936">.</span><span class="ident" id="4035937">Bytes</span><span class="op" id="4035942">(</span><span class="op" id="4035943">)</span><br>
<span class="lineno"></span><span class="op" id="4035945">}</span>
</div>
</body>
</html>
