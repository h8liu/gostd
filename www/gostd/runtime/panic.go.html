<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1607473">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1607528">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1607582">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1607633">package</span>&nbsp;<span class="ident" id="1607641">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607650">import</span>&nbsp;<span class="string" id="1607657">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607667">var</span>&nbsp;<span class="ident" id="1607671">indexError</span>&nbsp;<span class="op" id="1607682">=</span>&nbsp;<span class="builtintype" id="1607684">error</span><span class="op" id="1607689">(</span><span class="ident" id="1607690">errorString</span><span class="op" id="1607701">(</span><span class="string" id="1607702">&#34;index&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1607722">)</span><span class="op" id="1607723">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1607726">func</span>&nbsp;<span class="ident" id="1607731">panicindex</span><span class="op" id="1607741">(</span><span class="op" id="1607742">)</span>&nbsp;<span class="op" id="1607744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1607747">panic</span><span class="op" id="1607752">(</span><span class="ident" id="1607753">indexError</span><span class="op" id="1607763">)</span><br>
<span class="lineno"></span><span class="op" id="1607765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1607768">var</span>&nbsp;<span class="ident" id="1607772">sliceError</span>&nbsp;<span class="op" id="1607783">=</span>&nbsp;<span class="builtintype" id="1607785">error</span><span class="op" id="1607790">(</span><span class="ident" id="1607791">errorString</span><span class="op" id="1607802">(</span><span class="string" id="1607803">&#34;slice&nbsp;bounds&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1607830">)</span><span class="op" id="1607831">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607834">func</span>&nbsp;<span class="ident" id="1607839">panicslice</span><span class="op" id="1607849">(</span><span class="op" id="1607850">)</span>&nbsp;<span class="op" id="1607852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1607855">panic</span><span class="op" id="1607860">(</span><span class="ident" id="1607861">sliceError</span><span class="op" id="1607871">)</span><br>
<span class="lineno"></span><span class="op" id="1607873">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1607876">var</span>&nbsp;<span class="ident" id="1607880">divideError</span>&nbsp;<span class="op" id="1607892">=</span>&nbsp;<span class="builtintype" id="1607894">error</span><span class="op" id="1607899">(</span><span class="ident" id="1607900">errorString</span><span class="op" id="1607911">(</span><span class="string" id="1607912">&#34;integer&nbsp;divide&nbsp;by&nbsp;zero&#34;</span><span class="op" id="1607936">)</span><span class="op" id="1607937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607940">func</span>&nbsp;<span class="ident" id="1607945">panicdivide</span><span class="op" id="1607956">(</span><span class="op" id="1607957">)</span>&nbsp;<span class="op" id="1607959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1607962">panic</span><span class="op" id="1607967">(</span><span class="ident" id="1607968">divideError</span><span class="op" id="1607979">)</span><br>
<span class="lineno">25</span><span class="op" id="1607981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607984">var</span>&nbsp;<span class="ident" id="1607988">overflowError</span>&nbsp;<span class="op" id="1608002">=</span>&nbsp;<span class="builtintype" id="1608004">error</span><span class="op" id="1608009">(</span><span class="ident" id="1608010">errorString</span><span class="op" id="1608021">(</span><span class="string" id="1608022">&#34;integer&nbsp;overflow&#34;</span><span class="op" id="1608040">)</span><span class="op" id="1608041">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608044">func</span>&nbsp;<span class="ident" id="1608049">panicoverflow</span><span class="op" id="1608062">(</span><span class="op" id="1608063">)</span>&nbsp;<span class="op" id="1608065">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1608068">panic</span><span class="op" id="1608073">(</span><span class="ident" id="1608074">overflowError</span><span class="op" id="1608087">)</span><br>
<span class="lineno"></span><span class="op" id="1608089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608092">var</span>&nbsp;<span class="ident" id="1608096">floatError</span>&nbsp;<span class="op" id="1608107">=</span>&nbsp;<span class="builtintype" id="1608109">error</span><span class="op" id="1608114">(</span><span class="ident" id="1608115">errorString</span><span class="op" id="1608126">(</span><span class="string" id="1608127">&#34;floating&nbsp;point&nbsp;error&#34;</span><span class="op" id="1608149">)</span><span class="op" id="1608150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1608153">func</span>&nbsp;<span class="ident" id="1608158">panicfloat</span><span class="op" id="1608168">(</span><span class="op" id="1608169">)</span>&nbsp;<span class="op" id="1608171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1608174">panic</span><span class="op" id="1608179">(</span><span class="ident" id="1608180">floatError</span><span class="op" id="1608190">)</span><br>
<span class="lineno"></span><span class="op" id="1608192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608195">var</span>&nbsp;<span class="ident" id="1608199">memoryError</span>&nbsp;<span class="op" id="1608211">=</span>&nbsp;<span class="builtintype" id="1608213">error</span><span class="op" id="1608218">(</span><span class="ident" id="1608219">errorString</span><span class="op" id="1608230">(</span><span class="string" id="1608231">&#34;invalid&nbsp;memory&nbsp;address&nbsp;or&nbsp;nil&nbsp;pointer&nbsp;dereference&#34;</span><span class="op" id="1608282">)</span><span class="op" id="1608283">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1608286">func</span>&nbsp;<span class="ident" id="1608291">panicmem</span><span class="op" id="1608299">(</span><span class="op" id="1608300">)</span>&nbsp;<span class="op" id="1608302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1608305">panic</span><span class="op" id="1608310">(</span><span class="ident" id="1608311">memoryError</span><span class="op" id="1608322">)</span><br>
<span class="lineno"></span><span class="op" id="1608324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1608327">func</span>&nbsp;<span class="ident" id="1608332">throwreturn</span><span class="op" id="1608343">(</span><span class="op" id="1608344">)</span>&nbsp;<span class="op" id="1608346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608349">gothrow</span><span class="op" id="1608356">(</span><span class="string" id="1608357">&#34;no&nbsp;return&nbsp;at&nbsp;end&nbsp;of&nbsp;a&nbsp;typed&nbsp;function&nbsp;-&nbsp;compiler&nbsp;is&nbsp;broken&#34;</span><span class="op" id="1608416">)</span><br>
<span class="lineno"></span><span class="op" id="1608418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608421">func</span>&nbsp;<span class="ident" id="1608426">throwinit</span><span class="op" id="1608435">(</span><span class="op" id="1608436">)</span>&nbsp;<span class="op" id="1608438">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608441">gothrow</span><span class="op" id="1608448">(</span><span class="string" id="1608449">&#34;recursive&nbsp;call&nbsp;during&nbsp;initialization&nbsp;-&nbsp;linker&nbsp;skew&#34;</span><span class="op" id="1608501">)</span><br>
<span class="lineno"></span><span class="op" id="1608503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1608506">//&nbsp;Create&nbsp;a&nbsp;new&nbsp;deferred&nbsp;function&nbsp;fn&nbsp;with&nbsp;siz&nbsp;bytes&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1608572">//&nbsp;The&nbsp;compiler&nbsp;turns&nbsp;a&nbsp;defer&nbsp;statement&nbsp;into&nbsp;a&nbsp;call&nbsp;to&nbsp;this.</span><br>
<span class="lineno">55</span><span class="comment" id="1608633">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1608646">func</span>&nbsp;<span class="ident" id="1608651">deferproc</span><span class="op" id="1608660">(</span><span class="ident" id="1608661">siz</span>&nbsp;<span class="builtintype" id="1608665">int32</span><span class="op" id="1608670">,</span>&nbsp;<span class="ident" id="1608672">fn</span>&nbsp;<span class="op" id="1608675">*</span><span class="ident" id="1608676">funcval</span><span class="op" id="1608683">)</span>&nbsp;<span class="op" id="1608685">{</span>&nbsp;<span class="comment" id="1608687">//&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;follow&nbsp;fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608717">//&nbsp;the&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;are&nbsp;in&nbsp;a&nbsp;perilous&nbsp;state.&nbsp;&nbsp;The&nbsp;stack&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608781">//&nbsp;for&nbsp;deferproc&nbsp;does&nbsp;not&nbsp;describe&nbsp;them.&nbsp;&nbsp;So&nbsp;we&nbsp;can&#39;t&nbsp;let&nbsp;garbage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608848">//&nbsp;collection&nbsp;or&nbsp;stack&nbsp;copying&nbsp;trigger&nbsp;until&nbsp;we&#39;ve&nbsp;copied&nbsp;them&nbsp;out</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608916">//&nbsp;to&nbsp;somewhere&nbsp;safe.&nbsp;&nbsp;deferproc_m&nbsp;does&nbsp;that.&nbsp;&nbsp;Until&nbsp;deferproc_m,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608983">//&nbsp;we&nbsp;can&nbsp;only&nbsp;call&nbsp;nosplit&nbsp;routines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609022">argp</span>&nbsp;<span class="op" id="1609027">:=</span>&nbsp;<span class="builtintype" id="1609030">uintptr</span><span class="op" id="1609037">(</span><span class="ident" id="1609038">unsafe</span><span class="op" id="1609044">.</span><span class="ident" id="1609045">Pointer</span><span class="op" id="1609052">(</span><span class="op" id="1609053">&amp;</span><span class="ident" id="1609054">fn</span><span class="op" id="1609056">)</span><span class="op" id="1609057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609060">argp</span>&nbsp;<span class="op" id="1609065">+=</span>&nbsp;<span class="ident" id="1609068">unsafe</span><span class="op" id="1609074">.</span><span class="ident" id="1609075">Sizeof</span><span class="op" id="1609081">(</span><span class="ident" id="1609082">fn</span><span class="op" id="1609084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609087">if</span>&nbsp;<span class="ident" id="1609090">GOARCH</span>&nbsp;<span class="op" id="1609097">==</span>&nbsp;<span class="string" id="1609100">&#34;arm&#34;</span>&nbsp;<span class="op" id="1609106">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609110">argp</span>&nbsp;<span class="op" id="1609115">+=</span>&nbsp;<span class="ident" id="1609118">ptrSize</span>&nbsp;<span class="comment" id="1609126">//&nbsp;skip&nbsp;caller&#39;s&nbsp;saved&nbsp;link&nbsp;register</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609167">mp</span>&nbsp;<span class="op" id="1609170">:=</span>&nbsp;<span class="ident" id="1609173">acquirem</span><span class="op" id="1609181">(</span><span class="op" id="1609182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609185">mp</span><span class="op" id="1609187">.</span><span class="ident" id="1609188">scalararg</span><span class="op" id="1609197">[</span><span class="num" id="1609198">0</span><span class="op" id="1609199">]</span>&nbsp;<span class="op" id="1609201">=</span>&nbsp;<span class="builtintype" id="1609203">uintptr</span><span class="op" id="1609210">(</span><span class="ident" id="1609211">siz</span><span class="op" id="1609214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609217">mp</span><span class="op" id="1609219">.</span><span class="ident" id="1609220">ptrarg</span><span class="op" id="1609226">[</span><span class="num" id="1609227">0</span><span class="op" id="1609228">]</span>&nbsp;<span class="op" id="1609230">=</span>&nbsp;<span class="ident" id="1609232">unsafe</span><span class="op" id="1609238">.</span><span class="ident" id="1609239">Pointer</span><span class="op" id="1609246">(</span><span class="ident" id="1609247">fn</span><span class="op" id="1609249">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609252">mp</span><span class="op" id="1609254">.</span><span class="ident" id="1609255">scalararg</span><span class="op" id="1609264">[</span><span class="num" id="1609265">1</span><span class="op" id="1609266">]</span>&nbsp;<span class="op" id="1609268">=</span>&nbsp;<span class="ident" id="1609270">argp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609276">mp</span><span class="op" id="1609278">.</span><span class="ident" id="1609279">scalararg</span><span class="op" id="1609288">[</span><span class="num" id="1609289">2</span><span class="op" id="1609290">]</span>&nbsp;<span class="op" id="1609292">=</span>&nbsp;<span class="ident" id="1609294">getcallerpc</span><span class="op" id="1609305">(</span><span class="ident" id="1609306">unsafe</span><span class="op" id="1609312">.</span><span class="ident" id="1609313">Pointer</span><span class="op" id="1609320">(</span><span class="op" id="1609321">&amp;</span><span class="ident" id="1609322">siz</span><span class="op" id="1609325">)</span><span class="op" id="1609326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609330">if</span>&nbsp;<span class="ident" id="1609333">mp</span><span class="op" id="1609335">.</span><span class="ident" id="1609336">curg</span>&nbsp;<span class="op" id="1609341">!=</span>&nbsp;<span class="ident" id="1609344">getg</span><span class="op" id="1609348">(</span><span class="op" id="1609349">)</span>&nbsp;<span class="op" id="1609351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609355">//&nbsp;go&nbsp;code&nbsp;on&nbsp;the&nbsp;m&nbsp;stack&nbsp;can&#39;t&nbsp;defer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609395">gothrow</span><span class="op" id="1609402">(</span><span class="string" id="1609403">&#34;defer&nbsp;on&nbsp;m&#34;</span><span class="op" id="1609415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609422">onM</span><span class="op" id="1609425">(</span><span class="ident" id="1609426">deferproc_m</span><span class="op" id="1609437">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609441">releasem</span><span class="op" id="1609449">(</span><span class="ident" id="1609450">mp</span><span class="op" id="1609452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609456">//&nbsp;deferproc&nbsp;returns&nbsp;0&nbsp;normally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609490">//&nbsp;a&nbsp;deferred&nbsp;func&nbsp;that&nbsp;stops&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609529">//&nbsp;makes&nbsp;the&nbsp;deferproc&nbsp;return&nbsp;1.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609563">//&nbsp;the&nbsp;code&nbsp;the&nbsp;compiler&nbsp;generates&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609606">//&nbsp;checks&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;jumps&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609651">//&nbsp;end&nbsp;of&nbsp;the&nbsp;function&nbsp;if&nbsp;deferproc&nbsp;returns&nbsp;!=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609702">return0</span><span class="op" id="1609709">(</span><span class="op" id="1609710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609713">//&nbsp;No&nbsp;code&nbsp;can&nbsp;go&nbsp;here&nbsp;-&nbsp;the&nbsp;C&nbsp;return&nbsp;register&nbsp;has</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609765">//&nbsp;been&nbsp;set&nbsp;and&nbsp;must&nbsp;not&nbsp;be&nbsp;clobbered.</span><br>
<span class="lineno"></span><span class="op" id="1609804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609807">//&nbsp;Small&nbsp;malloc&nbsp;size&nbsp;classes&nbsp;&gt;=&nbsp;16&nbsp;are&nbsp;the&nbsp;multiples&nbsp;of&nbsp;16:&nbsp;16,&nbsp;32,&nbsp;48,&nbsp;64,&nbsp;80,&nbsp;96,&nbsp;112,&nbsp;128,&nbsp;144,&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="1609910">//&nbsp;Each&nbsp;P&nbsp;holds&nbsp;a&nbsp;pool&nbsp;for&nbsp;defers&nbsp;with&nbsp;small&nbsp;arg&nbsp;sizes.</span><br>
<span class="lineno">95</span><span class="comment" id="1609966">//&nbsp;Assign&nbsp;defer&nbsp;allocations&nbsp;to&nbsp;pools&nbsp;by&nbsp;rounding&nbsp;to&nbsp;16,&nbsp;to&nbsp;match&nbsp;malloc&nbsp;size&nbsp;classes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1610053">const</span>&nbsp;<span class="op" id="1610059">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610062">deferHeaderSize</span>&nbsp;<span class="op" id="1610078">=</span>&nbsp;<span class="ident" id="1610080">unsafe</span><span class="op" id="1610086">.</span><span class="ident" id="1610087">Sizeof</span><span class="op" id="1610093">(</span><span class="ident" id="1610094">_defer</span><span class="op" id="1610100">{</span><span class="op" id="1610101">}</span><span class="op" id="1610102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610105">minDeferAlloc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1610121">=</span>&nbsp;<span class="op" id="1610123">(</span><span class="ident" id="1610124">deferHeaderSize</span>&nbsp;<span class="op" id="1610140">+</span>&nbsp;<span class="num" id="1610142">15</span><span class="op" id="1610144">)</span>&nbsp;<span class="op" id="1610146">&amp;^</span>&nbsp;<span class="num" id="1610149">15</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610153">minDeferArgs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610169">=</span>&nbsp;<span class="ident" id="1610171">minDeferAlloc</span>&nbsp;<span class="op" id="1610185">-</span>&nbsp;<span class="ident" id="1610187">deferHeaderSize</span><br>
<span class="lineno"></span><span class="op" id="1610203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610206">//&nbsp;defer&nbsp;size&nbsp;class&nbsp;for&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="comment" id="1610242">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1610255">func</span>&nbsp;<span class="ident" id="1610260">deferclass</span><span class="op" id="1610270">(</span><span class="ident" id="1610271">siz</span>&nbsp;<span class="builtintype" id="1610275">uintptr</span><span class="op" id="1610282">)</span>&nbsp;<span class="builtintype" id="1610284">uintptr</span>&nbsp;<span class="op" id="1610292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610295">if</span>&nbsp;<span class="ident" id="1610298">siz</span>&nbsp;<span class="op" id="1610302">&lt;=</span>&nbsp;<span class="ident" id="1610305">minDeferArgs</span>&nbsp;<span class="op" id="1610318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610322">return</span>&nbsp;<span class="num" id="1610329">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610335">return</span>&nbsp;<span class="op" id="1610342">(</span><span class="ident" id="1610343">siz</span>&nbsp;<span class="op" id="1610347">-</span>&nbsp;<span class="ident" id="1610349">minDeferArgs</span>&nbsp;<span class="op" id="1610362">+</span>&nbsp;<span class="num" id="1610364">15</span><span class="op" id="1610366">)</span>&nbsp;<span class="op" id="1610368">/</span>&nbsp;<span class="num" id="1610370">16</span><br>
<span class="lineno">110</span><span class="op" id="1610373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610376">//&nbsp;total&nbsp;size&nbsp;of&nbsp;memory&nbsp;block&nbsp;for&nbsp;defer&nbsp;with&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="keyword" id="1610433">func</span>&nbsp;<span class="ident" id="1610438">totaldefersize</span><span class="op" id="1610452">(</span><span class="ident" id="1610453">siz</span>&nbsp;<span class="builtintype" id="1610457">uintptr</span><span class="op" id="1610464">)</span>&nbsp;<span class="builtintype" id="1610466">uintptr</span>&nbsp;<span class="op" id="1610474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610477">if</span>&nbsp;<span class="ident" id="1610480">siz</span>&nbsp;<span class="op" id="1610484">&lt;=</span>&nbsp;<span class="ident" id="1610487">minDeferArgs</span>&nbsp;<span class="op" id="1610500">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610504">return</span>&nbsp;<span class="ident" id="1610511">minDeferAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610529">return</span>&nbsp;<span class="ident" id="1610536">deferHeaderSize</span>&nbsp;<span class="op" id="1610552">+</span>&nbsp;<span class="ident" id="1610554">siz</span><br>
<span class="lineno"></span><span class="op" id="1610558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1610561">//&nbsp;Ensure&nbsp;that&nbsp;defer&nbsp;arg&nbsp;sizes&nbsp;that&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;defer&nbsp;size&nbsp;class</span><br>
<span class="lineno"></span><span class="comment" id="1610630">//&nbsp;also&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;malloc&nbsp;size&nbsp;class.</span><br>
<span class="lineno"></span><span class="keyword" id="1610673">func</span>&nbsp;<span class="ident" id="1610678">testdefersizes</span><span class="op" id="1610692">(</span><span class="op" id="1610693">)</span>&nbsp;<span class="op" id="1610695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610698">var</span>&nbsp;<span class="ident" id="1610702">m</span>&nbsp;<span class="op" id="1610704">[</span><span class="builtinfunc" id="1610705">len</span><span class="op" id="1610708">(</span><span class="ident" id="1610709">p</span><span class="op" id="1610710">{</span><span class="op" id="1610711">}</span><span class="op" id="1610712">.</span><span class="ident" id="1610713">deferpool</span><span class="op" id="1610722">)</span><span class="op" id="1610723">]</span><span class="builtintype" id="1610724">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610732">for</span>&nbsp;<span class="ident" id="1610736">i</span>&nbsp;<span class="op" id="1610738">:=</span>&nbsp;<span class="keyword" id="1610741">range</span>&nbsp;<span class="ident" id="1610747">m</span>&nbsp;<span class="op" id="1610749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610753">m</span><span class="op" id="1610754">[</span><span class="ident" id="1610755">i</span><span class="op" id="1610756">]</span>&nbsp;<span class="op" id="1610758">=</span>&nbsp;<span class="op" id="1610760">-</span><span class="num" id="1610761">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610767">for</span>&nbsp;<span class="ident" id="1610771">i</span>&nbsp;<span class="op" id="1610773">:=</span>&nbsp;<span class="builtintype" id="1610776">uintptr</span><span class="op" id="1610783">(</span><span class="num" id="1610784">0</span><span class="op" id="1610785">)</span><span class="op" id="1610786">;</span>&nbsp;<span class="op" id="1610788">;</span>&nbsp;<span class="ident" id="1610790">i</span><span class="op" id="1610791">++</span>&nbsp;<span class="op" id="1610794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610798">defersc</span>&nbsp;<span class="op" id="1610806">:=</span>&nbsp;<span class="ident" id="1610809">deferclass</span><span class="op" id="1610819">(</span><span class="ident" id="1610820">i</span><span class="op" id="1610821">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610825">if</span>&nbsp;<span class="ident" id="1610828">defersc</span>&nbsp;<span class="op" id="1610836">&gt;=</span>&nbsp;<span class="builtintype" id="1610839">uintptr</span><span class="op" id="1610846">(</span><span class="builtinfunc" id="1610847">len</span><span class="op" id="1610850">(</span><span class="ident" id="1610851">m</span><span class="op" id="1610852">)</span><span class="op" id="1610853">)</span>&nbsp;<span class="op" id="1610855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610860">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610872">siz</span>&nbsp;<span class="op" id="1610876">:=</span>&nbsp;<span class="ident" id="1610879">goroundupsize</span><span class="op" id="1610892">(</span><span class="ident" id="1610893">totaldefersize</span><span class="op" id="1610907">(</span><span class="ident" id="1610908">i</span><span class="op" id="1610909">)</span><span class="op" id="1610910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610914">if</span>&nbsp;<span class="ident" id="1610917">m</span><span class="op" id="1610918">[</span><span class="ident" id="1610919">defersc</span><span class="op" id="1610926">]</span>&nbsp;<span class="op" id="1610928">&lt;</span>&nbsp;<span class="num" id="1610930">0</span>&nbsp;<span class="op" id="1610932">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610937">m</span><span class="op" id="1610938">[</span><span class="ident" id="1610939">defersc</span><span class="op" id="1610946">]</span>&nbsp;<span class="op" id="1610948">=</span>&nbsp;<span class="builtintype" id="1610950">int32</span><span class="op" id="1610955">(</span><span class="ident" id="1610956">siz</span><span class="op" id="1610959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610964">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610979">if</span>&nbsp;<span class="ident" id="1610982">m</span><span class="op" id="1610983">[</span><span class="ident" id="1610984">defersc</span><span class="op" id="1610991">]</span>&nbsp;<span class="op" id="1610993">!=</span>&nbsp;<span class="builtintype" id="1610996">int32</span><span class="op" id="1611001">(</span><span class="ident" id="1611002">siz</span><span class="op" id="1611005">)</span>&nbsp;<span class="op" id="1611007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1611012">print</span><span class="op" id="1611017">(</span><span class="string" id="1611018">&#34;bad&nbsp;defer&nbsp;size&nbsp;class:&nbsp;i=&#34;</span><span class="op" id="1611044">,</span>&nbsp;<span class="ident" id="1611046">i</span><span class="op" id="1611047">,</span>&nbsp;<span class="string" id="1611049">&#34;&nbsp;siz=&#34;</span><span class="op" id="1611056">,</span>&nbsp;<span class="ident" id="1611058">siz</span><span class="op" id="1611061">,</span>&nbsp;<span class="string" id="1611063">&#34;&nbsp;defersc=&#34;</span><span class="op" id="1611074">,</span>&nbsp;<span class="ident" id="1611076">defersc</span><span class="op" id="1611083">,</span>&nbsp;<span class="string" id="1611085">&#34;\n&#34;</span><span class="op" id="1611089">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611094">gothrow</span><span class="op" id="1611101">(</span><span class="string" id="1611102">&#34;bad&nbsp;defer&nbsp;size&nbsp;class&#34;</span><span class="op" id="1611124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611131">}</span><br>
<span class="lineno"></span><span class="op" id="1611133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1611136">//&nbsp;The&nbsp;arguments&nbsp;associated&nbsp;with&nbsp;a&nbsp;deferred&nbsp;call&nbsp;are&nbsp;stored</span><br>
<span class="lineno"></span><span class="comment" id="1611196">//&nbsp;immediately&nbsp;after&nbsp;the&nbsp;_defer&nbsp;header&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1611246">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1611259">func</span>&nbsp;<span class="ident" id="1611264">deferArgs</span><span class="op" id="1611273">(</span><span class="ident" id="1611274">d</span>&nbsp;<span class="op" id="1611276">*</span><span class="ident" id="1611277">_defer</span><span class="op" id="1611283">)</span>&nbsp;<span class="ident" id="1611285">unsafe</span><span class="op" id="1611291">.</span><span class="ident" id="1611292">Pointer</span>&nbsp;<span class="op" id="1611300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611303">return</span>&nbsp;<span class="ident" id="1611310">add</span><span class="op" id="1611313">(</span><span class="ident" id="1611314">unsafe</span><span class="op" id="1611320">.</span><span class="ident" id="1611321">Pointer</span><span class="op" id="1611328">(</span><span class="ident" id="1611329">d</span><span class="op" id="1611330">)</span><span class="op" id="1611331">,</span>&nbsp;<span class="ident" id="1611333">unsafe</span><span class="op" id="1611339">.</span><span class="ident" id="1611340">Sizeof</span><span class="op" id="1611346">(</span><span class="op" id="1611347">*</span><span class="ident" id="1611348">d</span><span class="op" id="1611349">)</span><span class="op" id="1611350">)</span><br>
<span class="lineno">150</span><span class="op" id="1611352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611355">var</span>&nbsp;<span class="ident" id="1611359">deferType</span>&nbsp;<span class="op" id="1611369">*</span><span class="ident" id="1611370">_type</span>&nbsp;<span class="comment" id="1611376">//&nbsp;type&nbsp;of&nbsp;_defer&nbsp;struct</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611402">func</span>&nbsp;<span class="ident" id="1611407">init</span><span class="op" id="1611411">(</span><span class="op" id="1611412">)</span>&nbsp;<span class="op" id="1611414">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611417">var</span>&nbsp;<span class="ident" id="1611421">x</span>&nbsp;<span class="keyword" id="1611423">interface</span><span class="op" id="1611432">{</span><span class="op" id="1611433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611436">x</span>&nbsp;<span class="op" id="1611438">=</span>&nbsp;<span class="op" id="1611440">(</span><span class="op" id="1611441">*</span><span class="ident" id="1611442">_defer</span><span class="op" id="1611448">)</span><span class="op" id="1611449">(</span><span class="ident" id="1611450">nil</span><span class="op" id="1611453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611456">deferType</span>&nbsp;<span class="op" id="1611466">=</span>&nbsp;<span class="op" id="1611468">(</span><span class="op" id="1611469">*</span><span class="op" id="1611470">(</span><span class="op" id="1611471">*</span><span class="op" id="1611472">*</span><span class="ident" id="1611473">ptrtype</span><span class="op" id="1611480">)</span><span class="op" id="1611481">(</span><span class="ident" id="1611482">unsafe</span><span class="op" id="1611488">.</span><span class="ident" id="1611489">Pointer</span><span class="op" id="1611496">(</span><span class="op" id="1611497">&amp;</span><span class="ident" id="1611498">x</span><span class="op" id="1611499">)</span><span class="op" id="1611500">)</span><span class="op" id="1611501">)</span><span class="op" id="1611502">.</span><span class="ident" id="1611503">elem</span><br>
<span class="lineno"></span><span class="op" id="1611508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="1611511">//&nbsp;Allocate&nbsp;a&nbsp;Defer,&nbsp;usually&nbsp;using&nbsp;per-P&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="1611558">//&nbsp;Each&nbsp;defer&nbsp;must&nbsp;be&nbsp;released&nbsp;with&nbsp;freedefer.</span><br>
<span class="lineno"></span><span class="comment" id="1611605">//&nbsp;Note:&nbsp;runs&nbsp;on&nbsp;M&nbsp;stack</span><br>
<span class="lineno"></span><span class="keyword" id="1611630">func</span>&nbsp;<span class="ident" id="1611635">newdefer</span><span class="op" id="1611643">(</span><span class="ident" id="1611644">siz</span>&nbsp;<span class="builtintype" id="1611648">int32</span><span class="op" id="1611653">)</span>&nbsp;<span class="op" id="1611655">*</span><span class="ident" id="1611656">_defer</span>&nbsp;<span class="op" id="1611663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611666">var</span>&nbsp;<span class="ident" id="1611670">d</span>&nbsp;<span class="op" id="1611672">*</span><span class="ident" id="1611673">_defer</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611681">sc</span>&nbsp;<span class="op" id="1611684">:=</span>&nbsp;<span class="ident" id="1611687">deferclass</span><span class="op" id="1611697">(</span><span class="builtintype" id="1611698">uintptr</span><span class="op" id="1611705">(</span><span class="ident" id="1611706">siz</span><span class="op" id="1611709">)</span><span class="op" id="1611710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611713">mp</span>&nbsp;<span class="op" id="1611716">:=</span>&nbsp;<span class="ident" id="1611719">acquirem</span><span class="op" id="1611727">(</span><span class="op" id="1611728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611731">if</span>&nbsp;<span class="ident" id="1611734">sc</span>&nbsp;<span class="op" id="1611737">&lt;</span>&nbsp;<span class="builtintype" id="1611739">uintptr</span><span class="op" id="1611746">(</span><span class="builtinfunc" id="1611747">len</span><span class="op" id="1611750">(</span><span class="ident" id="1611751">p</span><span class="op" id="1611752">{</span><span class="op" id="1611753">}</span><span class="op" id="1611754">.</span><span class="ident" id="1611755">deferpool</span><span class="op" id="1611764">)</span><span class="op" id="1611765">)</span>&nbsp;<span class="op" id="1611767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611771">pp</span>&nbsp;<span class="op" id="1611774">:=</span>&nbsp;<span class="ident" id="1611777">mp</span><span class="op" id="1611779">.</span><span class="ident" id="1611780">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611784">d</span>&nbsp;<span class="op" id="1611786">=</span>&nbsp;<span class="ident" id="1611788">pp</span><span class="op" id="1611790">.</span><span class="ident" id="1611791">deferpool</span><span class="op" id="1611800">[</span><span class="ident" id="1611801">sc</span><span class="op" id="1611803">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611807">if</span>&nbsp;<span class="ident" id="1611810">d</span>&nbsp;<span class="op" id="1611812">!=</span>&nbsp;<span class="ident" id="1611815">nil</span>&nbsp;<span class="op" id="1611819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611824">pp</span><span class="op" id="1611826">.</span><span class="ident" id="1611827">deferpool</span><span class="op" id="1611836">[</span><span class="ident" id="1611837">sc</span><span class="op" id="1611839">]</span>&nbsp;<span class="op" id="1611841">=</span>&nbsp;<span class="ident" id="1611843">d</span><span class="op" id="1611844">.</span><span class="ident" id="1611845">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611858">if</span>&nbsp;<span class="ident" id="1611861">d</span>&nbsp;<span class="op" id="1611863">==</span>&nbsp;<span class="ident" id="1611866">nil</span>&nbsp;<span class="op" id="1611870">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611874">//&nbsp;Allocate&nbsp;new&nbsp;defer+args.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611904">total</span>&nbsp;<span class="op" id="1611910">:=</span>&nbsp;<span class="ident" id="1611913">goroundupsize</span><span class="op" id="1611926">(</span><span class="ident" id="1611927">totaldefersize</span><span class="op" id="1611941">(</span><span class="builtintype" id="1611942">uintptr</span><span class="op" id="1611949">(</span><span class="ident" id="1611950">siz</span><span class="op" id="1611953">)</span><span class="op" id="1611954">)</span><span class="op" id="1611955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611959">d</span>&nbsp;<span class="op" id="1611961">=</span>&nbsp;<span class="op" id="1611963">(</span><span class="op" id="1611964">*</span><span class="ident" id="1611965">_defer</span><span class="op" id="1611971">)</span><span class="op" id="1611972">(</span><span class="ident" id="1611973">mallocgc</span><span class="op" id="1611981">(</span><span class="ident" id="1611982">total</span><span class="op" id="1611987">,</span>&nbsp;<span class="ident" id="1611989">deferType</span><span class="op" id="1611998">,</span>&nbsp;<span class="num" id="1612000">0</span><span class="op" id="1612001">)</span><span class="op" id="1612002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612008">d</span><span class="op" id="1612009">.</span><span class="ident" id="1612010">siz</span>&nbsp;<span class="op" id="1612014">=</span>&nbsp;<span class="ident" id="1612016">siz</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612021">gp</span>&nbsp;<span class="op" id="1612024">:=</span>&nbsp;<span class="ident" id="1612027">mp</span><span class="op" id="1612029">.</span><span class="ident" id="1612030">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612036">d</span><span class="op" id="1612037">.</span><span class="ident" id="1612038">link</span>&nbsp;<span class="op" id="1612043">=</span>&nbsp;<span class="ident" id="1612045">gp</span><span class="op" id="1612047">.</span><span class="ident" id="1612048">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612056">gp</span><span class="op" id="1612058">.</span><span class="ident" id="1612059">_defer</span>&nbsp;<span class="op" id="1612066">=</span>&nbsp;<span class="ident" id="1612068">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612071">releasem</span><span class="op" id="1612079">(</span><span class="ident" id="1612080">mp</span><span class="op" id="1612082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612085">return</span>&nbsp;<span class="ident" id="1612092">d</span><br>
<span class="lineno">185</span><span class="op" id="1612094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612097">//&nbsp;Free&nbsp;the&nbsp;given&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1612122">//&nbsp;The&nbsp;defer&nbsp;cannot&nbsp;be&nbsp;used&nbsp;after&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="1612167">//go:nosplit</span><br>
<span class="lineno">190</span><span class="keyword" id="1612180">func</span>&nbsp;<span class="ident" id="1612185">freedefer</span><span class="op" id="1612194">(</span><span class="ident" id="1612195">d</span>&nbsp;<span class="op" id="1612197">*</span><span class="ident" id="1612198">_defer</span><span class="op" id="1612204">)</span>&nbsp;<span class="op" id="1612206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612209">if</span>&nbsp;<span class="ident" id="1612212">d</span><span class="op" id="1612213">.</span><span class="ident" id="1612214">_panic</span>&nbsp;<span class="op" id="1612221">!=</span>&nbsp;<span class="ident" id="1612224">nil</span>&nbsp;<span class="op" id="1612228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612232">freedeferpanic</span><span class="op" id="1612246">(</span><span class="op" id="1612247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612253">if</span>&nbsp;<span class="ident" id="1612256">d</span><span class="op" id="1612257">.</span><span class="ident" id="1612258">fn</span>&nbsp;<span class="op" id="1612261">!=</span>&nbsp;<span class="ident" id="1612264">nil</span>&nbsp;<span class="op" id="1612268">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612272">freedeferfn</span><span class="op" id="1612283">(</span><span class="op" id="1612284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612290">sc</span>&nbsp;<span class="op" id="1612293">:=</span>&nbsp;<span class="ident" id="1612296">deferclass</span><span class="op" id="1612306">(</span><span class="builtintype" id="1612307">uintptr</span><span class="op" id="1612314">(</span><span class="ident" id="1612315">d</span><span class="op" id="1612316">.</span><span class="ident" id="1612317">siz</span><span class="op" id="1612320">)</span><span class="op" id="1612321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612324">if</span>&nbsp;<span class="ident" id="1612327">sc</span>&nbsp;<span class="op" id="1612330">&lt;</span>&nbsp;<span class="builtintype" id="1612332">uintptr</span><span class="op" id="1612339">(</span><span class="builtinfunc" id="1612340">len</span><span class="op" id="1612343">(</span><span class="ident" id="1612344">p</span><span class="op" id="1612345">{</span><span class="op" id="1612346">}</span><span class="op" id="1612347">.</span><span class="ident" id="1612348">deferpool</span><span class="op" id="1612357">)</span><span class="op" id="1612358">)</span>&nbsp;<span class="op" id="1612360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612364">mp</span>&nbsp;<span class="op" id="1612367">:=</span>&nbsp;<span class="ident" id="1612370">acquirem</span><span class="op" id="1612378">(</span><span class="op" id="1612379">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612383">pp</span>&nbsp;<span class="op" id="1612386">:=</span>&nbsp;<span class="ident" id="1612389">mp</span><span class="op" id="1612391">.</span><span class="ident" id="1612392">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612396">*</span><span class="ident" id="1612397">d</span>&nbsp;<span class="op" id="1612399">=</span>&nbsp;<span class="ident" id="1612401">_defer</span><span class="op" id="1612407">{</span><span class="op" id="1612408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612412">d</span><span class="op" id="1612413">.</span><span class="ident" id="1612414">link</span>&nbsp;<span class="op" id="1612419">=</span>&nbsp;<span class="ident" id="1612421">pp</span><span class="op" id="1612423">.</span><span class="ident" id="1612424">deferpool</span><span class="op" id="1612433">[</span><span class="ident" id="1612434">sc</span><span class="op" id="1612436">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612440">pp</span><span class="op" id="1612442">.</span><span class="ident" id="1612443">deferpool</span><span class="op" id="1612452">[</span><span class="ident" id="1612453">sc</span><span class="op" id="1612455">]</span>&nbsp;<span class="op" id="1612457">=</span>&nbsp;<span class="ident" id="1612459">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612463">releasem</span><span class="op" id="1612471">(</span><span class="ident" id="1612472">mp</span><span class="op" id="1612474">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612477">}</span><br>
<span class="lineno"></span><span class="op" id="1612479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612482">//&nbsp;Separate&nbsp;function&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1612531">//&nbsp;Windows&nbsp;otherwise&nbsp;runs&nbsp;out&nbsp;of&nbsp;stack&nbsp;space.</span><br>
<span class="lineno">210</span><span class="keyword" id="1612577">func</span>&nbsp;<span class="ident" id="1612582">freedeferpanic</span><span class="op" id="1612596">(</span><span class="op" id="1612597">)</span>&nbsp;<span class="op" id="1612599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612602">//&nbsp;_panic&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612659">gothrow</span><span class="op" id="1612666">(</span><span class="string" id="1612667">&#34;freedefer&nbsp;with&nbsp;d._panic&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1612699">)</span><br>
<span class="lineno"></span><span class="op" id="1612701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1612704">func</span>&nbsp;<span class="ident" id="1612709">freedeferfn</span><span class="op" id="1612720">(</span><span class="op" id="1612721">)</span>&nbsp;<span class="op" id="1612723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612726">//&nbsp;fn&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612779">gothrow</span><span class="op" id="1612786">(</span><span class="string" id="1612787">&#34;freedefer&nbsp;with&nbsp;d.fn&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1612815">)</span><br>
<span class="lineno"></span><span class="op" id="1612817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1612820">//&nbsp;Run&nbsp;a&nbsp;deferred&nbsp;function&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1612864">//&nbsp;The&nbsp;compiler&nbsp;inserts&nbsp;a&nbsp;call&nbsp;to&nbsp;this&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1612921">//&nbsp;function&nbsp;which&nbsp;calls&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1612952">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred&nbsp;function,&nbsp;this&nbsp;will&nbsp;call&nbsp;runtime·jmpdefer,</span><br>
<span class="lineno"></span><span class="comment" id="1613022">//&nbsp;which&nbsp;will&nbsp;jump&nbsp;to&nbsp;the&nbsp;deferred&nbsp;function&nbsp;such&nbsp;that&nbsp;it&nbsp;appears</span><br>
<span class="lineno">225</span><span class="comment" id="1613087">//&nbsp;to&nbsp;have&nbsp;been&nbsp;called&nbsp;by&nbsp;the&nbsp;caller&nbsp;of&nbsp;deferreturn&nbsp;at&nbsp;the&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1613152">//&nbsp;just&nbsp;before&nbsp;deferreturn&nbsp;was&nbsp;called.&nbsp;&nbsp;The&nbsp;effect&nbsp;is&nbsp;that&nbsp;deferreturn</span><br>
<span class="lineno"></span><span class="comment" id="1613223">//&nbsp;is&nbsp;called&nbsp;again&nbsp;and&nbsp;again&nbsp;until&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;deferred&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="1613296">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;we&nbsp;reuse&nbsp;the&nbsp;caller&#39;s&nbsp;frame&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1613361">//&nbsp;call&nbsp;the&nbsp;deferred&nbsp;function.</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="1613393">//&nbsp;The&nbsp;single&nbsp;argument&nbsp;isn&#39;t&nbsp;actually&nbsp;used&nbsp;-&nbsp;it&nbsp;just&nbsp;has&nbsp;its&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1613462">//&nbsp;taken&nbsp;so&nbsp;it&nbsp;can&nbsp;be&nbsp;matched&nbsp;against&nbsp;pending&nbsp;defers.</span><br>
<span class="lineno"></span><span class="comment" id="1613516">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1613529">func</span>&nbsp;<span class="ident" id="1613534">deferreturn</span><span class="op" id="1613545">(</span><span class="ident" id="1613546">arg0</span>&nbsp;<span class="builtintype" id="1613551">uintptr</span><span class="op" id="1613558">)</span>&nbsp;<span class="op" id="1613560">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613563">gp</span>&nbsp;<span class="op" id="1613566">:=</span>&nbsp;<span class="ident" id="1613569">getg</span><span class="op" id="1613573">(</span><span class="op" id="1613574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613577">d</span>&nbsp;<span class="op" id="1613579">:=</span>&nbsp;<span class="ident" id="1613582">gp</span><span class="op" id="1613584">.</span><span class="ident" id="1613585">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613593">if</span>&nbsp;<span class="ident" id="1613596">d</span>&nbsp;<span class="op" id="1613598">==</span>&nbsp;<span class="ident" id="1613601">nil</span>&nbsp;<span class="op" id="1613605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613609">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613617">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613620">argp</span>&nbsp;<span class="op" id="1613625">:=</span>&nbsp;<span class="builtintype" id="1613628">uintptr</span><span class="op" id="1613635">(</span><span class="ident" id="1613636">unsafe</span><span class="op" id="1613642">.</span><span class="ident" id="1613643">Pointer</span><span class="op" id="1613650">(</span><span class="op" id="1613651">&amp;</span><span class="ident" id="1613652">arg0</span><span class="op" id="1613656">)</span><span class="op" id="1613657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613660">if</span>&nbsp;<span class="ident" id="1613663">d</span><span class="op" id="1613664">.</span><span class="ident" id="1613665">argp</span>&nbsp;<span class="op" id="1613670">!=</span>&nbsp;<span class="ident" id="1613673">argp</span>&nbsp;<span class="op" id="1613678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613682">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613694">//&nbsp;Moving&nbsp;arguments&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613723">//&nbsp;Do&nbsp;not&nbsp;allow&nbsp;preemption&nbsp;here,&nbsp;because&nbsp;the&nbsp;garbage&nbsp;collector</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613787">//&nbsp;won&#39;t&nbsp;know&nbsp;the&nbsp;form&nbsp;of&nbsp;the&nbsp;arguments&nbsp;until&nbsp;the&nbsp;jmpdefer&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613851">//&nbsp;flip&nbsp;the&nbsp;PC&nbsp;over&nbsp;to&nbsp;fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613879">mp</span>&nbsp;<span class="op" id="1613882">:=</span>&nbsp;<span class="ident" id="1613885">acquirem</span><span class="op" id="1613893">(</span><span class="op" id="1613894">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613897">memmove</span><span class="op" id="1613904">(</span><span class="ident" id="1613905">unsafe</span><span class="op" id="1613911">.</span><span class="ident" id="1613912">Pointer</span><span class="op" id="1613919">(</span><span class="ident" id="1613920">argp</span><span class="op" id="1613924">)</span><span class="op" id="1613925">,</span>&nbsp;<span class="ident" id="1613927">deferArgs</span><span class="op" id="1613936">(</span><span class="ident" id="1613937">d</span><span class="op" id="1613938">)</span><span class="op" id="1613939">,</span>&nbsp;<span class="builtintype" id="1613941">uintptr</span><span class="op" id="1613948">(</span><span class="ident" id="1613949">d</span><span class="op" id="1613950">.</span><span class="ident" id="1613951">siz</span><span class="op" id="1613954">)</span><span class="op" id="1613955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613958">fn</span>&nbsp;<span class="op" id="1613961">:=</span>&nbsp;<span class="ident" id="1613964">d</span><span class="op" id="1613965">.</span><span class="ident" id="1613966">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613970">d</span><span class="op" id="1613971">.</span><span class="ident" id="1613972">fn</span>&nbsp;<span class="op" id="1613975">=</span>&nbsp;<span class="ident" id="1613977">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613982">gp</span><span class="op" id="1613984">.</span><span class="ident" id="1613985">_defer</span>&nbsp;<span class="op" id="1613992">=</span>&nbsp;<span class="ident" id="1613994">d</span><span class="op" id="1613995">.</span><span class="ident" id="1613996">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614002">freedefer</span><span class="op" id="1614011">(</span><span class="ident" id="1614012">d</span><span class="op" id="1614013">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614016">releasem</span><span class="op" id="1614024">(</span><span class="ident" id="1614025">mp</span><span class="op" id="1614027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614030">jmpdefer</span><span class="op" id="1614038">(</span><span class="ident" id="1614039">fn</span><span class="op" id="1614041">,</span>&nbsp;<span class="ident" id="1614043">argp</span><span class="op" id="1614047">)</span><br>
<span class="lineno"></span><span class="op" id="1614049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1614052">//&nbsp;Goexit&nbsp;terminates&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;calls&nbsp;it.&nbsp;&nbsp;No&nbsp;other&nbsp;goroutine&nbsp;is&nbsp;affected.</span><br>
<span class="lineno">260</span><span class="comment" id="1614135">//&nbsp;Goexit&nbsp;runs&nbsp;all&nbsp;deferred&nbsp;calls&nbsp;before&nbsp;terminating&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;Because&nbsp;Goexit</span><br>
<span class="lineno"></span><span class="comment" id="1614219">//&nbsp;is&nbsp;not&nbsp;panic,&nbsp;however,&nbsp;any&nbsp;recover&nbsp;calls&nbsp;in&nbsp;those&nbsp;deferred&nbsp;functions&nbsp;will&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1614308">//</span><br>
<span class="lineno"></span><span class="comment" id="1614311">//&nbsp;Calling&nbsp;Goexit&nbsp;from&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;terminates&nbsp;that&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1614379">//&nbsp;without&nbsp;func&nbsp;main&nbsp;returning.&nbsp;Since&nbsp;func&nbsp;main&nbsp;has&nbsp;not&nbsp;returned,</span><br>
<span class="lineno">265</span><span class="comment" id="1614445">//&nbsp;the&nbsp;program&nbsp;continues&nbsp;execution&nbsp;of&nbsp;other&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="1614501">//&nbsp;If&nbsp;all&nbsp;other&nbsp;goroutines&nbsp;exit,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="1614555">func</span>&nbsp;<span class="ident" id="1614560">Goexit</span><span class="op" id="1614566">(</span><span class="op" id="1614567">)</span>&nbsp;<span class="op" id="1614569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614572">//&nbsp;Run&nbsp;all&nbsp;deferred&nbsp;functions&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614630">//&nbsp;This&nbsp;code&nbsp;is&nbsp;similar&nbsp;to&nbsp;gopanic,&nbsp;see&nbsp;that&nbsp;implementation</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614691">//&nbsp;for&nbsp;detailed&nbsp;comments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614718">gp</span>&nbsp;<span class="op" id="1614721">:=</span>&nbsp;<span class="ident" id="1614724">getg</span><span class="op" id="1614728">(</span><span class="op" id="1614729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614732">for</span>&nbsp;<span class="op" id="1614736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614740">d</span>&nbsp;<span class="op" id="1614742">:=</span>&nbsp;<span class="ident" id="1614745">gp</span><span class="op" id="1614747">.</span><span class="ident" id="1614748">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614757">if</span>&nbsp;<span class="ident" id="1614760">d</span>&nbsp;<span class="op" id="1614762">==</span>&nbsp;<span class="ident" id="1614765">nil</span>&nbsp;<span class="op" id="1614769">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614774">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614786">if</span>&nbsp;<span class="ident" id="1614789">d</span><span class="op" id="1614790">.</span><span class="ident" id="1614791">started</span>&nbsp;<span class="op" id="1614799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614804">if</span>&nbsp;<span class="ident" id="1614807">d</span><span class="op" id="1614808">.</span><span class="ident" id="1614809">_panic</span>&nbsp;<span class="op" id="1614816">!=</span>&nbsp;<span class="ident" id="1614819">nil</span>&nbsp;<span class="op" id="1614823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614829">d</span><span class="op" id="1614830">.</span><span class="ident" id="1614831">_panic</span><span class="op" id="1614837">.</span><span class="ident" id="1614838">aborted</span>&nbsp;<span class="op" id="1614846">=</span>&nbsp;<span class="builtintype" id="1614848">true</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614857">d</span><span class="op" id="1614858">.</span><span class="ident" id="1614859">_panic</span>&nbsp;<span class="op" id="1614866">=</span>&nbsp;<span class="ident" id="1614868">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614880">d</span><span class="op" id="1614881">.</span><span class="ident" id="1614882">fn</span>&nbsp;<span class="op" id="1614885">=</span>&nbsp;<span class="ident" id="1614887">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614894">gp</span><span class="op" id="1614896">.</span><span class="ident" id="1614897">_defer</span>&nbsp;<span class="op" id="1614904">=</span>&nbsp;<span class="ident" id="1614906">d</span><span class="op" id="1614907">.</span><span class="ident" id="1614908">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614916">freedefer</span><span class="op" id="1614925">(</span><span class="ident" id="1614926">d</span><span class="op" id="1614927">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614932">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614947">d</span><span class="op" id="1614948">.</span><span class="ident" id="1614949">started</span>&nbsp;<span class="op" id="1614957">=</span>&nbsp;<span class="builtintype" id="1614959">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614966">reflectcall</span><span class="op" id="1614977">(</span><span class="ident" id="1614978">unsafe</span><span class="op" id="1614984">.</span><span class="ident" id="1614985">Pointer</span><span class="op" id="1614992">(</span><span class="ident" id="1614993">d</span><span class="op" id="1614994">.</span><span class="ident" id="1614995">fn</span><span class="op" id="1614997">)</span><span class="op" id="1614998">,</span>&nbsp;<span class="ident" id="1615000">deferArgs</span><span class="op" id="1615009">(</span><span class="ident" id="1615010">d</span><span class="op" id="1615011">)</span><span class="op" id="1615012">,</span>&nbsp;<span class="builtintype" id="1615014">uint32</span><span class="op" id="1615020">(</span><span class="ident" id="1615021">d</span><span class="op" id="1615022">.</span><span class="ident" id="1615023">siz</span><span class="op" id="1615026">)</span><span class="op" id="1615027">,</span>&nbsp;<span class="builtintype" id="1615029">uint32</span><span class="op" id="1615035">(</span><span class="ident" id="1615036">d</span><span class="op" id="1615037">.</span><span class="ident" id="1615038">siz</span><span class="op" id="1615041">)</span><span class="op" id="1615042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615046">if</span>&nbsp;<span class="ident" id="1615049">gp</span><span class="op" id="1615051">.</span><span class="ident" id="1615052">_defer</span>&nbsp;<span class="op" id="1615059">!=</span>&nbsp;<span class="ident" id="1615062">d</span>&nbsp;<span class="op" id="1615064">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615069">gothrow</span><span class="op" id="1615076">(</span><span class="string" id="1615077">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;Goexit&#34;</span><span class="op" id="1615104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615112">d</span><span class="op" id="1615113">.</span><span class="ident" id="1615114">_panic</span>&nbsp;<span class="op" id="1615121">=</span>&nbsp;<span class="ident" id="1615123">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615129">d</span><span class="op" id="1615130">.</span><span class="ident" id="1615131">fn</span>&nbsp;<span class="op" id="1615134">=</span>&nbsp;<span class="ident" id="1615136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615142">gp</span><span class="op" id="1615144">.</span><span class="ident" id="1615145">_defer</span>&nbsp;<span class="op" id="1615152">=</span>&nbsp;<span class="ident" id="1615154">d</span><span class="op" id="1615155">.</span><span class="ident" id="1615156">link</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615163">freedefer</span><span class="op" id="1615172">(</span><span class="ident" id="1615173">d</span><span class="op" id="1615174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615178">//&nbsp;Note:&nbsp;we&nbsp;ignore&nbsp;recovers&nbsp;here&nbsp;because&nbsp;Goexit&nbsp;isn&#39;t&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615244">goexit</span><span class="op" id="1615250">(</span><span class="op" id="1615251">)</span><br>
<span class="lineno"></span><span class="op" id="1615253">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span><span class="keyword" id="1615256">func</span>&nbsp;<span class="ident" id="1615261">canpanic</span><span class="op" id="1615269">(</span><span class="op" id="1615270">*</span><span class="ident" id="1615271">g</span><span class="op" id="1615272">)</span>&nbsp;<span class="builtintype" id="1615274">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1615280">//&nbsp;Print&nbsp;all&nbsp;currently&nbsp;active&nbsp;panics.&nbsp;&nbsp;Used&nbsp;when&nbsp;crashing.</span><br>
<span class="lineno"></span><span class="keyword" id="1615339">func</span>&nbsp;<span class="ident" id="1615344">printpanics</span><span class="op" id="1615355">(</span><span class="ident" id="1615356">p</span>&nbsp;<span class="op" id="1615358">*</span><span class="ident" id="1615359">_panic</span><span class="op" id="1615365">)</span>&nbsp;<span class="op" id="1615367">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615370">if</span>&nbsp;<span class="ident" id="1615373">p</span><span class="op" id="1615374">.</span><span class="ident" id="1615375">link</span>&nbsp;<span class="op" id="1615380">!=</span>&nbsp;<span class="ident" id="1615383">nil</span>&nbsp;<span class="op" id="1615387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615391">printpanics</span><span class="op" id="1615402">(</span><span class="ident" id="1615403">p</span><span class="op" id="1615404">.</span><span class="ident" id="1615405">link</span><span class="op" id="1615409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615413">print</span><span class="op" id="1615418">(</span><span class="string" id="1615419">&#34;\t&#34;</span><span class="op" id="1615423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615429">print</span><span class="op" id="1615434">(</span><span class="string" id="1615435">&#34;panic:&nbsp;&#34;</span><span class="op" id="1615444">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615447">printany</span><span class="op" id="1615455">(</span><span class="ident" id="1615456">p</span><span class="op" id="1615457">.</span><span class="ident" id="1615458">arg</span><span class="op" id="1615461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615464">if</span>&nbsp;<span class="ident" id="1615467">p</span><span class="op" id="1615468">.</span><span class="ident" id="1615469">recovered</span>&nbsp;<span class="op" id="1615479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615483">print</span><span class="op" id="1615488">(</span><span class="string" id="1615489">&#34;&nbsp;[recovered]&#34;</span><span class="op" id="1615503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1615509">print</span><span class="op" id="1615514">(</span><span class="string" id="1615515">&#34;\n&#34;</span><span class="op" id="1615519">)</span><br>
<span class="lineno">315</span><span class="op" id="1615521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1615524">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1615581">func</span>&nbsp;<span class="ident" id="1615586">gopanic</span><span class="op" id="1615593">(</span><span class="ident" id="1615594">e</span>&nbsp;<span class="keyword" id="1615596">interface</span><span class="op" id="1615605">{</span><span class="op" id="1615606">}</span><span class="op" id="1615607">)</span>&nbsp;<span class="op" id="1615609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615612">gp</span>&nbsp;<span class="op" id="1615615">:=</span>&nbsp;<span class="ident" id="1615618">getg</span><span class="op" id="1615622">(</span><span class="op" id="1615623">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615626">if</span>&nbsp;<span class="ident" id="1615629">gp</span><span class="op" id="1615631">.</span><span class="ident" id="1615632">m</span><span class="op" id="1615633">.</span><span class="ident" id="1615634">curg</span>&nbsp;<span class="op" id="1615639">!=</span>&nbsp;<span class="ident" id="1615642">gp</span>&nbsp;<span class="op" id="1615645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615649">gothrow</span><span class="op" id="1615656">(</span><span class="string" id="1615657">&#34;panic&nbsp;on&nbsp;m&nbsp;stack&#34;</span><span class="op" id="1615675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615682">//&nbsp;m.softfloat&nbsp;is&nbsp;set&nbsp;during&nbsp;software&nbsp;floating&nbsp;point.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615737">//&nbsp;It&nbsp;increments&nbsp;m.locks&nbsp;to&nbsp;avoid&nbsp;preemption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615784">//&nbsp;We&nbsp;moved&nbsp;the&nbsp;memory&nbsp;loads&nbsp;out,&nbsp;so&nbsp;there&nbsp;shouldn&#39;t&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615841">//&nbsp;any&nbsp;reason&nbsp;for&nbsp;it&nbsp;to&nbsp;panic&nbsp;anymore.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615881">if</span>&nbsp;<span class="ident" id="1615884">gp</span><span class="op" id="1615886">.</span><span class="ident" id="1615887">m</span><span class="op" id="1615888">.</span><span class="ident" id="1615889">softfloat</span>&nbsp;<span class="op" id="1615899">!=</span>&nbsp;<span class="num" id="1615902">0</span>&nbsp;<span class="op" id="1615904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615908">gp</span><span class="op" id="1615910">.</span><span class="ident" id="1615911">m</span><span class="op" id="1615912">.</span><span class="ident" id="1615913">locks</span><span class="op" id="1615918">--</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615923">gp</span><span class="op" id="1615925">.</span><span class="ident" id="1615926">m</span><span class="op" id="1615927">.</span><span class="ident" id="1615928">softfloat</span>&nbsp;<span class="op" id="1615938">=</span>&nbsp;<span class="num" id="1615940">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615944">gothrow</span><span class="op" id="1615951">(</span><span class="string" id="1615952">&#34;panic&nbsp;during&nbsp;softfloat&#34;</span><span class="op" id="1615976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615982">if</span>&nbsp;<span class="ident" id="1615985">gp</span><span class="op" id="1615987">.</span><span class="ident" id="1615988">m</span><span class="op" id="1615989">.</span><span class="ident" id="1615990">mallocing</span>&nbsp;<span class="op" id="1616000">!=</span>&nbsp;<span class="num" id="1616003">0</span>&nbsp;<span class="op" id="1616005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616009">print</span><span class="op" id="1616014">(</span><span class="string" id="1616015">&#34;panic:&nbsp;&#34;</span><span class="op" id="1616024">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616028">printany</span><span class="op" id="1616036">(</span><span class="ident" id="1616037">e</span><span class="op" id="1616038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616042">print</span><span class="op" id="1616047">(</span><span class="string" id="1616048">&#34;\n&#34;</span><span class="op" id="1616052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616056">gothrow</span><span class="op" id="1616063">(</span><span class="string" id="1616064">&#34;panic&nbsp;during&nbsp;malloc&#34;</span><span class="op" id="1616085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616091">if</span>&nbsp;<span class="ident" id="1616094">gp</span><span class="op" id="1616096">.</span><span class="ident" id="1616097">m</span><span class="op" id="1616098">.</span><span class="ident" id="1616099">gcing</span>&nbsp;<span class="op" id="1616105">!=</span>&nbsp;<span class="num" id="1616108">0</span>&nbsp;<span class="op" id="1616110">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616114">print</span><span class="op" id="1616119">(</span><span class="string" id="1616120">&#34;panic:&nbsp;&#34;</span><span class="op" id="1616129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616133">printany</span><span class="op" id="1616141">(</span><span class="ident" id="1616142">e</span><span class="op" id="1616143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616147">print</span><span class="op" id="1616152">(</span><span class="string" id="1616153">&#34;\n&#34;</span><span class="op" id="1616157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616161">gothrow</span><span class="op" id="1616168">(</span><span class="string" id="1616169">&#34;panic&nbsp;during&nbsp;gc&#34;</span><span class="op" id="1616186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616189">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616192">if</span>&nbsp;<span class="ident" id="1616195">gp</span><span class="op" id="1616197">.</span><span class="ident" id="1616198">m</span><span class="op" id="1616199">.</span><span class="ident" id="1616200">locks</span>&nbsp;<span class="op" id="1616206">!=</span>&nbsp;<span class="num" id="1616209">0</span>&nbsp;<span class="op" id="1616211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616215">print</span><span class="op" id="1616220">(</span><span class="string" id="1616221">&#34;panic:&nbsp;&#34;</span><span class="op" id="1616230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616234">printany</span><span class="op" id="1616242">(</span><span class="ident" id="1616243">e</span><span class="op" id="1616244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1616248">print</span><span class="op" id="1616253">(</span><span class="string" id="1616254">&#34;\n&#34;</span><span class="op" id="1616258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616262">gothrow</span><span class="op" id="1616269">(</span><span class="string" id="1616270">&#34;panic&nbsp;holding&nbsp;locks&#34;</span><span class="op" id="1616291">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616298">var</span>&nbsp;<span class="ident" id="1616302">p</span>&nbsp;<span class="ident" id="1616304">_panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616312">p</span><span class="op" id="1616313">.</span><span class="ident" id="1616314">arg</span>&nbsp;<span class="op" id="1616318">=</span>&nbsp;<span class="ident" id="1616320">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616323">p</span><span class="op" id="1616324">.</span><span class="ident" id="1616325">link</span>&nbsp;<span class="op" id="1616330">=</span>&nbsp;<span class="ident" id="1616332">gp</span><span class="op" id="1616334">.</span><span class="ident" id="1616335">_panic</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616343">gp</span><span class="op" id="1616345">.</span><span class="ident" id="1616346">_panic</span>&nbsp;<span class="op" id="1616353">=</span>&nbsp;<span class="op" id="1616355">(</span><span class="op" id="1616356">*</span><span class="ident" id="1616357">_panic</span><span class="op" id="1616363">)</span><span class="op" id="1616364">(</span><span class="ident" id="1616365">noescape</span><span class="op" id="1616373">(</span><span class="ident" id="1616374">unsafe</span><span class="op" id="1616380">.</span><span class="ident" id="1616381">Pointer</span><span class="op" id="1616388">(</span><span class="op" id="1616389">&amp;</span><span class="ident" id="1616390">p</span><span class="op" id="1616391">)</span><span class="op" id="1616392">)</span><span class="op" id="1616393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616397">for</span>&nbsp;<span class="op" id="1616401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616405">d</span>&nbsp;<span class="op" id="1616407">:=</span>&nbsp;<span class="ident" id="1616410">gp</span><span class="op" id="1616412">.</span><span class="ident" id="1616413">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616422">if</span>&nbsp;<span class="ident" id="1616425">d</span>&nbsp;<span class="op" id="1616427">==</span>&nbsp;<span class="ident" id="1616430">nil</span>&nbsp;<span class="op" id="1616434">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616439">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616452">//&nbsp;If&nbsp;defer&nbsp;was&nbsp;started&nbsp;by&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;(and,&nbsp;since&nbsp;we&#39;re&nbsp;back&nbsp;here,&nbsp;that&nbsp;triggered&nbsp;a&nbsp;new&nbsp;panic),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616563">//&nbsp;take&nbsp;defer&nbsp;off&nbsp;list.&nbsp;The&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;will&nbsp;not&nbsp;continue&nbsp;running.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616644">if</span>&nbsp;<span class="ident" id="1616647">d</span><span class="op" id="1616648">.</span><span class="ident" id="1616649">started</span>&nbsp;<span class="op" id="1616657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616662">if</span>&nbsp;<span class="ident" id="1616665">d</span><span class="op" id="1616666">.</span><span class="ident" id="1616667">_panic</span>&nbsp;<span class="op" id="1616674">!=</span>&nbsp;<span class="ident" id="1616677">nil</span>&nbsp;<span class="op" id="1616681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616687">d</span><span class="op" id="1616688">.</span><span class="ident" id="1616689">_panic</span><span class="op" id="1616695">.</span><span class="ident" id="1616696">aborted</span>&nbsp;<span class="op" id="1616704">=</span>&nbsp;<span class="builtintype" id="1616706">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616719">d</span><span class="op" id="1616720">.</span><span class="ident" id="1616721">_panic</span>&nbsp;<span class="op" id="1616728">=</span>&nbsp;<span class="ident" id="1616730">nil</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616737">d</span><span class="op" id="1616738">.</span><span class="ident" id="1616739">fn</span>&nbsp;<span class="op" id="1616742">=</span>&nbsp;<span class="ident" id="1616744">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616751">gp</span><span class="op" id="1616753">.</span><span class="ident" id="1616754">_defer</span>&nbsp;<span class="op" id="1616761">=</span>&nbsp;<span class="ident" id="1616763">d</span><span class="op" id="1616764">.</span><span class="ident" id="1616765">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616773">freedefer</span><span class="op" id="1616782">(</span><span class="ident" id="1616783">d</span><span class="op" id="1616784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616789">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616800">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616805">//&nbsp;Mark&nbsp;defer&nbsp;as&nbsp;started,&nbsp;but&nbsp;keep&nbsp;on&nbsp;list,&nbsp;so&nbsp;that&nbsp;traceback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616869">//&nbsp;can&nbsp;find&nbsp;and&nbsp;update&nbsp;the&nbsp;defer&#39;s&nbsp;argument&nbsp;frame&nbsp;if&nbsp;stack&nbsp;growth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616937">//&nbsp;or&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;hapens&nbsp;before&nbsp;reflectcall&nbsp;starts&nbsp;executing&nbsp;d.fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617015">d</span><span class="op" id="1617016">.</span><span class="ident" id="1617017">started</span>&nbsp;<span class="op" id="1617025">=</span>&nbsp;<span class="builtintype" id="1617027">true</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617035">//&nbsp;Record&nbsp;the&nbsp;panic&nbsp;that&nbsp;is&nbsp;running&nbsp;the&nbsp;defer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617084">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;panic&nbsp;during&nbsp;the&nbsp;deferred&nbsp;call,&nbsp;that&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617150">//&nbsp;will&nbsp;find&nbsp;d&nbsp;in&nbsp;the&nbsp;list&nbsp;and&nbsp;will&nbsp;mark&nbsp;d._panic&nbsp;(this&nbsp;panic)&nbsp;aborted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617224">d</span><span class="op" id="1617225">.</span><span class="ident" id="1617226">_panic</span>&nbsp;<span class="op" id="1617233">=</span>&nbsp;<span class="op" id="1617235">(</span><span class="op" id="1617236">*</span><span class="ident" id="1617237">_panic</span><span class="op" id="1617243">)</span><span class="op" id="1617244">(</span><span class="ident" id="1617245">noescape</span><span class="op" id="1617253">(</span><span class="op" id="1617254">(</span><span class="ident" id="1617255">unsafe</span><span class="op" id="1617261">.</span><span class="ident" id="1617262">Pointer</span><span class="op" id="1617269">)</span><span class="op" id="1617270">(</span><span class="op" id="1617271">&amp;</span><span class="ident" id="1617272">p</span><span class="op" id="1617273">)</span><span class="op" id="1617274">)</span><span class="op" id="1617275">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617280">p</span><span class="op" id="1617281">.</span><span class="ident" id="1617282">argp</span>&nbsp;<span class="op" id="1617287">=</span>&nbsp;<span class="ident" id="1617289">unsafe</span><span class="op" id="1617295">.</span><span class="ident" id="1617296">Pointer</span><span class="op" id="1617303">(</span><span class="ident" id="1617304">getargp</span><span class="op" id="1617311">(</span><span class="num" id="1617312">0</span><span class="op" id="1617313">)</span><span class="op" id="1617314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617318">reflectcall</span><span class="op" id="1617329">(</span><span class="ident" id="1617330">unsafe</span><span class="op" id="1617336">.</span><span class="ident" id="1617337">Pointer</span><span class="op" id="1617344">(</span><span class="ident" id="1617345">d</span><span class="op" id="1617346">.</span><span class="ident" id="1617347">fn</span><span class="op" id="1617349">)</span><span class="op" id="1617350">,</span>&nbsp;<span class="ident" id="1617352">deferArgs</span><span class="op" id="1617361">(</span><span class="ident" id="1617362">d</span><span class="op" id="1617363">)</span><span class="op" id="1617364">,</span>&nbsp;<span class="builtintype" id="1617366">uint32</span><span class="op" id="1617372">(</span><span class="ident" id="1617373">d</span><span class="op" id="1617374">.</span><span class="ident" id="1617375">siz</span><span class="op" id="1617378">)</span><span class="op" id="1617379">,</span>&nbsp;<span class="builtintype" id="1617381">uint32</span><span class="op" id="1617387">(</span><span class="ident" id="1617388">d</span><span class="op" id="1617389">.</span><span class="ident" id="1617390">siz</span><span class="op" id="1617393">)</span><span class="op" id="1617394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617398">p</span><span class="op" id="1617399">.</span><span class="ident" id="1617400">argp</span>&nbsp;<span class="op" id="1617405">=</span>&nbsp;<span class="ident" id="1617407">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617414">//&nbsp;reflectcall&nbsp;did&nbsp;not&nbsp;panic.&nbsp;Remove&nbsp;d.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617456">if</span>&nbsp;<span class="ident" id="1617459">gp</span><span class="op" id="1617461">.</span><span class="ident" id="1617462">_defer</span>&nbsp;<span class="op" id="1617469">!=</span>&nbsp;<span class="ident" id="1617472">d</span>&nbsp;<span class="op" id="1617474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617479">gothrow</span><span class="op" id="1617486">(</span><span class="string" id="1617487">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;panic&#34;</span><span class="op" id="1617513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617521">d</span><span class="op" id="1617522">.</span><span class="ident" id="1617523">_panic</span>&nbsp;<span class="op" id="1617530">=</span>&nbsp;<span class="ident" id="1617532">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617538">d</span><span class="op" id="1617539">.</span><span class="ident" id="1617540">fn</span>&nbsp;<span class="op" id="1617543">=</span>&nbsp;<span class="ident" id="1617545">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617551">gp</span><span class="op" id="1617553">.</span><span class="ident" id="1617554">_defer</span>&nbsp;<span class="op" id="1617561">=</span>&nbsp;<span class="ident" id="1617563">d</span><span class="op" id="1617564">.</span><span class="ident" id="1617565">link</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617573">//&nbsp;trigger&nbsp;shrinkage&nbsp;to&nbsp;test&nbsp;stack&nbsp;copy.&nbsp;&nbsp;See&nbsp;stack_test.go:TestStackPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617650">//GC()</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617660">pc</span>&nbsp;<span class="op" id="1617663">:=</span>&nbsp;<span class="ident" id="1617666">d</span><span class="op" id="1617667">.</span><span class="ident" id="1617668">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617673">argp</span>&nbsp;<span class="op" id="1617678">:=</span>&nbsp;<span class="ident" id="1617681">unsafe</span><span class="op" id="1617687">.</span><span class="ident" id="1617688">Pointer</span><span class="op" id="1617695">(</span><span class="ident" id="1617696">d</span><span class="op" id="1617697">.</span><span class="ident" id="1617698">argp</span><span class="op" id="1617702">)</span>&nbsp;<span class="comment" id="1617704">//&nbsp;must&nbsp;be&nbsp;pointer&nbsp;so&nbsp;it&nbsp;gets&nbsp;adjusted&nbsp;during&nbsp;stack&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617763">freedefer</span><span class="op" id="1617772">(</span><span class="ident" id="1617773">d</span><span class="op" id="1617774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617778">if</span>&nbsp;<span class="ident" id="1617781">p</span><span class="op" id="1617782">.</span><span class="ident" id="1617783">recovered</span>&nbsp;<span class="op" id="1617793">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617798">gp</span><span class="op" id="1617800">.</span><span class="ident" id="1617801">_panic</span>&nbsp;<span class="op" id="1617808">=</span>&nbsp;<span class="ident" id="1617810">p</span><span class="op" id="1617811">.</span><span class="ident" id="1617812">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617820">//&nbsp;Aborted&nbsp;panics&nbsp;are&nbsp;marked&nbsp;but&nbsp;remain&nbsp;on&nbsp;the&nbsp;g.panic&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617884">//&nbsp;Remove&nbsp;them&nbsp;from&nbsp;the&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617917">for</span>&nbsp;<span class="ident" id="1617921">gp</span><span class="op" id="1617923">.</span><span class="ident" id="1617924">_panic</span>&nbsp;<span class="op" id="1617931">!=</span>&nbsp;<span class="ident" id="1617934">nil</span>&nbsp;<span class="op" id="1617938">&amp;&amp;</span>&nbsp;<span class="ident" id="1617941">gp</span><span class="op" id="1617943">.</span><span class="ident" id="1617944">_panic</span><span class="op" id="1617950">.</span><span class="ident" id="1617951">aborted</span>&nbsp;<span class="op" id="1617959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617965">gp</span><span class="op" id="1617967">.</span><span class="ident" id="1617968">_panic</span>&nbsp;<span class="op" id="1617975">=</span>&nbsp;<span class="ident" id="1617977">gp</span><span class="op" id="1617979">.</span><span class="ident" id="1617980">_panic</span><span class="op" id="1617986">.</span><span class="ident" id="1617987">link</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618000">if</span>&nbsp;<span class="ident" id="1618003">gp</span><span class="op" id="1618005">.</span><span class="ident" id="1618006">_panic</span>&nbsp;<span class="op" id="1618013">==</span>&nbsp;<span class="ident" id="1618016">nil</span>&nbsp;<span class="op" id="1618020">{</span>&nbsp;<span class="comment" id="1618022">//&nbsp;must&nbsp;be&nbsp;done&nbsp;with&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618054">gp</span><span class="op" id="1618056">.</span><span class="ident" id="1618057">sig</span>&nbsp;<span class="op" id="1618061">=</span>&nbsp;<span class="num" id="1618063">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618073">//&nbsp;Pass&nbsp;information&nbsp;about&nbsp;recovering&nbsp;frame&nbsp;to&nbsp;recovery.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618132">gp</span><span class="op" id="1618134">.</span><span class="ident" id="1618135">sigcode0</span>&nbsp;<span class="op" id="1618144">=</span>&nbsp;<span class="builtintype" id="1618146">uintptr</span><span class="op" id="1618153">(</span><span class="ident" id="1618154">argp</span><span class="op" id="1618158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618163">gp</span><span class="op" id="1618165">.</span><span class="ident" id="1618166">sigcode1</span>&nbsp;<span class="op" id="1618175">=</span>&nbsp;<span class="ident" id="1618177">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618183">mcall</span><span class="op" id="1618188">(</span><span class="ident" id="1618189">recovery_m</span><span class="op" id="1618199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618204">gothrow</span><span class="op" id="1618211">(</span><span class="string" id="1618212">&#34;recovery&nbsp;failed&#34;</span><span class="op" id="1618229">)</span>&nbsp;<span class="comment" id="1618231">//&nbsp;mcall&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618260">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618267">//&nbsp;ran&nbsp;out&nbsp;of&nbsp;deferred&nbsp;calls&nbsp;-&nbsp;old-school&nbsp;panic&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618320">startpanic</span><span class="op" id="1618330">(</span><span class="op" id="1618331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618334">printpanics</span><span class="op" id="1618345">(</span><span class="ident" id="1618346">gp</span><span class="op" id="1618348">.</span><span class="ident" id="1618349">_panic</span><span class="op" id="1618355">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618358">dopanic</span><span class="op" id="1618365">(</span><span class="num" id="1618366">0</span><span class="op" id="1618367">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618375">//&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618397">*</span><span class="op" id="1618398">(</span><span class="op" id="1618399">*</span><span class="builtintype" id="1618400">int</span><span class="op" id="1618403">)</span><span class="op" id="1618404">(</span><span class="ident" id="1618405">nil</span><span class="op" id="1618408">)</span>&nbsp;<span class="op" id="1618410">=</span>&nbsp;<span class="num" id="1618412">0</span>&nbsp;<span class="comment" id="1618414">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1618429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618432">//&nbsp;getargp&nbsp;returns&nbsp;the&nbsp;location&nbsp;where&nbsp;the&nbsp;caller</span><br>
<span class="lineno">430</span><span class="comment" id="1618481">//&nbsp;writes&nbsp;outgoing&nbsp;function&nbsp;call&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1618525">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1618538">func</span>&nbsp;<span class="ident" id="1618543">getargp</span><span class="op" id="1618550">(</span><span class="ident" id="1618551">x</span>&nbsp;<span class="builtintype" id="1618553">int</span><span class="op" id="1618556">)</span>&nbsp;<span class="builtintype" id="1618558">uintptr</span>&nbsp;<span class="op" id="1618566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618569">//&nbsp;x&nbsp;is&nbsp;an&nbsp;argument&nbsp;mainly&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;return&nbsp;its&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618632">//&nbsp;However,&nbsp;we&nbsp;need&nbsp;to&nbsp;make&nbsp;the&nbsp;function&nbsp;complex&nbsp;enough</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618689">//&nbsp;that&nbsp;it&nbsp;won&#39;t&nbsp;be&nbsp;inlined.&nbsp;We&nbsp;always&nbsp;pass&nbsp;x&nbsp;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618754">//&nbsp;does&nbsp;nothing&nbsp;other&nbsp;than&nbsp;keep&nbsp;the&nbsp;compiler&nbsp;from&nbsp;thinking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618814">//&nbsp;the&nbsp;function&nbsp;is&nbsp;simple&nbsp;enough&nbsp;to&nbsp;inline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618859">if</span>&nbsp;<span class="ident" id="1618862">x</span>&nbsp;<span class="op" id="1618864">&gt;</span>&nbsp;<span class="num" id="1618866">0</span>&nbsp;<span class="op" id="1618868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618872">return</span>&nbsp;<span class="ident" id="1618879">getcallersp</span><span class="op" id="1618890">(</span><span class="ident" id="1618891">unsafe</span><span class="op" id="1618897">.</span><span class="ident" id="1618898">Pointer</span><span class="op" id="1618905">(</span><span class="op" id="1618906">&amp;</span><span class="ident" id="1618907">x</span><span class="op" id="1618908">)</span><span class="op" id="1618909">)</span>&nbsp;<span class="op" id="1618911">*</span>&nbsp;<span class="num" id="1618913">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618919">return</span>&nbsp;<span class="builtintype" id="1618926">uintptr</span><span class="op" id="1618933">(</span><span class="ident" id="1618934">noescape</span><span class="op" id="1618942">(</span><span class="ident" id="1618943">unsafe</span><span class="op" id="1618949">.</span><span class="ident" id="1618950">Pointer</span><span class="op" id="1618957">(</span><span class="op" id="1618958">&amp;</span><span class="ident" id="1618959">x</span><span class="op" id="1618960">)</span><span class="op" id="1618961">)</span><span class="op" id="1618962">)</span><br>
<span class="lineno"></span><span class="op" id="1618964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1618967">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;recover.</span><br>
<span class="lineno">445</span><span class="comment" id="1619026">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;it&nbsp;needs&nbsp;to&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="1619081">//&nbsp;find&nbsp;the&nbsp;stack&nbsp;segment&nbsp;of&nbsp;its&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1619122">//</span><br>
<span class="lineno"></span><span class="comment" id="1619125">//&nbsp;TODO(rsc):&nbsp;Once&nbsp;we&nbsp;commit&nbsp;to&nbsp;CopyStackAlways,</span><br>
<span class="lineno"></span><span class="comment" id="1619174">//&nbsp;this&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;nosplit.</span><br>
<span class="lineno">450</span><span class="comment" id="1619210">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1619223">func</span>&nbsp;<span class="ident" id="1619228">gorecover</span><span class="op" id="1619237">(</span><span class="ident" id="1619238">argp</span>&nbsp;<span class="builtintype" id="1619243">uintptr</span><span class="op" id="1619250">)</span>&nbsp;<span class="keyword" id="1619252">interface</span><span class="op" id="1619261">{</span><span class="op" id="1619262">}</span>&nbsp;<span class="op" id="1619264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619267">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;a&nbsp;function&nbsp;running&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;deferred&nbsp;call&nbsp;during&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619346">//&nbsp;Must&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;topmost&nbsp;function&nbsp;of&nbsp;the&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619403">//&nbsp;(the&nbsp;function&nbsp;used&nbsp;in&nbsp;the&nbsp;defer&nbsp;statement).</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619451">//&nbsp;p.argp&nbsp;is&nbsp;the&nbsp;argument&nbsp;pointer&nbsp;of&nbsp;that&nbsp;topmost&nbsp;deferred&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619526">//&nbsp;Compare&nbsp;against&nbsp;argp&nbsp;reported&nbsp;by&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619571">//&nbsp;If&nbsp;they&nbsp;match,&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;who&nbsp;can&nbsp;recover.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619629">gp</span>&nbsp;<span class="op" id="1619632">:=</span>&nbsp;<span class="ident" id="1619635">getg</span><span class="op" id="1619639">(</span><span class="op" id="1619640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619643">p</span>&nbsp;<span class="op" id="1619645">:=</span>&nbsp;<span class="ident" id="1619648">gp</span><span class="op" id="1619650">.</span><span class="ident" id="1619651">_panic</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619659">if</span>&nbsp;<span class="ident" id="1619662">p</span>&nbsp;<span class="op" id="1619664">!=</span>&nbsp;<span class="ident" id="1619667">nil</span>&nbsp;<span class="op" id="1619671">&amp;&amp;</span>&nbsp;<span class="op" id="1619674">!</span><span class="ident" id="1619675">p</span><span class="op" id="1619676">.</span><span class="ident" id="1619677">recovered</span>&nbsp;<span class="op" id="1619687">&amp;&amp;</span>&nbsp;<span class="ident" id="1619690">argp</span>&nbsp;<span class="op" id="1619695">==</span>&nbsp;<span class="builtintype" id="1619698">uintptr</span><span class="op" id="1619705">(</span><span class="ident" id="1619706">p</span><span class="op" id="1619707">.</span><span class="ident" id="1619708">argp</span><span class="op" id="1619712">)</span>&nbsp;<span class="op" id="1619714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619718">p</span><span class="op" id="1619719">.</span><span class="ident" id="1619720">recovered</span>&nbsp;<span class="op" id="1619730">=</span>&nbsp;<span class="builtintype" id="1619732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619739">return</span>&nbsp;<span class="ident" id="1619746">p</span><span class="op" id="1619747">.</span><span class="ident" id="1619748">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619756">return</span>&nbsp;<span class="ident" id="1619763">nil</span><br>
<span class="lineno">465</span><span class="op" id="1619767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619770">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1619783">func</span>&nbsp;<span class="ident" id="1619788">startpanic</span><span class="op" id="1619798">(</span><span class="op" id="1619799">)</span>&nbsp;<span class="op" id="1619801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619804">onM_signalok</span><span class="op" id="1619816">(</span><span class="ident" id="1619817">startpanic_m</span><span class="op" id="1619829">)</span><br>
<span class="lineno">470</span><span class="op" id="1619831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619834">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1619847">func</span>&nbsp;<span class="ident" id="1619852">dopanic</span><span class="op" id="1619859">(</span><span class="ident" id="1619860">unused</span>&nbsp;<span class="builtintype" id="1619867">int</span><span class="op" id="1619870">)</span>&nbsp;<span class="op" id="1619872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619875">gp</span>&nbsp;<span class="op" id="1619878">:=</span>&nbsp;<span class="ident" id="1619881">getg</span><span class="op" id="1619885">(</span><span class="op" id="1619886">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619889">mp</span>&nbsp;<span class="op" id="1619892">:=</span>&nbsp;<span class="ident" id="1619895">acquirem</span><span class="op" id="1619903">(</span><span class="op" id="1619904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619907">mp</span><span class="op" id="1619909">.</span><span class="ident" id="1619910">ptrarg</span><span class="op" id="1619916">[</span><span class="num" id="1619917">0</span><span class="op" id="1619918">]</span>&nbsp;<span class="op" id="1619920">=</span>&nbsp;<span class="ident" id="1619922">unsafe</span><span class="op" id="1619928">.</span><span class="ident" id="1619929">Pointer</span><span class="op" id="1619936">(</span><span class="ident" id="1619937">gp</span><span class="op" id="1619939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619942">mp</span><span class="op" id="1619944">.</span><span class="ident" id="1619945">scalararg</span><span class="op" id="1619954">[</span><span class="num" id="1619955">0</span><span class="op" id="1619956">]</span>&nbsp;<span class="op" id="1619958">=</span>&nbsp;<span class="ident" id="1619960">getcallerpc</span><span class="op" id="1619971">(</span><span class="op" id="1619972">(</span><span class="ident" id="1619973">unsafe</span><span class="op" id="1619979">.</span><span class="ident" id="1619980">Pointer</span><span class="op" id="1619987">)</span><span class="op" id="1619988">(</span><span class="op" id="1619989">&amp;</span><span class="ident" id="1619990">unused</span><span class="op" id="1619996">)</span><span class="op" id="1619997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620000">mp</span><span class="op" id="1620002">.</span><span class="ident" id="1620003">scalararg</span><span class="op" id="1620012">[</span><span class="num" id="1620013">1</span><span class="op" id="1620014">]</span>&nbsp;<span class="op" id="1620016">=</span>&nbsp;<span class="ident" id="1620018">getcallersp</span><span class="op" id="1620029">(</span><span class="op" id="1620030">(</span><span class="ident" id="1620031">unsafe</span><span class="op" id="1620037">.</span><span class="ident" id="1620038">Pointer</span><span class="op" id="1620045">)</span><span class="op" id="1620046">(</span><span class="op" id="1620047">&amp;</span><span class="ident" id="1620048">unused</span><span class="op" id="1620054">)</span><span class="op" id="1620055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620058">onM_signalok</span><span class="op" id="1620070">(</span><span class="ident" id="1620071">dopanic_m</span><span class="op" id="1620080">)</span>&nbsp;<span class="comment" id="1620082">//&nbsp;should&nbsp;never&nbsp;return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620106">*</span><span class="op" id="1620107">(</span><span class="op" id="1620108">*</span><span class="builtintype" id="1620109">int</span><span class="op" id="1620112">)</span><span class="op" id="1620113">(</span><span class="ident" id="1620114">nil</span><span class="op" id="1620117">)</span>&nbsp;<span class="op" id="1620119">=</span>&nbsp;<span class="num" id="1620121">0</span><br>
<span class="lineno"></span><span class="op" id="1620123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1620126">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1620139">func</span>&nbsp;<span class="ident" id="1620144">throw</span><span class="op" id="1620149">(</span><span class="ident" id="1620150">s</span>&nbsp;<span class="op" id="1620152">*</span><span class="builtintype" id="1620153">byte</span><span class="op" id="1620157">)</span>&nbsp;<span class="op" id="1620159">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620162">gp</span>&nbsp;<span class="op" id="1620165">:=</span>&nbsp;<span class="ident" id="1620168">getg</span><span class="op" id="1620172">(</span><span class="op" id="1620173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620176">if</span>&nbsp;<span class="ident" id="1620179">gp</span><span class="op" id="1620181">.</span><span class="ident" id="1620182">m</span><span class="op" id="1620183">.</span><span class="ident" id="1620184">throwing</span>&nbsp;<span class="op" id="1620193">==</span>&nbsp;<span class="num" id="1620196">0</span>&nbsp;<span class="op" id="1620198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620202">gp</span><span class="op" id="1620204">.</span><span class="ident" id="1620205">m</span><span class="op" id="1620206">.</span><span class="ident" id="1620207">throwing</span>&nbsp;<span class="op" id="1620216">=</span>&nbsp;<span class="num" id="1620218">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620224">startpanic</span><span class="op" id="1620234">(</span><span class="op" id="1620235">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1620238">print</span><span class="op" id="1620243">(</span><span class="string" id="1620244">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1620259">,</span>&nbsp;<span class="ident" id="1620261">gostringnocopy</span><span class="op" id="1620275">(</span><span class="ident" id="1620276">s</span><span class="op" id="1620277">)</span><span class="op" id="1620278">,</span>&nbsp;<span class="string" id="1620280">&#34;\n&#34;</span><span class="op" id="1620284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620287">dopanic</span><span class="op" id="1620294">(</span><span class="num" id="1620295">0</span><span class="op" id="1620296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620299">*</span><span class="op" id="1620300">(</span><span class="op" id="1620301">*</span><span class="builtintype" id="1620302">int</span><span class="op" id="1620305">)</span><span class="op" id="1620306">(</span><span class="ident" id="1620307">nil</span><span class="op" id="1620310">)</span>&nbsp;<span class="op" id="1620312">=</span>&nbsp;<span class="num" id="1620314">0</span>&nbsp;<span class="comment" id="1620316">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1620331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="1620334">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1620347">func</span>&nbsp;<span class="ident" id="1620352">gothrow</span><span class="op" id="1620359">(</span><span class="ident" id="1620360">s</span>&nbsp;<span class="builtintype" id="1620362">string</span><span class="op" id="1620368">)</span>&nbsp;<span class="op" id="1620370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620373">gp</span>&nbsp;<span class="op" id="1620376">:=</span>&nbsp;<span class="ident" id="1620379">getg</span><span class="op" id="1620383">(</span><span class="op" id="1620384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620387">if</span>&nbsp;<span class="ident" id="1620390">gp</span><span class="op" id="1620392">.</span><span class="ident" id="1620393">m</span><span class="op" id="1620394">.</span><span class="ident" id="1620395">throwing</span>&nbsp;<span class="op" id="1620404">==</span>&nbsp;<span class="num" id="1620407">0</span>&nbsp;<span class="op" id="1620409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620413">gp</span><span class="op" id="1620415">.</span><span class="ident" id="1620416">m</span><span class="op" id="1620417">.</span><span class="ident" id="1620418">throwing</span>&nbsp;<span class="op" id="1620427">=</span>&nbsp;<span class="num" id="1620429">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620435">startpanic</span><span class="op" id="1620445">(</span><span class="op" id="1620446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1620449">print</span><span class="op" id="1620454">(</span><span class="string" id="1620455">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1620470">,</span>&nbsp;<span class="ident" id="1620472">s</span><span class="op" id="1620473">,</span>&nbsp;<span class="string" id="1620475">&#34;\n&#34;</span><span class="op" id="1620479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620482">dopanic</span><span class="op" id="1620489">(</span><span class="num" id="1620490">0</span><span class="op" id="1620491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620494">*</span><span class="op" id="1620495">(</span><span class="op" id="1620496">*</span><span class="builtintype" id="1620497">int</span><span class="op" id="1620500">)</span><span class="op" id="1620501">(</span><span class="ident" id="1620502">nil</span><span class="op" id="1620505">)</span>&nbsp;<span class="op" id="1620507">=</span>&nbsp;<span class="num" id="1620509">0</span>&nbsp;<span class="comment" id="1620511">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno">505</span><span class="op" id="1620526">}</span>
</div>
</body>
</html>
