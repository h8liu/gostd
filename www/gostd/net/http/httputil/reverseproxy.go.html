<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6164306">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6164361">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6164415">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6164466">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6164497">package</span>&nbsp;<span class="ident" id="6164505">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6164515">import</span>&nbsp;<span class="op" id="6164522">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164525">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164531">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164538">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164545">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164557">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164568">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164579">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6164587">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6164594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6164597">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6164670">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6164696">var</span>&nbsp;<span class="ident" id="6164700">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6164716">func</span><span class="op" id="6164720">(</span><span class="op" id="6164721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6164724">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6164794">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6164859">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6164870">type</span>&nbsp;<span class="ident" id="6164875">ReverseProxy</span>&nbsp;<span class="keyword" id="6164888">struct</span>&nbsp;<span class="op" id="6164895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6164898">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6164945">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6164991">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165040">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165084">Director</span>&nbsp;<span class="keyword" id="6165093">func</span><span class="op" id="6165097">(</span><span class="op" id="6165098">*</span><span class="ident" id="6165099">http</span><span class="op" id="6165103">.</span><span class="ident" id="6165104">Request</span><span class="op" id="6165111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165115">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165165">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165208">Transport</span>&nbsp;<span class="ident" id="6165218">http</span><span class="op" id="6165222">.</span><span class="ident" id="6165223">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165238">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165285">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165330">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165349">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165392">FlushInterval</span>&nbsp;<span class="ident" id="6165406">time</span><span class="op" id="6165410">.</span><span class="ident" id="6165411">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165422">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165475">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165528">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6165588">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165609">ErrorLog</span>&nbsp;<span class="op" id="6165618">*</span><span class="ident" id="6165619">log</span><span class="op" id="6165622">.</span><span class="ident" id="6165623">Logger</span><br>
<span class="lineno"></span><span class="op" id="6165630">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6165633">func</span>&nbsp;<span class="ident" id="6165638">singleJoiningSlash</span><span class="op" id="6165656">(</span><span class="ident" id="6165657">a</span><span class="op" id="6165658">,</span>&nbsp;<span class="ident" id="6165660">b</span>&nbsp;<span class="builtintype" id="6165662">string</span><span class="op" id="6165668">)</span>&nbsp;<span class="builtintype" id="6165670">string</span>&nbsp;<span class="op" id="6165677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165680">aslash</span>&nbsp;<span class="op" id="6165687">:=</span>&nbsp;<span class="ident" id="6165690">strings</span><span class="op" id="6165697">.</span><span class="ident" id="6165698">HasSuffix</span><span class="op" id="6165707">(</span><span class="ident" id="6165708">a</span><span class="op" id="6165709">,</span>&nbsp;<span class="string" id="6165711">&#34;/&#34;</span><span class="op" id="6165714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6165717">bslash</span>&nbsp;<span class="op" id="6165724">:=</span>&nbsp;<span class="ident" id="6165727">strings</span><span class="op" id="6165734">.</span><span class="ident" id="6165735">HasPrefix</span><span class="op" id="6165744">(</span><span class="ident" id="6165745">b</span><span class="op" id="6165746">,</span>&nbsp;<span class="string" id="6165748">&#34;/&#34;</span><span class="op" id="6165751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165754">switch</span>&nbsp;<span class="op" id="6165761">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165764">case</span>&nbsp;<span class="ident" id="6165769">aslash</span>&nbsp;<span class="op" id="6165776">&amp;&amp;</span>&nbsp;<span class="ident" id="6165779">bslash</span><span class="op" id="6165785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165789">return</span>&nbsp;<span class="ident" id="6165796">a</span>&nbsp;<span class="op" id="6165798">+</span>&nbsp;<span class="ident" id="6165800">b</span><span class="op" id="6165801">[</span><span class="num" id="6165802">1</span><span class="op" id="6165803">:</span><span class="op" id="6165804">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165807">case</span>&nbsp;<span class="op" id="6165812">!</span><span class="ident" id="6165813">aslash</span>&nbsp;<span class="op" id="6165820">&amp;&amp;</span>&nbsp;<span class="op" id="6165823">!</span><span class="ident" id="6165824">bslash</span><span class="op" id="6165830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165834">return</span>&nbsp;<span class="ident" id="6165841">a</span>&nbsp;<span class="op" id="6165843">+</span>&nbsp;<span class="string" id="6165845">&#34;/&#34;</span>&nbsp;<span class="op" id="6165849">+</span>&nbsp;<span class="ident" id="6165851">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6165854">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6165857">return</span>&nbsp;<span class="ident" id="6165864">a</span>&nbsp;<span class="op" id="6165866">+</span>&nbsp;<span class="ident" id="6165868">b</span><br>
<span class="lineno"></span><span class="op" id="6165870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6165873">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6165943">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6166013">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6166082">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6166127">func</span>&nbsp;<span class="ident" id="6166132">NewSingleHostReverseProxy</span><span class="op" id="6166157">(</span><span class="ident" id="6166158">target</span>&nbsp;<span class="op" id="6166165">*</span><span class="ident" id="6166166">url</span><span class="op" id="6166169">.</span><span class="ident" id="6166170">URL</span><span class="op" id="6166173">)</span>&nbsp;<span class="op" id="6166175">*</span><span class="ident" id="6166176">ReverseProxy</span>&nbsp;<span class="op" id="6166189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166192">targetQuery</span>&nbsp;<span class="op" id="6166204">:=</span>&nbsp;<span class="ident" id="6166207">target</span><span class="op" id="6166213">.</span><span class="ident" id="6166214">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166224">director</span>&nbsp;<span class="op" id="6166233">:=</span>&nbsp;<span class="keyword" id="6166236">func</span><span class="op" id="6166240">(</span><span class="ident" id="6166241">req</span>&nbsp;<span class="op" id="6166245">*</span><span class="ident" id="6166246">http</span><span class="op" id="6166250">.</span><span class="ident" id="6166251">Request</span><span class="op" id="6166258">)</span>&nbsp;<span class="op" id="6166260">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166264">req</span><span class="op" id="6166267">.</span><span class="ident" id="6166268">URL</span><span class="op" id="6166271">.</span><span class="ident" id="6166272">Scheme</span>&nbsp;<span class="op" id="6166279">=</span>&nbsp;<span class="ident" id="6166281">target</span><span class="op" id="6166287">.</span><span class="ident" id="6166288">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166297">req</span><span class="op" id="6166300">.</span><span class="ident" id="6166301">URL</span><span class="op" id="6166304">.</span><span class="ident" id="6166305">Host</span>&nbsp;<span class="op" id="6166310">=</span>&nbsp;<span class="ident" id="6166312">target</span><span class="op" id="6166318">.</span><span class="ident" id="6166319">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166326">req</span><span class="op" id="6166329">.</span><span class="ident" id="6166330">URL</span><span class="op" id="6166333">.</span><span class="ident" id="6166334">Path</span>&nbsp;<span class="op" id="6166339">=</span>&nbsp;<span class="ident" id="6166341">singleJoiningSlash</span><span class="op" id="6166359">(</span><span class="ident" id="6166360">target</span><span class="op" id="6166366">.</span><span class="ident" id="6166367">Path</span><span class="op" id="6166371">,</span>&nbsp;<span class="ident" id="6166373">req</span><span class="op" id="6166376">.</span><span class="ident" id="6166377">URL</span><span class="op" id="6166380">.</span><span class="ident" id="6166381">Path</span><span class="op" id="6166385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6166389">if</span>&nbsp;<span class="ident" id="6166392">targetQuery</span>&nbsp;<span class="op" id="6166404">==</span>&nbsp;<span class="string" id="6166407">&#34;&#34;</span>&nbsp;<span class="op" id="6166410">||</span>&nbsp;<span class="ident" id="6166413">req</span><span class="op" id="6166416">.</span><span class="ident" id="6166417">URL</span><span class="op" id="6166420">.</span><span class="ident" id="6166421">RawQuery</span>&nbsp;<span class="op" id="6166430">==</span>&nbsp;<span class="string" id="6166433">&#34;&#34;</span>&nbsp;<span class="op" id="6166436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166441">req</span><span class="op" id="6166444">.</span><span class="ident" id="6166445">URL</span><span class="op" id="6166448">.</span><span class="ident" id="6166449">RawQuery</span>&nbsp;<span class="op" id="6166458">=</span>&nbsp;<span class="ident" id="6166460">targetQuery</span>&nbsp;<span class="op" id="6166472">+</span>&nbsp;<span class="ident" id="6166474">req</span><span class="op" id="6166477">.</span><span class="ident" id="6166478">URL</span><span class="op" id="6166481">.</span><span class="ident" id="6166482">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6166493">}</span>&nbsp;<span class="keyword" id="6166495">else</span>&nbsp;<span class="op" id="6166500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166505">req</span><span class="op" id="6166508">.</span><span class="ident" id="6166509">URL</span><span class="op" id="6166512">.</span><span class="ident" id="6166513">RawQuery</span>&nbsp;<span class="op" id="6166522">=</span>&nbsp;<span class="ident" id="6166524">targetQuery</span>&nbsp;<span class="op" id="6166536">+</span>&nbsp;<span class="string" id="6166538">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6166542">+</span>&nbsp;<span class="ident" id="6166544">req</span><span class="op" id="6166547">.</span><span class="ident" id="6166548">URL</span><span class="op" id="6166551">.</span><span class="ident" id="6166552">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6166563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6166566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6166569">return</span>&nbsp;<span class="op" id="6166576">&amp;</span><span class="ident" id="6166577">ReverseProxy</span><span class="op" id="6166589">{</span><span class="ident" id="6166590">Director</span><span class="op" id="6166598">:</span>&nbsp;<span class="ident" id="6166600">director</span><span class="op" id="6166608">}</span><br>
<span class="lineno">80</span><span class="op" id="6166610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6166613">func</span>&nbsp;<span class="ident" id="6166618">copyHeader</span><span class="op" id="6166628">(</span><span class="ident" id="6166629">dst</span><span class="op" id="6166632">,</span>&nbsp;<span class="ident" id="6166634">src</span>&nbsp;<span class="ident" id="6166638">http</span><span class="op" id="6166642">.</span><span class="ident" id="6166643">Header</span><span class="op" id="6166649">)</span>&nbsp;<span class="op" id="6166651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6166654">for</span>&nbsp;<span class="ident" id="6166658">k</span><span class="op" id="6166659">,</span>&nbsp;<span class="ident" id="6166661">vv</span>&nbsp;<span class="op" id="6166664">:=</span>&nbsp;<span class="keyword" id="6166667">range</span>&nbsp;<span class="ident" id="6166673">src</span>&nbsp;<span class="op" id="6166677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6166681">for</span>&nbsp;<span class="ident" id="6166685">_</span><span class="op" id="6166686">,</span>&nbsp;<span class="ident" id="6166688">v</span>&nbsp;<span class="op" id="6166690">:=</span>&nbsp;<span class="keyword" id="6166693">range</span>&nbsp;<span class="ident" id="6166699">vv</span>&nbsp;<span class="op" id="6166702">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6166707">dst</span><span class="op" id="6166710">.</span><span class="ident" id="6166711">Add</span><span class="op" id="6166714">(</span><span class="ident" id="6166715">k</span><span class="op" id="6166716">,</span>&nbsp;<span class="ident" id="6166718">v</span><span class="op" id="6166719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6166723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6166726">}</span><br>
<span class="lineno"></span><span class="op" id="6166728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6166731">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6166798">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6166856">var</span>&nbsp;<span class="ident" id="6166860">hopHeaders</span>&nbsp;<span class="op" id="6166871">=</span>&nbsp;<span class="op" id="6166873">[</span><span class="op" id="6166874">]</span><span class="builtintype" id="6166875">string</span><span class="op" id="6166881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6166884">&#34;Connection&#34;</span><span class="op" id="6166896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6166899">&#34;Keep-Alive&#34;</span><span class="op" id="6166911">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6166914">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6166934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6166937">&#34;Proxy-Authorization&#34;</span><span class="op" id="6166958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6166961">&#34;Te&#34;</span><span class="op" id="6166965">,</span>&nbsp;<span class="comment" id="6166967">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6167001">&#34;Trailers&#34;</span><span class="op" id="6167011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6167014">&#34;Transfer-Encoding&#34;</span><span class="op" id="6167033">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6167036">&#34;Upgrade&#34;</span><span class="op" id="6167045">,</span><br>
<span class="lineno"></span><span class="op" id="6167047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6167050">func</span>&nbsp;<span class="op" id="6167055">(</span><span class="ident" id="6167056">p</span>&nbsp;<span class="op" id="6167058">*</span><span class="ident" id="6167059">ReverseProxy</span><span class="op" id="6167071">)</span>&nbsp;<span class="ident" id="6167073">ServeHTTP</span><span class="op" id="6167082">(</span><span class="ident" id="6167083">rw</span>&nbsp;<span class="ident" id="6167086">http</span><span class="op" id="6167090">.</span><span class="ident" id="6167091">ResponseWriter</span><span class="op" id="6167105">,</span>&nbsp;<span class="ident" id="6167107">req</span>&nbsp;<span class="op" id="6167111">*</span><span class="ident" id="6167112">http</span><span class="op" id="6167116">.</span><span class="ident" id="6167117">Request</span><span class="op" id="6167124">)</span>&nbsp;<span class="op" id="6167126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167129">transport</span>&nbsp;<span class="op" id="6167139">:=</span>&nbsp;<span class="ident" id="6167142">p</span><span class="op" id="6167143">.</span><span class="ident" id="6167144">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6167155">if</span>&nbsp;<span class="ident" id="6167158">transport</span>&nbsp;<span class="op" id="6167168">==</span>&nbsp;<span class="ident" id="6167171">nil</span>&nbsp;<span class="op" id="6167175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167179">transport</span>&nbsp;<span class="op" id="6167189">=</span>&nbsp;<span class="ident" id="6167191">http</span><span class="op" id="6167195">.</span><span class="ident" id="6167196">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6167214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167218">outreq</span>&nbsp;<span class="op" id="6167225">:=</span>&nbsp;<span class="builtinfunc" id="6167228">new</span><span class="op" id="6167231">(</span><span class="ident" id="6167232">http</span><span class="op" id="6167236">.</span><span class="ident" id="6167237">Request</span><span class="op" id="6167244">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6167247">*</span><span class="ident" id="6167248">outreq</span>&nbsp;<span class="op" id="6167255">=</span>&nbsp;<span class="op" id="6167257">*</span><span class="ident" id="6167258">req</span>&nbsp;<span class="comment" id="6167262">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167309">p</span><span class="op" id="6167310">.</span><span class="ident" id="6167311">Director</span><span class="op" id="6167319">(</span><span class="ident" id="6167320">outreq</span><span class="op" id="6167326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167329">outreq</span><span class="op" id="6167335">.</span><span class="ident" id="6167336">Proto</span>&nbsp;<span class="op" id="6167342">=</span>&nbsp;<span class="string" id="6167344">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167356">outreq</span><span class="op" id="6167362">.</span><span class="ident" id="6167363">ProtoMajor</span>&nbsp;<span class="op" id="6167374">=</span>&nbsp;<span class="num" id="6167376">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167379">outreq</span><span class="op" id="6167385">.</span><span class="ident" id="6167386">ProtoMinor</span>&nbsp;<span class="op" id="6167397">=</span>&nbsp;<span class="num" id="6167399">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167402">outreq</span><span class="op" id="6167408">.</span><span class="ident" id="6167409">Close</span>&nbsp;<span class="op" id="6167415">=</span>&nbsp;<span class="builtintype" id="6167417">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6167425">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6167483">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6167542">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6167606">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6167665">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167716">copiedHeaders</span>&nbsp;<span class="op" id="6167730">:=</span>&nbsp;<span class="builtintype" id="6167733">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6167740">for</span>&nbsp;<span class="ident" id="6167744">_</span><span class="op" id="6167745">,</span>&nbsp;<span class="ident" id="6167747">h</span>&nbsp;<span class="op" id="6167749">:=</span>&nbsp;<span class="keyword" id="6167752">range</span>&nbsp;<span class="ident" id="6167758">hopHeaders</span>&nbsp;<span class="op" id="6167769">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6167773">if</span>&nbsp;<span class="ident" id="6167776">outreq</span><span class="op" id="6167782">.</span><span class="ident" id="6167783">Header</span><span class="op" id="6167789">.</span><span class="ident" id="6167790">Get</span><span class="op" id="6167793">(</span><span class="ident" id="6167794">h</span><span class="op" id="6167795">)</span>&nbsp;<span class="op" id="6167797">!=</span>&nbsp;<span class="string" id="6167800">&#34;&#34;</span>&nbsp;<span class="op" id="6167803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6167808">if</span>&nbsp;<span class="op" id="6167811">!</span><span class="ident" id="6167812">copiedHeaders</span>&nbsp;<span class="op" id="6167826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167832">outreq</span><span class="op" id="6167838">.</span><span class="ident" id="6167839">Header</span>&nbsp;<span class="op" id="6167846">=</span>&nbsp;<span class="builtinfunc" id="6167848">make</span><span class="op" id="6167852">(</span><span class="ident" id="6167853">http</span><span class="op" id="6167857">.</span><span class="ident" id="6167858">Header</span><span class="op" id="6167864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167870">copyHeader</span><span class="op" id="6167880">(</span><span class="ident" id="6167881">outreq</span><span class="op" id="6167887">.</span><span class="ident" id="6167888">Header</span><span class="op" id="6167894">,</span>&nbsp;<span class="ident" id="6167896">req</span><span class="op" id="6167899">.</span><span class="ident" id="6167900">Header</span><span class="op" id="6167906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167912">copiedHeaders</span>&nbsp;<span class="op" id="6167926">=</span>&nbsp;<span class="builtintype" id="6167928">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6167936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6167941">outreq</span><span class="op" id="6167947">.</span><span class="ident" id="6167948">Header</span><span class="op" id="6167954">.</span><span class="ident" id="6167955">Del</span><span class="op" id="6167958">(</span><span class="ident" id="6167959">h</span><span class="op" id="6167960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6167964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6167967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6167971">if</span>&nbsp;<span class="ident" id="6167974">clientIP</span><span class="op" id="6167982">,</span>&nbsp;<span class="ident" id="6167984">_</span><span class="op" id="6167985">,</span>&nbsp;<span class="ident" id="6167987">err</span>&nbsp;<span class="op" id="6167991">:=</span>&nbsp;<span class="ident" id="6167994">net</span><span class="op" id="6167997">.</span><span class="ident" id="6167998">SplitHostPort</span><span class="op" id="6168011">(</span><span class="ident" id="6168012">req</span><span class="op" id="6168015">.</span><span class="ident" id="6168016">RemoteAddr</span><span class="op" id="6168026">)</span><span class="op" id="6168027">;</span>&nbsp;<span class="ident" id="6168029">err</span>&nbsp;<span class="op" id="6168033">==</span>&nbsp;<span class="ident" id="6168036">nil</span>&nbsp;<span class="op" id="6168040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6168044">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6168091">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6168141">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168197">if</span>&nbsp;<span class="ident" id="6168200">prior</span><span class="op" id="6168205">,</span>&nbsp;<span class="ident" id="6168207">ok</span>&nbsp;<span class="op" id="6168210">:=</span>&nbsp;<span class="ident" id="6168213">outreq</span><span class="op" id="6168219">.</span><span class="ident" id="6168220">Header</span><span class="op" id="6168226">[</span><span class="string" id="6168227">&#34;X-Forwarded-For&#34;</span><span class="op" id="6168244">]</span><span class="op" id="6168245">;</span>&nbsp;<span class="ident" id="6168247">ok</span>&nbsp;<span class="op" id="6168250">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168255">clientIP</span>&nbsp;<span class="op" id="6168264">=</span>&nbsp;<span class="ident" id="6168266">strings</span><span class="op" id="6168273">.</span><span class="ident" id="6168274">Join</span><span class="op" id="6168278">(</span><span class="ident" id="6168279">prior</span><span class="op" id="6168284">,</span>&nbsp;<span class="string" id="6168286">&#34;,&nbsp;&#34;</span><span class="op" id="6168290">)</span>&nbsp;<span class="op" id="6168292">+</span>&nbsp;<span class="string" id="6168294">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6168299">+</span>&nbsp;<span class="ident" id="6168301">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6168312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168316">outreq</span><span class="op" id="6168322">.</span><span class="ident" id="6168323">Header</span><span class="op" id="6168329">.</span><span class="ident" id="6168330">Set</span><span class="op" id="6168333">(</span><span class="string" id="6168334">&#34;X-Forwarded-For&#34;</span><span class="op" id="6168351">,</span>&nbsp;<span class="ident" id="6168353">clientIP</span><span class="op" id="6168361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6168364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168368">res</span><span class="op" id="6168371">,</span>&nbsp;<span class="ident" id="6168373">err</span>&nbsp;<span class="op" id="6168377">:=</span>&nbsp;<span class="ident" id="6168380">transport</span><span class="op" id="6168389">.</span><span class="ident" id="6168390">RoundTrip</span><span class="op" id="6168399">(</span><span class="ident" id="6168400">outreq</span><span class="op" id="6168406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168409">if</span>&nbsp;<span class="ident" id="6168412">err</span>&nbsp;<span class="op" id="6168416">!=</span>&nbsp;<span class="ident" id="6168419">nil</span>&nbsp;<span class="op" id="6168423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168427">p</span><span class="op" id="6168428">.</span><span class="ident" id="6168429">logf</span><span class="op" id="6168433">(</span><span class="string" id="6168434">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6168457">,</span>&nbsp;<span class="ident" id="6168459">err</span><span class="op" id="6168462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168466">rw</span><span class="op" id="6168468">.</span><span class="ident" id="6168469">WriteHeader</span><span class="op" id="6168480">(</span><span class="ident" id="6168481">http</span><span class="op" id="6168485">.</span><span class="ident" id="6168486">StatusInternalServerError</span><span class="op" id="6168511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168515">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6168523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168526">defer</span>&nbsp;<span class="ident" id="6168532">res</span><span class="op" id="6168535">.</span><span class="ident" id="6168536">Body</span><span class="op" id="6168540">.</span><span class="ident" id="6168541">Close</span><span class="op" id="6168546">(</span><span class="op" id="6168547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168551">for</span>&nbsp;<span class="ident" id="6168555">_</span><span class="op" id="6168556">,</span>&nbsp;<span class="ident" id="6168558">h</span>&nbsp;<span class="op" id="6168560">:=</span>&nbsp;<span class="keyword" id="6168563">range</span>&nbsp;<span class="ident" id="6168569">hopHeaders</span>&nbsp;<span class="op" id="6168580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168584">res</span><span class="op" id="6168587">.</span><span class="ident" id="6168588">Header</span><span class="op" id="6168594">.</span><span class="ident" id="6168595">Del</span><span class="op" id="6168598">(</span><span class="ident" id="6168599">h</span><span class="op" id="6168600">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6168603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168607">copyHeader</span><span class="op" id="6168617">(</span><span class="ident" id="6168618">rw</span><span class="op" id="6168620">.</span><span class="ident" id="6168621">Header</span><span class="op" id="6168627">(</span><span class="op" id="6168628">)</span><span class="op" id="6168629">,</span>&nbsp;<span class="ident" id="6168631">res</span><span class="op" id="6168634">.</span><span class="ident" id="6168635">Header</span><span class="op" id="6168641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168645">rw</span><span class="op" id="6168647">.</span><span class="ident" id="6168648">WriteHeader</span><span class="op" id="6168659">(</span><span class="ident" id="6168660">res</span><span class="op" id="6168663">.</span><span class="ident" id="6168664">StatusCode</span><span class="op" id="6168674">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168677">p</span><span class="op" id="6168678">.</span><span class="ident" id="6168679">copyResponse</span><span class="op" id="6168691">(</span><span class="ident" id="6168692">rw</span><span class="op" id="6168694">,</span>&nbsp;<span class="ident" id="6168696">res</span><span class="op" id="6168699">.</span><span class="ident" id="6168700">Body</span><span class="op" id="6168704">)</span><br>
<span class="lineno"></span><span class="op" id="6168706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6168709">func</span>&nbsp;<span class="op" id="6168714">(</span><span class="ident" id="6168715">p</span>&nbsp;<span class="op" id="6168717">*</span><span class="ident" id="6168718">ReverseProxy</span><span class="op" id="6168730">)</span>&nbsp;<span class="ident" id="6168732">copyResponse</span><span class="op" id="6168744">(</span><span class="ident" id="6168745">dst</span>&nbsp;<span class="ident" id="6168749">io</span><span class="op" id="6168751">.</span><span class="ident" id="6168752">Writer</span><span class="op" id="6168758">,</span>&nbsp;<span class="ident" id="6168760">src</span>&nbsp;<span class="ident" id="6168764">io</span><span class="op" id="6168766">.</span><span class="ident" id="6168767">Reader</span><span class="op" id="6168773">)</span>&nbsp;<span class="op" id="6168775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168778">if</span>&nbsp;<span class="ident" id="6168781">p</span><span class="op" id="6168782">.</span><span class="ident" id="6168783">FlushInterval</span>&nbsp;<span class="op" id="6168797">!=</span>&nbsp;<span class="num" id="6168800">0</span>&nbsp;<span class="op" id="6168802">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168806">if</span>&nbsp;<span class="ident" id="6168809">wf</span><span class="op" id="6168811">,</span>&nbsp;<span class="ident" id="6168813">ok</span>&nbsp;<span class="op" id="6168816">:=</span>&nbsp;<span class="ident" id="6168819">dst</span><span class="op" id="6168822">.</span><span class="op" id="6168823">(</span><span class="ident" id="6168824">writeFlusher</span><span class="op" id="6168836">)</span><span class="op" id="6168837">;</span>&nbsp;<span class="ident" id="6168839">ok</span>&nbsp;<span class="op" id="6168842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168847">mlw</span>&nbsp;<span class="op" id="6168851">:=</span>&nbsp;<span class="op" id="6168854">&amp;</span><span class="ident" id="6168855">maxLatencyWriter</span><span class="op" id="6168871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168877">dst</span><span class="op" id="6168880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6168886">wf</span><span class="op" id="6168888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168894">latency</span><span class="op" id="6168901">:</span>&nbsp;<span class="ident" id="6168903">p</span><span class="op" id="6168904">.</span><span class="ident" id="6168905">FlushInterval</span><span class="op" id="6168918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6168924">done</span><span class="op" id="6168928">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6168933">make</span><span class="op" id="6168937">(</span><span class="keyword" id="6168938">chan</span>&nbsp;<span class="builtintype" id="6168943">bool</span><span class="op" id="6168947">)</span><span class="op" id="6168948">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6168953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168958">go</span>&nbsp;<span class="ident" id="6168961">mlw</span><span class="op" id="6168964">.</span><span class="ident" id="6168965">flushLoop</span><span class="op" id="6168974">(</span><span class="op" id="6168975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6168980">defer</span>&nbsp;<span class="ident" id="6168986">mlw</span><span class="op" id="6168989">.</span><span class="ident" id="6168990">stop</span><span class="op" id="6168994">(</span><span class="op" id="6168995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169000">dst</span>&nbsp;<span class="op" id="6169004">=</span>&nbsp;<span class="ident" id="6169006">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169012">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169019">io</span><span class="op" id="6169021">.</span><span class="ident" id="6169022">Copy</span><span class="op" id="6169026">(</span><span class="ident" id="6169027">dst</span><span class="op" id="6169030">,</span>&nbsp;<span class="ident" id="6169032">src</span><span class="op" id="6169035">)</span><br>
<span class="lineno"></span><span class="op" id="6169037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6169040">func</span>&nbsp;<span class="op" id="6169045">(</span><span class="ident" id="6169046">p</span>&nbsp;<span class="op" id="6169048">*</span><span class="ident" id="6169049">ReverseProxy</span><span class="op" id="6169061">)</span>&nbsp;<span class="ident" id="6169063">logf</span><span class="op" id="6169067">(</span><span class="ident" id="6169068">format</span>&nbsp;<span class="builtintype" id="6169075">string</span><span class="op" id="6169081">,</span>&nbsp;<span class="ident" id="6169083">args</span>&nbsp;<span class="op" id="6169088">...</span><span class="keyword" id="6169091">interface</span><span class="op" id="6169100">{</span><span class="op" id="6169101">}</span><span class="op" id="6169102">)</span>&nbsp;<span class="op" id="6169104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169107">if</span>&nbsp;<span class="ident" id="6169110">p</span><span class="op" id="6169111">.</span><span class="ident" id="6169112">ErrorLog</span>&nbsp;<span class="op" id="6169121">!=</span>&nbsp;<span class="ident" id="6169124">nil</span>&nbsp;<span class="op" id="6169128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169132">p</span><span class="op" id="6169133">.</span><span class="ident" id="6169134">ErrorLog</span><span class="op" id="6169142">.</span><span class="ident" id="6169143">Printf</span><span class="op" id="6169149">(</span><span class="ident" id="6169150">format</span><span class="op" id="6169156">,</span>&nbsp;<span class="ident" id="6169158">args</span><span class="op" id="6169162">...</span><span class="op" id="6169165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169168">}</span>&nbsp;<span class="keyword" id="6169170">else</span>&nbsp;<span class="op" id="6169175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169179">log</span><span class="op" id="6169182">.</span><span class="ident" id="6169183">Printf</span><span class="op" id="6169189">(</span><span class="ident" id="6169190">format</span><span class="op" id="6169196">,</span>&nbsp;<span class="ident" id="6169198">args</span><span class="op" id="6169202">...</span><span class="op" id="6169205">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169208">}</span><br>
<span class="lineno"></span><span class="op" id="6169210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6169213">type</span>&nbsp;<span class="ident" id="6169218">writeFlusher</span>&nbsp;<span class="keyword" id="6169231">interface</span>&nbsp;<span class="op" id="6169241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169244">io</span><span class="op" id="6169246">.</span><span class="ident" id="6169247">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169255">http</span><span class="op" id="6169259">.</span><span class="ident" id="6169260">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6169268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6169271">type</span>&nbsp;<span class="ident" id="6169276">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6169293">struct</span>&nbsp;<span class="op" id="6169300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169303">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6169311">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169325">latency</span>&nbsp;<span class="ident" id="6169333">time</span><span class="op" id="6169337">.</span><span class="ident" id="6169338">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169349">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6169354">sync</span><span class="op" id="6169358">.</span><span class="ident" id="6169359">Mutex</span>&nbsp;<span class="comment" id="6169365">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169392">done</span>&nbsp;<span class="keyword" id="6169397">chan</span>&nbsp;<span class="builtintype" id="6169402">bool</span><br>
<span class="lineno"></span><span class="op" id="6169407">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6169410">func</span>&nbsp;<span class="op" id="6169415">(</span><span class="ident" id="6169416">m</span>&nbsp;<span class="op" id="6169418">*</span><span class="ident" id="6169419">maxLatencyWriter</span><span class="op" id="6169435">)</span>&nbsp;<span class="ident" id="6169437">Write</span><span class="op" id="6169442">(</span><span class="ident" id="6169443">p</span>&nbsp;<span class="op" id="6169445">[</span><span class="op" id="6169446">]</span><span class="builtintype" id="6169447">byte</span><span class="op" id="6169451">)</span>&nbsp;<span class="op" id="6169453">(</span><span class="builtintype" id="6169454">int</span><span class="op" id="6169457">,</span>&nbsp;<span class="builtintype" id="6169459">error</span><span class="op" id="6169464">)</span>&nbsp;<span class="op" id="6169466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169469">m</span><span class="op" id="6169470">.</span><span class="ident" id="6169471">lk</span><span class="op" id="6169473">.</span><span class="ident" id="6169474">Lock</span><span class="op" id="6169478">(</span><span class="op" id="6169479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169482">defer</span>&nbsp;<span class="ident" id="6169488">m</span><span class="op" id="6169489">.</span><span class="ident" id="6169490">lk</span><span class="op" id="6169492">.</span><span class="ident" id="6169493">Unlock</span><span class="op" id="6169499">(</span><span class="op" id="6169500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169503">return</span>&nbsp;<span class="ident" id="6169510">m</span><span class="op" id="6169511">.</span><span class="ident" id="6169512">dst</span><span class="op" id="6169515">.</span><span class="ident" id="6169516">Write</span><span class="op" id="6169521">(</span><span class="ident" id="6169522">p</span><span class="op" id="6169523">)</span><br>
<span class="lineno">205</span><span class="op" id="6169525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6169528">func</span>&nbsp;<span class="op" id="6169533">(</span><span class="ident" id="6169534">m</span>&nbsp;<span class="op" id="6169536">*</span><span class="ident" id="6169537">maxLatencyWriter</span><span class="op" id="6169553">)</span>&nbsp;<span class="ident" id="6169555">flushLoop</span><span class="op" id="6169564">(</span><span class="op" id="6169565">)</span>&nbsp;<span class="op" id="6169567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169570">t</span>&nbsp;<span class="op" id="6169572">:=</span>&nbsp;<span class="ident" id="6169575">time</span><span class="op" id="6169579">.</span><span class="ident" id="6169580">NewTicker</span><span class="op" id="6169589">(</span><span class="ident" id="6169590">m</span><span class="op" id="6169591">.</span><span class="ident" id="6169592">latency</span><span class="op" id="6169599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169602">defer</span>&nbsp;<span class="ident" id="6169608">t</span><span class="op" id="6169609">.</span><span class="ident" id="6169610">Stop</span><span class="op" id="6169614">(</span><span class="op" id="6169615">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169618">for</span>&nbsp;<span class="op" id="6169622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169626">select</span>&nbsp;<span class="op" id="6169633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169637">case</span>&nbsp;<span class="op" id="6169642">&lt;-</span><span class="ident" id="6169644">m</span><span class="op" id="6169645">.</span><span class="ident" id="6169646">done</span><span class="op" id="6169650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169655">if</span>&nbsp;<span class="ident" id="6169658">onExitFlushLoop</span>&nbsp;<span class="op" id="6169674">!=</span>&nbsp;<span class="ident" id="6169677">nil</span>&nbsp;<span class="op" id="6169681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169687">onExitFlushLoop</span><span class="op" id="6169702">(</span><span class="op" id="6169703">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169713">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6169722">case</span>&nbsp;<span class="op" id="6169727">&lt;-</span><span class="ident" id="6169729">t</span><span class="op" id="6169730">.</span><span class="ident" id="6169731">C</span><span class="op" id="6169732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169737">m</span><span class="op" id="6169738">.</span><span class="ident" id="6169739">lk</span><span class="op" id="6169741">.</span><span class="ident" id="6169742">Lock</span><span class="op" id="6169746">(</span><span class="op" id="6169747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169752">m</span><span class="op" id="6169753">.</span><span class="ident" id="6169754">dst</span><span class="op" id="6169757">.</span><span class="ident" id="6169758">Flush</span><span class="op" id="6169763">(</span><span class="op" id="6169764">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6169769">m</span><span class="op" id="6169770">.</span><span class="ident" id="6169771">lk</span><span class="op" id="6169773">.</span><span class="ident" id="6169774">Unlock</span><span class="op" id="6169780">(</span><span class="op" id="6169781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6169788">}</span><br>
<span class="lineno"></span><span class="op" id="6169790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6169793">func</span>&nbsp;<span class="op" id="6169798">(</span><span class="ident" id="6169799">m</span>&nbsp;<span class="op" id="6169801">*</span><span class="ident" id="6169802">maxLatencyWriter</span><span class="op" id="6169818">)</span>&nbsp;<span class="ident" id="6169820">stop</span><span class="op" id="6169824">(</span><span class="op" id="6169825">)</span>&nbsp;<span class="op" id="6169827">{</span>&nbsp;<span class="ident" id="6169829">m</span><span class="op" id="6169830">.</span><span class="ident" id="6169831">done</span>&nbsp;<span class="op" id="6169836">&lt;-</span>&nbsp;<span class="builtintype" id="6169839">true</span>&nbsp;<span class="op" id="6169844">}</span>
</div>
</body>
</html>
