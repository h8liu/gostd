<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3097841">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3097896">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3097950">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3098001">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3098066">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3098095">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3098143">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3098157">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3098218">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3098247">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3098307">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3098331">package</span>&nbsp;<span class="ident" id="3098339">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3098344">import</span>&nbsp;<span class="op" id="3098351">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098354">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098364">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098370">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098383">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098389">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3098397">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3098404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3098407">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3098457">type</span>&nbsp;<span class="ident" id="3098462">dnsConn</span>&nbsp;<span class="keyword" id="3098470">interface</span>&nbsp;<span class="op" id="3098480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098483">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3098490">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3098552">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3098613">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098626">readDNSResponse</span><span class="op" id="3098641">(</span><span class="op" id="3098642">)</span>&nbsp;<span class="op" id="3098644">(</span><span class="op" id="3098645">*</span><span class="ident" id="3098646">dnsMsg</span><span class="op" id="3098652">,</span>&nbsp;<span class="builtintype" id="3098654">error</span><span class="op" id="3098659">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3098663">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3098719">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098744">writeDNSQuery</span><span class="op" id="3098757">(</span><span class="op" id="3098758">*</span><span class="ident" id="3098759">dnsMsg</span><span class="op" id="3098765">)</span>&nbsp;<span class="builtintype" id="3098767">error</span><br>
<span class="lineno"></span><span class="op" id="3098773">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3098776">func</span>&nbsp;<span class="op" id="3098781">(</span><span class="ident" id="3098782">c</span>&nbsp;<span class="op" id="3098784">*</span><span class="ident" id="3098785">UDPConn</span><span class="op" id="3098792">)</span>&nbsp;<span class="ident" id="3098794">readDNSResponse</span><span class="op" id="3098809">(</span><span class="op" id="3098810">)</span>&nbsp;<span class="op" id="3098812">(</span><span class="op" id="3098813">*</span><span class="ident" id="3098814">dnsMsg</span><span class="op" id="3098820">,</span>&nbsp;<span class="builtintype" id="3098822">error</span><span class="op" id="3098827">)</span>&nbsp;<span class="op" id="3098829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098832">b</span>&nbsp;<span class="op" id="3098834">:=</span>&nbsp;<span class="builtinfunc" id="3098837">make</span><span class="op" id="3098841">(</span><span class="op" id="3098842">[</span><span class="op" id="3098843">]</span><span class="builtintype" id="3098844">byte</span><span class="op" id="3098848">,</span>&nbsp;<span class="num" id="3098850">512</span><span class="op" id="3098853">)</span>&nbsp;<span class="comment" id="3098855">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098872">n</span><span class="op" id="3098873">,</span>&nbsp;<span class="ident" id="3098875">err</span>&nbsp;<span class="op" id="3098879">:=</span>&nbsp;<span class="ident" id="3098882">c</span><span class="op" id="3098883">.</span><span class="ident" id="3098884">Read</span><span class="op" id="3098888">(</span><span class="ident" id="3098889">b</span><span class="op" id="3098890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098893">if</span>&nbsp;<span class="ident" id="3098896">err</span>&nbsp;<span class="op" id="3098900">!=</span>&nbsp;<span class="ident" id="3098903">nil</span>&nbsp;<span class="op" id="3098907">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098911">return</span>&nbsp;<span class="ident" id="3098918">nil</span><span class="op" id="3098921">,</span>&nbsp;<span class="ident" id="3098923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3098928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3098931">msg</span>&nbsp;<span class="op" id="3098935">:=</span>&nbsp;<span class="op" id="3098938">&amp;</span><span class="ident" id="3098939">dnsMsg</span><span class="op" id="3098945">{</span><span class="op" id="3098946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098949">if</span>&nbsp;<span class="op" id="3098952">!</span><span class="ident" id="3098953">msg</span><span class="op" id="3098956">.</span><span class="ident" id="3098957">Unpack</span><span class="op" id="3098963">(</span><span class="ident" id="3098964">b</span><span class="op" id="3098965">[</span><span class="op" id="3098966">:</span><span class="ident" id="3098967">n</span><span class="op" id="3098968">]</span><span class="op" id="3098969">)</span>&nbsp;<span class="op" id="3098971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3098975">return</span>&nbsp;<span class="ident" id="3098982">nil</span><span class="op" id="3098985">,</span>&nbsp;<span class="ident" id="3098987">errors</span><span class="op" id="3098993">.</span><span class="ident" id="3098994">New</span><span class="op" id="3098997">(</span><span class="string" id="3098998">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3099028">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099034">return</span>&nbsp;<span class="ident" id="3099041">msg</span><span class="op" id="3099044">,</span>&nbsp;<span class="ident" id="3099046">nil</span><br>
<span class="lineno"></span><span class="op" id="3099050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3099053">func</span>&nbsp;<span class="op" id="3099058">(</span><span class="ident" id="3099059">c</span>&nbsp;<span class="op" id="3099061">*</span><span class="ident" id="3099062">UDPConn</span><span class="op" id="3099069">)</span>&nbsp;<span class="ident" id="3099071">writeDNSQuery</span><span class="op" id="3099084">(</span><span class="ident" id="3099085">msg</span>&nbsp;<span class="op" id="3099089">*</span><span class="ident" id="3099090">dnsMsg</span><span class="op" id="3099096">)</span>&nbsp;<span class="builtintype" id="3099098">error</span>&nbsp;<span class="op" id="3099104">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099107">b</span><span class="op" id="3099108">,</span>&nbsp;<span class="ident" id="3099110">ok</span>&nbsp;<span class="op" id="3099113">:=</span>&nbsp;<span class="ident" id="3099116">msg</span><span class="op" id="3099119">.</span><span class="ident" id="3099120">Pack</span><span class="op" id="3099124">(</span><span class="op" id="3099125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099128">if</span>&nbsp;<span class="op" id="3099131">!</span><span class="ident" id="3099132">ok</span>&nbsp;<span class="op" id="3099135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099139">return</span>&nbsp;<span class="ident" id="3099146">errors</span><span class="op" id="3099152">.</span><span class="ident" id="3099153">New</span><span class="op" id="3099156">(</span><span class="string" id="3099157">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3099185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099191">if</span>&nbsp;<span class="ident" id="3099194">_</span><span class="op" id="3099195">,</span>&nbsp;<span class="ident" id="3099197">err</span>&nbsp;<span class="op" id="3099201">:=</span>&nbsp;<span class="ident" id="3099204">c</span><span class="op" id="3099205">.</span><span class="ident" id="3099206">Write</span><span class="op" id="3099211">(</span><span class="ident" id="3099212">b</span><span class="op" id="3099213">)</span><span class="op" id="3099214">;</span>&nbsp;<span class="ident" id="3099216">err</span>&nbsp;<span class="op" id="3099220">!=</span>&nbsp;<span class="ident" id="3099223">nil</span>&nbsp;<span class="op" id="3099227">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099231">return</span>&nbsp;<span class="ident" id="3099238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099246">return</span>&nbsp;<span class="ident" id="3099253">nil</span><br>
<span class="lineno"></span><span class="op" id="3099257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3099260">func</span>&nbsp;<span class="op" id="3099265">(</span><span class="ident" id="3099266">c</span>&nbsp;<span class="op" id="3099268">*</span><span class="ident" id="3099269">TCPConn</span><span class="op" id="3099276">)</span>&nbsp;<span class="ident" id="3099278">readDNSResponse</span><span class="op" id="3099293">(</span><span class="op" id="3099294">)</span>&nbsp;<span class="op" id="3099296">(</span><span class="op" id="3099297">*</span><span class="ident" id="3099298">dnsMsg</span><span class="op" id="3099304">,</span>&nbsp;<span class="builtintype" id="3099306">error</span><span class="op" id="3099311">)</span>&nbsp;<span class="op" id="3099313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099316">b</span>&nbsp;<span class="op" id="3099318">:=</span>&nbsp;<span class="builtinfunc" id="3099321">make</span><span class="op" id="3099325">(</span><span class="op" id="3099326">[</span><span class="op" id="3099327">]</span><span class="builtintype" id="3099328">byte</span><span class="op" id="3099332">,</span>&nbsp;<span class="num" id="3099334">1280</span><span class="op" id="3099338">)</span>&nbsp;<span class="comment" id="3099340">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099413">if</span>&nbsp;<span class="ident" id="3099416">_</span><span class="op" id="3099417">,</span>&nbsp;<span class="ident" id="3099419">err</span>&nbsp;<span class="op" id="3099423">:=</span>&nbsp;<span class="ident" id="3099426">io</span><span class="op" id="3099428">.</span><span class="ident" id="3099429">ReadFull</span><span class="op" id="3099437">(</span><span class="ident" id="3099438">c</span><span class="op" id="3099439">,</span>&nbsp;<span class="ident" id="3099441">b</span><span class="op" id="3099442">[</span><span class="op" id="3099443">:</span><span class="num" id="3099444">2</span><span class="op" id="3099445">]</span><span class="op" id="3099446">)</span><span class="op" id="3099447">;</span>&nbsp;<span class="ident" id="3099449">err</span>&nbsp;<span class="op" id="3099453">!=</span>&nbsp;<span class="ident" id="3099456">nil</span>&nbsp;<span class="op" id="3099460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099464">return</span>&nbsp;<span class="ident" id="3099471">nil</span><span class="op" id="3099474">,</span>&nbsp;<span class="ident" id="3099476">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099481">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099484">l</span>&nbsp;<span class="op" id="3099486">:=</span>&nbsp;<span class="builtintype" id="3099489">int</span><span class="op" id="3099492">(</span><span class="ident" id="3099493">b</span><span class="op" id="3099494">[</span><span class="num" id="3099495">0</span><span class="op" id="3099496">]</span><span class="op" id="3099497">)</span><span class="op" id="3099498">&lt;&lt;</span><span class="num" id="3099500">8</span>&nbsp;<span class="op" id="3099502">|</span>&nbsp;<span class="builtintype" id="3099504">int</span><span class="op" id="3099507">(</span><span class="ident" id="3099508">b</span><span class="op" id="3099509">[</span><span class="num" id="3099510">1</span><span class="op" id="3099511">]</span><span class="op" id="3099512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099515">if</span>&nbsp;<span class="ident" id="3099518">l</span>&nbsp;<span class="op" id="3099520">&gt;</span>&nbsp;<span class="builtinfunc" id="3099522">len</span><span class="op" id="3099525">(</span><span class="ident" id="3099526">b</span><span class="op" id="3099527">)</span>&nbsp;<span class="op" id="3099529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099533">b</span>&nbsp;<span class="op" id="3099535">=</span>&nbsp;<span class="builtinfunc" id="3099537">make</span><span class="op" id="3099541">(</span><span class="op" id="3099542">[</span><span class="op" id="3099543">]</span><span class="builtintype" id="3099544">byte</span><span class="op" id="3099548">,</span>&nbsp;<span class="ident" id="3099550">l</span><span class="op" id="3099551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099557">n</span><span class="op" id="3099558">,</span>&nbsp;<span class="ident" id="3099560">err</span>&nbsp;<span class="op" id="3099564">:=</span>&nbsp;<span class="ident" id="3099567">io</span><span class="op" id="3099569">.</span><span class="ident" id="3099570">ReadFull</span><span class="op" id="3099578">(</span><span class="ident" id="3099579">c</span><span class="op" id="3099580">,</span>&nbsp;<span class="ident" id="3099582">b</span><span class="op" id="3099583">[</span><span class="op" id="3099584">:</span><span class="ident" id="3099585">l</span><span class="op" id="3099586">]</span><span class="op" id="3099587">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099590">if</span>&nbsp;<span class="ident" id="3099593">err</span>&nbsp;<span class="op" id="3099597">!=</span>&nbsp;<span class="ident" id="3099600">nil</span>&nbsp;<span class="op" id="3099604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099608">return</span>&nbsp;<span class="ident" id="3099615">nil</span><span class="op" id="3099618">,</span>&nbsp;<span class="ident" id="3099620">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099628">msg</span>&nbsp;<span class="op" id="3099632">:=</span>&nbsp;<span class="op" id="3099635">&amp;</span><span class="ident" id="3099636">dnsMsg</span><span class="op" id="3099642">{</span><span class="op" id="3099643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099646">if</span>&nbsp;<span class="op" id="3099649">!</span><span class="ident" id="3099650">msg</span><span class="op" id="3099653">.</span><span class="ident" id="3099654">Unpack</span><span class="op" id="3099660">(</span><span class="ident" id="3099661">b</span><span class="op" id="3099662">[</span><span class="op" id="3099663">:</span><span class="ident" id="3099664">n</span><span class="op" id="3099665">]</span><span class="op" id="3099666">)</span>&nbsp;<span class="op" id="3099668">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099672">return</span>&nbsp;<span class="ident" id="3099679">nil</span><span class="op" id="3099682">,</span>&nbsp;<span class="ident" id="3099684">errors</span><span class="op" id="3099690">.</span><span class="ident" id="3099691">New</span><span class="op" id="3099694">(</span><span class="string" id="3099695">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3099725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099731">return</span>&nbsp;<span class="ident" id="3099738">msg</span><span class="op" id="3099741">,</span>&nbsp;<span class="ident" id="3099743">nil</span><br>
<span class="lineno"></span><span class="op" id="3099747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3099750">func</span>&nbsp;<span class="op" id="3099755">(</span><span class="ident" id="3099756">c</span>&nbsp;<span class="op" id="3099758">*</span><span class="ident" id="3099759">TCPConn</span><span class="op" id="3099766">)</span>&nbsp;<span class="ident" id="3099768">writeDNSQuery</span><span class="op" id="3099781">(</span><span class="ident" id="3099782">msg</span>&nbsp;<span class="op" id="3099786">*</span><span class="ident" id="3099787">dnsMsg</span><span class="op" id="3099793">)</span>&nbsp;<span class="builtintype" id="3099795">error</span>&nbsp;<span class="op" id="3099801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099804">b</span><span class="op" id="3099805">,</span>&nbsp;<span class="ident" id="3099807">ok</span>&nbsp;<span class="op" id="3099810">:=</span>&nbsp;<span class="ident" id="3099813">msg</span><span class="op" id="3099816">.</span><span class="ident" id="3099817">Pack</span><span class="op" id="3099821">(</span><span class="op" id="3099822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099825">if</span>&nbsp;<span class="op" id="3099828">!</span><span class="ident" id="3099829">ok</span>&nbsp;<span class="op" id="3099832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099836">return</span>&nbsp;<span class="ident" id="3099843">errors</span><span class="op" id="3099849">.</span><span class="ident" id="3099850">New</span><span class="op" id="3099853">(</span><span class="string" id="3099854">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3099882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3099885">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099888">l</span>&nbsp;<span class="op" id="3099890">:=</span>&nbsp;<span class="builtintype" id="3099893">uint16</span><span class="op" id="3099899">(</span><span class="builtinfunc" id="3099900">len</span><span class="op" id="3099903">(</span><span class="ident" id="3099904">b</span><span class="op" id="3099905">)</span><span class="op" id="3099906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099909">b</span>&nbsp;<span class="op" id="3099911">=</span>&nbsp;<span class="builtinfunc" id="3099913">append</span><span class="op" id="3099919">(</span><span class="op" id="3099920">[</span><span class="op" id="3099921">]</span><span class="builtintype" id="3099922">byte</span><span class="op" id="3099926">{</span><span class="builtintype" id="3099927">byte</span><span class="op" id="3099931">(</span><span class="ident" id="3099932">l</span>&nbsp;<span class="op" id="3099934">&gt;&gt;</span>&nbsp;<span class="num" id="3099937">8</span><span class="op" id="3099938">)</span><span class="op" id="3099939">,</span>&nbsp;<span class="builtintype" id="3099941">byte</span><span class="op" id="3099945">(</span><span class="ident" id="3099946">l</span><span class="op" id="3099947">)</span><span class="op" id="3099948">}</span><span class="op" id="3099949">,</span>&nbsp;<span class="ident" id="3099951">b</span><span class="op" id="3099952">...</span><span class="op" id="3099955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099958">if</span>&nbsp;<span class="ident" id="3099961">_</span><span class="op" id="3099962">,</span>&nbsp;<span class="ident" id="3099964">err</span>&nbsp;<span class="op" id="3099968">:=</span>&nbsp;<span class="ident" id="3099971">c</span><span class="op" id="3099972">.</span><span class="ident" id="3099973">Write</span><span class="op" id="3099978">(</span><span class="ident" id="3099979">b</span><span class="op" id="3099980">)</span><span class="op" id="3099981">;</span>&nbsp;<span class="ident" id="3099983">err</span>&nbsp;<span class="op" id="3099987">!=</span>&nbsp;<span class="ident" id="3099990">nil</span>&nbsp;<span class="op" id="3099994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3099998">return</span>&nbsp;<span class="ident" id="3100005">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100010">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100013">return</span>&nbsp;<span class="ident" id="3100020">nil</span><br>
<span class="lineno"></span><span class="op" id="3100024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3100027">func</span>&nbsp;<span class="op" id="3100032">(</span><span class="ident" id="3100033">d</span>&nbsp;<span class="op" id="3100035">*</span><span class="ident" id="3100036">Dialer</span><span class="op" id="3100042">)</span>&nbsp;<span class="ident" id="3100044">dialDNS</span><span class="op" id="3100051">(</span><span class="ident" id="3100052">network</span><span class="op" id="3100059">,</span>&nbsp;<span class="ident" id="3100061">server</span>&nbsp;<span class="builtintype" id="3100068">string</span><span class="op" id="3100074">)</span>&nbsp;<span class="op" id="3100076">(</span><span class="ident" id="3100077">dnsConn</span><span class="op" id="3100084">,</span>&nbsp;<span class="builtintype" id="3100086">error</span><span class="op" id="3100091">)</span>&nbsp;<span class="op" id="3100093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100096">switch</span>&nbsp;<span class="ident" id="3100103">network</span>&nbsp;<span class="op" id="3100111">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100114">case</span>&nbsp;<span class="string" id="3100119">&#34;tcp&#34;</span><span class="op" id="3100124">,</span>&nbsp;<span class="string" id="3100126">&#34;tcp4&#34;</span><span class="op" id="3100132">,</span>&nbsp;<span class="string" id="3100134">&#34;tcp6&#34;</span><span class="op" id="3100140">,</span>&nbsp;<span class="string" id="3100142">&#34;udp&#34;</span><span class="op" id="3100147">,</span>&nbsp;<span class="string" id="3100149">&#34;udp4&#34;</span><span class="op" id="3100155">,</span>&nbsp;<span class="string" id="3100157">&#34;udp6&#34;</span><span class="op" id="3100163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100166">default</span><span class="op" id="3100173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100177">return</span>&nbsp;<span class="ident" id="3100184">nil</span><span class="op" id="3100187">,</span>&nbsp;<span class="ident" id="3100189">UnknownNetworkError</span><span class="op" id="3100208">(</span><span class="ident" id="3100209">network</span><span class="op" id="3100216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100222">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100282">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100343">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100405">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3100460">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100517">c</span><span class="op" id="3100518">,</span>&nbsp;<span class="ident" id="3100520">err</span>&nbsp;<span class="op" id="3100524">:=</span>&nbsp;<span class="ident" id="3100527">d</span><span class="op" id="3100528">.</span><span class="ident" id="3100529">Dial</span><span class="op" id="3100533">(</span><span class="ident" id="3100534">network</span><span class="op" id="3100541">,</span>&nbsp;<span class="ident" id="3100543">server</span><span class="op" id="3100549">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100552">if</span>&nbsp;<span class="ident" id="3100555">err</span>&nbsp;<span class="op" id="3100559">!=</span>&nbsp;<span class="ident" id="3100562">nil</span>&nbsp;<span class="op" id="3100566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100570">return</span>&nbsp;<span class="ident" id="3100577">nil</span><span class="op" id="3100580">,</span>&nbsp;<span class="ident" id="3100582">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100590">switch</span>&nbsp;<span class="ident" id="3100597">network</span>&nbsp;<span class="op" id="3100605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100608">case</span>&nbsp;<span class="string" id="3100613">&#34;tcp&#34;</span><span class="op" id="3100618">,</span>&nbsp;<span class="string" id="3100620">&#34;tcp4&#34;</span><span class="op" id="3100626">,</span>&nbsp;<span class="string" id="3100628">&#34;tcp6&#34;</span><span class="op" id="3100634">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100638">return</span>&nbsp;<span class="ident" id="3100645">c</span><span class="op" id="3100646">.</span><span class="op" id="3100647">(</span><span class="op" id="3100648">*</span><span class="ident" id="3100649">TCPConn</span><span class="op" id="3100656">)</span><span class="op" id="3100657">,</span>&nbsp;<span class="ident" id="3100659">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100664">case</span>&nbsp;<span class="string" id="3100669">&#34;udp&#34;</span><span class="op" id="3100674">,</span>&nbsp;<span class="string" id="3100676">&#34;udp4&#34;</span><span class="op" id="3100682">,</span>&nbsp;<span class="string" id="3100684">&#34;udp6&#34;</span><span class="op" id="3100690">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100694">return</span>&nbsp;<span class="ident" id="3100701">c</span><span class="op" id="3100702">.</span><span class="op" id="3100703">(</span><span class="op" id="3100704">*</span><span class="ident" id="3100705">UDPConn</span><span class="op" id="3100712">)</span><span class="op" id="3100713">,</span>&nbsp;<span class="ident" id="3100715">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3100723">panic</span><span class="op" id="3100728">(</span><span class="string" id="3100729">&#34;unreachable&#34;</span><span class="op" id="3100742">)</span><br>
<span class="lineno">120</span><span class="op" id="3100744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3100747">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3100817">func</span>&nbsp;<span class="ident" id="3100822">exchange</span><span class="op" id="3100830">(</span><span class="ident" id="3100831">server</span><span class="op" id="3100837">,</span>&nbsp;<span class="ident" id="3100839">name</span>&nbsp;<span class="builtintype" id="3100844">string</span><span class="op" id="3100850">,</span>&nbsp;<span class="ident" id="3100852">qtype</span>&nbsp;<span class="builtintype" id="3100858">uint16</span><span class="op" id="3100864">,</span>&nbsp;<span class="ident" id="3100866">timeout</span>&nbsp;<span class="ident" id="3100874">time</span><span class="op" id="3100878">.</span><span class="ident" id="3100879">Duration</span><span class="op" id="3100887">)</span>&nbsp;<span class="op" id="3100889">(</span><span class="op" id="3100890">*</span><span class="ident" id="3100891">dnsMsg</span><span class="op" id="3100897">,</span>&nbsp;<span class="builtintype" id="3100899">error</span><span class="op" id="3100904">)</span>&nbsp;<span class="op" id="3100906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100909">d</span>&nbsp;<span class="op" id="3100911">:=</span>&nbsp;<span class="ident" id="3100914">Dialer</span><span class="op" id="3100920">{</span><span class="ident" id="3100921">Timeout</span><span class="op" id="3100928">:</span>&nbsp;<span class="ident" id="3100930">timeout</span><span class="op" id="3100937">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100940">out</span>&nbsp;<span class="op" id="3100944">:=</span>&nbsp;<span class="ident" id="3100947">dnsMsg</span><span class="op" id="3100953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100957">dnsMsgHdr</span><span class="op" id="3100966">:</span>&nbsp;<span class="ident" id="3100968">dnsMsgHdr</span><span class="op" id="3100977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100982">recursion_desired</span><span class="op" id="3100999">:</span>&nbsp;<span class="builtintype" id="3101001">true</span><span class="op" id="3101005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101009">}</span><span class="op" id="3101010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101014">question</span><span class="op" id="3101022">:</span>&nbsp;<span class="op" id="3101024">[</span><span class="op" id="3101025">]</span><span class="ident" id="3101026">dnsQuestion</span><span class="op" id="3101037">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101042">{</span><span class="ident" id="3101043">name</span><span class="op" id="3101047">,</span>&nbsp;<span class="ident" id="3101049">qtype</span><span class="op" id="3101054">,</span>&nbsp;<span class="ident" id="3101056">dnsClassINET</span><span class="op" id="3101068">}</span><span class="op" id="3101069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101073">}</span><span class="op" id="3101074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101080">for</span>&nbsp;<span class="ident" id="3101084">_</span><span class="op" id="3101085">,</span>&nbsp;<span class="ident" id="3101087">network</span>&nbsp;<span class="op" id="3101095">:=</span>&nbsp;<span class="keyword" id="3101098">range</span>&nbsp;<span class="op" id="3101104">[</span><span class="op" id="3101105">]</span><span class="builtintype" id="3101106">string</span><span class="op" id="3101112">{</span><span class="string" id="3101113">&#34;udp&#34;</span><span class="op" id="3101118">,</span>&nbsp;<span class="string" id="3101120">&#34;tcp&#34;</span><span class="op" id="3101125">}</span>&nbsp;<span class="op" id="3101127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101131">c</span><span class="op" id="3101132">,</span>&nbsp;<span class="ident" id="3101134">err</span>&nbsp;<span class="op" id="3101138">:=</span>&nbsp;<span class="ident" id="3101141">d</span><span class="op" id="3101142">.</span><span class="ident" id="3101143">dialDNS</span><span class="op" id="3101150">(</span><span class="ident" id="3101151">network</span><span class="op" id="3101158">,</span>&nbsp;<span class="ident" id="3101160">server</span><span class="op" id="3101166">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101170">if</span>&nbsp;<span class="ident" id="3101173">err</span>&nbsp;<span class="op" id="3101177">!=</span>&nbsp;<span class="ident" id="3101180">nil</span>&nbsp;<span class="op" id="3101184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101189">return</span>&nbsp;<span class="ident" id="3101196">nil</span><span class="op" id="3101199">,</span>&nbsp;<span class="ident" id="3101201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101211">defer</span>&nbsp;<span class="ident" id="3101217">c</span><span class="op" id="3101218">.</span><span class="ident" id="3101219">Close</span><span class="op" id="3101224">(</span><span class="op" id="3101225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101229">if</span>&nbsp;<span class="ident" id="3101232">timeout</span>&nbsp;<span class="op" id="3101240">&gt;</span>&nbsp;<span class="num" id="3101242">0</span>&nbsp;<span class="op" id="3101244">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101249">c</span><span class="op" id="3101250">.</span><span class="ident" id="3101251">SetDeadline</span><span class="op" id="3101262">(</span><span class="ident" id="3101263">time</span><span class="op" id="3101267">.</span><span class="ident" id="3101268">Now</span><span class="op" id="3101271">(</span><span class="op" id="3101272">)</span><span class="op" id="3101273">.</span><span class="ident" id="3101274">Add</span><span class="op" id="3101277">(</span><span class="ident" id="3101278">timeout</span><span class="op" id="3101285">)</span><span class="op" id="3101286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101294">out</span><span class="op" id="3101297">.</span><span class="ident" id="3101298">id</span>&nbsp;<span class="op" id="3101301">=</span>&nbsp;<span class="builtintype" id="3101303">uint16</span><span class="op" id="3101309">(</span><span class="ident" id="3101310">rand</span><span class="op" id="3101314">.</span><span class="ident" id="3101315">Int</span><span class="op" id="3101318">(</span><span class="op" id="3101319">)</span><span class="op" id="3101320">)</span>&nbsp;<span class="op" id="3101322">^</span>&nbsp;<span class="builtintype" id="3101324">uint16</span><span class="op" id="3101330">(</span><span class="ident" id="3101331">time</span><span class="op" id="3101335">.</span><span class="ident" id="3101336">Now</span><span class="op" id="3101339">(</span><span class="op" id="3101340">)</span><span class="op" id="3101341">.</span><span class="ident" id="3101342">UnixNano</span><span class="op" id="3101350">(</span><span class="op" id="3101351">)</span><span class="op" id="3101352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101356">if</span>&nbsp;<span class="ident" id="3101359">err</span>&nbsp;<span class="op" id="3101363">:=</span>&nbsp;<span class="ident" id="3101366">c</span><span class="op" id="3101367">.</span><span class="ident" id="3101368">writeDNSQuery</span><span class="op" id="3101381">(</span><span class="op" id="3101382">&amp;</span><span class="ident" id="3101383">out</span><span class="op" id="3101386">)</span><span class="op" id="3101387">;</span>&nbsp;<span class="ident" id="3101389">err</span>&nbsp;<span class="op" id="3101393">!=</span>&nbsp;<span class="ident" id="3101396">nil</span>&nbsp;<span class="op" id="3101400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101405">return</span>&nbsp;<span class="ident" id="3101412">nil</span><span class="op" id="3101415">,</span>&nbsp;<span class="ident" id="3101417">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101427">in</span><span class="op" id="3101429">,</span>&nbsp;<span class="ident" id="3101431">err</span>&nbsp;<span class="op" id="3101435">:=</span>&nbsp;<span class="ident" id="3101438">c</span><span class="op" id="3101439">.</span><span class="ident" id="3101440">readDNSResponse</span><span class="op" id="3101455">(</span><span class="op" id="3101456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101460">if</span>&nbsp;<span class="ident" id="3101463">err</span>&nbsp;<span class="op" id="3101467">!=</span>&nbsp;<span class="ident" id="3101470">nil</span>&nbsp;<span class="op" id="3101474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101479">return</span>&nbsp;<span class="ident" id="3101486">nil</span><span class="op" id="3101489">,</span>&nbsp;<span class="ident" id="3101491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101497">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101501">if</span>&nbsp;<span class="ident" id="3101504">in</span><span class="op" id="3101506">.</span><span class="ident" id="3101507">id</span>&nbsp;<span class="op" id="3101510">!=</span>&nbsp;<span class="ident" id="3101513">out</span><span class="op" id="3101516">.</span><span class="ident" id="3101517">id</span>&nbsp;<span class="op" id="3101520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101525">return</span>&nbsp;<span class="ident" id="3101532">nil</span><span class="op" id="3101535">,</span>&nbsp;<span class="ident" id="3101537">errors</span><span class="op" id="3101543">.</span><span class="ident" id="3101544">New</span><span class="op" id="3101547">(</span><span class="string" id="3101548">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3101573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101581">if</span>&nbsp;<span class="ident" id="3101584">in</span><span class="op" id="3101586">.</span><span class="ident" id="3101587">truncated</span>&nbsp;<span class="op" id="3101597">{</span>&nbsp;<span class="comment" id="3101599">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101618">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101633">return</span>&nbsp;<span class="ident" id="3101640">in</span><span class="op" id="3101642">,</span>&nbsp;<span class="ident" id="3101644">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101652">return</span>&nbsp;<span class="ident" id="3101659">nil</span><span class="op" id="3101662">,</span>&nbsp;<span class="ident" id="3101664">errors</span><span class="op" id="3101670">.</span><span class="ident" id="3101671">New</span><span class="op" id="3101674">(</span><span class="string" id="3101675">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3101702">)</span><br>
<span class="lineno"></span><span class="op" id="3101704">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3101707">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3101762">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3101811">func</span>&nbsp;<span class="ident" id="3101816">tryOneName</span><span class="op" id="3101826">(</span><span class="ident" id="3101827">cfg</span>&nbsp;<span class="op" id="3101831">*</span><span class="ident" id="3101832">dnsConfig</span><span class="op" id="3101841">,</span>&nbsp;<span class="ident" id="3101843">name</span>&nbsp;<span class="builtintype" id="3101848">string</span><span class="op" id="3101854">,</span>&nbsp;<span class="ident" id="3101856">qtype</span>&nbsp;<span class="builtintype" id="3101862">uint16</span><span class="op" id="3101868">)</span>&nbsp;<span class="op" id="3101870">(</span><span class="builtintype" id="3101871">string</span><span class="op" id="3101877">,</span>&nbsp;<span class="op" id="3101879">[</span><span class="op" id="3101880">]</span><span class="ident" id="3101881">dnsRR</span><span class="op" id="3101886">,</span>&nbsp;<span class="builtintype" id="3101888">error</span><span class="op" id="3101893">)</span>&nbsp;<span class="op" id="3101895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101898">if</span>&nbsp;<span class="builtinfunc" id="3101901">len</span><span class="op" id="3101904">(</span><span class="ident" id="3101905">cfg</span><span class="op" id="3101908">.</span><span class="ident" id="3101909">servers</span><span class="op" id="3101916">)</span>&nbsp;<span class="op" id="3101918">==</span>&nbsp;<span class="num" id="3101921">0</span>&nbsp;<span class="op" id="3101923">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101927">return</span>&nbsp;<span class="string" id="3101934">&#34;&#34;</span><span class="op" id="3101936">,</span>&nbsp;<span class="ident" id="3101938">nil</span><span class="op" id="3101941">,</span>&nbsp;<span class="op" id="3101943">&amp;</span><span class="ident" id="3101944">DNSError</span><span class="op" id="3101952">{</span><span class="ident" id="3101953">Err</span><span class="op" id="3101956">:</span>&nbsp;<span class="string" id="3101958">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3101974">,</span>&nbsp;<span class="ident" id="3101976">Name</span><span class="op" id="3101980">:</span>&nbsp;<span class="ident" id="3101982">name</span><span class="op" id="3101986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101992">if</span>&nbsp;<span class="builtinfunc" id="3101995">len</span><span class="op" id="3101998">(</span><span class="ident" id="3101999">name</span><span class="op" id="3102003">)</span>&nbsp;<span class="op" id="3102005">&gt;=</span>&nbsp;<span class="num" id="3102008">256</span>&nbsp;<span class="op" id="3102012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102016">return</span>&nbsp;<span class="string" id="3102023">&#34;&#34;</span><span class="op" id="3102025">,</span>&nbsp;<span class="ident" id="3102027">nil</span><span class="op" id="3102030">,</span>&nbsp;<span class="op" id="3102032">&amp;</span><span class="ident" id="3102033">DNSError</span><span class="op" id="3102041">{</span><span class="ident" id="3102042">Err</span><span class="op" id="3102045">:</span>&nbsp;<span class="string" id="3102047">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3102066">,</span>&nbsp;<span class="ident" id="3102068">Name</span><span class="op" id="3102072">:</span>&nbsp;<span class="ident" id="3102074">name</span><span class="op" id="3102078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102081">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102084">timeout</span>&nbsp;<span class="op" id="3102092">:=</span>&nbsp;<span class="ident" id="3102095">time</span><span class="op" id="3102099">.</span><span class="ident" id="3102100">Duration</span><span class="op" id="3102108">(</span><span class="ident" id="3102109">cfg</span><span class="op" id="3102112">.</span><span class="ident" id="3102113">timeout</span><span class="op" id="3102120">)</span>&nbsp;<span class="op" id="3102122">*</span>&nbsp;<span class="ident" id="3102124">time</span><span class="op" id="3102128">.</span><span class="ident" id="3102129">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102137">var</span>&nbsp;<span class="ident" id="3102141">lastErr</span>&nbsp;<span class="builtintype" id="3102149">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102156">for</span>&nbsp;<span class="ident" id="3102160">i</span>&nbsp;<span class="op" id="3102162">:=</span>&nbsp;<span class="num" id="3102165">0</span><span class="op" id="3102166">;</span>&nbsp;<span class="ident" id="3102168">i</span>&nbsp;<span class="op" id="3102170">&lt;</span>&nbsp;<span class="ident" id="3102172">cfg</span><span class="op" id="3102175">.</span><span class="ident" id="3102176">attempts</span><span class="op" id="3102184">;</span>&nbsp;<span class="ident" id="3102186">i</span><span class="op" id="3102187">++</span>&nbsp;<span class="op" id="3102190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102194">for</span>&nbsp;<span class="ident" id="3102198">_</span><span class="op" id="3102199">,</span>&nbsp;<span class="ident" id="3102201">server</span>&nbsp;<span class="op" id="3102208">:=</span>&nbsp;<span class="keyword" id="3102211">range</span>&nbsp;<span class="ident" id="3102217">cfg</span><span class="op" id="3102220">.</span><span class="ident" id="3102221">servers</span>&nbsp;<span class="op" id="3102229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102234">server</span>&nbsp;<span class="op" id="3102241">=</span>&nbsp;<span class="ident" id="3102243">JoinHostPort</span><span class="op" id="3102255">(</span><span class="ident" id="3102256">server</span><span class="op" id="3102262">,</span>&nbsp;<span class="string" id="3102264">&#34;53&#34;</span><span class="op" id="3102268">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102273">msg</span><span class="op" id="3102276">,</span>&nbsp;<span class="ident" id="3102278">err</span>&nbsp;<span class="op" id="3102282">:=</span>&nbsp;<span class="ident" id="3102285">exchange</span><span class="op" id="3102293">(</span><span class="ident" id="3102294">server</span><span class="op" id="3102300">,</span>&nbsp;<span class="ident" id="3102302">name</span><span class="op" id="3102306">,</span>&nbsp;<span class="ident" id="3102308">qtype</span><span class="op" id="3102313">,</span>&nbsp;<span class="ident" id="3102315">timeout</span><span class="op" id="3102322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102327">if</span>&nbsp;<span class="ident" id="3102330">err</span>&nbsp;<span class="op" id="3102334">!=</span>&nbsp;<span class="ident" id="3102337">nil</span>&nbsp;<span class="op" id="3102341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102347">lastErr</span>&nbsp;<span class="op" id="3102355">=</span>&nbsp;<span class="op" id="3102357">&amp;</span><span class="ident" id="3102358">DNSError</span><span class="op" id="3102366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102373">Err</span><span class="op" id="3102376">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102381">err</span><span class="op" id="3102384">.</span><span class="ident" id="3102385">Error</span><span class="op" id="3102390">(</span><span class="op" id="3102391">)</span><span class="op" id="3102392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102399">Name</span><span class="op" id="3102403">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3102407">name</span><span class="op" id="3102411">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102418">Server</span><span class="op" id="3102424">:</span>&nbsp;<span class="ident" id="3102426">server</span><span class="op" id="3102432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102444">if</span>&nbsp;<span class="ident" id="3102447">nerr</span><span class="op" id="3102451">,</span>&nbsp;<span class="ident" id="3102453">ok</span>&nbsp;<span class="op" id="3102456">:=</span>&nbsp;<span class="ident" id="3102459">err</span><span class="op" id="3102462">.</span><span class="op" id="3102463">(</span><span class="ident" id="3102464">Error</span><span class="op" id="3102469">)</span><span class="op" id="3102470">;</span>&nbsp;<span class="ident" id="3102472">ok</span>&nbsp;<span class="op" id="3102475">&amp;&amp;</span>&nbsp;<span class="ident" id="3102478">nerr</span><span class="op" id="3102482">.</span><span class="ident" id="3102483">Timeout</span><span class="op" id="3102490">(</span><span class="op" id="3102491">)</span>&nbsp;<span class="op" id="3102493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102500">lastErr</span><span class="op" id="3102507">.</span><span class="op" id="3102508">(</span><span class="op" id="3102509">*</span><span class="ident" id="3102510">DNSError</span><span class="op" id="3102518">)</span><span class="op" id="3102519">.</span><span class="ident" id="3102520">IsTimeout</span>&nbsp;<span class="op" id="3102530">=</span>&nbsp;<span class="builtintype" id="3102532">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102541">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102547">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102564">cname</span><span class="op" id="3102569">,</span>&nbsp;<span class="ident" id="3102571">addrs</span><span class="op" id="3102576">,</span>&nbsp;<span class="ident" id="3102578">err</span>&nbsp;<span class="op" id="3102582">:=</span>&nbsp;<span class="ident" id="3102585">answer</span><span class="op" id="3102591">(</span><span class="ident" id="3102592">name</span><span class="op" id="3102596">,</span>&nbsp;<span class="ident" id="3102598">server</span><span class="op" id="3102604">,</span>&nbsp;<span class="ident" id="3102606">msg</span><span class="op" id="3102609">,</span>&nbsp;<span class="ident" id="3102611">qtype</span><span class="op" id="3102616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102621">if</span>&nbsp;<span class="ident" id="3102624">err</span>&nbsp;<span class="op" id="3102628">==</span>&nbsp;<span class="ident" id="3102631">nil</span>&nbsp;<span class="op" id="3102635">||</span>&nbsp;<span class="ident" id="3102638">err</span><span class="op" id="3102641">.</span><span class="op" id="3102642">(</span><span class="op" id="3102643">*</span><span class="ident" id="3102644">DNSError</span><span class="op" id="3102652">)</span><span class="op" id="3102653">.</span><span class="ident" id="3102654">Err</span>&nbsp;<span class="op" id="3102658">==</span>&nbsp;<span class="ident" id="3102661">noSuchHost</span>&nbsp;<span class="op" id="3102672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102678">return</span>&nbsp;<span class="ident" id="3102685">cname</span><span class="op" id="3102690">,</span>&nbsp;<span class="ident" id="3102692">addrs</span><span class="op" id="3102697">,</span>&nbsp;<span class="ident" id="3102699">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102711">lastErr</span>&nbsp;<span class="op" id="3102719">=</span>&nbsp;<span class="ident" id="3102721">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102733">return</span>&nbsp;<span class="string" id="3102740">&#34;&#34;</span><span class="op" id="3102742">,</span>&nbsp;<span class="ident" id="3102744">nil</span><span class="op" id="3102747">,</span>&nbsp;<span class="ident" id="3102749">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3102757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3102760">func</span>&nbsp;<span class="ident" id="3102765">convertRR_A</span><span class="op" id="3102776">(</span><span class="ident" id="3102777">records</span>&nbsp;<span class="op" id="3102785">[</span><span class="op" id="3102786">]</span><span class="ident" id="3102787">dnsRR</span><span class="op" id="3102792">)</span>&nbsp;<span class="op" id="3102794">[</span><span class="op" id="3102795">]</span><span class="ident" id="3102796">IP</span>&nbsp;<span class="op" id="3102799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102802">addrs</span>&nbsp;<span class="op" id="3102808">:=</span>&nbsp;<span class="builtinfunc" id="3102811">make</span><span class="op" id="3102815">(</span><span class="op" id="3102816">[</span><span class="op" id="3102817">]</span><span class="ident" id="3102818">IP</span><span class="op" id="3102820">,</span>&nbsp;<span class="builtinfunc" id="3102822">len</span><span class="op" id="3102825">(</span><span class="ident" id="3102826">records</span><span class="op" id="3102833">)</span><span class="op" id="3102834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102837">for</span>&nbsp;<span class="ident" id="3102841">i</span><span class="op" id="3102842">,</span>&nbsp;<span class="ident" id="3102844">rr</span>&nbsp;<span class="op" id="3102847">:=</span>&nbsp;<span class="keyword" id="3102850">range</span>&nbsp;<span class="ident" id="3102856">records</span>&nbsp;<span class="op" id="3102864">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102868">a</span>&nbsp;<span class="op" id="3102870">:=</span>&nbsp;<span class="ident" id="3102873">rr</span><span class="op" id="3102875">.</span><span class="op" id="3102876">(</span><span class="op" id="3102877">*</span><span class="ident" id="3102878">dnsRR_A</span><span class="op" id="3102885">)</span><span class="op" id="3102886">.</span><span class="ident" id="3102887">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3102891">addrs</span><span class="op" id="3102896">[</span><span class="ident" id="3102897">i</span><span class="op" id="3102898">]</span>&nbsp;<span class="op" id="3102900">=</span>&nbsp;<span class="ident" id="3102902">IPv4</span><span class="op" id="3102906">(</span><span class="builtintype" id="3102907">byte</span><span class="op" id="3102911">(</span><span class="ident" id="3102912">a</span><span class="op" id="3102913">&gt;&gt;</span><span class="num" id="3102915">24</span><span class="op" id="3102917">)</span><span class="op" id="3102918">,</span>&nbsp;<span class="builtintype" id="3102920">byte</span><span class="op" id="3102924">(</span><span class="ident" id="3102925">a</span><span class="op" id="3102926">&gt;&gt;</span><span class="num" id="3102928">16</span><span class="op" id="3102930">)</span><span class="op" id="3102931">,</span>&nbsp;<span class="builtintype" id="3102933">byte</span><span class="op" id="3102937">(</span><span class="ident" id="3102938">a</span><span class="op" id="3102939">&gt;&gt;</span><span class="num" id="3102941">8</span><span class="op" id="3102942">)</span><span class="op" id="3102943">,</span>&nbsp;<span class="builtintype" id="3102945">byte</span><span class="op" id="3102949">(</span><span class="ident" id="3102950">a</span><span class="op" id="3102951">)</span><span class="op" id="3102952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3102955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3102958">return</span>&nbsp;<span class="ident" id="3102965">addrs</span><br>
<span class="lineno"></span><span class="op" id="3102971">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3102974">func</span>&nbsp;<span class="ident" id="3102979">convertRR_AAAA</span><span class="op" id="3102993">(</span><span class="ident" id="3102994">records</span>&nbsp;<span class="op" id="3103002">[</span><span class="op" id="3103003">]</span><span class="ident" id="3103004">dnsRR</span><span class="op" id="3103009">)</span>&nbsp;<span class="op" id="3103011">[</span><span class="op" id="3103012">]</span><span class="ident" id="3103013">IP</span>&nbsp;<span class="op" id="3103016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103019">addrs</span>&nbsp;<span class="op" id="3103025">:=</span>&nbsp;<span class="builtinfunc" id="3103028">make</span><span class="op" id="3103032">(</span><span class="op" id="3103033">[</span><span class="op" id="3103034">]</span><span class="ident" id="3103035">IP</span><span class="op" id="3103037">,</span>&nbsp;<span class="builtinfunc" id="3103039">len</span><span class="op" id="3103042">(</span><span class="ident" id="3103043">records</span><span class="op" id="3103050">)</span><span class="op" id="3103051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103054">for</span>&nbsp;<span class="ident" id="3103058">i</span><span class="op" id="3103059">,</span>&nbsp;<span class="ident" id="3103061">rr</span>&nbsp;<span class="op" id="3103064">:=</span>&nbsp;<span class="keyword" id="3103067">range</span>&nbsp;<span class="ident" id="3103073">records</span>&nbsp;<span class="op" id="3103081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103085">a</span>&nbsp;<span class="op" id="3103087">:=</span>&nbsp;<span class="builtinfunc" id="3103090">make</span><span class="op" id="3103094">(</span><span class="ident" id="3103095">IP</span><span class="op" id="3103097">,</span>&nbsp;<span class="ident" id="3103099">IPv6len</span><span class="op" id="3103106">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3103110">copy</span><span class="op" id="3103114">(</span><span class="ident" id="3103115">a</span><span class="op" id="3103116">,</span>&nbsp;<span class="ident" id="3103118">rr</span><span class="op" id="3103120">.</span><span class="op" id="3103121">(</span><span class="op" id="3103122">*</span><span class="ident" id="3103123">dnsRR_AAAA</span><span class="op" id="3103133">)</span><span class="op" id="3103134">.</span><span class="ident" id="3103135">AAAA</span><span class="op" id="3103139">[</span><span class="op" id="3103140">:</span><span class="op" id="3103141">]</span><span class="op" id="3103142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103146">addrs</span><span class="op" id="3103151">[</span><span class="ident" id="3103152">i</span><span class="op" id="3103153">]</span>&nbsp;<span class="op" id="3103155">=</span>&nbsp;<span class="ident" id="3103157">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3103160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103163">return</span>&nbsp;<span class="ident" id="3103170">addrs</span><br>
<span class="lineno"></span><span class="op" id="3103176">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3103179">var</span>&nbsp;<span class="ident" id="3103183">cfg</span>&nbsp;<span class="keyword" id="3103187">struct</span>&nbsp;<span class="op" id="3103194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103197">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103207">chan</span>&nbsp;<span class="keyword" id="3103212">struct</span><span class="op" id="3103218">{</span><span class="op" id="3103219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103222">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3103232">sync</span><span class="op" id="3103236">.</span><span class="ident" id="3103237">RWMutex</span>&nbsp;<span class="comment" id="3103245">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103279">dnsConfig</span>&nbsp;<span class="op" id="3103289">*</span><span class="ident" id="3103290">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103301">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3103311">error</span><br>
<span class="lineno"></span><span class="op" id="3103317">}</span><br>
<span class="lineno"></span><span class="keyword" id="3103319">var</span>&nbsp;<span class="ident" id="3103323">onceLoadConfig</span>&nbsp;<span class="ident" id="3103338">sync</span><span class="op" id="3103342">.</span><span class="ident" id="3103343">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3103349">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3103400">func</span>&nbsp;<span class="ident" id="3103405">loadDefaultConfig</span><span class="op" id="3103422">(</span><span class="op" id="3103423">)</span>&nbsp;<span class="op" id="3103425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103428">loadConfig</span><span class="op" id="3103438">(</span><span class="string" id="3103439">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3103457">,</span>&nbsp;<span class="num" id="3103459">5</span><span class="op" id="3103460">*</span><span class="ident" id="3103461">time</span><span class="op" id="3103465">.</span><span class="ident" id="3103466">Second</span><span class="op" id="3103472">,</span>&nbsp;<span class="ident" id="3103474">nil</span><span class="op" id="3103477">)</span><br>
<span class="lineno"></span><span class="op" id="3103479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3103482">func</span>&nbsp;<span class="ident" id="3103487">loadConfig</span><span class="op" id="3103497">(</span><span class="ident" id="3103498">resolvConfPath</span>&nbsp;<span class="builtintype" id="3103513">string</span><span class="op" id="3103519">,</span>&nbsp;<span class="ident" id="3103521">reloadTime</span>&nbsp;<span class="ident" id="3103532">time</span><span class="op" id="3103536">.</span><span class="ident" id="3103537">Duration</span><span class="op" id="3103545">,</span>&nbsp;<span class="ident" id="3103547">quit</span>&nbsp;<span class="op" id="3103552">&lt;-</span><span class="keyword" id="3103554">chan</span>&nbsp;<span class="keyword" id="3103559">chan</span>&nbsp;<span class="keyword" id="3103564">struct</span><span class="op" id="3103570">{</span><span class="op" id="3103571">}</span><span class="op" id="3103572">)</span>&nbsp;<span class="op" id="3103574">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103577">var</span>&nbsp;<span class="ident" id="3103581">mtime</span>&nbsp;<span class="ident" id="3103587">time</span><span class="op" id="3103591">.</span><span class="ident" id="3103592">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103598">cfg</span><span class="op" id="3103601">.</span><span class="ident" id="3103602">ch</span>&nbsp;<span class="op" id="3103605">=</span>&nbsp;<span class="builtinfunc" id="3103607">make</span><span class="op" id="3103611">(</span><span class="keyword" id="3103612">chan</span>&nbsp;<span class="keyword" id="3103617">struct</span><span class="op" id="3103623">{</span><span class="op" id="3103624">}</span><span class="op" id="3103625">,</span>&nbsp;<span class="num" id="3103627">1</span><span class="op" id="3103628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103631">if</span>&nbsp;<span class="ident" id="3103634">fi</span><span class="op" id="3103636">,</span>&nbsp;<span class="ident" id="3103638">err</span>&nbsp;<span class="op" id="3103642">:=</span>&nbsp;<span class="ident" id="3103645">os</span><span class="op" id="3103647">.</span><span class="ident" id="3103648">Stat</span><span class="op" id="3103652">(</span><span class="ident" id="3103653">resolvConfPath</span><span class="op" id="3103667">)</span><span class="op" id="3103668">;</span>&nbsp;<span class="ident" id="3103670">err</span>&nbsp;<span class="op" id="3103674">!=</span>&nbsp;<span class="ident" id="3103677">nil</span>&nbsp;<span class="op" id="3103681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103685">cfg</span><span class="op" id="3103688">.</span><span class="ident" id="3103689">dnserr</span>&nbsp;<span class="op" id="3103696">=</span>&nbsp;<span class="ident" id="3103698">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3103703">}</span>&nbsp;<span class="keyword" id="3103705">else</span>&nbsp;<span class="op" id="3103710">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103714">mtime</span>&nbsp;<span class="op" id="3103720">=</span>&nbsp;<span class="ident" id="3103722">fi</span><span class="op" id="3103724">.</span><span class="ident" id="3103725">ModTime</span><span class="op" id="3103732">(</span><span class="op" id="3103733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103737">cfg</span><span class="op" id="3103740">.</span><span class="ident" id="3103741">dnsConfig</span><span class="op" id="3103750">,</span>&nbsp;<span class="ident" id="3103752">cfg</span><span class="op" id="3103755">.</span><span class="ident" id="3103756">dnserr</span>&nbsp;<span class="op" id="3103763">=</span>&nbsp;<span class="ident" id="3103765">dnsReadConfig</span><span class="op" id="3103778">(</span><span class="ident" id="3103779">resolvConfPath</span><span class="op" id="3103793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3103796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103799">go</span>&nbsp;<span class="keyword" id="3103802">func</span><span class="op" id="3103806">(</span><span class="op" id="3103807">)</span>&nbsp;<span class="op" id="3103809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103813">for</span>&nbsp;<span class="op" id="3103817">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103822">time</span><span class="op" id="3103826">.</span><span class="ident" id="3103827">Sleep</span><span class="op" id="3103832">(</span><span class="ident" id="3103833">reloadTime</span><span class="op" id="3103843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103848">select</span>&nbsp;<span class="op" id="3103855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103860">case</span>&nbsp;<span class="ident" id="3103865">qresp</span>&nbsp;<span class="op" id="3103871">:=</span>&nbsp;<span class="op" id="3103874">&lt;-</span><span class="ident" id="3103876">quit</span><span class="op" id="3103880">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103886">qresp</span>&nbsp;<span class="op" id="3103892">&lt;-</span>&nbsp;<span class="keyword" id="3103895">struct</span><span class="op" id="3103901">{</span><span class="op" id="3103902">}</span><span class="op" id="3103903">{</span><span class="op" id="3103904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103910">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3103920">case</span>&nbsp;<span class="op" id="3103925">&lt;-</span><span class="ident" id="3103927">cfg</span><span class="op" id="3103930">.</span><span class="ident" id="3103931">ch</span><span class="op" id="3103933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3103938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3103944">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3103996">fi</span><span class="op" id="3103998">,</span>&nbsp;<span class="ident" id="3104000">err</span>&nbsp;<span class="op" id="3104004">:=</span>&nbsp;<span class="ident" id="3104007">os</span><span class="op" id="3104009">.</span><span class="ident" id="3104010">Stat</span><span class="op" id="3104014">(</span><span class="ident" id="3104015">resolvConfPath</span><span class="op" id="3104029">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104034">if</span>&nbsp;<span class="ident" id="3104037">err</span>&nbsp;<span class="op" id="3104041">!=</span>&nbsp;<span class="ident" id="3104044">nil</span>&nbsp;<span class="op" id="3104048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104054">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104071">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104131">m</span>&nbsp;<span class="op" id="3104133">:=</span>&nbsp;<span class="ident" id="3104136">fi</span><span class="op" id="3104138">.</span><span class="ident" id="3104139">ModTime</span><span class="op" id="3104146">(</span><span class="op" id="3104147">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104152">if</span>&nbsp;<span class="ident" id="3104155">m</span><span class="op" id="3104156">.</span><span class="ident" id="3104157">Equal</span><span class="op" id="3104162">(</span><span class="ident" id="3104163">mtime</span><span class="op" id="3104168">)</span>&nbsp;<span class="op" id="3104170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104176">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104193">mtime</span>&nbsp;<span class="op" id="3104199">=</span>&nbsp;<span class="ident" id="3104201">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104206">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104258">ncfg</span><span class="op" id="3104262">,</span>&nbsp;<span class="ident" id="3104264">err</span>&nbsp;<span class="op" id="3104268">:=</span>&nbsp;<span class="ident" id="3104271">dnsReadConfig</span><span class="op" id="3104284">(</span><span class="ident" id="3104285">resolvConfPath</span><span class="op" id="3104299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104304">if</span>&nbsp;<span class="ident" id="3104307">err</span>&nbsp;<span class="op" id="3104311">!=</span>&nbsp;<span class="ident" id="3104314">nil</span>&nbsp;<span class="op" id="3104318">||</span>&nbsp;<span class="builtinfunc" id="3104321">len</span><span class="op" id="3104324">(</span><span class="ident" id="3104325">ncfg</span><span class="op" id="3104329">.</span><span class="ident" id="3104330">servers</span><span class="op" id="3104337">)</span>&nbsp;<span class="op" id="3104339">==</span>&nbsp;<span class="num" id="3104342">0</span>&nbsp;<span class="op" id="3104344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104350">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104367">cfg</span><span class="op" id="3104370">.</span><span class="ident" id="3104371">mu</span><span class="op" id="3104373">.</span><span class="ident" id="3104374">Lock</span><span class="op" id="3104378">(</span><span class="op" id="3104379">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104384">cfg</span><span class="op" id="3104387">.</span><span class="ident" id="3104388">dnsConfig</span>&nbsp;<span class="op" id="3104398">=</span>&nbsp;<span class="ident" id="3104400">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104408">cfg</span><span class="op" id="3104411">.</span><span class="ident" id="3104412">dnserr</span>&nbsp;<span class="op" id="3104419">=</span>&nbsp;<span class="ident" id="3104421">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104428">cfg</span><span class="op" id="3104431">.</span><span class="ident" id="3104432">mu</span><span class="op" id="3104434">.</span><span class="ident" id="3104435">Unlock</span><span class="op" id="3104441">(</span><span class="op" id="3104442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104449">}</span><span class="op" id="3104450">(</span><span class="op" id="3104451">)</span><br>
<span class="lineno">270</span><span class="op" id="3104453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3104456">func</span>&nbsp;<span class="ident" id="3104461">lookup</span><span class="op" id="3104467">(</span><span class="ident" id="3104468">name</span>&nbsp;<span class="builtintype" id="3104473">string</span><span class="op" id="3104479">,</span>&nbsp;<span class="ident" id="3104481">qtype</span>&nbsp;<span class="builtintype" id="3104487">uint16</span><span class="op" id="3104493">)</span>&nbsp;<span class="op" id="3104495">(</span><span class="ident" id="3104496">cname</span>&nbsp;<span class="builtintype" id="3104502">string</span><span class="op" id="3104508">,</span>&nbsp;<span class="ident" id="3104510">addrs</span>&nbsp;<span class="op" id="3104516">[</span><span class="op" id="3104517">]</span><span class="ident" id="3104518">dnsRR</span><span class="op" id="3104523">,</span>&nbsp;<span class="ident" id="3104525">err</span>&nbsp;<span class="builtintype" id="3104529">error</span><span class="op" id="3104534">)</span>&nbsp;<span class="op" id="3104536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104539">if</span>&nbsp;<span class="op" id="3104542">!</span><span class="ident" id="3104543">isDomainName</span><span class="op" id="3104555">(</span><span class="ident" id="3104556">name</span><span class="op" id="3104560">)</span>&nbsp;<span class="op" id="3104562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104566">return</span>&nbsp;<span class="ident" id="3104573">name</span><span class="op" id="3104577">,</span>&nbsp;<span class="ident" id="3104579">nil</span><span class="op" id="3104582">,</span>&nbsp;<span class="op" id="3104584">&amp;</span><span class="ident" id="3104585">DNSError</span><span class="op" id="3104593">{</span><span class="ident" id="3104594">Err</span><span class="op" id="3104597">:</span>&nbsp;<span class="string" id="3104599">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3104620">,</span>&nbsp;<span class="ident" id="3104622">Name</span><span class="op" id="3104626">:</span>&nbsp;<span class="ident" id="3104628">name</span><span class="op" id="3104632">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104638">onceLoadConfig</span><span class="op" id="3104652">.</span><span class="ident" id="3104653">Do</span><span class="op" id="3104655">(</span><span class="ident" id="3104656">loadDefaultConfig</span><span class="op" id="3104673">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104677">select</span>&nbsp;<span class="op" id="3104684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104687">case</span>&nbsp;<span class="ident" id="3104692">cfg</span><span class="op" id="3104695">.</span><span class="ident" id="3104696">ch</span>&nbsp;<span class="op" id="3104699">&lt;-</span>&nbsp;<span class="keyword" id="3104702">struct</span><span class="op" id="3104708">{</span><span class="op" id="3104709">}</span><span class="op" id="3104710">{</span><span class="op" id="3104711">}</span><span class="op" id="3104712">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104715">default</span><span class="op" id="3104722">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104729">cfg</span><span class="op" id="3104732">.</span><span class="ident" id="3104733">mu</span><span class="op" id="3104735">.</span><span class="ident" id="3104736">RLock</span><span class="op" id="3104741">(</span><span class="op" id="3104742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104745">defer</span>&nbsp;<span class="ident" id="3104751">cfg</span><span class="op" id="3104754">.</span><span class="ident" id="3104755">mu</span><span class="op" id="3104757">.</span><span class="ident" id="3104758">RUnlock</span><span class="op" id="3104765">(</span><span class="op" id="3104766">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104770">if</span>&nbsp;<span class="ident" id="3104773">cfg</span><span class="op" id="3104776">.</span><span class="ident" id="3104777">dnserr</span>&nbsp;<span class="op" id="3104784">!=</span>&nbsp;<span class="ident" id="3104787">nil</span>&nbsp;<span class="op" id="3104791">||</span>&nbsp;<span class="ident" id="3104794">cfg</span><span class="op" id="3104797">.</span><span class="ident" id="3104798">dnsConfig</span>&nbsp;<span class="op" id="3104808">==</span>&nbsp;<span class="ident" id="3104811">nil</span>&nbsp;<span class="op" id="3104815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104819">err</span>&nbsp;<span class="op" id="3104823">=</span>&nbsp;<span class="ident" id="3104825">cfg</span><span class="op" id="3104828">.</span><span class="ident" id="3104829">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3104846">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104849">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3104906">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3104934">rooted</span>&nbsp;<span class="op" id="3104941">:=</span>&nbsp;<span class="builtinfunc" id="3104944">len</span><span class="op" id="3104947">(</span><span class="ident" id="3104948">name</span><span class="op" id="3104952">)</span>&nbsp;<span class="op" id="3104954">&gt;</span>&nbsp;<span class="num" id="3104956">0</span>&nbsp;<span class="op" id="3104958">&amp;&amp;</span>&nbsp;<span class="ident" id="3104961">name</span><span class="op" id="3104965">[</span><span class="builtinfunc" id="3104966">len</span><span class="op" id="3104969">(</span><span class="ident" id="3104970">name</span><span class="op" id="3104974">)</span><span class="op" id="3104975">-</span><span class="num" id="3104976">1</span><span class="op" id="3104977">]</span>&nbsp;<span class="op" id="3104979">==</span>&nbsp;<span class="string" id="3104982">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3104987">if</span>&nbsp;<span class="ident" id="3104990">rooted</span>&nbsp;<span class="op" id="3104997">||</span>&nbsp;<span class="ident" id="3105000">count</span><span class="op" id="3105005">(</span><span class="ident" id="3105006">name</span><span class="op" id="3105010">,</span>&nbsp;<span class="string" id="3105012">&#39;.&#39;</span><span class="op" id="3105015">)</span>&nbsp;<span class="op" id="3105017">&gt;=</span>&nbsp;<span class="ident" id="3105020">cfg</span><span class="op" id="3105023">.</span><span class="ident" id="3105024">dnsConfig</span><span class="op" id="3105033">.</span><span class="ident" id="3105034">ndots</span>&nbsp;<span class="op" id="3105040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105044">rname</span>&nbsp;<span class="op" id="3105050">:=</span>&nbsp;<span class="ident" id="3105053">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105060">if</span>&nbsp;<span class="op" id="3105063">!</span><span class="ident" id="3105064">rooted</span>&nbsp;<span class="op" id="3105071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105076">rname</span>&nbsp;<span class="op" id="3105082">+=</span>&nbsp;<span class="string" id="3105085">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105095">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105126">cname</span><span class="op" id="3105131">,</span>&nbsp;<span class="ident" id="3105133">addrs</span><span class="op" id="3105138">,</span>&nbsp;<span class="ident" id="3105140">err</span>&nbsp;<span class="op" id="3105144">=</span>&nbsp;<span class="ident" id="3105146">tryOneName</span><span class="op" id="3105156">(</span><span class="ident" id="3105157">cfg</span><span class="op" id="3105160">.</span><span class="ident" id="3105161">dnsConfig</span><span class="op" id="3105170">,</span>&nbsp;<span class="ident" id="3105172">rname</span><span class="op" id="3105177">,</span>&nbsp;<span class="ident" id="3105179">qtype</span><span class="op" id="3105184">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105188">if</span>&nbsp;<span class="ident" id="3105191">rooted</span>&nbsp;<span class="op" id="3105198">||</span>&nbsp;<span class="ident" id="3105201">err</span>&nbsp;<span class="op" id="3105205">==</span>&nbsp;<span class="ident" id="3105208">nil</span>&nbsp;<span class="op" id="3105212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105233">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105262">for</span>&nbsp;<span class="ident" id="3105266">i</span>&nbsp;<span class="op" id="3105268">:=</span>&nbsp;<span class="num" id="3105271">0</span><span class="op" id="3105272">;</span>&nbsp;<span class="ident" id="3105274">i</span>&nbsp;<span class="op" id="3105276">&lt;</span>&nbsp;<span class="builtinfunc" id="3105278">len</span><span class="op" id="3105281">(</span><span class="ident" id="3105282">cfg</span><span class="op" id="3105285">.</span><span class="ident" id="3105286">dnsConfig</span><span class="op" id="3105295">.</span><span class="ident" id="3105296">search</span><span class="op" id="3105302">)</span><span class="op" id="3105303">;</span>&nbsp;<span class="ident" id="3105305">i</span><span class="op" id="3105306">++</span>&nbsp;<span class="op" id="3105309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105313">rname</span>&nbsp;<span class="op" id="3105319">:=</span>&nbsp;<span class="ident" id="3105322">name</span>&nbsp;<span class="op" id="3105327">+</span>&nbsp;<span class="string" id="3105329">&#34;.&#34;</span>&nbsp;<span class="op" id="3105333">+</span>&nbsp;<span class="ident" id="3105335">cfg</span><span class="op" id="3105338">.</span><span class="ident" id="3105339">dnsConfig</span><span class="op" id="3105348">.</span><span class="ident" id="3105349">search</span><span class="op" id="3105355">[</span><span class="ident" id="3105356">i</span><span class="op" id="3105357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105361">if</span>&nbsp;<span class="ident" id="3105364">rname</span><span class="op" id="3105369">[</span><span class="builtinfunc" id="3105370">len</span><span class="op" id="3105373">(</span><span class="ident" id="3105374">rname</span><span class="op" id="3105379">)</span><span class="op" id="3105380">-</span><span class="num" id="3105381">1</span><span class="op" id="3105382">]</span>&nbsp;<span class="op" id="3105384">!=</span>&nbsp;<span class="string" id="3105387">&#39;.&#39;</span>&nbsp;<span class="op" id="3105391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105396">rname</span>&nbsp;<span class="op" id="3105402">+=</span>&nbsp;<span class="string" id="3105405">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105415">cname</span><span class="op" id="3105420">,</span>&nbsp;<span class="ident" id="3105422">addrs</span><span class="op" id="3105427">,</span>&nbsp;<span class="ident" id="3105429">err</span>&nbsp;<span class="op" id="3105433">=</span>&nbsp;<span class="ident" id="3105435">tryOneName</span><span class="op" id="3105445">(</span><span class="ident" id="3105446">cfg</span><span class="op" id="3105449">.</span><span class="ident" id="3105450">dnsConfig</span><span class="op" id="3105459">,</span>&nbsp;<span class="ident" id="3105461">rname</span><span class="op" id="3105466">,</span>&nbsp;<span class="ident" id="3105468">qtype</span><span class="op" id="3105473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105477">if</span>&nbsp;<span class="ident" id="3105480">err</span>&nbsp;<span class="op" id="3105484">==</span>&nbsp;<span class="ident" id="3105487">nil</span>&nbsp;<span class="op" id="3105491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105505">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105512">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105578">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105640">if</span>&nbsp;<span class="ident" id="3105643">count</span><span class="op" id="3105648">(</span><span class="ident" id="3105649">name</span><span class="op" id="3105653">,</span>&nbsp;<span class="string" id="3105655">&#39;.&#39;</span><span class="op" id="3105658">)</span>&nbsp;<span class="op" id="3105660">&lt;</span>&nbsp;<span class="ident" id="3105662">cfg</span><span class="op" id="3105665">.</span><span class="ident" id="3105666">dnsConfig</span><span class="op" id="3105675">.</span><span class="ident" id="3105676">ndots</span>&nbsp;<span class="op" id="3105682">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3105686">cname</span><span class="op" id="3105691">,</span>&nbsp;<span class="ident" id="3105693">addrs</span><span class="op" id="3105698">,</span>&nbsp;<span class="ident" id="3105700">err</span>&nbsp;<span class="op" id="3105704">=</span>&nbsp;<span class="ident" id="3105706">tryOneName</span><span class="op" id="3105716">(</span><span class="ident" id="3105717">cfg</span><span class="op" id="3105720">.</span><span class="ident" id="3105721">dnsConfig</span><span class="op" id="3105730">,</span>&nbsp;<span class="ident" id="3105732">name</span><span class="op" id="3105736">+</span><span class="string" id="3105737">&#34;.&#34;</span><span class="op" id="3105740">,</span>&nbsp;<span class="ident" id="3105742">qtype</span><span class="op" id="3105747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105751">if</span>&nbsp;<span class="ident" id="3105754">err</span>&nbsp;<span class="op" id="3105758">==</span>&nbsp;<span class="ident" id="3105761">nil</span>&nbsp;<span class="op" id="3105765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3105782">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3105786">if</span>&nbsp;<span class="ident" id="3105789">e</span><span class="op" id="3105790">,</span>&nbsp;<span class="ident" id="3105792">ok</span>&nbsp;<span class="op" id="3105795">:=</span>&nbsp;<span class="ident" id="3105798">err</span><span class="op" id="3105801">.</span><span class="op" id="3105802">(</span><span class="op" id="3105803">*</span><span class="ident" id="3105804">DNSError</span><span class="op" id="3105812">)</span><span class="op" id="3105813">;</span>&nbsp;<span class="ident" id="3105815">ok</span>&nbsp;<span class="op" id="3105818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105822">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105882">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3105941">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106002">e</span><span class="op" id="3106003">.</span><span class="ident" id="3106004">Name</span>&nbsp;<span class="op" id="3106009">=</span>&nbsp;<span class="ident" id="3106011">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106020">return</span><br>
<span class="lineno"></span><span class="op" id="3106027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3106030">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3106093">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3106153">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3106217">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3106278">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3106341">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3106353">func</span>&nbsp;<span class="ident" id="3106358">goLookupHost</span><span class="op" id="3106370">(</span><span class="ident" id="3106371">name</span>&nbsp;<span class="builtintype" id="3106376">string</span><span class="op" id="3106382">)</span>&nbsp;<span class="op" id="3106384">(</span><span class="ident" id="3106385">addrs</span>&nbsp;<span class="op" id="3106391">[</span><span class="op" id="3106392">]</span><span class="builtintype" id="3106393">string</span><span class="op" id="3106399">,</span>&nbsp;<span class="ident" id="3106401">err</span>&nbsp;<span class="builtintype" id="3106405">error</span><span class="op" id="3106410">)</span>&nbsp;<span class="op" id="3106412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3106415">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106462">addrs</span>&nbsp;<span class="op" id="3106468">=</span>&nbsp;<span class="ident" id="3106470">lookupStaticHost</span><span class="op" id="3106486">(</span><span class="ident" id="3106487">name</span><span class="op" id="3106491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106494">if</span>&nbsp;<span class="builtinfunc" id="3106497">len</span><span class="op" id="3106500">(</span><span class="ident" id="3106501">addrs</span><span class="op" id="3106506">)</span>&nbsp;<span class="op" id="3106508">&gt;</span>&nbsp;<span class="num" id="3106510">0</span>&nbsp;<span class="op" id="3106512">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106516">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106527">ips</span><span class="op" id="3106530">,</span>&nbsp;<span class="ident" id="3106532">err</span>&nbsp;<span class="op" id="3106536">:=</span>&nbsp;<span class="ident" id="3106539">goLookupIP</span><span class="op" id="3106549">(</span><span class="ident" id="3106550">name</span><span class="op" id="3106554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106557">if</span>&nbsp;<span class="ident" id="3106560">err</span>&nbsp;<span class="op" id="3106564">!=</span>&nbsp;<span class="ident" id="3106567">nil</span>&nbsp;<span class="op" id="3106571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106575">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106586">addrs</span>&nbsp;<span class="op" id="3106592">=</span>&nbsp;<span class="builtinfunc" id="3106594">make</span><span class="op" id="3106598">(</span><span class="op" id="3106599">[</span><span class="op" id="3106600">]</span><span class="builtintype" id="3106601">string</span><span class="op" id="3106607">,</span>&nbsp;<span class="num" id="3106609">0</span><span class="op" id="3106610">,</span>&nbsp;<span class="builtinfunc" id="3106612">len</span><span class="op" id="3106615">(</span><span class="ident" id="3106616">ips</span><span class="op" id="3106619">)</span><span class="op" id="3106620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106623">for</span>&nbsp;<span class="ident" id="3106627">_</span><span class="op" id="3106628">,</span>&nbsp;<span class="ident" id="3106630">ip</span>&nbsp;<span class="op" id="3106633">:=</span>&nbsp;<span class="keyword" id="3106636">range</span>&nbsp;<span class="ident" id="3106642">ips</span>&nbsp;<span class="op" id="3106646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3106650">addrs</span>&nbsp;<span class="op" id="3106656">=</span>&nbsp;<span class="builtinfunc" id="3106658">append</span><span class="op" id="3106664">(</span><span class="ident" id="3106665">addrs</span><span class="op" id="3106670">,</span>&nbsp;<span class="ident" id="3106672">ip</span><span class="op" id="3106674">.</span><span class="ident" id="3106675">String</span><span class="op" id="3106681">(</span><span class="op" id="3106682">)</span><span class="op" id="3106683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3106686">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3106689">return</span><br>
<span class="lineno"></span><span class="op" id="3106696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3106699">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3106758">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3106816">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3106878">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3106939">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3107002">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3107014">func</span>&nbsp;<span class="ident" id="3107019">goLookupIP</span><span class="op" id="3107029">(</span><span class="ident" id="3107030">name</span>&nbsp;<span class="builtintype" id="3107035">string</span><span class="op" id="3107041">)</span>&nbsp;<span class="op" id="3107043">(</span><span class="ident" id="3107044">addrs</span>&nbsp;<span class="op" id="3107050">[</span><span class="op" id="3107051">]</span><span class="ident" id="3107052">IP</span><span class="op" id="3107054">,</span>&nbsp;<span class="ident" id="3107056">err</span>&nbsp;<span class="builtintype" id="3107060">error</span><span class="op" id="3107065">)</span>&nbsp;<span class="op" id="3107067">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3107070">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107115">haddrs</span>&nbsp;<span class="op" id="3107122">:=</span>&nbsp;<span class="ident" id="3107125">lookupStaticHost</span><span class="op" id="3107141">(</span><span class="ident" id="3107142">name</span><span class="op" id="3107146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107149">if</span>&nbsp;<span class="builtinfunc" id="3107152">len</span><span class="op" id="3107155">(</span><span class="ident" id="3107156">haddrs</span><span class="op" id="3107162">)</span>&nbsp;<span class="op" id="3107164">&gt;</span>&nbsp;<span class="num" id="3107166">0</span>&nbsp;<span class="op" id="3107168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107172">for</span>&nbsp;<span class="ident" id="3107176">_</span><span class="op" id="3107177">,</span>&nbsp;<span class="ident" id="3107179">haddr</span>&nbsp;<span class="op" id="3107185">:=</span>&nbsp;<span class="keyword" id="3107188">range</span>&nbsp;<span class="ident" id="3107194">haddrs</span>&nbsp;<span class="op" id="3107201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107206">if</span>&nbsp;<span class="ident" id="3107209">ip</span>&nbsp;<span class="op" id="3107212">:=</span>&nbsp;<span class="ident" id="3107215">ParseIP</span><span class="op" id="3107222">(</span><span class="ident" id="3107223">haddr</span><span class="op" id="3107228">)</span><span class="op" id="3107229">;</span>&nbsp;<span class="ident" id="3107231">ip</span>&nbsp;<span class="op" id="3107234">!=</span>&nbsp;<span class="ident" id="3107237">nil</span>&nbsp;<span class="op" id="3107241">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107247">addrs</span>&nbsp;<span class="op" id="3107253">=</span>&nbsp;<span class="builtinfunc" id="3107255">append</span><span class="op" id="3107261">(</span><span class="ident" id="3107262">addrs</span><span class="op" id="3107267">,</span>&nbsp;<span class="ident" id="3107269">ip</span><span class="op" id="3107271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107284">if</span>&nbsp;<span class="builtinfunc" id="3107287">len</span><span class="op" id="3107290">(</span><span class="ident" id="3107291">addrs</span><span class="op" id="3107296">)</span>&nbsp;<span class="op" id="3107298">&gt;</span>&nbsp;<span class="num" id="3107300">0</span>&nbsp;<span class="op" id="3107302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107307">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107322">type</span>&nbsp;<span class="ident" id="3107327">racer</span>&nbsp;<span class="keyword" id="3107333">struct</span>&nbsp;<span class="op" id="3107340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107344">qtype</span>&nbsp;<span class="builtintype" id="3107350">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107359">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3107365">[</span><span class="op" id="3107366">]</span><span class="ident" id="3107367">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3107375">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107385">lane</span>&nbsp;<span class="op" id="3107390">:=</span>&nbsp;<span class="builtinfunc" id="3107393">make</span><span class="op" id="3107397">(</span><span class="keyword" id="3107398">chan</span>&nbsp;<span class="ident" id="3107403">racer</span><span class="op" id="3107408">,</span>&nbsp;<span class="num" id="3107410">1</span><span class="op" id="3107411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107414">qtypes</span>&nbsp;<span class="op" id="3107421">:=</span>&nbsp;<span class="op" id="3107424">[</span><span class="op" id="3107425">...</span><span class="op" id="3107428">]</span><span class="builtintype" id="3107429">uint16</span><span class="op" id="3107435">{</span><span class="ident" id="3107436">dnsTypeA</span><span class="op" id="3107444">,</span>&nbsp;<span class="ident" id="3107446">dnsTypeAAAA</span><span class="op" id="3107457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107460">for</span>&nbsp;<span class="ident" id="3107464">_</span><span class="op" id="3107465">,</span>&nbsp;<span class="ident" id="3107467">qtype</span>&nbsp;<span class="op" id="3107473">:=</span>&nbsp;<span class="keyword" id="3107476">range</span>&nbsp;<span class="ident" id="3107482">qtypes</span>&nbsp;<span class="op" id="3107489">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107493">go</span>&nbsp;<span class="keyword" id="3107496">func</span><span class="op" id="3107500">(</span><span class="ident" id="3107501">qtype</span>&nbsp;<span class="builtintype" id="3107507">uint16</span><span class="op" id="3107513">)</span>&nbsp;<span class="op" id="3107515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107520">_</span><span class="op" id="3107521">,</span>&nbsp;<span class="ident" id="3107523">rrs</span><span class="op" id="3107526">,</span>&nbsp;<span class="ident" id="3107528">err</span>&nbsp;<span class="op" id="3107532">:=</span>&nbsp;<span class="ident" id="3107535">lookup</span><span class="op" id="3107541">(</span><span class="ident" id="3107542">name</span><span class="op" id="3107546">,</span>&nbsp;<span class="ident" id="3107548">qtype</span><span class="op" id="3107553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107558">lane</span>&nbsp;<span class="op" id="3107563">&lt;-</span>&nbsp;<span class="ident" id="3107566">racer</span><span class="op" id="3107571">{</span><span class="ident" id="3107572">qtype</span><span class="op" id="3107577">,</span>&nbsp;<span class="ident" id="3107579">rrs</span><span class="op" id="3107582">,</span>&nbsp;<span class="ident" id="3107584">err</span><span class="op" id="3107587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107591">}</span><span class="op" id="3107592">(</span><span class="ident" id="3107593">qtype</span><span class="op" id="3107598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107601">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107604">var</span>&nbsp;<span class="ident" id="3107608">lastErr</span>&nbsp;<span class="builtintype" id="3107616">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107623">for</span>&nbsp;<span class="keyword" id="3107627">range</span>&nbsp;<span class="ident" id="3107633">qtypes</span>&nbsp;<span class="op" id="3107640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107644">racer</span>&nbsp;<span class="op" id="3107650">:=</span>&nbsp;<span class="op" id="3107653">&lt;-</span><span class="ident" id="3107655">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107662">if</span>&nbsp;<span class="ident" id="3107665">racer</span><span class="op" id="3107670">.</span><span class="builtintype" id="3107671">error</span>&nbsp;<span class="op" id="3107677">!=</span>&nbsp;<span class="ident" id="3107680">nil</span>&nbsp;<span class="op" id="3107684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107689">lastErr</span>&nbsp;<span class="op" id="3107697">=</span>&nbsp;<span class="ident" id="3107699">racer</span><span class="op" id="3107704">.</span><span class="builtintype" id="3107705">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107714">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107729">switch</span>&nbsp;<span class="ident" id="3107736">racer</span><span class="op" id="3107741">.</span><span class="ident" id="3107742">qtype</span>&nbsp;<span class="op" id="3107748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107752">case</span>&nbsp;<span class="ident" id="3107757">dnsTypeA</span><span class="op" id="3107765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107770">addrs</span>&nbsp;<span class="op" id="3107776">=</span>&nbsp;<span class="builtinfunc" id="3107778">append</span><span class="op" id="3107784">(</span><span class="ident" id="3107785">addrs</span><span class="op" id="3107790">,</span>&nbsp;<span class="ident" id="3107792">convertRR_A</span><span class="op" id="3107803">(</span><span class="ident" id="3107804">racer</span><span class="op" id="3107809">.</span><span class="ident" id="3107810">rrs</span><span class="op" id="3107813">)</span><span class="op" id="3107814">...</span><span class="op" id="3107817">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107821">case</span>&nbsp;<span class="ident" id="3107826">dnsTypeAAAA</span><span class="op" id="3107837">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3107842">addrs</span>&nbsp;<span class="op" id="3107848">=</span>&nbsp;<span class="builtinfunc" id="3107850">append</span><span class="op" id="3107856">(</span><span class="ident" id="3107857">addrs</span><span class="op" id="3107862">,</span>&nbsp;<span class="ident" id="3107864">convertRR_AAAA</span><span class="op" id="3107878">(</span><span class="ident" id="3107879">racer</span><span class="op" id="3107884">.</span><span class="ident" id="3107885">rrs</span><span class="op" id="3107888">)</span><span class="op" id="3107889">...</span><span class="op" id="3107892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107902">if</span>&nbsp;<span class="builtinfunc" id="3107905">len</span><span class="op" id="3107908">(</span><span class="ident" id="3107909">addrs</span><span class="op" id="3107914">)</span>&nbsp;<span class="op" id="3107916">==</span>&nbsp;<span class="num" id="3107919">0</span>&nbsp;<span class="op" id="3107921">&amp;&amp;</span>&nbsp;<span class="ident" id="3107924">lastErr</span>&nbsp;<span class="op" id="3107932">!=</span>&nbsp;<span class="ident" id="3107935">nil</span>&nbsp;<span class="op" id="3107939">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107943">return</span>&nbsp;<span class="ident" id="3107950">nil</span><span class="op" id="3107953">,</span>&nbsp;<span class="ident" id="3107955">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3107964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3107967">return</span>&nbsp;<span class="ident" id="3107974">addrs</span><span class="op" id="3107979">,</span>&nbsp;<span class="ident" id="3107981">nil</span><br>
<span class="lineno"></span><span class="op" id="3107985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3107988">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3108053">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3108114">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3108179">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3108240">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3108303">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3108315">func</span>&nbsp;<span class="ident" id="3108320">goLookupCNAME</span><span class="op" id="3108333">(</span><span class="ident" id="3108334">name</span>&nbsp;<span class="builtintype" id="3108339">string</span><span class="op" id="3108345">)</span>&nbsp;<span class="op" id="3108347">(</span><span class="ident" id="3108348">cname</span>&nbsp;<span class="builtintype" id="3108354">string</span><span class="op" id="3108360">,</span>&nbsp;<span class="ident" id="3108362">err</span>&nbsp;<span class="builtintype" id="3108366">error</span><span class="op" id="3108371">)</span>&nbsp;<span class="op" id="3108373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3108376">_</span><span class="op" id="3108377">,</span>&nbsp;<span class="ident" id="3108379">rr</span><span class="op" id="3108381">,</span>&nbsp;<span class="ident" id="3108383">err</span>&nbsp;<span class="op" id="3108387">:=</span>&nbsp;<span class="ident" id="3108390">lookup</span><span class="op" id="3108396">(</span><span class="ident" id="3108397">name</span><span class="op" id="3108401">,</span>&nbsp;<span class="ident" id="3108403">dnsTypeCNAME</span><span class="op" id="3108415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3108418">if</span>&nbsp;<span class="ident" id="3108421">err</span>&nbsp;<span class="op" id="3108425">!=</span>&nbsp;<span class="ident" id="3108428">nil</span>&nbsp;<span class="op" id="3108432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3108436">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3108444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3108447">cname</span>&nbsp;<span class="op" id="3108453">=</span>&nbsp;<span class="ident" id="3108455">rr</span><span class="op" id="3108457">[</span><span class="num" id="3108458">0</span><span class="op" id="3108459">]</span><span class="op" id="3108460">.</span><span class="op" id="3108461">(</span><span class="op" id="3108462">*</span><span class="ident" id="3108463">dnsRR_CNAME</span><span class="op" id="3108474">)</span><span class="op" id="3108475">.</span><span class="ident" id="3108476">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3108483">return</span><br>
<span class="lineno"></span><span class="op" id="3108490">}</span>
</div>
</body>
</html>
