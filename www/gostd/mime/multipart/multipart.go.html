<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3928610">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3928665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3928719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3928769">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3928773">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3928966">package</span>&nbsp;<span class="ident" id="3928974">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3928985">import</span>&nbsp;<span class="op" id="3928992">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3928995">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929004">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929013">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929020">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929026">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929039">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3929047">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3929063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3929066">var</span>&nbsp;<span class="ident" id="3929070">emptyParams</span>&nbsp;<span class="op" id="3929082">=</span>&nbsp;<span class="builtinfunc" id="3929084">make</span><span class="op" id="3929088">(</span><span class="keyword" id="3929089">map</span><span class="op" id="3929092">[</span><span class="builtintype" id="3929093">string</span><span class="op" id="3929099">]</span><span class="builtintype" id="3929100">string</span><span class="op" id="3929106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3929109">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3929165">type</span>&nbsp;<span class="ident" id="3929170">Part</span>&nbsp;<span class="keyword" id="3929175">struct</span>&nbsp;<span class="op" id="3929182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929185">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929250">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929312">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929365">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929369">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929434">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929496">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929559">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929582">Header</span>&nbsp;<span class="ident" id="3929589">textproto</span><span class="op" id="3929598">.</span><span class="ident" id="3929599">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929612">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929622">*</span><span class="ident" id="3929623">bytes</span><span class="op" id="3929628">.</span><span class="ident" id="3929629">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929637">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3929647">*</span><span class="ident" id="3929648">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929656">bytesRead</span>&nbsp;<span class="builtintype" id="3929666">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929672">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3929690">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929698">dispositionParams</span>&nbsp;<span class="keyword" id="3929716">map</span><span class="op" id="3929719">[</span><span class="builtintype" id="3929720">string</span><span class="op" id="3929726">]</span><span class="builtintype" id="3929727">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929736">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929797">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3929844">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3929874">r</span>&nbsp;<span class="ident" id="3929876">io</span><span class="op" id="3929878">.</span><span class="ident" id="3929879">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3929886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3929889">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3929959">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3930023">func</span>&nbsp;<span class="op" id="3930028">(</span><span class="ident" id="3930029">p</span>&nbsp;<span class="op" id="3930031">*</span><span class="ident" id="3930032">Part</span><span class="op" id="3930036">)</span>&nbsp;<span class="ident" id="3930038">FormName</span><span class="op" id="3930046">(</span><span class="op" id="3930047">)</span>&nbsp;<span class="builtintype" id="3930049">string</span>&nbsp;<span class="op" id="3930056">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3930059">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3930121">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930162">if</span>&nbsp;<span class="ident" id="3930165">p</span><span class="op" id="3930166">.</span><span class="ident" id="3930167">dispositionParams</span>&nbsp;<span class="op" id="3930185">==</span>&nbsp;<span class="builtintype" id="3930188">nil</span>&nbsp;<span class="op" id="3930192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930196">p</span><span class="op" id="3930197">.</span><span class="ident" id="3930198">parseContentDisposition</span><span class="op" id="3930221">(</span><span class="op" id="3930222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930225">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930228">if</span>&nbsp;<span class="ident" id="3930231">p</span><span class="op" id="3930232">.</span><span class="ident" id="3930233">disposition</span>&nbsp;<span class="op" id="3930245">!=</span>&nbsp;<span class="string" id="3930248">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3930260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930264">return</span>&nbsp;<span class="string" id="3930271">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930278">return</span>&nbsp;<span class="ident" id="3930285">p</span><span class="op" id="3930286">.</span><span class="ident" id="3930287">dispositionParams</span><span class="op" id="3930304">[</span><span class="string" id="3930305">&#34;name&#34;</span><span class="op" id="3930311">]</span><br>
<span class="lineno"></span><span class="op" id="3930313">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3930316">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3930373">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3930404">func</span>&nbsp;<span class="op" id="3930409">(</span><span class="ident" id="3930410">p</span>&nbsp;<span class="op" id="3930412">*</span><span class="ident" id="3930413">Part</span><span class="op" id="3930417">)</span>&nbsp;<span class="ident" id="3930419">FileName</span><span class="op" id="3930427">(</span><span class="op" id="3930428">)</span>&nbsp;<span class="builtintype" id="3930430">string</span>&nbsp;<span class="op" id="3930437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930440">if</span>&nbsp;<span class="ident" id="3930443">p</span><span class="op" id="3930444">.</span><span class="ident" id="3930445">dispositionParams</span>&nbsp;<span class="op" id="3930463">==</span>&nbsp;<span class="builtintype" id="3930466">nil</span>&nbsp;<span class="op" id="3930470">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930474">p</span><span class="op" id="3930475">.</span><span class="ident" id="3930476">parseContentDisposition</span><span class="op" id="3930499">(</span><span class="op" id="3930500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930506">return</span>&nbsp;<span class="ident" id="3930513">p</span><span class="op" id="3930514">.</span><span class="ident" id="3930515">dispositionParams</span><span class="op" id="3930532">[</span><span class="string" id="3930533">&#34;filename&#34;</span><span class="op" id="3930543">]</span><br>
<span class="lineno"></span><span class="op" id="3930545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3930548">func</span>&nbsp;<span class="op" id="3930553">(</span><span class="ident" id="3930554">p</span>&nbsp;<span class="op" id="3930556">*</span><span class="ident" id="3930557">Part</span><span class="op" id="3930561">)</span>&nbsp;<span class="ident" id="3930563">parseContentDisposition</span><span class="op" id="3930586">(</span><span class="op" id="3930587">)</span>&nbsp;<span class="op" id="3930589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930592">v</span>&nbsp;<span class="op" id="3930594">:=</span>&nbsp;<span class="ident" id="3930597">p</span><span class="op" id="3930598">.</span><span class="ident" id="3930599">Header</span><span class="op" id="3930605">.</span><span class="ident" id="3930606">Get</span><span class="op" id="3930609">(</span><span class="string" id="3930610">&#34;Content-Disposition&#34;</span><span class="op" id="3930631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930634">var</span>&nbsp;<span class="ident" id="3930638">err</span>&nbsp;<span class="builtintype" id="3930642">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930649">p</span><span class="op" id="3930650">.</span><span class="ident" id="3930651">disposition</span><span class="op" id="3930662">,</span>&nbsp;<span class="ident" id="3930664">p</span><span class="op" id="3930665">.</span><span class="ident" id="3930666">dispositionParams</span><span class="op" id="3930683">,</span>&nbsp;<span class="ident" id="3930685">err</span>&nbsp;<span class="op" id="3930689">=</span>&nbsp;<span class="ident" id="3930691">mime</span><span class="op" id="3930695">.</span><span class="ident" id="3930696">ParseMediaType</span><span class="op" id="3930710">(</span><span class="ident" id="3930711">v</span><span class="op" id="3930712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3930715">if</span>&nbsp;<span class="ident" id="3930718">err</span>&nbsp;<span class="op" id="3930722">!=</span>&nbsp;<span class="builtintype" id="3930725">nil</span>&nbsp;<span class="op" id="3930729">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3930733">p</span><span class="op" id="3930734">.</span><span class="ident" id="3930735">dispositionParams</span>&nbsp;<span class="op" id="3930753">=</span>&nbsp;<span class="ident" id="3930755">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3930768">}</span><br>
<span class="lineno"></span><span class="op" id="3930770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3930773">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3930842">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3930866">//</span><br>
<span class="lineno"></span><span class="comment" id="3930869">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3930938">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3931005">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3931028">func</span>&nbsp;<span class="ident" id="3931033">NewReader</span><span class="op" id="3931042">(</span><span class="ident" id="3931043">r</span>&nbsp;<span class="ident" id="3931045">io</span><span class="op" id="3931047">.</span><span class="ident" id="3931048">Reader</span><span class="op" id="3931054">,</span>&nbsp;<span class="ident" id="3931056">boundary</span>&nbsp;<span class="builtintype" id="3931065">string</span><span class="op" id="3931071">)</span>&nbsp;<span class="op" id="3931073">*</span><span class="ident" id="3931074">Reader</span>&nbsp;<span class="op" id="3931081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931084">b</span>&nbsp;<span class="op" id="3931086">:=</span>&nbsp;<span class="op" id="3931089">[</span><span class="op" id="3931090">]</span><span class="builtintype" id="3931091">byte</span><span class="op" id="3931095">(</span><span class="string" id="3931096">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3931105">+</span>&nbsp;<span class="ident" id="3931107">boundary</span>&nbsp;<span class="op" id="3931116">+</span>&nbsp;<span class="string" id="3931118">&#34;--&#34;</span><span class="op" id="3931122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931125">return</span>&nbsp;<span class="op" id="3931132">&amp;</span><span class="ident" id="3931133">Reader</span><span class="op" id="3931139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931143">bufReader</span><span class="op" id="3931152">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931161">bufio</span><span class="op" id="3931166">.</span><span class="ident" id="3931167">NewReader</span><span class="op" id="3931176">(</span><span class="ident" id="3931177">r</span><span class="op" id="3931178">)</span><span class="op" id="3931179">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931183">nl</span><span class="op" id="3931185">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931201">b</span><span class="op" id="3931202">[</span><span class="op" id="3931203">:</span><span class="num" id="3931204">2</span><span class="op" id="3931205">]</span><span class="op" id="3931206">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931210">nlDashBoundary</span><span class="op" id="3931224">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3931228">b</span><span class="op" id="3931229">[</span><span class="op" id="3931230">:</span><span class="builtinfunc" id="3931231">len</span><span class="op" id="3931234">(</span><span class="ident" id="3931235">b</span><span class="op" id="3931236">)</span><span class="op" id="3931237">-</span><span class="num" id="3931238">2</span><span class="op" id="3931239">]</span><span class="op" id="3931240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931244">dashBoundaryDash</span><span class="op" id="3931260">:</span>&nbsp;<span class="ident" id="3931262">b</span><span class="op" id="3931263">[</span><span class="num" id="3931264">2</span><span class="op" id="3931265">:</span><span class="op" id="3931266">]</span><span class="op" id="3931267">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931271">dashBoundary</span><span class="op" id="3931283">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931289">b</span><span class="op" id="3931290">[</span><span class="num" id="3931291">2</span>&nbsp;<span class="op" id="3931293">:</span>&nbsp;<span class="builtinfunc" id="3931295">len</span><span class="op" id="3931298">(</span><span class="ident" id="3931299">b</span><span class="op" id="3931300">)</span><span class="op" id="3931301">-</span><span class="num" id="3931302">2</span><span class="op" id="3931303">]</span><span class="op" id="3931304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931307">}</span><br>
<span class="lineno"></span><span class="op" id="3931309">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3931312">func</span>&nbsp;<span class="ident" id="3931317">newPart</span><span class="op" id="3931324">(</span><span class="ident" id="3931325">mr</span>&nbsp;<span class="op" id="3931328">*</span><span class="ident" id="3931329">Reader</span><span class="op" id="3931335">)</span>&nbsp;<span class="op" id="3931337">(</span><span class="op" id="3931338">*</span><span class="ident" id="3931339">Part</span><span class="op" id="3931343">,</span>&nbsp;<span class="builtintype" id="3931345">error</span><span class="op" id="3931350">)</span>&nbsp;<span class="op" id="3931352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931355">bp</span>&nbsp;<span class="op" id="3931358">:=</span>&nbsp;<span class="op" id="3931361">&amp;</span><span class="ident" id="3931362">Part</span><span class="op" id="3931366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931370">Header</span><span class="op" id="3931376">:</span>&nbsp;<span class="builtinfunc" id="3931378">make</span><span class="op" id="3931382">(</span><span class="keyword" id="3931383">map</span><span class="op" id="3931386">[</span><span class="builtintype" id="3931387">string</span><span class="op" id="3931393">]</span><span class="op" id="3931394">[</span><span class="op" id="3931395">]</span><span class="builtintype" id="3931396">string</span><span class="op" id="3931402">)</span><span class="op" id="3931403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931407">mr</span><span class="op" id="3931409">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931415">mr</span><span class="op" id="3931417">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931421">buffer</span><span class="op" id="3931427">:</span>&nbsp;<span class="builtinfunc" id="3931429">new</span><span class="op" id="3931432">(</span><span class="ident" id="3931433">bytes</span><span class="op" id="3931438">.</span><span class="ident" id="3931439">Buffer</span><span class="op" id="3931445">)</span><span class="op" id="3931446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931452">if</span>&nbsp;<span class="ident" id="3931455">err</span>&nbsp;<span class="op" id="3931459">:=</span>&nbsp;<span class="ident" id="3931462">bp</span><span class="op" id="3931464">.</span><span class="ident" id="3931465">populateHeaders</span><span class="op" id="3931480">(</span><span class="op" id="3931481">)</span><span class="op" id="3931482">;</span>&nbsp;<span class="ident" id="3931484">err</span>&nbsp;<span class="op" id="3931488">!=</span>&nbsp;<span class="builtintype" id="3931491">nil</span>&nbsp;<span class="op" id="3931495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931499">return</span>&nbsp;<span class="builtintype" id="3931506">nil</span><span class="op" id="3931509">,</span>&nbsp;<span class="ident" id="3931511">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931516">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931519">bp</span><span class="op" id="3931521">.</span><span class="ident" id="3931522">r</span>&nbsp;<span class="op" id="3931524">=</span>&nbsp;<span class="ident" id="3931526">partReader</span><span class="op" id="3931536">{</span><span class="ident" id="3931537">bp</span><span class="op" id="3931539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931542">const</span>&nbsp;<span class="ident" id="3931548">cte</span>&nbsp;<span class="op" id="3931552">=</span>&nbsp;<span class="string" id="3931554">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931583">if</span>&nbsp;<span class="ident" id="3931586">bp</span><span class="op" id="3931588">.</span><span class="ident" id="3931589">Header</span><span class="op" id="3931595">.</span><span class="ident" id="3931596">Get</span><span class="op" id="3931599">(</span><span class="ident" id="3931600">cte</span><span class="op" id="3931603">)</span>&nbsp;<span class="op" id="3931605">==</span>&nbsp;<span class="string" id="3931608">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3931627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931631">bp</span><span class="op" id="3931633">.</span><span class="ident" id="3931634">Header</span><span class="op" id="3931640">.</span><span class="ident" id="3931641">Del</span><span class="op" id="3931644">(</span><span class="ident" id="3931645">cte</span><span class="op" id="3931648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931652">bp</span><span class="op" id="3931654">.</span><span class="ident" id="3931655">r</span>&nbsp;<span class="op" id="3931657">=</span>&nbsp;<span class="ident" id="3931659">newQuotedPrintableReader</span><span class="op" id="3931683">(</span><span class="ident" id="3931684">bp</span><span class="op" id="3931686">.</span><span class="ident" id="3931687">r</span><span class="op" id="3931688">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931694">return</span>&nbsp;<span class="ident" id="3931701">bp</span><span class="op" id="3931703">,</span>&nbsp;<span class="builtintype" id="3931705">nil</span><br>
<span class="lineno"></span><span class="op" id="3931709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3931712">func</span>&nbsp;<span class="op" id="3931717">(</span><span class="ident" id="3931718">bp</span>&nbsp;<span class="op" id="3931721">*</span><span class="ident" id="3931722">Part</span><span class="op" id="3931726">)</span>&nbsp;<span class="ident" id="3931728">populateHeaders</span><span class="op" id="3931743">(</span><span class="op" id="3931744">)</span>&nbsp;<span class="builtintype" id="3931746">error</span>&nbsp;<span class="op" id="3931752">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931755">r</span>&nbsp;<span class="op" id="3931757">:=</span>&nbsp;<span class="ident" id="3931760">textproto</span><span class="op" id="3931769">.</span><span class="ident" id="3931770">NewReader</span><span class="op" id="3931779">(</span><span class="ident" id="3931780">bp</span><span class="op" id="3931782">.</span><span class="ident" id="3931783">mr</span><span class="op" id="3931785">.</span><span class="ident" id="3931786">bufReader</span><span class="op" id="3931795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931798">header</span><span class="op" id="3931804">,</span>&nbsp;<span class="ident" id="3931806">err</span>&nbsp;<span class="op" id="3931810">:=</span>&nbsp;<span class="ident" id="3931813">r</span><span class="op" id="3931814">.</span><span class="ident" id="3931815">ReadMIMEHeader</span><span class="op" id="3931829">(</span><span class="op" id="3931830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931833">if</span>&nbsp;<span class="ident" id="3931836">err</span>&nbsp;<span class="op" id="3931840">==</span>&nbsp;<span class="builtintype" id="3931843">nil</span>&nbsp;<span class="op" id="3931847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3931851">bp</span><span class="op" id="3931853">.</span><span class="ident" id="3931854">Header</span>&nbsp;<span class="op" id="3931861">=</span>&nbsp;<span class="ident" id="3931863">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931871">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3931874">return</span>&nbsp;<span class="ident" id="3931881">err</span><br>
<span class="lineno"></span><span class="op" id="3931885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3931888">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3931955">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3931985">func</span>&nbsp;<span class="op" id="3931990">(</span><span class="ident" id="3931991">p</span>&nbsp;<span class="op" id="3931993">*</span><span class="ident" id="3931994">Part</span><span class="op" id="3931998">)</span>&nbsp;<span class="ident" id="3932000">Read</span><span class="op" id="3932004">(</span><span class="ident" id="3932005">d</span>&nbsp;<span class="op" id="3932007">[</span><span class="op" id="3932008">]</span><span class="builtintype" id="3932009">byte</span><span class="op" id="3932013">)</span>&nbsp;<span class="op" id="3932015">(</span><span class="ident" id="3932016">n</span>&nbsp;<span class="builtintype" id="3932018">int</span><span class="op" id="3932021">,</span>&nbsp;<span class="ident" id="3932023">err</span>&nbsp;<span class="builtintype" id="3932027">error</span><span class="op" id="3932032">)</span>&nbsp;<span class="op" id="3932034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932037">return</span>&nbsp;<span class="ident" id="3932044">p</span><span class="op" id="3932045">.</span><span class="ident" id="3932046">r</span><span class="op" id="3932047">.</span><span class="ident" id="3932048">Read</span><span class="op" id="3932052">(</span><span class="ident" id="3932053">d</span><span class="op" id="3932054">)</span><br>
<span class="lineno"></span><span class="op" id="3932056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3932059">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3932133">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3932197">type</span>&nbsp;<span class="ident" id="3932202">partReader</span>&nbsp;<span class="keyword" id="3932213">struct</span>&nbsp;<span class="op" id="3932220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932223">p</span>&nbsp;<span class="op" id="3932225">*</span><span class="ident" id="3932226">Part</span><br>
<span class="lineno"></span><span class="op" id="3932231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3932234">func</span>&nbsp;<span class="op" id="3932239">(</span><span class="ident" id="3932240">pr</span>&nbsp;<span class="ident" id="3932243">partReader</span><span class="op" id="3932253">)</span>&nbsp;<span class="ident" id="3932255">Read</span><span class="op" id="3932259">(</span><span class="ident" id="3932260">d</span>&nbsp;<span class="op" id="3932262">[</span><span class="op" id="3932263">]</span><span class="builtintype" id="3932264">byte</span><span class="op" id="3932268">)</span>&nbsp;<span class="op" id="3932270">(</span><span class="ident" id="3932271">n</span>&nbsp;<span class="builtintype" id="3932273">int</span><span class="op" id="3932276">,</span>&nbsp;<span class="ident" id="3932278">err</span>&nbsp;<span class="builtintype" id="3932282">error</span><span class="op" id="3932287">)</span>&nbsp;<span class="op" id="3932289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932292">p</span>&nbsp;<span class="op" id="3932294">:=</span>&nbsp;<span class="ident" id="3932297">pr</span><span class="op" id="3932299">.</span><span class="ident" id="3932300">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932303">defer</span>&nbsp;<span class="keyword" id="3932309">func</span><span class="op" id="3932313">(</span><span class="op" id="3932314">)</span>&nbsp;<span class="op" id="3932316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932320">p</span><span class="op" id="3932321">.</span><span class="ident" id="3932322">bytesRead</span>&nbsp;<span class="op" id="3932332">+=</span>&nbsp;<span class="ident" id="3932335">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932338">}</span><span class="op" id="3932339">(</span><span class="op" id="3932340">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932343">if</span>&nbsp;<span class="ident" id="3932346">p</span><span class="op" id="3932347">.</span><span class="ident" id="3932348">buffer</span><span class="op" id="3932354">.</span><span class="ident" id="3932355">Len</span><span class="op" id="3932358">(</span><span class="op" id="3932359">)</span>&nbsp;<span class="op" id="3932361">&gt;=</span>&nbsp;<span class="builtinfunc" id="3932364">len</span><span class="op" id="3932367">(</span><span class="ident" id="3932368">d</span><span class="op" id="3932369">)</span>&nbsp;<span class="op" id="3932371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932375">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932435">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932496">return</span>&nbsp;<span class="ident" id="3932503">p</span><span class="op" id="3932504">.</span><span class="ident" id="3932505">buffer</span><span class="op" id="3932511">.</span><span class="ident" id="3932512">Read</span><span class="op" id="3932516">(</span><span class="ident" id="3932517">d</span><span class="op" id="3932518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932521">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932524">peek</span><span class="op" id="3932528">,</span>&nbsp;<span class="ident" id="3932530">err</span>&nbsp;<span class="op" id="3932534">:=</span>&nbsp;<span class="ident" id="3932537">p</span><span class="op" id="3932538">.</span><span class="ident" id="3932539">mr</span><span class="op" id="3932541">.</span><span class="ident" id="3932542">bufReader</span><span class="op" id="3932551">.</span><span class="ident" id="3932552">Peek</span><span class="op" id="3932556">(</span><span class="num" id="3932557">4096</span><span class="op" id="3932561">)</span>&nbsp;<span class="comment" id="3932563">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932609">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932669">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932732">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932792">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3932852">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932877">if</span>&nbsp;<span class="ident" id="3932880">p</span><span class="op" id="3932881">.</span><span class="ident" id="3932882">bytesRead</span>&nbsp;<span class="op" id="3932892">==</span>&nbsp;<span class="num" id="3932895">0</span>&nbsp;<span class="op" id="3932897">&amp;&amp;</span>&nbsp;<span class="ident" id="3932900">p</span><span class="op" id="3932901">.</span><span class="ident" id="3932902">mr</span><span class="op" id="3932904">.</span><span class="ident" id="3932905">peekBufferIsEmptyPart</span><span class="op" id="3932926">(</span><span class="ident" id="3932927">peek</span><span class="op" id="3932931">)</span>&nbsp;<span class="op" id="3932933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932937">return</span>&nbsp;<span class="num" id="3932944">0</span><span class="op" id="3932945">,</span>&nbsp;<span class="ident" id="3932947">io</span><span class="op" id="3932949">.</span><span class="ident" id="3932950">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932955">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932958">unexpectedEOF</span>&nbsp;<span class="op" id="3932972">:=</span>&nbsp;<span class="ident" id="3932975">err</span>&nbsp;<span class="op" id="3932979">==</span>&nbsp;<span class="ident" id="3932982">io</span><span class="op" id="3932984">.</span><span class="ident" id="3932985">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3932990">if</span>&nbsp;<span class="ident" id="3932993">err</span>&nbsp;<span class="op" id="3932997">!=</span>&nbsp;<span class="builtintype" id="3933000">nil</span>&nbsp;<span class="op" id="3933004">&amp;&amp;</span>&nbsp;<span class="op" id="3933007">!</span><span class="ident" id="3933008">unexpectedEOF</span>&nbsp;<span class="op" id="3933022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933026">return</span>&nbsp;<span class="num" id="3933033">0</span><span class="op" id="3933034">,</span>&nbsp;<span class="ident" id="3933036">fmt</span><span class="op" id="3933039">.</span><span class="ident" id="3933040">Errorf</span><span class="op" id="3933046">(</span><span class="string" id="3933047">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3933073">,</span>&nbsp;<span class="ident" id="3933075">err</span><span class="op" id="3933078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933084">if</span>&nbsp;<span class="ident" id="3933087">peek</span>&nbsp;<span class="op" id="3933092">==</span>&nbsp;<span class="builtintype" id="3933095">nil</span>&nbsp;<span class="op" id="3933099">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3933103">panic</span><span class="op" id="3933108">(</span><span class="string" id="3933109">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3933123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933130">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933189">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933253">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933312">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933324">nCopy</span>&nbsp;<span class="op" id="3933330">:=</span>&nbsp;<span class="num" id="3933333">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933336">foundBoundary</span>&nbsp;<span class="op" id="3933350">:=</span>&nbsp;<span class="builtintype" id="3933353">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933360">if</span>&nbsp;<span class="ident" id="3933363">idx</span>&nbsp;<span class="op" id="3933367">:=</span>&nbsp;<span class="ident" id="3933370">bytes</span><span class="op" id="3933375">.</span><span class="ident" id="3933376">Index</span><span class="op" id="3933381">(</span><span class="ident" id="3933382">peek</span><span class="op" id="3933386">,</span>&nbsp;<span class="ident" id="3933388">p</span><span class="op" id="3933389">.</span><span class="ident" id="3933390">mr</span><span class="op" id="3933392">.</span><span class="ident" id="3933393">nlDashBoundary</span><span class="op" id="3933407">)</span><span class="op" id="3933408">;</span>&nbsp;<span class="ident" id="3933410">idx</span>&nbsp;<span class="op" id="3933414">!=</span>&nbsp;<span class="op" id="3933417">-</span><span class="num" id="3933418">1</span>&nbsp;<span class="op" id="3933420">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933424">nCopy</span>&nbsp;<span class="op" id="3933430">=</span>&nbsp;<span class="ident" id="3933432">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933438">foundBoundary</span>&nbsp;<span class="op" id="3933452">=</span>&nbsp;<span class="builtintype" id="3933454">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933460">}</span>&nbsp;<span class="keyword" id="3933462">else</span>&nbsp;<span class="keyword" id="3933467">if</span>&nbsp;<span class="ident" id="3933470">safeCount</span>&nbsp;<span class="op" id="3933480">:=</span>&nbsp;<span class="builtinfunc" id="3933483">len</span><span class="op" id="3933486">(</span><span class="ident" id="3933487">peek</span><span class="op" id="3933491">)</span>&nbsp;<span class="op" id="3933493">-</span>&nbsp;<span class="builtinfunc" id="3933495">len</span><span class="op" id="3933498">(</span><span class="ident" id="3933499">p</span><span class="op" id="3933500">.</span><span class="ident" id="3933501">mr</span><span class="op" id="3933503">.</span><span class="ident" id="3933504">nlDashBoundary</span><span class="op" id="3933518">)</span><span class="op" id="3933519">;</span>&nbsp;<span class="ident" id="3933521">safeCount</span>&nbsp;<span class="op" id="3933531">&gt;</span>&nbsp;<span class="num" id="3933533">0</span>&nbsp;<span class="op" id="3933535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933539">nCopy</span>&nbsp;<span class="op" id="3933545">=</span>&nbsp;<span class="ident" id="3933547">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933558">}</span>&nbsp;<span class="keyword" id="3933560">else</span>&nbsp;<span class="keyword" id="3933565">if</span>&nbsp;<span class="ident" id="3933568">unexpectedEOF</span>&nbsp;<span class="op" id="3933582">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933586">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933640">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933697">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933740">return</span>&nbsp;<span class="num" id="3933747">0</span><span class="op" id="3933748">,</span>&nbsp;<span class="ident" id="3933750">io</span><span class="op" id="3933752">.</span><span class="ident" id="3933753">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933771">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933774">if</span>&nbsp;<span class="ident" id="3933777">nCopy</span>&nbsp;<span class="op" id="3933783">&gt;</span>&nbsp;<span class="num" id="3933785">0</span>&nbsp;<span class="op" id="3933787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933791">if</span>&nbsp;<span class="ident" id="3933794">_</span><span class="op" id="3933795">,</span>&nbsp;<span class="ident" id="3933797">err</span>&nbsp;<span class="op" id="3933801">:=</span>&nbsp;<span class="ident" id="3933804">io</span><span class="op" id="3933806">.</span><span class="ident" id="3933807">CopyN</span><span class="op" id="3933812">(</span><span class="ident" id="3933813">p</span><span class="op" id="3933814">.</span><span class="ident" id="3933815">buffer</span><span class="op" id="3933821">,</span>&nbsp;<span class="ident" id="3933823">p</span><span class="op" id="3933824">.</span><span class="ident" id="3933825">mr</span><span class="op" id="3933827">.</span><span class="ident" id="3933828">bufReader</span><span class="op" id="3933837">,</span>&nbsp;<span class="builtintype" id="3933839">int64</span><span class="op" id="3933844">(</span><span class="ident" id="3933845">nCopy</span><span class="op" id="3933850">)</span><span class="op" id="3933851">)</span><span class="op" id="3933852">;</span>&nbsp;<span class="ident" id="3933854">err</span>&nbsp;<span class="op" id="3933858">!=</span>&nbsp;<span class="builtintype" id="3933861">nil</span>&nbsp;<span class="op" id="3933865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933870">return</span>&nbsp;<span class="num" id="3933877">0</span><span class="op" id="3933878">,</span>&nbsp;<span class="ident" id="3933880">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3933889">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3933892">n</span><span class="op" id="3933893">,</span>&nbsp;<span class="ident" id="3933895">err</span>&nbsp;<span class="op" id="3933899">=</span>&nbsp;<span class="ident" id="3933901">p</span><span class="op" id="3933902">.</span><span class="ident" id="3933903">buffer</span><span class="op" id="3933909">.</span><span class="ident" id="3933910">Read</span><span class="op" id="3933914">(</span><span class="ident" id="3933915">d</span><span class="op" id="3933916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3933919">if</span>&nbsp;<span class="ident" id="3933922">err</span>&nbsp;<span class="op" id="3933926">==</span>&nbsp;<span class="ident" id="3933929">io</span><span class="op" id="3933931">.</span><span class="ident" id="3933932">EOF</span>&nbsp;<span class="op" id="3933936">&amp;&amp;</span>&nbsp;<span class="op" id="3933939">!</span><span class="ident" id="3933940">foundBoundary</span>&nbsp;<span class="op" id="3933954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3933958">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3934015">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934071">err</span>&nbsp;<span class="op" id="3934075">=</span>&nbsp;<span class="builtintype" id="3934077">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3934082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3934085">return</span><br>
<span class="lineno"></span><span class="op" id="3934092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3934095">func</span>&nbsp;<span class="op" id="3934100">(</span><span class="ident" id="3934101">p</span>&nbsp;<span class="op" id="3934103">*</span><span class="ident" id="3934104">Part</span><span class="op" id="3934108">)</span>&nbsp;<span class="ident" id="3934110">Close</span><span class="op" id="3934115">(</span><span class="op" id="3934116">)</span>&nbsp;<span class="builtintype" id="3934118">error</span>&nbsp;<span class="op" id="3934124">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934127">io</span><span class="op" id="3934129">.</span><span class="ident" id="3934130">Copy</span><span class="op" id="3934134">(</span><span class="ident" id="3934135">ioutil</span><span class="op" id="3934141">.</span><span class="ident" id="3934142">Discard</span><span class="op" id="3934149">,</span>&nbsp;<span class="ident" id="3934151">p</span><span class="op" id="3934152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3934155">return</span>&nbsp;<span class="builtintype" id="3934162">nil</span><br>
<span class="lineno"></span><span class="op" id="3934166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3934169">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3934231">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3934300">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3934320">type</span>&nbsp;<span class="ident" id="3934325">Reader</span>&nbsp;<span class="keyword" id="3934332">struct</span>&nbsp;<span class="op" id="3934339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934342">bufReader</span>&nbsp;<span class="op" id="3934352">*</span><span class="ident" id="3934353">bufio</span><span class="op" id="3934358">.</span><span class="ident" id="3934359">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934368">currentPart</span>&nbsp;<span class="op" id="3934380">*</span><span class="ident" id="3934381">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934387">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3934399">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934405">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3934422">[</span><span class="op" id="3934423">]</span><span class="builtintype" id="3934424">byte</span>&nbsp;<span class="comment" id="3934429">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934487">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3934504">[</span><span class="op" id="3934505">]</span><span class="builtintype" id="3934506">byte</span>&nbsp;<span class="comment" id="3934511">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934533">dashBoundaryDash</span>&nbsp;<span class="op" id="3934550">[</span><span class="op" id="3934551">]</span><span class="builtintype" id="3934552">byte</span>&nbsp;<span class="comment" id="3934557">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934576">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3934593">[</span><span class="op" id="3934594">]</span><span class="builtintype" id="3934595">byte</span>&nbsp;<span class="comment" id="3934600">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3934616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3934619">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3934683">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3934746">func</span>&nbsp;<span class="op" id="3934751">(</span><span class="ident" id="3934752">r</span>&nbsp;<span class="op" id="3934754">*</span><span class="ident" id="3934755">Reader</span><span class="op" id="3934761">)</span>&nbsp;<span class="ident" id="3934763">NextPart</span><span class="op" id="3934771">(</span><span class="op" id="3934772">)</span>&nbsp;<span class="op" id="3934774">(</span><span class="op" id="3934775">*</span><span class="ident" id="3934776">Part</span><span class="op" id="3934780">,</span>&nbsp;<span class="builtintype" id="3934782">error</span><span class="op" id="3934787">)</span>&nbsp;<span class="op" id="3934789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3934792">if</span>&nbsp;<span class="ident" id="3934795">r</span><span class="op" id="3934796">.</span><span class="ident" id="3934797">currentPart</span>&nbsp;<span class="op" id="3934809">!=</span>&nbsp;<span class="builtintype" id="3934812">nil</span>&nbsp;<span class="op" id="3934816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934820">r</span><span class="op" id="3934821">.</span><span class="ident" id="3934822">currentPart</span><span class="op" id="3934833">.</span><span class="ident" id="3934834">Close</span><span class="op" id="3934839">(</span><span class="op" id="3934840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3934843">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934847">expectNewPart</span>&nbsp;<span class="op" id="3934861">:=</span>&nbsp;<span class="builtintype" id="3934864">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3934871">for</span>&nbsp;<span class="op" id="3934875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934879">line</span><span class="op" id="3934883">,</span>&nbsp;<span class="ident" id="3934885">err</span>&nbsp;<span class="op" id="3934889">:=</span>&nbsp;<span class="ident" id="3934892">r</span><span class="op" id="3934893">.</span><span class="ident" id="3934894">bufReader</span><span class="op" id="3934903">.</span><span class="ident" id="3934904">ReadSlice</span><span class="op" id="3934913">(</span><span class="string" id="3934914">&#39;\n&#39;</span><span class="op" id="3934918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3934922">if</span>&nbsp;<span class="ident" id="3934925">err</span>&nbsp;<span class="op" id="3934929">==</span>&nbsp;<span class="ident" id="3934932">io</span><span class="op" id="3934934">.</span><span class="ident" id="3934935">EOF</span>&nbsp;<span class="op" id="3934939">&amp;&amp;</span>&nbsp;<span class="ident" id="3934942">r</span><span class="op" id="3934943">.</span><span class="ident" id="3934944">isFinalBoundary</span><span class="op" id="3934959">(</span><span class="ident" id="3934960">line</span><span class="op" id="3934964">)</span>&nbsp;<span class="op" id="3934966">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3934971">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935026">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935080">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935137">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935196">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935221">return</span>&nbsp;<span class="builtintype" id="3935228">nil</span><span class="op" id="3935231">,</span>&nbsp;<span class="ident" id="3935233">io</span><span class="op" id="3935235">.</span><span class="ident" id="3935236">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935246">if</span>&nbsp;<span class="ident" id="3935249">err</span>&nbsp;<span class="op" id="3935253">!=</span>&nbsp;<span class="builtintype" id="3935256">nil</span>&nbsp;<span class="op" id="3935260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935265">return</span>&nbsp;<span class="builtintype" id="3935272">nil</span><span class="op" id="3935275">,</span>&nbsp;<span class="ident" id="3935277">fmt</span><span class="op" id="3935280">.</span><span class="ident" id="3935281">Errorf</span><span class="op" id="3935287">(</span><span class="string" id="3935288">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3935313">,</span>&nbsp;<span class="ident" id="3935315">err</span><span class="op" id="3935318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935322">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935327">if</span>&nbsp;<span class="ident" id="3935330">r</span><span class="op" id="3935331">.</span><span class="ident" id="3935332">isBoundaryDelimiterLine</span><span class="op" id="3935355">(</span><span class="ident" id="3935356">line</span><span class="op" id="3935360">)</span>&nbsp;<span class="op" id="3935362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935367">r</span><span class="op" id="3935368">.</span><span class="ident" id="3935369">partsRead</span><span class="op" id="3935378">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935384">bp</span><span class="op" id="3935386">,</span>&nbsp;<span class="ident" id="3935388">err</span>&nbsp;<span class="op" id="3935392">:=</span>&nbsp;<span class="ident" id="3935395">newPart</span><span class="op" id="3935402">(</span><span class="ident" id="3935403">r</span><span class="op" id="3935404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935409">if</span>&nbsp;<span class="ident" id="3935412">err</span>&nbsp;<span class="op" id="3935416">!=</span>&nbsp;<span class="builtintype" id="3935419">nil</span>&nbsp;<span class="op" id="3935423">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935429">return</span>&nbsp;<span class="builtintype" id="3935436">nil</span><span class="op" id="3935439">,</span>&nbsp;<span class="ident" id="3935441">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935453">r</span><span class="op" id="3935454">.</span><span class="ident" id="3935455">currentPart</span>&nbsp;<span class="op" id="3935467">=</span>&nbsp;<span class="ident" id="3935469">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935475">return</span>&nbsp;<span class="ident" id="3935482">bp</span><span class="op" id="3935484">,</span>&nbsp;<span class="builtintype" id="3935486">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935492">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935497">if</span>&nbsp;<span class="ident" id="3935500">r</span><span class="op" id="3935501">.</span><span class="ident" id="3935502">isFinalBoundary</span><span class="op" id="3935517">(</span><span class="ident" id="3935518">line</span><span class="op" id="3935522">)</span>&nbsp;<span class="op" id="3935524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935529">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935548">return</span>&nbsp;<span class="builtintype" id="3935555">nil</span><span class="op" id="3935558">,</span>&nbsp;<span class="ident" id="3935560">io</span><span class="op" id="3935562">.</span><span class="ident" id="3935563">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935569">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935574">if</span>&nbsp;<span class="ident" id="3935577">expectNewPart</span>&nbsp;<span class="op" id="3935591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935596">return</span>&nbsp;<span class="builtintype" id="3935603">nil</span><span class="op" id="3935606">,</span>&nbsp;<span class="ident" id="3935608">fmt</span><span class="op" id="3935611">.</span><span class="ident" id="3935612">Errorf</span><span class="op" id="3935618">(</span><span class="string" id="3935619">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3935665">,</span>&nbsp;<span class="builtintype" id="3935667">string</span><span class="op" id="3935673">(</span><span class="ident" id="3935674">line</span><span class="op" id="3935678">)</span><span class="op" id="3935679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935688">if</span>&nbsp;<span class="ident" id="3935691">r</span><span class="op" id="3935692">.</span><span class="ident" id="3935693">partsRead</span>&nbsp;<span class="op" id="3935703">==</span>&nbsp;<span class="num" id="3935706">0</span>&nbsp;<span class="op" id="3935708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935713">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935729">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935745">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935799">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935855">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3935910">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935929">if</span>&nbsp;<span class="ident" id="3935932">bytes</span><span class="op" id="3935937">.</span><span class="ident" id="3935938">Equal</span><span class="op" id="3935943">(</span><span class="ident" id="3935944">line</span><span class="op" id="3935948">,</span>&nbsp;<span class="ident" id="3935950">r</span><span class="op" id="3935951">.</span><span class="ident" id="3935952">nl</span><span class="op" id="3935954">)</span>&nbsp;<span class="op" id="3935956">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935961">expectNewPart</span>&nbsp;<span class="op" id="3935975">=</span>&nbsp;<span class="builtintype" id="3935977">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3935985">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3935996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936001">return</span>&nbsp;<span class="builtintype" id="3936008">nil</span><span class="op" id="3936011">,</span>&nbsp;<span class="ident" id="3936013">fmt</span><span class="op" id="3936016">.</span><span class="ident" id="3936017">Errorf</span><span class="op" id="3936023">(</span><span class="string" id="3936024">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3936066">,</span>&nbsp;<span class="ident" id="3936068">line</span><span class="op" id="3936072">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3936075">}</span><br>
<span class="lineno"></span><span class="op" id="3936077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3936080">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3936147">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3936186">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3936230">func</span>&nbsp;<span class="op" id="3936235">(</span><span class="ident" id="3936236">mr</span>&nbsp;<span class="op" id="3936239">*</span><span class="ident" id="3936240">Reader</span><span class="op" id="3936246">)</span>&nbsp;<span class="ident" id="3936248">isFinalBoundary</span><span class="op" id="3936263">(</span><span class="ident" id="3936264">line</span>&nbsp;<span class="op" id="3936269">[</span><span class="op" id="3936270">]</span><span class="builtintype" id="3936271">byte</span><span class="op" id="3936275">)</span>&nbsp;<span class="builtintype" id="3936277">bool</span>&nbsp;<span class="op" id="3936282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936285">if</span>&nbsp;<span class="op" id="3936288">!</span><span class="ident" id="3936289">bytes</span><span class="op" id="3936294">.</span><span class="ident" id="3936295">HasPrefix</span><span class="op" id="3936304">(</span><span class="ident" id="3936305">line</span><span class="op" id="3936309">,</span>&nbsp;<span class="ident" id="3936311">mr</span><span class="op" id="3936313">.</span><span class="ident" id="3936314">dashBoundaryDash</span><span class="op" id="3936330">)</span>&nbsp;<span class="op" id="3936332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936336">return</span>&nbsp;<span class="builtintype" id="3936343">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3936350">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3936353">rest</span>&nbsp;<span class="op" id="3936358">:=</span>&nbsp;<span class="ident" id="3936361">line</span><span class="op" id="3936365">[</span><span class="builtinfunc" id="3936366">len</span><span class="op" id="3936369">(</span><span class="ident" id="3936370">mr</span><span class="op" id="3936372">.</span><span class="ident" id="3936373">dashBoundaryDash</span><span class="op" id="3936389">)</span><span class="op" id="3936390">:</span><span class="op" id="3936391">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3936394">rest</span>&nbsp;<span class="op" id="3936399">=</span>&nbsp;<span class="ident" id="3936401">skipLWSPChar</span><span class="op" id="3936413">(</span><span class="ident" id="3936414">rest</span><span class="op" id="3936418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936421">return</span>&nbsp;<span class="builtinfunc" id="3936428">len</span><span class="op" id="3936431">(</span><span class="ident" id="3936432">rest</span><span class="op" id="3936436">)</span>&nbsp;<span class="op" id="3936438">==</span>&nbsp;<span class="num" id="3936441">0</span>&nbsp;<span class="op" id="3936443">||</span>&nbsp;<span class="ident" id="3936446">bytes</span><span class="op" id="3936451">.</span><span class="ident" id="3936452">Equal</span><span class="op" id="3936457">(</span><span class="ident" id="3936458">rest</span><span class="op" id="3936462">,</span>&nbsp;<span class="ident" id="3936464">mr</span><span class="op" id="3936466">.</span><span class="ident" id="3936467">nl</span><span class="op" id="3936469">)</span><br>
<span class="lineno"></span><span class="op" id="3936471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3936474">func</span>&nbsp;<span class="op" id="3936479">(</span><span class="ident" id="3936480">mr</span>&nbsp;<span class="op" id="3936483">*</span><span class="ident" id="3936484">Reader</span><span class="op" id="3936490">)</span>&nbsp;<span class="ident" id="3936492">isBoundaryDelimiterLine</span><span class="op" id="3936515">(</span><span class="ident" id="3936516">line</span>&nbsp;<span class="op" id="3936521">[</span><span class="op" id="3936522">]</span><span class="builtintype" id="3936523">byte</span><span class="op" id="3936527">)</span>&nbsp;<span class="op" id="3936529">(</span><span class="ident" id="3936530">ret</span>&nbsp;<span class="builtintype" id="3936534">bool</span><span class="op" id="3936538">)</span>&nbsp;<span class="op" id="3936540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936543">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936594">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936654">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936711">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936770">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3936834">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936876">if</span>&nbsp;<span class="op" id="3936879">!</span><span class="ident" id="3936880">bytes</span><span class="op" id="3936885">.</span><span class="ident" id="3936886">HasPrefix</span><span class="op" id="3936895">(</span><span class="ident" id="3936896">line</span><span class="op" id="3936900">,</span>&nbsp;<span class="ident" id="3936902">mr</span><span class="op" id="3936904">.</span><span class="ident" id="3936905">dashBoundary</span><span class="op" id="3936917">)</span>&nbsp;<span class="op" id="3936919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3936923">return</span>&nbsp;<span class="builtintype" id="3936930">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3936937">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3936940">rest</span>&nbsp;<span class="op" id="3936945">:=</span>&nbsp;<span class="ident" id="3936948">line</span><span class="op" id="3936952">[</span><span class="builtinfunc" id="3936953">len</span><span class="op" id="3936956">(</span><span class="ident" id="3936957">mr</span><span class="op" id="3936959">.</span><span class="ident" id="3936960">dashBoundary</span><span class="op" id="3936972">)</span><span class="op" id="3936973">:</span><span class="op" id="3936974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3936977">rest</span>&nbsp;<span class="op" id="3936982">=</span>&nbsp;<span class="ident" id="3936984">skipLWSPChar</span><span class="op" id="3936996">(</span><span class="ident" id="3936997">rest</span><span class="op" id="3937001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3937005">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3937075">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3937146">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3937174">if</span>&nbsp;<span class="ident" id="3937177">mr</span><span class="op" id="3937179">.</span><span class="ident" id="3937180">partsRead</span>&nbsp;<span class="op" id="3937190">==</span>&nbsp;<span class="num" id="3937193">0</span>&nbsp;<span class="op" id="3937195">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3937198">len</span><span class="op" id="3937201">(</span><span class="ident" id="3937202">rest</span><span class="op" id="3937206">)</span>&nbsp;<span class="op" id="3937208">==</span>&nbsp;<span class="num" id="3937211">1</span>&nbsp;<span class="op" id="3937213">&amp;&amp;</span>&nbsp;<span class="ident" id="3937216">rest</span><span class="op" id="3937220">[</span><span class="num" id="3937221">0</span><span class="op" id="3937222">]</span>&nbsp;<span class="op" id="3937224">==</span>&nbsp;<span class="string" id="3937227">&#39;\n&#39;</span>&nbsp;<span class="op" id="3937232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3937236">mr</span><span class="op" id="3937238">.</span><span class="ident" id="3937239">nl</span>&nbsp;<span class="op" id="3937242">=</span>&nbsp;<span class="ident" id="3937244">mr</span><span class="op" id="3937246">.</span><span class="ident" id="3937247">nl</span><span class="op" id="3937249">[</span><span class="num" id="3937250">1</span><span class="op" id="3937251">:</span><span class="op" id="3937252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3937256">mr</span><span class="op" id="3937258">.</span><span class="ident" id="3937259">nlDashBoundary</span>&nbsp;<span class="op" id="3937274">=</span>&nbsp;<span class="ident" id="3937276">mr</span><span class="op" id="3937278">.</span><span class="ident" id="3937279">nlDashBoundary</span><span class="op" id="3937293">[</span><span class="num" id="3937294">1</span><span class="op" id="3937295">:</span><span class="op" id="3937296">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3937299">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3937302">return</span>&nbsp;<span class="ident" id="3937309">bytes</span><span class="op" id="3937314">.</span><span class="ident" id="3937315">Equal</span><span class="op" id="3937320">(</span><span class="ident" id="3937321">rest</span><span class="op" id="3937325">,</span>&nbsp;<span class="ident" id="3937327">mr</span><span class="op" id="3937329">.</span><span class="ident" id="3937330">nl</span><span class="op" id="3937332">)</span><br>
<span class="lineno"></span><span class="op" id="3937334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3937337">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3937402">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3937469">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3937540">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3937605">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3937617">//</span><br>
<span class="lineno"></span><span class="comment" id="3937620">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3937690">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3937758">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3937826">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3937870">func</span>&nbsp;<span class="op" id="3937875">(</span><span class="ident" id="3937876">mr</span>&nbsp;<span class="op" id="3937879">*</span><span class="ident" id="3937880">Reader</span><span class="op" id="3937886">)</span>&nbsp;<span class="ident" id="3937888">peekBufferIsEmptyPart</span><span class="op" id="3937909">(</span><span class="ident" id="3937910">peek</span>&nbsp;<span class="op" id="3937915">[</span><span class="op" id="3937916">]</span><span class="builtintype" id="3937917">byte</span><span class="op" id="3937921">)</span>&nbsp;<span class="builtintype" id="3937923">bool</span>&nbsp;<span class="op" id="3937928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3937931">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3937954">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938016">if</span>&nbsp;<span class="ident" id="3938019">bytes</span><span class="op" id="3938024">.</span><span class="ident" id="3938025">HasPrefix</span><span class="op" id="3938034">(</span><span class="ident" id="3938035">peek</span><span class="op" id="3938039">,</span>&nbsp;<span class="ident" id="3938041">mr</span><span class="op" id="3938043">.</span><span class="ident" id="3938044">dashBoundaryDash</span><span class="op" id="3938060">)</span>&nbsp;<span class="op" id="3938062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3938066">rest</span>&nbsp;<span class="op" id="3938071">:=</span>&nbsp;<span class="ident" id="3938074">peek</span><span class="op" id="3938078">[</span><span class="builtinfunc" id="3938079">len</span><span class="op" id="3938082">(</span><span class="ident" id="3938083">mr</span><span class="op" id="3938085">.</span><span class="ident" id="3938086">dashBoundaryDash</span><span class="op" id="3938102">)</span><span class="op" id="3938103">:</span><span class="op" id="3938104">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3938108">rest</span>&nbsp;<span class="op" id="3938113">=</span>&nbsp;<span class="ident" id="3938115">skipLWSPChar</span><span class="op" id="3938127">(</span><span class="ident" id="3938128">rest</span><span class="op" id="3938132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938136">return</span>&nbsp;<span class="ident" id="3938143">bytes</span><span class="op" id="3938148">.</span><span class="ident" id="3938149">HasPrefix</span><span class="op" id="3938158">(</span><span class="ident" id="3938159">rest</span><span class="op" id="3938163">,</span>&nbsp;<span class="ident" id="3938165">mr</span><span class="op" id="3938167">.</span><span class="ident" id="3938168">nl</span><span class="op" id="3938170">)</span>&nbsp;<span class="op" id="3938172">||</span>&nbsp;<span class="builtinfunc" id="3938175">len</span><span class="op" id="3938178">(</span><span class="ident" id="3938179">rest</span><span class="op" id="3938183">)</span>&nbsp;<span class="op" id="3938185">==</span>&nbsp;<span class="num" id="3938188">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3938191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938194">if</span>&nbsp;<span class="op" id="3938197">!</span><span class="ident" id="3938198">bytes</span><span class="op" id="3938203">.</span><span class="ident" id="3938204">HasPrefix</span><span class="op" id="3938213">(</span><span class="ident" id="3938214">peek</span><span class="op" id="3938218">,</span>&nbsp;<span class="ident" id="3938220">mr</span><span class="op" id="3938222">.</span><span class="ident" id="3938223">dashBoundary</span><span class="op" id="3938235">)</span>&nbsp;<span class="op" id="3938237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938241">return</span>&nbsp;<span class="builtintype" id="3938248">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3938255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3938258">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3938303">rest</span>&nbsp;<span class="op" id="3938308">:=</span>&nbsp;<span class="ident" id="3938311">peek</span><span class="op" id="3938315">[</span><span class="builtinfunc" id="3938316">len</span><span class="op" id="3938319">(</span><span class="ident" id="3938320">mr</span><span class="op" id="3938322">.</span><span class="ident" id="3938323">dashBoundary</span><span class="op" id="3938335">)</span><span class="op" id="3938336">:</span><span class="op" id="3938337">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3938340">rest</span>&nbsp;<span class="op" id="3938345">=</span>&nbsp;<span class="ident" id="3938347">skipLWSPChar</span><span class="op" id="3938359">(</span><span class="ident" id="3938360">rest</span><span class="op" id="3938364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938367">return</span>&nbsp;<span class="ident" id="3938374">bytes</span><span class="op" id="3938379">.</span><span class="ident" id="3938380">HasPrefix</span><span class="op" id="3938389">(</span><span class="ident" id="3938390">rest</span><span class="op" id="3938394">,</span>&nbsp;<span class="ident" id="3938396">mr</span><span class="op" id="3938398">.</span><span class="ident" id="3938399">nl</span><span class="op" id="3938401">)</span><br>
<span class="lineno"></span><span class="op" id="3938403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3938406">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3938470">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3938490">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3938521">func</span>&nbsp;<span class="ident" id="3938526">skipLWSPChar</span><span class="op" id="3938538">(</span><span class="ident" id="3938539">b</span>&nbsp;<span class="op" id="3938541">[</span><span class="op" id="3938542">]</span><span class="builtintype" id="3938543">byte</span><span class="op" id="3938547">)</span>&nbsp;<span class="op" id="3938549">[</span><span class="op" id="3938550">]</span><span class="builtintype" id="3938551">byte</span>&nbsp;<span class="op" id="3938556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938559">for</span>&nbsp;<span class="builtinfunc" id="3938563">len</span><span class="op" id="3938566">(</span><span class="ident" id="3938567">b</span><span class="op" id="3938568">)</span>&nbsp;<span class="op" id="3938570">&gt;</span>&nbsp;<span class="num" id="3938572">0</span>&nbsp;<span class="op" id="3938574">&amp;&amp;</span>&nbsp;<span class="op" id="3938577">(</span><span class="ident" id="3938578">b</span><span class="op" id="3938579">[</span><span class="num" id="3938580">0</span><span class="op" id="3938581">]</span>&nbsp;<span class="op" id="3938583">==</span>&nbsp;<span class="string" id="3938586">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3938590">||</span>&nbsp;<span class="ident" id="3938593">b</span><span class="op" id="3938594">[</span><span class="num" id="3938595">0</span><span class="op" id="3938596">]</span>&nbsp;<span class="op" id="3938598">==</span>&nbsp;<span class="string" id="3938601">&#39;\t&#39;</span><span class="op" id="3938605">)</span>&nbsp;<span class="op" id="3938607">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3938611">b</span>&nbsp;<span class="op" id="3938613">=</span>&nbsp;<span class="ident" id="3938615">b</span><span class="op" id="3938616">[</span><span class="num" id="3938617">1</span><span class="op" id="3938618">:</span><span class="op" id="3938619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3938622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3938625">return</span>&nbsp;<span class="ident" id="3938632">b</span><br>
<span class="lineno"></span><span class="op" id="3938634">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
