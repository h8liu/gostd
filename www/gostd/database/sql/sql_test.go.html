<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7001354">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7001409">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7001463">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7001514">package</span>&nbsp;<span class="ident" id="7001522">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7001527">import</span>&nbsp;<span class="op" id="7001534">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001537">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001560">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001570">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001577">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001590">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001601">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001612">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001623">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001631">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7001642">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7001649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7001652">func</span>&nbsp;<span class="ident" id="7001657">init</span><span class="op" id="7001661">(</span><span class="op" id="7001662">)</span>&nbsp;<span class="op" id="7001664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001667">type</span>&nbsp;<span class="ident" id="7001672">dbConn</span>&nbsp;<span class="keyword" id="7001679">struct</span>&nbsp;<span class="op" id="7001686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001690">db</span>&nbsp;<span class="op" id="7001693">*</span><span class="ident" id="7001694">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001699">c</span>&nbsp;&nbsp;<span class="op" id="7001702">*</span><span class="ident" id="7001703">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001715">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001718">freedFrom</span>&nbsp;<span class="op" id="7001728">:=</span>&nbsp;<span class="builtinfunc" id="7001731">make</span><span class="op" id="7001735">(</span><span class="keyword" id="7001736">map</span><span class="op" id="7001739">[</span><span class="ident" id="7001740">dbConn</span><span class="op" id="7001746">]</span><span class="builtintype" id="7001747">string</span><span class="op" id="7001753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001756">putConnHook</span>&nbsp;<span class="op" id="7001768">=</span>&nbsp;<span class="keyword" id="7001770">func</span><span class="op" id="7001774">(</span><span class="ident" id="7001775">db</span>&nbsp;<span class="op" id="7001778">*</span><span class="ident" id="7001779">DB</span><span class="op" id="7001781">,</span>&nbsp;<span class="ident" id="7001783">c</span>&nbsp;<span class="op" id="7001785">*</span><span class="ident" id="7001786">driverConn</span><span class="op" id="7001796">)</span>&nbsp;<span class="op" id="7001798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001802">idx</span>&nbsp;<span class="op" id="7001806">:=</span>&nbsp;<span class="op" id="7001809">-</span><span class="num" id="7001810">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001814">for</span>&nbsp;<span class="ident" id="7001818">i</span><span class="op" id="7001819">,</span>&nbsp;<span class="ident" id="7001821">v</span>&nbsp;<span class="op" id="7001823">:=</span>&nbsp;<span class="keyword" id="7001826">range</span>&nbsp;<span class="ident" id="7001832">db</span><span class="op" id="7001834">.</span><span class="ident" id="7001835">freeConn</span>&nbsp;<span class="op" id="7001844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001849">if</span>&nbsp;<span class="ident" id="7001852">v</span>&nbsp;<span class="op" id="7001854">==</span>&nbsp;<span class="ident" id="7001857">c</span>&nbsp;<span class="op" id="7001859">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7001865">idx</span>&nbsp;<span class="op" id="7001869">=</span>&nbsp;<span class="ident" id="7001871">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001877">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7001890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7001894">if</span>&nbsp;<span class="ident" id="7001897">idx</span>&nbsp;<span class="op" id="7001901">&gt;=</span>&nbsp;<span class="num" id="7001904">0</span>&nbsp;<span class="op" id="7001906">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7001911">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7001984">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7002051">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7002085">println</span><span class="op" id="7002092">(</span><span class="string" id="7002093">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7002136">+</span>&nbsp;<span class="ident" id="7002138">freedFrom</span><span class="op" id="7002147">[</span><span class="ident" id="7002148">dbConn</span><span class="op" id="7002154">{</span><span class="ident" id="7002155">db</span><span class="op" id="7002157">,</span>&nbsp;<span class="ident" id="7002159">c</span><span class="op" id="7002160">}</span><span class="op" id="7002161">]</span>&nbsp;<span class="op" id="7002163">+</span>&nbsp;<span class="string" id="7002165">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7002180">+</span>&nbsp;<span class="ident" id="7002182">stack</span><span class="op" id="7002187">(</span><span class="op" id="7002188">)</span><span class="op" id="7002189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7002194">panic</span><span class="op" id="7002199">(</span><span class="string" id="7002200">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7002222">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002230">freedFrom</span><span class="op" id="7002239">[</span><span class="ident" id="7002240">dbConn</span><span class="op" id="7002246">{</span><span class="ident" id="7002247">db</span><span class="op" id="7002249">,</span>&nbsp;<span class="ident" id="7002251">c</span><span class="op" id="7002252">}</span><span class="op" id="7002253">]</span>&nbsp;<span class="op" id="7002255">=</span>&nbsp;<span class="ident" id="7002257">stack</span><span class="op" id="7002262">(</span><span class="op" id="7002263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002266">}</span><br>
<span class="lineno"></span><span class="op" id="7002268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7002271">const</span>&nbsp;<span class="ident" id="7002277">fakeDBName</span>&nbsp;<span class="op" id="7002288">=</span>&nbsp;<span class="string" id="7002290">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7002297">var</span>&nbsp;<span class="ident" id="7002301">chrisBirthday</span>&nbsp;<span class="op" id="7002315">=</span>&nbsp;<span class="ident" id="7002317">time</span><span class="op" id="7002321">.</span><span class="ident" id="7002322">Unix</span><span class="op" id="7002326">(</span><span class="num" id="7002327">123456789</span><span class="op" id="7002336">,</span>&nbsp;<span class="num" id="7002338">0</span><span class="op" id="7002339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7002342">func</span>&nbsp;<span class="ident" id="7002347">newTestDB</span><span class="op" id="7002356">(</span><span class="ident" id="7002357">t</span>&nbsp;<span class="ident" id="7002359">testing</span><span class="op" id="7002366">.</span><span class="ident" id="7002367">TB</span><span class="op" id="7002369">,</span>&nbsp;<span class="ident" id="7002371">name</span>&nbsp;<span class="builtintype" id="7002376">string</span><span class="op" id="7002382">)</span>&nbsp;<span class="op" id="7002384">*</span><span class="ident" id="7002385">DB</span>&nbsp;<span class="op" id="7002388">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002391">db</span><span class="op" id="7002393">,</span>&nbsp;<span class="ident" id="7002395">err</span>&nbsp;<span class="op" id="7002399">:=</span>&nbsp;<span class="ident" id="7002402">Open</span><span class="op" id="7002406">(</span><span class="string" id="7002407">&#34;test&#34;</span><span class="op" id="7002413">,</span>&nbsp;<span class="ident" id="7002415">fakeDBName</span><span class="op" id="7002425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002428">if</span>&nbsp;<span class="ident" id="7002431">err</span>&nbsp;<span class="op" id="7002435">!=</span>&nbsp;<span class="ident" id="7002438">nil</span>&nbsp;<span class="op" id="7002442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002446">t</span><span class="op" id="7002447">.</span><span class="ident" id="7002448">Fatalf</span><span class="op" id="7002454">(</span><span class="string" id="7002455">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7002465">,</span>&nbsp;<span class="ident" id="7002467">err</span><span class="op" id="7002470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002476">if</span>&nbsp;<span class="ident" id="7002479">_</span><span class="op" id="7002480">,</span>&nbsp;<span class="ident" id="7002482">err</span>&nbsp;<span class="op" id="7002486">:=</span>&nbsp;<span class="ident" id="7002489">db</span><span class="op" id="7002491">.</span><span class="ident" id="7002492">Exec</span><span class="op" id="7002496">(</span><span class="string" id="7002497">&#34;WIPE&#34;</span><span class="op" id="7002503">)</span><span class="op" id="7002504">;</span>&nbsp;<span class="ident" id="7002506">err</span>&nbsp;<span class="op" id="7002510">!=</span>&nbsp;<span class="ident" id="7002513">nil</span>&nbsp;<span class="op" id="7002517">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002521">t</span><span class="op" id="7002522">.</span><span class="ident" id="7002523">Fatalf</span><span class="op" id="7002529">(</span><span class="string" id="7002530">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7002545">,</span>&nbsp;<span class="ident" id="7002547">err</span><span class="op" id="7002550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002556">if</span>&nbsp;<span class="ident" id="7002559">name</span>&nbsp;<span class="op" id="7002564">==</span>&nbsp;<span class="string" id="7002567">&#34;people&#34;</span>&nbsp;<span class="op" id="7002576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002580">exec</span><span class="op" id="7002584">(</span><span class="ident" id="7002585">t</span><span class="op" id="7002586">,</span>&nbsp;<span class="ident" id="7002588">db</span><span class="op" id="7002590">,</span>&nbsp;<span class="string" id="7002592">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7002665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002669">exec</span><span class="op" id="7002673">(</span><span class="ident" id="7002674">t</span><span class="op" id="7002675">,</span>&nbsp;<span class="ident" id="7002677">db</span><span class="op" id="7002679">,</span>&nbsp;<span class="string" id="7002681">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7002726">,</span>&nbsp;<span class="num" id="7002728">1</span><span class="op" id="7002729">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002733">exec</span><span class="op" id="7002737">(</span><span class="ident" id="7002738">t</span><span class="op" id="7002739">,</span>&nbsp;<span class="ident" id="7002741">db</span><span class="op" id="7002743">,</span>&nbsp;<span class="string" id="7002745">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7002788">,</span>&nbsp;<span class="num" id="7002790">2</span><span class="op" id="7002791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002795">exec</span><span class="op" id="7002799">(</span><span class="ident" id="7002800">t</span><span class="op" id="7002801">,</span>&nbsp;<span class="ident" id="7002803">db</span><span class="op" id="7002805">,</span>&nbsp;<span class="string" id="7002807">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7002860">,</span>&nbsp;<span class="num" id="7002862">3</span><span class="op" id="7002863">,</span>&nbsp;<span class="ident" id="7002865">chrisBirthday</span><span class="op" id="7002878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7002881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7002884">if</span>&nbsp;<span class="ident" id="7002887">name</span>&nbsp;<span class="op" id="7002892">==</span>&nbsp;<span class="string" id="7002895">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7002908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7002912">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7002971">exec</span><span class="op" id="7002975">(</span><span class="ident" id="7002976">t</span><span class="op" id="7002977">,</span>&nbsp;<span class="ident" id="7002979">db</span><span class="op" id="7002981">,</span>&nbsp;<span class="string" id="7002983">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7003025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003029">exec</span><span class="op" id="7003033">(</span><span class="ident" id="7003034">t</span><span class="op" id="7003035">,</span>&nbsp;<span class="ident" id="7003037">db</span><span class="op" id="7003039">,</span>&nbsp;<span class="string" id="7003041">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7003079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003085">return</span>&nbsp;<span class="ident" id="7003092">db</span><br>
<span class="lineno"></span><span class="op" id="7003095">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7003098">func</span>&nbsp;<span class="ident" id="7003103">exec</span><span class="op" id="7003107">(</span><span class="ident" id="7003108">t</span>&nbsp;<span class="ident" id="7003110">testing</span><span class="op" id="7003117">.</span><span class="ident" id="7003118">TB</span><span class="op" id="7003120">,</span>&nbsp;<span class="ident" id="7003122">db</span>&nbsp;<span class="op" id="7003125">*</span><span class="ident" id="7003126">DB</span><span class="op" id="7003128">,</span>&nbsp;<span class="ident" id="7003130">query</span>&nbsp;<span class="builtintype" id="7003136">string</span><span class="op" id="7003142">,</span>&nbsp;<span class="ident" id="7003144">args</span>&nbsp;<span class="op" id="7003149">...</span><span class="keyword" id="7003152">interface</span><span class="op" id="7003161">{</span><span class="op" id="7003162">}</span><span class="op" id="7003163">)</span>&nbsp;<span class="op" id="7003165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003168">_</span><span class="op" id="7003169">,</span>&nbsp;<span class="ident" id="7003171">err</span>&nbsp;<span class="op" id="7003175">:=</span>&nbsp;<span class="ident" id="7003178">db</span><span class="op" id="7003180">.</span><span class="ident" id="7003181">Exec</span><span class="op" id="7003185">(</span><span class="ident" id="7003186">query</span><span class="op" id="7003191">,</span>&nbsp;<span class="ident" id="7003193">args</span><span class="op" id="7003197">...</span><span class="op" id="7003200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003203">if</span>&nbsp;<span class="ident" id="7003206">err</span>&nbsp;<span class="op" id="7003210">!=</span>&nbsp;<span class="ident" id="7003213">nil</span>&nbsp;<span class="op" id="7003217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003221">t</span><span class="op" id="7003222">.</span><span class="ident" id="7003223">Fatalf</span><span class="op" id="7003229">(</span><span class="string" id="7003230">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7003246">,</span>&nbsp;<span class="ident" id="7003248">query</span><span class="op" id="7003253">,</span>&nbsp;<span class="ident" id="7003255">err</span><span class="op" id="7003258">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003261">}</span><br>
<span class="lineno"></span><span class="op" id="7003263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7003266">func</span>&nbsp;<span class="ident" id="7003271">closeDB</span><span class="op" id="7003278">(</span><span class="ident" id="7003279">t</span>&nbsp;<span class="ident" id="7003281">testing</span><span class="op" id="7003288">.</span><span class="ident" id="7003289">TB</span><span class="op" id="7003291">,</span>&nbsp;<span class="ident" id="7003293">db</span>&nbsp;<span class="op" id="7003296">*</span><span class="ident" id="7003297">DB</span><span class="op" id="7003299">)</span>&nbsp;<span class="op" id="7003301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003304">if</span>&nbsp;<span class="ident" id="7003307">e</span>&nbsp;<span class="op" id="7003309">:=</span>&nbsp;<span class="builtinfunc" id="7003312">recover</span><span class="op" id="7003319">(</span><span class="op" id="7003320">)</span><span class="op" id="7003321">;</span>&nbsp;<span class="ident" id="7003323">e</span>&nbsp;<span class="op" id="7003325">!=</span>&nbsp;<span class="ident" id="7003328">nil</span>&nbsp;<span class="op" id="7003332">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003336">fmt</span><span class="op" id="7003339">.</span><span class="ident" id="7003340">Printf</span><span class="op" id="7003346">(</span><span class="string" id="7003347">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7003360">,</span>&nbsp;<span class="ident" id="7003362">e</span><span class="op" id="7003363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7003367">panic</span><span class="op" id="7003372">(</span><span class="ident" id="7003373">e</span><span class="op" id="7003374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003380">defer</span>&nbsp;<span class="ident" id="7003386">setHookpostCloseConn</span><span class="op" id="7003406">(</span><span class="ident" id="7003407">nil</span><span class="op" id="7003410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003413">setHookpostCloseConn</span><span class="op" id="7003433">(</span><span class="keyword" id="7003434">func</span><span class="op" id="7003438">(</span><span class="ident" id="7003439">_</span>&nbsp;<span class="op" id="7003441">*</span><span class="ident" id="7003442">fakeConn</span><span class="op" id="7003450">,</span>&nbsp;<span class="ident" id="7003452">err</span>&nbsp;<span class="builtintype" id="7003456">error</span><span class="op" id="7003461">)</span>&nbsp;<span class="op" id="7003463">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003467">if</span>&nbsp;<span class="ident" id="7003470">err</span>&nbsp;<span class="op" id="7003474">!=</span>&nbsp;<span class="ident" id="7003477">nil</span>&nbsp;<span class="op" id="7003481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003486">t</span><span class="op" id="7003487">.</span><span class="ident" id="7003488">Errorf</span><span class="op" id="7003494">(</span><span class="string" id="7003495">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7003523">,</span>&nbsp;<span class="ident" id="7003525">err</span><span class="op" id="7003528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003535">}</span><span class="op" id="7003536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003539">for</span>&nbsp;<span class="ident" id="7003543">i</span><span class="op" id="7003544">,</span>&nbsp;<span class="ident" id="7003546">dc</span>&nbsp;<span class="op" id="7003549">:=</span>&nbsp;<span class="keyword" id="7003552">range</span>&nbsp;<span class="ident" id="7003558">db</span><span class="op" id="7003560">.</span><span class="ident" id="7003561">freeConn</span>&nbsp;<span class="op" id="7003570">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003574">if</span>&nbsp;<span class="ident" id="7003577">n</span>&nbsp;<span class="op" id="7003579">:=</span>&nbsp;<span class="builtinfunc" id="7003582">len</span><span class="op" id="7003585">(</span><span class="ident" id="7003586">dc</span><span class="op" id="7003588">.</span><span class="ident" id="7003589">openStmt</span><span class="op" id="7003597">)</span><span class="op" id="7003598">;</span>&nbsp;<span class="ident" id="7003600">n</span>&nbsp;<span class="op" id="7003602">&gt;</span>&nbsp;<span class="num" id="7003604">0</span>&nbsp;<span class="op" id="7003606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7003611">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7003655">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7003704">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7003753">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7003800">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003829">t</span><span class="op" id="7003830">.</span><span class="ident" id="7003831">Errorf</span><span class="op" id="7003837">(</span><span class="string" id="7003838">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7003898">,</span>&nbsp;<span class="ident" id="7003900">i</span><span class="op" id="7003901">,</span>&nbsp;<span class="builtinfunc" id="7003903">len</span><span class="op" id="7003906">(</span><span class="ident" id="7003907">db</span><span class="op" id="7003909">.</span><span class="ident" id="7003910">freeConn</span><span class="op" id="7003918">)</span><span class="op" id="7003919">,</span>&nbsp;<span class="ident" id="7003921">n</span><span class="op" id="7003922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7003929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003932">err</span>&nbsp;<span class="op" id="7003936">:=</span>&nbsp;<span class="ident" id="7003939">db</span><span class="op" id="7003941">.</span><span class="ident" id="7003942">Close</span><span class="op" id="7003947">(</span><span class="op" id="7003948">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7003951">if</span>&nbsp;<span class="ident" id="7003954">err</span>&nbsp;<span class="op" id="7003958">!=</span>&nbsp;<span class="ident" id="7003961">nil</span>&nbsp;<span class="op" id="7003965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7003969">t</span><span class="op" id="7003970">.</span><span class="ident" id="7003971">Fatalf</span><span class="op" id="7003977">(</span><span class="string" id="7003978">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7004000">,</span>&nbsp;<span class="ident" id="7004002">err</span><span class="op" id="7004005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004011">db</span><span class="op" id="7004013">.</span><span class="ident" id="7004014">mu</span><span class="op" id="7004016">.</span><span class="ident" id="7004017">Lock</span><span class="op" id="7004021">(</span><span class="op" id="7004022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004025">count</span>&nbsp;<span class="op" id="7004031">:=</span>&nbsp;<span class="ident" id="7004034">db</span><span class="op" id="7004036">.</span><span class="ident" id="7004037">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004046">db</span><span class="op" id="7004048">.</span><span class="ident" id="7004049">mu</span><span class="op" id="7004051">.</span><span class="ident" id="7004052">Unlock</span><span class="op" id="7004058">(</span><span class="op" id="7004059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004062">if</span>&nbsp;<span class="ident" id="7004065">count</span>&nbsp;<span class="op" id="7004071">!=</span>&nbsp;<span class="num" id="7004074">0</span>&nbsp;<span class="op" id="7004076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004080">t</span><span class="op" id="7004081">.</span><span class="ident" id="7004082">Fatalf</span><span class="op" id="7004088">(</span><span class="string" id="7004089">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7004133">,</span>&nbsp;<span class="ident" id="7004135">db</span><span class="op" id="7004137">.</span><span class="ident" id="7004138">numOpen</span><span class="op" id="7004145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004148">}</span><br>
<span class="lineno"></span><span class="op" id="7004150">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7004153">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7004220">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7004253">func</span>&nbsp;<span class="ident" id="7004258">numPrepares</span><span class="op" id="7004269">(</span><span class="ident" id="7004270">t</span>&nbsp;<span class="op" id="7004272">*</span><span class="ident" id="7004273">testing</span><span class="op" id="7004280">.</span><span class="ident" id="7004281">T</span><span class="op" id="7004282">,</span>&nbsp;<span class="ident" id="7004284">db</span>&nbsp;<span class="op" id="7004287">*</span><span class="ident" id="7004288">DB</span><span class="op" id="7004290">)</span>&nbsp;<span class="builtintype" id="7004292">int</span>&nbsp;<span class="op" id="7004296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004299">if</span>&nbsp;<span class="ident" id="7004302">n</span>&nbsp;<span class="op" id="7004304">:=</span>&nbsp;<span class="builtinfunc" id="7004307">len</span><span class="op" id="7004310">(</span><span class="ident" id="7004311">db</span><span class="op" id="7004313">.</span><span class="ident" id="7004314">freeConn</span><span class="op" id="7004322">)</span><span class="op" id="7004323">;</span>&nbsp;<span class="ident" id="7004325">n</span>&nbsp;<span class="op" id="7004327">!=</span>&nbsp;<span class="num" id="7004330">1</span>&nbsp;<span class="op" id="7004332">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004336">t</span><span class="op" id="7004337">.</span><span class="ident" id="7004338">Fatalf</span><span class="op" id="7004344">(</span><span class="string" id="7004345">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7004370">,</span>&nbsp;<span class="ident" id="7004372">n</span><span class="op" id="7004373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004379">return</span>&nbsp;<span class="ident" id="7004386">db</span><span class="op" id="7004388">.</span><span class="ident" id="7004389">freeConn</span><span class="op" id="7004397">[</span><span class="num" id="7004398">0</span><span class="op" id="7004399">]</span><span class="op" id="7004400">.</span><span class="ident" id="7004401">ci</span><span class="op" id="7004403">.</span><span class="op" id="7004404">(</span><span class="op" id="7004405">*</span><span class="ident" id="7004406">fakeConn</span><span class="op" id="7004414">)</span><span class="op" id="7004415">.</span><span class="ident" id="7004416">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7004427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7004430">func</span>&nbsp;<span class="op" id="7004435">(</span><span class="ident" id="7004436">db</span>&nbsp;<span class="op" id="7004439">*</span><span class="ident" id="7004440">DB</span><span class="op" id="7004442">)</span>&nbsp;<span class="ident" id="7004444">numDeps</span><span class="op" id="7004451">(</span><span class="op" id="7004452">)</span>&nbsp;<span class="builtintype" id="7004454">int</span>&nbsp;<span class="op" id="7004458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004461">db</span><span class="op" id="7004463">.</span><span class="ident" id="7004464">mu</span><span class="op" id="7004466">.</span><span class="ident" id="7004467">Lock</span><span class="op" id="7004471">(</span><span class="op" id="7004472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004475">defer</span>&nbsp;<span class="ident" id="7004481">db</span><span class="op" id="7004483">.</span><span class="ident" id="7004484">mu</span><span class="op" id="7004486">.</span><span class="ident" id="7004487">Unlock</span><span class="op" id="7004493">(</span><span class="op" id="7004494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004497">return</span>&nbsp;<span class="builtinfunc" id="7004504">len</span><span class="op" id="7004507">(</span><span class="ident" id="7004508">db</span><span class="op" id="7004510">.</span><span class="ident" id="7004511">dep</span><span class="op" id="7004514">)</span><br>
<span class="lineno"></span><span class="op" id="7004516">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7004519">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7004589">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7004634">func</span>&nbsp;<span class="op" id="7004639">(</span><span class="ident" id="7004640">db</span>&nbsp;<span class="op" id="7004643">*</span><span class="ident" id="7004644">DB</span><span class="op" id="7004646">)</span>&nbsp;<span class="ident" id="7004648">numDepsPollUntil</span><span class="op" id="7004664">(</span><span class="ident" id="7004665">want</span>&nbsp;<span class="builtintype" id="7004670">int</span><span class="op" id="7004673">,</span>&nbsp;<span class="ident" id="7004675">d</span>&nbsp;<span class="ident" id="7004677">time</span><span class="op" id="7004681">.</span><span class="ident" id="7004682">Duration</span><span class="op" id="7004690">)</span>&nbsp;<span class="builtintype" id="7004692">int</span>&nbsp;<span class="op" id="7004696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004699">deadline</span>&nbsp;<span class="op" id="7004708">:=</span>&nbsp;<span class="ident" id="7004711">time</span><span class="op" id="7004715">.</span><span class="ident" id="7004716">Now</span><span class="op" id="7004719">(</span><span class="op" id="7004720">)</span><span class="op" id="7004721">.</span><span class="ident" id="7004722">Add</span><span class="op" id="7004725">(</span><span class="ident" id="7004726">d</span><span class="op" id="7004727">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004730">for</span>&nbsp;<span class="op" id="7004734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004738">n</span>&nbsp;<span class="op" id="7004740">:=</span>&nbsp;<span class="ident" id="7004743">db</span><span class="op" id="7004745">.</span><span class="ident" id="7004746">numDeps</span><span class="op" id="7004753">(</span><span class="op" id="7004754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004758">if</span>&nbsp;<span class="ident" id="7004761">n</span>&nbsp;<span class="op" id="7004763">&lt;=</span>&nbsp;<span class="ident" id="7004766">want</span>&nbsp;<span class="op" id="7004771">||</span>&nbsp;<span class="ident" id="7004774">time</span><span class="op" id="7004778">.</span><span class="ident" id="7004779">Now</span><span class="op" id="7004782">(</span><span class="op" id="7004783">)</span><span class="op" id="7004784">.</span><span class="ident" id="7004785">After</span><span class="op" id="7004790">(</span><span class="ident" id="7004791">deadline</span><span class="op" id="7004799">)</span>&nbsp;<span class="op" id="7004801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004806">return</span>&nbsp;<span class="ident" id="7004813">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004817">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004821">time</span><span class="op" id="7004825">.</span><span class="ident" id="7004826">Sleep</span><span class="op" id="7004831">(</span><span class="num" id="7004832">50</span>&nbsp;<span class="op" id="7004835">*</span>&nbsp;<span class="ident" id="7004837">time</span><span class="op" id="7004841">.</span><span class="ident" id="7004842">Millisecond</span><span class="op" id="7004853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7004856">}</span><br>
<span class="lineno"></span><span class="op" id="7004858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7004861">func</span>&nbsp;<span class="op" id="7004866">(</span><span class="ident" id="7004867">db</span>&nbsp;<span class="op" id="7004870">*</span><span class="ident" id="7004871">DB</span><span class="op" id="7004873">)</span>&nbsp;<span class="ident" id="7004875">numFreeConns</span><span class="op" id="7004887">(</span><span class="op" id="7004888">)</span>&nbsp;<span class="builtintype" id="7004890">int</span>&nbsp;<span class="op" id="7004894">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7004897">db</span><span class="op" id="7004899">.</span><span class="ident" id="7004900">mu</span><span class="op" id="7004902">.</span><span class="ident" id="7004903">Lock</span><span class="op" id="7004907">(</span><span class="op" id="7004908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004911">defer</span>&nbsp;<span class="ident" id="7004917">db</span><span class="op" id="7004919">.</span><span class="ident" id="7004920">mu</span><span class="op" id="7004922">.</span><span class="ident" id="7004923">Unlock</span><span class="op" id="7004929">(</span><span class="op" id="7004930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7004933">return</span>&nbsp;<span class="builtinfunc" id="7004940">len</span><span class="op" id="7004943">(</span><span class="ident" id="7004944">db</span><span class="op" id="7004946">.</span><span class="ident" id="7004947">freeConn</span><span class="op" id="7004955">)</span><br>
<span class="lineno"></span><span class="op" id="7004957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7004960">func</span>&nbsp;<span class="op" id="7004965">(</span><span class="ident" id="7004966">db</span>&nbsp;<span class="op" id="7004969">*</span><span class="ident" id="7004970">DB</span><span class="op" id="7004972">)</span>&nbsp;<span class="ident" id="7004974">dumpDeps</span><span class="op" id="7004982">(</span><span class="ident" id="7004983">t</span>&nbsp;<span class="op" id="7004985">*</span><span class="ident" id="7004986">testing</span><span class="op" id="7004993">.</span><span class="ident" id="7004994">T</span><span class="op" id="7004995">)</span>&nbsp;<span class="op" id="7004997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005000">for</span>&nbsp;<span class="ident" id="7005004">fc</span>&nbsp;<span class="op" id="7005007">:=</span>&nbsp;<span class="keyword" id="7005010">range</span>&nbsp;<span class="ident" id="7005016">db</span><span class="op" id="7005018">.</span><span class="ident" id="7005019">dep</span>&nbsp;<span class="op" id="7005023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005027">db</span><span class="op" id="7005029">.</span><span class="ident" id="7005030">dumpDep</span><span class="op" id="7005037">(</span><span class="ident" id="7005038">t</span><span class="op" id="7005039">,</span>&nbsp;<span class="num" id="7005041">0</span><span class="op" id="7005042">,</span>&nbsp;<span class="ident" id="7005044">fc</span><span class="op" id="7005046">,</span>&nbsp;<span class="keyword" id="7005048">map</span><span class="op" id="7005051">[</span><span class="ident" id="7005052">finalCloser</span><span class="op" id="7005063">]</span><span class="builtintype" id="7005064">bool</span><span class="op" id="7005068">{</span><span class="op" id="7005069">}</span><span class="op" id="7005070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005073">}</span><br>
<span class="lineno"></span><span class="op" id="7005075">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7005078">func</span>&nbsp;<span class="op" id="7005083">(</span><span class="ident" id="7005084">db</span>&nbsp;<span class="op" id="7005087">*</span><span class="ident" id="7005088">DB</span><span class="op" id="7005090">)</span>&nbsp;<span class="ident" id="7005092">dumpDep</span><span class="op" id="7005099">(</span><span class="ident" id="7005100">t</span>&nbsp;<span class="op" id="7005102">*</span><span class="ident" id="7005103">testing</span><span class="op" id="7005110">.</span><span class="ident" id="7005111">T</span><span class="op" id="7005112">,</span>&nbsp;<span class="ident" id="7005114">depth</span>&nbsp;<span class="builtintype" id="7005120">int</span><span class="op" id="7005123">,</span>&nbsp;<span class="ident" id="7005125">dep</span>&nbsp;<span class="ident" id="7005129">finalCloser</span><span class="op" id="7005140">,</span>&nbsp;<span class="ident" id="7005142">seen</span>&nbsp;<span class="keyword" id="7005147">map</span><span class="op" id="7005150">[</span><span class="ident" id="7005151">finalCloser</span><span class="op" id="7005162">]</span><span class="builtintype" id="7005163">bool</span><span class="op" id="7005167">)</span>&nbsp;<span class="op" id="7005169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005172">seen</span><span class="op" id="7005176">[</span><span class="ident" id="7005177">dep</span><span class="op" id="7005180">]</span>&nbsp;<span class="op" id="7005182">=</span>&nbsp;<span class="builtintype" id="7005184">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005190">indent</span>&nbsp;<span class="op" id="7005197">:=</span>&nbsp;<span class="ident" id="7005200">strings</span><span class="op" id="7005207">.</span><span class="ident" id="7005208">Repeat</span><span class="op" id="7005214">(</span><span class="string" id="7005215">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7005219">,</span>&nbsp;<span class="ident" id="7005221">depth</span><span class="op" id="7005226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005229">ds</span>&nbsp;<span class="op" id="7005232">:=</span>&nbsp;<span class="ident" id="7005235">db</span><span class="op" id="7005237">.</span><span class="ident" id="7005238">dep</span><span class="op" id="7005241">[</span><span class="ident" id="7005242">dep</span><span class="op" id="7005245">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005248">for</span>&nbsp;<span class="ident" id="7005252">k</span>&nbsp;<span class="op" id="7005254">:=</span>&nbsp;<span class="keyword" id="7005257">range</span>&nbsp;<span class="ident" id="7005263">ds</span>&nbsp;<span class="op" id="7005266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005270">t</span><span class="op" id="7005271">.</span><span class="ident" id="7005272">Logf</span><span class="op" id="7005276">(</span><span class="string" id="7005277">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7005311">,</span>&nbsp;<span class="ident" id="7005313">indent</span><span class="op" id="7005319">,</span>&nbsp;<span class="ident" id="7005321">dep</span><span class="op" id="7005324">,</span>&nbsp;<span class="ident" id="7005326">dep</span><span class="op" id="7005329">,</span>&nbsp;<span class="ident" id="7005331">k</span><span class="op" id="7005332">,</span>&nbsp;<span class="ident" id="7005334">k</span><span class="op" id="7005335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005339">if</span>&nbsp;<span class="ident" id="7005342">fc</span><span class="op" id="7005344">,</span>&nbsp;<span class="ident" id="7005346">ok</span>&nbsp;<span class="op" id="7005349">:=</span>&nbsp;<span class="ident" id="7005352">k</span><span class="op" id="7005353">.</span><span class="op" id="7005354">(</span><span class="ident" id="7005355">finalCloser</span><span class="op" id="7005366">)</span><span class="op" id="7005367">;</span>&nbsp;<span class="ident" id="7005369">ok</span>&nbsp;<span class="op" id="7005372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005377">if</span>&nbsp;<span class="op" id="7005380">!</span><span class="ident" id="7005381">seen</span><span class="op" id="7005385">[</span><span class="ident" id="7005386">fc</span><span class="op" id="7005388">]</span>&nbsp;<span class="op" id="7005390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005396">db</span><span class="op" id="7005398">.</span><span class="ident" id="7005399">dumpDep</span><span class="op" id="7005406">(</span><span class="ident" id="7005407">t</span><span class="op" id="7005408">,</span>&nbsp;<span class="ident" id="7005410">depth</span><span class="op" id="7005415">+</span><span class="num" id="7005416">1</span><span class="op" id="7005417">,</span>&nbsp;<span class="ident" id="7005419">fc</span><span class="op" id="7005421">,</span>&nbsp;<span class="ident" id="7005423">seen</span><span class="op" id="7005427">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005439">}</span><br>
<span class="lineno"></span><span class="op" id="7005441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7005444">func</span>&nbsp;<span class="ident" id="7005449">TestQuery</span><span class="op" id="7005458">(</span><span class="ident" id="7005459">t</span>&nbsp;<span class="op" id="7005461">*</span><span class="ident" id="7005462">testing</span><span class="op" id="7005469">.</span><span class="ident" id="7005470">T</span><span class="op" id="7005471">)</span>&nbsp;<span class="op" id="7005473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005476">db</span>&nbsp;<span class="op" id="7005479">:=</span>&nbsp;<span class="ident" id="7005482">newTestDB</span><span class="op" id="7005491">(</span><span class="ident" id="7005492">t</span><span class="op" id="7005493">,</span>&nbsp;<span class="string" id="7005495">&#34;people&#34;</span><span class="op" id="7005503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005506">defer</span>&nbsp;<span class="ident" id="7005512">closeDB</span><span class="op" id="7005519">(</span><span class="ident" id="7005520">t</span><span class="op" id="7005521">,</span>&nbsp;<span class="ident" id="7005523">db</span><span class="op" id="7005525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005528">prepares0</span>&nbsp;<span class="op" id="7005538">:=</span>&nbsp;<span class="ident" id="7005541">numPrepares</span><span class="op" id="7005552">(</span><span class="ident" id="7005553">t</span><span class="op" id="7005554">,</span>&nbsp;<span class="ident" id="7005556">db</span><span class="op" id="7005558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005561">rows</span><span class="op" id="7005565">,</span>&nbsp;<span class="ident" id="7005567">err</span>&nbsp;<span class="op" id="7005571">:=</span>&nbsp;<span class="ident" id="7005574">db</span><span class="op" id="7005576">.</span><span class="ident" id="7005577">Query</span><span class="op" id="7005582">(</span><span class="string" id="7005583">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7005608">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005611">if</span>&nbsp;<span class="ident" id="7005614">err</span>&nbsp;<span class="op" id="7005618">!=</span>&nbsp;<span class="ident" id="7005621">nil</span>&nbsp;<span class="op" id="7005625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005629">t</span><span class="op" id="7005630">.</span><span class="ident" id="7005631">Fatalf</span><span class="op" id="7005637">(</span><span class="string" id="7005638">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7005649">,</span>&nbsp;<span class="ident" id="7005651">err</span><span class="op" id="7005654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005660">type</span>&nbsp;<span class="ident" id="7005665">row</span>&nbsp;<span class="keyword" id="7005669">struct</span>&nbsp;<span class="op" id="7005676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005680">age</span>&nbsp;&nbsp;<span class="builtintype" id="7005685">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005691">name</span>&nbsp;<span class="builtintype" id="7005696">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005707">got</span>&nbsp;<span class="op" id="7005711">:=</span>&nbsp;<span class="op" id="7005714">[</span><span class="op" id="7005715">]</span><span class="ident" id="7005716">row</span><span class="op" id="7005719">{</span><span class="op" id="7005720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005723">for</span>&nbsp;<span class="ident" id="7005727">rows</span><span class="op" id="7005731">.</span><span class="ident" id="7005732">Next</span><span class="op" id="7005736">(</span><span class="op" id="7005737">)</span>&nbsp;<span class="op" id="7005739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005743">var</span>&nbsp;<span class="ident" id="7005747">r</span>&nbsp;<span class="ident" id="7005749">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005755">err</span>&nbsp;<span class="op" id="7005759">=</span>&nbsp;<span class="ident" id="7005761">rows</span><span class="op" id="7005765">.</span><span class="ident" id="7005766">Scan</span><span class="op" id="7005770">(</span><span class="op" id="7005771">&amp;</span><span class="ident" id="7005772">r</span><span class="op" id="7005773">.</span><span class="ident" id="7005774">age</span><span class="op" id="7005777">,</span>&nbsp;<span class="op" id="7005779">&amp;</span><span class="ident" id="7005780">r</span><span class="op" id="7005781">.</span><span class="ident" id="7005782">name</span><span class="op" id="7005786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005790">if</span>&nbsp;<span class="ident" id="7005793">err</span>&nbsp;<span class="op" id="7005797">!=</span>&nbsp;<span class="ident" id="7005800">nil</span>&nbsp;<span class="op" id="7005804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005809">t</span><span class="op" id="7005810">.</span><span class="ident" id="7005811">Fatalf</span><span class="op" id="7005817">(</span><span class="string" id="7005818">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7005828">,</span>&nbsp;<span class="ident" id="7005830">err</span><span class="op" id="7005833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005841">got</span>&nbsp;<span class="op" id="7005845">=</span>&nbsp;<span class="builtinfunc" id="7005847">append</span><span class="op" id="7005853">(</span><span class="ident" id="7005854">got</span><span class="op" id="7005857">,</span>&nbsp;<span class="ident" id="7005859">r</span><span class="op" id="7005860">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005866">err</span>&nbsp;<span class="op" id="7005870">=</span>&nbsp;<span class="ident" id="7005872">rows</span><span class="op" id="7005876">.</span><span class="ident" id="7005877">Err</span><span class="op" id="7005880">(</span><span class="op" id="7005881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7005884">if</span>&nbsp;<span class="ident" id="7005887">err</span>&nbsp;<span class="op" id="7005891">!=</span>&nbsp;<span class="ident" id="7005894">nil</span>&nbsp;<span class="op" id="7005898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005902">t</span><span class="op" id="7005903">.</span><span class="ident" id="7005904">Fatalf</span><span class="op" id="7005910">(</span><span class="string" id="7005911">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7005920">,</span>&nbsp;<span class="ident" id="7005922">err</span><span class="op" id="7005925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005928">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7005931">want</span>&nbsp;<span class="op" id="7005936">:=</span>&nbsp;<span class="op" id="7005939">[</span><span class="op" id="7005940">]</span><span class="ident" id="7005941">row</span><span class="op" id="7005944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005948">{</span><span class="ident" id="7005949">age</span><span class="op" id="7005952">:</span>&nbsp;<span class="num" id="7005954">1</span><span class="op" id="7005955">,</span>&nbsp;<span class="ident" id="7005957">name</span><span class="op" id="7005961">:</span>&nbsp;<span class="string" id="7005963">&#34;Alice&#34;</span><span class="op" id="7005970">}</span><span class="op" id="7005971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7005975">{</span><span class="ident" id="7005976">age</span><span class="op" id="7005979">:</span>&nbsp;<span class="num" id="7005981">2</span><span class="op" id="7005982">,</span>&nbsp;<span class="ident" id="7005984">name</span><span class="op" id="7005988">:</span>&nbsp;<span class="string" id="7005990">&#34;Bob&#34;</span><span class="op" id="7005995">}</span><span class="op" id="7005996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006000">{</span><span class="ident" id="7006001">age</span><span class="op" id="7006004">:</span>&nbsp;<span class="num" id="7006006">3</span><span class="op" id="7006007">,</span>&nbsp;<span class="ident" id="7006009">name</span><span class="op" id="7006013">:</span>&nbsp;<span class="string" id="7006015">&#34;Chris&#34;</span><span class="op" id="7006022">}</span><span class="op" id="7006023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006026">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006029">if</span>&nbsp;<span class="op" id="7006032">!</span><span class="ident" id="7006033">reflect</span><span class="op" id="7006040">.</span><span class="ident" id="7006041">DeepEqual</span><span class="op" id="7006050">(</span><span class="ident" id="7006051">got</span><span class="op" id="7006054">,</span>&nbsp;<span class="ident" id="7006056">want</span><span class="op" id="7006060">)</span>&nbsp;<span class="op" id="7006062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006066">t</span><span class="op" id="7006067">.</span><span class="ident" id="7006068">Errorf</span><span class="op" id="7006074">(</span><span class="string" id="7006075">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7006108">,</span>&nbsp;<span class="ident" id="7006110">got</span><span class="op" id="7006113">,</span>&nbsp;<span class="ident" id="7006115">want</span><span class="op" id="7006119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7006126">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7006189">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006226">if</span>&nbsp;<span class="ident" id="7006229">n</span>&nbsp;<span class="op" id="7006231">:=</span>&nbsp;<span class="ident" id="7006234">db</span><span class="op" id="7006236">.</span><span class="ident" id="7006237">numFreeConns</span><span class="op" id="7006249">(</span><span class="op" id="7006250">)</span><span class="op" id="7006251">;</span>&nbsp;<span class="ident" id="7006253">n</span>&nbsp;<span class="op" id="7006255">!=</span>&nbsp;<span class="num" id="7006258">1</span>&nbsp;<span class="op" id="7006260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006264">t</span><span class="op" id="7006265">.</span><span class="ident" id="7006266">Fatalf</span><span class="op" id="7006272">(</span><span class="string" id="7006273">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7006322">,</span>&nbsp;<span class="ident" id="7006324">n</span><span class="op" id="7006325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006331">if</span>&nbsp;<span class="ident" id="7006334">prepares</span>&nbsp;<span class="op" id="7006343">:=</span>&nbsp;<span class="ident" id="7006346">numPrepares</span><span class="op" id="7006357">(</span><span class="ident" id="7006358">t</span><span class="op" id="7006359">,</span>&nbsp;<span class="ident" id="7006361">db</span><span class="op" id="7006363">)</span>&nbsp;<span class="op" id="7006365">-</span>&nbsp;<span class="ident" id="7006367">prepares0</span><span class="op" id="7006376">;</span>&nbsp;<span class="ident" id="7006378">prepares</span>&nbsp;<span class="op" id="7006387">!=</span>&nbsp;<span class="num" id="7006390">1</span>&nbsp;<span class="op" id="7006392">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006396">t</span><span class="op" id="7006397">.</span><span class="ident" id="7006398">Errorf</span><span class="op" id="7006404">(</span><span class="string" id="7006405">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7006445">,</span>&nbsp;<span class="ident" id="7006447">prepares</span><span class="op" id="7006455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006458">}</span><br>
<span class="lineno"></span><span class="op" id="7006460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7006463">func</span>&nbsp;<span class="ident" id="7006468">TestByteOwnership</span><span class="op" id="7006485">(</span><span class="ident" id="7006486">t</span>&nbsp;<span class="op" id="7006488">*</span><span class="ident" id="7006489">testing</span><span class="op" id="7006496">.</span><span class="ident" id="7006497">T</span><span class="op" id="7006498">)</span>&nbsp;<span class="op" id="7006500">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006503">db</span>&nbsp;<span class="op" id="7006506">:=</span>&nbsp;<span class="ident" id="7006509">newTestDB</span><span class="op" id="7006518">(</span><span class="ident" id="7006519">t</span><span class="op" id="7006520">,</span>&nbsp;<span class="string" id="7006522">&#34;people&#34;</span><span class="op" id="7006530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006533">defer</span>&nbsp;<span class="ident" id="7006539">closeDB</span><span class="op" id="7006546">(</span><span class="ident" id="7006547">t</span><span class="op" id="7006548">,</span>&nbsp;<span class="ident" id="7006550">db</span><span class="op" id="7006552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006555">rows</span><span class="op" id="7006559">,</span>&nbsp;<span class="ident" id="7006561">err</span>&nbsp;<span class="op" id="7006565">:=</span>&nbsp;<span class="ident" id="7006568">db</span><span class="op" id="7006570">.</span><span class="ident" id="7006571">Query</span><span class="op" id="7006576">(</span><span class="string" id="7006577">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7006604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006607">if</span>&nbsp;<span class="ident" id="7006610">err</span>&nbsp;<span class="op" id="7006614">!=</span>&nbsp;<span class="ident" id="7006617">nil</span>&nbsp;<span class="op" id="7006621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006625">t</span><span class="op" id="7006626">.</span><span class="ident" id="7006627">Fatalf</span><span class="op" id="7006633">(</span><span class="string" id="7006634">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7006645">,</span>&nbsp;<span class="ident" id="7006647">err</span><span class="op" id="7006650">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006656">type</span>&nbsp;<span class="ident" id="7006661">row</span>&nbsp;<span class="keyword" id="7006665">struct</span>&nbsp;<span class="op" id="7006672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006676">name</span>&nbsp;&nbsp;<span class="op" id="7006682">[</span><span class="op" id="7006683">]</span><span class="builtintype" id="7006684">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006691">photo</span>&nbsp;<span class="ident" id="7006697">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006707">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006710">got</span>&nbsp;<span class="op" id="7006714">:=</span>&nbsp;<span class="op" id="7006717">[</span><span class="op" id="7006718">]</span><span class="ident" id="7006719">row</span><span class="op" id="7006722">{</span><span class="op" id="7006723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006726">for</span>&nbsp;<span class="ident" id="7006730">rows</span><span class="op" id="7006734">.</span><span class="ident" id="7006735">Next</span><span class="op" id="7006739">(</span><span class="op" id="7006740">)</span>&nbsp;<span class="op" id="7006742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006746">var</span>&nbsp;<span class="ident" id="7006750">r</span>&nbsp;<span class="ident" id="7006752">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006758">err</span>&nbsp;<span class="op" id="7006762">=</span>&nbsp;<span class="ident" id="7006764">rows</span><span class="op" id="7006768">.</span><span class="ident" id="7006769">Scan</span><span class="op" id="7006773">(</span><span class="op" id="7006774">&amp;</span><span class="ident" id="7006775">r</span><span class="op" id="7006776">.</span><span class="ident" id="7006777">name</span><span class="op" id="7006781">,</span>&nbsp;<span class="op" id="7006783">&amp;</span><span class="ident" id="7006784">r</span><span class="op" id="7006785">.</span><span class="ident" id="7006786">photo</span><span class="op" id="7006791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006795">if</span>&nbsp;<span class="ident" id="7006798">err</span>&nbsp;<span class="op" id="7006802">!=</span>&nbsp;<span class="ident" id="7006805">nil</span>&nbsp;<span class="op" id="7006809">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006814">t</span><span class="op" id="7006815">.</span><span class="ident" id="7006816">Fatalf</span><span class="op" id="7006822">(</span><span class="string" id="7006823">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7006833">,</span>&nbsp;<span class="ident" id="7006835">err</span><span class="op" id="7006838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006846">got</span>&nbsp;<span class="op" id="7006850">=</span>&nbsp;<span class="builtinfunc" id="7006852">append</span><span class="op" id="7006858">(</span><span class="ident" id="7006859">got</span><span class="op" id="7006862">,</span>&nbsp;<span class="ident" id="7006864">r</span><span class="op" id="7006865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006871">corruptMemory</span>&nbsp;<span class="op" id="7006885">:=</span>&nbsp;<span class="op" id="7006888">[</span><span class="op" id="7006889">]</span><span class="builtintype" id="7006890">byte</span><span class="op" id="7006894">(</span><span class="string" id="7006895">&#34;\xffPHOTO&#34;</span><span class="op" id="7006906">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006909">want</span>&nbsp;<span class="op" id="7006914">:=</span>&nbsp;<span class="op" id="7006917">[</span><span class="op" id="7006918">]</span><span class="ident" id="7006919">row</span><span class="op" id="7006922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006926">{</span><span class="ident" id="7006927">name</span><span class="op" id="7006931">:</span>&nbsp;<span class="op" id="7006933">[</span><span class="op" id="7006934">]</span><span class="builtintype" id="7006935">byte</span><span class="op" id="7006939">(</span><span class="string" id="7006940">&#34;Alice&#34;</span><span class="op" id="7006947">)</span><span class="op" id="7006948">,</span>&nbsp;<span class="ident" id="7006950">photo</span><span class="op" id="7006955">:</span>&nbsp;<span class="ident" id="7006957">corruptMemory</span><span class="op" id="7006970">}</span><span class="op" id="7006971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006975">{</span><span class="ident" id="7006976">name</span><span class="op" id="7006980">:</span>&nbsp;<span class="op" id="7006982">[</span><span class="op" id="7006983">]</span><span class="builtintype" id="7006984">byte</span><span class="op" id="7006988">(</span><span class="string" id="7006989">&#34;Bob&#34;</span><span class="op" id="7006994">)</span><span class="op" id="7006995">,</span>&nbsp;<span class="ident" id="7006997">photo</span><span class="op" id="7007002">:</span>&nbsp;<span class="ident" id="7007004">corruptMemory</span><span class="op" id="7007017">}</span><span class="op" id="7007018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007022">{</span><span class="ident" id="7007023">name</span><span class="op" id="7007027">:</span>&nbsp;<span class="op" id="7007029">[</span><span class="op" id="7007030">]</span><span class="builtintype" id="7007031">byte</span><span class="op" id="7007035">(</span><span class="string" id="7007036">&#34;Chris&#34;</span><span class="op" id="7007043">)</span><span class="op" id="7007044">,</span>&nbsp;<span class="ident" id="7007046">photo</span><span class="op" id="7007051">:</span>&nbsp;<span class="ident" id="7007053">corruptMemory</span><span class="op" id="7007066">}</span><span class="op" id="7007067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007070">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007073">if</span>&nbsp;<span class="op" id="7007076">!</span><span class="ident" id="7007077">reflect</span><span class="op" id="7007084">.</span><span class="ident" id="7007085">DeepEqual</span><span class="op" id="7007094">(</span><span class="ident" id="7007095">got</span><span class="op" id="7007098">,</span>&nbsp;<span class="ident" id="7007100">want</span><span class="op" id="7007104">)</span>&nbsp;<span class="op" id="7007106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007110">t</span><span class="op" id="7007111">.</span><span class="ident" id="7007112">Errorf</span><span class="op" id="7007118">(</span><span class="string" id="7007119">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7007152">,</span>&nbsp;<span class="ident" id="7007154">got</span><span class="op" id="7007157">,</span>&nbsp;<span class="ident" id="7007159">want</span><span class="op" id="7007163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007170">var</span>&nbsp;<span class="ident" id="7007174">photo</span>&nbsp;<span class="ident" id="7007180">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007190">err</span>&nbsp;<span class="op" id="7007194">=</span>&nbsp;<span class="ident" id="7007196">db</span><span class="op" id="7007198">.</span><span class="ident" id="7007199">QueryRow</span><span class="op" id="7007207">(</span><span class="string" id="7007208">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7007236">,</span>&nbsp;<span class="string" id="7007238">&#34;Alice&#34;</span><span class="op" id="7007245">)</span><span class="op" id="7007246">.</span><span class="ident" id="7007247">Scan</span><span class="op" id="7007251">(</span><span class="op" id="7007252">&amp;</span><span class="ident" id="7007253">photo</span><span class="op" id="7007258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007261">if</span>&nbsp;<span class="ident" id="7007264">err</span>&nbsp;<span class="op" id="7007268">==</span>&nbsp;<span class="ident" id="7007271">nil</span>&nbsp;<span class="op" id="7007275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007279">t</span><span class="op" id="7007280">.</span><span class="ident" id="7007281">Error</span><span class="op" id="7007286">(</span><span class="string" id="7007287">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7007336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007339">}</span><br>
<span class="lineno"></span><span class="op" id="7007341">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7007344">func</span>&nbsp;<span class="ident" id="7007349">TestRowsColumns</span><span class="op" id="7007364">(</span><span class="ident" id="7007365">t</span>&nbsp;<span class="op" id="7007367">*</span><span class="ident" id="7007368">testing</span><span class="op" id="7007375">.</span><span class="ident" id="7007376">T</span><span class="op" id="7007377">)</span>&nbsp;<span class="op" id="7007379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007382">db</span>&nbsp;<span class="op" id="7007385">:=</span>&nbsp;<span class="ident" id="7007388">newTestDB</span><span class="op" id="7007397">(</span><span class="ident" id="7007398">t</span><span class="op" id="7007399">,</span>&nbsp;<span class="string" id="7007401">&#34;people&#34;</span><span class="op" id="7007409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007412">defer</span>&nbsp;<span class="ident" id="7007418">closeDB</span><span class="op" id="7007425">(</span><span class="ident" id="7007426">t</span><span class="op" id="7007427">,</span>&nbsp;<span class="ident" id="7007429">db</span><span class="op" id="7007431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007434">rows</span><span class="op" id="7007438">,</span>&nbsp;<span class="ident" id="7007440">err</span>&nbsp;<span class="op" id="7007444">:=</span>&nbsp;<span class="ident" id="7007447">db</span><span class="op" id="7007449">.</span><span class="ident" id="7007450">Query</span><span class="op" id="7007455">(</span><span class="string" id="7007456">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7007481">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007484">if</span>&nbsp;<span class="ident" id="7007487">err</span>&nbsp;<span class="op" id="7007491">!=</span>&nbsp;<span class="ident" id="7007494">nil</span>&nbsp;<span class="op" id="7007498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007502">t</span><span class="op" id="7007503">.</span><span class="ident" id="7007504">Fatalf</span><span class="op" id="7007510">(</span><span class="string" id="7007511">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7007522">,</span>&nbsp;<span class="ident" id="7007524">err</span><span class="op" id="7007527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007533">cols</span><span class="op" id="7007537">,</span>&nbsp;<span class="ident" id="7007539">err</span>&nbsp;<span class="op" id="7007543">:=</span>&nbsp;<span class="ident" id="7007546">rows</span><span class="op" id="7007550">.</span><span class="ident" id="7007551">Columns</span><span class="op" id="7007558">(</span><span class="op" id="7007559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007562">if</span>&nbsp;<span class="ident" id="7007565">err</span>&nbsp;<span class="op" id="7007569">!=</span>&nbsp;<span class="ident" id="7007572">nil</span>&nbsp;<span class="op" id="7007576">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007580">t</span><span class="op" id="7007581">.</span><span class="ident" id="7007582">Fatalf</span><span class="op" id="7007588">(</span><span class="string" id="7007589">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7007602">,</span>&nbsp;<span class="ident" id="7007604">err</span><span class="op" id="7007607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007613">want</span>&nbsp;<span class="op" id="7007618">:=</span>&nbsp;<span class="op" id="7007621">[</span><span class="op" id="7007622">]</span><span class="builtintype" id="7007623">string</span><span class="op" id="7007629">{</span><span class="string" id="7007630">&#34;age&#34;</span><span class="op" id="7007635">,</span>&nbsp;<span class="string" id="7007637">&#34;name&#34;</span><span class="op" id="7007643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007646">if</span>&nbsp;<span class="op" id="7007649">!</span><span class="ident" id="7007650">reflect</span><span class="op" id="7007657">.</span><span class="ident" id="7007658">DeepEqual</span><span class="op" id="7007667">(</span><span class="ident" id="7007668">cols</span><span class="op" id="7007672">,</span>&nbsp;<span class="ident" id="7007674">want</span><span class="op" id="7007678">)</span>&nbsp;<span class="op" id="7007680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007684">t</span><span class="op" id="7007685">.</span><span class="ident" id="7007686">Errorf</span><span class="op" id="7007692">(</span><span class="string" id="7007693">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7007712">,</span>&nbsp;<span class="ident" id="7007714">cols</span><span class="op" id="7007718">,</span>&nbsp;<span class="ident" id="7007720">want</span><span class="op" id="7007724">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007730">if</span>&nbsp;<span class="ident" id="7007733">err</span>&nbsp;<span class="op" id="7007737">:=</span>&nbsp;<span class="ident" id="7007740">rows</span><span class="op" id="7007744">.</span><span class="ident" id="7007745">Close</span><span class="op" id="7007750">(</span><span class="op" id="7007751">)</span><span class="op" id="7007752">;</span>&nbsp;<span class="ident" id="7007754">err</span>&nbsp;<span class="op" id="7007758">!=</span>&nbsp;<span class="ident" id="7007761">nil</span>&nbsp;<span class="op" id="7007765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007769">t</span><span class="op" id="7007770">.</span><span class="ident" id="7007771">Errorf</span><span class="op" id="7007777">(</span><span class="string" id="7007778">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7007802">,</span>&nbsp;<span class="ident" id="7007804">err</span><span class="op" id="7007807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007810">}</span><br>
<span class="lineno"></span><span class="op" id="7007812">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7007815">func</span>&nbsp;<span class="ident" id="7007820">TestQueryRow</span><span class="op" id="7007832">(</span><span class="ident" id="7007833">t</span>&nbsp;<span class="op" id="7007835">*</span><span class="ident" id="7007836">testing</span><span class="op" id="7007843">.</span><span class="ident" id="7007844">T</span><span class="op" id="7007845">)</span>&nbsp;<span class="op" id="7007847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007850">db</span>&nbsp;<span class="op" id="7007853">:=</span>&nbsp;<span class="ident" id="7007856">newTestDB</span><span class="op" id="7007865">(</span><span class="ident" id="7007866">t</span><span class="op" id="7007867">,</span>&nbsp;<span class="string" id="7007869">&#34;people&#34;</span><span class="op" id="7007877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007880">defer</span>&nbsp;<span class="ident" id="7007886">closeDB</span><span class="op" id="7007893">(</span><span class="ident" id="7007894">t</span><span class="op" id="7007895">,</span>&nbsp;<span class="ident" id="7007897">db</span><span class="op" id="7007899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007902">var</span>&nbsp;<span class="ident" id="7007906">name</span>&nbsp;<span class="builtintype" id="7007911">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007919">var</span>&nbsp;<span class="ident" id="7007923">age</span>&nbsp;<span class="builtintype" id="7007927">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007932">var</span>&nbsp;<span class="ident" id="7007936">birthday</span>&nbsp;<span class="ident" id="7007945">time</span><span class="op" id="7007949">.</span><span class="ident" id="7007950">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007957">err</span>&nbsp;<span class="op" id="7007961">:=</span>&nbsp;<span class="ident" id="7007964">db</span><span class="op" id="7007966">.</span><span class="ident" id="7007967">QueryRow</span><span class="op" id="7007975">(</span><span class="string" id="7007976">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7008006">,</span>&nbsp;<span class="num" id="7008008">3</span><span class="op" id="7008009">)</span><span class="op" id="7008010">.</span><span class="ident" id="7008011">Scan</span><span class="op" id="7008015">(</span><span class="op" id="7008016">&amp;</span><span class="ident" id="7008017">age</span><span class="op" id="7008020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008023">if</span>&nbsp;<span class="ident" id="7008026">err</span>&nbsp;<span class="op" id="7008030">==</span>&nbsp;<span class="ident" id="7008033">nil</span>&nbsp;<span class="op" id="7008037">||</span>&nbsp;<span class="op" id="7008040">!</span><span class="ident" id="7008041">strings</span><span class="op" id="7008048">.</span><span class="ident" id="7008049">Contains</span><span class="op" id="7008057">(</span><span class="ident" id="7008058">err</span><span class="op" id="7008061">.</span><span class="ident" id="7008062">Error</span><span class="op" id="7008067">(</span><span class="op" id="7008068">)</span><span class="op" id="7008069">,</span>&nbsp;<span class="string" id="7008071">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7008105">)</span>&nbsp;<span class="op" id="7008107">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008111">t</span><span class="op" id="7008112">.</span><span class="ident" id="7008113">Errorf</span><span class="op" id="7008119">(</span><span class="string" id="7008120">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7008185">,</span>&nbsp;<span class="ident" id="7008187">err</span><span class="op" id="7008190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008197">err</span>&nbsp;<span class="op" id="7008201">=</span>&nbsp;<span class="ident" id="7008203">db</span><span class="op" id="7008205">.</span><span class="ident" id="7008206">QueryRow</span><span class="op" id="7008214">(</span><span class="string" id="7008215">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7008242">,</span>&nbsp;<span class="num" id="7008244">3</span><span class="op" id="7008245">)</span><span class="op" id="7008246">.</span><span class="ident" id="7008247">Scan</span><span class="op" id="7008251">(</span><span class="op" id="7008252">&amp;</span><span class="ident" id="7008253">birthday</span><span class="op" id="7008261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008264">if</span>&nbsp;<span class="ident" id="7008267">err</span>&nbsp;<span class="op" id="7008271">!=</span>&nbsp;<span class="ident" id="7008274">nil</span>&nbsp;<span class="op" id="7008278">||</span>&nbsp;<span class="op" id="7008281">!</span><span class="ident" id="7008282">birthday</span><span class="op" id="7008290">.</span><span class="ident" id="7008291">Equal</span><span class="op" id="7008296">(</span><span class="ident" id="7008297">chrisBirthday</span><span class="op" id="7008310">)</span>&nbsp;<span class="op" id="7008312">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008316">t</span><span class="op" id="7008317">.</span><span class="ident" id="7008318">Errorf</span><span class="op" id="7008324">(</span><span class="string" id="7008325">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7008365">,</span>&nbsp;<span class="ident" id="7008367">birthday</span><span class="op" id="7008375">,</span>&nbsp;<span class="ident" id="7008377">err</span><span class="op" id="7008380">,</span>&nbsp;<span class="ident" id="7008382">chrisBirthday</span><span class="op" id="7008395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008402">err</span>&nbsp;<span class="op" id="7008406">=</span>&nbsp;<span class="ident" id="7008408">db</span><span class="op" id="7008410">.</span><span class="ident" id="7008411">QueryRow</span><span class="op" id="7008419">(</span><span class="string" id="7008420">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7008450">,</span>&nbsp;<span class="num" id="7008452">2</span><span class="op" id="7008453">)</span><span class="op" id="7008454">.</span><span class="ident" id="7008455">Scan</span><span class="op" id="7008459">(</span><span class="op" id="7008460">&amp;</span><span class="ident" id="7008461">age</span><span class="op" id="7008464">,</span>&nbsp;<span class="op" id="7008466">&amp;</span><span class="ident" id="7008467">name</span><span class="op" id="7008471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008474">if</span>&nbsp;<span class="ident" id="7008477">err</span>&nbsp;<span class="op" id="7008481">!=</span>&nbsp;<span class="ident" id="7008484">nil</span>&nbsp;<span class="op" id="7008488">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008492">t</span><span class="op" id="7008493">.</span><span class="ident" id="7008494">Fatalf</span><span class="op" id="7008500">(</span><span class="string" id="7008501">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7008524">,</span>&nbsp;<span class="ident" id="7008526">err</span><span class="op" id="7008529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008535">if</span>&nbsp;<span class="ident" id="7008538">name</span>&nbsp;<span class="op" id="7008543">!=</span>&nbsp;<span class="string" id="7008546">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7008552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008556">t</span><span class="op" id="7008557">.</span><span class="ident" id="7008558">Errorf</span><span class="op" id="7008564">(</span><span class="string" id="7008565">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7008592">,</span>&nbsp;<span class="ident" id="7008594">name</span><span class="op" id="7008598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008601">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008604">if</span>&nbsp;<span class="ident" id="7008607">age</span>&nbsp;<span class="op" id="7008611">!=</span>&nbsp;<span class="num" id="7008614">2</span>&nbsp;<span class="op" id="7008616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008620">t</span><span class="op" id="7008621">.</span><span class="ident" id="7008622">Errorf</span><span class="op" id="7008628">(</span><span class="string" id="7008629">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7008653">,</span>&nbsp;<span class="ident" id="7008655">age</span><span class="op" id="7008658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008665">err</span>&nbsp;<span class="op" id="7008669">=</span>&nbsp;<span class="ident" id="7008671">db</span><span class="op" id="7008673">.</span><span class="ident" id="7008674">QueryRow</span><span class="op" id="7008682">(</span><span class="string" id="7008683">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7008714">,</span>&nbsp;<span class="string" id="7008716">&#34;Alice&#34;</span><span class="op" id="7008723">)</span><span class="op" id="7008724">.</span><span class="ident" id="7008725">Scan</span><span class="op" id="7008729">(</span><span class="op" id="7008730">&amp;</span><span class="ident" id="7008731">age</span><span class="op" id="7008734">,</span>&nbsp;<span class="op" id="7008736">&amp;</span><span class="ident" id="7008737">name</span><span class="op" id="7008741">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008744">if</span>&nbsp;<span class="ident" id="7008747">err</span>&nbsp;<span class="op" id="7008751">!=</span>&nbsp;<span class="ident" id="7008754">nil</span>&nbsp;<span class="op" id="7008758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008762">t</span><span class="op" id="7008763">.</span><span class="ident" id="7008764">Fatalf</span><span class="op" id="7008770">(</span><span class="string" id="7008771">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7008795">,</span>&nbsp;<span class="ident" id="7008797">err</span><span class="op" id="7008800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008806">if</span>&nbsp;<span class="ident" id="7008809">name</span>&nbsp;<span class="op" id="7008814">!=</span>&nbsp;<span class="string" id="7008817">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7008825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008829">t</span><span class="op" id="7008830">.</span><span class="ident" id="7008831">Errorf</span><span class="op" id="7008837">(</span><span class="string" id="7008838">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7008867">,</span>&nbsp;<span class="ident" id="7008869">name</span><span class="op" id="7008873">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008879">if</span>&nbsp;<span class="ident" id="7008882">age</span>&nbsp;<span class="op" id="7008886">!=</span>&nbsp;<span class="num" id="7008889">1</span>&nbsp;<span class="op" id="7008891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008895">t</span><span class="op" id="7008896">.</span><span class="ident" id="7008897">Errorf</span><span class="op" id="7008903">(</span><span class="string" id="7008904">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7008928">,</span>&nbsp;<span class="ident" id="7008930">age</span><span class="op" id="7008933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008940">var</span>&nbsp;<span class="ident" id="7008944">photo</span>&nbsp;<span class="op" id="7008950">[</span><span class="op" id="7008951">]</span><span class="builtintype" id="7008952">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008958">err</span>&nbsp;<span class="op" id="7008962">=</span>&nbsp;<span class="ident" id="7008964">db</span><span class="op" id="7008966">.</span><span class="ident" id="7008967">QueryRow</span><span class="op" id="7008975">(</span><span class="string" id="7008976">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7009004">,</span>&nbsp;<span class="string" id="7009006">&#34;Alice&#34;</span><span class="op" id="7009013">)</span><span class="op" id="7009014">.</span><span class="ident" id="7009015">Scan</span><span class="op" id="7009019">(</span><span class="op" id="7009020">&amp;</span><span class="ident" id="7009021">photo</span><span class="op" id="7009026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009029">if</span>&nbsp;<span class="ident" id="7009032">err</span>&nbsp;<span class="op" id="7009036">!=</span>&nbsp;<span class="ident" id="7009039">nil</span>&nbsp;<span class="op" id="7009043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009047">t</span><span class="op" id="7009048">.</span><span class="ident" id="7009049">Fatalf</span><span class="op" id="7009055">(</span><span class="string" id="7009056">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7009081">,</span>&nbsp;<span class="ident" id="7009083">err</span><span class="op" id="7009086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009089">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009092">want</span>&nbsp;<span class="op" id="7009097">:=</span>&nbsp;<span class="op" id="7009100">[</span><span class="op" id="7009101">]</span><span class="builtintype" id="7009102">byte</span><span class="op" id="7009106">(</span><span class="string" id="7009107">&#34;APHOTO&#34;</span><span class="op" id="7009115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009118">if</span>&nbsp;<span class="op" id="7009121">!</span><span class="ident" id="7009122">reflect</span><span class="op" id="7009129">.</span><span class="ident" id="7009130">DeepEqual</span><span class="op" id="7009139">(</span><span class="ident" id="7009140">photo</span><span class="op" id="7009145">,</span>&nbsp;<span class="ident" id="7009147">want</span><span class="op" id="7009151">)</span>&nbsp;<span class="op" id="7009153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009157">t</span><span class="op" id="7009158">.</span><span class="ident" id="7009159">Errorf</span><span class="op" id="7009165">(</span><span class="string" id="7009166">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7009187">,</span>&nbsp;<span class="ident" id="7009189">photo</span><span class="op" id="7009194">,</span>&nbsp;<span class="ident" id="7009196">want</span><span class="op" id="7009200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009203">}</span><br>
<span class="lineno"></span><span class="op" id="7009205">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7009208">func</span>&nbsp;<span class="ident" id="7009213">TestStatementErrorAfterClose</span><span class="op" id="7009241">(</span><span class="ident" id="7009242">t</span>&nbsp;<span class="op" id="7009244">*</span><span class="ident" id="7009245">testing</span><span class="op" id="7009252">.</span><span class="ident" id="7009253">T</span><span class="op" id="7009254">)</span>&nbsp;<span class="op" id="7009256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009259">db</span>&nbsp;<span class="op" id="7009262">:=</span>&nbsp;<span class="ident" id="7009265">newTestDB</span><span class="op" id="7009274">(</span><span class="ident" id="7009275">t</span><span class="op" id="7009276">,</span>&nbsp;<span class="string" id="7009278">&#34;people&#34;</span><span class="op" id="7009286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009289">defer</span>&nbsp;<span class="ident" id="7009295">closeDB</span><span class="op" id="7009302">(</span><span class="ident" id="7009303">t</span><span class="op" id="7009304">,</span>&nbsp;<span class="ident" id="7009306">db</span><span class="op" id="7009308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009311">stmt</span><span class="op" id="7009315">,</span>&nbsp;<span class="ident" id="7009317">err</span>&nbsp;<span class="op" id="7009321">:=</span>&nbsp;<span class="ident" id="7009324">db</span><span class="op" id="7009326">.</span><span class="ident" id="7009327">Prepare</span><span class="op" id="7009334">(</span><span class="string" id="7009335">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7009361">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009364">if</span>&nbsp;<span class="ident" id="7009367">err</span>&nbsp;<span class="op" id="7009371">!=</span>&nbsp;<span class="ident" id="7009374">nil</span>&nbsp;<span class="op" id="7009378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009382">t</span><span class="op" id="7009383">.</span><span class="ident" id="7009384">Fatalf</span><span class="op" id="7009390">(</span><span class="string" id="7009391">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7009404">,</span>&nbsp;<span class="ident" id="7009406">err</span><span class="op" id="7009409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009415">err</span>&nbsp;<span class="op" id="7009419">=</span>&nbsp;<span class="ident" id="7009421">stmt</span><span class="op" id="7009425">.</span><span class="ident" id="7009426">Close</span><span class="op" id="7009431">(</span><span class="op" id="7009432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009435">if</span>&nbsp;<span class="ident" id="7009438">err</span>&nbsp;<span class="op" id="7009442">!=</span>&nbsp;<span class="ident" id="7009445">nil</span>&nbsp;<span class="op" id="7009449">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009453">t</span><span class="op" id="7009454">.</span><span class="ident" id="7009455">Fatalf</span><span class="op" id="7009461">(</span><span class="string" id="7009462">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7009473">,</span>&nbsp;<span class="ident" id="7009475">err</span><span class="op" id="7009478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009484">var</span>&nbsp;<span class="ident" id="7009488">name</span>&nbsp;<span class="builtintype" id="7009493">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009501">err</span>&nbsp;<span class="op" id="7009505">=</span>&nbsp;<span class="ident" id="7009507">stmt</span><span class="op" id="7009511">.</span><span class="ident" id="7009512">QueryRow</span><span class="op" id="7009520">(</span><span class="string" id="7009521">&#34;foo&#34;</span><span class="op" id="7009526">)</span><span class="op" id="7009527">.</span><span class="ident" id="7009528">Scan</span><span class="op" id="7009532">(</span><span class="op" id="7009533">&amp;</span><span class="ident" id="7009534">name</span><span class="op" id="7009538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009541">if</span>&nbsp;<span class="ident" id="7009544">err</span>&nbsp;<span class="op" id="7009548">==</span>&nbsp;<span class="ident" id="7009551">nil</span>&nbsp;<span class="op" id="7009555">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009559">t</span><span class="op" id="7009560">.</span><span class="ident" id="7009561">Errorf</span><span class="op" id="7009567">(</span><span class="string" id="7009568">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7009620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009623">}</span><br>
<span class="lineno"></span><span class="op" id="7009625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7009628">func</span>&nbsp;<span class="ident" id="7009633">TestStatementQueryRow</span><span class="op" id="7009654">(</span><span class="ident" id="7009655">t</span>&nbsp;<span class="op" id="7009657">*</span><span class="ident" id="7009658">testing</span><span class="op" id="7009665">.</span><span class="ident" id="7009666">T</span><span class="op" id="7009667">)</span>&nbsp;<span class="op" id="7009669">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009672">db</span>&nbsp;<span class="op" id="7009675">:=</span>&nbsp;<span class="ident" id="7009678">newTestDB</span><span class="op" id="7009687">(</span><span class="ident" id="7009688">t</span><span class="op" id="7009689">,</span>&nbsp;<span class="string" id="7009691">&#34;people&#34;</span><span class="op" id="7009699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009702">defer</span>&nbsp;<span class="ident" id="7009708">closeDB</span><span class="op" id="7009715">(</span><span class="ident" id="7009716">t</span><span class="op" id="7009717">,</span>&nbsp;<span class="ident" id="7009719">db</span><span class="op" id="7009721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009724">stmt</span><span class="op" id="7009728">,</span>&nbsp;<span class="ident" id="7009730">err</span>&nbsp;<span class="op" id="7009734">:=</span>&nbsp;<span class="ident" id="7009737">db</span><span class="op" id="7009739">.</span><span class="ident" id="7009740">Prepare</span><span class="op" id="7009747">(</span><span class="string" id="7009748">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7009774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009777">if</span>&nbsp;<span class="ident" id="7009780">err</span>&nbsp;<span class="op" id="7009784">!=</span>&nbsp;<span class="ident" id="7009787">nil</span>&nbsp;<span class="op" id="7009791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009795">t</span><span class="op" id="7009796">.</span><span class="ident" id="7009797">Fatalf</span><span class="op" id="7009803">(</span><span class="string" id="7009804">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7009817">,</span>&nbsp;<span class="ident" id="7009819">err</span><span class="op" id="7009822">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009828">defer</span>&nbsp;<span class="ident" id="7009834">stmt</span><span class="op" id="7009838">.</span><span class="ident" id="7009839">Close</span><span class="op" id="7009844">(</span><span class="op" id="7009845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009848">var</span>&nbsp;<span class="ident" id="7009852">age</span>&nbsp;<span class="builtintype" id="7009856">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009861">for</span>&nbsp;<span class="ident" id="7009865">n</span><span class="op" id="7009866">,</span>&nbsp;<span class="ident" id="7009868">tt</span>&nbsp;<span class="op" id="7009871">:=</span>&nbsp;<span class="keyword" id="7009874">range</span>&nbsp;<span class="op" id="7009880">[</span><span class="op" id="7009881">]</span><span class="keyword" id="7009882">struct</span>&nbsp;<span class="op" id="7009889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009893">name</span>&nbsp;<span class="builtintype" id="7009898">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009907">want</span>&nbsp;<span class="builtintype" id="7009912">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009917">}</span><span class="op" id="7009918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009922">{</span><span class="string" id="7009923">&#34;Alice&#34;</span><span class="op" id="7009930">,</span>&nbsp;<span class="num" id="7009932">1</span><span class="op" id="7009933">}</span><span class="op" id="7009934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009938">{</span><span class="string" id="7009939">&#34;Bob&#34;</span><span class="op" id="7009944">,</span>&nbsp;<span class="num" id="7009946">2</span><span class="op" id="7009947">}</span><span class="op" id="7009948">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009952">{</span><span class="string" id="7009953">&#34;Chris&#34;</span><span class="op" id="7009960">,</span>&nbsp;<span class="num" id="7009962">3</span><span class="op" id="7009963">}</span><span class="op" id="7009964">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009967">}</span>&nbsp;<span class="op" id="7009969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009973">if</span>&nbsp;<span class="ident" id="7009976">err</span>&nbsp;<span class="op" id="7009980">:=</span>&nbsp;<span class="ident" id="7009983">stmt</span><span class="op" id="7009987">.</span><span class="ident" id="7009988">QueryRow</span><span class="op" id="7009996">(</span><span class="ident" id="7009997">tt</span><span class="op" id="7009999">.</span><span class="ident" id="7010000">name</span><span class="op" id="7010004">)</span><span class="op" id="7010005">.</span><span class="ident" id="7010006">Scan</span><span class="op" id="7010010">(</span><span class="op" id="7010011">&amp;</span><span class="ident" id="7010012">age</span><span class="op" id="7010015">)</span><span class="op" id="7010016">;</span>&nbsp;<span class="ident" id="7010018">err</span>&nbsp;<span class="op" id="7010022">!=</span>&nbsp;<span class="ident" id="7010025">nil</span>&nbsp;<span class="op" id="7010029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010034">t</span><span class="op" id="7010035">.</span><span class="ident" id="7010036">Errorf</span><span class="op" id="7010042">(</span><span class="string" id="7010043">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7010073">,</span>&nbsp;<span class="ident" id="7010075">n</span><span class="op" id="7010076">,</span>&nbsp;<span class="ident" id="7010078">tt</span><span class="op" id="7010080">.</span><span class="ident" id="7010081">name</span><span class="op" id="7010085">,</span>&nbsp;<span class="ident" id="7010087">err</span><span class="op" id="7010090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010094">}</span>&nbsp;<span class="keyword" id="7010096">else</span>&nbsp;<span class="keyword" id="7010101">if</span>&nbsp;<span class="ident" id="7010104">age</span>&nbsp;<span class="op" id="7010108">!=</span>&nbsp;<span class="ident" id="7010111">tt</span><span class="op" id="7010113">.</span><span class="ident" id="7010114">want</span>&nbsp;<span class="op" id="7010119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010124">t</span><span class="op" id="7010125">.</span><span class="ident" id="7010126">Errorf</span><span class="op" id="7010132">(</span><span class="string" id="7010133">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7010154">,</span>&nbsp;<span class="ident" id="7010156">n</span><span class="op" id="7010157">,</span>&nbsp;<span class="ident" id="7010159">age</span><span class="op" id="7010162">,</span>&nbsp;<span class="ident" id="7010164">tt</span><span class="op" id="7010166">.</span><span class="ident" id="7010167">want</span><span class="op" id="7010171">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010178">}</span><br>
<span class="lineno"></span><span class="op" id="7010180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7010183">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7010208">func</span>&nbsp;<span class="ident" id="7010213">TestStatementQueryRowConcurrent</span><span class="op" id="7010244">(</span><span class="ident" id="7010245">t</span>&nbsp;<span class="op" id="7010247">*</span><span class="ident" id="7010248">testing</span><span class="op" id="7010255">.</span><span class="ident" id="7010256">T</span><span class="op" id="7010257">)</span>&nbsp;<span class="op" id="7010259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010262">db</span>&nbsp;<span class="op" id="7010265">:=</span>&nbsp;<span class="ident" id="7010268">newTestDB</span><span class="op" id="7010277">(</span><span class="ident" id="7010278">t</span><span class="op" id="7010279">,</span>&nbsp;<span class="string" id="7010281">&#34;people&#34;</span><span class="op" id="7010289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010292">defer</span>&nbsp;<span class="ident" id="7010298">closeDB</span><span class="op" id="7010305">(</span><span class="ident" id="7010306">t</span><span class="op" id="7010307">,</span>&nbsp;<span class="ident" id="7010309">db</span><span class="op" id="7010311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010314">stmt</span><span class="op" id="7010318">,</span>&nbsp;<span class="ident" id="7010320">err</span>&nbsp;<span class="op" id="7010324">:=</span>&nbsp;<span class="ident" id="7010327">db</span><span class="op" id="7010329">.</span><span class="ident" id="7010330">Prepare</span><span class="op" id="7010337">(</span><span class="string" id="7010338">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7010364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010367">if</span>&nbsp;<span class="ident" id="7010370">err</span>&nbsp;<span class="op" id="7010374">!=</span>&nbsp;<span class="ident" id="7010377">nil</span>&nbsp;<span class="op" id="7010381">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010385">t</span><span class="op" id="7010386">.</span><span class="ident" id="7010387">Fatalf</span><span class="op" id="7010393">(</span><span class="string" id="7010394">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7010407">,</span>&nbsp;<span class="ident" id="7010409">err</span><span class="op" id="7010412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010418">defer</span>&nbsp;<span class="ident" id="7010424">stmt</span><span class="op" id="7010428">.</span><span class="ident" id="7010429">Close</span><span class="op" id="7010434">(</span><span class="op" id="7010435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010439">const</span>&nbsp;<span class="ident" id="7010445">n</span>&nbsp;<span class="op" id="7010447">=</span>&nbsp;<span class="num" id="7010449">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010453">ch</span>&nbsp;<span class="op" id="7010456">:=</span>&nbsp;<span class="builtinfunc" id="7010459">make</span><span class="op" id="7010463">(</span><span class="keyword" id="7010464">chan</span>&nbsp;<span class="builtintype" id="7010469">error</span><span class="op" id="7010474">,</span>&nbsp;<span class="ident" id="7010476">n</span><span class="op" id="7010477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010480">for</span>&nbsp;<span class="ident" id="7010484">i</span>&nbsp;<span class="op" id="7010486">:=</span>&nbsp;<span class="num" id="7010489">0</span><span class="op" id="7010490">;</span>&nbsp;<span class="ident" id="7010492">i</span>&nbsp;<span class="op" id="7010494">&lt;</span>&nbsp;<span class="ident" id="7010496">n</span><span class="op" id="7010497">;</span>&nbsp;<span class="ident" id="7010499">i</span><span class="op" id="7010500">++</span>&nbsp;<span class="op" id="7010503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010507">go</span>&nbsp;<span class="keyword" id="7010510">func</span><span class="op" id="7010514">(</span><span class="op" id="7010515">)</span>&nbsp;<span class="op" id="7010517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010522">var</span>&nbsp;<span class="ident" id="7010526">age</span>&nbsp;<span class="builtintype" id="7010530">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010537">err</span>&nbsp;<span class="op" id="7010541">:=</span>&nbsp;<span class="ident" id="7010544">stmt</span><span class="op" id="7010548">.</span><span class="ident" id="7010549">QueryRow</span><span class="op" id="7010557">(</span><span class="string" id="7010558">&#34;Alice&#34;</span><span class="op" id="7010565">)</span><span class="op" id="7010566">.</span><span class="ident" id="7010567">Scan</span><span class="op" id="7010571">(</span><span class="op" id="7010572">&amp;</span><span class="ident" id="7010573">age</span><span class="op" id="7010576">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010581">if</span>&nbsp;<span class="ident" id="7010584">err</span>&nbsp;<span class="op" id="7010588">==</span>&nbsp;<span class="ident" id="7010591">nil</span>&nbsp;<span class="op" id="7010595">&amp;&amp;</span>&nbsp;<span class="ident" id="7010598">age</span>&nbsp;<span class="op" id="7010602">!=</span>&nbsp;<span class="num" id="7010605">1</span>&nbsp;<span class="op" id="7010607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010613">err</span>&nbsp;<span class="op" id="7010617">=</span>&nbsp;<span class="ident" id="7010619">fmt</span><span class="op" id="7010622">.</span><span class="ident" id="7010623">Errorf</span><span class="op" id="7010629">(</span><span class="string" id="7010630">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7010649">,</span>&nbsp;<span class="ident" id="7010651">age</span><span class="op" id="7010654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010664">ch</span>&nbsp;<span class="op" id="7010667">&lt;-</span>&nbsp;<span class="ident" id="7010670">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010676">}</span><span class="op" id="7010677">(</span><span class="op" id="7010678">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010684">for</span>&nbsp;<span class="ident" id="7010688">i</span>&nbsp;<span class="op" id="7010690">:=</span>&nbsp;<span class="num" id="7010693">0</span><span class="op" id="7010694">;</span>&nbsp;<span class="ident" id="7010696">i</span>&nbsp;<span class="op" id="7010698">&lt;</span>&nbsp;<span class="ident" id="7010700">n</span><span class="op" id="7010701">;</span>&nbsp;<span class="ident" id="7010703">i</span><span class="op" id="7010704">++</span>&nbsp;<span class="op" id="7010707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010711">if</span>&nbsp;<span class="ident" id="7010714">err</span>&nbsp;<span class="op" id="7010718">:=</span>&nbsp;<span class="op" id="7010721">&lt;-</span><span class="ident" id="7010723">ch</span><span class="op" id="7010725">;</span>&nbsp;<span class="ident" id="7010727">err</span>&nbsp;<span class="op" id="7010731">!=</span>&nbsp;<span class="ident" id="7010734">nil</span>&nbsp;<span class="op" id="7010738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010743">t</span><span class="op" id="7010744">.</span><span class="ident" id="7010745">Error</span><span class="op" id="7010750">(</span><span class="ident" id="7010751">err</span><span class="op" id="7010754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010758">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010761">}</span><br>
<span class="lineno"></span><span class="op" id="7010763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7010766">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7010798">func</span>&nbsp;<span class="ident" id="7010803">TestBogusPreboundParameters</span><span class="op" id="7010830">(</span><span class="ident" id="7010831">t</span>&nbsp;<span class="op" id="7010833">*</span><span class="ident" id="7010834">testing</span><span class="op" id="7010841">.</span><span class="ident" id="7010842">T</span><span class="op" id="7010843">)</span>&nbsp;<span class="op" id="7010845">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010848">db</span>&nbsp;<span class="op" id="7010851">:=</span>&nbsp;<span class="ident" id="7010854">newTestDB</span><span class="op" id="7010863">(</span><span class="ident" id="7010864">t</span><span class="op" id="7010865">,</span>&nbsp;<span class="string" id="7010867">&#34;foo&#34;</span><span class="op" id="7010872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010875">defer</span>&nbsp;<span class="ident" id="7010881">closeDB</span><span class="op" id="7010888">(</span><span class="ident" id="7010889">t</span><span class="op" id="7010890">,</span>&nbsp;<span class="ident" id="7010892">db</span><span class="op" id="7010894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010897">exec</span><span class="op" id="7010901">(</span><span class="ident" id="7010902">t</span><span class="op" id="7010903">,</span>&nbsp;<span class="ident" id="7010905">db</span><span class="op" id="7010907">,</span>&nbsp;<span class="string" id="7010909">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7010952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010955">_</span><span class="op" id="7010956">,</span>&nbsp;<span class="ident" id="7010958">err</span>&nbsp;<span class="op" id="7010962">:=</span>&nbsp;<span class="ident" id="7010965">db</span><span class="op" id="7010967">.</span><span class="ident" id="7010968">Prepare</span><span class="op" id="7010975">(</span><span class="string" id="7010976">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7011014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011017">if</span>&nbsp;<span class="ident" id="7011020">err</span>&nbsp;<span class="op" id="7011024">==</span>&nbsp;<span class="ident" id="7011027">nil</span>&nbsp;<span class="op" id="7011031">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011035">t</span><span class="op" id="7011036">.</span><span class="ident" id="7011037">Fatalf</span><span class="op" id="7011043">(</span><span class="string" id="7011044">&#34;expected&nbsp;error&#34;</span><span class="op" id="7011060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011066">if</span>&nbsp;<span class="ident" id="7011069">err</span><span class="op" id="7011072">.</span><span class="ident" id="7011073">Error</span><span class="op" id="7011078">(</span><span class="op" id="7011079">)</span>&nbsp;<span class="op" id="7011081">!=</span>&nbsp;<span class="string" id="7011084">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7011145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011149">t</span><span class="op" id="7011150">.</span><span class="ident" id="7011151">Errorf</span><span class="op" id="7011157">(</span><span class="string" id="7011158">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7011180">,</span>&nbsp;<span class="ident" id="7011182">err</span><span class="op" id="7011185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011188">}</span><br>
<span class="lineno">400</span><span class="op" id="7011190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011193">func</span>&nbsp;<span class="ident" id="7011198">TestExec</span><span class="op" id="7011206">(</span><span class="ident" id="7011207">t</span>&nbsp;<span class="op" id="7011209">*</span><span class="ident" id="7011210">testing</span><span class="op" id="7011217">.</span><span class="ident" id="7011218">T</span><span class="op" id="7011219">)</span>&nbsp;<span class="op" id="7011221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011224">db</span>&nbsp;<span class="op" id="7011227">:=</span>&nbsp;<span class="ident" id="7011230">newTestDB</span><span class="op" id="7011239">(</span><span class="ident" id="7011240">t</span><span class="op" id="7011241">,</span>&nbsp;<span class="string" id="7011243">&#34;foo&#34;</span><span class="op" id="7011248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011251">defer</span>&nbsp;<span class="ident" id="7011257">closeDB</span><span class="op" id="7011264">(</span><span class="ident" id="7011265">t</span><span class="op" id="7011266">,</span>&nbsp;<span class="ident" id="7011268">db</span><span class="op" id="7011270">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011273">exec</span><span class="op" id="7011277">(</span><span class="ident" id="7011278">t</span><span class="op" id="7011279">,</span>&nbsp;<span class="ident" id="7011281">db</span><span class="op" id="7011283">,</span>&nbsp;<span class="string" id="7011285">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7011328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011331">stmt</span><span class="op" id="7011335">,</span>&nbsp;<span class="ident" id="7011337">err</span>&nbsp;<span class="op" id="7011341">:=</span>&nbsp;<span class="ident" id="7011344">db</span><span class="op" id="7011346">.</span><span class="ident" id="7011347">Prepare</span><span class="op" id="7011354">(</span><span class="string" id="7011355">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7011379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011382">if</span>&nbsp;<span class="ident" id="7011385">err</span>&nbsp;<span class="op" id="7011389">!=</span>&nbsp;<span class="ident" id="7011392">nil</span>&nbsp;<span class="op" id="7011396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011400">t</span><span class="op" id="7011401">.</span><span class="ident" id="7011402">Errorf</span><span class="op" id="7011408">(</span><span class="string" id="7011409">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7011429">,</span>&nbsp;<span class="ident" id="7011431">stmt</span><span class="op" id="7011435">,</span>&nbsp;<span class="ident" id="7011437">err</span><span class="op" id="7011440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011443">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011446">defer</span>&nbsp;<span class="ident" id="7011452">stmt</span><span class="op" id="7011456">.</span><span class="ident" id="7011457">Close</span><span class="op" id="7011462">(</span><span class="op" id="7011463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011467">type</span>&nbsp;<span class="ident" id="7011472">execTest</span>&nbsp;<span class="keyword" id="7011481">struct</span>&nbsp;<span class="op" id="7011488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011492">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7011500">[</span><span class="op" id="7011501">]</span><span class="keyword" id="7011502">interface</span><span class="op" id="7011511">{</span><span class="op" id="7011512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011516">wantErr</span>&nbsp;<span class="builtintype" id="7011524">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011535">execTests</span>&nbsp;<span class="op" id="7011545">:=</span>&nbsp;<span class="op" id="7011548">[</span><span class="op" id="7011549">]</span><span class="ident" id="7011550">execTest</span><span class="op" id="7011558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7011562">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011573">{</span><span class="op" id="7011574">[</span><span class="op" id="7011575">]</span><span class="keyword" id="7011576">interface</span><span class="op" id="7011585">{</span><span class="op" id="7011586">}</span><span class="op" id="7011587">{</span><span class="string" id="7011588">&#34;Brad&#34;</span><span class="op" id="7011594">,</span>&nbsp;<span class="num" id="7011596">31</span><span class="op" id="7011598">}</span><span class="op" id="7011599">,</span>&nbsp;<span class="string" id="7011601">&#34;&#34;</span><span class="op" id="7011603">}</span><span class="op" id="7011604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011608">{</span><span class="op" id="7011609">[</span><span class="op" id="7011610">]</span><span class="keyword" id="7011611">interface</span><span class="op" id="7011620">{</span><span class="op" id="7011621">}</span><span class="op" id="7011622">{</span><span class="string" id="7011623">&#34;Brad&#34;</span><span class="op" id="7011629">,</span>&nbsp;<span class="ident" id="7011631">int64</span><span class="op" id="7011636">(</span><span class="num" id="7011637">31</span><span class="op" id="7011639">)</span><span class="op" id="7011640">}</span><span class="op" id="7011641">,</span>&nbsp;<span class="string" id="7011643">&#34;&#34;</span><span class="op" id="7011645">}</span><span class="op" id="7011646">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011650">{</span><span class="op" id="7011651">[</span><span class="op" id="7011652">]</span><span class="keyword" id="7011653">interface</span><span class="op" id="7011662">{</span><span class="op" id="7011663">}</span><span class="op" id="7011664">{</span><span class="string" id="7011665">&#34;Bob&#34;</span><span class="op" id="7011670">,</span>&nbsp;<span class="string" id="7011672">&#34;32&#34;</span><span class="op" id="7011676">}</span><span class="op" id="7011677">,</span>&nbsp;<span class="string" id="7011679">&#34;&#34;</span><span class="op" id="7011681">}</span><span class="op" id="7011682">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011686">{</span><span class="op" id="7011687">[</span><span class="op" id="7011688">]</span><span class="keyword" id="7011689">interface</span><span class="op" id="7011698">{</span><span class="op" id="7011699">}</span><span class="op" id="7011700">{</span><span class="num" id="7011701">7</span><span class="op" id="7011702">,</span>&nbsp;<span class="num" id="7011704">9</span><span class="op" id="7011705">}</span><span class="op" id="7011706">,</span>&nbsp;<span class="string" id="7011708">&#34;&#34;</span><span class="op" id="7011710">}</span><span class="op" id="7011711">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7011716">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011742">{</span><span class="op" id="7011743">[</span><span class="op" id="7011744">]</span><span class="keyword" id="7011745">interface</span><span class="op" id="7011754">{</span><span class="op" id="7011755">}</span><span class="op" id="7011756">{</span><span class="string" id="7011757">&#34;Brad&#34;</span><span class="op" id="7011763">,</span>&nbsp;<span class="ident" id="7011765">int64</span><span class="op" id="7011770">(</span><span class="num" id="7011771">0xFFFFFFFF</span><span class="op" id="7011781">)</span><span class="op" id="7011782">}</span><span class="op" id="7011783">,</span>&nbsp;<span class="string" id="7011785">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7011867">}</span><span class="op" id="7011868">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011872">{</span><span class="op" id="7011873">[</span><span class="op" id="7011874">]</span><span class="keyword" id="7011875">interface</span><span class="op" id="7011884">{</span><span class="op" id="7011885">}</span><span class="op" id="7011886">{</span><span class="string" id="7011887">&#34;Brad&#34;</span><span class="op" id="7011893">,</span>&nbsp;<span class="string" id="7011895">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7011909">}</span><span class="op" id="7011910">,</span>&nbsp;<span class="string" id="7011912">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7012012">}</span><span class="op" id="7012013">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7012018">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012045">{</span><span class="op" id="7012046">[</span><span class="op" id="7012047">]</span><span class="keyword" id="7012048">interface</span><span class="op" id="7012057">{</span><span class="op" id="7012058">}</span><span class="op" id="7012059">{</span><span class="op" id="7012060">}</span><span class="op" id="7012061">,</span>&nbsp;<span class="string" id="7012063">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7012097">}</span><span class="op" id="7012098">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012102">{</span><span class="op" id="7012103">[</span><span class="op" id="7012104">]</span><span class="keyword" id="7012105">interface</span><span class="op" id="7012114">{</span><span class="op" id="7012115">}</span><span class="op" id="7012116">{</span><span class="num" id="7012117">1</span><span class="op" id="7012118">,</span>&nbsp;<span class="num" id="7012120">2</span><span class="op" id="7012121">,</span>&nbsp;<span class="num" id="7012123">3</span><span class="op" id="7012124">}</span><span class="op" id="7012125">,</span>&nbsp;<span class="string" id="7012127">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7012161">}</span><span class="op" id="7012162">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012168">for</span>&nbsp;<span class="ident" id="7012172">n</span><span class="op" id="7012173">,</span>&nbsp;<span class="ident" id="7012175">et</span>&nbsp;<span class="op" id="7012178">:=</span>&nbsp;<span class="keyword" id="7012181">range</span>&nbsp;<span class="ident" id="7012187">execTests</span>&nbsp;<span class="op" id="7012197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012201">_</span><span class="op" id="7012202">,</span>&nbsp;<span class="ident" id="7012204">err</span>&nbsp;<span class="op" id="7012208">:=</span>&nbsp;<span class="ident" id="7012211">stmt</span><span class="op" id="7012215">.</span><span class="ident" id="7012216">Exec</span><span class="op" id="7012220">(</span><span class="ident" id="7012221">et</span><span class="op" id="7012223">.</span><span class="ident" id="7012224">args</span><span class="op" id="7012228">...</span><span class="op" id="7012231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012235">errStr</span>&nbsp;<span class="op" id="7012242">:=</span>&nbsp;<span class="string" id="7012245">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012250">if</span>&nbsp;<span class="ident" id="7012253">err</span>&nbsp;<span class="op" id="7012257">!=</span>&nbsp;<span class="ident" id="7012260">nil</span>&nbsp;<span class="op" id="7012264">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012269">errStr</span>&nbsp;<span class="op" id="7012276">=</span>&nbsp;<span class="ident" id="7012278">err</span><span class="op" id="7012281">.</span><span class="ident" id="7012282">Error</span><span class="op" id="7012287">(</span><span class="op" id="7012288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012296">if</span>&nbsp;<span class="ident" id="7012299">errStr</span>&nbsp;<span class="op" id="7012306">!=</span>&nbsp;<span class="ident" id="7012309">et</span><span class="op" id="7012311">.</span><span class="ident" id="7012312">wantErr</span>&nbsp;<span class="op" id="7012320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012325">t</span><span class="op" id="7012326">.</span><span class="ident" id="7012327">Errorf</span><span class="op" id="7012333">(</span><span class="string" id="7012334">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7012389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012395">n</span><span class="op" id="7012396">,</span>&nbsp;<span class="ident" id="7012398">et</span><span class="op" id="7012400">.</span><span class="ident" id="7012401">args</span><span class="op" id="7012405">,</span>&nbsp;<span class="ident" id="7012407">errStr</span><span class="op" id="7012413">,</span>&nbsp;<span class="ident" id="7012415">et</span><span class="op" id="7012417">.</span><span class="ident" id="7012418">wantErr</span><span class="op" id="7012425">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012432">}</span><br>
<span class="lineno"></span><span class="op" id="7012434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7012437">func</span>&nbsp;<span class="ident" id="7012442">TestTxPrepare</span><span class="op" id="7012455">(</span><span class="ident" id="7012456">t</span>&nbsp;<span class="op" id="7012458">*</span><span class="ident" id="7012459">testing</span><span class="op" id="7012466">.</span><span class="ident" id="7012467">T</span><span class="op" id="7012468">)</span>&nbsp;<span class="op" id="7012470">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012473">db</span>&nbsp;<span class="op" id="7012476">:=</span>&nbsp;<span class="ident" id="7012479">newTestDB</span><span class="op" id="7012488">(</span><span class="ident" id="7012489">t</span><span class="op" id="7012490">,</span>&nbsp;<span class="string" id="7012492">&#34;&#34;</span><span class="op" id="7012494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012497">defer</span>&nbsp;<span class="ident" id="7012503">closeDB</span><span class="op" id="7012510">(</span><span class="ident" id="7012511">t</span><span class="op" id="7012512">,</span>&nbsp;<span class="ident" id="7012514">db</span><span class="op" id="7012516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012519">exec</span><span class="op" id="7012523">(</span><span class="ident" id="7012524">t</span><span class="op" id="7012525">,</span>&nbsp;<span class="ident" id="7012527">db</span><span class="op" id="7012529">,</span>&nbsp;<span class="string" id="7012531">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7012574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012577">tx</span><span class="op" id="7012579">,</span>&nbsp;<span class="ident" id="7012581">err</span>&nbsp;<span class="op" id="7012585">:=</span>&nbsp;<span class="ident" id="7012588">db</span><span class="op" id="7012590">.</span><span class="ident" id="7012591">Begin</span><span class="op" id="7012596">(</span><span class="op" id="7012597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012600">if</span>&nbsp;<span class="ident" id="7012603">err</span>&nbsp;<span class="op" id="7012607">!=</span>&nbsp;<span class="ident" id="7012610">nil</span>&nbsp;<span class="op" id="7012614">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012618">t</span><span class="op" id="7012619">.</span><span class="ident" id="7012620">Fatalf</span><span class="op" id="7012626">(</span><span class="string" id="7012627">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7012639">,</span>&nbsp;<span class="ident" id="7012641">err</span><span class="op" id="7012644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012650">stmt</span><span class="op" id="7012654">,</span>&nbsp;<span class="ident" id="7012656">err</span>&nbsp;<span class="op" id="7012660">:=</span>&nbsp;<span class="ident" id="7012663">tx</span><span class="op" id="7012665">.</span><span class="ident" id="7012666">Prepare</span><span class="op" id="7012673">(</span><span class="string" id="7012674">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7012698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012701">if</span>&nbsp;<span class="ident" id="7012704">err</span>&nbsp;<span class="op" id="7012708">!=</span>&nbsp;<span class="ident" id="7012711">nil</span>&nbsp;<span class="op" id="7012715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012719">t</span><span class="op" id="7012720">.</span><span class="ident" id="7012721">Fatalf</span><span class="op" id="7012727">(</span><span class="string" id="7012728">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7012748">,</span>&nbsp;<span class="ident" id="7012750">stmt</span><span class="op" id="7012754">,</span>&nbsp;<span class="ident" id="7012756">err</span><span class="op" id="7012759">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012765">defer</span>&nbsp;<span class="ident" id="7012771">stmt</span><span class="op" id="7012775">.</span><span class="ident" id="7012776">Close</span><span class="op" id="7012781">(</span><span class="op" id="7012782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012785">_</span><span class="op" id="7012786">,</span>&nbsp;<span class="ident" id="7012788">err</span>&nbsp;<span class="op" id="7012792">=</span>&nbsp;<span class="ident" id="7012794">stmt</span><span class="op" id="7012798">.</span><span class="ident" id="7012799">Exec</span><span class="op" id="7012803">(</span><span class="string" id="7012804">&#34;Bobby&#34;</span><span class="op" id="7012811">,</span>&nbsp;<span class="num" id="7012813">7</span><span class="op" id="7012814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012817">if</span>&nbsp;<span class="ident" id="7012820">err</span>&nbsp;<span class="op" id="7012824">!=</span>&nbsp;<span class="ident" id="7012827">nil</span>&nbsp;<span class="op" id="7012831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012835">t</span><span class="op" id="7012836">.</span><span class="ident" id="7012837">Fatalf</span><span class="op" id="7012843">(</span><span class="string" id="7012844">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7012855">,</span>&nbsp;<span class="ident" id="7012857">err</span><span class="op" id="7012860">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012866">err</span>&nbsp;<span class="op" id="7012870">=</span>&nbsp;<span class="ident" id="7012872">tx</span><span class="op" id="7012874">.</span><span class="ident" id="7012875">Commit</span><span class="op" id="7012881">(</span><span class="op" id="7012882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012885">if</span>&nbsp;<span class="ident" id="7012888">err</span>&nbsp;<span class="op" id="7012892">!=</span>&nbsp;<span class="ident" id="7012895">nil</span>&nbsp;<span class="op" id="7012899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012903">t</span><span class="op" id="7012904">.</span><span class="ident" id="7012905">Fatalf</span><span class="op" id="7012911">(</span><span class="string" id="7012912">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7012925">,</span>&nbsp;<span class="ident" id="7012927">err</span><span class="op" id="7012930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012933">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7012936">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012982">if</span>&nbsp;<span class="op" id="7012985">!</span><span class="ident" id="7012986">stmt</span><span class="op" id="7012990">.</span><span class="ident" id="7012991">closed</span>&nbsp;<span class="op" id="7012998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013002">t</span><span class="op" id="7013003">.</span><span class="ident" id="7013004">Fatal</span><span class="op" id="7013009">(</span><span class="string" id="7013010">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7013040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013043">}</span><br>
<span class="lineno"></span><span class="op" id="7013045">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7013048">func</span>&nbsp;<span class="ident" id="7013053">TestTxStmt</span><span class="op" id="7013063">(</span><span class="ident" id="7013064">t</span>&nbsp;<span class="op" id="7013066">*</span><span class="ident" id="7013067">testing</span><span class="op" id="7013074">.</span><span class="ident" id="7013075">T</span><span class="op" id="7013076">)</span>&nbsp;<span class="op" id="7013078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013081">db</span>&nbsp;<span class="op" id="7013084">:=</span>&nbsp;<span class="ident" id="7013087">newTestDB</span><span class="op" id="7013096">(</span><span class="ident" id="7013097">t</span><span class="op" id="7013098">,</span>&nbsp;<span class="string" id="7013100">&#34;&#34;</span><span class="op" id="7013102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013105">defer</span>&nbsp;<span class="ident" id="7013111">closeDB</span><span class="op" id="7013118">(</span><span class="ident" id="7013119">t</span><span class="op" id="7013120">,</span>&nbsp;<span class="ident" id="7013122">db</span><span class="op" id="7013124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013127">exec</span><span class="op" id="7013131">(</span><span class="ident" id="7013132">t</span><span class="op" id="7013133">,</span>&nbsp;<span class="ident" id="7013135">db</span><span class="op" id="7013137">,</span>&nbsp;<span class="string" id="7013139">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7013182">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013185">stmt</span><span class="op" id="7013189">,</span>&nbsp;<span class="ident" id="7013191">err</span>&nbsp;<span class="op" id="7013195">:=</span>&nbsp;<span class="ident" id="7013198">db</span><span class="op" id="7013200">.</span><span class="ident" id="7013201">Prepare</span><span class="op" id="7013208">(</span><span class="string" id="7013209">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7013233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013236">if</span>&nbsp;<span class="ident" id="7013239">err</span>&nbsp;<span class="op" id="7013243">!=</span>&nbsp;<span class="ident" id="7013246">nil</span>&nbsp;<span class="op" id="7013250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013254">t</span><span class="op" id="7013255">.</span><span class="ident" id="7013256">Fatalf</span><span class="op" id="7013262">(</span><span class="string" id="7013263">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7013283">,</span>&nbsp;<span class="ident" id="7013285">stmt</span><span class="op" id="7013289">,</span>&nbsp;<span class="ident" id="7013291">err</span><span class="op" id="7013294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013300">defer</span>&nbsp;<span class="ident" id="7013306">stmt</span><span class="op" id="7013310">.</span><span class="ident" id="7013311">Close</span><span class="op" id="7013316">(</span><span class="op" id="7013317">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013320">tx</span><span class="op" id="7013322">,</span>&nbsp;<span class="ident" id="7013324">err</span>&nbsp;<span class="op" id="7013328">:=</span>&nbsp;<span class="ident" id="7013331">db</span><span class="op" id="7013333">.</span><span class="ident" id="7013334">Begin</span><span class="op" id="7013339">(</span><span class="op" id="7013340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013343">if</span>&nbsp;<span class="ident" id="7013346">err</span>&nbsp;<span class="op" id="7013350">!=</span>&nbsp;<span class="ident" id="7013353">nil</span>&nbsp;<span class="op" id="7013357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013361">t</span><span class="op" id="7013362">.</span><span class="ident" id="7013363">Fatalf</span><span class="op" id="7013369">(</span><span class="string" id="7013370">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7013382">,</span>&nbsp;<span class="ident" id="7013384">err</span><span class="op" id="7013387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013393">txs</span>&nbsp;<span class="op" id="7013397">:=</span>&nbsp;<span class="ident" id="7013400">tx</span><span class="op" id="7013402">.</span><span class="ident" id="7013403">Stmt</span><span class="op" id="7013407">(</span><span class="ident" id="7013408">stmt</span><span class="op" id="7013412">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013415">defer</span>&nbsp;<span class="ident" id="7013421">txs</span><span class="op" id="7013424">.</span><span class="ident" id="7013425">Close</span><span class="op" id="7013430">(</span><span class="op" id="7013431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013434">_</span><span class="op" id="7013435">,</span>&nbsp;<span class="ident" id="7013437">err</span>&nbsp;<span class="op" id="7013441">=</span>&nbsp;<span class="ident" id="7013443">txs</span><span class="op" id="7013446">.</span><span class="ident" id="7013447">Exec</span><span class="op" id="7013451">(</span><span class="string" id="7013452">&#34;Bobby&#34;</span><span class="op" id="7013459">,</span>&nbsp;<span class="num" id="7013461">7</span><span class="op" id="7013462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013465">if</span>&nbsp;<span class="ident" id="7013468">err</span>&nbsp;<span class="op" id="7013472">!=</span>&nbsp;<span class="ident" id="7013475">nil</span>&nbsp;<span class="op" id="7013479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013483">t</span><span class="op" id="7013484">.</span><span class="ident" id="7013485">Fatalf</span><span class="op" id="7013491">(</span><span class="string" id="7013492">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7013503">,</span>&nbsp;<span class="ident" id="7013505">err</span><span class="op" id="7013508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013511">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013514">err</span>&nbsp;<span class="op" id="7013518">=</span>&nbsp;<span class="ident" id="7013520">tx</span><span class="op" id="7013522">.</span><span class="ident" id="7013523">Commit</span><span class="op" id="7013529">(</span><span class="op" id="7013530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013533">if</span>&nbsp;<span class="ident" id="7013536">err</span>&nbsp;<span class="op" id="7013540">!=</span>&nbsp;<span class="ident" id="7013543">nil</span>&nbsp;<span class="op" id="7013547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013551">t</span><span class="op" id="7013552">.</span><span class="ident" id="7013553">Fatalf</span><span class="op" id="7013559">(</span><span class="string" id="7013560">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7013573">,</span>&nbsp;<span class="ident" id="7013575">err</span><span class="op" id="7013578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013584">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013630">if</span>&nbsp;<span class="op" id="7013633">!</span><span class="ident" id="7013634">txs</span><span class="op" id="7013637">.</span><span class="ident" id="7013638">closed</span>&nbsp;<span class="op" id="7013645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013649">t</span><span class="op" id="7013650">.</span><span class="ident" id="7013651">Fatal</span><span class="op" id="7013656">(</span><span class="string" id="7013657">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7013687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013690">}</span><br>
<span class="lineno"></span><span class="op" id="7013692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7013695">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7013734">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7013811">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7013878">func</span>&nbsp;<span class="ident" id="7013883">TestTxQuery</span><span class="op" id="7013894">(</span><span class="ident" id="7013895">t</span>&nbsp;<span class="op" id="7013897">*</span><span class="ident" id="7013898">testing</span><span class="op" id="7013905">.</span><span class="ident" id="7013906">T</span><span class="op" id="7013907">)</span>&nbsp;<span class="op" id="7013909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013912">db</span>&nbsp;<span class="op" id="7013915">:=</span>&nbsp;<span class="ident" id="7013918">newTestDB</span><span class="op" id="7013927">(</span><span class="ident" id="7013928">t</span><span class="op" id="7013929">,</span>&nbsp;<span class="string" id="7013931">&#34;&#34;</span><span class="op" id="7013933">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013936">defer</span>&nbsp;<span class="ident" id="7013942">closeDB</span><span class="op" id="7013949">(</span><span class="ident" id="7013950">t</span><span class="op" id="7013951">,</span>&nbsp;<span class="ident" id="7013953">db</span><span class="op" id="7013955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013958">exec</span><span class="op" id="7013962">(</span><span class="ident" id="7013963">t</span><span class="op" id="7013964">,</span>&nbsp;<span class="ident" id="7013966">db</span><span class="op" id="7013968">,</span>&nbsp;<span class="string" id="7013970">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7014013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014016">exec</span><span class="op" id="7014020">(</span><span class="ident" id="7014021">t</span><span class="op" id="7014022">,</span>&nbsp;<span class="ident" id="7014024">db</span><span class="op" id="7014026">,</span>&nbsp;<span class="string" id="7014028">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7014050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014054">tx</span><span class="op" id="7014056">,</span>&nbsp;<span class="ident" id="7014058">err</span>&nbsp;<span class="op" id="7014062">:=</span>&nbsp;<span class="ident" id="7014065">db</span><span class="op" id="7014067">.</span><span class="ident" id="7014068">Begin</span><span class="op" id="7014073">(</span><span class="op" id="7014074">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014077">if</span>&nbsp;<span class="ident" id="7014080">err</span>&nbsp;<span class="op" id="7014084">!=</span>&nbsp;<span class="ident" id="7014087">nil</span>&nbsp;<span class="op" id="7014091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014095">t</span><span class="op" id="7014096">.</span><span class="ident" id="7014097">Fatal</span><span class="op" id="7014102">(</span><span class="ident" id="7014103">err</span><span class="op" id="7014106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014112">defer</span>&nbsp;<span class="ident" id="7014118">tx</span><span class="op" id="7014120">.</span><span class="ident" id="7014121">Rollback</span><span class="op" id="7014129">(</span><span class="op" id="7014130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014134">r</span><span class="op" id="7014135">,</span>&nbsp;<span class="ident" id="7014137">err</span>&nbsp;<span class="op" id="7014141">:=</span>&nbsp;<span class="ident" id="7014144">tx</span><span class="op" id="7014146">.</span><span class="ident" id="7014147">Query</span><span class="op" id="7014152">(</span><span class="string" id="7014153">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7014170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014173">if</span>&nbsp;<span class="ident" id="7014176">err</span>&nbsp;<span class="op" id="7014180">!=</span>&nbsp;<span class="ident" id="7014183">nil</span>&nbsp;<span class="op" id="7014187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014191">t</span><span class="op" id="7014192">.</span><span class="ident" id="7014193">Fatal</span><span class="op" id="7014198">(</span><span class="ident" id="7014199">err</span><span class="op" id="7014202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014208">defer</span>&nbsp;<span class="ident" id="7014214">r</span><span class="op" id="7014215">.</span><span class="ident" id="7014216">Close</span><span class="op" id="7014221">(</span><span class="op" id="7014222">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014226">if</span>&nbsp;<span class="op" id="7014229">!</span><span class="ident" id="7014230">r</span><span class="op" id="7014231">.</span><span class="ident" id="7014232">Next</span><span class="op" id="7014236">(</span><span class="op" id="7014237">)</span>&nbsp;<span class="op" id="7014239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014243">if</span>&nbsp;<span class="ident" id="7014246">r</span><span class="op" id="7014247">.</span><span class="ident" id="7014248">Err</span><span class="op" id="7014251">(</span><span class="op" id="7014252">)</span>&nbsp;<span class="op" id="7014254">!=</span>&nbsp;<span class="ident" id="7014257">nil</span>&nbsp;<span class="op" id="7014261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014266">t</span><span class="op" id="7014267">.</span><span class="ident" id="7014268">Fatal</span><span class="op" id="7014273">(</span><span class="ident" id="7014274">r</span><span class="op" id="7014275">.</span><span class="ident" id="7014276">Err</span><span class="op" id="7014279">(</span><span class="op" id="7014280">)</span><span class="op" id="7014281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014285">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014289">t</span><span class="op" id="7014290">.</span><span class="ident" id="7014291">Fatal</span><span class="op" id="7014296">(</span><span class="string" id="7014297">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7014315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014322">var</span>&nbsp;<span class="ident" id="7014326">x</span>&nbsp;<span class="builtintype" id="7014328">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014336">err</span>&nbsp;<span class="op" id="7014340">=</span>&nbsp;<span class="ident" id="7014342">r</span><span class="op" id="7014343">.</span><span class="ident" id="7014344">Scan</span><span class="op" id="7014348">(</span><span class="op" id="7014349">&amp;</span><span class="ident" id="7014350">x</span><span class="op" id="7014351">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014354">if</span>&nbsp;<span class="ident" id="7014357">err</span>&nbsp;<span class="op" id="7014361">!=</span>&nbsp;<span class="ident" id="7014364">nil</span>&nbsp;<span class="op" id="7014368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014372">t</span><span class="op" id="7014373">.</span><span class="ident" id="7014374">Fatal</span><span class="op" id="7014379">(</span><span class="ident" id="7014380">err</span><span class="op" id="7014383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014386">}</span><br>
<span class="lineno"></span><span class="op" id="7014388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7014391">func</span>&nbsp;<span class="ident" id="7014396">TestTxQueryInvalid</span><span class="op" id="7014414">(</span><span class="ident" id="7014415">t</span>&nbsp;<span class="op" id="7014417">*</span><span class="ident" id="7014418">testing</span><span class="op" id="7014425">.</span><span class="ident" id="7014426">T</span><span class="op" id="7014427">)</span>&nbsp;<span class="op" id="7014429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014432">db</span>&nbsp;<span class="op" id="7014435">:=</span>&nbsp;<span class="ident" id="7014438">newTestDB</span><span class="op" id="7014447">(</span><span class="ident" id="7014448">t</span><span class="op" id="7014449">,</span>&nbsp;<span class="string" id="7014451">&#34;&#34;</span><span class="op" id="7014453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014456">defer</span>&nbsp;<span class="ident" id="7014462">closeDB</span><span class="op" id="7014469">(</span><span class="ident" id="7014470">t</span><span class="op" id="7014471">,</span>&nbsp;<span class="ident" id="7014473">db</span><span class="op" id="7014475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014479">tx</span><span class="op" id="7014481">,</span>&nbsp;<span class="ident" id="7014483">err</span>&nbsp;<span class="op" id="7014487">:=</span>&nbsp;<span class="ident" id="7014490">db</span><span class="op" id="7014492">.</span><span class="ident" id="7014493">Begin</span><span class="op" id="7014498">(</span><span class="op" id="7014499">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014502">if</span>&nbsp;<span class="ident" id="7014505">err</span>&nbsp;<span class="op" id="7014509">!=</span>&nbsp;<span class="ident" id="7014512">nil</span>&nbsp;<span class="op" id="7014516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014520">t</span><span class="op" id="7014521">.</span><span class="ident" id="7014522">Fatal</span><span class="op" id="7014527">(</span><span class="ident" id="7014528">err</span><span class="op" id="7014531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014537">defer</span>&nbsp;<span class="ident" id="7014543">tx</span><span class="op" id="7014545">.</span><span class="ident" id="7014546">Rollback</span><span class="op" id="7014554">(</span><span class="op" id="7014555">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014559">_</span><span class="op" id="7014560">,</span>&nbsp;<span class="ident" id="7014562">err</span>&nbsp;<span class="op" id="7014566">=</span>&nbsp;<span class="ident" id="7014568">tx</span><span class="op" id="7014570">.</span><span class="ident" id="7014571">Query</span><span class="op" id="7014576">(</span><span class="string" id="7014577">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7014594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014597">if</span>&nbsp;<span class="ident" id="7014600">err</span>&nbsp;<span class="op" id="7014604">==</span>&nbsp;<span class="ident" id="7014607">nil</span>&nbsp;<span class="op" id="7014611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014615">t</span><span class="op" id="7014616">.</span><span class="ident" id="7014617">Fatal</span><span class="op" id="7014622">(</span><span class="string" id="7014623">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7014639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014642">}</span><br>
<span class="lineno"></span><span class="op" id="7014644">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7014647">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7014710">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7014745">func</span>&nbsp;<span class="ident" id="7014750">TestTxErrBadConn</span><span class="op" id="7014766">(</span><span class="ident" id="7014767">t</span>&nbsp;<span class="op" id="7014769">*</span><span class="ident" id="7014770">testing</span><span class="op" id="7014777">.</span><span class="ident" id="7014778">T</span><span class="op" id="7014779">)</span>&nbsp;<span class="op" id="7014781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014784">db</span><span class="op" id="7014786">,</span>&nbsp;<span class="ident" id="7014788">err</span>&nbsp;<span class="op" id="7014792">:=</span>&nbsp;<span class="ident" id="7014795">Open</span><span class="op" id="7014799">(</span><span class="string" id="7014800">&#34;test&#34;</span><span class="op" id="7014806">,</span>&nbsp;<span class="ident" id="7014808">fakeDBName</span><span class="op" id="7014818">+</span><span class="string" id="7014819">&#34;;badConn&#34;</span><span class="op" id="7014829">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014832">if</span>&nbsp;<span class="ident" id="7014835">err</span>&nbsp;<span class="op" id="7014839">!=</span>&nbsp;<span class="ident" id="7014842">nil</span>&nbsp;<span class="op" id="7014846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014850">t</span><span class="op" id="7014851">.</span><span class="ident" id="7014852">Fatalf</span><span class="op" id="7014858">(</span><span class="string" id="7014859">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7014869">,</span>&nbsp;<span class="ident" id="7014871">err</span><span class="op" id="7014874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014880">if</span>&nbsp;<span class="ident" id="7014883">_</span><span class="op" id="7014884">,</span>&nbsp;<span class="ident" id="7014886">err</span>&nbsp;<span class="op" id="7014890">:=</span>&nbsp;<span class="ident" id="7014893">db</span><span class="op" id="7014895">.</span><span class="ident" id="7014896">Exec</span><span class="op" id="7014900">(</span><span class="string" id="7014901">&#34;WIPE&#34;</span><span class="op" id="7014907">)</span><span class="op" id="7014908">;</span>&nbsp;<span class="ident" id="7014910">err</span>&nbsp;<span class="op" id="7014914">!=</span>&nbsp;<span class="ident" id="7014917">nil</span>&nbsp;<span class="op" id="7014921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014925">t</span><span class="op" id="7014926">.</span><span class="ident" id="7014927">Fatalf</span><span class="op" id="7014933">(</span><span class="string" id="7014934">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7014949">,</span>&nbsp;<span class="ident" id="7014951">err</span><span class="op" id="7014954">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014960">defer</span>&nbsp;<span class="ident" id="7014966">closeDB</span><span class="op" id="7014973">(</span><span class="ident" id="7014974">t</span><span class="op" id="7014975">,</span>&nbsp;<span class="ident" id="7014977">db</span><span class="op" id="7014979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014982">exec</span><span class="op" id="7014986">(</span><span class="ident" id="7014987">t</span><span class="op" id="7014988">,</span>&nbsp;<span class="ident" id="7014990">db</span><span class="op" id="7014992">,</span>&nbsp;<span class="string" id="7014994">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7015037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015040">stmt</span><span class="op" id="7015044">,</span>&nbsp;<span class="ident" id="7015046">err</span>&nbsp;<span class="op" id="7015050">:=</span>&nbsp;<span class="ident" id="7015053">db</span><span class="op" id="7015055">.</span><span class="ident" id="7015056">Prepare</span><span class="op" id="7015063">(</span><span class="string" id="7015064">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7015088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015091">if</span>&nbsp;<span class="ident" id="7015094">err</span>&nbsp;<span class="op" id="7015098">!=</span>&nbsp;<span class="ident" id="7015101">nil</span>&nbsp;<span class="op" id="7015105">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015109">t</span><span class="op" id="7015110">.</span><span class="ident" id="7015111">Fatalf</span><span class="op" id="7015117">(</span><span class="string" id="7015118">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7015138">,</span>&nbsp;<span class="ident" id="7015140">stmt</span><span class="op" id="7015144">,</span>&nbsp;<span class="ident" id="7015146">err</span><span class="op" id="7015149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015155">defer</span>&nbsp;<span class="ident" id="7015161">stmt</span><span class="op" id="7015165">.</span><span class="ident" id="7015166">Close</span><span class="op" id="7015171">(</span><span class="op" id="7015172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015175">tx</span><span class="op" id="7015177">,</span>&nbsp;<span class="ident" id="7015179">err</span>&nbsp;<span class="op" id="7015183">:=</span>&nbsp;<span class="ident" id="7015186">db</span><span class="op" id="7015188">.</span><span class="ident" id="7015189">Begin</span><span class="op" id="7015194">(</span><span class="op" id="7015195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015198">if</span>&nbsp;<span class="ident" id="7015201">err</span>&nbsp;<span class="op" id="7015205">!=</span>&nbsp;<span class="ident" id="7015208">nil</span>&nbsp;<span class="op" id="7015212">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015216">t</span><span class="op" id="7015217">.</span><span class="ident" id="7015218">Fatalf</span><span class="op" id="7015224">(</span><span class="string" id="7015225">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7015237">,</span>&nbsp;<span class="ident" id="7015239">err</span><span class="op" id="7015242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015248">txs</span>&nbsp;<span class="op" id="7015252">:=</span>&nbsp;<span class="ident" id="7015255">tx</span><span class="op" id="7015257">.</span><span class="ident" id="7015258">Stmt</span><span class="op" id="7015262">(</span><span class="ident" id="7015263">stmt</span><span class="op" id="7015267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015270">defer</span>&nbsp;<span class="ident" id="7015276">txs</span><span class="op" id="7015279">.</span><span class="ident" id="7015280">Close</span><span class="op" id="7015285">(</span><span class="op" id="7015286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015289">_</span><span class="op" id="7015290">,</span>&nbsp;<span class="ident" id="7015292">err</span>&nbsp;<span class="op" id="7015296">=</span>&nbsp;<span class="ident" id="7015298">txs</span><span class="op" id="7015301">.</span><span class="ident" id="7015302">Exec</span><span class="op" id="7015306">(</span><span class="string" id="7015307">&#34;Bobby&#34;</span><span class="op" id="7015314">,</span>&nbsp;<span class="num" id="7015316">7</span><span class="op" id="7015317">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015320">if</span>&nbsp;<span class="ident" id="7015323">err</span>&nbsp;<span class="op" id="7015327">!=</span>&nbsp;<span class="ident" id="7015330">nil</span>&nbsp;<span class="op" id="7015334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015338">t</span><span class="op" id="7015339">.</span><span class="ident" id="7015340">Fatalf</span><span class="op" id="7015346">(</span><span class="string" id="7015347">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7015358">,</span>&nbsp;<span class="ident" id="7015360">err</span><span class="op" id="7015363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015369">err</span>&nbsp;<span class="op" id="7015373">=</span>&nbsp;<span class="ident" id="7015375">tx</span><span class="op" id="7015377">.</span><span class="ident" id="7015378">Commit</span><span class="op" id="7015384">(</span><span class="op" id="7015385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015388">if</span>&nbsp;<span class="ident" id="7015391">err</span>&nbsp;<span class="op" id="7015395">!=</span>&nbsp;<span class="ident" id="7015398">nil</span>&nbsp;<span class="op" id="7015402">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015406">t</span><span class="op" id="7015407">.</span><span class="ident" id="7015408">Fatalf</span><span class="op" id="7015414">(</span><span class="string" id="7015415">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7015428">,</span>&nbsp;<span class="ident" id="7015430">err</span><span class="op" id="7015433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015436">}</span><br>
<span class="lineno"></span><span class="op" id="7015438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7015441">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7015510">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7015534">func</span>&nbsp;<span class="ident" id="7015539">TestIssue2542Deadlock</span><span class="op" id="7015560">(</span><span class="ident" id="7015561">t</span>&nbsp;<span class="op" id="7015563">*</span><span class="ident" id="7015564">testing</span><span class="op" id="7015571">.</span><span class="ident" id="7015572">T</span><span class="op" id="7015573">)</span>&nbsp;<span class="op" id="7015575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015578">db</span>&nbsp;<span class="op" id="7015581">:=</span>&nbsp;<span class="ident" id="7015584">newTestDB</span><span class="op" id="7015593">(</span><span class="ident" id="7015594">t</span><span class="op" id="7015595">,</span>&nbsp;<span class="string" id="7015597">&#34;people&#34;</span><span class="op" id="7015605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015608">closeDB</span><span class="op" id="7015615">(</span><span class="ident" id="7015616">t</span><span class="op" id="7015617">,</span>&nbsp;<span class="ident" id="7015619">db</span><span class="op" id="7015621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015624">for</span>&nbsp;<span class="ident" id="7015628">i</span>&nbsp;<span class="op" id="7015630">:=</span>&nbsp;<span class="num" id="7015633">0</span><span class="op" id="7015634">;</span>&nbsp;<span class="ident" id="7015636">i</span>&nbsp;<span class="op" id="7015638">&lt;</span>&nbsp;<span class="num" id="7015640">2</span><span class="op" id="7015641">;</span>&nbsp;<span class="ident" id="7015643">i</span><span class="op" id="7015644">++</span>&nbsp;<span class="op" id="7015647">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015651">_</span><span class="op" id="7015652">,</span>&nbsp;<span class="ident" id="7015654">err</span>&nbsp;<span class="op" id="7015658">:=</span>&nbsp;<span class="ident" id="7015661">db</span><span class="op" id="7015663">.</span><span class="ident" id="7015664">Query</span><span class="op" id="7015669">(</span><span class="string" id="7015670">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7015695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015699">if</span>&nbsp;<span class="ident" id="7015702">err</span>&nbsp;<span class="op" id="7015706">==</span>&nbsp;<span class="ident" id="7015709">nil</span>&nbsp;<span class="op" id="7015713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015718">t</span><span class="op" id="7015719">.</span><span class="ident" id="7015720">Fatalf</span><span class="op" id="7015726">(</span><span class="string" id="7015727">&#34;expected&nbsp;error&#34;</span><span class="op" id="7015743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015750">}</span><br>
<span class="lineno">595</span><span class="op" id="7015752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7015755">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7015785">func</span>&nbsp;<span class="ident" id="7015790">TestCloseStmtBeforeRows</span><span class="op" id="7015813">(</span><span class="ident" id="7015814">t</span>&nbsp;<span class="op" id="7015816">*</span><span class="ident" id="7015817">testing</span><span class="op" id="7015824">.</span><span class="ident" id="7015825">T</span><span class="op" id="7015826">)</span>&nbsp;<span class="op" id="7015828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015831">db</span>&nbsp;<span class="op" id="7015834">:=</span>&nbsp;<span class="ident" id="7015837">newTestDB</span><span class="op" id="7015846">(</span><span class="ident" id="7015847">t</span><span class="op" id="7015848">,</span>&nbsp;<span class="string" id="7015850">&#34;people&#34;</span><span class="op" id="7015858">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015861">defer</span>&nbsp;<span class="ident" id="7015867">closeDB</span><span class="op" id="7015874">(</span><span class="ident" id="7015875">t</span><span class="op" id="7015876">,</span>&nbsp;<span class="ident" id="7015878">db</span><span class="op" id="7015880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015884">s</span><span class="op" id="7015885">,</span>&nbsp;<span class="ident" id="7015887">err</span>&nbsp;<span class="op" id="7015891">:=</span>&nbsp;<span class="ident" id="7015894">db</span><span class="op" id="7015896">.</span><span class="ident" id="7015897">Prepare</span><span class="op" id="7015904">(</span><span class="string" id="7015905">&#34;SELECT|people|name|&#34;</span><span class="op" id="7015926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015929">if</span>&nbsp;<span class="ident" id="7015932">err</span>&nbsp;<span class="op" id="7015936">!=</span>&nbsp;<span class="ident" id="7015939">nil</span>&nbsp;<span class="op" id="7015943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015947">t</span><span class="op" id="7015948">.</span><span class="ident" id="7015949">Fatal</span><span class="op" id="7015954">(</span><span class="ident" id="7015955">err</span><span class="op" id="7015958">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015965">r</span><span class="op" id="7015966">,</span>&nbsp;<span class="ident" id="7015968">err</span>&nbsp;<span class="op" id="7015972">:=</span>&nbsp;<span class="ident" id="7015975">s</span><span class="op" id="7015976">.</span><span class="ident" id="7015977">Query</span><span class="op" id="7015982">(</span><span class="op" id="7015983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015986">if</span>&nbsp;<span class="ident" id="7015989">err</span>&nbsp;<span class="op" id="7015993">!=</span>&nbsp;<span class="ident" id="7015996">nil</span>&nbsp;<span class="op" id="7016000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016004">s</span><span class="op" id="7016005">.</span><span class="ident" id="7016006">Close</span><span class="op" id="7016011">(</span><span class="op" id="7016012">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016016">t</span><span class="op" id="7016017">.</span><span class="ident" id="7016018">Fatal</span><span class="op" id="7016023">(</span><span class="ident" id="7016024">err</span><span class="op" id="7016027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016034">err</span>&nbsp;<span class="op" id="7016038">=</span>&nbsp;<span class="ident" id="7016040">s</span><span class="op" id="7016041">.</span><span class="ident" id="7016042">Close</span><span class="op" id="7016047">(</span><span class="op" id="7016048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016051">if</span>&nbsp;<span class="ident" id="7016054">err</span>&nbsp;<span class="op" id="7016058">!=</span>&nbsp;<span class="ident" id="7016061">nil</span>&nbsp;<span class="op" id="7016065">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016069">t</span><span class="op" id="7016070">.</span><span class="ident" id="7016071">Fatal</span><span class="op" id="7016076">(</span><span class="ident" id="7016077">err</span><span class="op" id="7016080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016087">r</span><span class="op" id="7016088">.</span><span class="ident" id="7016089">Close</span><span class="op" id="7016094">(</span><span class="op" id="7016095">)</span><br>
<span class="lineno"></span><span class="op" id="7016097">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7016100">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7016165">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7016200">func</span>&nbsp;<span class="ident" id="7016205">TestNullByteSlice</span><span class="op" id="7016222">(</span><span class="ident" id="7016223">t</span>&nbsp;<span class="op" id="7016225">*</span><span class="ident" id="7016226">testing</span><span class="op" id="7016233">.</span><span class="ident" id="7016234">T</span><span class="op" id="7016235">)</span>&nbsp;<span class="op" id="7016237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016240">db</span>&nbsp;<span class="op" id="7016243">:=</span>&nbsp;<span class="ident" id="7016246">newTestDB</span><span class="op" id="7016255">(</span><span class="ident" id="7016256">t</span><span class="op" id="7016257">,</span>&nbsp;<span class="string" id="7016259">&#34;&#34;</span><span class="op" id="7016261">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016264">defer</span>&nbsp;<span class="ident" id="7016270">closeDB</span><span class="op" id="7016277">(</span><span class="ident" id="7016278">t</span><span class="op" id="7016279">,</span>&nbsp;<span class="ident" id="7016281">db</span><span class="op" id="7016283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016286">exec</span><span class="op" id="7016290">(</span><span class="ident" id="7016291">t</span><span class="op" id="7016292">,</span>&nbsp;<span class="ident" id="7016294">db</span><span class="op" id="7016296">,</span>&nbsp;<span class="string" id="7016298">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7016333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016336">exec</span><span class="op" id="7016340">(</span><span class="ident" id="7016341">t</span><span class="op" id="7016342">,</span>&nbsp;<span class="ident" id="7016344">db</span><span class="op" id="7016346">,</span>&nbsp;<span class="string" id="7016348">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7016371">,</span>&nbsp;<span class="ident" id="7016373">nil</span><span class="op" id="7016376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016380">var</span>&nbsp;<span class="ident" id="7016384">name</span>&nbsp;<span class="op" id="7016389">[</span><span class="op" id="7016390">]</span><span class="builtintype" id="7016391">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016398">err</span>&nbsp;<span class="op" id="7016402">:=</span>&nbsp;<span class="ident" id="7016405">db</span><span class="op" id="7016407">.</span><span class="ident" id="7016408">QueryRow</span><span class="op" id="7016416">(</span><span class="string" id="7016417">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7016437">,</span>&nbsp;<span class="num" id="7016439">10</span><span class="op" id="7016441">)</span><span class="op" id="7016442">.</span><span class="ident" id="7016443">Scan</span><span class="op" id="7016447">(</span><span class="op" id="7016448">&amp;</span><span class="ident" id="7016449">name</span><span class="op" id="7016453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016456">if</span>&nbsp;<span class="ident" id="7016459">err</span>&nbsp;<span class="op" id="7016463">!=</span>&nbsp;<span class="ident" id="7016466">nil</span>&nbsp;<span class="op" id="7016470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016474">t</span><span class="op" id="7016475">.</span><span class="ident" id="7016476">Fatal</span><span class="op" id="7016481">(</span><span class="ident" id="7016482">err</span><span class="op" id="7016485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016488">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016491">if</span>&nbsp;<span class="ident" id="7016494">name</span>&nbsp;<span class="op" id="7016499">!=</span>&nbsp;<span class="ident" id="7016502">nil</span>&nbsp;<span class="op" id="7016506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016510">t</span><span class="op" id="7016511">.</span><span class="ident" id="7016512">Fatalf</span><span class="op" id="7016518">(</span><span class="string" id="7016519">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7016578">,</span>&nbsp;<span class="ident" id="7016580">name</span><span class="op" id="7016584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016591">exec</span><span class="op" id="7016595">(</span><span class="ident" id="7016596">t</span><span class="op" id="7016597">,</span>&nbsp;<span class="ident" id="7016599">db</span><span class="op" id="7016601">,</span>&nbsp;<span class="string" id="7016603">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7016626">,</span>&nbsp;<span class="string" id="7016628">&#34;bob&#34;</span><span class="op" id="7016633">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016636">err</span>&nbsp;<span class="op" id="7016640">=</span>&nbsp;<span class="ident" id="7016642">db</span><span class="op" id="7016644">.</span><span class="ident" id="7016645">QueryRow</span><span class="op" id="7016653">(</span><span class="string" id="7016654">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7016674">,</span>&nbsp;<span class="num" id="7016676">11</span><span class="op" id="7016678">)</span><span class="op" id="7016679">.</span><span class="ident" id="7016680">Scan</span><span class="op" id="7016684">(</span><span class="op" id="7016685">&amp;</span><span class="ident" id="7016686">name</span><span class="op" id="7016690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016693">if</span>&nbsp;<span class="ident" id="7016696">err</span>&nbsp;<span class="op" id="7016700">!=</span>&nbsp;<span class="ident" id="7016703">nil</span>&nbsp;<span class="op" id="7016707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016711">t</span><span class="op" id="7016712">.</span><span class="ident" id="7016713">Fatal</span><span class="op" id="7016718">(</span><span class="ident" id="7016719">err</span><span class="op" id="7016722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016728">if</span>&nbsp;<span class="builtintype" id="7016731">string</span><span class="op" id="7016737">(</span><span class="ident" id="7016738">name</span><span class="op" id="7016742">)</span>&nbsp;<span class="op" id="7016744">!=</span>&nbsp;<span class="string" id="7016747">&#34;bob&#34;</span>&nbsp;<span class="op" id="7016753">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016757">t</span><span class="op" id="7016758">.</span><span class="ident" id="7016759">Fatalf</span><span class="op" id="7016765">(</span><span class="string" id="7016766">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7016802">,</span>&nbsp;<span class="builtintype" id="7016804">string</span><span class="op" id="7016810">(</span><span class="ident" id="7016811">name</span><span class="op" id="7016815">)</span><span class="op" id="7016816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016819">}</span><br>
<span class="lineno"></span><span class="op" id="7016821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7016824">func</span>&nbsp;<span class="ident" id="7016829">TestPointerParamsAndScans</span><span class="op" id="7016854">(</span><span class="ident" id="7016855">t</span>&nbsp;<span class="op" id="7016857">*</span><span class="ident" id="7016858">testing</span><span class="op" id="7016865">.</span><span class="ident" id="7016866">T</span><span class="op" id="7016867">)</span>&nbsp;<span class="op" id="7016869">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016872">db</span>&nbsp;<span class="op" id="7016875">:=</span>&nbsp;<span class="ident" id="7016878">newTestDB</span><span class="op" id="7016887">(</span><span class="ident" id="7016888">t</span><span class="op" id="7016889">,</span>&nbsp;<span class="string" id="7016891">&#34;&#34;</span><span class="op" id="7016893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016896">defer</span>&nbsp;<span class="ident" id="7016902">closeDB</span><span class="op" id="7016909">(</span><span class="ident" id="7016910">t</span><span class="op" id="7016911">,</span>&nbsp;<span class="ident" id="7016913">db</span><span class="op" id="7016915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016918">exec</span><span class="op" id="7016922">(</span><span class="ident" id="7016923">t</span><span class="op" id="7016924">,</span>&nbsp;<span class="ident" id="7016926">db</span><span class="op" id="7016928">,</span>&nbsp;<span class="string" id="7016930">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7016965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016969">bob</span>&nbsp;<span class="op" id="7016973">:=</span>&nbsp;<span class="string" id="7016976">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016983">var</span>&nbsp;<span class="ident" id="7016987">name</span>&nbsp;<span class="op" id="7016992">*</span><span class="builtintype" id="7016993">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017002">name</span>&nbsp;<span class="op" id="7017007">=</span>&nbsp;<span class="op" id="7017009">&amp;</span><span class="ident" id="7017010">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017015">exec</span><span class="op" id="7017019">(</span><span class="ident" id="7017020">t</span><span class="op" id="7017021">,</span>&nbsp;<span class="ident" id="7017023">db</span><span class="op" id="7017025">,</span>&nbsp;<span class="string" id="7017027">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7017050">,</span>&nbsp;<span class="ident" id="7017052">name</span><span class="op" id="7017056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017059">name</span>&nbsp;<span class="op" id="7017064">=</span>&nbsp;<span class="ident" id="7017066">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017071">exec</span><span class="op" id="7017075">(</span><span class="ident" id="7017076">t</span><span class="op" id="7017077">,</span>&nbsp;<span class="ident" id="7017079">db</span><span class="op" id="7017081">,</span>&nbsp;<span class="string" id="7017083">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7017106">,</span>&nbsp;<span class="ident" id="7017108">name</span><span class="op" id="7017112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017116">err</span>&nbsp;<span class="op" id="7017120">:=</span>&nbsp;<span class="ident" id="7017123">db</span><span class="op" id="7017125">.</span><span class="ident" id="7017126">QueryRow</span><span class="op" id="7017134">(</span><span class="string" id="7017135">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7017155">,</span>&nbsp;<span class="num" id="7017157">10</span><span class="op" id="7017159">)</span><span class="op" id="7017160">.</span><span class="ident" id="7017161">Scan</span><span class="op" id="7017165">(</span><span class="op" id="7017166">&amp;</span><span class="ident" id="7017167">name</span><span class="op" id="7017171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017174">if</span>&nbsp;<span class="ident" id="7017177">err</span>&nbsp;<span class="op" id="7017181">!=</span>&nbsp;<span class="ident" id="7017184">nil</span>&nbsp;<span class="op" id="7017188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017192">t</span><span class="op" id="7017193">.</span><span class="ident" id="7017194">Fatalf</span><span class="op" id="7017200">(</span><span class="string" id="7017201">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7017221">,</span>&nbsp;<span class="ident" id="7017223">err</span><span class="op" id="7017226">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017232">if</span>&nbsp;<span class="ident" id="7017235">name</span>&nbsp;<span class="op" id="7017240">==</span>&nbsp;<span class="ident" id="7017243">nil</span>&nbsp;<span class="op" id="7017247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017251">t</span><span class="op" id="7017252">.</span><span class="ident" id="7017253">Errorf</span><span class="op" id="7017259">(</span><span class="string" id="7017260">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7017290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017293">}</span>&nbsp;<span class="keyword" id="7017295">else</span>&nbsp;<span class="keyword" id="7017300">if</span>&nbsp;<span class="op" id="7017303">*</span><span class="ident" id="7017304">name</span>&nbsp;<span class="op" id="7017309">!=</span>&nbsp;<span class="string" id="7017312">&#34;bob&#34;</span>&nbsp;<span class="op" id="7017318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017322">t</span><span class="op" id="7017323">.</span><span class="ident" id="7017324">Errorf</span><span class="op" id="7017330">(</span><span class="string" id="7017331">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7017360">,</span>&nbsp;<span class="op" id="7017362">*</span><span class="ident" id="7017363">name</span><span class="op" id="7017367">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017374">err</span>&nbsp;<span class="op" id="7017378">=</span>&nbsp;<span class="ident" id="7017380">db</span><span class="op" id="7017382">.</span><span class="ident" id="7017383">QueryRow</span><span class="op" id="7017391">(</span><span class="string" id="7017392">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7017412">,</span>&nbsp;<span class="num" id="7017414">20</span><span class="op" id="7017416">)</span><span class="op" id="7017417">.</span><span class="ident" id="7017418">Scan</span><span class="op" id="7017422">(</span><span class="op" id="7017423">&amp;</span><span class="ident" id="7017424">name</span><span class="op" id="7017428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017431">if</span>&nbsp;<span class="ident" id="7017434">err</span>&nbsp;<span class="op" id="7017438">!=</span>&nbsp;<span class="ident" id="7017441">nil</span>&nbsp;<span class="op" id="7017445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017449">t</span><span class="op" id="7017450">.</span><span class="ident" id="7017451">Fatalf</span><span class="op" id="7017457">(</span><span class="string" id="7017458">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7017478">,</span>&nbsp;<span class="ident" id="7017480">err</span><span class="op" id="7017483">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017489">if</span>&nbsp;<span class="ident" id="7017492">name</span>&nbsp;<span class="op" id="7017497">!=</span>&nbsp;<span class="ident" id="7017500">nil</span>&nbsp;<span class="op" id="7017504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017508">t</span><span class="op" id="7017509">.</span><span class="ident" id="7017510">Errorf</span><span class="op" id="7017516">(</span><span class="string" id="7017517">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7017539">,</span>&nbsp;<span class="op" id="7017541">*</span><span class="ident" id="7017542">name</span><span class="op" id="7017546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017549">}</span><br>
<span class="lineno"></span><span class="op" id="7017551">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7017554">func</span>&nbsp;<span class="ident" id="7017559">TestQueryRowClosingStmt</span><span class="op" id="7017582">(</span><span class="ident" id="7017583">t</span>&nbsp;<span class="op" id="7017585">*</span><span class="ident" id="7017586">testing</span><span class="op" id="7017593">.</span><span class="ident" id="7017594">T</span><span class="op" id="7017595">)</span>&nbsp;<span class="op" id="7017597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017600">db</span>&nbsp;<span class="op" id="7017603">:=</span>&nbsp;<span class="ident" id="7017606">newTestDB</span><span class="op" id="7017615">(</span><span class="ident" id="7017616">t</span><span class="op" id="7017617">,</span>&nbsp;<span class="string" id="7017619">&#34;people&#34;</span><span class="op" id="7017627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017630">defer</span>&nbsp;<span class="ident" id="7017636">closeDB</span><span class="op" id="7017643">(</span><span class="ident" id="7017644">t</span><span class="op" id="7017645">,</span>&nbsp;<span class="ident" id="7017647">db</span><span class="op" id="7017649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017652">var</span>&nbsp;<span class="ident" id="7017656">name</span>&nbsp;<span class="builtintype" id="7017661">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017669">var</span>&nbsp;<span class="ident" id="7017673">age</span>&nbsp;<span class="builtintype" id="7017677">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017682">err</span>&nbsp;<span class="op" id="7017686">:=</span>&nbsp;<span class="ident" id="7017689">db</span><span class="op" id="7017691">.</span><span class="ident" id="7017692">QueryRow</span><span class="op" id="7017700">(</span><span class="string" id="7017701">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7017731">,</span>&nbsp;<span class="num" id="7017733">3</span><span class="op" id="7017734">)</span><span class="op" id="7017735">.</span><span class="ident" id="7017736">Scan</span><span class="op" id="7017740">(</span><span class="op" id="7017741">&amp;</span><span class="ident" id="7017742">age</span><span class="op" id="7017745">,</span>&nbsp;<span class="op" id="7017747">&amp;</span><span class="ident" id="7017748">name</span><span class="op" id="7017752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017755">if</span>&nbsp;<span class="ident" id="7017758">err</span>&nbsp;<span class="op" id="7017762">!=</span>&nbsp;<span class="ident" id="7017765">nil</span>&nbsp;<span class="op" id="7017769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017773">t</span><span class="op" id="7017774">.</span><span class="ident" id="7017775">Fatal</span><span class="op" id="7017780">(</span><span class="ident" id="7017781">err</span><span class="op" id="7017784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017787">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017790">if</span>&nbsp;<span class="builtinfunc" id="7017793">len</span><span class="op" id="7017796">(</span><span class="ident" id="7017797">db</span><span class="op" id="7017799">.</span><span class="ident" id="7017800">freeConn</span><span class="op" id="7017808">)</span>&nbsp;<span class="op" id="7017810">!=</span>&nbsp;<span class="num" id="7017813">1</span>&nbsp;<span class="op" id="7017815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017819">t</span><span class="op" id="7017820">.</span><span class="ident" id="7017821">Fatalf</span><span class="op" id="7017827">(</span><span class="string" id="7017828">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7017850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7017853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017856">fakeConn</span>&nbsp;<span class="op" id="7017865">:=</span>&nbsp;<span class="ident" id="7017868">db</span><span class="op" id="7017870">.</span><span class="ident" id="7017871">freeConn</span><span class="op" id="7017879">[</span><span class="num" id="7017880">0</span><span class="op" id="7017881">]</span><span class="op" id="7017882">.</span><span class="ident" id="7017883">ci</span><span class="op" id="7017885">.</span><span class="op" id="7017886">(</span><span class="op" id="7017887">*</span><span class="ident" id="7017888">fakeConn</span><span class="op" id="7017896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7017899">if</span>&nbsp;<span class="ident" id="7017902">made</span><span class="op" id="7017906">,</span>&nbsp;<span class="ident" id="7017908">closed</span>&nbsp;<span class="op" id="7017915">:=</span>&nbsp;<span class="ident" id="7017918">fakeConn</span><span class="op" id="7017926">.</span><span class="ident" id="7017927">stmtsMade</span><span class="op" id="7017936">,</span>&nbsp;<span class="ident" id="7017938">fakeConn</span><span class="op" id="7017946">.</span><span class="ident" id="7017947">stmtsClosed</span><span class="op" id="7017958">;</span>&nbsp;<span class="ident" id="7017960">made</span>&nbsp;<span class="op" id="7017965">!=</span>&nbsp;<span class="ident" id="7017968">closed</span>&nbsp;<span class="op" id="7017975">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7017979">t</span><span class="op" id="7017980">.</span><span class="ident" id="7017981">Errorf</span><span class="op" id="7017987">(</span><span class="string" id="7017988">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7018034">,</span>&nbsp;<span class="ident" id="7018036">made</span><span class="op" id="7018040">,</span>&nbsp;<span class="ident" id="7018042">closed</span><span class="op" id="7018048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018051">}</span><br>
<span class="lineno"></span><span class="op" id="7018053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7018056">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7018075">func</span>&nbsp;<span class="ident" id="7018080">TestIssue6651</span><span class="op" id="7018093">(</span><span class="ident" id="7018094">t</span>&nbsp;<span class="op" id="7018096">*</span><span class="ident" id="7018097">testing</span><span class="op" id="7018104">.</span><span class="ident" id="7018105">T</span><span class="op" id="7018106">)</span>&nbsp;<span class="op" id="7018108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018111">db</span>&nbsp;<span class="op" id="7018114">:=</span>&nbsp;<span class="ident" id="7018117">newTestDB</span><span class="op" id="7018126">(</span><span class="ident" id="7018127">t</span><span class="op" id="7018128">,</span>&nbsp;<span class="string" id="7018130">&#34;people&#34;</span><span class="op" id="7018138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018141">defer</span>&nbsp;<span class="ident" id="7018147">closeDB</span><span class="op" id="7018154">(</span><span class="ident" id="7018155">t</span><span class="op" id="7018156">,</span>&nbsp;<span class="ident" id="7018158">db</span><span class="op" id="7018160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018164">var</span>&nbsp;<span class="ident" id="7018168">v</span>&nbsp;<span class="builtintype" id="7018170">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018179">want</span>&nbsp;<span class="op" id="7018184">:=</span>&nbsp;<span class="string" id="7018187">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018209">rowsCursorNextHook</span>&nbsp;<span class="op" id="7018228">=</span>&nbsp;<span class="keyword" id="7018230">func</span><span class="op" id="7018234">(</span><span class="ident" id="7018235">dest</span>&nbsp;<span class="op" id="7018240">[</span><span class="op" id="7018241">]</span><span class="ident" id="7018242">driver</span><span class="op" id="7018248">.</span><span class="ident" id="7018249">Value</span><span class="op" id="7018254">)</span>&nbsp;<span class="builtintype" id="7018256">error</span>&nbsp;<span class="op" id="7018262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018266">return</span>&nbsp;<span class="ident" id="7018273">fmt</span><span class="op" id="7018276">.</span><span class="ident" id="7018277">Errorf</span><span class="op" id="7018283">(</span><span class="ident" id="7018284">want</span><span class="op" id="7018288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018291">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018294">defer</span>&nbsp;<span class="keyword" id="7018300">func</span><span class="op" id="7018304">(</span><span class="op" id="7018305">)</span>&nbsp;<span class="op" id="7018307">{</span>&nbsp;<span class="ident" id="7018309">rowsCursorNextHook</span>&nbsp;<span class="op" id="7018328">=</span>&nbsp;<span class="ident" id="7018330">nil</span>&nbsp;<span class="op" id="7018334">}</span><span class="op" id="7018335">(</span><span class="op" id="7018336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018339">err</span>&nbsp;<span class="op" id="7018343">:=</span>&nbsp;<span class="ident" id="7018346">db</span><span class="op" id="7018348">.</span><span class="ident" id="7018349">QueryRow</span><span class="op" id="7018357">(</span><span class="string" id="7018358">&#34;SELECT|people|name|&#34;</span><span class="op" id="7018379">)</span><span class="op" id="7018380">.</span><span class="ident" id="7018381">Scan</span><span class="op" id="7018385">(</span><span class="op" id="7018386">&amp;</span><span class="ident" id="7018387">v</span><span class="op" id="7018388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018391">if</span>&nbsp;<span class="ident" id="7018394">err</span>&nbsp;<span class="op" id="7018398">==</span>&nbsp;<span class="ident" id="7018401">nil</span>&nbsp;<span class="op" id="7018405">||</span>&nbsp;<span class="ident" id="7018408">err</span><span class="op" id="7018411">.</span><span class="ident" id="7018412">Error</span><span class="op" id="7018417">(</span><span class="op" id="7018418">)</span>&nbsp;<span class="op" id="7018420">!=</span>&nbsp;<span class="ident" id="7018423">want</span>&nbsp;<span class="op" id="7018428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018432">t</span><span class="op" id="7018433">.</span><span class="ident" id="7018434">Errorf</span><span class="op" id="7018440">(</span><span class="string" id="7018441">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7018462">,</span>&nbsp;<span class="ident" id="7018464">err</span><span class="op" id="7018467">,</span>&nbsp;<span class="ident" id="7018469">want</span><span class="op" id="7018473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018476">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018479">rowsCursorNextHook</span>&nbsp;<span class="op" id="7018498">=</span>&nbsp;<span class="ident" id="7018500">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018506">want</span>&nbsp;<span class="op" id="7018511">=</span>&nbsp;<span class="string" id="7018513">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018536">rowsCloseHook</span>&nbsp;<span class="op" id="7018550">=</span>&nbsp;<span class="keyword" id="7018552">func</span><span class="op" id="7018556">(</span><span class="ident" id="7018557">rows</span>&nbsp;<span class="op" id="7018562">*</span><span class="ident" id="7018563">Rows</span><span class="op" id="7018567">,</span>&nbsp;<span class="ident" id="7018569">err</span>&nbsp;<span class="op" id="7018573">*</span><span class="builtintype" id="7018574">error</span><span class="op" id="7018579">)</span>&nbsp;<span class="op" id="7018581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018585">*</span><span class="ident" id="7018586">err</span>&nbsp;<span class="op" id="7018590">=</span>&nbsp;<span class="ident" id="7018592">fmt</span><span class="op" id="7018595">.</span><span class="ident" id="7018596">Errorf</span><span class="op" id="7018602">(</span><span class="ident" id="7018603">want</span><span class="op" id="7018607">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018613">defer</span>&nbsp;<span class="keyword" id="7018619">func</span><span class="op" id="7018623">(</span><span class="op" id="7018624">)</span>&nbsp;<span class="op" id="7018626">{</span>&nbsp;<span class="ident" id="7018628">rowsCloseHook</span>&nbsp;<span class="op" id="7018642">=</span>&nbsp;<span class="ident" id="7018644">nil</span>&nbsp;<span class="op" id="7018648">}</span><span class="op" id="7018649">(</span><span class="op" id="7018650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018653">err</span>&nbsp;<span class="op" id="7018657">=</span>&nbsp;<span class="ident" id="7018659">db</span><span class="op" id="7018661">.</span><span class="ident" id="7018662">QueryRow</span><span class="op" id="7018670">(</span><span class="string" id="7018671">&#34;SELECT|people|name|&#34;</span><span class="op" id="7018692">)</span><span class="op" id="7018693">.</span><span class="ident" id="7018694">Scan</span><span class="op" id="7018698">(</span><span class="op" id="7018699">&amp;</span><span class="ident" id="7018700">v</span><span class="op" id="7018701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7018704">if</span>&nbsp;<span class="ident" id="7018707">err</span>&nbsp;<span class="op" id="7018711">==</span>&nbsp;<span class="ident" id="7018714">nil</span>&nbsp;<span class="op" id="7018718">||</span>&nbsp;<span class="ident" id="7018721">err</span><span class="op" id="7018724">.</span><span class="ident" id="7018725">Error</span><span class="op" id="7018730">(</span><span class="op" id="7018731">)</span>&nbsp;<span class="op" id="7018733">!=</span>&nbsp;<span class="ident" id="7018736">want</span>&nbsp;<span class="op" id="7018741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018745">t</span><span class="op" id="7018746">.</span><span class="ident" id="7018747">Errorf</span><span class="op" id="7018753">(</span><span class="string" id="7018754">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7018775">,</span>&nbsp;<span class="ident" id="7018777">err</span><span class="op" id="7018780">,</span>&nbsp;<span class="ident" id="7018782">want</span><span class="op" id="7018786">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7018789">}</span><br>
<span class="lineno"></span><span class="op" id="7018791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7018794">type</span>&nbsp;<span class="ident" id="7018799">nullTestRow</span>&nbsp;<span class="keyword" id="7018811">struct</span>&nbsp;<span class="op" id="7018818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018821">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7018834">interface</span><span class="op" id="7018843">{</span><span class="op" id="7018844">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018847">notNullParam</span>&nbsp;<span class="keyword" id="7018860">interface</span><span class="op" id="7018869">{</span><span class="op" id="7018870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018873">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7018886">interface</span><span class="op" id="7018895">{</span><span class="op" id="7018896">}</span><br>
<span class="lineno"></span><span class="op" id="7018898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7018901">type</span>&nbsp;<span class="ident" id="7018906">nullTestSpec</span>&nbsp;<span class="keyword" id="7018919">struct</span>&nbsp;<span class="op" id="7018926">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018929">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7018941">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018949">notNullType</span>&nbsp;<span class="builtintype" id="7018961">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7018969">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7018981">[</span><span class="num" id="7018982">6</span><span class="op" id="7018983">]</span><span class="ident" id="7018984">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7018996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7018999">func</span>&nbsp;<span class="ident" id="7019004">TestNullStringParam</span><span class="op" id="7019023">(</span><span class="ident" id="7019024">t</span>&nbsp;<span class="op" id="7019026">*</span><span class="ident" id="7019027">testing</span><span class="op" id="7019034">.</span><span class="ident" id="7019035">T</span><span class="op" id="7019036">)</span>&nbsp;<span class="op" id="7019038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7019041">spec</span>&nbsp;<span class="op" id="7019046">:=</span>&nbsp;<span class="ident" id="7019049">nullTestSpec</span><span class="op" id="7019061">{</span><span class="string" id="7019062">&#34;nullstring&#34;</span><span class="op" id="7019074">,</span>&nbsp;<span class="string" id="7019076">&#34;string&#34;</span><span class="op" id="7019084">,</span>&nbsp;<span class="op" id="7019086">[</span><span class="num" id="7019087">6</span><span class="op" id="7019088">]</span><span class="ident" id="7019089">nullTestRow</span><span class="op" id="7019100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019104">{</span><span class="ident" id="7019105">NullString</span><span class="op" id="7019115">{</span><span class="string" id="7019116">&#34;aqua&#34;</span><span class="op" id="7019122">,</span>&nbsp;<span class="builtintype" id="7019124">true</span><span class="op" id="7019128">}</span><span class="op" id="7019129">,</span>&nbsp;<span class="string" id="7019131">&#34;&#34;</span><span class="op" id="7019133">,</span>&nbsp;<span class="ident" id="7019135">NullString</span><span class="op" id="7019145">{</span><span class="string" id="7019146">&#34;aqua&#34;</span><span class="op" id="7019152">,</span>&nbsp;<span class="builtintype" id="7019154">true</span><span class="op" id="7019158">}</span><span class="op" id="7019159">}</span><span class="op" id="7019160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019164">{</span><span class="ident" id="7019165">NullString</span><span class="op" id="7019175">{</span><span class="string" id="7019176">&#34;brown&#34;</span><span class="op" id="7019183">,</span>&nbsp;<span class="builtintype" id="7019185">false</span><span class="op" id="7019190">}</span><span class="op" id="7019191">,</span>&nbsp;<span class="string" id="7019193">&#34;&#34;</span><span class="op" id="7019195">,</span>&nbsp;<span class="ident" id="7019197">NullString</span><span class="op" id="7019207">{</span><span class="string" id="7019208">&#34;&#34;</span><span class="op" id="7019210">,</span>&nbsp;<span class="builtintype" id="7019212">false</span><span class="op" id="7019217">}</span><span class="op" id="7019218">}</span><span class="op" id="7019219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019223">{</span><span class="string" id="7019224">&#34;chartreuse&#34;</span><span class="op" id="7019236">,</span>&nbsp;<span class="string" id="7019238">&#34;&#34;</span><span class="op" id="7019240">,</span>&nbsp;<span class="ident" id="7019242">NullString</span><span class="op" id="7019252">{</span><span class="string" id="7019253">&#34;chartreuse&#34;</span><span class="op" id="7019265">,</span>&nbsp;<span class="builtintype" id="7019267">true</span><span class="op" id="7019271">}</span><span class="op" id="7019272">}</span><span class="op" id="7019273">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019277">{</span><span class="ident" id="7019278">NullString</span><span class="op" id="7019288">{</span><span class="string" id="7019289">&#34;darkred&#34;</span><span class="op" id="7019298">,</span>&nbsp;<span class="builtintype" id="7019300">true</span><span class="op" id="7019304">}</span><span class="op" id="7019305">,</span>&nbsp;<span class="string" id="7019307">&#34;&#34;</span><span class="op" id="7019309">,</span>&nbsp;<span class="ident" id="7019311">NullString</span><span class="op" id="7019321">{</span><span class="string" id="7019322">&#34;darkred&#34;</span><span class="op" id="7019331">,</span>&nbsp;<span class="builtintype" id="7019333">true</span><span class="op" id="7019337">}</span><span class="op" id="7019338">}</span><span class="op" id="7019339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019343">{</span><span class="ident" id="7019344">NullString</span><span class="op" id="7019354">{</span><span class="string" id="7019355">&#34;eel&#34;</span><span class="op" id="7019360">,</span>&nbsp;<span class="builtintype" id="7019362">false</span><span class="op" id="7019367">}</span><span class="op" id="7019368">,</span>&nbsp;<span class="string" id="7019370">&#34;&#34;</span><span class="op" id="7019372">,</span>&nbsp;<span class="ident" id="7019374">NullString</span><span class="op" id="7019384">{</span><span class="string" id="7019385">&#34;&#34;</span><span class="op" id="7019387">,</span>&nbsp;<span class="builtintype" id="7019389">false</span><span class="op" id="7019394">}</span><span class="op" id="7019395">}</span><span class="op" id="7019396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019400">{</span><span class="string" id="7019401">&#34;foo&#34;</span><span class="op" id="7019406">,</span>&nbsp;<span class="ident" id="7019408">NullString</span><span class="op" id="7019418">{</span><span class="string" id="7019419">&#34;black&#34;</span><span class="op" id="7019426">,</span>&nbsp;<span class="builtintype" id="7019428">false</span><span class="op" id="7019433">}</span><span class="op" id="7019434">,</span>&nbsp;<span class="ident" id="7019436">nil</span><span class="op" id="7019439">}</span><span class="op" id="7019440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019443">}</span><span class="op" id="7019444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7019447">nullTestRun</span><span class="op" id="7019458">(</span><span class="ident" id="7019459">t</span><span class="op" id="7019460">,</span>&nbsp;<span class="ident" id="7019462">spec</span><span class="op" id="7019466">)</span><br>
<span class="lineno">750</span><span class="op" id="7019468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7019471">func</span>&nbsp;<span class="ident" id="7019476">TestNullInt64Param</span><span class="op" id="7019494">(</span><span class="ident" id="7019495">t</span>&nbsp;<span class="op" id="7019497">*</span><span class="ident" id="7019498">testing</span><span class="op" id="7019505">.</span><span class="ident" id="7019506">T</span><span class="op" id="7019507">)</span>&nbsp;<span class="op" id="7019509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7019512">spec</span>&nbsp;<span class="op" id="7019517">:=</span>&nbsp;<span class="ident" id="7019520">nullTestSpec</span><span class="op" id="7019532">{</span><span class="string" id="7019533">&#34;nullint64&#34;</span><span class="op" id="7019544">,</span>&nbsp;<span class="string" id="7019546">&#34;int64&#34;</span><span class="op" id="7019553">,</span>&nbsp;<span class="op" id="7019555">[</span><span class="num" id="7019556">6</span><span class="op" id="7019557">]</span><span class="ident" id="7019558">nullTestRow</span><span class="op" id="7019569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019573">{</span><span class="ident" id="7019574">NullInt64</span><span class="op" id="7019583">{</span><span class="num" id="7019584">31</span><span class="op" id="7019586">,</span>&nbsp;<span class="builtintype" id="7019588">true</span><span class="op" id="7019592">}</span><span class="op" id="7019593">,</span>&nbsp;<span class="num" id="7019595">1</span><span class="op" id="7019596">,</span>&nbsp;<span class="ident" id="7019598">NullInt64</span><span class="op" id="7019607">{</span><span class="num" id="7019608">31</span><span class="op" id="7019610">,</span>&nbsp;<span class="builtintype" id="7019612">true</span><span class="op" id="7019616">}</span><span class="op" id="7019617">}</span><span class="op" id="7019618">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019622">{</span><span class="ident" id="7019623">NullInt64</span><span class="op" id="7019632">{</span><span class="op" id="7019633">-</span><span class="num" id="7019634">22</span><span class="op" id="7019636">,</span>&nbsp;<span class="builtintype" id="7019638">false</span><span class="op" id="7019643">}</span><span class="op" id="7019644">,</span>&nbsp;<span class="num" id="7019646">1</span><span class="op" id="7019647">,</span>&nbsp;<span class="ident" id="7019649">NullInt64</span><span class="op" id="7019658">{</span><span class="num" id="7019659">0</span><span class="op" id="7019660">,</span>&nbsp;<span class="builtintype" id="7019662">false</span><span class="op" id="7019667">}</span><span class="op" id="7019668">}</span><span class="op" id="7019669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019673">{</span><span class="num" id="7019674">22</span><span class="op" id="7019676">,</span>&nbsp;<span class="num" id="7019678">1</span><span class="op" id="7019679">,</span>&nbsp;<span class="ident" id="7019681">NullInt64</span><span class="op" id="7019690">{</span><span class="num" id="7019691">22</span><span class="op" id="7019693">,</span>&nbsp;<span class="builtintype" id="7019695">true</span><span class="op" id="7019699">}</span><span class="op" id="7019700">}</span><span class="op" id="7019701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019705">{</span><span class="ident" id="7019706">NullInt64</span><span class="op" id="7019715">{</span><span class="num" id="7019716">33</span><span class="op" id="7019718">,</span>&nbsp;<span class="builtintype" id="7019720">true</span><span class="op" id="7019724">}</span><span class="op" id="7019725">,</span>&nbsp;<span class="num" id="7019727">1</span><span class="op" id="7019728">,</span>&nbsp;<span class="ident" id="7019730">NullInt64</span><span class="op" id="7019739">{</span><span class="num" id="7019740">33</span><span class="op" id="7019742">,</span>&nbsp;<span class="builtintype" id="7019744">true</span><span class="op" id="7019748">}</span><span class="op" id="7019749">}</span><span class="op" id="7019750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019754">{</span><span class="ident" id="7019755">NullInt64</span><span class="op" id="7019764">{</span><span class="num" id="7019765">222</span><span class="op" id="7019768">,</span>&nbsp;<span class="builtintype" id="7019770">false</span><span class="op" id="7019775">}</span><span class="op" id="7019776">,</span>&nbsp;<span class="num" id="7019778">1</span><span class="op" id="7019779">,</span>&nbsp;<span class="ident" id="7019781">NullInt64</span><span class="op" id="7019790">{</span><span class="num" id="7019791">0</span><span class="op" id="7019792">,</span>&nbsp;<span class="builtintype" id="7019794">false</span><span class="op" id="7019799">}</span><span class="op" id="7019800">}</span><span class="op" id="7019801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019805">{</span><span class="num" id="7019806">0</span><span class="op" id="7019807">,</span>&nbsp;<span class="ident" id="7019809">NullInt64</span><span class="op" id="7019818">{</span><span class="num" id="7019819">31</span><span class="op" id="7019821">,</span>&nbsp;<span class="builtintype" id="7019823">false</span><span class="op" id="7019828">}</span><span class="op" id="7019829">,</span>&nbsp;<span class="ident" id="7019831">nil</span><span class="op" id="7019834">}</span><span class="op" id="7019835">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019838">}</span><span class="op" id="7019839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7019842">nullTestRun</span><span class="op" id="7019853">(</span><span class="ident" id="7019854">t</span><span class="op" id="7019855">,</span>&nbsp;<span class="ident" id="7019857">spec</span><span class="op" id="7019861">)</span><br>
<span class="lineno"></span><span class="op" id="7019863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7019866">func</span>&nbsp;<span class="ident" id="7019871">TestNullFloat64Param</span><span class="op" id="7019891">(</span><span class="ident" id="7019892">t</span>&nbsp;<span class="op" id="7019894">*</span><span class="ident" id="7019895">testing</span><span class="op" id="7019902">.</span><span class="ident" id="7019903">T</span><span class="op" id="7019904">)</span>&nbsp;<span class="op" id="7019906">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7019909">spec</span>&nbsp;<span class="op" id="7019914">:=</span>&nbsp;<span class="ident" id="7019917">nullTestSpec</span><span class="op" id="7019929">{</span><span class="string" id="7019930">&#34;nullfloat64&#34;</span><span class="op" id="7019943">,</span>&nbsp;<span class="string" id="7019945">&#34;float64&#34;</span><span class="op" id="7019954">,</span>&nbsp;<span class="op" id="7019956">[</span><span class="num" id="7019957">6</span><span class="op" id="7019958">]</span><span class="ident" id="7019959">nullTestRow</span><span class="op" id="7019970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7019974">{</span><span class="ident" id="7019975">NullFloat64</span><span class="op" id="7019986">{</span><span class="num" id="7019987">31.2</span><span class="op" id="7019991">,</span>&nbsp;<span class="builtintype" id="7019993">true</span><span class="op" id="7019997">}</span><span class="op" id="7019998">,</span>&nbsp;<span class="num" id="7020000">1</span><span class="op" id="7020001">,</span>&nbsp;<span class="ident" id="7020003">NullFloat64</span><span class="op" id="7020014">{</span><span class="num" id="7020015">31.2</span><span class="op" id="7020019">,</span>&nbsp;<span class="builtintype" id="7020021">true</span><span class="op" id="7020025">}</span><span class="op" id="7020026">}</span><span class="op" id="7020027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020031">{</span><span class="ident" id="7020032">NullFloat64</span><span class="op" id="7020043">{</span><span class="num" id="7020044">13.1</span><span class="op" id="7020048">,</span>&nbsp;<span class="builtintype" id="7020050">false</span><span class="op" id="7020055">}</span><span class="op" id="7020056">,</span>&nbsp;<span class="num" id="7020058">1</span><span class="op" id="7020059">,</span>&nbsp;<span class="ident" id="7020061">NullFloat64</span><span class="op" id="7020072">{</span><span class="num" id="7020073">0</span><span class="op" id="7020074">,</span>&nbsp;<span class="builtintype" id="7020076">false</span><span class="op" id="7020081">}</span><span class="op" id="7020082">}</span><span class="op" id="7020083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020087">{</span><span class="op" id="7020088">-</span><span class="num" id="7020089">22.9</span><span class="op" id="7020093">,</span>&nbsp;<span class="num" id="7020095">1</span><span class="op" id="7020096">,</span>&nbsp;<span class="ident" id="7020098">NullFloat64</span><span class="op" id="7020109">{</span><span class="op" id="7020110">-</span><span class="num" id="7020111">22.9</span><span class="op" id="7020115">,</span>&nbsp;<span class="builtintype" id="7020117">true</span><span class="op" id="7020121">}</span><span class="op" id="7020122">}</span><span class="op" id="7020123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020127">{</span><span class="ident" id="7020128">NullFloat64</span><span class="op" id="7020139">{</span><span class="num" id="7020140">33.81</span><span class="op" id="7020145">,</span>&nbsp;<span class="builtintype" id="7020147">true</span><span class="op" id="7020151">}</span><span class="op" id="7020152">,</span>&nbsp;<span class="num" id="7020154">1</span><span class="op" id="7020155">,</span>&nbsp;<span class="ident" id="7020157">NullFloat64</span><span class="op" id="7020168">{</span><span class="num" id="7020169">33.81</span><span class="op" id="7020174">,</span>&nbsp;<span class="builtintype" id="7020176">true</span><span class="op" id="7020180">}</span><span class="op" id="7020181">}</span><span class="op" id="7020182">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020186">{</span><span class="ident" id="7020187">NullFloat64</span><span class="op" id="7020198">{</span><span class="num" id="7020199">222</span><span class="op" id="7020202">,</span>&nbsp;<span class="builtintype" id="7020204">false</span><span class="op" id="7020209">}</span><span class="op" id="7020210">,</span>&nbsp;<span class="num" id="7020212">1</span><span class="op" id="7020213">,</span>&nbsp;<span class="ident" id="7020215">NullFloat64</span><span class="op" id="7020226">{</span><span class="num" id="7020227">0</span><span class="op" id="7020228">,</span>&nbsp;<span class="builtintype" id="7020230">false</span><span class="op" id="7020235">}</span><span class="op" id="7020236">}</span><span class="op" id="7020237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020241">{</span><span class="num" id="7020242">10</span><span class="op" id="7020244">,</span>&nbsp;<span class="ident" id="7020246">NullFloat64</span><span class="op" id="7020257">{</span><span class="num" id="7020258">31.2</span><span class="op" id="7020262">,</span>&nbsp;<span class="builtintype" id="7020264">false</span><span class="op" id="7020269">}</span><span class="op" id="7020270">,</span>&nbsp;<span class="ident" id="7020272">nil</span><span class="op" id="7020275">}</span><span class="op" id="7020276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020279">}</span><span class="op" id="7020280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020283">nullTestRun</span><span class="op" id="7020294">(</span><span class="ident" id="7020295">t</span><span class="op" id="7020296">,</span>&nbsp;<span class="ident" id="7020298">spec</span><span class="op" id="7020302">)</span><br>
<span class="lineno"></span><span class="op" id="7020304">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7020307">func</span>&nbsp;<span class="ident" id="7020312">TestNullBoolParam</span><span class="op" id="7020329">(</span><span class="ident" id="7020330">t</span>&nbsp;<span class="op" id="7020332">*</span><span class="ident" id="7020333">testing</span><span class="op" id="7020340">.</span><span class="ident" id="7020341">T</span><span class="op" id="7020342">)</span>&nbsp;<span class="op" id="7020344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020347">spec</span>&nbsp;<span class="op" id="7020352">:=</span>&nbsp;<span class="ident" id="7020355">nullTestSpec</span><span class="op" id="7020367">{</span><span class="string" id="7020368">&#34;nullbool&#34;</span><span class="op" id="7020378">,</span>&nbsp;<span class="string" id="7020380">&#34;bool&#34;</span><span class="op" id="7020386">,</span>&nbsp;<span class="op" id="7020388">[</span><span class="num" id="7020389">6</span><span class="op" id="7020390">]</span><span class="ident" id="7020391">nullTestRow</span><span class="op" id="7020402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020406">{</span><span class="ident" id="7020407">NullBool</span><span class="op" id="7020415">{</span><span class="builtintype" id="7020416">false</span><span class="op" id="7020421">,</span>&nbsp;<span class="builtintype" id="7020423">true</span><span class="op" id="7020427">}</span><span class="op" id="7020428">,</span>&nbsp;<span class="builtintype" id="7020430">true</span><span class="op" id="7020434">,</span>&nbsp;<span class="ident" id="7020436">NullBool</span><span class="op" id="7020444">{</span><span class="builtintype" id="7020445">false</span><span class="op" id="7020450">,</span>&nbsp;<span class="builtintype" id="7020452">true</span><span class="op" id="7020456">}</span><span class="op" id="7020457">}</span><span class="op" id="7020458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020462">{</span><span class="ident" id="7020463">NullBool</span><span class="op" id="7020471">{</span><span class="builtintype" id="7020472">true</span><span class="op" id="7020476">,</span>&nbsp;<span class="builtintype" id="7020478">false</span><span class="op" id="7020483">}</span><span class="op" id="7020484">,</span>&nbsp;<span class="builtintype" id="7020486">false</span><span class="op" id="7020491">,</span>&nbsp;<span class="ident" id="7020493">NullBool</span><span class="op" id="7020501">{</span><span class="builtintype" id="7020502">false</span><span class="op" id="7020507">,</span>&nbsp;<span class="builtintype" id="7020509">false</span><span class="op" id="7020514">}</span><span class="op" id="7020515">}</span><span class="op" id="7020516">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020520">{</span><span class="builtintype" id="7020521">true</span><span class="op" id="7020525">,</span>&nbsp;<span class="builtintype" id="7020527">true</span><span class="op" id="7020531">,</span>&nbsp;<span class="ident" id="7020533">NullBool</span><span class="op" id="7020541">{</span><span class="builtintype" id="7020542">true</span><span class="op" id="7020546">,</span>&nbsp;<span class="builtintype" id="7020548">true</span><span class="op" id="7020552">}</span><span class="op" id="7020553">}</span><span class="op" id="7020554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020558">{</span><span class="ident" id="7020559">NullBool</span><span class="op" id="7020567">{</span><span class="builtintype" id="7020568">true</span><span class="op" id="7020572">,</span>&nbsp;<span class="builtintype" id="7020574">true</span><span class="op" id="7020578">}</span><span class="op" id="7020579">,</span>&nbsp;<span class="builtintype" id="7020581">false</span><span class="op" id="7020586">,</span>&nbsp;<span class="ident" id="7020588">NullBool</span><span class="op" id="7020596">{</span><span class="builtintype" id="7020597">true</span><span class="op" id="7020601">,</span>&nbsp;<span class="builtintype" id="7020603">true</span><span class="op" id="7020607">}</span><span class="op" id="7020608">}</span><span class="op" id="7020609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020613">{</span><span class="ident" id="7020614">NullBool</span><span class="op" id="7020622">{</span><span class="builtintype" id="7020623">true</span><span class="op" id="7020627">,</span>&nbsp;<span class="builtintype" id="7020629">false</span><span class="op" id="7020634">}</span><span class="op" id="7020635">,</span>&nbsp;<span class="builtintype" id="7020637">true</span><span class="op" id="7020641">,</span>&nbsp;<span class="ident" id="7020643">NullBool</span><span class="op" id="7020651">{</span><span class="builtintype" id="7020652">false</span><span class="op" id="7020657">,</span>&nbsp;<span class="builtintype" id="7020659">false</span><span class="op" id="7020664">}</span><span class="op" id="7020665">}</span><span class="op" id="7020666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020670">{</span><span class="builtintype" id="7020671">true</span><span class="op" id="7020675">,</span>&nbsp;<span class="ident" id="7020677">NullBool</span><span class="op" id="7020685">{</span><span class="builtintype" id="7020686">true</span><span class="op" id="7020690">,</span>&nbsp;<span class="builtintype" id="7020692">false</span><span class="op" id="7020697">}</span><span class="op" id="7020698">,</span>&nbsp;<span class="ident" id="7020700">nil</span><span class="op" id="7020703">}</span><span class="op" id="7020704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7020707">}</span><span class="op" id="7020708">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020711">nullTestRun</span><span class="op" id="7020722">(</span><span class="ident" id="7020723">t</span><span class="op" id="7020724">,</span>&nbsp;<span class="ident" id="7020726">spec</span><span class="op" id="7020730">)</span><br>
<span class="lineno"></span><span class="op" id="7020732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7020735">func</span>&nbsp;<span class="ident" id="7020740">nullTestRun</span><span class="op" id="7020751">(</span><span class="ident" id="7020752">t</span>&nbsp;<span class="op" id="7020754">*</span><span class="ident" id="7020755">testing</span><span class="op" id="7020762">.</span><span class="ident" id="7020763">T</span><span class="op" id="7020764">,</span>&nbsp;<span class="ident" id="7020766">spec</span>&nbsp;<span class="ident" id="7020771">nullTestSpec</span><span class="op" id="7020783">)</span>&nbsp;<span class="op" id="7020785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020788">db</span>&nbsp;<span class="op" id="7020791">:=</span>&nbsp;<span class="ident" id="7020794">newTestDB</span><span class="op" id="7020803">(</span><span class="ident" id="7020804">t</span><span class="op" id="7020805">,</span>&nbsp;<span class="string" id="7020807">&#34;&#34;</span><span class="op" id="7020809">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7020812">defer</span>&nbsp;<span class="ident" id="7020818">closeDB</span><span class="op" id="7020825">(</span><span class="ident" id="7020826">t</span><span class="op" id="7020827">,</span>&nbsp;<span class="ident" id="7020829">db</span><span class="op" id="7020831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020834">exec</span><span class="op" id="7020838">(</span><span class="ident" id="7020839">t</span><span class="op" id="7020840">,</span>&nbsp;<span class="ident" id="7020842">db</span><span class="op" id="7020844">,</span>&nbsp;<span class="ident" id="7020846">fmt</span><span class="op" id="7020849">.</span><span class="ident" id="7020850">Sprintf</span><span class="op" id="7020857">(</span><span class="string" id="7020858">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7020910">,</span>&nbsp;<span class="ident" id="7020912">spec</span><span class="op" id="7020916">.</span><span class="ident" id="7020917">nullType</span><span class="op" id="7020925">,</span>&nbsp;<span class="ident" id="7020927">spec</span><span class="op" id="7020931">.</span><span class="ident" id="7020932">notNullType</span><span class="op" id="7020943">)</span><span class="op" id="7020944">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7020948">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7020974">exec</span><span class="op" id="7020978">(</span><span class="ident" id="7020979">t</span><span class="op" id="7020980">,</span>&nbsp;<span class="ident" id="7020982">db</span><span class="op" id="7020984">,</span>&nbsp;<span class="string" id="7020986">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7021027">,</span>&nbsp;<span class="num" id="7021029">1</span><span class="op" id="7021030">,</span>&nbsp;<span class="string" id="7021032">&#34;alice&#34;</span><span class="op" id="7021039">,</span>&nbsp;<span class="ident" id="7021041">spec</span><span class="op" id="7021045">.</span><span class="ident" id="7021046">rows</span><span class="op" id="7021050">[</span><span class="num" id="7021051">0</span><span class="op" id="7021052">]</span><span class="op" id="7021053">.</span><span class="ident" id="7021054">nullParam</span><span class="op" id="7021063">,</span>&nbsp;<span class="ident" id="7021065">spec</span><span class="op" id="7021069">.</span><span class="ident" id="7021070">rows</span><span class="op" id="7021074">[</span><span class="num" id="7021075">0</span><span class="op" id="7021076">]</span><span class="op" id="7021077">.</span><span class="ident" id="7021078">notNullParam</span><span class="op" id="7021090">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021093">exec</span><span class="op" id="7021097">(</span><span class="ident" id="7021098">t</span><span class="op" id="7021099">,</span>&nbsp;<span class="ident" id="7021101">db</span><span class="op" id="7021103">,</span>&nbsp;<span class="string" id="7021105">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7021146">,</span>&nbsp;<span class="num" id="7021148">2</span><span class="op" id="7021149">,</span>&nbsp;<span class="string" id="7021151">&#34;bob&#34;</span><span class="op" id="7021156">,</span>&nbsp;<span class="ident" id="7021158">spec</span><span class="op" id="7021162">.</span><span class="ident" id="7021163">rows</span><span class="op" id="7021167">[</span><span class="num" id="7021168">1</span><span class="op" id="7021169">]</span><span class="op" id="7021170">.</span><span class="ident" id="7021171">nullParam</span><span class="op" id="7021180">,</span>&nbsp;<span class="ident" id="7021182">spec</span><span class="op" id="7021186">.</span><span class="ident" id="7021187">rows</span><span class="op" id="7021191">[</span><span class="num" id="7021192">1</span><span class="op" id="7021193">]</span><span class="op" id="7021194">.</span><span class="ident" id="7021195">notNullParam</span><span class="op" id="7021207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7021211">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021250">stmt</span><span class="op" id="7021254">,</span>&nbsp;<span class="ident" id="7021256">err</span>&nbsp;<span class="op" id="7021260">:=</span>&nbsp;<span class="ident" id="7021263">db</span><span class="op" id="7021265">.</span><span class="ident" id="7021266">Prepare</span><span class="op" id="7021273">(</span><span class="string" id="7021274">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7021315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021318">if</span>&nbsp;<span class="ident" id="7021321">err</span>&nbsp;<span class="op" id="7021325">!=</span>&nbsp;<span class="ident" id="7021328">nil</span>&nbsp;<span class="op" id="7021332">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021336">t</span><span class="op" id="7021337">.</span><span class="ident" id="7021338">Fatalf</span><span class="op" id="7021344">(</span><span class="string" id="7021345">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7021358">,</span>&nbsp;<span class="ident" id="7021360">err</span><span class="op" id="7021363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7021366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021369">defer</span>&nbsp;<span class="ident" id="7021375">stmt</span><span class="op" id="7021379">.</span><span class="ident" id="7021380">Close</span><span class="op" id="7021385">(</span><span class="op" id="7021386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021389">if</span>&nbsp;<span class="ident" id="7021392">_</span><span class="op" id="7021393">,</span>&nbsp;<span class="ident" id="7021395">err</span>&nbsp;<span class="op" id="7021399">:=</span>&nbsp;<span class="ident" id="7021402">stmt</span><span class="op" id="7021406">.</span><span class="ident" id="7021407">Exec</span><span class="op" id="7021411">(</span><span class="num" id="7021412">3</span><span class="op" id="7021413">,</span>&nbsp;<span class="string" id="7021415">&#34;chris&#34;</span><span class="op" id="7021422">,</span>&nbsp;<span class="ident" id="7021424">spec</span><span class="op" id="7021428">.</span><span class="ident" id="7021429">rows</span><span class="op" id="7021433">[</span><span class="num" id="7021434">2</span><span class="op" id="7021435">]</span><span class="op" id="7021436">.</span><span class="ident" id="7021437">nullParam</span><span class="op" id="7021446">,</span>&nbsp;<span class="ident" id="7021448">spec</span><span class="op" id="7021452">.</span><span class="ident" id="7021453">rows</span><span class="op" id="7021457">[</span><span class="num" id="7021458">2</span><span class="op" id="7021459">]</span><span class="op" id="7021460">.</span><span class="ident" id="7021461">notNullParam</span><span class="op" id="7021473">)</span><span class="op" id="7021474">;</span>&nbsp;<span class="ident" id="7021476">err</span>&nbsp;<span class="op" id="7021480">!=</span>&nbsp;<span class="ident" id="7021483">nil</span>&nbsp;<span class="op" id="7021487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021491">t</span><span class="op" id="7021492">.</span><span class="ident" id="7021493">Errorf</span><span class="op" id="7021499">(</span><span class="string" id="7021500">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7021523">,</span>&nbsp;<span class="ident" id="7021525">err</span><span class="op" id="7021528">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7021531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021534">if</span>&nbsp;<span class="ident" id="7021537">_</span><span class="op" id="7021538">,</span>&nbsp;<span class="ident" id="7021540">err</span>&nbsp;<span class="op" id="7021544">:=</span>&nbsp;<span class="ident" id="7021547">stmt</span><span class="op" id="7021551">.</span><span class="ident" id="7021552">Exec</span><span class="op" id="7021556">(</span><span class="num" id="7021557">4</span><span class="op" id="7021558">,</span>&nbsp;<span class="string" id="7021560">&#34;dave&#34;</span><span class="op" id="7021566">,</span>&nbsp;<span class="ident" id="7021568">spec</span><span class="op" id="7021572">.</span><span class="ident" id="7021573">rows</span><span class="op" id="7021577">[</span><span class="num" id="7021578">3</span><span class="op" id="7021579">]</span><span class="op" id="7021580">.</span><span class="ident" id="7021581">nullParam</span><span class="op" id="7021590">,</span>&nbsp;<span class="ident" id="7021592">spec</span><span class="op" id="7021596">.</span><span class="ident" id="7021597">rows</span><span class="op" id="7021601">[</span><span class="num" id="7021602">3</span><span class="op" id="7021603">]</span><span class="op" id="7021604">.</span><span class="ident" id="7021605">notNullParam</span><span class="op" id="7021617">)</span><span class="op" id="7021618">;</span>&nbsp;<span class="ident" id="7021620">err</span>&nbsp;<span class="op" id="7021624">!=</span>&nbsp;<span class="ident" id="7021627">nil</span>&nbsp;<span class="op" id="7021631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021635">t</span><span class="op" id="7021636">.</span><span class="ident" id="7021637">Errorf</span><span class="op" id="7021643">(</span><span class="string" id="7021644">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7021666">,</span>&nbsp;<span class="ident" id="7021668">err</span><span class="op" id="7021671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7021674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021677">if</span>&nbsp;<span class="ident" id="7021680">_</span><span class="op" id="7021681">,</span>&nbsp;<span class="ident" id="7021683">err</span>&nbsp;<span class="op" id="7021687">:=</span>&nbsp;<span class="ident" id="7021690">stmt</span><span class="op" id="7021694">.</span><span class="ident" id="7021695">Exec</span><span class="op" id="7021699">(</span><span class="num" id="7021700">5</span><span class="op" id="7021701">,</span>&nbsp;<span class="string" id="7021703">&#34;eleanor&#34;</span><span class="op" id="7021712">,</span>&nbsp;<span class="ident" id="7021714">spec</span><span class="op" id="7021718">.</span><span class="ident" id="7021719">rows</span><span class="op" id="7021723">[</span><span class="num" id="7021724">4</span><span class="op" id="7021725">]</span><span class="op" id="7021726">.</span><span class="ident" id="7021727">nullParam</span><span class="op" id="7021736">,</span>&nbsp;<span class="ident" id="7021738">spec</span><span class="op" id="7021742">.</span><span class="ident" id="7021743">rows</span><span class="op" id="7021747">[</span><span class="num" id="7021748">4</span><span class="op" id="7021749">]</span><span class="op" id="7021750">.</span><span class="ident" id="7021751">notNullParam</span><span class="op" id="7021763">)</span><span class="op" id="7021764">;</span>&nbsp;<span class="ident" id="7021766">err</span>&nbsp;<span class="op" id="7021770">!=</span>&nbsp;<span class="ident" id="7021773">nil</span>&nbsp;<span class="op" id="7021777">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021781">t</span><span class="op" id="7021782">.</span><span class="ident" id="7021783">Errorf</span><span class="op" id="7021789">(</span><span class="string" id="7021790">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7021815">,</span>&nbsp;<span class="ident" id="7021817">err</span><span class="op" id="7021820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7021823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7021827">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7021868">if</span>&nbsp;<span class="ident" id="7021871">_</span><span class="op" id="7021872">,</span>&nbsp;<span class="ident" id="7021874">err</span>&nbsp;<span class="op" id="7021878">:=</span>&nbsp;<span class="ident" id="7021881">stmt</span><span class="op" id="7021885">.</span><span class="ident" id="7021886">Exec</span><span class="op" id="7021890">(</span><span class="num" id="7021891">6</span><span class="op" id="7021892">,</span>&nbsp;<span class="string" id="7021894">&#34;bob&#34;</span><span class="op" id="7021899">,</span>&nbsp;<span class="ident" id="7021901">spec</span><span class="op" id="7021905">.</span><span class="ident" id="7021906">rows</span><span class="op" id="7021910">[</span><span class="num" id="7021911">5</span><span class="op" id="7021912">]</span><span class="op" id="7021913">.</span><span class="ident" id="7021914">nullParam</span><span class="op" id="7021923">,</span>&nbsp;<span class="ident" id="7021925">spec</span><span class="op" id="7021929">.</span><span class="ident" id="7021930">rows</span><span class="op" id="7021934">[</span><span class="num" id="7021935">5</span><span class="op" id="7021936">]</span><span class="op" id="7021937">.</span><span class="ident" id="7021938">notNullParam</span><span class="op" id="7021950">)</span><span class="op" id="7021951">;</span>&nbsp;<span class="ident" id="7021953">err</span>&nbsp;<span class="op" id="7021957">==</span>&nbsp;<span class="ident" id="7021960">nil</span>&nbsp;<span class="op" id="7021964">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7021968">t</span><span class="op" id="7021969">.</span><span class="ident" id="7021970">Errorf</span><span class="op" id="7021976">(</span><span class="string" id="7021977">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7022040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7022043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022047">_</span><span class="op" id="7022048">,</span>&nbsp;<span class="ident" id="7022050">err</span>&nbsp;<span class="op" id="7022054">=</span>&nbsp;<span class="ident" id="7022056">db</span><span class="op" id="7022058">.</span><span class="ident" id="7022059">Exec</span><span class="op" id="7022063">(</span><span class="string" id="7022064">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7022094">,</span>&nbsp;<span class="num" id="7022096">999</span><span class="op" id="7022099">,</span>&nbsp;<span class="ident" id="7022101">nil</span><span class="op" id="7022104">,</span>&nbsp;<span class="ident" id="7022106">nil</span><span class="op" id="7022109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7022112">if</span>&nbsp;<span class="ident" id="7022115">err</span>&nbsp;<span class="op" id="7022119">==</span>&nbsp;<span class="ident" id="7022122">nil</span>&nbsp;<span class="op" id="7022126">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022130">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022180">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022236">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022288">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022336">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7022380">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7022440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022444">paramtype</span>&nbsp;<span class="op" id="7022454">:=</span>&nbsp;<span class="ident" id="7022457">reflect</span><span class="op" id="7022464">.</span><span class="ident" id="7022465">TypeOf</span><span class="op" id="7022471">(</span><span class="ident" id="7022472">spec</span><span class="op" id="7022476">.</span><span class="ident" id="7022477">rows</span><span class="op" id="7022481">[</span><span class="num" id="7022482">0</span><span class="op" id="7022483">]</span><span class="op" id="7022484">.</span><span class="ident" id="7022485">nullParam</span><span class="op" id="7022494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022497">bindVal</span>&nbsp;<span class="op" id="7022505">:=</span>&nbsp;<span class="ident" id="7022508">reflect</span><span class="op" id="7022515">.</span><span class="ident" id="7022516">New</span><span class="op" id="7022519">(</span><span class="ident" id="7022520">paramtype</span><span class="op" id="7022529">)</span><span class="op" id="7022530">.</span><span class="ident" id="7022531">Interface</span><span class="op" id="7022540">(</span><span class="op" id="7022541">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7022545">for</span>&nbsp;<span class="ident" id="7022549">i</span>&nbsp;<span class="op" id="7022551">:=</span>&nbsp;<span class="num" id="7022554">0</span><span class="op" id="7022555">;</span>&nbsp;<span class="ident" id="7022557">i</span>&nbsp;<span class="op" id="7022559">&lt;</span>&nbsp;<span class="num" id="7022561">5</span><span class="op" id="7022562">;</span>&nbsp;<span class="ident" id="7022564">i</span><span class="op" id="7022565">++</span>&nbsp;<span class="op" id="7022568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022572">id</span>&nbsp;<span class="op" id="7022575">:=</span>&nbsp;<span class="ident" id="7022578">i</span>&nbsp;<span class="op" id="7022580">+</span>&nbsp;<span class="num" id="7022582">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7022586">if</span>&nbsp;<span class="ident" id="7022589">err</span>&nbsp;<span class="op" id="7022593">:=</span>&nbsp;<span class="ident" id="7022596">db</span><span class="op" id="7022598">.</span><span class="ident" id="7022599">QueryRow</span><span class="op" id="7022607">(</span><span class="string" id="7022608">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7022629">,</span>&nbsp;<span class="ident" id="7022631">id</span><span class="op" id="7022633">)</span><span class="op" id="7022634">.</span><span class="ident" id="7022635">Scan</span><span class="op" id="7022639">(</span><span class="ident" id="7022640">bindVal</span><span class="op" id="7022647">)</span><span class="op" id="7022648">;</span>&nbsp;<span class="ident" id="7022650">err</span>&nbsp;<span class="op" id="7022654">!=</span>&nbsp;<span class="ident" id="7022657">nil</span>&nbsp;<span class="op" id="7022661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022666">t</span><span class="op" id="7022667">.</span><span class="ident" id="7022668">Errorf</span><span class="op" id="7022674">(</span><span class="string" id="7022675">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7022691">,</span>&nbsp;<span class="ident" id="7022693">id</span><span class="op" id="7022695">,</span>&nbsp;<span class="ident" id="7022697">err</span><span class="op" id="7022700">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7022704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022708">bindValDeref</span>&nbsp;<span class="op" id="7022721">:=</span>&nbsp;<span class="ident" id="7022724">reflect</span><span class="op" id="7022731">.</span><span class="ident" id="7022732">ValueOf</span><span class="op" id="7022739">(</span><span class="ident" id="7022740">bindVal</span><span class="op" id="7022747">)</span><span class="op" id="7022748">.</span><span class="ident" id="7022749">Elem</span><span class="op" id="7022753">(</span><span class="op" id="7022754">)</span><span class="op" id="7022755">.</span><span class="ident" id="7022756">Interface</span><span class="op" id="7022765">(</span><span class="op" id="7022766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7022770">if</span>&nbsp;<span class="op" id="7022773">!</span><span class="ident" id="7022774">reflect</span><span class="op" id="7022781">.</span><span class="ident" id="7022782">DeepEqual</span><span class="op" id="7022791">(</span><span class="ident" id="7022792">bindValDeref</span><span class="op" id="7022804">,</span>&nbsp;<span class="ident" id="7022806">spec</span><span class="op" id="7022810">.</span><span class="ident" id="7022811">rows</span><span class="op" id="7022815">[</span><span class="ident" id="7022816">i</span><span class="op" id="7022817">]</span><span class="op" id="7022818">.</span><span class="ident" id="7022819">scanNullVal</span><span class="op" id="7022830">)</span>&nbsp;<span class="op" id="7022832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022837">t</span><span class="op" id="7022838">.</span><span class="ident" id="7022839">Errorf</span><span class="op" id="7022845">(</span><span class="string" id="7022846">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7022871">,</span>&nbsp;<span class="ident" id="7022873">id</span><span class="op" id="7022875">,</span>&nbsp;<span class="ident" id="7022877">bindValDeref</span><span class="op" id="7022889">,</span>&nbsp;<span class="ident" id="7022891">spec</span><span class="op" id="7022895">.</span><span class="ident" id="7022896">rows</span><span class="op" id="7022900">[</span><span class="ident" id="7022901">i</span><span class="op" id="7022902">]</span><span class="op" id="7022903">.</span><span class="ident" id="7022904">scanNullVal</span><span class="op" id="7022915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7022919">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7022922">}</span><br>
<span class="lineno"></span><span class="op" id="7022924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7022927">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7022952">func</span>&nbsp;<span class="ident" id="7022957">TestQueryRowNilScanDest</span><span class="op" id="7022980">(</span><span class="ident" id="7022981">t</span>&nbsp;<span class="op" id="7022983">*</span><span class="ident" id="7022984">testing</span><span class="op" id="7022991">.</span><span class="ident" id="7022992">T</span><span class="op" id="7022993">)</span>&nbsp;<span class="op" id="7022995">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7022998">db</span>&nbsp;<span class="op" id="7023001">:=</span>&nbsp;<span class="ident" id="7023004">newTestDB</span><span class="op" id="7023013">(</span><span class="ident" id="7023014">t</span><span class="op" id="7023015">,</span>&nbsp;<span class="string" id="7023017">&#34;people&#34;</span><span class="op" id="7023025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023028">defer</span>&nbsp;<span class="ident" id="7023034">closeDB</span><span class="op" id="7023041">(</span><span class="ident" id="7023042">t</span><span class="op" id="7023043">,</span>&nbsp;<span class="ident" id="7023045">db</span><span class="op" id="7023047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023050">var</span>&nbsp;<span class="ident" id="7023054">name</span>&nbsp;<span class="op" id="7023059">*</span><span class="builtintype" id="7023060">string</span>&nbsp;<span class="comment" id="7023067">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023083">err</span>&nbsp;<span class="op" id="7023087">:=</span>&nbsp;<span class="ident" id="7023090">db</span><span class="op" id="7023092">.</span><span class="ident" id="7023093">QueryRow</span><span class="op" id="7023101">(</span><span class="string" id="7023102">&#34;SELECT|people|name|&#34;</span><span class="op" id="7023123">)</span><span class="op" id="7023124">.</span><span class="ident" id="7023125">Scan</span><span class="op" id="7023129">(</span><span class="ident" id="7023130">name</span><span class="op" id="7023134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023137">want</span>&nbsp;<span class="op" id="7023142">:=</span>&nbsp;<span class="string" id="7023145">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023210">if</span>&nbsp;<span class="ident" id="7023213">err</span>&nbsp;<span class="op" id="7023217">==</span>&nbsp;<span class="ident" id="7023220">nil</span>&nbsp;<span class="op" id="7023224">||</span>&nbsp;<span class="ident" id="7023227">err</span><span class="op" id="7023230">.</span><span class="ident" id="7023231">Error</span><span class="op" id="7023236">(</span><span class="op" id="7023237">)</span>&nbsp;<span class="op" id="7023239">!=</span>&nbsp;<span class="ident" id="7023242">want</span>&nbsp;<span class="op" id="7023247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023251">t</span><span class="op" id="7023252">.</span><span class="ident" id="7023253">Errorf</span><span class="op" id="7023259">(</span><span class="string" id="7023260">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7023281">,</span>&nbsp;<span class="ident" id="7023283">err</span><span class="op" id="7023286">.</span><span class="ident" id="7023287">Error</span><span class="op" id="7023292">(</span><span class="op" id="7023293">)</span><span class="op" id="7023294">,</span>&nbsp;<span class="ident" id="7023296">want</span><span class="op" id="7023300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7023303">}</span><br>
<span class="lineno"></span><span class="op" id="7023305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7023308">func</span>&nbsp;<span class="ident" id="7023313">TestIssue4902</span><span class="op" id="7023326">(</span><span class="ident" id="7023327">t</span>&nbsp;<span class="op" id="7023329">*</span><span class="ident" id="7023330">testing</span><span class="op" id="7023337">.</span><span class="ident" id="7023338">T</span><span class="op" id="7023339">)</span>&nbsp;<span class="op" id="7023341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023344">db</span>&nbsp;<span class="op" id="7023347">:=</span>&nbsp;<span class="ident" id="7023350">newTestDB</span><span class="op" id="7023359">(</span><span class="ident" id="7023360">t</span><span class="op" id="7023361">,</span>&nbsp;<span class="string" id="7023363">&#34;people&#34;</span><span class="op" id="7023371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023374">defer</span>&nbsp;<span class="ident" id="7023380">closeDB</span><span class="op" id="7023387">(</span><span class="ident" id="7023388">t</span><span class="op" id="7023389">,</span>&nbsp;<span class="ident" id="7023391">db</span><span class="op" id="7023393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023397">driver</span>&nbsp;<span class="op" id="7023404">:=</span>&nbsp;<span class="ident" id="7023407">db</span><span class="op" id="7023409">.</span><span class="ident" id="7023410">driver</span><span class="op" id="7023416">.</span><span class="op" id="7023417">(</span><span class="op" id="7023418">*</span><span class="ident" id="7023419">fakeDriver</span><span class="op" id="7023429">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023432">opens0</span>&nbsp;<span class="op" id="7023439">:=</span>&nbsp;<span class="ident" id="7023442">driver</span><span class="op" id="7023448">.</span><span class="ident" id="7023449">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023461">var</span>&nbsp;<span class="ident" id="7023465">stmt</span>&nbsp;<span class="op" id="7023470">*</span><span class="ident" id="7023471">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023477">var</span>&nbsp;<span class="ident" id="7023481">err</span>&nbsp;<span class="builtintype" id="7023485">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023492">for</span>&nbsp;<span class="ident" id="7023496">i</span>&nbsp;<span class="op" id="7023498">:=</span>&nbsp;<span class="num" id="7023501">0</span><span class="op" id="7023502">;</span>&nbsp;<span class="ident" id="7023504">i</span>&nbsp;<span class="op" id="7023506">&lt;</span>&nbsp;<span class="num" id="7023508">10</span><span class="op" id="7023510">;</span>&nbsp;<span class="ident" id="7023512">i</span><span class="op" id="7023513">++</span>&nbsp;<span class="op" id="7023516">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023520">stmt</span><span class="op" id="7023524">,</span>&nbsp;<span class="ident" id="7023526">err</span>&nbsp;<span class="op" id="7023530">=</span>&nbsp;<span class="ident" id="7023532">db</span><span class="op" id="7023534">.</span><span class="ident" id="7023535">Prepare</span><span class="op" id="7023542">(</span><span class="string" id="7023543">&#34;SELECT|people|name|&#34;</span><span class="op" id="7023564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023568">if</span>&nbsp;<span class="ident" id="7023571">err</span>&nbsp;<span class="op" id="7023575">!=</span>&nbsp;<span class="ident" id="7023578">nil</span>&nbsp;<span class="op" id="7023582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023587">t</span><span class="op" id="7023588">.</span><span class="ident" id="7023589">Fatal</span><span class="op" id="7023594">(</span><span class="ident" id="7023595">err</span><span class="op" id="7023598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7023602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023606">err</span>&nbsp;<span class="op" id="7023610">=</span>&nbsp;<span class="ident" id="7023612">stmt</span><span class="op" id="7023616">.</span><span class="ident" id="7023617">Close</span><span class="op" id="7023622">(</span><span class="op" id="7023623">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023627">if</span>&nbsp;<span class="ident" id="7023630">err</span>&nbsp;<span class="op" id="7023634">!=</span>&nbsp;<span class="ident" id="7023637">nil</span>&nbsp;<span class="op" id="7023641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023646">t</span><span class="op" id="7023647">.</span><span class="ident" id="7023648">Fatal</span><span class="op" id="7023653">(</span><span class="ident" id="7023654">err</span><span class="op" id="7023657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7023661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7023664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023668">opens</span>&nbsp;<span class="op" id="7023674">:=</span>&nbsp;<span class="ident" id="7023677">driver</span><span class="op" id="7023683">.</span><span class="ident" id="7023684">openCount</span>&nbsp;<span class="op" id="7023694">-</span>&nbsp;<span class="ident" id="7023696">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023704">if</span>&nbsp;<span class="ident" id="7023707">opens</span>&nbsp;<span class="op" id="7023713">&gt;</span>&nbsp;<span class="num" id="7023715">1</span>&nbsp;<span class="op" id="7023717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023721">t</span><span class="op" id="7023722">.</span><span class="ident" id="7023723">Errorf</span><span class="op" id="7023729">(</span><span class="string" id="7023730">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7023753">,</span>&nbsp;<span class="ident" id="7023755">opens</span><span class="op" id="7023760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023764">t</span><span class="op" id="7023765">.</span><span class="ident" id="7023766">Logf</span><span class="op" id="7023770">(</span><span class="string" id="7023771">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7023781">,</span>&nbsp;<span class="ident" id="7023783">db</span><span class="op" id="7023785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023789">t</span><span class="op" id="7023790">.</span><span class="ident" id="7023791">Logf</span><span class="op" id="7023795">(</span><span class="string" id="7023796">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7023810">,</span>&nbsp;<span class="ident" id="7023812">driver</span><span class="op" id="7023818">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023822">t</span><span class="op" id="7023823">.</span><span class="ident" id="7023824">Logf</span><span class="op" id="7023828">(</span><span class="string" id="7023829">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7023841">,</span>&nbsp;<span class="ident" id="7023843">stmt</span><span class="op" id="7023847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7023850">}</span><br>
<span class="lineno"></span><span class="op" id="7023852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7023855">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7023869">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7023895">func</span>&nbsp;<span class="ident" id="7023900">TestSimultaneousQueries</span><span class="op" id="7023923">(</span><span class="ident" id="7023924">t</span>&nbsp;<span class="op" id="7023926">*</span><span class="ident" id="7023927">testing</span><span class="op" id="7023934">.</span><span class="ident" id="7023935">T</span><span class="op" id="7023936">)</span>&nbsp;<span class="op" id="7023938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023941">db</span>&nbsp;<span class="op" id="7023944">:=</span>&nbsp;<span class="ident" id="7023947">newTestDB</span><span class="op" id="7023956">(</span><span class="ident" id="7023957">t</span><span class="op" id="7023958">,</span>&nbsp;<span class="string" id="7023960">&#34;people&#34;</span><span class="op" id="7023968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7023971">defer</span>&nbsp;<span class="ident" id="7023977">closeDB</span><span class="op" id="7023984">(</span><span class="ident" id="7023985">t</span><span class="op" id="7023986">,</span>&nbsp;<span class="ident" id="7023988">db</span><span class="op" id="7023990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7023994">tx</span><span class="op" id="7023996">,</span>&nbsp;<span class="ident" id="7023998">err</span>&nbsp;<span class="op" id="7024002">:=</span>&nbsp;<span class="ident" id="7024005">db</span><span class="op" id="7024007">.</span><span class="ident" id="7024008">Begin</span><span class="op" id="7024013">(</span><span class="op" id="7024014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024017">if</span>&nbsp;<span class="ident" id="7024020">err</span>&nbsp;<span class="op" id="7024024">!=</span>&nbsp;<span class="ident" id="7024027">nil</span>&nbsp;<span class="op" id="7024031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024035">t</span><span class="op" id="7024036">.</span><span class="ident" id="7024037">Fatal</span><span class="op" id="7024042">(</span><span class="ident" id="7024043">err</span><span class="op" id="7024046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024052">defer</span>&nbsp;<span class="ident" id="7024058">tx</span><span class="op" id="7024060">.</span><span class="ident" id="7024061">Rollback</span><span class="op" id="7024069">(</span><span class="op" id="7024070">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024074">r1</span><span class="op" id="7024076">,</span>&nbsp;<span class="ident" id="7024078">err</span>&nbsp;<span class="op" id="7024082">:=</span>&nbsp;<span class="ident" id="7024085">tx</span><span class="op" id="7024087">.</span><span class="ident" id="7024088">Query</span><span class="op" id="7024093">(</span><span class="string" id="7024094">&#34;SELECT|people|name|&#34;</span><span class="op" id="7024115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024118">if</span>&nbsp;<span class="ident" id="7024121">err</span>&nbsp;<span class="op" id="7024125">!=</span>&nbsp;<span class="ident" id="7024128">nil</span>&nbsp;<span class="op" id="7024132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024136">t</span><span class="op" id="7024137">.</span><span class="ident" id="7024138">Fatal</span><span class="op" id="7024143">(</span><span class="ident" id="7024144">err</span><span class="op" id="7024147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024150">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024153">defer</span>&nbsp;<span class="ident" id="7024159">r1</span><span class="op" id="7024161">.</span><span class="ident" id="7024162">Close</span><span class="op" id="7024167">(</span><span class="op" id="7024168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024172">r2</span><span class="op" id="7024174">,</span>&nbsp;<span class="ident" id="7024176">err</span>&nbsp;<span class="op" id="7024180">:=</span>&nbsp;<span class="ident" id="7024183">tx</span><span class="op" id="7024185">.</span><span class="ident" id="7024186">Query</span><span class="op" id="7024191">(</span><span class="string" id="7024192">&#34;SELECT|people|name|&#34;</span><span class="op" id="7024213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024216">if</span>&nbsp;<span class="ident" id="7024219">err</span>&nbsp;<span class="op" id="7024223">!=</span>&nbsp;<span class="ident" id="7024226">nil</span>&nbsp;<span class="op" id="7024230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024234">t</span><span class="op" id="7024235">.</span><span class="ident" id="7024236">Fatal</span><span class="op" id="7024241">(</span><span class="ident" id="7024242">err</span><span class="op" id="7024245">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024251">defer</span>&nbsp;<span class="ident" id="7024257">r2</span><span class="op" id="7024259">.</span><span class="ident" id="7024260">Close</span><span class="op" id="7024265">(</span><span class="op" id="7024266">)</span><br>
<span class="lineno"></span><span class="op" id="7024268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7024271">func</span>&nbsp;<span class="ident" id="7024276">TestMaxIdleConns</span><span class="op" id="7024292">(</span><span class="ident" id="7024293">t</span>&nbsp;<span class="op" id="7024295">*</span><span class="ident" id="7024296">testing</span><span class="op" id="7024303">.</span><span class="ident" id="7024304">T</span><span class="op" id="7024305">)</span>&nbsp;<span class="op" id="7024307">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024310">db</span>&nbsp;<span class="op" id="7024313">:=</span>&nbsp;<span class="ident" id="7024316">newTestDB</span><span class="op" id="7024325">(</span><span class="ident" id="7024326">t</span><span class="op" id="7024327">,</span>&nbsp;<span class="string" id="7024329">&#34;people&#34;</span><span class="op" id="7024337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024340">defer</span>&nbsp;<span class="ident" id="7024346">closeDB</span><span class="op" id="7024353">(</span><span class="ident" id="7024354">t</span><span class="op" id="7024355">,</span>&nbsp;<span class="ident" id="7024357">db</span><span class="op" id="7024359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024363">tx</span><span class="op" id="7024365">,</span>&nbsp;<span class="ident" id="7024367">err</span>&nbsp;<span class="op" id="7024371">:=</span>&nbsp;<span class="ident" id="7024374">db</span><span class="op" id="7024376">.</span><span class="ident" id="7024377">Begin</span><span class="op" id="7024382">(</span><span class="op" id="7024383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024386">if</span>&nbsp;<span class="ident" id="7024389">err</span>&nbsp;<span class="op" id="7024393">!=</span>&nbsp;<span class="ident" id="7024396">nil</span>&nbsp;<span class="op" id="7024400">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024404">t</span><span class="op" id="7024405">.</span><span class="ident" id="7024406">Fatal</span><span class="op" id="7024411">(</span><span class="ident" id="7024412">err</span><span class="op" id="7024415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024421">tx</span><span class="op" id="7024423">.</span><span class="ident" id="7024424">Commit</span><span class="op" id="7024430">(</span><span class="op" id="7024431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024434">if</span>&nbsp;<span class="ident" id="7024437">got</span>&nbsp;<span class="op" id="7024441">:=</span>&nbsp;<span class="builtinfunc" id="7024444">len</span><span class="op" id="7024447">(</span><span class="ident" id="7024448">db</span><span class="op" id="7024450">.</span><span class="ident" id="7024451">freeConn</span><span class="op" id="7024459">)</span><span class="op" id="7024460">;</span>&nbsp;<span class="ident" id="7024462">got</span>&nbsp;<span class="op" id="7024466">!=</span>&nbsp;<span class="num" id="7024469">1</span>&nbsp;<span class="op" id="7024471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024475">t</span><span class="op" id="7024476">.</span><span class="ident" id="7024477">Errorf</span><span class="op" id="7024483">(</span><span class="string" id="7024484">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7024508">,</span>&nbsp;<span class="ident" id="7024510">got</span><span class="op" id="7024513">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024520">db</span><span class="op" id="7024522">.</span><span class="ident" id="7024523">SetMaxIdleConns</span><span class="op" id="7024538">(</span><span class="num" id="7024539">0</span><span class="op" id="7024540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024544">if</span>&nbsp;<span class="ident" id="7024547">got</span>&nbsp;<span class="op" id="7024551">:=</span>&nbsp;<span class="builtinfunc" id="7024554">len</span><span class="op" id="7024557">(</span><span class="ident" id="7024558">db</span><span class="op" id="7024560">.</span><span class="ident" id="7024561">freeConn</span><span class="op" id="7024569">)</span><span class="op" id="7024570">;</span>&nbsp;<span class="ident" id="7024572">got</span>&nbsp;<span class="op" id="7024576">!=</span>&nbsp;<span class="num" id="7024579">0</span>&nbsp;<span class="op" id="7024581">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024585">t</span><span class="op" id="7024586">.</span><span class="ident" id="7024587">Errorf</span><span class="op" id="7024593">(</span><span class="string" id="7024594">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7024636">,</span>&nbsp;<span class="ident" id="7024638">got</span><span class="op" id="7024641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024648">tx</span><span class="op" id="7024650">,</span>&nbsp;<span class="ident" id="7024652">err</span>&nbsp;<span class="op" id="7024656">=</span>&nbsp;<span class="ident" id="7024658">db</span><span class="op" id="7024660">.</span><span class="ident" id="7024661">Begin</span><span class="op" id="7024666">(</span><span class="op" id="7024667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024670">if</span>&nbsp;<span class="ident" id="7024673">err</span>&nbsp;<span class="op" id="7024677">!=</span>&nbsp;<span class="ident" id="7024680">nil</span>&nbsp;<span class="op" id="7024684">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024688">t</span><span class="op" id="7024689">.</span><span class="ident" id="7024690">Fatal</span><span class="op" id="7024695">(</span><span class="ident" id="7024696">err</span><span class="op" id="7024699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024705">tx</span><span class="op" id="7024707">.</span><span class="ident" id="7024708">Commit</span><span class="op" id="7024714">(</span><span class="op" id="7024715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024718">if</span>&nbsp;<span class="ident" id="7024721">got</span>&nbsp;<span class="op" id="7024725">:=</span>&nbsp;<span class="builtinfunc" id="7024728">len</span><span class="op" id="7024731">(</span><span class="ident" id="7024732">db</span><span class="op" id="7024734">.</span><span class="ident" id="7024735">freeConn</span><span class="op" id="7024743">)</span><span class="op" id="7024744">;</span>&nbsp;<span class="ident" id="7024746">got</span>&nbsp;<span class="op" id="7024750">!=</span>&nbsp;<span class="num" id="7024753">0</span>&nbsp;<span class="op" id="7024755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024759">t</span><span class="op" id="7024760">.</span><span class="ident" id="7024761">Errorf</span><span class="op" id="7024767">(</span><span class="string" id="7024768">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7024792">,</span>&nbsp;<span class="ident" id="7024794">got</span><span class="op" id="7024797">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024800">}</span><br>
<span class="lineno"></span><span class="op" id="7024802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7024805">func</span>&nbsp;<span class="ident" id="7024810">TestMaxOpenConns</span><span class="op" id="7024826">(</span><span class="ident" id="7024827">t</span>&nbsp;<span class="op" id="7024829">*</span><span class="ident" id="7024830">testing</span><span class="op" id="7024837">.</span><span class="ident" id="7024838">T</span><span class="op" id="7024839">)</span>&nbsp;<span class="op" id="7024841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024844">if</span>&nbsp;<span class="ident" id="7024847">testing</span><span class="op" id="7024854">.</span><span class="ident" id="7024855">Short</span><span class="op" id="7024860">(</span><span class="op" id="7024861">)</span>&nbsp;<span class="op" id="7024863">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024867">t</span><span class="op" id="7024868">.</span><span class="ident" id="7024869">Skip</span><span class="op" id="7024873">(</span><span class="string" id="7024874">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7024898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7024901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024904">defer</span>&nbsp;<span class="ident" id="7024910">setHookpostCloseConn</span><span class="op" id="7024930">(</span><span class="ident" id="7024931">nil</span><span class="op" id="7024934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7024937">setHookpostCloseConn</span><span class="op" id="7024957">(</span><span class="keyword" id="7024958">func</span><span class="op" id="7024962">(</span><span class="ident" id="7024963">_</span>&nbsp;<span class="op" id="7024965">*</span><span class="ident" id="7024966">fakeConn</span><span class="op" id="7024974">,</span>&nbsp;<span class="ident" id="7024976">err</span>&nbsp;<span class="builtintype" id="7024980">error</span><span class="op" id="7024985">)</span>&nbsp;<span class="op" id="7024987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7024991">if</span>&nbsp;<span class="ident" id="7024994">err</span>&nbsp;<span class="op" id="7024998">!=</span>&nbsp;<span class="ident" id="7025001">nil</span>&nbsp;<span class="op" id="7025005">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025010">t</span><span class="op" id="7025011">.</span><span class="ident" id="7025012">Errorf</span><span class="op" id="7025018">(</span><span class="string" id="7025019">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7025047">,</span>&nbsp;<span class="ident" id="7025049">err</span><span class="op" id="7025052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025059">}</span><span class="op" id="7025060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025064">db</span>&nbsp;<span class="op" id="7025067">:=</span>&nbsp;<span class="ident" id="7025070">newTestDB</span><span class="op" id="7025079">(</span><span class="ident" id="7025080">t</span><span class="op" id="7025081">,</span>&nbsp;<span class="string" id="7025083">&#34;magicquery&#34;</span><span class="op" id="7025095">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025098">defer</span>&nbsp;<span class="ident" id="7025104">closeDB</span><span class="op" id="7025111">(</span><span class="ident" id="7025112">t</span><span class="op" id="7025113">,</span>&nbsp;<span class="ident" id="7025115">db</span><span class="op" id="7025117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025121">driver</span>&nbsp;<span class="op" id="7025128">:=</span>&nbsp;<span class="ident" id="7025131">db</span><span class="op" id="7025133">.</span><span class="ident" id="7025134">driver</span><span class="op" id="7025140">.</span><span class="op" id="7025141">(</span><span class="op" id="7025142">*</span><span class="ident" id="7025143">fakeDriver</span><span class="op" id="7025153">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7025157">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7025229">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025252">db</span><span class="op" id="7025254">.</span><span class="ident" id="7025255">SetMaxIdleConns</span><span class="op" id="7025270">(</span><span class="num" id="7025271">0</span><span class="op" id="7025272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025276">if</span>&nbsp;<span class="ident" id="7025279">g</span><span class="op" id="7025280">,</span>&nbsp;<span class="ident" id="7025282">w</span>&nbsp;<span class="op" id="7025284">:=</span>&nbsp;<span class="ident" id="7025287">db</span><span class="op" id="7025289">.</span><span class="ident" id="7025290">numFreeConns</span><span class="op" id="7025302">(</span><span class="op" id="7025303">)</span><span class="op" id="7025304">,</span>&nbsp;<span class="num" id="7025306">0</span><span class="op" id="7025307">;</span>&nbsp;<span class="ident" id="7025309">g</span>&nbsp;<span class="op" id="7025311">!=</span>&nbsp;<span class="ident" id="7025314">w</span>&nbsp;<span class="op" id="7025316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025320">t</span><span class="op" id="7025321">.</span><span class="ident" id="7025322">Errorf</span><span class="op" id="7025328">(</span><span class="string" id="7025329">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7025355">,</span>&nbsp;<span class="ident" id="7025357">g</span><span class="op" id="7025358">,</span>&nbsp;<span class="ident" id="7025360">w</span><span class="op" id="7025361">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025368">if</span>&nbsp;<span class="ident" id="7025371">n</span>&nbsp;<span class="op" id="7025373">:=</span>&nbsp;<span class="ident" id="7025376">db</span><span class="op" id="7025378">.</span><span class="ident" id="7025379">numDepsPollUntil</span><span class="op" id="7025395">(</span><span class="num" id="7025396">0</span><span class="op" id="7025397">,</span>&nbsp;<span class="ident" id="7025399">time</span><span class="op" id="7025403">.</span><span class="ident" id="7025404">Second</span><span class="op" id="7025410">)</span><span class="op" id="7025411">;</span>&nbsp;<span class="ident" id="7025413">n</span>&nbsp;<span class="op" id="7025415">&gt;</span>&nbsp;<span class="num" id="7025417">0</span>&nbsp;<span class="op" id="7025419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025423">t</span><span class="op" id="7025424">.</span><span class="ident" id="7025425">Errorf</span><span class="op" id="7025431">(</span><span class="string" id="7025432">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7025473">,</span>&nbsp;<span class="ident" id="7025475">n</span><span class="op" id="7025476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025480">db</span><span class="op" id="7025482">.</span><span class="ident" id="7025483">dumpDeps</span><span class="op" id="7025491">(</span><span class="ident" id="7025492">t</span><span class="op" id="7025493">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025500">driver</span><span class="op" id="7025506">.</span><span class="ident" id="7025507">mu</span><span class="op" id="7025509">.</span><span class="ident" id="7025510">Lock</span><span class="op" id="7025514">(</span><span class="op" id="7025515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025518">opens0</span>&nbsp;<span class="op" id="7025525">:=</span>&nbsp;<span class="ident" id="7025528">driver</span><span class="op" id="7025534">.</span><span class="ident" id="7025535">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025546">closes0</span>&nbsp;<span class="op" id="7025554">:=</span>&nbsp;<span class="ident" id="7025557">driver</span><span class="op" id="7025563">.</span><span class="ident" id="7025564">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025576">driver</span><span class="op" id="7025582">.</span><span class="ident" id="7025583">mu</span><span class="op" id="7025585">.</span><span class="ident" id="7025586">Unlock</span><span class="op" id="7025592">(</span><span class="op" id="7025593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025597">db</span><span class="op" id="7025599">.</span><span class="ident" id="7025600">SetMaxIdleConns</span><span class="op" id="7025615">(</span><span class="num" id="7025616">10</span><span class="op" id="7025618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025621">db</span><span class="op" id="7025623">.</span><span class="ident" id="7025624">SetMaxOpenConns</span><span class="op" id="7025639">(</span><span class="num" id="7025640">10</span><span class="op" id="7025642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025646">stmt</span><span class="op" id="7025650">,</span>&nbsp;<span class="ident" id="7025652">err</span>&nbsp;<span class="op" id="7025656">:=</span>&nbsp;<span class="ident" id="7025659">db</span><span class="op" id="7025661">.</span><span class="ident" id="7025662">Prepare</span><span class="op" id="7025669">(</span><span class="string" id="7025670">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7025706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025709">if</span>&nbsp;<span class="ident" id="7025712">err</span>&nbsp;<span class="op" id="7025716">!=</span>&nbsp;<span class="ident" id="7025719">nil</span>&nbsp;<span class="op" id="7025723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025727">t</span><span class="op" id="7025728">.</span><span class="ident" id="7025729">Fatal</span><span class="op" id="7025734">(</span><span class="ident" id="7025735">err</span><span class="op" id="7025738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7025745">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025781">const</span>&nbsp;<span class="op" id="7025787">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025791">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7025803">=</span>&nbsp;<span class="num" id="7025805">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025810">sleepMillis</span>&nbsp;<span class="op" id="7025822">=</span>&nbsp;<span class="num" id="7025824">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025829">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7025841">=</span>&nbsp;<span class="num" id="7025843">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7025846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025849">var</span>&nbsp;<span class="ident" id="7025853">wg</span>&nbsp;<span class="ident" id="7025856">sync</span><span class="op" id="7025860">.</span><span class="ident" id="7025861">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025872">for</span>&nbsp;<span class="ident" id="7025876">batch</span>&nbsp;<span class="op" id="7025882">:=</span>&nbsp;<span class="num" id="7025885">0</span><span class="op" id="7025886">;</span>&nbsp;<span class="ident" id="7025888">batch</span>&nbsp;<span class="op" id="7025894">&lt;</span>&nbsp;<span class="ident" id="7025896">nbatch</span><span class="op" id="7025902">;</span>&nbsp;<span class="ident" id="7025904">batch</span><span class="op" id="7025909">++</span>&nbsp;<span class="op" id="7025912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025916">for</span>&nbsp;<span class="ident" id="7025920">i</span>&nbsp;<span class="op" id="7025922">:=</span>&nbsp;<span class="num" id="7025925">0</span><span class="op" id="7025926">;</span>&nbsp;<span class="ident" id="7025928">i</span>&nbsp;<span class="op" id="7025930">&lt;</span>&nbsp;<span class="ident" id="7025932">nquery</span><span class="op" id="7025938">;</span>&nbsp;<span class="ident" id="7025940">i</span><span class="op" id="7025941">++</span>&nbsp;<span class="op" id="7025944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7025949">wg</span><span class="op" id="7025951">.</span><span class="ident" id="7025952">Add</span><span class="op" id="7025955">(</span><span class="num" id="7025956">1</span><span class="op" id="7025957">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025962">go</span>&nbsp;<span class="keyword" id="7025965">func</span><span class="op" id="7025969">(</span><span class="op" id="7025970">)</span>&nbsp;<span class="op" id="7025972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025978">defer</span>&nbsp;<span class="ident" id="7025984">wg</span><span class="op" id="7025986">.</span><span class="ident" id="7025987">Done</span><span class="op" id="7025991">(</span><span class="op" id="7025992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7025998">var</span>&nbsp;<span class="ident" id="7026002">op</span>&nbsp;<span class="builtintype" id="7026005">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026016">if</span>&nbsp;<span class="ident" id="7026019">err</span>&nbsp;<span class="op" id="7026023">:=</span>&nbsp;<span class="ident" id="7026026">stmt</span><span class="op" id="7026030">.</span><span class="ident" id="7026031">QueryRow</span><span class="op" id="7026039">(</span><span class="string" id="7026040">&#34;sleep&#34;</span><span class="op" id="7026047">,</span>&nbsp;<span class="ident" id="7026049">sleepMillis</span><span class="op" id="7026060">)</span><span class="op" id="7026061">.</span><span class="ident" id="7026062">Scan</span><span class="op" id="7026066">(</span><span class="op" id="7026067">&amp;</span><span class="ident" id="7026068">op</span><span class="op" id="7026070">)</span><span class="op" id="7026071">;</span>&nbsp;<span class="ident" id="7026073">err</span>&nbsp;<span class="op" id="7026077">!=</span>&nbsp;<span class="ident" id="7026080">nil</span>&nbsp;<span class="op" id="7026084">&amp;&amp;</span>&nbsp;<span class="ident" id="7026087">err</span>&nbsp;<span class="op" id="7026091">!=</span>&nbsp;<span class="ident" id="7026094">ErrNoRows</span>&nbsp;<span class="op" id="7026104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026111">t</span><span class="op" id="7026112">.</span><span class="ident" id="7026113">Error</span><span class="op" id="7026118">(</span><span class="ident" id="7026119">err</span><span class="op" id="7026122">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026133">}</span><span class="op" id="7026134">(</span><span class="op" id="7026135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7026143">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7026200">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7026257">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026278">time</span><span class="op" id="7026282">.</span><span class="ident" id="7026283">Sleep</span><span class="op" id="7026288">(</span><span class="num" id="7026289">2</span>&nbsp;<span class="op" id="7026291">*</span>&nbsp;<span class="ident" id="7026293">sleepMillis</span>&nbsp;<span class="op" id="7026305">*</span>&nbsp;<span class="ident" id="7026307">time</span><span class="op" id="7026311">.</span><span class="ident" id="7026312">Millisecond</span><span class="op" id="7026323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026329">wg</span><span class="op" id="7026331">.</span><span class="ident" id="7026332">Wait</span><span class="op" id="7026336">(</span><span class="op" id="7026337">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026341">if</span>&nbsp;<span class="ident" id="7026344">g</span><span class="op" id="7026345">,</span>&nbsp;<span class="ident" id="7026347">w</span>&nbsp;<span class="op" id="7026349">:=</span>&nbsp;<span class="ident" id="7026352">db</span><span class="op" id="7026354">.</span><span class="ident" id="7026355">numFreeConns</span><span class="op" id="7026367">(</span><span class="op" id="7026368">)</span><span class="op" id="7026369">,</span>&nbsp;<span class="num" id="7026371">10</span><span class="op" id="7026373">;</span>&nbsp;<span class="ident" id="7026375">g</span>&nbsp;<span class="op" id="7026377">!=</span>&nbsp;<span class="ident" id="7026380">w</span>&nbsp;<span class="op" id="7026382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026386">t</span><span class="op" id="7026387">.</span><span class="ident" id="7026388">Errorf</span><span class="op" id="7026394">(</span><span class="string" id="7026395">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7026421">,</span>&nbsp;<span class="ident" id="7026423">g</span><span class="op" id="7026424">,</span>&nbsp;<span class="ident" id="7026426">w</span><span class="op" id="7026427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026434">if</span>&nbsp;<span class="ident" id="7026437">n</span>&nbsp;<span class="op" id="7026439">:=</span>&nbsp;<span class="ident" id="7026442">db</span><span class="op" id="7026444">.</span><span class="ident" id="7026445">numDepsPollUntil</span><span class="op" id="7026461">(</span><span class="num" id="7026462">20</span><span class="op" id="7026464">,</span>&nbsp;<span class="ident" id="7026466">time</span><span class="op" id="7026470">.</span><span class="ident" id="7026471">Second</span><span class="op" id="7026477">)</span><span class="op" id="7026478">;</span>&nbsp;<span class="ident" id="7026480">n</span>&nbsp;<span class="op" id="7026482">&gt;</span>&nbsp;<span class="num" id="7026484">20</span>&nbsp;<span class="op" id="7026487">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026491">t</span><span class="op" id="7026492">.</span><span class="ident" id="7026493">Errorf</span><span class="op" id="7026499">(</span><span class="string" id="7026500">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7026545">,</span>&nbsp;<span class="ident" id="7026547">n</span><span class="op" id="7026548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026552">db</span><span class="op" id="7026554">.</span><span class="ident" id="7026555">dumpDeps</span><span class="op" id="7026563">(</span><span class="ident" id="7026564">t</span><span class="op" id="7026565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026572">driver</span><span class="op" id="7026578">.</span><span class="ident" id="7026579">mu</span><span class="op" id="7026581">.</span><span class="ident" id="7026582">Lock</span><span class="op" id="7026586">(</span><span class="op" id="7026587">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026590">opens</span>&nbsp;<span class="op" id="7026596">:=</span>&nbsp;<span class="ident" id="7026599">driver</span><span class="op" id="7026605">.</span><span class="ident" id="7026606">openCount</span>&nbsp;<span class="op" id="7026616">-</span>&nbsp;<span class="ident" id="7026618">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026626">closes</span>&nbsp;<span class="op" id="7026633">:=</span>&nbsp;<span class="ident" id="7026636">driver</span><span class="op" id="7026642">.</span><span class="ident" id="7026643">closeCount</span>&nbsp;<span class="op" id="7026654">-</span>&nbsp;<span class="ident" id="7026656">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026665">driver</span><span class="op" id="7026671">.</span><span class="ident" id="7026672">mu</span><span class="op" id="7026674">.</span><span class="ident" id="7026675">Unlock</span><span class="op" id="7026681">(</span><span class="op" id="7026682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026686">if</span>&nbsp;<span class="ident" id="7026689">opens</span>&nbsp;<span class="op" id="7026695">&gt;</span>&nbsp;<span class="num" id="7026697">10</span>&nbsp;<span class="op" id="7026700">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026704">t</span><span class="op" id="7026705">.</span><span class="ident" id="7026706">Logf</span><span class="op" id="7026710">(</span><span class="string" id="7026711">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7026728">,</span>&nbsp;<span class="ident" id="7026730">opens</span><span class="op" id="7026735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026739">t</span><span class="op" id="7026740">.</span><span class="ident" id="7026741">Logf</span><span class="op" id="7026745">(</span><span class="string" id="7026746">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7026764">,</span>&nbsp;<span class="ident" id="7026766">closes</span><span class="op" id="7026772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026776">t</span><span class="op" id="7026777">.</span><span class="ident" id="7026778">Errorf</span><span class="op" id="7026784">(</span><span class="string" id="7026785">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7026825">,</span>&nbsp;<span class="ident" id="7026827">opens</span><span class="op" id="7026832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026836">db</span><span class="op" id="7026838">.</span><span class="ident" id="7026839">dumpDeps</span><span class="op" id="7026847">(</span><span class="ident" id="7026848">t</span><span class="op" id="7026849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026852">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026856">if</span>&nbsp;<span class="ident" id="7026859">err</span>&nbsp;<span class="op" id="7026863">:=</span>&nbsp;<span class="ident" id="7026866">stmt</span><span class="op" id="7026870">.</span><span class="ident" id="7026871">Close</span><span class="op" id="7026876">(</span><span class="op" id="7026877">)</span><span class="op" id="7026878">;</span>&nbsp;<span class="ident" id="7026880">err</span>&nbsp;<span class="op" id="7026884">!=</span>&nbsp;<span class="ident" id="7026887">nil</span>&nbsp;<span class="op" id="7026891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026895">t</span><span class="op" id="7026896">.</span><span class="ident" id="7026897">Fatal</span><span class="op" id="7026902">(</span><span class="ident" id="7026903">err</span><span class="op" id="7026906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7026909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7026913">if</span>&nbsp;<span class="ident" id="7026916">g</span><span class="op" id="7026917">,</span>&nbsp;<span class="ident" id="7026919">w</span>&nbsp;<span class="op" id="7026921">:=</span>&nbsp;<span class="ident" id="7026924">db</span><span class="op" id="7026926">.</span><span class="ident" id="7026927">numFreeConns</span><span class="op" id="7026939">(</span><span class="op" id="7026940">)</span><span class="op" id="7026941">,</span>&nbsp;<span class="num" id="7026943">10</span><span class="op" id="7026945">;</span>&nbsp;<span class="ident" id="7026947">g</span>&nbsp;<span class="op" id="7026949">!=</span>&nbsp;<span class="ident" id="7026952">w</span>&nbsp;<span class="op" id="7026954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7026958">t</span><span class="op" id="7026959">.</span><span class="ident" id="7026960">Errorf</span><span class="op" id="7026966">(</span><span class="string" id="7026967">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7026993">,</span>&nbsp;<span class="ident" id="7026995">g</span><span class="op" id="7026996">,</span>&nbsp;<span class="ident" id="7026998">w</span><span class="op" id="7026999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027006">if</span>&nbsp;<span class="ident" id="7027009">n</span>&nbsp;<span class="op" id="7027011">:=</span>&nbsp;<span class="ident" id="7027014">db</span><span class="op" id="7027016">.</span><span class="ident" id="7027017">numDepsPollUntil</span><span class="op" id="7027033">(</span><span class="num" id="7027034">10</span><span class="op" id="7027036">,</span>&nbsp;<span class="ident" id="7027038">time</span><span class="op" id="7027042">.</span><span class="ident" id="7027043">Second</span><span class="op" id="7027049">)</span><span class="op" id="7027050">;</span>&nbsp;<span class="ident" id="7027052">n</span>&nbsp;<span class="op" id="7027054">&gt;</span>&nbsp;<span class="num" id="7027056">10</span>&nbsp;<span class="op" id="7027059">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027063">t</span><span class="op" id="7027064">.</span><span class="ident" id="7027065">Errorf</span><span class="op" id="7027071">(</span><span class="string" id="7027072">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7027117">,</span>&nbsp;<span class="ident" id="7027119">n</span><span class="op" id="7027120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027124">db</span><span class="op" id="7027126">.</span><span class="ident" id="7027127">dumpDeps</span><span class="op" id="7027135">(</span><span class="ident" id="7027136">t</span><span class="op" id="7027137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027144">db</span><span class="op" id="7027146">.</span><span class="ident" id="7027147">SetMaxOpenConns</span><span class="op" id="7027162">(</span><span class="num" id="7027163">5</span><span class="op" id="7027164">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027168">if</span>&nbsp;<span class="ident" id="7027171">g</span><span class="op" id="7027172">,</span>&nbsp;<span class="ident" id="7027174">w</span>&nbsp;<span class="op" id="7027176">:=</span>&nbsp;<span class="ident" id="7027179">db</span><span class="op" id="7027181">.</span><span class="ident" id="7027182">numFreeConns</span><span class="op" id="7027194">(</span><span class="op" id="7027195">)</span><span class="op" id="7027196">,</span>&nbsp;<span class="num" id="7027198">5</span><span class="op" id="7027199">;</span>&nbsp;<span class="ident" id="7027201">g</span>&nbsp;<span class="op" id="7027203">!=</span>&nbsp;<span class="ident" id="7027206">w</span>&nbsp;<span class="op" id="7027208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027212">t</span><span class="op" id="7027213">.</span><span class="ident" id="7027214">Errorf</span><span class="op" id="7027220">(</span><span class="string" id="7027221">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7027247">,</span>&nbsp;<span class="ident" id="7027249">g</span><span class="op" id="7027250">,</span>&nbsp;<span class="ident" id="7027252">w</span><span class="op" id="7027253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027260">if</span>&nbsp;<span class="ident" id="7027263">n</span>&nbsp;<span class="op" id="7027265">:=</span>&nbsp;<span class="ident" id="7027268">db</span><span class="op" id="7027270">.</span><span class="ident" id="7027271">numDepsPollUntil</span><span class="op" id="7027287">(</span><span class="num" id="7027288">5</span><span class="op" id="7027289">,</span>&nbsp;<span class="ident" id="7027291">time</span><span class="op" id="7027295">.</span><span class="ident" id="7027296">Second</span><span class="op" id="7027302">)</span><span class="op" id="7027303">;</span>&nbsp;<span class="ident" id="7027305">n</span>&nbsp;<span class="op" id="7027307">&gt;</span>&nbsp;<span class="num" id="7027309">5</span>&nbsp;<span class="op" id="7027311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027315">t</span><span class="op" id="7027316">.</span><span class="ident" id="7027317">Errorf</span><span class="op" id="7027323">(</span><span class="string" id="7027324">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7027365">,</span>&nbsp;<span class="ident" id="7027367">n</span><span class="op" id="7027368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027372">db</span><span class="op" id="7027374">.</span><span class="ident" id="7027375">dumpDeps</span><span class="op" id="7027383">(</span><span class="ident" id="7027384">t</span><span class="op" id="7027385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027392">db</span><span class="op" id="7027394">.</span><span class="ident" id="7027395">SetMaxOpenConns</span><span class="op" id="7027410">(</span><span class="num" id="7027411">0</span><span class="op" id="7027412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027416">if</span>&nbsp;<span class="ident" id="7027419">g</span><span class="op" id="7027420">,</span>&nbsp;<span class="ident" id="7027422">w</span>&nbsp;<span class="op" id="7027424">:=</span>&nbsp;<span class="ident" id="7027427">db</span><span class="op" id="7027429">.</span><span class="ident" id="7027430">numFreeConns</span><span class="op" id="7027442">(</span><span class="op" id="7027443">)</span><span class="op" id="7027444">,</span>&nbsp;<span class="num" id="7027446">5</span><span class="op" id="7027447">;</span>&nbsp;<span class="ident" id="7027449">g</span>&nbsp;<span class="op" id="7027451">!=</span>&nbsp;<span class="ident" id="7027454">w</span>&nbsp;<span class="op" id="7027456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027460">t</span><span class="op" id="7027461">.</span><span class="ident" id="7027462">Errorf</span><span class="op" id="7027468">(</span><span class="string" id="7027469">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7027495">,</span>&nbsp;<span class="ident" id="7027497">g</span><span class="op" id="7027498">,</span>&nbsp;<span class="ident" id="7027500">w</span><span class="op" id="7027501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027504">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027508">if</span>&nbsp;<span class="ident" id="7027511">n</span>&nbsp;<span class="op" id="7027513">:=</span>&nbsp;<span class="ident" id="7027516">db</span><span class="op" id="7027518">.</span><span class="ident" id="7027519">numDepsPollUntil</span><span class="op" id="7027535">(</span><span class="num" id="7027536">5</span><span class="op" id="7027537">,</span>&nbsp;<span class="ident" id="7027539">time</span><span class="op" id="7027543">.</span><span class="ident" id="7027544">Second</span><span class="op" id="7027550">)</span><span class="op" id="7027551">;</span>&nbsp;<span class="ident" id="7027553">n</span>&nbsp;<span class="op" id="7027555">&gt;</span>&nbsp;<span class="num" id="7027557">5</span>&nbsp;<span class="op" id="7027559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027563">t</span><span class="op" id="7027564">.</span><span class="ident" id="7027565">Errorf</span><span class="op" id="7027571">(</span><span class="string" id="7027572">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7027613">,</span>&nbsp;<span class="ident" id="7027615">n</span><span class="op" id="7027616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027620">db</span><span class="op" id="7027622">.</span><span class="ident" id="7027623">dumpDeps</span><span class="op" id="7027631">(</span><span class="ident" id="7027632">t</span><span class="op" id="7027633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027636">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027640">db</span><span class="op" id="7027642">.</span><span class="ident" id="7027643">SetMaxIdleConns</span><span class="op" id="7027658">(</span><span class="num" id="7027659">0</span><span class="op" id="7027660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027664">if</span>&nbsp;<span class="ident" id="7027667">g</span><span class="op" id="7027668">,</span>&nbsp;<span class="ident" id="7027670">w</span>&nbsp;<span class="op" id="7027672">:=</span>&nbsp;<span class="ident" id="7027675">db</span><span class="op" id="7027677">.</span><span class="ident" id="7027678">numFreeConns</span><span class="op" id="7027690">(</span><span class="op" id="7027691">)</span><span class="op" id="7027692">,</span>&nbsp;<span class="num" id="7027694">0</span><span class="op" id="7027695">;</span>&nbsp;<span class="ident" id="7027697">g</span>&nbsp;<span class="op" id="7027699">!=</span>&nbsp;<span class="ident" id="7027702">w</span>&nbsp;<span class="op" id="7027704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027708">t</span><span class="op" id="7027709">.</span><span class="ident" id="7027710">Errorf</span><span class="op" id="7027716">(</span><span class="string" id="7027717">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7027743">,</span>&nbsp;<span class="ident" id="7027745">g</span><span class="op" id="7027746">,</span>&nbsp;<span class="ident" id="7027748">w</span><span class="op" id="7027749">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027756">if</span>&nbsp;<span class="ident" id="7027759">n</span>&nbsp;<span class="op" id="7027761">:=</span>&nbsp;<span class="ident" id="7027764">db</span><span class="op" id="7027766">.</span><span class="ident" id="7027767">numDepsPollUntil</span><span class="op" id="7027783">(</span><span class="num" id="7027784">0</span><span class="op" id="7027785">,</span>&nbsp;<span class="ident" id="7027787">time</span><span class="op" id="7027791">.</span><span class="ident" id="7027792">Second</span><span class="op" id="7027798">)</span><span class="op" id="7027799">;</span>&nbsp;<span class="ident" id="7027801">n</span>&nbsp;<span class="op" id="7027803">&gt;</span>&nbsp;<span class="num" id="7027805">0</span>&nbsp;<span class="op" id="7027807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027811">t</span><span class="op" id="7027812">.</span><span class="ident" id="7027813">Errorf</span><span class="op" id="7027819">(</span><span class="string" id="7027820">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7027861">,</span>&nbsp;<span class="ident" id="7027863">n</span><span class="op" id="7027864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027868">db</span><span class="op" id="7027870">.</span><span class="ident" id="7027871">dumpDeps</span><span class="op" id="7027879">(</span><span class="ident" id="7027880">t</span><span class="op" id="7027881">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7027884">}</span><br>
<span class="lineno"></span><span class="op" id="7027886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7027889">func</span>&nbsp;<span class="ident" id="7027894">TestSingleOpenConn</span><span class="op" id="7027912">(</span><span class="ident" id="7027913">t</span>&nbsp;<span class="op" id="7027915">*</span><span class="ident" id="7027916">testing</span><span class="op" id="7027923">.</span><span class="ident" id="7027924">T</span><span class="op" id="7027925">)</span>&nbsp;<span class="op" id="7027927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027930">db</span>&nbsp;<span class="op" id="7027933">:=</span>&nbsp;<span class="ident" id="7027936">newTestDB</span><span class="op" id="7027945">(</span><span class="ident" id="7027946">t</span><span class="op" id="7027947">,</span>&nbsp;<span class="string" id="7027949">&#34;people&#34;</span><span class="op" id="7027957">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7027960">defer</span>&nbsp;<span class="ident" id="7027966">closeDB</span><span class="op" id="7027973">(</span><span class="ident" id="7027974">t</span><span class="op" id="7027975">,</span>&nbsp;<span class="ident" id="7027977">db</span><span class="op" id="7027979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7027983">db</span><span class="op" id="7027985">.</span><span class="ident" id="7027986">SetMaxOpenConns</span><span class="op" id="7028001">(</span><span class="num" id="7028002">1</span><span class="op" id="7028003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028007">rows</span><span class="op" id="7028011">,</span>&nbsp;<span class="ident" id="7028013">err</span>&nbsp;<span class="op" id="7028017">:=</span>&nbsp;<span class="ident" id="7028020">db</span><span class="op" id="7028022">.</span><span class="ident" id="7028023">Query</span><span class="op" id="7028028">(</span><span class="string" id="7028029">&#34;SELECT|people|name|&#34;</span><span class="op" id="7028050">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028053">if</span>&nbsp;<span class="ident" id="7028056">err</span>&nbsp;<span class="op" id="7028060">!=</span>&nbsp;<span class="ident" id="7028063">nil</span>&nbsp;<span class="op" id="7028067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028071">t</span><span class="op" id="7028072">.</span><span class="ident" id="7028073">Fatal</span><span class="op" id="7028078">(</span><span class="ident" id="7028079">err</span><span class="op" id="7028082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028088">if</span>&nbsp;<span class="ident" id="7028091">err</span>&nbsp;<span class="op" id="7028095">=</span>&nbsp;<span class="ident" id="7028097">rows</span><span class="op" id="7028101">.</span><span class="ident" id="7028102">Close</span><span class="op" id="7028107">(</span><span class="op" id="7028108">)</span><span class="op" id="7028109">;</span>&nbsp;<span class="ident" id="7028111">err</span>&nbsp;<span class="op" id="7028115">!=</span>&nbsp;<span class="ident" id="7028118">nil</span>&nbsp;<span class="op" id="7028122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028126">t</span><span class="op" id="7028127">.</span><span class="ident" id="7028128">Fatal</span><span class="op" id="7028133">(</span><span class="ident" id="7028134">err</span><span class="op" id="7028137">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7028143">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028166">rows</span><span class="op" id="7028170">,</span>&nbsp;<span class="ident" id="7028172">err</span>&nbsp;<span class="op" id="7028176">=</span>&nbsp;<span class="ident" id="7028178">db</span><span class="op" id="7028180">.</span><span class="ident" id="7028181">Query</span><span class="op" id="7028186">(</span><span class="string" id="7028187">&#34;SELECT|people|name|&#34;</span><span class="op" id="7028208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028211">if</span>&nbsp;<span class="ident" id="7028214">err</span>&nbsp;<span class="op" id="7028218">!=</span>&nbsp;<span class="ident" id="7028221">nil</span>&nbsp;<span class="op" id="7028225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028229">t</span><span class="op" id="7028230">.</span><span class="ident" id="7028231">Fatal</span><span class="op" id="7028236">(</span><span class="ident" id="7028237">err</span><span class="op" id="7028240">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028246">if</span>&nbsp;<span class="ident" id="7028249">err</span>&nbsp;<span class="op" id="7028253">=</span>&nbsp;<span class="ident" id="7028255">rows</span><span class="op" id="7028259">.</span><span class="ident" id="7028260">Close</span><span class="op" id="7028265">(</span><span class="op" id="7028266">)</span><span class="op" id="7028267">;</span>&nbsp;<span class="ident" id="7028269">err</span>&nbsp;<span class="op" id="7028273">!=</span>&nbsp;<span class="ident" id="7028276">nil</span>&nbsp;<span class="op" id="7028280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028284">t</span><span class="op" id="7028285">.</span><span class="ident" id="7028286">Fatal</span><span class="op" id="7028291">(</span><span class="ident" id="7028292">err</span><span class="op" id="7028295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028298">}</span><br>
<span class="lineno"></span><span class="op" id="7028300">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7028303">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7028328">func</span>&nbsp;<span class="ident" id="7028333">TestStmtCloseDeps</span><span class="op" id="7028350">(</span><span class="ident" id="7028351">t</span>&nbsp;<span class="op" id="7028353">*</span><span class="ident" id="7028354">testing</span><span class="op" id="7028361">.</span><span class="ident" id="7028362">T</span><span class="op" id="7028363">)</span>&nbsp;<span class="op" id="7028365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028368">if</span>&nbsp;<span class="ident" id="7028371">testing</span><span class="op" id="7028378">.</span><span class="ident" id="7028379">Short</span><span class="op" id="7028384">(</span><span class="op" id="7028385">)</span>&nbsp;<span class="op" id="7028387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028391">t</span><span class="op" id="7028392">.</span><span class="ident" id="7028393">Skip</span><span class="op" id="7028397">(</span><span class="string" id="7028398">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7028422">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028428">defer</span>&nbsp;<span class="ident" id="7028434">setHookpostCloseConn</span><span class="op" id="7028454">(</span><span class="ident" id="7028455">nil</span><span class="op" id="7028458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028461">setHookpostCloseConn</span><span class="op" id="7028481">(</span><span class="keyword" id="7028482">func</span><span class="op" id="7028486">(</span><span class="ident" id="7028487">_</span>&nbsp;<span class="op" id="7028489">*</span><span class="ident" id="7028490">fakeConn</span><span class="op" id="7028498">,</span>&nbsp;<span class="ident" id="7028500">err</span>&nbsp;<span class="builtintype" id="7028504">error</span><span class="op" id="7028509">)</span>&nbsp;<span class="op" id="7028511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028515">if</span>&nbsp;<span class="ident" id="7028518">err</span>&nbsp;<span class="op" id="7028522">!=</span>&nbsp;<span class="ident" id="7028525">nil</span>&nbsp;<span class="op" id="7028529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028534">t</span><span class="op" id="7028535">.</span><span class="ident" id="7028536">Errorf</span><span class="op" id="7028542">(</span><span class="string" id="7028543">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7028571">,</span>&nbsp;<span class="ident" id="7028573">err</span><span class="op" id="7028576">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028583">}</span><span class="op" id="7028584">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028588">db</span>&nbsp;<span class="op" id="7028591">:=</span>&nbsp;<span class="ident" id="7028594">newTestDB</span><span class="op" id="7028603">(</span><span class="ident" id="7028604">t</span><span class="op" id="7028605">,</span>&nbsp;<span class="string" id="7028607">&#34;magicquery&#34;</span><span class="op" id="7028619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028622">defer</span>&nbsp;<span class="ident" id="7028628">closeDB</span><span class="op" id="7028635">(</span><span class="ident" id="7028636">t</span><span class="op" id="7028637">,</span>&nbsp;<span class="ident" id="7028639">db</span><span class="op" id="7028641">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028645">driver</span>&nbsp;<span class="op" id="7028652">:=</span>&nbsp;<span class="ident" id="7028655">db</span><span class="op" id="7028657">.</span><span class="ident" id="7028658">driver</span><span class="op" id="7028664">.</span><span class="op" id="7028665">(</span><span class="op" id="7028666">*</span><span class="ident" id="7028667">fakeDriver</span><span class="op" id="7028677">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028681">driver</span><span class="op" id="7028687">.</span><span class="ident" id="7028688">mu</span><span class="op" id="7028690">.</span><span class="ident" id="7028691">Lock</span><span class="op" id="7028695">(</span><span class="op" id="7028696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028699">opens0</span>&nbsp;<span class="op" id="7028706">:=</span>&nbsp;<span class="ident" id="7028709">driver</span><span class="op" id="7028715">.</span><span class="ident" id="7028716">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028727">closes0</span>&nbsp;<span class="op" id="7028735">:=</span>&nbsp;<span class="ident" id="7028738">driver</span><span class="op" id="7028744">.</span><span class="ident" id="7028745">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028757">driver</span><span class="op" id="7028763">.</span><span class="ident" id="7028764">mu</span><span class="op" id="7028766">.</span><span class="ident" id="7028767">Unlock</span><span class="op" id="7028773">(</span><span class="op" id="7028774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028777">openDelta0</span>&nbsp;<span class="op" id="7028788">:=</span>&nbsp;<span class="ident" id="7028791">opens0</span>&nbsp;<span class="op" id="7028798">-</span>&nbsp;<span class="ident" id="7028800">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028810">stmt</span><span class="op" id="7028814">,</span>&nbsp;<span class="ident" id="7028816">err</span>&nbsp;<span class="op" id="7028820">:=</span>&nbsp;<span class="ident" id="7028823">db</span><span class="op" id="7028825">.</span><span class="ident" id="7028826">Prepare</span><span class="op" id="7028833">(</span><span class="string" id="7028834">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7028870">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028873">if</span>&nbsp;<span class="ident" id="7028876">err</span>&nbsp;<span class="op" id="7028880">!=</span>&nbsp;<span class="ident" id="7028883">nil</span>&nbsp;<span class="op" id="7028887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028891">t</span><span class="op" id="7028892">.</span><span class="ident" id="7028893">Fatal</span><span class="op" id="7028898">(</span><span class="ident" id="7028899">err</span><span class="op" id="7028902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7028905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7028909">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7028945">const</span>&nbsp;<span class="op" id="7028951">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028955">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7028967">=</span>&nbsp;<span class="num" id="7028969">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028974">sleepMillis</span>&nbsp;<span class="op" id="7028986">=</span>&nbsp;<span class="num" id="7028988">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7028993">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7029005">=</span>&nbsp;<span class="num" id="7029007">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029010">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029013">var</span>&nbsp;<span class="ident" id="7029017">wg</span>&nbsp;<span class="ident" id="7029020">sync</span><span class="op" id="7029024">.</span><span class="ident" id="7029025">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029036">for</span>&nbsp;<span class="ident" id="7029040">batch</span>&nbsp;<span class="op" id="7029046">:=</span>&nbsp;<span class="num" id="7029049">0</span><span class="op" id="7029050">;</span>&nbsp;<span class="ident" id="7029052">batch</span>&nbsp;<span class="op" id="7029058">&lt;</span>&nbsp;<span class="ident" id="7029060">nbatch</span><span class="op" id="7029066">;</span>&nbsp;<span class="ident" id="7029068">batch</span><span class="op" id="7029073">++</span>&nbsp;<span class="op" id="7029076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029080">for</span>&nbsp;<span class="ident" id="7029084">i</span>&nbsp;<span class="op" id="7029086">:=</span>&nbsp;<span class="num" id="7029089">0</span><span class="op" id="7029090">;</span>&nbsp;<span class="ident" id="7029092">i</span>&nbsp;<span class="op" id="7029094">&lt;</span>&nbsp;<span class="ident" id="7029096">nquery</span><span class="op" id="7029102">;</span>&nbsp;<span class="ident" id="7029104">i</span><span class="op" id="7029105">++</span>&nbsp;<span class="op" id="7029108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029113">wg</span><span class="op" id="7029115">.</span><span class="ident" id="7029116">Add</span><span class="op" id="7029119">(</span><span class="num" id="7029120">1</span><span class="op" id="7029121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029126">go</span>&nbsp;<span class="keyword" id="7029129">func</span><span class="op" id="7029133">(</span><span class="op" id="7029134">)</span>&nbsp;<span class="op" id="7029136">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029142">defer</span>&nbsp;<span class="ident" id="7029148">wg</span><span class="op" id="7029150">.</span><span class="ident" id="7029151">Done</span><span class="op" id="7029155">(</span><span class="op" id="7029156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029162">var</span>&nbsp;<span class="ident" id="7029166">op</span>&nbsp;<span class="builtintype" id="7029169">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029180">if</span>&nbsp;<span class="ident" id="7029183">err</span>&nbsp;<span class="op" id="7029187">:=</span>&nbsp;<span class="ident" id="7029190">stmt</span><span class="op" id="7029194">.</span><span class="ident" id="7029195">QueryRow</span><span class="op" id="7029203">(</span><span class="string" id="7029204">&#34;sleep&#34;</span><span class="op" id="7029211">,</span>&nbsp;<span class="ident" id="7029213">sleepMillis</span><span class="op" id="7029224">)</span><span class="op" id="7029225">.</span><span class="ident" id="7029226">Scan</span><span class="op" id="7029230">(</span><span class="op" id="7029231">&amp;</span><span class="ident" id="7029232">op</span><span class="op" id="7029234">)</span><span class="op" id="7029235">;</span>&nbsp;<span class="ident" id="7029237">err</span>&nbsp;<span class="op" id="7029241">!=</span>&nbsp;<span class="ident" id="7029244">nil</span>&nbsp;<span class="op" id="7029248">&amp;&amp;</span>&nbsp;<span class="ident" id="7029251">err</span>&nbsp;<span class="op" id="7029255">!=</span>&nbsp;<span class="ident" id="7029258">ErrNoRows</span>&nbsp;<span class="op" id="7029268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029275">t</span><span class="op" id="7029276">.</span><span class="ident" id="7029277">Error</span><span class="op" id="7029282">(</span><span class="ident" id="7029283">err</span><span class="op" id="7029286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029292">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029297">}</span><span class="op" id="7029298">(</span><span class="op" id="7029299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7029307">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7029364">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7029421">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029442">time</span><span class="op" id="7029446">.</span><span class="ident" id="7029447">Sleep</span><span class="op" id="7029452">(</span><span class="num" id="7029453">2</span>&nbsp;<span class="op" id="7029455">*</span>&nbsp;<span class="ident" id="7029457">sleepMillis</span>&nbsp;<span class="op" id="7029469">*</span>&nbsp;<span class="ident" id="7029471">time</span><span class="op" id="7029475">.</span><span class="ident" id="7029476">Millisecond</span><span class="op" id="7029487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029493">wg</span><span class="op" id="7029495">.</span><span class="ident" id="7029496">Wait</span><span class="op" id="7029500">(</span><span class="op" id="7029501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029505">if</span>&nbsp;<span class="ident" id="7029508">g</span><span class="op" id="7029509">,</span>&nbsp;<span class="ident" id="7029511">w</span>&nbsp;<span class="op" id="7029513">:=</span>&nbsp;<span class="ident" id="7029516">db</span><span class="op" id="7029518">.</span><span class="ident" id="7029519">numFreeConns</span><span class="op" id="7029531">(</span><span class="op" id="7029532">)</span><span class="op" id="7029533">,</span>&nbsp;<span class="num" id="7029535">2</span><span class="op" id="7029536">;</span>&nbsp;<span class="ident" id="7029538">g</span>&nbsp;<span class="op" id="7029540">!=</span>&nbsp;<span class="ident" id="7029543">w</span>&nbsp;<span class="op" id="7029545">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029549">t</span><span class="op" id="7029550">.</span><span class="ident" id="7029551">Errorf</span><span class="op" id="7029557">(</span><span class="string" id="7029558">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7029584">,</span>&nbsp;<span class="ident" id="7029586">g</span><span class="op" id="7029587">,</span>&nbsp;<span class="ident" id="7029589">w</span><span class="op" id="7029590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029597">if</span>&nbsp;<span class="ident" id="7029600">n</span>&nbsp;<span class="op" id="7029602">:=</span>&nbsp;<span class="ident" id="7029605">db</span><span class="op" id="7029607">.</span><span class="ident" id="7029608">numDepsPollUntil</span><span class="op" id="7029624">(</span><span class="num" id="7029625">4</span><span class="op" id="7029626">,</span>&nbsp;<span class="ident" id="7029628">time</span><span class="op" id="7029632">.</span><span class="ident" id="7029633">Second</span><span class="op" id="7029639">)</span><span class="op" id="7029640">;</span>&nbsp;<span class="ident" id="7029642">n</span>&nbsp;<span class="op" id="7029644">&gt;</span>&nbsp;<span class="num" id="7029646">4</span>&nbsp;<span class="op" id="7029648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029652">t</span><span class="op" id="7029653">.</span><span class="ident" id="7029654">Errorf</span><span class="op" id="7029660">(</span><span class="string" id="7029661">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7029705">,</span>&nbsp;<span class="ident" id="7029707">n</span><span class="op" id="7029708">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029712">db</span><span class="op" id="7029714">.</span><span class="ident" id="7029715">dumpDeps</span><span class="op" id="7029723">(</span><span class="ident" id="7029724">t</span><span class="op" id="7029725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7029728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029732">driver</span><span class="op" id="7029738">.</span><span class="ident" id="7029739">mu</span><span class="op" id="7029741">.</span><span class="ident" id="7029742">Lock</span><span class="op" id="7029746">(</span><span class="op" id="7029747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029750">opens</span>&nbsp;<span class="op" id="7029756">:=</span>&nbsp;<span class="ident" id="7029759">driver</span><span class="op" id="7029765">.</span><span class="ident" id="7029766">openCount</span>&nbsp;<span class="op" id="7029776">-</span>&nbsp;<span class="ident" id="7029778">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029786">closes</span>&nbsp;<span class="op" id="7029793">:=</span>&nbsp;<span class="ident" id="7029796">driver</span><span class="op" id="7029802">.</span><span class="ident" id="7029803">closeCount</span>&nbsp;<span class="op" id="7029814">-</span>&nbsp;<span class="ident" id="7029816">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029825">openDelta</span>&nbsp;<span class="op" id="7029835">:=</span>&nbsp;<span class="op" id="7029838">(</span><span class="ident" id="7029839">driver</span><span class="op" id="7029845">.</span><span class="ident" id="7029846">openCount</span>&nbsp;<span class="op" id="7029856">-</span>&nbsp;<span class="ident" id="7029858">driver</span><span class="op" id="7029864">.</span><span class="ident" id="7029865">closeCount</span><span class="op" id="7029875">)</span>&nbsp;<span class="op" id="7029877">-</span>&nbsp;<span class="ident" id="7029879">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029891">driver</span><span class="op" id="7029897">.</span><span class="ident" id="7029898">mu</span><span class="op" id="7029900">.</span><span class="ident" id="7029901">Unlock</span><span class="op" id="7029907">(</span><span class="op" id="7029908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7029912">if</span>&nbsp;<span class="ident" id="7029915">openDelta</span>&nbsp;<span class="op" id="7029925">&gt;</span>&nbsp;<span class="num" id="7029927">2</span>&nbsp;<span class="op" id="7029929">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029933">t</span><span class="op" id="7029934">.</span><span class="ident" id="7029935">Logf</span><span class="op" id="7029939">(</span><span class="string" id="7029940">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7029957">,</span>&nbsp;<span class="ident" id="7029959">opens</span><span class="op" id="7029964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7029968">t</span><span class="op" id="7029969">.</span><span class="ident" id="7029970">Logf</span><span class="op" id="7029974">(</span><span class="string" id="7029975">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7029993">,</span>&nbsp;<span class="ident" id="7029995">closes</span><span class="op" id="7030001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030005">t</span><span class="op" id="7030006">.</span><span class="ident" id="7030007">Logf</span><span class="op" id="7030011">(</span><span class="string" id="7030012">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7030029">,</span>&nbsp;<span class="ident" id="7030031">openDelta</span><span class="op" id="7030040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030044">t</span><span class="op" id="7030045">.</span><span class="ident" id="7030046">Errorf</span><span class="op" id="7030052">(</span><span class="string" id="7030053">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7030092">,</span>&nbsp;<span class="ident" id="7030094">openDelta</span><span class="op" id="7030103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030107">db</span><span class="op" id="7030109">.</span><span class="ident" id="7030110">dumpDeps</span><span class="op" id="7030118">(</span><span class="ident" id="7030119">t</span><span class="op" id="7030120">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030127">if</span>&nbsp;<span class="builtinfunc" id="7030130">len</span><span class="op" id="7030133">(</span><span class="ident" id="7030134">stmt</span><span class="op" id="7030138">.</span><span class="ident" id="7030139">css</span><span class="op" id="7030142">)</span>&nbsp;<span class="op" id="7030144">&gt;</span>&nbsp;<span class="ident" id="7030146">nquery</span>&nbsp;<span class="op" id="7030153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030157">t</span><span class="op" id="7030158">.</span><span class="ident" id="7030159">Errorf</span><span class="op" id="7030165">(</span><span class="string" id="7030166">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7030198">,</span>&nbsp;<span class="builtinfunc" id="7030200">len</span><span class="op" id="7030203">(</span><span class="ident" id="7030204">stmt</span><span class="op" id="7030208">.</span><span class="ident" id="7030209">css</span><span class="op" id="7030212">)</span><span class="op" id="7030213">,</span>&nbsp;<span class="ident" id="7030215">nquery</span><span class="op" id="7030221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030224">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030228">if</span>&nbsp;<span class="ident" id="7030231">err</span>&nbsp;<span class="op" id="7030235">:=</span>&nbsp;<span class="ident" id="7030238">stmt</span><span class="op" id="7030242">.</span><span class="ident" id="7030243">Close</span><span class="op" id="7030248">(</span><span class="op" id="7030249">)</span><span class="op" id="7030250">;</span>&nbsp;<span class="ident" id="7030252">err</span>&nbsp;<span class="op" id="7030256">!=</span>&nbsp;<span class="ident" id="7030259">nil</span>&nbsp;<span class="op" id="7030263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030267">t</span><span class="op" id="7030268">.</span><span class="ident" id="7030269">Fatal</span><span class="op" id="7030274">(</span><span class="ident" id="7030275">err</span><span class="op" id="7030278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030285">if</span>&nbsp;<span class="ident" id="7030288">g</span><span class="op" id="7030289">,</span>&nbsp;<span class="ident" id="7030291">w</span>&nbsp;<span class="op" id="7030293">:=</span>&nbsp;<span class="ident" id="7030296">db</span><span class="op" id="7030298">.</span><span class="ident" id="7030299">numFreeConns</span><span class="op" id="7030311">(</span><span class="op" id="7030312">)</span><span class="op" id="7030313">,</span>&nbsp;<span class="num" id="7030315">2</span><span class="op" id="7030316">;</span>&nbsp;<span class="ident" id="7030318">g</span>&nbsp;<span class="op" id="7030320">!=</span>&nbsp;<span class="ident" id="7030323">w</span>&nbsp;<span class="op" id="7030325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030329">t</span><span class="op" id="7030330">.</span><span class="ident" id="7030331">Errorf</span><span class="op" id="7030337">(</span><span class="string" id="7030338">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7030364">,</span>&nbsp;<span class="ident" id="7030366">g</span><span class="op" id="7030367">,</span>&nbsp;<span class="ident" id="7030369">w</span><span class="op" id="7030370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030377">if</span>&nbsp;<span class="ident" id="7030380">n</span>&nbsp;<span class="op" id="7030382">:=</span>&nbsp;<span class="ident" id="7030385">db</span><span class="op" id="7030387">.</span><span class="ident" id="7030388">numDepsPollUntil</span><span class="op" id="7030404">(</span><span class="num" id="7030405">2</span><span class="op" id="7030406">,</span>&nbsp;<span class="ident" id="7030408">time</span><span class="op" id="7030412">.</span><span class="ident" id="7030413">Second</span><span class="op" id="7030419">)</span><span class="op" id="7030420">;</span>&nbsp;<span class="ident" id="7030422">n</span>&nbsp;<span class="op" id="7030424">&gt;</span>&nbsp;<span class="num" id="7030426">2</span>&nbsp;<span class="op" id="7030428">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030432">t</span><span class="op" id="7030433">.</span><span class="ident" id="7030434">Errorf</span><span class="op" id="7030440">(</span><span class="string" id="7030441">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7030485">,</span>&nbsp;<span class="ident" id="7030487">n</span><span class="op" id="7030488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030492">db</span><span class="op" id="7030494">.</span><span class="ident" id="7030495">dumpDeps</span><span class="op" id="7030503">(</span><span class="ident" id="7030504">t</span><span class="op" id="7030505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030512">db</span><span class="op" id="7030514">.</span><span class="ident" id="7030515">SetMaxIdleConns</span><span class="op" id="7030530">(</span><span class="num" id="7030531">0</span><span class="op" id="7030532">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030536">if</span>&nbsp;<span class="ident" id="7030539">g</span><span class="op" id="7030540">,</span>&nbsp;<span class="ident" id="7030542">w</span>&nbsp;<span class="op" id="7030544">:=</span>&nbsp;<span class="ident" id="7030547">db</span><span class="op" id="7030549">.</span><span class="ident" id="7030550">numFreeConns</span><span class="op" id="7030562">(</span><span class="op" id="7030563">)</span><span class="op" id="7030564">,</span>&nbsp;<span class="num" id="7030566">0</span><span class="op" id="7030567">;</span>&nbsp;<span class="ident" id="7030569">g</span>&nbsp;<span class="op" id="7030571">!=</span>&nbsp;<span class="ident" id="7030574">w</span>&nbsp;<span class="op" id="7030576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030580">t</span><span class="op" id="7030581">.</span><span class="ident" id="7030582">Errorf</span><span class="op" id="7030588">(</span><span class="string" id="7030589">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7030615">,</span>&nbsp;<span class="ident" id="7030617">g</span><span class="op" id="7030618">,</span>&nbsp;<span class="ident" id="7030620">w</span><span class="op" id="7030621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030628">if</span>&nbsp;<span class="ident" id="7030631">n</span>&nbsp;<span class="op" id="7030633">:=</span>&nbsp;<span class="ident" id="7030636">db</span><span class="op" id="7030638">.</span><span class="ident" id="7030639">numDepsPollUntil</span><span class="op" id="7030655">(</span><span class="num" id="7030656">0</span><span class="op" id="7030657">,</span>&nbsp;<span class="ident" id="7030659">time</span><span class="op" id="7030663">.</span><span class="ident" id="7030664">Second</span><span class="op" id="7030670">)</span><span class="op" id="7030671">;</span>&nbsp;<span class="ident" id="7030673">n</span>&nbsp;<span class="op" id="7030675">&gt;</span>&nbsp;<span class="num" id="7030677">0</span>&nbsp;<span class="op" id="7030679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030683">t</span><span class="op" id="7030684">.</span><span class="ident" id="7030685">Errorf</span><span class="op" id="7030691">(</span><span class="string" id="7030692">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7030733">,</span>&nbsp;<span class="ident" id="7030735">n</span><span class="op" id="7030736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030740">db</span><span class="op" id="7030742">.</span><span class="ident" id="7030743">dumpDeps</span><span class="op" id="7030751">(</span><span class="ident" id="7030752">t</span><span class="op" id="7030753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7030756">}</span><br>
<span class="lineno"></span><span class="op" id="7030758">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7030761">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7030786">func</span>&nbsp;<span class="ident" id="7030791">TestCloseConnBeforeStmts</span><span class="op" id="7030815">(</span><span class="ident" id="7030816">t</span>&nbsp;<span class="op" id="7030818">*</span><span class="ident" id="7030819">testing</span><span class="op" id="7030826">.</span><span class="ident" id="7030827">T</span><span class="op" id="7030828">)</span>&nbsp;<span class="op" id="7030830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030833">db</span>&nbsp;<span class="op" id="7030836">:=</span>&nbsp;<span class="ident" id="7030839">newTestDB</span><span class="op" id="7030848">(</span><span class="ident" id="7030849">t</span><span class="op" id="7030850">,</span>&nbsp;<span class="string" id="7030852">&#34;people&#34;</span><span class="op" id="7030860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030863">defer</span>&nbsp;<span class="ident" id="7030869">closeDB</span><span class="op" id="7030876">(</span><span class="ident" id="7030877">t</span><span class="op" id="7030878">,</span>&nbsp;<span class="ident" id="7030880">db</span><span class="op" id="7030882">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030886">defer</span>&nbsp;<span class="ident" id="7030892">setHookpostCloseConn</span><span class="op" id="7030912">(</span><span class="ident" id="7030913">nil</span><span class="op" id="7030916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030919">setHookpostCloseConn</span><span class="op" id="7030939">(</span><span class="keyword" id="7030940">func</span><span class="op" id="7030944">(</span><span class="ident" id="7030945">_</span>&nbsp;<span class="op" id="7030947">*</span><span class="ident" id="7030948">fakeConn</span><span class="op" id="7030956">,</span>&nbsp;<span class="ident" id="7030958">err</span>&nbsp;<span class="builtintype" id="7030962">error</span><span class="op" id="7030967">)</span>&nbsp;<span class="op" id="7030969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7030973">if</span>&nbsp;<span class="ident" id="7030976">err</span>&nbsp;<span class="op" id="7030980">!=</span>&nbsp;<span class="ident" id="7030983">nil</span>&nbsp;<span class="op" id="7030987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7030992">t</span><span class="op" id="7030993">.</span><span class="ident" id="7030994">Errorf</span><span class="op" id="7031000">(</span><span class="string" id="7031001">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7031038">,</span>&nbsp;<span class="ident" id="7031040">err</span><span class="op" id="7031043">,</span>&nbsp;<span class="ident" id="7031045">stack</span><span class="op" id="7031050">(</span><span class="op" id="7031051">)</span><span class="op" id="7031052">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031057">db</span><span class="op" id="7031059">.</span><span class="ident" id="7031060">dumpDeps</span><span class="op" id="7031068">(</span><span class="ident" id="7031069">t</span><span class="op" id="7031070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031075">t</span><span class="op" id="7031076">.</span><span class="ident" id="7031077">Errorf</span><span class="op" id="7031083">(</span><span class="string" id="7031084">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7031094">,</span>&nbsp;<span class="ident" id="7031096">db</span><span class="op" id="7031098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031105">}</span><span class="op" id="7031106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031110">stmt</span><span class="op" id="7031114">,</span>&nbsp;<span class="ident" id="7031116">err</span>&nbsp;<span class="op" id="7031120">:=</span>&nbsp;<span class="ident" id="7031123">db</span><span class="op" id="7031125">.</span><span class="ident" id="7031126">Prepare</span><span class="op" id="7031133">(</span><span class="string" id="7031134">&#34;SELECT|people|name|&#34;</span><span class="op" id="7031155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031158">if</span>&nbsp;<span class="ident" id="7031161">err</span>&nbsp;<span class="op" id="7031165">!=</span>&nbsp;<span class="ident" id="7031168">nil</span>&nbsp;<span class="op" id="7031172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031176">t</span><span class="op" id="7031177">.</span><span class="ident" id="7031178">Fatal</span><span class="op" id="7031183">(</span><span class="ident" id="7031184">err</span><span class="op" id="7031187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031194">if</span>&nbsp;<span class="builtinfunc" id="7031197">len</span><span class="op" id="7031200">(</span><span class="ident" id="7031201">db</span><span class="op" id="7031203">.</span><span class="ident" id="7031204">freeConn</span><span class="op" id="7031212">)</span>&nbsp;<span class="op" id="7031214">!=</span>&nbsp;<span class="num" id="7031217">1</span>&nbsp;<span class="op" id="7031219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031223">t</span><span class="op" id="7031224">.</span><span class="ident" id="7031225">Fatalf</span><span class="op" id="7031231">(</span><span class="string" id="7031232">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7031261">,</span>&nbsp;<span class="builtinfunc" id="7031263">len</span><span class="op" id="7031266">(</span><span class="ident" id="7031267">db</span><span class="op" id="7031269">.</span><span class="ident" id="7031270">freeConn</span><span class="op" id="7031278">)</span><span class="op" id="7031279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031285">dc</span>&nbsp;<span class="op" id="7031288">:=</span>&nbsp;<span class="ident" id="7031291">db</span><span class="op" id="7031293">.</span><span class="ident" id="7031294">freeConn</span><span class="op" id="7031302">[</span><span class="num" id="7031303">0</span><span class="op" id="7031304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031307">if</span>&nbsp;<span class="ident" id="7031310">dc</span><span class="op" id="7031312">.</span><span class="ident" id="7031313">closed</span>&nbsp;<span class="op" id="7031320">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031324">t</span><span class="op" id="7031325">.</span><span class="ident" id="7031326">Errorf</span><span class="op" id="7031332">(</span><span class="string" id="7031333">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7031359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031366">if</span>&nbsp;<span class="ident" id="7031369">n</span>&nbsp;<span class="op" id="7031371">:=</span>&nbsp;<span class="builtinfunc" id="7031374">len</span><span class="op" id="7031377">(</span><span class="ident" id="7031378">dc</span><span class="op" id="7031380">.</span><span class="ident" id="7031381">openStmt</span><span class="op" id="7031389">)</span><span class="op" id="7031390">;</span>&nbsp;<span class="ident" id="7031392">n</span>&nbsp;<span class="op" id="7031394">!=</span>&nbsp;<span class="num" id="7031397">1</span>&nbsp;<span class="op" id="7031399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031403">t</span><span class="op" id="7031404">.</span><span class="ident" id="7031405">Errorf</span><span class="op" id="7031411">(</span><span class="string" id="7031412">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7031450">,</span>&nbsp;<span class="ident" id="7031452">n</span><span class="op" id="7031453">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031459">err</span>&nbsp;<span class="op" id="7031463">=</span>&nbsp;<span class="ident" id="7031465">db</span><span class="op" id="7031467">.</span><span class="ident" id="7031468">Close</span><span class="op" id="7031473">(</span><span class="op" id="7031474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031477">if</span>&nbsp;<span class="ident" id="7031480">err</span>&nbsp;<span class="op" id="7031484">!=</span>&nbsp;<span class="ident" id="7031487">nil</span>&nbsp;<span class="op" id="7031491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031495">t</span><span class="op" id="7031496">.</span><span class="ident" id="7031497">Errorf</span><span class="op" id="7031503">(</span><span class="string" id="7031504">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7031519">,</span>&nbsp;<span class="ident" id="7031521">err</span><span class="op" id="7031524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031527">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031530">if</span>&nbsp;<span class="op" id="7031533">!</span><span class="ident" id="7031534">dc</span><span class="op" id="7031536">.</span><span class="ident" id="7031537">closed</span>&nbsp;<span class="op" id="7031544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031548">t</span><span class="op" id="7031549">.</span><span class="ident" id="7031550">Errorf</span><span class="op" id="7031556">(</span><span class="string" id="7031557">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7031602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031608">if</span>&nbsp;<span class="ident" id="7031611">n</span>&nbsp;<span class="op" id="7031613">:=</span>&nbsp;<span class="builtinfunc" id="7031616">len</span><span class="op" id="7031619">(</span><span class="ident" id="7031620">dc</span><span class="op" id="7031622">.</span><span class="ident" id="7031623">openStmt</span><span class="op" id="7031631">)</span><span class="op" id="7031632">;</span>&nbsp;<span class="ident" id="7031634">n</span>&nbsp;<span class="op" id="7031636">!=</span>&nbsp;<span class="num" id="7031639">0</span>&nbsp;<span class="op" id="7031641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031645">t</span><span class="op" id="7031646">.</span><span class="ident" id="7031647">Errorf</span><span class="op" id="7031653">(</span><span class="string" id="7031654">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7031692">,</span>&nbsp;<span class="ident" id="7031694">n</span><span class="op" id="7031695">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031702">err</span>&nbsp;<span class="op" id="7031706">=</span>&nbsp;<span class="ident" id="7031708">stmt</span><span class="op" id="7031712">.</span><span class="ident" id="7031713">Close</span><span class="op" id="7031718">(</span><span class="op" id="7031719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031722">if</span>&nbsp;<span class="ident" id="7031725">err</span>&nbsp;<span class="op" id="7031729">!=</span>&nbsp;<span class="ident" id="7031732">nil</span>&nbsp;<span class="op" id="7031736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031740">t</span><span class="op" id="7031741">.</span><span class="ident" id="7031742">Errorf</span><span class="op" id="7031748">(</span><span class="string" id="7031749">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7031766">,</span>&nbsp;<span class="ident" id="7031768">err</span><span class="op" id="7031771">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031778">if</span>&nbsp;<span class="op" id="7031781">!</span><span class="ident" id="7031782">dc</span><span class="op" id="7031784">.</span><span class="ident" id="7031785">closed</span>&nbsp;<span class="op" id="7031792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031796">t</span><span class="op" id="7031797">.</span><span class="ident" id="7031798">Errorf</span><span class="op" id="7031804">(</span><span class="string" id="7031805">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7031828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031831">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7031834">if</span>&nbsp;<span class="ident" id="7031837">dc</span><span class="op" id="7031839">.</span><span class="ident" id="7031840">ci</span>&nbsp;<span class="op" id="7031843">!=</span>&nbsp;<span class="ident" id="7031846">nil</span>&nbsp;<span class="op" id="7031850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7031854">t</span><span class="op" id="7031855">.</span><span class="ident" id="7031856">Errorf</span><span class="op" id="7031862">(</span><span class="string" id="7031863">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7031924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7031927">}</span><br>
<span class="lineno"></span><span class="op" id="7031929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7031932">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7032002">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7032032">func</span>&nbsp;<span class="ident" id="7032037">TestRowsCloseOrder</span><span class="op" id="7032055">(</span><span class="ident" id="7032056">t</span>&nbsp;<span class="op" id="7032058">*</span><span class="ident" id="7032059">testing</span><span class="op" id="7032066">.</span><span class="ident" id="7032067">T</span><span class="op" id="7032068">)</span>&nbsp;<span class="op" id="7032070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032073">db</span>&nbsp;<span class="op" id="7032076">:=</span>&nbsp;<span class="ident" id="7032079">newTestDB</span><span class="op" id="7032088">(</span><span class="ident" id="7032089">t</span><span class="op" id="7032090">,</span>&nbsp;<span class="string" id="7032092">&#34;people&#34;</span><span class="op" id="7032100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032103">defer</span>&nbsp;<span class="ident" id="7032109">closeDB</span><span class="op" id="7032116">(</span><span class="ident" id="7032117">t</span><span class="op" id="7032118">,</span>&nbsp;<span class="ident" id="7032120">db</span><span class="op" id="7032122">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032126">db</span><span class="op" id="7032128">.</span><span class="ident" id="7032129">SetMaxIdleConns</span><span class="op" id="7032144">(</span><span class="num" id="7032145">0</span><span class="op" id="7032146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032149">setStrictFakeConnClose</span><span class="op" id="7032171">(</span><span class="ident" id="7032172">t</span><span class="op" id="7032173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032176">defer</span>&nbsp;<span class="ident" id="7032182">setStrictFakeConnClose</span><span class="op" id="7032204">(</span><span class="ident" id="7032205">nil</span><span class="op" id="7032208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032212">rows</span><span class="op" id="7032216">,</span>&nbsp;<span class="ident" id="7032218">err</span>&nbsp;<span class="op" id="7032222">:=</span>&nbsp;<span class="ident" id="7032225">db</span><span class="op" id="7032227">.</span><span class="ident" id="7032228">Query</span><span class="op" id="7032233">(</span><span class="string" id="7032234">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7032259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032262">if</span>&nbsp;<span class="ident" id="7032265">err</span>&nbsp;<span class="op" id="7032269">!=</span>&nbsp;<span class="ident" id="7032272">nil</span>&nbsp;<span class="op" id="7032276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032280">t</span><span class="op" id="7032281">.</span><span class="ident" id="7032282">Fatal</span><span class="op" id="7032287">(</span><span class="ident" id="7032288">err</span><span class="op" id="7032291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032297">err</span>&nbsp;<span class="op" id="7032301">=</span>&nbsp;<span class="ident" id="7032303">rows</span><span class="op" id="7032307">.</span><span class="ident" id="7032308">Close</span><span class="op" id="7032313">(</span><span class="op" id="7032314">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032317">if</span>&nbsp;<span class="ident" id="7032320">err</span>&nbsp;<span class="op" id="7032324">!=</span>&nbsp;<span class="ident" id="7032327">nil</span>&nbsp;<span class="op" id="7032331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032335">t</span><span class="op" id="7032336">.</span><span class="ident" id="7032337">Fatal</span><span class="op" id="7032342">(</span><span class="ident" id="7032343">err</span><span class="op" id="7032346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032349">}</span><br>
<span class="lineno"></span><span class="op" id="7032351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7032354">func</span>&nbsp;<span class="ident" id="7032359">TestRowsImplicitClose</span><span class="op" id="7032380">(</span><span class="ident" id="7032381">t</span>&nbsp;<span class="op" id="7032383">*</span><span class="ident" id="7032384">testing</span><span class="op" id="7032391">.</span><span class="ident" id="7032392">T</span><span class="op" id="7032393">)</span>&nbsp;<span class="op" id="7032395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032398">db</span>&nbsp;<span class="op" id="7032401">:=</span>&nbsp;<span class="ident" id="7032404">newTestDB</span><span class="op" id="7032413">(</span><span class="ident" id="7032414">t</span><span class="op" id="7032415">,</span>&nbsp;<span class="string" id="7032417">&#34;people&#34;</span><span class="op" id="7032425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032428">defer</span>&nbsp;<span class="ident" id="7032434">closeDB</span><span class="op" id="7032441">(</span><span class="ident" id="7032442">t</span><span class="op" id="7032443">,</span>&nbsp;<span class="ident" id="7032445">db</span><span class="op" id="7032447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032451">rows</span><span class="op" id="7032455">,</span>&nbsp;<span class="ident" id="7032457">err</span>&nbsp;<span class="op" id="7032461">:=</span>&nbsp;<span class="ident" id="7032464">db</span><span class="op" id="7032466">.</span><span class="ident" id="7032467">Query</span><span class="op" id="7032472">(</span><span class="string" id="7032473">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7032498">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032501">if</span>&nbsp;<span class="ident" id="7032504">err</span>&nbsp;<span class="op" id="7032508">!=</span>&nbsp;<span class="ident" id="7032511">nil</span>&nbsp;<span class="op" id="7032515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032519">t</span><span class="op" id="7032520">.</span><span class="ident" id="7032521">Fatal</span><span class="op" id="7032526">(</span><span class="ident" id="7032527">err</span><span class="op" id="7032530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032537">want</span><span class="op" id="7032541">,</span>&nbsp;<span class="ident" id="7032543">fail</span>&nbsp;<span class="op" id="7032548">:=</span>&nbsp;<span class="num" id="7032551">2</span><span class="op" id="7032552">,</span>&nbsp;<span class="ident" id="7032554">errors</span><span class="op" id="7032560">.</span><span class="ident" id="7032561">New</span><span class="op" id="7032564">(</span><span class="string" id="7032565">&#34;fail&#34;</span><span class="op" id="7032571">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032574">r</span>&nbsp;<span class="op" id="7032576">:=</span>&nbsp;<span class="ident" id="7032579">rows</span><span class="op" id="7032583">.</span><span class="ident" id="7032584">rowsi</span><span class="op" id="7032589">.</span><span class="op" id="7032590">(</span><span class="op" id="7032591">*</span><span class="ident" id="7032592">rowsCursor</span><span class="op" id="7032602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032605">r</span><span class="op" id="7032606">.</span><span class="ident" id="7032607">errPos</span><span class="op" id="7032613">,</span>&nbsp;<span class="ident" id="7032615">r</span><span class="op" id="7032616">.</span><span class="ident" id="7032617">err</span>&nbsp;<span class="op" id="7032621">=</span>&nbsp;<span class="ident" id="7032623">want</span><span class="op" id="7032627">,</span>&nbsp;<span class="ident" id="7032629">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032636">got</span>&nbsp;<span class="op" id="7032640">:=</span>&nbsp;<span class="num" id="7032643">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032646">for</span>&nbsp;<span class="ident" id="7032650">rows</span><span class="op" id="7032654">.</span><span class="ident" id="7032655">Next</span><span class="op" id="7032659">(</span><span class="op" id="7032660">)</span>&nbsp;<span class="op" id="7032662">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032666">got</span><span class="op" id="7032669">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032676">if</span>&nbsp;<span class="ident" id="7032679">got</span>&nbsp;<span class="op" id="7032683">!=</span>&nbsp;<span class="ident" id="7032686">want</span>&nbsp;<span class="op" id="7032691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032695">t</span><span class="op" id="7032696">.</span><span class="ident" id="7032697">Errorf</span><span class="op" id="7032703">(</span><span class="string" id="7032704">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7032726">,</span>&nbsp;<span class="ident" id="7032728">got</span><span class="op" id="7032731">,</span>&nbsp;<span class="ident" id="7032733">want</span><span class="op" id="7032737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032740">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032743">if</span>&nbsp;<span class="ident" id="7032746">err</span>&nbsp;<span class="op" id="7032750">:=</span>&nbsp;<span class="ident" id="7032753">rows</span><span class="op" id="7032757">.</span><span class="ident" id="7032758">Err</span><span class="op" id="7032761">(</span><span class="op" id="7032762">)</span><span class="op" id="7032763">;</span>&nbsp;<span class="ident" id="7032765">err</span>&nbsp;<span class="op" id="7032769">!=</span>&nbsp;<span class="ident" id="7032772">fail</span>&nbsp;<span class="op" id="7032777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032781">t</span><span class="op" id="7032782">.</span><span class="ident" id="7032783">Errorf</span><span class="op" id="7032789">(</span><span class="string" id="7032790">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7032813">,</span>&nbsp;<span class="ident" id="7032815">err</span><span class="op" id="7032818">,</span>&nbsp;<span class="ident" id="7032820">fail</span><span class="op" id="7032824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032830">if</span>&nbsp;<span class="op" id="7032833">!</span><span class="ident" id="7032834">r</span><span class="op" id="7032835">.</span><span class="ident" id="7032836">closed</span>&nbsp;<span class="op" id="7032843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032847">t</span><span class="op" id="7032848">.</span><span class="ident" id="7032849">Errorf</span><span class="op" id="7032855">(</span><span class="string" id="7032856">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7032886">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7032889">}</span><br>
<span class="lineno"></span><span class="op" id="7032891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7032894">func</span>&nbsp;<span class="ident" id="7032899">TestStmtCloseOrder</span><span class="op" id="7032917">(</span><span class="ident" id="7032918">t</span>&nbsp;<span class="op" id="7032920">*</span><span class="ident" id="7032921">testing</span><span class="op" id="7032928">.</span><span class="ident" id="7032929">T</span><span class="op" id="7032930">)</span>&nbsp;<span class="op" id="7032932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032935">db</span>&nbsp;<span class="op" id="7032938">:=</span>&nbsp;<span class="ident" id="7032941">newTestDB</span><span class="op" id="7032950">(</span><span class="ident" id="7032951">t</span><span class="op" id="7032952">,</span>&nbsp;<span class="string" id="7032954">&#34;people&#34;</span><span class="op" id="7032962">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7032965">defer</span>&nbsp;<span class="ident" id="7032971">closeDB</span><span class="op" id="7032978">(</span><span class="ident" id="7032979">t</span><span class="op" id="7032980">,</span>&nbsp;<span class="ident" id="7032982">db</span><span class="op" id="7032984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7032988">db</span><span class="op" id="7032990">.</span><span class="ident" id="7032991">SetMaxIdleConns</span><span class="op" id="7033006">(</span><span class="num" id="7033007">0</span><span class="op" id="7033008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033011">setStrictFakeConnClose</span><span class="op" id="7033033">(</span><span class="ident" id="7033034">t</span><span class="op" id="7033035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033038">defer</span>&nbsp;<span class="ident" id="7033044">setStrictFakeConnClose</span><span class="op" id="7033066">(</span><span class="ident" id="7033067">nil</span><span class="op" id="7033070">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033074">_</span><span class="op" id="7033075">,</span>&nbsp;<span class="ident" id="7033077">err</span>&nbsp;<span class="op" id="7033081">:=</span>&nbsp;<span class="ident" id="7033084">db</span><span class="op" id="7033086">.</span><span class="ident" id="7033087">Query</span><span class="op" id="7033092">(</span><span class="string" id="7033093">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7033120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033123">if</span>&nbsp;<span class="ident" id="7033126">err</span>&nbsp;<span class="op" id="7033130">==</span>&nbsp;<span class="ident" id="7033133">nil</span>&nbsp;<span class="op" id="7033137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033141">t</span><span class="op" id="7033142">.</span><span class="ident" id="7033143">Fatal</span><span class="op" id="7033148">(</span><span class="string" id="7033149">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7033189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033192">}</span><br>
<span class="lineno">1315</span><span class="op" id="7033194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7033197">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7033222">func</span>&nbsp;<span class="ident" id="7033227">TestErrBadConnReconnect</span><span class="op" id="7033250">(</span><span class="ident" id="7033251">t</span>&nbsp;<span class="op" id="7033253">*</span><span class="ident" id="7033254">testing</span><span class="op" id="7033261">.</span><span class="ident" id="7033262">T</span><span class="op" id="7033263">)</span>&nbsp;<span class="op" id="7033265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033268">db</span>&nbsp;<span class="op" id="7033271">:=</span>&nbsp;<span class="ident" id="7033274">newTestDB</span><span class="op" id="7033283">(</span><span class="ident" id="7033284">t</span><span class="op" id="7033285">,</span>&nbsp;<span class="string" id="7033287">&#34;foo&#34;</span><span class="op" id="7033292">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033295">defer</span>&nbsp;<span class="ident" id="7033301">closeDB</span><span class="op" id="7033308">(</span><span class="ident" id="7033309">t</span><span class="op" id="7033310">,</span>&nbsp;<span class="ident" id="7033312">db</span><span class="op" id="7033314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033317">exec</span><span class="op" id="7033321">(</span><span class="ident" id="7033322">t</span><span class="op" id="7033323">,</span>&nbsp;<span class="ident" id="7033325">db</span><span class="op" id="7033327">,</span>&nbsp;<span class="string" id="7033329">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7033372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033376">simulateBadConn</span>&nbsp;<span class="op" id="7033392">:=</span>&nbsp;<span class="keyword" id="7033395">func</span><span class="op" id="7033399">(</span><span class="ident" id="7033400">name</span>&nbsp;<span class="builtintype" id="7033405">string</span><span class="op" id="7033411">,</span>&nbsp;<span class="ident" id="7033413">hook</span>&nbsp;<span class="op" id="7033418">*</span><span class="keyword" id="7033419">func</span><span class="op" id="7033423">(</span><span class="op" id="7033424">)</span>&nbsp;<span class="builtintype" id="7033426">bool</span><span class="op" id="7033430">,</span>&nbsp;<span class="ident" id="7033432">op</span>&nbsp;<span class="keyword" id="7033435">func</span><span class="op" id="7033439">(</span><span class="op" id="7033440">)</span>&nbsp;<span class="builtintype" id="7033442">error</span><span class="op" id="7033447">)</span>&nbsp;<span class="op" id="7033449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033453">broken</span><span class="op" id="7033459">,</span>&nbsp;<span class="ident" id="7033461">retried</span>&nbsp;<span class="op" id="7033469">:=</span>&nbsp;<span class="builtintype" id="7033472">false</span><span class="op" id="7033477">,</span>&nbsp;<span class="builtintype" id="7033479">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033487">numOpen</span>&nbsp;<span class="op" id="7033495">:=</span>&nbsp;<span class="ident" id="7033498">db</span><span class="op" id="7033500">.</span><span class="ident" id="7033501">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7033512">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033563">*</span><span class="ident" id="7033564">hook</span>&nbsp;<span class="op" id="7033569">=</span>&nbsp;<span class="keyword" id="7033571">func</span><span class="op" id="7033575">(</span><span class="op" id="7033576">)</span>&nbsp;<span class="builtintype" id="7033578">bool</span>&nbsp;<span class="op" id="7033583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033588">if</span>&nbsp;<span class="op" id="7033591">!</span><span class="ident" id="7033592">broken</span>&nbsp;<span class="op" id="7033599">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033605">broken</span>&nbsp;<span class="op" id="7033612">=</span>&nbsp;<span class="builtintype" id="7033614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033623">return</span>&nbsp;<span class="builtintype" id="7033630">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033643">retried</span>&nbsp;<span class="op" id="7033651">=</span>&nbsp;<span class="builtintype" id="7033653">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033661">return</span>&nbsp;<span class="builtintype" id="7033668">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033681">if</span>&nbsp;<span class="ident" id="7033684">err</span>&nbsp;<span class="op" id="7033688">:=</span>&nbsp;<span class="ident" id="7033691">op</span><span class="op" id="7033693">(</span><span class="op" id="7033694">)</span><span class="op" id="7033695">;</span>&nbsp;<span class="ident" id="7033697">err</span>&nbsp;<span class="op" id="7033701">!=</span>&nbsp;<span class="ident" id="7033704">nil</span>&nbsp;<span class="op" id="7033708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033713">t</span><span class="op" id="7033714">.</span><span class="ident" id="7033715">Errorf</span><span class="op" id="7033721">(</span><span class="ident" id="7033722">name</span><span class="op" id="7033726">+</span><span class="string" id="7033727">&#34;:&nbsp;%v&#34;</span><span class="op" id="7033733">,</span>&nbsp;<span class="ident" id="7033735">err</span><span class="op" id="7033738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033743">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033757">if</span>&nbsp;<span class="op" id="7033760">!</span><span class="ident" id="7033761">broken</span>&nbsp;<span class="op" id="7033768">||</span>&nbsp;<span class="op" id="7033771">!</span><span class="ident" id="7033772">retried</span>&nbsp;<span class="op" id="7033780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033785">t</span><span class="op" id="7033786">.</span><span class="ident" id="7033787">Error</span><span class="op" id="7033792">(</span><span class="ident" id="7033793">name</span>&nbsp;<span class="op" id="7033798">+</span>&nbsp;<span class="string" id="7033800">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7033840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033844">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033848">*</span><span class="ident" id="7033849">hook</span>&nbsp;<span class="op" id="7033854">=</span>&nbsp;<span class="ident" id="7033856">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7033863">if</span>&nbsp;<span class="ident" id="7033866">numOpen</span>&nbsp;<span class="op" id="7033874">!=</span>&nbsp;<span class="ident" id="7033877">db</span><span class="op" id="7033879">.</span><span class="ident" id="7033880">numOpen</span>&nbsp;<span class="op" id="7033888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033893">t</span><span class="op" id="7033894">.</span><span class="ident" id="7033895">Errorf</span><span class="op" id="7033901">(</span><span class="ident" id="7033902">name</span><span class="op" id="7033906">+</span><span class="string" id="7033907">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7033935">,</span>&nbsp;<span class="ident" id="7033937">db</span><span class="op" id="7033939">.</span><span class="ident" id="7033940">numOpen</span><span class="op" id="7033947">-</span><span class="ident" id="7033948">numOpen</span><span class="op" id="7033955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7033960">numOpen</span>&nbsp;<span class="op" id="7033968">=</span>&nbsp;<span class="ident" id="7033970">db</span><span class="op" id="7033972">.</span><span class="ident" id="7033973">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7033986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7033990">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034002">dbExec</span>&nbsp;<span class="op" id="7034009">:=</span>&nbsp;<span class="keyword" id="7034012">func</span><span class="op" id="7034016">(</span><span class="op" id="7034017">)</span>&nbsp;<span class="builtintype" id="7034019">error</span>&nbsp;<span class="op" id="7034025">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034029">_</span><span class="op" id="7034030">,</span>&nbsp;<span class="ident" id="7034032">err</span>&nbsp;<span class="op" id="7034036">:=</span>&nbsp;<span class="ident" id="7034039">db</span><span class="op" id="7034041">.</span><span class="ident" id="7034042">Exec</span><span class="op" id="7034046">(</span><span class="string" id="7034047">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7034078">,</span>&nbsp;<span class="string" id="7034080">&#34;Gordon&#34;</span><span class="op" id="7034088">,</span>&nbsp;<span class="num" id="7034090">3</span><span class="op" id="7034091">,</span>&nbsp;<span class="builtintype" id="7034093">true</span><span class="op" id="7034097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034101">return</span>&nbsp;<span class="ident" id="7034108">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034116">simulateBadConn</span><span class="op" id="7034131">(</span><span class="string" id="7034132">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7034149">,</span>&nbsp;<span class="op" id="7034151">&amp;</span><span class="ident" id="7034152">hookPrepareBadConn</span><span class="op" id="7034170">,</span>&nbsp;<span class="ident" id="7034172">dbExec</span><span class="op" id="7034178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034181">simulateBadConn</span><span class="op" id="7034196">(</span><span class="string" id="7034197">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7034211">,</span>&nbsp;<span class="op" id="7034213">&amp;</span><span class="ident" id="7034214">hookExecBadConn</span><span class="op" id="7034229">,</span>&nbsp;<span class="ident" id="7034231">dbExec</span><span class="op" id="7034237">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7034241">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034254">dbQuery</span>&nbsp;<span class="op" id="7034262">:=</span>&nbsp;<span class="keyword" id="7034265">func</span><span class="op" id="7034269">(</span><span class="op" id="7034270">)</span>&nbsp;<span class="builtintype" id="7034272">error</span>&nbsp;<span class="op" id="7034278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034282">rows</span><span class="op" id="7034286">,</span>&nbsp;<span class="ident" id="7034288">err</span>&nbsp;<span class="op" id="7034292">:=</span>&nbsp;<span class="ident" id="7034295">db</span><span class="op" id="7034297">.</span><span class="ident" id="7034298">Query</span><span class="op" id="7034303">(</span><span class="string" id="7034304">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7034325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034329">if</span>&nbsp;<span class="ident" id="7034332">err</span>&nbsp;<span class="op" id="7034336">==</span>&nbsp;<span class="ident" id="7034339">nil</span>&nbsp;<span class="op" id="7034343">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034348">err</span>&nbsp;<span class="op" id="7034352">=</span>&nbsp;<span class="ident" id="7034354">rows</span><span class="op" id="7034358">.</span><span class="ident" id="7034359">Close</span><span class="op" id="7034364">(</span><span class="op" id="7034365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034373">return</span>&nbsp;<span class="ident" id="7034380">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034388">simulateBadConn</span><span class="op" id="7034403">(</span><span class="string" id="7034404">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7034422">,</span>&nbsp;<span class="op" id="7034424">&amp;</span><span class="ident" id="7034425">hookPrepareBadConn</span><span class="op" id="7034443">,</span>&nbsp;<span class="ident" id="7034445">dbQuery</span><span class="op" id="7034452">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034455">simulateBadConn</span><span class="op" id="7034470">(</span><span class="string" id="7034471">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7034487">,</span>&nbsp;<span class="op" id="7034489">&amp;</span><span class="ident" id="7034490">hookQueryBadConn</span><span class="op" id="7034506">,</span>&nbsp;<span class="ident" id="7034508">dbQuery</span><span class="op" id="7034515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7034519">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034534">simulateBadConn</span><span class="op" id="7034549">(</span><span class="string" id="7034550">&#34;db.Prepare&#34;</span><span class="op" id="7034562">,</span>&nbsp;<span class="op" id="7034564">&amp;</span><span class="ident" id="7034565">hookPrepareBadConn</span><span class="op" id="7034583">,</span>&nbsp;<span class="keyword" id="7034585">func</span><span class="op" id="7034589">(</span><span class="op" id="7034590">)</span>&nbsp;<span class="builtintype" id="7034592">error</span>&nbsp;<span class="op" id="7034598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034602">stmt</span><span class="op" id="7034606">,</span>&nbsp;<span class="ident" id="7034608">err</span>&nbsp;<span class="op" id="7034612">:=</span>&nbsp;<span class="ident" id="7034615">db</span><span class="op" id="7034617">.</span><span class="ident" id="7034618">Prepare</span><span class="op" id="7034625">(</span><span class="string" id="7034626">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7034657">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034661">if</span>&nbsp;<span class="ident" id="7034664">err</span>&nbsp;<span class="op" id="7034668">!=</span>&nbsp;<span class="ident" id="7034671">nil</span>&nbsp;<span class="op" id="7034675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034680">return</span>&nbsp;<span class="ident" id="7034687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034697">stmt</span><span class="op" id="7034701">.</span><span class="ident" id="7034702">Close</span><span class="op" id="7034707">(</span><span class="op" id="7034708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034712">return</span>&nbsp;<span class="ident" id="7034719">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034724">}</span><span class="op" id="7034725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7034729">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034802">forcePrepare</span>&nbsp;<span class="op" id="7034815">:=</span>&nbsp;<span class="keyword" id="7034818">func</span><span class="op" id="7034822">(</span><span class="ident" id="7034823">stmt</span>&nbsp;<span class="op" id="7034828">*</span><span class="ident" id="7034829">Stmt</span><span class="op" id="7034833">)</span>&nbsp;<span class="op" id="7034835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034839">stmt</span><span class="op" id="7034843">.</span><span class="ident" id="7034844">css</span>&nbsp;<span class="op" id="7034848">=</span>&nbsp;<span class="ident" id="7034850">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7034859">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034873">stmt1</span><span class="op" id="7034878">,</span>&nbsp;<span class="ident" id="7034880">err</span>&nbsp;<span class="op" id="7034884">:=</span>&nbsp;<span class="ident" id="7034887">db</span><span class="op" id="7034889">.</span><span class="ident" id="7034890">Prepare</span><span class="op" id="7034897">(</span><span class="string" id="7034898">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7034929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034932">if</span>&nbsp;<span class="ident" id="7034935">err</span>&nbsp;<span class="op" id="7034939">!=</span>&nbsp;<span class="ident" id="7034942">nil</span>&nbsp;<span class="op" id="7034946">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7034950">t</span><span class="op" id="7034951">.</span><span class="ident" id="7034952">Fatalf</span><span class="op" id="7034958">(</span><span class="string" id="7034959">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7034972">,</span>&nbsp;<span class="ident" id="7034974">err</span><span class="op" id="7034977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7034980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7034983">defer</span>&nbsp;<span class="ident" id="7034989">stmt1</span><span class="op" id="7034994">.</span><span class="ident" id="7034995">Close</span><span class="op" id="7035000">(</span><span class="op" id="7035001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7035004">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035049">forcePrepare</span><span class="op" id="7035061">(</span><span class="ident" id="7035062">stmt1</span><span class="op" id="7035067">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035071">stmtExec</span>&nbsp;<span class="op" id="7035080">:=</span>&nbsp;<span class="keyword" id="7035083">func</span><span class="op" id="7035087">(</span><span class="op" id="7035088">)</span>&nbsp;<span class="builtintype" id="7035090">error</span>&nbsp;<span class="op" id="7035096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035100">_</span><span class="op" id="7035101">,</span>&nbsp;<span class="ident" id="7035103">err</span>&nbsp;<span class="op" id="7035107">:=</span>&nbsp;<span class="ident" id="7035110">stmt1</span><span class="op" id="7035115">.</span><span class="ident" id="7035116">Exec</span><span class="op" id="7035120">(</span><span class="string" id="7035121">&#34;Gopher&#34;</span><span class="op" id="7035129">,</span>&nbsp;<span class="num" id="7035131">3</span><span class="op" id="7035132">,</span>&nbsp;<span class="builtintype" id="7035134">false</span><span class="op" id="7035139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7035143">return</span>&nbsp;<span class="ident" id="7035150">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7035155">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035158">simulateBadConn</span><span class="op" id="7035173">(</span><span class="string" id="7035174">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7035193">,</span>&nbsp;<span class="op" id="7035195">&amp;</span><span class="ident" id="7035196">hookPrepareBadConn</span><span class="op" id="7035214">,</span>&nbsp;<span class="ident" id="7035216">stmtExec</span><span class="op" id="7035224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035227">simulateBadConn</span><span class="op" id="7035242">(</span><span class="string" id="7035243">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7035259">,</span>&nbsp;<span class="op" id="7035261">&amp;</span><span class="ident" id="7035262">hookExecBadConn</span><span class="op" id="7035277">,</span>&nbsp;<span class="ident" id="7035279">stmtExec</span><span class="op" id="7035287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7035291">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035306">stmt2</span><span class="op" id="7035311">,</span>&nbsp;<span class="ident" id="7035313">err</span>&nbsp;<span class="op" id="7035317">:=</span>&nbsp;<span class="ident" id="7035320">db</span><span class="op" id="7035322">.</span><span class="ident" id="7035323">Prepare</span><span class="op" id="7035330">(</span><span class="string" id="7035331">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7035352">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7035355">if</span>&nbsp;<span class="ident" id="7035358">err</span>&nbsp;<span class="op" id="7035362">!=</span>&nbsp;<span class="ident" id="7035365">nil</span>&nbsp;<span class="op" id="7035369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035373">t</span><span class="op" id="7035374">.</span><span class="ident" id="7035375">Fatalf</span><span class="op" id="7035381">(</span><span class="string" id="7035382">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7035395">,</span>&nbsp;<span class="ident" id="7035397">err</span><span class="op" id="7035400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7035403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7035406">defer</span>&nbsp;<span class="ident" id="7035412">stmt2</span><span class="op" id="7035417">.</span><span class="ident" id="7035418">Close</span><span class="op" id="7035423">(</span><span class="op" id="7035424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7035427">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035472">forcePrepare</span><span class="op" id="7035484">(</span><span class="ident" id="7035485">stmt2</span><span class="op" id="7035490">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035494">stmtQuery</span>&nbsp;<span class="op" id="7035504">:=</span>&nbsp;<span class="keyword" id="7035507">func</span><span class="op" id="7035511">(</span><span class="op" id="7035512">)</span>&nbsp;<span class="builtintype" id="7035514">error</span>&nbsp;<span class="op" id="7035520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035524">rows</span><span class="op" id="7035528">,</span>&nbsp;<span class="ident" id="7035530">err</span>&nbsp;<span class="op" id="7035534">:=</span>&nbsp;<span class="ident" id="7035537">stmt2</span><span class="op" id="7035542">.</span><span class="ident" id="7035543">Query</span><span class="op" id="7035548">(</span><span class="op" id="7035549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7035553">if</span>&nbsp;<span class="ident" id="7035556">err</span>&nbsp;<span class="op" id="7035560">==</span>&nbsp;<span class="ident" id="7035563">nil</span>&nbsp;<span class="op" id="7035567">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035572">err</span>&nbsp;<span class="op" id="7035576">=</span>&nbsp;<span class="ident" id="7035578">rows</span><span class="op" id="7035582">.</span><span class="ident" id="7035583">Close</span><span class="op" id="7035588">(</span><span class="op" id="7035589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7035593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7035597">return</span>&nbsp;<span class="ident" id="7035604">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7035609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035612">simulateBadConn</span><span class="op" id="7035627">(</span><span class="string" id="7035628">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7035648">,</span>&nbsp;<span class="op" id="7035650">&amp;</span><span class="ident" id="7035651">hookPrepareBadConn</span><span class="op" id="7035669">,</span>&nbsp;<span class="ident" id="7035671">stmtQuery</span><span class="op" id="7035680">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035683">simulateBadConn</span><span class="op" id="7035698">(</span><span class="string" id="7035699">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7035716">,</span>&nbsp;<span class="op" id="7035718">&amp;</span><span class="ident" id="7035719">hookQueryBadConn</span><span class="op" id="7035735">,</span>&nbsp;<span class="ident" id="7035737">stmtQuery</span><span class="op" id="7035746">)</span><br>
<span class="lineno"></span><span class="op" id="7035748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7035751">type</span>&nbsp;<span class="ident" id="7035756">concurrentTest</span>&nbsp;<span class="keyword" id="7035771">interface</span>&nbsp;<span class="op" id="7035781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035784">init</span><span class="op" id="7035788">(</span><span class="ident" id="7035789">t</span>&nbsp;<span class="ident" id="7035791">testing</span><span class="op" id="7035798">.</span><span class="ident" id="7035799">TB</span><span class="op" id="7035801">,</span>&nbsp;<span class="ident" id="7035803">db</span>&nbsp;<span class="op" id="7035806">*</span><span class="ident" id="7035807">DB</span><span class="op" id="7035809">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035812">finish</span><span class="op" id="7035818">(</span><span class="ident" id="7035819">t</span>&nbsp;<span class="ident" id="7035821">testing</span><span class="op" id="7035828">.</span><span class="ident" id="7035829">TB</span><span class="op" id="7035831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035834">test</span><span class="op" id="7035838">(</span><span class="ident" id="7035839">t</span>&nbsp;<span class="ident" id="7035841">testing</span><span class="op" id="7035848">.</span><span class="ident" id="7035849">TB</span><span class="op" id="7035851">)</span>&nbsp;<span class="builtintype" id="7035853">error</span><br>
<span class="lineno"></span><span class="op" id="7035859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7035862">type</span>&nbsp;<span class="ident" id="7035867">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7035889">struct</span>&nbsp;<span class="op" id="7035896">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035899">db</span>&nbsp;<span class="op" id="7035902">*</span><span class="ident" id="7035903">DB</span><br>
<span class="lineno"></span><span class="op" id="7035906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7035909">func</span>&nbsp;<span class="op" id="7035914">(</span><span class="ident" id="7035915">c</span>&nbsp;<span class="op" id="7035917">*</span><span class="ident" id="7035918">concurrentDBQueryTest</span><span class="op" id="7035939">)</span>&nbsp;<span class="ident" id="7035941">init</span><span class="op" id="7035945">(</span><span class="ident" id="7035946">t</span>&nbsp;<span class="ident" id="7035948">testing</span><span class="op" id="7035955">.</span><span class="ident" id="7035956">TB</span><span class="op" id="7035958">,</span>&nbsp;<span class="ident" id="7035960">db</span>&nbsp;<span class="op" id="7035963">*</span><span class="ident" id="7035964">DB</span><span class="op" id="7035966">)</span>&nbsp;<span class="op" id="7035968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7035971">c</span><span class="op" id="7035972">.</span><span class="ident" id="7035973">db</span>&nbsp;<span class="op" id="7035976">=</span>&nbsp;<span class="ident" id="7035978">db</span><br>
<span class="lineno">1435</span><span class="op" id="7035981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7035984">func</span>&nbsp;<span class="op" id="7035989">(</span><span class="ident" id="7035990">c</span>&nbsp;<span class="op" id="7035992">*</span><span class="ident" id="7035993">concurrentDBQueryTest</span><span class="op" id="7036014">)</span>&nbsp;<span class="ident" id="7036016">finish</span><span class="op" id="7036022">(</span><span class="ident" id="7036023">t</span>&nbsp;<span class="ident" id="7036025">testing</span><span class="op" id="7036032">.</span><span class="ident" id="7036033">TB</span><span class="op" id="7036035">)</span>&nbsp;<span class="op" id="7036037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036040">c</span><span class="op" id="7036041">.</span><span class="ident" id="7036042">db</span>&nbsp;<span class="op" id="7036045">=</span>&nbsp;<span class="ident" id="7036047">nil</span><br>
<span class="lineno"></span><span class="op" id="7036051">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7036054">func</span>&nbsp;<span class="op" id="7036059">(</span><span class="ident" id="7036060">c</span>&nbsp;<span class="op" id="7036062">*</span><span class="ident" id="7036063">concurrentDBQueryTest</span><span class="op" id="7036084">)</span>&nbsp;<span class="ident" id="7036086">test</span><span class="op" id="7036090">(</span><span class="ident" id="7036091">t</span>&nbsp;<span class="ident" id="7036093">testing</span><span class="op" id="7036100">.</span><span class="ident" id="7036101">TB</span><span class="op" id="7036103">)</span>&nbsp;<span class="builtintype" id="7036105">error</span>&nbsp;<span class="op" id="7036111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036114">rows</span><span class="op" id="7036118">,</span>&nbsp;<span class="ident" id="7036120">err</span>&nbsp;<span class="op" id="7036124">:=</span>&nbsp;<span class="ident" id="7036127">c</span><span class="op" id="7036128">.</span><span class="ident" id="7036129">db</span><span class="op" id="7036131">.</span><span class="ident" id="7036132">Query</span><span class="op" id="7036137">(</span><span class="string" id="7036138">&#34;SELECT|people|name|&#34;</span><span class="op" id="7036159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036162">if</span>&nbsp;<span class="ident" id="7036165">err</span>&nbsp;<span class="op" id="7036169">!=</span>&nbsp;<span class="ident" id="7036172">nil</span>&nbsp;<span class="op" id="7036176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036180">t</span><span class="op" id="7036181">.</span><span class="ident" id="7036182">Error</span><span class="op" id="7036187">(</span><span class="ident" id="7036188">err</span><span class="op" id="7036191">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036195">return</span>&nbsp;<span class="ident" id="7036202">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7036207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036210">var</span>&nbsp;<span class="ident" id="7036214">name</span>&nbsp;<span class="builtintype" id="7036219">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036227">for</span>&nbsp;<span class="ident" id="7036231">rows</span><span class="op" id="7036235">.</span><span class="ident" id="7036236">Next</span><span class="op" id="7036240">(</span><span class="op" id="7036241">)</span>&nbsp;<span class="op" id="7036243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036247">rows</span><span class="op" id="7036251">.</span><span class="ident" id="7036252">Scan</span><span class="op" id="7036256">(</span><span class="op" id="7036257">&amp;</span><span class="ident" id="7036258">name</span><span class="op" id="7036262">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7036265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036268">rows</span><span class="op" id="7036272">.</span><span class="ident" id="7036273">Close</span><span class="op" id="7036278">(</span><span class="op" id="7036279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036282">return</span>&nbsp;<span class="ident" id="7036289">nil</span><br>
<span class="lineno"></span><span class="op" id="7036293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7036296">type</span>&nbsp;<span class="ident" id="7036301">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7036322">struct</span>&nbsp;<span class="op" id="7036329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036332">db</span>&nbsp;<span class="op" id="7036335">*</span><span class="ident" id="7036336">DB</span><br>
<span class="lineno"></span><span class="op" id="7036339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7036342">func</span>&nbsp;<span class="op" id="7036347">(</span><span class="ident" id="7036348">c</span>&nbsp;<span class="op" id="7036350">*</span><span class="ident" id="7036351">concurrentDBExecTest</span><span class="op" id="7036371">)</span>&nbsp;<span class="ident" id="7036373">init</span><span class="op" id="7036377">(</span><span class="ident" id="7036378">t</span>&nbsp;<span class="ident" id="7036380">testing</span><span class="op" id="7036387">.</span><span class="ident" id="7036388">TB</span><span class="op" id="7036390">,</span>&nbsp;<span class="ident" id="7036392">db</span>&nbsp;<span class="op" id="7036395">*</span><span class="ident" id="7036396">DB</span><span class="op" id="7036398">)</span>&nbsp;<span class="op" id="7036400">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036403">c</span><span class="op" id="7036404">.</span><span class="ident" id="7036405">db</span>&nbsp;<span class="op" id="7036408">=</span>&nbsp;<span class="ident" id="7036410">db</span><br>
<span class="lineno"></span><span class="op" id="7036413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7036416">func</span>&nbsp;<span class="op" id="7036421">(</span><span class="ident" id="7036422">c</span>&nbsp;<span class="op" id="7036424">*</span><span class="ident" id="7036425">concurrentDBExecTest</span><span class="op" id="7036445">)</span>&nbsp;<span class="ident" id="7036447">finish</span><span class="op" id="7036453">(</span><span class="ident" id="7036454">t</span>&nbsp;<span class="ident" id="7036456">testing</span><span class="op" id="7036463">.</span><span class="ident" id="7036464">TB</span><span class="op" id="7036466">)</span>&nbsp;<span class="op" id="7036468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036471">c</span><span class="op" id="7036472">.</span><span class="ident" id="7036473">db</span>&nbsp;<span class="op" id="7036476">=</span>&nbsp;<span class="ident" id="7036478">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7036482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7036485">func</span>&nbsp;<span class="op" id="7036490">(</span><span class="ident" id="7036491">c</span>&nbsp;<span class="op" id="7036493">*</span><span class="ident" id="7036494">concurrentDBExecTest</span><span class="op" id="7036514">)</span>&nbsp;<span class="ident" id="7036516">test</span><span class="op" id="7036520">(</span><span class="ident" id="7036521">t</span>&nbsp;<span class="ident" id="7036523">testing</span><span class="op" id="7036530">.</span><span class="ident" id="7036531">TB</span><span class="op" id="7036533">)</span>&nbsp;<span class="builtintype" id="7036535">error</span>&nbsp;<span class="op" id="7036541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036544">_</span><span class="op" id="7036545">,</span>&nbsp;<span class="ident" id="7036547">err</span>&nbsp;<span class="op" id="7036551">:=</span>&nbsp;<span class="ident" id="7036554">c</span><span class="op" id="7036555">.</span><span class="ident" id="7036556">db</span><span class="op" id="7036558">.</span><span class="ident" id="7036559">Exec</span><span class="op" id="7036563">(</span><span class="string" id="7036564">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7036617">,</span>&nbsp;<span class="num" id="7036619">3</span><span class="op" id="7036620">,</span>&nbsp;<span class="ident" id="7036622">chrisBirthday</span><span class="op" id="7036635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036638">if</span>&nbsp;<span class="ident" id="7036641">err</span>&nbsp;<span class="op" id="7036645">!=</span>&nbsp;<span class="ident" id="7036648">nil</span>&nbsp;<span class="op" id="7036652">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036656">t</span><span class="op" id="7036657">.</span><span class="ident" id="7036658">Error</span><span class="op" id="7036663">(</span><span class="ident" id="7036664">err</span><span class="op" id="7036667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036671">return</span>&nbsp;<span class="ident" id="7036678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7036683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036686">return</span>&nbsp;<span class="ident" id="7036693">nil</span><br>
<span class="lineno"></span><span class="op" id="7036697">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7036700">type</span>&nbsp;<span class="ident" id="7036705">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7036729">struct</span>&nbsp;<span class="op" id="7036736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036739">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7036744">*</span><span class="ident" id="7036745">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036749">stmt</span>&nbsp;<span class="op" id="7036754">*</span><span class="ident" id="7036755">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7036760">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7036763">func</span>&nbsp;<span class="op" id="7036768">(</span><span class="ident" id="7036769">c</span>&nbsp;<span class="op" id="7036771">*</span><span class="ident" id="7036772">concurrentStmtQueryTest</span><span class="op" id="7036795">)</span>&nbsp;<span class="ident" id="7036797">init</span><span class="op" id="7036801">(</span><span class="ident" id="7036802">t</span>&nbsp;<span class="ident" id="7036804">testing</span><span class="op" id="7036811">.</span><span class="ident" id="7036812">TB</span><span class="op" id="7036814">,</span>&nbsp;<span class="ident" id="7036816">db</span>&nbsp;<span class="op" id="7036819">*</span><span class="ident" id="7036820">DB</span><span class="op" id="7036822">)</span>&nbsp;<span class="op" id="7036824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036827">c</span><span class="op" id="7036828">.</span><span class="ident" id="7036829">db</span>&nbsp;<span class="op" id="7036832">=</span>&nbsp;<span class="ident" id="7036834">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036838">var</span>&nbsp;<span class="ident" id="7036842">err</span>&nbsp;<span class="builtintype" id="7036846">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036853">c</span><span class="op" id="7036854">.</span><span class="ident" id="7036855">stmt</span><span class="op" id="7036859">,</span>&nbsp;<span class="ident" id="7036861">err</span>&nbsp;<span class="op" id="7036865">=</span>&nbsp;<span class="ident" id="7036867">db</span><span class="op" id="7036869">.</span><span class="ident" id="7036870">Prepare</span><span class="op" id="7036877">(</span><span class="string" id="7036878">&#34;SELECT|people|name|&#34;</span><span class="op" id="7036899">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036902">if</span>&nbsp;<span class="ident" id="7036905">err</span>&nbsp;<span class="op" id="7036909">!=</span>&nbsp;<span class="ident" id="7036912">nil</span>&nbsp;<span class="op" id="7036916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7036920">t</span><span class="op" id="7036921">.</span><span class="ident" id="7036922">Fatal</span><span class="op" id="7036927">(</span><span class="ident" id="7036928">err</span><span class="op" id="7036931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7036934">}</span><br>
<span class="lineno"></span><span class="op" id="7036936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7036939">func</span>&nbsp;<span class="op" id="7036944">(</span><span class="ident" id="7036945">c</span>&nbsp;<span class="op" id="7036947">*</span><span class="ident" id="7036948">concurrentStmtQueryTest</span><span class="op" id="7036971">)</span>&nbsp;<span class="ident" id="7036973">finish</span><span class="op" id="7036979">(</span><span class="ident" id="7036980">t</span>&nbsp;<span class="ident" id="7036982">testing</span><span class="op" id="7036989">.</span><span class="ident" id="7036990">TB</span><span class="op" id="7036992">)</span>&nbsp;<span class="op" id="7036994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7036997">if</span>&nbsp;<span class="ident" id="7037000">c</span><span class="op" id="7037001">.</span><span class="ident" id="7037002">stmt</span>&nbsp;<span class="op" id="7037007">!=</span>&nbsp;<span class="ident" id="7037010">nil</span>&nbsp;<span class="op" id="7037014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037018">c</span><span class="op" id="7037019">.</span><span class="ident" id="7037020">stmt</span><span class="op" id="7037024">.</span><span class="ident" id="7037025">Close</span><span class="op" id="7037030">(</span><span class="op" id="7037031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037035">c</span><span class="op" id="7037036">.</span><span class="ident" id="7037037">stmt</span>&nbsp;<span class="op" id="7037042">=</span>&nbsp;<span class="ident" id="7037044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037049">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037052">c</span><span class="op" id="7037053">.</span><span class="ident" id="7037054">db</span>&nbsp;<span class="op" id="7037057">=</span>&nbsp;<span class="ident" id="7037059">nil</span><br>
<span class="lineno"></span><span class="op" id="7037063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037066">func</span>&nbsp;<span class="op" id="7037071">(</span><span class="ident" id="7037072">c</span>&nbsp;<span class="op" id="7037074">*</span><span class="ident" id="7037075">concurrentStmtQueryTest</span><span class="op" id="7037098">)</span>&nbsp;<span class="ident" id="7037100">test</span><span class="op" id="7037104">(</span><span class="ident" id="7037105">t</span>&nbsp;<span class="ident" id="7037107">testing</span><span class="op" id="7037114">.</span><span class="ident" id="7037115">TB</span><span class="op" id="7037117">)</span>&nbsp;<span class="builtintype" id="7037119">error</span>&nbsp;<span class="op" id="7037125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037128">rows</span><span class="op" id="7037132">,</span>&nbsp;<span class="ident" id="7037134">err</span>&nbsp;<span class="op" id="7037138">:=</span>&nbsp;<span class="ident" id="7037141">c</span><span class="op" id="7037142">.</span><span class="ident" id="7037143">stmt</span><span class="op" id="7037147">.</span><span class="ident" id="7037148">Query</span><span class="op" id="7037153">(</span><span class="op" id="7037154">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037157">if</span>&nbsp;<span class="ident" id="7037160">err</span>&nbsp;<span class="op" id="7037164">!=</span>&nbsp;<span class="ident" id="7037167">nil</span>&nbsp;<span class="op" id="7037171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037175">t</span><span class="op" id="7037176">.</span><span class="ident" id="7037177">Errorf</span><span class="op" id="7037183">(</span><span class="string" id="7037184">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7037205">,</span>&nbsp;<span class="ident" id="7037207">err</span><span class="op" id="7037210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037214">return</span>&nbsp;<span class="ident" id="7037221">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037230">var</span>&nbsp;<span class="ident" id="7037234">name</span>&nbsp;<span class="builtintype" id="7037239">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037247">for</span>&nbsp;<span class="ident" id="7037251">rows</span><span class="op" id="7037255">.</span><span class="ident" id="7037256">Next</span><span class="op" id="7037260">(</span><span class="op" id="7037261">)</span>&nbsp;<span class="op" id="7037263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037267">rows</span><span class="op" id="7037271">.</span><span class="ident" id="7037272">Scan</span><span class="op" id="7037276">(</span><span class="op" id="7037277">&amp;</span><span class="ident" id="7037278">name</span><span class="op" id="7037282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037288">rows</span><span class="op" id="7037292">.</span><span class="ident" id="7037293">Close</span><span class="op" id="7037298">(</span><span class="op" id="7037299">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037302">return</span>&nbsp;<span class="ident" id="7037309">nil</span><br>
<span class="lineno"></span><span class="op" id="7037313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037316">type</span>&nbsp;<span class="ident" id="7037321">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7037344">struct</span>&nbsp;<span class="op" id="7037351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037354">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7037359">*</span><span class="ident" id="7037360">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037364">stmt</span>&nbsp;<span class="op" id="7037369">*</span><span class="ident" id="7037370">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7037375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037378">func</span>&nbsp;<span class="op" id="7037383">(</span><span class="ident" id="7037384">c</span>&nbsp;<span class="op" id="7037386">*</span><span class="ident" id="7037387">concurrentStmtExecTest</span><span class="op" id="7037409">)</span>&nbsp;<span class="ident" id="7037411">init</span><span class="op" id="7037415">(</span><span class="ident" id="7037416">t</span>&nbsp;<span class="ident" id="7037418">testing</span><span class="op" id="7037425">.</span><span class="ident" id="7037426">TB</span><span class="op" id="7037428">,</span>&nbsp;<span class="ident" id="7037430">db</span>&nbsp;<span class="op" id="7037433">*</span><span class="ident" id="7037434">DB</span><span class="op" id="7037436">)</span>&nbsp;<span class="op" id="7037438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037441">c</span><span class="op" id="7037442">.</span><span class="ident" id="7037443">db</span>&nbsp;<span class="op" id="7037446">=</span>&nbsp;<span class="ident" id="7037448">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037452">var</span>&nbsp;<span class="ident" id="7037456">err</span>&nbsp;<span class="builtintype" id="7037460">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037467">c</span><span class="op" id="7037468">.</span><span class="ident" id="7037469">stmt</span><span class="op" id="7037473">,</span>&nbsp;<span class="ident" id="7037475">err</span>&nbsp;<span class="op" id="7037479">=</span>&nbsp;<span class="ident" id="7037481">db</span><span class="op" id="7037483">.</span><span class="ident" id="7037484">Prepare</span><span class="op" id="7037491">(</span><span class="string" id="7037492">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7037545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037548">if</span>&nbsp;<span class="ident" id="7037551">err</span>&nbsp;<span class="op" id="7037555">!=</span>&nbsp;<span class="ident" id="7037558">nil</span>&nbsp;<span class="op" id="7037562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037566">t</span><span class="op" id="7037567">.</span><span class="ident" id="7037568">Fatal</span><span class="op" id="7037573">(</span><span class="ident" id="7037574">err</span><span class="op" id="7037577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037580">}</span><br>
<span class="lineno">1525</span><span class="op" id="7037582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037585">func</span>&nbsp;<span class="op" id="7037590">(</span><span class="ident" id="7037591">c</span>&nbsp;<span class="op" id="7037593">*</span><span class="ident" id="7037594">concurrentStmtExecTest</span><span class="op" id="7037616">)</span>&nbsp;<span class="ident" id="7037618">finish</span><span class="op" id="7037624">(</span><span class="ident" id="7037625">t</span>&nbsp;<span class="ident" id="7037627">testing</span><span class="op" id="7037634">.</span><span class="ident" id="7037635">TB</span><span class="op" id="7037637">)</span>&nbsp;<span class="op" id="7037639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037642">if</span>&nbsp;<span class="ident" id="7037645">c</span><span class="op" id="7037646">.</span><span class="ident" id="7037647">stmt</span>&nbsp;<span class="op" id="7037652">!=</span>&nbsp;<span class="ident" id="7037655">nil</span>&nbsp;<span class="op" id="7037659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037663">c</span><span class="op" id="7037664">.</span><span class="ident" id="7037665">stmt</span><span class="op" id="7037669">.</span><span class="ident" id="7037670">Close</span><span class="op" id="7037675">(</span><span class="op" id="7037676">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037680">c</span><span class="op" id="7037681">.</span><span class="ident" id="7037682">stmt</span>&nbsp;<span class="op" id="7037687">=</span>&nbsp;<span class="ident" id="7037689">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037697">c</span><span class="op" id="7037698">.</span><span class="ident" id="7037699">db</span>&nbsp;<span class="op" id="7037702">=</span>&nbsp;<span class="ident" id="7037704">nil</span><br>
<span class="lineno"></span><span class="op" id="7037708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7037711">func</span>&nbsp;<span class="op" id="7037716">(</span><span class="ident" id="7037717">c</span>&nbsp;<span class="op" id="7037719">*</span><span class="ident" id="7037720">concurrentStmtExecTest</span><span class="op" id="7037742">)</span>&nbsp;<span class="ident" id="7037744">test</span><span class="op" id="7037748">(</span><span class="ident" id="7037749">t</span>&nbsp;<span class="ident" id="7037751">testing</span><span class="op" id="7037758">.</span><span class="ident" id="7037759">TB</span><span class="op" id="7037761">)</span>&nbsp;<span class="builtintype" id="7037763">error</span>&nbsp;<span class="op" id="7037769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037772">_</span><span class="op" id="7037773">,</span>&nbsp;<span class="ident" id="7037775">err</span>&nbsp;<span class="op" id="7037779">:=</span>&nbsp;<span class="ident" id="7037782">c</span><span class="op" id="7037783">.</span><span class="ident" id="7037784">stmt</span><span class="op" id="7037788">.</span><span class="ident" id="7037789">Exec</span><span class="op" id="7037793">(</span><span class="num" id="7037794">3</span><span class="op" id="7037795">,</span>&nbsp;<span class="ident" id="7037797">chrisBirthday</span><span class="op" id="7037810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037813">if</span>&nbsp;<span class="ident" id="7037816">err</span>&nbsp;<span class="op" id="7037820">!=</span>&nbsp;<span class="ident" id="7037823">nil</span>&nbsp;<span class="op" id="7037827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037831">t</span><span class="op" id="7037832">.</span><span class="ident" id="7037833">Errorf</span><span class="op" id="7037839">(</span><span class="string" id="7037840">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7037860">,</span>&nbsp;<span class="ident" id="7037862">err</span><span class="op" id="7037865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037869">return</span>&nbsp;<span class="ident" id="7037876">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7037881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7037884">return</span>&nbsp;<span class="ident" id="7037891">nil</span><br>
<span class="lineno"></span><span class="op" id="7037895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037898">type</span>&nbsp;<span class="ident" id="7037903">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7037925">struct</span>&nbsp;<span class="op" id="7037932">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037935">db</span>&nbsp;<span class="op" id="7037938">*</span><span class="ident" id="7037939">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7037943">tx</span>&nbsp;<span class="op" id="7037946">*</span><span class="ident" id="7037947">Tx</span><br>
<span class="lineno"></span><span class="op" id="7037950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7037953">func</span>&nbsp;<span class="op" id="7037958">(</span><span class="ident" id="7037959">c</span>&nbsp;<span class="op" id="7037961">*</span><span class="ident" id="7037962">concurrentTxQueryTest</span><span class="op" id="7037983">)</span>&nbsp;<span class="ident" id="7037985">init</span><span class="op" id="7037989">(</span><span class="ident" id="7037990">t</span>&nbsp;<span class="ident" id="7037992">testing</span><span class="op" id="7037999">.</span><span class="ident" id="7038000">TB</span><span class="op" id="7038002">,</span>&nbsp;<span class="ident" id="7038004">db</span>&nbsp;<span class="op" id="7038007">*</span><span class="ident" id="7038008">DB</span><span class="op" id="7038010">)</span>&nbsp;<span class="op" id="7038012">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038015">c</span><span class="op" id="7038016">.</span><span class="ident" id="7038017">db</span>&nbsp;<span class="op" id="7038020">=</span>&nbsp;<span class="ident" id="7038022">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038026">var</span>&nbsp;<span class="ident" id="7038030">err</span>&nbsp;<span class="builtintype" id="7038034">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038041">c</span><span class="op" id="7038042">.</span><span class="ident" id="7038043">tx</span><span class="op" id="7038045">,</span>&nbsp;<span class="ident" id="7038047">err</span>&nbsp;<span class="op" id="7038051">=</span>&nbsp;<span class="ident" id="7038053">c</span><span class="op" id="7038054">.</span><span class="ident" id="7038055">db</span><span class="op" id="7038057">.</span><span class="ident" id="7038058">Begin</span><span class="op" id="7038063">(</span><span class="op" id="7038064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038067">if</span>&nbsp;<span class="ident" id="7038070">err</span>&nbsp;<span class="op" id="7038074">!=</span>&nbsp;<span class="ident" id="7038077">nil</span>&nbsp;<span class="op" id="7038081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038085">t</span><span class="op" id="7038086">.</span><span class="ident" id="7038087">Fatal</span><span class="op" id="7038092">(</span><span class="ident" id="7038093">err</span><span class="op" id="7038096">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038099">}</span><br>
<span class="lineno"></span><span class="op" id="7038101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7038104">func</span>&nbsp;<span class="op" id="7038109">(</span><span class="ident" id="7038110">c</span>&nbsp;<span class="op" id="7038112">*</span><span class="ident" id="7038113">concurrentTxQueryTest</span><span class="op" id="7038134">)</span>&nbsp;<span class="ident" id="7038136">finish</span><span class="op" id="7038142">(</span><span class="ident" id="7038143">t</span>&nbsp;<span class="ident" id="7038145">testing</span><span class="op" id="7038152">.</span><span class="ident" id="7038153">TB</span><span class="op" id="7038155">)</span>&nbsp;<span class="op" id="7038157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038160">if</span>&nbsp;<span class="ident" id="7038163">c</span><span class="op" id="7038164">.</span><span class="ident" id="7038165">tx</span>&nbsp;<span class="op" id="7038168">!=</span>&nbsp;<span class="ident" id="7038171">nil</span>&nbsp;<span class="op" id="7038175">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038179">c</span><span class="op" id="7038180">.</span><span class="ident" id="7038181">tx</span><span class="op" id="7038183">.</span><span class="ident" id="7038184">Rollback</span><span class="op" id="7038192">(</span><span class="op" id="7038193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038197">c</span><span class="op" id="7038198">.</span><span class="ident" id="7038199">tx</span>&nbsp;<span class="op" id="7038202">=</span>&nbsp;<span class="ident" id="7038204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038212">c</span><span class="op" id="7038213">.</span><span class="ident" id="7038214">db</span>&nbsp;<span class="op" id="7038217">=</span>&nbsp;<span class="ident" id="7038219">nil</span><br>
<span class="lineno"></span><span class="op" id="7038223">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7038226">func</span>&nbsp;<span class="op" id="7038231">(</span><span class="ident" id="7038232">c</span>&nbsp;<span class="op" id="7038234">*</span><span class="ident" id="7038235">concurrentTxQueryTest</span><span class="op" id="7038256">)</span>&nbsp;<span class="ident" id="7038258">test</span><span class="op" id="7038262">(</span><span class="ident" id="7038263">t</span>&nbsp;<span class="ident" id="7038265">testing</span><span class="op" id="7038272">.</span><span class="ident" id="7038273">TB</span><span class="op" id="7038275">)</span>&nbsp;<span class="builtintype" id="7038277">error</span>&nbsp;<span class="op" id="7038283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038286">rows</span><span class="op" id="7038290">,</span>&nbsp;<span class="ident" id="7038292">err</span>&nbsp;<span class="op" id="7038296">:=</span>&nbsp;<span class="ident" id="7038299">c</span><span class="op" id="7038300">.</span><span class="ident" id="7038301">db</span><span class="op" id="7038303">.</span><span class="ident" id="7038304">Query</span><span class="op" id="7038309">(</span><span class="string" id="7038310">&#34;SELECT|people|name|&#34;</span><span class="op" id="7038331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038334">if</span>&nbsp;<span class="ident" id="7038337">err</span>&nbsp;<span class="op" id="7038341">!=</span>&nbsp;<span class="ident" id="7038344">nil</span>&nbsp;<span class="op" id="7038348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038352">t</span><span class="op" id="7038353">.</span><span class="ident" id="7038354">Error</span><span class="op" id="7038359">(</span><span class="ident" id="7038360">err</span><span class="op" id="7038363">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038367">return</span>&nbsp;<span class="ident" id="7038374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038382">var</span>&nbsp;<span class="ident" id="7038386">name</span>&nbsp;<span class="builtintype" id="7038391">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038399">for</span>&nbsp;<span class="ident" id="7038403">rows</span><span class="op" id="7038407">.</span><span class="ident" id="7038408">Next</span><span class="op" id="7038412">(</span><span class="op" id="7038413">)</span>&nbsp;<span class="op" id="7038415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038419">rows</span><span class="op" id="7038423">.</span><span class="ident" id="7038424">Scan</span><span class="op" id="7038428">(</span><span class="op" id="7038429">&amp;</span><span class="ident" id="7038430">name</span><span class="op" id="7038434">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038440">rows</span><span class="op" id="7038444">.</span><span class="ident" id="7038445">Close</span><span class="op" id="7038450">(</span><span class="op" id="7038451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038454">return</span>&nbsp;<span class="ident" id="7038461">nil</span><br>
<span class="lineno"></span><span class="op" id="7038465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7038468">type</span>&nbsp;<span class="ident" id="7038473">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7038494">struct</span>&nbsp;<span class="op" id="7038501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038504">db</span>&nbsp;<span class="op" id="7038507">*</span><span class="ident" id="7038508">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038512">tx</span>&nbsp;<span class="op" id="7038515">*</span><span class="ident" id="7038516">Tx</span><br>
<span class="lineno"></span><span class="op" id="7038519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7038522">func</span>&nbsp;<span class="op" id="7038527">(</span><span class="ident" id="7038528">c</span>&nbsp;<span class="op" id="7038530">*</span><span class="ident" id="7038531">concurrentTxExecTest</span><span class="op" id="7038551">)</span>&nbsp;<span class="ident" id="7038553">init</span><span class="op" id="7038557">(</span><span class="ident" id="7038558">t</span>&nbsp;<span class="ident" id="7038560">testing</span><span class="op" id="7038567">.</span><span class="ident" id="7038568">TB</span><span class="op" id="7038570">,</span>&nbsp;<span class="ident" id="7038572">db</span>&nbsp;<span class="op" id="7038575">*</span><span class="ident" id="7038576">DB</span><span class="op" id="7038578">)</span>&nbsp;<span class="op" id="7038580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038583">c</span><span class="op" id="7038584">.</span><span class="ident" id="7038585">db</span>&nbsp;<span class="op" id="7038588">=</span>&nbsp;<span class="ident" id="7038590">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038594">var</span>&nbsp;<span class="ident" id="7038598">err</span>&nbsp;<span class="builtintype" id="7038602">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038609">c</span><span class="op" id="7038610">.</span><span class="ident" id="7038611">tx</span><span class="op" id="7038613">,</span>&nbsp;<span class="ident" id="7038615">err</span>&nbsp;<span class="op" id="7038619">=</span>&nbsp;<span class="ident" id="7038621">c</span><span class="op" id="7038622">.</span><span class="ident" id="7038623">db</span><span class="op" id="7038625">.</span><span class="ident" id="7038626">Begin</span><span class="op" id="7038631">(</span><span class="op" id="7038632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038635">if</span>&nbsp;<span class="ident" id="7038638">err</span>&nbsp;<span class="op" id="7038642">!=</span>&nbsp;<span class="ident" id="7038645">nil</span>&nbsp;<span class="op" id="7038649">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038653">t</span><span class="op" id="7038654">.</span><span class="ident" id="7038655">Fatal</span><span class="op" id="7038660">(</span><span class="ident" id="7038661">err</span><span class="op" id="7038664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038667">}</span><br>
<span class="lineno"></span><span class="op" id="7038669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7038672">func</span>&nbsp;<span class="op" id="7038677">(</span><span class="ident" id="7038678">c</span>&nbsp;<span class="op" id="7038680">*</span><span class="ident" id="7038681">concurrentTxExecTest</span><span class="op" id="7038701">)</span>&nbsp;<span class="ident" id="7038703">finish</span><span class="op" id="7038709">(</span><span class="ident" id="7038710">t</span>&nbsp;<span class="ident" id="7038712">testing</span><span class="op" id="7038719">.</span><span class="ident" id="7038720">TB</span><span class="op" id="7038722">)</span>&nbsp;<span class="op" id="7038724">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038727">if</span>&nbsp;<span class="ident" id="7038730">c</span><span class="op" id="7038731">.</span><span class="ident" id="7038732">tx</span>&nbsp;<span class="op" id="7038735">!=</span>&nbsp;<span class="ident" id="7038738">nil</span>&nbsp;<span class="op" id="7038742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038746">c</span><span class="op" id="7038747">.</span><span class="ident" id="7038748">tx</span><span class="op" id="7038750">.</span><span class="ident" id="7038751">Rollback</span><span class="op" id="7038759">(</span><span class="op" id="7038760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038764">c</span><span class="op" id="7038765">.</span><span class="ident" id="7038766">tx</span>&nbsp;<span class="op" id="7038769">=</span>&nbsp;<span class="ident" id="7038771">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038779">c</span><span class="op" id="7038780">.</span><span class="ident" id="7038781">db</span>&nbsp;<span class="op" id="7038784">=</span>&nbsp;<span class="ident" id="7038786">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7038790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7038793">func</span>&nbsp;<span class="op" id="7038798">(</span><span class="ident" id="7038799">c</span>&nbsp;<span class="op" id="7038801">*</span><span class="ident" id="7038802">concurrentTxExecTest</span><span class="op" id="7038822">)</span>&nbsp;<span class="ident" id="7038824">test</span><span class="op" id="7038828">(</span><span class="ident" id="7038829">t</span>&nbsp;<span class="ident" id="7038831">testing</span><span class="op" id="7038838">.</span><span class="ident" id="7038839">TB</span><span class="op" id="7038841">)</span>&nbsp;<span class="builtintype" id="7038843">error</span>&nbsp;<span class="op" id="7038849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038852">_</span><span class="op" id="7038853">,</span>&nbsp;<span class="ident" id="7038855">err</span>&nbsp;<span class="op" id="7038859">:=</span>&nbsp;<span class="ident" id="7038862">c</span><span class="op" id="7038863">.</span><span class="ident" id="7038864">tx</span><span class="op" id="7038866">.</span><span class="ident" id="7038867">Exec</span><span class="op" id="7038871">(</span><span class="string" id="7038872">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7038925">,</span>&nbsp;<span class="num" id="7038927">3</span><span class="op" id="7038928">,</span>&nbsp;<span class="ident" id="7038930">chrisBirthday</span><span class="op" id="7038943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038946">if</span>&nbsp;<span class="ident" id="7038949">err</span>&nbsp;<span class="op" id="7038953">!=</span>&nbsp;<span class="ident" id="7038956">nil</span>&nbsp;<span class="op" id="7038960">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7038964">t</span><span class="op" id="7038965">.</span><span class="ident" id="7038966">Error</span><span class="op" id="7038971">(</span><span class="ident" id="7038972">err</span><span class="op" id="7038975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038979">return</span>&nbsp;<span class="ident" id="7038986">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7038991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7038994">return</span>&nbsp;<span class="ident" id="7039001">nil</span><br>
<span class="lineno"></span><span class="op" id="7039005">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7039008">type</span>&nbsp;<span class="ident" id="7039013">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7039039">struct</span>&nbsp;<span class="op" id="7039046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039049">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7039054">*</span><span class="ident" id="7039055">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039059">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7039064">*</span><span class="ident" id="7039065">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039069">stmt</span>&nbsp;<span class="op" id="7039074">*</span><span class="ident" id="7039075">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7039080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7039083">func</span>&nbsp;<span class="op" id="7039088">(</span><span class="ident" id="7039089">c</span>&nbsp;<span class="op" id="7039091">*</span><span class="ident" id="7039092">concurrentTxStmtQueryTest</span><span class="op" id="7039117">)</span>&nbsp;<span class="ident" id="7039119">init</span><span class="op" id="7039123">(</span><span class="ident" id="7039124">t</span>&nbsp;<span class="ident" id="7039126">testing</span><span class="op" id="7039133">.</span><span class="ident" id="7039134">TB</span><span class="op" id="7039136">,</span>&nbsp;<span class="ident" id="7039138">db</span>&nbsp;<span class="op" id="7039141">*</span><span class="ident" id="7039142">DB</span><span class="op" id="7039144">)</span>&nbsp;<span class="op" id="7039146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039149">c</span><span class="op" id="7039150">.</span><span class="ident" id="7039151">db</span>&nbsp;<span class="op" id="7039154">=</span>&nbsp;<span class="ident" id="7039156">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039160">var</span>&nbsp;<span class="ident" id="7039164">err</span>&nbsp;<span class="builtintype" id="7039168">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039175">c</span><span class="op" id="7039176">.</span><span class="ident" id="7039177">tx</span><span class="op" id="7039179">,</span>&nbsp;<span class="ident" id="7039181">err</span>&nbsp;<span class="op" id="7039185">=</span>&nbsp;<span class="ident" id="7039187">c</span><span class="op" id="7039188">.</span><span class="ident" id="7039189">db</span><span class="op" id="7039191">.</span><span class="ident" id="7039192">Begin</span><span class="op" id="7039197">(</span><span class="op" id="7039198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039201">if</span>&nbsp;<span class="ident" id="7039204">err</span>&nbsp;<span class="op" id="7039208">!=</span>&nbsp;<span class="ident" id="7039211">nil</span>&nbsp;<span class="op" id="7039215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039219">t</span><span class="op" id="7039220">.</span><span class="ident" id="7039221">Fatal</span><span class="op" id="7039226">(</span><span class="ident" id="7039227">err</span><span class="op" id="7039230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039236">c</span><span class="op" id="7039237">.</span><span class="ident" id="7039238">stmt</span><span class="op" id="7039242">,</span>&nbsp;<span class="ident" id="7039244">err</span>&nbsp;<span class="op" id="7039248">=</span>&nbsp;<span class="ident" id="7039250">c</span><span class="op" id="7039251">.</span><span class="ident" id="7039252">tx</span><span class="op" id="7039254">.</span><span class="ident" id="7039255">Prepare</span><span class="op" id="7039262">(</span><span class="string" id="7039263">&#34;SELECT|people|name|&#34;</span><span class="op" id="7039284">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039287">if</span>&nbsp;<span class="ident" id="7039290">err</span>&nbsp;<span class="op" id="7039294">!=</span>&nbsp;<span class="ident" id="7039297">nil</span>&nbsp;<span class="op" id="7039301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039305">t</span><span class="op" id="7039306">.</span><span class="ident" id="7039307">Fatal</span><span class="op" id="7039312">(</span><span class="ident" id="7039313">err</span><span class="op" id="7039316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039319">}</span><br>
<span class="lineno"></span><span class="op" id="7039321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7039324">func</span>&nbsp;<span class="op" id="7039329">(</span><span class="ident" id="7039330">c</span>&nbsp;<span class="op" id="7039332">*</span><span class="ident" id="7039333">concurrentTxStmtQueryTest</span><span class="op" id="7039358">)</span>&nbsp;<span class="ident" id="7039360">finish</span><span class="op" id="7039366">(</span><span class="ident" id="7039367">t</span>&nbsp;<span class="ident" id="7039369">testing</span><span class="op" id="7039376">.</span><span class="ident" id="7039377">TB</span><span class="op" id="7039379">)</span>&nbsp;<span class="op" id="7039381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039384">if</span>&nbsp;<span class="ident" id="7039387">c</span><span class="op" id="7039388">.</span><span class="ident" id="7039389">stmt</span>&nbsp;<span class="op" id="7039394">!=</span>&nbsp;<span class="ident" id="7039397">nil</span>&nbsp;<span class="op" id="7039401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039405">c</span><span class="op" id="7039406">.</span><span class="ident" id="7039407">stmt</span><span class="op" id="7039411">.</span><span class="ident" id="7039412">Close</span><span class="op" id="7039417">(</span><span class="op" id="7039418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039422">c</span><span class="op" id="7039423">.</span><span class="ident" id="7039424">stmt</span>&nbsp;<span class="op" id="7039429">=</span>&nbsp;<span class="ident" id="7039431">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039436">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039439">if</span>&nbsp;<span class="ident" id="7039442">c</span><span class="op" id="7039443">.</span><span class="ident" id="7039444">tx</span>&nbsp;<span class="op" id="7039447">!=</span>&nbsp;<span class="ident" id="7039450">nil</span>&nbsp;<span class="op" id="7039454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039458">c</span><span class="op" id="7039459">.</span><span class="ident" id="7039460">tx</span><span class="op" id="7039462">.</span><span class="ident" id="7039463">Rollback</span><span class="op" id="7039471">(</span><span class="op" id="7039472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039476">c</span><span class="op" id="7039477">.</span><span class="ident" id="7039478">tx</span>&nbsp;<span class="op" id="7039481">=</span>&nbsp;<span class="ident" id="7039483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039491">c</span><span class="op" id="7039492">.</span><span class="ident" id="7039493">db</span>&nbsp;<span class="op" id="7039496">=</span>&nbsp;<span class="ident" id="7039498">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7039502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7039505">func</span>&nbsp;<span class="op" id="7039510">(</span><span class="ident" id="7039511">c</span>&nbsp;<span class="op" id="7039513">*</span><span class="ident" id="7039514">concurrentTxStmtQueryTest</span><span class="op" id="7039539">)</span>&nbsp;<span class="ident" id="7039541">test</span><span class="op" id="7039545">(</span><span class="ident" id="7039546">t</span>&nbsp;<span class="ident" id="7039548">testing</span><span class="op" id="7039555">.</span><span class="ident" id="7039556">TB</span><span class="op" id="7039558">)</span>&nbsp;<span class="builtintype" id="7039560">error</span>&nbsp;<span class="op" id="7039566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039569">rows</span><span class="op" id="7039573">,</span>&nbsp;<span class="ident" id="7039575">err</span>&nbsp;<span class="op" id="7039579">:=</span>&nbsp;<span class="ident" id="7039582">c</span><span class="op" id="7039583">.</span><span class="ident" id="7039584">stmt</span><span class="op" id="7039588">.</span><span class="ident" id="7039589">Query</span><span class="op" id="7039594">(</span><span class="op" id="7039595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039598">if</span>&nbsp;<span class="ident" id="7039601">err</span>&nbsp;<span class="op" id="7039605">!=</span>&nbsp;<span class="ident" id="7039608">nil</span>&nbsp;<span class="op" id="7039612">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039616">t</span><span class="op" id="7039617">.</span><span class="ident" id="7039618">Errorf</span><span class="op" id="7039624">(</span><span class="string" id="7039625">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7039646">,</span>&nbsp;<span class="ident" id="7039648">err</span><span class="op" id="7039651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039655">return</span>&nbsp;<span class="ident" id="7039662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039671">var</span>&nbsp;<span class="ident" id="7039675">name</span>&nbsp;<span class="builtintype" id="7039680">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039688">for</span>&nbsp;<span class="ident" id="7039692">rows</span><span class="op" id="7039696">.</span><span class="ident" id="7039697">Next</span><span class="op" id="7039701">(</span><span class="op" id="7039702">)</span>&nbsp;<span class="op" id="7039704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039708">rows</span><span class="op" id="7039712">.</span><span class="ident" id="7039713">Scan</span><span class="op" id="7039717">(</span><span class="op" id="7039718">&amp;</span><span class="ident" id="7039719">name</span><span class="op" id="7039723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039729">rows</span><span class="op" id="7039733">.</span><span class="ident" id="7039734">Close</span><span class="op" id="7039739">(</span><span class="op" id="7039740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039743">return</span>&nbsp;<span class="ident" id="7039750">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7039754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7039757">type</span>&nbsp;<span class="ident" id="7039762">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7039787">struct</span>&nbsp;<span class="op" id="7039794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039797">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7039802">*</span><span class="ident" id="7039803">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039807">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7039812">*</span><span class="ident" id="7039813">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039817">stmt</span>&nbsp;<span class="op" id="7039822">*</span><span class="ident" id="7039823">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7039828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7039831">func</span>&nbsp;<span class="op" id="7039836">(</span><span class="ident" id="7039837">c</span>&nbsp;<span class="op" id="7039839">*</span><span class="ident" id="7039840">concurrentTxStmtExecTest</span><span class="op" id="7039864">)</span>&nbsp;<span class="ident" id="7039866">init</span><span class="op" id="7039870">(</span><span class="ident" id="7039871">t</span>&nbsp;<span class="ident" id="7039873">testing</span><span class="op" id="7039880">.</span><span class="ident" id="7039881">TB</span><span class="op" id="7039883">,</span>&nbsp;<span class="ident" id="7039885">db</span>&nbsp;<span class="op" id="7039888">*</span><span class="ident" id="7039889">DB</span><span class="op" id="7039891">)</span>&nbsp;<span class="op" id="7039893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039896">c</span><span class="op" id="7039897">.</span><span class="ident" id="7039898">db</span>&nbsp;<span class="op" id="7039901">=</span>&nbsp;<span class="ident" id="7039903">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039907">var</span>&nbsp;<span class="ident" id="7039911">err</span>&nbsp;<span class="builtintype" id="7039915">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039922">c</span><span class="op" id="7039923">.</span><span class="ident" id="7039924">tx</span><span class="op" id="7039926">,</span>&nbsp;<span class="ident" id="7039928">err</span>&nbsp;<span class="op" id="7039932">=</span>&nbsp;<span class="ident" id="7039934">c</span><span class="op" id="7039935">.</span><span class="ident" id="7039936">db</span><span class="op" id="7039938">.</span><span class="ident" id="7039939">Begin</span><span class="op" id="7039944">(</span><span class="op" id="7039945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7039948">if</span>&nbsp;<span class="ident" id="7039951">err</span>&nbsp;<span class="op" id="7039955">!=</span>&nbsp;<span class="ident" id="7039958">nil</span>&nbsp;<span class="op" id="7039962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039966">t</span><span class="op" id="7039967">.</span><span class="ident" id="7039968">Fatal</span><span class="op" id="7039973">(</span><span class="ident" id="7039974">err</span><span class="op" id="7039977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7039980">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7039983">c</span><span class="op" id="7039984">.</span><span class="ident" id="7039985">stmt</span><span class="op" id="7039989">,</span>&nbsp;<span class="ident" id="7039991">err</span>&nbsp;<span class="op" id="7039995">=</span>&nbsp;<span class="ident" id="7039997">c</span><span class="op" id="7039998">.</span><span class="ident" id="7039999">tx</span><span class="op" id="7040001">.</span><span class="ident" id="7040002">Prepare</span><span class="op" id="7040009">(</span><span class="string" id="7040010">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7040063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040066">if</span>&nbsp;<span class="ident" id="7040069">err</span>&nbsp;<span class="op" id="7040073">!=</span>&nbsp;<span class="ident" id="7040076">nil</span>&nbsp;<span class="op" id="7040080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040084">t</span><span class="op" id="7040085">.</span><span class="ident" id="7040086">Fatal</span><span class="op" id="7040091">(</span><span class="ident" id="7040092">err</span><span class="op" id="7040095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040098">}</span><br>
<span class="lineno"></span><span class="op" id="7040100">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7040103">func</span>&nbsp;<span class="op" id="7040108">(</span><span class="ident" id="7040109">c</span>&nbsp;<span class="op" id="7040111">*</span><span class="ident" id="7040112">concurrentTxStmtExecTest</span><span class="op" id="7040136">)</span>&nbsp;<span class="ident" id="7040138">finish</span><span class="op" id="7040144">(</span><span class="ident" id="7040145">t</span>&nbsp;<span class="ident" id="7040147">testing</span><span class="op" id="7040154">.</span><span class="ident" id="7040155">TB</span><span class="op" id="7040157">)</span>&nbsp;<span class="op" id="7040159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040162">if</span>&nbsp;<span class="ident" id="7040165">c</span><span class="op" id="7040166">.</span><span class="ident" id="7040167">stmt</span>&nbsp;<span class="op" id="7040172">!=</span>&nbsp;<span class="ident" id="7040175">nil</span>&nbsp;<span class="op" id="7040179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040183">c</span><span class="op" id="7040184">.</span><span class="ident" id="7040185">stmt</span><span class="op" id="7040189">.</span><span class="ident" id="7040190">Close</span><span class="op" id="7040195">(</span><span class="op" id="7040196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040200">c</span><span class="op" id="7040201">.</span><span class="ident" id="7040202">stmt</span>&nbsp;<span class="op" id="7040207">=</span>&nbsp;<span class="ident" id="7040209">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040217">if</span>&nbsp;<span class="ident" id="7040220">c</span><span class="op" id="7040221">.</span><span class="ident" id="7040222">tx</span>&nbsp;<span class="op" id="7040225">!=</span>&nbsp;<span class="ident" id="7040228">nil</span>&nbsp;<span class="op" id="7040232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040236">c</span><span class="op" id="7040237">.</span><span class="ident" id="7040238">tx</span><span class="op" id="7040240">.</span><span class="ident" id="7040241">Rollback</span><span class="op" id="7040249">(</span><span class="op" id="7040250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040254">c</span><span class="op" id="7040255">.</span><span class="ident" id="7040256">tx</span>&nbsp;<span class="op" id="7040259">=</span>&nbsp;<span class="ident" id="7040261">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040266">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040269">c</span><span class="op" id="7040270">.</span><span class="ident" id="7040271">db</span>&nbsp;<span class="op" id="7040274">=</span>&nbsp;<span class="ident" id="7040276">nil</span><br>
<span class="lineno"></span><span class="op" id="7040280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7040283">func</span>&nbsp;<span class="op" id="7040288">(</span><span class="ident" id="7040289">c</span>&nbsp;<span class="op" id="7040291">*</span><span class="ident" id="7040292">concurrentTxStmtExecTest</span><span class="op" id="7040316">)</span>&nbsp;<span class="ident" id="7040318">test</span><span class="op" id="7040322">(</span><span class="ident" id="7040323">t</span>&nbsp;<span class="ident" id="7040325">testing</span><span class="op" id="7040332">.</span><span class="ident" id="7040333">TB</span><span class="op" id="7040335">)</span>&nbsp;<span class="builtintype" id="7040337">error</span>&nbsp;<span class="op" id="7040343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040346">_</span><span class="op" id="7040347">,</span>&nbsp;<span class="ident" id="7040349">err</span>&nbsp;<span class="op" id="7040353">:=</span>&nbsp;<span class="ident" id="7040356">c</span><span class="op" id="7040357">.</span><span class="ident" id="7040358">stmt</span><span class="op" id="7040362">.</span><span class="ident" id="7040363">Exec</span><span class="op" id="7040367">(</span><span class="num" id="7040368">3</span><span class="op" id="7040369">,</span>&nbsp;<span class="ident" id="7040371">chrisBirthday</span><span class="op" id="7040384">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040387">if</span>&nbsp;<span class="ident" id="7040390">err</span>&nbsp;<span class="op" id="7040394">!=</span>&nbsp;<span class="ident" id="7040397">nil</span>&nbsp;<span class="op" id="7040401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040405">t</span><span class="op" id="7040406">.</span><span class="ident" id="7040407">Errorf</span><span class="op" id="7040413">(</span><span class="string" id="7040414">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7040434">,</span>&nbsp;<span class="ident" id="7040436">err</span><span class="op" id="7040439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040443">return</span>&nbsp;<span class="ident" id="7040450">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040458">return</span>&nbsp;<span class="ident" id="7040465">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7040469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7040472">type</span>&nbsp;<span class="ident" id="7040477">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7040498">struct</span>&nbsp;<span class="op" id="7040505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040508">tests</span>&nbsp;<span class="op" id="7040514">[</span><span class="op" id="7040515">]</span><span class="ident" id="7040516">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7040531">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7040534">func</span>&nbsp;<span class="op" id="7040539">(</span><span class="ident" id="7040540">c</span>&nbsp;<span class="op" id="7040542">*</span><span class="ident" id="7040543">concurrentRandomTest</span><span class="op" id="7040563">)</span>&nbsp;<span class="ident" id="7040565">init</span><span class="op" id="7040569">(</span><span class="ident" id="7040570">t</span>&nbsp;<span class="ident" id="7040572">testing</span><span class="op" id="7040579">.</span><span class="ident" id="7040580">TB</span><span class="op" id="7040582">,</span>&nbsp;<span class="ident" id="7040584">db</span>&nbsp;<span class="op" id="7040587">*</span><span class="ident" id="7040588">DB</span><span class="op" id="7040590">)</span>&nbsp;<span class="op" id="7040592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040595">c</span><span class="op" id="7040596">.</span><span class="ident" id="7040597">tests</span>&nbsp;<span class="op" id="7040603">=</span>&nbsp;<span class="op" id="7040605">[</span><span class="op" id="7040606">]</span><span class="ident" id="7040607">concurrentTest</span><span class="op" id="7040621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040625">new</span><span class="op" id="7040628">(</span><span class="ident" id="7040629">concurrentDBQueryTest</span><span class="op" id="7040650">)</span><span class="op" id="7040651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040655">new</span><span class="op" id="7040658">(</span><span class="ident" id="7040659">concurrentDBExecTest</span><span class="op" id="7040679">)</span><span class="op" id="7040680">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040684">new</span><span class="op" id="7040687">(</span><span class="ident" id="7040688">concurrentStmtQueryTest</span><span class="op" id="7040711">)</span><span class="op" id="7040712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040716">new</span><span class="op" id="7040719">(</span><span class="ident" id="7040720">concurrentStmtExecTest</span><span class="op" id="7040742">)</span><span class="op" id="7040743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040747">new</span><span class="op" id="7040750">(</span><span class="ident" id="7040751">concurrentTxQueryTest</span><span class="op" id="7040772">)</span><span class="op" id="7040773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040777">new</span><span class="op" id="7040780">(</span><span class="ident" id="7040781">concurrentTxExecTest</span><span class="op" id="7040801">)</span><span class="op" id="7040802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040806">new</span><span class="op" id="7040809">(</span><span class="ident" id="7040810">concurrentTxStmtQueryTest</span><span class="op" id="7040835">)</span><span class="op" id="7040836">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7040840">new</span><span class="op" id="7040843">(</span><span class="ident" id="7040844">concurrentTxStmtExecTest</span><span class="op" id="7040868">)</span><span class="op" id="7040869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040875">for</span>&nbsp;<span class="ident" id="7040879">_</span><span class="op" id="7040880">,</span>&nbsp;<span class="ident" id="7040882">ct</span>&nbsp;<span class="op" id="7040885">:=</span>&nbsp;<span class="keyword" id="7040888">range</span>&nbsp;<span class="ident" id="7040894">c</span><span class="op" id="7040895">.</span><span class="ident" id="7040896">tests</span>&nbsp;<span class="op" id="7040902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7040906">ct</span><span class="op" id="7040908">.</span><span class="ident" id="7040909">init</span><span class="op" id="7040913">(</span><span class="ident" id="7040914">t</span><span class="op" id="7040915">,</span>&nbsp;<span class="ident" id="7040917">db</span><span class="op" id="7040919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7040922">}</span><br>
<span class="lineno">1715</span><span class="op" id="7040924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7040927">func</span>&nbsp;<span class="op" id="7040932">(</span><span class="ident" id="7040933">c</span>&nbsp;<span class="op" id="7040935">*</span><span class="ident" id="7040936">concurrentRandomTest</span><span class="op" id="7040956">)</span>&nbsp;<span class="ident" id="7040958">finish</span><span class="op" id="7040964">(</span><span class="ident" id="7040965">t</span>&nbsp;<span class="ident" id="7040967">testing</span><span class="op" id="7040974">.</span><span class="ident" id="7040975">TB</span><span class="op" id="7040977">)</span>&nbsp;<span class="op" id="7040979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7040982">for</span>&nbsp;<span class="ident" id="7040986">_</span><span class="op" id="7040987">,</span>&nbsp;<span class="ident" id="7040989">ct</span>&nbsp;<span class="op" id="7040992">:=</span>&nbsp;<span class="keyword" id="7040995">range</span>&nbsp;<span class="ident" id="7041001">c</span><span class="op" id="7041002">.</span><span class="ident" id="7041003">tests</span>&nbsp;<span class="op" id="7041009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041013">ct</span><span class="op" id="7041015">.</span><span class="ident" id="7041016">finish</span><span class="op" id="7041022">(</span><span class="ident" id="7041023">t</span><span class="op" id="7041024">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041027">}</span><br>
<span class="lineno"></span><span class="op" id="7041029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7041032">func</span>&nbsp;<span class="op" id="7041037">(</span><span class="ident" id="7041038">c</span>&nbsp;<span class="op" id="7041040">*</span><span class="ident" id="7041041">concurrentRandomTest</span><span class="op" id="7041061">)</span>&nbsp;<span class="ident" id="7041063">test</span><span class="op" id="7041067">(</span><span class="ident" id="7041068">t</span>&nbsp;<span class="ident" id="7041070">testing</span><span class="op" id="7041077">.</span><span class="ident" id="7041078">TB</span><span class="op" id="7041080">)</span>&nbsp;<span class="builtintype" id="7041082">error</span>&nbsp;<span class="op" id="7041088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041091">ct</span>&nbsp;<span class="op" id="7041094">:=</span>&nbsp;<span class="ident" id="7041097">c</span><span class="op" id="7041098">.</span><span class="ident" id="7041099">tests</span><span class="op" id="7041104">[</span><span class="ident" id="7041105">rand</span><span class="op" id="7041109">.</span><span class="ident" id="7041110">Intn</span><span class="op" id="7041114">(</span><span class="builtinfunc" id="7041115">len</span><span class="op" id="7041118">(</span><span class="ident" id="7041119">c</span><span class="op" id="7041120">.</span><span class="ident" id="7041121">tests</span><span class="op" id="7041126">)</span><span class="op" id="7041127">)</span><span class="op" id="7041128">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041131">return</span>&nbsp;<span class="ident" id="7041138">ct</span><span class="op" id="7041140">.</span><span class="ident" id="7041141">test</span><span class="op" id="7041145">(</span><span class="ident" id="7041146">t</span><span class="op" id="7041147">)</span><br>
<span class="lineno"></span><span class="op" id="7041149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7041152">func</span>&nbsp;<span class="ident" id="7041157">doConcurrentTest</span><span class="op" id="7041173">(</span><span class="ident" id="7041174">t</span>&nbsp;<span class="ident" id="7041176">testing</span><span class="op" id="7041183">.</span><span class="ident" id="7041184">TB</span><span class="op" id="7041186">,</span>&nbsp;<span class="ident" id="7041188">ct</span>&nbsp;<span class="ident" id="7041191">concurrentTest</span><span class="op" id="7041205">)</span>&nbsp;<span class="op" id="7041207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041210">maxProcs</span><span class="op" id="7041218">,</span>&nbsp;<span class="ident" id="7041220">numReqs</span>&nbsp;<span class="op" id="7041228">:=</span>&nbsp;<span class="num" id="7041231">1</span><span class="op" id="7041232">,</span>&nbsp;<span class="num" id="7041234">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041239">if</span>&nbsp;<span class="ident" id="7041242">testing</span><span class="op" id="7041249">.</span><span class="ident" id="7041250">Short</span><span class="op" id="7041255">(</span><span class="op" id="7041256">)</span>&nbsp;<span class="op" id="7041258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041262">maxProcs</span><span class="op" id="7041270">,</span>&nbsp;<span class="ident" id="7041272">numReqs</span>&nbsp;<span class="op" id="7041280">=</span>&nbsp;<span class="num" id="7041282">4</span><span class="op" id="7041283">,</span>&nbsp;<span class="num" id="7041285">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041292">defer</span>&nbsp;<span class="ident" id="7041298">runtime</span><span class="op" id="7041305">.</span><span class="ident" id="7041306">GOMAXPROCS</span><span class="op" id="7041316">(</span><span class="ident" id="7041317">runtime</span><span class="op" id="7041324">.</span><span class="ident" id="7041325">GOMAXPROCS</span><span class="op" id="7041335">(</span><span class="ident" id="7041336">maxProcs</span><span class="op" id="7041344">)</span><span class="op" id="7041345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041349">db</span>&nbsp;<span class="op" id="7041352">:=</span>&nbsp;<span class="ident" id="7041355">newTestDB</span><span class="op" id="7041364">(</span><span class="ident" id="7041365">t</span><span class="op" id="7041366">,</span>&nbsp;<span class="string" id="7041368">&#34;people&#34;</span><span class="op" id="7041376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041379">defer</span>&nbsp;<span class="ident" id="7041385">closeDB</span><span class="op" id="7041392">(</span><span class="ident" id="7041393">t</span><span class="op" id="7041394">,</span>&nbsp;<span class="ident" id="7041396">db</span><span class="op" id="7041398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041402">ct</span><span class="op" id="7041404">.</span><span class="ident" id="7041405">init</span><span class="op" id="7041409">(</span><span class="ident" id="7041410">t</span><span class="op" id="7041411">,</span>&nbsp;<span class="ident" id="7041413">db</span><span class="op" id="7041415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041418">defer</span>&nbsp;<span class="ident" id="7041424">ct</span><span class="op" id="7041426">.</span><span class="ident" id="7041427">finish</span><span class="op" id="7041433">(</span><span class="ident" id="7041434">t</span><span class="op" id="7041435">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041439">var</span>&nbsp;<span class="ident" id="7041443">wg</span>&nbsp;<span class="ident" id="7041446">sync</span><span class="op" id="7041450">.</span><span class="ident" id="7041451">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041462">wg</span><span class="op" id="7041464">.</span><span class="ident" id="7041465">Add</span><span class="op" id="7041468">(</span><span class="ident" id="7041469">numReqs</span><span class="op" id="7041476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041480">reqs</span>&nbsp;<span class="op" id="7041485">:=</span>&nbsp;<span class="builtinfunc" id="7041488">make</span><span class="op" id="7041492">(</span><span class="keyword" id="7041493">chan</span>&nbsp;<span class="builtintype" id="7041498">bool</span><span class="op" id="7041502">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041505">defer</span>&nbsp;<span class="builtinfunc" id="7041511">close</span><span class="op" id="7041516">(</span><span class="ident" id="7041517">reqs</span><span class="op" id="7041521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041525">for</span>&nbsp;<span class="ident" id="7041529">i</span>&nbsp;<span class="op" id="7041531">:=</span>&nbsp;<span class="num" id="7041534">0</span><span class="op" id="7041535">;</span>&nbsp;<span class="ident" id="7041537">i</span>&nbsp;<span class="op" id="7041539">&lt;</span>&nbsp;<span class="ident" id="7041541">maxProcs</span><span class="op" id="7041549">*</span><span class="num" id="7041550">2</span><span class="op" id="7041551">;</span>&nbsp;<span class="ident" id="7041553">i</span><span class="op" id="7041554">++</span>&nbsp;<span class="op" id="7041557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041561">go</span>&nbsp;<span class="keyword" id="7041564">func</span><span class="op" id="7041568">(</span><span class="op" id="7041569">)</span>&nbsp;<span class="op" id="7041571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041576">for</span>&nbsp;<span class="keyword" id="7041580">range</span>&nbsp;<span class="ident" id="7041586">reqs</span>&nbsp;<span class="op" id="7041591">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041597">err</span>&nbsp;<span class="op" id="7041601">:=</span>&nbsp;<span class="ident" id="7041604">ct</span><span class="op" id="7041606">.</span><span class="ident" id="7041607">test</span><span class="op" id="7041611">(</span><span class="ident" id="7041612">t</span><span class="op" id="7041613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041619">if</span>&nbsp;<span class="ident" id="7041622">err</span>&nbsp;<span class="op" id="7041626">!=</span>&nbsp;<span class="ident" id="7041629">nil</span>&nbsp;<span class="op" id="7041633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041640">wg</span><span class="op" id="7041642">.</span><span class="ident" id="7041643">Done</span><span class="op" id="7041647">(</span><span class="op" id="7041648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041655">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041668">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041674">wg</span><span class="op" id="7041676">.</span><span class="ident" id="7041677">Done</span><span class="op" id="7041681">(</span><span class="op" id="7041682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041691">}</span><span class="op" id="7041692">(</span><span class="op" id="7041693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041700">for</span>&nbsp;<span class="ident" id="7041704">i</span>&nbsp;<span class="op" id="7041706">:=</span>&nbsp;<span class="num" id="7041709">0</span><span class="op" id="7041710">;</span>&nbsp;<span class="ident" id="7041712">i</span>&nbsp;<span class="op" id="7041714">&lt;</span>&nbsp;<span class="ident" id="7041716">numReqs</span><span class="op" id="7041723">;</span>&nbsp;<span class="ident" id="7041725">i</span><span class="op" id="7041726">++</span>&nbsp;<span class="op" id="7041729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041733">reqs</span>&nbsp;<span class="op" id="7041738">&lt;-</span>&nbsp;<span class="builtintype" id="7041741">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041751">wg</span><span class="op" id="7041753">.</span><span class="ident" id="7041754">Wait</span><span class="op" id="7041758">(</span><span class="op" id="7041759">)</span><br>
<span class="lineno">1765</span><span class="op" id="7041761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7041764">func</span>&nbsp;<span class="ident" id="7041769">manyConcurrentQueries</span><span class="op" id="7041790">(</span><span class="ident" id="7041791">t</span>&nbsp;<span class="ident" id="7041793">testing</span><span class="op" id="7041800">.</span><span class="ident" id="7041801">TB</span><span class="op" id="7041803">)</span>&nbsp;<span class="op" id="7041805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041808">maxProcs</span><span class="op" id="7041816">,</span>&nbsp;<span class="ident" id="7041818">numReqs</span>&nbsp;<span class="op" id="7041826">:=</span>&nbsp;<span class="num" id="7041829">16</span><span class="op" id="7041831">,</span>&nbsp;<span class="num" id="7041833">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041838">if</span>&nbsp;<span class="ident" id="7041841">testing</span><span class="op" id="7041848">.</span><span class="ident" id="7041849">Short</span><span class="op" id="7041854">(</span><span class="op" id="7041855">)</span>&nbsp;<span class="op" id="7041857">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041861">maxProcs</span><span class="op" id="7041869">,</span>&nbsp;<span class="ident" id="7041871">numReqs</span>&nbsp;<span class="op" id="7041879">=</span>&nbsp;<span class="num" id="7041881">4</span><span class="op" id="7041882">,</span>&nbsp;<span class="num" id="7041884">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7041888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041891">defer</span>&nbsp;<span class="ident" id="7041897">runtime</span><span class="op" id="7041904">.</span><span class="ident" id="7041905">GOMAXPROCS</span><span class="op" id="7041915">(</span><span class="ident" id="7041916">runtime</span><span class="op" id="7041923">.</span><span class="ident" id="7041924">GOMAXPROCS</span><span class="op" id="7041934">(</span><span class="ident" id="7041935">maxProcs</span><span class="op" id="7041943">)</span><span class="op" id="7041944">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7041948">db</span>&nbsp;<span class="op" id="7041951">:=</span>&nbsp;<span class="ident" id="7041954">newTestDB</span><span class="op" id="7041963">(</span><span class="ident" id="7041964">t</span><span class="op" id="7041965">,</span>&nbsp;<span class="string" id="7041967">&#34;people&#34;</span><span class="op" id="7041975">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7041978">defer</span>&nbsp;<span class="ident" id="7041984">closeDB</span><span class="op" id="7041991">(</span><span class="ident" id="7041992">t</span><span class="op" id="7041993">,</span>&nbsp;<span class="ident" id="7041995">db</span><span class="op" id="7041997">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042001">stmt</span><span class="op" id="7042005">,</span>&nbsp;<span class="ident" id="7042007">err</span>&nbsp;<span class="op" id="7042011">:=</span>&nbsp;<span class="ident" id="7042014">db</span><span class="op" id="7042016">.</span><span class="ident" id="7042017">Prepare</span><span class="op" id="7042024">(</span><span class="string" id="7042025">&#34;SELECT|people|name|&#34;</span><span class="op" id="7042046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042049">if</span>&nbsp;<span class="ident" id="7042052">err</span>&nbsp;<span class="op" id="7042056">!=</span>&nbsp;<span class="ident" id="7042059">nil</span>&nbsp;<span class="op" id="7042063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042067">t</span><span class="op" id="7042068">.</span><span class="ident" id="7042069">Fatal</span><span class="op" id="7042074">(</span><span class="ident" id="7042075">err</span><span class="op" id="7042078">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042084">defer</span>&nbsp;<span class="ident" id="7042090">stmt</span><span class="op" id="7042094">.</span><span class="ident" id="7042095">Close</span><span class="op" id="7042100">(</span><span class="op" id="7042101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042105">var</span>&nbsp;<span class="ident" id="7042109">wg</span>&nbsp;<span class="ident" id="7042112">sync</span><span class="op" id="7042116">.</span><span class="ident" id="7042117">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042128">wg</span><span class="op" id="7042130">.</span><span class="ident" id="7042131">Add</span><span class="op" id="7042134">(</span><span class="ident" id="7042135">numReqs</span><span class="op" id="7042142">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042146">reqs</span>&nbsp;<span class="op" id="7042151">:=</span>&nbsp;<span class="builtinfunc" id="7042154">make</span><span class="op" id="7042158">(</span><span class="keyword" id="7042159">chan</span>&nbsp;<span class="builtintype" id="7042164">bool</span><span class="op" id="7042168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042171">defer</span>&nbsp;<span class="builtinfunc" id="7042177">close</span><span class="op" id="7042182">(</span><span class="ident" id="7042183">reqs</span><span class="op" id="7042187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042191">for</span>&nbsp;<span class="ident" id="7042195">i</span>&nbsp;<span class="op" id="7042197">:=</span>&nbsp;<span class="num" id="7042200">0</span><span class="op" id="7042201">;</span>&nbsp;<span class="ident" id="7042203">i</span>&nbsp;<span class="op" id="7042205">&lt;</span>&nbsp;<span class="ident" id="7042207">maxProcs</span><span class="op" id="7042215">*</span><span class="num" id="7042216">2</span><span class="op" id="7042217">;</span>&nbsp;<span class="ident" id="7042219">i</span><span class="op" id="7042220">++</span>&nbsp;<span class="op" id="7042223">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042227">go</span>&nbsp;<span class="keyword" id="7042230">func</span><span class="op" id="7042234">(</span><span class="op" id="7042235">)</span>&nbsp;<span class="op" id="7042237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042242">for</span>&nbsp;<span class="keyword" id="7042246">range</span>&nbsp;<span class="ident" id="7042252">reqs</span>&nbsp;<span class="op" id="7042257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042263">rows</span><span class="op" id="7042267">,</span>&nbsp;<span class="ident" id="7042269">err</span>&nbsp;<span class="op" id="7042273">:=</span>&nbsp;<span class="ident" id="7042276">stmt</span><span class="op" id="7042280">.</span><span class="ident" id="7042281">Query</span><span class="op" id="7042286">(</span><span class="op" id="7042287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042293">if</span>&nbsp;<span class="ident" id="7042296">err</span>&nbsp;<span class="op" id="7042300">!=</span>&nbsp;<span class="ident" id="7042303">nil</span>&nbsp;<span class="op" id="7042307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042314">t</span><span class="op" id="7042315">.</span><span class="ident" id="7042316">Errorf</span><span class="op" id="7042322">(</span><span class="string" id="7042323">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7042344">,</span>&nbsp;<span class="ident" id="7042346">err</span><span class="op" id="7042349">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042356">wg</span><span class="op" id="7042358">.</span><span class="ident" id="7042359">Done</span><span class="op" id="7042363">(</span><span class="op" id="7042364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042371">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042391">var</span>&nbsp;<span class="ident" id="7042395">name</span>&nbsp;<span class="builtintype" id="7042400">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042411">for</span>&nbsp;<span class="ident" id="7042415">rows</span><span class="op" id="7042419">.</span><span class="ident" id="7042420">Next</span><span class="op" id="7042424">(</span><span class="op" id="7042425">)</span>&nbsp;<span class="op" id="7042427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042434">rows</span><span class="op" id="7042438">.</span><span class="ident" id="7042439">Scan</span><span class="op" id="7042443">(</span><span class="op" id="7042444">&amp;</span><span class="ident" id="7042445">name</span><span class="op" id="7042449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042461">rows</span><span class="op" id="7042465">.</span><span class="ident" id="7042466">Close</span><span class="op" id="7042471">(</span><span class="op" id="7042472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042479">wg</span><span class="op" id="7042481">.</span><span class="ident" id="7042482">Done</span><span class="op" id="7042486">(</span><span class="op" id="7042487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042496">}</span><span class="op" id="7042497">(</span><span class="op" id="7042498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042505">for</span>&nbsp;<span class="ident" id="7042509">i</span>&nbsp;<span class="op" id="7042511">:=</span>&nbsp;<span class="num" id="7042514">0</span><span class="op" id="7042515">;</span>&nbsp;<span class="ident" id="7042517">i</span>&nbsp;<span class="op" id="7042519">&lt;</span>&nbsp;<span class="ident" id="7042521">numReqs</span><span class="op" id="7042528">;</span>&nbsp;<span class="ident" id="7042530">i</span><span class="op" id="7042531">++</span>&nbsp;<span class="op" id="7042534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042538">reqs</span>&nbsp;<span class="op" id="7042543">&lt;-</span>&nbsp;<span class="builtintype" id="7042546">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042556">wg</span><span class="op" id="7042558">.</span><span class="ident" id="7042559">Wait</span><span class="op" id="7042563">(</span><span class="op" id="7042564">)</span><br>
<span class="lineno">1815</span><span class="op" id="7042566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7042569">func</span>&nbsp;<span class="ident" id="7042574">TestIssue6081</span><span class="op" id="7042587">(</span><span class="ident" id="7042588">t</span>&nbsp;<span class="op" id="7042590">*</span><span class="ident" id="7042591">testing</span><span class="op" id="7042598">.</span><span class="ident" id="7042599">T</span><span class="op" id="7042600">)</span>&nbsp;<span class="op" id="7042602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042605">db</span>&nbsp;<span class="op" id="7042608">:=</span>&nbsp;<span class="ident" id="7042611">newTestDB</span><span class="op" id="7042620">(</span><span class="ident" id="7042621">t</span><span class="op" id="7042622">,</span>&nbsp;<span class="string" id="7042624">&#34;people&#34;</span><span class="op" id="7042632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042635">defer</span>&nbsp;<span class="ident" id="7042641">closeDB</span><span class="op" id="7042648">(</span><span class="ident" id="7042649">t</span><span class="op" id="7042650">,</span>&nbsp;<span class="ident" id="7042652">db</span><span class="op" id="7042654">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042658">drv</span>&nbsp;<span class="op" id="7042662">:=</span>&nbsp;<span class="ident" id="7042665">db</span><span class="op" id="7042667">.</span><span class="ident" id="7042668">driver</span><span class="op" id="7042674">.</span><span class="op" id="7042675">(</span><span class="op" id="7042676">*</span><span class="ident" id="7042677">fakeDriver</span><span class="op" id="7042687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042690">drv</span><span class="op" id="7042693">.</span><span class="ident" id="7042694">mu</span><span class="op" id="7042696">.</span><span class="ident" id="7042697">Lock</span><span class="op" id="7042701">(</span><span class="op" id="7042702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042705">opens0</span>&nbsp;<span class="op" id="7042712">:=</span>&nbsp;<span class="ident" id="7042715">drv</span><span class="op" id="7042718">.</span><span class="ident" id="7042719">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042730">closes0</span>&nbsp;<span class="op" id="7042738">:=</span>&nbsp;<span class="ident" id="7042741">drv</span><span class="op" id="7042744">.</span><span class="ident" id="7042745">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042757">drv</span><span class="op" id="7042760">.</span><span class="ident" id="7042761">mu</span><span class="op" id="7042763">.</span><span class="ident" id="7042764">Unlock</span><span class="op" id="7042770">(</span><span class="op" id="7042771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042775">stmt</span><span class="op" id="7042779">,</span>&nbsp;<span class="ident" id="7042781">err</span>&nbsp;<span class="op" id="7042785">:=</span>&nbsp;<span class="ident" id="7042788">db</span><span class="op" id="7042790">.</span><span class="ident" id="7042791">Prepare</span><span class="op" id="7042798">(</span><span class="string" id="7042799">&#34;SELECT|people|name|&#34;</span><span class="op" id="7042820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042823">if</span>&nbsp;<span class="ident" id="7042826">err</span>&nbsp;<span class="op" id="7042830">!=</span>&nbsp;<span class="ident" id="7042833">nil</span>&nbsp;<span class="op" id="7042837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042841">t</span><span class="op" id="7042842">.</span><span class="ident" id="7042843">Fatal</span><span class="op" id="7042848">(</span><span class="ident" id="7042849">err</span><span class="op" id="7042852">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7042858">rowsCloseHook</span>&nbsp;<span class="op" id="7042872">=</span>&nbsp;<span class="keyword" id="7042874">func</span><span class="op" id="7042878">(</span><span class="ident" id="7042879">rows</span>&nbsp;<span class="op" id="7042884">*</span><span class="ident" id="7042885">Rows</span><span class="op" id="7042889">,</span>&nbsp;<span class="ident" id="7042891">err</span>&nbsp;<span class="op" id="7042895">*</span><span class="builtintype" id="7042896">error</span><span class="op" id="7042901">)</span>&nbsp;<span class="op" id="7042903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042907">*</span><span class="ident" id="7042908">err</span>&nbsp;<span class="op" id="7042912">=</span>&nbsp;<span class="ident" id="7042914">driver</span><span class="op" id="7042920">.</span><span class="ident" id="7042921">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7042933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042936">defer</span>&nbsp;<span class="keyword" id="7042942">func</span><span class="op" id="7042946">(</span><span class="op" id="7042947">)</span>&nbsp;<span class="op" id="7042949">{</span>&nbsp;<span class="ident" id="7042951">rowsCloseHook</span>&nbsp;<span class="op" id="7042965">=</span>&nbsp;<span class="ident" id="7042967">nil</span>&nbsp;<span class="op" id="7042971">}</span><span class="op" id="7042972">(</span><span class="op" id="7042973">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7042976">for</span>&nbsp;<span class="ident" id="7042980">i</span>&nbsp;<span class="op" id="7042982">:=</span>&nbsp;<span class="num" id="7042985">0</span><span class="op" id="7042986">;</span>&nbsp;<span class="ident" id="7042988">i</span>&nbsp;<span class="op" id="7042990">&lt;</span>&nbsp;<span class="num" id="7042992">10</span><span class="op" id="7042994">;</span>&nbsp;<span class="ident" id="7042996">i</span><span class="op" id="7042997">++</span>&nbsp;<span class="op" id="7043000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043004">rows</span><span class="op" id="7043008">,</span>&nbsp;<span class="ident" id="7043010">err</span>&nbsp;<span class="op" id="7043014">:=</span>&nbsp;<span class="ident" id="7043017">stmt</span><span class="op" id="7043021">.</span><span class="ident" id="7043022">Query</span><span class="op" id="7043027">(</span><span class="op" id="7043028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7043032">if</span>&nbsp;<span class="ident" id="7043035">err</span>&nbsp;<span class="op" id="7043039">!=</span>&nbsp;<span class="ident" id="7043042">nil</span>&nbsp;<span class="op" id="7043046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043051">t</span><span class="op" id="7043052">.</span><span class="ident" id="7043053">Fatal</span><span class="op" id="7043058">(</span><span class="ident" id="7043059">err</span><span class="op" id="7043062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043066">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043070">rows</span><span class="op" id="7043074">.</span><span class="ident" id="7043075">Close</span><span class="op" id="7043080">(</span><span class="op" id="7043081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7043087">if</span>&nbsp;<span class="ident" id="7043090">n</span>&nbsp;<span class="op" id="7043092">:=</span>&nbsp;<span class="builtinfunc" id="7043095">len</span><span class="op" id="7043098">(</span><span class="ident" id="7043099">stmt</span><span class="op" id="7043103">.</span><span class="ident" id="7043104">css</span><span class="op" id="7043107">)</span><span class="op" id="7043108">;</span>&nbsp;<span class="ident" id="7043110">n</span>&nbsp;<span class="op" id="7043112">&gt;</span>&nbsp;<span class="num" id="7043114">1</span>&nbsp;<span class="op" id="7043116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043120">t</span><span class="op" id="7043121">.</span><span class="ident" id="7043122">Errorf</span><span class="op" id="7043128">(</span><span class="string" id="7043129">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7043161">,</span>&nbsp;<span class="ident" id="7043163">n</span><span class="op" id="7043164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043167">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043170">stmt</span><span class="op" id="7043174">.</span><span class="ident" id="7043175">Close</span><span class="op" id="7043180">(</span><span class="op" id="7043181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7043184">if</span>&nbsp;<span class="ident" id="7043187">n</span>&nbsp;<span class="op" id="7043189">:=</span>&nbsp;<span class="builtinfunc" id="7043192">len</span><span class="op" id="7043195">(</span><span class="ident" id="7043196">stmt</span><span class="op" id="7043200">.</span><span class="ident" id="7043201">css</span><span class="op" id="7043204">)</span><span class="op" id="7043205">;</span>&nbsp;<span class="ident" id="7043207">n</span>&nbsp;<span class="op" id="7043209">!=</span>&nbsp;<span class="num" id="7043212">0</span>&nbsp;<span class="op" id="7043214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043218">t</span><span class="op" id="7043219">.</span><span class="ident" id="7043220">Errorf</span><span class="op" id="7043226">(</span><span class="string" id="7043227">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7043268">,</span>&nbsp;<span class="ident" id="7043270">n</span><span class="op" id="7043271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043278">drv</span><span class="op" id="7043281">.</span><span class="ident" id="7043282">mu</span><span class="op" id="7043284">.</span><span class="ident" id="7043285">Lock</span><span class="op" id="7043289">(</span><span class="op" id="7043290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043293">opens</span>&nbsp;<span class="op" id="7043299">:=</span>&nbsp;<span class="ident" id="7043302">drv</span><span class="op" id="7043305">.</span><span class="ident" id="7043306">openCount</span>&nbsp;<span class="op" id="7043316">-</span>&nbsp;<span class="ident" id="7043318">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043326">closes</span>&nbsp;<span class="op" id="7043333">:=</span>&nbsp;<span class="ident" id="7043336">drv</span><span class="op" id="7043339">.</span><span class="ident" id="7043340">closeCount</span>&nbsp;<span class="op" id="7043351">-</span>&nbsp;<span class="ident" id="7043353">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043362">drv</span><span class="op" id="7043365">.</span><span class="ident" id="7043366">mu</span><span class="op" id="7043368">.</span><span class="ident" id="7043369">Unlock</span><span class="op" id="7043375">(</span><span class="op" id="7043376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7043379">if</span>&nbsp;<span class="ident" id="7043382">opens</span>&nbsp;<span class="op" id="7043388">&lt;</span>&nbsp;<span class="num" id="7043390">9</span>&nbsp;<span class="op" id="7043392">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043396">t</span><span class="op" id="7043397">.</span><span class="ident" id="7043398">Errorf</span><span class="op" id="7043404">(</span><span class="string" id="7043405">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7043428">,</span>&nbsp;<span class="ident" id="7043430">opens</span><span class="op" id="7043435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7043441">if</span>&nbsp;<span class="ident" id="7043444">closes</span>&nbsp;<span class="op" id="7043451">&lt;</span>&nbsp;<span class="num" id="7043453">9</span>&nbsp;<span class="op" id="7043455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043459">t</span><span class="op" id="7043460">.</span><span class="ident" id="7043461">Errorf</span><span class="op" id="7043467">(</span><span class="string" id="7043468">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7043492">,</span>&nbsp;<span class="ident" id="7043494">closes</span><span class="op" id="7043500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7043503">}</span><br>
<span class="lineno">1860</span><span class="op" id="7043505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7043508">func</span>&nbsp;<span class="ident" id="7043513">TestConcurrency</span><span class="op" id="7043528">(</span><span class="ident" id="7043529">t</span>&nbsp;<span class="op" id="7043531">*</span><span class="ident" id="7043532">testing</span><span class="op" id="7043539">.</span><span class="ident" id="7043540">T</span><span class="op" id="7043541">)</span>&nbsp;<span class="op" id="7043543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043546">doConcurrentTest</span><span class="op" id="7043562">(</span><span class="ident" id="7043563">t</span><span class="op" id="7043564">,</span>&nbsp;<span class="builtinfunc" id="7043566">new</span><span class="op" id="7043569">(</span><span class="ident" id="7043570">concurrentDBQueryTest</span><span class="op" id="7043591">)</span><span class="op" id="7043592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043595">doConcurrentTest</span><span class="op" id="7043611">(</span><span class="ident" id="7043612">t</span><span class="op" id="7043613">,</span>&nbsp;<span class="builtinfunc" id="7043615">new</span><span class="op" id="7043618">(</span><span class="ident" id="7043619">concurrentDBExecTest</span><span class="op" id="7043639">)</span><span class="op" id="7043640">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043643">doConcurrentTest</span><span class="op" id="7043659">(</span><span class="ident" id="7043660">t</span><span class="op" id="7043661">,</span>&nbsp;<span class="builtinfunc" id="7043663">new</span><span class="op" id="7043666">(</span><span class="ident" id="7043667">concurrentStmtQueryTest</span><span class="op" id="7043690">)</span><span class="op" id="7043691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043694">doConcurrentTest</span><span class="op" id="7043710">(</span><span class="ident" id="7043711">t</span><span class="op" id="7043712">,</span>&nbsp;<span class="builtinfunc" id="7043714">new</span><span class="op" id="7043717">(</span><span class="ident" id="7043718">concurrentStmtExecTest</span><span class="op" id="7043740">)</span><span class="op" id="7043741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043744">doConcurrentTest</span><span class="op" id="7043760">(</span><span class="ident" id="7043761">t</span><span class="op" id="7043762">,</span>&nbsp;<span class="builtinfunc" id="7043764">new</span><span class="op" id="7043767">(</span><span class="ident" id="7043768">concurrentTxQueryTest</span><span class="op" id="7043789">)</span><span class="op" id="7043790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043793">doConcurrentTest</span><span class="op" id="7043809">(</span><span class="ident" id="7043810">t</span><span class="op" id="7043811">,</span>&nbsp;<span class="builtinfunc" id="7043813">new</span><span class="op" id="7043816">(</span><span class="ident" id="7043817">concurrentTxExecTest</span><span class="op" id="7043837">)</span><span class="op" id="7043838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043841">doConcurrentTest</span><span class="op" id="7043857">(</span><span class="ident" id="7043858">t</span><span class="op" id="7043859">,</span>&nbsp;<span class="builtinfunc" id="7043861">new</span><span class="op" id="7043864">(</span><span class="ident" id="7043865">concurrentTxStmtQueryTest</span><span class="op" id="7043890">)</span><span class="op" id="7043891">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043894">doConcurrentTest</span><span class="op" id="7043910">(</span><span class="ident" id="7043911">t</span><span class="op" id="7043912">,</span>&nbsp;<span class="builtinfunc" id="7043914">new</span><span class="op" id="7043917">(</span><span class="ident" id="7043918">concurrentTxStmtExecTest</span><span class="op" id="7043942">)</span><span class="op" id="7043943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7043946">doConcurrentTest</span><span class="op" id="7043962">(</span><span class="ident" id="7043963">t</span><span class="op" id="7043964">,</span>&nbsp;<span class="builtinfunc" id="7043966">new</span><span class="op" id="7043969">(</span><span class="ident" id="7043970">concurrentRandomTest</span><span class="op" id="7043990">)</span><span class="op" id="7043991">)</span><br>
<span class="lineno"></span><span class="op" id="7043993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7043996">func</span>&nbsp;<span class="ident" id="7044001">TestConnectionLeak</span><span class="op" id="7044019">(</span><span class="ident" id="7044020">t</span>&nbsp;<span class="op" id="7044022">*</span><span class="ident" id="7044023">testing</span><span class="op" id="7044030">.</span><span class="ident" id="7044031">T</span><span class="op" id="7044032">)</span>&nbsp;<span class="op" id="7044034">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044037">db</span>&nbsp;<span class="op" id="7044040">:=</span>&nbsp;<span class="ident" id="7044043">newTestDB</span><span class="op" id="7044052">(</span><span class="ident" id="7044053">t</span><span class="op" id="7044054">,</span>&nbsp;<span class="string" id="7044056">&#34;people&#34;</span><span class="op" id="7044064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044067">defer</span>&nbsp;<span class="ident" id="7044073">closeDB</span><span class="op" id="7044080">(</span><span class="ident" id="7044081">t</span><span class="op" id="7044082">,</span>&nbsp;<span class="ident" id="7044084">db</span><span class="op" id="7044086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044089">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044130">rows</span>&nbsp;<span class="op" id="7044135">:=</span>&nbsp;<span class="builtinfunc" id="7044138">make</span><span class="op" id="7044142">(</span><span class="op" id="7044143">[</span><span class="op" id="7044144">]</span><span class="op" id="7044145">*</span><span class="ident" id="7044146">Rows</span><span class="op" id="7044150">,</span>&nbsp;<span class="ident" id="7044152">defaultMaxIdleConns</span><span class="op" id="7044171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044174">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044240">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044310">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044327">db</span><span class="op" id="7044329">.</span><span class="ident" id="7044330">SetMaxOpenConns</span><span class="op" id="7044345">(</span><span class="builtinfunc" id="7044346">len</span><span class="op" id="7044349">(</span><span class="ident" id="7044350">rows</span><span class="op" id="7044354">)</span>&nbsp;<span class="op" id="7044356">+</span>&nbsp;<span class="num" id="7044358">1</span><span class="op" id="7044359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044362">for</span>&nbsp;<span class="ident" id="7044366">ii</span>&nbsp;<span class="op" id="7044369">:=</span>&nbsp;<span class="keyword" id="7044372">range</span>&nbsp;<span class="ident" id="7044378">rows</span>&nbsp;<span class="op" id="7044383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044387">r</span><span class="op" id="7044388">,</span>&nbsp;<span class="ident" id="7044390">err</span>&nbsp;<span class="op" id="7044394">:=</span>&nbsp;<span class="ident" id="7044397">db</span><span class="op" id="7044399">.</span><span class="ident" id="7044400">Query</span><span class="op" id="7044405">(</span><span class="string" id="7044406">&#34;SELECT|people|name|&#34;</span><span class="op" id="7044427">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044431">if</span>&nbsp;<span class="ident" id="7044434">err</span>&nbsp;<span class="op" id="7044438">!=</span>&nbsp;<span class="ident" id="7044441">nil</span>&nbsp;<span class="op" id="7044445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044450">t</span><span class="op" id="7044451">.</span><span class="ident" id="7044452">Fatal</span><span class="op" id="7044457">(</span><span class="ident" id="7044458">err</span><span class="op" id="7044461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7044465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044469">r</span><span class="op" id="7044470">.</span><span class="ident" id="7044471">Next</span><span class="op" id="7044475">(</span><span class="op" id="7044476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044480">if</span>&nbsp;<span class="ident" id="7044483">err</span>&nbsp;<span class="op" id="7044487">:=</span>&nbsp;<span class="ident" id="7044490">r</span><span class="op" id="7044491">.</span><span class="ident" id="7044492">Err</span><span class="op" id="7044495">(</span><span class="op" id="7044496">)</span><span class="op" id="7044497">;</span>&nbsp;<span class="ident" id="7044499">err</span>&nbsp;<span class="op" id="7044503">!=</span>&nbsp;<span class="ident" id="7044506">nil</span>&nbsp;<span class="op" id="7044510">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044515">t</span><span class="op" id="7044516">.</span><span class="ident" id="7044517">Fatal</span><span class="op" id="7044522">(</span><span class="ident" id="7044523">err</span><span class="op" id="7044526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7044530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044534">rows</span><span class="op" id="7044538">[</span><span class="ident" id="7044539">ii</span><span class="op" id="7044541">]</span>&nbsp;<span class="op" id="7044543">=</span>&nbsp;<span class="ident" id="7044545">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7044548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044551">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044610">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044674">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044710">drv</span>&nbsp;<span class="op" id="7044714">:=</span>&nbsp;<span class="ident" id="7044717">db</span><span class="op" id="7044719">.</span><span class="ident" id="7044720">driver</span><span class="op" id="7044726">.</span><span class="op" id="7044727">(</span><span class="op" id="7044728">*</span><span class="ident" id="7044729">fakeDriver</span><span class="op" id="7044739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044742">drv</span><span class="op" id="7044745">.</span><span class="ident" id="7044746">waitCh</span>&nbsp;<span class="op" id="7044753">=</span>&nbsp;<span class="builtinfunc" id="7044755">make</span><span class="op" id="7044759">(</span><span class="keyword" id="7044760">chan</span>&nbsp;<span class="keyword" id="7044765">struct</span><span class="op" id="7044771">{</span><span class="op" id="7044772">}</span><span class="op" id="7044773">,</span>&nbsp;<span class="num" id="7044775">1</span><span class="op" id="7044776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044779">drv</span><span class="op" id="7044782">.</span><span class="ident" id="7044783">waitingCh</span>&nbsp;<span class="op" id="7044793">=</span>&nbsp;<span class="builtinfunc" id="7044795">make</span><span class="op" id="7044799">(</span><span class="keyword" id="7044800">chan</span>&nbsp;<span class="keyword" id="7044805">struct</span><span class="op" id="7044811">{</span><span class="op" id="7044812">}</span><span class="op" id="7044813">,</span>&nbsp;<span class="num" id="7044815">1</span><span class="op" id="7044816">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044819">var</span>&nbsp;<span class="ident" id="7044823">wg</span>&nbsp;<span class="ident" id="7044826">sync</span><span class="op" id="7044830">.</span><span class="ident" id="7044831">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044842">wg</span><span class="op" id="7044844">.</span><span class="ident" id="7044845">Add</span><span class="op" id="7044848">(</span><span class="num" id="7044849">1</span><span class="op" id="7044850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044853">go</span>&nbsp;<span class="keyword" id="7044856">func</span><span class="op" id="7044860">(</span><span class="op" id="7044861">)</span>&nbsp;<span class="op" id="7044863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044867">r</span><span class="op" id="7044868">,</span>&nbsp;<span class="ident" id="7044870">err</span>&nbsp;<span class="op" id="7044874">:=</span>&nbsp;<span class="ident" id="7044877">db</span><span class="op" id="7044879">.</span><span class="ident" id="7044880">Query</span><span class="op" id="7044885">(</span><span class="string" id="7044886">&#34;SELECT|people|name|&#34;</span><span class="op" id="7044907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7044911">if</span>&nbsp;<span class="ident" id="7044914">err</span>&nbsp;<span class="op" id="7044918">!=</span>&nbsp;<span class="ident" id="7044921">nil</span>&nbsp;<span class="op" id="7044925">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044930">t</span><span class="op" id="7044931">.</span><span class="ident" id="7044932">Fatal</span><span class="op" id="7044937">(</span><span class="ident" id="7044938">err</span><span class="op" id="7044941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7044945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044949">r</span><span class="op" id="7044950">.</span><span class="ident" id="7044951">Close</span><span class="op" id="7044956">(</span><span class="op" id="7044957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7044961">wg</span><span class="op" id="7044963">.</span><span class="ident" id="7044964">Done</span><span class="op" id="7044968">(</span><span class="op" id="7044969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7044972">}</span><span class="op" id="7044973">(</span><span class="op" id="7044974">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7044977">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7045046">&lt;-</span><span class="ident" id="7045048">drv</span><span class="op" id="7045051">.</span><span class="ident" id="7045052">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045063">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045130">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7045190">for</span>&nbsp;<span class="ident" id="7045194">_</span><span class="op" id="7045195">,</span>&nbsp;<span class="ident" id="7045197">v</span>&nbsp;<span class="op" id="7045199">:=</span>&nbsp;<span class="keyword" id="7045202">range</span>&nbsp;<span class="ident" id="7045208">rows</span>&nbsp;<span class="op" id="7045213">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045217">v</span><span class="op" id="7045218">.</span><span class="ident" id="7045219">Close</span><span class="op" id="7045224">(</span><span class="op" id="7045225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7045228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045231">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045302">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045373">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7045442">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045458">drv</span><span class="op" id="7045461">.</span><span class="ident" id="7045462">waitCh</span>&nbsp;<span class="op" id="7045469">&lt;-</span>&nbsp;<span class="keyword" id="7045472">struct</span><span class="op" id="7045478">{</span><span class="op" id="7045479">}</span><span class="op" id="7045480">{</span><span class="op" id="7045481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045484">wg</span><span class="op" id="7045486">.</span><span class="ident" id="7045487">Wait</span><span class="op" id="7045491">(</span><span class="op" id="7045492">)</span><br>
<span class="lineno"></span><span class="op" id="7045494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7045497">func</span>&nbsp;<span class="ident" id="7045502">BenchmarkConcurrentDBExec</span><span class="op" id="7045527">(</span><span class="ident" id="7045528">b</span>&nbsp;<span class="op" id="7045530">*</span><span class="ident" id="7045531">testing</span><span class="op" id="7045538">.</span><span class="ident" id="7045539">B</span><span class="op" id="7045540">)</span>&nbsp;<span class="op" id="7045542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045545">b</span><span class="op" id="7045546">.</span><span class="ident" id="7045547">ReportAllocs</span><span class="op" id="7045559">(</span><span class="op" id="7045560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045563">ct</span>&nbsp;<span class="op" id="7045566">:=</span>&nbsp;<span class="builtinfunc" id="7045569">new</span><span class="op" id="7045572">(</span><span class="ident" id="7045573">concurrentDBExecTest</span><span class="op" id="7045593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7045596">for</span>&nbsp;<span class="ident" id="7045600">i</span>&nbsp;<span class="op" id="7045602">:=</span>&nbsp;<span class="num" id="7045605">0</span><span class="op" id="7045606">;</span>&nbsp;<span class="ident" id="7045608">i</span>&nbsp;<span class="op" id="7045610">&lt;</span>&nbsp;<span class="ident" id="7045612">b</span><span class="op" id="7045613">.</span><span class="ident" id="7045614">N</span><span class="op" id="7045615">;</span>&nbsp;<span class="ident" id="7045617">i</span><span class="op" id="7045618">++</span>&nbsp;<span class="op" id="7045621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045625">doConcurrentTest</span><span class="op" id="7045641">(</span><span class="ident" id="7045642">b</span><span class="op" id="7045643">,</span>&nbsp;<span class="ident" id="7045645">ct</span><span class="op" id="7045647">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7045650">}</span><br>
<span class="lineno"></span><span class="op" id="7045652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7045655">func</span>&nbsp;<span class="ident" id="7045660">BenchmarkConcurrentStmtQuery</span><span class="op" id="7045688">(</span><span class="ident" id="7045689">b</span>&nbsp;<span class="op" id="7045691">*</span><span class="ident" id="7045692">testing</span><span class="op" id="7045699">.</span><span class="ident" id="7045700">B</span><span class="op" id="7045701">)</span>&nbsp;<span class="op" id="7045703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045706">b</span><span class="op" id="7045707">.</span><span class="ident" id="7045708">ReportAllocs</span><span class="op" id="7045720">(</span><span class="op" id="7045721">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045724">ct</span>&nbsp;<span class="op" id="7045727">:=</span>&nbsp;<span class="builtinfunc" id="7045730">new</span><span class="op" id="7045733">(</span><span class="ident" id="7045734">concurrentStmtQueryTest</span><span class="op" id="7045757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7045760">for</span>&nbsp;<span class="ident" id="7045764">i</span>&nbsp;<span class="op" id="7045766">:=</span>&nbsp;<span class="num" id="7045769">0</span><span class="op" id="7045770">;</span>&nbsp;<span class="ident" id="7045772">i</span>&nbsp;<span class="op" id="7045774">&lt;</span>&nbsp;<span class="ident" id="7045776">b</span><span class="op" id="7045777">.</span><span class="ident" id="7045778">N</span><span class="op" id="7045779">;</span>&nbsp;<span class="ident" id="7045781">i</span><span class="op" id="7045782">++</span>&nbsp;<span class="op" id="7045785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045789">doConcurrentTest</span><span class="op" id="7045805">(</span><span class="ident" id="7045806">b</span><span class="op" id="7045807">,</span>&nbsp;<span class="ident" id="7045809">ct</span><span class="op" id="7045811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7045814">}</span><br>
<span class="lineno"></span><span class="op" id="7045816">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7045819">func</span>&nbsp;<span class="ident" id="7045824">BenchmarkConcurrentStmtExec</span><span class="op" id="7045851">(</span><span class="ident" id="7045852">b</span>&nbsp;<span class="op" id="7045854">*</span><span class="ident" id="7045855">testing</span><span class="op" id="7045862">.</span><span class="ident" id="7045863">B</span><span class="op" id="7045864">)</span>&nbsp;<span class="op" id="7045866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045869">b</span><span class="op" id="7045870">.</span><span class="ident" id="7045871">ReportAllocs</span><span class="op" id="7045883">(</span><span class="op" id="7045884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045887">ct</span>&nbsp;<span class="op" id="7045890">:=</span>&nbsp;<span class="builtinfunc" id="7045893">new</span><span class="op" id="7045896">(</span><span class="ident" id="7045897">concurrentStmtExecTest</span><span class="op" id="7045919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7045922">for</span>&nbsp;<span class="ident" id="7045926">i</span>&nbsp;<span class="op" id="7045928">:=</span>&nbsp;<span class="num" id="7045931">0</span><span class="op" id="7045932">;</span>&nbsp;<span class="ident" id="7045934">i</span>&nbsp;<span class="op" id="7045936">&lt;</span>&nbsp;<span class="ident" id="7045938">b</span><span class="op" id="7045939">.</span><span class="ident" id="7045940">N</span><span class="op" id="7045941">;</span>&nbsp;<span class="ident" id="7045943">i</span><span class="op" id="7045944">++</span>&nbsp;<span class="op" id="7045947">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7045951">doConcurrentTest</span><span class="op" id="7045967">(</span><span class="ident" id="7045968">b</span><span class="op" id="7045969">,</span>&nbsp;<span class="ident" id="7045971">ct</span><span class="op" id="7045973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7045976">}</span><br>
<span class="lineno"></span><span class="op" id="7045978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7045981">func</span>&nbsp;<span class="ident" id="7045986">BenchmarkConcurrentTxQuery</span><span class="op" id="7046012">(</span><span class="ident" id="7046013">b</span>&nbsp;<span class="op" id="7046015">*</span><span class="ident" id="7046016">testing</span><span class="op" id="7046023">.</span><span class="ident" id="7046024">B</span><span class="op" id="7046025">)</span>&nbsp;<span class="op" id="7046027">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046030">b</span><span class="op" id="7046031">.</span><span class="ident" id="7046032">ReportAllocs</span><span class="op" id="7046044">(</span><span class="op" id="7046045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046048">ct</span>&nbsp;<span class="op" id="7046051">:=</span>&nbsp;<span class="builtinfunc" id="7046054">new</span><span class="op" id="7046057">(</span><span class="ident" id="7046058">concurrentTxQueryTest</span><span class="op" id="7046079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7046082">for</span>&nbsp;<span class="ident" id="7046086">i</span>&nbsp;<span class="op" id="7046088">:=</span>&nbsp;<span class="num" id="7046091">0</span><span class="op" id="7046092">;</span>&nbsp;<span class="ident" id="7046094">i</span>&nbsp;<span class="op" id="7046096">&lt;</span>&nbsp;<span class="ident" id="7046098">b</span><span class="op" id="7046099">.</span><span class="ident" id="7046100">N</span><span class="op" id="7046101">;</span>&nbsp;<span class="ident" id="7046103">i</span><span class="op" id="7046104">++</span>&nbsp;<span class="op" id="7046107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046111">doConcurrentTest</span><span class="op" id="7046127">(</span><span class="ident" id="7046128">b</span><span class="op" id="7046129">,</span>&nbsp;<span class="ident" id="7046131">ct</span><span class="op" id="7046133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7046136">}</span><br>
<span class="lineno">1955</span><span class="op" id="7046138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7046141">func</span>&nbsp;<span class="ident" id="7046146">BenchmarkConcurrentTxExec</span><span class="op" id="7046171">(</span><span class="ident" id="7046172">b</span>&nbsp;<span class="op" id="7046174">*</span><span class="ident" id="7046175">testing</span><span class="op" id="7046182">.</span><span class="ident" id="7046183">B</span><span class="op" id="7046184">)</span>&nbsp;<span class="op" id="7046186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046189">b</span><span class="op" id="7046190">.</span><span class="ident" id="7046191">ReportAllocs</span><span class="op" id="7046203">(</span><span class="op" id="7046204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046207">ct</span>&nbsp;<span class="op" id="7046210">:=</span>&nbsp;<span class="builtinfunc" id="7046213">new</span><span class="op" id="7046216">(</span><span class="ident" id="7046217">concurrentTxExecTest</span><span class="op" id="7046237">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7046240">for</span>&nbsp;<span class="ident" id="7046244">i</span>&nbsp;<span class="op" id="7046246">:=</span>&nbsp;<span class="num" id="7046249">0</span><span class="op" id="7046250">;</span>&nbsp;<span class="ident" id="7046252">i</span>&nbsp;<span class="op" id="7046254">&lt;</span>&nbsp;<span class="ident" id="7046256">b</span><span class="op" id="7046257">.</span><span class="ident" id="7046258">N</span><span class="op" id="7046259">;</span>&nbsp;<span class="ident" id="7046261">i</span><span class="op" id="7046262">++</span>&nbsp;<span class="op" id="7046265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046269">doConcurrentTest</span><span class="op" id="7046285">(</span><span class="ident" id="7046286">b</span><span class="op" id="7046287">,</span>&nbsp;<span class="ident" id="7046289">ct</span><span class="op" id="7046291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7046294">}</span><br>
<span class="lineno"></span><span class="op" id="7046296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7046299">func</span>&nbsp;<span class="ident" id="7046304">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7046334">(</span><span class="ident" id="7046335">b</span>&nbsp;<span class="op" id="7046337">*</span><span class="ident" id="7046338">testing</span><span class="op" id="7046345">.</span><span class="ident" id="7046346">B</span><span class="op" id="7046347">)</span>&nbsp;<span class="op" id="7046349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046352">b</span><span class="op" id="7046353">.</span><span class="ident" id="7046354">ReportAllocs</span><span class="op" id="7046366">(</span><span class="op" id="7046367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046370">ct</span>&nbsp;<span class="op" id="7046373">:=</span>&nbsp;<span class="builtinfunc" id="7046376">new</span><span class="op" id="7046379">(</span><span class="ident" id="7046380">concurrentTxStmtQueryTest</span><span class="op" id="7046405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7046408">for</span>&nbsp;<span class="ident" id="7046412">i</span>&nbsp;<span class="op" id="7046414">:=</span>&nbsp;<span class="num" id="7046417">0</span><span class="op" id="7046418">;</span>&nbsp;<span class="ident" id="7046420">i</span>&nbsp;<span class="op" id="7046422">&lt;</span>&nbsp;<span class="ident" id="7046424">b</span><span class="op" id="7046425">.</span><span class="ident" id="7046426">N</span><span class="op" id="7046427">;</span>&nbsp;<span class="ident" id="7046429">i</span><span class="op" id="7046430">++</span>&nbsp;<span class="op" id="7046433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046437">doConcurrentTest</span><span class="op" id="7046453">(</span><span class="ident" id="7046454">b</span><span class="op" id="7046455">,</span>&nbsp;<span class="ident" id="7046457">ct</span><span class="op" id="7046459">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7046462">}</span><br>
<span class="lineno"></span><span class="op" id="7046464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7046467">func</span>&nbsp;<span class="ident" id="7046472">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7046501">(</span><span class="ident" id="7046502">b</span>&nbsp;<span class="op" id="7046504">*</span><span class="ident" id="7046505">testing</span><span class="op" id="7046512">.</span><span class="ident" id="7046513">B</span><span class="op" id="7046514">)</span>&nbsp;<span class="op" id="7046516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046519">b</span><span class="op" id="7046520">.</span><span class="ident" id="7046521">ReportAllocs</span><span class="op" id="7046533">(</span><span class="op" id="7046534">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046537">ct</span>&nbsp;<span class="op" id="7046540">:=</span>&nbsp;<span class="builtinfunc" id="7046543">new</span><span class="op" id="7046546">(</span><span class="ident" id="7046547">concurrentTxStmtExecTest</span><span class="op" id="7046571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7046574">for</span>&nbsp;<span class="ident" id="7046578">i</span>&nbsp;<span class="op" id="7046580">:=</span>&nbsp;<span class="num" id="7046583">0</span><span class="op" id="7046584">;</span>&nbsp;<span class="ident" id="7046586">i</span>&nbsp;<span class="op" id="7046588">&lt;</span>&nbsp;<span class="ident" id="7046590">b</span><span class="op" id="7046591">.</span><span class="ident" id="7046592">N</span><span class="op" id="7046593">;</span>&nbsp;<span class="ident" id="7046595">i</span><span class="op" id="7046596">++</span>&nbsp;<span class="op" id="7046599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046603">doConcurrentTest</span><span class="op" id="7046619">(</span><span class="ident" id="7046620">b</span><span class="op" id="7046621">,</span>&nbsp;<span class="ident" id="7046623">ct</span><span class="op" id="7046625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7046628">}</span><br>
<span class="lineno"></span><span class="op" id="7046630">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7046633">func</span>&nbsp;<span class="ident" id="7046638">BenchmarkConcurrentRandom</span><span class="op" id="7046663">(</span><span class="ident" id="7046664">b</span>&nbsp;<span class="op" id="7046666">*</span><span class="ident" id="7046667">testing</span><span class="op" id="7046674">.</span><span class="ident" id="7046675">B</span><span class="op" id="7046676">)</span>&nbsp;<span class="op" id="7046678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046681">b</span><span class="op" id="7046682">.</span><span class="ident" id="7046683">ReportAllocs</span><span class="op" id="7046695">(</span><span class="op" id="7046696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046699">ct</span>&nbsp;<span class="op" id="7046702">:=</span>&nbsp;<span class="builtinfunc" id="7046705">new</span><span class="op" id="7046708">(</span><span class="ident" id="7046709">concurrentRandomTest</span><span class="op" id="7046729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7046732">for</span>&nbsp;<span class="ident" id="7046736">i</span>&nbsp;<span class="op" id="7046738">:=</span>&nbsp;<span class="num" id="7046741">0</span><span class="op" id="7046742">;</span>&nbsp;<span class="ident" id="7046744">i</span>&nbsp;<span class="op" id="7046746">&lt;</span>&nbsp;<span class="ident" id="7046748">b</span><span class="op" id="7046749">.</span><span class="ident" id="7046750">N</span><span class="op" id="7046751">;</span>&nbsp;<span class="ident" id="7046753">i</span><span class="op" id="7046754">++</span>&nbsp;<span class="op" id="7046757">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7046761">doConcurrentTest</span><span class="op" id="7046777">(</span><span class="ident" id="7046778">b</span><span class="op" id="7046779">,</span>&nbsp;<span class="ident" id="7046781">ct</span><span class="op" id="7046783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7046786">}</span><br>
<span class="lineno"></span><span class="op" id="7046788">}</span>
</div>
</body>
</html>
