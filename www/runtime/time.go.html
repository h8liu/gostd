<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1743918">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1743973">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1744027">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1744078">//&nbsp;Time-related&nbsp;runtime&nbsp;and&nbsp;pieces&nbsp;of&nbsp;package&nbsp;time.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1744131">package</span>&nbsp;<span class="ident" id="1744139">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1744148">import</span>&nbsp;<span class="string" id="1744155">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1744165">//&nbsp;Package&nbsp;time&nbsp;knows&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1744217">//&nbsp;If&nbsp;this&nbsp;struct&nbsp;changes,&nbsp;adjust&nbsp;../time/sleep.go:/runtimeTimer.</span><br>
<span class="lineno"></span><span class="comment" id="1744283">//&nbsp;For&nbsp;GOOS=nacl,&nbsp;package&nbsp;syscall&nbsp;knows&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1744353">//&nbsp;If&nbsp;this&nbsp;struct&nbsp;changes,&nbsp;adjust&nbsp;../syscall/net_nacl.go:/runtimeTimer.</span><br>
<span class="lineno">15</span><span class="keyword" id="1744425">type</span>&nbsp;<span class="ident" id="1744430">timer</span>&nbsp;<span class="keyword" id="1744436">struct</span>&nbsp;<span class="op" id="1744443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744446">i</span>&nbsp;<span class="builtintype" id="1744448">int</span>&nbsp;<span class="comment" id="1744452">//&nbsp;heap&nbsp;index</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744468">//&nbsp;Timer&nbsp;wakes&nbsp;up&nbsp;at&nbsp;when,&nbsp;and&nbsp;then&nbsp;at&nbsp;when+period,&nbsp;...&nbsp;(period&nbsp;&gt;&nbsp;0&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744543">//&nbsp;each&nbsp;time&nbsp;calling&nbsp;f(now,&nbsp;arg)&nbsp;in&nbsp;the&nbsp;timer&nbsp;goroutine,&nbsp;so&nbsp;f&nbsp;must&nbsp;be</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744614">//&nbsp;a&nbsp;well-behaved&nbsp;function&nbsp;and&nbsp;not&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744657">when</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1744664">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744671">period</span>&nbsp;<span class="ident" id="1744678">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744685">f</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1744692">func</span><span class="op" id="1744696">(</span><span class="keyword" id="1744697">interface</span><span class="op" id="1744706">{</span><span class="op" id="1744707">}</span><span class="op" id="1744708">,</span>&nbsp;<span class="builtintype" id="1744710">uintptr</span><span class="op" id="1744717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744720">arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1744727">interface</span><span class="op" id="1744736">{</span><span class="op" id="1744737">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744740">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1744747">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1744755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1744758">var</span>&nbsp;<span class="ident" id="1744762">timers</span>&nbsp;<span class="keyword" id="1744769">struct</span>&nbsp;<span class="op" id="1744776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744779">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1744792">mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744799">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1744812">*</span><span class="ident" id="1744813">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744816">created</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1744829">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744835">sleeping</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1744848">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744854">rescheduling</span>&nbsp;<span class="builtintype" id="1744867">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744873">waitnote</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1744886">note</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744892">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1744905">[</span><span class="op" id="1744906">]</span><span class="op" id="1744907">*</span><span class="ident" id="1744908">timer</span><br>
<span class="lineno"></span><span class="op" id="1744914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1744917">//&nbsp;nacl&nbsp;fake&nbsp;time&nbsp;support&nbsp;-&nbsp;time&nbsp;in&nbsp;nanoseconds&nbsp;since&nbsp;1970</span><br>
<span class="lineno"></span><span class="keyword" id="1744976">var</span>&nbsp;<span class="ident" id="1744980">faketime</span>&nbsp;<span class="ident" id="1744989">int64</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1744996">//&nbsp;Package&nbsp;time&nbsp;APIs.</span><br>
<span class="lineno"></span><span class="comment" id="1745018">//&nbsp;Godoc&nbsp;uses&nbsp;the&nbsp;comments&nbsp;in&nbsp;package&nbsp;time,&nbsp;not&nbsp;these.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1745074">//&nbsp;time.now&nbsp;is&nbsp;implemented&nbsp;in&nbsp;assembly.</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1745115">//&nbsp;Sleep&nbsp;puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;sleep&nbsp;for&nbsp;at&nbsp;least&nbsp;ns&nbsp;nanoseconds.</span><br>
<span class="lineno"></span><span class="keyword" id="1745189">func</span>&nbsp;<span class="ident" id="1745194">timeSleep</span><span class="op" id="1745203">(</span><span class="ident" id="1745204">ns</span>&nbsp;<span class="ident" id="1745207">int64</span><span class="op" id="1745212">)</span>&nbsp;<span class="op" id="1745214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745217">if</span>&nbsp;<span class="ident" id="1745220">ns</span>&nbsp;<span class="op" id="1745223">&lt;=</span>&nbsp;<span class="num" id="1745226">0</span>&nbsp;<span class="op" id="1745228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745232">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745244">t</span>&nbsp;<span class="op" id="1745246">:=</span>&nbsp;<span class="builtinfunc" id="1745249">new</span><span class="op" id="1745252">(</span><span class="ident" id="1745253">timer</span><span class="op" id="1745258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745261">t</span><span class="op" id="1745262">.</span><span class="ident" id="1745263">when</span>&nbsp;<span class="op" id="1745268">=</span>&nbsp;<span class="ident" id="1745270">nanotime</span><span class="op" id="1745278">(</span><span class="op" id="1745279">)</span>&nbsp;<span class="op" id="1745281">+</span>&nbsp;<span class="ident" id="1745283">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745287">t</span><span class="op" id="1745288">.</span><span class="ident" id="1745289">f</span>&nbsp;<span class="op" id="1745291">=</span>&nbsp;<span class="ident" id="1745293">goroutineReady</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745309">t</span><span class="op" id="1745310">.</span><span class="ident" id="1745311">arg</span>&nbsp;<span class="op" id="1745315">=</span>&nbsp;<span class="ident" id="1745317">getg</span><span class="op" id="1745321">(</span><span class="op" id="1745322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745325">lock</span><span class="op" id="1745329">(</span><span class="op" id="1745330">&amp;</span><span class="ident" id="1745331">timers</span><span class="op" id="1745337">.</span><span class="ident" id="1745338">lock</span><span class="op" id="1745342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745345">addtimerLocked</span><span class="op" id="1745359">(</span><span class="ident" id="1745360">t</span><span class="op" id="1745361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745364">goparkunlock</span><span class="op" id="1745376">(</span><span class="op" id="1745377">&amp;</span><span class="ident" id="1745378">timers</span><span class="op" id="1745384">.</span><span class="ident" id="1745385">lock</span><span class="op" id="1745389">,</span>&nbsp;<span class="string" id="1745391">&#34;sleep&#34;</span><span class="op" id="1745398">)</span><br>
<span class="lineno"></span><span class="op" id="1745400">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="1745403">//&nbsp;startTimer&nbsp;adds&nbsp;t&nbsp;to&nbsp;the&nbsp;timer&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1745443">func</span>&nbsp;<span class="ident" id="1745448">startTimer</span><span class="op" id="1745458">(</span><span class="ident" id="1745459">t</span>&nbsp;<span class="op" id="1745461">*</span><span class="ident" id="1745462">timer</span><span class="op" id="1745467">)</span>&nbsp;<span class="op" id="1745469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745472">if</span>&nbsp;<span class="ident" id="1745475">raceenabled</span>&nbsp;<span class="op" id="1745487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745491">racerelease</span><span class="op" id="1745502">(</span><span class="ident" id="1745503">unsafe</span><span class="op" id="1745509">.</span><span class="ident" id="1745510">Pointer</span><span class="op" id="1745517">(</span><span class="ident" id="1745518">t</span><span class="op" id="1745519">)</span><span class="op" id="1745520">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745526">addtimer</span><span class="op" id="1745534">(</span><span class="ident" id="1745535">t</span><span class="op" id="1745536">)</span><br>
<span class="lineno"></span><span class="op" id="1745538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1745541">//&nbsp;stopTimer&nbsp;removes&nbsp;t&nbsp;from&nbsp;the&nbsp;timer&nbsp;heap&nbsp;if&nbsp;it&nbsp;is&nbsp;there.</span><br>
<span class="lineno">70</span><span class="comment" id="1745600">//&nbsp;It&nbsp;returns&nbsp;true&nbsp;if&nbsp;t&nbsp;was&nbsp;removed,&nbsp;false&nbsp;if&nbsp;t&nbsp;wasn&#39;t&nbsp;even&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="1745667">func</span>&nbsp;<span class="ident" id="1745672">stopTimer</span><span class="op" id="1745681">(</span><span class="ident" id="1745682">t</span>&nbsp;<span class="op" id="1745684">*</span><span class="ident" id="1745685">timer</span><span class="op" id="1745690">)</span>&nbsp;<span class="builtintype" id="1745692">bool</span>&nbsp;<span class="op" id="1745697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745700">return</span>&nbsp;<span class="ident" id="1745707">deltimer</span><span class="op" id="1745715">(</span><span class="ident" id="1745716">t</span><span class="op" id="1745717">)</span><br>
<span class="lineno"></span><span class="op" id="1745719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="1745722">//&nbsp;Go&nbsp;runtime.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1745738">//&nbsp;Ready&nbsp;the&nbsp;goroutine&nbsp;arg.</span><br>
<span class="lineno"></span><span class="keyword" id="1745766">func</span>&nbsp;<span class="ident" id="1745771">goroutineReady</span><span class="op" id="1745785">(</span><span class="ident" id="1745786">arg</span>&nbsp;<span class="keyword" id="1745790">interface</span><span class="op" id="1745799">{</span><span class="op" id="1745800">}</span><span class="op" id="1745801">,</span>&nbsp;<span class="ident" id="1745803">seq</span>&nbsp;<span class="builtintype" id="1745807">uintptr</span><span class="op" id="1745814">)</span>&nbsp;<span class="op" id="1745816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745819">goready</span><span class="op" id="1745826">(</span><span class="ident" id="1745827">arg</span><span class="op" id="1745830">.</span><span class="op" id="1745831">(</span><span class="op" id="1745832">*</span><span class="ident" id="1745833">g</span><span class="op" id="1745834">)</span><span class="op" id="1745835">)</span><br>
<span class="lineno">80</span><span class="op" id="1745837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1745840">func</span>&nbsp;<span class="ident" id="1745845">addtimer</span><span class="op" id="1745853">(</span><span class="ident" id="1745854">t</span>&nbsp;<span class="op" id="1745856">*</span><span class="ident" id="1745857">timer</span><span class="op" id="1745862">)</span>&nbsp;<span class="op" id="1745864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745867">lock</span><span class="op" id="1745871">(</span><span class="op" id="1745872">&amp;</span><span class="ident" id="1745873">timers</span><span class="op" id="1745879">.</span><span class="ident" id="1745880">lock</span><span class="op" id="1745884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745887">addtimerLocked</span><span class="op" id="1745901">(</span><span class="ident" id="1745902">t</span><span class="op" id="1745903">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745906">unlock</span><span class="op" id="1745912">(</span><span class="op" id="1745913">&amp;</span><span class="ident" id="1745914">timers</span><span class="op" id="1745920">.</span><span class="ident" id="1745921">lock</span><span class="op" id="1745925">)</span><br>
<span class="lineno"></span><span class="op" id="1745927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1745930">//&nbsp;Add&nbsp;a&nbsp;timer&nbsp;to&nbsp;the&nbsp;heap&nbsp;and&nbsp;start&nbsp;or&nbsp;kick&nbsp;the&nbsp;timer&nbsp;proc.</span><br>
<span class="lineno"></span><span class="comment" id="1745991">//&nbsp;If&nbsp;the&nbsp;new&nbsp;timer&nbsp;is&nbsp;earlier&nbsp;than&nbsp;any&nbsp;of&nbsp;the&nbsp;others.</span><br>
<span class="lineno">90</span><span class="comment" id="1746046">//&nbsp;Timers&nbsp;are&nbsp;locked.</span><br>
<span class="lineno"></span><span class="keyword" id="1746068">func</span>&nbsp;<span class="ident" id="1746073">addtimerLocked</span><span class="op" id="1746087">(</span><span class="ident" id="1746088">t</span>&nbsp;<span class="op" id="1746090">*</span><span class="ident" id="1746091">timer</span><span class="op" id="1746096">)</span>&nbsp;<span class="op" id="1746098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746101">//&nbsp;when&nbsp;must&nbsp;never&nbsp;be&nbsp;negative;&nbsp;otherwise&nbsp;timerproc&nbsp;will&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746168">//&nbsp;during&nbsp;its&nbsp;delta&nbsp;calculation&nbsp;and&nbsp;never&nbsp;expire&nbsp;other&nbsp;runtimeÂ·timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746241">if</span>&nbsp;<span class="ident" id="1746244">t</span><span class="op" id="1746245">.</span><span class="ident" id="1746246">when</span>&nbsp;<span class="op" id="1746251">&lt;</span>&nbsp;<span class="num" id="1746253">0</span>&nbsp;<span class="op" id="1746255">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746259">t</span><span class="op" id="1746260">.</span><span class="ident" id="1746261">when</span>&nbsp;<span class="op" id="1746266">=</span>&nbsp;<span class="num" id="1746268">1</span><span class="op" id="1746269">&lt;&lt;</span><span class="num" id="1746271">63</span>&nbsp;<span class="op" id="1746274">-</span>&nbsp;<span class="num" id="1746276">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746282">t</span><span class="op" id="1746283">.</span><span class="ident" id="1746284">i</span>&nbsp;<span class="op" id="1746286">=</span>&nbsp;<span class="builtinfunc" id="1746288">len</span><span class="op" id="1746291">(</span><span class="ident" id="1746292">timers</span><span class="op" id="1746298">.</span><span class="ident" id="1746299">t</span><span class="op" id="1746300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746303">timers</span><span class="op" id="1746309">.</span><span class="ident" id="1746310">t</span>&nbsp;<span class="op" id="1746312">=</span>&nbsp;<span class="builtinfunc" id="1746314">append</span><span class="op" id="1746320">(</span><span class="ident" id="1746321">timers</span><span class="op" id="1746327">.</span><span class="ident" id="1746328">t</span><span class="op" id="1746329">,</span>&nbsp;<span class="ident" id="1746331">t</span><span class="op" id="1746332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746335">siftupTimer</span><span class="op" id="1746346">(</span><span class="ident" id="1746347">t</span><span class="op" id="1746348">.</span><span class="ident" id="1746349">i</span><span class="op" id="1746350">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746353">if</span>&nbsp;<span class="ident" id="1746356">t</span><span class="op" id="1746357">.</span><span class="ident" id="1746358">i</span>&nbsp;<span class="op" id="1746360">==</span>&nbsp;<span class="num" id="1746363">0</span>&nbsp;<span class="op" id="1746365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746369">//&nbsp;siftup&nbsp;moved&nbsp;to&nbsp;top:&nbsp;new&nbsp;earliest&nbsp;deadline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746418">if</span>&nbsp;<span class="ident" id="1746421">timers</span><span class="op" id="1746427">.</span><span class="ident" id="1746428">sleeping</span>&nbsp;<span class="op" id="1746437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746442">timers</span><span class="op" id="1746448">.</span><span class="ident" id="1746449">sleeping</span>&nbsp;<span class="op" id="1746458">=</span>&nbsp;<span class="ident" id="1746460">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746469">notewakeup</span><span class="op" id="1746479">(</span><span class="op" id="1746480">&amp;</span><span class="ident" id="1746481">timers</span><span class="op" id="1746487">.</span><span class="ident" id="1746488">waitnote</span><span class="op" id="1746496">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746504">if</span>&nbsp;<span class="ident" id="1746507">timers</span><span class="op" id="1746513">.</span><span class="ident" id="1746514">rescheduling</span>&nbsp;<span class="op" id="1746527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746532">timers</span><span class="op" id="1746538">.</span><span class="ident" id="1746539">rescheduling</span>&nbsp;<span class="op" id="1746552">=</span>&nbsp;<span class="ident" id="1746554">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746563">goready</span><span class="op" id="1746570">(</span><span class="ident" id="1746571">timers</span><span class="op" id="1746577">.</span><span class="ident" id="1746578">gp</span><span class="op" id="1746580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746584">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746590">if</span>&nbsp;<span class="op" id="1746593">!</span><span class="ident" id="1746594">timers</span><span class="op" id="1746600">.</span><span class="ident" id="1746601">created</span>&nbsp;<span class="op" id="1746609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746613">timers</span><span class="op" id="1746619">.</span><span class="ident" id="1746620">created</span>&nbsp;<span class="op" id="1746628">=</span>&nbsp;<span class="ident" id="1746630">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746637">go</span>&nbsp;<span class="ident" id="1746640">timerproc</span><span class="op" id="1746649">(</span><span class="op" id="1746650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746653">}</span><br>
<span class="lineno">115</span><span class="op" id="1746655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1746658">//&nbsp;Delete&nbsp;timer&nbsp;t&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="comment" id="1746691">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;update&nbsp;the&nbsp;timerproc:&nbsp;if&nbsp;it&nbsp;wakes&nbsp;up&nbsp;early,&nbsp;no&nbsp;big&nbsp;deal.</span><br>
<span class="lineno"></span><span class="keyword" id="1746766">func</span>&nbsp;<span class="ident" id="1746771">deltimer</span><span class="op" id="1746779">(</span><span class="ident" id="1746780">t</span>&nbsp;<span class="op" id="1746782">*</span><span class="ident" id="1746783">timer</span><span class="op" id="1746788">)</span>&nbsp;<span class="builtintype" id="1746790">bool</span>&nbsp;<span class="op" id="1746795">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746798">//&nbsp;Dereference&nbsp;t&nbsp;so&nbsp;that&nbsp;any&nbsp;panic&nbsp;happens&nbsp;before&nbsp;the&nbsp;lock&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746867">//&nbsp;Discard&nbsp;result,&nbsp;because&nbsp;t&nbsp;might&nbsp;be&nbsp;moving&nbsp;in&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746926">_</span>&nbsp;<span class="op" id="1746928">=</span>&nbsp;<span class="ident" id="1746930">t</span><span class="op" id="1746931">.</span><span class="ident" id="1746932">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746936">lock</span><span class="op" id="1746940">(</span><span class="op" id="1746941">&amp;</span><span class="ident" id="1746942">timers</span><span class="op" id="1746948">.</span><span class="ident" id="1746949">lock</span><span class="op" id="1746953">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1746956">//&nbsp;t&nbsp;may&nbsp;not&nbsp;be&nbsp;registered&nbsp;anymore&nbsp;and&nbsp;may&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1747005">//&nbsp;a&nbsp;bogus&nbsp;i&nbsp;(typically&nbsp;0,&nbsp;if&nbsp;generated&nbsp;by&nbsp;Go).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1747054">//&nbsp;Verify&nbsp;it&nbsp;before&nbsp;proceeding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747087">i</span>&nbsp;<span class="op" id="1747089">:=</span>&nbsp;<span class="ident" id="1747092">t</span><span class="op" id="1747093">.</span><span class="ident" id="1747094">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747097">last</span>&nbsp;<span class="op" id="1747102">:=</span>&nbsp;<span class="builtinfunc" id="1747105">len</span><span class="op" id="1747108">(</span><span class="ident" id="1747109">timers</span><span class="op" id="1747115">.</span><span class="ident" id="1747116">t</span><span class="op" id="1747117">)</span>&nbsp;<span class="op" id="1747119">-</span>&nbsp;<span class="num" id="1747121">1</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747124">if</span>&nbsp;<span class="ident" id="1747127">i</span>&nbsp;<span class="op" id="1747129">&lt;</span>&nbsp;<span class="num" id="1747131">0</span>&nbsp;<span class="op" id="1747133">||</span>&nbsp;<span class="ident" id="1747136">i</span>&nbsp;<span class="op" id="1747138">&gt;</span>&nbsp;<span class="ident" id="1747140">last</span>&nbsp;<span class="op" id="1747145">||</span>&nbsp;<span class="ident" id="1747148">timers</span><span class="op" id="1747154">.</span><span class="ident" id="1747155">t</span><span class="op" id="1747156">[</span><span class="ident" id="1747157">i</span><span class="op" id="1747158">]</span>&nbsp;<span class="op" id="1747160">!=</span>&nbsp;<span class="ident" id="1747163">t</span>&nbsp;<span class="op" id="1747165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747169">unlock</span><span class="op" id="1747175">(</span><span class="op" id="1747176">&amp;</span><span class="ident" id="1747177">timers</span><span class="op" id="1747183">.</span><span class="ident" id="1747184">lock</span><span class="op" id="1747188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747192">return</span>&nbsp;<span class="ident" id="1747199">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747209">if</span>&nbsp;<span class="ident" id="1747212">i</span>&nbsp;<span class="op" id="1747214">!=</span>&nbsp;<span class="ident" id="1747217">last</span>&nbsp;<span class="op" id="1747222">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747226">timers</span><span class="op" id="1747232">.</span><span class="ident" id="1747233">t</span><span class="op" id="1747234">[</span><span class="ident" id="1747235">i</span><span class="op" id="1747236">]</span>&nbsp;<span class="op" id="1747238">=</span>&nbsp;<span class="ident" id="1747240">timers</span><span class="op" id="1747246">.</span><span class="ident" id="1747247">t</span><span class="op" id="1747248">[</span><span class="ident" id="1747249">last</span><span class="op" id="1747253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747257">timers</span><span class="op" id="1747263">.</span><span class="ident" id="1747264">t</span><span class="op" id="1747265">[</span><span class="ident" id="1747266">i</span><span class="op" id="1747267">]</span><span class="op" id="1747268">.</span><span class="ident" id="1747269">i</span>&nbsp;<span class="op" id="1747271">=</span>&nbsp;<span class="ident" id="1747273">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747279">timers</span><span class="op" id="1747285">.</span><span class="ident" id="1747286">t</span><span class="op" id="1747287">[</span><span class="ident" id="1747288">last</span><span class="op" id="1747292">]</span>&nbsp;<span class="op" id="1747294">=</span>&nbsp;<span class="ident" id="1747296">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747301">timers</span><span class="op" id="1747307">.</span><span class="ident" id="1747308">t</span>&nbsp;<span class="op" id="1747310">=</span>&nbsp;<span class="ident" id="1747312">timers</span><span class="op" id="1747318">.</span><span class="ident" id="1747319">t</span><span class="op" id="1747320">[</span><span class="op" id="1747321">:</span><span class="ident" id="1747322">last</span><span class="op" id="1747326">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747329">if</span>&nbsp;<span class="ident" id="1747332">i</span>&nbsp;<span class="op" id="1747334">!=</span>&nbsp;<span class="ident" id="1747337">last</span>&nbsp;<span class="op" id="1747342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747346">siftupTimer</span><span class="op" id="1747357">(</span><span class="ident" id="1747358">i</span><span class="op" id="1747359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747363">siftdownTimer</span><span class="op" id="1747376">(</span><span class="ident" id="1747377">i</span><span class="op" id="1747378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747384">unlock</span><span class="op" id="1747390">(</span><span class="op" id="1747391">&amp;</span><span class="ident" id="1747392">timers</span><span class="op" id="1747398">.</span><span class="ident" id="1747399">lock</span><span class="op" id="1747403">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747406">return</span>&nbsp;<span class="ident" id="1747413">true</span><br>
<span class="lineno"></span><span class="op" id="1747418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1747421">//&nbsp;Timerproc&nbsp;runs&nbsp;the&nbsp;time-driven&nbsp;events.</span><br>
<span class="lineno"></span><span class="comment" id="1747463">//&nbsp;It&nbsp;sleeps&nbsp;until&nbsp;the&nbsp;next&nbsp;event&nbsp;in&nbsp;the&nbsp;timers&nbsp;heap.</span><br>
<span class="lineno">150</span><span class="comment" id="1747517">//&nbsp;If&nbsp;addtimer&nbsp;inserts&nbsp;a&nbsp;new&nbsp;earlier&nbsp;event,&nbsp;addtimer1&nbsp;wakes&nbsp;timerproc&nbsp;early.</span><br>
<span class="lineno"></span><span class="keyword" id="1747594">func</span>&nbsp;<span class="ident" id="1747599">timerproc</span><span class="op" id="1747608">(</span><span class="op" id="1747609">)</span>&nbsp;<span class="op" id="1747611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747614">timers</span><span class="op" id="1747620">.</span><span class="ident" id="1747621">gp</span>&nbsp;<span class="op" id="1747624">=</span>&nbsp;<span class="ident" id="1747626">getg</span><span class="op" id="1747630">(</span><span class="op" id="1747631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747634">timers</span><span class="op" id="1747640">.</span><span class="ident" id="1747641">gp</span><span class="op" id="1747643">.</span><span class="ident" id="1747644">issystem</span>&nbsp;<span class="op" id="1747653">=</span>&nbsp;<span class="ident" id="1747655">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747661">for</span>&nbsp;<span class="op" id="1747665">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747669">lock</span><span class="op" id="1747673">(</span><span class="op" id="1747674">&amp;</span><span class="ident" id="1747675">timers</span><span class="op" id="1747681">.</span><span class="ident" id="1747682">lock</span><span class="op" id="1747686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747690">timers</span><span class="op" id="1747696">.</span><span class="ident" id="1747697">sleeping</span>&nbsp;<span class="op" id="1747706">=</span>&nbsp;<span class="ident" id="1747708">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747716">now</span>&nbsp;<span class="op" id="1747720">:=</span>&nbsp;<span class="ident" id="1747723">nanotime</span><span class="op" id="1747731">(</span><span class="op" id="1747732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747736">delta</span>&nbsp;<span class="op" id="1747742">:=</span>&nbsp;<span class="ident" id="1747745">int64</span><span class="op" id="1747750">(</span><span class="op" id="1747751">-</span><span class="num" id="1747752">1</span><span class="op" id="1747753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747757">for</span>&nbsp;<span class="op" id="1747761">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747766">if</span>&nbsp;<span class="builtinfunc" id="1747769">len</span><span class="op" id="1747772">(</span><span class="ident" id="1747773">timers</span><span class="op" id="1747779">.</span><span class="ident" id="1747780">t</span><span class="op" id="1747781">)</span>&nbsp;<span class="op" id="1747783">==</span>&nbsp;<span class="num" id="1747786">0</span>&nbsp;<span class="op" id="1747788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747794">delta</span>&nbsp;<span class="op" id="1747800">=</span>&nbsp;<span class="op" id="1747802">-</span><span class="num" id="1747803">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747809">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747823">t</span>&nbsp;<span class="op" id="1747825">:=</span>&nbsp;<span class="ident" id="1747828">timers</span><span class="op" id="1747834">.</span><span class="ident" id="1747835">t</span><span class="op" id="1747836">[</span><span class="num" id="1747837">0</span><span class="op" id="1747838">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747843">delta</span>&nbsp;<span class="op" id="1747849">=</span>&nbsp;<span class="ident" id="1747851">t</span><span class="op" id="1747852">.</span><span class="ident" id="1747853">when</span>&nbsp;<span class="op" id="1747858">-</span>&nbsp;<span class="ident" id="1747860">now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747867">if</span>&nbsp;<span class="ident" id="1747870">delta</span>&nbsp;<span class="op" id="1747876">&gt;</span>&nbsp;<span class="num" id="1747878">0</span>&nbsp;<span class="op" id="1747880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747900">if</span>&nbsp;<span class="ident" id="1747903">t</span><span class="op" id="1747904">.</span><span class="ident" id="1747905">period</span>&nbsp;<span class="op" id="1747912">&gt;</span>&nbsp;<span class="num" id="1747914">0</span>&nbsp;<span class="op" id="1747916">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1747922">//&nbsp;leave&nbsp;in&nbsp;heap&nbsp;but&nbsp;adjust&nbsp;next&nbsp;time&nbsp;to&nbsp;fire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747972">t</span><span class="op" id="1747973">.</span><span class="ident" id="1747974">when</span>&nbsp;<span class="op" id="1747979">+=</span>&nbsp;<span class="ident" id="1747982">t</span><span class="op" id="1747983">.</span><span class="ident" id="1747984">period</span>&nbsp;<span class="op" id="1747991">*</span>&nbsp;<span class="op" id="1747993">(</span><span class="num" id="1747994">1</span>&nbsp;<span class="op" id="1747996">+</span>&nbsp;<span class="op" id="1747998">-</span><span class="ident" id="1747999">delta</span><span class="op" id="1748004">/</span><span class="ident" id="1748005">t</span><span class="op" id="1748006">.</span><span class="ident" id="1748007">period</span><span class="op" id="1748013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748019">siftdownTimer</span><span class="op" id="1748032">(</span><span class="num" id="1748033">0</span><span class="op" id="1748034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748039">}</span>&nbsp;<span class="keyword" id="1748041">else</span>&nbsp;<span class="op" id="1748046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748052">//&nbsp;remove&nbsp;from&nbsp;heap</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748076">last</span>&nbsp;<span class="op" id="1748081">:=</span>&nbsp;<span class="builtinfunc" id="1748084">len</span><span class="op" id="1748087">(</span><span class="ident" id="1748088">timers</span><span class="op" id="1748094">.</span><span class="ident" id="1748095">t</span><span class="op" id="1748096">)</span>&nbsp;<span class="op" id="1748098">-</span>&nbsp;<span class="num" id="1748100">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748106">if</span>&nbsp;<span class="ident" id="1748109">last</span>&nbsp;<span class="op" id="1748114">&gt;</span>&nbsp;<span class="num" id="1748116">0</span>&nbsp;<span class="op" id="1748118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748125">timers</span><span class="op" id="1748131">.</span><span class="ident" id="1748132">t</span><span class="op" id="1748133">[</span><span class="num" id="1748134">0</span><span class="op" id="1748135">]</span>&nbsp;<span class="op" id="1748137">=</span>&nbsp;<span class="ident" id="1748139">timers</span><span class="op" id="1748145">.</span><span class="ident" id="1748146">t</span><span class="op" id="1748147">[</span><span class="ident" id="1748148">last</span><span class="op" id="1748152">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748159">timers</span><span class="op" id="1748165">.</span><span class="ident" id="1748166">t</span><span class="op" id="1748167">[</span><span class="num" id="1748168">0</span><span class="op" id="1748169">]</span><span class="op" id="1748170">.</span><span class="ident" id="1748171">i</span>&nbsp;<span class="op" id="1748173">=</span>&nbsp;<span class="num" id="1748175">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748181">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748187">timers</span><span class="op" id="1748193">.</span><span class="ident" id="1748194">t</span><span class="op" id="1748195">[</span><span class="ident" id="1748196">last</span><span class="op" id="1748200">]</span>&nbsp;<span class="op" id="1748202">=</span>&nbsp;<span class="ident" id="1748204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748212">timers</span><span class="op" id="1748218">.</span><span class="ident" id="1748219">t</span>&nbsp;<span class="op" id="1748221">=</span>&nbsp;<span class="ident" id="1748223">timers</span><span class="op" id="1748229">.</span><span class="ident" id="1748230">t</span><span class="op" id="1748231">[</span><span class="op" id="1748232">:</span><span class="ident" id="1748233">last</span><span class="op" id="1748237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748243">if</span>&nbsp;<span class="ident" id="1748246">last</span>&nbsp;<span class="op" id="1748251">&gt;</span>&nbsp;<span class="num" id="1748253">0</span>&nbsp;<span class="op" id="1748255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748262">siftdownTimer</span><span class="op" id="1748275">(</span><span class="num" id="1748276">0</span><span class="op" id="1748277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748283">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748289">t</span><span class="op" id="1748290">.</span><span class="ident" id="1748291">i</span>&nbsp;<span class="op" id="1748293">=</span>&nbsp;<span class="op" id="1748295">-</span><span class="num" id="1748296">1</span>&nbsp;<span class="comment" id="1748298">//&nbsp;mark&nbsp;as&nbsp;removed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748325">f</span>&nbsp;<span class="op" id="1748327">:=</span>&nbsp;<span class="ident" id="1748330">t</span><span class="op" id="1748331">.</span><span class="ident" id="1748332">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748337">arg</span>&nbsp;<span class="op" id="1748341">:=</span>&nbsp;<span class="ident" id="1748344">t</span><span class="op" id="1748345">.</span><span class="ident" id="1748346">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748353">seq</span>&nbsp;<span class="op" id="1748357">:=</span>&nbsp;<span class="ident" id="1748360">t</span><span class="op" id="1748361">.</span><span class="ident" id="1748362">seq</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748369">unlock</span><span class="op" id="1748375">(</span><span class="op" id="1748376">&amp;</span><span class="ident" id="1748377">timers</span><span class="op" id="1748383">.</span><span class="ident" id="1748384">lock</span><span class="op" id="1748388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748393">if</span>&nbsp;<span class="ident" id="1748396">raceenabled</span>&nbsp;<span class="op" id="1748408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748414">raceacquire</span><span class="op" id="1748425">(</span><span class="ident" id="1748426">unsafe</span><span class="op" id="1748432">.</span><span class="ident" id="1748433">Pointer</span><span class="op" id="1748440">(</span><span class="ident" id="1748441">t</span><span class="op" id="1748442">)</span><span class="op" id="1748443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748453">f</span><span class="op" id="1748454">(</span><span class="ident" id="1748455">arg</span><span class="op" id="1748458">,</span>&nbsp;<span class="ident" id="1748460">seq</span><span class="op" id="1748463">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748468">lock</span><span class="op" id="1748472">(</span><span class="op" id="1748473">&amp;</span><span class="ident" id="1748474">timers</span><span class="op" id="1748480">.</span><span class="ident" id="1748481">lock</span><span class="op" id="1748485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748493">if</span>&nbsp;<span class="ident" id="1748496">delta</span>&nbsp;<span class="op" id="1748502">&lt;</span>&nbsp;<span class="num" id="1748504">0</span>&nbsp;<span class="op" id="1748506">||</span>&nbsp;<span class="ident" id="1748509">faketime</span>&nbsp;<span class="op" id="1748518">&gt;</span>&nbsp;<span class="num" id="1748520">0</span>&nbsp;<span class="op" id="1748522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748527">//&nbsp;No&nbsp;timers&nbsp;left&nbsp;-&nbsp;put&nbsp;goroutine&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748574">timers</span><span class="op" id="1748580">.</span><span class="ident" id="1748581">rescheduling</span>&nbsp;<span class="op" id="1748594">=</span>&nbsp;<span class="ident" id="1748596">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748604">goparkunlock</span><span class="op" id="1748616">(</span><span class="op" id="1748617">&amp;</span><span class="ident" id="1748618">timers</span><span class="op" id="1748624">.</span><span class="ident" id="1748625">lock</span><span class="op" id="1748629">,</span>&nbsp;<span class="string" id="1748631">&#34;timer&nbsp;goroutine&nbsp;(idle)&#34;</span><span class="op" id="1748655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748660">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748675">//&nbsp;At&nbsp;least&nbsp;one&nbsp;timer&nbsp;pending.&nbsp;&nbsp;Sleep&nbsp;until&nbsp;then.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748727">timers</span><span class="op" id="1748733">.</span><span class="ident" id="1748734">sleeping</span>&nbsp;<span class="op" id="1748743">=</span>&nbsp;<span class="ident" id="1748745">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748752">noteclear</span><span class="op" id="1748761">(</span><span class="op" id="1748762">&amp;</span><span class="ident" id="1748763">timers</span><span class="op" id="1748769">.</span><span class="ident" id="1748770">waitnote</span><span class="op" id="1748778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748782">unlock</span><span class="op" id="1748788">(</span><span class="op" id="1748789">&amp;</span><span class="ident" id="1748790">timers</span><span class="op" id="1748796">.</span><span class="ident" id="1748797">lock</span><span class="op" id="1748801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748805">notetsleepg</span><span class="op" id="1748816">(</span><span class="op" id="1748817">&amp;</span><span class="ident" id="1748818">timers</span><span class="op" id="1748824">.</span><span class="ident" id="1748825">waitnote</span><span class="op" id="1748833">,</span>&nbsp;<span class="ident" id="1748835">delta</span><span class="op" id="1748840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748843">}</span><br>
<span class="lineno"></span><span class="op" id="1748845">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="1748848">func</span>&nbsp;<span class="ident" id="1748853">timejump</span><span class="op" id="1748861">(</span><span class="op" id="1748862">)</span>&nbsp;<span class="op" id="1748864">*</span><span class="ident" id="1748865">g</span>&nbsp;<span class="op" id="1748867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748870">if</span>&nbsp;<span class="ident" id="1748873">faketime</span>&nbsp;<span class="op" id="1748882">==</span>&nbsp;<span class="num" id="1748885">0</span>&nbsp;<span class="op" id="1748887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748891">return</span>&nbsp;<span class="ident" id="1748898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748903">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748907">lock</span><span class="op" id="1748911">(</span><span class="op" id="1748912">&amp;</span><span class="ident" id="1748913">timers</span><span class="op" id="1748919">.</span><span class="ident" id="1748920">lock</span><span class="op" id="1748924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748927">if</span>&nbsp;<span class="op" id="1748930">!</span><span class="ident" id="1748931">timers</span><span class="op" id="1748937">.</span><span class="ident" id="1748938">created</span>&nbsp;<span class="op" id="1748946">||</span>&nbsp;<span class="builtinfunc" id="1748949">len</span><span class="op" id="1748952">(</span><span class="ident" id="1748953">timers</span><span class="op" id="1748959">.</span><span class="ident" id="1748960">t</span><span class="op" id="1748961">)</span>&nbsp;<span class="op" id="1748963">==</span>&nbsp;<span class="num" id="1748966">0</span>&nbsp;<span class="op" id="1748968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748972">unlock</span><span class="op" id="1748978">(</span><span class="op" id="1748979">&amp;</span><span class="ident" id="1748980">timers</span><span class="op" id="1748986">.</span><span class="ident" id="1748987">lock</span><span class="op" id="1748991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748995">return</span>&nbsp;<span class="ident" id="1749002">nil</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749011">var</span>&nbsp;<span class="ident" id="1749015">gp</span>&nbsp;<span class="op" id="1749018">*</span><span class="ident" id="1749019">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749022">if</span>&nbsp;<span class="ident" id="1749025">faketime</span>&nbsp;<span class="op" id="1749034">&lt;</span>&nbsp;<span class="ident" id="1749036">timers</span><span class="op" id="1749042">.</span><span class="ident" id="1749043">t</span><span class="op" id="1749044">[</span><span class="num" id="1749045">0</span><span class="op" id="1749046">]</span><span class="op" id="1749047">.</span><span class="ident" id="1749048">when</span>&nbsp;<span class="op" id="1749053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749057">faketime</span>&nbsp;<span class="op" id="1749066">=</span>&nbsp;<span class="ident" id="1749068">timers</span><span class="op" id="1749074">.</span><span class="ident" id="1749075">t</span><span class="op" id="1749076">[</span><span class="num" id="1749077">0</span><span class="op" id="1749078">]</span><span class="op" id="1749079">.</span><span class="ident" id="1749080">when</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749087">if</span>&nbsp;<span class="ident" id="1749090">timers</span><span class="op" id="1749096">.</span><span class="ident" id="1749097">rescheduling</span>&nbsp;<span class="op" id="1749110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749115">timers</span><span class="op" id="1749121">.</span><span class="ident" id="1749122">rescheduling</span>&nbsp;<span class="op" id="1749135">=</span>&nbsp;<span class="ident" id="1749137">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749146">gp</span>&nbsp;<span class="op" id="1749149">=</span>&nbsp;<span class="ident" id="1749151">timers</span><span class="op" id="1749157">.</span><span class="ident" id="1749158">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749166">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749169">unlock</span><span class="op" id="1749175">(</span><span class="op" id="1749176">&amp;</span><span class="ident" id="1749177">timers</span><span class="op" id="1749183">.</span><span class="ident" id="1749184">lock</span><span class="op" id="1749188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749191">return</span>&nbsp;<span class="ident" id="1749198">gp</span><br>
<span class="lineno"></span><span class="op" id="1749201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1749204">//&nbsp;Heap&nbsp;maintenance&nbsp;algorithms.</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="1749237">func</span>&nbsp;<span class="ident" id="1749242">siftupTimer</span><span class="op" id="1749253">(</span><span class="ident" id="1749254">i</span>&nbsp;<span class="builtintype" id="1749256">int</span><span class="op" id="1749259">)</span>&nbsp;<span class="op" id="1749261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749264">t</span>&nbsp;<span class="op" id="1749266">:=</span>&nbsp;<span class="ident" id="1749269">timers</span><span class="op" id="1749275">.</span><span class="ident" id="1749276">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749279">when</span>&nbsp;<span class="op" id="1749284">:=</span>&nbsp;<span class="ident" id="1749287">t</span><span class="op" id="1749288">[</span><span class="ident" id="1749289">i</span><span class="op" id="1749290">]</span><span class="op" id="1749291">.</span><span class="ident" id="1749292">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749298">tmp</span>&nbsp;<span class="op" id="1749302">:=</span>&nbsp;<span class="ident" id="1749305">t</span><span class="op" id="1749306">[</span><span class="ident" id="1749307">i</span><span class="op" id="1749308">]</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749311">for</span>&nbsp;<span class="ident" id="1749315">i</span>&nbsp;<span class="op" id="1749317">&gt;</span>&nbsp;<span class="num" id="1749319">0</span>&nbsp;<span class="op" id="1749321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749325">p</span>&nbsp;<span class="op" id="1749327">:=</span>&nbsp;<span class="op" id="1749330">(</span><span class="ident" id="1749331">i</span>&nbsp;<span class="op" id="1749333">-</span>&nbsp;<span class="num" id="1749335">1</span><span class="op" id="1749336">)</span>&nbsp;<span class="op" id="1749338">/</span>&nbsp;<span class="num" id="1749340">4</span>&nbsp;<span class="comment" id="1749342">//&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749354">if</span>&nbsp;<span class="ident" id="1749357">when</span>&nbsp;<span class="op" id="1749362">&gt;=</span>&nbsp;<span class="ident" id="1749365">t</span><span class="op" id="1749366">[</span><span class="ident" id="1749367">p</span><span class="op" id="1749368">]</span><span class="op" id="1749369">.</span><span class="ident" id="1749370">when</span>&nbsp;<span class="op" id="1749375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749380">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749388">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749392">t</span><span class="op" id="1749393">[</span><span class="ident" id="1749394">i</span><span class="op" id="1749395">]</span>&nbsp;<span class="op" id="1749397">=</span>&nbsp;<span class="ident" id="1749399">t</span><span class="op" id="1749400">[</span><span class="ident" id="1749401">p</span><span class="op" id="1749402">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749406">t</span><span class="op" id="1749407">[</span><span class="ident" id="1749408">i</span><span class="op" id="1749409">]</span><span class="op" id="1749410">.</span><span class="ident" id="1749411">i</span>&nbsp;<span class="op" id="1749413">=</span>&nbsp;<span class="ident" id="1749415">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749419">t</span><span class="op" id="1749420">[</span><span class="ident" id="1749421">p</span><span class="op" id="1749422">]</span>&nbsp;<span class="op" id="1749424">=</span>&nbsp;<span class="ident" id="1749426">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749432">t</span><span class="op" id="1749433">[</span><span class="ident" id="1749434">p</span><span class="op" id="1749435">]</span><span class="op" id="1749436">.</span><span class="ident" id="1749437">i</span>&nbsp;<span class="op" id="1749439">=</span>&nbsp;<span class="ident" id="1749441">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749445">i</span>&nbsp;<span class="op" id="1749447">=</span>&nbsp;<span class="ident" id="1749449">p</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749452">}</span><br>
<span class="lineno"></span><span class="op" id="1749454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1749457">func</span>&nbsp;<span class="ident" id="1749462">siftdownTimer</span><span class="op" id="1749475">(</span><span class="ident" id="1749476">i</span>&nbsp;<span class="builtintype" id="1749478">int</span><span class="op" id="1749481">)</span>&nbsp;<span class="op" id="1749483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749486">t</span>&nbsp;<span class="op" id="1749488">:=</span>&nbsp;<span class="ident" id="1749491">timers</span><span class="op" id="1749497">.</span><span class="ident" id="1749498">t</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749501">n</span>&nbsp;<span class="op" id="1749503">:=</span>&nbsp;<span class="builtinfunc" id="1749506">len</span><span class="op" id="1749509">(</span><span class="ident" id="1749510">t</span><span class="op" id="1749511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749514">when</span>&nbsp;<span class="op" id="1749519">:=</span>&nbsp;<span class="ident" id="1749522">t</span><span class="op" id="1749523">[</span><span class="ident" id="1749524">i</span><span class="op" id="1749525">]</span><span class="op" id="1749526">.</span><span class="ident" id="1749527">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749533">tmp</span>&nbsp;<span class="op" id="1749537">:=</span>&nbsp;<span class="ident" id="1749540">t</span><span class="op" id="1749541">[</span><span class="ident" id="1749542">i</span><span class="op" id="1749543">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749546">for</span>&nbsp;<span class="op" id="1749550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749554">c</span>&nbsp;<span class="op" id="1749556">:=</span>&nbsp;<span class="ident" id="1749559">i</span><span class="op" id="1749560">*</span><span class="num" id="1749561">4</span>&nbsp;<span class="op" id="1749563">+</span>&nbsp;<span class="num" id="1749565">1</span>&nbsp;<span class="comment" id="1749567">//&nbsp;left&nbsp;child</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749583">c3</span>&nbsp;<span class="op" id="1749586">:=</span>&nbsp;<span class="ident" id="1749589">c</span>&nbsp;<span class="op" id="1749591">+</span>&nbsp;<span class="num" id="1749593">2</span>&nbsp;&nbsp;<span class="comment" id="1749596">//&nbsp;mid&nbsp;child</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749611">if</span>&nbsp;<span class="ident" id="1749614">c</span>&nbsp;<span class="op" id="1749616">&gt;=</span>&nbsp;<span class="ident" id="1749619">n</span>&nbsp;<span class="op" id="1749621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749626">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749638">w</span>&nbsp;<span class="op" id="1749640">:=</span>&nbsp;<span class="ident" id="1749643">t</span><span class="op" id="1749644">[</span><span class="ident" id="1749645">c</span><span class="op" id="1749646">]</span><span class="op" id="1749647">.</span><span class="ident" id="1749648">when</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749655">if</span>&nbsp;<span class="ident" id="1749658">c</span><span class="op" id="1749659">+</span><span class="num" id="1749660">1</span>&nbsp;<span class="op" id="1749662">&lt;</span>&nbsp;<span class="ident" id="1749664">n</span>&nbsp;<span class="op" id="1749666">&amp;&amp;</span>&nbsp;<span class="ident" id="1749669">t</span><span class="op" id="1749670">[</span><span class="ident" id="1749671">c</span><span class="op" id="1749672">+</span><span class="num" id="1749673">1</span><span class="op" id="1749674">]</span><span class="op" id="1749675">.</span><span class="ident" id="1749676">when</span>&nbsp;<span class="op" id="1749681">&lt;</span>&nbsp;<span class="ident" id="1749683">w</span>&nbsp;<span class="op" id="1749685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749690">w</span>&nbsp;<span class="op" id="1749692">=</span>&nbsp;<span class="ident" id="1749694">t</span><span class="op" id="1749695">[</span><span class="ident" id="1749696">c</span><span class="op" id="1749697">+</span><span class="num" id="1749698">1</span><span class="op" id="1749699">]</span><span class="op" id="1749700">.</span><span class="ident" id="1749701">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749709">c</span><span class="op" id="1749710">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749719">if</span>&nbsp;<span class="ident" id="1749722">c3</span>&nbsp;<span class="op" id="1749725">&lt;</span>&nbsp;<span class="ident" id="1749727">n</span>&nbsp;<span class="op" id="1749729">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749734">w3</span>&nbsp;<span class="op" id="1749737">:=</span>&nbsp;<span class="ident" id="1749740">t</span><span class="op" id="1749741">[</span><span class="ident" id="1749742">c3</span><span class="op" id="1749744">]</span><span class="op" id="1749745">.</span><span class="ident" id="1749746">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749754">if</span>&nbsp;<span class="ident" id="1749757">c3</span><span class="op" id="1749759">+</span><span class="num" id="1749760">1</span>&nbsp;<span class="op" id="1749762">&lt;</span>&nbsp;<span class="ident" id="1749764">n</span>&nbsp;<span class="op" id="1749766">&amp;&amp;</span>&nbsp;<span class="ident" id="1749769">t</span><span class="op" id="1749770">[</span><span class="ident" id="1749771">c3</span><span class="op" id="1749773">+</span><span class="num" id="1749774">1</span><span class="op" id="1749775">]</span><span class="op" id="1749776">.</span><span class="ident" id="1749777">when</span>&nbsp;<span class="op" id="1749782">&lt;</span>&nbsp;<span class="ident" id="1749784">w3</span>&nbsp;<span class="op" id="1749787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749793">w3</span>&nbsp;<span class="op" id="1749796">=</span>&nbsp;<span class="ident" id="1749798">t</span><span class="op" id="1749799">[</span><span class="ident" id="1749800">c3</span><span class="op" id="1749802">+</span><span class="num" id="1749803">1</span><span class="op" id="1749804">]</span><span class="op" id="1749805">.</span><span class="ident" id="1749806">when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749815">c3</span><span class="op" id="1749817">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749823">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749828">if</span>&nbsp;<span class="ident" id="1749831">w3</span>&nbsp;<span class="op" id="1749834">&lt;</span>&nbsp;<span class="ident" id="1749836">w</span>&nbsp;<span class="op" id="1749838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749844">w</span>&nbsp;<span class="op" id="1749846">=</span>&nbsp;<span class="ident" id="1749848">w3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749855">c</span>&nbsp;<span class="op" id="1749857">=</span>&nbsp;<span class="ident" id="1749859">c3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749869">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749873">if</span>&nbsp;<span class="ident" id="1749876">w</span>&nbsp;<span class="op" id="1749878">&gt;=</span>&nbsp;<span class="ident" id="1749881">when</span>&nbsp;<span class="op" id="1749886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749891">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749903">t</span><span class="op" id="1749904">[</span><span class="ident" id="1749905">i</span><span class="op" id="1749906">]</span>&nbsp;<span class="op" id="1749908">=</span>&nbsp;<span class="ident" id="1749910">t</span><span class="op" id="1749911">[</span><span class="ident" id="1749912">c</span><span class="op" id="1749913">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749917">t</span><span class="op" id="1749918">[</span><span class="ident" id="1749919">i</span><span class="op" id="1749920">]</span><span class="op" id="1749921">.</span><span class="ident" id="1749922">i</span>&nbsp;<span class="op" id="1749924">=</span>&nbsp;<span class="ident" id="1749926">i</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749930">t</span><span class="op" id="1749931">[</span><span class="ident" id="1749932">c</span><span class="op" id="1749933">]</span>&nbsp;<span class="op" id="1749935">=</span>&nbsp;<span class="ident" id="1749937">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749943">t</span><span class="op" id="1749944">[</span><span class="ident" id="1749945">c</span><span class="op" id="1749946">]</span><span class="op" id="1749947">.</span><span class="ident" id="1749948">i</span>&nbsp;<span class="op" id="1749950">=</span>&nbsp;<span class="ident" id="1749952">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749956">i</span>&nbsp;<span class="op" id="1749958">=</span>&nbsp;<span class="ident" id="1749960">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749963">}</span><br>
<span class="lineno"></span><span class="op" id="1749965">}</span>
</div>
</body>
</html>
