<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5611245">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5611300">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5611354">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5611405">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5611483">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5611559">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5611590">//</span><br>
<span class="lineno"></span><span class="comment" id="5611593">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5611659">//</span><br>
<span class="lineno"></span><span class="comment" id="5611662">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5611732">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5611756">//</span><br>
<span class="lineno"></span><span class="comment" id="5611759">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5611780">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5611810">//</span><br>
<span class="lineno"></span><span class="comment" id="5611813">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5611878">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5611946">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5611996">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5612017">//</span><br>
<span class="lineno"></span><span class="keyword" id="5612020">package</span>&nbsp;<span class="ident" id="5612028">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5612036">import</span>&nbsp;<span class="op" id="5612043">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612046">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612055">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612072">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612079">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612086">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612098">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612104">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612115">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612123">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5612134">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5612141">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5612144">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5612199">type</span>&nbsp;<span class="ident" id="5612204">Var</span>&nbsp;<span class="keyword" id="5612208">interface</span>&nbsp;<span class="op" id="5612218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612221">String</span><span class="op" id="5612227">(</span><span class="op" id="5612228">)</span>&nbsp;<span class="builtintype" id="5612230">string</span><br>
<span class="lineno">40</span><span class="op" id="5612237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5612240">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5612310">type</span>&nbsp;<span class="ident" id="5612315">Int</span>&nbsp;<span class="keyword" id="5612319">struct</span>&nbsp;<span class="op" id="5612326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612329">mu</span>&nbsp;<span class="ident" id="5612332">sync</span><span class="op" id="5612336">.</span><span class="ident" id="5612337">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612346">i</span>&nbsp;&nbsp;<span class="ident" id="5612349">int64</span><br>
<span class="lineno"></span><span class="op" id="5612355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5612358">func</span>&nbsp;<span class="op" id="5612363">(</span><span class="ident" id="5612364">v</span>&nbsp;<span class="op" id="5612366">*</span><span class="ident" id="5612367">Int</span><span class="op" id="5612370">)</span>&nbsp;<span class="ident" id="5612372">String</span><span class="op" id="5612378">(</span><span class="op" id="5612379">)</span>&nbsp;<span class="builtintype" id="5612381">string</span>&nbsp;<span class="op" id="5612388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612391">v</span><span class="op" id="5612392">.</span><span class="ident" id="5612393">mu</span><span class="op" id="5612395">.</span><span class="ident" id="5612396">RLock</span><span class="op" id="5612401">(</span><span class="op" id="5612402">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612405">defer</span>&nbsp;<span class="ident" id="5612411">v</span><span class="op" id="5612412">.</span><span class="ident" id="5612413">mu</span><span class="op" id="5612415">.</span><span class="ident" id="5612416">RUnlock</span><span class="op" id="5612423">(</span><span class="op" id="5612424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612427">return</span>&nbsp;<span class="ident" id="5612434">strconv</span><span class="op" id="5612441">.</span><span class="ident" id="5612442">FormatInt</span><span class="op" id="5612451">(</span><span class="ident" id="5612452">v</span><span class="op" id="5612453">.</span><span class="ident" id="5612454">i</span><span class="op" id="5612455">,</span>&nbsp;<span class="num" id="5612457">10</span><span class="op" id="5612459">)</span><br>
<span class="lineno"></span><span class="op" id="5612461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5612464">func</span>&nbsp;<span class="op" id="5612469">(</span><span class="ident" id="5612470">v</span>&nbsp;<span class="op" id="5612472">*</span><span class="ident" id="5612473">Int</span><span class="op" id="5612476">)</span>&nbsp;<span class="ident" id="5612478">Add</span><span class="op" id="5612481">(</span><span class="ident" id="5612482">delta</span>&nbsp;<span class="ident" id="5612488">int64</span><span class="op" id="5612493">)</span>&nbsp;<span class="op" id="5612495">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612498">v</span><span class="op" id="5612499">.</span><span class="ident" id="5612500">mu</span><span class="op" id="5612502">.</span><span class="ident" id="5612503">Lock</span><span class="op" id="5612507">(</span><span class="op" id="5612508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612511">defer</span>&nbsp;<span class="ident" id="5612517">v</span><span class="op" id="5612518">.</span><span class="ident" id="5612519">mu</span><span class="op" id="5612521">.</span><span class="ident" id="5612522">Unlock</span><span class="op" id="5612528">(</span><span class="op" id="5612529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612532">v</span><span class="op" id="5612533">.</span><span class="ident" id="5612534">i</span>&nbsp;<span class="op" id="5612536">+=</span>&nbsp;<span class="ident" id="5612539">delta</span><br>
<span class="lineno"></span><span class="op" id="5612545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5612548">func</span>&nbsp;<span class="op" id="5612553">(</span><span class="ident" id="5612554">v</span>&nbsp;<span class="op" id="5612556">*</span><span class="ident" id="5612557">Int</span><span class="op" id="5612560">)</span>&nbsp;<span class="ident" id="5612562">Set</span><span class="op" id="5612565">(</span><span class="ident" id="5612566">value</span>&nbsp;<span class="ident" id="5612572">int64</span><span class="op" id="5612577">)</span>&nbsp;<span class="op" id="5612579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612582">v</span><span class="op" id="5612583">.</span><span class="ident" id="5612584">mu</span><span class="op" id="5612586">.</span><span class="ident" id="5612587">Lock</span><span class="op" id="5612591">(</span><span class="op" id="5612592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612595">defer</span>&nbsp;<span class="ident" id="5612601">v</span><span class="op" id="5612602">.</span><span class="ident" id="5612603">mu</span><span class="op" id="5612605">.</span><span class="ident" id="5612606">Unlock</span><span class="op" id="5612612">(</span><span class="op" id="5612613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612616">v</span><span class="op" id="5612617">.</span><span class="ident" id="5612618">i</span>&nbsp;<span class="op" id="5612620">=</span>&nbsp;<span class="ident" id="5612622">value</span><br>
<span class="lineno"></span><span class="op" id="5612628">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5612631">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5612701">type</span>&nbsp;<span class="ident" id="5612706">Float</span>&nbsp;<span class="keyword" id="5612712">struct</span>&nbsp;<span class="op" id="5612719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612722">mu</span>&nbsp;<span class="ident" id="5612725">sync</span><span class="op" id="5612729">.</span><span class="ident" id="5612730">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612739">f</span>&nbsp;&nbsp;<span class="builtintype" id="5612742">float64</span><br>
<span class="lineno">70</span><span class="op" id="5612750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5612753">func</span>&nbsp;<span class="op" id="5612758">(</span><span class="ident" id="5612759">v</span>&nbsp;<span class="op" id="5612761">*</span><span class="ident" id="5612762">Float</span><span class="op" id="5612767">)</span>&nbsp;<span class="ident" id="5612769">String</span><span class="op" id="5612775">(</span><span class="op" id="5612776">)</span>&nbsp;<span class="builtintype" id="5612778">string</span>&nbsp;<span class="op" id="5612785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612788">v</span><span class="op" id="5612789">.</span><span class="ident" id="5612790">mu</span><span class="op" id="5612792">.</span><span class="ident" id="5612793">RLock</span><span class="op" id="5612798">(</span><span class="op" id="5612799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612802">defer</span>&nbsp;<span class="ident" id="5612808">v</span><span class="op" id="5612809">.</span><span class="ident" id="5612810">mu</span><span class="op" id="5612812">.</span><span class="ident" id="5612813">RUnlock</span><span class="op" id="5612820">(</span><span class="op" id="5612821">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612824">return</span>&nbsp;<span class="ident" id="5612831">strconv</span><span class="op" id="5612838">.</span><span class="ident" id="5612839">FormatFloat</span><span class="op" id="5612850">(</span><span class="ident" id="5612851">v</span><span class="op" id="5612852">.</span><span class="ident" id="5612853">f</span><span class="op" id="5612854">,</span>&nbsp;<span class="string" id="5612856">&#39;g&#39;</span><span class="op" id="5612859">,</span>&nbsp;<span class="op" id="5612861">-</span><span class="num" id="5612862">1</span><span class="op" id="5612863">,</span>&nbsp;<span class="num" id="5612865">64</span><span class="op" id="5612867">)</span><br>
<span class="lineno"></span><span class="op" id="5612869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5612872">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5612896">func</span>&nbsp;<span class="op" id="5612901">(</span><span class="ident" id="5612902">v</span>&nbsp;<span class="op" id="5612904">*</span><span class="ident" id="5612905">Float</span><span class="op" id="5612910">)</span>&nbsp;<span class="ident" id="5612912">Add</span><span class="op" id="5612915">(</span><span class="ident" id="5612916">delta</span>&nbsp;<span class="builtintype" id="5612922">float64</span><span class="op" id="5612929">)</span>&nbsp;<span class="op" id="5612931">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612934">v</span><span class="op" id="5612935">.</span><span class="ident" id="5612936">mu</span><span class="op" id="5612938">.</span><span class="ident" id="5612939">Lock</span><span class="op" id="5612943">(</span><span class="op" id="5612944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612947">defer</span>&nbsp;<span class="ident" id="5612953">v</span><span class="op" id="5612954">.</span><span class="ident" id="5612955">mu</span><span class="op" id="5612957">.</span><span class="ident" id="5612958">Unlock</span><span class="op" id="5612964">(</span><span class="op" id="5612965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612968">v</span><span class="op" id="5612969">.</span><span class="ident" id="5612970">f</span>&nbsp;<span class="op" id="5612972">+=</span>&nbsp;<span class="ident" id="5612975">delta</span><br>
<span class="lineno"></span><span class="op" id="5612981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5612984">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5613008">func</span>&nbsp;<span class="op" id="5613013">(</span><span class="ident" id="5613014">v</span>&nbsp;<span class="op" id="5613016">*</span><span class="ident" id="5613017">Float</span><span class="op" id="5613022">)</span>&nbsp;<span class="ident" id="5613024">Set</span><span class="op" id="5613027">(</span><span class="ident" id="5613028">value</span>&nbsp;<span class="builtintype" id="5613034">float64</span><span class="op" id="5613041">)</span>&nbsp;<span class="op" id="5613043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613046">v</span><span class="op" id="5613047">.</span><span class="ident" id="5613048">mu</span><span class="op" id="5613050">.</span><span class="ident" id="5613051">Lock</span><span class="op" id="5613055">(</span><span class="op" id="5613056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613059">defer</span>&nbsp;<span class="ident" id="5613065">v</span><span class="op" id="5613066">.</span><span class="ident" id="5613067">mu</span><span class="op" id="5613069">.</span><span class="ident" id="5613070">Unlock</span><span class="op" id="5613076">(</span><span class="op" id="5613077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613080">v</span><span class="op" id="5613081">.</span><span class="ident" id="5613082">f</span>&nbsp;<span class="op" id="5613084">=</span>&nbsp;<span class="ident" id="5613086">value</span><br>
<span class="lineno">90</span><span class="op" id="5613092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5613095">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5613168">type</span>&nbsp;<span class="ident" id="5613173">Map</span>&nbsp;<span class="keyword" id="5613177">struct</span>&nbsp;<span class="op" id="5613184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613187">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5613192">sync</span><span class="op" id="5613196">.</span><span class="ident" id="5613197">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613206">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613211">map</span><span class="op" id="5613214">[</span><span class="builtintype" id="5613215">string</span><span class="op" id="5613221">]</span><span class="ident" id="5613222">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613227">keys</span>&nbsp;<span class="op" id="5613232">[</span><span class="op" id="5613233">]</span><span class="builtintype" id="5613234">string</span>&nbsp;<span class="comment" id="5613241">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5613251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5613254">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5613302">type</span>&nbsp;<span class="ident" id="5613307">KeyValue</span>&nbsp;<span class="keyword" id="5613316">struct</span>&nbsp;<span class="op" id="5613323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613326">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5613332">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613340">Value</span>&nbsp;<span class="ident" id="5613346">Var</span><br>
<span class="lineno"></span><span class="op" id="5613350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5613353">func</span>&nbsp;<span class="op" id="5613358">(</span><span class="ident" id="5613359">v</span>&nbsp;<span class="op" id="5613361">*</span><span class="ident" id="5613362">Map</span><span class="op" id="5613365">)</span>&nbsp;<span class="ident" id="5613367">String</span><span class="op" id="5613373">(</span><span class="op" id="5613374">)</span>&nbsp;<span class="builtintype" id="5613376">string</span>&nbsp;<span class="op" id="5613383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613386">v</span><span class="op" id="5613387">.</span><span class="ident" id="5613388">mu</span><span class="op" id="5613390">.</span><span class="ident" id="5613391">RLock</span><span class="op" id="5613396">(</span><span class="op" id="5613397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613400">defer</span>&nbsp;<span class="ident" id="5613406">v</span><span class="op" id="5613407">.</span><span class="ident" id="5613408">mu</span><span class="op" id="5613410">.</span><span class="ident" id="5613411">RUnlock</span><span class="op" id="5613418">(</span><span class="op" id="5613419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613422">var</span>&nbsp;<span class="ident" id="5613426">b</span>&nbsp;<span class="ident" id="5613428">bytes</span><span class="op" id="5613433">.</span><span class="ident" id="5613434">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613442">fmt</span><span class="op" id="5613445">.</span><span class="ident" id="5613446">Fprintf</span><span class="op" id="5613453">(</span><span class="op" id="5613454">&amp;</span><span class="ident" id="5613455">b</span><span class="op" id="5613456">,</span>&nbsp;<span class="string" id="5613458">&#34;{&#34;</span><span class="op" id="5613461">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613464">first</span>&nbsp;<span class="op" id="5613470">:=</span>&nbsp;<span class="builtintype" id="5613473">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613479">v</span><span class="op" id="5613480">.</span><span class="ident" id="5613481">doLocked</span><span class="op" id="5613489">(</span><span class="keyword" id="5613490">func</span><span class="op" id="5613494">(</span><span class="ident" id="5613495">kv</span>&nbsp;<span class="ident" id="5613498">KeyValue</span><span class="op" id="5613506">)</span>&nbsp;<span class="op" id="5613508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613512">if</span>&nbsp;<span class="op" id="5613515">!</span><span class="ident" id="5613516">first</span>&nbsp;<span class="op" id="5613522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613527">fmt</span><span class="op" id="5613530">.</span><span class="ident" id="5613531">Fprintf</span><span class="op" id="5613538">(</span><span class="op" id="5613539">&amp;</span><span class="ident" id="5613540">b</span><span class="op" id="5613541">,</span>&nbsp;<span class="string" id="5613543">&#34;,&nbsp;&#34;</span><span class="op" id="5613547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613551">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613555">fmt</span><span class="op" id="5613558">.</span><span class="ident" id="5613559">Fprintf</span><span class="op" id="5613566">(</span><span class="op" id="5613567">&amp;</span><span class="ident" id="5613568">b</span><span class="op" id="5613569">,</span>&nbsp;<span class="string" id="5613571">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5613579">,</span>&nbsp;<span class="ident" id="5613581">kv</span><span class="op" id="5613583">.</span><span class="ident" id="5613584">Key</span><span class="op" id="5613587">,</span>&nbsp;<span class="ident" id="5613589">kv</span><span class="op" id="5613591">.</span><span class="ident" id="5613592">Value</span><span class="op" id="5613597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613601">first</span>&nbsp;<span class="op" id="5613607">=</span>&nbsp;<span class="builtintype" id="5613609">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613616">}</span><span class="op" id="5613617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613620">fmt</span><span class="op" id="5613623">.</span><span class="ident" id="5613624">Fprintf</span><span class="op" id="5613631">(</span><span class="op" id="5613632">&amp;</span><span class="ident" id="5613633">b</span><span class="op" id="5613634">,</span>&nbsp;<span class="string" id="5613636">&#34;}&#34;</span><span class="op" id="5613639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613642">return</span>&nbsp;<span class="ident" id="5613649">b</span><span class="op" id="5613650">.</span><span class="ident" id="5613651">String</span><span class="op" id="5613657">(</span><span class="op" id="5613658">)</span><br>
<span class="lineno">120</span><span class="op" id="5613660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5613663">func</span>&nbsp;<span class="op" id="5613668">(</span><span class="ident" id="5613669">v</span>&nbsp;<span class="op" id="5613671">*</span><span class="ident" id="5613672">Map</span><span class="op" id="5613675">)</span>&nbsp;<span class="ident" id="5613677">Init</span><span class="op" id="5613681">(</span><span class="op" id="5613682">)</span>&nbsp;<span class="op" id="5613684">*</span><span class="ident" id="5613685">Map</span>&nbsp;<span class="op" id="5613689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613692">v</span><span class="op" id="5613693">.</span><span class="ident" id="5613694">m</span>&nbsp;<span class="op" id="5613696">=</span>&nbsp;<span class="builtinfunc" id="5613698">make</span><span class="op" id="5613702">(</span><span class="keyword" id="5613703">map</span><span class="op" id="5613706">[</span><span class="builtintype" id="5613707">string</span><span class="op" id="5613713">]</span><span class="ident" id="5613714">Var</span><span class="op" id="5613717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613720">return</span>&nbsp;<span class="ident" id="5613727">v</span><br>
<span class="lineno">125</span><span class="op" id="5613729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5613732">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5613789">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5613823">func</span>&nbsp;<span class="op" id="5613828">(</span><span class="ident" id="5613829">v</span>&nbsp;<span class="op" id="5613831">*</span><span class="ident" id="5613832">Map</span><span class="op" id="5613835">)</span>&nbsp;<span class="ident" id="5613837">updateKeys</span><span class="op" id="5613847">(</span><span class="op" id="5613848">)</span>&nbsp;<span class="op" id="5613850">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613853">if</span>&nbsp;<span class="builtinfunc" id="5613856">len</span><span class="op" id="5613859">(</span><span class="ident" id="5613860">v</span><span class="op" id="5613861">.</span><span class="ident" id="5613862">m</span><span class="op" id="5613863">)</span>&nbsp;<span class="op" id="5613865">==</span>&nbsp;<span class="builtinfunc" id="5613868">len</span><span class="op" id="5613871">(</span><span class="ident" id="5613872">v</span><span class="op" id="5613873">.</span><span class="ident" id="5613874">keys</span><span class="op" id="5613878">)</span>&nbsp;<span class="op" id="5613880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613884">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613901">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613912">v</span><span class="op" id="5613913">.</span><span class="ident" id="5613914">keys</span>&nbsp;<span class="op" id="5613919">=</span>&nbsp;<span class="ident" id="5613921">v</span><span class="op" id="5613922">.</span><span class="ident" id="5613923">keys</span><span class="op" id="5613927">[</span><span class="op" id="5613928">:</span><span class="num" id="5613929">0</span><span class="op" id="5613930">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613933">for</span>&nbsp;<span class="ident" id="5613937">k</span>&nbsp;<span class="op" id="5613939">:=</span>&nbsp;<span class="keyword" id="5613942">range</span>&nbsp;<span class="ident" id="5613948">v</span><span class="op" id="5613949">.</span><span class="ident" id="5613950">m</span>&nbsp;<span class="op" id="5613952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613956">v</span><span class="op" id="5613957">.</span><span class="ident" id="5613958">keys</span>&nbsp;<span class="op" id="5613963">=</span>&nbsp;<span class="builtinfunc" id="5613965">append</span><span class="op" id="5613971">(</span><span class="ident" id="5613972">v</span><span class="op" id="5613973">.</span><span class="ident" id="5613974">keys</span><span class="op" id="5613978">,</span>&nbsp;<span class="ident" id="5613980">k</span><span class="op" id="5613981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613987">sort</span><span class="op" id="5613991">.</span><span class="ident" id="5613992">Strings</span><span class="op" id="5613999">(</span><span class="ident" id="5614000">v</span><span class="op" id="5614001">.</span><span class="ident" id="5614002">keys</span><span class="op" id="5614006">)</span><br>
<span class="lineno"></span><span class="op" id="5614008">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5614011">func</span>&nbsp;<span class="op" id="5614016">(</span><span class="ident" id="5614017">v</span>&nbsp;<span class="op" id="5614019">*</span><span class="ident" id="5614020">Map</span><span class="op" id="5614023">)</span>&nbsp;<span class="ident" id="5614025">Get</span><span class="op" id="5614028">(</span><span class="ident" id="5614029">key</span>&nbsp;<span class="builtintype" id="5614033">string</span><span class="op" id="5614039">)</span>&nbsp;<span class="ident" id="5614041">Var</span>&nbsp;<span class="op" id="5614045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614048">v</span><span class="op" id="5614049">.</span><span class="ident" id="5614050">mu</span><span class="op" id="5614052">.</span><span class="ident" id="5614053">RLock</span><span class="op" id="5614058">(</span><span class="op" id="5614059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614062">defer</span>&nbsp;<span class="ident" id="5614068">v</span><span class="op" id="5614069">.</span><span class="ident" id="5614070">mu</span><span class="op" id="5614072">.</span><span class="ident" id="5614073">RUnlock</span><span class="op" id="5614080">(</span><span class="op" id="5614081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614084">return</span>&nbsp;<span class="ident" id="5614091">v</span><span class="op" id="5614092">.</span><span class="ident" id="5614093">m</span><span class="op" id="5614094">[</span><span class="ident" id="5614095">key</span><span class="op" id="5614098">]</span><br>
<span class="lineno">145</span><span class="op" id="5614100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5614103">func</span>&nbsp;<span class="op" id="5614108">(</span><span class="ident" id="5614109">v</span>&nbsp;<span class="op" id="5614111">*</span><span class="ident" id="5614112">Map</span><span class="op" id="5614115">)</span>&nbsp;<span class="ident" id="5614117">Set</span><span class="op" id="5614120">(</span><span class="ident" id="5614121">key</span>&nbsp;<span class="builtintype" id="5614125">string</span><span class="op" id="5614131">,</span>&nbsp;<span class="ident" id="5614133">av</span>&nbsp;<span class="ident" id="5614136">Var</span><span class="op" id="5614139">)</span>&nbsp;<span class="op" id="5614141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614144">v</span><span class="op" id="5614145">.</span><span class="ident" id="5614146">mu</span><span class="op" id="5614148">.</span><span class="ident" id="5614149">Lock</span><span class="op" id="5614153">(</span><span class="op" id="5614154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614157">defer</span>&nbsp;<span class="ident" id="5614163">v</span><span class="op" id="5614164">.</span><span class="ident" id="5614165">mu</span><span class="op" id="5614167">.</span><span class="ident" id="5614168">Unlock</span><span class="op" id="5614174">(</span><span class="op" id="5614175">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614178">v</span><span class="op" id="5614179">.</span><span class="ident" id="5614180">m</span><span class="op" id="5614181">[</span><span class="ident" id="5614182">key</span><span class="op" id="5614185">]</span>&nbsp;<span class="op" id="5614187">=</span>&nbsp;<span class="ident" id="5614189">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614193">v</span><span class="op" id="5614194">.</span><span class="ident" id="5614195">updateKeys</span><span class="op" id="5614205">(</span><span class="op" id="5614206">)</span><br>
<span class="lineno"></span><span class="op" id="5614208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5614211">func</span>&nbsp;<span class="op" id="5614216">(</span><span class="ident" id="5614217">v</span>&nbsp;<span class="op" id="5614219">*</span><span class="ident" id="5614220">Map</span><span class="op" id="5614223">)</span>&nbsp;<span class="ident" id="5614225">Add</span><span class="op" id="5614228">(</span><span class="ident" id="5614229">key</span>&nbsp;<span class="builtintype" id="5614233">string</span><span class="op" id="5614239">,</span>&nbsp;<span class="ident" id="5614241">delta</span>&nbsp;<span class="ident" id="5614247">int64</span><span class="op" id="5614252">)</span>&nbsp;<span class="op" id="5614254">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614257">v</span><span class="op" id="5614258">.</span><span class="ident" id="5614259">mu</span><span class="op" id="5614261">.</span><span class="ident" id="5614262">RLock</span><span class="op" id="5614267">(</span><span class="op" id="5614268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614271">av</span><span class="op" id="5614273">,</span>&nbsp;<span class="ident" id="5614275">ok</span>&nbsp;<span class="op" id="5614278">:=</span>&nbsp;<span class="ident" id="5614281">v</span><span class="op" id="5614282">.</span><span class="ident" id="5614283">m</span><span class="op" id="5614284">[</span><span class="ident" id="5614285">key</span><span class="op" id="5614288">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614291">v</span><span class="op" id="5614292">.</span><span class="ident" id="5614293">mu</span><span class="op" id="5614295">.</span><span class="ident" id="5614296">RUnlock</span><span class="op" id="5614303">(</span><span class="op" id="5614304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614307">if</span>&nbsp;<span class="op" id="5614310">!</span><span class="ident" id="5614311">ok</span>&nbsp;<span class="op" id="5614314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614318">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614356">v</span><span class="op" id="5614357">.</span><span class="ident" id="5614358">mu</span><span class="op" id="5614360">.</span><span class="ident" id="5614361">Lock</span><span class="op" id="5614365">(</span><span class="op" id="5614366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614370">av</span><span class="op" id="5614372">,</span>&nbsp;<span class="ident" id="5614374">ok</span>&nbsp;<span class="op" id="5614377">=</span>&nbsp;<span class="ident" id="5614379">v</span><span class="op" id="5614380">.</span><span class="ident" id="5614381">m</span><span class="op" id="5614382">[</span><span class="ident" id="5614383">key</span><span class="op" id="5614386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614390">if</span>&nbsp;<span class="op" id="5614393">!</span><span class="ident" id="5614394">ok</span>&nbsp;<span class="op" id="5614397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614402">av</span>&nbsp;<span class="op" id="5614405">=</span>&nbsp;<span class="builtinfunc" id="5614407">new</span><span class="op" id="5614410">(</span><span class="ident" id="5614411">Int</span><span class="op" id="5614414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614419">v</span><span class="op" id="5614420">.</span><span class="ident" id="5614421">m</span><span class="op" id="5614422">[</span><span class="ident" id="5614423">key</span><span class="op" id="5614426">]</span>&nbsp;<span class="op" id="5614428">=</span>&nbsp;<span class="ident" id="5614430">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614436">v</span><span class="op" id="5614437">.</span><span class="ident" id="5614438">updateKeys</span><span class="op" id="5614448">(</span><span class="op" id="5614449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614457">v</span><span class="op" id="5614458">.</span><span class="ident" id="5614459">mu</span><span class="op" id="5614461">.</span><span class="ident" id="5614462">Unlock</span><span class="op" id="5614468">(</span><span class="op" id="5614469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614476">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614510">if</span>&nbsp;<span class="ident" id="5614513">iv</span><span class="op" id="5614515">,</span>&nbsp;<span class="ident" id="5614517">ok</span>&nbsp;<span class="op" id="5614520">:=</span>&nbsp;<span class="ident" id="5614523">av</span><span class="op" id="5614525">.</span><span class="op" id="5614526">(</span><span class="op" id="5614527">*</span><span class="ident" id="5614528">Int</span><span class="op" id="5614531">)</span><span class="op" id="5614532">;</span>&nbsp;<span class="ident" id="5614534">ok</span>&nbsp;<span class="op" id="5614537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614541">iv</span><span class="op" id="5614543">.</span><span class="ident" id="5614544">Add</span><span class="op" id="5614547">(</span><span class="ident" id="5614548">delta</span><span class="op" id="5614553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614556">}</span><br>
<span class="lineno"></span><span class="op" id="5614558">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5614561">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5614636">func</span>&nbsp;<span class="op" id="5614641">(</span><span class="ident" id="5614642">v</span>&nbsp;<span class="op" id="5614644">*</span><span class="ident" id="5614645">Map</span><span class="op" id="5614648">)</span>&nbsp;<span class="ident" id="5614650">AddFloat</span><span class="op" id="5614658">(</span><span class="ident" id="5614659">key</span>&nbsp;<span class="builtintype" id="5614663">string</span><span class="op" id="5614669">,</span>&nbsp;<span class="ident" id="5614671">delta</span>&nbsp;<span class="builtintype" id="5614677">float64</span><span class="op" id="5614684">)</span>&nbsp;<span class="op" id="5614686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614689">v</span><span class="op" id="5614690">.</span><span class="ident" id="5614691">mu</span><span class="op" id="5614693">.</span><span class="ident" id="5614694">RLock</span><span class="op" id="5614699">(</span><span class="op" id="5614700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614703">av</span><span class="op" id="5614705">,</span>&nbsp;<span class="ident" id="5614707">ok</span>&nbsp;<span class="op" id="5614710">:=</span>&nbsp;<span class="ident" id="5614713">v</span><span class="op" id="5614714">.</span><span class="ident" id="5614715">m</span><span class="op" id="5614716">[</span><span class="ident" id="5614717">key</span><span class="op" id="5614720">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614723">v</span><span class="op" id="5614724">.</span><span class="ident" id="5614725">mu</span><span class="op" id="5614727">.</span><span class="ident" id="5614728">RUnlock</span><span class="op" id="5614735">(</span><span class="op" id="5614736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614739">if</span>&nbsp;<span class="op" id="5614742">!</span><span class="ident" id="5614743">ok</span>&nbsp;<span class="op" id="5614746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614750">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614788">v</span><span class="op" id="5614789">.</span><span class="ident" id="5614790">mu</span><span class="op" id="5614792">.</span><span class="ident" id="5614793">Lock</span><span class="op" id="5614797">(</span><span class="op" id="5614798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614802">av</span><span class="op" id="5614804">,</span>&nbsp;<span class="ident" id="5614806">ok</span>&nbsp;<span class="op" id="5614809">=</span>&nbsp;<span class="ident" id="5614811">v</span><span class="op" id="5614812">.</span><span class="ident" id="5614813">m</span><span class="op" id="5614814">[</span><span class="ident" id="5614815">key</span><span class="op" id="5614818">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614822">if</span>&nbsp;<span class="op" id="5614825">!</span><span class="ident" id="5614826">ok</span>&nbsp;<span class="op" id="5614829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614834">av</span>&nbsp;<span class="op" id="5614837">=</span>&nbsp;<span class="builtinfunc" id="5614839">new</span><span class="op" id="5614842">(</span><span class="ident" id="5614843">Float</span><span class="op" id="5614848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614853">v</span><span class="op" id="5614854">.</span><span class="ident" id="5614855">m</span><span class="op" id="5614856">[</span><span class="ident" id="5614857">key</span><span class="op" id="5614860">]</span>&nbsp;<span class="op" id="5614862">=</span>&nbsp;<span class="ident" id="5614864">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614870">v</span><span class="op" id="5614871">.</span><span class="ident" id="5614872">updateKeys</span><span class="op" id="5614882">(</span><span class="op" id="5614883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614887">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614891">v</span><span class="op" id="5614892">.</span><span class="ident" id="5614893">mu</span><span class="op" id="5614895">.</span><span class="ident" id="5614896">Unlock</span><span class="op" id="5614902">(</span><span class="op" id="5614903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614910">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614946">if</span>&nbsp;<span class="ident" id="5614949">iv</span><span class="op" id="5614951">,</span>&nbsp;<span class="ident" id="5614953">ok</span>&nbsp;<span class="op" id="5614956">:=</span>&nbsp;<span class="ident" id="5614959">av</span><span class="op" id="5614961">.</span><span class="op" id="5614962">(</span><span class="op" id="5614963">*</span><span class="ident" id="5614964">Float</span><span class="op" id="5614969">)</span><span class="op" id="5614970">;</span>&nbsp;<span class="ident" id="5614972">ok</span>&nbsp;<span class="op" id="5614975">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614979">iv</span><span class="op" id="5614981">.</span><span class="ident" id="5614982">Add</span><span class="op" id="5614985">(</span><span class="ident" id="5614986">delta</span><span class="op" id="5614991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614994">}</span><br>
<span class="lineno"></span><span class="op" id="5614996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5614999">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5615040">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5615083">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5615136">func</span>&nbsp;<span class="op" id="5615141">(</span><span class="ident" id="5615142">v</span>&nbsp;<span class="op" id="5615144">*</span><span class="ident" id="5615145">Map</span><span class="op" id="5615148">)</span>&nbsp;<span class="ident" id="5615150">Do</span><span class="op" id="5615152">(</span><span class="ident" id="5615153">f</span>&nbsp;<span class="keyword" id="5615155">func</span><span class="op" id="5615159">(</span><span class="ident" id="5615160">KeyValue</span><span class="op" id="5615168">)</span><span class="op" id="5615169">)</span>&nbsp;<span class="op" id="5615171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615174">v</span><span class="op" id="5615175">.</span><span class="ident" id="5615176">mu</span><span class="op" id="5615178">.</span><span class="ident" id="5615179">RLock</span><span class="op" id="5615184">(</span><span class="op" id="5615185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615188">defer</span>&nbsp;<span class="ident" id="5615194">v</span><span class="op" id="5615195">.</span><span class="ident" id="5615196">mu</span><span class="op" id="5615198">.</span><span class="ident" id="5615199">RUnlock</span><span class="op" id="5615206">(</span><span class="op" id="5615207">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615210">v</span><span class="op" id="5615211">.</span><span class="ident" id="5615212">doLocked</span><span class="op" id="5615220">(</span><span class="ident" id="5615221">f</span><span class="op" id="5615222">)</span><br>
<span class="lineno"></span><span class="op" id="5615224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5615227">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5615274">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5615306">func</span>&nbsp;<span class="op" id="5615311">(</span><span class="ident" id="5615312">v</span>&nbsp;<span class="op" id="5615314">*</span><span class="ident" id="5615315">Map</span><span class="op" id="5615318">)</span>&nbsp;<span class="ident" id="5615320">doLocked</span><span class="op" id="5615328">(</span><span class="ident" id="5615329">f</span>&nbsp;<span class="keyword" id="5615331">func</span><span class="op" id="5615335">(</span><span class="ident" id="5615336">KeyValue</span><span class="op" id="5615344">)</span><span class="op" id="5615345">)</span>&nbsp;<span class="op" id="5615347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615350">for</span>&nbsp;<span class="ident" id="5615354">_</span><span class="op" id="5615355">,</span>&nbsp;<span class="ident" id="5615357">k</span>&nbsp;<span class="op" id="5615359">:=</span>&nbsp;<span class="keyword" id="5615362">range</span>&nbsp;<span class="ident" id="5615368">v</span><span class="op" id="5615369">.</span><span class="ident" id="5615370">keys</span>&nbsp;<span class="op" id="5615375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615379">f</span><span class="op" id="5615380">(</span><span class="ident" id="5615381">KeyValue</span><span class="op" id="5615389">{</span><span class="ident" id="5615390">k</span><span class="op" id="5615391">,</span>&nbsp;<span class="ident" id="5615393">v</span><span class="op" id="5615394">.</span><span class="ident" id="5615395">m</span><span class="op" id="5615396">[</span><span class="ident" id="5615397">k</span><span class="op" id="5615398">]</span><span class="op" id="5615399">}</span><span class="op" id="5615400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615403">}</span><br>
<span class="lineno"></span><span class="op" id="5615405">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5615408">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5615473">type</span>&nbsp;<span class="ident" id="5615478">String</span>&nbsp;<span class="keyword" id="5615485">struct</span>&nbsp;<span class="op" id="5615492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615495">mu</span>&nbsp;<span class="ident" id="5615498">sync</span><span class="op" id="5615502">.</span><span class="ident" id="5615503">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615512">s</span>&nbsp;&nbsp;<span class="builtintype" id="5615515">string</span><br>
<span class="lineno">220</span><span class="op" id="5615522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615525">func</span>&nbsp;<span class="op" id="5615530">(</span><span class="ident" id="5615531">v</span>&nbsp;<span class="op" id="5615533">*</span><span class="ident" id="5615534">String</span><span class="op" id="5615540">)</span>&nbsp;<span class="ident" id="5615542">String</span><span class="op" id="5615548">(</span><span class="op" id="5615549">)</span>&nbsp;<span class="builtintype" id="5615551">string</span>&nbsp;<span class="op" id="5615558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615561">v</span><span class="op" id="5615562">.</span><span class="ident" id="5615563">mu</span><span class="op" id="5615565">.</span><span class="ident" id="5615566">RLock</span><span class="op" id="5615571">(</span><span class="op" id="5615572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615575">defer</span>&nbsp;<span class="ident" id="5615581">v</span><span class="op" id="5615582">.</span><span class="ident" id="5615583">mu</span><span class="op" id="5615585">.</span><span class="ident" id="5615586">RUnlock</span><span class="op" id="5615593">(</span><span class="op" id="5615594">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615597">return</span>&nbsp;<span class="ident" id="5615604">strconv</span><span class="op" id="5615611">.</span><span class="ident" id="5615612">Quote</span><span class="op" id="5615617">(</span><span class="ident" id="5615618">v</span><span class="op" id="5615619">.</span><span class="ident" id="5615620">s</span><span class="op" id="5615621">)</span><br>
<span class="lineno"></span><span class="op" id="5615623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615626">func</span>&nbsp;<span class="op" id="5615631">(</span><span class="ident" id="5615632">v</span>&nbsp;<span class="op" id="5615634">*</span><span class="ident" id="5615635">String</span><span class="op" id="5615641">)</span>&nbsp;<span class="ident" id="5615643">Set</span><span class="op" id="5615646">(</span><span class="ident" id="5615647">value</span>&nbsp;<span class="builtintype" id="5615653">string</span><span class="op" id="5615659">)</span>&nbsp;<span class="op" id="5615661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615664">v</span><span class="op" id="5615665">.</span><span class="ident" id="5615666">mu</span><span class="op" id="5615668">.</span><span class="ident" id="5615669">Lock</span><span class="op" id="5615673">(</span><span class="op" id="5615674">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615677">defer</span>&nbsp;<span class="ident" id="5615683">v</span><span class="op" id="5615684">.</span><span class="ident" id="5615685">mu</span><span class="op" id="5615687">.</span><span class="ident" id="5615688">Unlock</span><span class="op" id="5615694">(</span><span class="op" id="5615695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615698">v</span><span class="op" id="5615699">.</span><span class="ident" id="5615700">s</span>&nbsp;<span class="op" id="5615702">=</span>&nbsp;<span class="ident" id="5615704">value</span><br>
<span class="lineno"></span><span class="op" id="5615710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5615713">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5615760">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5615809">type</span>&nbsp;<span class="ident" id="5615814">Func</span>&nbsp;<span class="keyword" id="5615819">func</span><span class="op" id="5615823">(</span><span class="op" id="5615824">)</span>&nbsp;<span class="keyword" id="5615826">interface</span><span class="op" id="5615835">{</span><span class="op" id="5615836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615839">func</span>&nbsp;<span class="op" id="5615844">(</span><span class="ident" id="5615845">f</span>&nbsp;<span class="ident" id="5615847">Func</span><span class="op" id="5615851">)</span>&nbsp;<span class="ident" id="5615853">String</span><span class="op" id="5615859">(</span><span class="op" id="5615860">)</span>&nbsp;<span class="builtintype" id="5615862">string</span>&nbsp;<span class="op" id="5615869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615872">v</span><span class="op" id="5615873">,</span>&nbsp;<span class="ident" id="5615875">_</span>&nbsp;<span class="op" id="5615877">:=</span>&nbsp;<span class="ident" id="5615880">json</span><span class="op" id="5615884">.</span><span class="ident" id="5615885">Marshal</span><span class="op" id="5615892">(</span><span class="ident" id="5615893">f</span><span class="op" id="5615894">(</span><span class="op" id="5615895">)</span><span class="op" id="5615896">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615899">return</span>&nbsp;<span class="builtintype" id="5615906">string</span><span class="op" id="5615912">(</span><span class="ident" id="5615913">v</span><span class="op" id="5615914">)</span><br>
<span class="lineno"></span><span class="op" id="5615916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5615919">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5615947">var</span>&nbsp;<span class="op" id="5615951">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615954">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5615962">sync</span><span class="op" id="5615966">.</span><span class="ident" id="5615967">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615976">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5615984">=</span>&nbsp;<span class="builtinfunc" id="5615986">make</span><span class="op" id="5615990">(</span><span class="keyword" id="5615991">map</span><span class="op" id="5615994">[</span><span class="builtintype" id="5615995">string</span><span class="op" id="5616001">]</span><span class="ident" id="5616002">Var</span><span class="op" id="5616005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616008">varKeys</span>&nbsp;<span class="op" id="5616016">[</span><span class="op" id="5616017">]</span><span class="builtintype" id="5616018">string</span>&nbsp;<span class="comment" id="5616025">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5616035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5616038">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5616114">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5616190">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5616230">func</span>&nbsp;<span class="ident" id="5616235">Publish</span><span class="op" id="5616242">(</span><span class="ident" id="5616243">name</span>&nbsp;<span class="builtintype" id="5616248">string</span><span class="op" id="5616254">,</span>&nbsp;<span class="ident" id="5616256">v</span>&nbsp;<span class="ident" id="5616258">Var</span><span class="op" id="5616261">)</span>&nbsp;<span class="op" id="5616263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616266">mutex</span><span class="op" id="5616271">.</span><span class="ident" id="5616272">Lock</span><span class="op" id="5616276">(</span><span class="op" id="5616277">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616280">defer</span>&nbsp;<span class="ident" id="5616286">mutex</span><span class="op" id="5616291">.</span><span class="ident" id="5616292">Unlock</span><span class="op" id="5616298">(</span><span class="op" id="5616299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616302">if</span>&nbsp;<span class="ident" id="5616305">_</span><span class="op" id="5616306">,</span>&nbsp;<span class="ident" id="5616308">existing</span>&nbsp;<span class="op" id="5616317">:=</span>&nbsp;<span class="ident" id="5616320">vars</span><span class="op" id="5616324">[</span><span class="ident" id="5616325">name</span><span class="op" id="5616329">]</span><span class="op" id="5616330">;</span>&nbsp;<span class="ident" id="5616332">existing</span>&nbsp;<span class="op" id="5616341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616345">log</span><span class="op" id="5616348">.</span><span class="ident" id="5616349">Panicln</span><span class="op" id="5616356">(</span><span class="string" id="5616357">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5616386">,</span>&nbsp;<span class="ident" id="5616388">name</span><span class="op" id="5616392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616398">vars</span><span class="op" id="5616402">[</span><span class="ident" id="5616403">name</span><span class="op" id="5616407">]</span>&nbsp;<span class="op" id="5616409">=</span>&nbsp;<span class="ident" id="5616411">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616414">varKeys</span>&nbsp;<span class="op" id="5616422">=</span>&nbsp;<span class="builtinfunc" id="5616424">append</span><span class="op" id="5616430">(</span><span class="ident" id="5616431">varKeys</span><span class="op" id="5616438">,</span>&nbsp;<span class="ident" id="5616440">name</span><span class="op" id="5616444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616447">sort</span><span class="op" id="5616451">.</span><span class="ident" id="5616452">Strings</span><span class="op" id="5616459">(</span><span class="ident" id="5616460">varKeys</span><span class="op" id="5616467">)</span><br>
<span class="lineno"></span><span class="op" id="5616469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5616472">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5616516">func</span>&nbsp;<span class="ident" id="5616521">Get</span><span class="op" id="5616524">(</span><span class="ident" id="5616525">name</span>&nbsp;<span class="builtintype" id="5616530">string</span><span class="op" id="5616536">)</span>&nbsp;<span class="ident" id="5616538">Var</span>&nbsp;<span class="op" id="5616542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616545">mutex</span><span class="op" id="5616550">.</span><span class="ident" id="5616551">RLock</span><span class="op" id="5616556">(</span><span class="op" id="5616557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616560">defer</span>&nbsp;<span class="ident" id="5616566">mutex</span><span class="op" id="5616571">.</span><span class="ident" id="5616572">RUnlock</span><span class="op" id="5616579">(</span><span class="op" id="5616580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616583">return</span>&nbsp;<span class="ident" id="5616590">vars</span><span class="op" id="5616594">[</span><span class="ident" id="5616595">name</span><span class="op" id="5616599">]</span><br>
<span class="lineno"></span><span class="op" id="5616601">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5616604">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5616667">func</span>&nbsp;<span class="ident" id="5616672">NewInt</span><span class="op" id="5616678">(</span><span class="ident" id="5616679">name</span>&nbsp;<span class="builtintype" id="5616684">string</span><span class="op" id="5616690">)</span>&nbsp;<span class="op" id="5616692">*</span><span class="ident" id="5616693">Int</span>&nbsp;<span class="op" id="5616697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616700">v</span>&nbsp;<span class="op" id="5616702">:=</span>&nbsp;<span class="builtinfunc" id="5616705">new</span><span class="op" id="5616708">(</span><span class="ident" id="5616709">Int</span><span class="op" id="5616712">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616715">Publish</span><span class="op" id="5616722">(</span><span class="ident" id="5616723">name</span><span class="op" id="5616727">,</span>&nbsp;<span class="ident" id="5616729">v</span><span class="op" id="5616730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616733">return</span>&nbsp;<span class="ident" id="5616740">v</span><br>
<span class="lineno"></span><span class="op" id="5616742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5616745">func</span>&nbsp;<span class="ident" id="5616750">NewFloat</span><span class="op" id="5616758">(</span><span class="ident" id="5616759">name</span>&nbsp;<span class="builtintype" id="5616764">string</span><span class="op" id="5616770">)</span>&nbsp;<span class="op" id="5616772">*</span><span class="ident" id="5616773">Float</span>&nbsp;<span class="op" id="5616779">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616782">v</span>&nbsp;<span class="op" id="5616784">:=</span>&nbsp;<span class="builtinfunc" id="5616787">new</span><span class="op" id="5616790">(</span><span class="ident" id="5616791">Float</span><span class="op" id="5616796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616799">Publish</span><span class="op" id="5616806">(</span><span class="ident" id="5616807">name</span><span class="op" id="5616811">,</span>&nbsp;<span class="ident" id="5616813">v</span><span class="op" id="5616814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616817">return</span>&nbsp;<span class="ident" id="5616824">v</span><br>
<span class="lineno"></span><span class="op" id="5616826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5616829">func</span>&nbsp;<span class="ident" id="5616834">NewMap</span><span class="op" id="5616840">(</span><span class="ident" id="5616841">name</span>&nbsp;<span class="builtintype" id="5616846">string</span><span class="op" id="5616852">)</span>&nbsp;<span class="op" id="5616854">*</span><span class="ident" id="5616855">Map</span>&nbsp;<span class="op" id="5616859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616862">v</span>&nbsp;<span class="op" id="5616864">:=</span>&nbsp;<span class="builtinfunc" id="5616867">new</span><span class="op" id="5616870">(</span><span class="ident" id="5616871">Map</span><span class="op" id="5616874">)</span><span class="op" id="5616875">.</span><span class="ident" id="5616876">Init</span><span class="op" id="5616880">(</span><span class="op" id="5616881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616884">Publish</span><span class="op" id="5616891">(</span><span class="ident" id="5616892">name</span><span class="op" id="5616896">,</span>&nbsp;<span class="ident" id="5616898">v</span><span class="op" id="5616899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616902">return</span>&nbsp;<span class="ident" id="5616909">v</span><br>
<span class="lineno"></span><span class="op" id="5616911">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5616914">func</span>&nbsp;<span class="ident" id="5616919">NewString</span><span class="op" id="5616928">(</span><span class="ident" id="5616929">name</span>&nbsp;<span class="builtintype" id="5616934">string</span><span class="op" id="5616940">)</span>&nbsp;<span class="op" id="5616942">*</span><span class="ident" id="5616943">String</span>&nbsp;<span class="op" id="5616950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616953">v</span>&nbsp;<span class="op" id="5616955">:=</span>&nbsp;<span class="builtinfunc" id="5616958">new</span><span class="op" id="5616961">(</span><span class="ident" id="5616962">String</span><span class="op" id="5616968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616971">Publish</span><span class="op" id="5616978">(</span><span class="ident" id="5616979">name</span><span class="op" id="5616983">,</span>&nbsp;<span class="ident" id="5616985">v</span><span class="op" id="5616986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616989">return</span>&nbsp;<span class="ident" id="5616996">v</span><br>
<span class="lineno">295</span><span class="op" id="5616998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5617001">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5617043">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5617102">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5617155">func</span>&nbsp;<span class="ident" id="5617160">Do</span><span class="op" id="5617162">(</span><span class="ident" id="5617163">f</span>&nbsp;<span class="keyword" id="5617165">func</span><span class="op" id="5617169">(</span><span class="ident" id="5617170">KeyValue</span><span class="op" id="5617178">)</span><span class="op" id="5617179">)</span>&nbsp;<span class="op" id="5617181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617184">mutex</span><span class="op" id="5617189">.</span><span class="ident" id="5617190">RLock</span><span class="op" id="5617195">(</span><span class="op" id="5617196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617199">defer</span>&nbsp;<span class="ident" id="5617205">mutex</span><span class="op" id="5617210">.</span><span class="ident" id="5617211">RUnlock</span><span class="op" id="5617218">(</span><span class="op" id="5617219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617222">for</span>&nbsp;<span class="ident" id="5617226">_</span><span class="op" id="5617227">,</span>&nbsp;<span class="ident" id="5617229">k</span>&nbsp;<span class="op" id="5617231">:=</span>&nbsp;<span class="keyword" id="5617234">range</span>&nbsp;<span class="ident" id="5617240">varKeys</span>&nbsp;<span class="op" id="5617248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617252">f</span><span class="op" id="5617253">(</span><span class="ident" id="5617254">KeyValue</span><span class="op" id="5617262">{</span><span class="ident" id="5617263">k</span><span class="op" id="5617264">,</span>&nbsp;<span class="ident" id="5617266">vars</span><span class="op" id="5617270">[</span><span class="ident" id="5617271">k</span><span class="op" id="5617272">]</span><span class="op" id="5617273">}</span><span class="op" id="5617274">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617277">}</span><br>
<span class="lineno"></span><span class="op" id="5617279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617282">func</span>&nbsp;<span class="ident" id="5617287">expvarHandler</span><span class="op" id="5617300">(</span><span class="ident" id="5617301">w</span>&nbsp;<span class="ident" id="5617303">http</span><span class="op" id="5617307">.</span><span class="ident" id="5617308">ResponseWriter</span><span class="op" id="5617322">,</span>&nbsp;<span class="ident" id="5617324">r</span>&nbsp;<span class="op" id="5617326">*</span><span class="ident" id="5617327">http</span><span class="op" id="5617331">.</span><span class="ident" id="5617332">Request</span><span class="op" id="5617339">)</span>&nbsp;<span class="op" id="5617341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617344">w</span><span class="op" id="5617345">.</span><span class="ident" id="5617346">Header</span><span class="op" id="5617352">(</span><span class="op" id="5617353">)</span><span class="op" id="5617354">.</span><span class="ident" id="5617355">Set</span><span class="op" id="5617358">(</span><span class="string" id="5617359">&#34;Content-Type&#34;</span><span class="op" id="5617373">,</span>&nbsp;<span class="string" id="5617375">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5617408">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617411">fmt</span><span class="op" id="5617414">.</span><span class="ident" id="5617415">Fprintf</span><span class="op" id="5617422">(</span><span class="ident" id="5617423">w</span><span class="op" id="5617424">,</span>&nbsp;<span class="string" id="5617426">&#34;{\n&#34;</span><span class="op" id="5617431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617434">first</span>&nbsp;<span class="op" id="5617440">:=</span>&nbsp;<span class="builtintype" id="5617443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617449">Do</span><span class="op" id="5617451">(</span><span class="keyword" id="5617452">func</span><span class="op" id="5617456">(</span><span class="ident" id="5617457">kv</span>&nbsp;<span class="ident" id="5617460">KeyValue</span><span class="op" id="5617468">)</span>&nbsp;<span class="op" id="5617470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617474">if</span>&nbsp;<span class="op" id="5617477">!</span><span class="ident" id="5617478">first</span>&nbsp;<span class="op" id="5617484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617489">fmt</span><span class="op" id="5617492">.</span><span class="ident" id="5617493">Fprintf</span><span class="op" id="5617500">(</span><span class="ident" id="5617501">w</span><span class="op" id="5617502">,</span>&nbsp;<span class="string" id="5617504">&#34;,\n&#34;</span><span class="op" id="5617509">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617517">first</span>&nbsp;<span class="op" id="5617523">=</span>&nbsp;<span class="builtintype" id="5617525">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617533">fmt</span><span class="op" id="5617536">.</span><span class="ident" id="5617537">Fprintf</span><span class="op" id="5617544">(</span><span class="ident" id="5617545">w</span><span class="op" id="5617546">,</span>&nbsp;<span class="string" id="5617548">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5617556">,</span>&nbsp;<span class="ident" id="5617558">kv</span><span class="op" id="5617560">.</span><span class="ident" id="5617561">Key</span><span class="op" id="5617564">,</span>&nbsp;<span class="ident" id="5617566">kv</span><span class="op" id="5617568">.</span><span class="ident" id="5617569">Value</span><span class="op" id="5617574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617577">}</span><span class="op" id="5617578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617581">fmt</span><span class="op" id="5617584">.</span><span class="ident" id="5617585">Fprintf</span><span class="op" id="5617592">(</span><span class="ident" id="5617593">w</span><span class="op" id="5617594">,</span>&nbsp;<span class="string" id="5617596">&#34;\n}\n&#34;</span><span class="op" id="5617603">)</span><br>
<span class="lineno">320</span><span class="op" id="5617605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617608">func</span>&nbsp;<span class="ident" id="5617613">cmdline</span><span class="op" id="5617620">(</span><span class="op" id="5617621">)</span>&nbsp;<span class="keyword" id="5617623">interface</span><span class="op" id="5617632">{</span><span class="op" id="5617633">}</span>&nbsp;<span class="op" id="5617635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617638">return</span>&nbsp;<span class="ident" id="5617645">os</span><span class="op" id="5617647">.</span><span class="ident" id="5617648">Args</span><br>
<span class="lineno"></span><span class="op" id="5617653">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5617656">func</span>&nbsp;<span class="ident" id="5617661">memstats</span><span class="op" id="5617669">(</span><span class="op" id="5617670">)</span>&nbsp;<span class="keyword" id="5617672">interface</span><span class="op" id="5617681">{</span><span class="op" id="5617682">}</span>&nbsp;<span class="op" id="5617684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617687">stats</span>&nbsp;<span class="op" id="5617693">:=</span>&nbsp;<span class="builtinfunc" id="5617696">new</span><span class="op" id="5617699">(</span><span class="ident" id="5617700">runtime</span><span class="op" id="5617707">.</span><span class="ident" id="5617708">MemStats</span><span class="op" id="5617716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617719">runtime</span><span class="op" id="5617726">.</span><span class="ident" id="5617727">ReadMemStats</span><span class="op" id="5617739">(</span><span class="ident" id="5617740">stats</span><span class="op" id="5617745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617748">return</span>&nbsp;<span class="op" id="5617755">*</span><span class="ident" id="5617756">stats</span><br>
<span class="lineno">330</span><span class="op" id="5617762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617765">func</span>&nbsp;<span class="ident" id="5617770">init</span><span class="op" id="5617774">(</span><span class="op" id="5617775">)</span>&nbsp;<span class="op" id="5617777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617780">http</span><span class="op" id="5617784">.</span><span class="ident" id="5617785">HandleFunc</span><span class="op" id="5617795">(</span><span class="string" id="5617796">&#34;/debug/vars&#34;</span><span class="op" id="5617809">,</span>&nbsp;<span class="ident" id="5617811">expvarHandler</span><span class="op" id="5617824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617827">Publish</span><span class="op" id="5617834">(</span><span class="string" id="5617835">&#34;cmdline&#34;</span><span class="op" id="5617844">,</span>&nbsp;<span class="ident" id="5617846">Func</span><span class="op" id="5617850">(</span><span class="ident" id="5617851">cmdline</span><span class="op" id="5617858">)</span><span class="op" id="5617859">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617862">Publish</span><span class="op" id="5617869">(</span><span class="string" id="5617870">&#34;memstats&#34;</span><span class="op" id="5617880">,</span>&nbsp;<span class="ident" id="5617882">Func</span><span class="op" id="5617886">(</span><span class="ident" id="5617887">memstats</span><span class="op" id="5617895">)</span><span class="op" id="5617896">)</span><br>
<span class="lineno"></span><span class="op" id="5617898">}</span>
</div>
</body>
</html>
