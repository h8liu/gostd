<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5601333">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5601388">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5601442">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5601493">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5601553">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5601566">package</span>&nbsp;<span class="ident" id="5601574">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5601579">import</span>&nbsp;<span class="op" id="5601586">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601589">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601598">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601612">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601622">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601629">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601635">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601648">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601655">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601667">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601678">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601684">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5601695">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5601705">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5601708">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5601774">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5601836">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5601877">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5601937">func</span>&nbsp;<span class="ident" id="5601942">Request</span><span class="op" id="5601949">(</span><span class="op" id="5601950">)</span>&nbsp;<span class="op" id="5601952">(</span><span class="op" id="5601953">*</span><span class="ident" id="5601954">http</span><span class="op" id="5601958">.</span><span class="ident" id="5601959">Request</span><span class="op" id="5601966">,</span>&nbsp;<span class="builtintype" id="5601968">error</span><span class="op" id="5601973">)</span>&nbsp;<span class="op" id="5601975">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5601978">r</span><span class="op" id="5601979">,</span>&nbsp;<span class="ident" id="5601981">err</span>&nbsp;<span class="op" id="5601985">:=</span>&nbsp;<span class="ident" id="5601988">RequestFromMap</span><span class="op" id="5602002">(</span><span class="ident" id="5602003">envMap</span><span class="op" id="5602009">(</span><span class="ident" id="5602010">os</span><span class="op" id="5602012">.</span><span class="ident" id="5602013">Environ</span><span class="op" id="5602020">(</span><span class="op" id="5602021">)</span><span class="op" id="5602022">)</span><span class="op" id="5602023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602026">if</span>&nbsp;<span class="ident" id="5602029">err</span>&nbsp;<span class="op" id="5602033">!=</span>&nbsp;<span class="builtintype" id="5602036">nil</span>&nbsp;<span class="op" id="5602040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602044">return</span>&nbsp;<span class="builtintype" id="5602051">nil</span><span class="op" id="5602054">,</span>&nbsp;<span class="ident" id="5602056">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602064">if</span>&nbsp;<span class="ident" id="5602067">r</span><span class="op" id="5602068">.</span><span class="ident" id="5602069">ContentLength</span>&nbsp;<span class="op" id="5602083">&gt;</span>&nbsp;<span class="num" id="5602085">0</span>&nbsp;<span class="op" id="5602087">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602091">r</span><span class="op" id="5602092">.</span><span class="ident" id="5602093">Body</span>&nbsp;<span class="op" id="5602098">=</span>&nbsp;<span class="ident" id="5602100">ioutil</span><span class="op" id="5602106">.</span><span class="ident" id="5602107">NopCloser</span><span class="op" id="5602116">(</span><span class="ident" id="5602117">io</span><span class="op" id="5602119">.</span><span class="ident" id="5602120">LimitReader</span><span class="op" id="5602131">(</span><span class="ident" id="5602132">os</span><span class="op" id="5602134">.</span><span class="ident" id="5602135">Stdin</span><span class="op" id="5602140">,</span>&nbsp;<span class="ident" id="5602142">r</span><span class="op" id="5602143">.</span><span class="ident" id="5602144">ContentLength</span><span class="op" id="5602157">)</span><span class="op" id="5602158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602164">return</span>&nbsp;<span class="ident" id="5602171">r</span><span class="op" id="5602172">,</span>&nbsp;<span class="builtintype" id="5602174">nil</span><br>
<span class="lineno"></span><span class="op" id="5602178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5602181">func</span>&nbsp;<span class="ident" id="5602186">envMap</span><span class="op" id="5602192">(</span><span class="ident" id="5602193">env</span>&nbsp;<span class="op" id="5602197">[</span><span class="op" id="5602198">]</span><span class="builtintype" id="5602199">string</span><span class="op" id="5602205">)</span>&nbsp;<span class="keyword" id="5602207">map</span><span class="op" id="5602210">[</span><span class="builtintype" id="5602211">string</span><span class="op" id="5602217">]</span><span class="builtintype" id="5602218">string</span>&nbsp;<span class="op" id="5602225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602228">m</span>&nbsp;<span class="op" id="5602230">:=</span>&nbsp;<span class="builtinfunc" id="5602233">make</span><span class="op" id="5602237">(</span><span class="keyword" id="5602238">map</span><span class="op" id="5602241">[</span><span class="builtintype" id="5602242">string</span><span class="op" id="5602248">]</span><span class="builtintype" id="5602249">string</span><span class="op" id="5602255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602258">for</span>&nbsp;<span class="ident" id="5602262">_</span><span class="op" id="5602263">,</span>&nbsp;<span class="ident" id="5602265">kv</span>&nbsp;<span class="op" id="5602268">:=</span>&nbsp;<span class="keyword" id="5602271">range</span>&nbsp;<span class="ident" id="5602277">env</span>&nbsp;<span class="op" id="5602281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602285">if</span>&nbsp;<span class="ident" id="5602288">idx</span>&nbsp;<span class="op" id="5602292">:=</span>&nbsp;<span class="ident" id="5602295">strings</span><span class="op" id="5602302">.</span><span class="ident" id="5602303">Index</span><span class="op" id="5602308">(</span><span class="ident" id="5602309">kv</span><span class="op" id="5602311">,</span>&nbsp;<span class="string" id="5602313">&#34;=&#34;</span><span class="op" id="5602316">)</span><span class="op" id="5602317">;</span>&nbsp;<span class="ident" id="5602319">idx</span>&nbsp;<span class="op" id="5602323">!=</span>&nbsp;<span class="op" id="5602326">-</span><span class="num" id="5602327">1</span>&nbsp;<span class="op" id="5602329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602334">m</span><span class="op" id="5602335">[</span><span class="ident" id="5602336">kv</span><span class="op" id="5602338">[</span><span class="op" id="5602339">:</span><span class="ident" id="5602340">idx</span><span class="op" id="5602343">]</span><span class="op" id="5602344">]</span>&nbsp;<span class="op" id="5602346">=</span>&nbsp;<span class="ident" id="5602348">kv</span><span class="op" id="5602350">[</span><span class="ident" id="5602351">idx</span><span class="op" id="5602354">+</span><span class="num" id="5602355">1</span><span class="op" id="5602356">:</span><span class="op" id="5602357">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602367">return</span>&nbsp;<span class="ident" id="5602374">m</span><br>
<span class="lineno"></span><span class="op" id="5602376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5602379">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5602441">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5602496">func</span>&nbsp;<span class="ident" id="5602501">RequestFromMap</span><span class="op" id="5602515">(</span><span class="ident" id="5602516">params</span>&nbsp;<span class="keyword" id="5602523">map</span><span class="op" id="5602526">[</span><span class="builtintype" id="5602527">string</span><span class="op" id="5602533">]</span><span class="builtintype" id="5602534">string</span><span class="op" id="5602540">)</span>&nbsp;<span class="op" id="5602542">(</span><span class="op" id="5602543">*</span><span class="ident" id="5602544">http</span><span class="op" id="5602548">.</span><span class="ident" id="5602549">Request</span><span class="op" id="5602556">,</span>&nbsp;<span class="builtintype" id="5602558">error</span><span class="op" id="5602563">)</span>&nbsp;<span class="op" id="5602565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602568">r</span>&nbsp;<span class="op" id="5602570">:=</span>&nbsp;<span class="builtinfunc" id="5602573">new</span><span class="op" id="5602576">(</span><span class="ident" id="5602577">http</span><span class="op" id="5602581">.</span><span class="ident" id="5602582">Request</span><span class="op" id="5602589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602592">r</span><span class="op" id="5602593">.</span><span class="ident" id="5602594">Method</span>&nbsp;<span class="op" id="5602601">=</span>&nbsp;<span class="ident" id="5602603">params</span><span class="op" id="5602609">[</span><span class="string" id="5602610">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5602626">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602629">if</span>&nbsp;<span class="ident" id="5602632">r</span><span class="op" id="5602633">.</span><span class="ident" id="5602634">Method</span>&nbsp;<span class="op" id="5602641">==</span>&nbsp;<span class="string" id="5602644">&#34;&#34;</span>&nbsp;<span class="op" id="5602647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602651">return</span>&nbsp;<span class="builtintype" id="5602658">nil</span><span class="op" id="5602661">,</span>&nbsp;<span class="ident" id="5602663">errors</span><span class="op" id="5602669">.</span><span class="ident" id="5602670">New</span><span class="op" id="5602673">(</span><span class="string" id="5602674">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5602713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602720">r</span><span class="op" id="5602721">.</span><span class="ident" id="5602722">Proto</span>&nbsp;<span class="op" id="5602728">=</span>&nbsp;<span class="ident" id="5602730">params</span><span class="op" id="5602736">[</span><span class="string" id="5602737">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5602754">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602757">var</span>&nbsp;<span class="ident" id="5602761">ok</span>&nbsp;<span class="builtintype" id="5602764">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602770">r</span><span class="op" id="5602771">.</span><span class="ident" id="5602772">ProtoMajor</span><span class="op" id="5602782">,</span>&nbsp;<span class="ident" id="5602784">r</span><span class="op" id="5602785">.</span><span class="ident" id="5602786">ProtoMinor</span><span class="op" id="5602796">,</span>&nbsp;<span class="ident" id="5602798">ok</span>&nbsp;<span class="op" id="5602801">=</span>&nbsp;<span class="ident" id="5602803">http</span><span class="op" id="5602807">.</span><span class="ident" id="5602808">ParseHTTPVersion</span><span class="op" id="5602824">(</span><span class="ident" id="5602825">r</span><span class="op" id="5602826">.</span><span class="ident" id="5602827">Proto</span><span class="op" id="5602832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602835">if</span>&nbsp;<span class="op" id="5602838">!</span><span class="ident" id="5602839">ok</span>&nbsp;<span class="op" id="5602842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5602846">return</span>&nbsp;<span class="builtintype" id="5602853">nil</span><span class="op" id="5602856">,</span>&nbsp;<span class="ident" id="5602858">errors</span><span class="op" id="5602864">.</span><span class="ident" id="5602865">New</span><span class="op" id="5602868">(</span><span class="string" id="5602869">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5602907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5602910">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602914">r</span><span class="op" id="5602915">.</span><span class="ident" id="5602916">Close</span>&nbsp;<span class="op" id="5602922">=</span>&nbsp;<span class="builtintype" id="5602924">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602930">r</span><span class="op" id="5602931">.</span><span class="ident" id="5602932">Trailer</span>&nbsp;<span class="op" id="5602940">=</span>&nbsp;<span class="ident" id="5602942">http</span><span class="op" id="5602946">.</span><span class="ident" id="5602947">Header</span><span class="op" id="5602953">{</span><span class="op" id="5602954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602957">r</span><span class="op" id="5602958">.</span><span class="ident" id="5602959">Header</span>&nbsp;<span class="op" id="5602966">=</span>&nbsp;<span class="ident" id="5602968">http</span><span class="op" id="5602972">.</span><span class="ident" id="5602973">Header</span><span class="op" id="5602979">{</span><span class="op" id="5602980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5602984">r</span><span class="op" id="5602985">.</span><span class="ident" id="5602986">Host</span>&nbsp;<span class="op" id="5602991">=</span>&nbsp;<span class="ident" id="5602993">params</span><span class="op" id="5602999">[</span><span class="string" id="5603000">&#34;HTTP_HOST&#34;</span><span class="op" id="5603011">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603015">if</span>&nbsp;<span class="ident" id="5603018">lenstr</span>&nbsp;<span class="op" id="5603025">:=</span>&nbsp;<span class="ident" id="5603028">params</span><span class="op" id="5603034">[</span><span class="string" id="5603035">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5603051">]</span><span class="op" id="5603052">;</span>&nbsp;<span class="ident" id="5603054">lenstr</span>&nbsp;<span class="op" id="5603061">!=</span>&nbsp;<span class="string" id="5603064">&#34;&#34;</span>&nbsp;<span class="op" id="5603067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603071">clen</span><span class="op" id="5603075">,</span>&nbsp;<span class="ident" id="5603077">err</span>&nbsp;<span class="op" id="5603081">:=</span>&nbsp;<span class="ident" id="5603084">strconv</span><span class="op" id="5603091">.</span><span class="ident" id="5603092">ParseInt</span><span class="op" id="5603100">(</span><span class="ident" id="5603101">lenstr</span><span class="op" id="5603107">,</span>&nbsp;<span class="num" id="5603109">10</span><span class="op" id="5603111">,</span>&nbsp;<span class="num" id="5603113">64</span><span class="op" id="5603115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603119">if</span>&nbsp;<span class="ident" id="5603122">err</span>&nbsp;<span class="op" id="5603126">!=</span>&nbsp;<span class="builtintype" id="5603129">nil</span>&nbsp;<span class="op" id="5603133">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603138">return</span>&nbsp;<span class="builtintype" id="5603145">nil</span><span class="op" id="5603148">,</span>&nbsp;<span class="ident" id="5603150">errors</span><span class="op" id="5603156">.</span><span class="ident" id="5603157">New</span><span class="op" id="5603160">(</span><span class="string" id="5603161">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5603204">+</span>&nbsp;<span class="ident" id="5603206">lenstr</span><span class="op" id="5603212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603220">r</span><span class="op" id="5603221">.</span><span class="ident" id="5603222">ContentLength</span>&nbsp;<span class="op" id="5603236">=</span>&nbsp;<span class="ident" id="5603238">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603248">if</span>&nbsp;<span class="ident" id="5603251">ct</span>&nbsp;<span class="op" id="5603254">:=</span>&nbsp;<span class="ident" id="5603257">params</span><span class="op" id="5603263">[</span><span class="string" id="5603264">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5603278">]</span><span class="op" id="5603279">;</span>&nbsp;<span class="ident" id="5603281">ct</span>&nbsp;<span class="op" id="5603284">!=</span>&nbsp;<span class="string" id="5603287">&#34;&#34;</span>&nbsp;<span class="op" id="5603290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603294">r</span><span class="op" id="5603295">.</span><span class="ident" id="5603296">Header</span><span class="op" id="5603302">.</span><span class="ident" id="5603303">Set</span><span class="op" id="5603306">(</span><span class="string" id="5603307">&#34;Content-Type&#34;</span><span class="op" id="5603321">,</span>&nbsp;<span class="ident" id="5603323">ct</span><span class="op" id="5603325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5603332">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603387">for</span>&nbsp;<span class="ident" id="5603391">k</span><span class="op" id="5603392">,</span>&nbsp;<span class="ident" id="5603394">v</span>&nbsp;<span class="op" id="5603396">:=</span>&nbsp;<span class="keyword" id="5603399">range</span>&nbsp;<span class="ident" id="5603405">params</span>&nbsp;<span class="op" id="5603412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603416">if</span>&nbsp;<span class="op" id="5603419">!</span><span class="ident" id="5603420">strings</span><span class="op" id="5603427">.</span><span class="ident" id="5603428">HasPrefix</span><span class="op" id="5603437">(</span><span class="ident" id="5603438">k</span><span class="op" id="5603439">,</span>&nbsp;<span class="string" id="5603441">&#34;HTTP_&#34;</span><span class="op" id="5603448">)</span>&nbsp;<span class="op" id="5603450">||</span>&nbsp;<span class="ident" id="5603453">k</span>&nbsp;<span class="op" id="5603455">==</span>&nbsp;<span class="string" id="5603458">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5603470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603475">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603490">r</span><span class="op" id="5603491">.</span><span class="ident" id="5603492">Header</span><span class="op" id="5603498">.</span><span class="ident" id="5603499">Add</span><span class="op" id="5603502">(</span><span class="ident" id="5603503">strings</span><span class="op" id="5603510">.</span><span class="ident" id="5603511">Replace</span><span class="op" id="5603518">(</span><span class="ident" id="5603519">k</span><span class="op" id="5603520">[</span><span class="num" id="5603521">5</span><span class="op" id="5603522">:</span><span class="op" id="5603523">]</span><span class="op" id="5603524">,</span>&nbsp;<span class="string" id="5603526">&#34;_&#34;</span><span class="op" id="5603529">,</span>&nbsp;<span class="string" id="5603531">&#34;-&#34;</span><span class="op" id="5603534">,</span>&nbsp;<span class="op" id="5603536">-</span><span class="num" id="5603537">1</span><span class="op" id="5603538">)</span><span class="op" id="5603539">,</span>&nbsp;<span class="ident" id="5603541">v</span><span class="op" id="5603542">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5603549">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603607">uriStr</span>&nbsp;<span class="op" id="5603614">:=</span>&nbsp;<span class="ident" id="5603617">params</span><span class="op" id="5603623">[</span><span class="string" id="5603624">&#34;REQUEST_URI&#34;</span><span class="op" id="5603637">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603640">if</span>&nbsp;<span class="ident" id="5603643">uriStr</span>&nbsp;<span class="op" id="5603650">==</span>&nbsp;<span class="string" id="5603653">&#34;&#34;</span>&nbsp;<span class="op" id="5603656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5603660">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603718">uriStr</span>&nbsp;<span class="op" id="5603725">=</span>&nbsp;<span class="ident" id="5603727">params</span><span class="op" id="5603733">[</span><span class="string" id="5603734">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5603747">]</span>&nbsp;<span class="op" id="5603749">+</span>&nbsp;<span class="ident" id="5603751">params</span><span class="op" id="5603757">[</span><span class="string" id="5603758">&#34;PATH_INFO&#34;</span><span class="op" id="5603769">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603773">s</span>&nbsp;<span class="op" id="5603775">:=</span>&nbsp;<span class="ident" id="5603778">params</span><span class="op" id="5603784">[</span><span class="string" id="5603785">&#34;QUERY_STRING&#34;</span><span class="op" id="5603799">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603803">if</span>&nbsp;<span class="ident" id="5603806">s</span>&nbsp;<span class="op" id="5603808">!=</span>&nbsp;<span class="string" id="5603811">&#34;&#34;</span>&nbsp;<span class="op" id="5603814">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5603819">uriStr</span>&nbsp;<span class="op" id="5603826">+=</span>&nbsp;<span class="string" id="5603829">&#34;?&#34;</span>&nbsp;<span class="op" id="5603833">+</span>&nbsp;<span class="ident" id="5603835">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5603842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5603846">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5603899">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5603966">if</span>&nbsp;<span class="ident" id="5603969">s</span>&nbsp;<span class="op" id="5603971">:=</span>&nbsp;<span class="ident" id="5603974">params</span><span class="op" id="5603980">[</span><span class="string" id="5603981">&#34;HTTPS&#34;</span><span class="op" id="5603988">]</span><span class="op" id="5603989">;</span>&nbsp;<span class="ident" id="5603991">s</span>&nbsp;<span class="op" id="5603993">==</span>&nbsp;<span class="string" id="5603996">&#34;on&#34;</span>&nbsp;<span class="op" id="5604001">||</span>&nbsp;<span class="ident" id="5604004">s</span>&nbsp;<span class="op" id="5604006">==</span>&nbsp;<span class="string" id="5604009">&#34;ON&#34;</span>&nbsp;<span class="op" id="5604014">||</span>&nbsp;<span class="ident" id="5604017">s</span>&nbsp;<span class="op" id="5604019">==</span>&nbsp;<span class="string" id="5604022">&#34;1&#34;</span>&nbsp;<span class="op" id="5604026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604030">r</span><span class="op" id="5604031">.</span><span class="ident" id="5604032">TLS</span>&nbsp;<span class="op" id="5604036">=</span>&nbsp;<span class="op" id="5604038">&amp;</span><span class="ident" id="5604039">tls</span><span class="op" id="5604042">.</span><span class="ident" id="5604043">ConnectionState</span><span class="op" id="5604058">{</span><span class="ident" id="5604059">HandshakeComplete</span><span class="op" id="5604076">:</span>&nbsp;<span class="builtintype" id="5604078">true</span><span class="op" id="5604082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604089">if</span>&nbsp;<span class="ident" id="5604092">r</span><span class="op" id="5604093">.</span><span class="ident" id="5604094">Host</span>&nbsp;<span class="op" id="5604099">!=</span>&nbsp;<span class="string" id="5604102">&#34;&#34;</span>&nbsp;<span class="op" id="5604105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604109">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604174">rawurl</span>&nbsp;<span class="op" id="5604181">:=</span>&nbsp;<span class="ident" id="5604184">r</span><span class="op" id="5604185">.</span><span class="ident" id="5604186">Host</span>&nbsp;<span class="op" id="5604191">+</span>&nbsp;<span class="ident" id="5604193">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604202">if</span>&nbsp;<span class="ident" id="5604205">r</span><span class="op" id="5604206">.</span><span class="ident" id="5604207">TLS</span>&nbsp;<span class="op" id="5604211">==</span>&nbsp;<span class="builtintype" id="5604214">nil</span>&nbsp;<span class="op" id="5604218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604223">rawurl</span>&nbsp;<span class="op" id="5604230">=</span>&nbsp;<span class="string" id="5604232">&#34;http://&#34;</span>&nbsp;<span class="op" id="5604242">+</span>&nbsp;<span class="ident" id="5604244">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604253">}</span>&nbsp;<span class="keyword" id="5604255">else</span>&nbsp;<span class="op" id="5604260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604265">rawurl</span>&nbsp;<span class="op" id="5604272">=</span>&nbsp;<span class="string" id="5604274">&#34;https://&#34;</span>&nbsp;<span class="op" id="5604285">+</span>&nbsp;<span class="ident" id="5604287">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604300">url</span><span class="op" id="5604303">,</span>&nbsp;<span class="ident" id="5604305">err</span>&nbsp;<span class="op" id="5604309">:=</span>&nbsp;<span class="ident" id="5604312">url</span><span class="op" id="5604315">.</span><span class="ident" id="5604316">Parse</span><span class="op" id="5604321">(</span><span class="ident" id="5604322">rawurl</span><span class="op" id="5604328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604332">if</span>&nbsp;<span class="ident" id="5604335">err</span>&nbsp;<span class="op" id="5604339">!=</span>&nbsp;<span class="builtintype" id="5604342">nil</span>&nbsp;<span class="op" id="5604346">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604351">return</span>&nbsp;<span class="builtintype" id="5604358">nil</span><span class="op" id="5604361">,</span>&nbsp;<span class="ident" id="5604363">errors</span><span class="op" id="5604369">.</span><span class="ident" id="5604370">New</span><span class="op" id="5604373">(</span><span class="string" id="5604374">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5604431">+</span>&nbsp;<span class="ident" id="5604433">rawurl</span><span class="op" id="5604439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604447">r</span><span class="op" id="5604448">.</span><span class="ident" id="5604449">URL</span>&nbsp;<span class="op" id="5604453">=</span>&nbsp;<span class="ident" id="5604455">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604463">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604524">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604544">if</span>&nbsp;<span class="ident" id="5604547">r</span><span class="op" id="5604548">.</span><span class="ident" id="5604549">URL</span>&nbsp;<span class="op" id="5604553">==</span>&nbsp;<span class="builtintype" id="5604556">nil</span>&nbsp;<span class="op" id="5604560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604564">url</span><span class="op" id="5604567">,</span>&nbsp;<span class="ident" id="5604569">err</span>&nbsp;<span class="op" id="5604573">:=</span>&nbsp;<span class="ident" id="5604576">url</span><span class="op" id="5604579">.</span><span class="ident" id="5604580">Parse</span><span class="op" id="5604585">(</span><span class="ident" id="5604586">uriStr</span><span class="op" id="5604592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604596">if</span>&nbsp;<span class="ident" id="5604599">err</span>&nbsp;<span class="op" id="5604603">!=</span>&nbsp;<span class="builtintype" id="5604606">nil</span>&nbsp;<span class="op" id="5604610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604615">return</span>&nbsp;<span class="builtintype" id="5604622">nil</span><span class="op" id="5604625">,</span>&nbsp;<span class="ident" id="5604627">errors</span><span class="op" id="5604633">.</span><span class="ident" id="5604634">New</span><span class="op" id="5604637">(</span><span class="string" id="5604638">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5604686">+</span>&nbsp;<span class="ident" id="5604688">uriStr</span><span class="op" id="5604694">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604702">r</span><span class="op" id="5604703">.</span><span class="ident" id="5604704">URL</span>&nbsp;<span class="op" id="5604708">=</span>&nbsp;<span class="ident" id="5604710">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5604715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604719">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604781">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5604845">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5604866">r</span><span class="op" id="5604867">.</span><span class="ident" id="5604868">RemoteAddr</span>&nbsp;<span class="op" id="5604879">=</span>&nbsp;<span class="ident" id="5604881">net</span><span class="op" id="5604884">.</span><span class="ident" id="5604885">JoinHostPort</span><span class="op" id="5604897">(</span><span class="ident" id="5604898">params</span><span class="op" id="5604904">[</span><span class="string" id="5604905">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5604918">]</span><span class="op" id="5604919">,</span>&nbsp;<span class="string" id="5604921">&#34;0&#34;</span><span class="op" id="5604924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5604928">return</span>&nbsp;<span class="ident" id="5604935">r</span><span class="op" id="5604936">,</span>&nbsp;<span class="builtintype" id="5604938">nil</span><br>
<span class="lineno">140</span><span class="op" id="5604942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5604945">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5605012">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5605070">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5605134">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5605159">func</span>&nbsp;<span class="ident" id="5605164">Serve</span><span class="op" id="5605169">(</span><span class="ident" id="5605170">handler</span>&nbsp;<span class="ident" id="5605178">http</span><span class="op" id="5605182">.</span><span class="ident" id="5605183">Handler</span><span class="op" id="5605190">)</span>&nbsp;<span class="builtintype" id="5605192">error</span>&nbsp;<span class="op" id="5605198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605201">req</span><span class="op" id="5605204">,</span>&nbsp;<span class="ident" id="5605206">err</span>&nbsp;<span class="op" id="5605210">:=</span>&nbsp;<span class="ident" id="5605213">Request</span><span class="op" id="5605220">(</span><span class="op" id="5605221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605224">if</span>&nbsp;<span class="ident" id="5605227">err</span>&nbsp;<span class="op" id="5605231">!=</span>&nbsp;<span class="builtintype" id="5605234">nil</span>&nbsp;<span class="op" id="5605238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605242">return</span>&nbsp;<span class="ident" id="5605249">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605257">if</span>&nbsp;<span class="ident" id="5605260">handler</span>&nbsp;<span class="op" id="5605268">==</span>&nbsp;<span class="builtintype" id="5605271">nil</span>&nbsp;<span class="op" id="5605275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605279">handler</span>&nbsp;<span class="op" id="5605287">=</span>&nbsp;<span class="ident" id="5605289">http</span><span class="op" id="5605293">.</span><span class="ident" id="5605294">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605314">rw</span>&nbsp;<span class="op" id="5605317">:=</span>&nbsp;<span class="op" id="5605320">&amp;</span><span class="ident" id="5605321">response</span><span class="op" id="5605329">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605333">req</span><span class="op" id="5605336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605341">req</span><span class="op" id="5605344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605348">header</span><span class="op" id="5605354">:</span>&nbsp;<span class="builtinfunc" id="5605356">make</span><span class="op" id="5605360">(</span><span class="ident" id="5605361">http</span><span class="op" id="5605365">.</span><span class="ident" id="5605366">Header</span><span class="op" id="5605372">)</span><span class="op" id="5605373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605377">bufw</span><span class="op" id="5605381">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5605385">bufio</span><span class="op" id="5605390">.</span><span class="ident" id="5605391">NewWriter</span><span class="op" id="5605400">(</span><span class="ident" id="5605401">os</span><span class="op" id="5605403">.</span><span class="ident" id="5605404">Stdout</span><span class="op" id="5605410">)</span><span class="op" id="5605411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605417">handler</span><span class="op" id="5605424">.</span><span class="ident" id="5605425">ServeHTTP</span><span class="op" id="5605434">(</span><span class="ident" id="5605435">rw</span><span class="op" id="5605437">,</span>&nbsp;<span class="ident" id="5605439">req</span><span class="op" id="5605442">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605445">rw</span><span class="op" id="5605447">.</span><span class="ident" id="5605448">Write</span><span class="op" id="5605453">(</span><span class="builtintype" id="5605454">nil</span><span class="op" id="5605457">)</span>&nbsp;<span class="comment" id="5605459">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605492">if</span>&nbsp;<span class="ident" id="5605495">err</span>&nbsp;<span class="op" id="5605499">=</span>&nbsp;<span class="ident" id="5605501">rw</span><span class="op" id="5605503">.</span><span class="ident" id="5605504">bufw</span><span class="op" id="5605508">.</span><span class="ident" id="5605509">Flush</span><span class="op" id="5605514">(</span><span class="op" id="5605515">)</span><span class="op" id="5605516">;</span>&nbsp;<span class="ident" id="5605518">err</span>&nbsp;<span class="op" id="5605522">!=</span>&nbsp;<span class="builtintype" id="5605525">nil</span>&nbsp;<span class="op" id="5605529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605533">return</span>&nbsp;<span class="ident" id="5605540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605548">return</span>&nbsp;<span class="builtintype" id="5605555">nil</span><br>
<span class="lineno">165</span><span class="op" id="5605559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605562">type</span>&nbsp;<span class="ident" id="5605567">response</span>&nbsp;<span class="keyword" id="5605576">struct</span>&nbsp;<span class="op" id="5605583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605586">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605597">*</span><span class="ident" id="5605598">http</span><span class="op" id="5605602">.</span><span class="ident" id="5605603">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605612">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605623">http</span><span class="op" id="5605627">.</span><span class="ident" id="5605628">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605636">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605647">*</span><span class="ident" id="5605648">bufio</span><span class="op" id="5605653">.</span><span class="ident" id="5605654">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605662">headerSent</span>&nbsp;<span class="builtintype" id="5605673">bool</span><br>
<span class="lineno"></span><span class="op" id="5605678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605681">func</span>&nbsp;<span class="op" id="5605686">(</span><span class="ident" id="5605687">r</span>&nbsp;<span class="op" id="5605689">*</span><span class="ident" id="5605690">response</span><span class="op" id="5605698">)</span>&nbsp;<span class="ident" id="5605700">Flush</span><span class="op" id="5605705">(</span><span class="op" id="5605706">)</span>&nbsp;<span class="op" id="5605708">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605711">r</span><span class="op" id="5605712">.</span><span class="ident" id="5605713">bufw</span><span class="op" id="5605717">.</span><span class="ident" id="5605718">Flush</span><span class="op" id="5605723">(</span><span class="op" id="5605724">)</span><br>
<span class="lineno"></span><span class="op" id="5605726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605729">func</span>&nbsp;<span class="op" id="5605734">(</span><span class="ident" id="5605735">r</span>&nbsp;<span class="op" id="5605737">*</span><span class="ident" id="5605738">response</span><span class="op" id="5605746">)</span>&nbsp;<span class="ident" id="5605748">Header</span><span class="op" id="5605754">(</span><span class="op" id="5605755">)</span>&nbsp;<span class="ident" id="5605757">http</span><span class="op" id="5605761">.</span><span class="ident" id="5605762">Header</span>&nbsp;<span class="op" id="5605769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605772">return</span>&nbsp;<span class="ident" id="5605779">r</span><span class="op" id="5605780">.</span><span class="ident" id="5605781">header</span><br>
<span class="lineno">180</span><span class="op" id="5605788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605791">func</span>&nbsp;<span class="op" id="5605796">(</span><span class="ident" id="5605797">r</span>&nbsp;<span class="op" id="5605799">*</span><span class="ident" id="5605800">response</span><span class="op" id="5605808">)</span>&nbsp;<span class="ident" id="5605810">Write</span><span class="op" id="5605815">(</span><span class="ident" id="5605816">p</span>&nbsp;<span class="op" id="5605818">[</span><span class="op" id="5605819">]</span><span class="builtintype" id="5605820">byte</span><span class="op" id="5605824">)</span>&nbsp;<span class="op" id="5605826">(</span><span class="ident" id="5605827">n</span>&nbsp;<span class="builtintype" id="5605829">int</span><span class="op" id="5605832">,</span>&nbsp;<span class="ident" id="5605834">err</span>&nbsp;<span class="builtintype" id="5605838">error</span><span class="op" id="5605843">)</span>&nbsp;<span class="op" id="5605845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605848">if</span>&nbsp;<span class="op" id="5605851">!</span><span class="ident" id="5605852">r</span><span class="op" id="5605853">.</span><span class="ident" id="5605854">headerSent</span>&nbsp;<span class="op" id="5605865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5605869">r</span><span class="op" id="5605870">.</span><span class="ident" id="5605871">WriteHeader</span><span class="op" id="5605882">(</span><span class="ident" id="5605883">http</span><span class="op" id="5605887">.</span><span class="ident" id="5605888">StatusOK</span><span class="op" id="5605896">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5605899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605902">return</span>&nbsp;<span class="ident" id="5605909">r</span><span class="op" id="5605910">.</span><span class="ident" id="5605911">bufw</span><span class="op" id="5605915">.</span><span class="ident" id="5605916">Write</span><span class="op" id="5605921">(</span><span class="ident" id="5605922">p</span><span class="op" id="5605923">)</span><br>
<span class="lineno"></span><span class="op" id="5605925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5605928">func</span>&nbsp;<span class="op" id="5605933">(</span><span class="ident" id="5605934">r</span>&nbsp;<span class="op" id="5605936">*</span><span class="ident" id="5605937">response</span><span class="op" id="5605945">)</span>&nbsp;<span class="ident" id="5605947">WriteHeader</span><span class="op" id="5605958">(</span><span class="ident" id="5605959">code</span>&nbsp;<span class="builtintype" id="5605964">int</span><span class="op" id="5605967">)</span>&nbsp;<span class="op" id="5605969">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5605972">if</span>&nbsp;<span class="ident" id="5605975">r</span><span class="op" id="5605976">.</span><span class="ident" id="5605977">headerSent</span>&nbsp;<span class="op" id="5605988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5605992">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606058">fmt</span><span class="op" id="5606061">.</span><span class="ident" id="5606062">Fprintf</span><span class="op" id="5606069">(</span><span class="ident" id="5606070">os</span><span class="op" id="5606072">.</span><span class="ident" id="5606073">Stderr</span><span class="op" id="5606079">,</span>&nbsp;<span class="string" id="5606081">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5606136">,</span>&nbsp;<span class="ident" id="5606138">r</span><span class="op" id="5606139">.</span><span class="ident" id="5606140">req</span><span class="op" id="5606143">.</span><span class="ident" id="5606144">URL</span><span class="op" id="5606147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5606151">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5606159">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606162">r</span><span class="op" id="5606163">.</span><span class="ident" id="5606164">headerSent</span>&nbsp;<span class="op" id="5606175">=</span>&nbsp;<span class="builtintype" id="5606177">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606183">fmt</span><span class="op" id="5606186">.</span><span class="ident" id="5606187">Fprintf</span><span class="op" id="5606194">(</span><span class="ident" id="5606195">r</span><span class="op" id="5606196">.</span><span class="ident" id="5606197">bufw</span><span class="op" id="5606201">,</span>&nbsp;<span class="string" id="5606203">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5606222">,</span>&nbsp;<span class="ident" id="5606224">code</span><span class="op" id="5606228">,</span>&nbsp;<span class="ident" id="5606230">http</span><span class="op" id="5606234">.</span><span class="ident" id="5606235">StatusText</span><span class="op" id="5606245">(</span><span class="ident" id="5606246">code</span><span class="op" id="5606250">)</span><span class="op" id="5606251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5606255">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5606286">if</span>&nbsp;<span class="ident" id="5606289">_</span><span class="op" id="5606290">,</span>&nbsp;<span class="ident" id="5606292">hasType</span>&nbsp;<span class="op" id="5606300">:=</span>&nbsp;<span class="ident" id="5606303">r</span><span class="op" id="5606304">.</span><span class="ident" id="5606305">header</span><span class="op" id="5606311">[</span><span class="string" id="5606312">&#34;Content-Type&#34;</span><span class="op" id="5606326">]</span><span class="op" id="5606327">;</span>&nbsp;<span class="op" id="5606329">!</span><span class="ident" id="5606330">hasType</span>&nbsp;<span class="op" id="5606338">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606342">r</span><span class="op" id="5606343">.</span><span class="ident" id="5606344">header</span><span class="op" id="5606350">.</span><span class="ident" id="5606351">Add</span><span class="op" id="5606354">(</span><span class="string" id="5606355">&#34;Content-Type&#34;</span><span class="op" id="5606369">,</span>&nbsp;<span class="string" id="5606371">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5606397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5606400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606404">r</span><span class="op" id="5606405">.</span><span class="ident" id="5606406">header</span><span class="op" id="5606412">.</span><span class="ident" id="5606413">Write</span><span class="op" id="5606418">(</span><span class="ident" id="5606419">r</span><span class="op" id="5606420">.</span><span class="ident" id="5606421">bufw</span><span class="op" id="5606425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606428">r</span><span class="op" id="5606429">.</span><span class="ident" id="5606430">bufw</span><span class="op" id="5606434">.</span><span class="ident" id="5606435">WriteString</span><span class="op" id="5606446">(</span><span class="string" id="5606447">&#34;\r\n&#34;</span><span class="op" id="5606453">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5606456">r</span><span class="op" id="5606457">.</span><span class="ident" id="5606458">bufw</span><span class="op" id="5606462">.</span><span class="ident" id="5606463">Flush</span><span class="op" id="5606468">(</span><span class="op" id="5606469">)</span><br>
<span class="lineno"></span><span class="op" id="5606471">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
