<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2958869">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2958924">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2958978">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2959029">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2959094">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="2959123">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="2959171">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="2959185">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="2959246">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="2959275">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="2959335">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="2959359">package</span>&nbsp;<span class="ident" id="2959367">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2959372">import</span>&nbsp;<span class="op" id="2959379">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959382">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959392">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959398">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959411">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959417">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2959425">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="2959432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2959435">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="2959485">type</span>&nbsp;<span class="ident" id="2959490">dnsConn</span>&nbsp;<span class="keyword" id="2959498">interface</span>&nbsp;<span class="op" id="2959508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959511">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959518">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959580">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959641">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959654">readDNSResponse</span><span class="op" id="2959669">(</span><span class="op" id="2959670">)</span>&nbsp;<span class="op" id="2959672">(</span><span class="op" id="2959673">*</span><span class="ident" id="2959674">dnsMsg</span><span class="op" id="2959680">,</span>&nbsp;<span class="builtintype" id="2959682">error</span><span class="op" id="2959687">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959691">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959747">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959772">writeDNSQuery</span><span class="op" id="2959785">(</span><span class="op" id="2959786">*</span><span class="ident" id="2959787">dnsMsg</span><span class="op" id="2959793">)</span>&nbsp;<span class="builtintype" id="2959795">error</span><br>
<span class="lineno"></span><span class="op" id="2959801">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="2959804">func</span>&nbsp;<span class="op" id="2959809">(</span><span class="ident" id="2959810">c</span>&nbsp;<span class="op" id="2959812">*</span><span class="ident" id="2959813">UDPConn</span><span class="op" id="2959820">)</span>&nbsp;<span class="ident" id="2959822">readDNSResponse</span><span class="op" id="2959837">(</span><span class="op" id="2959838">)</span>&nbsp;<span class="op" id="2959840">(</span><span class="op" id="2959841">*</span><span class="ident" id="2959842">dnsMsg</span><span class="op" id="2959848">,</span>&nbsp;<span class="builtintype" id="2959850">error</span><span class="op" id="2959855">)</span>&nbsp;<span class="op" id="2959857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959860">b</span>&nbsp;<span class="op" id="2959862">:=</span>&nbsp;<span class="builtinfunc" id="2959865">make</span><span class="op" id="2959869">(</span><span class="op" id="2959870">[</span><span class="op" id="2959871">]</span><span class="builtintype" id="2959872">byte</span><span class="op" id="2959876">,</span>&nbsp;<span class="num" id="2959878">512</span><span class="op" id="2959881">)</span>&nbsp;<span class="comment" id="2959883">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959900">n</span><span class="op" id="2959901">,</span>&nbsp;<span class="ident" id="2959903">err</span>&nbsp;<span class="op" id="2959907">:=</span>&nbsp;<span class="ident" id="2959910">c</span><span class="op" id="2959911">.</span><span class="ident" id="2959912">Read</span><span class="op" id="2959916">(</span><span class="ident" id="2959917">b</span><span class="op" id="2959918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959921">if</span>&nbsp;<span class="ident" id="2959924">err</span>&nbsp;<span class="op" id="2959928">!=</span>&nbsp;<span class="ident" id="2959931">nil</span>&nbsp;<span class="op" id="2959935">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959939">return</span>&nbsp;<span class="ident" id="2959946">nil</span><span class="op" id="2959949">,</span>&nbsp;<span class="ident" id="2959951">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2959956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959959">msg</span>&nbsp;<span class="op" id="2959963">:=</span>&nbsp;<span class="op" id="2959966">&amp;</span><span class="ident" id="2959967">dnsMsg</span><span class="op" id="2959973">{</span><span class="op" id="2959974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959977">if</span>&nbsp;<span class="op" id="2959980">!</span><span class="ident" id="2959981">msg</span><span class="op" id="2959984">.</span><span class="ident" id="2959985">Unpack</span><span class="op" id="2959991">(</span><span class="ident" id="2959992">b</span><span class="op" id="2959993">[</span><span class="op" id="2959994">:</span><span class="ident" id="2959995">n</span><span class="op" id="2959996">]</span><span class="op" id="2959997">)</span>&nbsp;<span class="op" id="2959999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960003">return</span>&nbsp;<span class="ident" id="2960010">nil</span><span class="op" id="2960013">,</span>&nbsp;<span class="ident" id="2960015">errors</span><span class="op" id="2960021">.</span><span class="ident" id="2960022">New</span><span class="op" id="2960025">(</span><span class="string" id="2960026">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="2960056">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960062">return</span>&nbsp;<span class="ident" id="2960069">msg</span><span class="op" id="2960072">,</span>&nbsp;<span class="ident" id="2960074">nil</span><br>
<span class="lineno"></span><span class="op" id="2960078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2960081">func</span>&nbsp;<span class="op" id="2960086">(</span><span class="ident" id="2960087">c</span>&nbsp;<span class="op" id="2960089">*</span><span class="ident" id="2960090">UDPConn</span><span class="op" id="2960097">)</span>&nbsp;<span class="ident" id="2960099">writeDNSQuery</span><span class="op" id="2960112">(</span><span class="ident" id="2960113">msg</span>&nbsp;<span class="op" id="2960117">*</span><span class="ident" id="2960118">dnsMsg</span><span class="op" id="2960124">)</span>&nbsp;<span class="builtintype" id="2960126">error</span>&nbsp;<span class="op" id="2960132">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960135">b</span><span class="op" id="2960136">,</span>&nbsp;<span class="ident" id="2960138">ok</span>&nbsp;<span class="op" id="2960141">:=</span>&nbsp;<span class="ident" id="2960144">msg</span><span class="op" id="2960147">.</span><span class="ident" id="2960148">Pack</span><span class="op" id="2960152">(</span><span class="op" id="2960153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960156">if</span>&nbsp;<span class="op" id="2960159">!</span><span class="ident" id="2960160">ok</span>&nbsp;<span class="op" id="2960163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960167">return</span>&nbsp;<span class="ident" id="2960174">errors</span><span class="op" id="2960180">.</span><span class="ident" id="2960181">New</span><span class="op" id="2960184">(</span><span class="string" id="2960185">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="2960213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960219">if</span>&nbsp;<span class="ident" id="2960222">_</span><span class="op" id="2960223">,</span>&nbsp;<span class="ident" id="2960225">err</span>&nbsp;<span class="op" id="2960229">:=</span>&nbsp;<span class="ident" id="2960232">c</span><span class="op" id="2960233">.</span><span class="ident" id="2960234">Write</span><span class="op" id="2960239">(</span><span class="ident" id="2960240">b</span><span class="op" id="2960241">)</span><span class="op" id="2960242">;</span>&nbsp;<span class="ident" id="2960244">err</span>&nbsp;<span class="op" id="2960248">!=</span>&nbsp;<span class="ident" id="2960251">nil</span>&nbsp;<span class="op" id="2960255">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960259">return</span>&nbsp;<span class="ident" id="2960266">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960274">return</span>&nbsp;<span class="ident" id="2960281">nil</span><br>
<span class="lineno"></span><span class="op" id="2960285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="2960288">func</span>&nbsp;<span class="op" id="2960293">(</span><span class="ident" id="2960294">c</span>&nbsp;<span class="op" id="2960296">*</span><span class="ident" id="2960297">TCPConn</span><span class="op" id="2960304">)</span>&nbsp;<span class="ident" id="2960306">readDNSResponse</span><span class="op" id="2960321">(</span><span class="op" id="2960322">)</span>&nbsp;<span class="op" id="2960324">(</span><span class="op" id="2960325">*</span><span class="ident" id="2960326">dnsMsg</span><span class="op" id="2960332">,</span>&nbsp;<span class="builtintype" id="2960334">error</span><span class="op" id="2960339">)</span>&nbsp;<span class="op" id="2960341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960344">b</span>&nbsp;<span class="op" id="2960346">:=</span>&nbsp;<span class="builtinfunc" id="2960349">make</span><span class="op" id="2960353">(</span><span class="op" id="2960354">[</span><span class="op" id="2960355">]</span><span class="builtintype" id="2960356">byte</span><span class="op" id="2960360">,</span>&nbsp;<span class="num" id="2960362">1280</span><span class="op" id="2960366">)</span>&nbsp;<span class="comment" id="2960368">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960441">if</span>&nbsp;<span class="ident" id="2960444">_</span><span class="op" id="2960445">,</span>&nbsp;<span class="ident" id="2960447">err</span>&nbsp;<span class="op" id="2960451">:=</span>&nbsp;<span class="ident" id="2960454">io</span><span class="op" id="2960456">.</span><span class="ident" id="2960457">ReadFull</span><span class="op" id="2960465">(</span><span class="ident" id="2960466">c</span><span class="op" id="2960467">,</span>&nbsp;<span class="ident" id="2960469">b</span><span class="op" id="2960470">[</span><span class="op" id="2960471">:</span><span class="num" id="2960472">2</span><span class="op" id="2960473">]</span><span class="op" id="2960474">)</span><span class="op" id="2960475">;</span>&nbsp;<span class="ident" id="2960477">err</span>&nbsp;<span class="op" id="2960481">!=</span>&nbsp;<span class="ident" id="2960484">nil</span>&nbsp;<span class="op" id="2960488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960492">return</span>&nbsp;<span class="ident" id="2960499">nil</span><span class="op" id="2960502">,</span>&nbsp;<span class="ident" id="2960504">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960509">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960512">l</span>&nbsp;<span class="op" id="2960514">:=</span>&nbsp;<span class="builtintype" id="2960517">int</span><span class="op" id="2960520">(</span><span class="ident" id="2960521">b</span><span class="op" id="2960522">[</span><span class="num" id="2960523">0</span><span class="op" id="2960524">]</span><span class="op" id="2960525">)</span><span class="op" id="2960526">&lt;&lt;</span><span class="num" id="2960528">8</span>&nbsp;<span class="op" id="2960530">|</span>&nbsp;<span class="builtintype" id="2960532">int</span><span class="op" id="2960535">(</span><span class="ident" id="2960536">b</span><span class="op" id="2960537">[</span><span class="num" id="2960538">1</span><span class="op" id="2960539">]</span><span class="op" id="2960540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960543">if</span>&nbsp;<span class="ident" id="2960546">l</span>&nbsp;<span class="op" id="2960548">&gt;</span>&nbsp;<span class="builtinfunc" id="2960550">len</span><span class="op" id="2960553">(</span><span class="ident" id="2960554">b</span><span class="op" id="2960555">)</span>&nbsp;<span class="op" id="2960557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960561">b</span>&nbsp;<span class="op" id="2960563">=</span>&nbsp;<span class="builtinfunc" id="2960565">make</span><span class="op" id="2960569">(</span><span class="op" id="2960570">[</span><span class="op" id="2960571">]</span><span class="builtintype" id="2960572">byte</span><span class="op" id="2960576">,</span>&nbsp;<span class="ident" id="2960578">l</span><span class="op" id="2960579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960585">n</span><span class="op" id="2960586">,</span>&nbsp;<span class="ident" id="2960588">err</span>&nbsp;<span class="op" id="2960592">:=</span>&nbsp;<span class="ident" id="2960595">io</span><span class="op" id="2960597">.</span><span class="ident" id="2960598">ReadFull</span><span class="op" id="2960606">(</span><span class="ident" id="2960607">c</span><span class="op" id="2960608">,</span>&nbsp;<span class="ident" id="2960610">b</span><span class="op" id="2960611">[</span><span class="op" id="2960612">:</span><span class="ident" id="2960613">l</span><span class="op" id="2960614">]</span><span class="op" id="2960615">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960618">if</span>&nbsp;<span class="ident" id="2960621">err</span>&nbsp;<span class="op" id="2960625">!=</span>&nbsp;<span class="ident" id="2960628">nil</span>&nbsp;<span class="op" id="2960632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960636">return</span>&nbsp;<span class="ident" id="2960643">nil</span><span class="op" id="2960646">,</span>&nbsp;<span class="ident" id="2960648">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960656">msg</span>&nbsp;<span class="op" id="2960660">:=</span>&nbsp;<span class="op" id="2960663">&amp;</span><span class="ident" id="2960664">dnsMsg</span><span class="op" id="2960670">{</span><span class="op" id="2960671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960674">if</span>&nbsp;<span class="op" id="2960677">!</span><span class="ident" id="2960678">msg</span><span class="op" id="2960681">.</span><span class="ident" id="2960682">Unpack</span><span class="op" id="2960688">(</span><span class="ident" id="2960689">b</span><span class="op" id="2960690">[</span><span class="op" id="2960691">:</span><span class="ident" id="2960692">n</span><span class="op" id="2960693">]</span><span class="op" id="2960694">)</span>&nbsp;<span class="op" id="2960696">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960700">return</span>&nbsp;<span class="ident" id="2960707">nil</span><span class="op" id="2960710">,</span>&nbsp;<span class="ident" id="2960712">errors</span><span class="op" id="2960718">.</span><span class="ident" id="2960719">New</span><span class="op" id="2960722">(</span><span class="string" id="2960723">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="2960753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960759">return</span>&nbsp;<span class="ident" id="2960766">msg</span><span class="op" id="2960769">,</span>&nbsp;<span class="ident" id="2960771">nil</span><br>
<span class="lineno"></span><span class="op" id="2960775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="2960778">func</span>&nbsp;<span class="op" id="2960783">(</span><span class="ident" id="2960784">c</span>&nbsp;<span class="op" id="2960786">*</span><span class="ident" id="2960787">TCPConn</span><span class="op" id="2960794">)</span>&nbsp;<span class="ident" id="2960796">writeDNSQuery</span><span class="op" id="2960809">(</span><span class="ident" id="2960810">msg</span>&nbsp;<span class="op" id="2960814">*</span><span class="ident" id="2960815">dnsMsg</span><span class="op" id="2960821">)</span>&nbsp;<span class="builtintype" id="2960823">error</span>&nbsp;<span class="op" id="2960829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960832">b</span><span class="op" id="2960833">,</span>&nbsp;<span class="ident" id="2960835">ok</span>&nbsp;<span class="op" id="2960838">:=</span>&nbsp;<span class="ident" id="2960841">msg</span><span class="op" id="2960844">.</span><span class="ident" id="2960845">Pack</span><span class="op" id="2960849">(</span><span class="op" id="2960850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960853">if</span>&nbsp;<span class="op" id="2960856">!</span><span class="ident" id="2960857">ok</span>&nbsp;<span class="op" id="2960860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960864">return</span>&nbsp;<span class="ident" id="2960871">errors</span><span class="op" id="2960877">.</span><span class="ident" id="2960878">New</span><span class="op" id="2960881">(</span><span class="string" id="2960882">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="2960910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960913">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960916">l</span>&nbsp;<span class="op" id="2960918">:=</span>&nbsp;<span class="builtintype" id="2960921">uint16</span><span class="op" id="2960927">(</span><span class="builtinfunc" id="2960928">len</span><span class="op" id="2960931">(</span><span class="ident" id="2960932">b</span><span class="op" id="2960933">)</span><span class="op" id="2960934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960937">b</span>&nbsp;<span class="op" id="2960939">=</span>&nbsp;<span class="builtinfunc" id="2960941">append</span><span class="op" id="2960947">(</span><span class="op" id="2960948">[</span><span class="op" id="2960949">]</span><span class="builtintype" id="2960950">byte</span><span class="op" id="2960954">{</span><span class="builtintype" id="2960955">byte</span><span class="op" id="2960959">(</span><span class="ident" id="2960960">l</span>&nbsp;<span class="op" id="2960962">&gt;&gt;</span>&nbsp;<span class="num" id="2960965">8</span><span class="op" id="2960966">)</span><span class="op" id="2960967">,</span>&nbsp;<span class="builtintype" id="2960969">byte</span><span class="op" id="2960973">(</span><span class="ident" id="2960974">l</span><span class="op" id="2960975">)</span><span class="op" id="2960976">}</span><span class="op" id="2960977">,</span>&nbsp;<span class="ident" id="2960979">b</span><span class="op" id="2960980">...</span><span class="op" id="2960983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960986">if</span>&nbsp;<span class="ident" id="2960989">_</span><span class="op" id="2960990">,</span>&nbsp;<span class="ident" id="2960992">err</span>&nbsp;<span class="op" id="2960996">:=</span>&nbsp;<span class="ident" id="2960999">c</span><span class="op" id="2961000">.</span><span class="ident" id="2961001">Write</span><span class="op" id="2961006">(</span><span class="ident" id="2961007">b</span><span class="op" id="2961008">)</span><span class="op" id="2961009">;</span>&nbsp;<span class="ident" id="2961011">err</span>&nbsp;<span class="op" id="2961015">!=</span>&nbsp;<span class="ident" id="2961018">nil</span>&nbsp;<span class="op" id="2961022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961026">return</span>&nbsp;<span class="ident" id="2961033">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961038">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961041">return</span>&nbsp;<span class="ident" id="2961048">nil</span><br>
<span class="lineno"></span><span class="op" id="2961052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2961055">func</span>&nbsp;<span class="op" id="2961060">(</span><span class="ident" id="2961061">d</span>&nbsp;<span class="op" id="2961063">*</span><span class="ident" id="2961064">Dialer</span><span class="op" id="2961070">)</span>&nbsp;<span class="ident" id="2961072">dialDNS</span><span class="op" id="2961079">(</span><span class="ident" id="2961080">network</span><span class="op" id="2961087">,</span>&nbsp;<span class="ident" id="2961089">server</span>&nbsp;<span class="builtintype" id="2961096">string</span><span class="op" id="2961102">)</span>&nbsp;<span class="op" id="2961104">(</span><span class="ident" id="2961105">dnsConn</span><span class="op" id="2961112">,</span>&nbsp;<span class="builtintype" id="2961114">error</span><span class="op" id="2961119">)</span>&nbsp;<span class="op" id="2961121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961124">switch</span>&nbsp;<span class="ident" id="2961131">network</span>&nbsp;<span class="op" id="2961139">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961142">case</span>&nbsp;<span class="string" id="2961147">&#34;tcp&#34;</span><span class="op" id="2961152">,</span>&nbsp;<span class="string" id="2961154">&#34;tcp4&#34;</span><span class="op" id="2961160">,</span>&nbsp;<span class="string" id="2961162">&#34;tcp6&#34;</span><span class="op" id="2961168">,</span>&nbsp;<span class="string" id="2961170">&#34;udp&#34;</span><span class="op" id="2961175">,</span>&nbsp;<span class="string" id="2961177">&#34;udp4&#34;</span><span class="op" id="2961183">,</span>&nbsp;<span class="string" id="2961185">&#34;udp6&#34;</span><span class="op" id="2961191">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961194">default</span><span class="op" id="2961201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961205">return</span>&nbsp;<span class="ident" id="2961212">nil</span><span class="op" id="2961215">,</span>&nbsp;<span class="ident" id="2961217">UnknownNetworkError</span><span class="op" id="2961236">(</span><span class="ident" id="2961237">network</span><span class="op" id="2961244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961250">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961310">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961371">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961433">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961488">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961545">c</span><span class="op" id="2961546">,</span>&nbsp;<span class="ident" id="2961548">err</span>&nbsp;<span class="op" id="2961552">:=</span>&nbsp;<span class="ident" id="2961555">d</span><span class="op" id="2961556">.</span><span class="ident" id="2961557">Dial</span><span class="op" id="2961561">(</span><span class="ident" id="2961562">network</span><span class="op" id="2961569">,</span>&nbsp;<span class="ident" id="2961571">server</span><span class="op" id="2961577">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961580">if</span>&nbsp;<span class="ident" id="2961583">err</span>&nbsp;<span class="op" id="2961587">!=</span>&nbsp;<span class="ident" id="2961590">nil</span>&nbsp;<span class="op" id="2961594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961598">return</span>&nbsp;<span class="ident" id="2961605">nil</span><span class="op" id="2961608">,</span>&nbsp;<span class="ident" id="2961610">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961618">switch</span>&nbsp;<span class="ident" id="2961625">network</span>&nbsp;<span class="op" id="2961633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961636">case</span>&nbsp;<span class="string" id="2961641">&#34;tcp&#34;</span><span class="op" id="2961646">,</span>&nbsp;<span class="string" id="2961648">&#34;tcp4&#34;</span><span class="op" id="2961654">,</span>&nbsp;<span class="string" id="2961656">&#34;tcp6&#34;</span><span class="op" id="2961662">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961666">return</span>&nbsp;<span class="ident" id="2961673">c</span><span class="op" id="2961674">.</span><span class="op" id="2961675">(</span><span class="op" id="2961676">*</span><span class="ident" id="2961677">TCPConn</span><span class="op" id="2961684">)</span><span class="op" id="2961685">,</span>&nbsp;<span class="ident" id="2961687">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961692">case</span>&nbsp;<span class="string" id="2961697">&#34;udp&#34;</span><span class="op" id="2961702">,</span>&nbsp;<span class="string" id="2961704">&#34;udp4&#34;</span><span class="op" id="2961710">,</span>&nbsp;<span class="string" id="2961712">&#34;udp6&#34;</span><span class="op" id="2961718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961722">return</span>&nbsp;<span class="ident" id="2961729">c</span><span class="op" id="2961730">.</span><span class="op" id="2961731">(</span><span class="op" id="2961732">*</span><span class="ident" id="2961733">UDPConn</span><span class="op" id="2961740">)</span><span class="op" id="2961741">,</span>&nbsp;<span class="ident" id="2961743">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2961751">panic</span><span class="op" id="2961756">(</span><span class="string" id="2961757">&#34;unreachable&#34;</span><span class="op" id="2961770">)</span><br>
<span class="lineno">120</span><span class="op" id="2961772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2961775">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="2961845">func</span>&nbsp;<span class="ident" id="2961850">exchange</span><span class="op" id="2961858">(</span><span class="ident" id="2961859">server</span><span class="op" id="2961865">,</span>&nbsp;<span class="ident" id="2961867">name</span>&nbsp;<span class="builtintype" id="2961872">string</span><span class="op" id="2961878">,</span>&nbsp;<span class="ident" id="2961880">qtype</span>&nbsp;<span class="builtintype" id="2961886">uint16</span><span class="op" id="2961892">,</span>&nbsp;<span class="ident" id="2961894">timeout</span>&nbsp;<span class="ident" id="2961902">time</span><span class="op" id="2961906">.</span><span class="ident" id="2961907">Duration</span><span class="op" id="2961915">)</span>&nbsp;<span class="op" id="2961917">(</span><span class="op" id="2961918">*</span><span class="ident" id="2961919">dnsMsg</span><span class="op" id="2961925">,</span>&nbsp;<span class="builtintype" id="2961927">error</span><span class="op" id="2961932">)</span>&nbsp;<span class="op" id="2961934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961937">d</span>&nbsp;<span class="op" id="2961939">:=</span>&nbsp;<span class="ident" id="2961942">Dialer</span><span class="op" id="2961948">{</span><span class="ident" id="2961949">Timeout</span><span class="op" id="2961956">:</span>&nbsp;<span class="ident" id="2961958">timeout</span><span class="op" id="2961965">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961968">out</span>&nbsp;<span class="op" id="2961972">:=</span>&nbsp;<span class="ident" id="2961975">dnsMsg</span><span class="op" id="2961981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961985">dnsMsgHdr</span><span class="op" id="2961994">:</span>&nbsp;<span class="ident" id="2961996">dnsMsgHdr</span><span class="op" id="2962005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962010">recursion_desired</span><span class="op" id="2962027">:</span>&nbsp;<span class="builtintype" id="2962029">true</span><span class="op" id="2962033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962037">}</span><span class="op" id="2962038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962042">question</span><span class="op" id="2962050">:</span>&nbsp;<span class="op" id="2962052">[</span><span class="op" id="2962053">]</span><span class="ident" id="2962054">dnsQuestion</span><span class="op" id="2962065">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962070">{</span><span class="ident" id="2962071">name</span><span class="op" id="2962075">,</span>&nbsp;<span class="ident" id="2962077">qtype</span><span class="op" id="2962082">,</span>&nbsp;<span class="ident" id="2962084">dnsClassINET</span><span class="op" id="2962096">}</span><span class="op" id="2962097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962101">}</span><span class="op" id="2962102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962108">for</span>&nbsp;<span class="ident" id="2962112">_</span><span class="op" id="2962113">,</span>&nbsp;<span class="ident" id="2962115">network</span>&nbsp;<span class="op" id="2962123">:=</span>&nbsp;<span class="keyword" id="2962126">range</span>&nbsp;<span class="op" id="2962132">[</span><span class="op" id="2962133">]</span><span class="builtintype" id="2962134">string</span><span class="op" id="2962140">{</span><span class="string" id="2962141">&#34;udp&#34;</span><span class="op" id="2962146">,</span>&nbsp;<span class="string" id="2962148">&#34;tcp&#34;</span><span class="op" id="2962153">}</span>&nbsp;<span class="op" id="2962155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962159">c</span><span class="op" id="2962160">,</span>&nbsp;<span class="ident" id="2962162">err</span>&nbsp;<span class="op" id="2962166">:=</span>&nbsp;<span class="ident" id="2962169">d</span><span class="op" id="2962170">.</span><span class="ident" id="2962171">dialDNS</span><span class="op" id="2962178">(</span><span class="ident" id="2962179">network</span><span class="op" id="2962186">,</span>&nbsp;<span class="ident" id="2962188">server</span><span class="op" id="2962194">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962198">if</span>&nbsp;<span class="ident" id="2962201">err</span>&nbsp;<span class="op" id="2962205">!=</span>&nbsp;<span class="ident" id="2962208">nil</span>&nbsp;<span class="op" id="2962212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962217">return</span>&nbsp;<span class="ident" id="2962224">nil</span><span class="op" id="2962227">,</span>&nbsp;<span class="ident" id="2962229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962239">defer</span>&nbsp;<span class="ident" id="2962245">c</span><span class="op" id="2962246">.</span><span class="ident" id="2962247">Close</span><span class="op" id="2962252">(</span><span class="op" id="2962253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962257">if</span>&nbsp;<span class="ident" id="2962260">timeout</span>&nbsp;<span class="op" id="2962268">&gt;</span>&nbsp;<span class="num" id="2962270">0</span>&nbsp;<span class="op" id="2962272">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962277">c</span><span class="op" id="2962278">.</span><span class="ident" id="2962279">SetDeadline</span><span class="op" id="2962290">(</span><span class="ident" id="2962291">time</span><span class="op" id="2962295">.</span><span class="ident" id="2962296">Now</span><span class="op" id="2962299">(</span><span class="op" id="2962300">)</span><span class="op" id="2962301">.</span><span class="ident" id="2962302">Add</span><span class="op" id="2962305">(</span><span class="ident" id="2962306">timeout</span><span class="op" id="2962313">)</span><span class="op" id="2962314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962322">out</span><span class="op" id="2962325">.</span><span class="ident" id="2962326">id</span>&nbsp;<span class="op" id="2962329">=</span>&nbsp;<span class="builtintype" id="2962331">uint16</span><span class="op" id="2962337">(</span><span class="ident" id="2962338">rand</span><span class="op" id="2962342">.</span><span class="ident" id="2962343">Int</span><span class="op" id="2962346">(</span><span class="op" id="2962347">)</span><span class="op" id="2962348">)</span>&nbsp;<span class="op" id="2962350">^</span>&nbsp;<span class="builtintype" id="2962352">uint16</span><span class="op" id="2962358">(</span><span class="ident" id="2962359">time</span><span class="op" id="2962363">.</span><span class="ident" id="2962364">Now</span><span class="op" id="2962367">(</span><span class="op" id="2962368">)</span><span class="op" id="2962369">.</span><span class="ident" id="2962370">UnixNano</span><span class="op" id="2962378">(</span><span class="op" id="2962379">)</span><span class="op" id="2962380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962384">if</span>&nbsp;<span class="ident" id="2962387">err</span>&nbsp;<span class="op" id="2962391">:=</span>&nbsp;<span class="ident" id="2962394">c</span><span class="op" id="2962395">.</span><span class="ident" id="2962396">writeDNSQuery</span><span class="op" id="2962409">(</span><span class="op" id="2962410">&amp;</span><span class="ident" id="2962411">out</span><span class="op" id="2962414">)</span><span class="op" id="2962415">;</span>&nbsp;<span class="ident" id="2962417">err</span>&nbsp;<span class="op" id="2962421">!=</span>&nbsp;<span class="ident" id="2962424">nil</span>&nbsp;<span class="op" id="2962428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962433">return</span>&nbsp;<span class="ident" id="2962440">nil</span><span class="op" id="2962443">,</span>&nbsp;<span class="ident" id="2962445">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962455">in</span><span class="op" id="2962457">,</span>&nbsp;<span class="ident" id="2962459">err</span>&nbsp;<span class="op" id="2962463">:=</span>&nbsp;<span class="ident" id="2962466">c</span><span class="op" id="2962467">.</span><span class="ident" id="2962468">readDNSResponse</span><span class="op" id="2962483">(</span><span class="op" id="2962484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962488">if</span>&nbsp;<span class="ident" id="2962491">err</span>&nbsp;<span class="op" id="2962495">!=</span>&nbsp;<span class="ident" id="2962498">nil</span>&nbsp;<span class="op" id="2962502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962507">return</span>&nbsp;<span class="ident" id="2962514">nil</span><span class="op" id="2962517">,</span>&nbsp;<span class="ident" id="2962519">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962525">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962529">if</span>&nbsp;<span class="ident" id="2962532">in</span><span class="op" id="2962534">.</span><span class="ident" id="2962535">id</span>&nbsp;<span class="op" id="2962538">!=</span>&nbsp;<span class="ident" id="2962541">out</span><span class="op" id="2962544">.</span><span class="ident" id="2962545">id</span>&nbsp;<span class="op" id="2962548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962553">return</span>&nbsp;<span class="ident" id="2962560">nil</span><span class="op" id="2962563">,</span>&nbsp;<span class="ident" id="2962565">errors</span><span class="op" id="2962571">.</span><span class="ident" id="2962572">New</span><span class="op" id="2962575">(</span><span class="string" id="2962576">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="2962601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962609">if</span>&nbsp;<span class="ident" id="2962612">in</span><span class="op" id="2962614">.</span><span class="ident" id="2962615">truncated</span>&nbsp;<span class="op" id="2962625">{</span>&nbsp;<span class="comment" id="2962627">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962646">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962661">return</span>&nbsp;<span class="ident" id="2962668">in</span><span class="op" id="2962670">,</span>&nbsp;<span class="ident" id="2962672">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962680">return</span>&nbsp;<span class="ident" id="2962687">nil</span><span class="op" id="2962690">,</span>&nbsp;<span class="ident" id="2962692">errors</span><span class="op" id="2962698">.</span><span class="ident" id="2962699">New</span><span class="op" id="2962702">(</span><span class="string" id="2962703">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="2962730">)</span><br>
<span class="lineno"></span><span class="op" id="2962732">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="2962735">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="2962790">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="2962839">func</span>&nbsp;<span class="ident" id="2962844">tryOneName</span><span class="op" id="2962854">(</span><span class="ident" id="2962855">cfg</span>&nbsp;<span class="op" id="2962859">*</span><span class="ident" id="2962860">dnsConfig</span><span class="op" id="2962869">,</span>&nbsp;<span class="ident" id="2962871">name</span>&nbsp;<span class="builtintype" id="2962876">string</span><span class="op" id="2962882">,</span>&nbsp;<span class="ident" id="2962884">qtype</span>&nbsp;<span class="builtintype" id="2962890">uint16</span><span class="op" id="2962896">)</span>&nbsp;<span class="op" id="2962898">(</span><span class="builtintype" id="2962899">string</span><span class="op" id="2962905">,</span>&nbsp;<span class="op" id="2962907">[</span><span class="op" id="2962908">]</span><span class="ident" id="2962909">dnsRR</span><span class="op" id="2962914">,</span>&nbsp;<span class="builtintype" id="2962916">error</span><span class="op" id="2962921">)</span>&nbsp;<span class="op" id="2962923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962926">if</span>&nbsp;<span class="builtinfunc" id="2962929">len</span><span class="op" id="2962932">(</span><span class="ident" id="2962933">cfg</span><span class="op" id="2962936">.</span><span class="ident" id="2962937">servers</span><span class="op" id="2962944">)</span>&nbsp;<span class="op" id="2962946">==</span>&nbsp;<span class="num" id="2962949">0</span>&nbsp;<span class="op" id="2962951">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962955">return</span>&nbsp;<span class="string" id="2962962">&#34;&#34;</span><span class="op" id="2962964">,</span>&nbsp;<span class="ident" id="2962966">nil</span><span class="op" id="2962969">,</span>&nbsp;<span class="op" id="2962971">&amp;</span><span class="ident" id="2962972">DNSError</span><span class="op" id="2962980">{</span><span class="ident" id="2962981">Err</span><span class="op" id="2962984">:</span>&nbsp;<span class="string" id="2962986">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="2963002">,</span>&nbsp;<span class="ident" id="2963004">Name</span><span class="op" id="2963008">:</span>&nbsp;<span class="ident" id="2963010">name</span><span class="op" id="2963014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963020">if</span>&nbsp;<span class="builtinfunc" id="2963023">len</span><span class="op" id="2963026">(</span><span class="ident" id="2963027">name</span><span class="op" id="2963031">)</span>&nbsp;<span class="op" id="2963033">&gt;=</span>&nbsp;<span class="num" id="2963036">256</span>&nbsp;<span class="op" id="2963040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963044">return</span>&nbsp;<span class="string" id="2963051">&#34;&#34;</span><span class="op" id="2963053">,</span>&nbsp;<span class="ident" id="2963055">nil</span><span class="op" id="2963058">,</span>&nbsp;<span class="op" id="2963060">&amp;</span><span class="ident" id="2963061">DNSError</span><span class="op" id="2963069">{</span><span class="ident" id="2963070">Err</span><span class="op" id="2963073">:</span>&nbsp;<span class="string" id="2963075">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="2963094">,</span>&nbsp;<span class="ident" id="2963096">Name</span><span class="op" id="2963100">:</span>&nbsp;<span class="ident" id="2963102">name</span><span class="op" id="2963106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963109">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963112">timeout</span>&nbsp;<span class="op" id="2963120">:=</span>&nbsp;<span class="ident" id="2963123">time</span><span class="op" id="2963127">.</span><span class="ident" id="2963128">Duration</span><span class="op" id="2963136">(</span><span class="ident" id="2963137">cfg</span><span class="op" id="2963140">.</span><span class="ident" id="2963141">timeout</span><span class="op" id="2963148">)</span>&nbsp;<span class="op" id="2963150">*</span>&nbsp;<span class="ident" id="2963152">time</span><span class="op" id="2963156">.</span><span class="ident" id="2963157">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963165">var</span>&nbsp;<span class="ident" id="2963169">lastErr</span>&nbsp;<span class="builtintype" id="2963177">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963184">for</span>&nbsp;<span class="ident" id="2963188">i</span>&nbsp;<span class="op" id="2963190">:=</span>&nbsp;<span class="num" id="2963193">0</span><span class="op" id="2963194">;</span>&nbsp;<span class="ident" id="2963196">i</span>&nbsp;<span class="op" id="2963198">&lt;</span>&nbsp;<span class="ident" id="2963200">cfg</span><span class="op" id="2963203">.</span><span class="ident" id="2963204">attempts</span><span class="op" id="2963212">;</span>&nbsp;<span class="ident" id="2963214">i</span><span class="op" id="2963215">++</span>&nbsp;<span class="op" id="2963218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963222">for</span>&nbsp;<span class="ident" id="2963226">_</span><span class="op" id="2963227">,</span>&nbsp;<span class="ident" id="2963229">server</span>&nbsp;<span class="op" id="2963236">:=</span>&nbsp;<span class="keyword" id="2963239">range</span>&nbsp;<span class="ident" id="2963245">cfg</span><span class="op" id="2963248">.</span><span class="ident" id="2963249">servers</span>&nbsp;<span class="op" id="2963257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963262">server</span>&nbsp;<span class="op" id="2963269">=</span>&nbsp;<span class="ident" id="2963271">JoinHostPort</span><span class="op" id="2963283">(</span><span class="ident" id="2963284">server</span><span class="op" id="2963290">,</span>&nbsp;<span class="string" id="2963292">&#34;53&#34;</span><span class="op" id="2963296">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963301">msg</span><span class="op" id="2963304">,</span>&nbsp;<span class="ident" id="2963306">err</span>&nbsp;<span class="op" id="2963310">:=</span>&nbsp;<span class="ident" id="2963313">exchange</span><span class="op" id="2963321">(</span><span class="ident" id="2963322">server</span><span class="op" id="2963328">,</span>&nbsp;<span class="ident" id="2963330">name</span><span class="op" id="2963334">,</span>&nbsp;<span class="ident" id="2963336">qtype</span><span class="op" id="2963341">,</span>&nbsp;<span class="ident" id="2963343">timeout</span><span class="op" id="2963350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963355">if</span>&nbsp;<span class="ident" id="2963358">err</span>&nbsp;<span class="op" id="2963362">!=</span>&nbsp;<span class="ident" id="2963365">nil</span>&nbsp;<span class="op" id="2963369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963375">lastErr</span>&nbsp;<span class="op" id="2963383">=</span>&nbsp;<span class="op" id="2963385">&amp;</span><span class="ident" id="2963386">DNSError</span><span class="op" id="2963394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963401">Err</span><span class="op" id="2963404">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2963409">err</span><span class="op" id="2963412">.</span><span class="ident" id="2963413">Error</span><span class="op" id="2963418">(</span><span class="op" id="2963419">)</span><span class="op" id="2963420">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963427">Name</span><span class="op" id="2963431">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2963435">name</span><span class="op" id="2963439">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963446">Server</span><span class="op" id="2963452">:</span>&nbsp;<span class="ident" id="2963454">server</span><span class="op" id="2963460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963472">if</span>&nbsp;<span class="ident" id="2963475">nerr</span><span class="op" id="2963479">,</span>&nbsp;<span class="ident" id="2963481">ok</span>&nbsp;<span class="op" id="2963484">:=</span>&nbsp;<span class="ident" id="2963487">err</span><span class="op" id="2963490">.</span><span class="op" id="2963491">(</span><span class="ident" id="2963492">Error</span><span class="op" id="2963497">)</span><span class="op" id="2963498">;</span>&nbsp;<span class="ident" id="2963500">ok</span>&nbsp;<span class="op" id="2963503">&amp;&amp;</span>&nbsp;<span class="ident" id="2963506">nerr</span><span class="op" id="2963510">.</span><span class="ident" id="2963511">Timeout</span><span class="op" id="2963518">(</span><span class="op" id="2963519">)</span>&nbsp;<span class="op" id="2963521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963528">lastErr</span><span class="op" id="2963535">.</span><span class="op" id="2963536">(</span><span class="op" id="2963537">*</span><span class="ident" id="2963538">DNSError</span><span class="op" id="2963546">)</span><span class="op" id="2963547">.</span><span class="ident" id="2963548">IsTimeout</span>&nbsp;<span class="op" id="2963558">=</span>&nbsp;<span class="builtintype" id="2963560">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963569">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963575">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963592">cname</span><span class="op" id="2963597">,</span>&nbsp;<span class="ident" id="2963599">addrs</span><span class="op" id="2963604">,</span>&nbsp;<span class="ident" id="2963606">err</span>&nbsp;<span class="op" id="2963610">:=</span>&nbsp;<span class="ident" id="2963613">answer</span><span class="op" id="2963619">(</span><span class="ident" id="2963620">name</span><span class="op" id="2963624">,</span>&nbsp;<span class="ident" id="2963626">server</span><span class="op" id="2963632">,</span>&nbsp;<span class="ident" id="2963634">msg</span><span class="op" id="2963637">,</span>&nbsp;<span class="ident" id="2963639">qtype</span><span class="op" id="2963644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963649">if</span>&nbsp;<span class="ident" id="2963652">err</span>&nbsp;<span class="op" id="2963656">==</span>&nbsp;<span class="ident" id="2963659">nil</span>&nbsp;<span class="op" id="2963663">||</span>&nbsp;<span class="ident" id="2963666">err</span><span class="op" id="2963669">.</span><span class="op" id="2963670">(</span><span class="op" id="2963671">*</span><span class="ident" id="2963672">DNSError</span><span class="op" id="2963680">)</span><span class="op" id="2963681">.</span><span class="ident" id="2963682">Err</span>&nbsp;<span class="op" id="2963686">==</span>&nbsp;<span class="ident" id="2963689">noSuchHost</span>&nbsp;<span class="op" id="2963700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963706">return</span>&nbsp;<span class="ident" id="2963713">cname</span><span class="op" id="2963718">,</span>&nbsp;<span class="ident" id="2963720">addrs</span><span class="op" id="2963725">,</span>&nbsp;<span class="ident" id="2963727">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963739">lastErr</span>&nbsp;<span class="op" id="2963747">=</span>&nbsp;<span class="ident" id="2963749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963761">return</span>&nbsp;<span class="string" id="2963768">&#34;&#34;</span><span class="op" id="2963770">,</span>&nbsp;<span class="ident" id="2963772">nil</span><span class="op" id="2963775">,</span>&nbsp;<span class="ident" id="2963777">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="2963785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2963788">func</span>&nbsp;<span class="ident" id="2963793">convertRR_A</span><span class="op" id="2963804">(</span><span class="ident" id="2963805">records</span>&nbsp;<span class="op" id="2963813">[</span><span class="op" id="2963814">]</span><span class="ident" id="2963815">dnsRR</span><span class="op" id="2963820">)</span>&nbsp;<span class="op" id="2963822">[</span><span class="op" id="2963823">]</span><span class="ident" id="2963824">IP</span>&nbsp;<span class="op" id="2963827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963830">addrs</span>&nbsp;<span class="op" id="2963836">:=</span>&nbsp;<span class="builtinfunc" id="2963839">make</span><span class="op" id="2963843">(</span><span class="op" id="2963844">[</span><span class="op" id="2963845">]</span><span class="ident" id="2963846">IP</span><span class="op" id="2963848">,</span>&nbsp;<span class="builtinfunc" id="2963850">len</span><span class="op" id="2963853">(</span><span class="ident" id="2963854">records</span><span class="op" id="2963861">)</span><span class="op" id="2963862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963865">for</span>&nbsp;<span class="ident" id="2963869">i</span><span class="op" id="2963870">,</span>&nbsp;<span class="ident" id="2963872">rr</span>&nbsp;<span class="op" id="2963875">:=</span>&nbsp;<span class="keyword" id="2963878">range</span>&nbsp;<span class="ident" id="2963884">records</span>&nbsp;<span class="op" id="2963892">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963896">a</span>&nbsp;<span class="op" id="2963898">:=</span>&nbsp;<span class="ident" id="2963901">rr</span><span class="op" id="2963903">.</span><span class="op" id="2963904">(</span><span class="op" id="2963905">*</span><span class="ident" id="2963906">dnsRR_A</span><span class="op" id="2963913">)</span><span class="op" id="2963914">.</span><span class="ident" id="2963915">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963919">addrs</span><span class="op" id="2963924">[</span><span class="ident" id="2963925">i</span><span class="op" id="2963926">]</span>&nbsp;<span class="op" id="2963928">=</span>&nbsp;<span class="ident" id="2963930">IPv4</span><span class="op" id="2963934">(</span><span class="builtintype" id="2963935">byte</span><span class="op" id="2963939">(</span><span class="ident" id="2963940">a</span><span class="op" id="2963941">&gt;&gt;</span><span class="num" id="2963943">24</span><span class="op" id="2963945">)</span><span class="op" id="2963946">,</span>&nbsp;<span class="builtintype" id="2963948">byte</span><span class="op" id="2963952">(</span><span class="ident" id="2963953">a</span><span class="op" id="2963954">&gt;&gt;</span><span class="num" id="2963956">16</span><span class="op" id="2963958">)</span><span class="op" id="2963959">,</span>&nbsp;<span class="builtintype" id="2963961">byte</span><span class="op" id="2963965">(</span><span class="ident" id="2963966">a</span><span class="op" id="2963967">&gt;&gt;</span><span class="num" id="2963969">8</span><span class="op" id="2963970">)</span><span class="op" id="2963971">,</span>&nbsp;<span class="builtintype" id="2963973">byte</span><span class="op" id="2963977">(</span><span class="ident" id="2963978">a</span><span class="op" id="2963979">)</span><span class="op" id="2963980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963986">return</span>&nbsp;<span class="ident" id="2963993">addrs</span><br>
<span class="lineno"></span><span class="op" id="2963999">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="2964002">func</span>&nbsp;<span class="ident" id="2964007">convertRR_AAAA</span><span class="op" id="2964021">(</span><span class="ident" id="2964022">records</span>&nbsp;<span class="op" id="2964030">[</span><span class="op" id="2964031">]</span><span class="ident" id="2964032">dnsRR</span><span class="op" id="2964037">)</span>&nbsp;<span class="op" id="2964039">[</span><span class="op" id="2964040">]</span><span class="ident" id="2964041">IP</span>&nbsp;<span class="op" id="2964044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964047">addrs</span>&nbsp;<span class="op" id="2964053">:=</span>&nbsp;<span class="builtinfunc" id="2964056">make</span><span class="op" id="2964060">(</span><span class="op" id="2964061">[</span><span class="op" id="2964062">]</span><span class="ident" id="2964063">IP</span><span class="op" id="2964065">,</span>&nbsp;<span class="builtinfunc" id="2964067">len</span><span class="op" id="2964070">(</span><span class="ident" id="2964071">records</span><span class="op" id="2964078">)</span><span class="op" id="2964079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964082">for</span>&nbsp;<span class="ident" id="2964086">i</span><span class="op" id="2964087">,</span>&nbsp;<span class="ident" id="2964089">rr</span>&nbsp;<span class="op" id="2964092">:=</span>&nbsp;<span class="keyword" id="2964095">range</span>&nbsp;<span class="ident" id="2964101">records</span>&nbsp;<span class="op" id="2964109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964113">a</span>&nbsp;<span class="op" id="2964115">:=</span>&nbsp;<span class="builtinfunc" id="2964118">make</span><span class="op" id="2964122">(</span><span class="ident" id="2964123">IP</span><span class="op" id="2964125">,</span>&nbsp;<span class="ident" id="2964127">IPv6len</span><span class="op" id="2964134">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2964138">copy</span><span class="op" id="2964142">(</span><span class="ident" id="2964143">a</span><span class="op" id="2964144">,</span>&nbsp;<span class="ident" id="2964146">rr</span><span class="op" id="2964148">.</span><span class="op" id="2964149">(</span><span class="op" id="2964150">*</span><span class="ident" id="2964151">dnsRR_AAAA</span><span class="op" id="2964161">)</span><span class="op" id="2964162">.</span><span class="ident" id="2964163">AAAA</span><span class="op" id="2964167">[</span><span class="op" id="2964168">:</span><span class="op" id="2964169">]</span><span class="op" id="2964170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964174">addrs</span><span class="op" id="2964179">[</span><span class="ident" id="2964180">i</span><span class="op" id="2964181">]</span>&nbsp;<span class="op" id="2964183">=</span>&nbsp;<span class="ident" id="2964185">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964191">return</span>&nbsp;<span class="ident" id="2964198">addrs</span><br>
<span class="lineno"></span><span class="op" id="2964204">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="2964207">var</span>&nbsp;<span class="ident" id="2964211">cfg</span>&nbsp;<span class="keyword" id="2964215">struct</span>&nbsp;<span class="op" id="2964222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964225">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964235">chan</span>&nbsp;<span class="keyword" id="2964240">struct</span><span class="op" id="2964246">{</span><span class="op" id="2964247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964250">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964260">sync</span><span class="op" id="2964264">.</span><span class="ident" id="2964265">RWMutex</span>&nbsp;<span class="comment" id="2964273">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964307">dnsConfig</span>&nbsp;<span class="op" id="2964317">*</span><span class="ident" id="2964318">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964329">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2964339">error</span><br>
<span class="lineno"></span><span class="op" id="2964345">}</span><br>
<span class="lineno"></span><span class="keyword" id="2964347">var</span>&nbsp;<span class="ident" id="2964351">onceLoadConfig</span>&nbsp;<span class="ident" id="2964366">sync</span><span class="op" id="2964370">.</span><span class="ident" id="2964371">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2964377">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="2964428">func</span>&nbsp;<span class="ident" id="2964433">loadDefaultConfig</span><span class="op" id="2964450">(</span><span class="op" id="2964451">)</span>&nbsp;<span class="op" id="2964453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964456">loadConfig</span><span class="op" id="2964466">(</span><span class="string" id="2964467">&#34;/etc/resolv.conf&#34;</span><span class="op" id="2964485">,</span>&nbsp;<span class="num" id="2964487">5</span><span class="op" id="2964488">*</span><span class="ident" id="2964489">time</span><span class="op" id="2964493">.</span><span class="ident" id="2964494">Second</span><span class="op" id="2964500">,</span>&nbsp;<span class="ident" id="2964502">nil</span><span class="op" id="2964505">)</span><br>
<span class="lineno"></span><span class="op" id="2964507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2964510">func</span>&nbsp;<span class="ident" id="2964515">loadConfig</span><span class="op" id="2964525">(</span><span class="ident" id="2964526">resolvConfPath</span>&nbsp;<span class="builtintype" id="2964541">string</span><span class="op" id="2964547">,</span>&nbsp;<span class="ident" id="2964549">reloadTime</span>&nbsp;<span class="ident" id="2964560">time</span><span class="op" id="2964564">.</span><span class="ident" id="2964565">Duration</span><span class="op" id="2964573">,</span>&nbsp;<span class="ident" id="2964575">quit</span>&nbsp;<span class="op" id="2964580">&lt;-</span><span class="keyword" id="2964582">chan</span>&nbsp;<span class="keyword" id="2964587">chan</span>&nbsp;<span class="keyword" id="2964592">struct</span><span class="op" id="2964598">{</span><span class="op" id="2964599">}</span><span class="op" id="2964600">)</span>&nbsp;<span class="op" id="2964602">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964605">var</span>&nbsp;<span class="ident" id="2964609">mtime</span>&nbsp;<span class="ident" id="2964615">time</span><span class="op" id="2964619">.</span><span class="ident" id="2964620">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964626">cfg</span><span class="op" id="2964629">.</span><span class="ident" id="2964630">ch</span>&nbsp;<span class="op" id="2964633">=</span>&nbsp;<span class="builtinfunc" id="2964635">make</span><span class="op" id="2964639">(</span><span class="keyword" id="2964640">chan</span>&nbsp;<span class="keyword" id="2964645">struct</span><span class="op" id="2964651">{</span><span class="op" id="2964652">}</span><span class="op" id="2964653">,</span>&nbsp;<span class="num" id="2964655">1</span><span class="op" id="2964656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964659">if</span>&nbsp;<span class="ident" id="2964662">fi</span><span class="op" id="2964664">,</span>&nbsp;<span class="ident" id="2964666">err</span>&nbsp;<span class="op" id="2964670">:=</span>&nbsp;<span class="ident" id="2964673">os</span><span class="op" id="2964675">.</span><span class="ident" id="2964676">Stat</span><span class="op" id="2964680">(</span><span class="ident" id="2964681">resolvConfPath</span><span class="op" id="2964695">)</span><span class="op" id="2964696">;</span>&nbsp;<span class="ident" id="2964698">err</span>&nbsp;<span class="op" id="2964702">!=</span>&nbsp;<span class="ident" id="2964705">nil</span>&nbsp;<span class="op" id="2964709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964713">cfg</span><span class="op" id="2964716">.</span><span class="ident" id="2964717">dnserr</span>&nbsp;<span class="op" id="2964724">=</span>&nbsp;<span class="ident" id="2964726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964731">}</span>&nbsp;<span class="keyword" id="2964733">else</span>&nbsp;<span class="op" id="2964738">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964742">mtime</span>&nbsp;<span class="op" id="2964748">=</span>&nbsp;<span class="ident" id="2964750">fi</span><span class="op" id="2964752">.</span><span class="ident" id="2964753">ModTime</span><span class="op" id="2964760">(</span><span class="op" id="2964761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964765">cfg</span><span class="op" id="2964768">.</span><span class="ident" id="2964769">dnsConfig</span><span class="op" id="2964778">,</span>&nbsp;<span class="ident" id="2964780">cfg</span><span class="op" id="2964783">.</span><span class="ident" id="2964784">dnserr</span>&nbsp;<span class="op" id="2964791">=</span>&nbsp;<span class="ident" id="2964793">dnsReadConfig</span><span class="op" id="2964806">(</span><span class="ident" id="2964807">resolvConfPath</span><span class="op" id="2964821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964827">go</span>&nbsp;<span class="keyword" id="2964830">func</span><span class="op" id="2964834">(</span><span class="op" id="2964835">)</span>&nbsp;<span class="op" id="2964837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964841">for</span>&nbsp;<span class="op" id="2964845">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964850">time</span><span class="op" id="2964854">.</span><span class="ident" id="2964855">Sleep</span><span class="op" id="2964860">(</span><span class="ident" id="2964861">reloadTime</span><span class="op" id="2964871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964876">select</span>&nbsp;<span class="op" id="2964883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964888">case</span>&nbsp;<span class="ident" id="2964893">qresp</span>&nbsp;<span class="op" id="2964899">:=</span>&nbsp;<span class="op" id="2964902">&lt;-</span><span class="ident" id="2964904">quit</span><span class="op" id="2964908">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964914">qresp</span>&nbsp;<span class="op" id="2964920">&lt;-</span>&nbsp;<span class="keyword" id="2964923">struct</span><span class="op" id="2964929">{</span><span class="op" id="2964930">}</span><span class="op" id="2964931">{</span><span class="op" id="2964932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964938">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964948">case</span>&nbsp;<span class="op" id="2964953">&lt;-</span><span class="ident" id="2964955">cfg</span><span class="op" id="2964958">.</span><span class="ident" id="2964959">ch</span><span class="op" id="2964961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2964972">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965024">fi</span><span class="op" id="2965026">,</span>&nbsp;<span class="ident" id="2965028">err</span>&nbsp;<span class="op" id="2965032">:=</span>&nbsp;<span class="ident" id="2965035">os</span><span class="op" id="2965037">.</span><span class="ident" id="2965038">Stat</span><span class="op" id="2965042">(</span><span class="ident" id="2965043">resolvConfPath</span><span class="op" id="2965057">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965062">if</span>&nbsp;<span class="ident" id="2965065">err</span>&nbsp;<span class="op" id="2965069">!=</span>&nbsp;<span class="ident" id="2965072">nil</span>&nbsp;<span class="op" id="2965076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965082">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2965099">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965159">m</span>&nbsp;<span class="op" id="2965161">:=</span>&nbsp;<span class="ident" id="2965164">fi</span><span class="op" id="2965166">.</span><span class="ident" id="2965167">ModTime</span><span class="op" id="2965174">(</span><span class="op" id="2965175">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965180">if</span>&nbsp;<span class="ident" id="2965183">m</span><span class="op" id="2965184">.</span><span class="ident" id="2965185">Equal</span><span class="op" id="2965190">(</span><span class="ident" id="2965191">mtime</span><span class="op" id="2965196">)</span>&nbsp;<span class="op" id="2965198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965204">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965221">mtime</span>&nbsp;<span class="op" id="2965227">=</span>&nbsp;<span class="ident" id="2965229">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2965234">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965286">ncfg</span><span class="op" id="2965290">,</span>&nbsp;<span class="ident" id="2965292">err</span>&nbsp;<span class="op" id="2965296">:=</span>&nbsp;<span class="ident" id="2965299">dnsReadConfig</span><span class="op" id="2965312">(</span><span class="ident" id="2965313">resolvConfPath</span><span class="op" id="2965327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965332">if</span>&nbsp;<span class="ident" id="2965335">err</span>&nbsp;<span class="op" id="2965339">!=</span>&nbsp;<span class="ident" id="2965342">nil</span>&nbsp;<span class="op" id="2965346">||</span>&nbsp;<span class="builtinfunc" id="2965349">len</span><span class="op" id="2965352">(</span><span class="ident" id="2965353">ncfg</span><span class="op" id="2965357">.</span><span class="ident" id="2965358">servers</span><span class="op" id="2965365">)</span>&nbsp;<span class="op" id="2965367">==</span>&nbsp;<span class="num" id="2965370">0</span>&nbsp;<span class="op" id="2965372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965378">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965395">cfg</span><span class="op" id="2965398">.</span><span class="ident" id="2965399">mu</span><span class="op" id="2965401">.</span><span class="ident" id="2965402">Lock</span><span class="op" id="2965406">(</span><span class="op" id="2965407">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965412">cfg</span><span class="op" id="2965415">.</span><span class="ident" id="2965416">dnsConfig</span>&nbsp;<span class="op" id="2965426">=</span>&nbsp;<span class="ident" id="2965428">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965436">cfg</span><span class="op" id="2965439">.</span><span class="ident" id="2965440">dnserr</span>&nbsp;<span class="op" id="2965447">=</span>&nbsp;<span class="ident" id="2965449">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965456">cfg</span><span class="op" id="2965459">.</span><span class="ident" id="2965460">mu</span><span class="op" id="2965462">.</span><span class="ident" id="2965463">Unlock</span><span class="op" id="2965469">(</span><span class="op" id="2965470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965477">}</span><span class="op" id="2965478">(</span><span class="op" id="2965479">)</span><br>
<span class="lineno">270</span><span class="op" id="2965481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2965484">func</span>&nbsp;<span class="ident" id="2965489">lookup</span><span class="op" id="2965495">(</span><span class="ident" id="2965496">name</span>&nbsp;<span class="builtintype" id="2965501">string</span><span class="op" id="2965507">,</span>&nbsp;<span class="ident" id="2965509">qtype</span>&nbsp;<span class="builtintype" id="2965515">uint16</span><span class="op" id="2965521">)</span>&nbsp;<span class="op" id="2965523">(</span><span class="ident" id="2965524">cname</span>&nbsp;<span class="builtintype" id="2965530">string</span><span class="op" id="2965536">,</span>&nbsp;<span class="ident" id="2965538">addrs</span>&nbsp;<span class="op" id="2965544">[</span><span class="op" id="2965545">]</span><span class="ident" id="2965546">dnsRR</span><span class="op" id="2965551">,</span>&nbsp;<span class="ident" id="2965553">err</span>&nbsp;<span class="builtintype" id="2965557">error</span><span class="op" id="2965562">)</span>&nbsp;<span class="op" id="2965564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965567">if</span>&nbsp;<span class="op" id="2965570">!</span><span class="ident" id="2965571">isDomainName</span><span class="op" id="2965583">(</span><span class="ident" id="2965584">name</span><span class="op" id="2965588">)</span>&nbsp;<span class="op" id="2965590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965594">return</span>&nbsp;<span class="ident" id="2965601">name</span><span class="op" id="2965605">,</span>&nbsp;<span class="ident" id="2965607">nil</span><span class="op" id="2965610">,</span>&nbsp;<span class="op" id="2965612">&amp;</span><span class="ident" id="2965613">DNSError</span><span class="op" id="2965621">{</span><span class="ident" id="2965622">Err</span><span class="op" id="2965625">:</span>&nbsp;<span class="string" id="2965627">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="2965648">,</span>&nbsp;<span class="ident" id="2965650">Name</span><span class="op" id="2965654">:</span>&nbsp;<span class="ident" id="2965656">name</span><span class="op" id="2965660">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965666">onceLoadConfig</span><span class="op" id="2965680">.</span><span class="ident" id="2965681">Do</span><span class="op" id="2965683">(</span><span class="ident" id="2965684">loadDefaultConfig</span><span class="op" id="2965701">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965705">select</span>&nbsp;<span class="op" id="2965712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965715">case</span>&nbsp;<span class="ident" id="2965720">cfg</span><span class="op" id="2965723">.</span><span class="ident" id="2965724">ch</span>&nbsp;<span class="op" id="2965727">&lt;-</span>&nbsp;<span class="keyword" id="2965730">struct</span><span class="op" id="2965736">{</span><span class="op" id="2965737">}</span><span class="op" id="2965738">{</span><span class="op" id="2965739">}</span><span class="op" id="2965740">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965743">default</span><span class="op" id="2965750">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965757">cfg</span><span class="op" id="2965760">.</span><span class="ident" id="2965761">mu</span><span class="op" id="2965763">.</span><span class="ident" id="2965764">RLock</span><span class="op" id="2965769">(</span><span class="op" id="2965770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965773">defer</span>&nbsp;<span class="ident" id="2965779">cfg</span><span class="op" id="2965782">.</span><span class="ident" id="2965783">mu</span><span class="op" id="2965785">.</span><span class="ident" id="2965786">RUnlock</span><span class="op" id="2965793">(</span><span class="op" id="2965794">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965798">if</span>&nbsp;<span class="ident" id="2965801">cfg</span><span class="op" id="2965804">.</span><span class="ident" id="2965805">dnserr</span>&nbsp;<span class="op" id="2965812">!=</span>&nbsp;<span class="ident" id="2965815">nil</span>&nbsp;<span class="op" id="2965819">||</span>&nbsp;<span class="ident" id="2965822">cfg</span><span class="op" id="2965825">.</span><span class="ident" id="2965826">dnsConfig</span>&nbsp;<span class="op" id="2965836">==</span>&nbsp;<span class="ident" id="2965839">nil</span>&nbsp;<span class="op" id="2965843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965847">err</span>&nbsp;<span class="op" id="2965851">=</span>&nbsp;<span class="ident" id="2965853">cfg</span><span class="op" id="2965856">.</span><span class="ident" id="2965857">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965866">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965874">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2965877">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2965934">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965962">rooted</span>&nbsp;<span class="op" id="2965969">:=</span>&nbsp;<span class="builtinfunc" id="2965972">len</span><span class="op" id="2965975">(</span><span class="ident" id="2965976">name</span><span class="op" id="2965980">)</span>&nbsp;<span class="op" id="2965982">&gt;</span>&nbsp;<span class="num" id="2965984">0</span>&nbsp;<span class="op" id="2965986">&amp;&amp;</span>&nbsp;<span class="ident" id="2965989">name</span><span class="op" id="2965993">[</span><span class="builtinfunc" id="2965994">len</span><span class="op" id="2965997">(</span><span class="ident" id="2965998">name</span><span class="op" id="2966002">)</span><span class="op" id="2966003">-</span><span class="num" id="2966004">1</span><span class="op" id="2966005">]</span>&nbsp;<span class="op" id="2966007">==</span>&nbsp;<span class="string" id="2966010">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966015">if</span>&nbsp;<span class="ident" id="2966018">rooted</span>&nbsp;<span class="op" id="2966025">||</span>&nbsp;<span class="ident" id="2966028">count</span><span class="op" id="2966033">(</span><span class="ident" id="2966034">name</span><span class="op" id="2966038">,</span>&nbsp;<span class="string" id="2966040">&#39;.&#39;</span><span class="op" id="2966043">)</span>&nbsp;<span class="op" id="2966045">&gt;=</span>&nbsp;<span class="ident" id="2966048">cfg</span><span class="op" id="2966051">.</span><span class="ident" id="2966052">dnsConfig</span><span class="op" id="2966061">.</span><span class="ident" id="2966062">ndots</span>&nbsp;<span class="op" id="2966068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966072">rname</span>&nbsp;<span class="op" id="2966078">:=</span>&nbsp;<span class="ident" id="2966081">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966088">if</span>&nbsp;<span class="op" id="2966091">!</span><span class="ident" id="2966092">rooted</span>&nbsp;<span class="op" id="2966099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966104">rname</span>&nbsp;<span class="op" id="2966110">+=</span>&nbsp;<span class="string" id="2966113">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966123">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966154">cname</span><span class="op" id="2966159">,</span>&nbsp;<span class="ident" id="2966161">addrs</span><span class="op" id="2966166">,</span>&nbsp;<span class="ident" id="2966168">err</span>&nbsp;<span class="op" id="2966172">=</span>&nbsp;<span class="ident" id="2966174">tryOneName</span><span class="op" id="2966184">(</span><span class="ident" id="2966185">cfg</span><span class="op" id="2966188">.</span><span class="ident" id="2966189">dnsConfig</span><span class="op" id="2966198">,</span>&nbsp;<span class="ident" id="2966200">rname</span><span class="op" id="2966205">,</span>&nbsp;<span class="ident" id="2966207">qtype</span><span class="op" id="2966212">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966216">if</span>&nbsp;<span class="ident" id="2966219">rooted</span>&nbsp;<span class="op" id="2966226">||</span>&nbsp;<span class="ident" id="2966229">err</span>&nbsp;<span class="op" id="2966233">==</span>&nbsp;<span class="ident" id="2966236">nil</span>&nbsp;<span class="op" id="2966240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966245">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966261">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966290">for</span>&nbsp;<span class="ident" id="2966294">i</span>&nbsp;<span class="op" id="2966296">:=</span>&nbsp;<span class="num" id="2966299">0</span><span class="op" id="2966300">;</span>&nbsp;<span class="ident" id="2966302">i</span>&nbsp;<span class="op" id="2966304">&lt;</span>&nbsp;<span class="builtinfunc" id="2966306">len</span><span class="op" id="2966309">(</span><span class="ident" id="2966310">cfg</span><span class="op" id="2966313">.</span><span class="ident" id="2966314">dnsConfig</span><span class="op" id="2966323">.</span><span class="ident" id="2966324">search</span><span class="op" id="2966330">)</span><span class="op" id="2966331">;</span>&nbsp;<span class="ident" id="2966333">i</span><span class="op" id="2966334">++</span>&nbsp;<span class="op" id="2966337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966341">rname</span>&nbsp;<span class="op" id="2966347">:=</span>&nbsp;<span class="ident" id="2966350">name</span>&nbsp;<span class="op" id="2966355">+</span>&nbsp;<span class="string" id="2966357">&#34;.&#34;</span>&nbsp;<span class="op" id="2966361">+</span>&nbsp;<span class="ident" id="2966363">cfg</span><span class="op" id="2966366">.</span><span class="ident" id="2966367">dnsConfig</span><span class="op" id="2966376">.</span><span class="ident" id="2966377">search</span><span class="op" id="2966383">[</span><span class="ident" id="2966384">i</span><span class="op" id="2966385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966389">if</span>&nbsp;<span class="ident" id="2966392">rname</span><span class="op" id="2966397">[</span><span class="builtinfunc" id="2966398">len</span><span class="op" id="2966401">(</span><span class="ident" id="2966402">rname</span><span class="op" id="2966407">)</span><span class="op" id="2966408">-</span><span class="num" id="2966409">1</span><span class="op" id="2966410">]</span>&nbsp;<span class="op" id="2966412">!=</span>&nbsp;<span class="string" id="2966415">&#39;.&#39;</span>&nbsp;<span class="op" id="2966419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966424">rname</span>&nbsp;<span class="op" id="2966430">+=</span>&nbsp;<span class="string" id="2966433">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966443">cname</span><span class="op" id="2966448">,</span>&nbsp;<span class="ident" id="2966450">addrs</span><span class="op" id="2966455">,</span>&nbsp;<span class="ident" id="2966457">err</span>&nbsp;<span class="op" id="2966461">=</span>&nbsp;<span class="ident" id="2966463">tryOneName</span><span class="op" id="2966473">(</span><span class="ident" id="2966474">cfg</span><span class="op" id="2966477">.</span><span class="ident" id="2966478">dnsConfig</span><span class="op" id="2966487">,</span>&nbsp;<span class="ident" id="2966489">rname</span><span class="op" id="2966494">,</span>&nbsp;<span class="ident" id="2966496">qtype</span><span class="op" id="2966501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966505">if</span>&nbsp;<span class="ident" id="2966508">err</span>&nbsp;<span class="op" id="2966512">==</span>&nbsp;<span class="ident" id="2966515">nil</span>&nbsp;<span class="op" id="2966519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966524">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966533">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966540">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966606">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966668">if</span>&nbsp;<span class="ident" id="2966671">count</span><span class="op" id="2966676">(</span><span class="ident" id="2966677">name</span><span class="op" id="2966681">,</span>&nbsp;<span class="string" id="2966683">&#39;.&#39;</span><span class="op" id="2966686">)</span>&nbsp;<span class="op" id="2966688">&lt;</span>&nbsp;<span class="ident" id="2966690">cfg</span><span class="op" id="2966693">.</span><span class="ident" id="2966694">dnsConfig</span><span class="op" id="2966703">.</span><span class="ident" id="2966704">ndots</span>&nbsp;<span class="op" id="2966710">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966714">cname</span><span class="op" id="2966719">,</span>&nbsp;<span class="ident" id="2966721">addrs</span><span class="op" id="2966726">,</span>&nbsp;<span class="ident" id="2966728">err</span>&nbsp;<span class="op" id="2966732">=</span>&nbsp;<span class="ident" id="2966734">tryOneName</span><span class="op" id="2966744">(</span><span class="ident" id="2966745">cfg</span><span class="op" id="2966748">.</span><span class="ident" id="2966749">dnsConfig</span><span class="op" id="2966758">,</span>&nbsp;<span class="ident" id="2966760">name</span><span class="op" id="2966764">+</span><span class="string" id="2966765">&#34;.&#34;</span><span class="op" id="2966768">,</span>&nbsp;<span class="ident" id="2966770">qtype</span><span class="op" id="2966775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966779">if</span>&nbsp;<span class="ident" id="2966782">err</span>&nbsp;<span class="op" id="2966786">==</span>&nbsp;<span class="ident" id="2966789">nil</span>&nbsp;<span class="op" id="2966793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966798">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966810">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966814">if</span>&nbsp;<span class="ident" id="2966817">e</span><span class="op" id="2966818">,</span>&nbsp;<span class="ident" id="2966820">ok</span>&nbsp;<span class="op" id="2966823">:=</span>&nbsp;<span class="ident" id="2966826">err</span><span class="op" id="2966829">.</span><span class="op" id="2966830">(</span><span class="op" id="2966831">*</span><span class="ident" id="2966832">DNSError</span><span class="op" id="2966840">)</span><span class="op" id="2966841">;</span>&nbsp;<span class="ident" id="2966843">ok</span>&nbsp;<span class="op" id="2966846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966850">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966910">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966969">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967030">e</span><span class="op" id="2967031">.</span><span class="ident" id="2967032">Name</span>&nbsp;<span class="op" id="2967037">=</span>&nbsp;<span class="ident" id="2967039">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967048">return</span><br>
<span class="lineno"></span><span class="op" id="2967055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="2967058">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="2967121">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="2967181">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="2967245">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2967306">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="2967369">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="2967381">func</span>&nbsp;<span class="ident" id="2967386">goLookupHost</span><span class="op" id="2967398">(</span><span class="ident" id="2967399">name</span>&nbsp;<span class="builtintype" id="2967404">string</span><span class="op" id="2967410">)</span>&nbsp;<span class="op" id="2967412">(</span><span class="ident" id="2967413">addrs</span>&nbsp;<span class="op" id="2967419">[</span><span class="op" id="2967420">]</span><span class="builtintype" id="2967421">string</span><span class="op" id="2967427">,</span>&nbsp;<span class="ident" id="2967429">err</span>&nbsp;<span class="builtintype" id="2967433">error</span><span class="op" id="2967438">)</span>&nbsp;<span class="op" id="2967440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2967443">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967490">addrs</span>&nbsp;<span class="op" id="2967496">=</span>&nbsp;<span class="ident" id="2967498">lookupStaticHost</span><span class="op" id="2967514">(</span><span class="ident" id="2967515">name</span><span class="op" id="2967519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967522">if</span>&nbsp;<span class="builtinfunc" id="2967525">len</span><span class="op" id="2967528">(</span><span class="ident" id="2967529">addrs</span><span class="op" id="2967534">)</span>&nbsp;<span class="op" id="2967536">&gt;</span>&nbsp;<span class="num" id="2967538">0</span>&nbsp;<span class="op" id="2967540">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967544">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967555">ips</span><span class="op" id="2967558">,</span>&nbsp;<span class="ident" id="2967560">err</span>&nbsp;<span class="op" id="2967564">:=</span>&nbsp;<span class="ident" id="2967567">goLookupIP</span><span class="op" id="2967577">(</span><span class="ident" id="2967578">name</span><span class="op" id="2967582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967585">if</span>&nbsp;<span class="ident" id="2967588">err</span>&nbsp;<span class="op" id="2967592">!=</span>&nbsp;<span class="ident" id="2967595">nil</span>&nbsp;<span class="op" id="2967599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967603">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967614">addrs</span>&nbsp;<span class="op" id="2967620">=</span>&nbsp;<span class="builtinfunc" id="2967622">make</span><span class="op" id="2967626">(</span><span class="op" id="2967627">[</span><span class="op" id="2967628">]</span><span class="builtintype" id="2967629">string</span><span class="op" id="2967635">,</span>&nbsp;<span class="num" id="2967637">0</span><span class="op" id="2967638">,</span>&nbsp;<span class="builtinfunc" id="2967640">len</span><span class="op" id="2967643">(</span><span class="ident" id="2967644">ips</span><span class="op" id="2967647">)</span><span class="op" id="2967648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967651">for</span>&nbsp;<span class="ident" id="2967655">_</span><span class="op" id="2967656">,</span>&nbsp;<span class="ident" id="2967658">ip</span>&nbsp;<span class="op" id="2967661">:=</span>&nbsp;<span class="keyword" id="2967664">range</span>&nbsp;<span class="ident" id="2967670">ips</span>&nbsp;<span class="op" id="2967674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967678">addrs</span>&nbsp;<span class="op" id="2967684">=</span>&nbsp;<span class="builtinfunc" id="2967686">append</span><span class="op" id="2967692">(</span><span class="ident" id="2967693">addrs</span><span class="op" id="2967698">,</span>&nbsp;<span class="ident" id="2967700">ip</span><span class="op" id="2967702">.</span><span class="ident" id="2967703">String</span><span class="op" id="2967709">(</span><span class="op" id="2967710">)</span><span class="op" id="2967711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967714">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967717">return</span><br>
<span class="lineno"></span><span class="op" id="2967724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2967727">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="2967786">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="2967844">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="2967906">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2967967">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="2968030">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="2968042">func</span>&nbsp;<span class="ident" id="2968047">goLookupIP</span><span class="op" id="2968057">(</span><span class="ident" id="2968058">name</span>&nbsp;<span class="builtintype" id="2968063">string</span><span class="op" id="2968069">)</span>&nbsp;<span class="op" id="2968071">(</span><span class="ident" id="2968072">addrs</span>&nbsp;<span class="op" id="2968078">[</span><span class="op" id="2968079">]</span><span class="ident" id="2968080">IP</span><span class="op" id="2968082">,</span>&nbsp;<span class="ident" id="2968084">err</span>&nbsp;<span class="builtintype" id="2968088">error</span><span class="op" id="2968093">)</span>&nbsp;<span class="op" id="2968095">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2968098">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968143">haddrs</span>&nbsp;<span class="op" id="2968150">:=</span>&nbsp;<span class="ident" id="2968153">lookupStaticHost</span><span class="op" id="2968169">(</span><span class="ident" id="2968170">name</span><span class="op" id="2968174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968177">if</span>&nbsp;<span class="builtinfunc" id="2968180">len</span><span class="op" id="2968183">(</span><span class="ident" id="2968184">haddrs</span><span class="op" id="2968190">)</span>&nbsp;<span class="op" id="2968192">&gt;</span>&nbsp;<span class="num" id="2968194">0</span>&nbsp;<span class="op" id="2968196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968200">for</span>&nbsp;<span class="ident" id="2968204">_</span><span class="op" id="2968205">,</span>&nbsp;<span class="ident" id="2968207">haddr</span>&nbsp;<span class="op" id="2968213">:=</span>&nbsp;<span class="keyword" id="2968216">range</span>&nbsp;<span class="ident" id="2968222">haddrs</span>&nbsp;<span class="op" id="2968229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968234">if</span>&nbsp;<span class="ident" id="2968237">ip</span>&nbsp;<span class="op" id="2968240">:=</span>&nbsp;<span class="ident" id="2968243">ParseIP</span><span class="op" id="2968250">(</span><span class="ident" id="2968251">haddr</span><span class="op" id="2968256">)</span><span class="op" id="2968257">;</span>&nbsp;<span class="ident" id="2968259">ip</span>&nbsp;<span class="op" id="2968262">!=</span>&nbsp;<span class="ident" id="2968265">nil</span>&nbsp;<span class="op" id="2968269">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968275">addrs</span>&nbsp;<span class="op" id="2968281">=</span>&nbsp;<span class="builtinfunc" id="2968283">append</span><span class="op" id="2968289">(</span><span class="ident" id="2968290">addrs</span><span class="op" id="2968295">,</span>&nbsp;<span class="ident" id="2968297">ip</span><span class="op" id="2968299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968312">if</span>&nbsp;<span class="builtinfunc" id="2968315">len</span><span class="op" id="2968318">(</span><span class="ident" id="2968319">addrs</span><span class="op" id="2968324">)</span>&nbsp;<span class="op" id="2968326">&gt;</span>&nbsp;<span class="num" id="2968328">0</span>&nbsp;<span class="op" id="2968330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968335">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968350">type</span>&nbsp;<span class="ident" id="2968355">racer</span>&nbsp;<span class="keyword" id="2968361">struct</span>&nbsp;<span class="op" id="2968368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968372">qtype</span>&nbsp;<span class="builtintype" id="2968378">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968387">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2968393">[</span><span class="op" id="2968394">]</span><span class="ident" id="2968395">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2968403">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968413">lane</span>&nbsp;<span class="op" id="2968418">:=</span>&nbsp;<span class="builtinfunc" id="2968421">make</span><span class="op" id="2968425">(</span><span class="keyword" id="2968426">chan</span>&nbsp;<span class="ident" id="2968431">racer</span><span class="op" id="2968436">,</span>&nbsp;<span class="num" id="2968438">1</span><span class="op" id="2968439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968442">qtypes</span>&nbsp;<span class="op" id="2968449">:=</span>&nbsp;<span class="op" id="2968452">[</span><span class="op" id="2968453">...</span><span class="op" id="2968456">]</span><span class="builtintype" id="2968457">uint16</span><span class="op" id="2968463">{</span><span class="ident" id="2968464">dnsTypeA</span><span class="op" id="2968472">,</span>&nbsp;<span class="ident" id="2968474">dnsTypeAAAA</span><span class="op" id="2968485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968488">for</span>&nbsp;<span class="ident" id="2968492">_</span><span class="op" id="2968493">,</span>&nbsp;<span class="ident" id="2968495">qtype</span>&nbsp;<span class="op" id="2968501">:=</span>&nbsp;<span class="keyword" id="2968504">range</span>&nbsp;<span class="ident" id="2968510">qtypes</span>&nbsp;<span class="op" id="2968517">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968521">go</span>&nbsp;<span class="keyword" id="2968524">func</span><span class="op" id="2968528">(</span><span class="ident" id="2968529">qtype</span>&nbsp;<span class="builtintype" id="2968535">uint16</span><span class="op" id="2968541">)</span>&nbsp;<span class="op" id="2968543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968548">_</span><span class="op" id="2968549">,</span>&nbsp;<span class="ident" id="2968551">rrs</span><span class="op" id="2968554">,</span>&nbsp;<span class="ident" id="2968556">err</span>&nbsp;<span class="op" id="2968560">:=</span>&nbsp;<span class="ident" id="2968563">lookup</span><span class="op" id="2968569">(</span><span class="ident" id="2968570">name</span><span class="op" id="2968574">,</span>&nbsp;<span class="ident" id="2968576">qtype</span><span class="op" id="2968581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968586">lane</span>&nbsp;<span class="op" id="2968591">&lt;-</span>&nbsp;<span class="ident" id="2968594">racer</span><span class="op" id="2968599">{</span><span class="ident" id="2968600">qtype</span><span class="op" id="2968605">,</span>&nbsp;<span class="ident" id="2968607">rrs</span><span class="op" id="2968610">,</span>&nbsp;<span class="ident" id="2968612">err</span><span class="op" id="2968615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968619">}</span><span class="op" id="2968620">(</span><span class="ident" id="2968621">qtype</span><span class="op" id="2968626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968629">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968632">var</span>&nbsp;<span class="ident" id="2968636">lastErr</span>&nbsp;<span class="builtintype" id="2968644">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968651">for</span>&nbsp;<span class="keyword" id="2968655">range</span>&nbsp;<span class="ident" id="2968661">qtypes</span>&nbsp;<span class="op" id="2968668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968672">racer</span>&nbsp;<span class="op" id="2968678">:=</span>&nbsp;<span class="op" id="2968681">&lt;-</span><span class="ident" id="2968683">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968690">if</span>&nbsp;<span class="ident" id="2968693">racer</span><span class="op" id="2968698">.</span><span class="builtintype" id="2968699">error</span>&nbsp;<span class="op" id="2968705">!=</span>&nbsp;<span class="ident" id="2968708">nil</span>&nbsp;<span class="op" id="2968712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968717">lastErr</span>&nbsp;<span class="op" id="2968725">=</span>&nbsp;<span class="ident" id="2968727">racer</span><span class="op" id="2968732">.</span><span class="builtintype" id="2968733">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968742">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968757">switch</span>&nbsp;<span class="ident" id="2968764">racer</span><span class="op" id="2968769">.</span><span class="ident" id="2968770">qtype</span>&nbsp;<span class="op" id="2968776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968780">case</span>&nbsp;<span class="ident" id="2968785">dnsTypeA</span><span class="op" id="2968793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968798">addrs</span>&nbsp;<span class="op" id="2968804">=</span>&nbsp;<span class="builtinfunc" id="2968806">append</span><span class="op" id="2968812">(</span><span class="ident" id="2968813">addrs</span><span class="op" id="2968818">,</span>&nbsp;<span class="ident" id="2968820">convertRR_A</span><span class="op" id="2968831">(</span><span class="ident" id="2968832">racer</span><span class="op" id="2968837">.</span><span class="ident" id="2968838">rrs</span><span class="op" id="2968841">)</span><span class="op" id="2968842">...</span><span class="op" id="2968845">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968849">case</span>&nbsp;<span class="ident" id="2968854">dnsTypeAAAA</span><span class="op" id="2968865">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968870">addrs</span>&nbsp;<span class="op" id="2968876">=</span>&nbsp;<span class="builtinfunc" id="2968878">append</span><span class="op" id="2968884">(</span><span class="ident" id="2968885">addrs</span><span class="op" id="2968890">,</span>&nbsp;<span class="ident" id="2968892">convertRR_AAAA</span><span class="op" id="2968906">(</span><span class="ident" id="2968907">racer</span><span class="op" id="2968912">.</span><span class="ident" id="2968913">rrs</span><span class="op" id="2968916">)</span><span class="op" id="2968917">...</span><span class="op" id="2968920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968930">if</span>&nbsp;<span class="builtinfunc" id="2968933">len</span><span class="op" id="2968936">(</span><span class="ident" id="2968937">addrs</span><span class="op" id="2968942">)</span>&nbsp;<span class="op" id="2968944">==</span>&nbsp;<span class="num" id="2968947">0</span>&nbsp;<span class="op" id="2968949">&amp;&amp;</span>&nbsp;<span class="ident" id="2968952">lastErr</span>&nbsp;<span class="op" id="2968960">!=</span>&nbsp;<span class="ident" id="2968963">nil</span>&nbsp;<span class="op" id="2968967">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968971">return</span>&nbsp;<span class="ident" id="2968978">nil</span><span class="op" id="2968981">,</span>&nbsp;<span class="ident" id="2968983">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968995">return</span>&nbsp;<span class="ident" id="2969002">addrs</span><span class="op" id="2969007">,</span>&nbsp;<span class="ident" id="2969009">nil</span><br>
<span class="lineno"></span><span class="op" id="2969013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2969016">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="2969081">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="2969142">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="2969207">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2969268">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="2969331">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="2969343">func</span>&nbsp;<span class="ident" id="2969348">goLookupCNAME</span><span class="op" id="2969361">(</span><span class="ident" id="2969362">name</span>&nbsp;<span class="builtintype" id="2969367">string</span><span class="op" id="2969373">)</span>&nbsp;<span class="op" id="2969375">(</span><span class="ident" id="2969376">cname</span>&nbsp;<span class="builtintype" id="2969382">string</span><span class="op" id="2969388">,</span>&nbsp;<span class="ident" id="2969390">err</span>&nbsp;<span class="builtintype" id="2969394">error</span><span class="op" id="2969399">)</span>&nbsp;<span class="op" id="2969401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2969404">_</span><span class="op" id="2969405">,</span>&nbsp;<span class="ident" id="2969407">rr</span><span class="op" id="2969409">,</span>&nbsp;<span class="ident" id="2969411">err</span>&nbsp;<span class="op" id="2969415">:=</span>&nbsp;<span class="ident" id="2969418">lookup</span><span class="op" id="2969424">(</span><span class="ident" id="2969425">name</span><span class="op" id="2969429">,</span>&nbsp;<span class="ident" id="2969431">dnsTypeCNAME</span><span class="op" id="2969443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2969446">if</span>&nbsp;<span class="ident" id="2969449">err</span>&nbsp;<span class="op" id="2969453">!=</span>&nbsp;<span class="ident" id="2969456">nil</span>&nbsp;<span class="op" id="2969460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2969464">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2969472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2969475">cname</span>&nbsp;<span class="op" id="2969481">=</span>&nbsp;<span class="ident" id="2969483">rr</span><span class="op" id="2969485">[</span><span class="num" id="2969486">0</span><span class="op" id="2969487">]</span><span class="op" id="2969488">.</span><span class="op" id="2969489">(</span><span class="op" id="2969490">*</span><span class="ident" id="2969491">dnsRR_CNAME</span><span class="op" id="2969502">)</span><span class="op" id="2969503">.</span><span class="ident" id="2969504">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2969511">return</span><br>
<span class="lineno"></span><span class="op" id="2969518">}</span>
</div>
</body>
</html>
