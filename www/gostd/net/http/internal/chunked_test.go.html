<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6685221">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6685276">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6685330">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6685381">package</span>&nbsp;<span class="ident" id="6685389">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6685399">import</span>&nbsp;<span class="op" id="6685406">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685409">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685418">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685427">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685434">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685440">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685453">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6685464">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6685474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6685477">func</span>&nbsp;<span class="ident" id="6685482">TestChunk</span><span class="op" id="6685491">(</span><span class="ident" id="6685492">t</span>&nbsp;<span class="op" id="6685494">*</span><span class="ident" id="6685495">testing</span><span class="op" id="6685502">.</span><span class="ident" id="6685503">T</span><span class="op" id="6685504">)</span>&nbsp;<span class="op" id="6685506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685509">var</span>&nbsp;<span class="ident" id="6685513">b</span>&nbsp;<span class="ident" id="6685515">bytes</span><span class="op" id="6685520">.</span><span class="ident" id="6685521">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685530">w</span>&nbsp;<span class="op" id="6685532">:=</span>&nbsp;<span class="ident" id="6685535">NewChunkedWriter</span><span class="op" id="6685551">(</span><span class="op" id="6685552">&amp;</span><span class="ident" id="6685553">b</span><span class="op" id="6685554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685557">const</span>&nbsp;<span class="ident" id="6685563">chunk1</span>&nbsp;<span class="op" id="6685570">=</span>&nbsp;<span class="string" id="6685572">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685583">const</span>&nbsp;<span class="ident" id="6685589">chunk2</span>&nbsp;<span class="op" id="6685596">=</span>&nbsp;<span class="string" id="6685598">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685625">w</span><span class="op" id="6685626">.</span><span class="ident" id="6685627">Write</span><span class="op" id="6685632">(</span><span class="op" id="6685633">[</span><span class="op" id="6685634">]</span><span class="builtintype" id="6685635">byte</span><span class="op" id="6685639">(</span><span class="ident" id="6685640">chunk1</span><span class="op" id="6685646">)</span><span class="op" id="6685647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685650">w</span><span class="op" id="6685651">.</span><span class="ident" id="6685652">Write</span><span class="op" id="6685657">(</span><span class="op" id="6685658">[</span><span class="op" id="6685659">]</span><span class="builtintype" id="6685660">byte</span><span class="op" id="6685664">(</span><span class="ident" id="6685665">chunk2</span><span class="op" id="6685671">)</span><span class="op" id="6685672">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685675">w</span><span class="op" id="6685676">.</span><span class="ident" id="6685677">Close</span><span class="op" id="6685682">(</span><span class="op" id="6685683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685687">if</span>&nbsp;<span class="ident" id="6685690">g</span><span class="op" id="6685691">,</span>&nbsp;<span class="ident" id="6685693">e</span>&nbsp;<span class="op" id="6685695">:=</span>&nbsp;<span class="ident" id="6685698">b</span><span class="op" id="6685699">.</span><span class="ident" id="6685700">String</span><span class="op" id="6685706">(</span><span class="op" id="6685707">)</span><span class="op" id="6685708">,</span>&nbsp;<span class="string" id="6685710">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="6685766">;</span>&nbsp;<span class="ident" id="6685768">g</span>&nbsp;<span class="op" id="6685770">!=</span>&nbsp;<span class="ident" id="6685773">e</span>&nbsp;<span class="op" id="6685775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685779">t</span><span class="op" id="6685780">.</span><span class="ident" id="6685781">Fatalf</span><span class="op" id="6685787">(</span><span class="string" id="6685788">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6685820">,</span>&nbsp;<span class="ident" id="6685822">g</span><span class="op" id="6685823">,</span>&nbsp;<span class="ident" id="6685825">e</span><span class="op" id="6685826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6685829">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685833">r</span>&nbsp;<span class="op" id="6685835">:=</span>&nbsp;<span class="ident" id="6685838">NewChunkedReader</span><span class="op" id="6685854">(</span><span class="op" id="6685855">&amp;</span><span class="ident" id="6685856">b</span><span class="op" id="6685857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685860">data</span><span class="op" id="6685864">,</span>&nbsp;<span class="ident" id="6685866">err</span>&nbsp;<span class="op" id="6685870">:=</span>&nbsp;<span class="ident" id="6685873">ioutil</span><span class="op" id="6685879">.</span><span class="ident" id="6685880">ReadAll</span><span class="op" id="6685887">(</span><span class="ident" id="6685888">r</span><span class="op" id="6685889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685892">if</span>&nbsp;<span class="ident" id="6685895">err</span>&nbsp;<span class="op" id="6685899">!=</span>&nbsp;<span class="ident" id="6685902">nil</span>&nbsp;<span class="op" id="6685906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685910">t</span><span class="op" id="6685911">.</span><span class="ident" id="6685912">Logf</span><span class="op" id="6685916">(</span><span class="string" id="6685917">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="6685929">,</span>&nbsp;<span class="ident" id="6685931">data</span><span class="op" id="6685935">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6685939">t</span><span class="op" id="6685940">.</span><span class="ident" id="6685941">Fatalf</span><span class="op" id="6685947">(</span><span class="string" id="6685948">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="6685973">,</span>&nbsp;<span class="ident" id="6685975">err</span><span class="op" id="6685978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6685981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6685984">if</span>&nbsp;<span class="ident" id="6685987">g</span><span class="op" id="6685988">,</span>&nbsp;<span class="ident" id="6685990">e</span>&nbsp;<span class="op" id="6685992">:=</span>&nbsp;<span class="builtintype" id="6685995">string</span><span class="op" id="6686001">(</span><span class="ident" id="6686002">data</span><span class="op" id="6686006">)</span><span class="op" id="6686007">,</span>&nbsp;<span class="ident" id="6686009">chunk1</span><span class="op" id="6686015">+</span><span class="ident" id="6686016">chunk2</span><span class="op" id="6686022">;</span>&nbsp;<span class="ident" id="6686024">g</span>&nbsp;<span class="op" id="6686026">!=</span>&nbsp;<span class="ident" id="6686029">e</span>&nbsp;<span class="op" id="6686031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686035">t</span><span class="op" id="6686036">.</span><span class="ident" id="6686037">Errorf</span><span class="op" id="6686043">(</span><span class="string" id="6686044">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6686075">,</span>&nbsp;<span class="ident" id="6686077">g</span><span class="op" id="6686078">,</span>&nbsp;<span class="ident" id="6686080">e</span><span class="op" id="6686081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686084">}</span><br>
<span class="lineno">40</span><span class="op" id="6686086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6686089">func</span>&nbsp;<span class="ident" id="6686094">TestChunkReadMultiple</span><span class="op" id="6686115">(</span><span class="ident" id="6686116">t</span>&nbsp;<span class="op" id="6686118">*</span><span class="ident" id="6686119">testing</span><span class="op" id="6686126">.</span><span class="ident" id="6686127">T</span><span class="op" id="6686128">)</span>&nbsp;<span class="op" id="6686130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686133">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686179">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6686183">var</span>&nbsp;<span class="ident" id="6686187">b</span>&nbsp;<span class="ident" id="6686189">bytes</span><span class="op" id="6686194">.</span><span class="ident" id="6686195">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686204">w</span>&nbsp;<span class="op" id="6686206">:=</span>&nbsp;<span class="ident" id="6686209">NewChunkedWriter</span><span class="op" id="6686225">(</span><span class="op" id="6686226">&amp;</span><span class="ident" id="6686227">b</span><span class="op" id="6686228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686232">w</span><span class="op" id="6686233">.</span><span class="ident" id="6686234">Write</span><span class="op" id="6686239">(</span><span class="op" id="6686240">[</span><span class="op" id="6686241">]</span><span class="builtintype" id="6686242">byte</span><span class="op" id="6686246">(</span><span class="string" id="6686247">&#34;foo&#34;</span><span class="op" id="6686252">)</span><span class="op" id="6686253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686257">w</span><span class="op" id="6686258">.</span><span class="ident" id="6686259">Write</span><span class="op" id="6686264">(</span><span class="op" id="6686265">[</span><span class="op" id="6686266">]</span><span class="builtintype" id="6686267">byte</span><span class="op" id="6686271">(</span><span class="string" id="6686272">&#34;bar&#34;</span><span class="op" id="6686277">)</span><span class="op" id="6686278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686282">w</span><span class="op" id="6686283">.</span><span class="ident" id="6686284">Close</span><span class="op" id="6686289">(</span><span class="op" id="6686290">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686295">r</span>&nbsp;<span class="op" id="6686297">:=</span>&nbsp;<span class="ident" id="6686300">NewChunkedReader</span><span class="op" id="6686316">(</span><span class="op" id="6686317">&amp;</span><span class="ident" id="6686318">b</span><span class="op" id="6686319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686323">buf</span>&nbsp;<span class="op" id="6686327">:=</span>&nbsp;<span class="builtinfunc" id="6686330">make</span><span class="op" id="6686334">(</span><span class="op" id="6686335">[</span><span class="op" id="6686336">]</span><span class="builtintype" id="6686337">byte</span><span class="op" id="6686341">,</span>&nbsp;<span class="num" id="6686343">10</span><span class="op" id="6686345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686349">n</span><span class="op" id="6686350">,</span>&nbsp;<span class="ident" id="6686352">err</span>&nbsp;<span class="op" id="6686356">:=</span>&nbsp;<span class="ident" id="6686359">r</span><span class="op" id="6686360">.</span><span class="ident" id="6686361">Read</span><span class="op" id="6686365">(</span><span class="ident" id="6686366">buf</span><span class="op" id="6686369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6686373">if</span>&nbsp;<span class="ident" id="6686376">n</span>&nbsp;<span class="op" id="6686378">!=</span>&nbsp;<span class="num" id="6686381">6</span>&nbsp;<span class="op" id="6686383">||</span>&nbsp;<span class="ident" id="6686386">err</span>&nbsp;<span class="op" id="6686390">!=</span>&nbsp;<span class="ident" id="6686393">io</span><span class="op" id="6686395">.</span><span class="ident" id="6686396">EOF</span>&nbsp;<span class="op" id="6686400">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686405">t</span><span class="op" id="6686406">.</span><span class="ident" id="6686407">Errorf</span><span class="op" id="6686413">(</span><span class="string" id="6686414">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="6686442">,</span>&nbsp;<span class="ident" id="6686444">n</span><span class="op" id="6686445">,</span>&nbsp;<span class="ident" id="6686447">err</span><span class="op" id="6686450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686458">buf</span>&nbsp;<span class="op" id="6686462">=</span>&nbsp;<span class="ident" id="6686464">buf</span><span class="op" id="6686467">[</span><span class="op" id="6686468">:</span><span class="ident" id="6686469">n</span><span class="op" id="6686470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6686474">if</span>&nbsp;<span class="builtintype" id="6686477">string</span><span class="op" id="6686483">(</span><span class="ident" id="6686484">buf</span><span class="op" id="6686487">)</span>&nbsp;<span class="op" id="6686489">!=</span>&nbsp;<span class="string" id="6686492">&#34;foobar&#34;</span>&nbsp;<span class="op" id="6686501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686506">t</span><span class="op" id="6686507">.</span><span class="ident" id="6686508">Errorf</span><span class="op" id="6686514">(</span><span class="string" id="6686515">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6686535">,</span>&nbsp;<span class="ident" id="6686537">buf</span><span class="op" id="6686540">,</span>&nbsp;<span class="string" id="6686542">&#34;foobar&#34;</span><span class="op" id="6686550">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686561">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686639">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6686699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6686703">var</span>&nbsp;<span class="ident" id="6686707">b</span>&nbsp;<span class="ident" id="6686709">bytes</span><span class="op" id="6686714">.</span><span class="ident" id="6686715">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6686724">w</span>&nbsp;<span class="op" id="6686726">:=</span>&nbsp;<span class="ident" id="6686729">NewChunkedWriter</span><span class="op" id="6686745">(</span><span class="op" id="6686746">&amp;</span><span class="ident" id="6686747">b</span><span class="op" id="6686748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686752">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686828">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686895">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6686970">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687033">const</span>&nbsp;<span class="ident" id="6687039">fillBufChunk</span>&nbsp;<span class="op" id="6687052">=</span>&nbsp;<span class="string" id="6687054">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687070">const</span>&nbsp;<span class="ident" id="6687076">shortChunk</span>&nbsp;<span class="op" id="6687087">=</span>&nbsp;<span class="string" id="6687089">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687097">w</span><span class="op" id="6687098">.</span><span class="ident" id="6687099">Write</span><span class="op" id="6687104">(</span><span class="op" id="6687105">[</span><span class="op" id="6687106">]</span><span class="builtintype" id="6687107">byte</span><span class="op" id="6687111">(</span><span class="ident" id="6687112">fillBufChunk</span><span class="op" id="6687124">)</span><span class="op" id="6687125">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687129">w</span><span class="op" id="6687130">.</span><span class="ident" id="6687131">Write</span><span class="op" id="6687136">(</span><span class="op" id="6687137">[</span><span class="op" id="6687138">]</span><span class="builtintype" id="6687139">byte</span><span class="op" id="6687143">(</span><span class="ident" id="6687144">shortChunk</span><span class="op" id="6687154">)</span><span class="op" id="6687155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687159">w</span><span class="op" id="6687160">.</span><span class="ident" id="6687161">Close</span><span class="op" id="6687166">(</span><span class="op" id="6687167">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687172">r</span>&nbsp;<span class="op" id="6687174">:=</span>&nbsp;<span class="ident" id="6687177">NewChunkedReader</span><span class="op" id="6687193">(</span><span class="ident" id="6687194">bufio</span><span class="op" id="6687199">.</span><span class="ident" id="6687200">NewReaderSize</span><span class="op" id="6687213">(</span><span class="op" id="6687214">&amp;</span><span class="ident" id="6687215">b</span><span class="op" id="6687216">,</span>&nbsp;<span class="num" id="6687218">16</span><span class="op" id="6687220">)</span><span class="op" id="6687221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687225">buf</span>&nbsp;<span class="op" id="6687229">:=</span>&nbsp;<span class="builtinfunc" id="6687232">make</span><span class="op" id="6687236">(</span><span class="op" id="6687237">[</span><span class="op" id="6687238">]</span><span class="builtintype" id="6687239">byte</span><span class="op" id="6687243">,</span>&nbsp;<span class="builtinfunc" id="6687245">len</span><span class="op" id="6687248">(</span><span class="ident" id="6687249">fillBufChunk</span><span class="op" id="6687261">)</span><span class="op" id="6687262">+</span><span class="builtinfunc" id="6687263">len</span><span class="op" id="6687266">(</span><span class="ident" id="6687267">shortChunk</span><span class="op" id="6687277">)</span><span class="op" id="6687278">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687282">n</span><span class="op" id="6687283">,</span>&nbsp;<span class="ident" id="6687285">err</span>&nbsp;<span class="op" id="6687289">:=</span>&nbsp;<span class="ident" id="6687292">r</span><span class="op" id="6687293">.</span><span class="ident" id="6687294">Read</span><span class="op" id="6687298">(</span><span class="ident" id="6687299">buf</span><span class="op" id="6687302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687306">if</span>&nbsp;<span class="ident" id="6687309">n</span>&nbsp;<span class="op" id="6687311">!=</span>&nbsp;<span class="builtinfunc" id="6687314">len</span><span class="op" id="6687317">(</span><span class="ident" id="6687318">fillBufChunk</span><span class="op" id="6687330">)</span>&nbsp;<span class="op" id="6687332">||</span>&nbsp;<span class="ident" id="6687335">err</span>&nbsp;<span class="op" id="6687339">!=</span>&nbsp;<span class="ident" id="6687342">nil</span>&nbsp;<span class="op" id="6687346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687351">t</span><span class="op" id="6687352">.</span><span class="ident" id="6687353">Errorf</span><span class="op" id="6687359">(</span><span class="string" id="6687360">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="6687389">,</span>&nbsp;<span class="ident" id="6687391">n</span><span class="op" id="6687392">,</span>&nbsp;<span class="ident" id="6687394">err</span><span class="op" id="6687397">,</span>&nbsp;<span class="builtinfunc" id="6687399">len</span><span class="op" id="6687402">(</span><span class="ident" id="6687403">fillBufChunk</span><span class="op" id="6687415">)</span><span class="op" id="6687416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687424">buf</span>&nbsp;<span class="op" id="6687428">=</span>&nbsp;<span class="ident" id="6687430">buf</span><span class="op" id="6687433">[</span><span class="op" id="6687434">:</span><span class="ident" id="6687435">n</span><span class="op" id="6687436">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687440">if</span>&nbsp;<span class="builtintype" id="6687443">string</span><span class="op" id="6687449">(</span><span class="ident" id="6687450">buf</span><span class="op" id="6687453">)</span>&nbsp;<span class="op" id="6687455">!=</span>&nbsp;<span class="ident" id="6687458">fillBufChunk</span>&nbsp;<span class="op" id="6687471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687476">t</span><span class="op" id="6687477">.</span><span class="ident" id="6687478">Errorf</span><span class="op" id="6687484">(</span><span class="string" id="6687485">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6687505">,</span>&nbsp;<span class="ident" id="6687507">buf</span><span class="op" id="6687510">,</span>&nbsp;<span class="ident" id="6687512">fillBufChunk</span><span class="op" id="6687524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687533">n</span><span class="op" id="6687534">,</span>&nbsp;<span class="ident" id="6687536">err</span>&nbsp;<span class="op" id="6687540">=</span>&nbsp;<span class="ident" id="6687542">r</span><span class="op" id="6687543">.</span><span class="ident" id="6687544">Read</span><span class="op" id="6687548">(</span><span class="ident" id="6687549">buf</span><span class="op" id="6687552">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687556">if</span>&nbsp;<span class="ident" id="6687559">n</span>&nbsp;<span class="op" id="6687561">!=</span>&nbsp;<span class="builtinfunc" id="6687564">len</span><span class="op" id="6687567">(</span><span class="ident" id="6687568">shortChunk</span><span class="op" id="6687578">)</span>&nbsp;<span class="op" id="6687580">||</span>&nbsp;<span class="ident" id="6687583">err</span>&nbsp;<span class="op" id="6687587">!=</span>&nbsp;<span class="ident" id="6687590">io</span><span class="op" id="6687592">.</span><span class="ident" id="6687593">EOF</span>&nbsp;<span class="op" id="6687597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687602">t</span><span class="op" id="6687603">.</span><span class="ident" id="6687604">Errorf</span><span class="op" id="6687610">(</span><span class="string" id="6687611">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="6687640">,</span>&nbsp;<span class="ident" id="6687642">n</span><span class="op" id="6687643">,</span>&nbsp;<span class="ident" id="6687645">err</span><span class="op" id="6687648">,</span>&nbsp;<span class="builtinfunc" id="6687650">len</span><span class="op" id="6687653">(</span><span class="ident" id="6687654">shortChunk</span><span class="op" id="6687664">)</span><span class="op" id="6687665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6687676">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687759">r</span>&nbsp;<span class="op" id="6687761">:=</span>&nbsp;<span class="ident" id="6687764">NewChunkedReader</span><span class="op" id="6687780">(</span><span class="ident" id="6687781">bufio</span><span class="op" id="6687786">.</span><span class="ident" id="6687787">NewReader</span><span class="op" id="6687796">(</span><span class="ident" id="6687797">strings</span><span class="op" id="6687804">.</span><span class="ident" id="6687805">NewReader</span><span class="op" id="6687814">(</span><span class="string" id="6687815">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="6687834">)</span><span class="op" id="6687835">)</span><span class="op" id="6687836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687840">buf</span>&nbsp;<span class="op" id="6687844">:=</span>&nbsp;<span class="builtinfunc" id="6687847">make</span><span class="op" id="6687851">(</span><span class="op" id="6687852">[</span><span class="op" id="6687853">]</span><span class="builtintype" id="6687854">byte</span><span class="op" id="6687858">,</span>&nbsp;<span class="num" id="6687860">3</span><span class="op" id="6687861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687865">n</span><span class="op" id="6687866">,</span>&nbsp;<span class="ident" id="6687868">err</span>&nbsp;<span class="op" id="6687872">:=</span>&nbsp;<span class="ident" id="6687875">r</span><span class="op" id="6687876">.</span><span class="ident" id="6687877">Read</span><span class="op" id="6687881">(</span><span class="ident" id="6687882">buf</span><span class="op" id="6687885">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687889">if</span>&nbsp;<span class="ident" id="6687892">n</span>&nbsp;<span class="op" id="6687894">!=</span>&nbsp;<span class="num" id="6687897">3</span>&nbsp;<span class="op" id="6687899">||</span>&nbsp;<span class="ident" id="6687902">err</span>&nbsp;<span class="op" id="6687906">!=</span>&nbsp;<span class="ident" id="6687909">io</span><span class="op" id="6687911">.</span><span class="ident" id="6687912">EOF</span>&nbsp;<span class="op" id="6687916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6687921">t</span><span class="op" id="6687922">.</span><span class="ident" id="6687923">Errorf</span><span class="op" id="6687929">(</span><span class="string" id="6687930">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="6687958">,</span>&nbsp;<span class="ident" id="6687960">n</span><span class="op" id="6687961">,</span>&nbsp;<span class="ident" id="6687963">err</span><span class="op" id="6687966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6687970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6687974">if</span>&nbsp;<span class="builtintype" id="6687977">string</span><span class="op" id="6687983">(</span><span class="ident" id="6687984">buf</span><span class="op" id="6687987">)</span>&nbsp;<span class="op" id="6687989">!=</span>&nbsp;<span class="string" id="6687992">&#34;foo&#34;</span>&nbsp;<span class="op" id="6687998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688003">t</span><span class="op" id="6688004">.</span><span class="ident" id="6688005">Errorf</span><span class="op" id="6688011">(</span><span class="string" id="6688012">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="6688032">,</span>&nbsp;<span class="ident" id="6688034">buf</span><span class="op" id="6688037">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688044">}</span><br>
<span class="lineno"></span><span class="op" id="6688046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6688049">func</span>&nbsp;<span class="ident" id="6688054">TestChunkReaderAllocs</span><span class="op" id="6688075">(</span><span class="ident" id="6688076">t</span>&nbsp;<span class="op" id="6688078">*</span><span class="ident" id="6688079">testing</span><span class="op" id="6688086">.</span><span class="ident" id="6688087">T</span><span class="op" id="6688088">)</span>&nbsp;<span class="op" id="6688090">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688093">if</span>&nbsp;<span class="ident" id="6688096">testing</span><span class="op" id="6688103">.</span><span class="ident" id="6688104">Short</span><span class="op" id="6688109">(</span><span class="op" id="6688110">)</span>&nbsp;<span class="op" id="6688112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688116">t</span><span class="op" id="6688117">.</span><span class="ident" id="6688118">Skip</span><span class="op" id="6688122">(</span><span class="string" id="6688123">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6688147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688153">var</span>&nbsp;<span class="ident" id="6688157">buf</span>&nbsp;<span class="ident" id="6688161">bytes</span><span class="op" id="6688166">.</span><span class="ident" id="6688167">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688175">w</span>&nbsp;<span class="op" id="6688177">:=</span>&nbsp;<span class="ident" id="6688180">NewChunkedWriter</span><span class="op" id="6688196">(</span><span class="op" id="6688197">&amp;</span><span class="ident" id="6688198">buf</span><span class="op" id="6688201">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688204">a</span><span class="op" id="6688205">,</span>&nbsp;<span class="ident" id="6688207">b</span><span class="op" id="6688208">,</span>&nbsp;<span class="ident" id="6688210">c</span>&nbsp;<span class="op" id="6688212">:=</span>&nbsp;<span class="op" id="6688215">[</span><span class="op" id="6688216">]</span><span class="builtintype" id="6688217">byte</span><span class="op" id="6688221">(</span><span class="string" id="6688222">&#34;aaaaaa&#34;</span><span class="op" id="6688230">)</span><span class="op" id="6688231">,</span>&nbsp;<span class="op" id="6688233">[</span><span class="op" id="6688234">]</span><span class="builtintype" id="6688235">byte</span><span class="op" id="6688239">(</span><span class="string" id="6688240">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="6688254">)</span><span class="op" id="6688255">,</span>&nbsp;<span class="op" id="6688257">[</span><span class="op" id="6688258">]</span><span class="builtintype" id="6688259">byte</span><span class="op" id="6688263">(</span><span class="string" id="6688264">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="6688290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688293">w</span><span class="op" id="6688294">.</span><span class="ident" id="6688295">Write</span><span class="op" id="6688300">(</span><span class="ident" id="6688301">a</span><span class="op" id="6688302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688305">w</span><span class="op" id="6688306">.</span><span class="ident" id="6688307">Write</span><span class="op" id="6688312">(</span><span class="ident" id="6688313">b</span><span class="op" id="6688314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688317">w</span><span class="op" id="6688318">.</span><span class="ident" id="6688319">Write</span><span class="op" id="6688324">(</span><span class="ident" id="6688325">c</span><span class="op" id="6688326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688329">w</span><span class="op" id="6688330">.</span><span class="ident" id="6688331">Close</span><span class="op" id="6688336">(</span><span class="op" id="6688337">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688341">readBuf</span>&nbsp;<span class="op" id="6688349">:=</span>&nbsp;<span class="builtinfunc" id="6688352">make</span><span class="op" id="6688356">(</span><span class="op" id="6688357">[</span><span class="op" id="6688358">]</span><span class="builtintype" id="6688359">byte</span><span class="op" id="6688363">,</span>&nbsp;<span class="builtinfunc" id="6688365">len</span><span class="op" id="6688368">(</span><span class="ident" id="6688369">a</span><span class="op" id="6688370">)</span><span class="op" id="6688371">+</span><span class="builtinfunc" id="6688372">len</span><span class="op" id="6688375">(</span><span class="ident" id="6688376">b</span><span class="op" id="6688377">)</span><span class="op" id="6688378">+</span><span class="builtinfunc" id="6688379">len</span><span class="op" id="6688382">(</span><span class="ident" id="6688383">c</span><span class="op" id="6688384">)</span><span class="op" id="6688385">+</span><span class="num" id="6688386">1</span><span class="op" id="6688387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688390">byter</span>&nbsp;<span class="op" id="6688396">:=</span>&nbsp;<span class="ident" id="6688399">bytes</span><span class="op" id="6688404">.</span><span class="ident" id="6688405">NewReader</span><span class="op" id="6688414">(</span><span class="ident" id="6688415">buf</span><span class="op" id="6688418">.</span><span class="ident" id="6688419">Bytes</span><span class="op" id="6688424">(</span><span class="op" id="6688425">)</span><span class="op" id="6688426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688429">bufr</span>&nbsp;<span class="op" id="6688434">:=</span>&nbsp;<span class="ident" id="6688437">bufio</span><span class="op" id="6688442">.</span><span class="ident" id="6688443">NewReader</span><span class="op" id="6688452">(</span><span class="ident" id="6688453">byter</span><span class="op" id="6688458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688461">mallocs</span>&nbsp;<span class="op" id="6688469">:=</span>&nbsp;<span class="ident" id="6688472">testing</span><span class="op" id="6688479">.</span><span class="ident" id="6688480">AllocsPerRun</span><span class="op" id="6688492">(</span><span class="num" id="6688493">100</span><span class="op" id="6688496">,</span>&nbsp;<span class="keyword" id="6688498">func</span><span class="op" id="6688502">(</span><span class="op" id="6688503">)</span>&nbsp;<span class="op" id="6688505">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688509">byter</span><span class="op" id="6688514">.</span><span class="ident" id="6688515">Seek</span><span class="op" id="6688519">(</span><span class="num" id="6688520">0</span><span class="op" id="6688521">,</span>&nbsp;<span class="num" id="6688523">0</span><span class="op" id="6688524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688528">bufr</span><span class="op" id="6688532">.</span><span class="ident" id="6688533">Reset</span><span class="op" id="6688538">(</span><span class="ident" id="6688539">byter</span><span class="op" id="6688544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688548">r</span>&nbsp;<span class="op" id="6688550">:=</span>&nbsp;<span class="ident" id="6688553">NewChunkedReader</span><span class="op" id="6688569">(</span><span class="ident" id="6688570">bufr</span><span class="op" id="6688574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688578">n</span><span class="op" id="6688579">,</span>&nbsp;<span class="ident" id="6688581">err</span>&nbsp;<span class="op" id="6688585">:=</span>&nbsp;<span class="ident" id="6688588">io</span><span class="op" id="6688590">.</span><span class="ident" id="6688591">ReadFull</span><span class="op" id="6688599">(</span><span class="ident" id="6688600">r</span><span class="op" id="6688601">,</span>&nbsp;<span class="ident" id="6688603">readBuf</span><span class="op" id="6688610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688614">if</span>&nbsp;<span class="ident" id="6688617">n</span>&nbsp;<span class="op" id="6688619">!=</span>&nbsp;<span class="builtinfunc" id="6688622">len</span><span class="op" id="6688625">(</span><span class="ident" id="6688626">readBuf</span><span class="op" id="6688633">)</span><span class="op" id="6688634">-</span><span class="num" id="6688635">1</span>&nbsp;<span class="op" id="6688637">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688642">t</span><span class="op" id="6688643">.</span><span class="ident" id="6688644">Fatalf</span><span class="op" id="6688650">(</span><span class="string" id="6688651">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6688675">,</span>&nbsp;<span class="ident" id="6688677">n</span><span class="op" id="6688678">,</span>&nbsp;<span class="builtinfunc" id="6688680">len</span><span class="op" id="6688683">(</span><span class="ident" id="6688684">readBuf</span><span class="op" id="6688691">)</span><span class="op" id="6688692">-</span><span class="num" id="6688693">1</span><span class="op" id="6688694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688702">if</span>&nbsp;<span class="ident" id="6688705">err</span>&nbsp;<span class="op" id="6688709">!=</span>&nbsp;<span class="ident" id="6688712">io</span><span class="op" id="6688714">.</span><span class="ident" id="6688715">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6688732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688737">t</span><span class="op" id="6688738">.</span><span class="ident" id="6688739">Fatalf</span><span class="op" id="6688745">(</span><span class="string" id="6688746">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="6688786">,</span>&nbsp;<span class="ident" id="6688788">err</span><span class="op" id="6688791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688795">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688798">}</span><span class="op" id="6688799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688802">if</span>&nbsp;<span class="ident" id="6688805">mallocs</span>&nbsp;<span class="op" id="6688813">&gt;</span>&nbsp;<span class="num" id="6688815">1.5</span>&nbsp;<span class="op" id="6688819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688823">t</span><span class="op" id="6688824">.</span><span class="ident" id="6688825">Errorf</span><span class="op" id="6688831">(</span><span class="string" id="6688832">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6688854">,</span>&nbsp;<span class="ident" id="6688856">mallocs</span><span class="op" id="6688863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6688866">}</span><br>
<span class="lineno"></span><span class="op" id="6688868">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6688871">func</span>&nbsp;<span class="ident" id="6688876">TestParseHexUint</span><span class="op" id="6688892">(</span><span class="ident" id="6688893">t</span>&nbsp;<span class="op" id="6688895">*</span><span class="ident" id="6688896">testing</span><span class="op" id="6688903">.</span><span class="ident" id="6688904">T</span><span class="op" id="6688905">)</span>&nbsp;<span class="op" id="6688907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6688910">for</span>&nbsp;<span class="ident" id="6688914">i</span>&nbsp;<span class="op" id="6688916">:=</span>&nbsp;<span class="ident" id="6688919">uint64</span><span class="op" id="6688925">(</span><span class="num" id="6688926">0</span><span class="op" id="6688927">)</span><span class="op" id="6688928">;</span>&nbsp;<span class="ident" id="6688930">i</span>&nbsp;<span class="op" id="6688932">&lt;=</span>&nbsp;<span class="num" id="6688935">1234</span><span class="op" id="6688939">;</span>&nbsp;<span class="ident" id="6688941">i</span><span class="op" id="6688942">++</span>&nbsp;<span class="op" id="6688945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688949">line</span>&nbsp;<span class="op" id="6688954">:=</span>&nbsp;<span class="op" id="6688957">[</span><span class="op" id="6688958">]</span><span class="builtintype" id="6688959">byte</span><span class="op" id="6688963">(</span><span class="ident" id="6688964">fmt</span><span class="op" id="6688967">.</span><span class="ident" id="6688968">Sprintf</span><span class="op" id="6688975">(</span><span class="string" id="6688976">&#34;%x&#34;</span><span class="op" id="6688980">,</span>&nbsp;<span class="ident" id="6688982">i</span><span class="op" id="6688983">)</span><span class="op" id="6688984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6688988">got</span><span class="op" id="6688991">,</span>&nbsp;<span class="ident" id="6688993">err</span>&nbsp;<span class="op" id="6688997">:=</span>&nbsp;<span class="ident" id="6689000">parseHexUint</span><span class="op" id="6689012">(</span><span class="ident" id="6689013">line</span><span class="op" id="6689017">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6689021">if</span>&nbsp;<span class="ident" id="6689024">err</span>&nbsp;<span class="op" id="6689028">!=</span>&nbsp;<span class="ident" id="6689031">nil</span>&nbsp;<span class="op" id="6689035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6689040">t</span><span class="op" id="6689041">.</span><span class="ident" id="6689042">Fatalf</span><span class="op" id="6689048">(</span><span class="string" id="6689049">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6689060">,</span>&nbsp;<span class="ident" id="6689062">i</span><span class="op" id="6689063">,</span>&nbsp;<span class="ident" id="6689065">err</span><span class="op" id="6689068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6689072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6689076">if</span>&nbsp;<span class="ident" id="6689079">got</span>&nbsp;<span class="op" id="6689083">!=</span>&nbsp;<span class="ident" id="6689086">i</span>&nbsp;<span class="op" id="6689088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6689093">t</span><span class="op" id="6689094">.</span><span class="ident" id="6689095">Errorf</span><span class="op" id="6689101">(</span><span class="string" id="6689102">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6689130">,</span>&nbsp;<span class="ident" id="6689132">line</span><span class="op" id="6689136">,</span>&nbsp;<span class="ident" id="6689138">got</span><span class="op" id="6689141">,</span>&nbsp;<span class="ident" id="6689143">i</span><span class="op" id="6689144">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6689148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6689151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6689154">_</span><span class="op" id="6689155">,</span>&nbsp;<span class="ident" id="6689157">err</span>&nbsp;<span class="op" id="6689161">:=</span>&nbsp;<span class="ident" id="6689164">parseHexUint</span><span class="op" id="6689176">(</span><span class="op" id="6689177">[</span><span class="op" id="6689178">]</span><span class="builtintype" id="6689179">byte</span><span class="op" id="6689183">(</span><span class="string" id="6689184">&#34;bogus&#34;</span><span class="op" id="6689191">)</span><span class="op" id="6689192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6689195">if</span>&nbsp;<span class="ident" id="6689198">err</span>&nbsp;<span class="op" id="6689202">==</span>&nbsp;<span class="ident" id="6689205">nil</span>&nbsp;<span class="op" id="6689209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6689213">t</span><span class="op" id="6689214">.</span><span class="ident" id="6689215">Error</span><span class="op" id="6689220">(</span><span class="string" id="6689221">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="6689252">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6689255">}</span><br>
<span class="lineno"></span><span class="op" id="6689257">}</span>
</div>
</body>
</html>
