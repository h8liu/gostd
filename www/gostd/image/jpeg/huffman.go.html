<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5649324">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5649379">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5649433">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5649484">package</span>&nbsp;<span class="ident" id="5649492">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5649498">import</span>&nbsp;<span class="op" id="5649505">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5649508">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5649513">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5649516">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5649594">const</span>&nbsp;<span class="ident" id="5649600">maxCodeLength</span>&nbsp;<span class="op" id="5649614">=</span>&nbsp;<span class="num" id="5649616">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5649620">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5649695">const</span>&nbsp;<span class="ident" id="5649701">maxNCodes</span>&nbsp;<span class="op" id="5649711">=</span>&nbsp;<span class="num" id="5649713">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5649718">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5649787">const</span>&nbsp;<span class="ident" id="5649793">lutSize</span>&nbsp;<span class="op" id="5649801">=</span>&nbsp;<span class="num" id="5649803">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5649806">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5649863">type</span>&nbsp;<span class="ident" id="5649868">huffman</span>&nbsp;<span class="keyword" id="5649876">struct</span>&nbsp;<span class="op" id="5649883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5649886">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5649933">nCodes</span>&nbsp;<span class="builtintype" id="5649940">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5649947">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650021">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650093">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650166">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5650184">lut</span>&nbsp;<span class="op" id="5650188">[</span><span class="num" id="5650189">1</span>&nbsp;<span class="op" id="5650191">&lt;&lt;</span>&nbsp;<span class="ident" id="5650194">lutSize</span><span class="op" id="5650201">]</span><span class="builtintype" id="5650202">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650210">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5650269">vals</span>&nbsp;<span class="op" id="5650274">[</span><span class="ident" id="5650275">maxNCodes</span><span class="op" id="5650284">]</span><span class="builtintype" id="5650285">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650292">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650363">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5650389">minCodes</span>&nbsp;<span class="op" id="5650398">[</span><span class="ident" id="5650399">maxCodeLength</span><span class="op" id="5650412">]</span><span class="builtintype" id="5650413">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650420">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650491">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5650517">maxCodes</span>&nbsp;<span class="op" id="5650526">[</span><span class="ident" id="5650527">maxCodeLength</span><span class="op" id="5650540">]</span><span class="builtintype" id="5650541">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5650548">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5650606">valsIndices</span>&nbsp;<span class="op" id="5650618">[</span><span class="ident" id="5650619">maxCodeLength</span><span class="op" id="5650632">]</span><span class="builtintype" id="5650633">int32</span><br>
<span class="lineno"></span><span class="op" id="5650639">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5650642">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5650718">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5650735">var</span>&nbsp;<span class="ident" id="5650739">errShortHuffmanData</span>&nbsp;<span class="op" id="5650759">=</span>&nbsp;<span class="ident" id="5650761">FormatError</span><span class="op" id="5650772">(</span><span class="string" id="5650773">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5650793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5650796">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5650874">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5650951">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5651026">func</span>&nbsp;<span class="op" id="5651031">(</span><span class="ident" id="5651032">d</span>&nbsp;<span class="op" id="5651034">*</span><span class="ident" id="5651035">decoder</span><span class="op" id="5651042">)</span>&nbsp;<span class="ident" id="5651044">ensureNBits</span><span class="op" id="5651055">(</span><span class="ident" id="5651056">n</span>&nbsp;<span class="builtintype" id="5651058">int32</span><span class="op" id="5651063">)</span>&nbsp;<span class="builtintype" id="5651065">error</span>&nbsp;<span class="op" id="5651071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651074">for</span>&nbsp;<span class="op" id="5651078">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651082">c</span><span class="op" id="5651083">,</span>&nbsp;<span class="ident" id="5651085">err</span>&nbsp;<span class="op" id="5651089">:=</span>&nbsp;<span class="ident" id="5651092">d</span><span class="op" id="5651093">.</span><span class="ident" id="5651094">readByteStuffedByte</span><span class="op" id="5651113">(</span><span class="op" id="5651114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651118">if</span>&nbsp;<span class="ident" id="5651121">err</span>&nbsp;<span class="op" id="5651125">!=</span>&nbsp;<span class="ident" id="5651128">nil</span>&nbsp;<span class="op" id="5651132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651137">if</span>&nbsp;<span class="ident" id="5651140">err</span>&nbsp;<span class="op" id="5651144">==</span>&nbsp;<span class="ident" id="5651147">io</span><span class="op" id="5651149">.</span><span class="ident" id="5651150">EOF</span>&nbsp;<span class="op" id="5651154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651160">return</span>&nbsp;<span class="ident" id="5651167">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651190">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651195">return</span>&nbsp;<span class="ident" id="5651202">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651212">d</span><span class="op" id="5651213">.</span><span class="ident" id="5651214">bits</span><span class="op" id="5651218">.</span><span class="ident" id="5651219">a</span>&nbsp;<span class="op" id="5651221">=</span>&nbsp;<span class="ident" id="5651223">d</span><span class="op" id="5651224">.</span><span class="ident" id="5651225">bits</span><span class="op" id="5651229">.</span><span class="ident" id="5651230">a</span><span class="op" id="5651231">&lt;&lt;</span><span class="num" id="5651233">8</span>&nbsp;<span class="op" id="5651235">|</span>&nbsp;<span class="builtintype" id="5651237">uint32</span><span class="op" id="5651243">(</span><span class="ident" id="5651244">c</span><span class="op" id="5651245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651249">d</span><span class="op" id="5651250">.</span><span class="ident" id="5651251">bits</span><span class="op" id="5651255">.</span><span class="ident" id="5651256">n</span>&nbsp;<span class="op" id="5651258">+=</span>&nbsp;<span class="num" id="5651261">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651265">if</span>&nbsp;<span class="ident" id="5651268">d</span><span class="op" id="5651269">.</span><span class="ident" id="5651270">bits</span><span class="op" id="5651274">.</span><span class="ident" id="5651275">m</span>&nbsp;<span class="op" id="5651277">==</span>&nbsp;<span class="num" id="5651280">0</span>&nbsp;<span class="op" id="5651282">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651287">d</span><span class="op" id="5651288">.</span><span class="ident" id="5651289">bits</span><span class="op" id="5651293">.</span><span class="ident" id="5651294">m</span>&nbsp;<span class="op" id="5651296">=</span>&nbsp;<span class="num" id="5651298">1</span>&nbsp;<span class="op" id="5651300">&lt;&lt;</span>&nbsp;<span class="num" id="5651303">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651307">}</span>&nbsp;<span class="keyword" id="5651309">else</span>&nbsp;<span class="op" id="5651314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651319">d</span><span class="op" id="5651320">.</span><span class="ident" id="5651321">bits</span><span class="op" id="5651325">.</span><span class="ident" id="5651326">m</span>&nbsp;<span class="op" id="5651328">&lt;&lt;=</span>&nbsp;<span class="num" id="5651332">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651340">if</span>&nbsp;<span class="ident" id="5651343">d</span><span class="op" id="5651344">.</span><span class="ident" id="5651345">bits</span><span class="op" id="5651349">.</span><span class="ident" id="5651350">n</span>&nbsp;<span class="op" id="5651352">&gt;=</span>&nbsp;<span class="ident" id="5651355">n</span>&nbsp;<span class="op" id="5651357">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651362">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651376">return</span>&nbsp;<span class="ident" id="5651383">nil</span><br>
<span class="lineno"></span><span class="op" id="5651387">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5651390">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5651470">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5651482">func</span>&nbsp;<span class="op" id="5651487">(</span><span class="ident" id="5651488">d</span>&nbsp;<span class="op" id="5651490">*</span><span class="ident" id="5651491">decoder</span><span class="op" id="5651498">)</span>&nbsp;<span class="ident" id="5651500">receiveExtend</span><span class="op" id="5651513">(</span><span class="ident" id="5651514">t</span>&nbsp;<span class="builtintype" id="5651516">uint8</span><span class="op" id="5651521">)</span>&nbsp;<span class="op" id="5651523">(</span><span class="builtintype" id="5651524">int32</span><span class="op" id="5651529">,</span>&nbsp;<span class="builtintype" id="5651531">error</span><span class="op" id="5651536">)</span>&nbsp;<span class="op" id="5651538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651541">if</span>&nbsp;<span class="ident" id="5651544">d</span><span class="op" id="5651545">.</span><span class="ident" id="5651546">bits</span><span class="op" id="5651550">.</span><span class="ident" id="5651551">n</span>&nbsp;<span class="op" id="5651553">&lt;</span>&nbsp;<span class="builtintype" id="5651555">int32</span><span class="op" id="5651560">(</span><span class="ident" id="5651561">t</span><span class="op" id="5651562">)</span>&nbsp;<span class="op" id="5651564">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651568">if</span>&nbsp;<span class="ident" id="5651571">err</span>&nbsp;<span class="op" id="5651575">:=</span>&nbsp;<span class="ident" id="5651578">d</span><span class="op" id="5651579">.</span><span class="ident" id="5651580">ensureNBits</span><span class="op" id="5651591">(</span><span class="builtintype" id="5651592">int32</span><span class="op" id="5651597">(</span><span class="ident" id="5651598">t</span><span class="op" id="5651599">)</span><span class="op" id="5651600">)</span><span class="op" id="5651601">;</span>&nbsp;<span class="ident" id="5651603">err</span>&nbsp;<span class="op" id="5651607">!=</span>&nbsp;<span class="ident" id="5651610">nil</span>&nbsp;<span class="op" id="5651614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651619">return</span>&nbsp;<span class="num" id="5651626">0</span><span class="op" id="5651627">,</span>&nbsp;<span class="ident" id="5651629">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651641">d</span><span class="op" id="5651642">.</span><span class="ident" id="5651643">bits</span><span class="op" id="5651647">.</span><span class="ident" id="5651648">n</span>&nbsp;<span class="op" id="5651650">-=</span>&nbsp;<span class="builtintype" id="5651653">int32</span><span class="op" id="5651658">(</span><span class="ident" id="5651659">t</span><span class="op" id="5651660">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651663">d</span><span class="op" id="5651664">.</span><span class="ident" id="5651665">bits</span><span class="op" id="5651669">.</span><span class="ident" id="5651670">m</span>&nbsp;<span class="op" id="5651672">&gt;&gt;=</span>&nbsp;<span class="ident" id="5651676">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651679">s</span>&nbsp;<span class="op" id="5651681">:=</span>&nbsp;<span class="builtintype" id="5651684">int32</span><span class="op" id="5651689">(</span><span class="num" id="5651690">1</span><span class="op" id="5651691">)</span>&nbsp;<span class="op" id="5651693">&lt;&lt;</span>&nbsp;<span class="ident" id="5651696">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651699">x</span>&nbsp;<span class="op" id="5651701">:=</span>&nbsp;<span class="builtintype" id="5651704">int32</span><span class="op" id="5651709">(</span><span class="ident" id="5651710">d</span><span class="op" id="5651711">.</span><span class="ident" id="5651712">bits</span><span class="op" id="5651716">.</span><span class="ident" id="5651717">a</span><span class="op" id="5651718">&gt;&gt;</span><span class="builtintype" id="5651720">uint8</span><span class="op" id="5651725">(</span><span class="ident" id="5651726">d</span><span class="op" id="5651727">.</span><span class="ident" id="5651728">bits</span><span class="op" id="5651732">.</span><span class="ident" id="5651733">n</span><span class="op" id="5651734">)</span><span class="op" id="5651735">)</span>&nbsp;<span class="op" id="5651737">&amp;</span>&nbsp;<span class="op" id="5651739">(</span><span class="ident" id="5651740">s</span>&nbsp;<span class="op" id="5651742">-</span>&nbsp;<span class="num" id="5651744">1</span><span class="op" id="5651745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651748">if</span>&nbsp;<span class="ident" id="5651751">x</span>&nbsp;<span class="op" id="5651753">&lt;</span>&nbsp;<span class="ident" id="5651755">s</span><span class="op" id="5651756">&gt;&gt;</span><span class="num" id="5651758">1</span>&nbsp;<span class="op" id="5651760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5651764">x</span>&nbsp;<span class="op" id="5651766">+=</span>&nbsp;<span class="op" id="5651769">(</span><span class="op" id="5651770">(</span><span class="op" id="5651771">-</span><span class="num" id="5651772">1</span><span class="op" id="5651773">)</span>&nbsp;<span class="op" id="5651775">&lt;&lt;</span>&nbsp;<span class="ident" id="5651778">t</span><span class="op" id="5651779">)</span>&nbsp;<span class="op" id="5651781">+</span>&nbsp;<span class="num" id="5651783">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5651786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651789">return</span>&nbsp;<span class="ident" id="5651796">x</span><span class="op" id="5651797">,</span>&nbsp;<span class="ident" id="5651799">nil</span><br>
<span class="lineno"></span><span class="op" id="5651803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5651806">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5651887">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5651946">func</span>&nbsp;<span class="op" id="5651951">(</span><span class="ident" id="5651952">d</span>&nbsp;<span class="op" id="5651954">*</span><span class="ident" id="5651955">decoder</span><span class="op" id="5651962">)</span>&nbsp;<span class="ident" id="5651964">processDHT</span><span class="op" id="5651974">(</span><span class="ident" id="5651975">n</span>&nbsp;<span class="builtintype" id="5651977">int</span><span class="op" id="5651980">)</span>&nbsp;<span class="builtintype" id="5651982">error</span>&nbsp;<span class="op" id="5651988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5651991">for</span>&nbsp;<span class="ident" id="5651995">n</span>&nbsp;<span class="op" id="5651997">&gt;</span>&nbsp;<span class="num" id="5651999">0</span>&nbsp;<span class="op" id="5652001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652005">if</span>&nbsp;<span class="ident" id="5652008">n</span>&nbsp;<span class="op" id="5652010">&lt;</span>&nbsp;<span class="num" id="5652012">17</span>&nbsp;<span class="op" id="5652015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652020">return</span>&nbsp;<span class="ident" id="5652027">FormatError</span><span class="op" id="5652038">(</span><span class="string" id="5652039">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5652061">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652069">if</span>&nbsp;<span class="ident" id="5652072">err</span>&nbsp;<span class="op" id="5652076">:=</span>&nbsp;<span class="ident" id="5652079">d</span><span class="op" id="5652080">.</span><span class="ident" id="5652081">readFull</span><span class="op" id="5652089">(</span><span class="ident" id="5652090">d</span><span class="op" id="5652091">.</span><span class="ident" id="5652092">tmp</span><span class="op" id="5652095">[</span><span class="op" id="5652096">:</span><span class="num" id="5652097">17</span><span class="op" id="5652099">]</span><span class="op" id="5652100">)</span><span class="op" id="5652101">;</span>&nbsp;<span class="ident" id="5652103">err</span>&nbsp;<span class="op" id="5652107">!=</span>&nbsp;<span class="ident" id="5652110">nil</span>&nbsp;<span class="op" id="5652114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652119">return</span>&nbsp;<span class="ident" id="5652126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652136">tc</span>&nbsp;<span class="op" id="5652139">:=</span>&nbsp;<span class="ident" id="5652142">d</span><span class="op" id="5652143">.</span><span class="ident" id="5652144">tmp</span><span class="op" id="5652147">[</span><span class="num" id="5652148">0</span><span class="op" id="5652149">]</span>&nbsp;<span class="op" id="5652151">&gt;&gt;</span>&nbsp;<span class="num" id="5652154">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652158">if</span>&nbsp;<span class="ident" id="5652161">tc</span>&nbsp;<span class="op" id="5652164">&gt;</span>&nbsp;<span class="ident" id="5652166">maxTc</span>&nbsp;<span class="op" id="5652172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652177">return</span>&nbsp;<span class="ident" id="5652184">FormatError</span><span class="op" id="5652195">(</span><span class="string" id="5652196">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5652210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652218">th</span>&nbsp;<span class="op" id="5652221">:=</span>&nbsp;<span class="ident" id="5652224">d</span><span class="op" id="5652225">.</span><span class="ident" id="5652226">tmp</span><span class="op" id="5652229">[</span><span class="num" id="5652230">0</span><span class="op" id="5652231">]</span>&nbsp;<span class="op" id="5652233">&amp;</span>&nbsp;<span class="num" id="5652235">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652242">if</span>&nbsp;<span class="ident" id="5652245">th</span>&nbsp;<span class="op" id="5652248">&gt;</span>&nbsp;<span class="ident" id="5652250">maxTh</span>&nbsp;<span class="op" id="5652256">||</span>&nbsp;<span class="op" id="5652259">!</span><span class="ident" id="5652260">d</span><span class="op" id="5652261">.</span><span class="ident" id="5652262">progressive</span>&nbsp;<span class="op" id="5652274">&amp;&amp;</span>&nbsp;<span class="ident" id="5652277">th</span>&nbsp;<span class="op" id="5652280">&gt;</span>&nbsp;<span class="num" id="5652282">1</span>&nbsp;<span class="op" id="5652284">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652289">return</span>&nbsp;<span class="ident" id="5652296">FormatError</span><span class="op" id="5652307">(</span><span class="string" id="5652308">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5652322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652330">h</span>&nbsp;<span class="op" id="5652332">:=</span>&nbsp;<span class="op" id="5652335">&amp;</span><span class="ident" id="5652336">d</span><span class="op" id="5652337">.</span><span class="ident" id="5652338">huff</span><span class="op" id="5652342">[</span><span class="ident" id="5652343">tc</span><span class="op" id="5652345">]</span><span class="op" id="5652346">[</span><span class="ident" id="5652347">th</span><span class="op" id="5652349">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5652354">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5652405">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5652463">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652507">h</span><span class="op" id="5652508">.</span><span class="ident" id="5652509">nCodes</span>&nbsp;<span class="op" id="5652516">=</span>&nbsp;<span class="num" id="5652518">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652522">var</span>&nbsp;<span class="ident" id="5652526">nCodes</span>&nbsp;<span class="op" id="5652533">[</span><span class="ident" id="5652534">maxCodeLength</span><span class="op" id="5652547">]</span><span class="builtintype" id="5652548">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652556">for</span>&nbsp;<span class="ident" id="5652560">i</span>&nbsp;<span class="op" id="5652562">:=</span>&nbsp;<span class="keyword" id="5652565">range</span>&nbsp;<span class="ident" id="5652571">nCodes</span>&nbsp;<span class="op" id="5652578">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652583">nCodes</span><span class="op" id="5652589">[</span><span class="ident" id="5652590">i</span><span class="op" id="5652591">]</span>&nbsp;<span class="op" id="5652593">=</span>&nbsp;<span class="builtintype" id="5652595">int32</span><span class="op" id="5652600">(</span><span class="ident" id="5652601">d</span><span class="op" id="5652602">.</span><span class="ident" id="5652603">tmp</span><span class="op" id="5652606">[</span><span class="ident" id="5652607">i</span><span class="op" id="5652608">+</span><span class="num" id="5652609">1</span><span class="op" id="5652610">]</span><span class="op" id="5652611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652616">h</span><span class="op" id="5652617">.</span><span class="ident" id="5652618">nCodes</span>&nbsp;<span class="op" id="5652625">+=</span>&nbsp;<span class="ident" id="5652628">nCodes</span><span class="op" id="5652634">[</span><span class="ident" id="5652635">i</span><span class="op" id="5652636">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652644">if</span>&nbsp;<span class="ident" id="5652647">h</span><span class="op" id="5652648">.</span><span class="ident" id="5652649">nCodes</span>&nbsp;<span class="op" id="5652656">==</span>&nbsp;<span class="num" id="5652659">0</span>&nbsp;<span class="op" id="5652661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652666">return</span>&nbsp;<span class="ident" id="5652673">FormatError</span><span class="op" id="5652684">(</span><span class="string" id="5652685">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5652716">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652724">if</span>&nbsp;<span class="ident" id="5652727">h</span><span class="op" id="5652728">.</span><span class="ident" id="5652729">nCodes</span>&nbsp;<span class="op" id="5652736">&gt;</span>&nbsp;<span class="ident" id="5652738">maxNCodes</span>&nbsp;<span class="op" id="5652748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652753">return</span>&nbsp;<span class="ident" id="5652760">FormatError</span><span class="op" id="5652771">(</span><span class="string" id="5652772">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5652808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5652816">n</span>&nbsp;<span class="op" id="5652818">-=</span>&nbsp;<span class="builtintype" id="5652821">int</span><span class="op" id="5652824">(</span><span class="ident" id="5652825">h</span><span class="op" id="5652826">.</span><span class="ident" id="5652827">nCodes</span><span class="op" id="5652833">)</span>&nbsp;<span class="op" id="5652835">+</span>&nbsp;<span class="num" id="5652837">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652842">if</span>&nbsp;<span class="ident" id="5652845">n</span>&nbsp;<span class="op" id="5652847">&lt;</span>&nbsp;<span class="num" id="5652849">0</span>&nbsp;<span class="op" id="5652851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652856">return</span>&nbsp;<span class="ident" id="5652863">FormatError</span><span class="op" id="5652874">(</span><span class="string" id="5652875">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5652897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652905">if</span>&nbsp;<span class="ident" id="5652908">err</span>&nbsp;<span class="op" id="5652912">:=</span>&nbsp;<span class="ident" id="5652915">d</span><span class="op" id="5652916">.</span><span class="ident" id="5652917">readFull</span><span class="op" id="5652925">(</span><span class="ident" id="5652926">h</span><span class="op" id="5652927">.</span><span class="ident" id="5652928">vals</span><span class="op" id="5652932">[</span><span class="op" id="5652933">:</span><span class="ident" id="5652934">h</span><span class="op" id="5652935">.</span><span class="ident" id="5652936">nCodes</span><span class="op" id="5652942">]</span><span class="op" id="5652943">)</span><span class="op" id="5652944">;</span>&nbsp;<span class="ident" id="5652946">err</span>&nbsp;<span class="op" id="5652950">!=</span>&nbsp;<span class="ident" id="5652953">nil</span>&nbsp;<span class="op" id="5652957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5652962">return</span>&nbsp;<span class="ident" id="5652969">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5652975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5652980">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653011">for</span>&nbsp;<span class="ident" id="5653015">i</span>&nbsp;<span class="op" id="5653017">:=</span>&nbsp;<span class="keyword" id="5653020">range</span>&nbsp;<span class="ident" id="5653026">h</span><span class="op" id="5653027">.</span><span class="ident" id="5653028">lut</span>&nbsp;<span class="op" id="5653032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653037">h</span><span class="op" id="5653038">.</span><span class="ident" id="5653039">lut</span><span class="op" id="5653042">[</span><span class="ident" id="5653043">i</span><span class="op" id="5653044">]</span>&nbsp;<span class="op" id="5653046">=</span>&nbsp;<span class="num" id="5653048">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653056">var</span>&nbsp;<span class="ident" id="5653060">x</span><span class="op" id="5653061">,</span>&nbsp;<span class="ident" id="5653063">code</span>&nbsp;<span class="builtintype" id="5653068">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653077">for</span>&nbsp;<span class="ident" id="5653081">i</span>&nbsp;<span class="op" id="5653083">:=</span>&nbsp;<span class="builtintype" id="5653086">uint32</span><span class="op" id="5653092">(</span><span class="num" id="5653093">0</span><span class="op" id="5653094">)</span><span class="op" id="5653095">;</span>&nbsp;<span class="ident" id="5653097">i</span>&nbsp;<span class="op" id="5653099">&lt;</span>&nbsp;<span class="ident" id="5653101">lutSize</span><span class="op" id="5653108">;</span>&nbsp;<span class="ident" id="5653110">i</span><span class="op" id="5653111">++</span>&nbsp;<span class="op" id="5653114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653119">code</span>&nbsp;<span class="op" id="5653124">&lt;&lt;=</span>&nbsp;<span class="num" id="5653128">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653133">for</span>&nbsp;<span class="ident" id="5653137">j</span>&nbsp;<span class="op" id="5653139">:=</span>&nbsp;<span class="builtintype" id="5653142">int32</span><span class="op" id="5653147">(</span><span class="num" id="5653148">0</span><span class="op" id="5653149">)</span><span class="op" id="5653150">;</span>&nbsp;<span class="ident" id="5653152">j</span>&nbsp;<span class="op" id="5653154">&lt;</span>&nbsp;<span class="ident" id="5653156">nCodes</span><span class="op" id="5653162">[</span><span class="ident" id="5653163">i</span><span class="op" id="5653164">]</span><span class="op" id="5653165">;</span>&nbsp;<span class="ident" id="5653167">j</span><span class="op" id="5653168">++</span>&nbsp;<span class="op" id="5653171">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653177">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653235">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653291">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653341">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653399">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653448">base</span>&nbsp;<span class="op" id="5653453">:=</span>&nbsp;<span class="builtintype" id="5653456">uint8</span><span class="op" id="5653461">(</span><span class="ident" id="5653462">code</span>&nbsp;<span class="op" id="5653467">&lt;&lt;</span>&nbsp;<span class="op" id="5653470">(</span><span class="num" id="5653471">7</span>&nbsp;<span class="op" id="5653473">-</span>&nbsp;<span class="ident" id="5653475">i</span><span class="op" id="5653476">)</span><span class="op" id="5653477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653483">lutValue</span>&nbsp;<span class="op" id="5653492">:=</span>&nbsp;<span class="builtintype" id="5653495">uint16</span><span class="op" id="5653501">(</span><span class="ident" id="5653502">h</span><span class="op" id="5653503">.</span><span class="ident" id="5653504">vals</span><span class="op" id="5653508">[</span><span class="ident" id="5653509">x</span><span class="op" id="5653510">]</span><span class="op" id="5653511">)</span><span class="op" id="5653512">&lt;&lt;</span><span class="num" id="5653514">8</span>&nbsp;<span class="op" id="5653516">|</span>&nbsp;<span class="builtintype" id="5653518">uint16</span><span class="op" id="5653524">(</span><span class="num" id="5653525">2</span><span class="op" id="5653526">+</span><span class="ident" id="5653527">i</span><span class="op" id="5653528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653534">for</span>&nbsp;<span class="ident" id="5653538">k</span>&nbsp;<span class="op" id="5653540">:=</span>&nbsp;<span class="builtintype" id="5653543">uint8</span><span class="op" id="5653548">(</span><span class="num" id="5653549">0</span><span class="op" id="5653550">)</span><span class="op" id="5653551">;</span>&nbsp;<span class="ident" id="5653553">k</span>&nbsp;<span class="op" id="5653555">&lt;</span>&nbsp;<span class="num" id="5653557">1</span><span class="op" id="5653558">&lt;&lt;</span><span class="op" id="5653560">(</span><span class="num" id="5653561">7</span><span class="op" id="5653562">-</span><span class="ident" id="5653563">i</span><span class="op" id="5653564">)</span><span class="op" id="5653565">;</span>&nbsp;<span class="ident" id="5653567">k</span><span class="op" id="5653568">++</span>&nbsp;<span class="op" id="5653571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653578">h</span><span class="op" id="5653579">.</span><span class="ident" id="5653580">lut</span><span class="op" id="5653583">[</span><span class="ident" id="5653584">base</span><span class="op" id="5653588">|</span><span class="ident" id="5653589">k</span><span class="op" id="5653590">]</span>&nbsp;<span class="op" id="5653592">=</span>&nbsp;<span class="ident" id="5653594">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653607">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653613">code</span><span class="op" id="5653617">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653624">x</span><span class="op" id="5653625">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5653640">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653689">var</span>&nbsp;<span class="ident" id="5653693">c</span><span class="op" id="5653694">,</span>&nbsp;<span class="ident" id="5653696">index</span>&nbsp;<span class="builtintype" id="5653702">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653710">for</span>&nbsp;<span class="ident" id="5653714">i</span><span class="op" id="5653715">,</span>&nbsp;<span class="ident" id="5653717">n</span>&nbsp;<span class="op" id="5653719">:=</span>&nbsp;<span class="keyword" id="5653722">range</span>&nbsp;<span class="ident" id="5653728">nCodes</span>&nbsp;<span class="op" id="5653735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653740">if</span>&nbsp;<span class="ident" id="5653743">n</span>&nbsp;<span class="op" id="5653745">==</span>&nbsp;<span class="num" id="5653748">0</span>&nbsp;<span class="op" id="5653750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653756">h</span><span class="op" id="5653757">.</span><span class="ident" id="5653758">minCodes</span><span class="op" id="5653766">[</span><span class="ident" id="5653767">i</span><span class="op" id="5653768">]</span>&nbsp;<span class="op" id="5653770">=</span>&nbsp;<span class="op" id="5653772">-</span><span class="num" id="5653773">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653779">h</span><span class="op" id="5653780">.</span><span class="ident" id="5653781">maxCodes</span><span class="op" id="5653789">[</span><span class="ident" id="5653790">i</span><span class="op" id="5653791">]</span>&nbsp;<span class="op" id="5653793">=</span>&nbsp;<span class="op" id="5653795">-</span><span class="num" id="5653796">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653802">h</span><span class="op" id="5653803">.</span><span class="ident" id="5653804">valsIndices</span><span class="op" id="5653815">[</span><span class="ident" id="5653816">i</span><span class="op" id="5653817">]</span>&nbsp;<span class="op" id="5653819">=</span>&nbsp;<span class="op" id="5653821">-</span><span class="num" id="5653822">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653827">}</span>&nbsp;<span class="keyword" id="5653829">else</span>&nbsp;<span class="op" id="5653834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653840">h</span><span class="op" id="5653841">.</span><span class="ident" id="5653842">minCodes</span><span class="op" id="5653850">[</span><span class="ident" id="5653851">i</span><span class="op" id="5653852">]</span>&nbsp;<span class="op" id="5653854">=</span>&nbsp;<span class="ident" id="5653856">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653862">h</span><span class="op" id="5653863">.</span><span class="ident" id="5653864">maxCodes</span><span class="op" id="5653872">[</span><span class="ident" id="5653873">i</span><span class="op" id="5653874">]</span>&nbsp;<span class="op" id="5653876">=</span>&nbsp;<span class="ident" id="5653878">c</span>&nbsp;<span class="op" id="5653880">+</span>&nbsp;<span class="ident" id="5653882">n</span>&nbsp;<span class="op" id="5653884">-</span>&nbsp;<span class="num" id="5653886">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653892">h</span><span class="op" id="5653893">.</span><span class="ident" id="5653894">valsIndices</span><span class="op" id="5653905">[</span><span class="ident" id="5653906">i</span><span class="op" id="5653907">]</span>&nbsp;<span class="op" id="5653909">=</span>&nbsp;<span class="ident" id="5653911">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653921">c</span>&nbsp;<span class="op" id="5653923">+=</span>&nbsp;<span class="ident" id="5653926">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653932">index</span>&nbsp;<span class="op" id="5653938">+=</span>&nbsp;<span class="ident" id="5653941">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5653951">c</span>&nbsp;<span class="op" id="5653953">&lt;&lt;=</span>&nbsp;<span class="num" id="5653957">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5653964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5653967">return</span>&nbsp;<span class="ident" id="5653974">nil</span><br>
<span class="lineno"></span><span class="op" id="5653978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5653981">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5654056">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5654083">func</span>&nbsp;<span class="op" id="5654088">(</span><span class="ident" id="5654089">d</span>&nbsp;<span class="op" id="5654091">*</span><span class="ident" id="5654092">decoder</span><span class="op" id="5654099">)</span>&nbsp;<span class="ident" id="5654101">decodeHuffman</span><span class="op" id="5654114">(</span><span class="ident" id="5654115">h</span>&nbsp;<span class="op" id="5654117">*</span><span class="ident" id="5654118">huffman</span><span class="op" id="5654125">)</span>&nbsp;<span class="op" id="5654127">(</span><span class="builtintype" id="5654128">uint8</span><span class="op" id="5654133">,</span>&nbsp;<span class="builtintype" id="5654135">error</span><span class="op" id="5654140">)</span>&nbsp;<span class="op" id="5654142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654145">if</span>&nbsp;<span class="ident" id="5654148">h</span><span class="op" id="5654149">.</span><span class="ident" id="5654150">nCodes</span>&nbsp;<span class="op" id="5654157">==</span>&nbsp;<span class="num" id="5654160">0</span>&nbsp;<span class="op" id="5654162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654166">return</span>&nbsp;<span class="num" id="5654173">0</span><span class="op" id="5654174">,</span>&nbsp;<span class="ident" id="5654176">FormatError</span><span class="op" id="5654187">(</span><span class="string" id="5654188">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5654217">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654224">if</span>&nbsp;<span class="ident" id="5654227">d</span><span class="op" id="5654228">.</span><span class="ident" id="5654229">bits</span><span class="op" id="5654233">.</span><span class="ident" id="5654234">n</span>&nbsp;<span class="op" id="5654236">&lt;</span>&nbsp;<span class="num" id="5654238">8</span>&nbsp;<span class="op" id="5654240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654244">if</span>&nbsp;<span class="ident" id="5654247">err</span>&nbsp;<span class="op" id="5654251">:=</span>&nbsp;<span class="ident" id="5654254">d</span><span class="op" id="5654255">.</span><span class="ident" id="5654256">ensureNBits</span><span class="op" id="5654267">(</span><span class="num" id="5654268">8</span><span class="op" id="5654269">)</span><span class="op" id="5654270">;</span>&nbsp;<span class="ident" id="5654272">err</span>&nbsp;<span class="op" id="5654276">!=</span>&nbsp;<span class="ident" id="5654279">nil</span>&nbsp;<span class="op" id="5654283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654288">if</span>&nbsp;<span class="ident" id="5654291">err</span>&nbsp;<span class="op" id="5654295">!=</span>&nbsp;<span class="ident" id="5654298">errMissingFF00</span>&nbsp;<span class="op" id="5654313">&amp;&amp;</span>&nbsp;<span class="ident" id="5654316">err</span>&nbsp;<span class="op" id="5654320">!=</span>&nbsp;<span class="ident" id="5654323">errShortHuffmanData</span>&nbsp;<span class="op" id="5654343">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654349">return</span>&nbsp;<span class="num" id="5654356">0</span><span class="op" id="5654357">,</span>&nbsp;<span class="ident" id="5654359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5654371">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5654443">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5654514">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654577">d</span><span class="op" id="5654578">.</span><span class="ident" id="5654579">unreadByteStuffedByte</span><span class="op" id="5654600">(</span><span class="op" id="5654601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654606">goto</span>&nbsp;<span class="ident" id="5654611">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654628">if</span>&nbsp;<span class="ident" id="5654631">v</span>&nbsp;<span class="op" id="5654633">:=</span>&nbsp;<span class="ident" id="5654636">h</span><span class="op" id="5654637">.</span><span class="ident" id="5654638">lut</span><span class="op" id="5654641">[</span><span class="op" id="5654642">(</span><span class="ident" id="5654643">d</span><span class="op" id="5654644">.</span><span class="ident" id="5654645">bits</span><span class="op" id="5654649">.</span><span class="ident" id="5654650">a</span><span class="op" id="5654651">&gt;&gt;</span><span class="builtintype" id="5654653">uint32</span><span class="op" id="5654659">(</span><span class="ident" id="5654660">d</span><span class="op" id="5654661">.</span><span class="ident" id="5654662">bits</span><span class="op" id="5654666">.</span><span class="ident" id="5654667">n</span><span class="op" id="5654668">-</span><span class="ident" id="5654669">lutSize</span><span class="op" id="5654676">)</span><span class="op" id="5654677">)</span><span class="op" id="5654678">&amp;</span><span class="num" id="5654679">0xff</span><span class="op" id="5654683">]</span><span class="op" id="5654684">;</span>&nbsp;<span class="ident" id="5654686">v</span>&nbsp;<span class="op" id="5654688">!=</span>&nbsp;<span class="num" id="5654691">0</span>&nbsp;<span class="op" id="5654693">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654697">n</span>&nbsp;<span class="op" id="5654699">:=</span>&nbsp;<span class="op" id="5654702">(</span><span class="ident" id="5654703">v</span>&nbsp;<span class="op" id="5654705">&amp;</span>&nbsp;<span class="num" id="5654707">0xff</span><span class="op" id="5654711">)</span>&nbsp;<span class="op" id="5654713">-</span>&nbsp;<span class="num" id="5654715">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654719">d</span><span class="op" id="5654720">.</span><span class="ident" id="5654721">bits</span><span class="op" id="5654725">.</span><span class="ident" id="5654726">n</span>&nbsp;<span class="op" id="5654728">-=</span>&nbsp;<span class="builtintype" id="5654731">int32</span><span class="op" id="5654736">(</span><span class="ident" id="5654737">n</span><span class="op" id="5654738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654742">d</span><span class="op" id="5654743">.</span><span class="ident" id="5654744">bits</span><span class="op" id="5654748">.</span><span class="ident" id="5654749">m</span>&nbsp;<span class="op" id="5654751">&gt;&gt;=</span>&nbsp;<span class="ident" id="5654755">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654759">return</span>&nbsp;<span class="builtintype" id="5654766">uint8</span><span class="op" id="5654771">(</span><span class="ident" id="5654772">v</span>&nbsp;<span class="op" id="5654774">&gt;&gt;</span>&nbsp;<span class="num" id="5654777">8</span><span class="op" id="5654778">)</span><span class="op" id="5654779">,</span>&nbsp;<span class="ident" id="5654781">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654786">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5654789">slowPath</span><span class="op" id="5654797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654800">for</span>&nbsp;<span class="ident" id="5654804">i</span><span class="op" id="5654805">,</span>&nbsp;<span class="ident" id="5654807">code</span>&nbsp;<span class="op" id="5654812">:=</span>&nbsp;<span class="num" id="5654815">0</span><span class="op" id="5654816">,</span>&nbsp;<span class="builtintype" id="5654818">int32</span><span class="op" id="5654823">(</span><span class="num" id="5654824">0</span><span class="op" id="5654825">)</span><span class="op" id="5654826">;</span>&nbsp;<span class="ident" id="5654828">i</span>&nbsp;<span class="op" id="5654830">&lt;</span>&nbsp;<span class="ident" id="5654832">maxCodeLength</span><span class="op" id="5654845">;</span>&nbsp;<span class="ident" id="5654847">i</span><span class="op" id="5654848">++</span>&nbsp;<span class="op" id="5654851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654855">if</span>&nbsp;<span class="ident" id="5654858">d</span><span class="op" id="5654859">.</span><span class="ident" id="5654860">bits</span><span class="op" id="5654864">.</span><span class="ident" id="5654865">n</span>&nbsp;<span class="op" id="5654867">==</span>&nbsp;<span class="num" id="5654870">0</span>&nbsp;<span class="op" id="5654872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654877">if</span>&nbsp;<span class="ident" id="5654880">err</span>&nbsp;<span class="op" id="5654884">:=</span>&nbsp;<span class="ident" id="5654887">d</span><span class="op" id="5654888">.</span><span class="ident" id="5654889">ensureNBits</span><span class="op" id="5654900">(</span><span class="num" id="5654901">1</span><span class="op" id="5654902">)</span><span class="op" id="5654903">;</span>&nbsp;<span class="ident" id="5654905">err</span>&nbsp;<span class="op" id="5654909">!=</span>&nbsp;<span class="ident" id="5654912">nil</span>&nbsp;<span class="op" id="5654916">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654922">return</span>&nbsp;<span class="num" id="5654929">0</span><span class="op" id="5654930">,</span>&nbsp;<span class="ident" id="5654932">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5654947">if</span>&nbsp;<span class="ident" id="5654950">d</span><span class="op" id="5654951">.</span><span class="ident" id="5654952">bits</span><span class="op" id="5654956">.</span><span class="ident" id="5654957">a</span><span class="op" id="5654958">&amp;</span><span class="ident" id="5654959">d</span><span class="op" id="5654960">.</span><span class="ident" id="5654961">bits</span><span class="op" id="5654965">.</span><span class="ident" id="5654966">m</span>&nbsp;<span class="op" id="5654968">!=</span>&nbsp;<span class="num" id="5654971">0</span>&nbsp;<span class="op" id="5654973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654978">code</span>&nbsp;<span class="op" id="5654983">|=</span>&nbsp;<span class="num" id="5654986">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5654990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5654994">d</span><span class="op" id="5654995">.</span><span class="ident" id="5654996">bits</span><span class="op" id="5655000">.</span><span class="ident" id="5655001">n</span><span class="op" id="5655002">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655007">d</span><span class="op" id="5655008">.</span><span class="ident" id="5655009">bits</span><span class="op" id="5655013">.</span><span class="ident" id="5655014">m</span>&nbsp;<span class="op" id="5655016">&gt;&gt;=</span>&nbsp;<span class="num" id="5655020">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655024">if</span>&nbsp;<span class="ident" id="5655027">code</span>&nbsp;<span class="op" id="5655032">&lt;=</span>&nbsp;<span class="ident" id="5655035">h</span><span class="op" id="5655036">.</span><span class="ident" id="5655037">maxCodes</span><span class="op" id="5655045">[</span><span class="ident" id="5655046">i</span><span class="op" id="5655047">]</span>&nbsp;<span class="op" id="5655049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655054">return</span>&nbsp;<span class="ident" id="5655061">h</span><span class="op" id="5655062">.</span><span class="ident" id="5655063">vals</span><span class="op" id="5655067">[</span><span class="ident" id="5655068">h</span><span class="op" id="5655069">.</span><span class="ident" id="5655070">valsIndices</span><span class="op" id="5655081">[</span><span class="ident" id="5655082">i</span><span class="op" id="5655083">]</span><span class="op" id="5655084">+</span><span class="ident" id="5655085">code</span><span class="op" id="5655089">-</span><span class="ident" id="5655090">h</span><span class="op" id="5655091">.</span><span class="ident" id="5655092">minCodes</span><span class="op" id="5655100">[</span><span class="ident" id="5655101">i</span><span class="op" id="5655102">]</span><span class="op" id="5655103">]</span><span class="op" id="5655104">,</span>&nbsp;<span class="ident" id="5655106">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655116">code</span>&nbsp;<span class="op" id="5655121">&lt;&lt;=</span>&nbsp;<span class="num" id="5655125">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655131">return</span>&nbsp;<span class="num" id="5655138">0</span><span class="op" id="5655139">,</span>&nbsp;<span class="ident" id="5655141">FormatError</span><span class="op" id="5655152">(</span><span class="string" id="5655153">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5655171">)</span><br>
<span class="lineno"></span><span class="op" id="5655173">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5655176">func</span>&nbsp;<span class="op" id="5655181">(</span><span class="ident" id="5655182">d</span>&nbsp;<span class="op" id="5655184">*</span><span class="ident" id="5655185">decoder</span><span class="op" id="5655192">)</span>&nbsp;<span class="ident" id="5655194">decodeBit</span><span class="op" id="5655203">(</span><span class="op" id="5655204">)</span>&nbsp;<span class="op" id="5655206">(</span><span class="builtintype" id="5655207">bool</span><span class="op" id="5655211">,</span>&nbsp;<span class="builtintype" id="5655213">error</span><span class="op" id="5655218">)</span>&nbsp;<span class="op" id="5655220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655223">if</span>&nbsp;<span class="ident" id="5655226">d</span><span class="op" id="5655227">.</span><span class="ident" id="5655228">bits</span><span class="op" id="5655232">.</span><span class="ident" id="5655233">n</span>&nbsp;<span class="op" id="5655235">==</span>&nbsp;<span class="num" id="5655238">0</span>&nbsp;<span class="op" id="5655240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655244">if</span>&nbsp;<span class="ident" id="5655247">err</span>&nbsp;<span class="op" id="5655251">:=</span>&nbsp;<span class="ident" id="5655254">d</span><span class="op" id="5655255">.</span><span class="ident" id="5655256">ensureNBits</span><span class="op" id="5655267">(</span><span class="num" id="5655268">1</span><span class="op" id="5655269">)</span><span class="op" id="5655270">;</span>&nbsp;<span class="ident" id="5655272">err</span>&nbsp;<span class="op" id="5655276">!=</span>&nbsp;<span class="ident" id="5655279">nil</span>&nbsp;<span class="op" id="5655283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655288">return</span>&nbsp;<span class="builtintype" id="5655295">false</span><span class="op" id="5655300">,</span>&nbsp;<span class="ident" id="5655302">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655314">ret</span>&nbsp;<span class="op" id="5655318">:=</span>&nbsp;<span class="ident" id="5655321">d</span><span class="op" id="5655322">.</span><span class="ident" id="5655323">bits</span><span class="op" id="5655327">.</span><span class="ident" id="5655328">a</span><span class="op" id="5655329">&amp;</span><span class="ident" id="5655330">d</span><span class="op" id="5655331">.</span><span class="ident" id="5655332">bits</span><span class="op" id="5655336">.</span><span class="ident" id="5655337">m</span>&nbsp;<span class="op" id="5655339">!=</span>&nbsp;<span class="num" id="5655342">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655345">d</span><span class="op" id="5655346">.</span><span class="ident" id="5655347">bits</span><span class="op" id="5655351">.</span><span class="ident" id="5655352">n</span><span class="op" id="5655353">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655357">d</span><span class="op" id="5655358">.</span><span class="ident" id="5655359">bits</span><span class="op" id="5655363">.</span><span class="ident" id="5655364">m</span>&nbsp;<span class="op" id="5655366">&gt;&gt;=</span>&nbsp;<span class="num" id="5655370">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655373">return</span>&nbsp;<span class="ident" id="5655380">ret</span><span class="op" id="5655383">,</span>&nbsp;<span class="ident" id="5655385">nil</span><br>
<span class="lineno"></span><span class="op" id="5655389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5655392">func</span>&nbsp;<span class="op" id="5655397">(</span><span class="ident" id="5655398">d</span>&nbsp;<span class="op" id="5655400">*</span><span class="ident" id="5655401">decoder</span><span class="op" id="5655408">)</span>&nbsp;<span class="ident" id="5655410">decodeBits</span><span class="op" id="5655420">(</span><span class="ident" id="5655421">n</span>&nbsp;<span class="builtintype" id="5655423">int32</span><span class="op" id="5655428">)</span>&nbsp;<span class="op" id="5655430">(</span><span class="builtintype" id="5655431">uint32</span><span class="op" id="5655437">,</span>&nbsp;<span class="builtintype" id="5655439">error</span><span class="op" id="5655444">)</span>&nbsp;<span class="op" id="5655446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655449">if</span>&nbsp;<span class="ident" id="5655452">d</span><span class="op" id="5655453">.</span><span class="ident" id="5655454">bits</span><span class="op" id="5655458">.</span><span class="ident" id="5655459">n</span>&nbsp;<span class="op" id="5655461">&lt;</span>&nbsp;<span class="ident" id="5655463">n</span>&nbsp;<span class="op" id="5655465">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655469">if</span>&nbsp;<span class="ident" id="5655472">err</span>&nbsp;<span class="op" id="5655476">:=</span>&nbsp;<span class="ident" id="5655479">d</span><span class="op" id="5655480">.</span><span class="ident" id="5655481">ensureNBits</span><span class="op" id="5655492">(</span><span class="ident" id="5655493">n</span><span class="op" id="5655494">)</span><span class="op" id="5655495">;</span>&nbsp;<span class="ident" id="5655497">err</span>&nbsp;<span class="op" id="5655501">!=</span>&nbsp;<span class="ident" id="5655504">nil</span>&nbsp;<span class="op" id="5655508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655513">return</span>&nbsp;<span class="num" id="5655520">0</span><span class="op" id="5655521">,</span>&nbsp;<span class="ident" id="5655523">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5655532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655535">ret</span>&nbsp;<span class="op" id="5655539">:=</span>&nbsp;<span class="ident" id="5655542">d</span><span class="op" id="5655543">.</span><span class="ident" id="5655544">bits</span><span class="op" id="5655548">.</span><span class="ident" id="5655549">a</span>&nbsp;<span class="op" id="5655551">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5655554">uint32</span><span class="op" id="5655560">(</span><span class="ident" id="5655561">d</span><span class="op" id="5655562">.</span><span class="ident" id="5655563">bits</span><span class="op" id="5655567">.</span><span class="ident" id="5655568">n</span><span class="op" id="5655569">-</span><span class="ident" id="5655570">n</span><span class="op" id="5655571">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655574">ret</span>&nbsp;<span class="op" id="5655578">&amp;=</span>&nbsp;<span class="op" id="5655581">(</span><span class="num" id="5655582">1</span>&nbsp;<span class="op" id="5655584">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5655587">uint32</span><span class="op" id="5655593">(</span><span class="ident" id="5655594">n</span><span class="op" id="5655595">)</span><span class="op" id="5655596">)</span>&nbsp;<span class="op" id="5655598">-</span>&nbsp;<span class="num" id="5655600">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655603">d</span><span class="op" id="5655604">.</span><span class="ident" id="5655605">bits</span><span class="op" id="5655609">.</span><span class="ident" id="5655610">n</span>&nbsp;<span class="op" id="5655612">-=</span>&nbsp;<span class="ident" id="5655615">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5655618">d</span><span class="op" id="5655619">.</span><span class="ident" id="5655620">bits</span><span class="op" id="5655624">.</span><span class="ident" id="5655625">m</span>&nbsp;<span class="op" id="5655627">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5655631">uint32</span><span class="op" id="5655637">(</span><span class="ident" id="5655638">n</span><span class="op" id="5655639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5655642">return</span>&nbsp;<span class="ident" id="5655649">ret</span><span class="op" id="5655652">,</span>&nbsp;<span class="ident" id="5655654">nil</span><br>
<span class="lineno"></span><span class="op" id="5655658">}</span>
</div>
</body>
</html>
