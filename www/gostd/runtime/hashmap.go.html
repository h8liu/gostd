<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1489833">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1489888">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1489942">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1489993">package</span>&nbsp;<span class="ident" id="1490001">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1490010">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1490069">//</span><br>
<span class="lineno"></span><span class="comment" id="1490072">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1490125">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1490182">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1490240">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1490296">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1490355">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1490382">//</span><br>
<span class="lineno"></span><span class="comment" id="1490385">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1490438">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1490456">//</span><br>
<span class="lineno"></span><span class="comment" id="1490459">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1490512">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1490567">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1490628">//</span><br>
<span class="lineno"></span><span class="comment" id="1490631">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1490686">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1490744">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1490803">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1490860">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1490915">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1490976">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1491032">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1491091">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1491113">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1491175">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1491235">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1491296">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1491332">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1491399">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1491466">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1491533">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1491600">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1491667">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1491734">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1491801">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1491868">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1491935">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1492002">//</span><br>
<span class="lineno"></span><span class="comment" id="1492005">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1492074">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1492130">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1492199">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1492268">//</span><br>
<span class="lineno"></span><span class="comment" id="1492271">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1492339">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1492413">import</span>&nbsp;<span class="op" id="1492420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1492423">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1492432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1492435">const</span>&nbsp;<span class="op" id="1492441">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492444">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492501">bucketCntBits</span>&nbsp;<span class="op" id="1492515">=</span>&nbsp;<span class="num" id="1492517">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492520">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1492534">=</span>&nbsp;<span class="num" id="1492536">1</span>&nbsp;<span class="op" id="1492538">&lt;&lt;</span>&nbsp;<span class="ident" id="1492541">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492557">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492616">loadFactor</span>&nbsp;<span class="op" id="1492627">=</span>&nbsp;<span class="num" id="1492629">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492635">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492716">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492741">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492806">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492875">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1492888">=</span>&nbsp;<span class="num" id="1492890">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492895">maxValueSize</span>&nbsp;<span class="op" id="1492908">=</span>&nbsp;<span class="num" id="1492910">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492916">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492987">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493052">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493089">dataOffset</span>&nbsp;<span class="op" id="1493100">=</span>&nbsp;<span class="ident" id="1493102">unsafe</span><span class="op" id="1493108">.</span><span class="ident" id="1493109">Offsetof</span><span class="op" id="1493117">(</span><span class="keyword" id="1493118">struct</span>&nbsp;<span class="op" id="1493125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493129">b</span>&nbsp;<span class="ident" id="1493131">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493138">v</span>&nbsp;<span class="ident" id="1493140">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493147">}</span><span class="op" id="1493148">{</span><span class="op" id="1493149">}</span><span class="op" id="1493150">.</span><span class="ident" id="1493151">v</span><span class="op" id="1493152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493156">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493236">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493329">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493423">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493505">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493520">=</span>&nbsp;<span class="num" id="1493522">0</span>&nbsp;<span class="comment" id="1493524">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493542">evacuatedEmpty</span>&nbsp;<span class="op" id="1493557">=</span>&nbsp;<span class="num" id="1493559">1</span>&nbsp;<span class="comment" id="1493561">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493601">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493616">=</span>&nbsp;<span class="num" id="1493618">2</span>&nbsp;<span class="comment" id="1493620">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493701">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493716">=</span>&nbsp;<span class="num" id="1493718">3</span>&nbsp;<span class="comment" id="1493720">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493785">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493800">=</span>&nbsp;<span class="num" id="1493802">4</span>&nbsp;<span class="comment" id="1493804">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493851">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493861">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1493873">=</span>&nbsp;<span class="num" id="1493875">1</span>&nbsp;<span class="comment" id="1493877">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493920">oldIterator</span>&nbsp;<span class="op" id="1493932">=</span>&nbsp;<span class="num" id="1493934">2</span>&nbsp;<span class="comment" id="1493936">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493983">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494026">noCheck</span>&nbsp;<span class="op" id="1494034">=</span>&nbsp;<span class="num" id="1494036">1</span><span class="op" id="1494037">&lt;&lt;</span><span class="op" id="1494039">(</span><span class="num" id="1494040">8</span><span class="op" id="1494041">*</span><span class="ident" id="1494042">ptrSize</span><span class="op" id="1494049">)</span>&nbsp;<span class="op" id="1494051">-</span>&nbsp;<span class="num" id="1494053">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494057">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494127">checkgc</span>&nbsp;<span class="op" id="1494135">=</span>&nbsp;<span class="builtintype" id="1494137">false</span><br>
<span class="lineno"></span><span class="op" id="1494143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1494146">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1494172">type</span>&nbsp;<span class="ident" id="1494177">hmap</span>&nbsp;<span class="keyword" id="1494182">struct</span>&nbsp;<span class="op" id="1494189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494192">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494266">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494352">count</span>&nbsp;<span class="builtintype" id="1494358">int</span>&nbsp;<span class="comment" id="1494362">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494434">flags</span>&nbsp;<span class="builtintype" id="1494440">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494448">hash0</span>&nbsp;<span class="builtintype" id="1494454">uint32</span>&nbsp;<span class="comment" id="1494461">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494475">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1494481">uint8</span>&nbsp;&nbsp;<span class="comment" id="1494488">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494555">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1494566">unsafe</span><span class="op" id="1494572">.</span><span class="ident" id="1494573">Pointer</span>&nbsp;<span class="comment" id="1494581">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494631">oldbuckets</span>&nbsp;<span class="ident" id="1494642">unsafe</span><span class="op" id="1494648">.</span><span class="ident" id="1494649">Pointer</span>&nbsp;<span class="comment" id="1494657">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494727">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1494738">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1494753">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1494833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1494836">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1494862">type</span>&nbsp;<span class="ident" id="1494867">bmap</span>&nbsp;<span class="keyword" id="1494872">struct</span>&nbsp;<span class="op" id="1494879">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494882">tophash</span>&nbsp;&nbsp;<span class="op" id="1494891">[</span><span class="ident" id="1494892">bucketCnt</span><span class="op" id="1494901">]</span><span class="builtintype" id="1494902">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494909">overflow</span>&nbsp;<span class="op" id="1494918">*</span><span class="ident" id="1494919">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494925">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494983">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495066">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495153">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1495229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1495232">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1495263">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1495328">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1495361">type</span>&nbsp;<span class="ident" id="1495366">hiter</span>&nbsp;<span class="keyword" id="1495372">struct</span>&nbsp;<span class="op" id="1495379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495382">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495394">unsafe</span><span class="op" id="1495400">.</span><span class="ident" id="1495401">Pointer</span>&nbsp;<span class="comment" id="1495409">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495499">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495511">unsafe</span><span class="op" id="1495517">.</span><span class="ident" id="1495518">Pointer</span>&nbsp;<span class="comment" id="1495526">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495579">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495591">*</span><span class="ident" id="1495592">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495601">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495613">*</span><span class="ident" id="1495614">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495620">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1495632">unsafe</span><span class="op" id="1495638">.</span><span class="ident" id="1495639">Pointer</span>&nbsp;<span class="comment" id="1495647">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495695">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1495707">*</span><span class="ident" id="1495708">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495722">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495741">startBucket</span>&nbsp;<span class="builtintype" id="1495753">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495768">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495800">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1495812">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495827">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495925">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1495937">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1495952">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496017">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496029">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496036">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496048">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496055">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496067">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496076">checkBucket</span>&nbsp;<span class="builtintype" id="1496088">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1496096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496099">func</span>&nbsp;<span class="ident" id="1496104">evacuated</span><span class="op" id="1496113">(</span><span class="ident" id="1496114">b</span>&nbsp;<span class="op" id="1496116">*</span><span class="ident" id="1496117">bmap</span><span class="op" id="1496121">)</span>&nbsp;<span class="builtintype" id="1496123">bool</span>&nbsp;<span class="op" id="1496128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496131">h</span>&nbsp;<span class="op" id="1496133">:=</span>&nbsp;<span class="ident" id="1496136">b</span><span class="op" id="1496137">.</span><span class="ident" id="1496138">tophash</span><span class="op" id="1496145">[</span><span class="num" id="1496146">0</span><span class="op" id="1496147">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496150">return</span>&nbsp;<span class="ident" id="1496157">h</span>&nbsp;<span class="op" id="1496159">&gt;</span>&nbsp;<span class="ident" id="1496161">empty</span>&nbsp;<span class="op" id="1496167">&amp;&amp;</span>&nbsp;<span class="ident" id="1496170">h</span>&nbsp;<span class="op" id="1496172">&lt;</span>&nbsp;<span class="ident" id="1496174">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1496185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496188">func</span>&nbsp;<span class="ident" id="1496193">makemap</span><span class="op" id="1496200">(</span><span class="ident" id="1496201">t</span>&nbsp;<span class="op" id="1496203">*</span><span class="ident" id="1496204">maptype</span><span class="op" id="1496211">,</span>&nbsp;<span class="ident" id="1496213">hint</span>&nbsp;<span class="ident" id="1496218">int64</span><span class="op" id="1496223">)</span>&nbsp;<span class="op" id="1496225">*</span><span class="ident" id="1496226">hmap</span>&nbsp;<span class="op" id="1496231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496234">if</span>&nbsp;<span class="ident" id="1496237">sz</span>&nbsp;<span class="op" id="1496240">:=</span>&nbsp;<span class="ident" id="1496243">unsafe</span><span class="op" id="1496249">.</span><span class="ident" id="1496250">Sizeof</span><span class="op" id="1496256">(</span><span class="ident" id="1496257">hmap</span><span class="op" id="1496261">{</span><span class="op" id="1496262">}</span><span class="op" id="1496263">)</span><span class="op" id="1496264">;</span>&nbsp;<span class="ident" id="1496266">sz</span>&nbsp;<span class="op" id="1496269">&gt;</span>&nbsp;<span class="num" id="1496271">48</span>&nbsp;<span class="op" id="1496274">||</span>&nbsp;<span class="ident" id="1496277">sz</span>&nbsp;<span class="op" id="1496280">!=</span>&nbsp;<span class="builtintype" id="1496283">uintptr</span><span class="op" id="1496290">(</span><span class="ident" id="1496291">t</span><span class="op" id="1496292">.</span><span class="ident" id="1496293">hmap</span><span class="op" id="1496297">.</span><span class="ident" id="1496298">size</span><span class="op" id="1496302">)</span>&nbsp;<span class="op" id="1496304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496308">gothrow</span><span class="op" id="1496315">(</span><span class="string" id="1496316">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1496331">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496338">if</span>&nbsp;<span class="ident" id="1496341">hint</span>&nbsp;<span class="op" id="1496346">&lt;</span>&nbsp;<span class="num" id="1496348">0</span>&nbsp;<span class="op" id="1496350">||</span>&nbsp;<span class="ident" id="1496353">int64</span><span class="op" id="1496358">(</span><span class="builtintype" id="1496359">int32</span><span class="op" id="1496364">(</span><span class="ident" id="1496365">hint</span><span class="op" id="1496369">)</span><span class="op" id="1496370">)</span>&nbsp;<span class="op" id="1496372">!=</span>&nbsp;<span class="ident" id="1496375">hint</span>&nbsp;<span class="op" id="1496380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1496384">panic</span><span class="op" id="1496389">(</span><span class="string" id="1496390">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1496418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496422">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496481">if</span>&nbsp;<span class="op" id="1496484">!</span><span class="ident" id="1496485">ismapkey</span><span class="op" id="1496493">(</span><span class="ident" id="1496494">t</span><span class="op" id="1496495">.</span><span class="ident" id="1496496">key</span><span class="op" id="1496499">)</span>&nbsp;<span class="op" id="1496501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496505">gothrow</span><span class="op" id="1496512">(</span><span class="string" id="1496513">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1496556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496559">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496563">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496603">if</span>&nbsp;<span class="ident" id="1496606">t</span><span class="op" id="1496607">.</span><span class="ident" id="1496608">key</span><span class="op" id="1496611">.</span><span class="ident" id="1496612">size</span>&nbsp;<span class="op" id="1496617">&gt;</span>&nbsp;<span class="ident" id="1496619">maxKeySize</span>&nbsp;<span class="op" id="1496630">&amp;&amp;</span>&nbsp;<span class="op" id="1496633">(</span><span class="op" id="1496634">!</span><span class="ident" id="1496635">t</span><span class="op" id="1496636">.</span><span class="ident" id="1496637">indirectkey</span>&nbsp;<span class="op" id="1496649">||</span>&nbsp;<span class="ident" id="1496652">t</span><span class="op" id="1496653">.</span><span class="ident" id="1496654">keysize</span>&nbsp;<span class="op" id="1496662">!=</span>&nbsp;<span class="builtintype" id="1496665">uint8</span><span class="op" id="1496670">(</span><span class="ident" id="1496671">ptrSize</span><span class="op" id="1496678">)</span><span class="op" id="1496679">)</span>&nbsp;<span class="op" id="1496681">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496686">t</span><span class="op" id="1496687">.</span><span class="ident" id="1496688">key</span><span class="op" id="1496691">.</span><span class="ident" id="1496692">size</span>&nbsp;<span class="op" id="1496697">&lt;=</span>&nbsp;<span class="ident" id="1496700">maxKeySize</span>&nbsp;<span class="op" id="1496711">&amp;&amp;</span>&nbsp;<span class="op" id="1496714">(</span><span class="ident" id="1496715">t</span><span class="op" id="1496716">.</span><span class="ident" id="1496717">indirectkey</span>&nbsp;<span class="op" id="1496729">||</span>&nbsp;<span class="ident" id="1496732">t</span><span class="op" id="1496733">.</span><span class="ident" id="1496734">keysize</span>&nbsp;<span class="op" id="1496742">!=</span>&nbsp;<span class="builtintype" id="1496745">uint8</span><span class="op" id="1496750">(</span><span class="ident" id="1496751">t</span><span class="op" id="1496752">.</span><span class="ident" id="1496753">key</span><span class="op" id="1496756">.</span><span class="ident" id="1496757">size</span><span class="op" id="1496761">)</span><span class="op" id="1496762">)</span>&nbsp;<span class="op" id="1496764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496768">gothrow</span><span class="op" id="1496775">(</span><span class="string" id="1496776">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1496792">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496798">if</span>&nbsp;<span class="ident" id="1496801">t</span><span class="op" id="1496802">.</span><span class="ident" id="1496803">elem</span><span class="op" id="1496807">.</span><span class="ident" id="1496808">size</span>&nbsp;<span class="op" id="1496813">&gt;</span>&nbsp;<span class="ident" id="1496815">maxValueSize</span>&nbsp;<span class="op" id="1496828">&amp;&amp;</span>&nbsp;<span class="op" id="1496831">(</span><span class="op" id="1496832">!</span><span class="ident" id="1496833">t</span><span class="op" id="1496834">.</span><span class="ident" id="1496835">indirectvalue</span>&nbsp;<span class="op" id="1496849">||</span>&nbsp;<span class="ident" id="1496852">t</span><span class="op" id="1496853">.</span><span class="ident" id="1496854">valuesize</span>&nbsp;<span class="op" id="1496864">!=</span>&nbsp;<span class="builtintype" id="1496867">uint8</span><span class="op" id="1496872">(</span><span class="ident" id="1496873">ptrSize</span><span class="op" id="1496880">)</span><span class="op" id="1496881">)</span>&nbsp;<span class="op" id="1496883">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496888">t</span><span class="op" id="1496889">.</span><span class="ident" id="1496890">elem</span><span class="op" id="1496894">.</span><span class="ident" id="1496895">size</span>&nbsp;<span class="op" id="1496900">&lt;=</span>&nbsp;<span class="ident" id="1496903">maxValueSize</span>&nbsp;<span class="op" id="1496916">&amp;&amp;</span>&nbsp;<span class="op" id="1496919">(</span><span class="ident" id="1496920">t</span><span class="op" id="1496921">.</span><span class="ident" id="1496922">indirectvalue</span>&nbsp;<span class="op" id="1496936">||</span>&nbsp;<span class="ident" id="1496939">t</span><span class="op" id="1496940">.</span><span class="ident" id="1496941">valuesize</span>&nbsp;<span class="op" id="1496951">!=</span>&nbsp;<span class="builtintype" id="1496954">uint8</span><span class="op" id="1496959">(</span><span class="ident" id="1496960">t</span><span class="op" id="1496961">.</span><span class="ident" id="1496962">elem</span><span class="op" id="1496966">.</span><span class="ident" id="1496967">size</span><span class="op" id="1496971">)</span><span class="op" id="1496972">)</span>&nbsp;<span class="op" id="1496974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496978">gothrow</span><span class="op" id="1496985">(</span><span class="string" id="1496986">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1497004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497007">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497011">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497088">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497133">if</span>&nbsp;<span class="ident" id="1497136">t</span><span class="op" id="1497137">.</span><span class="ident" id="1497138">key</span><span class="op" id="1497141">.</span><span class="ident" id="1497142">align</span>&nbsp;<span class="op" id="1497148">&gt;</span>&nbsp;<span class="ident" id="1497150">bucketCnt</span>&nbsp;<span class="op" id="1497160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497164">gothrow</span><span class="op" id="1497171">(</span><span class="string" id="1497172">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1497191">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497197">if</span>&nbsp;<span class="ident" id="1497200">t</span><span class="op" id="1497201">.</span><span class="ident" id="1497202">elem</span><span class="op" id="1497206">.</span><span class="ident" id="1497207">align</span>&nbsp;<span class="op" id="1497213">&gt;</span>&nbsp;<span class="ident" id="1497215">bucketCnt</span>&nbsp;<span class="op" id="1497225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497229">gothrow</span><span class="op" id="1497236">(</span><span class="string" id="1497237">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1497258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497264">if</span>&nbsp;<span class="builtintype" id="1497267">uintptr</span><span class="op" id="1497274">(</span><span class="ident" id="1497275">t</span><span class="op" id="1497276">.</span><span class="ident" id="1497277">key</span><span class="op" id="1497280">.</span><span class="ident" id="1497281">size</span><span class="op" id="1497285">)</span><span class="op" id="1497286">%</span><span class="builtintype" id="1497287">uintptr</span><span class="op" id="1497294">(</span><span class="ident" id="1497295">t</span><span class="op" id="1497296">.</span><span class="ident" id="1497297">key</span><span class="op" id="1497300">.</span><span class="ident" id="1497301">align</span><span class="op" id="1497306">)</span>&nbsp;<span class="op" id="1497308">!=</span>&nbsp;<span class="num" id="1497311">0</span>&nbsp;<span class="op" id="1497313">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497317">gothrow</span><span class="op" id="1497324">(</span><span class="string" id="1497325">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1497363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497369">if</span>&nbsp;<span class="builtintype" id="1497372">uintptr</span><span class="op" id="1497379">(</span><span class="ident" id="1497380">t</span><span class="op" id="1497381">.</span><span class="ident" id="1497382">elem</span><span class="op" id="1497386">.</span><span class="ident" id="1497387">size</span><span class="op" id="1497391">)</span><span class="op" id="1497392">%</span><span class="builtintype" id="1497393">uintptr</span><span class="op" id="1497400">(</span><span class="ident" id="1497401">t</span><span class="op" id="1497402">.</span><span class="ident" id="1497403">elem</span><span class="op" id="1497407">.</span><span class="ident" id="1497408">align</span><span class="op" id="1497413">)</span>&nbsp;<span class="op" id="1497415">!=</span>&nbsp;<span class="num" id="1497418">0</span>&nbsp;<span class="op" id="1497420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497424">gothrow</span><span class="op" id="1497431">(</span><span class="string" id="1497432">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1497474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497477">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497480">if</span>&nbsp;<span class="ident" id="1497483">bucketCnt</span>&nbsp;<span class="op" id="1497493">&lt;</span>&nbsp;<span class="num" id="1497495">8</span>&nbsp;<span class="op" id="1497497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497501">gothrow</span><span class="op" id="1497508">(</span><span class="string" id="1497509">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1497552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497558">if</span>&nbsp;<span class="ident" id="1497561">dataOffset</span><span class="op" id="1497571">%</span><span class="builtintype" id="1497572">uintptr</span><span class="op" id="1497579">(</span><span class="ident" id="1497580">t</span><span class="op" id="1497581">.</span><span class="ident" id="1497582">key</span><span class="op" id="1497585">.</span><span class="ident" id="1497586">align</span><span class="op" id="1497591">)</span>&nbsp;<span class="op" id="1497593">!=</span>&nbsp;<span class="num" id="1497596">0</span>&nbsp;<span class="op" id="1497598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497602">gothrow</span><span class="op" id="1497609">(</span><span class="string" id="1497610">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1497640">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497646">if</span>&nbsp;<span class="ident" id="1497649">dataOffset</span><span class="op" id="1497659">%</span><span class="builtintype" id="1497660">uintptr</span><span class="op" id="1497667">(</span><span class="ident" id="1497668">t</span><span class="op" id="1497669">.</span><span class="ident" id="1497670">elem</span><span class="op" id="1497674">.</span><span class="ident" id="1497675">align</span><span class="op" id="1497680">)</span>&nbsp;<span class="op" id="1497682">!=</span>&nbsp;<span class="num" id="1497685">0</span>&nbsp;<span class="op" id="1497687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497691">gothrow</span><span class="op" id="1497698">(</span><span class="string" id="1497699">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1497731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497738">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497806">B</span>&nbsp;<span class="op" id="1497808">:=</span>&nbsp;<span class="builtintype" id="1497811">uint8</span><span class="op" id="1497816">(</span><span class="num" id="1497817">0</span><span class="op" id="1497818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497821">for</span>&nbsp;<span class="op" id="1497825">;</span>&nbsp;<span class="ident" id="1497827">hint</span>&nbsp;<span class="op" id="1497832">&gt;</span>&nbsp;<span class="ident" id="1497834">bucketCnt</span>&nbsp;<span class="op" id="1497844">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1497847">float32</span><span class="op" id="1497854">(</span><span class="ident" id="1497855">hint</span><span class="op" id="1497859">)</span>&nbsp;<span class="op" id="1497861">&gt;</span>&nbsp;<span class="ident" id="1497863">loadFactor</span><span class="op" id="1497873">*</span><span class="builtintype" id="1497874">float32</span><span class="op" id="1497881">(</span><span class="builtintype" id="1497882">uintptr</span><span class="op" id="1497889">(</span><span class="num" id="1497890">1</span><span class="op" id="1497891">)</span><span class="op" id="1497892">&lt;&lt;</span><span class="ident" id="1497894">B</span><span class="op" id="1497895">)</span><span class="op" id="1497896">;</span>&nbsp;<span class="ident" id="1497898">B</span><span class="op" id="1497899">++</span>&nbsp;<span class="op" id="1497902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497909">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497941">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498015">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498076">var</span>&nbsp;<span class="ident" id="1498080">buckets</span>&nbsp;<span class="ident" id="1498088">unsafe</span><span class="op" id="1498094">.</span><span class="ident" id="1498095">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498104">if</span>&nbsp;<span class="ident" id="1498107">B</span>&nbsp;<span class="op" id="1498109">!=</span>&nbsp;<span class="num" id="1498112">0</span>&nbsp;<span class="op" id="1498114">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498118">if</span>&nbsp;<span class="ident" id="1498121">checkgc</span>&nbsp;<span class="op" id="1498129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498134">memstats</span><span class="op" id="1498142">.</span><span class="ident" id="1498143">next_gc</span>&nbsp;<span class="op" id="1498151">=</span>&nbsp;<span class="ident" id="1498153">memstats</span><span class="op" id="1498161">.</span><span class="ident" id="1498162">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498179">buckets</span>&nbsp;<span class="op" id="1498187">=</span>&nbsp;<span class="ident" id="1498189">newarray</span><span class="op" id="1498197">(</span><span class="ident" id="1498198">t</span><span class="op" id="1498199">.</span><span class="ident" id="1498200">bucket</span><span class="op" id="1498206">,</span>&nbsp;<span class="builtintype" id="1498208">uintptr</span><span class="op" id="1498215">(</span><span class="num" id="1498216">1</span><span class="op" id="1498217">)</span><span class="op" id="1498218">&lt;&lt;</span><span class="ident" id="1498220">B</span><span class="op" id="1498221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498224">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498228">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498248">if</span>&nbsp;<span class="ident" id="1498251">checkgc</span>&nbsp;<span class="op" id="1498259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498263">memstats</span><span class="op" id="1498271">.</span><span class="ident" id="1498272">next_gc</span>&nbsp;<span class="op" id="1498280">=</span>&nbsp;<span class="ident" id="1498282">memstats</span><span class="op" id="1498290">.</span><span class="ident" id="1498291">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498303">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498306">h</span>&nbsp;<span class="op" id="1498308">:=</span>&nbsp;<span class="op" id="1498311">(</span><span class="op" id="1498312">*</span><span class="ident" id="1498313">hmap</span><span class="op" id="1498317">)</span><span class="op" id="1498318">(</span><span class="ident" id="1498319">newobject</span><span class="op" id="1498328">(</span><span class="ident" id="1498329">t</span><span class="op" id="1498330">.</span><span class="ident" id="1498331">hmap</span><span class="op" id="1498335">)</span><span class="op" id="1498336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498339">h</span><span class="op" id="1498340">.</span><span class="ident" id="1498341">count</span>&nbsp;<span class="op" id="1498347">=</span>&nbsp;<span class="num" id="1498349">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498352">h</span><span class="op" id="1498353">.</span><span class="ident" id="1498354">B</span>&nbsp;<span class="op" id="1498356">=</span>&nbsp;<span class="ident" id="1498358">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498361">h</span><span class="op" id="1498362">.</span><span class="ident" id="1498363">flags</span>&nbsp;<span class="op" id="1498369">=</span>&nbsp;<span class="num" id="1498371">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498374">h</span><span class="op" id="1498375">.</span><span class="ident" id="1498376">hash0</span>&nbsp;<span class="op" id="1498382">=</span>&nbsp;<span class="ident" id="1498384">fastrand1</span><span class="op" id="1498393">(</span><span class="op" id="1498394">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498397">h</span><span class="op" id="1498398">.</span><span class="ident" id="1498399">buckets</span>&nbsp;<span class="op" id="1498407">=</span>&nbsp;<span class="ident" id="1498409">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498418">h</span><span class="op" id="1498419">.</span><span class="ident" id="1498420">oldbuckets</span>&nbsp;<span class="op" id="1498431">=</span>&nbsp;<span class="ident" id="1498433">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498438">h</span><span class="op" id="1498439">.</span><span class="ident" id="1498440">nevacuate</span>&nbsp;<span class="op" id="1498450">=</span>&nbsp;<span class="num" id="1498452">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498456">return</span>&nbsp;<span class="ident" id="1498463">h</span><br>
<span class="lineno">230</span><span class="op" id="1498465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1498468">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1498539">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1498610">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1498640">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1498708">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1498739">func</span>&nbsp;<span class="ident" id="1498744">mapaccess1</span><span class="op" id="1498754">(</span><span class="ident" id="1498755">t</span>&nbsp;<span class="op" id="1498757">*</span><span class="ident" id="1498758">maptype</span><span class="op" id="1498765">,</span>&nbsp;<span class="ident" id="1498767">h</span>&nbsp;<span class="op" id="1498769">*</span><span class="ident" id="1498770">hmap</span><span class="op" id="1498774">,</span>&nbsp;<span class="ident" id="1498776">key</span>&nbsp;<span class="ident" id="1498780">unsafe</span><span class="op" id="1498786">.</span><span class="ident" id="1498787">Pointer</span><span class="op" id="1498794">)</span>&nbsp;<span class="ident" id="1498796">unsafe</span><span class="op" id="1498802">.</span><span class="ident" id="1498803">Pointer</span>&nbsp;<span class="op" id="1498811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498814">if</span>&nbsp;<span class="ident" id="1498817">raceenabled</span>&nbsp;<span class="op" id="1498829">&amp;&amp;</span>&nbsp;<span class="ident" id="1498832">h</span>&nbsp;<span class="op" id="1498834">!=</span>&nbsp;<span class="ident" id="1498837">nil</span>&nbsp;<span class="op" id="1498841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498845">callerpc</span>&nbsp;<span class="op" id="1498854">:=</span>&nbsp;<span class="ident" id="1498857">getcallerpc</span><span class="op" id="1498868">(</span><span class="ident" id="1498869">unsafe</span><span class="op" id="1498875">.</span><span class="ident" id="1498876">Pointer</span><span class="op" id="1498883">(</span><span class="op" id="1498884">&amp;</span><span class="ident" id="1498885">t</span><span class="op" id="1498886">)</span><span class="op" id="1498887">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498891">pc</span>&nbsp;<span class="op" id="1498894">:=</span>&nbsp;<span class="ident" id="1498897">funcPC</span><span class="op" id="1498903">(</span><span class="ident" id="1498904">mapaccess1</span><span class="op" id="1498914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498918">racereadpc</span><span class="op" id="1498928">(</span><span class="ident" id="1498929">unsafe</span><span class="op" id="1498935">.</span><span class="ident" id="1498936">Pointer</span><span class="op" id="1498943">(</span><span class="ident" id="1498944">h</span><span class="op" id="1498945">)</span><span class="op" id="1498946">,</span>&nbsp;<span class="ident" id="1498948">callerpc</span><span class="op" id="1498956">,</span>&nbsp;<span class="ident" id="1498958">pc</span><span class="op" id="1498960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498964">raceReadObjectPC</span><span class="op" id="1498980">(</span><span class="ident" id="1498981">t</span><span class="op" id="1498982">.</span><span class="ident" id="1498983">key</span><span class="op" id="1498986">,</span>&nbsp;<span class="ident" id="1498988">key</span><span class="op" id="1498991">,</span>&nbsp;<span class="ident" id="1498993">callerpc</span><span class="op" id="1499001">,</span>&nbsp;<span class="ident" id="1499003">pc</span><span class="op" id="1499005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499011">if</span>&nbsp;<span class="ident" id="1499014">h</span>&nbsp;<span class="op" id="1499016">==</span>&nbsp;<span class="ident" id="1499019">nil</span>&nbsp;<span class="op" id="1499023">||</span>&nbsp;<span class="ident" id="1499026">h</span><span class="op" id="1499027">.</span><span class="ident" id="1499028">count</span>&nbsp;<span class="op" id="1499034">==</span>&nbsp;<span class="num" id="1499037">0</span>&nbsp;<span class="op" id="1499039">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499043">return</span>&nbsp;<span class="ident" id="1499050">unsafe</span><span class="op" id="1499056">.</span><span class="ident" id="1499057">Pointer</span><span class="op" id="1499064">(</span><span class="ident" id="1499065">t</span><span class="op" id="1499066">.</span><span class="ident" id="1499067">elem</span><span class="op" id="1499071">.</span><span class="ident" id="1499072">zero</span><span class="op" id="1499076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499082">alg</span>&nbsp;<span class="op" id="1499086">:=</span>&nbsp;<span class="ident" id="1499089">goalg</span><span class="op" id="1499094">(</span><span class="ident" id="1499095">t</span><span class="op" id="1499096">.</span><span class="ident" id="1499097">key</span><span class="op" id="1499100">.</span><span class="ident" id="1499101">alg</span><span class="op" id="1499104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499107">hash</span>&nbsp;<span class="op" id="1499112">:=</span>&nbsp;<span class="ident" id="1499115">alg</span><span class="op" id="1499118">.</span><span class="ident" id="1499119">hash</span><span class="op" id="1499123">(</span><span class="ident" id="1499124">key</span><span class="op" id="1499127">,</span>&nbsp;<span class="builtintype" id="1499129">uintptr</span><span class="op" id="1499136">(</span><span class="ident" id="1499137">t</span><span class="op" id="1499138">.</span><span class="ident" id="1499139">key</span><span class="op" id="1499142">.</span><span class="ident" id="1499143">size</span><span class="op" id="1499147">)</span><span class="op" id="1499148">,</span>&nbsp;<span class="builtintype" id="1499150">uintptr</span><span class="op" id="1499157">(</span><span class="ident" id="1499158">h</span><span class="op" id="1499159">.</span><span class="ident" id="1499160">hash0</span><span class="op" id="1499165">)</span><span class="op" id="1499166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499169">m</span>&nbsp;<span class="op" id="1499171">:=</span>&nbsp;<span class="builtintype" id="1499174">uintptr</span><span class="op" id="1499181">(</span><span class="num" id="1499182">1</span><span class="op" id="1499183">)</span><span class="op" id="1499184">&lt;&lt;</span><span class="ident" id="1499186">h</span><span class="op" id="1499187">.</span><span class="ident" id="1499188">B</span>&nbsp;<span class="op" id="1499190">-</span>&nbsp;<span class="num" id="1499192">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499195">b</span>&nbsp;<span class="op" id="1499197">:=</span>&nbsp;<span class="op" id="1499200">(</span><span class="op" id="1499201">*</span><span class="ident" id="1499202">bmap</span><span class="op" id="1499206">)</span><span class="op" id="1499207">(</span><span class="ident" id="1499208">add</span><span class="op" id="1499211">(</span><span class="ident" id="1499212">h</span><span class="op" id="1499213">.</span><span class="ident" id="1499214">buckets</span><span class="op" id="1499221">,</span>&nbsp;<span class="op" id="1499223">(</span><span class="ident" id="1499224">hash</span><span class="op" id="1499228">&amp;</span><span class="ident" id="1499229">m</span><span class="op" id="1499230">)</span><span class="op" id="1499231">*</span><span class="builtintype" id="1499232">uintptr</span><span class="op" id="1499239">(</span><span class="ident" id="1499240">t</span><span class="op" id="1499241">.</span><span class="ident" id="1499242">bucketsize</span><span class="op" id="1499252">)</span><span class="op" id="1499253">)</span><span class="op" id="1499254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499257">if</span>&nbsp;<span class="ident" id="1499260">c</span>&nbsp;<span class="op" id="1499262">:=</span>&nbsp;<span class="ident" id="1499265">h</span><span class="op" id="1499266">.</span><span class="ident" id="1499267">oldbuckets</span><span class="op" id="1499277">;</span>&nbsp;<span class="ident" id="1499279">c</span>&nbsp;<span class="op" id="1499281">!=</span>&nbsp;<span class="ident" id="1499284">nil</span>&nbsp;<span class="op" id="1499288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499292">oldb</span>&nbsp;<span class="op" id="1499297">:=</span>&nbsp;<span class="op" id="1499300">(</span><span class="op" id="1499301">*</span><span class="ident" id="1499302">bmap</span><span class="op" id="1499306">)</span><span class="op" id="1499307">(</span><span class="ident" id="1499308">add</span><span class="op" id="1499311">(</span><span class="ident" id="1499312">c</span><span class="op" id="1499313">,</span>&nbsp;<span class="op" id="1499315">(</span><span class="ident" id="1499316">hash</span><span class="op" id="1499320">&amp;</span><span class="op" id="1499321">(</span><span class="ident" id="1499322">m</span><span class="op" id="1499323">&gt;&gt;</span><span class="num" id="1499325">1</span><span class="op" id="1499326">)</span><span class="op" id="1499327">)</span><span class="op" id="1499328">*</span><span class="builtintype" id="1499329">uintptr</span><span class="op" id="1499336">(</span><span class="ident" id="1499337">t</span><span class="op" id="1499338">.</span><span class="ident" id="1499339">bucketsize</span><span class="op" id="1499349">)</span><span class="op" id="1499350">)</span><span class="op" id="1499351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499355">if</span>&nbsp;<span class="op" id="1499358">!</span><span class="ident" id="1499359">evacuated</span><span class="op" id="1499368">(</span><span class="ident" id="1499369">oldb</span><span class="op" id="1499373">)</span>&nbsp;<span class="op" id="1499375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499380">b</span>&nbsp;<span class="op" id="1499382">=</span>&nbsp;<span class="ident" id="1499384">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499397">top</span>&nbsp;<span class="op" id="1499401">:=</span>&nbsp;<span class="builtintype" id="1499404">uint8</span><span class="op" id="1499409">(</span><span class="ident" id="1499410">hash</span>&nbsp;<span class="op" id="1499415">&gt;&gt;</span>&nbsp;<span class="op" id="1499418">(</span><span class="ident" id="1499419">ptrSize</span><span class="op" id="1499426">*</span><span class="num" id="1499427">8</span>&nbsp;<span class="op" id="1499429">-</span>&nbsp;<span class="num" id="1499431">8</span><span class="op" id="1499432">)</span><span class="op" id="1499433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499436">if</span>&nbsp;<span class="ident" id="1499439">top</span>&nbsp;<span class="op" id="1499443">&lt;</span>&nbsp;<span class="ident" id="1499445">minTopHash</span>&nbsp;<span class="op" id="1499456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499460">top</span>&nbsp;<span class="op" id="1499464">+=</span>&nbsp;<span class="ident" id="1499467">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499482">for</span>&nbsp;<span class="op" id="1499486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499490">for</span>&nbsp;<span class="ident" id="1499494">i</span>&nbsp;<span class="op" id="1499496">:=</span>&nbsp;<span class="builtintype" id="1499499">uintptr</span><span class="op" id="1499506">(</span><span class="num" id="1499507">0</span><span class="op" id="1499508">)</span><span class="op" id="1499509">;</span>&nbsp;<span class="ident" id="1499511">i</span>&nbsp;<span class="op" id="1499513">&lt;</span>&nbsp;<span class="ident" id="1499515">bucketCnt</span><span class="op" id="1499524">;</span>&nbsp;<span class="ident" id="1499526">i</span><span class="op" id="1499527">++</span>&nbsp;<span class="op" id="1499530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499535">if</span>&nbsp;<span class="ident" id="1499538">b</span><span class="op" id="1499539">.</span><span class="ident" id="1499540">tophash</span><span class="op" id="1499547">[</span><span class="ident" id="1499548">i</span><span class="op" id="1499549">]</span>&nbsp;<span class="op" id="1499551">!=</span>&nbsp;<span class="ident" id="1499554">top</span>&nbsp;<span class="op" id="1499558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499564">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499581">k</span>&nbsp;<span class="op" id="1499583">:=</span>&nbsp;<span class="ident" id="1499586">add</span><span class="op" id="1499589">(</span><span class="ident" id="1499590">unsafe</span><span class="op" id="1499596">.</span><span class="ident" id="1499597">Pointer</span><span class="op" id="1499604">(</span><span class="ident" id="1499605">b</span><span class="op" id="1499606">)</span><span class="op" id="1499607">,</span>&nbsp;<span class="ident" id="1499609">dataOffset</span><span class="op" id="1499619">+</span><span class="ident" id="1499620">i</span><span class="op" id="1499621">*</span><span class="builtintype" id="1499622">uintptr</span><span class="op" id="1499629">(</span><span class="ident" id="1499630">t</span><span class="op" id="1499631">.</span><span class="ident" id="1499632">keysize</span><span class="op" id="1499639">)</span><span class="op" id="1499640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499645">if</span>&nbsp;<span class="ident" id="1499648">t</span><span class="op" id="1499649">.</span><span class="ident" id="1499650">indirectkey</span>&nbsp;<span class="op" id="1499662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499668">k</span>&nbsp;<span class="op" id="1499670">=</span>&nbsp;<span class="op" id="1499672">*</span><span class="op" id="1499673">(</span><span class="op" id="1499674">(</span><span class="op" id="1499675">*</span><span class="ident" id="1499676">unsafe</span><span class="op" id="1499682">.</span><span class="ident" id="1499683">Pointer</span><span class="op" id="1499690">)</span><span class="op" id="1499691">(</span><span class="ident" id="1499692">k</span><span class="op" id="1499693">)</span><span class="op" id="1499694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499699">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499704">if</span>&nbsp;<span class="ident" id="1499707">alg</span><span class="op" id="1499710">.</span><span class="ident" id="1499711">equal</span><span class="op" id="1499716">(</span><span class="ident" id="1499717">key</span><span class="op" id="1499720">,</span>&nbsp;<span class="ident" id="1499722">k</span><span class="op" id="1499723">,</span>&nbsp;<span class="builtintype" id="1499725">uintptr</span><span class="op" id="1499732">(</span><span class="ident" id="1499733">t</span><span class="op" id="1499734">.</span><span class="ident" id="1499735">key</span><span class="op" id="1499738">.</span><span class="ident" id="1499739">size</span><span class="op" id="1499743">)</span><span class="op" id="1499744">)</span>&nbsp;<span class="op" id="1499746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499752">v</span>&nbsp;<span class="op" id="1499754">:=</span>&nbsp;<span class="ident" id="1499757">add</span><span class="op" id="1499760">(</span><span class="ident" id="1499761">unsafe</span><span class="op" id="1499767">.</span><span class="ident" id="1499768">Pointer</span><span class="op" id="1499775">(</span><span class="ident" id="1499776">b</span><span class="op" id="1499777">)</span><span class="op" id="1499778">,</span>&nbsp;<span class="ident" id="1499780">dataOffset</span><span class="op" id="1499790">+</span><span class="ident" id="1499791">bucketCnt</span><span class="op" id="1499800">*</span><span class="builtintype" id="1499801">uintptr</span><span class="op" id="1499808">(</span><span class="ident" id="1499809">t</span><span class="op" id="1499810">.</span><span class="ident" id="1499811">keysize</span><span class="op" id="1499818">)</span><span class="op" id="1499819">+</span><span class="ident" id="1499820">i</span><span class="op" id="1499821">*</span><span class="builtintype" id="1499822">uintptr</span><span class="op" id="1499829">(</span><span class="ident" id="1499830">t</span><span class="op" id="1499831">.</span><span class="ident" id="1499832">valuesize</span><span class="op" id="1499841">)</span><span class="op" id="1499842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499848">if</span>&nbsp;<span class="ident" id="1499851">t</span><span class="op" id="1499852">.</span><span class="ident" id="1499853">indirectvalue</span>&nbsp;<span class="op" id="1499867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499874">v</span>&nbsp;<span class="op" id="1499876">=</span>&nbsp;<span class="op" id="1499878">*</span><span class="op" id="1499879">(</span><span class="op" id="1499880">(</span><span class="op" id="1499881">*</span><span class="ident" id="1499882">unsafe</span><span class="op" id="1499888">.</span><span class="ident" id="1499889">Pointer</span><span class="op" id="1499896">)</span><span class="op" id="1499897">(</span><span class="ident" id="1499898">v</span><span class="op" id="1499899">)</span><span class="op" id="1499900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499906">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499912">return</span>&nbsp;<span class="ident" id="1499919">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499932">b</span>&nbsp;<span class="op" id="1499934">=</span>&nbsp;<span class="ident" id="1499936">b</span><span class="op" id="1499937">.</span><span class="ident" id="1499938">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499949">if</span>&nbsp;<span class="ident" id="1499952">b</span>&nbsp;<span class="op" id="1499954">==</span>&nbsp;<span class="ident" id="1499957">nil</span>&nbsp;<span class="op" id="1499961">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499966">return</span>&nbsp;<span class="ident" id="1499973">unsafe</span><span class="op" id="1499979">.</span><span class="ident" id="1499980">Pointer</span><span class="op" id="1499987">(</span><span class="ident" id="1499988">t</span><span class="op" id="1499989">.</span><span class="ident" id="1499990">elem</span><span class="op" id="1499994">.</span><span class="ident" id="1499995">zero</span><span class="op" id="1499999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500006">}</span><br>
<span class="lineno"></span><span class="op" id="1500008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1500011">func</span>&nbsp;<span class="ident" id="1500016">mapaccess2</span><span class="op" id="1500026">(</span><span class="ident" id="1500027">t</span>&nbsp;<span class="op" id="1500029">*</span><span class="ident" id="1500030">maptype</span><span class="op" id="1500037">,</span>&nbsp;<span class="ident" id="1500039">h</span>&nbsp;<span class="op" id="1500041">*</span><span class="ident" id="1500042">hmap</span><span class="op" id="1500046">,</span>&nbsp;<span class="ident" id="1500048">key</span>&nbsp;<span class="ident" id="1500052">unsafe</span><span class="op" id="1500058">.</span><span class="ident" id="1500059">Pointer</span><span class="op" id="1500066">)</span>&nbsp;<span class="op" id="1500068">(</span><span class="ident" id="1500069">unsafe</span><span class="op" id="1500075">.</span><span class="ident" id="1500076">Pointer</span><span class="op" id="1500083">,</span>&nbsp;<span class="builtintype" id="1500085">bool</span><span class="op" id="1500089">)</span>&nbsp;<span class="op" id="1500091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500094">if</span>&nbsp;<span class="ident" id="1500097">raceenabled</span>&nbsp;<span class="op" id="1500109">&amp;&amp;</span>&nbsp;<span class="ident" id="1500112">h</span>&nbsp;<span class="op" id="1500114">!=</span>&nbsp;<span class="ident" id="1500117">nil</span>&nbsp;<span class="op" id="1500121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500125">callerpc</span>&nbsp;<span class="op" id="1500134">:=</span>&nbsp;<span class="ident" id="1500137">getcallerpc</span><span class="op" id="1500148">(</span><span class="ident" id="1500149">unsafe</span><span class="op" id="1500155">.</span><span class="ident" id="1500156">Pointer</span><span class="op" id="1500163">(</span><span class="op" id="1500164">&amp;</span><span class="ident" id="1500165">t</span><span class="op" id="1500166">)</span><span class="op" id="1500167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500171">pc</span>&nbsp;<span class="op" id="1500174">:=</span>&nbsp;<span class="ident" id="1500177">funcPC</span><span class="op" id="1500183">(</span><span class="ident" id="1500184">mapaccess2</span><span class="op" id="1500194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500198">racereadpc</span><span class="op" id="1500208">(</span><span class="ident" id="1500209">unsafe</span><span class="op" id="1500215">.</span><span class="ident" id="1500216">Pointer</span><span class="op" id="1500223">(</span><span class="ident" id="1500224">h</span><span class="op" id="1500225">)</span><span class="op" id="1500226">,</span>&nbsp;<span class="ident" id="1500228">callerpc</span><span class="op" id="1500236">,</span>&nbsp;<span class="ident" id="1500238">pc</span><span class="op" id="1500240">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500244">raceReadObjectPC</span><span class="op" id="1500260">(</span><span class="ident" id="1500261">t</span><span class="op" id="1500262">.</span><span class="ident" id="1500263">key</span><span class="op" id="1500266">,</span>&nbsp;<span class="ident" id="1500268">key</span><span class="op" id="1500271">,</span>&nbsp;<span class="ident" id="1500273">callerpc</span><span class="op" id="1500281">,</span>&nbsp;<span class="ident" id="1500283">pc</span><span class="op" id="1500285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500291">if</span>&nbsp;<span class="ident" id="1500294">h</span>&nbsp;<span class="op" id="1500296">==</span>&nbsp;<span class="ident" id="1500299">nil</span>&nbsp;<span class="op" id="1500303">||</span>&nbsp;<span class="ident" id="1500306">h</span><span class="op" id="1500307">.</span><span class="ident" id="1500308">count</span>&nbsp;<span class="op" id="1500314">==</span>&nbsp;<span class="num" id="1500317">0</span>&nbsp;<span class="op" id="1500319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500323">return</span>&nbsp;<span class="ident" id="1500330">unsafe</span><span class="op" id="1500336">.</span><span class="ident" id="1500337">Pointer</span><span class="op" id="1500344">(</span><span class="ident" id="1500345">t</span><span class="op" id="1500346">.</span><span class="ident" id="1500347">elem</span><span class="op" id="1500351">.</span><span class="ident" id="1500352">zero</span><span class="op" id="1500356">)</span><span class="op" id="1500357">,</span>&nbsp;<span class="builtintype" id="1500359">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500366">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500369">alg</span>&nbsp;<span class="op" id="1500373">:=</span>&nbsp;<span class="ident" id="1500376">goalg</span><span class="op" id="1500381">(</span><span class="ident" id="1500382">t</span><span class="op" id="1500383">.</span><span class="ident" id="1500384">key</span><span class="op" id="1500387">.</span><span class="ident" id="1500388">alg</span><span class="op" id="1500391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500394">hash</span>&nbsp;<span class="op" id="1500399">:=</span>&nbsp;<span class="ident" id="1500402">alg</span><span class="op" id="1500405">.</span><span class="ident" id="1500406">hash</span><span class="op" id="1500410">(</span><span class="ident" id="1500411">key</span><span class="op" id="1500414">,</span>&nbsp;<span class="builtintype" id="1500416">uintptr</span><span class="op" id="1500423">(</span><span class="ident" id="1500424">t</span><span class="op" id="1500425">.</span><span class="ident" id="1500426">key</span><span class="op" id="1500429">.</span><span class="ident" id="1500430">size</span><span class="op" id="1500434">)</span><span class="op" id="1500435">,</span>&nbsp;<span class="builtintype" id="1500437">uintptr</span><span class="op" id="1500444">(</span><span class="ident" id="1500445">h</span><span class="op" id="1500446">.</span><span class="ident" id="1500447">hash0</span><span class="op" id="1500452">)</span><span class="op" id="1500453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500456">m</span>&nbsp;<span class="op" id="1500458">:=</span>&nbsp;<span class="builtintype" id="1500461">uintptr</span><span class="op" id="1500468">(</span><span class="num" id="1500469">1</span><span class="op" id="1500470">)</span><span class="op" id="1500471">&lt;&lt;</span><span class="ident" id="1500473">h</span><span class="op" id="1500474">.</span><span class="ident" id="1500475">B</span>&nbsp;<span class="op" id="1500477">-</span>&nbsp;<span class="num" id="1500479">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500482">b</span>&nbsp;<span class="op" id="1500484">:=</span>&nbsp;<span class="op" id="1500487">(</span><span class="op" id="1500488">*</span><span class="ident" id="1500489">bmap</span><span class="op" id="1500493">)</span><span class="op" id="1500494">(</span><span class="ident" id="1500495">unsafe</span><span class="op" id="1500501">.</span><span class="ident" id="1500502">Pointer</span><span class="op" id="1500509">(</span><span class="builtintype" id="1500510">uintptr</span><span class="op" id="1500517">(</span><span class="ident" id="1500518">h</span><span class="op" id="1500519">.</span><span class="ident" id="1500520">buckets</span><span class="op" id="1500527">)</span>&nbsp;<span class="op" id="1500529">+</span>&nbsp;<span class="op" id="1500531">(</span><span class="ident" id="1500532">hash</span><span class="op" id="1500536">&amp;</span><span class="ident" id="1500537">m</span><span class="op" id="1500538">)</span><span class="op" id="1500539">*</span><span class="builtintype" id="1500540">uintptr</span><span class="op" id="1500547">(</span><span class="ident" id="1500548">t</span><span class="op" id="1500549">.</span><span class="ident" id="1500550">bucketsize</span><span class="op" id="1500560">)</span><span class="op" id="1500561">)</span><span class="op" id="1500562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500565">if</span>&nbsp;<span class="ident" id="1500568">c</span>&nbsp;<span class="op" id="1500570">:=</span>&nbsp;<span class="ident" id="1500573">h</span><span class="op" id="1500574">.</span><span class="ident" id="1500575">oldbuckets</span><span class="op" id="1500585">;</span>&nbsp;<span class="ident" id="1500587">c</span>&nbsp;<span class="op" id="1500589">!=</span>&nbsp;<span class="ident" id="1500592">nil</span>&nbsp;<span class="op" id="1500596">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500600">oldb</span>&nbsp;<span class="op" id="1500605">:=</span>&nbsp;<span class="op" id="1500608">(</span><span class="op" id="1500609">*</span><span class="ident" id="1500610">bmap</span><span class="op" id="1500614">)</span><span class="op" id="1500615">(</span><span class="ident" id="1500616">unsafe</span><span class="op" id="1500622">.</span><span class="ident" id="1500623">Pointer</span><span class="op" id="1500630">(</span><span class="builtintype" id="1500631">uintptr</span><span class="op" id="1500638">(</span><span class="ident" id="1500639">c</span><span class="op" id="1500640">)</span>&nbsp;<span class="op" id="1500642">+</span>&nbsp;<span class="op" id="1500644">(</span><span class="ident" id="1500645">hash</span><span class="op" id="1500649">&amp;</span><span class="op" id="1500650">(</span><span class="ident" id="1500651">m</span><span class="op" id="1500652">&gt;&gt;</span><span class="num" id="1500654">1</span><span class="op" id="1500655">)</span><span class="op" id="1500656">)</span><span class="op" id="1500657">*</span><span class="builtintype" id="1500658">uintptr</span><span class="op" id="1500665">(</span><span class="ident" id="1500666">t</span><span class="op" id="1500667">.</span><span class="ident" id="1500668">bucketsize</span><span class="op" id="1500678">)</span><span class="op" id="1500679">)</span><span class="op" id="1500680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500684">if</span>&nbsp;<span class="op" id="1500687">!</span><span class="ident" id="1500688">evacuated</span><span class="op" id="1500697">(</span><span class="ident" id="1500698">oldb</span><span class="op" id="1500702">)</span>&nbsp;<span class="op" id="1500704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500709">b</span>&nbsp;<span class="op" id="1500711">=</span>&nbsp;<span class="ident" id="1500713">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500723">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500726">top</span>&nbsp;<span class="op" id="1500730">:=</span>&nbsp;<span class="builtintype" id="1500733">uint8</span><span class="op" id="1500738">(</span><span class="ident" id="1500739">hash</span>&nbsp;<span class="op" id="1500744">&gt;&gt;</span>&nbsp;<span class="op" id="1500747">(</span><span class="ident" id="1500748">ptrSize</span><span class="op" id="1500755">*</span><span class="num" id="1500756">8</span>&nbsp;<span class="op" id="1500758">-</span>&nbsp;<span class="num" id="1500760">8</span><span class="op" id="1500761">)</span><span class="op" id="1500762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500765">if</span>&nbsp;<span class="ident" id="1500768">top</span>&nbsp;<span class="op" id="1500772">&lt;</span>&nbsp;<span class="ident" id="1500774">minTopHash</span>&nbsp;<span class="op" id="1500785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500789">top</span>&nbsp;<span class="op" id="1500793">+=</span>&nbsp;<span class="ident" id="1500796">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500811">for</span>&nbsp;<span class="op" id="1500815">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500819">for</span>&nbsp;<span class="ident" id="1500823">i</span>&nbsp;<span class="op" id="1500825">:=</span>&nbsp;<span class="builtintype" id="1500828">uintptr</span><span class="op" id="1500835">(</span><span class="num" id="1500836">0</span><span class="op" id="1500837">)</span><span class="op" id="1500838">;</span>&nbsp;<span class="ident" id="1500840">i</span>&nbsp;<span class="op" id="1500842">&lt;</span>&nbsp;<span class="ident" id="1500844">bucketCnt</span><span class="op" id="1500853">;</span>&nbsp;<span class="ident" id="1500855">i</span><span class="op" id="1500856">++</span>&nbsp;<span class="op" id="1500859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500864">if</span>&nbsp;<span class="ident" id="1500867">b</span><span class="op" id="1500868">.</span><span class="ident" id="1500869">tophash</span><span class="op" id="1500876">[</span><span class="ident" id="1500877">i</span><span class="op" id="1500878">]</span>&nbsp;<span class="op" id="1500880">!=</span>&nbsp;<span class="ident" id="1500883">top</span>&nbsp;<span class="op" id="1500887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500893">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500910">k</span>&nbsp;<span class="op" id="1500912">:=</span>&nbsp;<span class="ident" id="1500915">add</span><span class="op" id="1500918">(</span><span class="ident" id="1500919">unsafe</span><span class="op" id="1500925">.</span><span class="ident" id="1500926">Pointer</span><span class="op" id="1500933">(</span><span class="ident" id="1500934">b</span><span class="op" id="1500935">)</span><span class="op" id="1500936">,</span>&nbsp;<span class="ident" id="1500938">dataOffset</span><span class="op" id="1500948">+</span><span class="ident" id="1500949">i</span><span class="op" id="1500950">*</span><span class="builtintype" id="1500951">uintptr</span><span class="op" id="1500958">(</span><span class="ident" id="1500959">t</span><span class="op" id="1500960">.</span><span class="ident" id="1500961">keysize</span><span class="op" id="1500968">)</span><span class="op" id="1500969">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500974">if</span>&nbsp;<span class="ident" id="1500977">t</span><span class="op" id="1500978">.</span><span class="ident" id="1500979">indirectkey</span>&nbsp;<span class="op" id="1500991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500997">k</span>&nbsp;<span class="op" id="1500999">=</span>&nbsp;<span class="op" id="1501001">*</span><span class="op" id="1501002">(</span><span class="op" id="1501003">(</span><span class="op" id="1501004">*</span><span class="ident" id="1501005">unsafe</span><span class="op" id="1501011">.</span><span class="ident" id="1501012">Pointer</span><span class="op" id="1501019">)</span><span class="op" id="1501020">(</span><span class="ident" id="1501021">k</span><span class="op" id="1501022">)</span><span class="op" id="1501023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501033">if</span>&nbsp;<span class="ident" id="1501036">alg</span><span class="op" id="1501039">.</span><span class="ident" id="1501040">equal</span><span class="op" id="1501045">(</span><span class="ident" id="1501046">key</span><span class="op" id="1501049">,</span>&nbsp;<span class="ident" id="1501051">k</span><span class="op" id="1501052">,</span>&nbsp;<span class="builtintype" id="1501054">uintptr</span><span class="op" id="1501061">(</span><span class="ident" id="1501062">t</span><span class="op" id="1501063">.</span><span class="ident" id="1501064">key</span><span class="op" id="1501067">.</span><span class="ident" id="1501068">size</span><span class="op" id="1501072">)</span><span class="op" id="1501073">)</span>&nbsp;<span class="op" id="1501075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501081">v</span>&nbsp;<span class="op" id="1501083">:=</span>&nbsp;<span class="ident" id="1501086">add</span><span class="op" id="1501089">(</span><span class="ident" id="1501090">unsafe</span><span class="op" id="1501096">.</span><span class="ident" id="1501097">Pointer</span><span class="op" id="1501104">(</span><span class="ident" id="1501105">b</span><span class="op" id="1501106">)</span><span class="op" id="1501107">,</span>&nbsp;<span class="ident" id="1501109">dataOffset</span><span class="op" id="1501119">+</span><span class="ident" id="1501120">bucketCnt</span><span class="op" id="1501129">*</span><span class="builtintype" id="1501130">uintptr</span><span class="op" id="1501137">(</span><span class="ident" id="1501138">t</span><span class="op" id="1501139">.</span><span class="ident" id="1501140">keysize</span><span class="op" id="1501147">)</span><span class="op" id="1501148">+</span><span class="ident" id="1501149">i</span><span class="op" id="1501150">*</span><span class="builtintype" id="1501151">uintptr</span><span class="op" id="1501158">(</span><span class="ident" id="1501159">t</span><span class="op" id="1501160">.</span><span class="ident" id="1501161">valuesize</span><span class="op" id="1501170">)</span><span class="op" id="1501171">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501177">if</span>&nbsp;<span class="ident" id="1501180">t</span><span class="op" id="1501181">.</span><span class="ident" id="1501182">indirectvalue</span>&nbsp;<span class="op" id="1501196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501203">v</span>&nbsp;<span class="op" id="1501205">=</span>&nbsp;<span class="op" id="1501207">*</span><span class="op" id="1501208">(</span><span class="op" id="1501209">(</span><span class="op" id="1501210">*</span><span class="ident" id="1501211">unsafe</span><span class="op" id="1501217">.</span><span class="ident" id="1501218">Pointer</span><span class="op" id="1501225">)</span><span class="op" id="1501226">(</span><span class="ident" id="1501227">v</span><span class="op" id="1501228">)</span><span class="op" id="1501229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501241">return</span>&nbsp;<span class="ident" id="1501248">v</span><span class="op" id="1501249">,</span>&nbsp;<span class="builtintype" id="1501251">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501259">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501267">b</span>&nbsp;<span class="op" id="1501269">=</span>&nbsp;<span class="ident" id="1501271">b</span><span class="op" id="1501272">.</span><span class="ident" id="1501273">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501284">if</span>&nbsp;<span class="ident" id="1501287">b</span>&nbsp;<span class="op" id="1501289">==</span>&nbsp;<span class="ident" id="1501292">nil</span>&nbsp;<span class="op" id="1501296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501301">return</span>&nbsp;<span class="ident" id="1501308">unsafe</span><span class="op" id="1501314">.</span><span class="ident" id="1501315">Pointer</span><span class="op" id="1501322">(</span><span class="ident" id="1501323">t</span><span class="op" id="1501324">.</span><span class="ident" id="1501325">elem</span><span class="op" id="1501329">.</span><span class="ident" id="1501330">zero</span><span class="op" id="1501334">)</span><span class="op" id="1501335">,</span>&nbsp;<span class="builtintype" id="1501337">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501345">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501348">}</span><br>
<span class="lineno"></span><span class="op" id="1501350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1501353">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1501406">func</span>&nbsp;<span class="ident" id="1501411">mapaccessK</span><span class="op" id="1501421">(</span><span class="ident" id="1501422">t</span>&nbsp;<span class="op" id="1501424">*</span><span class="ident" id="1501425">maptype</span><span class="op" id="1501432">,</span>&nbsp;<span class="ident" id="1501434">h</span>&nbsp;<span class="op" id="1501436">*</span><span class="ident" id="1501437">hmap</span><span class="op" id="1501441">,</span>&nbsp;<span class="ident" id="1501443">key</span>&nbsp;<span class="ident" id="1501447">unsafe</span><span class="op" id="1501453">.</span><span class="ident" id="1501454">Pointer</span><span class="op" id="1501461">)</span>&nbsp;<span class="op" id="1501463">(</span><span class="ident" id="1501464">unsafe</span><span class="op" id="1501470">.</span><span class="ident" id="1501471">Pointer</span><span class="op" id="1501478">,</span>&nbsp;<span class="ident" id="1501480">unsafe</span><span class="op" id="1501486">.</span><span class="ident" id="1501487">Pointer</span><span class="op" id="1501494">)</span>&nbsp;<span class="op" id="1501496">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501499">if</span>&nbsp;<span class="ident" id="1501502">h</span>&nbsp;<span class="op" id="1501504">==</span>&nbsp;<span class="ident" id="1501507">nil</span>&nbsp;<span class="op" id="1501511">||</span>&nbsp;<span class="ident" id="1501514">h</span><span class="op" id="1501515">.</span><span class="ident" id="1501516">count</span>&nbsp;<span class="op" id="1501522">==</span>&nbsp;<span class="num" id="1501525">0</span>&nbsp;<span class="op" id="1501527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501531">return</span>&nbsp;<span class="ident" id="1501538">nil</span><span class="op" id="1501541">,</span>&nbsp;<span class="ident" id="1501543">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501551">alg</span>&nbsp;<span class="op" id="1501555">:=</span>&nbsp;<span class="ident" id="1501558">goalg</span><span class="op" id="1501563">(</span><span class="ident" id="1501564">t</span><span class="op" id="1501565">.</span><span class="ident" id="1501566">key</span><span class="op" id="1501569">.</span><span class="ident" id="1501570">alg</span><span class="op" id="1501573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501576">hash</span>&nbsp;<span class="op" id="1501581">:=</span>&nbsp;<span class="ident" id="1501584">alg</span><span class="op" id="1501587">.</span><span class="ident" id="1501588">hash</span><span class="op" id="1501592">(</span><span class="ident" id="1501593">key</span><span class="op" id="1501596">,</span>&nbsp;<span class="builtintype" id="1501598">uintptr</span><span class="op" id="1501605">(</span><span class="ident" id="1501606">t</span><span class="op" id="1501607">.</span><span class="ident" id="1501608">key</span><span class="op" id="1501611">.</span><span class="ident" id="1501612">size</span><span class="op" id="1501616">)</span><span class="op" id="1501617">,</span>&nbsp;<span class="builtintype" id="1501619">uintptr</span><span class="op" id="1501626">(</span><span class="ident" id="1501627">h</span><span class="op" id="1501628">.</span><span class="ident" id="1501629">hash0</span><span class="op" id="1501634">)</span><span class="op" id="1501635">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501638">m</span>&nbsp;<span class="op" id="1501640">:=</span>&nbsp;<span class="builtintype" id="1501643">uintptr</span><span class="op" id="1501650">(</span><span class="num" id="1501651">1</span><span class="op" id="1501652">)</span><span class="op" id="1501653">&lt;&lt;</span><span class="ident" id="1501655">h</span><span class="op" id="1501656">.</span><span class="ident" id="1501657">B</span>&nbsp;<span class="op" id="1501659">-</span>&nbsp;<span class="num" id="1501661">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501664">b</span>&nbsp;<span class="op" id="1501666">:=</span>&nbsp;<span class="op" id="1501669">(</span><span class="op" id="1501670">*</span><span class="ident" id="1501671">bmap</span><span class="op" id="1501675">)</span><span class="op" id="1501676">(</span><span class="ident" id="1501677">unsafe</span><span class="op" id="1501683">.</span><span class="ident" id="1501684">Pointer</span><span class="op" id="1501691">(</span><span class="builtintype" id="1501692">uintptr</span><span class="op" id="1501699">(</span><span class="ident" id="1501700">h</span><span class="op" id="1501701">.</span><span class="ident" id="1501702">buckets</span><span class="op" id="1501709">)</span>&nbsp;<span class="op" id="1501711">+</span>&nbsp;<span class="op" id="1501713">(</span><span class="ident" id="1501714">hash</span><span class="op" id="1501718">&amp;</span><span class="ident" id="1501719">m</span><span class="op" id="1501720">)</span><span class="op" id="1501721">*</span><span class="builtintype" id="1501722">uintptr</span><span class="op" id="1501729">(</span><span class="ident" id="1501730">t</span><span class="op" id="1501731">.</span><span class="ident" id="1501732">bucketsize</span><span class="op" id="1501742">)</span><span class="op" id="1501743">)</span><span class="op" id="1501744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501747">if</span>&nbsp;<span class="ident" id="1501750">c</span>&nbsp;<span class="op" id="1501752">:=</span>&nbsp;<span class="ident" id="1501755">h</span><span class="op" id="1501756">.</span><span class="ident" id="1501757">oldbuckets</span><span class="op" id="1501767">;</span>&nbsp;<span class="ident" id="1501769">c</span>&nbsp;<span class="op" id="1501771">!=</span>&nbsp;<span class="ident" id="1501774">nil</span>&nbsp;<span class="op" id="1501778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501782">oldb</span>&nbsp;<span class="op" id="1501787">:=</span>&nbsp;<span class="op" id="1501790">(</span><span class="op" id="1501791">*</span><span class="ident" id="1501792">bmap</span><span class="op" id="1501796">)</span><span class="op" id="1501797">(</span><span class="ident" id="1501798">unsafe</span><span class="op" id="1501804">.</span><span class="ident" id="1501805">Pointer</span><span class="op" id="1501812">(</span><span class="builtintype" id="1501813">uintptr</span><span class="op" id="1501820">(</span><span class="ident" id="1501821">c</span><span class="op" id="1501822">)</span>&nbsp;<span class="op" id="1501824">+</span>&nbsp;<span class="op" id="1501826">(</span><span class="ident" id="1501827">hash</span><span class="op" id="1501831">&amp;</span><span class="op" id="1501832">(</span><span class="ident" id="1501833">m</span><span class="op" id="1501834">&gt;&gt;</span><span class="num" id="1501836">1</span><span class="op" id="1501837">)</span><span class="op" id="1501838">)</span><span class="op" id="1501839">*</span><span class="builtintype" id="1501840">uintptr</span><span class="op" id="1501847">(</span><span class="ident" id="1501848">t</span><span class="op" id="1501849">.</span><span class="ident" id="1501850">bucketsize</span><span class="op" id="1501860">)</span><span class="op" id="1501861">)</span><span class="op" id="1501862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501866">if</span>&nbsp;<span class="op" id="1501869">!</span><span class="ident" id="1501870">evacuated</span><span class="op" id="1501879">(</span><span class="ident" id="1501880">oldb</span><span class="op" id="1501884">)</span>&nbsp;<span class="op" id="1501886">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501891">b</span>&nbsp;<span class="op" id="1501893">=</span>&nbsp;<span class="ident" id="1501895">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501908">top</span>&nbsp;<span class="op" id="1501912">:=</span>&nbsp;<span class="builtintype" id="1501915">uint8</span><span class="op" id="1501920">(</span><span class="ident" id="1501921">hash</span>&nbsp;<span class="op" id="1501926">&gt;&gt;</span>&nbsp;<span class="op" id="1501929">(</span><span class="ident" id="1501930">ptrSize</span><span class="op" id="1501937">*</span><span class="num" id="1501938">8</span>&nbsp;<span class="op" id="1501940">-</span>&nbsp;<span class="num" id="1501942">8</span><span class="op" id="1501943">)</span><span class="op" id="1501944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501947">if</span>&nbsp;<span class="ident" id="1501950">top</span>&nbsp;<span class="op" id="1501954">&lt;</span>&nbsp;<span class="ident" id="1501956">minTopHash</span>&nbsp;<span class="op" id="1501967">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501971">top</span>&nbsp;<span class="op" id="1501975">+=</span>&nbsp;<span class="ident" id="1501978">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501993">for</span>&nbsp;<span class="op" id="1501997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502001">for</span>&nbsp;<span class="ident" id="1502005">i</span>&nbsp;<span class="op" id="1502007">:=</span>&nbsp;<span class="builtintype" id="1502010">uintptr</span><span class="op" id="1502017">(</span><span class="num" id="1502018">0</span><span class="op" id="1502019">)</span><span class="op" id="1502020">;</span>&nbsp;<span class="ident" id="1502022">i</span>&nbsp;<span class="op" id="1502024">&lt;</span>&nbsp;<span class="ident" id="1502026">bucketCnt</span><span class="op" id="1502035">;</span>&nbsp;<span class="ident" id="1502037">i</span><span class="op" id="1502038">++</span>&nbsp;<span class="op" id="1502041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502046">if</span>&nbsp;<span class="ident" id="1502049">b</span><span class="op" id="1502050">.</span><span class="ident" id="1502051">tophash</span><span class="op" id="1502058">[</span><span class="ident" id="1502059">i</span><span class="op" id="1502060">]</span>&nbsp;<span class="op" id="1502062">!=</span>&nbsp;<span class="ident" id="1502065">top</span>&nbsp;<span class="op" id="1502069">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502075">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502092">k</span>&nbsp;<span class="op" id="1502094">:=</span>&nbsp;<span class="ident" id="1502097">add</span><span class="op" id="1502100">(</span><span class="ident" id="1502101">unsafe</span><span class="op" id="1502107">.</span><span class="ident" id="1502108">Pointer</span><span class="op" id="1502115">(</span><span class="ident" id="1502116">b</span><span class="op" id="1502117">)</span><span class="op" id="1502118">,</span>&nbsp;<span class="ident" id="1502120">dataOffset</span><span class="op" id="1502130">+</span><span class="ident" id="1502131">i</span><span class="op" id="1502132">*</span><span class="builtintype" id="1502133">uintptr</span><span class="op" id="1502140">(</span><span class="ident" id="1502141">t</span><span class="op" id="1502142">.</span><span class="ident" id="1502143">keysize</span><span class="op" id="1502150">)</span><span class="op" id="1502151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502156">if</span>&nbsp;<span class="ident" id="1502159">t</span><span class="op" id="1502160">.</span><span class="ident" id="1502161">indirectkey</span>&nbsp;<span class="op" id="1502173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502179">k</span>&nbsp;<span class="op" id="1502181">=</span>&nbsp;<span class="op" id="1502183">*</span><span class="op" id="1502184">(</span><span class="op" id="1502185">(</span><span class="op" id="1502186">*</span><span class="ident" id="1502187">unsafe</span><span class="op" id="1502193">.</span><span class="ident" id="1502194">Pointer</span><span class="op" id="1502201">)</span><span class="op" id="1502202">(</span><span class="ident" id="1502203">k</span><span class="op" id="1502204">)</span><span class="op" id="1502205">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502215">if</span>&nbsp;<span class="ident" id="1502218">alg</span><span class="op" id="1502221">.</span><span class="ident" id="1502222">equal</span><span class="op" id="1502227">(</span><span class="ident" id="1502228">key</span><span class="op" id="1502231">,</span>&nbsp;<span class="ident" id="1502233">k</span><span class="op" id="1502234">,</span>&nbsp;<span class="builtintype" id="1502236">uintptr</span><span class="op" id="1502243">(</span><span class="ident" id="1502244">t</span><span class="op" id="1502245">.</span><span class="ident" id="1502246">key</span><span class="op" id="1502249">.</span><span class="ident" id="1502250">size</span><span class="op" id="1502254">)</span><span class="op" id="1502255">)</span>&nbsp;<span class="op" id="1502257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502263">v</span>&nbsp;<span class="op" id="1502265">:=</span>&nbsp;<span class="ident" id="1502268">add</span><span class="op" id="1502271">(</span><span class="ident" id="1502272">unsafe</span><span class="op" id="1502278">.</span><span class="ident" id="1502279">Pointer</span><span class="op" id="1502286">(</span><span class="ident" id="1502287">b</span><span class="op" id="1502288">)</span><span class="op" id="1502289">,</span>&nbsp;<span class="ident" id="1502291">dataOffset</span><span class="op" id="1502301">+</span><span class="ident" id="1502302">bucketCnt</span><span class="op" id="1502311">*</span><span class="builtintype" id="1502312">uintptr</span><span class="op" id="1502319">(</span><span class="ident" id="1502320">t</span><span class="op" id="1502321">.</span><span class="ident" id="1502322">keysize</span><span class="op" id="1502329">)</span><span class="op" id="1502330">+</span><span class="ident" id="1502331">i</span><span class="op" id="1502332">*</span><span class="builtintype" id="1502333">uintptr</span><span class="op" id="1502340">(</span><span class="ident" id="1502341">t</span><span class="op" id="1502342">.</span><span class="ident" id="1502343">valuesize</span><span class="op" id="1502352">)</span><span class="op" id="1502353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502359">if</span>&nbsp;<span class="ident" id="1502362">t</span><span class="op" id="1502363">.</span><span class="ident" id="1502364">indirectvalue</span>&nbsp;<span class="op" id="1502378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502385">v</span>&nbsp;<span class="op" id="1502387">=</span>&nbsp;<span class="op" id="1502389">*</span><span class="op" id="1502390">(</span><span class="op" id="1502391">(</span><span class="op" id="1502392">*</span><span class="ident" id="1502393">unsafe</span><span class="op" id="1502399">.</span><span class="ident" id="1502400">Pointer</span><span class="op" id="1502407">)</span><span class="op" id="1502408">(</span><span class="ident" id="1502409">v</span><span class="op" id="1502410">)</span><span class="op" id="1502411">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502423">return</span>&nbsp;<span class="ident" id="1502430">k</span><span class="op" id="1502431">,</span>&nbsp;<span class="ident" id="1502433">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502446">b</span>&nbsp;<span class="op" id="1502448">=</span>&nbsp;<span class="ident" id="1502450">b</span><span class="op" id="1502451">.</span><span class="ident" id="1502452">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502463">if</span>&nbsp;<span class="ident" id="1502466">b</span>&nbsp;<span class="op" id="1502468">==</span>&nbsp;<span class="ident" id="1502471">nil</span>&nbsp;<span class="op" id="1502475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502480">return</span>&nbsp;<span class="ident" id="1502487">nil</span><span class="op" id="1502490">,</span>&nbsp;<span class="ident" id="1502492">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502501">}</span><br>
<span class="lineno"></span><span class="op" id="1502503">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1502506">func</span>&nbsp;<span class="ident" id="1502511">mapassign1</span><span class="op" id="1502521">(</span><span class="ident" id="1502522">t</span>&nbsp;<span class="op" id="1502524">*</span><span class="ident" id="1502525">maptype</span><span class="op" id="1502532">,</span>&nbsp;<span class="ident" id="1502534">h</span>&nbsp;<span class="op" id="1502536">*</span><span class="ident" id="1502537">hmap</span><span class="op" id="1502541">,</span>&nbsp;<span class="ident" id="1502543">key</span>&nbsp;<span class="ident" id="1502547">unsafe</span><span class="op" id="1502553">.</span><span class="ident" id="1502554">Pointer</span><span class="op" id="1502561">,</span>&nbsp;<span class="ident" id="1502563">val</span>&nbsp;<span class="ident" id="1502567">unsafe</span><span class="op" id="1502573">.</span><span class="ident" id="1502574">Pointer</span><span class="op" id="1502581">)</span>&nbsp;<span class="op" id="1502583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502586">if</span>&nbsp;<span class="ident" id="1502589">h</span>&nbsp;<span class="op" id="1502591">==</span>&nbsp;<span class="ident" id="1502594">nil</span>&nbsp;<span class="op" id="1502598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1502602">panic</span><span class="op" id="1502607">(</span><span class="string" id="1502608">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1502640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502643">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502646">if</span>&nbsp;<span class="ident" id="1502649">raceenabled</span>&nbsp;<span class="op" id="1502661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502665">callerpc</span>&nbsp;<span class="op" id="1502674">:=</span>&nbsp;<span class="ident" id="1502677">getcallerpc</span><span class="op" id="1502688">(</span><span class="ident" id="1502689">unsafe</span><span class="op" id="1502695">.</span><span class="ident" id="1502696">Pointer</span><span class="op" id="1502703">(</span><span class="op" id="1502704">&amp;</span><span class="ident" id="1502705">t</span><span class="op" id="1502706">)</span><span class="op" id="1502707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502711">pc</span>&nbsp;<span class="op" id="1502714">:=</span>&nbsp;<span class="ident" id="1502717">funcPC</span><span class="op" id="1502723">(</span><span class="ident" id="1502724">mapassign1</span><span class="op" id="1502734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502738">racewritepc</span><span class="op" id="1502749">(</span><span class="ident" id="1502750">unsafe</span><span class="op" id="1502756">.</span><span class="ident" id="1502757">Pointer</span><span class="op" id="1502764">(</span><span class="ident" id="1502765">h</span><span class="op" id="1502766">)</span><span class="op" id="1502767">,</span>&nbsp;<span class="ident" id="1502769">callerpc</span><span class="op" id="1502777">,</span>&nbsp;<span class="ident" id="1502779">pc</span><span class="op" id="1502781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502785">raceReadObjectPC</span><span class="op" id="1502801">(</span><span class="ident" id="1502802">t</span><span class="op" id="1502803">.</span><span class="ident" id="1502804">key</span><span class="op" id="1502807">,</span>&nbsp;<span class="ident" id="1502809">key</span><span class="op" id="1502812">,</span>&nbsp;<span class="ident" id="1502814">callerpc</span><span class="op" id="1502822">,</span>&nbsp;<span class="ident" id="1502824">pc</span><span class="op" id="1502826">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502830">raceReadObjectPC</span><span class="op" id="1502846">(</span><span class="ident" id="1502847">t</span><span class="op" id="1502848">.</span><span class="ident" id="1502849">elem</span><span class="op" id="1502853">,</span>&nbsp;<span class="ident" id="1502855">val</span><span class="op" id="1502858">,</span>&nbsp;<span class="ident" id="1502860">callerpc</span><span class="op" id="1502868">,</span>&nbsp;<span class="ident" id="1502870">pc</span><span class="op" id="1502872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502879">alg</span>&nbsp;<span class="op" id="1502883">:=</span>&nbsp;<span class="ident" id="1502886">goalg</span><span class="op" id="1502891">(</span><span class="ident" id="1502892">t</span><span class="op" id="1502893">.</span><span class="ident" id="1502894">key</span><span class="op" id="1502897">.</span><span class="ident" id="1502898">alg</span><span class="op" id="1502901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502904">hash</span>&nbsp;<span class="op" id="1502909">:=</span>&nbsp;<span class="ident" id="1502912">alg</span><span class="op" id="1502915">.</span><span class="ident" id="1502916">hash</span><span class="op" id="1502920">(</span><span class="ident" id="1502921">key</span><span class="op" id="1502924">,</span>&nbsp;<span class="builtintype" id="1502926">uintptr</span><span class="op" id="1502933">(</span><span class="ident" id="1502934">t</span><span class="op" id="1502935">.</span><span class="ident" id="1502936">key</span><span class="op" id="1502939">.</span><span class="ident" id="1502940">size</span><span class="op" id="1502944">)</span><span class="op" id="1502945">,</span>&nbsp;<span class="builtintype" id="1502947">uintptr</span><span class="op" id="1502954">(</span><span class="ident" id="1502955">h</span><span class="op" id="1502956">.</span><span class="ident" id="1502957">hash0</span><span class="op" id="1502962">)</span><span class="op" id="1502963">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502967">if</span>&nbsp;<span class="ident" id="1502970">h</span><span class="op" id="1502971">.</span><span class="ident" id="1502972">buckets</span>&nbsp;<span class="op" id="1502980">==</span>&nbsp;<span class="ident" id="1502983">nil</span>&nbsp;<span class="op" id="1502987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502991">if</span>&nbsp;<span class="ident" id="1502994">checkgc</span>&nbsp;<span class="op" id="1503002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503007">memstats</span><span class="op" id="1503015">.</span><span class="ident" id="1503016">next_gc</span>&nbsp;<span class="op" id="1503024">=</span>&nbsp;<span class="ident" id="1503026">memstats</span><span class="op" id="1503034">.</span><span class="ident" id="1503035">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503048">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503052">h</span><span class="op" id="1503053">.</span><span class="ident" id="1503054">buckets</span>&nbsp;<span class="op" id="1503062">=</span>&nbsp;<span class="ident" id="1503064">newarray</span><span class="op" id="1503072">(</span><span class="ident" id="1503073">t</span><span class="op" id="1503074">.</span><span class="ident" id="1503075">bucket</span><span class="op" id="1503081">,</span>&nbsp;<span class="num" id="1503083">1</span><span class="op" id="1503084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1503090">again</span><span class="op" id="1503095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503098">bucket</span>&nbsp;<span class="op" id="1503105">:=</span>&nbsp;<span class="ident" id="1503108">hash</span>&nbsp;<span class="op" id="1503113">&amp;</span>&nbsp;<span class="op" id="1503115">(</span><span class="builtintype" id="1503116">uintptr</span><span class="op" id="1503123">(</span><span class="num" id="1503124">1</span><span class="op" id="1503125">)</span><span class="op" id="1503126">&lt;&lt;</span><span class="ident" id="1503128">h</span><span class="op" id="1503129">.</span><span class="ident" id="1503130">B</span>&nbsp;<span class="op" id="1503132">-</span>&nbsp;<span class="num" id="1503134">1</span><span class="op" id="1503135">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503138">if</span>&nbsp;<span class="ident" id="1503141">h</span><span class="op" id="1503142">.</span><span class="ident" id="1503143">oldbuckets</span>&nbsp;<span class="op" id="1503154">!=</span>&nbsp;<span class="ident" id="1503157">nil</span>&nbsp;<span class="op" id="1503161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503165">growWork</span><span class="op" id="1503173">(</span><span class="ident" id="1503174">t</span><span class="op" id="1503175">,</span>&nbsp;<span class="ident" id="1503177">h</span><span class="op" id="1503178">,</span>&nbsp;<span class="ident" id="1503180">bucket</span><span class="op" id="1503186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503192">b</span>&nbsp;<span class="op" id="1503194">:=</span>&nbsp;<span class="op" id="1503197">(</span><span class="op" id="1503198">*</span><span class="ident" id="1503199">bmap</span><span class="op" id="1503203">)</span><span class="op" id="1503204">(</span><span class="ident" id="1503205">unsafe</span><span class="op" id="1503211">.</span><span class="ident" id="1503212">Pointer</span><span class="op" id="1503219">(</span><span class="builtintype" id="1503220">uintptr</span><span class="op" id="1503227">(</span><span class="ident" id="1503228">h</span><span class="op" id="1503229">.</span><span class="ident" id="1503230">buckets</span><span class="op" id="1503237">)</span>&nbsp;<span class="op" id="1503239">+</span>&nbsp;<span class="ident" id="1503241">bucket</span><span class="op" id="1503247">*</span><span class="builtintype" id="1503248">uintptr</span><span class="op" id="1503255">(</span><span class="ident" id="1503256">t</span><span class="op" id="1503257">.</span><span class="ident" id="1503258">bucketsize</span><span class="op" id="1503268">)</span><span class="op" id="1503269">)</span><span class="op" id="1503270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503273">top</span>&nbsp;<span class="op" id="1503277">:=</span>&nbsp;<span class="builtintype" id="1503280">uint8</span><span class="op" id="1503285">(</span><span class="ident" id="1503286">hash</span>&nbsp;<span class="op" id="1503291">&gt;&gt;</span>&nbsp;<span class="op" id="1503294">(</span><span class="ident" id="1503295">ptrSize</span><span class="op" id="1503302">*</span><span class="num" id="1503303">8</span>&nbsp;<span class="op" id="1503305">-</span>&nbsp;<span class="num" id="1503307">8</span><span class="op" id="1503308">)</span><span class="op" id="1503309">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503312">if</span>&nbsp;<span class="ident" id="1503315">top</span>&nbsp;<span class="op" id="1503319">&lt;</span>&nbsp;<span class="ident" id="1503321">minTopHash</span>&nbsp;<span class="op" id="1503332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503336">top</span>&nbsp;<span class="op" id="1503340">+=</span>&nbsp;<span class="ident" id="1503343">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503359">var</span>&nbsp;<span class="ident" id="1503363">inserti</span>&nbsp;<span class="op" id="1503371">*</span><span class="builtintype" id="1503372">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503379">var</span>&nbsp;<span class="ident" id="1503383">insertk</span>&nbsp;<span class="ident" id="1503391">unsafe</span><span class="op" id="1503397">.</span><span class="ident" id="1503398">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503407">var</span>&nbsp;<span class="ident" id="1503411">insertv</span>&nbsp;<span class="ident" id="1503419">unsafe</span><span class="op" id="1503425">.</span><span class="ident" id="1503426">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503435">for</span>&nbsp;<span class="op" id="1503439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503443">for</span>&nbsp;<span class="ident" id="1503447">i</span>&nbsp;<span class="op" id="1503449">:=</span>&nbsp;<span class="builtintype" id="1503452">uintptr</span><span class="op" id="1503459">(</span><span class="num" id="1503460">0</span><span class="op" id="1503461">)</span><span class="op" id="1503462">;</span>&nbsp;<span class="ident" id="1503464">i</span>&nbsp;<span class="op" id="1503466">&lt;</span>&nbsp;<span class="ident" id="1503468">bucketCnt</span><span class="op" id="1503477">;</span>&nbsp;<span class="ident" id="1503479">i</span><span class="op" id="1503480">++</span>&nbsp;<span class="op" id="1503483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503488">if</span>&nbsp;<span class="ident" id="1503491">b</span><span class="op" id="1503492">.</span><span class="ident" id="1503493">tophash</span><span class="op" id="1503500">[</span><span class="ident" id="1503501">i</span><span class="op" id="1503502">]</span>&nbsp;<span class="op" id="1503504">!=</span>&nbsp;<span class="ident" id="1503507">top</span>&nbsp;<span class="op" id="1503511">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503517">if</span>&nbsp;<span class="ident" id="1503520">b</span><span class="op" id="1503521">.</span><span class="ident" id="1503522">tophash</span><span class="op" id="1503529">[</span><span class="ident" id="1503530">i</span><span class="op" id="1503531">]</span>&nbsp;<span class="op" id="1503533">==</span>&nbsp;<span class="ident" id="1503536">empty</span>&nbsp;<span class="op" id="1503542">&amp;&amp;</span>&nbsp;<span class="ident" id="1503545">inserti</span>&nbsp;<span class="op" id="1503553">==</span>&nbsp;<span class="ident" id="1503556">nil</span>&nbsp;<span class="op" id="1503560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503567">inserti</span>&nbsp;<span class="op" id="1503575">=</span>&nbsp;<span class="op" id="1503577">&amp;</span><span class="ident" id="1503578">b</span><span class="op" id="1503579">.</span><span class="ident" id="1503580">tophash</span><span class="op" id="1503587">[</span><span class="ident" id="1503588">i</span><span class="op" id="1503589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503596">insertk</span>&nbsp;<span class="op" id="1503604">=</span>&nbsp;<span class="ident" id="1503606">add</span><span class="op" id="1503609">(</span><span class="ident" id="1503610">unsafe</span><span class="op" id="1503616">.</span><span class="ident" id="1503617">Pointer</span><span class="op" id="1503624">(</span><span class="ident" id="1503625">b</span><span class="op" id="1503626">)</span><span class="op" id="1503627">,</span>&nbsp;<span class="ident" id="1503629">dataOffset</span><span class="op" id="1503639">+</span><span class="ident" id="1503640">i</span><span class="op" id="1503641">*</span><span class="builtintype" id="1503642">uintptr</span><span class="op" id="1503649">(</span><span class="ident" id="1503650">t</span><span class="op" id="1503651">.</span><span class="ident" id="1503652">keysize</span><span class="op" id="1503659">)</span><span class="op" id="1503660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503667">insertv</span>&nbsp;<span class="op" id="1503675">=</span>&nbsp;<span class="ident" id="1503677">add</span><span class="op" id="1503680">(</span><span class="ident" id="1503681">unsafe</span><span class="op" id="1503687">.</span><span class="ident" id="1503688">Pointer</span><span class="op" id="1503695">(</span><span class="ident" id="1503696">b</span><span class="op" id="1503697">)</span><span class="op" id="1503698">,</span>&nbsp;<span class="ident" id="1503700">dataOffset</span><span class="op" id="1503710">+</span><span class="ident" id="1503711">bucketCnt</span><span class="op" id="1503720">*</span><span class="builtintype" id="1503721">uintptr</span><span class="op" id="1503728">(</span><span class="ident" id="1503729">t</span><span class="op" id="1503730">.</span><span class="ident" id="1503731">keysize</span><span class="op" id="1503738">)</span><span class="op" id="1503739">+</span><span class="ident" id="1503740">i</span><span class="op" id="1503741">*</span><span class="builtintype" id="1503742">uintptr</span><span class="op" id="1503749">(</span><span class="ident" id="1503750">t</span><span class="op" id="1503751">.</span><span class="ident" id="1503752">valuesize</span><span class="op" id="1503761">)</span><span class="op" id="1503762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503768">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503774">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503791">k</span>&nbsp;<span class="op" id="1503793">:=</span>&nbsp;<span class="ident" id="1503796">add</span><span class="op" id="1503799">(</span><span class="ident" id="1503800">unsafe</span><span class="op" id="1503806">.</span><span class="ident" id="1503807">Pointer</span><span class="op" id="1503814">(</span><span class="ident" id="1503815">b</span><span class="op" id="1503816">)</span><span class="op" id="1503817">,</span>&nbsp;<span class="ident" id="1503819">dataOffset</span><span class="op" id="1503829">+</span><span class="ident" id="1503830">i</span><span class="op" id="1503831">*</span><span class="builtintype" id="1503832">uintptr</span><span class="op" id="1503839">(</span><span class="ident" id="1503840">t</span><span class="op" id="1503841">.</span><span class="ident" id="1503842">keysize</span><span class="op" id="1503849">)</span><span class="op" id="1503850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503855">k2</span>&nbsp;<span class="op" id="1503858">:=</span>&nbsp;<span class="ident" id="1503861">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503866">if</span>&nbsp;<span class="ident" id="1503869">t</span><span class="op" id="1503870">.</span><span class="ident" id="1503871">indirectkey</span>&nbsp;<span class="op" id="1503883">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503889">k2</span>&nbsp;<span class="op" id="1503892">=</span>&nbsp;<span class="op" id="1503894">*</span><span class="op" id="1503895">(</span><span class="op" id="1503896">(</span><span class="op" id="1503897">*</span><span class="ident" id="1503898">unsafe</span><span class="op" id="1503904">.</span><span class="ident" id="1503905">Pointer</span><span class="op" id="1503912">)</span><span class="op" id="1503913">(</span><span class="ident" id="1503914">k2</span><span class="op" id="1503916">)</span><span class="op" id="1503917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503927">if</span>&nbsp;<span class="op" id="1503930">!</span><span class="ident" id="1503931">alg</span><span class="op" id="1503934">.</span><span class="ident" id="1503935">equal</span><span class="op" id="1503940">(</span><span class="ident" id="1503941">key</span><span class="op" id="1503944">,</span>&nbsp;<span class="ident" id="1503946">k2</span><span class="op" id="1503948">,</span>&nbsp;<span class="builtintype" id="1503950">uintptr</span><span class="op" id="1503957">(</span><span class="ident" id="1503958">t</span><span class="op" id="1503959">.</span><span class="ident" id="1503960">key</span><span class="op" id="1503963">.</span><span class="ident" id="1503964">size</span><span class="op" id="1503968">)</span><span class="op" id="1503969">)</span>&nbsp;<span class="op" id="1503971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503977">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503989">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503994">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504044">memmove</span><span class="op" id="1504051">(</span><span class="ident" id="1504052">k2</span><span class="op" id="1504054">,</span>&nbsp;<span class="ident" id="1504056">key</span><span class="op" id="1504059">,</span>&nbsp;<span class="builtintype" id="1504061">uintptr</span><span class="op" id="1504068">(</span><span class="ident" id="1504069">t</span><span class="op" id="1504070">.</span><span class="ident" id="1504071">key</span><span class="op" id="1504074">.</span><span class="ident" id="1504075">size</span><span class="op" id="1504079">)</span><span class="op" id="1504080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504085">v</span>&nbsp;<span class="op" id="1504087">:=</span>&nbsp;<span class="ident" id="1504090">add</span><span class="op" id="1504093">(</span><span class="ident" id="1504094">unsafe</span><span class="op" id="1504100">.</span><span class="ident" id="1504101">Pointer</span><span class="op" id="1504108">(</span><span class="ident" id="1504109">b</span><span class="op" id="1504110">)</span><span class="op" id="1504111">,</span>&nbsp;<span class="ident" id="1504113">dataOffset</span><span class="op" id="1504123">+</span><span class="ident" id="1504124">bucketCnt</span><span class="op" id="1504133">*</span><span class="builtintype" id="1504134">uintptr</span><span class="op" id="1504141">(</span><span class="ident" id="1504142">t</span><span class="op" id="1504143">.</span><span class="ident" id="1504144">keysize</span><span class="op" id="1504151">)</span><span class="op" id="1504152">+</span><span class="ident" id="1504153">i</span><span class="op" id="1504154">*</span><span class="builtintype" id="1504155">uintptr</span><span class="op" id="1504162">(</span><span class="ident" id="1504163">t</span><span class="op" id="1504164">.</span><span class="ident" id="1504165">valuesize</span><span class="op" id="1504174">)</span><span class="op" id="1504175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504180">v2</span>&nbsp;<span class="op" id="1504183">:=</span>&nbsp;<span class="ident" id="1504186">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504191">if</span>&nbsp;<span class="ident" id="1504194">t</span><span class="op" id="1504195">.</span><span class="ident" id="1504196">indirectvalue</span>&nbsp;<span class="op" id="1504210">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504216">v2</span>&nbsp;<span class="op" id="1504219">=</span>&nbsp;<span class="op" id="1504221">*</span><span class="op" id="1504222">(</span><span class="op" id="1504223">(</span><span class="op" id="1504224">*</span><span class="ident" id="1504225">unsafe</span><span class="op" id="1504231">.</span><span class="ident" id="1504232">Pointer</span><span class="op" id="1504239">)</span><span class="op" id="1504240">(</span><span class="ident" id="1504241">v2</span><span class="op" id="1504243">)</span><span class="op" id="1504244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504254">memmove</span><span class="op" id="1504261">(</span><span class="ident" id="1504262">v2</span><span class="op" id="1504264">,</span>&nbsp;<span class="ident" id="1504266">val</span><span class="op" id="1504269">,</span>&nbsp;<span class="builtintype" id="1504271">uintptr</span><span class="op" id="1504278">(</span><span class="ident" id="1504279">t</span><span class="op" id="1504280">.</span><span class="ident" id="1504281">elem</span><span class="op" id="1504285">.</span><span class="ident" id="1504286">size</span><span class="op" id="1504290">)</span><span class="op" id="1504291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504296">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504305">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504309">if</span>&nbsp;<span class="ident" id="1504312">b</span><span class="op" id="1504313">.</span><span class="ident" id="1504314">overflow</span>&nbsp;<span class="op" id="1504323">==</span>&nbsp;<span class="ident" id="1504326">nil</span>&nbsp;<span class="op" id="1504330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504335">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504347">b</span>&nbsp;<span class="op" id="1504349">=</span>&nbsp;<span class="ident" id="1504351">b</span><span class="op" id="1504352">.</span><span class="ident" id="1504353">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504363">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504367">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504433">if</span>&nbsp;<span class="builtintype" id="1504436">float32</span><span class="op" id="1504443">(</span><span class="ident" id="1504444">h</span><span class="op" id="1504445">.</span><span class="ident" id="1504446">count</span><span class="op" id="1504451">)</span>&nbsp;<span class="op" id="1504453">&gt;=</span>&nbsp;<span class="ident" id="1504456">loadFactor</span><span class="op" id="1504466">*</span><span class="builtintype" id="1504467">float32</span><span class="op" id="1504474">(</span><span class="op" id="1504475">(</span><span class="builtintype" id="1504476">uintptr</span><span class="op" id="1504483">(</span><span class="num" id="1504484">1</span><span class="op" id="1504485">)</span><span class="op" id="1504486">&lt;&lt;</span><span class="ident" id="1504488">h</span><span class="op" id="1504489">.</span><span class="ident" id="1504490">B</span><span class="op" id="1504491">)</span><span class="op" id="1504492">)</span>&nbsp;<span class="op" id="1504494">&amp;&amp;</span>&nbsp;<span class="ident" id="1504497">h</span><span class="op" id="1504498">.</span><span class="ident" id="1504499">count</span>&nbsp;<span class="op" id="1504505">&gt;=</span>&nbsp;<span class="ident" id="1504508">bucketCnt</span>&nbsp;<span class="op" id="1504518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504522">hashGrow</span><span class="op" id="1504530">(</span><span class="ident" id="1504531">t</span><span class="op" id="1504532">,</span>&nbsp;<span class="ident" id="1504534">h</span><span class="op" id="1504535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504539">goto</span>&nbsp;<span class="ident" id="1504544">again</span>&nbsp;<span class="comment" id="1504550">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504613">if</span>&nbsp;<span class="ident" id="1504616">inserti</span>&nbsp;<span class="op" id="1504624">==</span>&nbsp;<span class="ident" id="1504627">nil</span>&nbsp;<span class="op" id="1504631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504635">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504690">if</span>&nbsp;<span class="ident" id="1504693">checkgc</span>&nbsp;<span class="op" id="1504701">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504706">memstats</span><span class="op" id="1504714">.</span><span class="ident" id="1504715">next_gc</span>&nbsp;<span class="op" id="1504723">=</span>&nbsp;<span class="ident" id="1504725">memstats</span><span class="op" id="1504733">.</span><span class="ident" id="1504734">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504751">newb</span>&nbsp;<span class="op" id="1504756">:=</span>&nbsp;<span class="op" id="1504759">(</span><span class="op" id="1504760">*</span><span class="ident" id="1504761">bmap</span><span class="op" id="1504765">)</span><span class="op" id="1504766">(</span><span class="ident" id="1504767">newobject</span><span class="op" id="1504776">(</span><span class="ident" id="1504777">t</span><span class="op" id="1504778">.</span><span class="ident" id="1504779">bucket</span><span class="op" id="1504785">)</span><span class="op" id="1504786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504790">b</span><span class="op" id="1504791">.</span><span class="ident" id="1504792">overflow</span>&nbsp;<span class="op" id="1504801">=</span>&nbsp;<span class="ident" id="1504803">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504810">inserti</span>&nbsp;<span class="op" id="1504818">=</span>&nbsp;<span class="op" id="1504820">&amp;</span><span class="ident" id="1504821">newb</span><span class="op" id="1504825">.</span><span class="ident" id="1504826">tophash</span><span class="op" id="1504833">[</span><span class="num" id="1504834">0</span><span class="op" id="1504835">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504839">insertk</span>&nbsp;<span class="op" id="1504847">=</span>&nbsp;<span class="ident" id="1504849">add</span><span class="op" id="1504852">(</span><span class="ident" id="1504853">unsafe</span><span class="op" id="1504859">.</span><span class="ident" id="1504860">Pointer</span><span class="op" id="1504867">(</span><span class="ident" id="1504868">newb</span><span class="op" id="1504872">)</span><span class="op" id="1504873">,</span>&nbsp;<span class="ident" id="1504875">dataOffset</span><span class="op" id="1504885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504889">insertv</span>&nbsp;<span class="op" id="1504897">=</span>&nbsp;<span class="ident" id="1504899">add</span><span class="op" id="1504902">(</span><span class="ident" id="1504903">insertk</span><span class="op" id="1504910">,</span>&nbsp;<span class="ident" id="1504912">bucketCnt</span><span class="op" id="1504921">*</span><span class="builtintype" id="1504922">uintptr</span><span class="op" id="1504929">(</span><span class="ident" id="1504930">t</span><span class="op" id="1504931">.</span><span class="ident" id="1504932">keysize</span><span class="op" id="1504939">)</span><span class="op" id="1504940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504947">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504990">if</span>&nbsp;<span class="ident" id="1504993">t</span><span class="op" id="1504994">.</span><span class="ident" id="1504995">indirectkey</span>&nbsp;<span class="op" id="1505007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505011">if</span>&nbsp;<span class="ident" id="1505014">checkgc</span>&nbsp;<span class="op" id="1505022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505027">memstats</span><span class="op" id="1505035">.</span><span class="ident" id="1505036">next_gc</span>&nbsp;<span class="op" id="1505044">=</span>&nbsp;<span class="ident" id="1505046">memstats</span><span class="op" id="1505054">.</span><span class="ident" id="1505055">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505072">kmem</span>&nbsp;<span class="op" id="1505077">:=</span>&nbsp;<span class="ident" id="1505080">newobject</span><span class="op" id="1505089">(</span><span class="ident" id="1505090">t</span><span class="op" id="1505091">.</span><span class="ident" id="1505092">key</span><span class="op" id="1505095">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505099">*</span><span class="op" id="1505100">(</span><span class="op" id="1505101">*</span><span class="ident" id="1505102">unsafe</span><span class="op" id="1505108">.</span><span class="ident" id="1505109">Pointer</span><span class="op" id="1505116">)</span><span class="op" id="1505117">(</span><span class="ident" id="1505118">insertk</span><span class="op" id="1505125">)</span>&nbsp;<span class="op" id="1505127">=</span>&nbsp;<span class="ident" id="1505129">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505136">insertk</span>&nbsp;<span class="op" id="1505144">=</span>&nbsp;<span class="ident" id="1505146">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505155">if</span>&nbsp;<span class="ident" id="1505158">t</span><span class="op" id="1505159">.</span><span class="ident" id="1505160">indirectvalue</span>&nbsp;<span class="op" id="1505174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505178">if</span>&nbsp;<span class="ident" id="1505181">checkgc</span>&nbsp;<span class="op" id="1505189">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505194">memstats</span><span class="op" id="1505202">.</span><span class="ident" id="1505203">next_gc</span>&nbsp;<span class="op" id="1505211">=</span>&nbsp;<span class="ident" id="1505213">memstats</span><span class="op" id="1505221">.</span><span class="ident" id="1505222">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505239">vmem</span>&nbsp;<span class="op" id="1505244">:=</span>&nbsp;<span class="ident" id="1505247">newobject</span><span class="op" id="1505256">(</span><span class="ident" id="1505257">t</span><span class="op" id="1505258">.</span><span class="ident" id="1505259">elem</span><span class="op" id="1505263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505267">*</span><span class="op" id="1505268">(</span><span class="op" id="1505269">*</span><span class="ident" id="1505270">unsafe</span><span class="op" id="1505276">.</span><span class="ident" id="1505277">Pointer</span><span class="op" id="1505284">)</span><span class="op" id="1505285">(</span><span class="ident" id="1505286">insertv</span><span class="op" id="1505293">)</span>&nbsp;<span class="op" id="1505295">=</span>&nbsp;<span class="ident" id="1505297">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505304">insertv</span>&nbsp;<span class="op" id="1505312">=</span>&nbsp;<span class="ident" id="1505314">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505323">memmove</span><span class="op" id="1505330">(</span><span class="ident" id="1505331">insertk</span><span class="op" id="1505338">,</span>&nbsp;<span class="ident" id="1505340">key</span><span class="op" id="1505343">,</span>&nbsp;<span class="builtintype" id="1505345">uintptr</span><span class="op" id="1505352">(</span><span class="ident" id="1505353">t</span><span class="op" id="1505354">.</span><span class="ident" id="1505355">key</span><span class="op" id="1505358">.</span><span class="ident" id="1505359">size</span><span class="op" id="1505363">)</span><span class="op" id="1505364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505367">memmove</span><span class="op" id="1505374">(</span><span class="ident" id="1505375">insertv</span><span class="op" id="1505382">,</span>&nbsp;<span class="ident" id="1505384">val</span><span class="op" id="1505387">,</span>&nbsp;<span class="builtintype" id="1505389">uintptr</span><span class="op" id="1505396">(</span><span class="ident" id="1505397">t</span><span class="op" id="1505398">.</span><span class="ident" id="1505399">elem</span><span class="op" id="1505403">.</span><span class="ident" id="1505404">size</span><span class="op" id="1505408">)</span><span class="op" id="1505409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505412">*</span><span class="ident" id="1505413">inserti</span>&nbsp;<span class="op" id="1505421">=</span>&nbsp;<span class="ident" id="1505423">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505428">h</span><span class="op" id="1505429">.</span><span class="ident" id="1505430">count</span><span class="op" id="1505435">++</span><br>
<span class="lineno">485</span><span class="op" id="1505438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505441">func</span>&nbsp;<span class="ident" id="1505446">mapdelete</span><span class="op" id="1505455">(</span><span class="ident" id="1505456">t</span>&nbsp;<span class="op" id="1505458">*</span><span class="ident" id="1505459">maptype</span><span class="op" id="1505466">,</span>&nbsp;<span class="ident" id="1505468">h</span>&nbsp;<span class="op" id="1505470">*</span><span class="ident" id="1505471">hmap</span><span class="op" id="1505475">,</span>&nbsp;<span class="ident" id="1505477">key</span>&nbsp;<span class="ident" id="1505481">unsafe</span><span class="op" id="1505487">.</span><span class="ident" id="1505488">Pointer</span><span class="op" id="1505495">)</span>&nbsp;<span class="op" id="1505497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505500">if</span>&nbsp;<span class="ident" id="1505503">raceenabled</span>&nbsp;<span class="op" id="1505515">&amp;&amp;</span>&nbsp;<span class="ident" id="1505518">h</span>&nbsp;<span class="op" id="1505520">!=</span>&nbsp;<span class="ident" id="1505523">nil</span>&nbsp;<span class="op" id="1505527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505531">callerpc</span>&nbsp;<span class="op" id="1505540">:=</span>&nbsp;<span class="ident" id="1505543">getcallerpc</span><span class="op" id="1505554">(</span><span class="ident" id="1505555">unsafe</span><span class="op" id="1505561">.</span><span class="ident" id="1505562">Pointer</span><span class="op" id="1505569">(</span><span class="op" id="1505570">&amp;</span><span class="ident" id="1505571">t</span><span class="op" id="1505572">)</span><span class="op" id="1505573">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505577">pc</span>&nbsp;<span class="op" id="1505580">:=</span>&nbsp;<span class="ident" id="1505583">funcPC</span><span class="op" id="1505589">(</span><span class="ident" id="1505590">mapdelete</span><span class="op" id="1505599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505603">racewritepc</span><span class="op" id="1505614">(</span><span class="ident" id="1505615">unsafe</span><span class="op" id="1505621">.</span><span class="ident" id="1505622">Pointer</span><span class="op" id="1505629">(</span><span class="ident" id="1505630">h</span><span class="op" id="1505631">)</span><span class="op" id="1505632">,</span>&nbsp;<span class="ident" id="1505634">callerpc</span><span class="op" id="1505642">,</span>&nbsp;<span class="ident" id="1505644">pc</span><span class="op" id="1505646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505650">raceReadObjectPC</span><span class="op" id="1505666">(</span><span class="ident" id="1505667">t</span><span class="op" id="1505668">.</span><span class="ident" id="1505669">key</span><span class="op" id="1505672">,</span>&nbsp;<span class="ident" id="1505674">key</span><span class="op" id="1505677">,</span>&nbsp;<span class="ident" id="1505679">callerpc</span><span class="op" id="1505687">,</span>&nbsp;<span class="ident" id="1505689">pc</span><span class="op" id="1505691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505697">if</span>&nbsp;<span class="ident" id="1505700">h</span>&nbsp;<span class="op" id="1505702">==</span>&nbsp;<span class="ident" id="1505705">nil</span>&nbsp;<span class="op" id="1505709">||</span>&nbsp;<span class="ident" id="1505712">h</span><span class="op" id="1505713">.</span><span class="ident" id="1505714">count</span>&nbsp;<span class="op" id="1505720">==</span>&nbsp;<span class="num" id="1505723">0</span>&nbsp;<span class="op" id="1505725">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505740">alg</span>&nbsp;<span class="op" id="1505744">:=</span>&nbsp;<span class="ident" id="1505747">goalg</span><span class="op" id="1505752">(</span><span class="ident" id="1505753">t</span><span class="op" id="1505754">.</span><span class="ident" id="1505755">key</span><span class="op" id="1505758">.</span><span class="ident" id="1505759">alg</span><span class="op" id="1505762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505765">hash</span>&nbsp;<span class="op" id="1505770">:=</span>&nbsp;<span class="ident" id="1505773">alg</span><span class="op" id="1505776">.</span><span class="ident" id="1505777">hash</span><span class="op" id="1505781">(</span><span class="ident" id="1505782">key</span><span class="op" id="1505785">,</span>&nbsp;<span class="builtintype" id="1505787">uintptr</span><span class="op" id="1505794">(</span><span class="ident" id="1505795">t</span><span class="op" id="1505796">.</span><span class="ident" id="1505797">key</span><span class="op" id="1505800">.</span><span class="ident" id="1505801">size</span><span class="op" id="1505805">)</span><span class="op" id="1505806">,</span>&nbsp;<span class="builtintype" id="1505808">uintptr</span><span class="op" id="1505815">(</span><span class="ident" id="1505816">h</span><span class="op" id="1505817">.</span><span class="ident" id="1505818">hash0</span><span class="op" id="1505823">)</span><span class="op" id="1505824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505827">bucket</span>&nbsp;<span class="op" id="1505834">:=</span>&nbsp;<span class="ident" id="1505837">hash</span>&nbsp;<span class="op" id="1505842">&amp;</span>&nbsp;<span class="op" id="1505844">(</span><span class="builtintype" id="1505845">uintptr</span><span class="op" id="1505852">(</span><span class="num" id="1505853">1</span><span class="op" id="1505854">)</span><span class="op" id="1505855">&lt;&lt;</span><span class="ident" id="1505857">h</span><span class="op" id="1505858">.</span><span class="ident" id="1505859">B</span>&nbsp;<span class="op" id="1505861">-</span>&nbsp;<span class="num" id="1505863">1</span><span class="op" id="1505864">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505867">if</span>&nbsp;<span class="ident" id="1505870">h</span><span class="op" id="1505871">.</span><span class="ident" id="1505872">oldbuckets</span>&nbsp;<span class="op" id="1505883">!=</span>&nbsp;<span class="ident" id="1505886">nil</span>&nbsp;<span class="op" id="1505890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505894">growWork</span><span class="op" id="1505902">(</span><span class="ident" id="1505903">t</span><span class="op" id="1505904">,</span>&nbsp;<span class="ident" id="1505906">h</span><span class="op" id="1505907">,</span>&nbsp;<span class="ident" id="1505909">bucket</span><span class="op" id="1505915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505921">b</span>&nbsp;<span class="op" id="1505923">:=</span>&nbsp;<span class="op" id="1505926">(</span><span class="op" id="1505927">*</span><span class="ident" id="1505928">bmap</span><span class="op" id="1505932">)</span><span class="op" id="1505933">(</span><span class="ident" id="1505934">unsafe</span><span class="op" id="1505940">.</span><span class="ident" id="1505941">Pointer</span><span class="op" id="1505948">(</span><span class="builtintype" id="1505949">uintptr</span><span class="op" id="1505956">(</span><span class="ident" id="1505957">h</span><span class="op" id="1505958">.</span><span class="ident" id="1505959">buckets</span><span class="op" id="1505966">)</span>&nbsp;<span class="op" id="1505968">+</span>&nbsp;<span class="ident" id="1505970">bucket</span><span class="op" id="1505976">*</span><span class="builtintype" id="1505977">uintptr</span><span class="op" id="1505984">(</span><span class="ident" id="1505985">t</span><span class="op" id="1505986">.</span><span class="ident" id="1505987">bucketsize</span><span class="op" id="1505997">)</span><span class="op" id="1505998">)</span><span class="op" id="1505999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506002">top</span>&nbsp;<span class="op" id="1506006">:=</span>&nbsp;<span class="builtintype" id="1506009">uint8</span><span class="op" id="1506014">(</span><span class="ident" id="1506015">hash</span>&nbsp;<span class="op" id="1506020">&gt;&gt;</span>&nbsp;<span class="op" id="1506023">(</span><span class="ident" id="1506024">ptrSize</span><span class="op" id="1506031">*</span><span class="num" id="1506032">8</span>&nbsp;<span class="op" id="1506034">-</span>&nbsp;<span class="num" id="1506036">8</span><span class="op" id="1506037">)</span><span class="op" id="1506038">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506041">if</span>&nbsp;<span class="ident" id="1506044">top</span>&nbsp;<span class="op" id="1506048">&lt;</span>&nbsp;<span class="ident" id="1506050">minTopHash</span>&nbsp;<span class="op" id="1506061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506065">top</span>&nbsp;<span class="op" id="1506069">+=</span>&nbsp;<span class="ident" id="1506072">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506087">for</span>&nbsp;<span class="op" id="1506091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506095">for</span>&nbsp;<span class="ident" id="1506099">i</span>&nbsp;<span class="op" id="1506101">:=</span>&nbsp;<span class="builtintype" id="1506104">uintptr</span><span class="op" id="1506111">(</span><span class="num" id="1506112">0</span><span class="op" id="1506113">)</span><span class="op" id="1506114">;</span>&nbsp;<span class="ident" id="1506116">i</span>&nbsp;<span class="op" id="1506118">&lt;</span>&nbsp;<span class="ident" id="1506120">bucketCnt</span><span class="op" id="1506129">;</span>&nbsp;<span class="ident" id="1506131">i</span><span class="op" id="1506132">++</span>&nbsp;<span class="op" id="1506135">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506140">if</span>&nbsp;<span class="ident" id="1506143">b</span><span class="op" id="1506144">.</span><span class="ident" id="1506145">tophash</span><span class="op" id="1506152">[</span><span class="ident" id="1506153">i</span><span class="op" id="1506154">]</span>&nbsp;<span class="op" id="1506156">!=</span>&nbsp;<span class="ident" id="1506159">top</span>&nbsp;<span class="op" id="1506163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506169">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506186">k</span>&nbsp;<span class="op" id="1506188">:=</span>&nbsp;<span class="ident" id="1506191">add</span><span class="op" id="1506194">(</span><span class="ident" id="1506195">unsafe</span><span class="op" id="1506201">.</span><span class="ident" id="1506202">Pointer</span><span class="op" id="1506209">(</span><span class="ident" id="1506210">b</span><span class="op" id="1506211">)</span><span class="op" id="1506212">,</span>&nbsp;<span class="ident" id="1506214">dataOffset</span><span class="op" id="1506224">+</span><span class="ident" id="1506225">i</span><span class="op" id="1506226">*</span><span class="builtintype" id="1506227">uintptr</span><span class="op" id="1506234">(</span><span class="ident" id="1506235">t</span><span class="op" id="1506236">.</span><span class="ident" id="1506237">keysize</span><span class="op" id="1506244">)</span><span class="op" id="1506245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506250">k2</span>&nbsp;<span class="op" id="1506253">:=</span>&nbsp;<span class="ident" id="1506256">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506261">if</span>&nbsp;<span class="ident" id="1506264">t</span><span class="op" id="1506265">.</span><span class="ident" id="1506266">indirectkey</span>&nbsp;<span class="op" id="1506278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506284">k2</span>&nbsp;<span class="op" id="1506287">=</span>&nbsp;<span class="op" id="1506289">*</span><span class="op" id="1506290">(</span><span class="op" id="1506291">(</span><span class="op" id="1506292">*</span><span class="ident" id="1506293">unsafe</span><span class="op" id="1506299">.</span><span class="ident" id="1506300">Pointer</span><span class="op" id="1506307">)</span><span class="op" id="1506308">(</span><span class="ident" id="1506309">k2</span><span class="op" id="1506311">)</span><span class="op" id="1506312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506322">if</span>&nbsp;<span class="op" id="1506325">!</span><span class="ident" id="1506326">alg</span><span class="op" id="1506329">.</span><span class="ident" id="1506330">equal</span><span class="op" id="1506335">(</span><span class="ident" id="1506336">key</span><span class="op" id="1506339">,</span>&nbsp;<span class="ident" id="1506341">k2</span><span class="op" id="1506343">,</span>&nbsp;<span class="builtintype" id="1506345">uintptr</span><span class="op" id="1506352">(</span><span class="ident" id="1506353">t</span><span class="op" id="1506354">.</span><span class="ident" id="1506355">key</span><span class="op" id="1506358">.</span><span class="ident" id="1506359">size</span><span class="op" id="1506363">)</span><span class="op" id="1506364">)</span>&nbsp;<span class="op" id="1506366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506372">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506389">memclr</span><span class="op" id="1506395">(</span><span class="ident" id="1506396">k</span><span class="op" id="1506397">,</span>&nbsp;<span class="builtintype" id="1506399">uintptr</span><span class="op" id="1506406">(</span><span class="ident" id="1506407">t</span><span class="op" id="1506408">.</span><span class="ident" id="1506409">keysize</span><span class="op" id="1506416">)</span><span class="op" id="1506417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506422">v</span>&nbsp;<span class="op" id="1506424">:=</span>&nbsp;<span class="ident" id="1506427">unsafe</span><span class="op" id="1506433">.</span><span class="ident" id="1506434">Pointer</span><span class="op" id="1506441">(</span><span class="builtintype" id="1506442">uintptr</span><span class="op" id="1506449">(</span><span class="ident" id="1506450">unsafe</span><span class="op" id="1506456">.</span><span class="ident" id="1506457">Pointer</span><span class="op" id="1506464">(</span><span class="ident" id="1506465">b</span><span class="op" id="1506466">)</span><span class="op" id="1506467">)</span>&nbsp;<span class="op" id="1506469">+</span>&nbsp;<span class="ident" id="1506471">dataOffset</span>&nbsp;<span class="op" id="1506482">+</span>&nbsp;<span class="ident" id="1506484">bucketCnt</span><span class="op" id="1506493">*</span><span class="builtintype" id="1506494">uintptr</span><span class="op" id="1506501">(</span><span class="ident" id="1506502">t</span><span class="op" id="1506503">.</span><span class="ident" id="1506504">keysize</span><span class="op" id="1506511">)</span>&nbsp;<span class="op" id="1506513">+</span>&nbsp;<span class="ident" id="1506515">i</span><span class="op" id="1506516">*</span><span class="builtintype" id="1506517">uintptr</span><span class="op" id="1506524">(</span><span class="ident" id="1506525">t</span><span class="op" id="1506526">.</span><span class="ident" id="1506527">valuesize</span><span class="op" id="1506536">)</span><span class="op" id="1506537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506542">memclr</span><span class="op" id="1506548">(</span><span class="ident" id="1506549">v</span><span class="op" id="1506550">,</span>&nbsp;<span class="builtintype" id="1506552">uintptr</span><span class="op" id="1506559">(</span><span class="ident" id="1506560">t</span><span class="op" id="1506561">.</span><span class="ident" id="1506562">valuesize</span><span class="op" id="1506571">)</span><span class="op" id="1506572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506577">b</span><span class="op" id="1506578">.</span><span class="ident" id="1506579">tophash</span><span class="op" id="1506586">[</span><span class="ident" id="1506587">i</span><span class="op" id="1506588">]</span>&nbsp;<span class="op" id="1506590">=</span>&nbsp;<span class="ident" id="1506592">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506601">h</span><span class="op" id="1506602">.</span><span class="ident" id="1506603">count</span><span class="op" id="1506608">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506627">b</span>&nbsp;<span class="op" id="1506629">=</span>&nbsp;<span class="ident" id="1506631">b</span><span class="op" id="1506632">.</span><span class="ident" id="1506633">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506644">if</span>&nbsp;<span class="ident" id="1506647">b</span>&nbsp;<span class="op" id="1506649">==</span>&nbsp;<span class="ident" id="1506652">nil</span>&nbsp;<span class="op" id="1506656">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506661">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506673">}</span><br>
<span class="lineno"></span><span class="op" id="1506675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1506678">func</span>&nbsp;<span class="ident" id="1506683">mapiterinit</span><span class="op" id="1506694">(</span><span class="ident" id="1506695">t</span>&nbsp;<span class="op" id="1506697">*</span><span class="ident" id="1506698">maptype</span><span class="op" id="1506705">,</span>&nbsp;<span class="ident" id="1506707">h</span>&nbsp;<span class="op" id="1506709">*</span><span class="ident" id="1506710">hmap</span><span class="op" id="1506714">,</span>&nbsp;<span class="ident" id="1506716">it</span>&nbsp;<span class="op" id="1506719">*</span><span class="ident" id="1506720">hiter</span><span class="op" id="1506725">)</span>&nbsp;<span class="op" id="1506727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506730">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506795">it</span><span class="op" id="1506797">.</span><span class="ident" id="1506798">key</span>&nbsp;<span class="op" id="1506802">=</span>&nbsp;<span class="ident" id="1506804">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506809">it</span><span class="op" id="1506811">.</span><span class="ident" id="1506812">value</span>&nbsp;<span class="op" id="1506818">=</span>&nbsp;<span class="ident" id="1506820">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506825">it</span><span class="op" id="1506827">.</span><span class="ident" id="1506828">t</span>&nbsp;<span class="op" id="1506830">=</span>&nbsp;<span class="ident" id="1506832">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506837">it</span><span class="op" id="1506839">.</span><span class="ident" id="1506840">h</span>&nbsp;<span class="op" id="1506842">=</span>&nbsp;<span class="ident" id="1506844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506849">it</span><span class="op" id="1506851">.</span><span class="ident" id="1506852">buckets</span>&nbsp;<span class="op" id="1506860">=</span>&nbsp;<span class="ident" id="1506862">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506867">it</span><span class="op" id="1506869">.</span><span class="ident" id="1506870">bptr</span>&nbsp;<span class="op" id="1506875">=</span>&nbsp;<span class="ident" id="1506877">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506883">if</span>&nbsp;<span class="ident" id="1506886">raceenabled</span>&nbsp;<span class="op" id="1506898">&amp;&amp;</span>&nbsp;<span class="ident" id="1506901">h</span>&nbsp;<span class="op" id="1506903">!=</span>&nbsp;<span class="ident" id="1506906">nil</span>&nbsp;<span class="op" id="1506910">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506914">callerpc</span>&nbsp;<span class="op" id="1506923">:=</span>&nbsp;<span class="ident" id="1506926">getcallerpc</span><span class="op" id="1506937">(</span><span class="ident" id="1506938">unsafe</span><span class="op" id="1506944">.</span><span class="ident" id="1506945">Pointer</span><span class="op" id="1506952">(</span><span class="op" id="1506953">&amp;</span><span class="ident" id="1506954">t</span><span class="op" id="1506955">)</span><span class="op" id="1506956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506960">racereadpc</span><span class="op" id="1506970">(</span><span class="ident" id="1506971">unsafe</span><span class="op" id="1506977">.</span><span class="ident" id="1506978">Pointer</span><span class="op" id="1506985">(</span><span class="ident" id="1506986">h</span><span class="op" id="1506987">)</span><span class="op" id="1506988">,</span>&nbsp;<span class="ident" id="1506990">callerpc</span><span class="op" id="1506998">,</span>&nbsp;<span class="ident" id="1507000">funcPC</span><span class="op" id="1507006">(</span><span class="ident" id="1507007">mapiterinit</span><span class="op" id="1507018">)</span><span class="op" id="1507019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507026">if</span>&nbsp;<span class="ident" id="1507029">h</span>&nbsp;<span class="op" id="1507031">==</span>&nbsp;<span class="ident" id="1507034">nil</span>&nbsp;<span class="op" id="1507038">||</span>&nbsp;<span class="ident" id="1507041">h</span><span class="op" id="1507042">.</span><span class="ident" id="1507043">count</span>&nbsp;<span class="op" id="1507049">==</span>&nbsp;<span class="num" id="1507052">0</span>&nbsp;<span class="op" id="1507054">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507058">it</span><span class="op" id="1507060">.</span><span class="ident" id="1507061">key</span>&nbsp;<span class="op" id="1507065">=</span>&nbsp;<span class="ident" id="1507067">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507073">it</span><span class="op" id="1507075">.</span><span class="ident" id="1507076">value</span>&nbsp;<span class="op" id="1507082">=</span>&nbsp;<span class="ident" id="1507084">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507090">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507102">if</span>&nbsp;<span class="ident" id="1507105">unsafe</span><span class="op" id="1507111">.</span><span class="ident" id="1507112">Sizeof</span><span class="op" id="1507118">(</span><span class="ident" id="1507119">hiter</span><span class="op" id="1507124">{</span><span class="op" id="1507125">}</span><span class="op" id="1507126">)</span><span class="op" id="1507127">/</span><span class="ident" id="1507128">ptrSize</span>&nbsp;<span class="op" id="1507136">!=</span>&nbsp;<span class="num" id="1507139">10</span>&nbsp;<span class="op" id="1507142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507146">gothrow</span><span class="op" id="1507153">(</span><span class="string" id="1507154">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1507180">)</span>&nbsp;<span class="comment" id="1507182">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507216">it</span><span class="op" id="1507218">.</span><span class="ident" id="1507219">t</span>&nbsp;<span class="op" id="1507221">=</span>&nbsp;<span class="ident" id="1507223">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507226">it</span><span class="op" id="1507228">.</span><span class="ident" id="1507229">h</span>&nbsp;<span class="op" id="1507231">=</span>&nbsp;<span class="ident" id="1507233">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507237">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507271">it</span><span class="op" id="1507273">.</span><span class="ident" id="1507274">B</span>&nbsp;<span class="op" id="1507276">=</span>&nbsp;<span class="ident" id="1507278">h</span><span class="op" id="1507279">.</span><span class="ident" id="1507280">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507283">it</span><span class="op" id="1507285">.</span><span class="ident" id="1507286">buckets</span>&nbsp;<span class="op" id="1507294">=</span>&nbsp;<span class="ident" id="1507296">h</span><span class="op" id="1507297">.</span><span class="ident" id="1507298">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507308">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507334">r</span>&nbsp;<span class="op" id="1507336">:=</span>&nbsp;<span class="builtintype" id="1507339">uintptr</span><span class="op" id="1507346">(</span><span class="ident" id="1507347">fastrand1</span><span class="op" id="1507356">(</span><span class="op" id="1507357">)</span><span class="op" id="1507358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507361">if</span>&nbsp;<span class="ident" id="1507364">h</span><span class="op" id="1507365">.</span><span class="ident" id="1507366">B</span>&nbsp;<span class="op" id="1507368">&gt;</span>&nbsp;<span class="num" id="1507370">31</span><span class="op" id="1507372">-</span><span class="ident" id="1507373">bucketCntBits</span>&nbsp;<span class="op" id="1507387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507391">r</span>&nbsp;<span class="op" id="1507393">+=</span>&nbsp;<span class="builtintype" id="1507396">uintptr</span><span class="op" id="1507403">(</span><span class="ident" id="1507404">fastrand1</span><span class="op" id="1507413">(</span><span class="op" id="1507414">)</span><span class="op" id="1507415">)</span>&nbsp;<span class="op" id="1507417">&lt;&lt;</span>&nbsp;<span class="num" id="1507420">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507424">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507427">it</span><span class="op" id="1507429">.</span><span class="ident" id="1507430">startBucket</span>&nbsp;<span class="op" id="1507442">=</span>&nbsp;<span class="ident" id="1507444">r</span>&nbsp;<span class="op" id="1507446">&amp;</span>&nbsp;<span class="op" id="1507448">(</span><span class="builtintype" id="1507449">uintptr</span><span class="op" id="1507456">(</span><span class="num" id="1507457">1</span><span class="op" id="1507458">)</span><span class="op" id="1507459">&lt;&lt;</span><span class="ident" id="1507461">h</span><span class="op" id="1507462">.</span><span class="ident" id="1507463">B</span>&nbsp;<span class="op" id="1507465">-</span>&nbsp;<span class="num" id="1507467">1</span><span class="op" id="1507468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507471">it</span><span class="op" id="1507473">.</span><span class="ident" id="1507474">offset</span>&nbsp;<span class="op" id="1507481">=</span>&nbsp;<span class="builtintype" id="1507483">uint8</span><span class="op" id="1507488">(</span><span class="ident" id="1507489">r</span>&nbsp;<span class="op" id="1507491">&gt;&gt;</span>&nbsp;<span class="ident" id="1507494">h</span><span class="op" id="1507495">.</span><span class="ident" id="1507496">B</span>&nbsp;<span class="op" id="1507498">&amp;</span>&nbsp;<span class="op" id="1507500">(</span><span class="ident" id="1507501">bucketCnt</span>&nbsp;<span class="op" id="1507511">-</span>&nbsp;<span class="num" id="1507513">1</span><span class="op" id="1507514">)</span><span class="op" id="1507515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507519">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507538">it</span><span class="op" id="1507540">.</span><span class="ident" id="1507541">bucket</span>&nbsp;<span class="op" id="1507548">=</span>&nbsp;<span class="ident" id="1507550">it</span><span class="op" id="1507552">.</span><span class="ident" id="1507553">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507566">it</span><span class="op" id="1507568">.</span><span class="ident" id="1507569">wrapped</span>&nbsp;<span class="op" id="1507577">=</span>&nbsp;<span class="builtintype" id="1507579">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507586">it</span><span class="op" id="1507588">.</span><span class="ident" id="1507589">bptr</span>&nbsp;<span class="op" id="1507594">=</span>&nbsp;<span class="ident" id="1507596">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507602">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507636">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507692">for</span>&nbsp;<span class="op" id="1507696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507700">old</span>&nbsp;<span class="op" id="1507704">:=</span>&nbsp;<span class="ident" id="1507707">h</span><span class="op" id="1507708">.</span><span class="ident" id="1507709">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507717">if</span>&nbsp;<span class="ident" id="1507720">old</span>&nbsp;<span class="op" id="1507724">==</span>&nbsp;<span class="ident" id="1507727">old</span><span class="op" id="1507730">|</span><span class="ident" id="1507731">iterator</span><span class="op" id="1507739">|</span><span class="ident" id="1507740">oldIterator</span>&nbsp;<span class="op" id="1507752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507757">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507765">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507769">if</span>&nbsp;<span class="ident" id="1507772">cas</span><span class="op" id="1507775">(</span><span class="op" id="1507776">&amp;</span><span class="ident" id="1507777">h</span><span class="op" id="1507778">.</span><span class="ident" id="1507779">flags</span><span class="op" id="1507784">,</span>&nbsp;<span class="ident" id="1507786">old</span><span class="op" id="1507789">,</span>&nbsp;<span class="ident" id="1507791">old</span><span class="op" id="1507794">|</span><span class="ident" id="1507795">iterator</span><span class="op" id="1507803">|</span><span class="ident" id="1507804">oldIterator</span><span class="op" id="1507815">)</span>&nbsp;<span class="op" id="1507817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507822">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507837">mapiternext</span><span class="op" id="1507848">(</span><span class="ident" id="1507849">it</span><span class="op" id="1507851">)</span><br>
<span class="lineno"></span><span class="op" id="1507853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1507856">func</span>&nbsp;<span class="ident" id="1507861">mapiternext</span><span class="op" id="1507872">(</span><span class="ident" id="1507873">it</span>&nbsp;<span class="op" id="1507876">*</span><span class="ident" id="1507877">hiter</span><span class="op" id="1507882">)</span>&nbsp;<span class="op" id="1507884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507887">h</span>&nbsp;<span class="op" id="1507889">:=</span>&nbsp;<span class="ident" id="1507892">it</span><span class="op" id="1507894">.</span><span class="ident" id="1507895">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507898">if</span>&nbsp;<span class="ident" id="1507901">raceenabled</span>&nbsp;<span class="op" id="1507913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507917">callerpc</span>&nbsp;<span class="op" id="1507926">:=</span>&nbsp;<span class="ident" id="1507929">getcallerpc</span><span class="op" id="1507940">(</span><span class="ident" id="1507941">unsafe</span><span class="op" id="1507947">.</span><span class="ident" id="1507948">Pointer</span><span class="op" id="1507955">(</span><span class="op" id="1507956">&amp;</span><span class="ident" id="1507957">it</span><span class="op" id="1507959">)</span><span class="op" id="1507960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507964">racereadpc</span><span class="op" id="1507974">(</span><span class="ident" id="1507975">unsafe</span><span class="op" id="1507981">.</span><span class="ident" id="1507982">Pointer</span><span class="op" id="1507989">(</span><span class="ident" id="1507990">h</span><span class="op" id="1507991">)</span><span class="op" id="1507992">,</span>&nbsp;<span class="ident" id="1507994">callerpc</span><span class="op" id="1508002">,</span>&nbsp;<span class="ident" id="1508004">funcPC</span><span class="op" id="1508010">(</span><span class="ident" id="1508011">mapiternext</span><span class="op" id="1508022">)</span><span class="op" id="1508023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508029">t</span>&nbsp;<span class="op" id="1508031">:=</span>&nbsp;<span class="ident" id="1508034">it</span><span class="op" id="1508036">.</span><span class="ident" id="1508037">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508040">bucket</span>&nbsp;<span class="op" id="1508047">:=</span>&nbsp;<span class="ident" id="1508050">it</span><span class="op" id="1508052">.</span><span class="ident" id="1508053">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508061">b</span>&nbsp;<span class="op" id="1508063">:=</span>&nbsp;<span class="ident" id="1508066">it</span><span class="op" id="1508068">.</span><span class="ident" id="1508069">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508075">i</span>&nbsp;<span class="op" id="1508077">:=</span>&nbsp;<span class="ident" id="1508080">it</span><span class="op" id="1508082">.</span><span class="ident" id="1508083">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508086">checkBucket</span>&nbsp;<span class="op" id="1508098">:=</span>&nbsp;<span class="ident" id="1508101">it</span><span class="op" id="1508103">.</span><span class="ident" id="1508104">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508117">alg</span>&nbsp;<span class="op" id="1508121">:=</span>&nbsp;<span class="ident" id="1508124">goalg</span><span class="op" id="1508129">(</span><span class="ident" id="1508130">t</span><span class="op" id="1508131">.</span><span class="ident" id="1508132">key</span><span class="op" id="1508135">.</span><span class="ident" id="1508136">alg</span><span class="op" id="1508139">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1508142">next</span><span class="op" id="1508146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508149">if</span>&nbsp;<span class="ident" id="1508152">b</span>&nbsp;<span class="op" id="1508154">==</span>&nbsp;<span class="ident" id="1508157">nil</span>&nbsp;<span class="op" id="1508161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508165">if</span>&nbsp;<span class="ident" id="1508168">bucket</span>&nbsp;<span class="op" id="1508175">==</span>&nbsp;<span class="ident" id="1508178">it</span><span class="op" id="1508180">.</span><span class="ident" id="1508181">startBucket</span>&nbsp;<span class="op" id="1508193">&amp;&amp;</span>&nbsp;<span class="ident" id="1508196">it</span><span class="op" id="1508198">.</span><span class="ident" id="1508199">wrapped</span>&nbsp;<span class="op" id="1508207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508212">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508235">it</span><span class="op" id="1508237">.</span><span class="ident" id="1508238">key</span>&nbsp;<span class="op" id="1508242">=</span>&nbsp;<span class="ident" id="1508244">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508251">it</span><span class="op" id="1508253">.</span><span class="ident" id="1508254">value</span>&nbsp;<span class="op" id="1508260">=</span>&nbsp;<span class="ident" id="1508262">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508269">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508282">if</span>&nbsp;<span class="ident" id="1508285">h</span><span class="op" id="1508286">.</span><span class="ident" id="1508287">oldbuckets</span>&nbsp;<span class="op" id="1508298">!=</span>&nbsp;<span class="ident" id="1508301">nil</span>&nbsp;<span class="op" id="1508305">&amp;&amp;</span>&nbsp;<span class="ident" id="1508308">it</span><span class="op" id="1508310">.</span><span class="ident" id="1508311">B</span>&nbsp;<span class="op" id="1508313">==</span>&nbsp;<span class="ident" id="1508316">h</span><span class="op" id="1508317">.</span><span class="ident" id="1508318">B</span>&nbsp;<span class="op" id="1508320">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508325">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508406">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508483">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508559">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508635">oldbucket</span>&nbsp;<span class="op" id="1508645">:=</span>&nbsp;<span class="ident" id="1508648">bucket</span>&nbsp;<span class="op" id="1508655">&amp;</span>&nbsp;<span class="op" id="1508657">(</span><span class="builtintype" id="1508658">uintptr</span><span class="op" id="1508665">(</span><span class="num" id="1508666">1</span><span class="op" id="1508667">)</span><span class="op" id="1508668">&lt;&lt;</span><span class="op" id="1508670">(</span><span class="ident" id="1508671">it</span><span class="op" id="1508673">.</span><span class="ident" id="1508674">B</span><span class="op" id="1508675">-</span><span class="num" id="1508676">1</span><span class="op" id="1508677">)</span>&nbsp;<span class="op" id="1508679">-</span>&nbsp;<span class="num" id="1508681">1</span><span class="op" id="1508682">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508687">b</span>&nbsp;<span class="op" id="1508689">=</span>&nbsp;<span class="op" id="1508691">(</span><span class="op" id="1508692">*</span><span class="ident" id="1508693">bmap</span><span class="op" id="1508697">)</span><span class="op" id="1508698">(</span><span class="ident" id="1508699">add</span><span class="op" id="1508702">(</span><span class="ident" id="1508703">h</span><span class="op" id="1508704">.</span><span class="ident" id="1508705">oldbuckets</span><span class="op" id="1508715">,</span>&nbsp;<span class="ident" id="1508717">oldbucket</span><span class="op" id="1508726">*</span><span class="builtintype" id="1508727">uintptr</span><span class="op" id="1508734">(</span><span class="ident" id="1508735">t</span><span class="op" id="1508736">.</span><span class="ident" id="1508737">bucketsize</span><span class="op" id="1508747">)</span><span class="op" id="1508748">)</span><span class="op" id="1508749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508754">if</span>&nbsp;<span class="op" id="1508757">!</span><span class="ident" id="1508758">evacuated</span><span class="op" id="1508767">(</span><span class="ident" id="1508768">b</span><span class="op" id="1508769">)</span>&nbsp;<span class="op" id="1508771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508777">checkBucket</span>&nbsp;<span class="op" id="1508789">=</span>&nbsp;<span class="ident" id="1508791">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508801">}</span>&nbsp;<span class="keyword" id="1508803">else</span>&nbsp;<span class="op" id="1508808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508814">b</span>&nbsp;<span class="op" id="1508816">=</span>&nbsp;<span class="op" id="1508818">(</span><span class="op" id="1508819">*</span><span class="ident" id="1508820">bmap</span><span class="op" id="1508824">)</span><span class="op" id="1508825">(</span><span class="ident" id="1508826">add</span><span class="op" id="1508829">(</span><span class="ident" id="1508830">it</span><span class="op" id="1508832">.</span><span class="ident" id="1508833">buckets</span><span class="op" id="1508840">,</span>&nbsp;<span class="ident" id="1508842">bucket</span><span class="op" id="1508848">*</span><span class="builtintype" id="1508849">uintptr</span><span class="op" id="1508856">(</span><span class="ident" id="1508857">t</span><span class="op" id="1508858">.</span><span class="ident" id="1508859">bucketsize</span><span class="op" id="1508869">)</span><span class="op" id="1508870">)</span><span class="op" id="1508871">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508877">checkBucket</span>&nbsp;<span class="op" id="1508889">=</span>&nbsp;<span class="ident" id="1508891">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508906">}</span>&nbsp;<span class="keyword" id="1508908">else</span>&nbsp;<span class="op" id="1508913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508918">b</span>&nbsp;<span class="op" id="1508920">=</span>&nbsp;<span class="op" id="1508922">(</span><span class="op" id="1508923">*</span><span class="ident" id="1508924">bmap</span><span class="op" id="1508928">)</span><span class="op" id="1508929">(</span><span class="ident" id="1508930">add</span><span class="op" id="1508933">(</span><span class="ident" id="1508934">it</span><span class="op" id="1508936">.</span><span class="ident" id="1508937">buckets</span><span class="op" id="1508944">,</span>&nbsp;<span class="ident" id="1508946">bucket</span><span class="op" id="1508952">*</span><span class="builtintype" id="1508953">uintptr</span><span class="op" id="1508960">(</span><span class="ident" id="1508961">t</span><span class="op" id="1508962">.</span><span class="ident" id="1508963">bucketsize</span><span class="op" id="1508973">)</span><span class="op" id="1508974">)</span><span class="op" id="1508975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508980">checkBucket</span>&nbsp;<span class="op" id="1508992">=</span>&nbsp;<span class="ident" id="1508994">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509008">bucket</span><span class="op" id="1509014">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509019">if</span>&nbsp;<span class="ident" id="1509022">bucket</span>&nbsp;<span class="op" id="1509029">==</span>&nbsp;<span class="builtintype" id="1509032">uintptr</span><span class="op" id="1509039">(</span><span class="num" id="1509040">1</span><span class="op" id="1509041">)</span><span class="op" id="1509042">&lt;&lt;</span><span class="ident" id="1509044">it</span><span class="op" id="1509046">.</span><span class="ident" id="1509047">B</span>&nbsp;<span class="op" id="1509049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509054">bucket</span>&nbsp;<span class="op" id="1509061">=</span>&nbsp;<span class="num" id="1509063">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509068">it</span><span class="op" id="1509070">.</span><span class="ident" id="1509071">wrapped</span>&nbsp;<span class="op" id="1509079">=</span>&nbsp;<span class="builtintype" id="1509081">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509092">i</span>&nbsp;<span class="op" id="1509094">=</span>&nbsp;<span class="num" id="1509096">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509102">for</span>&nbsp;<span class="op" id="1509106">;</span>&nbsp;<span class="ident" id="1509108">i</span>&nbsp;<span class="op" id="1509110">&lt;</span>&nbsp;<span class="ident" id="1509112">bucketCnt</span><span class="op" id="1509121">;</span>&nbsp;<span class="ident" id="1509123">i</span><span class="op" id="1509124">++</span>&nbsp;<span class="op" id="1509127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509131">offi</span>&nbsp;<span class="op" id="1509136">:=</span>&nbsp;<span class="op" id="1509139">(</span><span class="ident" id="1509140">i</span>&nbsp;<span class="op" id="1509142">+</span>&nbsp;<span class="ident" id="1509144">it</span><span class="op" id="1509146">.</span><span class="ident" id="1509147">offset</span><span class="op" id="1509153">)</span>&nbsp;<span class="op" id="1509155">&amp;</span>&nbsp;<span class="op" id="1509157">(</span><span class="ident" id="1509158">bucketCnt</span>&nbsp;<span class="op" id="1509168">-</span>&nbsp;<span class="num" id="1509170">1</span><span class="op" id="1509171">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509175">k</span>&nbsp;<span class="op" id="1509177">:=</span>&nbsp;<span class="ident" id="1509180">add</span><span class="op" id="1509183">(</span><span class="ident" id="1509184">unsafe</span><span class="op" id="1509190">.</span><span class="ident" id="1509191">Pointer</span><span class="op" id="1509198">(</span><span class="ident" id="1509199">b</span><span class="op" id="1509200">)</span><span class="op" id="1509201">,</span>&nbsp;<span class="ident" id="1509203">dataOffset</span><span class="op" id="1509213">+</span><span class="builtintype" id="1509214">uintptr</span><span class="op" id="1509221">(</span><span class="ident" id="1509222">offi</span><span class="op" id="1509226">)</span><span class="op" id="1509227">*</span><span class="builtintype" id="1509228">uintptr</span><span class="op" id="1509235">(</span><span class="ident" id="1509236">t</span><span class="op" id="1509237">.</span><span class="ident" id="1509238">keysize</span><span class="op" id="1509245">)</span><span class="op" id="1509246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509250">v</span>&nbsp;<span class="op" id="1509252">:=</span>&nbsp;<span class="ident" id="1509255">add</span><span class="op" id="1509258">(</span><span class="ident" id="1509259">unsafe</span><span class="op" id="1509265">.</span><span class="ident" id="1509266">Pointer</span><span class="op" id="1509273">(</span><span class="ident" id="1509274">b</span><span class="op" id="1509275">)</span><span class="op" id="1509276">,</span>&nbsp;<span class="ident" id="1509278">dataOffset</span><span class="op" id="1509288">+</span><span class="ident" id="1509289">bucketCnt</span><span class="op" id="1509298">*</span><span class="builtintype" id="1509299">uintptr</span><span class="op" id="1509306">(</span><span class="ident" id="1509307">t</span><span class="op" id="1509308">.</span><span class="ident" id="1509309">keysize</span><span class="op" id="1509316">)</span><span class="op" id="1509317">+</span><span class="builtintype" id="1509318">uintptr</span><span class="op" id="1509325">(</span><span class="ident" id="1509326">offi</span><span class="op" id="1509330">)</span><span class="op" id="1509331">*</span><span class="builtintype" id="1509332">uintptr</span><span class="op" id="1509339">(</span><span class="ident" id="1509340">t</span><span class="op" id="1509341">.</span><span class="ident" id="1509342">valuesize</span><span class="op" id="1509351">)</span><span class="op" id="1509352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509356">if</span>&nbsp;<span class="ident" id="1509359">b</span><span class="op" id="1509360">.</span><span class="ident" id="1509361">tophash</span><span class="op" id="1509368">[</span><span class="ident" id="1509369">offi</span><span class="op" id="1509373">]</span>&nbsp;<span class="op" id="1509375">!=</span>&nbsp;<span class="ident" id="1509378">empty</span>&nbsp;<span class="op" id="1509384">&amp;&amp;</span>&nbsp;<span class="ident" id="1509387">b</span><span class="op" id="1509388">.</span><span class="ident" id="1509389">tophash</span><span class="op" id="1509396">[</span><span class="ident" id="1509397">offi</span><span class="op" id="1509401">]</span>&nbsp;<span class="op" id="1509403">!=</span>&nbsp;<span class="ident" id="1509406">evacuatedEmpty</span>&nbsp;<span class="op" id="1509421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509426">if</span>&nbsp;<span class="ident" id="1509429">checkBucket</span>&nbsp;<span class="op" id="1509441">!=</span>&nbsp;<span class="ident" id="1509444">noCheck</span>&nbsp;<span class="op" id="1509452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509458">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509522">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509584">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509653">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509718">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509779">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509841">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509872">k2</span>&nbsp;<span class="op" id="1509875">:=</span>&nbsp;<span class="ident" id="1509878">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509884">if</span>&nbsp;<span class="ident" id="1509887">t</span><span class="op" id="1509888">.</span><span class="ident" id="1509889">indirectkey</span>&nbsp;<span class="op" id="1509901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509908">k2</span>&nbsp;<span class="op" id="1509911">=</span>&nbsp;<span class="op" id="1509913">*</span><span class="op" id="1509914">(</span><span class="op" id="1509915">(</span><span class="op" id="1509916">*</span><span class="ident" id="1509917">unsafe</span><span class="op" id="1509923">.</span><span class="ident" id="1509924">Pointer</span><span class="op" id="1509931">)</span><span class="op" id="1509932">(</span><span class="ident" id="1509933">k2</span><span class="op" id="1509935">)</span><span class="op" id="1509936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509942">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509948">if</span>&nbsp;<span class="ident" id="1509951">alg</span><span class="op" id="1509954">.</span><span class="ident" id="1509955">equal</span><span class="op" id="1509960">(</span><span class="ident" id="1509961">k2</span><span class="op" id="1509963">,</span>&nbsp;<span class="ident" id="1509965">k2</span><span class="op" id="1509967">,</span>&nbsp;<span class="builtintype" id="1509969">uintptr</span><span class="op" id="1509976">(</span><span class="ident" id="1509977">t</span><span class="op" id="1509978">.</span><span class="ident" id="1509979">key</span><span class="op" id="1509982">.</span><span class="ident" id="1509983">size</span><span class="op" id="1509987">)</span><span class="op" id="1509988">)</span>&nbsp;<span class="op" id="1509990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1509997">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510054">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510112">hash</span>&nbsp;<span class="op" id="1510117">:=</span>&nbsp;<span class="ident" id="1510120">alg</span><span class="op" id="1510123">.</span><span class="ident" id="1510124">hash</span><span class="op" id="1510128">(</span><span class="ident" id="1510129">k2</span><span class="op" id="1510131">,</span>&nbsp;<span class="builtintype" id="1510133">uintptr</span><span class="op" id="1510140">(</span><span class="ident" id="1510141">t</span><span class="op" id="1510142">.</span><span class="ident" id="1510143">key</span><span class="op" id="1510146">.</span><span class="ident" id="1510147">size</span><span class="op" id="1510151">)</span><span class="op" id="1510152">,</span>&nbsp;<span class="builtintype" id="1510154">uintptr</span><span class="op" id="1510161">(</span><span class="ident" id="1510162">h</span><span class="op" id="1510163">.</span><span class="ident" id="1510164">hash0</span><span class="op" id="1510169">)</span><span class="op" id="1510170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510177">if</span>&nbsp;<span class="ident" id="1510180">hash</span><span class="op" id="1510184">&amp;</span><span class="op" id="1510185">(</span><span class="builtintype" id="1510186">uintptr</span><span class="op" id="1510193">(</span><span class="num" id="1510194">1</span><span class="op" id="1510195">)</span><span class="op" id="1510196">&lt;&lt;</span><span class="ident" id="1510198">it</span><span class="op" id="1510200">.</span><span class="ident" id="1510201">B</span><span class="op" id="1510202">-</span><span class="num" id="1510203">1</span><span class="op" id="1510204">)</span>&nbsp;<span class="op" id="1510206">!=</span>&nbsp;<span class="ident" id="1510209">checkBucket</span>&nbsp;<span class="op" id="1510221">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510229">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510249">}</span>&nbsp;<span class="keyword" id="1510251">else</span>&nbsp;<span class="op" id="1510256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510263">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510322">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510381">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510440">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510492">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510552">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510610">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510633">if</span>&nbsp;<span class="ident" id="1510636">checkBucket</span><span class="op" id="1510647">&gt;&gt;</span><span class="op" id="1510649">(</span><span class="ident" id="1510650">it</span><span class="op" id="1510652">.</span><span class="ident" id="1510653">B</span><span class="op" id="1510654">-</span><span class="num" id="1510655">1</span><span class="op" id="1510656">)</span>&nbsp;<span class="op" id="1510658">!=</span>&nbsp;<span class="builtintype" id="1510661">uintptr</span><span class="op" id="1510668">(</span><span class="ident" id="1510669">b</span><span class="op" id="1510670">.</span><span class="ident" id="1510671">tophash</span><span class="op" id="1510678">[</span><span class="ident" id="1510679">offi</span><span class="op" id="1510683">]</span><span class="op" id="1510684">&amp;</span><span class="num" id="1510685">1</span><span class="op" id="1510686">)</span>&nbsp;<span class="op" id="1510688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510696">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510721">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510726">if</span>&nbsp;<span class="ident" id="1510729">b</span><span class="op" id="1510730">.</span><span class="ident" id="1510731">tophash</span><span class="op" id="1510738">[</span><span class="ident" id="1510739">offi</span><span class="op" id="1510743">]</span>&nbsp;<span class="op" id="1510745">!=</span>&nbsp;<span class="ident" id="1510748">evacuatedX</span>&nbsp;<span class="op" id="1510759">&amp;&amp;</span>&nbsp;<span class="ident" id="1510762">b</span><span class="op" id="1510763">.</span><span class="ident" id="1510764">tophash</span><span class="op" id="1510771">[</span><span class="ident" id="1510772">offi</span><span class="op" id="1510776">]</span>&nbsp;<span class="op" id="1510778">!=</span>&nbsp;<span class="ident" id="1510781">evacuatedY</span>&nbsp;<span class="op" id="1510792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510798">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510848">if</span>&nbsp;<span class="ident" id="1510851">t</span><span class="op" id="1510852">.</span><span class="ident" id="1510853">indirectkey</span>&nbsp;<span class="op" id="1510865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510872">k</span>&nbsp;<span class="op" id="1510874">=</span>&nbsp;<span class="op" id="1510876">*</span><span class="op" id="1510877">(</span><span class="op" id="1510878">(</span><span class="op" id="1510879">*</span><span class="ident" id="1510880">unsafe</span><span class="op" id="1510886">.</span><span class="ident" id="1510887">Pointer</span><span class="op" id="1510894">)</span><span class="op" id="1510895">(</span><span class="ident" id="1510896">k</span><span class="op" id="1510897">)</span><span class="op" id="1510898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510904">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510910">it</span><span class="op" id="1510912">.</span><span class="ident" id="1510913">key</span>&nbsp;<span class="op" id="1510917">=</span>&nbsp;<span class="ident" id="1510919">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510925">if</span>&nbsp;<span class="ident" id="1510928">t</span><span class="op" id="1510929">.</span><span class="ident" id="1510930">indirectvalue</span>&nbsp;<span class="op" id="1510944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510951">v</span>&nbsp;<span class="op" id="1510953">=</span>&nbsp;<span class="op" id="1510955">*</span><span class="op" id="1510956">(</span><span class="op" id="1510957">(</span><span class="op" id="1510958">*</span><span class="ident" id="1510959">unsafe</span><span class="op" id="1510965">.</span><span class="ident" id="1510966">Pointer</span><span class="op" id="1510973">)</span><span class="op" id="1510974">(</span><span class="ident" id="1510975">v</span><span class="op" id="1510976">)</span><span class="op" id="1510977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510989">it</span><span class="op" id="1510991">.</span><span class="ident" id="1510992">value</span>&nbsp;<span class="op" id="1510998">=</span>&nbsp;<span class="ident" id="1511000">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511005">}</span>&nbsp;<span class="keyword" id="1511007">else</span>&nbsp;<span class="op" id="1511012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511018">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511082">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511141">k2</span>&nbsp;<span class="op" id="1511144">:=</span>&nbsp;<span class="ident" id="1511147">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511153">if</span>&nbsp;<span class="ident" id="1511156">t</span><span class="op" id="1511157">.</span><span class="ident" id="1511158">indirectkey</span>&nbsp;<span class="op" id="1511170">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511177">k2</span>&nbsp;<span class="op" id="1511180">=</span>&nbsp;<span class="op" id="1511182">*</span><span class="op" id="1511183">(</span><span class="op" id="1511184">(</span><span class="op" id="1511185">*</span><span class="ident" id="1511186">unsafe</span><span class="op" id="1511192">.</span><span class="ident" id="1511193">Pointer</span><span class="op" id="1511200">)</span><span class="op" id="1511201">(</span><span class="ident" id="1511202">k2</span><span class="op" id="1511204">)</span><span class="op" id="1511205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511217">if</span>&nbsp;<span class="ident" id="1511220">alg</span><span class="op" id="1511223">.</span><span class="ident" id="1511224">equal</span><span class="op" id="1511229">(</span><span class="ident" id="1511230">k2</span><span class="op" id="1511232">,</span>&nbsp;<span class="ident" id="1511234">k2</span><span class="op" id="1511236">,</span>&nbsp;<span class="builtintype" id="1511238">uintptr</span><span class="op" id="1511245">(</span><span class="ident" id="1511246">t</span><span class="op" id="1511247">.</span><span class="ident" id="1511248">key</span><span class="op" id="1511251">.</span><span class="ident" id="1511252">size</span><span class="op" id="1511256">)</span><span class="op" id="1511257">)</span>&nbsp;<span class="op" id="1511259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511266">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511317">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511366">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511428">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511495">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511568">rk</span><span class="op" id="1511570">,</span>&nbsp;<span class="ident" id="1511572">rv</span>&nbsp;<span class="op" id="1511575">:=</span>&nbsp;<span class="ident" id="1511578">mapaccessK</span><span class="op" id="1511588">(</span><span class="ident" id="1511589">t</span><span class="op" id="1511590">,</span>&nbsp;<span class="ident" id="1511592">h</span><span class="op" id="1511593">,</span>&nbsp;<span class="ident" id="1511595">k2</span><span class="op" id="1511597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511604">if</span>&nbsp;<span class="ident" id="1511607">rk</span>&nbsp;<span class="op" id="1511610">==</span>&nbsp;<span class="ident" id="1511613">nil</span>&nbsp;<span class="op" id="1511617">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511625">continue</span>&nbsp;<span class="comment" id="1511634">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511670">it</span><span class="op" id="1511672">.</span><span class="ident" id="1511673">key</span>&nbsp;<span class="op" id="1511677">=</span>&nbsp;<span class="ident" id="1511679">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511687">it</span><span class="op" id="1511689">.</span><span class="ident" id="1511690">value</span>&nbsp;<span class="op" id="1511696">=</span>&nbsp;<span class="ident" id="1511698">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1511705">}</span>&nbsp;<span class="keyword" id="1511707">else</span>&nbsp;<span class="op" id="1511712">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511719">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511774">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511835">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511888">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511931">it</span><span class="op" id="1511933">.</span><span class="ident" id="1511934">key</span>&nbsp;<span class="op" id="1511938">=</span>&nbsp;<span class="ident" id="1511940">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1511948">if</span>&nbsp;<span class="ident" id="1511951">t</span><span class="op" id="1511952">.</span><span class="ident" id="1511953">indirectvalue</span>&nbsp;<span class="op" id="1511967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511975">v</span>&nbsp;<span class="op" id="1511977">=</span>&nbsp;<span class="op" id="1511979">*</span><span class="op" id="1511980">(</span><span class="op" id="1511981">(</span><span class="op" id="1511982">*</span><span class="ident" id="1511983">unsafe</span><span class="op" id="1511989">.</span><span class="ident" id="1511990">Pointer</span><span class="op" id="1511997">)</span><span class="op" id="1511998">(</span><span class="ident" id="1511999">v</span><span class="op" id="1512000">)</span><span class="op" id="1512001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512015">it</span><span class="op" id="1512017">.</span><span class="ident" id="1512018">value</span>&nbsp;<span class="op" id="1512024">=</span>&nbsp;<span class="ident" id="1512026">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512032">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512042">it</span><span class="op" id="1512044">.</span><span class="ident" id="1512045">bucket</span>&nbsp;<span class="op" id="1512052">=</span>&nbsp;<span class="ident" id="1512054">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512064">it</span><span class="op" id="1512066">.</span><span class="ident" id="1512067">bptr</span>&nbsp;<span class="op" id="1512072">=</span>&nbsp;<span class="ident" id="1512074">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512079">it</span><span class="op" id="1512081">.</span><span class="ident" id="1512082">i</span>&nbsp;<span class="op" id="1512084">=</span>&nbsp;<span class="ident" id="1512086">i</span>&nbsp;<span class="op" id="1512088">+</span>&nbsp;<span class="num" id="1512090">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512095">it</span><span class="op" id="1512097">.</span><span class="ident" id="1512098">checkBucket</span>&nbsp;<span class="op" id="1512110">=</span>&nbsp;<span class="ident" id="1512112">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512127">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512142">b</span>&nbsp;<span class="op" id="1512144">=</span>&nbsp;<span class="ident" id="1512146">b</span><span class="op" id="1512147">.</span><span class="ident" id="1512148">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512158">i</span>&nbsp;<span class="op" id="1512160">=</span>&nbsp;<span class="num" id="1512162">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512165">goto</span>&nbsp;<span class="ident" id="1512170">next</span><br>
<span class="lineno"></span><span class="op" id="1512175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1512178">func</span>&nbsp;<span class="ident" id="1512183">hashGrow</span><span class="op" id="1512191">(</span><span class="ident" id="1512192">t</span>&nbsp;<span class="op" id="1512194">*</span><span class="ident" id="1512195">maptype</span><span class="op" id="1512202">,</span>&nbsp;<span class="ident" id="1512204">h</span>&nbsp;<span class="op" id="1512206">*</span><span class="ident" id="1512207">hmap</span><span class="op" id="1512211">)</span>&nbsp;<span class="op" id="1512213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512216">if</span>&nbsp;<span class="ident" id="1512219">h</span><span class="op" id="1512220">.</span><span class="ident" id="1512221">oldbuckets</span>&nbsp;<span class="op" id="1512232">!=</span>&nbsp;<span class="ident" id="1512235">nil</span>&nbsp;<span class="op" id="1512239">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512243">gothrow</span><span class="op" id="1512250">(</span><span class="string" id="1512251">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1512280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512286">oldbuckets</span>&nbsp;<span class="op" id="1512297">:=</span>&nbsp;<span class="ident" id="1512300">h</span><span class="op" id="1512301">.</span><span class="ident" id="1512302">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512311">if</span>&nbsp;<span class="ident" id="1512314">checkgc</span>&nbsp;<span class="op" id="1512322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512326">memstats</span><span class="op" id="1512334">.</span><span class="ident" id="1512335">next_gc</span>&nbsp;<span class="op" id="1512343">=</span>&nbsp;<span class="ident" id="1512345">memstats</span><span class="op" id="1512353">.</span><span class="ident" id="1512354">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512369">newbuckets</span>&nbsp;<span class="op" id="1512380">:=</span>&nbsp;<span class="ident" id="1512383">newarray</span><span class="op" id="1512391">(</span><span class="ident" id="1512392">t</span><span class="op" id="1512393">.</span><span class="ident" id="1512394">bucket</span><span class="op" id="1512400">,</span>&nbsp;<span class="builtintype" id="1512402">uintptr</span><span class="op" id="1512409">(</span><span class="num" id="1512410">1</span><span class="op" id="1512411">)</span><span class="op" id="1512412">&lt;&lt;</span><span class="op" id="1512414">(</span><span class="ident" id="1512415">h</span><span class="op" id="1512416">.</span><span class="ident" id="1512417">B</span><span class="op" id="1512418">+</span><span class="num" id="1512419">1</span><span class="op" id="1512420">)</span><span class="op" id="1512421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512424">flags</span>&nbsp;<span class="op" id="1512430">:=</span>&nbsp;<span class="ident" id="1512433">h</span><span class="op" id="1512434">.</span><span class="ident" id="1512435">flags</span>&nbsp;<span class="op" id="1512441">&amp;^</span>&nbsp;<span class="op" id="1512444">(</span><span class="ident" id="1512445">iterator</span>&nbsp;<span class="op" id="1512454">|</span>&nbsp;<span class="ident" id="1512456">oldIterator</span><span class="op" id="1512467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1512470">if</span>&nbsp;<span class="ident" id="1512473">h</span><span class="op" id="1512474">.</span><span class="ident" id="1512475">flags</span><span class="op" id="1512480">&amp;</span><span class="ident" id="1512481">iterator</span>&nbsp;<span class="op" id="1512490">!=</span>&nbsp;<span class="num" id="1512493">0</span>&nbsp;<span class="op" id="1512495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512499">flags</span>&nbsp;<span class="op" id="1512505">|=</span>&nbsp;<span class="ident" id="1512508">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1512521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512524">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512560">h</span><span class="op" id="1512561">.</span><span class="ident" id="1512562">B</span><span class="op" id="1512563">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512567">h</span><span class="op" id="1512568">.</span><span class="ident" id="1512569">flags</span>&nbsp;<span class="op" id="1512575">=</span>&nbsp;<span class="ident" id="1512577">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512584">h</span><span class="op" id="1512585">.</span><span class="ident" id="1512586">oldbuckets</span>&nbsp;<span class="op" id="1512597">=</span>&nbsp;<span class="ident" id="1512599">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512611">h</span><span class="op" id="1512612">.</span><span class="ident" id="1512613">buckets</span>&nbsp;<span class="op" id="1512621">=</span>&nbsp;<span class="ident" id="1512623">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512635">h</span><span class="op" id="1512636">.</span><span class="ident" id="1512637">nevacuate</span>&nbsp;<span class="op" id="1512647">=</span>&nbsp;<span class="num" id="1512649">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512653">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512721">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1512754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1512757">func</span>&nbsp;<span class="ident" id="1512762">growWork</span><span class="op" id="1512770">(</span><span class="ident" id="1512771">t</span>&nbsp;<span class="op" id="1512773">*</span><span class="ident" id="1512774">maptype</span><span class="op" id="1512781">,</span>&nbsp;<span class="ident" id="1512783">h</span>&nbsp;<span class="op" id="1512785">*</span><span class="ident" id="1512786">hmap</span><span class="op" id="1512790">,</span>&nbsp;<span class="ident" id="1512792">bucket</span>&nbsp;<span class="builtintype" id="1512799">uintptr</span><span class="op" id="1512806">)</span>&nbsp;<span class="op" id="1512808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512811">noldbuckets</span>&nbsp;<span class="op" id="1512823">:=</span>&nbsp;<span class="builtintype" id="1512826">uintptr</span><span class="op" id="1512833">(</span><span class="num" id="1512834">1</span><span class="op" id="1512835">)</span>&nbsp;<span class="op" id="1512837">&lt;&lt;</span>&nbsp;<span class="op" id="1512840">(</span><span class="ident" id="1512841">h</span><span class="op" id="1512842">.</span><span class="ident" id="1512843">B</span>&nbsp;<span class="op" id="1512845">-</span>&nbsp;<span class="num" id="1512847">1</span><span class="op" id="1512848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512852">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512906">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512943">evacuate</span><span class="op" id="1512951">(</span><span class="ident" id="1512952">t</span><span class="op" id="1512953">,</span>&nbsp;<span class="ident" id="1512955">h</span><span class="op" id="1512956">,</span>&nbsp;<span class="ident" id="1512958">bucket</span><span class="op" id="1512964">&amp;</span><span class="op" id="1512965">(</span><span class="ident" id="1512966">noldbuckets</span><span class="op" id="1512977">-</span><span class="num" id="1512978">1</span><span class="op" id="1512979">)</span><span class="op" id="1512980">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512984">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513044">if</span>&nbsp;<span class="ident" id="1513047">h</span><span class="op" id="1513048">.</span><span class="ident" id="1513049">oldbuckets</span>&nbsp;<span class="op" id="1513060">!=</span>&nbsp;<span class="ident" id="1513063">nil</span>&nbsp;<span class="op" id="1513067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513071">evacuate</span><span class="op" id="1513079">(</span><span class="ident" id="1513080">t</span><span class="op" id="1513081">,</span>&nbsp;<span class="ident" id="1513083">h</span><span class="op" id="1513084">,</span>&nbsp;<span class="ident" id="1513086">h</span><span class="op" id="1513087">.</span><span class="ident" id="1513088">nevacuate</span><span class="op" id="1513097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1513100">}</span><br>
<span class="lineno"></span><span class="op" id="1513102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1513105">func</span>&nbsp;<span class="ident" id="1513110">evacuate</span><span class="op" id="1513118">(</span><span class="ident" id="1513119">t</span>&nbsp;<span class="op" id="1513121">*</span><span class="ident" id="1513122">maptype</span><span class="op" id="1513129">,</span>&nbsp;<span class="ident" id="1513131">h</span>&nbsp;<span class="op" id="1513133">*</span><span class="ident" id="1513134">hmap</span><span class="op" id="1513138">,</span>&nbsp;<span class="ident" id="1513140">oldbucket</span>&nbsp;<span class="builtintype" id="1513150">uintptr</span><span class="op" id="1513157">)</span>&nbsp;<span class="op" id="1513159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513162">b</span>&nbsp;<span class="op" id="1513164">:=</span>&nbsp;<span class="op" id="1513167">(</span><span class="op" id="1513168">*</span><span class="ident" id="1513169">bmap</span><span class="op" id="1513173">)</span><span class="op" id="1513174">(</span><span class="ident" id="1513175">add</span><span class="op" id="1513178">(</span><span class="ident" id="1513179">h</span><span class="op" id="1513180">.</span><span class="ident" id="1513181">oldbuckets</span><span class="op" id="1513191">,</span>&nbsp;<span class="ident" id="1513193">oldbucket</span><span class="op" id="1513202">*</span><span class="builtintype" id="1513203">uintptr</span><span class="op" id="1513210">(</span><span class="ident" id="1513211">t</span><span class="op" id="1513212">.</span><span class="ident" id="1513213">bucketsize</span><span class="op" id="1513223">)</span><span class="op" id="1513224">)</span><span class="op" id="1513225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513228">newbit</span>&nbsp;<span class="op" id="1513235">:=</span>&nbsp;<span class="builtintype" id="1513238">uintptr</span><span class="op" id="1513245">(</span><span class="num" id="1513246">1</span><span class="op" id="1513247">)</span>&nbsp;<span class="op" id="1513249">&lt;&lt;</span>&nbsp;<span class="op" id="1513252">(</span><span class="ident" id="1513253">h</span><span class="op" id="1513254">.</span><span class="ident" id="1513255">B</span>&nbsp;<span class="op" id="1513257">-</span>&nbsp;<span class="num" id="1513259">1</span><span class="op" id="1513260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513263">alg</span>&nbsp;<span class="op" id="1513267">:=</span>&nbsp;<span class="ident" id="1513270">goalg</span><span class="op" id="1513275">(</span><span class="ident" id="1513276">t</span><span class="op" id="1513277">.</span><span class="ident" id="1513278">key</span><span class="op" id="1513281">.</span><span class="ident" id="1513282">alg</span><span class="op" id="1513285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513288">if</span>&nbsp;<span class="op" id="1513291">!</span><span class="ident" id="1513292">evacuated</span><span class="op" id="1513301">(</span><span class="ident" id="1513302">b</span><span class="op" id="1513303">)</span>&nbsp;<span class="op" id="1513305">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513309">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513379">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513443">x</span>&nbsp;<span class="op" id="1513445">:=</span>&nbsp;<span class="op" id="1513448">(</span><span class="op" id="1513449">*</span><span class="ident" id="1513450">bmap</span><span class="op" id="1513454">)</span><span class="op" id="1513455">(</span><span class="ident" id="1513456">add</span><span class="op" id="1513459">(</span><span class="ident" id="1513460">h</span><span class="op" id="1513461">.</span><span class="ident" id="1513462">buckets</span><span class="op" id="1513469">,</span>&nbsp;<span class="ident" id="1513471">oldbucket</span><span class="op" id="1513480">*</span><span class="builtintype" id="1513481">uintptr</span><span class="op" id="1513488">(</span><span class="ident" id="1513489">t</span><span class="op" id="1513490">.</span><span class="ident" id="1513491">bucketsize</span><span class="op" id="1513501">)</span><span class="op" id="1513502">)</span><span class="op" id="1513503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513507">y</span>&nbsp;<span class="op" id="1513509">:=</span>&nbsp;<span class="op" id="1513512">(</span><span class="op" id="1513513">*</span><span class="ident" id="1513514">bmap</span><span class="op" id="1513518">)</span><span class="op" id="1513519">(</span><span class="ident" id="1513520">add</span><span class="op" id="1513523">(</span><span class="ident" id="1513524">h</span><span class="op" id="1513525">.</span><span class="ident" id="1513526">buckets</span><span class="op" id="1513533">,</span>&nbsp;<span class="op" id="1513535">(</span><span class="ident" id="1513536">oldbucket</span><span class="op" id="1513545">+</span><span class="ident" id="1513546">newbit</span><span class="op" id="1513552">)</span><span class="op" id="1513553">*</span><span class="builtintype" id="1513554">uintptr</span><span class="op" id="1513561">(</span><span class="ident" id="1513562">t</span><span class="op" id="1513563">.</span><span class="ident" id="1513564">bucketsize</span><span class="op" id="1513574">)</span><span class="op" id="1513575">)</span><span class="op" id="1513576">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513580">xi</span>&nbsp;<span class="op" id="1513583">:=</span>&nbsp;<span class="num" id="1513586">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513590">yi</span>&nbsp;<span class="op" id="1513593">:=</span>&nbsp;<span class="num" id="1513596">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513600">xk</span>&nbsp;<span class="op" id="1513603">:=</span>&nbsp;<span class="ident" id="1513606">add</span><span class="op" id="1513609">(</span><span class="ident" id="1513610">unsafe</span><span class="op" id="1513616">.</span><span class="ident" id="1513617">Pointer</span><span class="op" id="1513624">(</span><span class="ident" id="1513625">x</span><span class="op" id="1513626">)</span><span class="op" id="1513627">,</span>&nbsp;<span class="ident" id="1513629">dataOffset</span><span class="op" id="1513639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513643">yk</span>&nbsp;<span class="op" id="1513646">:=</span>&nbsp;<span class="ident" id="1513649">add</span><span class="op" id="1513652">(</span><span class="ident" id="1513653">unsafe</span><span class="op" id="1513659">.</span><span class="ident" id="1513660">Pointer</span><span class="op" id="1513667">(</span><span class="ident" id="1513668">y</span><span class="op" id="1513669">)</span><span class="op" id="1513670">,</span>&nbsp;<span class="ident" id="1513672">dataOffset</span><span class="op" id="1513682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513686">xv</span>&nbsp;<span class="op" id="1513689">:=</span>&nbsp;<span class="ident" id="1513692">add</span><span class="op" id="1513695">(</span><span class="ident" id="1513696">xk</span><span class="op" id="1513698">,</span>&nbsp;<span class="ident" id="1513700">bucketCnt</span><span class="op" id="1513709">*</span><span class="builtintype" id="1513710">uintptr</span><span class="op" id="1513717">(</span><span class="ident" id="1513718">t</span><span class="op" id="1513719">.</span><span class="ident" id="1513720">keysize</span><span class="op" id="1513727">)</span><span class="op" id="1513728">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513732">yv</span>&nbsp;<span class="op" id="1513735">:=</span>&nbsp;<span class="ident" id="1513738">add</span><span class="op" id="1513741">(</span><span class="ident" id="1513742">yk</span><span class="op" id="1513744">,</span>&nbsp;<span class="ident" id="1513746">bucketCnt</span><span class="op" id="1513755">*</span><span class="builtintype" id="1513756">uintptr</span><span class="op" id="1513763">(</span><span class="ident" id="1513764">t</span><span class="op" id="1513765">.</span><span class="ident" id="1513766">keysize</span><span class="op" id="1513773">)</span><span class="op" id="1513774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513778">for</span>&nbsp;<span class="op" id="1513782">;</span>&nbsp;<span class="ident" id="1513784">b</span>&nbsp;<span class="op" id="1513786">!=</span>&nbsp;<span class="ident" id="1513789">nil</span><span class="op" id="1513792">;</span>&nbsp;<span class="ident" id="1513794">b</span>&nbsp;<span class="op" id="1513796">=</span>&nbsp;<span class="ident" id="1513798">b</span><span class="op" id="1513799">.</span><span class="ident" id="1513800">overflow</span>&nbsp;<span class="op" id="1513809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513814">k</span>&nbsp;<span class="op" id="1513816">:=</span>&nbsp;<span class="ident" id="1513819">add</span><span class="op" id="1513822">(</span><span class="ident" id="1513823">unsafe</span><span class="op" id="1513829">.</span><span class="ident" id="1513830">Pointer</span><span class="op" id="1513837">(</span><span class="ident" id="1513838">b</span><span class="op" id="1513839">)</span><span class="op" id="1513840">,</span>&nbsp;<span class="ident" id="1513842">dataOffset</span><span class="op" id="1513852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513857">v</span>&nbsp;<span class="op" id="1513859">:=</span>&nbsp;<span class="ident" id="1513862">add</span><span class="op" id="1513865">(</span><span class="ident" id="1513866">k</span><span class="op" id="1513867">,</span>&nbsp;<span class="ident" id="1513869">bucketCnt</span><span class="op" id="1513878">*</span><span class="builtintype" id="1513879">uintptr</span><span class="op" id="1513886">(</span><span class="ident" id="1513887">t</span><span class="op" id="1513888">.</span><span class="ident" id="1513889">keysize</span><span class="op" id="1513896">)</span><span class="op" id="1513897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513902">for</span>&nbsp;<span class="ident" id="1513906">i</span>&nbsp;<span class="op" id="1513908">:=</span>&nbsp;<span class="num" id="1513911">0</span><span class="op" id="1513912">;</span>&nbsp;<span class="ident" id="1513914">i</span>&nbsp;<span class="op" id="1513916">&lt;</span>&nbsp;<span class="ident" id="1513918">bucketCnt</span><span class="op" id="1513927">;</span>&nbsp;<span class="ident" id="1513929">i</span><span class="op" id="1513930">,</span>&nbsp;<span class="ident" id="1513932">k</span><span class="op" id="1513933">,</span>&nbsp;<span class="ident" id="1513935">v</span>&nbsp;<span class="op" id="1513937">=</span>&nbsp;<span class="ident" id="1513939">i</span><span class="op" id="1513940">+</span><span class="num" id="1513941">1</span><span class="op" id="1513942">,</span>&nbsp;<span class="ident" id="1513944">add</span><span class="op" id="1513947">(</span><span class="ident" id="1513948">k</span><span class="op" id="1513949">,</span>&nbsp;<span class="builtintype" id="1513951">uintptr</span><span class="op" id="1513958">(</span><span class="ident" id="1513959">t</span><span class="op" id="1513960">.</span><span class="ident" id="1513961">keysize</span><span class="op" id="1513968">)</span><span class="op" id="1513969">)</span><span class="op" id="1513970">,</span>&nbsp;<span class="ident" id="1513972">add</span><span class="op" id="1513975">(</span><span class="ident" id="1513976">v</span><span class="op" id="1513977">,</span>&nbsp;<span class="builtintype" id="1513979">uintptr</span><span class="op" id="1513986">(</span><span class="ident" id="1513987">t</span><span class="op" id="1513988">.</span><span class="ident" id="1513989">valuesize</span><span class="op" id="1513998">)</span><span class="op" id="1513999">)</span>&nbsp;<span class="op" id="1514001">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514007">top</span>&nbsp;<span class="op" id="1514011">:=</span>&nbsp;<span class="ident" id="1514014">b</span><span class="op" id="1514015">.</span><span class="ident" id="1514016">tophash</span><span class="op" id="1514023">[</span><span class="ident" id="1514024">i</span><span class="op" id="1514025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514031">if</span>&nbsp;<span class="ident" id="1514034">top</span>&nbsp;<span class="op" id="1514038">==</span>&nbsp;<span class="ident" id="1514041">empty</span>&nbsp;<span class="op" id="1514047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514054">b</span><span class="op" id="1514055">.</span><span class="ident" id="1514056">tophash</span><span class="op" id="1514063">[</span><span class="ident" id="1514064">i</span><span class="op" id="1514065">]</span>&nbsp;<span class="op" id="1514067">=</span>&nbsp;<span class="ident" id="1514069">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514089">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514102">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514108">if</span>&nbsp;<span class="ident" id="1514111">top</span>&nbsp;<span class="op" id="1514115">&lt;</span>&nbsp;<span class="ident" id="1514117">minTopHash</span>&nbsp;<span class="op" id="1514128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514135">gothrow</span><span class="op" id="1514142">(</span><span class="string" id="1514143">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1514158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514170">k2</span>&nbsp;<span class="op" id="1514173">:=</span>&nbsp;<span class="ident" id="1514176">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514182">if</span>&nbsp;<span class="ident" id="1514185">t</span><span class="op" id="1514186">.</span><span class="ident" id="1514187">indirectkey</span>&nbsp;<span class="op" id="1514199">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514206">k2</span>&nbsp;<span class="op" id="1514209">=</span>&nbsp;<span class="op" id="1514211">*</span><span class="op" id="1514212">(</span><span class="op" id="1514213">(</span><span class="op" id="1514214">*</span><span class="ident" id="1514215">unsafe</span><span class="op" id="1514221">.</span><span class="ident" id="1514222">Pointer</span><span class="op" id="1514229">)</span><span class="op" id="1514230">(</span><span class="ident" id="1514231">k2</span><span class="op" id="1514233">)</span><span class="op" id="1514234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514246">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514315">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514371">hash</span>&nbsp;<span class="op" id="1514376">:=</span>&nbsp;<span class="ident" id="1514379">alg</span><span class="op" id="1514382">.</span><span class="ident" id="1514383">hash</span><span class="op" id="1514387">(</span><span class="ident" id="1514388">k2</span><span class="op" id="1514390">,</span>&nbsp;<span class="builtintype" id="1514392">uintptr</span><span class="op" id="1514399">(</span><span class="ident" id="1514400">t</span><span class="op" id="1514401">.</span><span class="ident" id="1514402">key</span><span class="op" id="1514405">.</span><span class="ident" id="1514406">size</span><span class="op" id="1514410">)</span><span class="op" id="1514411">,</span>&nbsp;<span class="builtintype" id="1514413">uintptr</span><span class="op" id="1514420">(</span><span class="ident" id="1514421">h</span><span class="op" id="1514422">.</span><span class="ident" id="1514423">hash0</span><span class="op" id="1514428">)</span><span class="op" id="1514429">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514435">if</span>&nbsp;<span class="ident" id="1514438">h</span><span class="op" id="1514439">.</span><span class="ident" id="1514440">flags</span><span class="op" id="1514445">&amp;</span><span class="ident" id="1514446">iterator</span>&nbsp;<span class="op" id="1514455">!=</span>&nbsp;<span class="num" id="1514458">0</span>&nbsp;<span class="op" id="1514460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514467">if</span>&nbsp;<span class="op" id="1514470">!</span><span class="ident" id="1514471">alg</span><span class="op" id="1514474">.</span><span class="ident" id="1514475">equal</span><span class="op" id="1514480">(</span><span class="ident" id="1514481">k2</span><span class="op" id="1514483">,</span>&nbsp;<span class="ident" id="1514485">k2</span><span class="op" id="1514487">,</span>&nbsp;<span class="builtintype" id="1514489">uintptr</span><span class="op" id="1514496">(</span><span class="ident" id="1514497">t</span><span class="op" id="1514498">.</span><span class="ident" id="1514499">key</span><span class="op" id="1514502">.</span><span class="ident" id="1514503">size</span><span class="op" id="1514507">)</span><span class="op" id="1514508">)</span>&nbsp;<span class="op" id="1514510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514518">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514586">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514653">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514721">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514785">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514837">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514905">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514974">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515044">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515109">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1515176">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515207">if</span>&nbsp;<span class="op" id="1515210">(</span><span class="ident" id="1515211">top</span>&nbsp;<span class="op" id="1515215">&amp;</span>&nbsp;<span class="num" id="1515217">1</span><span class="op" id="1515218">)</span>&nbsp;<span class="op" id="1515220">!=</span>&nbsp;<span class="num" id="1515223">0</span>&nbsp;<span class="op" id="1515225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515234">hash</span>&nbsp;<span class="op" id="1515239">|=</span>&nbsp;<span class="ident" id="1515242">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515255">}</span>&nbsp;<span class="keyword" id="1515257">else</span>&nbsp;<span class="op" id="1515262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515271">hash</span>&nbsp;<span class="op" id="1515276">&amp;^=</span>&nbsp;<span class="ident" id="1515280">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515301">top</span>&nbsp;<span class="op" id="1515305">=</span>&nbsp;<span class="builtintype" id="1515307">uint8</span><span class="op" id="1515312">(</span><span class="ident" id="1515313">hash</span>&nbsp;<span class="op" id="1515318">&gt;&gt;</span>&nbsp;<span class="op" id="1515321">(</span><span class="ident" id="1515322">ptrSize</span><span class="op" id="1515329">*</span><span class="num" id="1515330">8</span>&nbsp;<span class="op" id="1515332">-</span>&nbsp;<span class="num" id="1515334">8</span><span class="op" id="1515335">)</span><span class="op" id="1515336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515344">if</span>&nbsp;<span class="ident" id="1515347">top</span>&nbsp;<span class="op" id="1515351">&lt;</span>&nbsp;<span class="ident" id="1515353">minTopHash</span>&nbsp;<span class="op" id="1515364">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515373">top</span>&nbsp;<span class="op" id="1515377">+=</span>&nbsp;<span class="ident" id="1515380">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515416">if</span>&nbsp;<span class="op" id="1515419">(</span><span class="ident" id="1515420">hash</span>&nbsp;<span class="op" id="1515425">&amp;</span>&nbsp;<span class="ident" id="1515427">newbit</span><span class="op" id="1515433">)</span>&nbsp;<span class="op" id="1515435">==</span>&nbsp;<span class="num" id="1515438">0</span>&nbsp;<span class="op" id="1515440">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515447">b</span><span class="op" id="1515448">.</span><span class="ident" id="1515449">tophash</span><span class="op" id="1515456">[</span><span class="ident" id="1515457">i</span><span class="op" id="1515458">]</span>&nbsp;<span class="op" id="1515460">=</span>&nbsp;<span class="ident" id="1515462">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515478">if</span>&nbsp;<span class="ident" id="1515481">xi</span>&nbsp;<span class="op" id="1515484">==</span>&nbsp;<span class="ident" id="1515487">bucketCnt</span>&nbsp;<span class="op" id="1515497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515505">if</span>&nbsp;<span class="ident" id="1515508">checkgc</span>&nbsp;<span class="op" id="1515516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515525">memstats</span><span class="op" id="1515533">.</span><span class="ident" id="1515534">next_gc</span>&nbsp;<span class="op" id="1515542">=</span>&nbsp;<span class="ident" id="1515544">memstats</span><span class="op" id="1515552">.</span><span class="ident" id="1515553">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515570">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515578">newx</span>&nbsp;<span class="op" id="1515583">:=</span>&nbsp;<span class="op" id="1515586">(</span><span class="op" id="1515587">*</span><span class="ident" id="1515588">bmap</span><span class="op" id="1515592">)</span><span class="op" id="1515593">(</span><span class="ident" id="1515594">newobject</span><span class="op" id="1515603">(</span><span class="ident" id="1515604">t</span><span class="op" id="1515605">.</span><span class="ident" id="1515606">bucket</span><span class="op" id="1515612">)</span><span class="op" id="1515613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515621">x</span><span class="op" id="1515622">.</span><span class="ident" id="1515623">overflow</span>&nbsp;<span class="op" id="1515632">=</span>&nbsp;<span class="ident" id="1515634">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515645">x</span>&nbsp;<span class="op" id="1515647">=</span>&nbsp;<span class="ident" id="1515649">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515660">xi</span>&nbsp;<span class="op" id="1515663">=</span>&nbsp;<span class="num" id="1515665">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515673">xk</span>&nbsp;<span class="op" id="1515676">=</span>&nbsp;<span class="ident" id="1515678">add</span><span class="op" id="1515681">(</span><span class="ident" id="1515682">unsafe</span><span class="op" id="1515688">.</span><span class="ident" id="1515689">Pointer</span><span class="op" id="1515696">(</span><span class="ident" id="1515697">x</span><span class="op" id="1515698">)</span><span class="op" id="1515699">,</span>&nbsp;<span class="ident" id="1515701">dataOffset</span><span class="op" id="1515711">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515719">xv</span>&nbsp;<span class="op" id="1515722">=</span>&nbsp;<span class="ident" id="1515724">add</span><span class="op" id="1515727">(</span><span class="ident" id="1515728">xk</span><span class="op" id="1515730">,</span>&nbsp;<span class="ident" id="1515732">bucketCnt</span><span class="op" id="1515741">*</span><span class="builtintype" id="1515742">uintptr</span><span class="op" id="1515749">(</span><span class="ident" id="1515750">t</span><span class="op" id="1515751">.</span><span class="ident" id="1515752">keysize</span><span class="op" id="1515759">)</span><span class="op" id="1515760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515774">x</span><span class="op" id="1515775">.</span><span class="ident" id="1515776">tophash</span><span class="op" id="1515783">[</span><span class="ident" id="1515784">xi</span><span class="op" id="1515786">]</span>&nbsp;<span class="op" id="1515788">=</span>&nbsp;<span class="ident" id="1515790">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515799">if</span>&nbsp;<span class="ident" id="1515802">t</span><span class="op" id="1515803">.</span><span class="ident" id="1515804">indirectkey</span>&nbsp;<span class="op" id="1515816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515824">*</span><span class="op" id="1515825">(</span><span class="op" id="1515826">*</span><span class="ident" id="1515827">unsafe</span><span class="op" id="1515833">.</span><span class="ident" id="1515834">Pointer</span><span class="op" id="1515841">)</span><span class="op" id="1515842">(</span><span class="ident" id="1515843">xk</span><span class="op" id="1515845">)</span>&nbsp;<span class="op" id="1515847">=</span>&nbsp;<span class="ident" id="1515849">k2</span>&nbsp;<span class="comment" id="1515852">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515873">}</span>&nbsp;<span class="keyword" id="1515875">else</span>&nbsp;<span class="op" id="1515880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515888">memmove</span><span class="op" id="1515895">(</span><span class="ident" id="1515896">xk</span><span class="op" id="1515898">,</span>&nbsp;<span class="ident" id="1515900">k</span><span class="op" id="1515901">,</span>&nbsp;<span class="builtintype" id="1515903">uintptr</span><span class="op" id="1515910">(</span><span class="ident" id="1515911">t</span><span class="op" id="1515912">.</span><span class="ident" id="1515913">key</span><span class="op" id="1515916">.</span><span class="ident" id="1515917">size</span><span class="op" id="1515921">)</span><span class="op" id="1515922">)</span>&nbsp;<span class="comment" id="1515924">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515950">if</span>&nbsp;<span class="ident" id="1515953">t</span><span class="op" id="1515954">.</span><span class="ident" id="1515955">indirectvalue</span>&nbsp;<span class="op" id="1515969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515977">*</span><span class="op" id="1515978">(</span><span class="op" id="1515979">*</span><span class="ident" id="1515980">unsafe</span><span class="op" id="1515986">.</span><span class="ident" id="1515987">Pointer</span><span class="op" id="1515994">)</span><span class="op" id="1515995">(</span><span class="ident" id="1515996">xv</span><span class="op" id="1515998">)</span>&nbsp;<span class="op" id="1516000">=</span>&nbsp;<span class="op" id="1516002">*</span><span class="op" id="1516003">(</span><span class="op" id="1516004">*</span><span class="ident" id="1516005">unsafe</span><span class="op" id="1516011">.</span><span class="ident" id="1516012">Pointer</span><span class="op" id="1516019">)</span><span class="op" id="1516020">(</span><span class="ident" id="1516021">v</span><span class="op" id="1516022">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516029">}</span>&nbsp;<span class="keyword" id="1516031">else</span>&nbsp;<span class="op" id="1516036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516044">memmove</span><span class="op" id="1516051">(</span><span class="ident" id="1516052">xv</span><span class="op" id="1516054">,</span>&nbsp;<span class="ident" id="1516056">v</span><span class="op" id="1516057">,</span>&nbsp;<span class="builtintype" id="1516059">uintptr</span><span class="op" id="1516066">(</span><span class="ident" id="1516067">t</span><span class="op" id="1516068">.</span><span class="ident" id="1516069">elem</span><span class="op" id="1516073">.</span><span class="ident" id="1516074">size</span><span class="op" id="1516078">)</span><span class="op" id="1516079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516093">xi</span><span class="op" id="1516095">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516103">xk</span>&nbsp;<span class="op" id="1516106">=</span>&nbsp;<span class="ident" id="1516108">add</span><span class="op" id="1516111">(</span><span class="ident" id="1516112">xk</span><span class="op" id="1516114">,</span>&nbsp;<span class="builtintype" id="1516116">uintptr</span><span class="op" id="1516123">(</span><span class="ident" id="1516124">t</span><span class="op" id="1516125">.</span><span class="ident" id="1516126">keysize</span><span class="op" id="1516133">)</span><span class="op" id="1516134">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516141">xv</span>&nbsp;<span class="op" id="1516144">=</span>&nbsp;<span class="ident" id="1516146">add</span><span class="op" id="1516149">(</span><span class="ident" id="1516150">xv</span><span class="op" id="1516152">,</span>&nbsp;<span class="builtintype" id="1516154">uintptr</span><span class="op" id="1516161">(</span><span class="ident" id="1516162">t</span><span class="op" id="1516163">.</span><span class="ident" id="1516164">valuesize</span><span class="op" id="1516173">)</span><span class="op" id="1516174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516180">}</span>&nbsp;<span class="keyword" id="1516182">else</span>&nbsp;<span class="op" id="1516187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516194">b</span><span class="op" id="1516195">.</span><span class="ident" id="1516196">tophash</span><span class="op" id="1516203">[</span><span class="ident" id="1516204">i</span><span class="op" id="1516205">]</span>&nbsp;<span class="op" id="1516207">=</span>&nbsp;<span class="ident" id="1516209">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516225">if</span>&nbsp;<span class="ident" id="1516228">yi</span>&nbsp;<span class="op" id="1516231">==</span>&nbsp;<span class="ident" id="1516234">bucketCnt</span>&nbsp;<span class="op" id="1516244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516252">if</span>&nbsp;<span class="ident" id="1516255">checkgc</span>&nbsp;<span class="op" id="1516263">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516272">memstats</span><span class="op" id="1516280">.</span><span class="ident" id="1516281">next_gc</span>&nbsp;<span class="op" id="1516289">=</span>&nbsp;<span class="ident" id="1516291">memstats</span><span class="op" id="1516299">.</span><span class="ident" id="1516300">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516325">newy</span>&nbsp;<span class="op" id="1516330">:=</span>&nbsp;<span class="op" id="1516333">(</span><span class="op" id="1516334">*</span><span class="ident" id="1516335">bmap</span><span class="op" id="1516339">)</span><span class="op" id="1516340">(</span><span class="ident" id="1516341">newobject</span><span class="op" id="1516350">(</span><span class="ident" id="1516351">t</span><span class="op" id="1516352">.</span><span class="ident" id="1516353">bucket</span><span class="op" id="1516359">)</span><span class="op" id="1516360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516368">y</span><span class="op" id="1516369">.</span><span class="ident" id="1516370">overflow</span>&nbsp;<span class="op" id="1516379">=</span>&nbsp;<span class="ident" id="1516381">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516392">y</span>&nbsp;<span class="op" id="1516394">=</span>&nbsp;<span class="ident" id="1516396">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516407">yi</span>&nbsp;<span class="op" id="1516410">=</span>&nbsp;<span class="num" id="1516412">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516420">yk</span>&nbsp;<span class="op" id="1516423">=</span>&nbsp;<span class="ident" id="1516425">add</span><span class="op" id="1516428">(</span><span class="ident" id="1516429">unsafe</span><span class="op" id="1516435">.</span><span class="ident" id="1516436">Pointer</span><span class="op" id="1516443">(</span><span class="ident" id="1516444">y</span><span class="op" id="1516445">)</span><span class="op" id="1516446">,</span>&nbsp;<span class="ident" id="1516448">dataOffset</span><span class="op" id="1516458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516466">yv</span>&nbsp;<span class="op" id="1516469">=</span>&nbsp;<span class="ident" id="1516471">add</span><span class="op" id="1516474">(</span><span class="ident" id="1516475">yk</span><span class="op" id="1516477">,</span>&nbsp;<span class="ident" id="1516479">bucketCnt</span><span class="op" id="1516488">*</span><span class="builtintype" id="1516489">uintptr</span><span class="op" id="1516496">(</span><span class="ident" id="1516497">t</span><span class="op" id="1516498">.</span><span class="ident" id="1516499">keysize</span><span class="op" id="1516506">)</span><span class="op" id="1516507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516521">y</span><span class="op" id="1516522">.</span><span class="ident" id="1516523">tophash</span><span class="op" id="1516530">[</span><span class="ident" id="1516531">yi</span><span class="op" id="1516533">]</span>&nbsp;<span class="op" id="1516535">=</span>&nbsp;<span class="ident" id="1516537">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516546">if</span>&nbsp;<span class="ident" id="1516549">t</span><span class="op" id="1516550">.</span><span class="ident" id="1516551">indirectkey</span>&nbsp;<span class="op" id="1516563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516571">*</span><span class="op" id="1516572">(</span><span class="op" id="1516573">*</span><span class="ident" id="1516574">unsafe</span><span class="op" id="1516580">.</span><span class="ident" id="1516581">Pointer</span><span class="op" id="1516588">)</span><span class="op" id="1516589">(</span><span class="ident" id="1516590">yk</span><span class="op" id="1516592">)</span>&nbsp;<span class="op" id="1516594">=</span>&nbsp;<span class="ident" id="1516596">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516604">}</span>&nbsp;<span class="keyword" id="1516606">else</span>&nbsp;<span class="op" id="1516611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516619">memmove</span><span class="op" id="1516626">(</span><span class="ident" id="1516627">yk</span><span class="op" id="1516629">,</span>&nbsp;<span class="ident" id="1516631">k</span><span class="op" id="1516632">,</span>&nbsp;<span class="builtintype" id="1516634">uintptr</span><span class="op" id="1516641">(</span><span class="ident" id="1516642">t</span><span class="op" id="1516643">.</span><span class="ident" id="1516644">key</span><span class="op" id="1516647">.</span><span class="ident" id="1516648">size</span><span class="op" id="1516652">)</span><span class="op" id="1516653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516660">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516667">if</span>&nbsp;<span class="ident" id="1516670">t</span><span class="op" id="1516671">.</span><span class="ident" id="1516672">indirectvalue</span>&nbsp;<span class="op" id="1516686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516694">*</span><span class="op" id="1516695">(</span><span class="op" id="1516696">*</span><span class="ident" id="1516697">unsafe</span><span class="op" id="1516703">.</span><span class="ident" id="1516704">Pointer</span><span class="op" id="1516711">)</span><span class="op" id="1516712">(</span><span class="ident" id="1516713">yv</span><span class="op" id="1516715">)</span>&nbsp;<span class="op" id="1516717">=</span>&nbsp;<span class="op" id="1516719">*</span><span class="op" id="1516720">(</span><span class="op" id="1516721">*</span><span class="ident" id="1516722">unsafe</span><span class="op" id="1516728">.</span><span class="ident" id="1516729">Pointer</span><span class="op" id="1516736">)</span><span class="op" id="1516737">(</span><span class="ident" id="1516738">v</span><span class="op" id="1516739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516746">}</span>&nbsp;<span class="keyword" id="1516748">else</span>&nbsp;<span class="op" id="1516753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516761">memmove</span><span class="op" id="1516768">(</span><span class="ident" id="1516769">yv</span><span class="op" id="1516771">,</span>&nbsp;<span class="ident" id="1516773">v</span><span class="op" id="1516774">,</span>&nbsp;<span class="builtintype" id="1516776">uintptr</span><span class="op" id="1516783">(</span><span class="ident" id="1516784">t</span><span class="op" id="1516785">.</span><span class="ident" id="1516786">elem</span><span class="op" id="1516790">.</span><span class="ident" id="1516791">size</span><span class="op" id="1516795">)</span><span class="op" id="1516796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516803">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516810">yi</span><span class="op" id="1516812">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516820">yk</span>&nbsp;<span class="op" id="1516823">=</span>&nbsp;<span class="ident" id="1516825">add</span><span class="op" id="1516828">(</span><span class="ident" id="1516829">yk</span><span class="op" id="1516831">,</span>&nbsp;<span class="builtintype" id="1516833">uintptr</span><span class="op" id="1516840">(</span><span class="ident" id="1516841">t</span><span class="op" id="1516842">.</span><span class="ident" id="1516843">keysize</span><span class="op" id="1516850">)</span><span class="op" id="1516851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516858">yv</span>&nbsp;<span class="op" id="1516861">=</span>&nbsp;<span class="ident" id="1516863">add</span><span class="op" id="1516866">(</span><span class="ident" id="1516867">yv</span><span class="op" id="1516869">,</span>&nbsp;<span class="builtintype" id="1516871">uintptr</span><span class="op" id="1516878">(</span><span class="ident" id="1516879">t</span><span class="op" id="1516880">.</span><span class="ident" id="1516881">valuesize</span><span class="op" id="1516890">)</span><span class="op" id="1516891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516902">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516910">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516973">if</span>&nbsp;<span class="ident" id="1516976">h</span><span class="op" id="1516977">.</span><span class="ident" id="1516978">flags</span><span class="op" id="1516983">&amp;</span><span class="ident" id="1516984">oldIterator</span>&nbsp;<span class="op" id="1516996">==</span>&nbsp;<span class="num" id="1516999">0</span>&nbsp;<span class="op" id="1517001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517006">b</span>&nbsp;<span class="op" id="1517008">=</span>&nbsp;<span class="op" id="1517010">(</span><span class="op" id="1517011">*</span><span class="ident" id="1517012">bmap</span><span class="op" id="1517016">)</span><span class="op" id="1517017">(</span><span class="ident" id="1517018">add</span><span class="op" id="1517021">(</span><span class="ident" id="1517022">h</span><span class="op" id="1517023">.</span><span class="ident" id="1517024">oldbuckets</span><span class="op" id="1517034">,</span>&nbsp;<span class="ident" id="1517036">oldbucket</span><span class="op" id="1517045">*</span><span class="builtintype" id="1517046">uintptr</span><span class="op" id="1517053">(</span><span class="ident" id="1517054">t</span><span class="op" id="1517055">.</span><span class="ident" id="1517056">bucketsize</span><span class="op" id="1517066">)</span><span class="op" id="1517067">)</span><span class="op" id="1517068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517073">b</span><span class="op" id="1517074">.</span><span class="ident" id="1517075">overflow</span>&nbsp;<span class="op" id="1517084">=</span>&nbsp;<span class="ident" id="1517086">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517093">memclr</span><span class="op" id="1517099">(</span><span class="ident" id="1517100">add</span><span class="op" id="1517103">(</span><span class="ident" id="1517104">unsafe</span><span class="op" id="1517110">.</span><span class="ident" id="1517111">Pointer</span><span class="op" id="1517118">(</span><span class="ident" id="1517119">b</span><span class="op" id="1517120">)</span><span class="op" id="1517121">,</span>&nbsp;<span class="ident" id="1517123">dataOffset</span><span class="op" id="1517133">)</span><span class="op" id="1517134">,</span>&nbsp;<span class="builtintype" id="1517136">uintptr</span><span class="op" id="1517143">(</span><span class="ident" id="1517144">t</span><span class="op" id="1517145">.</span><span class="ident" id="1517146">bucketsize</span><span class="op" id="1517156">)</span><span class="op" id="1517157">-</span><span class="ident" id="1517158">dataOffset</span><span class="op" id="1517168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517179">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517207">if</span>&nbsp;<span class="ident" id="1517210">oldbucket</span>&nbsp;<span class="op" id="1517220">==</span>&nbsp;<span class="ident" id="1517223">h</span><span class="op" id="1517224">.</span><span class="ident" id="1517225">nevacuate</span>&nbsp;<span class="op" id="1517235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517239">h</span><span class="op" id="1517240">.</span><span class="ident" id="1517241">nevacuate</span>&nbsp;<span class="op" id="1517251">=</span>&nbsp;<span class="ident" id="1517253">oldbucket</span>&nbsp;<span class="op" id="1517263">+</span>&nbsp;<span class="num" id="1517265">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517269">if</span>&nbsp;<span class="ident" id="1517272">oldbucket</span><span class="op" id="1517281">+</span><span class="num" id="1517282">1</span>&nbsp;<span class="op" id="1517284">==</span>&nbsp;<span class="ident" id="1517287">newbit</span>&nbsp;<span class="op" id="1517294">{</span>&nbsp;<span class="comment" id="1517296">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517328">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517384">h</span><span class="op" id="1517385">.</span><span class="ident" id="1517386">oldbuckets</span>&nbsp;<span class="op" id="1517397">=</span>&nbsp;<span class="ident" id="1517399">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517408">}</span><br>
<span class="lineno"></span><span class="op" id="1517410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1517413">func</span>&nbsp;<span class="ident" id="1517418">ismapkey</span><span class="op" id="1517426">(</span><span class="ident" id="1517427">t</span>&nbsp;<span class="op" id="1517429">*</span><span class="ident" id="1517430">_type</span><span class="op" id="1517435">)</span>&nbsp;<span class="builtintype" id="1517437">bool</span>&nbsp;<span class="op" id="1517442">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517445">return</span>&nbsp;<span class="ident" id="1517452">goalg</span><span class="op" id="1517457">(</span><span class="ident" id="1517458">t</span><span class="op" id="1517459">.</span><span class="ident" id="1517460">alg</span><span class="op" id="1517463">)</span><span class="op" id="1517464">.</span><span class="ident" id="1517465">hash</span>&nbsp;<span class="op" id="1517470">!=</span>&nbsp;<span class="ident" id="1517473">nil</span><br>
<span class="lineno"></span><span class="op" id="1517477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1517480">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1517531">func</span>&nbsp;<span class="ident" id="1517536">reflect_makemap</span><span class="op" id="1517551">(</span><span class="ident" id="1517552">t</span>&nbsp;<span class="op" id="1517554">*</span><span class="ident" id="1517555">maptype</span><span class="op" id="1517562">)</span>&nbsp;<span class="op" id="1517564">*</span><span class="ident" id="1517565">hmap</span>&nbsp;<span class="op" id="1517570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517573">return</span>&nbsp;<span class="ident" id="1517580">makemap</span><span class="op" id="1517587">(</span><span class="ident" id="1517588">t</span><span class="op" id="1517589">,</span>&nbsp;<span class="num" id="1517591">0</span><span class="op" id="1517592">)</span><br>
<span class="lineno"></span><span class="op" id="1517594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1517597">func</span>&nbsp;<span class="ident" id="1517602">reflect_mapaccess</span><span class="op" id="1517619">(</span><span class="ident" id="1517620">t</span>&nbsp;<span class="op" id="1517622">*</span><span class="ident" id="1517623">maptype</span><span class="op" id="1517630">,</span>&nbsp;<span class="ident" id="1517632">h</span>&nbsp;<span class="op" id="1517634">*</span><span class="ident" id="1517635">hmap</span><span class="op" id="1517639">,</span>&nbsp;<span class="ident" id="1517641">key</span>&nbsp;<span class="ident" id="1517645">unsafe</span><span class="op" id="1517651">.</span><span class="ident" id="1517652">Pointer</span><span class="op" id="1517659">)</span>&nbsp;<span class="ident" id="1517661">unsafe</span><span class="op" id="1517667">.</span><span class="ident" id="1517668">Pointer</span>&nbsp;<span class="op" id="1517676">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517679">val</span><span class="op" id="1517682">,</span>&nbsp;<span class="ident" id="1517684">ok</span>&nbsp;<span class="op" id="1517687">:=</span>&nbsp;<span class="ident" id="1517690">mapaccess2</span><span class="op" id="1517700">(</span><span class="ident" id="1517701">t</span><span class="op" id="1517702">,</span>&nbsp;<span class="ident" id="1517704">h</span><span class="op" id="1517705">,</span>&nbsp;<span class="ident" id="1517707">key</span><span class="op" id="1517710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517713">if</span>&nbsp;<span class="op" id="1517716">!</span><span class="ident" id="1517717">ok</span>&nbsp;<span class="op" id="1517720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1517724">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517769">val</span>&nbsp;<span class="op" id="1517773">=</span>&nbsp;<span class="ident" id="1517775">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517780">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517783">return</span>&nbsp;<span class="ident" id="1517790">val</span><br>
<span class="lineno"></span><span class="op" id="1517794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1517797">func</span>&nbsp;<span class="ident" id="1517802">reflect_mapassign</span><span class="op" id="1517819">(</span><span class="ident" id="1517820">t</span>&nbsp;<span class="op" id="1517822">*</span><span class="ident" id="1517823">maptype</span><span class="op" id="1517830">,</span>&nbsp;<span class="ident" id="1517832">h</span>&nbsp;<span class="op" id="1517834">*</span><span class="ident" id="1517835">hmap</span><span class="op" id="1517839">,</span>&nbsp;<span class="ident" id="1517841">key</span>&nbsp;<span class="ident" id="1517845">unsafe</span><span class="op" id="1517851">.</span><span class="ident" id="1517852">Pointer</span><span class="op" id="1517859">,</span>&nbsp;<span class="ident" id="1517861">val</span>&nbsp;<span class="ident" id="1517865">unsafe</span><span class="op" id="1517871">.</span><span class="ident" id="1517872">Pointer</span><span class="op" id="1517879">)</span>&nbsp;<span class="op" id="1517881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517884">mapassign1</span><span class="op" id="1517894">(</span><span class="ident" id="1517895">t</span><span class="op" id="1517896">,</span>&nbsp;<span class="ident" id="1517898">h</span><span class="op" id="1517899">,</span>&nbsp;<span class="ident" id="1517901">key</span><span class="op" id="1517904">,</span>&nbsp;<span class="ident" id="1517906">val</span><span class="op" id="1517909">)</span><br>
<span class="lineno">920</span><span class="op" id="1517911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1517914">func</span>&nbsp;<span class="ident" id="1517919">reflect_mapdelete</span><span class="op" id="1517936">(</span><span class="ident" id="1517937">t</span>&nbsp;<span class="op" id="1517939">*</span><span class="ident" id="1517940">maptype</span><span class="op" id="1517947">,</span>&nbsp;<span class="ident" id="1517949">h</span>&nbsp;<span class="op" id="1517951">*</span><span class="ident" id="1517952">hmap</span><span class="op" id="1517956">,</span>&nbsp;<span class="ident" id="1517958">key</span>&nbsp;<span class="ident" id="1517962">unsafe</span><span class="op" id="1517968">.</span><span class="ident" id="1517969">Pointer</span><span class="op" id="1517976">)</span>&nbsp;<span class="op" id="1517978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517981">mapdelete</span><span class="op" id="1517990">(</span><span class="ident" id="1517991">t</span><span class="op" id="1517992">,</span>&nbsp;<span class="ident" id="1517994">h</span><span class="op" id="1517995">,</span>&nbsp;<span class="ident" id="1517997">key</span><span class="op" id="1518000">)</span><br>
<span class="lineno"></span><span class="op" id="1518002">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1518005">func</span>&nbsp;<span class="ident" id="1518010">reflect_mapiterinit</span><span class="op" id="1518029">(</span><span class="ident" id="1518030">t</span>&nbsp;<span class="op" id="1518032">*</span><span class="ident" id="1518033">maptype</span><span class="op" id="1518040">,</span>&nbsp;<span class="ident" id="1518042">h</span>&nbsp;<span class="op" id="1518044">*</span><span class="ident" id="1518045">hmap</span><span class="op" id="1518049">)</span>&nbsp;<span class="op" id="1518051">*</span><span class="ident" id="1518052">hiter</span>&nbsp;<span class="op" id="1518058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518061">it</span>&nbsp;<span class="op" id="1518064">:=</span>&nbsp;<span class="builtinfunc" id="1518067">new</span><span class="op" id="1518070">(</span><span class="ident" id="1518071">hiter</span><span class="op" id="1518076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518079">mapiterinit</span><span class="op" id="1518090">(</span><span class="ident" id="1518091">t</span><span class="op" id="1518092">,</span>&nbsp;<span class="ident" id="1518094">h</span><span class="op" id="1518095">,</span>&nbsp;<span class="ident" id="1518097">it</span><span class="op" id="1518099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518102">return</span>&nbsp;<span class="ident" id="1518109">it</span><br>
<span class="lineno">930</span><span class="op" id="1518112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1518115">func</span>&nbsp;<span class="ident" id="1518120">reflect_mapiternext</span><span class="op" id="1518139">(</span><span class="ident" id="1518140">it</span>&nbsp;<span class="op" id="1518143">*</span><span class="ident" id="1518144">hiter</span><span class="op" id="1518149">)</span>&nbsp;<span class="op" id="1518151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518154">mapiternext</span><span class="op" id="1518165">(</span><span class="ident" id="1518166">it</span><span class="op" id="1518168">)</span><br>
<span class="lineno"></span><span class="op" id="1518170">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1518173">func</span>&nbsp;<span class="ident" id="1518178">reflect_mapiterkey</span><span class="op" id="1518196">(</span><span class="ident" id="1518197">it</span>&nbsp;<span class="op" id="1518200">*</span><span class="ident" id="1518201">hiter</span><span class="op" id="1518206">)</span>&nbsp;<span class="ident" id="1518208">unsafe</span><span class="op" id="1518214">.</span><span class="ident" id="1518215">Pointer</span>&nbsp;<span class="op" id="1518223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518226">return</span>&nbsp;<span class="ident" id="1518233">it</span><span class="op" id="1518235">.</span><span class="ident" id="1518236">key</span><br>
<span class="lineno"></span><span class="op" id="1518240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1518243">func</span>&nbsp;<span class="ident" id="1518248">reflect_maplen</span><span class="op" id="1518262">(</span><span class="ident" id="1518263">h</span>&nbsp;<span class="op" id="1518265">*</span><span class="ident" id="1518266">hmap</span><span class="op" id="1518270">)</span>&nbsp;<span class="builtintype" id="1518272">int</span>&nbsp;<span class="op" id="1518276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518279">if</span>&nbsp;<span class="ident" id="1518282">h</span>&nbsp;<span class="op" id="1518284">==</span>&nbsp;<span class="ident" id="1518287">nil</span>&nbsp;<span class="op" id="1518291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518295">return</span>&nbsp;<span class="num" id="1518302">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518308">if</span>&nbsp;<span class="ident" id="1518311">raceenabled</span>&nbsp;<span class="op" id="1518323">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518327">callerpc</span>&nbsp;<span class="op" id="1518336">:=</span>&nbsp;<span class="ident" id="1518339">getcallerpc</span><span class="op" id="1518350">(</span><span class="ident" id="1518351">unsafe</span><span class="op" id="1518357">.</span><span class="ident" id="1518358">Pointer</span><span class="op" id="1518365">(</span><span class="op" id="1518366">&amp;</span><span class="ident" id="1518367">h</span><span class="op" id="1518368">)</span><span class="op" id="1518369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518373">racereadpc</span><span class="op" id="1518383">(</span><span class="ident" id="1518384">unsafe</span><span class="op" id="1518390">.</span><span class="ident" id="1518391">Pointer</span><span class="op" id="1518398">(</span><span class="ident" id="1518399">h</span><span class="op" id="1518400">)</span><span class="op" id="1518401">,</span>&nbsp;<span class="ident" id="1518403">callerpc</span><span class="op" id="1518411">,</span>&nbsp;<span class="ident" id="1518413">funcPC</span><span class="op" id="1518419">(</span><span class="ident" id="1518420">reflect_maplen</span><span class="op" id="1518434">)</span><span class="op" id="1518435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518441">return</span>&nbsp;<span class="ident" id="1518448">h</span><span class="op" id="1518449">.</span><span class="ident" id="1518450">count</span><br>
<span class="lineno"></span><span class="op" id="1518456">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1518459">func</span>&nbsp;<span class="ident" id="1518464">reflect_ismapkey</span><span class="op" id="1518480">(</span><span class="ident" id="1518481">t</span>&nbsp;<span class="op" id="1518483">*</span><span class="ident" id="1518484">_type</span><span class="op" id="1518489">)</span>&nbsp;<span class="builtintype" id="1518491">bool</span>&nbsp;<span class="op" id="1518496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518499">return</span>&nbsp;<span class="ident" id="1518506">ismapkey</span><span class="op" id="1518514">(</span><span class="ident" id="1518515">t</span><span class="op" id="1518516">)</span><br>
<span class="lineno"></span><span class="op" id="1518518">}</span>
</div>
</body>
</html>
