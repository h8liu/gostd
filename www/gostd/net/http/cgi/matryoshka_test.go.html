<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7335395">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7335450">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7335504">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7335555">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7335618">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7335682">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7335739">package</span>&nbsp;<span class="ident" id="7335747">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7335752">import</span>&nbsp;<span class="op" id="7335759">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335762">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335771">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335781">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335788">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335794">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335806">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335827">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335833">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335844">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335855">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7335862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7335865">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7335935">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7335999">func</span>&nbsp;<span class="ident" id="7336004">TestHostingOurselves</span><span class="op" id="7336024">(</span><span class="ident" id="7336025">t</span>&nbsp;<span class="op" id="7336027">*</span><span class="ident" id="7336028">testing</span><span class="op" id="7336035">.</span><span class="ident" id="7336036">T</span><span class="op" id="7336037">)</span>&nbsp;<span class="op" id="7336039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7336042">if</span>&nbsp;<span class="ident" id="7336045">runtime</span><span class="op" id="7336052">.</span><span class="ident" id="7336053">GOOS</span>&nbsp;<span class="op" id="7336058">==</span>&nbsp;<span class="string" id="7336061">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7336068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336072">t</span><span class="op" id="7336073">.</span><span class="ident" id="7336074">Skip</span><span class="op" id="7336078">(</span><span class="string" id="7336079">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7336097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7336100">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336104">h</span>&nbsp;<span class="op" id="7336106">:=</span>&nbsp;<span class="op" id="7336109">&amp;</span><span class="ident" id="7336110">Handler</span><span class="op" id="7336117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336121">Path</span><span class="op" id="7336125">:</span>&nbsp;<span class="ident" id="7336127">os</span><span class="op" id="7336129">.</span><span class="ident" id="7336130">Args</span><span class="op" id="7336134">[</span><span class="num" id="7336135">0</span><span class="op" id="7336136">]</span><span class="op" id="7336137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336141">Root</span><span class="op" id="7336145">:</span>&nbsp;<span class="string" id="7336147">&#34;/test.go&#34;</span><span class="op" id="7336157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336161">Args</span><span class="op" id="7336165">:</span>&nbsp;<span class="op" id="7336167">[</span><span class="op" id="7336168">]</span><span class="builtintype" id="7336169">string</span><span class="op" id="7336175">{</span><span class="string" id="7336176">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7336209">}</span><span class="op" id="7336210">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7336213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336216">expectedMap</span>&nbsp;<span class="op" id="7336228">:=</span>&nbsp;<span class="keyword" id="7336231">map</span><span class="op" id="7336234">[</span><span class="builtintype" id="7336235">string</span><span class="op" id="7336241">]</span><span class="builtintype" id="7336242">string</span><span class="op" id="7336248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336252">&#34;test&#34;</span><span class="op" id="7336258">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336277">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7336295">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336299">&#34;param-a&#34;</span><span class="op" id="7336308">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336324">&#34;b&#34;</span><span class="op" id="7336327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336331">&#34;param-foo&#34;</span><span class="op" id="7336342">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336356">&#34;bar&#34;</span><span class="op" id="7336361">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336365">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7336388">:</span>&nbsp;<span class="string" id="7336390">&#34;CGI/1.1&#34;</span><span class="op" id="7336399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336403">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7336418">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336428">&#34;example.com&#34;</span><span class="op" id="7336441">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336445">&#34;env-PATH_INFO&#34;</span><span class="op" id="7336460">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336470">&#34;&#34;</span><span class="op" id="7336472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336476">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7336494">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336501">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7336514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336518">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7336535">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336543">&#34;1.2.3.4&#34;</span><span class="op" id="7336552">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336556">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7336573">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336581">&#34;1.2.3.4&#34;</span><span class="op" id="7336590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336594">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7336614">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336619">&#34;GET&#34;</span><span class="op" id="7336624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336628">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7336645">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336653">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7336675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336679">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7336700">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7336704">os</span><span class="op" id="7336706">.</span><span class="ident" id="7336707">Args</span><span class="op" id="7336711">[</span><span class="num" id="7336712">0</span><span class="op" id="7336713">]</span><span class="op" id="7336714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336718">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7336735">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336743">&#34;/test.go&#34;</span><span class="op" id="7336753">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336757">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7336774">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336782">&#34;example.com&#34;</span><span class="op" id="7336795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336799">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7336816">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336824">&#34;80&#34;</span><span class="op" id="7336828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7336832">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7336853">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7336857">&#34;go&#34;</span><span class="op" id="7336861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7336864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7336867">replay</span>&nbsp;<span class="op" id="7336874">:=</span>&nbsp;<span class="ident" id="7336877">runCgiTest</span><span class="op" id="7336887">(</span><span class="ident" id="7336888">t</span><span class="op" id="7336889">,</span>&nbsp;<span class="ident" id="7336891">h</span><span class="op" id="7336892">,</span>&nbsp;<span class="string" id="7336894">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7336952">,</span>&nbsp;<span class="ident" id="7336954">expectedMap</span><span class="op" id="7336965">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7336969">if</span>&nbsp;<span class="ident" id="7336972">expected</span><span class="op" id="7336980">,</span>&nbsp;<span class="ident" id="7336982">got</span>&nbsp;<span class="op" id="7336986">:=</span>&nbsp;<span class="string" id="7336989">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7337015">,</span>&nbsp;<span class="ident" id="7337017">replay</span><span class="op" id="7337023">.</span><span class="ident" id="7337024">Header</span><span class="op" id="7337030">(</span><span class="op" id="7337031">)</span><span class="op" id="7337032">.</span><span class="ident" id="7337033">Get</span><span class="op" id="7337036">(</span><span class="string" id="7337037">&#34;Content-Type&#34;</span><span class="op" id="7337051">)</span><span class="op" id="7337052">;</span>&nbsp;<span class="ident" id="7337054">got</span>&nbsp;<span class="op" id="7337058">!=</span>&nbsp;<span class="ident" id="7337061">expected</span>&nbsp;<span class="op" id="7337070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337074">t</span><span class="op" id="7337075">.</span><span class="ident" id="7337076">Errorf</span><span class="op" id="7337082">(</span><span class="string" id="7337083">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7337122">,</span>&nbsp;<span class="ident" id="7337124">got</span><span class="op" id="7337127">,</span>&nbsp;<span class="ident" id="7337129">expected</span><span class="op" id="7337137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337143">if</span>&nbsp;<span class="ident" id="7337146">expected</span><span class="op" id="7337154">,</span>&nbsp;<span class="ident" id="7337156">got</span>&nbsp;<span class="op" id="7337160">:=</span>&nbsp;<span class="string" id="7337163">&#34;X-Test-Value&#34;</span><span class="op" id="7337177">,</span>&nbsp;<span class="ident" id="7337179">replay</span><span class="op" id="7337185">.</span><span class="ident" id="7337186">Header</span><span class="op" id="7337192">(</span><span class="op" id="7337193">)</span><span class="op" id="7337194">.</span><span class="ident" id="7337195">Get</span><span class="op" id="7337198">(</span><span class="string" id="7337199">&#34;X-Test-Header&#34;</span><span class="op" id="7337214">)</span><span class="op" id="7337215">;</span>&nbsp;<span class="ident" id="7337217">got</span>&nbsp;<span class="op" id="7337221">!=</span>&nbsp;<span class="ident" id="7337224">expected</span>&nbsp;<span class="op" id="7337233">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337237">t</span><span class="op" id="7337238">.</span><span class="ident" id="7337239">Errorf</span><span class="op" id="7337245">(</span><span class="string" id="7337246">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7337286">,</span>&nbsp;<span class="ident" id="7337288">got</span><span class="op" id="7337291">,</span>&nbsp;<span class="ident" id="7337293">expected</span><span class="op" id="7337301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337304">}</span><br>
<span class="lineno"></span><span class="op" id="7337306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7337309">type</span>&nbsp;<span class="ident" id="7337314">customWriterRecorder</span>&nbsp;<span class="keyword" id="7337335">struct</span>&nbsp;<span class="op" id="7337342">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337345">w</span>&nbsp;<span class="ident" id="7337347">io</span><span class="op" id="7337349">.</span><span class="ident" id="7337350">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337358">*</span><span class="ident" id="7337359">httptest</span><span class="op" id="7337367">.</span><span class="ident" id="7337368">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7337385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7337388">func</span>&nbsp;<span class="op" id="7337393">(</span><span class="ident" id="7337394">r</span>&nbsp;<span class="op" id="7337396">*</span><span class="ident" id="7337397">customWriterRecorder</span><span class="op" id="7337417">)</span>&nbsp;<span class="ident" id="7337419">Write</span><span class="op" id="7337424">(</span><span class="ident" id="7337425">p</span>&nbsp;<span class="op" id="7337427">[</span><span class="op" id="7337428">]</span><span class="builtintype" id="7337429">byte</span><span class="op" id="7337433">)</span>&nbsp;<span class="op" id="7337435">(</span><span class="ident" id="7337436">n</span>&nbsp;<span class="builtintype" id="7337438">int</span><span class="op" id="7337441">,</span>&nbsp;<span class="ident" id="7337443">err</span>&nbsp;<span class="builtintype" id="7337447">error</span><span class="op" id="7337452">)</span>&nbsp;<span class="op" id="7337454">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337457">return</span>&nbsp;<span class="ident" id="7337464">r</span><span class="op" id="7337465">.</span><span class="ident" id="7337466">w</span><span class="op" id="7337467">.</span><span class="ident" id="7337468">Write</span><span class="op" id="7337473">(</span><span class="ident" id="7337474">p</span><span class="op" id="7337475">)</span><br>
<span class="lineno"></span><span class="op" id="7337477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7337480">type</span>&nbsp;<span class="ident" id="7337485">limitWriter</span>&nbsp;<span class="keyword" id="7337497">struct</span>&nbsp;<span class="op" id="7337504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337507">w</span>&nbsp;<span class="ident" id="7337509">io</span><span class="op" id="7337511">.</span><span class="ident" id="7337512">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337520">n</span>&nbsp;<span class="builtintype" id="7337522">int</span><br>
<span class="lineno"></span><span class="op" id="7337526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7337529">func</span>&nbsp;<span class="op" id="7337534">(</span><span class="ident" id="7337535">w</span>&nbsp;<span class="op" id="7337537">*</span><span class="ident" id="7337538">limitWriter</span><span class="op" id="7337549">)</span>&nbsp;<span class="ident" id="7337551">Write</span><span class="op" id="7337556">(</span><span class="ident" id="7337557">p</span>&nbsp;<span class="op" id="7337559">[</span><span class="op" id="7337560">]</span><span class="builtintype" id="7337561">byte</span><span class="op" id="7337565">)</span>&nbsp;<span class="op" id="7337567">(</span><span class="ident" id="7337568">n</span>&nbsp;<span class="builtintype" id="7337570">int</span><span class="op" id="7337573">,</span>&nbsp;<span class="ident" id="7337575">err</span>&nbsp;<span class="builtintype" id="7337579">error</span><span class="op" id="7337584">)</span>&nbsp;<span class="op" id="7337586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337589">if</span>&nbsp;<span class="builtinfunc" id="7337592">len</span><span class="op" id="7337595">(</span><span class="ident" id="7337596">p</span><span class="op" id="7337597">)</span>&nbsp;<span class="op" id="7337599">&gt;</span>&nbsp;<span class="ident" id="7337601">w</span><span class="op" id="7337602">.</span><span class="ident" id="7337603">n</span>&nbsp;<span class="op" id="7337605">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337609">p</span>&nbsp;<span class="op" id="7337611">=</span>&nbsp;<span class="ident" id="7337613">p</span><span class="op" id="7337614">[</span><span class="op" id="7337615">:</span><span class="ident" id="7337616">w</span><span class="op" id="7337617">.</span><span class="ident" id="7337618">n</span><span class="op" id="7337619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337625">if</span>&nbsp;<span class="builtinfunc" id="7337628">len</span><span class="op" id="7337631">(</span><span class="ident" id="7337632">p</span><span class="op" id="7337633">)</span>&nbsp;<span class="op" id="7337635">&gt;</span>&nbsp;<span class="num" id="7337637">0</span>&nbsp;<span class="op" id="7337639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337643">n</span><span class="op" id="7337644">,</span>&nbsp;<span class="ident" id="7337646">err</span>&nbsp;<span class="op" id="7337650">=</span>&nbsp;<span class="ident" id="7337652">w</span><span class="op" id="7337653">.</span><span class="ident" id="7337654">w</span><span class="op" id="7337655">.</span><span class="ident" id="7337656">Write</span><span class="op" id="7337661">(</span><span class="ident" id="7337662">p</span><span class="op" id="7337663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337667">w</span><span class="op" id="7337668">.</span><span class="ident" id="7337669">n</span>&nbsp;<span class="op" id="7337671">-=</span>&nbsp;<span class="ident" id="7337674">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337680">if</span>&nbsp;<span class="ident" id="7337683">w</span><span class="op" id="7337684">.</span><span class="ident" id="7337685">n</span>&nbsp;<span class="op" id="7337687">==</span>&nbsp;<span class="num" id="7337690">0</span>&nbsp;<span class="op" id="7337692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337696">err</span>&nbsp;<span class="op" id="7337700">=</span>&nbsp;<span class="ident" id="7337702">errors</span><span class="op" id="7337708">.</span><span class="ident" id="7337709">New</span><span class="op" id="7337712">(</span><span class="string" id="7337713">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7337731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337737">return</span><br>
<span class="lineno">90</span><span class="op" id="7337744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7337747">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7337817">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7337844">func</span>&nbsp;<span class="ident" id="7337849">TestKillChildAfterCopyError</span><span class="op" id="7337876">(</span><span class="ident" id="7337877">t</span>&nbsp;<span class="op" id="7337879">*</span><span class="ident" id="7337880">testing</span><span class="op" id="7337887">.</span><span class="ident" id="7337888">T</span><span class="op" id="7337889">)</span>&nbsp;<span class="op" id="7337891">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337894">if</span>&nbsp;<span class="ident" id="7337897">runtime</span><span class="op" id="7337904">.</span><span class="ident" id="7337905">GOOS</span>&nbsp;<span class="op" id="7337910">==</span>&nbsp;<span class="string" id="7337913">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7337920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7337924">t</span><span class="op" id="7337925">.</span><span class="ident" id="7337926">Skip</span><span class="op" id="7337930">(</span><span class="string" id="7337931">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7337949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7337952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7337956">defer</span>&nbsp;<span class="keyword" id="7337962">func</span><span class="op" id="7337966">(</span><span class="op" id="7337967">)</span>&nbsp;<span class="op" id="7337969">{</span>&nbsp;<span class="ident" id="7337971">testHookStartProcess</span>&nbsp;<span class="op" id="7337992">=</span>&nbsp;<span class="builtintype" id="7337994">nil</span>&nbsp;<span class="op" id="7337998">}</span><span class="op" id="7337999">(</span><span class="op" id="7338000">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338003">proc</span>&nbsp;<span class="op" id="7338008">:=</span>&nbsp;<span class="builtinfunc" id="7338011">make</span><span class="op" id="7338015">(</span><span class="keyword" id="7338016">chan</span>&nbsp;<span class="op" id="7338021">*</span><span class="ident" id="7338022">os</span><span class="op" id="7338024">.</span><span class="ident" id="7338025">Process</span><span class="op" id="7338032">,</span>&nbsp;<span class="num" id="7338034">1</span><span class="op" id="7338035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338038">testHookStartProcess</span>&nbsp;<span class="op" id="7338059">=</span>&nbsp;<span class="keyword" id="7338061">func</span><span class="op" id="7338065">(</span><span class="ident" id="7338066">p</span>&nbsp;<span class="op" id="7338068">*</span><span class="ident" id="7338069">os</span><span class="op" id="7338071">.</span><span class="ident" id="7338072">Process</span><span class="op" id="7338079">)</span>&nbsp;<span class="op" id="7338081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338085">proc</span>&nbsp;<span class="op" id="7338090">&lt;-</span>&nbsp;<span class="ident" id="7338093">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338100">h</span>&nbsp;<span class="op" id="7338102">:=</span>&nbsp;<span class="op" id="7338105">&amp;</span><span class="ident" id="7338106">Handler</span><span class="op" id="7338113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338117">Path</span><span class="op" id="7338121">:</span>&nbsp;<span class="ident" id="7338123">os</span><span class="op" id="7338125">.</span><span class="ident" id="7338126">Args</span><span class="op" id="7338130">[</span><span class="num" id="7338131">0</span><span class="op" id="7338132">]</span><span class="op" id="7338133">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338137">Root</span><span class="op" id="7338141">:</span>&nbsp;<span class="string" id="7338143">&#34;/test.go&#34;</span><span class="op" id="7338153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338157">Args</span><span class="op" id="7338161">:</span>&nbsp;<span class="op" id="7338163">[</span><span class="op" id="7338164">]</span><span class="builtintype" id="7338165">string</span><span class="op" id="7338171">{</span><span class="string" id="7338172">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7338205">}</span><span class="op" id="7338206">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338209">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338212">req</span><span class="op" id="7338215">,</span>&nbsp;<span class="ident" id="7338217">_</span>&nbsp;<span class="op" id="7338219">:=</span>&nbsp;<span class="ident" id="7338222">http</span><span class="op" id="7338226">.</span><span class="ident" id="7338227">NewRequest</span><span class="op" id="7338237">(</span><span class="string" id="7338238">&#34;GET&#34;</span><span class="op" id="7338243">,</span>&nbsp;<span class="string" id="7338245">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7338290">,</span>&nbsp;<span class="builtintype" id="7338292">nil</span><span class="op" id="7338295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338298">rec</span>&nbsp;<span class="op" id="7338302">:=</span>&nbsp;<span class="ident" id="7338305">httptest</span><span class="op" id="7338313">.</span><span class="ident" id="7338314">NewRecorder</span><span class="op" id="7338325">(</span><span class="op" id="7338326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338329">var</span>&nbsp;<span class="ident" id="7338333">out</span>&nbsp;<span class="ident" id="7338337">bytes</span><span class="op" id="7338342">.</span><span class="ident" id="7338343">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338351">const</span>&nbsp;<span class="ident" id="7338357">writeLen</span>&nbsp;<span class="op" id="7338366">=</span>&nbsp;<span class="num" id="7338368">50</span>&nbsp;<span class="op" id="7338371">&lt;&lt;</span>&nbsp;<span class="num" id="7338374">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338378">rw</span>&nbsp;<span class="op" id="7338381">:=</span>&nbsp;<span class="op" id="7338384">&amp;</span><span class="ident" id="7338385">customWriterRecorder</span><span class="op" id="7338405">{</span><span class="op" id="7338406">&amp;</span><span class="ident" id="7338407">limitWriter</span><span class="op" id="7338418">{</span><span class="op" id="7338419">&amp;</span><span class="ident" id="7338420">out</span><span class="op" id="7338423">,</span>&nbsp;<span class="ident" id="7338425">writeLen</span><span class="op" id="7338433">}</span><span class="op" id="7338434">,</span>&nbsp;<span class="ident" id="7338436">rec</span><span class="op" id="7338439">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338443">donec</span>&nbsp;<span class="op" id="7338449">:=</span>&nbsp;<span class="builtinfunc" id="7338452">make</span><span class="op" id="7338456">(</span><span class="keyword" id="7338457">chan</span>&nbsp;<span class="builtintype" id="7338462">bool</span><span class="op" id="7338466">,</span>&nbsp;<span class="num" id="7338468">1</span><span class="op" id="7338469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338472">go</span>&nbsp;<span class="keyword" id="7338475">func</span><span class="op" id="7338479">(</span><span class="op" id="7338480">)</span>&nbsp;<span class="op" id="7338482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338486">h</span><span class="op" id="7338487">.</span><span class="ident" id="7338488">ServeHTTP</span><span class="op" id="7338497">(</span><span class="ident" id="7338498">rw</span><span class="op" id="7338500">,</span>&nbsp;<span class="ident" id="7338502">req</span><span class="op" id="7338505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338509">donec</span>&nbsp;<span class="op" id="7338515">&lt;-</span>&nbsp;<span class="builtintype" id="7338518">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338524">}</span><span class="op" id="7338525">(</span><span class="op" id="7338526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338530">select</span>&nbsp;<span class="op" id="7338537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338540">case</span>&nbsp;<span class="op" id="7338545">&lt;-</span><span class="ident" id="7338547">donec</span><span class="op" id="7338552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338556">if</span>&nbsp;<span class="ident" id="7338559">out</span><span class="op" id="7338562">.</span><span class="ident" id="7338563">Len</span><span class="op" id="7338566">(</span><span class="op" id="7338567">)</span>&nbsp;<span class="op" id="7338569">!=</span>&nbsp;<span class="ident" id="7338572">writeLen</span>&nbsp;<span class="op" id="7338581">||</span>&nbsp;<span class="ident" id="7338584">out</span><span class="op" id="7338587">.</span><span class="ident" id="7338588">Bytes</span><span class="op" id="7338593">(</span><span class="op" id="7338594">)</span><span class="op" id="7338595">[</span><span class="num" id="7338596">0</span><span class="op" id="7338597">]</span>&nbsp;<span class="op" id="7338599">!=</span>&nbsp;<span class="string" id="7338602">&#39;a&#39;</span>&nbsp;<span class="op" id="7338606">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338611">t</span><span class="op" id="7338612">.</span><span class="ident" id="7338613">Errorf</span><span class="op" id="7338619">(</span><span class="string" id="7338620">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7338643">,</span>&nbsp;<span class="ident" id="7338645">out</span><span class="op" id="7338648">.</span><span class="ident" id="7338649">Bytes</span><span class="op" id="7338654">(</span><span class="op" id="7338655">)</span><span class="op" id="7338656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338663">case</span>&nbsp;<span class="op" id="7338668">&lt;-</span><span class="ident" id="7338670">time</span><span class="op" id="7338674">.</span><span class="ident" id="7338675">After</span><span class="op" id="7338680">(</span><span class="num" id="7338681">5</span>&nbsp;<span class="op" id="7338683">*</span>&nbsp;<span class="ident" id="7338685">time</span><span class="op" id="7338689">.</span><span class="ident" id="7338690">Second</span><span class="op" id="7338696">)</span><span class="op" id="7338697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338701">t</span><span class="op" id="7338702">.</span><span class="ident" id="7338703">Errorf</span><span class="op" id="7338709">(</span><span class="string" id="7338710">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7338770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338774">select</span>&nbsp;<span class="op" id="7338781">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338785">case</span>&nbsp;<span class="ident" id="7338790">p</span>&nbsp;<span class="op" id="7338792">:=</span>&nbsp;<span class="op" id="7338795">&lt;-</span><span class="ident" id="7338797">proc</span><span class="op" id="7338801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338806">p</span><span class="op" id="7338807">.</span><span class="ident" id="7338808">Kill</span><span class="op" id="7338812">(</span><span class="op" id="7338813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338818">t</span><span class="op" id="7338819">.</span><span class="ident" id="7338820">Logf</span><span class="op" id="7338824">(</span><span class="string" id="7338825">&#34;killed&nbsp;process&#34;</span><span class="op" id="7338841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7338845">default</span><span class="op" id="7338852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7338857">t</span><span class="op" id="7338858">.</span><span class="ident" id="7338859">Logf</span><span class="op" id="7338863">(</span><span class="string" id="7338864">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7338885">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7338892">}</span><br>
<span class="lineno"></span><span class="op" id="7338894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7338897">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7338954">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7338979">func</span>&nbsp;<span class="ident" id="7338984">TestChildOnlyHeaders</span><span class="op" id="7339004">(</span><span class="ident" id="7339005">t</span>&nbsp;<span class="op" id="7339007">*</span><span class="ident" id="7339008">testing</span><span class="op" id="7339015">.</span><span class="ident" id="7339016">T</span><span class="op" id="7339017">)</span>&nbsp;<span class="op" id="7339019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7339022">if</span>&nbsp;<span class="ident" id="7339025">runtime</span><span class="op" id="7339032">.</span><span class="ident" id="7339033">GOOS</span>&nbsp;<span class="op" id="7339038">==</span>&nbsp;<span class="string" id="7339041">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7339048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339052">t</span><span class="op" id="7339053">.</span><span class="ident" id="7339054">Skip</span><span class="op" id="7339058">(</span><span class="string" id="7339059">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7339077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339080">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339084">h</span>&nbsp;<span class="op" id="7339086">:=</span>&nbsp;<span class="op" id="7339089">&amp;</span><span class="ident" id="7339090">Handler</span><span class="op" id="7339097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339101">Path</span><span class="op" id="7339105">:</span>&nbsp;<span class="ident" id="7339107">os</span><span class="op" id="7339109">.</span><span class="ident" id="7339110">Args</span><span class="op" id="7339114">[</span><span class="num" id="7339115">0</span><span class="op" id="7339116">]</span><span class="op" id="7339117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339121">Root</span><span class="op" id="7339125">:</span>&nbsp;<span class="string" id="7339127">&#34;/test.go&#34;</span><span class="op" id="7339137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339141">Args</span><span class="op" id="7339145">:</span>&nbsp;<span class="op" id="7339147">[</span><span class="op" id="7339148">]</span><span class="builtintype" id="7339149">string</span><span class="op" id="7339155">{</span><span class="string" id="7339156">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7339189">}</span><span class="op" id="7339190">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339196">expectedMap</span>&nbsp;<span class="op" id="7339208">:=</span>&nbsp;<span class="keyword" id="7339211">map</span><span class="op" id="7339214">[</span><span class="builtintype" id="7339215">string</span><span class="op" id="7339221">]</span><span class="builtintype" id="7339222">string</span><span class="op" id="7339228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7339232">&#34;_body&#34;</span><span class="op" id="7339239">:</span>&nbsp;<span class="string" id="7339241">&#34;&#34;</span><span class="op" id="7339243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339249">replay</span>&nbsp;<span class="op" id="7339256">:=</span>&nbsp;<span class="ident" id="7339259">runCgiTest</span><span class="op" id="7339269">(</span><span class="ident" id="7339270">t</span><span class="op" id="7339271">,</span>&nbsp;<span class="ident" id="7339273">h</span><span class="op" id="7339274">,</span>&nbsp;<span class="string" id="7339276">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7339332">,</span>&nbsp;<span class="ident" id="7339334">expectedMap</span><span class="op" id="7339345">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7339348">if</span>&nbsp;<span class="ident" id="7339351">expected</span><span class="op" id="7339359">,</span>&nbsp;<span class="ident" id="7339361">got</span>&nbsp;<span class="op" id="7339365">:=</span>&nbsp;<span class="string" id="7339368">&#34;X-Test-Value&#34;</span><span class="op" id="7339382">,</span>&nbsp;<span class="ident" id="7339384">replay</span><span class="op" id="7339390">.</span><span class="ident" id="7339391">Header</span><span class="op" id="7339397">(</span><span class="op" id="7339398">)</span><span class="op" id="7339399">.</span><span class="ident" id="7339400">Get</span><span class="op" id="7339403">(</span><span class="string" id="7339404">&#34;X-Test-Header&#34;</span><span class="op" id="7339419">)</span><span class="op" id="7339420">;</span>&nbsp;<span class="ident" id="7339422">got</span>&nbsp;<span class="op" id="7339426">!=</span>&nbsp;<span class="ident" id="7339429">expected</span>&nbsp;<span class="op" id="7339438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339442">t</span><span class="op" id="7339443">.</span><span class="ident" id="7339444">Errorf</span><span class="op" id="7339450">(</span><span class="string" id="7339451">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7339491">,</span>&nbsp;<span class="ident" id="7339493">got</span><span class="op" id="7339496">,</span>&nbsp;<span class="ident" id="7339498">expected</span><span class="op" id="7339506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339509">}</span><br>
<span class="lineno"></span><span class="op" id="7339511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7339514">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7339539">func</span>&nbsp;<span class="ident" id="7339544">Test500WithNoHeaders</span><span class="op" id="7339564">(</span><span class="ident" id="7339565">t</span>&nbsp;<span class="op" id="7339567">*</span><span class="ident" id="7339568">testing</span><span class="op" id="7339575">.</span><span class="ident" id="7339576">T</span><span class="op" id="7339577">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339583">{</span>&nbsp;<span class="ident" id="7339585">want500Test</span><span class="op" id="7339596">(</span><span class="ident" id="7339597">t</span><span class="op" id="7339598">,</span>&nbsp;<span class="string" id="7339600">&#34;/immediate-disconnect&#34;</span><span class="op" id="7339623">)</span>&nbsp;<span class="op" id="7339625">}</span><br>
<span class="lineno"></span><span class="keyword" id="7339627">func</span>&nbsp;<span class="ident" id="7339632">Test500WithNoContentType</span><span class="op" id="7339656">(</span><span class="ident" id="7339657">t</span>&nbsp;<span class="op" id="7339659">*</span><span class="ident" id="7339660">testing</span><span class="op" id="7339667">.</span><span class="ident" id="7339668">T</span><span class="op" id="7339669">)</span>&nbsp;<span class="op" id="7339671">{</span>&nbsp;<span class="ident" id="7339673">want500Test</span><span class="op" id="7339684">(</span><span class="ident" id="7339685">t</span><span class="op" id="7339686">,</span>&nbsp;<span class="string" id="7339688">&#34;/no-content-type&#34;</span><span class="op" id="7339706">)</span>&nbsp;<span class="op" id="7339708">}</span><br>
<span class="lineno"></span><span class="keyword" id="7339710">func</span>&nbsp;<span class="ident" id="7339715">Test500WithEmptyHeaders</span><span class="op" id="7339738">(</span><span class="ident" id="7339739">t</span>&nbsp;<span class="op" id="7339741">*</span><span class="ident" id="7339742">testing</span><span class="op" id="7339749">.</span><span class="ident" id="7339750">T</span><span class="op" id="7339751">)</span>&nbsp;&nbsp;<span class="op" id="7339754">{</span>&nbsp;<span class="ident" id="7339756">want500Test</span><span class="op" id="7339767">(</span><span class="ident" id="7339768">t</span><span class="op" id="7339769">,</span>&nbsp;<span class="string" id="7339771">&#34;/empty-headers&#34;</span><span class="op" id="7339787">)</span>&nbsp;<span class="op" id="7339789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7339792">func</span>&nbsp;<span class="ident" id="7339797">want500Test</span><span class="op" id="7339808">(</span><span class="ident" id="7339809">t</span>&nbsp;<span class="op" id="7339811">*</span><span class="ident" id="7339812">testing</span><span class="op" id="7339819">.</span><span class="ident" id="7339820">T</span><span class="op" id="7339821">,</span>&nbsp;<span class="ident" id="7339823">path</span>&nbsp;<span class="builtintype" id="7339828">string</span><span class="op" id="7339834">)</span>&nbsp;<span class="op" id="7339836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339839">h</span>&nbsp;<span class="op" id="7339841">:=</span>&nbsp;<span class="op" id="7339844">&amp;</span><span class="ident" id="7339845">Handler</span><span class="op" id="7339852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339856">Path</span><span class="op" id="7339860">:</span>&nbsp;<span class="ident" id="7339862">os</span><span class="op" id="7339864">.</span><span class="ident" id="7339865">Args</span><span class="op" id="7339869">[</span><span class="num" id="7339870">0</span><span class="op" id="7339871">]</span><span class="op" id="7339872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339876">Root</span><span class="op" id="7339880">:</span>&nbsp;<span class="string" id="7339882">&#34;/test.go&#34;</span><span class="op" id="7339892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339896">Args</span><span class="op" id="7339900">:</span>&nbsp;<span class="op" id="7339902">[</span><span class="op" id="7339903">]</span><span class="builtintype" id="7339904">string</span><span class="op" id="7339910">{</span><span class="string" id="7339911">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7339944">}</span><span class="op" id="7339945">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7339948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7339951">expectedMap</span>&nbsp;<span class="op" id="7339963">:=</span>&nbsp;<span class="keyword" id="7339966">map</span><span class="op" id="7339969">[</span><span class="builtintype" id="7339970">string</span><span class="op" id="7339976">]</span><span class="builtintype" id="7339977">string</span><span class="op" id="7339983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7339987">&#34;_body&#34;</span><span class="op" id="7339994">:</span>&nbsp;<span class="string" id="7339996">&#34;&#34;</span><span class="op" id="7339998">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340004">replay</span>&nbsp;<span class="op" id="7340011">:=</span>&nbsp;<span class="ident" id="7340014">runCgiTest</span><span class="op" id="7340024">(</span><span class="ident" id="7340025">t</span><span class="op" id="7340026">,</span>&nbsp;<span class="ident" id="7340028">h</span><span class="op" id="7340029">,</span>&nbsp;<span class="string" id="7340031">&#34;GET&nbsp;&#34;</span><span class="op" id="7340037">+</span><span class="ident" id="7340038">path</span><span class="op" id="7340042">+</span><span class="string" id="7340043">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7340077">,</span>&nbsp;<span class="ident" id="7340079">expectedMap</span><span class="op" id="7340090">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340093">if</span>&nbsp;<span class="ident" id="7340096">replay</span><span class="op" id="7340102">.</span><span class="ident" id="7340103">Code</span>&nbsp;<span class="op" id="7340108">!=</span>&nbsp;<span class="num" id="7340111">500</span>&nbsp;<span class="op" id="7340115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340119">t</span><span class="op" id="7340120">.</span><span class="ident" id="7340121">Errorf</span><span class="op" id="7340127">(</span><span class="string" id="7340128">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7340151">,</span>&nbsp;<span class="ident" id="7340153">replay</span><span class="op" id="7340159">.</span><span class="ident" id="7340160">Code</span><span class="op" id="7340164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340167">}</span><br>
<span class="lineno"></span><span class="op" id="7340169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7340172">type</span>&nbsp;<span class="ident" id="7340177">neverEnding</span>&nbsp;<span class="builtintype" id="7340189">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7340195">func</span>&nbsp;<span class="op" id="7340200">(</span><span class="ident" id="7340201">b</span>&nbsp;<span class="ident" id="7340203">neverEnding</span><span class="op" id="7340214">)</span>&nbsp;<span class="ident" id="7340216">Read</span><span class="op" id="7340220">(</span><span class="ident" id="7340221">p</span>&nbsp;<span class="op" id="7340223">[</span><span class="op" id="7340224">]</span><span class="builtintype" id="7340225">byte</span><span class="op" id="7340229">)</span>&nbsp;<span class="op" id="7340231">(</span><span class="ident" id="7340232">n</span>&nbsp;<span class="builtintype" id="7340234">int</span><span class="op" id="7340237">,</span>&nbsp;<span class="ident" id="7340239">err</span>&nbsp;<span class="builtintype" id="7340243">error</span><span class="op" id="7340248">)</span>&nbsp;<span class="op" id="7340250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340253">for</span>&nbsp;<span class="ident" id="7340257">i</span>&nbsp;<span class="op" id="7340259">:=</span>&nbsp;<span class="keyword" id="7340262">range</span>&nbsp;<span class="ident" id="7340268">p</span>&nbsp;<span class="op" id="7340270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340274">p</span><span class="op" id="7340275">[</span><span class="ident" id="7340276">i</span><span class="op" id="7340277">]</span>&nbsp;<span class="op" id="7340279">=</span>&nbsp;<span class="builtintype" id="7340281">byte</span><span class="op" id="7340285">(</span><span class="ident" id="7340286">b</span><span class="op" id="7340287">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340293">return</span>&nbsp;<span class="builtinfunc" id="7340300">len</span><span class="op" id="7340303">(</span><span class="ident" id="7340304">p</span><span class="op" id="7340305">)</span><span class="op" id="7340306">,</span>&nbsp;<span class="builtintype" id="7340308">nil</span><br>
<span class="lineno"></span><span class="op" id="7340312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7340315">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7340345">func</span>&nbsp;<span class="ident" id="7340350">TestBeChildCGIProcess</span><span class="op" id="7340371">(</span><span class="ident" id="7340372">t</span>&nbsp;<span class="op" id="7340374">*</span><span class="ident" id="7340375">testing</span><span class="op" id="7340382">.</span><span class="ident" id="7340383">T</span><span class="op" id="7340384">)</span>&nbsp;<span class="op" id="7340386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340389">if</span>&nbsp;<span class="ident" id="7340392">os</span><span class="op" id="7340394">.</span><span class="ident" id="7340395">Getenv</span><span class="op" id="7340401">(</span><span class="string" id="7340402">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7340418">)</span>&nbsp;<span class="op" id="7340420">==</span>&nbsp;<span class="string" id="7340423">&#34;&#34;</span>&nbsp;<span class="op" id="7340426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7340430">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340476">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340484">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340487">switch</span>&nbsp;<span class="ident" id="7340494">os</span><span class="op" id="7340496">.</span><span class="ident" id="7340497">Getenv</span><span class="op" id="7340503">(</span><span class="string" id="7340504">&#34;REQUEST_URI&#34;</span><span class="op" id="7340517">)</span>&nbsp;<span class="op" id="7340519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340522">case</span>&nbsp;<span class="string" id="7340527">&#34;/immediate-disconnect&#34;</span><span class="op" id="7340550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340554">os</span><span class="op" id="7340556">.</span><span class="ident" id="7340557">Exit</span><span class="op" id="7340561">(</span><span class="num" id="7340562">0</span><span class="op" id="7340563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340566">case</span>&nbsp;<span class="string" id="7340571">&#34;/no-content-type&#34;</span><span class="op" id="7340589">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340593">fmt</span><span class="op" id="7340596">.</span><span class="ident" id="7340597">Printf</span><span class="op" id="7340603">(</span><span class="string" id="7340604">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7340634">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340638">os</span><span class="op" id="7340640">.</span><span class="ident" id="7340641">Exit</span><span class="op" id="7340645">(</span><span class="num" id="7340646">0</span><span class="op" id="7340647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340650">case</span>&nbsp;<span class="string" id="7340655">&#34;/empty-headers&#34;</span><span class="op" id="7340671">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340675">fmt</span><span class="op" id="7340678">.</span><span class="ident" id="7340679">Printf</span><span class="op" id="7340685">(</span><span class="string" id="7340686">&#34;\nHello&#34;</span><span class="op" id="7340695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340699">os</span><span class="op" id="7340701">.</span><span class="ident" id="7340702">Exit</span><span class="op" id="7340706">(</span><span class="num" id="7340707">0</span><span class="op" id="7340708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340711">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340714">Serve</span><span class="op" id="7340719">(</span><span class="ident" id="7340720">http</span><span class="op" id="7340724">.</span><span class="ident" id="7340725">HandlerFunc</span><span class="op" id="7340736">(</span><span class="keyword" id="7340737">func</span><span class="op" id="7340741">(</span><span class="ident" id="7340742">rw</span>&nbsp;<span class="ident" id="7340745">http</span><span class="op" id="7340749">.</span><span class="ident" id="7340750">ResponseWriter</span><span class="op" id="7340764">,</span>&nbsp;<span class="ident" id="7340766">req</span>&nbsp;<span class="op" id="7340770">*</span><span class="ident" id="7340771">http</span><span class="op" id="7340775">.</span><span class="ident" id="7340776">Request</span><span class="op" id="7340783">)</span>&nbsp;<span class="op" id="7340785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340789">rw</span><span class="op" id="7340791">.</span><span class="ident" id="7340792">Header</span><span class="op" id="7340798">(</span><span class="op" id="7340799">)</span><span class="op" id="7340800">.</span><span class="ident" id="7340801">Set</span><span class="op" id="7340804">(</span><span class="string" id="7340805">&#34;X-Test-Header&#34;</span><span class="op" id="7340820">,</span>&nbsp;<span class="string" id="7340822">&#34;X-Test-Value&#34;</span><span class="op" id="7340836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340840">req</span><span class="op" id="7340843">.</span><span class="ident" id="7340844">ParseForm</span><span class="op" id="7340853">(</span><span class="op" id="7340854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340858">if</span>&nbsp;<span class="ident" id="7340861">req</span><span class="op" id="7340864">.</span><span class="ident" id="7340865">FormValue</span><span class="op" id="7340874">(</span><span class="string" id="7340875">&#34;no-body&#34;</span><span class="op" id="7340884">)</span>&nbsp;<span class="op" id="7340886">==</span>&nbsp;<span class="string" id="7340889">&#34;1&#34;</span>&nbsp;<span class="op" id="7340893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340898">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7340907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340911">if</span>&nbsp;<span class="ident" id="7340914">req</span><span class="op" id="7340917">.</span><span class="ident" id="7340918">FormValue</span><span class="op" id="7340927">(</span><span class="string" id="7340928">&#34;write-forever&#34;</span><span class="op" id="7340943">)</span>&nbsp;<span class="op" id="7340945">==</span>&nbsp;<span class="string" id="7340948">&#34;1&#34;</span>&nbsp;<span class="op" id="7340952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7340957">io</span><span class="op" id="7340959">.</span><span class="ident" id="7340960">Copy</span><span class="op" id="7340964">(</span><span class="ident" id="7340965">rw</span><span class="op" id="7340967">,</span>&nbsp;<span class="ident" id="7340969">neverEnding</span><span class="op" id="7340980">(</span><span class="string" id="7340981">&#39;a&#39;</span><span class="op" id="7340984">)</span><span class="op" id="7340985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7340990">for</span>&nbsp;<span class="op" id="7340994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7341000">time</span><span class="op" id="7341004">.</span><span class="ident" id="7341005">Sleep</span><span class="op" id="7341010">(</span><span class="num" id="7341011">5</span>&nbsp;<span class="op" id="7341013">*</span>&nbsp;<span class="ident" id="7341015">time</span><span class="op" id="7341019">.</span><span class="ident" id="7341020">Second</span><span class="op" id="7341026">)</span>&nbsp;<span class="comment" id="7341028">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7341069">fmt</span><span class="op" id="7341072">.</span><span class="ident" id="7341073">Fprintf</span><span class="op" id="7341080">(</span><span class="ident" id="7341081">rw</span><span class="op" id="7341083">,</span>&nbsp;<span class="string" id="7341085">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7341110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7341114">for</span>&nbsp;<span class="ident" id="7341118">k</span><span class="op" id="7341119">,</span>&nbsp;<span class="ident" id="7341121">vv</span>&nbsp;<span class="op" id="7341124">:=</span>&nbsp;<span class="keyword" id="7341127">range</span>&nbsp;<span class="ident" id="7341133">req</span><span class="op" id="7341136">.</span><span class="ident" id="7341137">Form</span>&nbsp;<span class="op" id="7341142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7341147">for</span>&nbsp;<span class="ident" id="7341151">_</span><span class="op" id="7341152">,</span>&nbsp;<span class="ident" id="7341154">v</span>&nbsp;<span class="op" id="7341156">:=</span>&nbsp;<span class="keyword" id="7341159">range</span>&nbsp;<span class="ident" id="7341165">vv</span>&nbsp;<span class="op" id="7341168">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7341174">fmt</span><span class="op" id="7341177">.</span><span class="ident" id="7341178">Fprintf</span><span class="op" id="7341185">(</span><span class="ident" id="7341186">rw</span><span class="op" id="7341188">,</span>&nbsp;<span class="string" id="7341190">&#34;param-%s=%s\n&#34;</span><span class="op" id="7341205">,</span>&nbsp;<span class="ident" id="7341207">k</span><span class="op" id="7341208">,</span>&nbsp;<span class="ident" id="7341210">v</span><span class="op" id="7341211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7341224">for</span>&nbsp;<span class="ident" id="7341228">_</span><span class="op" id="7341229">,</span>&nbsp;<span class="ident" id="7341231">kv</span>&nbsp;<span class="op" id="7341234">:=</span>&nbsp;<span class="keyword" id="7341237">range</span>&nbsp;<span class="ident" id="7341243">os</span><span class="op" id="7341245">.</span><span class="ident" id="7341246">Environ</span><span class="op" id="7341253">(</span><span class="op" id="7341254">)</span>&nbsp;<span class="op" id="7341256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7341261">fmt</span><span class="op" id="7341264">.</span><span class="ident" id="7341265">Fprintf</span><span class="op" id="7341272">(</span><span class="ident" id="7341273">rw</span><span class="op" id="7341275">,</span>&nbsp;<span class="string" id="7341277">&#34;env-%s\n&#34;</span><span class="op" id="7341287">,</span>&nbsp;<span class="ident" id="7341289">kv</span><span class="op" id="7341291">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7341298">}</span><span class="op" id="7341299">)</span><span class="op" id="7341300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7341303">os</span><span class="op" id="7341305">.</span><span class="ident" id="7341306">Exit</span><span class="op" id="7341310">(</span><span class="num" id="7341311">0</span><span class="op" id="7341312">)</span><br>
<span class="lineno"></span><span class="op" id="7341314">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
