<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html" class="current">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2369492">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2369547">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2369601">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2369652">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2369669">package</span>&nbsp;<span class="ident" id="2369677">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2369686">import</span>&nbsp;<span class="op" id="2369693">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2369696">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2369705">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2369708">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2369798">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2369825">type</span>&nbsp;<span class="ident" id="2369830">SysProcIDMap</span>&nbsp;<span class="keyword" id="2369843">struct</span>&nbsp;<span class="op" id="2369850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369853">ContainerID</span>&nbsp;<span class="builtintype" id="2369865">int</span>&nbsp;<span class="comment" id="2369869">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369887">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2369899">int</span>&nbsp;<span class="comment" id="2369903">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369916">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2369928">int</span>&nbsp;<span class="comment" id="2369932">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2369941">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2369944">type</span>&nbsp;<span class="ident" id="2369949">SysProcAttr</span>&nbsp;<span class="keyword" id="2369961">struct</span>&nbsp;<span class="op" id="2369968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369971">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2369983">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2369998">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370010">Credential</span>&nbsp;&nbsp;<span class="op" id="2370022">*</span><span class="ident" id="2370023">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370037">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370053">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370065">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370080">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370100">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370112">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370127">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370147">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370159">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370174">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370225">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370237">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370252">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370327">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370339">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370354">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370396">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2370408">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370423">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370459">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2370471">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370486">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370557">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2370569">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2370584">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370623">UidMappings</span>&nbsp;<span class="op" id="2370635">[</span><span class="op" id="2370636">]</span><span class="ident" id="2370637">SysProcIDMap</span>&nbsp;<span class="comment" id="2370650">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370692">GidMappings</span>&nbsp;<span class="op" id="2370704">[</span><span class="op" id="2370705">]</span><span class="ident" id="2370706">SysProcIDMap</span>&nbsp;<span class="comment" id="2370719">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2370761">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2370764">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2370799">func</span>&nbsp;<span class="ident" id="2370804">runtime_BeforeFork</span><span class="op" id="2370822">(</span><span class="op" id="2370823">)</span><br>
<span class="lineno"></span><span class="keyword" id="2370825">func</span>&nbsp;<span class="ident" id="2370830">runtime_AfterFork</span><span class="op" id="2370847">(</span><span class="op" id="2370848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2370851">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2370923">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2370981">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2371048">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2371115">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2371183">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2371247">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2371308">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2371370">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2371411">func</span>&nbsp;<span class="ident" id="2371416">forkAndExecInChild</span><span class="op" id="2371434">(</span><span class="ident" id="2371435">argv0</span>&nbsp;<span class="op" id="2371441">*</span><span class="builtintype" id="2371442">byte</span><span class="op" id="2371446">,</span>&nbsp;<span class="ident" id="2371448">argv</span><span class="op" id="2371452">,</span>&nbsp;<span class="ident" id="2371454">envv</span>&nbsp;<span class="op" id="2371459">[</span><span class="op" id="2371460">]</span><span class="op" id="2371461">*</span><span class="builtintype" id="2371462">byte</span><span class="op" id="2371466">,</span>&nbsp;<span class="ident" id="2371468">chroot</span><span class="op" id="2371474">,</span>&nbsp;<span class="ident" id="2371476">dir</span>&nbsp;<span class="op" id="2371480">*</span><span class="builtintype" id="2371481">byte</span><span class="op" id="2371485">,</span>&nbsp;<span class="ident" id="2371487">attr</span>&nbsp;<span class="op" id="2371492">*</span><span class="ident" id="2371493">ProcAttr</span><span class="op" id="2371501">,</span>&nbsp;<span class="ident" id="2371503">sys</span>&nbsp;<span class="op" id="2371507">*</span><span class="ident" id="2371508">SysProcAttr</span><span class="op" id="2371519">,</span>&nbsp;<span class="ident" id="2371521">pipe</span>&nbsp;<span class="builtintype" id="2371526">int</span><span class="op" id="2371529">)</span>&nbsp;<span class="op" id="2371531">(</span><span class="ident" id="2371532">pid</span>&nbsp;<span class="builtintype" id="2371536">int</span><span class="op" id="2371539">,</span>&nbsp;<span class="ident" id="2371541">err</span>&nbsp;<span class="ident" id="2371545">Errno</span><span class="op" id="2371550">)</span>&nbsp;<span class="op" id="2371552">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371555">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371600">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371655">var</span>&nbsp;<span class="op" id="2371659">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371663">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2371670">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371680">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2371687">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371695">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2371702">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371710">nextfd</span>&nbsp;<span class="builtintype" id="2371717">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371723">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2371730">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371736">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2371743">[</span><span class="num" id="2371744">2</span><span class="op" id="2371745">]</span><span class="builtintype" id="2371746">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371751">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371755">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371810">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371874">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371933">fd</span>&nbsp;<span class="op" id="2371936">:=</span>&nbsp;<span class="builtinfunc" id="2371939">make</span><span class="op" id="2371943">(</span><span class="op" id="2371944">[</span><span class="op" id="2371945">]</span><span class="builtintype" id="2371946">int</span><span class="op" id="2371949">,</span>&nbsp;<span class="builtinfunc" id="2371951">len</span><span class="op" id="2371954">(</span><span class="ident" id="2371955">attr</span><span class="op" id="2371959">.</span><span class="ident" id="2371960">Files</span><span class="op" id="2371965">)</span><span class="op" id="2371966">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371969">nextfd</span>&nbsp;<span class="op" id="2371976">=</span>&nbsp;<span class="builtinfunc" id="2371978">len</span><span class="op" id="2371981">(</span><span class="ident" id="2371982">attr</span><span class="op" id="2371986">.</span><span class="ident" id="2371987">Files</span><span class="op" id="2371992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371995">for</span>&nbsp;<span class="ident" id="2371999">i</span><span class="op" id="2372000">,</span>&nbsp;<span class="ident" id="2372002">ufd</span>&nbsp;<span class="op" id="2372006">:=</span>&nbsp;<span class="keyword" id="2372009">range</span>&nbsp;<span class="ident" id="2372015">attr</span><span class="op" id="2372019">.</span><span class="ident" id="2372020">Files</span>&nbsp;<span class="op" id="2372026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372030">if</span>&nbsp;<span class="ident" id="2372033">nextfd</span>&nbsp;<span class="op" id="2372040">&lt;</span>&nbsp;<span class="builtintype" id="2372042">int</span><span class="op" id="2372045">(</span><span class="ident" id="2372046">ufd</span><span class="op" id="2372049">)</span>&nbsp;<span class="op" id="2372051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372056">nextfd</span>&nbsp;<span class="op" id="2372063">=</span>&nbsp;<span class="builtintype" id="2372065">int</span><span class="op" id="2372068">(</span><span class="ident" id="2372069">ufd</span><span class="op" id="2372072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372076">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372080">fd</span><span class="op" id="2372082">[</span><span class="ident" id="2372083">i</span><span class="op" id="2372084">]</span>&nbsp;<span class="op" id="2372086">=</span>&nbsp;<span class="builtintype" id="2372088">int</span><span class="op" id="2372091">(</span><span class="ident" id="2372092">ufd</span><span class="op" id="2372095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372101">nextfd</span><span class="op" id="2372107">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372112">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372176">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372232">if</span>&nbsp;<span class="ident" id="2372235">sys</span><span class="op" id="2372238">.</span><span class="ident" id="2372239">UidMappings</span>&nbsp;<span class="op" id="2372251">!=</span>&nbsp;<span class="ident" id="2372254">nil</span>&nbsp;<span class="op" id="2372258">||</span>&nbsp;<span class="ident" id="2372261">sys</span><span class="op" id="2372264">.</span><span class="ident" id="2372265">GidMappings</span>&nbsp;<span class="op" id="2372277">!=</span>&nbsp;<span class="ident" id="2372280">nil</span>&nbsp;<span class="op" id="2372284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372288">if</span>&nbsp;<span class="ident" id="2372291">err</span>&nbsp;<span class="op" id="2372295">:=</span>&nbsp;<span class="ident" id="2372298">forkExecPipe</span><span class="op" id="2372310">(</span><span class="ident" id="2372311">p</span><span class="op" id="2372312">[</span><span class="op" id="2372313">:</span><span class="op" id="2372314">]</span><span class="op" id="2372315">)</span><span class="op" id="2372316">;</span>&nbsp;<span class="ident" id="2372318">err</span>&nbsp;<span class="op" id="2372322">!=</span>&nbsp;<span class="ident" id="2372325">nil</span>&nbsp;<span class="op" id="2372329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372334">return</span>&nbsp;<span class="num" id="2372341">0</span><span class="op" id="2372342">,</span>&nbsp;<span class="ident" id="2372344">err</span><span class="op" id="2372347">.</span><span class="op" id="2372348">(</span><span class="ident" id="2372349">Errno</span><span class="op" id="2372354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372358">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372365">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372389">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372448">runtime_BeforeFork</span><span class="op" id="2372466">(</span><span class="op" id="2372467">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372470">r1</span><span class="op" id="2372472">,</span>&nbsp;<span class="ident" id="2372474">_</span><span class="op" id="2372475">,</span>&nbsp;<span class="ident" id="2372477">err1</span>&nbsp;<span class="op" id="2372482">=</span>&nbsp;<span class="ident" id="2372484">RawSyscall6</span><span class="op" id="2372495">(</span><span class="ident" id="2372496">SYS_CLONE</span><span class="op" id="2372505">,</span>&nbsp;<span class="builtintype" id="2372507">uintptr</span><span class="op" id="2372514">(</span><span class="ident" id="2372515">SIGCHLD</span><span class="op" id="2372522">)</span><span class="op" id="2372523">|</span><span class="ident" id="2372524">sys</span><span class="op" id="2372527">.</span><span class="ident" id="2372528">Cloneflags</span><span class="op" id="2372538">,</span>&nbsp;<span class="num" id="2372540">0</span><span class="op" id="2372541">,</span>&nbsp;<span class="num" id="2372543">0</span><span class="op" id="2372544">,</span>&nbsp;<span class="num" id="2372546">0</span><span class="op" id="2372547">,</span>&nbsp;<span class="num" id="2372549">0</span><span class="op" id="2372550">,</span>&nbsp;<span class="num" id="2372552">0</span><span class="op" id="2372553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372556">if</span>&nbsp;<span class="ident" id="2372559">err1</span>&nbsp;<span class="op" id="2372564">!=</span>&nbsp;<span class="num" id="2372567">0</span>&nbsp;<span class="op" id="2372569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372573">runtime_AfterFork</span><span class="op" id="2372590">(</span><span class="op" id="2372591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372595">return</span>&nbsp;<span class="num" id="2372602">0</span><span class="op" id="2372603">,</span>&nbsp;<span class="ident" id="2372605">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372611">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372615">if</span>&nbsp;<span class="ident" id="2372618">r1</span>&nbsp;<span class="op" id="2372621">!=</span>&nbsp;<span class="num" id="2372624">0</span>&nbsp;<span class="op" id="2372626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372630">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372654">runtime_AfterFork</span><span class="op" id="2372671">(</span><span class="op" id="2372672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372676">pid</span>&nbsp;<span class="op" id="2372680">=</span>&nbsp;<span class="builtintype" id="2372682">int</span><span class="op" id="2372685">(</span><span class="ident" id="2372686">r1</span><span class="op" id="2372688">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372693">if</span>&nbsp;<span class="ident" id="2372696">sys</span><span class="op" id="2372699">.</span><span class="ident" id="2372700">UidMappings</span>&nbsp;<span class="op" id="2372712">!=</span>&nbsp;<span class="ident" id="2372715">nil</span>&nbsp;<span class="op" id="2372719">||</span>&nbsp;<span class="ident" id="2372722">sys</span><span class="op" id="2372725">.</span><span class="ident" id="2372726">GidMappings</span>&nbsp;<span class="op" id="2372738">!=</span>&nbsp;<span class="ident" id="2372741">nil</span>&nbsp;<span class="op" id="2372745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372750">Close</span><span class="op" id="2372755">(</span><span class="ident" id="2372756">p</span><span class="op" id="2372757">[</span><span class="num" id="2372758">0</span><span class="op" id="2372759">]</span><span class="op" id="2372760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372765">err</span>&nbsp;<span class="op" id="2372769">:=</span>&nbsp;<span class="ident" id="2372772">writeUidGidMappings</span><span class="op" id="2372791">(</span><span class="ident" id="2372792">pid</span><span class="op" id="2372795">,</span>&nbsp;<span class="ident" id="2372797">sys</span><span class="op" id="2372800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372805">if</span>&nbsp;<span class="ident" id="2372808">err</span>&nbsp;<span class="op" id="2372812">!=</span>&nbsp;<span class="ident" id="2372815">nil</span>&nbsp;<span class="op" id="2372819">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372825">err2</span>&nbsp;<span class="op" id="2372830">=</span>&nbsp;<span class="ident" id="2372832">err</span><span class="op" id="2372835">.</span><span class="op" id="2372836">(</span><span class="ident" id="2372837">Errno</span><span class="op" id="2372842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372852">RawSyscall</span><span class="op" id="2372862">(</span><span class="ident" id="2372863">SYS_WRITE</span><span class="op" id="2372872">,</span>&nbsp;<span class="builtintype" id="2372874">uintptr</span><span class="op" id="2372881">(</span><span class="ident" id="2372882">p</span><span class="op" id="2372883">[</span><span class="num" id="2372884">1</span><span class="op" id="2372885">]</span><span class="op" id="2372886">)</span><span class="op" id="2372887">,</span>&nbsp;<span class="builtintype" id="2372889">uintptr</span><span class="op" id="2372896">(</span><span class="ident" id="2372897">unsafe</span><span class="op" id="2372903">.</span><span class="ident" id="2372904">Pointer</span><span class="op" id="2372911">(</span><span class="op" id="2372912">&amp;</span><span class="ident" id="2372913">err2</span><span class="op" id="2372917">)</span><span class="op" id="2372918">)</span><span class="op" id="2372919">,</span>&nbsp;<span class="ident" id="2372921">unsafe</span><span class="op" id="2372927">.</span><span class="ident" id="2372928">Sizeof</span><span class="op" id="2372934">(</span><span class="ident" id="2372935">err2</span><span class="op" id="2372939">)</span><span class="op" id="2372940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372945">Close</span><span class="op" id="2372950">(</span><span class="ident" id="2372951">p</span><span class="op" id="2372952">[</span><span class="num" id="2372953">1</span><span class="op" id="2372954">]</span><span class="op" id="2372955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372959">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372964">return</span>&nbsp;<span class="ident" id="2372971">pid</span><span class="op" id="2372974">,</span>&nbsp;<span class="num" id="2372976">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372983">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2373018">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373072">if</span>&nbsp;<span class="ident" id="2373075">sys</span><span class="op" id="2373078">.</span><span class="ident" id="2373079">UidMappings</span>&nbsp;<span class="op" id="2373091">!=</span>&nbsp;<span class="ident" id="2373094">nil</span>&nbsp;<span class="op" id="2373098">||</span>&nbsp;<span class="ident" id="2373101">sys</span><span class="op" id="2373104">.</span><span class="ident" id="2373105">GidMappings</span>&nbsp;<span class="op" id="2373117">!=</span>&nbsp;<span class="ident" id="2373120">nil</span>&nbsp;<span class="op" id="2373124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373128">if</span>&nbsp;<span class="ident" id="2373131">_</span><span class="op" id="2373132">,</span>&nbsp;<span class="ident" id="2373134">_</span><span class="op" id="2373135">,</span>&nbsp;<span class="ident" id="2373137">err1</span>&nbsp;<span class="op" id="2373142">=</span>&nbsp;<span class="ident" id="2373144">RawSyscall</span><span class="op" id="2373154">(</span><span class="ident" id="2373155">SYS_CLOSE</span><span class="op" id="2373164">,</span>&nbsp;<span class="builtintype" id="2373166">uintptr</span><span class="op" id="2373173">(</span><span class="ident" id="2373174">p</span><span class="op" id="2373175">[</span><span class="num" id="2373176">1</span><span class="op" id="2373177">]</span><span class="op" id="2373178">)</span><span class="op" id="2373179">,</span>&nbsp;<span class="num" id="2373181">0</span><span class="op" id="2373182">,</span>&nbsp;<span class="num" id="2373184">0</span><span class="op" id="2373185">)</span><span class="op" id="2373186">;</span>&nbsp;<span class="ident" id="2373188">err1</span>&nbsp;<span class="op" id="2373193">!=</span>&nbsp;<span class="num" id="2373196">0</span>&nbsp;<span class="op" id="2373198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373203">goto</span>&nbsp;<span class="ident" id="2373208">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373225">r1</span><span class="op" id="2373227">,</span>&nbsp;<span class="ident" id="2373229">_</span><span class="op" id="2373230">,</span>&nbsp;<span class="ident" id="2373232">err1</span>&nbsp;<span class="op" id="2373237">=</span>&nbsp;<span class="ident" id="2373239">RawSyscall</span><span class="op" id="2373249">(</span><span class="ident" id="2373250">SYS_READ</span><span class="op" id="2373258">,</span>&nbsp;<span class="builtintype" id="2373260">uintptr</span><span class="op" id="2373267">(</span><span class="ident" id="2373268">p</span><span class="op" id="2373269">[</span><span class="num" id="2373270">0</span><span class="op" id="2373271">]</span><span class="op" id="2373272">)</span><span class="op" id="2373273">,</span>&nbsp;<span class="builtintype" id="2373275">uintptr</span><span class="op" id="2373282">(</span><span class="ident" id="2373283">unsafe</span><span class="op" id="2373289">.</span><span class="ident" id="2373290">Pointer</span><span class="op" id="2373297">(</span><span class="op" id="2373298">&amp;</span><span class="ident" id="2373299">err2</span><span class="op" id="2373303">)</span><span class="op" id="2373304">)</span><span class="op" id="2373305">,</span>&nbsp;<span class="ident" id="2373307">unsafe</span><span class="op" id="2373313">.</span><span class="ident" id="2373314">Sizeof</span><span class="op" id="2373320">(</span><span class="ident" id="2373321">err2</span><span class="op" id="2373325">)</span><span class="op" id="2373326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373330">if</span>&nbsp;<span class="ident" id="2373333">err1</span>&nbsp;<span class="op" id="2373338">!=</span>&nbsp;<span class="num" id="2373341">0</span>&nbsp;<span class="op" id="2373343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373348">goto</span>&nbsp;<span class="ident" id="2373353">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373366">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373370">if</span>&nbsp;<span class="ident" id="2373373">r1</span>&nbsp;<span class="op" id="2373376">!=</span>&nbsp;<span class="ident" id="2373379">unsafe</span><span class="op" id="2373385">.</span><span class="ident" id="2373386">Sizeof</span><span class="op" id="2373392">(</span><span class="ident" id="2373393">err2</span><span class="op" id="2373397">)</span>&nbsp;<span class="op" id="2373399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373404">err1</span>&nbsp;<span class="op" id="2373409">=</span>&nbsp;<span class="ident" id="2373411">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373421">goto</span>&nbsp;<span class="ident" id="2373426">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373443">if</span>&nbsp;<span class="ident" id="2373446">err2</span>&nbsp;<span class="op" id="2373451">!=</span>&nbsp;<span class="num" id="2373454">0</span>&nbsp;<span class="op" id="2373456">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373461">err1</span>&nbsp;<span class="op" id="2373466">=</span>&nbsp;<span class="ident" id="2373468">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373476">goto</span>&nbsp;<span class="ident" id="2373481">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2373501">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373525">if</span>&nbsp;<span class="ident" id="2373528">sys</span><span class="op" id="2373531">.</span><span class="ident" id="2373532">Pdeathsig</span>&nbsp;<span class="op" id="2373542">!=</span>&nbsp;<span class="num" id="2373545">0</span>&nbsp;<span class="op" id="2373547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373551">_</span><span class="op" id="2373552">,</span>&nbsp;<span class="ident" id="2373554">_</span><span class="op" id="2373555">,</span>&nbsp;<span class="ident" id="2373557">err1</span>&nbsp;<span class="op" id="2373562">=</span>&nbsp;<span class="ident" id="2373564">RawSyscall6</span><span class="op" id="2373575">(</span><span class="ident" id="2373576">SYS_PRCTL</span><span class="op" id="2373585">,</span>&nbsp;<span class="ident" id="2373587">PR_SET_PDEATHSIG</span><span class="op" id="2373603">,</span>&nbsp;<span class="builtintype" id="2373605">uintptr</span><span class="op" id="2373612">(</span><span class="ident" id="2373613">sys</span><span class="op" id="2373616">.</span><span class="ident" id="2373617">Pdeathsig</span><span class="op" id="2373626">)</span><span class="op" id="2373627">,</span>&nbsp;<span class="num" id="2373629">0</span><span class="op" id="2373630">,</span>&nbsp;<span class="num" id="2373632">0</span><span class="op" id="2373633">,</span>&nbsp;<span class="num" id="2373635">0</span><span class="op" id="2373636">,</span>&nbsp;<span class="num" id="2373638">0</span><span class="op" id="2373639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373643">if</span>&nbsp;<span class="ident" id="2373646">err1</span>&nbsp;<span class="op" id="2373651">!=</span>&nbsp;<span class="num" id="2373654">0</span>&nbsp;<span class="op" id="2373656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373661">goto</span>&nbsp;<span class="ident" id="2373666">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2373684">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2373747">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2373809">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373829">r1</span><span class="op" id="2373831">,</span>&nbsp;<span class="ident" id="2373833">_</span><span class="op" id="2373834">,</span>&nbsp;<span class="ident" id="2373836">_</span>&nbsp;<span class="op" id="2373838">=</span>&nbsp;<span class="ident" id="2373840">RawSyscall</span><span class="op" id="2373850">(</span><span class="ident" id="2373851">SYS_GETPPID</span><span class="op" id="2373862">,</span>&nbsp;<span class="num" id="2373864">0</span><span class="op" id="2373865">,</span>&nbsp;<span class="num" id="2373867">0</span><span class="op" id="2373868">,</span>&nbsp;<span class="num" id="2373870">0</span><span class="op" id="2373871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373875">if</span>&nbsp;<span class="ident" id="2373878">r1</span>&nbsp;<span class="op" id="2373881">==</span>&nbsp;<span class="num" id="2373884">1</span>&nbsp;<span class="op" id="2373886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373891">pid</span><span class="op" id="2373894">,</span>&nbsp;<span class="ident" id="2373896">_</span><span class="op" id="2373897">,</span>&nbsp;<span class="ident" id="2373899">_</span>&nbsp;<span class="op" id="2373901">:=</span>&nbsp;<span class="ident" id="2373904">RawSyscall</span><span class="op" id="2373914">(</span><span class="ident" id="2373915">SYS_GETPID</span><span class="op" id="2373925">,</span>&nbsp;<span class="num" id="2373927">0</span><span class="op" id="2373928">,</span>&nbsp;<span class="num" id="2373930">0</span><span class="op" id="2373931">,</span>&nbsp;<span class="num" id="2373933">0</span><span class="op" id="2373934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373939">_</span><span class="op" id="2373940">,</span>&nbsp;<span class="ident" id="2373942">_</span><span class="op" id="2373943">,</span>&nbsp;<span class="ident" id="2373945">err1</span>&nbsp;<span class="op" id="2373950">:=</span>&nbsp;<span class="ident" id="2373953">RawSyscall</span><span class="op" id="2373963">(</span><span class="ident" id="2373964">SYS_KILL</span><span class="op" id="2373972">,</span>&nbsp;<span class="ident" id="2373974">pid</span><span class="op" id="2373977">,</span>&nbsp;<span class="builtintype" id="2373979">uintptr</span><span class="op" id="2373986">(</span><span class="ident" id="2373987">sys</span><span class="op" id="2373990">.</span><span class="ident" id="2373991">Pdeathsig</span><span class="op" id="2374000">)</span><span class="op" id="2374001">,</span>&nbsp;<span class="num" id="2374003">0</span><span class="op" id="2374004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374009">if</span>&nbsp;<span class="ident" id="2374012">err1</span>&nbsp;<span class="op" id="2374017">!=</span>&nbsp;<span class="num" id="2374020">0</span>&nbsp;<span class="op" id="2374022">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374028">goto</span>&nbsp;<span class="ident" id="2374033">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2374058">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374091">if</span>&nbsp;<span class="ident" id="2374094">sys</span><span class="op" id="2374097">.</span><span class="ident" id="2374098">Ptrace</span>&nbsp;<span class="op" id="2374105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374109">_</span><span class="op" id="2374110">,</span>&nbsp;<span class="ident" id="2374112">_</span><span class="op" id="2374113">,</span>&nbsp;<span class="ident" id="2374115">err1</span>&nbsp;<span class="op" id="2374120">=</span>&nbsp;<span class="ident" id="2374122">RawSyscall</span><span class="op" id="2374132">(</span><span class="ident" id="2374133">SYS_PTRACE</span><span class="op" id="2374143">,</span>&nbsp;<span class="builtintype" id="2374145">uintptr</span><span class="op" id="2374152">(</span><span class="ident" id="2374153">PTRACE_TRACEME</span><span class="op" id="2374167">)</span><span class="op" id="2374168">,</span>&nbsp;<span class="num" id="2374170">0</span><span class="op" id="2374171">,</span>&nbsp;<span class="num" id="2374173">0</span><span class="op" id="2374174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374178">if</span>&nbsp;<span class="ident" id="2374181">err1</span>&nbsp;<span class="op" id="2374186">!=</span>&nbsp;<span class="num" id="2374189">0</span>&nbsp;<span class="op" id="2374191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374196">goto</span>&nbsp;<span class="ident" id="2374201">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2374221">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374236">if</span>&nbsp;<span class="ident" id="2374239">sys</span><span class="op" id="2374242">.</span><span class="ident" id="2374243">Setsid</span>&nbsp;<span class="op" id="2374250">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374254">_</span><span class="op" id="2374255">,</span>&nbsp;<span class="ident" id="2374257">_</span><span class="op" id="2374258">,</span>&nbsp;<span class="ident" id="2374260">err1</span>&nbsp;<span class="op" id="2374265">=</span>&nbsp;<span class="ident" id="2374267">RawSyscall</span><span class="op" id="2374277">(</span><span class="ident" id="2374278">SYS_SETSID</span><span class="op" id="2374288">,</span>&nbsp;<span class="num" id="2374290">0</span><span class="op" id="2374291">,</span>&nbsp;<span class="num" id="2374293">0</span><span class="op" id="2374294">,</span>&nbsp;<span class="num" id="2374296">0</span><span class="op" id="2374297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374301">if</span>&nbsp;<span class="ident" id="2374304">err1</span>&nbsp;<span class="op" id="2374309">!=</span>&nbsp;<span class="num" id="2374312">0</span>&nbsp;<span class="op" id="2374314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374319">goto</span>&nbsp;<span class="ident" id="2374324">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374340">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2374344">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374366">if</span>&nbsp;<span class="ident" id="2374369">sys</span><span class="op" id="2374372">.</span><span class="ident" id="2374373">Setpgid</span>&nbsp;<span class="op" id="2374381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374385">_</span><span class="op" id="2374386">,</span>&nbsp;<span class="ident" id="2374388">_</span><span class="op" id="2374389">,</span>&nbsp;<span class="ident" id="2374391">err1</span>&nbsp;<span class="op" id="2374396">=</span>&nbsp;<span class="ident" id="2374398">RawSyscall</span><span class="op" id="2374408">(</span><span class="ident" id="2374409">SYS_SETPGID</span><span class="op" id="2374420">,</span>&nbsp;<span class="num" id="2374422">0</span><span class="op" id="2374423">,</span>&nbsp;<span class="num" id="2374425">0</span><span class="op" id="2374426">,</span>&nbsp;<span class="num" id="2374428">0</span><span class="op" id="2374429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374433">if</span>&nbsp;<span class="ident" id="2374436">err1</span>&nbsp;<span class="op" id="2374441">!=</span>&nbsp;<span class="num" id="2374444">0</span>&nbsp;<span class="op" id="2374446">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374451">goto</span>&nbsp;<span class="ident" id="2374456">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2374476">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374487">if</span>&nbsp;<span class="ident" id="2374490">chroot</span>&nbsp;<span class="op" id="2374497">!=</span>&nbsp;<span class="ident" id="2374500">nil</span>&nbsp;<span class="op" id="2374504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374508">_</span><span class="op" id="2374509">,</span>&nbsp;<span class="ident" id="2374511">_</span><span class="op" id="2374512">,</span>&nbsp;<span class="ident" id="2374514">err1</span>&nbsp;<span class="op" id="2374519">=</span>&nbsp;<span class="ident" id="2374521">RawSyscall</span><span class="op" id="2374531">(</span><span class="ident" id="2374532">SYS_CHROOT</span><span class="op" id="2374542">,</span>&nbsp;<span class="builtintype" id="2374544">uintptr</span><span class="op" id="2374551">(</span><span class="ident" id="2374552">unsafe</span><span class="op" id="2374558">.</span><span class="ident" id="2374559">Pointer</span><span class="op" id="2374566">(</span><span class="ident" id="2374567">chroot</span><span class="op" id="2374573">)</span><span class="op" id="2374574">)</span><span class="op" id="2374575">,</span>&nbsp;<span class="num" id="2374577">0</span><span class="op" id="2374578">,</span>&nbsp;<span class="num" id="2374580">0</span><span class="op" id="2374581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374585">if</span>&nbsp;<span class="ident" id="2374588">err1</span>&nbsp;<span class="op" id="2374593">!=</span>&nbsp;<span class="num" id="2374596">0</span>&nbsp;<span class="op" id="2374598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374603">goto</span>&nbsp;<span class="ident" id="2374608">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374621">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2374628">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374648">if</span>&nbsp;<span class="ident" id="2374651">cred</span>&nbsp;<span class="op" id="2374656">:=</span>&nbsp;<span class="ident" id="2374659">sys</span><span class="op" id="2374662">.</span><span class="ident" id="2374663">Credential</span><span class="op" id="2374673">;</span>&nbsp;<span class="ident" id="2374675">cred</span>&nbsp;<span class="op" id="2374680">!=</span>&nbsp;<span class="ident" id="2374683">nil</span>&nbsp;<span class="op" id="2374687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374691">ngroups</span>&nbsp;<span class="op" id="2374699">:=</span>&nbsp;<span class="builtintype" id="2374702">uintptr</span><span class="op" id="2374709">(</span><span class="builtinfunc" id="2374710">len</span><span class="op" id="2374713">(</span><span class="ident" id="2374714">cred</span><span class="op" id="2374718">.</span><span class="ident" id="2374719">Groups</span><span class="op" id="2374725">)</span><span class="op" id="2374726">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374730">var</span>&nbsp;<span class="ident" id="2374734">groups</span>&nbsp;<span class="ident" id="2374741">unsafe</span><span class="op" id="2374747">.</span><span class="ident" id="2374748">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374758">if</span>&nbsp;<span class="ident" id="2374761">ngroups</span>&nbsp;<span class="op" id="2374769">&gt;</span>&nbsp;<span class="num" id="2374771">0</span>&nbsp;<span class="op" id="2374773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374778">groups</span>&nbsp;<span class="op" id="2374785">=</span>&nbsp;<span class="ident" id="2374787">unsafe</span><span class="op" id="2374793">.</span><span class="ident" id="2374794">Pointer</span><span class="op" id="2374801">(</span><span class="op" id="2374802">&amp;</span><span class="ident" id="2374803">cred</span><span class="op" id="2374807">.</span><span class="ident" id="2374808">Groups</span><span class="op" id="2374814">[</span><span class="num" id="2374815">0</span><span class="op" id="2374816">]</span><span class="op" id="2374817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374825">_</span><span class="op" id="2374826">,</span>&nbsp;<span class="ident" id="2374828">_</span><span class="op" id="2374829">,</span>&nbsp;<span class="ident" id="2374831">err1</span>&nbsp;<span class="op" id="2374836">=</span>&nbsp;<span class="ident" id="2374838">RawSyscall</span><span class="op" id="2374848">(</span><span class="ident" id="2374849">SYS_SETGROUPS</span><span class="op" id="2374862">,</span>&nbsp;<span class="ident" id="2374864">ngroups</span><span class="op" id="2374871">,</span>&nbsp;<span class="builtintype" id="2374873">uintptr</span><span class="op" id="2374880">(</span><span class="ident" id="2374881">groups</span><span class="op" id="2374887">)</span><span class="op" id="2374888">,</span>&nbsp;<span class="num" id="2374890">0</span><span class="op" id="2374891">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374895">if</span>&nbsp;<span class="ident" id="2374898">err1</span>&nbsp;<span class="op" id="2374903">!=</span>&nbsp;<span class="num" id="2374906">0</span>&nbsp;<span class="op" id="2374908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374913">goto</span>&nbsp;<span class="ident" id="2374918">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2374931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2374935">_</span><span class="op" id="2374936">,</span>&nbsp;<span class="ident" id="2374938">_</span><span class="op" id="2374939">,</span>&nbsp;<span class="ident" id="2374941">err1</span>&nbsp;<span class="op" id="2374946">=</span>&nbsp;<span class="ident" id="2374948">RawSyscall</span><span class="op" id="2374958">(</span><span class="ident" id="2374959">SYS_SETGID</span><span class="op" id="2374969">,</span>&nbsp;<span class="builtintype" id="2374971">uintptr</span><span class="op" id="2374978">(</span><span class="ident" id="2374979">cred</span><span class="op" id="2374983">.</span><span class="ident" id="2374984">Gid</span><span class="op" id="2374987">)</span><span class="op" id="2374988">,</span>&nbsp;<span class="num" id="2374990">0</span><span class="op" id="2374991">,</span>&nbsp;<span class="num" id="2374993">0</span><span class="op" id="2374994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2374998">if</span>&nbsp;<span class="ident" id="2375001">err1</span>&nbsp;<span class="op" id="2375006">!=</span>&nbsp;<span class="num" id="2375009">0</span>&nbsp;<span class="op" id="2375011">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375016">goto</span>&nbsp;<span class="ident" id="2375021">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375038">_</span><span class="op" id="2375039">,</span>&nbsp;<span class="ident" id="2375041">_</span><span class="op" id="2375042">,</span>&nbsp;<span class="ident" id="2375044">err1</span>&nbsp;<span class="op" id="2375049">=</span>&nbsp;<span class="ident" id="2375051">RawSyscall</span><span class="op" id="2375061">(</span><span class="ident" id="2375062">SYS_SETUID</span><span class="op" id="2375072">,</span>&nbsp;<span class="builtintype" id="2375074">uintptr</span><span class="op" id="2375081">(</span><span class="ident" id="2375082">cred</span><span class="op" id="2375086">.</span><span class="ident" id="2375087">Uid</span><span class="op" id="2375090">)</span><span class="op" id="2375091">,</span>&nbsp;<span class="num" id="2375093">0</span><span class="op" id="2375094">,</span>&nbsp;<span class="num" id="2375096">0</span><span class="op" id="2375097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375101">if</span>&nbsp;<span class="ident" id="2375104">err1</span>&nbsp;<span class="op" id="2375109">!=</span>&nbsp;<span class="num" id="2375112">0</span>&nbsp;<span class="op" id="2375114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375119">goto</span>&nbsp;<span class="ident" id="2375124">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2375144">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375154">if</span>&nbsp;<span class="ident" id="2375157">dir</span>&nbsp;<span class="op" id="2375161">!=</span>&nbsp;<span class="ident" id="2375164">nil</span>&nbsp;<span class="op" id="2375168">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375172">_</span><span class="op" id="2375173">,</span>&nbsp;<span class="ident" id="2375175">_</span><span class="op" id="2375176">,</span>&nbsp;<span class="ident" id="2375178">err1</span>&nbsp;<span class="op" id="2375183">=</span>&nbsp;<span class="ident" id="2375185">RawSyscall</span><span class="op" id="2375195">(</span><span class="ident" id="2375196">SYS_CHDIR</span><span class="op" id="2375205">,</span>&nbsp;<span class="builtintype" id="2375207">uintptr</span><span class="op" id="2375214">(</span><span class="ident" id="2375215">unsafe</span><span class="op" id="2375221">.</span><span class="ident" id="2375222">Pointer</span><span class="op" id="2375229">(</span><span class="ident" id="2375230">dir</span><span class="op" id="2375233">)</span><span class="op" id="2375234">)</span><span class="op" id="2375235">,</span>&nbsp;<span class="num" id="2375237">0</span><span class="op" id="2375238">,</span>&nbsp;<span class="num" id="2375240">0</span><span class="op" id="2375241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375245">if</span>&nbsp;<span class="ident" id="2375248">err1</span>&nbsp;<span class="op" id="2375253">!=</span>&nbsp;<span class="num" id="2375256">0</span>&nbsp;<span class="op" id="2375258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375263">goto</span>&nbsp;<span class="ident" id="2375268">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375284">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2375288">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2375351">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375407">if</span>&nbsp;<span class="ident" id="2375410">pipe</span>&nbsp;<span class="op" id="2375415">&lt;</span>&nbsp;<span class="ident" id="2375417">nextfd</span>&nbsp;<span class="op" id="2375424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375428">_</span><span class="op" id="2375429">,</span>&nbsp;<span class="ident" id="2375431">_</span><span class="op" id="2375432">,</span>&nbsp;<span class="ident" id="2375434">err1</span>&nbsp;<span class="op" id="2375439">=</span>&nbsp;<span class="ident" id="2375441">RawSyscall</span><span class="op" id="2375451">(</span><span class="ident" id="2375452">SYS_DUP2</span><span class="op" id="2375460">,</span>&nbsp;<span class="builtintype" id="2375462">uintptr</span><span class="op" id="2375469">(</span><span class="ident" id="2375470">pipe</span><span class="op" id="2375474">)</span><span class="op" id="2375475">,</span>&nbsp;<span class="builtintype" id="2375477">uintptr</span><span class="op" id="2375484">(</span><span class="ident" id="2375485">nextfd</span><span class="op" id="2375491">)</span><span class="op" id="2375492">,</span>&nbsp;<span class="num" id="2375494">0</span><span class="op" id="2375495">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375499">if</span>&nbsp;<span class="ident" id="2375502">err1</span>&nbsp;<span class="op" id="2375507">!=</span>&nbsp;<span class="num" id="2375510">0</span>&nbsp;<span class="op" id="2375512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375517">goto</span>&nbsp;<span class="ident" id="2375522">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375539">RawSyscall</span><span class="op" id="2375549">(</span><span class="ident" id="2375550">SYS_FCNTL</span><span class="op" id="2375559">,</span>&nbsp;<span class="builtintype" id="2375561">uintptr</span><span class="op" id="2375568">(</span><span class="ident" id="2375569">nextfd</span><span class="op" id="2375575">)</span><span class="op" id="2375576">,</span>&nbsp;<span class="ident" id="2375578">F_SETFD</span><span class="op" id="2375585">,</span>&nbsp;<span class="ident" id="2375587">FD_CLOEXEC</span><span class="op" id="2375597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375601">pipe</span>&nbsp;<span class="op" id="2375606">=</span>&nbsp;<span class="ident" id="2375608">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375617">nextfd</span><span class="op" id="2375623">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375630">for</span>&nbsp;<span class="ident" id="2375634">i</span>&nbsp;<span class="op" id="2375636">=</span>&nbsp;<span class="num" id="2375638">0</span><span class="op" id="2375639">;</span>&nbsp;<span class="ident" id="2375641">i</span>&nbsp;<span class="op" id="2375643">&lt;</span>&nbsp;<span class="builtinfunc" id="2375645">len</span><span class="op" id="2375648">(</span><span class="ident" id="2375649">fd</span><span class="op" id="2375651">)</span><span class="op" id="2375652">;</span>&nbsp;<span class="ident" id="2375654">i</span><span class="op" id="2375655">++</span>&nbsp;<span class="op" id="2375658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375662">if</span>&nbsp;<span class="ident" id="2375665">fd</span><span class="op" id="2375667">[</span><span class="ident" id="2375668">i</span><span class="op" id="2375669">]</span>&nbsp;<span class="op" id="2375671">&gt;=</span>&nbsp;<span class="num" id="2375674">0</span>&nbsp;<span class="op" id="2375676">&amp;&amp;</span>&nbsp;<span class="ident" id="2375679">fd</span><span class="op" id="2375681">[</span><span class="ident" id="2375682">i</span><span class="op" id="2375683">]</span>&nbsp;<span class="op" id="2375685">&lt;</span>&nbsp;<span class="builtintype" id="2375687">int</span><span class="op" id="2375690">(</span><span class="ident" id="2375691">i</span><span class="op" id="2375692">)</span>&nbsp;<span class="op" id="2375694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375699">_</span><span class="op" id="2375700">,</span>&nbsp;<span class="ident" id="2375702">_</span><span class="op" id="2375703">,</span>&nbsp;<span class="ident" id="2375705">err1</span>&nbsp;<span class="op" id="2375710">=</span>&nbsp;<span class="ident" id="2375712">RawSyscall</span><span class="op" id="2375722">(</span><span class="ident" id="2375723">SYS_DUP2</span><span class="op" id="2375731">,</span>&nbsp;<span class="builtintype" id="2375733">uintptr</span><span class="op" id="2375740">(</span><span class="ident" id="2375741">fd</span><span class="op" id="2375743">[</span><span class="ident" id="2375744">i</span><span class="op" id="2375745">]</span><span class="op" id="2375746">)</span><span class="op" id="2375747">,</span>&nbsp;<span class="builtintype" id="2375749">uintptr</span><span class="op" id="2375756">(</span><span class="ident" id="2375757">nextfd</span><span class="op" id="2375763">)</span><span class="op" id="2375764">,</span>&nbsp;<span class="num" id="2375766">0</span><span class="op" id="2375767">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375772">if</span>&nbsp;<span class="ident" id="2375775">err1</span>&nbsp;<span class="op" id="2375780">!=</span>&nbsp;<span class="num" id="2375783">0</span>&nbsp;<span class="op" id="2375785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375791">goto</span>&nbsp;<span class="ident" id="2375796">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375815">RawSyscall</span><span class="op" id="2375825">(</span><span class="ident" id="2375826">SYS_FCNTL</span><span class="op" id="2375835">,</span>&nbsp;<span class="builtintype" id="2375837">uintptr</span><span class="op" id="2375844">(</span><span class="ident" id="2375845">nextfd</span><span class="op" id="2375851">)</span><span class="op" id="2375852">,</span>&nbsp;<span class="ident" id="2375854">F_SETFD</span><span class="op" id="2375861">,</span>&nbsp;<span class="ident" id="2375863">FD_CLOEXEC</span><span class="op" id="2375873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375878">fd</span><span class="op" id="2375880">[</span><span class="ident" id="2375881">i</span><span class="op" id="2375882">]</span>&nbsp;<span class="op" id="2375884">=</span>&nbsp;<span class="ident" id="2375886">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375896">nextfd</span><span class="op" id="2375902">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375908">if</span>&nbsp;<span class="ident" id="2375911">nextfd</span>&nbsp;<span class="op" id="2375918">==</span>&nbsp;<span class="ident" id="2375921">pipe</span>&nbsp;<span class="op" id="2375926">{</span>&nbsp;<span class="comment" id="2375928">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375955">nextfd</span><span class="op" id="2375961">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375971">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2375978">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376013">for</span>&nbsp;<span class="ident" id="2376017">i</span>&nbsp;<span class="op" id="2376019">=</span>&nbsp;<span class="num" id="2376021">0</span><span class="op" id="2376022">;</span>&nbsp;<span class="ident" id="2376024">i</span>&nbsp;<span class="op" id="2376026">&lt;</span>&nbsp;<span class="builtinfunc" id="2376028">len</span><span class="op" id="2376031">(</span><span class="ident" id="2376032">fd</span><span class="op" id="2376034">)</span><span class="op" id="2376035">;</span>&nbsp;<span class="ident" id="2376037">i</span><span class="op" id="2376038">++</span>&nbsp;<span class="op" id="2376041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376045">if</span>&nbsp;<span class="ident" id="2376048">fd</span><span class="op" id="2376050">[</span><span class="ident" id="2376051">i</span><span class="op" id="2376052">]</span>&nbsp;<span class="op" id="2376054">==</span>&nbsp;<span class="op" id="2376057">-</span><span class="num" id="2376058">1</span>&nbsp;<span class="op" id="2376060">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376065">RawSyscall</span><span class="op" id="2376075">(</span><span class="ident" id="2376076">SYS_CLOSE</span><span class="op" id="2376085">,</span>&nbsp;<span class="builtintype" id="2376087">uintptr</span><span class="op" id="2376094">(</span><span class="ident" id="2376095">i</span><span class="op" id="2376096">)</span><span class="op" id="2376097">,</span>&nbsp;<span class="num" id="2376099">0</span><span class="op" id="2376100">,</span>&nbsp;<span class="num" id="2376102">0</span><span class="op" id="2376103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376108">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376123">if</span>&nbsp;<span class="ident" id="2376126">fd</span><span class="op" id="2376128">[</span><span class="ident" id="2376129">i</span><span class="op" id="2376130">]</span>&nbsp;<span class="op" id="2376132">==</span>&nbsp;<span class="builtintype" id="2376135">int</span><span class="op" id="2376138">(</span><span class="ident" id="2376139">i</span><span class="op" id="2376140">)</span>&nbsp;<span class="op" id="2376142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376147">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376205">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376242">_</span><span class="op" id="2376243">,</span>&nbsp;<span class="ident" id="2376245">_</span><span class="op" id="2376246">,</span>&nbsp;<span class="ident" id="2376248">err1</span>&nbsp;<span class="op" id="2376253">=</span>&nbsp;<span class="ident" id="2376255">RawSyscall</span><span class="op" id="2376265">(</span><span class="ident" id="2376266">SYS_FCNTL</span><span class="op" id="2376275">,</span>&nbsp;<span class="builtintype" id="2376277">uintptr</span><span class="op" id="2376284">(</span><span class="ident" id="2376285">fd</span><span class="op" id="2376287">[</span><span class="ident" id="2376288">i</span><span class="op" id="2376289">]</span><span class="op" id="2376290">)</span><span class="op" id="2376291">,</span>&nbsp;<span class="ident" id="2376293">F_SETFD</span><span class="op" id="2376300">,</span>&nbsp;<span class="num" id="2376302">0</span><span class="op" id="2376303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376308">if</span>&nbsp;<span class="ident" id="2376311">err1</span>&nbsp;<span class="op" id="2376316">!=</span>&nbsp;<span class="num" id="2376319">0</span>&nbsp;<span class="op" id="2376321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376327">goto</span>&nbsp;<span class="ident" id="2376332">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376346">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376351">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376366">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376412">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376448">_</span><span class="op" id="2376449">,</span>&nbsp;<span class="ident" id="2376451">_</span><span class="op" id="2376452">,</span>&nbsp;<span class="ident" id="2376454">err1</span>&nbsp;<span class="op" id="2376459">=</span>&nbsp;<span class="ident" id="2376461">RawSyscall</span><span class="op" id="2376471">(</span><span class="ident" id="2376472">SYS_DUP2</span><span class="op" id="2376480">,</span>&nbsp;<span class="builtintype" id="2376482">uintptr</span><span class="op" id="2376489">(</span><span class="ident" id="2376490">fd</span><span class="op" id="2376492">[</span><span class="ident" id="2376493">i</span><span class="op" id="2376494">]</span><span class="op" id="2376495">)</span><span class="op" id="2376496">,</span>&nbsp;<span class="builtintype" id="2376498">uintptr</span><span class="op" id="2376505">(</span><span class="ident" id="2376506">i</span><span class="op" id="2376507">)</span><span class="op" id="2376508">,</span>&nbsp;<span class="num" id="2376510">0</span><span class="op" id="2376511">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376515">if</span>&nbsp;<span class="ident" id="2376518">err1</span>&nbsp;<span class="op" id="2376523">!=</span>&nbsp;<span class="num" id="2376526">0</span>&nbsp;<span class="op" id="2376528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376533">goto</span>&nbsp;<span class="ident" id="2376538">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376558">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376615">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376677">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376732">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376763">for</span>&nbsp;<span class="ident" id="2376767">i</span>&nbsp;<span class="op" id="2376769">=</span>&nbsp;<span class="builtinfunc" id="2376771">len</span><span class="op" id="2376774">(</span><span class="ident" id="2376775">fd</span><span class="op" id="2376777">)</span><span class="op" id="2376778">;</span>&nbsp;<span class="ident" id="2376780">i</span>&nbsp;<span class="op" id="2376782">&lt;</span>&nbsp;<span class="num" id="2376784">3</span><span class="op" id="2376785">;</span>&nbsp;<span class="ident" id="2376787">i</span><span class="op" id="2376788">++</span>&nbsp;<span class="op" id="2376791">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376795">RawSyscall</span><span class="op" id="2376805">(</span><span class="ident" id="2376806">SYS_CLOSE</span><span class="op" id="2376815">,</span>&nbsp;<span class="builtintype" id="2376817">uintptr</span><span class="op" id="2376824">(</span><span class="ident" id="2376825">i</span><span class="op" id="2376826">)</span><span class="op" id="2376827">,</span>&nbsp;<span class="num" id="2376829">0</span><span class="op" id="2376830">,</span>&nbsp;<span class="num" id="2376832">0</span><span class="op" id="2376833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376840">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376865">if</span>&nbsp;<span class="ident" id="2376868">sys</span><span class="op" id="2376871">.</span><span class="ident" id="2376872">Noctty</span>&nbsp;<span class="op" id="2376879">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376883">_</span><span class="op" id="2376884">,</span>&nbsp;<span class="ident" id="2376886">_</span><span class="op" id="2376887">,</span>&nbsp;<span class="ident" id="2376889">err1</span>&nbsp;<span class="op" id="2376894">=</span>&nbsp;<span class="ident" id="2376896">RawSyscall</span><span class="op" id="2376906">(</span><span class="ident" id="2376907">SYS_IOCTL</span><span class="op" id="2376916">,</span>&nbsp;<span class="num" id="2376918">0</span><span class="op" id="2376919">,</span>&nbsp;<span class="builtintype" id="2376921">uintptr</span><span class="op" id="2376928">(</span><span class="ident" id="2376929">TIOCNOTTY</span><span class="op" id="2376938">)</span><span class="op" id="2376939">,</span>&nbsp;<span class="num" id="2376941">0</span><span class="op" id="2376942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376946">if</span>&nbsp;<span class="ident" id="2376949">err1</span>&nbsp;<span class="op" id="2376954">!=</span>&nbsp;<span class="num" id="2376957">0</span>&nbsp;<span class="op" id="2376959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376964">goto</span>&nbsp;<span class="ident" id="2376969">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376985">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376989">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377025">if</span>&nbsp;<span class="ident" id="2377028">sys</span><span class="op" id="2377031">.</span><span class="ident" id="2377032">Setctty</span>&nbsp;<span class="op" id="2377040">&amp;&amp;</span>&nbsp;<span class="ident" id="2377043">sys</span><span class="op" id="2377046">.</span><span class="ident" id="2377047">Ctty</span>&nbsp;<span class="op" id="2377052">&gt;=</span>&nbsp;<span class="num" id="2377055">0</span>&nbsp;<span class="op" id="2377057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377061">_</span><span class="op" id="2377062">,</span>&nbsp;<span class="ident" id="2377064">_</span><span class="op" id="2377065">,</span>&nbsp;<span class="ident" id="2377067">err1</span>&nbsp;<span class="op" id="2377072">=</span>&nbsp;<span class="ident" id="2377074">RawSyscall</span><span class="op" id="2377084">(</span><span class="ident" id="2377085">SYS_IOCTL</span><span class="op" id="2377094">,</span>&nbsp;<span class="builtintype" id="2377096">uintptr</span><span class="op" id="2377103">(</span><span class="ident" id="2377104">sys</span><span class="op" id="2377107">.</span><span class="ident" id="2377108">Ctty</span><span class="op" id="2377112">)</span><span class="op" id="2377113">,</span>&nbsp;<span class="builtintype" id="2377115">uintptr</span><span class="op" id="2377122">(</span><span class="ident" id="2377123">TIOCSCTTY</span><span class="op" id="2377132">)</span><span class="op" id="2377133">,</span>&nbsp;<span class="num" id="2377135">0</span><span class="op" id="2377136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377140">if</span>&nbsp;<span class="ident" id="2377143">err1</span>&nbsp;<span class="op" id="2377148">!=</span>&nbsp;<span class="num" id="2377151">0</span>&nbsp;<span class="op" id="2377153">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377158">goto</span>&nbsp;<span class="ident" id="2377163">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377183">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377201">_</span><span class="op" id="2377202">,</span>&nbsp;<span class="ident" id="2377204">_</span><span class="op" id="2377205">,</span>&nbsp;<span class="ident" id="2377207">err1</span>&nbsp;<span class="op" id="2377212">=</span>&nbsp;<span class="ident" id="2377214">RawSyscall</span><span class="op" id="2377224">(</span><span class="ident" id="2377225">SYS_EXECVE</span><span class="op" id="2377235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2377239">uintptr</span><span class="op" id="2377246">(</span><span class="ident" id="2377247">unsafe</span><span class="op" id="2377253">.</span><span class="ident" id="2377254">Pointer</span><span class="op" id="2377261">(</span><span class="ident" id="2377262">argv0</span><span class="op" id="2377267">)</span><span class="op" id="2377268">)</span><span class="op" id="2377269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2377273">uintptr</span><span class="op" id="2377280">(</span><span class="ident" id="2377281">unsafe</span><span class="op" id="2377287">.</span><span class="ident" id="2377288">Pointer</span><span class="op" id="2377295">(</span><span class="op" id="2377296">&amp;</span><span class="ident" id="2377297">argv</span><span class="op" id="2377301">[</span><span class="num" id="2377302">0</span><span class="op" id="2377303">]</span><span class="op" id="2377304">)</span><span class="op" id="2377305">)</span><span class="op" id="2377306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2377310">uintptr</span><span class="op" id="2377317">(</span><span class="ident" id="2377318">unsafe</span><span class="op" id="2377324">.</span><span class="ident" id="2377325">Pointer</span><span class="op" id="2377332">(</span><span class="op" id="2377333">&amp;</span><span class="ident" id="2377334">envv</span><span class="op" id="2377338">[</span><span class="num" id="2377339">0</span><span class="op" id="2377340">]</span><span class="op" id="2377341">)</span><span class="op" id="2377342">)</span><span class="op" id="2377343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2377346">childerror</span><span class="op" id="2377356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377359">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377387">RawSyscall</span><span class="op" id="2377397">(</span><span class="ident" id="2377398">SYS_WRITE</span><span class="op" id="2377407">,</span>&nbsp;<span class="builtintype" id="2377409">uintptr</span><span class="op" id="2377416">(</span><span class="ident" id="2377417">pipe</span><span class="op" id="2377421">)</span><span class="op" id="2377422">,</span>&nbsp;<span class="builtintype" id="2377424">uintptr</span><span class="op" id="2377431">(</span><span class="ident" id="2377432">unsafe</span><span class="op" id="2377438">.</span><span class="ident" id="2377439">Pointer</span><span class="op" id="2377446">(</span><span class="op" id="2377447">&amp;</span><span class="ident" id="2377448">err1</span><span class="op" id="2377452">)</span><span class="op" id="2377453">)</span><span class="op" id="2377454">,</span>&nbsp;<span class="ident" id="2377456">unsafe</span><span class="op" id="2377462">.</span><span class="ident" id="2377463">Sizeof</span><span class="op" id="2377469">(</span><span class="ident" id="2377470">err1</span><span class="op" id="2377474">)</span><span class="op" id="2377475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377478">for</span>&nbsp;<span class="op" id="2377482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377486">RawSyscall</span><span class="op" id="2377496">(</span><span class="ident" id="2377497">SYS_EXIT</span><span class="op" id="2377505">,</span>&nbsp;<span class="num" id="2377507">253</span><span class="op" id="2377510">,</span>&nbsp;<span class="num" id="2377512">0</span><span class="op" id="2377513">,</span>&nbsp;<span class="num" id="2377515">0</span><span class="op" id="2377516">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377519">}</span><br>
<span class="lineno"></span><span class="op" id="2377521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2377524">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2377591">func</span>&nbsp;<span class="ident" id="2377596">forkExecPipe</span><span class="op" id="2377608">(</span><span class="ident" id="2377609">p</span>&nbsp;<span class="op" id="2377611">[</span><span class="op" id="2377612">]</span><span class="builtintype" id="2377613">int</span><span class="op" id="2377616">)</span>&nbsp;<span class="op" id="2377618">(</span><span class="ident" id="2377619">err</span>&nbsp;<span class="builtintype" id="2377623">error</span><span class="op" id="2377628">)</span>&nbsp;<span class="op" id="2377630">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377633">err</span>&nbsp;<span class="op" id="2377637">=</span>&nbsp;<span class="ident" id="2377639">Pipe2</span><span class="op" id="2377644">(</span><span class="ident" id="2377645">p</span><span class="op" id="2377646">,</span>&nbsp;<span class="ident" id="2377648">O_CLOEXEC</span><span class="op" id="2377657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377660">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377735">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377765">if</span>&nbsp;<span class="ident" id="2377768">err</span>&nbsp;<span class="op" id="2377772">==</span>&nbsp;<span class="ident" id="2377775">ENOSYS</span>&nbsp;<span class="op" id="2377782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377786">if</span>&nbsp;<span class="ident" id="2377789">err</span>&nbsp;<span class="op" id="2377793">=</span>&nbsp;<span class="ident" id="2377795">Pipe</span><span class="op" id="2377799">(</span><span class="ident" id="2377800">p</span><span class="op" id="2377801">)</span><span class="op" id="2377802">;</span>&nbsp;<span class="ident" id="2377804">err</span>&nbsp;<span class="op" id="2377808">!=</span>&nbsp;<span class="ident" id="2377811">nil</span>&nbsp;<span class="op" id="2377815">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377820">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377833">if</span>&nbsp;<span class="ident" id="2377836">_</span><span class="op" id="2377837">,</span>&nbsp;<span class="ident" id="2377839">err</span>&nbsp;<span class="op" id="2377843">=</span>&nbsp;<span class="ident" id="2377845">fcntl</span><span class="op" id="2377850">(</span><span class="ident" id="2377851">p</span><span class="op" id="2377852">[</span><span class="num" id="2377853">0</span><span class="op" id="2377854">]</span><span class="op" id="2377855">,</span>&nbsp;<span class="ident" id="2377857">F_SETFD</span><span class="op" id="2377864">,</span>&nbsp;<span class="ident" id="2377866">FD_CLOEXEC</span><span class="op" id="2377876">)</span><span class="op" id="2377877">;</span>&nbsp;<span class="ident" id="2377879">err</span>&nbsp;<span class="op" id="2377883">!=</span>&nbsp;<span class="ident" id="2377886">nil</span>&nbsp;<span class="op" id="2377890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377895">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377904">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377908">_</span><span class="op" id="2377909">,</span>&nbsp;<span class="ident" id="2377911">err</span>&nbsp;<span class="op" id="2377915">=</span>&nbsp;<span class="ident" id="2377917">fcntl</span><span class="op" id="2377922">(</span><span class="ident" id="2377923">p</span><span class="op" id="2377924">[</span><span class="num" id="2377925">1</span><span class="op" id="2377926">]</span><span class="op" id="2377927">,</span>&nbsp;<span class="ident" id="2377929">F_SETFD</span><span class="op" id="2377936">,</span>&nbsp;<span class="ident" id="2377938">FD_CLOEXEC</span><span class="op" id="2377948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377954">return</span><br>
<span class="lineno"></span><span class="op" id="2377961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2377964">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2378061">func</span>&nbsp;<span class="ident" id="2378066">writeIDMappings</span><span class="op" id="2378081">(</span><span class="ident" id="2378082">path</span>&nbsp;<span class="builtintype" id="2378087">string</span><span class="op" id="2378093">,</span>&nbsp;<span class="ident" id="2378095">idMap</span>&nbsp;<span class="op" id="2378101">[</span><span class="op" id="2378102">]</span><span class="ident" id="2378103">SysProcIDMap</span><span class="op" id="2378115">)</span>&nbsp;<span class="builtintype" id="2378117">error</span>&nbsp;<span class="op" id="2378123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378126">fd</span><span class="op" id="2378128">,</span>&nbsp;<span class="ident" id="2378130">err</span>&nbsp;<span class="op" id="2378134">:=</span>&nbsp;<span class="ident" id="2378137">Open</span><span class="op" id="2378141">(</span><span class="ident" id="2378142">path</span><span class="op" id="2378146">,</span>&nbsp;<span class="ident" id="2378148">O_RDWR</span><span class="op" id="2378154">,</span>&nbsp;<span class="num" id="2378156">0</span><span class="op" id="2378157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378160">if</span>&nbsp;<span class="ident" id="2378163">err</span>&nbsp;<span class="op" id="2378167">!=</span>&nbsp;<span class="ident" id="2378170">nil</span>&nbsp;<span class="op" id="2378174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378178">return</span>&nbsp;<span class="ident" id="2378185">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378194">data</span>&nbsp;<span class="op" id="2378199">:=</span>&nbsp;<span class="string" id="2378202">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378206">for</span>&nbsp;<span class="ident" id="2378210">_</span><span class="op" id="2378211">,</span>&nbsp;<span class="ident" id="2378213">im</span>&nbsp;<span class="op" id="2378216">:=</span>&nbsp;<span class="keyword" id="2378219">range</span>&nbsp;<span class="ident" id="2378225">idMap</span>&nbsp;<span class="op" id="2378231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378235">data</span>&nbsp;<span class="op" id="2378240">=</span>&nbsp;<span class="ident" id="2378242">data</span>&nbsp;<span class="op" id="2378247">+</span>&nbsp;<span class="ident" id="2378249">itoa</span><span class="op" id="2378253">(</span><span class="ident" id="2378254">im</span><span class="op" id="2378256">.</span><span class="ident" id="2378257">ContainerID</span><span class="op" id="2378268">)</span>&nbsp;<span class="op" id="2378270">+</span>&nbsp;<span class="string" id="2378272">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2378276">+</span>&nbsp;<span class="ident" id="2378278">itoa</span><span class="op" id="2378282">(</span><span class="ident" id="2378283">im</span><span class="op" id="2378285">.</span><span class="ident" id="2378286">HostID</span><span class="op" id="2378292">)</span>&nbsp;<span class="op" id="2378294">+</span>&nbsp;<span class="string" id="2378296">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2378300">+</span>&nbsp;<span class="ident" id="2378302">itoa</span><span class="op" id="2378306">(</span><span class="ident" id="2378307">im</span><span class="op" id="2378309">.</span><span class="ident" id="2378310">Size</span><span class="op" id="2378314">)</span>&nbsp;<span class="op" id="2378316">+</span>&nbsp;<span class="string" id="2378318">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378328">bytes</span><span class="op" id="2378333">,</span>&nbsp;<span class="ident" id="2378335">err</span>&nbsp;<span class="op" id="2378339">:=</span>&nbsp;<span class="ident" id="2378342">ByteSliceFromString</span><span class="op" id="2378361">(</span><span class="ident" id="2378362">data</span><span class="op" id="2378366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378369">if</span>&nbsp;<span class="ident" id="2378372">err</span>&nbsp;<span class="op" id="2378376">!=</span>&nbsp;<span class="ident" id="2378379">nil</span>&nbsp;<span class="op" id="2378383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378387">Close</span><span class="op" id="2378392">(</span><span class="ident" id="2378393">fd</span><span class="op" id="2378395">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378399">return</span>&nbsp;<span class="ident" id="2378406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378415">if</span>&nbsp;<span class="ident" id="2378418">_</span><span class="op" id="2378419">,</span>&nbsp;<span class="ident" id="2378421">err</span>&nbsp;<span class="op" id="2378425">:=</span>&nbsp;<span class="ident" id="2378428">Write</span><span class="op" id="2378433">(</span><span class="ident" id="2378434">fd</span><span class="op" id="2378436">,</span>&nbsp;<span class="ident" id="2378438">bytes</span><span class="op" id="2378443">)</span><span class="op" id="2378444">;</span>&nbsp;<span class="ident" id="2378446">err</span>&nbsp;<span class="op" id="2378450">!=</span>&nbsp;<span class="ident" id="2378453">nil</span>&nbsp;<span class="op" id="2378457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378461">Close</span><span class="op" id="2378466">(</span><span class="ident" id="2378467">fd</span><span class="op" id="2378469">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378473">return</span>&nbsp;<span class="ident" id="2378480">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378489">if</span>&nbsp;<span class="ident" id="2378492">err</span>&nbsp;<span class="op" id="2378496">:=</span>&nbsp;<span class="ident" id="2378499">Close</span><span class="op" id="2378504">(</span><span class="ident" id="2378505">fd</span><span class="op" id="2378507">)</span><span class="op" id="2378508">;</span>&nbsp;<span class="ident" id="2378510">err</span>&nbsp;<span class="op" id="2378514">!=</span>&nbsp;<span class="ident" id="2378517">nil</span>&nbsp;<span class="op" id="2378521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378525">return</span>&nbsp;<span class="ident" id="2378532">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378541">return</span>&nbsp;<span class="ident" id="2378548">nil</span><br>
<span class="lineno"></span><span class="op" id="2378552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2378555">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2378635">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2378694">func</span>&nbsp;<span class="ident" id="2378699">writeUidGidMappings</span><span class="op" id="2378718">(</span><span class="ident" id="2378719">pid</span>&nbsp;<span class="builtintype" id="2378723">int</span><span class="op" id="2378726">,</span>&nbsp;<span class="ident" id="2378728">sys</span>&nbsp;<span class="op" id="2378732">*</span><span class="ident" id="2378733">SysProcAttr</span><span class="op" id="2378744">)</span>&nbsp;<span class="builtintype" id="2378746">error</span>&nbsp;<span class="op" id="2378752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378755">if</span>&nbsp;<span class="ident" id="2378758">sys</span><span class="op" id="2378761">.</span><span class="ident" id="2378762">UidMappings</span>&nbsp;<span class="op" id="2378774">!=</span>&nbsp;<span class="ident" id="2378777">nil</span>&nbsp;<span class="op" id="2378781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378785">uidf</span>&nbsp;<span class="op" id="2378790">:=</span>&nbsp;<span class="string" id="2378793">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2378802">+</span>&nbsp;<span class="ident" id="2378804">itoa</span><span class="op" id="2378808">(</span><span class="ident" id="2378809">pid</span><span class="op" id="2378812">)</span>&nbsp;<span class="op" id="2378814">+</span>&nbsp;<span class="string" id="2378816">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378829">if</span>&nbsp;<span class="ident" id="2378832">err</span>&nbsp;<span class="op" id="2378836">:=</span>&nbsp;<span class="ident" id="2378839">writeIDMappings</span><span class="op" id="2378854">(</span><span class="ident" id="2378855">uidf</span><span class="op" id="2378859">,</span>&nbsp;<span class="ident" id="2378861">sys</span><span class="op" id="2378864">.</span><span class="ident" id="2378865">UidMappings</span><span class="op" id="2378876">)</span><span class="op" id="2378877">;</span>&nbsp;<span class="ident" id="2378879">err</span>&nbsp;<span class="op" id="2378883">!=</span>&nbsp;<span class="ident" id="2378886">nil</span>&nbsp;<span class="op" id="2378890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378895">return</span>&nbsp;<span class="ident" id="2378902">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378915">if</span>&nbsp;<span class="ident" id="2378918">sys</span><span class="op" id="2378921">.</span><span class="ident" id="2378922">GidMappings</span>&nbsp;<span class="op" id="2378934">!=</span>&nbsp;<span class="ident" id="2378937">nil</span>&nbsp;<span class="op" id="2378941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378945">gidf</span>&nbsp;<span class="op" id="2378950">:=</span>&nbsp;<span class="string" id="2378953">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2378962">+</span>&nbsp;<span class="ident" id="2378964">itoa</span><span class="op" id="2378968">(</span><span class="ident" id="2378969">pid</span><span class="op" id="2378972">)</span>&nbsp;<span class="op" id="2378974">+</span>&nbsp;<span class="string" id="2378976">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378989">if</span>&nbsp;<span class="ident" id="2378992">err</span>&nbsp;<span class="op" id="2378996">:=</span>&nbsp;<span class="ident" id="2378999">writeIDMappings</span><span class="op" id="2379014">(</span><span class="ident" id="2379015">gidf</span><span class="op" id="2379019">,</span>&nbsp;<span class="ident" id="2379021">sys</span><span class="op" id="2379024">.</span><span class="ident" id="2379025">GidMappings</span><span class="op" id="2379036">)</span><span class="op" id="2379037">;</span>&nbsp;<span class="ident" id="2379039">err</span>&nbsp;<span class="op" id="2379043">!=</span>&nbsp;<span class="ident" id="2379046">nil</span>&nbsp;<span class="op" id="2379050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379055">return</span>&nbsp;<span class="ident" id="2379062">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379068">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379075">return</span>&nbsp;<span class="ident" id="2379082">nil</span><br>
<span class="lineno"></span><span class="op" id="2379086">}</span>
</div>
</body>
</html>
