<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1584508">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1584563">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1584617">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1584668">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1584689">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1584746">package</span>&nbsp;<span class="ident" id="1584754">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1584763">import</span>&nbsp;<span class="op" id="1584770">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1584773">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1584782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584785">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1584860">var</span>&nbsp;<span class="ident" id="1584864">proflock</span>&nbsp;<span class="ident" id="1584873">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584880">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1584959">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1585033">const</span>&nbsp;<span class="op" id="1585039">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585042">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585060">memProfile</span>&nbsp;<span class="ident" id="1585071">bucketType</span>&nbsp;<span class="op" id="1585082">=</span>&nbsp;<span class="num" id="1585084">1</span>&nbsp;<span class="op" id="1585086">+</span>&nbsp;<span class="ident" id="1585088">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585094">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585109">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585139">buckHashSize</span>&nbsp;<span class="op" id="1585152">=</span>&nbsp;<span class="num" id="1585154">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585163">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585206">maxStack</span>&nbsp;<span class="op" id="1585215">=</span>&nbsp;<span class="num" id="1585217">32</span><br>
<span class="lineno">30</span><span class="op" id="1585220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1585223">type</span>&nbsp;<span class="ident" id="1585228">bucketType</span>&nbsp;<span class="builtintype" id="1585239">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585244">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1585300">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1585357">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1585417">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1585473">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1585519">//</span><br>
<span class="lineno">40</span><span class="comment" id="1585522">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1585563">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1585626">type</span>&nbsp;<span class="ident" id="1585631">bucket</span>&nbsp;<span class="keyword" id="1585638">struct</span>&nbsp;<span class="op" id="1585645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585648">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585656">*</span><span class="ident" id="1585657">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585665">allnext</span>&nbsp;<span class="op" id="1585673">*</span><span class="ident" id="1585674">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585682">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585690">bucketType</span>&nbsp;<span class="comment" id="1585701">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585730">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1585738">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585747">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1585755">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1585764">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1585772">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1585780">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1585783">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1585850">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1585881">type</span>&nbsp;<span class="ident" id="1585886">memRecord</span>&nbsp;<span class="keyword" id="1585896">struct</span>&nbsp;<span class="op" id="1585903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585906">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585969">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586037">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586065">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586128">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586196">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586256">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586260">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586303">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586353">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586395">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586448">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586492">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586504">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586513">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586525">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586534">alloc_bytes</span>&nbsp;<span class="builtintype" id="1586546">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586555">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1586567">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586577">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586625">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586642">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586651">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586668">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586677">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1586694">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586703">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1586720">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1586730">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586756">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586775">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586784">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1586803">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586812">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1586831">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1586840">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1586859">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1586867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586870">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1586941">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1586974">type</span>&nbsp;<span class="ident" id="1586979">blockRecord</span>&nbsp;<span class="keyword" id="1586991">struct</span>&nbsp;<span class="op" id="1586998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587001">count</span>&nbsp;&nbsp;<span class="ident" id="1587008">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587015">cycles</span>&nbsp;<span class="ident" id="1587022">int64</span><br>
<span class="lineno"></span><span class="op" id="1587028">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1587031">var</span>&nbsp;<span class="op" id="1587035">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587038">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1587048">*</span><span class="ident" id="1587049">bucket</span>&nbsp;<span class="comment" id="1587056">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587083">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1587093">*</span><span class="ident" id="1587094">bucket</span>&nbsp;<span class="comment" id="1587101">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587130">buckhash</span>&nbsp;&nbsp;<span class="op" id="1587140">*</span><span class="op" id="1587141">[</span><span class="num" id="1587142">179999</span><span class="op" id="1587148">]</span><span class="op" id="1587149">*</span><span class="ident" id="1587150">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587158">bucketmem</span>&nbsp;<span class="builtintype" id="1587168">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1587176">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587179">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1587260">func</span>&nbsp;<span class="ident" id="1587265">newBucket</span><span class="op" id="1587274">(</span><span class="ident" id="1587275">typ</span>&nbsp;<span class="ident" id="1587279">bucketType</span><span class="op" id="1587289">,</span>&nbsp;<span class="ident" id="1587291">nstk</span>&nbsp;<span class="builtintype" id="1587296">int</span><span class="op" id="1587299">)</span>&nbsp;<span class="op" id="1587301">*</span><span class="ident" id="1587302">bucket</span>&nbsp;<span class="op" id="1587309">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587312">size</span>&nbsp;<span class="op" id="1587317">:=</span>&nbsp;<span class="ident" id="1587320">unsafe</span><span class="op" id="1587326">.</span><span class="ident" id="1587327">Sizeof</span><span class="op" id="1587333">(</span><span class="ident" id="1587334">bucket</span><span class="op" id="1587340">{</span><span class="op" id="1587341">}</span><span class="op" id="1587342">)</span>&nbsp;<span class="op" id="1587344">+</span>&nbsp;<span class="builtintype" id="1587346">uintptr</span><span class="op" id="1587353">(</span><span class="ident" id="1587354">nstk</span><span class="op" id="1587358">)</span><span class="op" id="1587359">*</span><span class="ident" id="1587360">unsafe</span><span class="op" id="1587366">.</span><span class="ident" id="1587367">Sizeof</span><span class="op" id="1587373">(</span><span class="builtintype" id="1587374">uintptr</span><span class="op" id="1587381">(</span><span class="num" id="1587382">0</span><span class="op" id="1587383">)</span><span class="op" id="1587384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587387">switch</span>&nbsp;<span class="ident" id="1587394">typ</span>&nbsp;<span class="op" id="1587398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587401">default</span><span class="op" id="1587408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587412">gothrow</span><span class="op" id="1587419">(</span><span class="string" id="1587420">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1587449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587452">case</span>&nbsp;<span class="ident" id="1587457">memProfile</span><span class="op" id="1587467">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587471">size</span>&nbsp;<span class="op" id="1587476">+=</span>&nbsp;<span class="ident" id="1587479">unsafe</span><span class="op" id="1587485">.</span><span class="ident" id="1587486">Sizeof</span><span class="op" id="1587492">(</span><span class="ident" id="1587493">memRecord</span><span class="op" id="1587502">{</span><span class="op" id="1587503">}</span><span class="op" id="1587504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587507">case</span>&nbsp;<span class="ident" id="1587512">blockProfile</span><span class="op" id="1587524">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587528">size</span>&nbsp;<span class="op" id="1587533">+=</span>&nbsp;<span class="ident" id="1587536">unsafe</span><span class="op" id="1587542">.</span><span class="ident" id="1587543">Sizeof</span><span class="op" id="1587549">(</span><span class="ident" id="1587550">blockRecord</span><span class="op" id="1587561">{</span><span class="op" id="1587562">}</span><span class="op" id="1587563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1587566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587570">b</span>&nbsp;<span class="op" id="1587572">:=</span>&nbsp;<span class="op" id="1587575">(</span><span class="op" id="1587576">*</span><span class="ident" id="1587577">bucket</span><span class="op" id="1587583">)</span><span class="op" id="1587584">(</span><span class="ident" id="1587585">persistentalloc</span><span class="op" id="1587600">(</span><span class="ident" id="1587601">size</span><span class="op" id="1587605">,</span>&nbsp;<span class="num" id="1587607">0</span><span class="op" id="1587608">,</span>&nbsp;<span class="op" id="1587610">&amp;</span><span class="ident" id="1587611">memstats</span><span class="op" id="1587619">.</span><span class="ident" id="1587620">buckhash_sys</span><span class="op" id="1587632">)</span><span class="op" id="1587633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587636">bucketmem</span>&nbsp;<span class="op" id="1587646">+=</span>&nbsp;<span class="ident" id="1587649">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587655">b</span><span class="op" id="1587656">.</span><span class="ident" id="1587657">typ</span>&nbsp;<span class="op" id="1587661">=</span>&nbsp;<span class="ident" id="1587663">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587668">b</span><span class="op" id="1587669">.</span><span class="ident" id="1587670">nstk</span>&nbsp;<span class="op" id="1587675">=</span>&nbsp;<span class="builtintype" id="1587677">uintptr</span><span class="op" id="1587684">(</span><span class="ident" id="1587685">nstk</span><span class="op" id="1587689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587692">return</span>&nbsp;<span class="ident" id="1587699">b</span><br>
<span class="lineno">115</span><span class="op" id="1587701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587704">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1587753">func</span>&nbsp;<span class="op" id="1587758">(</span><span class="ident" id="1587759">b</span>&nbsp;<span class="op" id="1587761">*</span><span class="ident" id="1587762">bucket</span><span class="op" id="1587768">)</span>&nbsp;<span class="ident" id="1587770">stk</span><span class="op" id="1587773">(</span><span class="op" id="1587774">)</span>&nbsp;<span class="op" id="1587776">[</span><span class="op" id="1587777">]</span><span class="builtintype" id="1587778">uintptr</span>&nbsp;<span class="op" id="1587786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1587789">stk</span>&nbsp;<span class="op" id="1587793">:=</span>&nbsp;<span class="op" id="1587796">(</span><span class="op" id="1587797">*</span><span class="op" id="1587798">[</span><span class="ident" id="1587799">maxStack</span><span class="op" id="1587807">]</span><span class="builtintype" id="1587808">uintptr</span><span class="op" id="1587815">)</span><span class="op" id="1587816">(</span><span class="ident" id="1587817">add</span><span class="op" id="1587820">(</span><span class="ident" id="1587821">unsafe</span><span class="op" id="1587827">.</span><span class="ident" id="1587828">Pointer</span><span class="op" id="1587835">(</span><span class="ident" id="1587836">b</span><span class="op" id="1587837">)</span><span class="op" id="1587838">,</span>&nbsp;<span class="ident" id="1587840">unsafe</span><span class="op" id="1587846">.</span><span class="ident" id="1587847">Sizeof</span><span class="op" id="1587853">(</span><span class="op" id="1587854">*</span><span class="ident" id="1587855">b</span><span class="op" id="1587856">)</span><span class="op" id="1587857">)</span><span class="op" id="1587858">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587861">return</span>&nbsp;<span class="ident" id="1587868">stk</span><span class="op" id="1587871">[</span><span class="op" id="1587872">:</span><span class="ident" id="1587873">b</span><span class="op" id="1587874">.</span><span class="ident" id="1587875">nstk</span><span class="op" id="1587879">:</span><span class="ident" id="1587880">b</span><span class="op" id="1587881">.</span><span class="ident" id="1587882">nstk</span><span class="op" id="1587886">]</span><br>
<span class="lineno"></span><span class="op" id="1587888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587891">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1587960">func</span>&nbsp;<span class="op" id="1587965">(</span><span class="ident" id="1587966">b</span>&nbsp;<span class="op" id="1587968">*</span><span class="ident" id="1587969">bucket</span><span class="op" id="1587975">)</span>&nbsp;<span class="ident" id="1587977">mp</span><span class="op" id="1587979">(</span><span class="op" id="1587980">)</span>&nbsp;<span class="op" id="1587982">*</span><span class="ident" id="1587983">memRecord</span>&nbsp;<span class="op" id="1587993">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1587996">if</span>&nbsp;<span class="ident" id="1587999">b</span><span class="op" id="1588000">.</span><span class="ident" id="1588001">typ</span>&nbsp;<span class="op" id="1588005">!=</span>&nbsp;<span class="ident" id="1588008">memProfile</span>&nbsp;<span class="op" id="1588019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588023">gothrow</span><span class="op" id="1588030">(</span><span class="string" id="1588031">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1588053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588059">data</span>&nbsp;<span class="op" id="1588064">:=</span>&nbsp;<span class="ident" id="1588067">add</span><span class="op" id="1588070">(</span><span class="ident" id="1588071">unsafe</span><span class="op" id="1588077">.</span><span class="ident" id="1588078">Pointer</span><span class="op" id="1588085">(</span><span class="ident" id="1588086">b</span><span class="op" id="1588087">)</span><span class="op" id="1588088">,</span>&nbsp;<span class="ident" id="1588090">unsafe</span><span class="op" id="1588096">.</span><span class="ident" id="1588097">Sizeof</span><span class="op" id="1588103">(</span><span class="op" id="1588104">*</span><span class="ident" id="1588105">b</span><span class="op" id="1588106">)</span><span class="op" id="1588107">+</span><span class="ident" id="1588108">b</span><span class="op" id="1588109">.</span><span class="ident" id="1588110">nstk</span><span class="op" id="1588114">*</span><span class="ident" id="1588115">unsafe</span><span class="op" id="1588121">.</span><span class="ident" id="1588122">Sizeof</span><span class="op" id="1588128">(</span><span class="builtintype" id="1588129">uintptr</span><span class="op" id="1588136">(</span><span class="num" id="1588137">0</span><span class="op" id="1588138">)</span><span class="op" id="1588139">)</span><span class="op" id="1588140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588143">return</span>&nbsp;<span class="op" id="1588150">(</span><span class="op" id="1588151">*</span><span class="ident" id="1588152">memRecord</span><span class="op" id="1588161">)</span><span class="op" id="1588162">(</span><span class="ident" id="1588163">data</span><span class="op" id="1588167">)</span><br>
<span class="lineno">130</span><span class="op" id="1588169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588172">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1588245">func</span>&nbsp;<span class="op" id="1588250">(</span><span class="ident" id="1588251">b</span>&nbsp;<span class="op" id="1588253">*</span><span class="ident" id="1588254">bucket</span><span class="op" id="1588260">)</span>&nbsp;<span class="ident" id="1588262">bp</span><span class="op" id="1588264">(</span><span class="op" id="1588265">)</span>&nbsp;<span class="op" id="1588267">*</span><span class="ident" id="1588268">blockRecord</span>&nbsp;<span class="op" id="1588280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588283">if</span>&nbsp;<span class="ident" id="1588286">b</span><span class="op" id="1588287">.</span><span class="ident" id="1588288">typ</span>&nbsp;<span class="op" id="1588292">!=</span>&nbsp;<span class="ident" id="1588295">blockProfile</span>&nbsp;<span class="op" id="1588308">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588312">gothrow</span><span class="op" id="1588319">(</span><span class="string" id="1588320">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1588342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588348">data</span>&nbsp;<span class="op" id="1588353">:=</span>&nbsp;<span class="ident" id="1588356">add</span><span class="op" id="1588359">(</span><span class="ident" id="1588360">unsafe</span><span class="op" id="1588366">.</span><span class="ident" id="1588367">Pointer</span><span class="op" id="1588374">(</span><span class="ident" id="1588375">b</span><span class="op" id="1588376">)</span><span class="op" id="1588377">,</span>&nbsp;<span class="ident" id="1588379">unsafe</span><span class="op" id="1588385">.</span><span class="ident" id="1588386">Sizeof</span><span class="op" id="1588392">(</span><span class="op" id="1588393">*</span><span class="ident" id="1588394">b</span><span class="op" id="1588395">)</span><span class="op" id="1588396">+</span><span class="ident" id="1588397">b</span><span class="op" id="1588398">.</span><span class="ident" id="1588399">nstk</span><span class="op" id="1588403">*</span><span class="ident" id="1588404">unsafe</span><span class="op" id="1588410">.</span><span class="ident" id="1588411">Sizeof</span><span class="op" id="1588417">(</span><span class="builtintype" id="1588418">uintptr</span><span class="op" id="1588425">(</span><span class="num" id="1588426">0</span><span class="op" id="1588427">)</span><span class="op" id="1588428">)</span><span class="op" id="1588429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588432">return</span>&nbsp;<span class="op" id="1588439">(</span><span class="op" id="1588440">*</span><span class="ident" id="1588441">blockRecord</span><span class="op" id="1588452">)</span><span class="op" id="1588453">(</span><span class="ident" id="1588454">data</span><span class="op" id="1588458">)</span><br>
<span class="lineno"></span><span class="op" id="1588460">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1588463">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1588534">func</span>&nbsp;<span class="ident" id="1588539">stkbucket</span><span class="op" id="1588548">(</span><span class="ident" id="1588549">typ</span>&nbsp;<span class="ident" id="1588553">bucketType</span><span class="op" id="1588563">,</span>&nbsp;<span class="ident" id="1588565">size</span>&nbsp;<span class="builtintype" id="1588570">uintptr</span><span class="op" id="1588577">,</span>&nbsp;<span class="ident" id="1588579">stk</span>&nbsp;<span class="op" id="1588583">[</span><span class="op" id="1588584">]</span><span class="builtintype" id="1588585">uintptr</span><span class="op" id="1588592">,</span>&nbsp;<span class="ident" id="1588594">alloc</span>&nbsp;<span class="builtintype" id="1588600">bool</span><span class="op" id="1588604">)</span>&nbsp;<span class="op" id="1588606">*</span><span class="ident" id="1588607">bucket</span>&nbsp;<span class="op" id="1588614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588617">if</span>&nbsp;<span class="ident" id="1588620">buckhash</span>&nbsp;<span class="op" id="1588629">==</span>&nbsp;<span class="builtintype" id="1588632">nil</span>&nbsp;<span class="op" id="1588636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588640">buckhash</span>&nbsp;<span class="op" id="1588649">=</span>&nbsp;<span class="op" id="1588651">(</span><span class="op" id="1588652">*</span><span class="op" id="1588653">[</span><span class="ident" id="1588654">buckHashSize</span><span class="op" id="1588666">]</span><span class="op" id="1588667">*</span><span class="ident" id="1588668">bucket</span><span class="op" id="1588674">)</span><span class="op" id="1588675">(</span><span class="ident" id="1588676">sysAlloc</span><span class="op" id="1588684">(</span><span class="ident" id="1588685">unsafe</span><span class="op" id="1588691">.</span><span class="ident" id="1588692">Sizeof</span><span class="op" id="1588698">(</span><span class="op" id="1588699">*</span><span class="ident" id="1588700">buckhash</span><span class="op" id="1588708">)</span><span class="op" id="1588709">,</span>&nbsp;<span class="op" id="1588711">&amp;</span><span class="ident" id="1588712">memstats</span><span class="op" id="1588720">.</span><span class="ident" id="1588721">buckhash_sys</span><span class="op" id="1588733">)</span><span class="op" id="1588734">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588738">if</span>&nbsp;<span class="ident" id="1588741">buckhash</span>&nbsp;<span class="op" id="1588750">==</span>&nbsp;<span class="builtintype" id="1588753">nil</span>&nbsp;<span class="op" id="1588757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588762">gothrow</span><span class="op" id="1588769">(</span><span class="string" id="1588770">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1588803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588814">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588830">var</span>&nbsp;<span class="ident" id="1588834">h</span>&nbsp;<span class="builtintype" id="1588836">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1588845">for</span>&nbsp;<span class="ident" id="1588849">_</span><span class="op" id="1588850">,</span>&nbsp;<span class="ident" id="1588852">pc</span>&nbsp;<span class="op" id="1588855">:=</span>&nbsp;<span class="keyword" id="1588858">range</span>&nbsp;<span class="ident" id="1588864">stk</span>&nbsp;<span class="op" id="1588868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588872">h</span>&nbsp;<span class="op" id="1588874">+=</span>&nbsp;<span class="ident" id="1588877">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588882">h</span>&nbsp;<span class="op" id="1588884">+=</span>&nbsp;<span class="ident" id="1588887">h</span>&nbsp;<span class="op" id="1588889">&lt;&lt;</span>&nbsp;<span class="num" id="1588892">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588897">h</span>&nbsp;<span class="op" id="1588899">^=</span>&nbsp;<span class="ident" id="1588902">h</span>&nbsp;<span class="op" id="1588904">&gt;&gt;</span>&nbsp;<span class="num" id="1588907">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1588910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588913">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588930">h</span>&nbsp;<span class="op" id="1588932">+=</span>&nbsp;<span class="ident" id="1588935">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588941">h</span>&nbsp;<span class="op" id="1588943">+=</span>&nbsp;<span class="ident" id="1588946">h</span>&nbsp;<span class="op" id="1588948">&lt;&lt;</span>&nbsp;<span class="num" id="1588951">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588955">h</span>&nbsp;<span class="op" id="1588957">^=</span>&nbsp;<span class="ident" id="1588960">h</span>&nbsp;<span class="op" id="1588962">&gt;&gt;</span>&nbsp;<span class="num" id="1588965">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1588968">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588981">h</span>&nbsp;<span class="op" id="1588983">+=</span>&nbsp;<span class="ident" id="1588986">h</span>&nbsp;<span class="op" id="1588988">&lt;&lt;</span>&nbsp;<span class="num" id="1588991">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1588994">h</span>&nbsp;<span class="op" id="1588996">^=</span>&nbsp;<span class="ident" id="1588999">h</span>&nbsp;<span class="op" id="1589001">&gt;&gt;</span>&nbsp;<span class="num" id="1589004">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589009">i</span>&nbsp;<span class="op" id="1589011">:=</span>&nbsp;<span class="builtintype" id="1589014">int</span><span class="op" id="1589017">(</span><span class="ident" id="1589018">h</span>&nbsp;<span class="op" id="1589020">%</span>&nbsp;<span class="ident" id="1589022">buckHashSize</span><span class="op" id="1589034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589037">for</span>&nbsp;<span class="ident" id="1589041">b</span>&nbsp;<span class="op" id="1589043">:=</span>&nbsp;<span class="ident" id="1589046">buckhash</span><span class="op" id="1589054">[</span><span class="ident" id="1589055">i</span><span class="op" id="1589056">]</span><span class="op" id="1589057">;</span>&nbsp;<span class="ident" id="1589059">b</span>&nbsp;<span class="op" id="1589061">!=</span>&nbsp;<span class="builtintype" id="1589064">nil</span><span class="op" id="1589067">;</span>&nbsp;<span class="ident" id="1589069">b</span>&nbsp;<span class="op" id="1589071">=</span>&nbsp;<span class="ident" id="1589073">b</span><span class="op" id="1589074">.</span><span class="ident" id="1589075">next</span>&nbsp;<span class="op" id="1589080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589084">if</span>&nbsp;<span class="ident" id="1589087">b</span><span class="op" id="1589088">.</span><span class="ident" id="1589089">typ</span>&nbsp;<span class="op" id="1589093">==</span>&nbsp;<span class="ident" id="1589096">typ</span>&nbsp;<span class="op" id="1589100">&amp;&amp;</span>&nbsp;<span class="ident" id="1589103">b</span><span class="op" id="1589104">.</span><span class="ident" id="1589105">hash</span>&nbsp;<span class="op" id="1589110">==</span>&nbsp;<span class="ident" id="1589113">h</span>&nbsp;<span class="op" id="1589115">&amp;&amp;</span>&nbsp;<span class="ident" id="1589118">b</span><span class="op" id="1589119">.</span><span class="ident" id="1589120">size</span>&nbsp;<span class="op" id="1589125">==</span>&nbsp;<span class="ident" id="1589128">size</span>&nbsp;<span class="op" id="1589133">&amp;&amp;</span>&nbsp;<span class="ident" id="1589136">eqslice</span><span class="op" id="1589143">(</span><span class="ident" id="1589144">b</span><span class="op" id="1589145">.</span><span class="ident" id="1589146">stk</span><span class="op" id="1589149">(</span><span class="op" id="1589150">)</span><span class="op" id="1589151">,</span>&nbsp;<span class="ident" id="1589153">stk</span><span class="op" id="1589156">)</span>&nbsp;<span class="op" id="1589158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589163">return</span>&nbsp;<span class="ident" id="1589170">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589174">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589181">if</span>&nbsp;<span class="op" id="1589184">!</span><span class="ident" id="1589185">alloc</span>&nbsp;<span class="op" id="1589191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589195">return</span>&nbsp;<span class="builtintype" id="1589202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589207">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1589211">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589234">b</span>&nbsp;<span class="op" id="1589236">:=</span>&nbsp;<span class="ident" id="1589239">newBucket</span><span class="op" id="1589248">(</span><span class="ident" id="1589249">typ</span><span class="op" id="1589252">,</span>&nbsp;<span class="builtinfunc" id="1589254">len</span><span class="op" id="1589257">(</span><span class="ident" id="1589258">stk</span><span class="op" id="1589261">)</span><span class="op" id="1589262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1589265">copy</span><span class="op" id="1589269">(</span><span class="ident" id="1589270">b</span><span class="op" id="1589271">.</span><span class="ident" id="1589272">stk</span><span class="op" id="1589275">(</span><span class="op" id="1589276">)</span><span class="op" id="1589277">,</span>&nbsp;<span class="ident" id="1589279">stk</span><span class="op" id="1589282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589285">b</span><span class="op" id="1589286">.</span><span class="ident" id="1589287">hash</span>&nbsp;<span class="op" id="1589292">=</span>&nbsp;<span class="ident" id="1589294">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589297">b</span><span class="op" id="1589298">.</span><span class="ident" id="1589299">size</span>&nbsp;<span class="op" id="1589304">=</span>&nbsp;<span class="ident" id="1589306">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589312">b</span><span class="op" id="1589313">.</span><span class="ident" id="1589314">next</span>&nbsp;<span class="op" id="1589319">=</span>&nbsp;<span class="ident" id="1589321">buckhash</span><span class="op" id="1589329">[</span><span class="ident" id="1589330">i</span><span class="op" id="1589331">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589334">buckhash</span><span class="op" id="1589342">[</span><span class="ident" id="1589343">i</span><span class="op" id="1589344">]</span>&nbsp;<span class="op" id="1589346">=</span>&nbsp;<span class="ident" id="1589348">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589351">if</span>&nbsp;<span class="ident" id="1589354">typ</span>&nbsp;<span class="op" id="1589358">==</span>&nbsp;<span class="ident" id="1589361">memProfile</span>&nbsp;<span class="op" id="1589372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589376">b</span><span class="op" id="1589377">.</span><span class="ident" id="1589378">allnext</span>&nbsp;<span class="op" id="1589386">=</span>&nbsp;<span class="ident" id="1589388">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589399">mbuckets</span>&nbsp;<span class="op" id="1589408">=</span>&nbsp;<span class="ident" id="1589410">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589413">}</span>&nbsp;<span class="keyword" id="1589415">else</span>&nbsp;<span class="op" id="1589420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589424">b</span><span class="op" id="1589425">.</span><span class="ident" id="1589426">allnext</span>&nbsp;<span class="op" id="1589434">=</span>&nbsp;<span class="ident" id="1589436">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589447">bbuckets</span>&nbsp;<span class="op" id="1589456">=</span>&nbsp;<span class="ident" id="1589458">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589461">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589464">return</span>&nbsp;<span class="ident" id="1589471">b</span><br>
<span class="lineno"></span><span class="op" id="1589473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1589476">func</span>&nbsp;<span class="ident" id="1589481">sysAlloc</span><span class="op" id="1589489">(</span><span class="ident" id="1589490">n</span>&nbsp;<span class="builtintype" id="1589492">uintptr</span><span class="op" id="1589499">,</span>&nbsp;<span class="ident" id="1589501">stat</span>&nbsp;<span class="op" id="1589506">*</span><span class="ident" id="1589507">uint64</span><span class="op" id="1589513">)</span>&nbsp;<span class="ident" id="1589515">unsafe</span><span class="op" id="1589521">.</span><span class="ident" id="1589522">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1589531">func</span>&nbsp;<span class="ident" id="1589536">eqslice</span><span class="op" id="1589543">(</span><span class="ident" id="1589544">x</span><span class="op" id="1589545">,</span>&nbsp;<span class="ident" id="1589547">y</span>&nbsp;<span class="op" id="1589549">[</span><span class="op" id="1589550">]</span><span class="builtintype" id="1589551">uintptr</span><span class="op" id="1589558">)</span>&nbsp;<span class="builtintype" id="1589560">bool</span>&nbsp;<span class="op" id="1589565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589568">if</span>&nbsp;<span class="builtinfunc" id="1589571">len</span><span class="op" id="1589574">(</span><span class="ident" id="1589575">x</span><span class="op" id="1589576">)</span>&nbsp;<span class="op" id="1589578">!=</span>&nbsp;<span class="builtinfunc" id="1589581">len</span><span class="op" id="1589584">(</span><span class="ident" id="1589585">y</span><span class="op" id="1589586">)</span>&nbsp;<span class="op" id="1589588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589592">return</span>&nbsp;<span class="builtintype" id="1589599">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589609">for</span>&nbsp;<span class="ident" id="1589613">i</span><span class="op" id="1589614">,</span>&nbsp;<span class="ident" id="1589616">xi</span>&nbsp;<span class="op" id="1589619">:=</span>&nbsp;<span class="keyword" id="1589622">range</span>&nbsp;<span class="ident" id="1589628">x</span>&nbsp;<span class="op" id="1589630">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589634">if</span>&nbsp;<span class="ident" id="1589637">xi</span>&nbsp;<span class="op" id="1589640">!=</span>&nbsp;<span class="ident" id="1589643">y</span><span class="op" id="1589644">[</span><span class="ident" id="1589645">i</span><span class="op" id="1589646">]</span>&nbsp;<span class="op" id="1589648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589653">return</span>&nbsp;<span class="builtintype" id="1589660">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1589671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589674">return</span>&nbsp;<span class="builtintype" id="1589681">true</span><br>
<span class="lineno">205</span><span class="op" id="1589686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1589689">func</span>&nbsp;<span class="ident" id="1589694">mprof_GC</span><span class="op" id="1589702">(</span><span class="op" id="1589703">)</span>&nbsp;<span class="op" id="1589705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1589708">for</span>&nbsp;<span class="ident" id="1589712">b</span>&nbsp;<span class="op" id="1589714">:=</span>&nbsp;<span class="ident" id="1589717">mbuckets</span><span class="op" id="1589725">;</span>&nbsp;<span class="ident" id="1589727">b</span>&nbsp;<span class="op" id="1589729">!=</span>&nbsp;<span class="builtintype" id="1589732">nil</span><span class="op" id="1589735">;</span>&nbsp;<span class="ident" id="1589737">b</span>&nbsp;<span class="op" id="1589739">=</span>&nbsp;<span class="ident" id="1589741">b</span><span class="op" id="1589742">.</span><span class="ident" id="1589743">allnext</span>&nbsp;<span class="op" id="1589751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589755">mp</span>&nbsp;<span class="op" id="1589758">:=</span>&nbsp;<span class="ident" id="1589761">b</span><span class="op" id="1589762">.</span><span class="ident" id="1589763">mp</span><span class="op" id="1589765">(</span><span class="op" id="1589766">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589770">mp</span><span class="op" id="1589772">.</span><span class="ident" id="1589773">allocs</span>&nbsp;<span class="op" id="1589780">+=</span>&nbsp;<span class="ident" id="1589783">mp</span><span class="op" id="1589785">.</span><span class="ident" id="1589786">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589800">mp</span><span class="op" id="1589802">.</span><span class="ident" id="1589803">frees</span>&nbsp;<span class="op" id="1589809">+=</span>&nbsp;<span class="ident" id="1589812">mp</span><span class="op" id="1589814">.</span><span class="ident" id="1589815">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589828">mp</span><span class="op" id="1589830">.</span><span class="ident" id="1589831">alloc_bytes</span>&nbsp;<span class="op" id="1589843">+=</span>&nbsp;<span class="ident" id="1589846">mp</span><span class="op" id="1589848">.</span><span class="ident" id="1589849">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589868">mp</span><span class="op" id="1589870">.</span><span class="ident" id="1589871">free_bytes</span>&nbsp;<span class="op" id="1589882">+=</span>&nbsp;<span class="ident" id="1589885">mp</span><span class="op" id="1589887">.</span><span class="ident" id="1589888">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589907">mp</span><span class="op" id="1589909">.</span><span class="ident" id="1589910">prev_allocs</span>&nbsp;<span class="op" id="1589922">=</span>&nbsp;<span class="ident" id="1589924">mp</span><span class="op" id="1589926">.</span><span class="ident" id="1589927">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589943">mp</span><span class="op" id="1589945">.</span><span class="ident" id="1589946">prev_frees</span>&nbsp;<span class="op" id="1589957">=</span>&nbsp;<span class="ident" id="1589959">mp</span><span class="op" id="1589961">.</span><span class="ident" id="1589962">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1589977">mp</span><span class="op" id="1589979">.</span><span class="ident" id="1589980">prev_alloc_bytes</span>&nbsp;<span class="op" id="1589997">=</span>&nbsp;<span class="ident" id="1589999">mp</span><span class="op" id="1590001">.</span><span class="ident" id="1590002">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590023">mp</span><span class="op" id="1590025">.</span><span class="ident" id="1590026">prev_free_bytes</span>&nbsp;<span class="op" id="1590042">=</span>&nbsp;<span class="ident" id="1590044">mp</span><span class="op" id="1590046">.</span><span class="ident" id="1590047">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590068">mp</span><span class="op" id="1590070">.</span><span class="ident" id="1590071">recent_allocs</span>&nbsp;<span class="op" id="1590085">=</span>&nbsp;<span class="num" id="1590087">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590091">mp</span><span class="op" id="1590093">.</span><span class="ident" id="1590094">recent_frees</span>&nbsp;<span class="op" id="1590107">=</span>&nbsp;<span class="num" id="1590109">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590113">mp</span><span class="op" id="1590115">.</span><span class="ident" id="1590116">recent_alloc_bytes</span>&nbsp;<span class="op" id="1590135">=</span>&nbsp;<span class="num" id="1590137">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590141">mp</span><span class="op" id="1590143">.</span><span class="ident" id="1590144">recent_free_bytes</span>&nbsp;<span class="op" id="1590162">=</span>&nbsp;<span class="num" id="1590164">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1590167">}</span><br>
<span class="lineno">225</span><span class="op" id="1590169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1590172">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1590249">func</span>&nbsp;<span class="ident" id="1590254">mProf_GC</span><span class="op" id="1590262">(</span><span class="op" id="1590263">)</span>&nbsp;<span class="op" id="1590265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590268">lock</span><span class="op" id="1590272">(</span><span class="op" id="1590273">&amp;</span><span class="ident" id="1590274">proflock</span><span class="op" id="1590282">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590285">mprof_GC</span><span class="op" id="1590293">(</span><span class="op" id="1590294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590297">unlock</span><span class="op" id="1590303">(</span><span class="op" id="1590304">&amp;</span><span class="ident" id="1590305">proflock</span><span class="op" id="1590313">)</span><br>
<span class="lineno"></span><span class="op" id="1590315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1590318">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1590366">func</span>&nbsp;<span class="ident" id="1590371">mProf_Malloc</span><span class="op" id="1590383">(</span><span class="ident" id="1590384">p</span>&nbsp;<span class="ident" id="1590386">unsafe</span><span class="op" id="1590392">.</span><span class="ident" id="1590393">Pointer</span><span class="op" id="1590400">,</span>&nbsp;<span class="ident" id="1590402">size</span>&nbsp;<span class="builtintype" id="1590407">uintptr</span><span class="op" id="1590414">)</span>&nbsp;<span class="op" id="1590416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1590419">var</span>&nbsp;<span class="ident" id="1590423">stk</span>&nbsp;<span class="op" id="1590427">[</span><span class="ident" id="1590428">maxStack</span><span class="op" id="1590436">]</span><span class="builtintype" id="1590437">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590446">nstk</span>&nbsp;<span class="op" id="1590451">:=</span>&nbsp;<span class="ident" id="1590454">callers</span><span class="op" id="1590461">(</span><span class="num" id="1590462">4</span><span class="op" id="1590463">,</span>&nbsp;<span class="op" id="1590465">&amp;</span><span class="ident" id="1590466">stk</span><span class="op" id="1590469">[</span><span class="num" id="1590470">0</span><span class="op" id="1590471">]</span><span class="op" id="1590472">,</span>&nbsp;<span class="builtinfunc" id="1590474">len</span><span class="op" id="1590477">(</span><span class="ident" id="1590478">stk</span><span class="op" id="1590481">)</span><span class="op" id="1590482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590485">lock</span><span class="op" id="1590489">(</span><span class="op" id="1590490">&amp;</span><span class="ident" id="1590491">proflock</span><span class="op" id="1590499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590502">b</span>&nbsp;<span class="op" id="1590504">:=</span>&nbsp;<span class="ident" id="1590507">stkbucket</span><span class="op" id="1590516">(</span><span class="ident" id="1590517">memProfile</span><span class="op" id="1590527">,</span>&nbsp;<span class="ident" id="1590529">size</span><span class="op" id="1590533">,</span>&nbsp;<span class="ident" id="1590535">stk</span><span class="op" id="1590538">[</span><span class="op" id="1590539">:</span><span class="ident" id="1590540">nstk</span><span class="op" id="1590544">]</span><span class="op" id="1590545">,</span>&nbsp;<span class="builtintype" id="1590547">true</span><span class="op" id="1590551">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590554">mp</span>&nbsp;<span class="op" id="1590557">:=</span>&nbsp;<span class="ident" id="1590560">b</span><span class="op" id="1590561">.</span><span class="ident" id="1590562">mp</span><span class="op" id="1590564">(</span><span class="op" id="1590565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590568">mp</span><span class="op" id="1590570">.</span><span class="ident" id="1590571">recent_allocs</span><span class="op" id="1590584">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590588">mp</span><span class="op" id="1590590">.</span><span class="ident" id="1590591">recent_alloc_bytes</span>&nbsp;<span class="op" id="1590610">+=</span>&nbsp;<span class="ident" id="1590613">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590619">unlock</span><span class="op" id="1590625">(</span><span class="op" id="1590626">&amp;</span><span class="ident" id="1590627">proflock</span><span class="op" id="1590635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590639">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590727">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590791">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1590855">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1590896">setprofilebucket</span><span class="op" id="1590912">(</span><span class="ident" id="1590913">p</span><span class="op" id="1590914">,</span>&nbsp;<span class="ident" id="1590916">b</span><span class="op" id="1590917">)</span><br>
<span class="lineno">250</span><span class="op" id="1590919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1590922">func</span>&nbsp;<span class="ident" id="1590927">setprofilebucket_m</span><span class="op" id="1590945">(</span><span class="op" id="1590946">)</span>&nbsp;<span class="comment" id="1590948">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1590960">func</span>&nbsp;<span class="ident" id="1590965">setprofilebucket</span><span class="op" id="1590981">(</span><span class="ident" id="1590982">p</span>&nbsp;<span class="ident" id="1590984">unsafe</span><span class="op" id="1590990">.</span><span class="ident" id="1590991">Pointer</span><span class="op" id="1590998">,</span>&nbsp;<span class="ident" id="1591000">b</span>&nbsp;<span class="op" id="1591002">*</span><span class="ident" id="1591003">bucket</span><span class="op" id="1591009">)</span>&nbsp;<span class="op" id="1591011">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591014">g</span>&nbsp;<span class="op" id="1591016">:=</span>&nbsp;<span class="ident" id="1591019">getg</span><span class="op" id="1591023">(</span><span class="op" id="1591024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591027">g</span><span class="op" id="1591028">.</span><span class="ident" id="1591029">m</span><span class="op" id="1591030">.</span><span class="ident" id="1591031">ptrarg</span><span class="op" id="1591037">[</span><span class="num" id="1591038">0</span><span class="op" id="1591039">]</span>&nbsp;<span class="op" id="1591041">=</span>&nbsp;<span class="ident" id="1591043">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591046">g</span><span class="op" id="1591047">.</span><span class="ident" id="1591048">m</span><span class="op" id="1591049">.</span><span class="ident" id="1591050">ptrarg</span><span class="op" id="1591056">[</span><span class="num" id="1591057">1</span><span class="op" id="1591058">]</span>&nbsp;<span class="op" id="1591060">=</span>&nbsp;<span class="ident" id="1591062">unsafe</span><span class="op" id="1591068">.</span><span class="ident" id="1591069">Pointer</span><span class="op" id="1591076">(</span><span class="ident" id="1591077">b</span><span class="op" id="1591078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591081">onM</span><span class="op" id="1591084">(</span><span class="ident" id="1591085">setprofilebucket_m</span><span class="op" id="1591103">)</span><br>
<span class="lineno"></span><span class="op" id="1591105">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1591108">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1591149">func</span>&nbsp;<span class="ident" id="1591154">mProf_Free</span><span class="op" id="1591164">(</span><span class="ident" id="1591165">b</span>&nbsp;<span class="op" id="1591167">*</span><span class="ident" id="1591168">bucket</span><span class="op" id="1591174">,</span>&nbsp;<span class="ident" id="1591176">size</span>&nbsp;<span class="builtintype" id="1591181">uintptr</span><span class="op" id="1591188">,</span>&nbsp;<span class="ident" id="1591190">freed</span>&nbsp;<span class="builtintype" id="1591196">bool</span><span class="op" id="1591200">)</span>&nbsp;<span class="op" id="1591202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591205">lock</span><span class="op" id="1591209">(</span><span class="op" id="1591210">&amp;</span><span class="ident" id="1591211">proflock</span><span class="op" id="1591219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591222">mp</span>&nbsp;<span class="op" id="1591225">:=</span>&nbsp;<span class="ident" id="1591228">b</span><span class="op" id="1591229">.</span><span class="ident" id="1591230">mp</span><span class="op" id="1591232">(</span><span class="op" id="1591233">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591236">if</span>&nbsp;<span class="ident" id="1591239">freed</span>&nbsp;<span class="op" id="1591245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591249">mp</span><span class="op" id="1591251">.</span><span class="ident" id="1591252">recent_frees</span><span class="op" id="1591264">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591269">mp</span><span class="op" id="1591271">.</span><span class="ident" id="1591272">recent_free_bytes</span>&nbsp;<span class="op" id="1591290">+=</span>&nbsp;<span class="ident" id="1591293">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591299">}</span>&nbsp;<span class="keyword" id="1591301">else</span>&nbsp;<span class="op" id="1591306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591310">mp</span><span class="op" id="1591312">.</span><span class="ident" id="1591313">prev_frees</span><span class="op" id="1591323">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591328">mp</span><span class="op" id="1591330">.</span><span class="ident" id="1591331">prev_free_bytes</span>&nbsp;<span class="op" id="1591347">+=</span>&nbsp;<span class="ident" id="1591350">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591359">unlock</span><span class="op" id="1591365">(</span><span class="op" id="1591366">&amp;</span><span class="ident" id="1591367">proflock</span><span class="op" id="1591375">)</span><br>
<span class="lineno"></span><span class="op" id="1591377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1591380">var</span>&nbsp;<span class="ident" id="1591384">blockprofilerate</span>&nbsp;<span class="ident" id="1591401">uint64</span>&nbsp;<span class="comment" id="1591408">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1591425">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1591499">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1591574">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1591646">//</span><br>
<span class="lineno"></span><span class="comment" id="1591649">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1591715">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1591766">func</span>&nbsp;<span class="ident" id="1591771">SetBlockProfileRate</span><span class="op" id="1591790">(</span><span class="ident" id="1591791">rate</span>&nbsp;<span class="builtintype" id="1591796">int</span><span class="op" id="1591799">)</span>&nbsp;<span class="op" id="1591801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591804">var</span>&nbsp;<span class="ident" id="1591808">r</span>&nbsp;<span class="ident" id="1591810">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1591817">if</span>&nbsp;<span class="ident" id="1591820">rate</span>&nbsp;<span class="op" id="1591825">&lt;=</span>&nbsp;<span class="num" id="1591828">0</span>&nbsp;<span class="op" id="1591830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591834">r</span>&nbsp;<span class="op" id="1591836">=</span>&nbsp;<span class="num" id="1591838">0</span>&nbsp;<span class="comment" id="1591840">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591862">}</span>&nbsp;<span class="keyword" id="1591864">else</span>&nbsp;<span class="keyword" id="1591869">if</span>&nbsp;<span class="ident" id="1591872">rate</span>&nbsp;<span class="op" id="1591877">==</span>&nbsp;<span class="num" id="1591880">1</span>&nbsp;<span class="op" id="1591882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1591886">r</span>&nbsp;<span class="op" id="1591888">=</span>&nbsp;<span class="num" id="1591890">1</span>&nbsp;<span class="comment" id="1591892">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1591915">}</span>&nbsp;<span class="keyword" id="1591917">else</span>&nbsp;<span class="op" id="1591922">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1591926">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592007">r</span>&nbsp;<span class="op" id="1592009">=</span>&nbsp;<span class="ident" id="1592011">int64</span><span class="op" id="1592016">(</span><span class="builtintype" id="1592017">float64</span><span class="op" id="1592024">(</span><span class="ident" id="1592025">rate</span><span class="op" id="1592029">)</span>&nbsp;<span class="op" id="1592031">*</span>&nbsp;<span class="builtintype" id="1592033">float64</span><span class="op" id="1592040">(</span><span class="ident" id="1592041">tickspersecond</span><span class="op" id="1592055">(</span><span class="op" id="1592056">)</span><span class="op" id="1592057">)</span>&nbsp;<span class="op" id="1592059">/</span>&nbsp;<span class="op" id="1592061">(</span><span class="num" id="1592062">1000</span>&nbsp;<span class="op" id="1592067">*</span>&nbsp;<span class="num" id="1592069">1000</span>&nbsp;<span class="op" id="1592074">*</span>&nbsp;<span class="num" id="1592076">1000</span><span class="op" id="1592080">)</span><span class="op" id="1592081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592085">if</span>&nbsp;<span class="ident" id="1592088">r</span>&nbsp;<span class="op" id="1592090">==</span>&nbsp;<span class="num" id="1592093">0</span>&nbsp;<span class="op" id="1592095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592100">r</span>&nbsp;<span class="op" id="1592102">=</span>&nbsp;<span class="num" id="1592104">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592108">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592115">atomicstore64</span><span class="op" id="1592128">(</span><span class="op" id="1592129">&amp;</span><span class="ident" id="1592130">blockprofilerate</span><span class="op" id="1592146">,</span>&nbsp;<span class="ident" id="1592148">uint64</span><span class="op" id="1592154">(</span><span class="ident" id="1592155">r</span><span class="op" id="1592156">)</span><span class="op" id="1592157">)</span><br>
<span class="lineno"></span><span class="op" id="1592159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1592162">func</span>&nbsp;<span class="ident" id="1592167">blockevent</span><span class="op" id="1592177">(</span><span class="ident" id="1592178">cycles</span>&nbsp;<span class="ident" id="1592185">int64</span><span class="op" id="1592190">,</span>&nbsp;<span class="ident" id="1592192">skip</span>&nbsp;<span class="builtintype" id="1592197">int</span><span class="op" id="1592200">)</span>&nbsp;<span class="op" id="1592202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592205">if</span>&nbsp;<span class="ident" id="1592208">cycles</span>&nbsp;<span class="op" id="1592215">&lt;=</span>&nbsp;<span class="num" id="1592218">0</span>&nbsp;<span class="op" id="1592220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592224">cycles</span>&nbsp;<span class="op" id="1592231">=</span>&nbsp;<span class="num" id="1592233">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592239">rate</span>&nbsp;<span class="op" id="1592244">:=</span>&nbsp;<span class="ident" id="1592247">int64</span><span class="op" id="1592252">(</span><span class="ident" id="1592253">atomicload64</span><span class="op" id="1592265">(</span><span class="op" id="1592266">&amp;</span><span class="ident" id="1592267">blockprofilerate</span><span class="op" id="1592283">)</span><span class="op" id="1592284">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592287">if</span>&nbsp;<span class="ident" id="1592290">rate</span>&nbsp;<span class="op" id="1592295">&lt;=</span>&nbsp;<span class="num" id="1592298">0</span>&nbsp;<span class="op" id="1592300">||</span>&nbsp;<span class="op" id="1592303">(</span><span class="ident" id="1592304">rate</span>&nbsp;<span class="op" id="1592309">&gt;</span>&nbsp;<span class="ident" id="1592311">cycles</span>&nbsp;<span class="op" id="1592318">&amp;&amp;</span>&nbsp;<span class="ident" id="1592321">int64</span><span class="op" id="1592326">(</span><span class="ident" id="1592327">fastrand1</span><span class="op" id="1592336">(</span><span class="op" id="1592337">)</span><span class="op" id="1592338">)</span><span class="op" id="1592339">%</span><span class="ident" id="1592340">rate</span>&nbsp;<span class="op" id="1592345">&gt;</span>&nbsp;<span class="ident" id="1592347">cycles</span><span class="op" id="1592353">)</span>&nbsp;<span class="op" id="1592355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592359">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592370">gp</span>&nbsp;<span class="op" id="1592373">:=</span>&nbsp;<span class="ident" id="1592376">getg</span><span class="op" id="1592380">(</span><span class="op" id="1592381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592384">var</span>&nbsp;<span class="ident" id="1592388">nstk</span>&nbsp;<span class="builtintype" id="1592393">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592398">var</span>&nbsp;<span class="ident" id="1592402">stk</span>&nbsp;<span class="op" id="1592406">[</span><span class="ident" id="1592407">maxStack</span><span class="op" id="1592415">]</span><span class="builtintype" id="1592416">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1592425">if</span>&nbsp;<span class="ident" id="1592428">gp</span><span class="op" id="1592430">.</span><span class="ident" id="1592431">m</span><span class="op" id="1592432">.</span><span class="ident" id="1592433">curg</span>&nbsp;<span class="op" id="1592438">==</span>&nbsp;<span class="builtintype" id="1592441">nil</span>&nbsp;<span class="op" id="1592445">||</span>&nbsp;<span class="ident" id="1592448">gp</span><span class="op" id="1592450">.</span><span class="ident" id="1592451">m</span><span class="op" id="1592452">.</span><span class="ident" id="1592453">curg</span>&nbsp;<span class="op" id="1592458">==</span>&nbsp;<span class="ident" id="1592461">gp</span>&nbsp;<span class="op" id="1592464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592468">nstk</span>&nbsp;<span class="op" id="1592473">=</span>&nbsp;<span class="ident" id="1592475">callers</span><span class="op" id="1592482">(</span><span class="ident" id="1592483">skip</span><span class="op" id="1592487">,</span>&nbsp;<span class="op" id="1592489">&amp;</span><span class="ident" id="1592490">stk</span><span class="op" id="1592493">[</span><span class="num" id="1592494">0</span><span class="op" id="1592495">]</span><span class="op" id="1592496">,</span>&nbsp;<span class="builtinfunc" id="1592498">len</span><span class="op" id="1592501">(</span><span class="ident" id="1592502">stk</span><span class="op" id="1592505">)</span><span class="op" id="1592506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592509">}</span>&nbsp;<span class="keyword" id="1592511">else</span>&nbsp;<span class="op" id="1592516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592520">nstk</span>&nbsp;<span class="op" id="1592525">=</span>&nbsp;<span class="ident" id="1592527">gcallers</span><span class="op" id="1592535">(</span><span class="ident" id="1592536">gp</span><span class="op" id="1592538">.</span><span class="ident" id="1592539">m</span><span class="op" id="1592540">.</span><span class="ident" id="1592541">curg</span><span class="op" id="1592545">,</span>&nbsp;<span class="ident" id="1592547">skip</span><span class="op" id="1592551">,</span>&nbsp;<span class="op" id="1592553">&amp;</span><span class="ident" id="1592554">stk</span><span class="op" id="1592557">[</span><span class="num" id="1592558">0</span><span class="op" id="1592559">]</span><span class="op" id="1592560">,</span>&nbsp;<span class="builtinfunc" id="1592562">len</span><span class="op" id="1592565">(</span><span class="ident" id="1592566">stk</span><span class="op" id="1592569">)</span><span class="op" id="1592570">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1592573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592576">lock</span><span class="op" id="1592580">(</span><span class="op" id="1592581">&amp;</span><span class="ident" id="1592582">proflock</span><span class="op" id="1592590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592593">b</span>&nbsp;<span class="op" id="1592595">:=</span>&nbsp;<span class="ident" id="1592598">stkbucket</span><span class="op" id="1592607">(</span><span class="ident" id="1592608">blockProfile</span><span class="op" id="1592620">,</span>&nbsp;<span class="num" id="1592622">0</span><span class="op" id="1592623">,</span>&nbsp;<span class="ident" id="1592625">stk</span><span class="op" id="1592628">[</span><span class="op" id="1592629">:</span><span class="ident" id="1592630">nstk</span><span class="op" id="1592634">]</span><span class="op" id="1592635">,</span>&nbsp;<span class="builtintype" id="1592637">true</span><span class="op" id="1592641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592644">b</span><span class="op" id="1592645">.</span><span class="ident" id="1592646">bp</span><span class="op" id="1592648">(</span><span class="op" id="1592649">)</span><span class="op" id="1592650">.</span><span class="ident" id="1592651">count</span><span class="op" id="1592656">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592660">b</span><span class="op" id="1592661">.</span><span class="ident" id="1592662">bp</span><span class="op" id="1592664">(</span><span class="op" id="1592665">)</span><span class="op" id="1592666">.</span><span class="ident" id="1592667">cycles</span>&nbsp;<span class="op" id="1592674">+=</span>&nbsp;<span class="ident" id="1592677">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592685">unlock</span><span class="op" id="1592691">(</span><span class="op" id="1592692">&amp;</span><span class="ident" id="1592693">proflock</span><span class="op" id="1592701">)</span><br>
<span class="lineno"></span><span class="op" id="1592703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1592706">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1592740">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1592793">type</span>&nbsp;<span class="ident" id="1592798">StackRecord</span>&nbsp;<span class="keyword" id="1592810">struct</span>&nbsp;<span class="op" id="1592817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1592820">Stack0</span>&nbsp;<span class="op" id="1592827">[</span><span class="num" id="1592828">32</span><span class="op" id="1592830">]</span><span class="builtintype" id="1592831">uintptr</span>&nbsp;<span class="comment" id="1592839">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1592893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1592896">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1592957">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1592982">func</span>&nbsp;<span class="op" id="1592987">(</span><span class="ident" id="1592988">r</span>&nbsp;<span class="op" id="1592990">*</span><span class="ident" id="1592991">StackRecord</span><span class="op" id="1593002">)</span>&nbsp;<span class="ident" id="1593004">Stack</span><span class="op" id="1593009">(</span><span class="op" id="1593010">)</span>&nbsp;<span class="op" id="1593012">[</span><span class="op" id="1593013">]</span><span class="builtintype" id="1593014">uintptr</span>&nbsp;<span class="op" id="1593022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593025">for</span>&nbsp;<span class="ident" id="1593029">i</span><span class="op" id="1593030">,</span>&nbsp;<span class="ident" id="1593032">v</span>&nbsp;<span class="op" id="1593034">:=</span>&nbsp;<span class="keyword" id="1593037">range</span>&nbsp;<span class="ident" id="1593043">r</span><span class="op" id="1593044">.</span><span class="ident" id="1593045">Stack0</span>&nbsp;<span class="op" id="1593052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593056">if</span>&nbsp;<span class="ident" id="1593059">v</span>&nbsp;<span class="op" id="1593061">==</span>&nbsp;<span class="num" id="1593064">0</span>&nbsp;<span class="op" id="1593066">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593071">return</span>&nbsp;<span class="ident" id="1593078">r</span><span class="op" id="1593079">.</span><span class="ident" id="1593080">Stack0</span><span class="op" id="1593086">[</span><span class="num" id="1593087">0</span><span class="op" id="1593088">:</span><span class="ident" id="1593089">i</span><span class="op" id="1593090">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1593097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1593100">return</span>&nbsp;<span class="ident" id="1593107">r</span><span class="op" id="1593108">.</span><span class="ident" id="1593109">Stack0</span><span class="op" id="1593115">[</span><span class="num" id="1593116">0</span><span class="op" id="1593117">:</span><span class="op" id="1593118">]</span><br>
<span class="lineno"></span><span class="op" id="1593120">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1593123">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1593185">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1593242">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1593287">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1593341">//</span><br>
<span class="lineno"></span><span class="comment" id="1593344">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1593421">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1593481">//</span><br>
<span class="lineno"></span><span class="comment" id="1593484">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1593546">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1593609">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1593670">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1593731">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1593789">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1593819">var</span>&nbsp;<span class="ident" id="1593823">MemProfileRate</span>&nbsp;<span class="builtintype" id="1593838">int</span>&nbsp;<span class="op" id="1593842">=</span>&nbsp;<span class="num" id="1593844">512</span>&nbsp;<span class="op" id="1593848">*</span>&nbsp;<span class="num" id="1593850">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1593856">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1593915">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1593963">type</span>&nbsp;<span class="ident" id="1593968">MemProfileRecord</span>&nbsp;<span class="keyword" id="1593985">struct</span>&nbsp;<span class="op" id="1593992">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1593995">AllocBytes</span><span class="op" id="1594005">,</span>&nbsp;<span class="ident" id="1594007">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594021">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1594033">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594070">AllocObjects</span><span class="op" id="1594082">,</span>&nbsp;<span class="ident" id="1594084">FreeObjects</span>&nbsp;<span class="ident" id="1594096">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1594108">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1594147">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594173">[</span><span class="num" id="1594174">32</span><span class="op" id="1594176">]</span><span class="builtintype" id="1594177">uintptr</span>&nbsp;<span class="comment" id="1594185">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1594239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1594242">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1594317">func</span>&nbsp;<span class="op" id="1594322">(</span><span class="ident" id="1594323">r</span>&nbsp;<span class="op" id="1594325">*</span><span class="ident" id="1594326">MemProfileRecord</span><span class="op" id="1594342">)</span>&nbsp;<span class="ident" id="1594344">InUseBytes</span><span class="op" id="1594354">(</span><span class="op" id="1594355">)</span>&nbsp;<span class="ident" id="1594357">int64</span>&nbsp;<span class="op" id="1594363">{</span>&nbsp;<span class="keyword" id="1594365">return</span>&nbsp;<span class="ident" id="1594372">r</span><span class="op" id="1594373">.</span><span class="ident" id="1594374">AllocBytes</span>&nbsp;<span class="op" id="1594385">-</span>&nbsp;<span class="ident" id="1594387">r</span><span class="op" id="1594388">.</span><span class="ident" id="1594389">FreeBytes</span>&nbsp;<span class="op" id="1594399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1594402">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1594485">func</span>&nbsp;<span class="op" id="1594490">(</span><span class="ident" id="1594491">r</span>&nbsp;<span class="op" id="1594493">*</span><span class="ident" id="1594494">MemProfileRecord</span><span class="op" id="1594510">)</span>&nbsp;<span class="ident" id="1594512">InUseObjects</span><span class="op" id="1594524">(</span><span class="op" id="1594525">)</span>&nbsp;<span class="ident" id="1594527">int64</span>&nbsp;<span class="op" id="1594533">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594536">return</span>&nbsp;<span class="ident" id="1594543">r</span><span class="op" id="1594544">.</span><span class="ident" id="1594545">AllocObjects</span>&nbsp;<span class="op" id="1594558">-</span>&nbsp;<span class="ident" id="1594560">r</span><span class="op" id="1594561">.</span><span class="ident" id="1594562">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1594574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1594577">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1594638">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1594663">func</span>&nbsp;<span class="op" id="1594668">(</span><span class="ident" id="1594669">r</span>&nbsp;<span class="op" id="1594671">*</span><span class="ident" id="1594672">MemProfileRecord</span><span class="op" id="1594688">)</span>&nbsp;<span class="ident" id="1594690">Stack</span><span class="op" id="1594695">(</span><span class="op" id="1594696">)</span>&nbsp;<span class="op" id="1594698">[</span><span class="op" id="1594699">]</span><span class="builtintype" id="1594700">uintptr</span>&nbsp;<span class="op" id="1594708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594711">for</span>&nbsp;<span class="ident" id="1594715">i</span><span class="op" id="1594716">,</span>&nbsp;<span class="ident" id="1594718">v</span>&nbsp;<span class="op" id="1594720">:=</span>&nbsp;<span class="keyword" id="1594723">range</span>&nbsp;<span class="ident" id="1594729">r</span><span class="op" id="1594730">.</span><span class="ident" id="1594731">Stack0</span>&nbsp;<span class="op" id="1594738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594742">if</span>&nbsp;<span class="ident" id="1594745">v</span>&nbsp;<span class="op" id="1594747">==</span>&nbsp;<span class="num" id="1594750">0</span>&nbsp;<span class="op" id="1594752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594757">return</span>&nbsp;<span class="ident" id="1594764">r</span><span class="op" id="1594765">.</span><span class="ident" id="1594766">Stack0</span><span class="op" id="1594772">[</span><span class="num" id="1594773">0</span><span class="op" id="1594774">:</span><span class="ident" id="1594775">i</span><span class="op" id="1594776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594780">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1594783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1594786">return</span>&nbsp;<span class="ident" id="1594793">r</span><span class="op" id="1594794">.</span><span class="ident" id="1594795">Stack0</span><span class="op" id="1594801">[</span><span class="num" id="1594802">0</span><span class="op" id="1594803">:</span><span class="op" id="1594804">]</span><br>
<span class="lineno"></span><span class="op" id="1594806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1594809">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1594887">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1594964">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1595033">//</span><br>
<span class="lineno"></span><span class="comment" id="1595036">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1595101">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1595160">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1595222">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1595260">//</span><br>
<span class="lineno"></span><span class="comment" id="1595263">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1595319">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1595374">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1595409">func</span>&nbsp;<span class="ident" id="1595414">MemProfile</span><span class="op" id="1595424">(</span><span class="ident" id="1595425">p</span>&nbsp;<span class="op" id="1595427">[</span><span class="op" id="1595428">]</span><span class="ident" id="1595429">MemProfileRecord</span><span class="op" id="1595445">,</span>&nbsp;<span class="ident" id="1595447">inuseZero</span>&nbsp;<span class="builtintype" id="1595457">bool</span><span class="op" id="1595461">)</span>&nbsp;<span class="op" id="1595463">(</span><span class="ident" id="1595464">n</span>&nbsp;<span class="builtintype" id="1595466">int</span><span class="op" id="1595469">,</span>&nbsp;<span class="ident" id="1595471">ok</span>&nbsp;<span class="builtintype" id="1595474">bool</span><span class="op" id="1595478">)</span>&nbsp;<span class="op" id="1595480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595483">lock</span><span class="op" id="1595487">(</span><span class="op" id="1595488">&amp;</span><span class="ident" id="1595489">proflock</span><span class="op" id="1595497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595500">clear</span>&nbsp;<span class="op" id="1595506">:=</span>&nbsp;<span class="builtintype" id="1595509">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595515">for</span>&nbsp;<span class="ident" id="1595519">b</span>&nbsp;<span class="op" id="1595521">:=</span>&nbsp;<span class="ident" id="1595524">mbuckets</span><span class="op" id="1595532">;</span>&nbsp;<span class="ident" id="1595534">b</span>&nbsp;<span class="op" id="1595536">!=</span>&nbsp;<span class="builtintype" id="1595539">nil</span><span class="op" id="1595542">;</span>&nbsp;<span class="ident" id="1595544">b</span>&nbsp;<span class="op" id="1595546">=</span>&nbsp;<span class="ident" id="1595548">b</span><span class="op" id="1595549">.</span><span class="ident" id="1595550">allnext</span>&nbsp;<span class="op" id="1595558">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595562">mp</span>&nbsp;<span class="op" id="1595565">:=</span>&nbsp;<span class="ident" id="1595568">b</span><span class="op" id="1595569">.</span><span class="ident" id="1595570">mp</span><span class="op" id="1595572">(</span><span class="op" id="1595573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595577">if</span>&nbsp;<span class="ident" id="1595580">inuseZero</span>&nbsp;<span class="op" id="1595590">||</span>&nbsp;<span class="ident" id="1595593">mp</span><span class="op" id="1595595">.</span><span class="ident" id="1595596">alloc_bytes</span>&nbsp;<span class="op" id="1595608">!=</span>&nbsp;<span class="ident" id="1595611">mp</span><span class="op" id="1595613">.</span><span class="ident" id="1595614">free_bytes</span>&nbsp;<span class="op" id="1595625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595630">n</span><span class="op" id="1595631">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595640">if</span>&nbsp;<span class="ident" id="1595643">mp</span><span class="op" id="1595645">.</span><span class="ident" id="1595646">allocs</span>&nbsp;<span class="op" id="1595653">!=</span>&nbsp;<span class="num" id="1595656">0</span>&nbsp;<span class="op" id="1595658">||</span>&nbsp;<span class="ident" id="1595661">mp</span><span class="op" id="1595663">.</span><span class="ident" id="1595664">frees</span>&nbsp;<span class="op" id="1595670">!=</span>&nbsp;<span class="num" id="1595673">0</span>&nbsp;<span class="op" id="1595675">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595680">clear</span>&nbsp;<span class="op" id="1595686">=</span>&nbsp;<span class="builtintype" id="1595688">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1595699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1595702">if</span>&nbsp;<span class="ident" id="1595705">clear</span>&nbsp;<span class="op" id="1595711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595715">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595777">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595837">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595906">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595975">mprof_GC</span><span class="op" id="1595983">(</span><span class="op" id="1595984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595988">mprof_GC</span><span class="op" id="1595996">(</span><span class="op" id="1595997">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596001">n</span>&nbsp;<span class="op" id="1596003">=</span>&nbsp;<span class="num" id="1596005">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596009">for</span>&nbsp;<span class="ident" id="1596013">b</span>&nbsp;<span class="op" id="1596015">:=</span>&nbsp;<span class="ident" id="1596018">mbuckets</span><span class="op" id="1596026">;</span>&nbsp;<span class="ident" id="1596028">b</span>&nbsp;<span class="op" id="1596030">!=</span>&nbsp;<span class="builtintype" id="1596033">nil</span><span class="op" id="1596036">;</span>&nbsp;<span class="ident" id="1596038">b</span>&nbsp;<span class="op" id="1596040">=</span>&nbsp;<span class="ident" id="1596042">b</span><span class="op" id="1596043">.</span><span class="ident" id="1596044">allnext</span>&nbsp;<span class="op" id="1596052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596057">mp</span>&nbsp;<span class="op" id="1596060">:=</span>&nbsp;<span class="ident" id="1596063">b</span><span class="op" id="1596064">.</span><span class="ident" id="1596065">mp</span><span class="op" id="1596067">(</span><span class="op" id="1596068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596073">if</span>&nbsp;<span class="ident" id="1596076">inuseZero</span>&nbsp;<span class="op" id="1596086">||</span>&nbsp;<span class="ident" id="1596089">mp</span><span class="op" id="1596091">.</span><span class="ident" id="1596092">alloc_bytes</span>&nbsp;<span class="op" id="1596104">!=</span>&nbsp;<span class="ident" id="1596107">mp</span><span class="op" id="1596109">.</span><span class="ident" id="1596110">free_bytes</span>&nbsp;<span class="op" id="1596121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596127">n</span><span class="op" id="1596128">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596144">if</span>&nbsp;<span class="ident" id="1596147">n</span>&nbsp;<span class="op" id="1596149">&lt;=</span>&nbsp;<span class="builtinfunc" id="1596152">len</span><span class="op" id="1596155">(</span><span class="ident" id="1596156">p</span><span class="op" id="1596157">)</span>&nbsp;<span class="op" id="1596159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596163">ok</span>&nbsp;<span class="op" id="1596166">=</span>&nbsp;<span class="builtintype" id="1596168">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596175">idx</span>&nbsp;<span class="op" id="1596179">:=</span>&nbsp;<span class="num" id="1596182">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596186">for</span>&nbsp;<span class="ident" id="1596190">b</span>&nbsp;<span class="op" id="1596192">:=</span>&nbsp;<span class="ident" id="1596195">mbuckets</span><span class="op" id="1596203">;</span>&nbsp;<span class="ident" id="1596205">b</span>&nbsp;<span class="op" id="1596207">!=</span>&nbsp;<span class="builtintype" id="1596210">nil</span><span class="op" id="1596213">;</span>&nbsp;<span class="ident" id="1596215">b</span>&nbsp;<span class="op" id="1596217">=</span>&nbsp;<span class="ident" id="1596219">b</span><span class="op" id="1596220">.</span><span class="ident" id="1596221">allnext</span>&nbsp;<span class="op" id="1596229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596234">mp</span>&nbsp;<span class="op" id="1596237">:=</span>&nbsp;<span class="ident" id="1596240">b</span><span class="op" id="1596241">.</span><span class="ident" id="1596242">mp</span><span class="op" id="1596244">(</span><span class="op" id="1596245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596250">if</span>&nbsp;<span class="ident" id="1596253">inuseZero</span>&nbsp;<span class="op" id="1596263">||</span>&nbsp;<span class="ident" id="1596266">mp</span><span class="op" id="1596268">.</span><span class="ident" id="1596269">alloc_bytes</span>&nbsp;<span class="op" id="1596281">!=</span>&nbsp;<span class="ident" id="1596284">mp</span><span class="op" id="1596286">.</span><span class="ident" id="1596287">free_bytes</span>&nbsp;<span class="op" id="1596298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596304">record</span><span class="op" id="1596310">(</span><span class="op" id="1596311">&amp;</span><span class="ident" id="1596312">p</span><span class="op" id="1596313">[</span><span class="ident" id="1596314">idx</span><span class="op" id="1596317">]</span><span class="op" id="1596318">,</span>&nbsp;<span class="ident" id="1596320">b</span><span class="op" id="1596321">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596327">idx</span><span class="op" id="1596330">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596346">unlock</span><span class="op" id="1596352">(</span><span class="op" id="1596353">&amp;</span><span class="ident" id="1596354">proflock</span><span class="op" id="1596362">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596365">return</span><br>
<span class="lineno"></span><span class="op" id="1596372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1596375">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1596399">func</span>&nbsp;<span class="ident" id="1596404">record</span><span class="op" id="1596410">(</span><span class="ident" id="1596411">r</span>&nbsp;<span class="op" id="1596413">*</span><span class="ident" id="1596414">MemProfileRecord</span><span class="op" id="1596430">,</span>&nbsp;<span class="ident" id="1596432">b</span>&nbsp;<span class="op" id="1596434">*</span><span class="ident" id="1596435">bucket</span><span class="op" id="1596441">)</span>&nbsp;<span class="op" id="1596443">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596446">mp</span>&nbsp;<span class="op" id="1596449">:=</span>&nbsp;<span class="ident" id="1596452">b</span><span class="op" id="1596453">.</span><span class="ident" id="1596454">mp</span><span class="op" id="1596456">(</span><span class="op" id="1596457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596460">r</span><span class="op" id="1596461">.</span><span class="ident" id="1596462">AllocBytes</span>&nbsp;<span class="op" id="1596473">=</span>&nbsp;<span class="ident" id="1596475">int64</span><span class="op" id="1596480">(</span><span class="ident" id="1596481">mp</span><span class="op" id="1596483">.</span><span class="ident" id="1596484">alloc_bytes</span><span class="op" id="1596495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596498">r</span><span class="op" id="1596499">.</span><span class="ident" id="1596500">FreeBytes</span>&nbsp;<span class="op" id="1596510">=</span>&nbsp;<span class="ident" id="1596512">int64</span><span class="op" id="1596517">(</span><span class="ident" id="1596518">mp</span><span class="op" id="1596520">.</span><span class="ident" id="1596521">free_bytes</span><span class="op" id="1596531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596534">r</span><span class="op" id="1596535">.</span><span class="ident" id="1596536">AllocObjects</span>&nbsp;<span class="op" id="1596549">=</span>&nbsp;<span class="ident" id="1596551">int64</span><span class="op" id="1596556">(</span><span class="ident" id="1596557">mp</span><span class="op" id="1596559">.</span><span class="ident" id="1596560">allocs</span><span class="op" id="1596566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596569">r</span><span class="op" id="1596570">.</span><span class="ident" id="1596571">FreeObjects</span>&nbsp;<span class="op" id="1596583">=</span>&nbsp;<span class="ident" id="1596585">int64</span><span class="op" id="1596590">(</span><span class="ident" id="1596591">mp</span><span class="op" id="1596593">.</span><span class="ident" id="1596594">frees</span><span class="op" id="1596599">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1596602">copy</span><span class="op" id="1596606">(</span><span class="ident" id="1596607">r</span><span class="op" id="1596608">.</span><span class="ident" id="1596609">Stack0</span><span class="op" id="1596615">[</span><span class="op" id="1596616">:</span><span class="op" id="1596617">]</span><span class="op" id="1596618">,</span>&nbsp;<span class="ident" id="1596620">b</span><span class="op" id="1596621">.</span><span class="ident" id="1596622">stk</span><span class="op" id="1596625">(</span><span class="op" id="1596626">)</span><span class="op" id="1596627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596630">for</span>&nbsp;<span class="ident" id="1596634">i</span>&nbsp;<span class="op" id="1596636">:=</span>&nbsp;<span class="builtintype" id="1596639">int</span><span class="op" id="1596642">(</span><span class="ident" id="1596643">b</span><span class="op" id="1596644">.</span><span class="ident" id="1596645">nstk</span><span class="op" id="1596649">)</span><span class="op" id="1596650">;</span>&nbsp;<span class="ident" id="1596652">i</span>&nbsp;<span class="op" id="1596654">&lt;</span>&nbsp;<span class="builtinfunc" id="1596656">len</span><span class="op" id="1596659">(</span><span class="ident" id="1596660">r</span><span class="op" id="1596661">.</span><span class="ident" id="1596662">Stack0</span><span class="op" id="1596668">)</span><span class="op" id="1596669">;</span>&nbsp;<span class="ident" id="1596671">i</span><span class="op" id="1596672">++</span>&nbsp;<span class="op" id="1596675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596679">r</span><span class="op" id="1596680">.</span><span class="ident" id="1596681">Stack0</span><span class="op" id="1596687">[</span><span class="ident" id="1596688">i</span><span class="op" id="1596689">]</span>&nbsp;<span class="op" id="1596691">=</span>&nbsp;<span class="num" id="1596693">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596696">}</span><br>
<span class="lineno"></span><span class="op" id="1596698">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1596701">func</span>&nbsp;<span class="ident" id="1596706">iterate_memprof</span><span class="op" id="1596721">(</span><span class="ident" id="1596722">fn</span>&nbsp;<span class="keyword" id="1596725">func</span><span class="op" id="1596729">(</span><span class="op" id="1596730">*</span><span class="ident" id="1596731">bucket</span><span class="op" id="1596737">,</span>&nbsp;<span class="builtintype" id="1596739">uintptr</span><span class="op" id="1596746">,</span>&nbsp;<span class="op" id="1596748">*</span><span class="builtintype" id="1596749">uintptr</span><span class="op" id="1596756">,</span>&nbsp;<span class="builtintype" id="1596758">uintptr</span><span class="op" id="1596765">,</span>&nbsp;<span class="builtintype" id="1596767">uintptr</span><span class="op" id="1596774">,</span>&nbsp;<span class="builtintype" id="1596776">uintptr</span><span class="op" id="1596783">)</span><span class="op" id="1596784">)</span>&nbsp;<span class="op" id="1596786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596789">lock</span><span class="op" id="1596793">(</span><span class="op" id="1596794">&amp;</span><span class="ident" id="1596795">proflock</span><span class="op" id="1596803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1596806">for</span>&nbsp;<span class="ident" id="1596810">b</span>&nbsp;<span class="op" id="1596812">:=</span>&nbsp;<span class="ident" id="1596815">mbuckets</span><span class="op" id="1596823">;</span>&nbsp;<span class="ident" id="1596825">b</span>&nbsp;<span class="op" id="1596827">!=</span>&nbsp;<span class="builtintype" id="1596830">nil</span><span class="op" id="1596833">;</span>&nbsp;<span class="ident" id="1596835">b</span>&nbsp;<span class="op" id="1596837">=</span>&nbsp;<span class="ident" id="1596839">b</span><span class="op" id="1596840">.</span><span class="ident" id="1596841">allnext</span>&nbsp;<span class="op" id="1596849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596853">mp</span>&nbsp;<span class="op" id="1596856">:=</span>&nbsp;<span class="ident" id="1596859">b</span><span class="op" id="1596860">.</span><span class="ident" id="1596861">mp</span><span class="op" id="1596863">(</span><span class="op" id="1596864">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596868">fn</span><span class="op" id="1596870">(</span><span class="ident" id="1596871">b</span><span class="op" id="1596872">,</span>&nbsp;<span class="builtintype" id="1596874">uintptr</span><span class="op" id="1596881">(</span><span class="ident" id="1596882">b</span><span class="op" id="1596883">.</span><span class="ident" id="1596884">nstk</span><span class="op" id="1596888">)</span><span class="op" id="1596889">,</span>&nbsp;<span class="op" id="1596891">&amp;</span><span class="ident" id="1596892">b</span><span class="op" id="1596893">.</span><span class="ident" id="1596894">stk</span><span class="op" id="1596897">(</span><span class="op" id="1596898">)</span><span class="op" id="1596899">[</span><span class="num" id="1596900">0</span><span class="op" id="1596901">]</span><span class="op" id="1596902">,</span>&nbsp;<span class="ident" id="1596904">b</span><span class="op" id="1596905">.</span><span class="ident" id="1596906">size</span><span class="op" id="1596910">,</span>&nbsp;<span class="ident" id="1596912">mp</span><span class="op" id="1596914">.</span><span class="ident" id="1596915">allocs</span><span class="op" id="1596921">,</span>&nbsp;<span class="ident" id="1596923">mp</span><span class="op" id="1596925">.</span><span class="ident" id="1596926">frees</span><span class="op" id="1596931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1596934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1596937">unlock</span><span class="op" id="1596943">(</span><span class="op" id="1596944">&amp;</span><span class="ident" id="1596945">proflock</span><span class="op" id="1596953">)</span><br>
<span class="lineno"></span><span class="op" id="1596955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1596958">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1597017">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1597065">type</span>&nbsp;<span class="ident" id="1597070">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1597089">struct</span>&nbsp;<span class="op" id="1597096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597099">Count</span>&nbsp;&nbsp;<span class="ident" id="1597106">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597113">Cycles</span>&nbsp;<span class="ident" id="1597120">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597127">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1597139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1597142">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1597224">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1597303">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1597374">//</span><br>
<span class="lineno"></span><span class="comment" id="1597377">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1597433">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1597490">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1597527">func</span>&nbsp;<span class="ident" id="1597532">BlockProfile</span><span class="op" id="1597544">(</span><span class="ident" id="1597545">p</span>&nbsp;<span class="op" id="1597547">[</span><span class="op" id="1597548">]</span><span class="ident" id="1597549">BlockProfileRecord</span><span class="op" id="1597567">)</span>&nbsp;<span class="op" id="1597569">(</span><span class="ident" id="1597570">n</span>&nbsp;<span class="builtintype" id="1597572">int</span><span class="op" id="1597575">,</span>&nbsp;<span class="ident" id="1597577">ok</span>&nbsp;<span class="builtintype" id="1597580">bool</span><span class="op" id="1597584">)</span>&nbsp;<span class="op" id="1597586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597589">lock</span><span class="op" id="1597593">(</span><span class="op" id="1597594">&amp;</span><span class="ident" id="1597595">proflock</span><span class="op" id="1597603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1597606">for</span>&nbsp;<span class="ident" id="1597610">b</span>&nbsp;<span class="op" id="1597612">:=</span>&nbsp;<span class="ident" id="1597615">bbuckets</span><span class="op" id="1597623">;</span>&nbsp;<span class="ident" id="1597625">b</span>&nbsp;<span class="op" id="1597627">!=</span>&nbsp;<span class="builtintype" id="1597630">nil</span><span class="op" id="1597633">;</span>&nbsp;<span class="ident" id="1597635">b</span>&nbsp;<span class="op" id="1597637">=</span>&nbsp;<span class="ident" id="1597639">b</span><span class="op" id="1597640">.</span><span class="ident" id="1597641">allnext</span>&nbsp;<span class="op" id="1597649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597653">n</span><span class="op" id="1597654">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1597658">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1597661">if</span>&nbsp;<span class="ident" id="1597664">n</span>&nbsp;<span class="op" id="1597666">&lt;=</span>&nbsp;<span class="builtinfunc" id="1597669">len</span><span class="op" id="1597672">(</span><span class="ident" id="1597673">p</span><span class="op" id="1597674">)</span>&nbsp;<span class="op" id="1597676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597680">ok</span>&nbsp;<span class="op" id="1597683">=</span>&nbsp;<span class="builtintype" id="1597685">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1597692">for</span>&nbsp;<span class="ident" id="1597696">b</span>&nbsp;<span class="op" id="1597698">:=</span>&nbsp;<span class="ident" id="1597701">bbuckets</span><span class="op" id="1597709">;</span>&nbsp;<span class="ident" id="1597711">b</span>&nbsp;<span class="op" id="1597713">!=</span>&nbsp;<span class="builtintype" id="1597716">nil</span><span class="op" id="1597719">;</span>&nbsp;<span class="ident" id="1597721">b</span>&nbsp;<span class="op" id="1597723">=</span>&nbsp;<span class="ident" id="1597725">b</span><span class="op" id="1597726">.</span><span class="ident" id="1597727">allnext</span>&nbsp;<span class="op" id="1597735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597740">bp</span>&nbsp;<span class="op" id="1597743">:=</span>&nbsp;<span class="ident" id="1597746">b</span><span class="op" id="1597747">.</span><span class="ident" id="1597748">bp</span><span class="op" id="1597750">(</span><span class="op" id="1597751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597756">r</span>&nbsp;<span class="op" id="1597758">:=</span>&nbsp;<span class="op" id="1597761">&amp;</span><span class="ident" id="1597762">p</span><span class="op" id="1597763">[</span><span class="num" id="1597764">0</span><span class="op" id="1597765">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597770">r</span><span class="op" id="1597771">.</span><span class="ident" id="1597772">Count</span>&nbsp;<span class="op" id="1597778">=</span>&nbsp;<span class="ident" id="1597780">int64</span><span class="op" id="1597785">(</span><span class="ident" id="1597786">bp</span><span class="op" id="1597788">.</span><span class="ident" id="1597789">count</span><span class="op" id="1597794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597799">r</span><span class="op" id="1597800">.</span><span class="ident" id="1597801">Cycles</span>&nbsp;<span class="op" id="1597808">=</span>&nbsp;<span class="ident" id="1597810">int64</span><span class="op" id="1597815">(</span><span class="ident" id="1597816">bp</span><span class="op" id="1597818">.</span><span class="ident" id="1597819">cycles</span><span class="op" id="1597825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597830">i</span>&nbsp;<span class="op" id="1597832">:=</span>&nbsp;<span class="builtinfunc" id="1597835">copy</span><span class="op" id="1597839">(</span><span class="ident" id="1597840">r</span><span class="op" id="1597841">.</span><span class="ident" id="1597842">Stack0</span><span class="op" id="1597848">[</span><span class="op" id="1597849">:</span><span class="op" id="1597850">]</span><span class="op" id="1597851">,</span>&nbsp;<span class="ident" id="1597853">b</span><span class="op" id="1597854">.</span><span class="ident" id="1597855">stk</span><span class="op" id="1597858">(</span><span class="op" id="1597859">)</span><span class="op" id="1597860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1597865">for</span>&nbsp;<span class="op" id="1597869">;</span>&nbsp;<span class="ident" id="1597871">i</span>&nbsp;<span class="op" id="1597873">&lt;</span>&nbsp;<span class="builtinfunc" id="1597875">len</span><span class="op" id="1597878">(</span><span class="ident" id="1597879">r</span><span class="op" id="1597880">.</span><span class="ident" id="1597881">Stack0</span><span class="op" id="1597887">)</span><span class="op" id="1597888">;</span>&nbsp;<span class="ident" id="1597890">i</span><span class="op" id="1597891">++</span>&nbsp;<span class="op" id="1597894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597900">r</span><span class="op" id="1597901">.</span><span class="ident" id="1597902">Stack0</span><span class="op" id="1597908">[</span><span class="ident" id="1597909">i</span><span class="op" id="1597910">]</span>&nbsp;<span class="op" id="1597912">=</span>&nbsp;<span class="num" id="1597914">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1597919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597924">p</span>&nbsp;<span class="op" id="1597926">=</span>&nbsp;<span class="ident" id="1597928">p</span><span class="op" id="1597929">[</span><span class="num" id="1597930">1</span><span class="op" id="1597931">:</span><span class="op" id="1597932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1597936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1597939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597942">unlock</span><span class="op" id="1597948">(</span><span class="op" id="1597949">&amp;</span><span class="ident" id="1597950">proflock</span><span class="op" id="1597958">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1597961">return</span><br>
<span class="lineno"></span><span class="op" id="1597968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1597971">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1598059">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1598145">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1598223">//</span><br>
<span class="lineno"></span><span class="comment" id="1598226">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1598287">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1598331">func</span>&nbsp;<span class="ident" id="1598336">ThreadCreateProfile</span><span class="op" id="1598355">(</span><span class="ident" id="1598356">p</span>&nbsp;<span class="op" id="1598358">[</span><span class="op" id="1598359">]</span><span class="ident" id="1598360">StackRecord</span><span class="op" id="1598371">)</span>&nbsp;<span class="op" id="1598373">(</span><span class="ident" id="1598374">n</span>&nbsp;<span class="builtintype" id="1598376">int</span><span class="op" id="1598379">,</span>&nbsp;<span class="ident" id="1598381">ok</span>&nbsp;<span class="builtintype" id="1598384">bool</span><span class="op" id="1598388">)</span>&nbsp;<span class="op" id="1598390">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598393">first</span>&nbsp;<span class="op" id="1598399">:=</span>&nbsp;<span class="op" id="1598402">(</span><span class="op" id="1598403">*</span><span class="ident" id="1598404">m</span><span class="op" id="1598405">)</span><span class="op" id="1598406">(</span><span class="ident" id="1598407">atomicloadp</span><span class="op" id="1598418">(</span><span class="ident" id="1598419">unsafe</span><span class="op" id="1598425">.</span><span class="ident" id="1598426">Pointer</span><span class="op" id="1598433">(</span><span class="op" id="1598434">&amp;</span><span class="ident" id="1598435">allm</span><span class="op" id="1598439">)</span><span class="op" id="1598440">)</span><span class="op" id="1598441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1598444">for</span>&nbsp;<span class="ident" id="1598448">mp</span>&nbsp;<span class="op" id="1598451">:=</span>&nbsp;<span class="ident" id="1598454">first</span><span class="op" id="1598459">;</span>&nbsp;<span class="ident" id="1598461">mp</span>&nbsp;<span class="op" id="1598464">!=</span>&nbsp;<span class="builtintype" id="1598467">nil</span><span class="op" id="1598470">;</span>&nbsp;<span class="ident" id="1598472">mp</span>&nbsp;<span class="op" id="1598475">=</span>&nbsp;<span class="ident" id="1598477">mp</span><span class="op" id="1598479">.</span><span class="ident" id="1598480">alllink</span>&nbsp;<span class="op" id="1598488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598492">n</span><span class="op" id="1598493">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1598497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1598500">if</span>&nbsp;<span class="ident" id="1598503">n</span>&nbsp;<span class="op" id="1598505">&lt;=</span>&nbsp;<span class="builtinfunc" id="1598508">len</span><span class="op" id="1598511">(</span><span class="ident" id="1598512">p</span><span class="op" id="1598513">)</span>&nbsp;<span class="op" id="1598515">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598519">ok</span>&nbsp;<span class="op" id="1598522">=</span>&nbsp;<span class="builtintype" id="1598524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598531">i</span>&nbsp;<span class="op" id="1598533">:=</span>&nbsp;<span class="num" id="1598536">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1598540">for</span>&nbsp;<span class="ident" id="1598544">mp</span>&nbsp;<span class="op" id="1598547">:=</span>&nbsp;<span class="ident" id="1598550">first</span><span class="op" id="1598555">;</span>&nbsp;<span class="ident" id="1598557">mp</span>&nbsp;<span class="op" id="1598560">!=</span>&nbsp;<span class="builtintype" id="1598563">nil</span><span class="op" id="1598566">;</span>&nbsp;<span class="ident" id="1598568">mp</span>&nbsp;<span class="op" id="1598571">=</span>&nbsp;<span class="ident" id="1598573">mp</span><span class="op" id="1598575">.</span><span class="ident" id="1598576">alllink</span>&nbsp;<span class="op" id="1598584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1598589">for</span>&nbsp;<span class="ident" id="1598593">s</span>&nbsp;<span class="op" id="1598595">:=</span>&nbsp;<span class="keyword" id="1598598">range</span>&nbsp;<span class="ident" id="1598604">mp</span><span class="op" id="1598606">.</span><span class="ident" id="1598607">createstack</span>&nbsp;<span class="op" id="1598619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598625">p</span><span class="op" id="1598626">[</span><span class="ident" id="1598627">i</span><span class="op" id="1598628">]</span><span class="op" id="1598629">.</span><span class="ident" id="1598630">Stack0</span><span class="op" id="1598636">[</span><span class="ident" id="1598637">s</span><span class="op" id="1598638">]</span>&nbsp;<span class="op" id="1598640">=</span>&nbsp;<span class="builtintype" id="1598642">uintptr</span><span class="op" id="1598649">(</span><span class="ident" id="1598650">mp</span><span class="op" id="1598652">.</span><span class="ident" id="1598653">createstack</span><span class="op" id="1598664">[</span><span class="ident" id="1598665">s</span><span class="op" id="1598666">]</span><span class="op" id="1598667">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1598672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598677">i</span><span class="op" id="1598678">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1598683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1598686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1598689">return</span><br>
<span class="lineno">520</span><span class="op" id="1598696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598699">var</span>&nbsp;<span class="ident" id="1598703">allgs</span>&nbsp;<span class="op" id="1598709">[</span><span class="op" id="1598710">]</span><span class="op" id="1598711">*</span><span class="ident" id="1598712">g</span>&nbsp;<span class="comment" id="1598714">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1598725">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1598817">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1598900">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1598975">//</span><br>
<span class="lineno"></span><span class="comment" id="1598978">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1599039">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1599080">func</span>&nbsp;<span class="ident" id="1599085">GoroutineProfile</span><span class="op" id="1599101">(</span><span class="ident" id="1599102">p</span>&nbsp;<span class="op" id="1599104">[</span><span class="op" id="1599105">]</span><span class="ident" id="1599106">StackRecord</span><span class="op" id="1599117">)</span>&nbsp;<span class="op" id="1599119">(</span><span class="ident" id="1599120">n</span>&nbsp;<span class="builtintype" id="1599122">int</span><span class="op" id="1599125">,</span>&nbsp;<span class="ident" id="1599127">ok</span>&nbsp;<span class="builtintype" id="1599130">bool</span><span class="op" id="1599134">)</span>&nbsp;<span class="op" id="1599136">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599140">n</span>&nbsp;<span class="op" id="1599142">=</span>&nbsp;<span class="ident" id="1599144">NumGoroutine</span><span class="op" id="1599156">(</span><span class="op" id="1599157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599160">if</span>&nbsp;<span class="ident" id="1599163">n</span>&nbsp;<span class="op" id="1599165">&lt;=</span>&nbsp;<span class="builtinfunc" id="1599168">len</span><span class="op" id="1599171">(</span><span class="ident" id="1599172">p</span><span class="op" id="1599173">)</span>&nbsp;<span class="op" id="1599175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599179">gp</span>&nbsp;<span class="op" id="1599182">:=</span>&nbsp;<span class="ident" id="1599185">getg</span><span class="op" id="1599189">(</span><span class="op" id="1599190">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599194">semacquire</span><span class="op" id="1599204">(</span><span class="op" id="1599205">&amp;</span><span class="ident" id="1599206">worldsema</span><span class="op" id="1599215">,</span>&nbsp;<span class="builtintype" id="1599217">false</span><span class="op" id="1599222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599226">gp</span><span class="op" id="1599228">.</span><span class="ident" id="1599229">m</span><span class="op" id="1599230">.</span><span class="ident" id="1599231">gcing</span>&nbsp;<span class="op" id="1599237">=</span>&nbsp;<span class="num" id="1599239">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599243">onM</span><span class="op" id="1599246">(</span><span class="ident" id="1599247">stoptheworld</span><span class="op" id="1599259">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599264">n</span>&nbsp;<span class="op" id="1599266">=</span>&nbsp;<span class="ident" id="1599268">NumGoroutine</span><span class="op" id="1599280">(</span><span class="op" id="1599281">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599285">if</span>&nbsp;<span class="ident" id="1599288">n</span>&nbsp;<span class="op" id="1599290">&lt;=</span>&nbsp;<span class="builtinfunc" id="1599293">len</span><span class="op" id="1599296">(</span><span class="ident" id="1599297">p</span><span class="op" id="1599298">)</span>&nbsp;<span class="op" id="1599300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599305">ok</span>&nbsp;<span class="op" id="1599308">=</span>&nbsp;<span class="builtintype" id="1599310">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599318">r</span>&nbsp;<span class="op" id="1599320">:=</span>&nbsp;<span class="ident" id="1599323">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599328">sp</span>&nbsp;<span class="op" id="1599331">:=</span>&nbsp;<span class="ident" id="1599334">getcallersp</span><span class="op" id="1599345">(</span><span class="ident" id="1599346">unsafe</span><span class="op" id="1599352">.</span><span class="ident" id="1599353">Pointer</span><span class="op" id="1599360">(</span><span class="op" id="1599361">&amp;</span><span class="ident" id="1599362">p</span><span class="op" id="1599363">)</span><span class="op" id="1599364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599369">pc</span>&nbsp;<span class="op" id="1599372">:=</span>&nbsp;<span class="ident" id="1599375">getcallerpc</span><span class="op" id="1599386">(</span><span class="ident" id="1599387">unsafe</span><span class="op" id="1599393">.</span><span class="ident" id="1599394">Pointer</span><span class="op" id="1599401">(</span><span class="op" id="1599402">&amp;</span><span class="ident" id="1599403">p</span><span class="op" id="1599404">)</span><span class="op" id="1599405">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599410">onM</span><span class="op" id="1599413">(</span><span class="keyword" id="1599414">func</span><span class="op" id="1599418">(</span><span class="op" id="1599419">)</span>&nbsp;<span class="op" id="1599421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599427">saveg</span><span class="op" id="1599432">(</span><span class="ident" id="1599433">pc</span><span class="op" id="1599435">,</span>&nbsp;<span class="ident" id="1599437">sp</span><span class="op" id="1599439">,</span>&nbsp;<span class="ident" id="1599441">gp</span><span class="op" id="1599443">,</span>&nbsp;<span class="op" id="1599445">&amp;</span><span class="ident" id="1599446">r</span><span class="op" id="1599447">[</span><span class="num" id="1599448">0</span><span class="op" id="1599449">]</span><span class="op" id="1599450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599455">}</span><span class="op" id="1599456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599461">r</span>&nbsp;<span class="op" id="1599463">=</span>&nbsp;<span class="ident" id="1599465">r</span><span class="op" id="1599466">[</span><span class="num" id="1599467">1</span><span class="op" id="1599468">:</span><span class="op" id="1599469">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599474">for</span>&nbsp;<span class="ident" id="1599478">_</span><span class="op" id="1599479">,</span>&nbsp;<span class="ident" id="1599481">gp1</span>&nbsp;<span class="op" id="1599485">:=</span>&nbsp;<span class="keyword" id="1599488">range</span>&nbsp;<span class="ident" id="1599494">allgs</span>&nbsp;<span class="op" id="1599500">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599506">if</span>&nbsp;<span class="ident" id="1599509">gp1</span>&nbsp;<span class="op" id="1599513">==</span>&nbsp;<span class="ident" id="1599516">gp</span>&nbsp;<span class="op" id="1599519">||</span>&nbsp;<span class="ident" id="1599522">readgstatus</span><span class="op" id="1599533">(</span><span class="ident" id="1599534">gp1</span><span class="op" id="1599537">)</span>&nbsp;<span class="op" id="1599539">==</span>&nbsp;<span class="ident" id="1599542">_Gdead</span>&nbsp;<span class="op" id="1599549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599556">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599575">saveg</span><span class="op" id="1599580">(</span><span class="op" id="1599581">^</span><span class="builtintype" id="1599582">uintptr</span><span class="op" id="1599589">(</span><span class="num" id="1599590">0</span><span class="op" id="1599591">)</span><span class="op" id="1599592">,</span>&nbsp;<span class="op" id="1599594">^</span><span class="builtintype" id="1599595">uintptr</span><span class="op" id="1599602">(</span><span class="num" id="1599603">0</span><span class="op" id="1599604">)</span><span class="op" id="1599605">,</span>&nbsp;<span class="ident" id="1599607">gp1</span><span class="op" id="1599610">,</span>&nbsp;<span class="op" id="1599612">&amp;</span><span class="ident" id="1599613">r</span><span class="op" id="1599614">[</span><span class="num" id="1599615">0</span><span class="op" id="1599616">]</span><span class="op" id="1599617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599623">r</span>&nbsp;<span class="op" id="1599625">=</span>&nbsp;<span class="ident" id="1599627">r</span><span class="op" id="1599628">[</span><span class="num" id="1599629">1</span><span class="op" id="1599630">:</span><span class="op" id="1599631">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599645">gp</span><span class="op" id="1599647">.</span><span class="ident" id="1599648">m</span><span class="op" id="1599649">.</span><span class="ident" id="1599650">gcing</span>&nbsp;<span class="op" id="1599656">=</span>&nbsp;<span class="num" id="1599658">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599662">semrelease</span><span class="op" id="1599672">(</span><span class="op" id="1599673">&amp;</span><span class="ident" id="1599674">worldsema</span><span class="op" id="1599683">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599687">onM</span><span class="op" id="1599690">(</span><span class="ident" id="1599691">starttheworld</span><span class="op" id="1599704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599711">return</span>&nbsp;<span class="ident" id="1599718">n</span><span class="op" id="1599719">,</span>&nbsp;<span class="ident" id="1599721">ok</span><br>
<span class="lineno"></span><span class="op" id="1599724">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1599727">func</span>&nbsp;<span class="ident" id="1599732">saveg</span><span class="op" id="1599737">(</span><span class="ident" id="1599738">pc</span><span class="op" id="1599740">,</span>&nbsp;<span class="ident" id="1599742">sp</span>&nbsp;<span class="builtintype" id="1599745">uintptr</span><span class="op" id="1599752">,</span>&nbsp;<span class="ident" id="1599754">gp</span>&nbsp;<span class="op" id="1599757">*</span><span class="ident" id="1599758">g</span><span class="op" id="1599759">,</span>&nbsp;<span class="ident" id="1599761">r</span>&nbsp;<span class="op" id="1599763">*</span><span class="ident" id="1599764">StackRecord</span><span class="op" id="1599775">)</span>&nbsp;<span class="op" id="1599777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599780">n</span>&nbsp;<span class="op" id="1599782">:=</span>&nbsp;<span class="ident" id="1599785">gentraceback</span><span class="op" id="1599797">(</span><span class="ident" id="1599798">pc</span><span class="op" id="1599800">,</span>&nbsp;<span class="ident" id="1599802">sp</span><span class="op" id="1599804">,</span>&nbsp;<span class="num" id="1599806">0</span><span class="op" id="1599807">,</span>&nbsp;<span class="ident" id="1599809">gp</span><span class="op" id="1599811">,</span>&nbsp;<span class="num" id="1599813">0</span><span class="op" id="1599814">,</span>&nbsp;<span class="op" id="1599816">&amp;</span><span class="ident" id="1599817">r</span><span class="op" id="1599818">.</span><span class="ident" id="1599819">Stack0</span><span class="op" id="1599825">[</span><span class="num" id="1599826">0</span><span class="op" id="1599827">]</span><span class="op" id="1599828">,</span>&nbsp;<span class="builtinfunc" id="1599830">len</span><span class="op" id="1599833">(</span><span class="ident" id="1599834">r</span><span class="op" id="1599835">.</span><span class="ident" id="1599836">Stack0</span><span class="op" id="1599842">)</span><span class="op" id="1599843">,</span>&nbsp;<span class="builtintype" id="1599845">nil</span><span class="op" id="1599848">,</span>&nbsp;<span class="builtintype" id="1599850">nil</span><span class="op" id="1599853">,</span>&nbsp;<span class="num" id="1599855">0</span><span class="op" id="1599856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599859">if</span>&nbsp;<span class="ident" id="1599862">n</span>&nbsp;<span class="op" id="1599864">&lt;</span>&nbsp;<span class="builtinfunc" id="1599866">len</span><span class="op" id="1599869">(</span><span class="ident" id="1599870">r</span><span class="op" id="1599871">.</span><span class="ident" id="1599872">Stack0</span><span class="op" id="1599878">)</span>&nbsp;<span class="op" id="1599880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599884">r</span><span class="op" id="1599885">.</span><span class="ident" id="1599886">Stack0</span><span class="op" id="1599892">[</span><span class="ident" id="1599893">n</span><span class="op" id="1599894">]</span>&nbsp;<span class="op" id="1599896">=</span>&nbsp;<span class="num" id="1599898">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599901">}</span><br>
<span class="lineno"></span><span class="op" id="1599903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599906">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1599971">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1600022">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1600092">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1600147">func</span>&nbsp;<span class="ident" id="1600152">Stack</span><span class="op" id="1600157">(</span><span class="ident" id="1600158">buf</span>&nbsp;<span class="op" id="1600162">[</span><span class="op" id="1600163">]</span><span class="builtintype" id="1600164">byte</span><span class="op" id="1600168">,</span>&nbsp;<span class="ident" id="1600170">all</span>&nbsp;<span class="builtintype" id="1600174">bool</span><span class="op" id="1600178">)</span>&nbsp;<span class="builtintype" id="1600180">int</span>&nbsp;<span class="op" id="1600184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600187">mp</span>&nbsp;<span class="op" id="1600190">:=</span>&nbsp;<span class="ident" id="1600193">acquirem</span><span class="op" id="1600201">(</span><span class="op" id="1600202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600205">gp</span>&nbsp;<span class="op" id="1600208">:=</span>&nbsp;<span class="ident" id="1600211">mp</span><span class="op" id="1600213">.</span><span class="ident" id="1600214">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600220">if</span>&nbsp;<span class="ident" id="1600223">all</span>&nbsp;<span class="op" id="1600227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600231">semacquire</span><span class="op" id="1600241">(</span><span class="op" id="1600242">&amp;</span><span class="ident" id="1600243">worldsema</span><span class="op" id="1600252">,</span>&nbsp;<span class="builtintype" id="1600254">false</span><span class="op" id="1600259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600263">mp</span><span class="op" id="1600265">.</span><span class="ident" id="1600266">gcing</span>&nbsp;<span class="op" id="1600272">=</span>&nbsp;<span class="num" id="1600274">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600278">releasem</span><span class="op" id="1600286">(</span><span class="ident" id="1600287">mp</span><span class="op" id="1600289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600293">onM</span><span class="op" id="1600296">(</span><span class="ident" id="1600297">stoptheworld</span><span class="op" id="1600309">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600313">if</span>&nbsp;<span class="ident" id="1600316">mp</span>&nbsp;<span class="op" id="1600319">!=</span>&nbsp;<span class="ident" id="1600322">acquirem</span><span class="op" id="1600330">(</span><span class="op" id="1600331">)</span>&nbsp;<span class="op" id="1600333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600338">gothrow</span><span class="op" id="1600345">(</span><span class="string" id="1600346">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1600366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600377">n</span>&nbsp;<span class="op" id="1600379">:=</span>&nbsp;<span class="num" id="1600382">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600385">if</span>&nbsp;<span class="builtinfunc" id="1600388">len</span><span class="op" id="1600391">(</span><span class="ident" id="1600392">buf</span><span class="op" id="1600395">)</span>&nbsp;<span class="op" id="1600397">&gt;</span>&nbsp;<span class="num" id="1600399">0</span>&nbsp;<span class="op" id="1600401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600405">sp</span>&nbsp;<span class="op" id="1600408">:=</span>&nbsp;<span class="ident" id="1600411">getcallersp</span><span class="op" id="1600422">(</span><span class="ident" id="1600423">unsafe</span><span class="op" id="1600429">.</span><span class="ident" id="1600430">Pointer</span><span class="op" id="1600437">(</span><span class="op" id="1600438">&amp;</span><span class="ident" id="1600439">buf</span><span class="op" id="1600442">)</span><span class="op" id="1600443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600447">pc</span>&nbsp;<span class="op" id="1600450">:=</span>&nbsp;<span class="ident" id="1600453">getcallerpc</span><span class="op" id="1600464">(</span><span class="ident" id="1600465">unsafe</span><span class="op" id="1600471">.</span><span class="ident" id="1600472">Pointer</span><span class="op" id="1600479">(</span><span class="op" id="1600480">&amp;</span><span class="ident" id="1600481">buf</span><span class="op" id="1600484">)</span><span class="op" id="1600485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600489">onM</span><span class="op" id="1600492">(</span><span class="keyword" id="1600493">func</span><span class="op" id="1600497">(</span><span class="op" id="1600498">)</span>&nbsp;<span class="op" id="1600500">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600505">g0</span>&nbsp;<span class="op" id="1600508">:=</span>&nbsp;<span class="ident" id="1600511">getg</span><span class="op" id="1600515">(</span><span class="op" id="1600516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600521">g0</span><span class="op" id="1600523">.</span><span class="ident" id="1600524">writebuf</span>&nbsp;<span class="op" id="1600533">=</span>&nbsp;<span class="ident" id="1600535">buf</span><span class="op" id="1600538">[</span><span class="num" id="1600539">0</span><span class="op" id="1600540">:</span><span class="num" id="1600541">0</span><span class="op" id="1600542">:</span><span class="builtinfunc" id="1600543">len</span><span class="op" id="1600546">(</span><span class="ident" id="1600547">buf</span><span class="op" id="1600550">)</span><span class="op" id="1600551">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600556">goroutineheader</span><span class="op" id="1600571">(</span><span class="ident" id="1600572">gp</span><span class="op" id="1600574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600579">traceback</span><span class="op" id="1600588">(</span><span class="ident" id="1600589">pc</span><span class="op" id="1600591">,</span>&nbsp;<span class="ident" id="1600593">sp</span><span class="op" id="1600595">,</span>&nbsp;<span class="num" id="1600597">0</span><span class="op" id="1600598">,</span>&nbsp;<span class="ident" id="1600600">gp</span><span class="op" id="1600602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600607">if</span>&nbsp;<span class="ident" id="1600610">all</span>&nbsp;<span class="op" id="1600614">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600620">tracebackothers</span><span class="op" id="1600635">(</span><span class="ident" id="1600636">gp</span><span class="op" id="1600638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600648">n</span>&nbsp;<span class="op" id="1600650">=</span>&nbsp;<span class="builtinfunc" id="1600652">len</span><span class="op" id="1600655">(</span><span class="ident" id="1600656">g0</span><span class="op" id="1600658">.</span><span class="ident" id="1600659">writebuf</span><span class="op" id="1600667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600672">g0</span><span class="op" id="1600674">.</span><span class="ident" id="1600675">writebuf</span>&nbsp;<span class="op" id="1600684">=</span>&nbsp;<span class="builtintype" id="1600686">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600692">}</span><span class="op" id="1600693">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600700">if</span>&nbsp;<span class="ident" id="1600703">all</span>&nbsp;<span class="op" id="1600707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600711">mp</span><span class="op" id="1600713">.</span><span class="ident" id="1600714">gcing</span>&nbsp;<span class="op" id="1600720">=</span>&nbsp;<span class="num" id="1600722">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600726">semrelease</span><span class="op" id="1600736">(</span><span class="op" id="1600737">&amp;</span><span class="ident" id="1600738">worldsema</span><span class="op" id="1600747">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600751">onM</span><span class="op" id="1600754">(</span><span class="ident" id="1600755">starttheworld</span><span class="op" id="1600768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600774">releasem</span><span class="op" id="1600782">(</span><span class="ident" id="1600783">mp</span><span class="op" id="1600785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600788">return</span>&nbsp;<span class="ident" id="1600795">n</span><br>
<span class="lineno"></span><span class="op" id="1600797">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1600800">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600830">var</span>&nbsp;<span class="ident" id="1600834">tracelock</span>&nbsp;<span class="ident" id="1600844">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1600851">func</span>&nbsp;<span class="ident" id="1600856">tracealloc</span><span class="op" id="1600866">(</span><span class="ident" id="1600867">p</span>&nbsp;<span class="ident" id="1600869">unsafe</span><span class="op" id="1600875">.</span><span class="ident" id="1600876">Pointer</span><span class="op" id="1600883">,</span>&nbsp;<span class="ident" id="1600885">size</span>&nbsp;<span class="builtintype" id="1600890">uintptr</span><span class="op" id="1600897">,</span>&nbsp;<span class="ident" id="1600899">typ</span>&nbsp;<span class="op" id="1600903">*</span><span class="ident" id="1600904">_type</span><span class="op" id="1600909">)</span>&nbsp;<span class="op" id="1600911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600914">lock</span><span class="op" id="1600918">(</span><span class="op" id="1600919">&amp;</span><span class="ident" id="1600920">tracelock</span><span class="op" id="1600929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600932">gp</span>&nbsp;<span class="op" id="1600935">:=</span>&nbsp;<span class="ident" id="1600938">getg</span><span class="op" id="1600942">(</span><span class="op" id="1600943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600946">gp</span><span class="op" id="1600948">.</span><span class="ident" id="1600949">m</span><span class="op" id="1600950">.</span><span class="ident" id="1600951">traceback</span>&nbsp;<span class="op" id="1600961">=</span>&nbsp;<span class="num" id="1600963">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600966">if</span>&nbsp;<span class="ident" id="1600969">typ</span>&nbsp;<span class="op" id="1600973">==</span>&nbsp;<span class="builtintype" id="1600976">nil</span>&nbsp;<span class="op" id="1600980">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1600984">print</span><span class="op" id="1600989">(</span><span class="string" id="1600990">&#34;tracealloc(&#34;</span><span class="op" id="1601003">,</span>&nbsp;<span class="ident" id="1601005">p</span><span class="op" id="1601006">,</span>&nbsp;<span class="string" id="1601008">&#34;,&nbsp;&#34;</span><span class="op" id="1601012">,</span>&nbsp;<span class="ident" id="1601014">hex</span><span class="op" id="1601017">(</span><span class="ident" id="1601018">size</span><span class="op" id="1601022">)</span><span class="op" id="1601023">,</span>&nbsp;<span class="string" id="1601025">&#34;)\n&#34;</span><span class="op" id="1601030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601033">}</span>&nbsp;<span class="keyword" id="1601035">else</span>&nbsp;<span class="op" id="1601040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601044">print</span><span class="op" id="1601049">(</span><span class="string" id="1601050">&#34;tracealloc(&#34;</span><span class="op" id="1601063">,</span>&nbsp;<span class="ident" id="1601065">p</span><span class="op" id="1601066">,</span>&nbsp;<span class="string" id="1601068">&#34;,&nbsp;&#34;</span><span class="op" id="1601072">,</span>&nbsp;<span class="ident" id="1601074">hex</span><span class="op" id="1601077">(</span><span class="ident" id="1601078">size</span><span class="op" id="1601082">)</span><span class="op" id="1601083">,</span>&nbsp;<span class="string" id="1601085">&#34;,&nbsp;&#34;</span><span class="op" id="1601089">,</span>&nbsp;<span class="op" id="1601091">*</span><span class="ident" id="1601092">typ</span><span class="op" id="1601095">.</span><span class="ident" id="1601096">_string</span><span class="op" id="1601103">,</span>&nbsp;<span class="string" id="1601105">&#34;)\n&#34;</span><span class="op" id="1601110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601116">if</span>&nbsp;<span class="ident" id="1601119">gp</span><span class="op" id="1601121">.</span><span class="ident" id="1601122">m</span><span class="op" id="1601123">.</span><span class="ident" id="1601124">curg</span>&nbsp;<span class="op" id="1601129">==</span>&nbsp;<span class="builtintype" id="1601132">nil</span>&nbsp;<span class="op" id="1601136">||</span>&nbsp;<span class="ident" id="1601139">gp</span>&nbsp;<span class="op" id="1601142">==</span>&nbsp;<span class="ident" id="1601145">gp</span><span class="op" id="1601147">.</span><span class="ident" id="1601148">m</span><span class="op" id="1601149">.</span><span class="ident" id="1601150">curg</span>&nbsp;<span class="op" id="1601155">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601159">goroutineheader</span><span class="op" id="1601174">(</span><span class="ident" id="1601175">gp</span><span class="op" id="1601177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601181">pc</span>&nbsp;<span class="op" id="1601184">:=</span>&nbsp;<span class="ident" id="1601187">getcallerpc</span><span class="op" id="1601198">(</span><span class="ident" id="1601199">unsafe</span><span class="op" id="1601205">.</span><span class="ident" id="1601206">Pointer</span><span class="op" id="1601213">(</span><span class="op" id="1601214">&amp;</span><span class="ident" id="1601215">p</span><span class="op" id="1601216">)</span><span class="op" id="1601217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601221">sp</span>&nbsp;<span class="op" id="1601224">:=</span>&nbsp;<span class="ident" id="1601227">getcallersp</span><span class="op" id="1601238">(</span><span class="ident" id="1601239">unsafe</span><span class="op" id="1601245">.</span><span class="ident" id="1601246">Pointer</span><span class="op" id="1601253">(</span><span class="op" id="1601254">&amp;</span><span class="ident" id="1601255">p</span><span class="op" id="1601256">)</span><span class="op" id="1601257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601261">onM</span><span class="op" id="1601264">(</span><span class="keyword" id="1601265">func</span><span class="op" id="1601269">(</span><span class="op" id="1601270">)</span>&nbsp;<span class="op" id="1601272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601277">traceback</span><span class="op" id="1601286">(</span><span class="ident" id="1601287">pc</span><span class="op" id="1601289">,</span>&nbsp;<span class="ident" id="1601291">sp</span><span class="op" id="1601293">,</span>&nbsp;<span class="num" id="1601295">0</span><span class="op" id="1601296">,</span>&nbsp;<span class="ident" id="1601298">gp</span><span class="op" id="1601300">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601304">}</span><span class="op" id="1601305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601308">}</span>&nbsp;<span class="keyword" id="1601310">else</span>&nbsp;<span class="op" id="1601315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601319">goroutineheader</span><span class="op" id="1601334">(</span><span class="ident" id="1601335">gp</span><span class="op" id="1601337">.</span><span class="ident" id="1601338">m</span><span class="op" id="1601339">.</span><span class="ident" id="1601340">curg</span><span class="op" id="1601344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601348">traceback</span><span class="op" id="1601357">(</span><span class="op" id="1601358">^</span><span class="builtintype" id="1601359">uintptr</span><span class="op" id="1601366">(</span><span class="num" id="1601367">0</span><span class="op" id="1601368">)</span><span class="op" id="1601369">,</span>&nbsp;<span class="op" id="1601371">^</span><span class="builtintype" id="1601372">uintptr</span><span class="op" id="1601379">(</span><span class="num" id="1601380">0</span><span class="op" id="1601381">)</span><span class="op" id="1601382">,</span>&nbsp;<span class="num" id="1601384">0</span><span class="op" id="1601385">,</span>&nbsp;<span class="ident" id="1601387">gp</span><span class="op" id="1601389">.</span><span class="ident" id="1601390">m</span><span class="op" id="1601391">.</span><span class="ident" id="1601392">curg</span><span class="op" id="1601396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601399">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601402">print</span><span class="op" id="1601407">(</span><span class="string" id="1601408">&#34;\n&#34;</span><span class="op" id="1601412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601415">gp</span><span class="op" id="1601417">.</span><span class="ident" id="1601418">m</span><span class="op" id="1601419">.</span><span class="ident" id="1601420">traceback</span>&nbsp;<span class="op" id="1601430">=</span>&nbsp;<span class="num" id="1601432">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601435">unlock</span><span class="op" id="1601441">(</span><span class="op" id="1601442">&amp;</span><span class="ident" id="1601443">tracelock</span><span class="op" id="1601452">)</span><br>
<span class="lineno"></span><span class="op" id="1601454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1601457">func</span>&nbsp;<span class="ident" id="1601462">tracefree</span><span class="op" id="1601471">(</span><span class="ident" id="1601472">p</span>&nbsp;<span class="ident" id="1601474">unsafe</span><span class="op" id="1601480">.</span><span class="ident" id="1601481">Pointer</span><span class="op" id="1601488">,</span>&nbsp;<span class="ident" id="1601490">size</span>&nbsp;<span class="builtintype" id="1601495">uintptr</span><span class="op" id="1601502">)</span>&nbsp;<span class="op" id="1601504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601507">lock</span><span class="op" id="1601511">(</span><span class="op" id="1601512">&amp;</span><span class="ident" id="1601513">tracelock</span><span class="op" id="1601522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601525">gp</span>&nbsp;<span class="op" id="1601528">:=</span>&nbsp;<span class="ident" id="1601531">getg</span><span class="op" id="1601535">(</span><span class="op" id="1601536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601539">gp</span><span class="op" id="1601541">.</span><span class="ident" id="1601542">m</span><span class="op" id="1601543">.</span><span class="ident" id="1601544">traceback</span>&nbsp;<span class="op" id="1601554">=</span>&nbsp;<span class="num" id="1601556">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601559">print</span><span class="op" id="1601564">(</span><span class="string" id="1601565">&#34;tracefree(&#34;</span><span class="op" id="1601577">,</span>&nbsp;<span class="ident" id="1601579">p</span><span class="op" id="1601580">,</span>&nbsp;<span class="string" id="1601582">&#34;,&nbsp;&#34;</span><span class="op" id="1601586">,</span>&nbsp;<span class="ident" id="1601588">hex</span><span class="op" id="1601591">(</span><span class="ident" id="1601592">size</span><span class="op" id="1601596">)</span><span class="op" id="1601597">,</span>&nbsp;<span class="string" id="1601599">&#34;)\n&#34;</span><span class="op" id="1601604">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601607">goroutineheader</span><span class="op" id="1601622">(</span><span class="ident" id="1601623">gp</span><span class="op" id="1601625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601628">pc</span>&nbsp;<span class="op" id="1601631">:=</span>&nbsp;<span class="ident" id="1601634">getcallerpc</span><span class="op" id="1601645">(</span><span class="ident" id="1601646">unsafe</span><span class="op" id="1601652">.</span><span class="ident" id="1601653">Pointer</span><span class="op" id="1601660">(</span><span class="op" id="1601661">&amp;</span><span class="ident" id="1601662">p</span><span class="op" id="1601663">)</span><span class="op" id="1601664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601667">sp</span>&nbsp;<span class="op" id="1601670">:=</span>&nbsp;<span class="ident" id="1601673">getcallersp</span><span class="op" id="1601684">(</span><span class="ident" id="1601685">unsafe</span><span class="op" id="1601691">.</span><span class="ident" id="1601692">Pointer</span><span class="op" id="1601699">(</span><span class="op" id="1601700">&amp;</span><span class="ident" id="1601701">p</span><span class="op" id="1601702">)</span><span class="op" id="1601703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601706">onM</span><span class="op" id="1601709">(</span><span class="keyword" id="1601710">func</span><span class="op" id="1601714">(</span><span class="op" id="1601715">)</span>&nbsp;<span class="op" id="1601717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601721">traceback</span><span class="op" id="1601730">(</span><span class="ident" id="1601731">pc</span><span class="op" id="1601733">,</span>&nbsp;<span class="ident" id="1601735">sp</span><span class="op" id="1601737">,</span>&nbsp;<span class="num" id="1601739">0</span><span class="op" id="1601740">,</span>&nbsp;<span class="ident" id="1601742">gp</span><span class="op" id="1601744">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601747">}</span><span class="op" id="1601748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601751">print</span><span class="op" id="1601756">(</span><span class="string" id="1601757">&#34;\n&#34;</span><span class="op" id="1601761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601764">gp</span><span class="op" id="1601766">.</span><span class="ident" id="1601767">m</span><span class="op" id="1601768">.</span><span class="ident" id="1601769">traceback</span>&nbsp;<span class="op" id="1601779">=</span>&nbsp;<span class="num" id="1601781">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601784">unlock</span><span class="op" id="1601790">(</span><span class="op" id="1601791">&amp;</span><span class="ident" id="1601792">tracelock</span><span class="op" id="1601801">)</span><br>
<span class="lineno"></span><span class="op" id="1601803">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1601806">func</span>&nbsp;<span class="ident" id="1601811">tracegc</span><span class="op" id="1601818">(</span><span class="op" id="1601819">)</span>&nbsp;<span class="op" id="1601821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601824">lock</span><span class="op" id="1601828">(</span><span class="op" id="1601829">&amp;</span><span class="ident" id="1601830">tracelock</span><span class="op" id="1601839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601842">gp</span>&nbsp;<span class="op" id="1601845">:=</span>&nbsp;<span class="ident" id="1601848">getg</span><span class="op" id="1601852">(</span><span class="op" id="1601853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601856">gp</span><span class="op" id="1601858">.</span><span class="ident" id="1601859">m</span><span class="op" id="1601860">.</span><span class="ident" id="1601861">traceback</span>&nbsp;<span class="op" id="1601871">=</span>&nbsp;<span class="num" id="1601873">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601876">print</span><span class="op" id="1601881">(</span><span class="string" id="1601882">&#34;tracegc()\n&#34;</span><span class="op" id="1601895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601898">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601953">tracebackothers</span><span class="op" id="1601968">(</span><span class="ident" id="1601969">gp</span><span class="op" id="1601971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601974">print</span><span class="op" id="1601979">(</span><span class="string" id="1601980">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1601995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601998">print</span><span class="op" id="1602003">(</span><span class="string" id="1602004">&#34;\n&#34;</span><span class="op" id="1602008">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602011">gp</span><span class="op" id="1602013">.</span><span class="ident" id="1602014">m</span><span class="op" id="1602015">.</span><span class="ident" id="1602016">traceback</span>&nbsp;<span class="op" id="1602026">=</span>&nbsp;<span class="num" id="1602028">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602031">unlock</span><span class="op" id="1602037">(</span><span class="op" id="1602038">&amp;</span><span class="ident" id="1602039">tracelock</span><span class="op" id="1602048">)</span><br>
<span class="lineno"></span><span class="op" id="1602050">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
