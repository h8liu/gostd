<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html" class="current">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7502535">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7502590">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7502644">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7502695">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7502760">package</span>&nbsp;<span class="ident" id="7502768">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7502773">import</span>&nbsp;<span class="op" id="7502780">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502783">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502789">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502802">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502808">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502816">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502827">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7502838">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7502845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7502848">var</span>&nbsp;<span class="ident" id="7502852">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="7502878">=</span>&nbsp;<span class="op" id="7502880">[</span><span class="op" id="7502881">]</span><span class="keyword" id="7502882">struct</span>&nbsp;<span class="op" id="7502889">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7502892">server</span>&nbsp;&nbsp;<span class="builtintype" id="7502900">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7502908">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7502916">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7502924">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7502932">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7502940">timeout</span>&nbsp;<span class="builtintype" id="7502948">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7502953">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7502961">int</span><br>
<span class="lineno">25</span><span class="op" id="7502965">}</span><span class="op" id="7502966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7502969">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7503028">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503068">{</span><span class="string" id="7503069">&#34;8.8.8.8:53&#34;</span><span class="op" id="7503081">,</span>&nbsp;<span class="string" id="7503083">&#34;com.&#34;</span><span class="op" id="7503089">,</span>&nbsp;<span class="ident" id="7503091">dnsTypeALL</span><span class="op" id="7503101">,</span>&nbsp;<span class="num" id="7503103">2</span><span class="op" id="7503104">,</span>&nbsp;<span class="ident" id="7503106">dnsRcodeSuccess</span><span class="op" id="7503121">}</span><span class="op" id="7503122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503125">{</span><span class="string" id="7503126">&#34;8.8.4.4:53&#34;</span><span class="op" id="7503138">,</span>&nbsp;<span class="string" id="7503140">&#34;com.&#34;</span><span class="op" id="7503146">,</span>&nbsp;<span class="ident" id="7503148">dnsTypeALL</span><span class="op" id="7503158">,</span>&nbsp;<span class="num" id="7503160">4</span><span class="op" id="7503161">,</span>&nbsp;<span class="ident" id="7503163">dnsRcodeSuccess</span><span class="op" id="7503178">}</span><span class="op" id="7503179">,</span><br>
<span class="lineno">30</span><span class="op" id="7503181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7503184">func</span>&nbsp;<span class="ident" id="7503189">TestDNSTransportFallback</span><span class="op" id="7503213">(</span><span class="ident" id="7503214">t</span>&nbsp;<span class="op" id="7503216">*</span><span class="ident" id="7503217">testing</span><span class="op" id="7503224">.</span><span class="ident" id="7503225">T</span><span class="op" id="7503226">)</span>&nbsp;<span class="op" id="7503228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503231">if</span>&nbsp;<span class="ident" id="7503234">testing</span><span class="op" id="7503241">.</span><span class="ident" id="7503242">Short</span><span class="op" id="7503247">(</span><span class="op" id="7503248">)</span>&nbsp;<span class="op" id="7503250">||</span>&nbsp;<span class="op" id="7503253">!</span><span class="op" id="7503254">*</span><span class="ident" id="7503255">testExternal</span>&nbsp;<span class="op" id="7503268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503272">t</span><span class="op" id="7503273">.</span><span class="ident" id="7503274">Skip</span><span class="op" id="7503278">(</span><span class="string" id="7503279">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7503320">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503327">for</span>&nbsp;<span class="ident" id="7503331">_</span><span class="op" id="7503332">,</span>&nbsp;<span class="ident" id="7503334">tt</span>&nbsp;<span class="op" id="7503337">:=</span>&nbsp;<span class="keyword" id="7503340">range</span>&nbsp;<span class="ident" id="7503346">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="7503372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503376">timeout</span>&nbsp;<span class="op" id="7503384">:=</span>&nbsp;<span class="ident" id="7503387">time</span><span class="op" id="7503391">.</span><span class="ident" id="7503392">Duration</span><span class="op" id="7503400">(</span><span class="ident" id="7503401">tt</span><span class="op" id="7503403">.</span><span class="ident" id="7503404">timeout</span><span class="op" id="7503411">)</span>&nbsp;<span class="op" id="7503413">*</span>&nbsp;<span class="ident" id="7503415">time</span><span class="op" id="7503419">.</span><span class="ident" id="7503420">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503429">msg</span><span class="op" id="7503432">,</span>&nbsp;<span class="ident" id="7503434">err</span>&nbsp;<span class="op" id="7503438">:=</span>&nbsp;<span class="ident" id="7503441">exchange</span><span class="op" id="7503449">(</span><span class="ident" id="7503450">tt</span><span class="op" id="7503452">.</span><span class="ident" id="7503453">server</span><span class="op" id="7503459">,</span>&nbsp;<span class="ident" id="7503461">tt</span><span class="op" id="7503463">.</span><span class="ident" id="7503464">name</span><span class="op" id="7503468">,</span>&nbsp;<span class="ident" id="7503470">tt</span><span class="op" id="7503472">.</span><span class="ident" id="7503473">qtype</span><span class="op" id="7503478">,</span>&nbsp;<span class="ident" id="7503480">timeout</span><span class="op" id="7503487">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503491">if</span>&nbsp;<span class="ident" id="7503494">err</span>&nbsp;<span class="op" id="7503498">!=</span>&nbsp;<span class="ident" id="7503501">nil</span>&nbsp;<span class="op" id="7503505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503510">t</span><span class="op" id="7503511">.</span><span class="ident" id="7503512">Error</span><span class="op" id="7503517">(</span><span class="ident" id="7503518">err</span><span class="op" id="7503521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503526">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503541">switch</span>&nbsp;<span class="ident" id="7503548">msg</span><span class="op" id="7503551">.</span><span class="ident" id="7503552">rcode</span>&nbsp;<span class="op" id="7503558">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503562">case</span>&nbsp;<span class="ident" id="7503567">tt</span><span class="op" id="7503569">.</span><span class="ident" id="7503570">rcode</span><span class="op" id="7503575">,</span>&nbsp;<span class="ident" id="7503577">dnsRcodeServerFailure</span><span class="op" id="7503598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503602">default</span><span class="op" id="7503609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503614">t</span><span class="op" id="7503615">.</span><span class="ident" id="7503616">Errorf</span><span class="op" id="7503622">(</span><span class="string" id="7503623">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7503648">,</span>&nbsp;<span class="ident" id="7503650">msg</span><span class="op" id="7503653">.</span><span class="ident" id="7503654">rcode</span><span class="op" id="7503659">,</span>&nbsp;<span class="ident" id="7503661">tt</span><span class="op" id="7503663">.</span><span class="ident" id="7503664">server</span><span class="op" id="7503670">,</span>&nbsp;<span class="ident" id="7503672">tt</span><span class="op" id="7503674">.</span><span class="ident" id="7503675">rcode</span><span class="op" id="7503680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7503685">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503696">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503699">}</span><br>
<span class="lineno"></span><span class="op" id="7503701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7503704">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="7503771">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="7503788">var</span>&nbsp;<span class="ident" id="7503792">specialDomainNameTests</span>&nbsp;<span class="op" id="7503815">=</span>&nbsp;<span class="op" id="7503817">[</span><span class="op" id="7503818">]</span><span class="keyword" id="7503819">struct</span>&nbsp;<span class="op" id="7503826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503829">name</span>&nbsp;&nbsp;<span class="builtintype" id="7503835">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503843">qtype</span>&nbsp;<span class="builtintype" id="7503849">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7503857">rcode</span>&nbsp;<span class="builtintype" id="7503863">int</span><br>
<span class="lineno"></span><span class="op" id="7503867">}</span><span class="op" id="7503868">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7503871">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7503935">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7503962">{</span><span class="string" id="7503963">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="7503990">,</span>&nbsp;<span class="ident" id="7503992">dnsTypePTR</span><span class="op" id="7504002">,</span>&nbsp;<span class="ident" id="7504004">dnsRcodeNameError</span><span class="op" id="7504021">}</span><span class="op" id="7504022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504025">{</span><span class="string" id="7504026">&#34;test.&#34;</span><span class="op" id="7504033">,</span>&nbsp;<span class="ident" id="7504035">dnsTypeALL</span><span class="op" id="7504045">,</span>&nbsp;<span class="ident" id="7504047">dnsRcodeNameError</span><span class="op" id="7504064">}</span><span class="op" id="7504065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504068">{</span><span class="string" id="7504069">&#34;example.com.&#34;</span><span class="op" id="7504083">,</span>&nbsp;<span class="ident" id="7504085">dnsTypeALL</span><span class="op" id="7504095">,</span>&nbsp;<span class="ident" id="7504097">dnsRcodeSuccess</span><span class="op" id="7504112">}</span><span class="op" id="7504113">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7504117">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7504177">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7504236">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7504296">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504349">{</span><span class="string" id="7504350">&#34;localhost.&#34;</span><span class="op" id="7504362">,</span>&nbsp;<span class="ident" id="7504364">dnsTypeALL</span><span class="op" id="7504374">,</span>&nbsp;<span class="ident" id="7504376">dnsRcodeNameError</span><span class="op" id="7504393">}</span><span class="op" id="7504394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504397">{</span><span class="string" id="7504398">&#34;invalid.&#34;</span><span class="op" id="7504408">,</span>&nbsp;<span class="ident" id="7504410">dnsTypeALL</span><span class="op" id="7504420">,</span>&nbsp;<span class="ident" id="7504422">dnsRcodeNameError</span><span class="op" id="7504439">}</span><span class="op" id="7504440">,</span><br>
<span class="lineno"></span><span class="op" id="7504442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7504445">func</span>&nbsp;<span class="ident" id="7504450">TestSpecialDomainName</span><span class="op" id="7504471">(</span><span class="ident" id="7504472">t</span>&nbsp;<span class="op" id="7504474">*</span><span class="ident" id="7504475">testing</span><span class="op" id="7504482">.</span><span class="ident" id="7504483">T</span><span class="op" id="7504484">)</span>&nbsp;<span class="op" id="7504486">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504489">if</span>&nbsp;<span class="ident" id="7504492">testing</span><span class="op" id="7504499">.</span><span class="ident" id="7504500">Short</span><span class="op" id="7504505">(</span><span class="op" id="7504506">)</span>&nbsp;<span class="op" id="7504508">||</span>&nbsp;<span class="op" id="7504511">!</span><span class="op" id="7504512">*</span><span class="ident" id="7504513">testExternal</span>&nbsp;<span class="op" id="7504526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504530">t</span><span class="op" id="7504531">.</span><span class="ident" id="7504532">Skip</span><span class="op" id="7504536">(</span><span class="string" id="7504537">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7504578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504585">server</span>&nbsp;<span class="op" id="7504592">:=</span>&nbsp;<span class="string" id="7504595">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504609">for</span>&nbsp;<span class="ident" id="7504613">_</span><span class="op" id="7504614">,</span>&nbsp;<span class="ident" id="7504616">tt</span>&nbsp;<span class="op" id="7504619">:=</span>&nbsp;<span class="keyword" id="7504622">range</span>&nbsp;<span class="ident" id="7504628">specialDomainNameTests</span>&nbsp;<span class="op" id="7504651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504655">msg</span><span class="op" id="7504658">,</span>&nbsp;<span class="ident" id="7504660">err</span>&nbsp;<span class="op" id="7504664">:=</span>&nbsp;<span class="ident" id="7504667">exchange</span><span class="op" id="7504675">(</span><span class="ident" id="7504676">server</span><span class="op" id="7504682">,</span>&nbsp;<span class="ident" id="7504684">tt</span><span class="op" id="7504686">.</span><span class="ident" id="7504687">name</span><span class="op" id="7504691">,</span>&nbsp;<span class="ident" id="7504693">tt</span><span class="op" id="7504695">.</span><span class="ident" id="7504696">qtype</span><span class="op" id="7504701">,</span>&nbsp;<span class="num" id="7504703">0</span><span class="op" id="7504704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504708">if</span>&nbsp;<span class="ident" id="7504711">err</span>&nbsp;<span class="op" id="7504715">!=</span>&nbsp;<span class="ident" id="7504718">nil</span>&nbsp;<span class="op" id="7504722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504727">t</span><span class="op" id="7504728">.</span><span class="ident" id="7504729">Error</span><span class="op" id="7504734">(</span><span class="ident" id="7504735">err</span><span class="op" id="7504738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504743">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504758">switch</span>&nbsp;<span class="ident" id="7504765">msg</span><span class="op" id="7504768">.</span><span class="ident" id="7504769">rcode</span>&nbsp;<span class="op" id="7504775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504779">case</span>&nbsp;<span class="ident" id="7504784">tt</span><span class="op" id="7504786">.</span><span class="ident" id="7504787">rcode</span><span class="op" id="7504792">,</span>&nbsp;<span class="ident" id="7504794">dnsRcodeServerFailure</span><span class="op" id="7504815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504819">default</span><span class="op" id="7504826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504831">t</span><span class="op" id="7504832">.</span><span class="ident" id="7504833">Errorf</span><span class="op" id="7504839">(</span><span class="string" id="7504840">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7504865">,</span>&nbsp;<span class="ident" id="7504867">msg</span><span class="op" id="7504870">.</span><span class="ident" id="7504871">rcode</span><span class="op" id="7504876">,</span>&nbsp;<span class="ident" id="7504878">server</span><span class="op" id="7504884">,</span>&nbsp;<span class="ident" id="7504886">tt</span><span class="op" id="7504888">.</span><span class="ident" id="7504889">rcode</span><span class="op" id="7504894">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7504899">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504913">}</span><br>
<span class="lineno"></span><span class="op" id="7504915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7504918">type</span>&nbsp;<span class="ident" id="7504923">resolvConfTest</span>&nbsp;<span class="keyword" id="7504938">struct</span>&nbsp;<span class="op" id="7504945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7504948">*</span><span class="ident" id="7504949">testing</span><span class="op" id="7504956">.</span><span class="ident" id="7504957">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504960">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7504968">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504976">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7504984">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7504992">started</span>&nbsp;<span class="builtintype" id="7505000">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505006">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="7505014">chan</span>&nbsp;<span class="keyword" id="7505019">chan</span>&nbsp;<span class="keyword" id="7505024">struct</span><span class="op" id="7505030">{</span><span class="op" id="7505031">}</span><br>
<span class="lineno"></span><span class="op" id="7505033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7505036">func</span>&nbsp;<span class="ident" id="7505041">newResolvConfTest</span><span class="op" id="7505058">(</span><span class="ident" id="7505059">t</span>&nbsp;<span class="op" id="7505061">*</span><span class="ident" id="7505062">testing</span><span class="op" id="7505069">.</span><span class="ident" id="7505070">T</span><span class="op" id="7505071">)</span>&nbsp;<span class="op" id="7505073">*</span><span class="ident" id="7505074">resolvConfTest</span>&nbsp;<span class="op" id="7505089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505092">dir</span><span class="op" id="7505095">,</span>&nbsp;<span class="ident" id="7505097">err</span>&nbsp;<span class="op" id="7505101">:=</span>&nbsp;<span class="ident" id="7505104">ioutil</span><span class="op" id="7505110">.</span><span class="ident" id="7505111">TempDir</span><span class="op" id="7505118">(</span><span class="string" id="7505119">&#34;&#34;</span><span class="op" id="7505121">,</span>&nbsp;<span class="string" id="7505123">&#34;resolvConfTest&#34;</span><span class="op" id="7505139">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7505142">if</span>&nbsp;<span class="ident" id="7505145">err</span>&nbsp;<span class="op" id="7505149">!=</span>&nbsp;<span class="ident" id="7505152">nil</span>&nbsp;<span class="op" id="7505156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505160">t</span><span class="op" id="7505161">.</span><span class="ident" id="7505162">Fatalf</span><span class="op" id="7505168">(</span><span class="string" id="7505169">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="7505200">,</span>&nbsp;<span class="ident" id="7505202">err</span><span class="op" id="7505205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7505208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7505212">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505247">onceLoadConfig</span><span class="op" id="7505261">.</span><span class="ident" id="7505262">Do</span><span class="op" id="7505264">(</span><span class="keyword" id="7505265">func</span><span class="op" id="7505269">(</span><span class="op" id="7505270">)</span>&nbsp;<span class="op" id="7505272">{</span><span class="op" id="7505273">}</span><span class="op" id="7505274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505278">r</span>&nbsp;<span class="op" id="7505280">:=</span>&nbsp;<span class="op" id="7505283">&amp;</span><span class="ident" id="7505284">resolvConfTest</span><span class="op" id="7505298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505302">T</span><span class="op" id="7505303">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7505309">t</span><span class="op" id="7505310">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505314">dir</span><span class="op" id="7505317">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7505321">dir</span><span class="op" id="7505324">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505328">path</span><span class="op" id="7505332">:</span>&nbsp;&nbsp;<span class="ident" id="7505335">path</span><span class="op" id="7505339">.</span><span class="ident" id="7505340">Join</span><span class="op" id="7505344">(</span><span class="ident" id="7505345">dir</span><span class="op" id="7505348">,</span>&nbsp;<span class="string" id="7505350">&#34;resolv.conf&#34;</span><span class="op" id="7505363">)</span><span class="op" id="7505364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505368">quitc</span><span class="op" id="7505373">:</span>&nbsp;<span class="builtinfunc" id="7505375">make</span><span class="op" id="7505379">(</span><span class="keyword" id="7505380">chan</span>&nbsp;<span class="keyword" id="7505385">chan</span>&nbsp;<span class="keyword" id="7505390">struct</span><span class="op" id="7505396">{</span><span class="op" id="7505397">}</span><span class="op" id="7505398">)</span><span class="op" id="7505399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7505402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7505406">return</span>&nbsp;<span class="ident" id="7505413">r</span><br>
<span class="lineno">120</span><span class="op" id="7505415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7505418">func</span>&nbsp;<span class="op" id="7505423">(</span><span class="ident" id="7505424">r</span>&nbsp;<span class="op" id="7505426">*</span><span class="ident" id="7505427">resolvConfTest</span><span class="op" id="7505441">)</span>&nbsp;<span class="ident" id="7505443">Start</span><span class="op" id="7505448">(</span><span class="op" id="7505449">)</span>&nbsp;<span class="op" id="7505451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505454">loadConfig</span><span class="op" id="7505464">(</span><span class="ident" id="7505465">r</span><span class="op" id="7505466">.</span><span class="ident" id="7505467">path</span><span class="op" id="7505471">,</span>&nbsp;<span class="num" id="7505473">100</span><span class="op" id="7505476">*</span><span class="ident" id="7505477">time</span><span class="op" id="7505481">.</span><span class="ident" id="7505482">Millisecond</span><span class="op" id="7505493">,</span>&nbsp;<span class="ident" id="7505495">r</span><span class="op" id="7505496">.</span><span class="ident" id="7505497">quitc</span><span class="op" id="7505502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505505">r</span><span class="op" id="7505506">.</span><span class="ident" id="7505507">started</span>&nbsp;<span class="op" id="7505515">=</span>&nbsp;<span class="builtintype" id="7505517">true</span><br>
<span class="lineno">125</span><span class="op" id="7505522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7505525">func</span>&nbsp;<span class="op" id="7505530">(</span><span class="ident" id="7505531">r</span>&nbsp;<span class="op" id="7505533">*</span><span class="ident" id="7505534">resolvConfTest</span><span class="op" id="7505548">)</span>&nbsp;<span class="ident" id="7505550">SetConf</span><span class="op" id="7505557">(</span><span class="ident" id="7505558">s</span>&nbsp;<span class="builtintype" id="7505560">string</span><span class="op" id="7505566">)</span>&nbsp;<span class="op" id="7505568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7505571">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7505640">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505695">time</span><span class="op" id="7505699">.</span><span class="ident" id="7505700">Sleep</span><span class="op" id="7505705">(</span><span class="ident" id="7505706">time</span><span class="op" id="7505710">.</span><span class="ident" id="7505711">Second</span><span class="op" id="7505717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505721">f</span><span class="op" id="7505722">,</span>&nbsp;<span class="ident" id="7505724">err</span>&nbsp;<span class="op" id="7505728">:=</span>&nbsp;<span class="ident" id="7505731">os</span><span class="op" id="7505733">.</span><span class="ident" id="7505734">OpenFile</span><span class="op" id="7505742">(</span><span class="ident" id="7505743">r</span><span class="op" id="7505744">.</span><span class="ident" id="7505745">path</span><span class="op" id="7505749">,</span>&nbsp;<span class="ident" id="7505751">os</span><span class="op" id="7505753">.</span><span class="ident" id="7505754">O_CREATE</span><span class="op" id="7505762">|</span><span class="ident" id="7505763">os</span><span class="op" id="7505765">.</span><span class="ident" id="7505766">O_TRUNC</span><span class="op" id="7505773">|</span><span class="ident" id="7505774">os</span><span class="op" id="7505776">.</span><span class="ident" id="7505777">O_WRONLY</span><span class="op" id="7505785">,</span>&nbsp;<span class="num" id="7505787">0600</span><span class="op" id="7505791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7505794">if</span>&nbsp;<span class="ident" id="7505797">err</span>&nbsp;<span class="op" id="7505801">!=</span>&nbsp;<span class="ident" id="7505804">nil</span>&nbsp;<span class="op" id="7505808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505812">r</span><span class="op" id="7505813">.</span><span class="ident" id="7505814">Fatalf</span><span class="op" id="7505820">(</span><span class="string" id="7505821">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7505856">,</span>&nbsp;<span class="ident" id="7505858">r</span><span class="op" id="7505859">.</span><span class="ident" id="7505860">path</span><span class="op" id="7505864">,</span>&nbsp;<span class="ident" id="7505866">err</span><span class="op" id="7505869">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7505872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7505875">if</span>&nbsp;<span class="ident" id="7505878">_</span><span class="op" id="7505879">,</span>&nbsp;<span class="ident" id="7505881">err</span>&nbsp;<span class="op" id="7505885">:=</span>&nbsp;<span class="ident" id="7505888">io</span><span class="op" id="7505890">.</span><span class="ident" id="7505891">WriteString</span><span class="op" id="7505902">(</span><span class="ident" id="7505903">f</span><span class="op" id="7505904">,</span>&nbsp;<span class="ident" id="7505906">s</span><span class="op" id="7505907">)</span><span class="op" id="7505908">;</span>&nbsp;<span class="ident" id="7505910">err</span>&nbsp;<span class="op" id="7505914">!=</span>&nbsp;<span class="ident" id="7505917">nil</span>&nbsp;<span class="op" id="7505921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505925">f</span><span class="op" id="7505926">.</span><span class="ident" id="7505927">Close</span><span class="op" id="7505932">(</span><span class="op" id="7505933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505937">r</span><span class="op" id="7505938">.</span><span class="ident" id="7505939">Fatalf</span><span class="op" id="7505945">(</span><span class="string" id="7505946">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="7505977">,</span>&nbsp;<span class="ident" id="7505979">err</span><span class="op" id="7505982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7505985">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7505988">f</span><span class="op" id="7505989">.</span><span class="ident" id="7505990">Close</span><span class="op" id="7505995">(</span><span class="op" id="7505996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506000">if</span>&nbsp;<span class="ident" id="7506003">r</span><span class="op" id="7506004">.</span><span class="ident" id="7506005">started</span>&nbsp;<span class="op" id="7506013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506017">cfg</span><span class="op" id="7506020">.</span><span class="ident" id="7506021">ch</span>&nbsp;<span class="op" id="7506024">&lt;-</span>&nbsp;<span class="keyword" id="7506027">struct</span><span class="op" id="7506033">{</span><span class="op" id="7506034">}</span><span class="op" id="7506035">{</span><span class="op" id="7506036">}</span>&nbsp;<span class="comment" id="7506038">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506055">cfg</span><span class="op" id="7506058">.</span><span class="ident" id="7506059">ch</span>&nbsp;<span class="op" id="7506062">&lt;-</span>&nbsp;<span class="keyword" id="7506065">struct</span><span class="op" id="7506071">{</span><span class="op" id="7506072">}</span><span class="op" id="7506073">{</span><span class="op" id="7506074">}</span>&nbsp;<span class="comment" id="7506076">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506106">cfg</span><span class="op" id="7506109">.</span><span class="ident" id="7506110">ch</span>&nbsp;<span class="op" id="7506113">&lt;-</span>&nbsp;<span class="keyword" id="7506116">struct</span><span class="op" id="7506122">{</span><span class="op" id="7506123">}</span><span class="op" id="7506124">{</span><span class="op" id="7506125">}</span>&nbsp;<span class="comment" id="7506127">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506159">}</span><br>
<span class="lineno"></span><span class="op" id="7506161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7506164">func</span>&nbsp;<span class="op" id="7506169">(</span><span class="ident" id="7506170">r</span>&nbsp;<span class="op" id="7506172">*</span><span class="ident" id="7506173">resolvConfTest</span><span class="op" id="7506187">)</span>&nbsp;<span class="ident" id="7506189">WantServers</span><span class="op" id="7506200">(</span><span class="ident" id="7506201">want</span>&nbsp;<span class="op" id="7506206">[</span><span class="op" id="7506207">]</span><span class="builtintype" id="7506208">string</span><span class="op" id="7506214">)</span>&nbsp;<span class="op" id="7506216">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506219">cfg</span><span class="op" id="7506222">.</span><span class="ident" id="7506223">mu</span><span class="op" id="7506225">.</span><span class="ident" id="7506226">RLock</span><span class="op" id="7506231">(</span><span class="op" id="7506232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506235">defer</span>&nbsp;<span class="ident" id="7506241">cfg</span><span class="op" id="7506244">.</span><span class="ident" id="7506245">mu</span><span class="op" id="7506247">.</span><span class="ident" id="7506248">RUnlock</span><span class="op" id="7506255">(</span><span class="op" id="7506256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506259">if</span>&nbsp;<span class="ident" id="7506262">got</span>&nbsp;<span class="op" id="7506266">:=</span>&nbsp;<span class="ident" id="7506269">cfg</span><span class="op" id="7506272">.</span><span class="ident" id="7506273">dnsConfig</span><span class="op" id="7506282">.</span><span class="ident" id="7506283">servers</span><span class="op" id="7506290">;</span>&nbsp;<span class="op" id="7506292">!</span><span class="ident" id="7506293">reflect</span><span class="op" id="7506300">.</span><span class="ident" id="7506301">DeepEqual</span><span class="op" id="7506310">(</span><span class="ident" id="7506311">got</span><span class="op" id="7506314">,</span>&nbsp;<span class="ident" id="7506316">want</span><span class="op" id="7506320">)</span>&nbsp;<span class="op" id="7506322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506326">r</span><span class="op" id="7506327">.</span><span class="ident" id="7506328">Fatalf</span><span class="op" id="7506334">(</span><span class="string" id="7506335">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7506381">,</span>&nbsp;<span class="ident" id="7506383">got</span><span class="op" id="7506386">,</span>&nbsp;<span class="ident" id="7506388">want</span><span class="op" id="7506392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506395">}</span><br>
<span class="lineno">155</span><span class="op" id="7506397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7506400">func</span>&nbsp;<span class="op" id="7506405">(</span><span class="ident" id="7506406">r</span>&nbsp;<span class="op" id="7506408">*</span><span class="ident" id="7506409">resolvConfTest</span><span class="op" id="7506423">)</span>&nbsp;<span class="ident" id="7506425">Close</span><span class="op" id="7506430">(</span><span class="op" id="7506431">)</span>&nbsp;<span class="op" id="7506433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506436">resp</span>&nbsp;<span class="op" id="7506441">:=</span>&nbsp;<span class="builtinfunc" id="7506444">make</span><span class="op" id="7506448">(</span><span class="keyword" id="7506449">chan</span>&nbsp;<span class="keyword" id="7506454">struct</span><span class="op" id="7506460">{</span><span class="op" id="7506461">}</span><span class="op" id="7506462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506465">r</span><span class="op" id="7506466">.</span><span class="ident" id="7506467">quitc</span>&nbsp;<span class="op" id="7506473">&lt;-</span>&nbsp;<span class="ident" id="7506476">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506482">&lt;-</span><span class="ident" id="7506484">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506490">if</span>&nbsp;<span class="ident" id="7506493">err</span>&nbsp;<span class="op" id="7506497">:=</span>&nbsp;<span class="ident" id="7506500">os</span><span class="op" id="7506502">.</span><span class="ident" id="7506503">RemoveAll</span><span class="op" id="7506512">(</span><span class="ident" id="7506513">r</span><span class="op" id="7506514">.</span><span class="ident" id="7506515">dir</span><span class="op" id="7506518">)</span><span class="op" id="7506519">;</span>&nbsp;<span class="ident" id="7506521">err</span>&nbsp;<span class="op" id="7506525">!=</span>&nbsp;<span class="ident" id="7506528">nil</span>&nbsp;<span class="op" id="7506532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506536">r</span><span class="op" id="7506537">.</span><span class="ident" id="7506538">Logf</span><span class="op" id="7506542">(</span><span class="string" id="7506543">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7506577">,</span>&nbsp;<span class="ident" id="7506579">r</span><span class="op" id="7506580">.</span><span class="ident" id="7506581">dir</span><span class="op" id="7506584">,</span>&nbsp;<span class="ident" id="7506586">err</span><span class="op" id="7506589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506592">}</span><br>
<span class="lineno"></span><span class="op" id="7506594">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="7506597">func</span>&nbsp;<span class="ident" id="7506602">TestReloadResolvConfFail</span><span class="op" id="7506626">(</span><span class="ident" id="7506627">t</span>&nbsp;<span class="op" id="7506629">*</span><span class="ident" id="7506630">testing</span><span class="op" id="7506637">.</span><span class="ident" id="7506638">T</span><span class="op" id="7506639">)</span>&nbsp;<span class="op" id="7506641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506644">if</span>&nbsp;<span class="ident" id="7506647">testing</span><span class="op" id="7506654">.</span><span class="ident" id="7506655">Short</span><span class="op" id="7506660">(</span><span class="op" id="7506661">)</span>&nbsp;<span class="op" id="7506663">||</span>&nbsp;<span class="op" id="7506666">!</span><span class="op" id="7506667">*</span><span class="ident" id="7506668">testExternal</span>&nbsp;<span class="op" id="7506681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506685">t</span><span class="op" id="7506686">.</span><span class="ident" id="7506687">Skip</span><span class="op" id="7506691">(</span><span class="string" id="7506692">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7506733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506736">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506740">r</span>&nbsp;<span class="op" id="7506742">:=</span>&nbsp;<span class="ident" id="7506745">newResolvConfTest</span><span class="op" id="7506762">(</span><span class="ident" id="7506763">t</span><span class="op" id="7506764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506767">defer</span>&nbsp;<span class="ident" id="7506773">r</span><span class="op" id="7506774">.</span><span class="ident" id="7506775">Close</span><span class="op" id="7506780">(</span><span class="op" id="7506781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7506785">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506824">r</span><span class="op" id="7506825">.</span><span class="ident" id="7506826">Start</span><span class="op" id="7506831">(</span><span class="op" id="7506832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506835">if</span>&nbsp;<span class="ident" id="7506838">_</span><span class="op" id="7506839">,</span>&nbsp;<span class="ident" id="7506841">err</span>&nbsp;<span class="op" id="7506845">:=</span>&nbsp;<span class="ident" id="7506848">goLookupIP</span><span class="op" id="7506858">(</span><span class="string" id="7506859">&#34;golang.org&#34;</span><span class="op" id="7506871">)</span><span class="op" id="7506872">;</span>&nbsp;<span class="ident" id="7506874">err</span>&nbsp;<span class="op" id="7506878">==</span>&nbsp;<span class="ident" id="7506881">nil</span>&nbsp;<span class="op" id="7506885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506889">t</span><span class="op" id="7506890">.</span><span class="ident" id="7506891">Fatal</span><span class="op" id="7506896">(</span><span class="string" id="7506897">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="7506928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7506931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7506935">r</span><span class="op" id="7506936">.</span><span class="ident" id="7506937">SetConf</span><span class="op" id="7506944">(</span><span class="string" id="7506945">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="7506965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7506968">if</span>&nbsp;<span class="ident" id="7506971">_</span><span class="op" id="7506972">,</span>&nbsp;<span class="ident" id="7506974">err</span>&nbsp;<span class="op" id="7506978">:=</span>&nbsp;<span class="ident" id="7506981">goLookupIP</span><span class="op" id="7506991">(</span><span class="string" id="7506992">&#34;golang.org&#34;</span><span class="op" id="7507004">)</span><span class="op" id="7507005">;</span>&nbsp;<span class="ident" id="7507007">err</span>&nbsp;<span class="op" id="7507011">!=</span>&nbsp;<span class="ident" id="7507014">nil</span>&nbsp;<span class="op" id="7507018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507022">t</span><span class="op" id="7507023">.</span><span class="ident" id="7507024">Fatalf</span><span class="op" id="7507030">(</span><span class="string" id="7507031">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7507069">,</span>&nbsp;<span class="ident" id="7507071">err</span><span class="op" id="7507074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7507077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7507081">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7507129">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507173">r</span><span class="op" id="7507174">.</span><span class="ident" id="7507175">SetConf</span><span class="op" id="7507182">(</span><span class="string" id="7507183">&#34;&#34;</span><span class="op" id="7507185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7507188">if</span>&nbsp;<span class="ident" id="7507191">_</span><span class="op" id="7507192">,</span>&nbsp;<span class="ident" id="7507194">err</span>&nbsp;<span class="op" id="7507198">:=</span>&nbsp;<span class="ident" id="7507201">goLookupIP</span><span class="op" id="7507211">(</span><span class="string" id="7507212">&#34;golang.org&#34;</span><span class="op" id="7507224">)</span><span class="op" id="7507225">;</span>&nbsp;<span class="ident" id="7507227">err</span>&nbsp;<span class="op" id="7507231">!=</span>&nbsp;<span class="ident" id="7507234">nil</span>&nbsp;<span class="op" id="7507238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507242">t</span><span class="op" id="7507243">.</span><span class="ident" id="7507244">Fatalf</span><span class="op" id="7507250">(</span><span class="string" id="7507251">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7507294">,</span>&nbsp;<span class="ident" id="7507296">err</span><span class="op" id="7507299">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7507302">}</span><br>
<span class="lineno"></span><span class="op" id="7507304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7507307">func</span>&nbsp;<span class="ident" id="7507312">TestReloadResolvConfChange</span><span class="op" id="7507338">(</span><span class="ident" id="7507339">t</span>&nbsp;<span class="op" id="7507341">*</span><span class="ident" id="7507342">testing</span><span class="op" id="7507349">.</span><span class="ident" id="7507350">T</span><span class="op" id="7507351">)</span>&nbsp;<span class="op" id="7507353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7507356">if</span>&nbsp;<span class="ident" id="7507359">testing</span><span class="op" id="7507366">.</span><span class="ident" id="7507367">Short</span><span class="op" id="7507372">(</span><span class="op" id="7507373">)</span>&nbsp;<span class="op" id="7507375">||</span>&nbsp;<span class="op" id="7507378">!</span><span class="op" id="7507379">*</span><span class="ident" id="7507380">testExternal</span>&nbsp;<span class="op" id="7507393">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507397">t</span><span class="op" id="7507398">.</span><span class="ident" id="7507399">Skip</span><span class="op" id="7507403">(</span><span class="string" id="7507404">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7507445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7507448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507452">r</span>&nbsp;<span class="op" id="7507454">:=</span>&nbsp;<span class="ident" id="7507457">newResolvConfTest</span><span class="op" id="7507474">(</span><span class="ident" id="7507475">t</span><span class="op" id="7507476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7507479">defer</span>&nbsp;<span class="ident" id="7507485">r</span><span class="op" id="7507486">.</span><span class="ident" id="7507487">Close</span><span class="op" id="7507492">(</span><span class="op" id="7507493">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507497">r</span><span class="op" id="7507498">.</span><span class="ident" id="7507499">SetConf</span><span class="op" id="7507506">(</span><span class="string" id="7507507">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="7507527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507530">r</span><span class="op" id="7507531">.</span><span class="ident" id="7507532">Start</span><span class="op" id="7507537">(</span><span class="op" id="7507538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7507542">if</span>&nbsp;<span class="ident" id="7507545">_</span><span class="op" id="7507546">,</span>&nbsp;<span class="ident" id="7507548">err</span>&nbsp;<span class="op" id="7507552">:=</span>&nbsp;<span class="ident" id="7507555">goLookupIP</span><span class="op" id="7507565">(</span><span class="string" id="7507566">&#34;golang.org&#34;</span><span class="op" id="7507578">)</span><span class="op" id="7507579">;</span>&nbsp;<span class="ident" id="7507581">err</span>&nbsp;<span class="op" id="7507585">!=</span>&nbsp;<span class="ident" id="7507588">nil</span>&nbsp;<span class="op" id="7507592">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507596">t</span><span class="op" id="7507597">.</span><span class="ident" id="7507598">Fatalf</span><span class="op" id="7507604">(</span><span class="string" id="7507605">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7507634">,</span>&nbsp;<span class="ident" id="7507636">err</span><span class="op" id="7507639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7507642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507645">r</span><span class="op" id="7507646">.</span><span class="ident" id="7507647">WantServers</span><span class="op" id="7507658">(</span><span class="op" id="7507659">[</span><span class="op" id="7507660">]</span><span class="builtintype" id="7507661">string</span><span class="op" id="7507667">{</span><span class="string" id="7507668">&#34;8.8.8.8&#34;</span><span class="op" id="7507677">}</span><span class="op" id="7507678">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7507682">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7507733">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507773">r</span><span class="op" id="7507774">.</span><span class="ident" id="7507775">SetConf</span><span class="op" id="7507782">(</span><span class="string" id="7507783">&#34;&#34;</span><span class="op" id="7507785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7507788">if</span>&nbsp;<span class="ident" id="7507791">_</span><span class="op" id="7507792">,</span>&nbsp;<span class="ident" id="7507794">err</span>&nbsp;<span class="op" id="7507798">:=</span>&nbsp;<span class="ident" id="7507801">goLookupIP</span><span class="op" id="7507811">(</span><span class="string" id="7507812">&#34;golang.org&#34;</span><span class="op" id="7507824">)</span><span class="op" id="7507825">;</span>&nbsp;<span class="ident" id="7507827">err</span>&nbsp;<span class="op" id="7507831">!=</span>&nbsp;<span class="ident" id="7507834">nil</span>&nbsp;<span class="op" id="7507838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507842">t</span><span class="op" id="7507843">.</span><span class="ident" id="7507844">Fatalf</span><span class="op" id="7507850">(</span><span class="string" id="7507851">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7507885">,</span>&nbsp;<span class="ident" id="7507887">err</span><span class="op" id="7507890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7507893">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7507897">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507940">r</span><span class="op" id="7507941">.</span><span class="ident" id="7507942">SetConf</span><span class="op" id="7507949">(</span><span class="string" id="7507950">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="7507970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7507973">r</span><span class="op" id="7507974">.</span><span class="ident" id="7507975">WantServers</span><span class="op" id="7507986">(</span><span class="op" id="7507987">[</span><span class="op" id="7507988">]</span><span class="builtintype" id="7507989">string</span><span class="op" id="7507995">{</span><span class="string" id="7507996">&#34;8.8.4.4&#34;</span><span class="op" id="7508005">}</span><span class="op" id="7508006">)</span><br>
<span class="lineno"></span><span class="op" id="7508008">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="7508011">func</span>&nbsp;<span class="ident" id="7508016">BenchmarkGoLookupIP</span><span class="op" id="7508035">(</span><span class="ident" id="7508036">b</span>&nbsp;<span class="op" id="7508038">*</span><span class="ident" id="7508039">testing</span><span class="op" id="7508046">.</span><span class="ident" id="7508047">B</span><span class="op" id="7508048">)</span>&nbsp;<span class="op" id="7508050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7508053">for</span>&nbsp;<span class="ident" id="7508057">i</span>&nbsp;<span class="op" id="7508059">:=</span>&nbsp;<span class="num" id="7508062">0</span><span class="op" id="7508063">;</span>&nbsp;<span class="ident" id="7508065">i</span>&nbsp;<span class="op" id="7508067">&lt;</span>&nbsp;<span class="ident" id="7508069">b</span><span class="op" id="7508070">.</span><span class="ident" id="7508071">N</span><span class="op" id="7508072">;</span>&nbsp;<span class="ident" id="7508074">i</span><span class="op" id="7508075">++</span>&nbsp;<span class="op" id="7508078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508082">goLookupIP</span><span class="op" id="7508092">(</span><span class="string" id="7508093">&#34;www.example.com&#34;</span><span class="op" id="7508110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7508113">}</span><br>
<span class="lineno">225</span><span class="op" id="7508115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7508118">func</span>&nbsp;<span class="ident" id="7508123">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="7508152">(</span><span class="ident" id="7508153">b</span>&nbsp;<span class="op" id="7508155">*</span><span class="ident" id="7508156">testing</span><span class="op" id="7508163">.</span><span class="ident" id="7508164">B</span><span class="op" id="7508165">)</span>&nbsp;<span class="op" id="7508167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7508170">for</span>&nbsp;<span class="ident" id="7508174">i</span>&nbsp;<span class="op" id="7508176">:=</span>&nbsp;<span class="num" id="7508179">0</span><span class="op" id="7508180">;</span>&nbsp;<span class="ident" id="7508182">i</span>&nbsp;<span class="op" id="7508184">&lt;</span>&nbsp;<span class="ident" id="7508186">b</span><span class="op" id="7508187">.</span><span class="ident" id="7508188">N</span><span class="op" id="7508189">;</span>&nbsp;<span class="ident" id="7508191">i</span><span class="op" id="7508192">++</span>&nbsp;<span class="op" id="7508195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508199">goLookupIP</span><span class="op" id="7508209">(</span><span class="string" id="7508210">&#34;some.nonexistent&#34;</span><span class="op" id="7508228">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7508231">}</span><br>
<span class="lineno"></span><span class="op" id="7508233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7508236">func</span>&nbsp;<span class="ident" id="7508241">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="7508280">(</span><span class="ident" id="7508281">b</span>&nbsp;<span class="op" id="7508283">*</span><span class="ident" id="7508284">testing</span><span class="op" id="7508291">.</span><span class="ident" id="7508292">B</span><span class="op" id="7508293">)</span>&nbsp;<span class="op" id="7508295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508298">onceLoadConfig</span><span class="op" id="7508312">.</span><span class="ident" id="7508313">Do</span><span class="op" id="7508315">(</span><span class="ident" id="7508316">loadDefaultConfig</span><span class="op" id="7508333">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7508336">if</span>&nbsp;<span class="ident" id="7508339">cfg</span><span class="op" id="7508342">.</span><span class="ident" id="7508343">dnserr</span>&nbsp;<span class="op" id="7508350">!=</span>&nbsp;<span class="ident" id="7508353">nil</span>&nbsp;<span class="op" id="7508357">||</span>&nbsp;<span class="ident" id="7508360">cfg</span><span class="op" id="7508363">.</span><span class="ident" id="7508364">dnsConfig</span>&nbsp;<span class="op" id="7508374">==</span>&nbsp;<span class="ident" id="7508377">nil</span>&nbsp;<span class="op" id="7508381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508385">b</span><span class="op" id="7508386">.</span><span class="ident" id="7508387">Fatalf</span><span class="op" id="7508393">(</span><span class="string" id="7508394">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7508417">,</span>&nbsp;<span class="ident" id="7508419">cfg</span><span class="op" id="7508422">.</span><span class="ident" id="7508423">dnserr</span><span class="op" id="7508429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7508432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7508435">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7508499">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508536">orig</span>&nbsp;<span class="op" id="7508541">:=</span>&nbsp;<span class="ident" id="7508544">cfg</span><span class="op" id="7508547">.</span><span class="ident" id="7508548">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508559">cfg</span><span class="op" id="7508562">.</span><span class="ident" id="7508563">dnsConfig</span><span class="op" id="7508572">.</span><span class="ident" id="7508573">servers</span>&nbsp;<span class="op" id="7508581">=</span>&nbsp;<span class="builtinfunc" id="7508583">append</span><span class="op" id="7508589">(</span><span class="op" id="7508590">[</span><span class="op" id="7508591">]</span><span class="builtintype" id="7508592">string</span><span class="op" id="7508598">{</span><span class="string" id="7508599">&#34;203.0.113.254&#34;</span><span class="op" id="7508614">}</span><span class="op" id="7508615">,</span>&nbsp;<span class="ident" id="7508617">cfg</span><span class="op" id="7508620">.</span><span class="ident" id="7508621">dnsConfig</span><span class="op" id="7508630">.</span><span class="ident" id="7508631">servers</span><span class="op" id="7508638">...</span><span class="op" id="7508641">)</span>&nbsp;<span class="comment" id="7508643">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7508682">for</span>&nbsp;<span class="ident" id="7508686">i</span>&nbsp;<span class="op" id="7508688">:=</span>&nbsp;<span class="num" id="7508691">0</span><span class="op" id="7508692">;</span>&nbsp;<span class="ident" id="7508694">i</span>&nbsp;<span class="op" id="7508696">&lt;</span>&nbsp;<span class="ident" id="7508698">b</span><span class="op" id="7508699">.</span><span class="ident" id="7508700">N</span><span class="op" id="7508701">;</span>&nbsp;<span class="ident" id="7508703">i</span><span class="op" id="7508704">++</span>&nbsp;<span class="op" id="7508707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508711">goLookupIP</span><span class="op" id="7508721">(</span><span class="string" id="7508722">&#34;www.example.com&#34;</span><span class="op" id="7508739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7508742">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7508745">cfg</span><span class="op" id="7508748">.</span><span class="ident" id="7508749">dnsConfig</span>&nbsp;<span class="op" id="7508759">=</span>&nbsp;<span class="ident" id="7508761">orig</span><br>
<span class="lineno"></span><span class="op" id="7508766">}</span>
</div>
</body>
</html>
