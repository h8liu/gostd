<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4221325">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4221380">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4221434">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4221485">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="4221530">//</span><br>
<span class="lineno"></span><span class="comment" id="4221533">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="4221600">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4221646">package</span>&nbsp;<span class="ident" id="4221654">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4221660">import</span>&nbsp;<span class="op" id="4221667">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221670">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221679">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221696">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221710">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221720">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221727">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221733">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221740">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221747">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221758">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221764">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221775">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4221783">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4221790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4221793">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4221863">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="4221934">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="4222005">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4222073">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="4222110">var</span>&nbsp;<span class="ident" id="4222114">DefaultTransport</span>&nbsp;<span class="ident" id="4222131">RoundTripper</span>&nbsp;<span class="op" id="4222144">=</span>&nbsp;<span class="op" id="4222146">&amp;</span><span class="ident" id="4222147">Transport</span><span class="op" id="4222156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222159">Proxy</span><span class="op" id="4222164">:</span>&nbsp;<span class="ident" id="4222166">ProxyFromEnvironment</span><span class="op" id="4222186">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222189">Dial</span><span class="op" id="4222193">:</span>&nbsp;<span class="op" id="4222195">(</span><span class="op" id="4222196">&amp;</span><span class="ident" id="4222197">net</span><span class="op" id="4222200">.</span><span class="ident" id="4222201">Dialer</span><span class="op" id="4222207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222211">Timeout</span><span class="op" id="4222218">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="4222222">30</span>&nbsp;<span class="op" id="4222225">*</span>&nbsp;<span class="ident" id="4222227">time</span><span class="op" id="4222231">.</span><span class="ident" id="4222232">Second</span><span class="op" id="4222238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222242">KeepAlive</span><span class="op" id="4222251">:</span>&nbsp;<span class="num" id="4222253">30</span>&nbsp;<span class="op" id="4222256">*</span>&nbsp;<span class="ident" id="4222258">time</span><span class="op" id="4222262">.</span><span class="ident" id="4222263">Second</span><span class="op" id="4222269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4222272">}</span><span class="op" id="4222273">)</span><span class="op" id="4222274">.</span><span class="ident" id="4222275">Dial</span><span class="op" id="4222279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222282">TLSHandshakeTimeout</span><span class="op" id="4222301">:</span>&nbsp;<span class="num" id="4222303">10</span>&nbsp;<span class="op" id="4222306">*</span>&nbsp;<span class="ident" id="4222308">time</span><span class="op" id="4222312">.</span><span class="ident" id="4222313">Second</span><span class="op" id="4222319">,</span><br>
<span class="lineno">40</span><span class="op" id="4222321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4222324">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4222390">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="4222414">const</span>&nbsp;<span class="ident" id="4222420">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="4222447">=</span>&nbsp;<span class="num" id="4222449">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4222452">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="4222522">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="4222590">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="4222649">type</span>&nbsp;<span class="ident" id="4222654">Transport</span>&nbsp;<span class="keyword" id="4222664">struct</span>&nbsp;<span class="op" id="4222671">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222674">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222685">sync</span><span class="op" id="4222689">.</span><span class="ident" id="4222690">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222697">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4222708">bool</span>&nbsp;<span class="comment" id="4222713">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222760">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4222771">map</span><span class="op" id="4222774">[</span><span class="ident" id="4222775">connectMethodKey</span><span class="op" id="4222791">]</span><span class="op" id="4222792">[</span><span class="op" id="4222793">]</span><span class="op" id="4222794">*</span><span class="ident" id="4222795">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222808">idleConnCh</span>&nbsp;<span class="keyword" id="4222819">map</span><span class="op" id="4222822">[</span><span class="ident" id="4222823">connectMethodKey</span><span class="op" id="4222839">]</span><span class="keyword" id="4222840">chan</span>&nbsp;<span class="op" id="4222845">*</span><span class="ident" id="4222846">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222860">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222872">sync</span><span class="op" id="4222876">.</span><span class="ident" id="4222877">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222884">reqCanceler</span>&nbsp;<span class="keyword" id="4222896">map</span><span class="op" id="4222899">[</span><span class="op" id="4222900">*</span><span class="ident" id="4222901">Request</span><span class="op" id="4222908">]</span><span class="keyword" id="4222909">func</span><span class="op" id="4222913">(</span><span class="op" id="4222914">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222918">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222927">sync</span><span class="op" id="4222931">.</span><span class="ident" id="4222932">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4222941">altProto</span>&nbsp;<span class="keyword" id="4222950">map</span><span class="op" id="4222953">[</span><span class="builtintype" id="4222954">string</span><span class="op" id="4222960">]</span><span class="ident" id="4222961">RoundTripper</span>&nbsp;<span class="comment" id="4222974">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223020">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223081">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223139">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223187">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223248">Proxy</span>&nbsp;<span class="keyword" id="4223254">func</span><span class="op" id="4223258">(</span><span class="op" id="4223259">*</span><span class="ident" id="4223260">Request</span><span class="op" id="4223267">)</span>&nbsp;<span class="op" id="4223269">(</span><span class="op" id="4223270">*</span><span class="ident" id="4223271">url</span><span class="op" id="4223274">.</span><span class="ident" id="4223275">URL</span><span class="op" id="4223278">,</span>&nbsp;<span class="builtintype" id="4223280">error</span><span class="op" id="4223285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223289">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223351">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223372">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223410">Dial</span>&nbsp;<span class="keyword" id="4223415">func</span><span class="op" id="4223419">(</span><span class="ident" id="4223420">network</span><span class="op" id="4223427">,</span>&nbsp;<span class="ident" id="4223429">addr</span>&nbsp;<span class="builtintype" id="4223434">string</span><span class="op" id="4223440">)</span>&nbsp;<span class="op" id="4223442">(</span><span class="ident" id="4223443">net</span><span class="op" id="4223446">.</span><span class="ident" id="4223447">Conn</span><span class="op" id="4223451">,</span>&nbsp;<span class="builtintype" id="4223453">error</span><span class="op" id="4223458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223462">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223523">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223575">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223579">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223637">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223641">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223700">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223761">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223825">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4223853">DialTLS</span>&nbsp;<span class="keyword" id="4223861">func</span><span class="op" id="4223865">(</span><span class="ident" id="4223866">network</span><span class="op" id="4223873">,</span>&nbsp;<span class="ident" id="4223875">addr</span>&nbsp;<span class="builtintype" id="4223880">string</span><span class="op" id="4223886">)</span>&nbsp;<span class="op" id="4223888">(</span><span class="ident" id="4223889">net</span><span class="op" id="4223892">.</span><span class="ident" id="4223893">Conn</span><span class="op" id="4223897">,</span>&nbsp;<span class="builtintype" id="4223899">error</span><span class="op" id="4223904">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223908">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4223972">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224031">TLSClientConfig</span>&nbsp;<span class="op" id="4224047">*</span><span class="ident" id="4224048">tls</span><span class="op" id="4224051">.</span><span class="ident" id="4224052">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224061">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224133">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224186">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="4224206">time</span><span class="op" id="4224210">.</span><span class="ident" id="4224211">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224222">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224289">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224326">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="4224344">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224351">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224412">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224471">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224528">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224589">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224649">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224704">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224758">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224776">DisableCompression</span>&nbsp;<span class="builtintype" id="4224795">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224802">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224866">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224911">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4224951">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="4224971">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4224977">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4225041">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4225102">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4225161">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4225223">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="4225245">time</span><span class="op" id="4225249">.</span><span class="ident" id="4225250">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4225261">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4225312">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="4225362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4225365">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4225431">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="4225491">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="4225558">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="4225626">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="4225639">//</span><br>
<span class="lineno"></span><span class="comment" id="4225642">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4225702">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="4225764">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="4225822">//</span><br>
<span class="lineno">130</span><span class="comment" id="4225825">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4225895">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4225964">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="4225991">//</span><br>
<span class="lineno"></span><span class="comment" id="4225994">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="4226064">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4226130">func</span>&nbsp;<span class="ident" id="4226135">ProxyFromEnvironment</span><span class="op" id="4226155">(</span><span class="ident" id="4226156">req</span>&nbsp;<span class="op" id="4226160">*</span><span class="ident" id="4226161">Request</span><span class="op" id="4226168">)</span>&nbsp;<span class="op" id="4226170">(</span><span class="op" id="4226171">*</span><span class="ident" id="4226172">url</span><span class="op" id="4226175">.</span><span class="ident" id="4226176">URL</span><span class="op" id="4226179">,</span>&nbsp;<span class="builtintype" id="4226181">error</span><span class="op" id="4226186">)</span>&nbsp;<span class="op" id="4226188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226191">var</span>&nbsp;<span class="ident" id="4226195">proxy</span>&nbsp;<span class="builtintype" id="4226201">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226209">if</span>&nbsp;<span class="ident" id="4226212">req</span><span class="op" id="4226215">.</span><span class="ident" id="4226216">URL</span><span class="op" id="4226219">.</span><span class="ident" id="4226220">Scheme</span>&nbsp;<span class="op" id="4226227">==</span>&nbsp;<span class="string" id="4226230">&#34;https&#34;</span>&nbsp;<span class="op" id="4226238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226242">proxy</span>&nbsp;<span class="op" id="4226248">=</span>&nbsp;<span class="ident" id="4226250">httpsProxyEnv</span><span class="op" id="4226263">.</span><span class="ident" id="4226264">Get</span><span class="op" id="4226267">(</span><span class="op" id="4226268">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226274">if</span>&nbsp;<span class="ident" id="4226277">proxy</span>&nbsp;<span class="op" id="4226283">==</span>&nbsp;<span class="string" id="4226286">&#34;&#34;</span>&nbsp;<span class="op" id="4226289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226293">proxy</span>&nbsp;<span class="op" id="4226299">=</span>&nbsp;<span class="ident" id="4226301">httpProxyEnv</span><span class="op" id="4226313">.</span><span class="ident" id="4226314">Get</span><span class="op" id="4226317">(</span><span class="op" id="4226318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226324">if</span>&nbsp;<span class="ident" id="4226327">proxy</span>&nbsp;<span class="op" id="4226333">==</span>&nbsp;<span class="string" id="4226336">&#34;&#34;</span>&nbsp;<span class="op" id="4226339">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226343">return</span>&nbsp;<span class="builtintype" id="4226350">nil</span><span class="op" id="4226353">,</span>&nbsp;<span class="builtintype" id="4226355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226363">if</span>&nbsp;<span class="op" id="4226366">!</span><span class="ident" id="4226367">useProxy</span><span class="op" id="4226375">(</span><span class="ident" id="4226376">canonicalAddr</span><span class="op" id="4226389">(</span><span class="ident" id="4226390">req</span><span class="op" id="4226393">.</span><span class="ident" id="4226394">URL</span><span class="op" id="4226397">)</span><span class="op" id="4226398">)</span>&nbsp;<span class="op" id="4226400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226404">return</span>&nbsp;<span class="builtintype" id="4226411">nil</span><span class="op" id="4226414">,</span>&nbsp;<span class="builtintype" id="4226416">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226421">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4226424">proxyURL</span><span class="op" id="4226432">,</span>&nbsp;<span class="ident" id="4226434">err</span>&nbsp;<span class="op" id="4226438">:=</span>&nbsp;<span class="ident" id="4226441">url</span><span class="op" id="4226444">.</span><span class="ident" id="4226445">Parse</span><span class="op" id="4226450">(</span><span class="ident" id="4226451">proxy</span><span class="op" id="4226456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226459">if</span>&nbsp;<span class="ident" id="4226462">err</span>&nbsp;<span class="op" id="4226466">!=</span>&nbsp;<span class="builtintype" id="4226469">nil</span>&nbsp;<span class="op" id="4226473">||</span>&nbsp;<span class="op" id="4226476">!</span><span class="ident" id="4226477">strings</span><span class="op" id="4226484">.</span><span class="ident" id="4226485">HasPrefix</span><span class="op" id="4226494">(</span><span class="ident" id="4226495">proxyURL</span><span class="op" id="4226503">.</span><span class="ident" id="4226504">Scheme</span><span class="op" id="4226510">,</span>&nbsp;<span class="string" id="4226512">&#34;http&#34;</span><span class="op" id="4226518">)</span>&nbsp;<span class="op" id="4226520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4226524">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4226581">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4226632">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226682">if</span>&nbsp;<span class="ident" id="4226685">proxyURL</span><span class="op" id="4226693">,</span>&nbsp;<span class="ident" id="4226695">err</span>&nbsp;<span class="op" id="4226699">:=</span>&nbsp;<span class="ident" id="4226702">url</span><span class="op" id="4226705">.</span><span class="ident" id="4226706">Parse</span><span class="op" id="4226711">(</span><span class="string" id="4226712">&#34;http://&#34;</span>&nbsp;<span class="op" id="4226722">+</span>&nbsp;<span class="ident" id="4226724">proxy</span><span class="op" id="4226729">)</span><span class="op" id="4226730">;</span>&nbsp;<span class="ident" id="4226732">err</span>&nbsp;<span class="op" id="4226736">==</span>&nbsp;<span class="builtintype" id="4226739">nil</span>&nbsp;<span class="op" id="4226743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226748">return</span>&nbsp;<span class="ident" id="4226755">proxyURL</span><span class="op" id="4226763">,</span>&nbsp;<span class="builtintype" id="4226765">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226777">if</span>&nbsp;<span class="ident" id="4226780">err</span>&nbsp;<span class="op" id="4226784">!=</span>&nbsp;<span class="builtintype" id="4226787">nil</span>&nbsp;<span class="op" id="4226791">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226795">return</span>&nbsp;<span class="builtintype" id="4226802">nil</span><span class="op" id="4226805">,</span>&nbsp;<span class="ident" id="4226807">fmt</span><span class="op" id="4226810">.</span><span class="ident" id="4226811">Errorf</span><span class="op" id="4226817">(</span><span class="string" id="4226818">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="4226848">,</span>&nbsp;<span class="ident" id="4226850">proxy</span><span class="op" id="4226855">,</span>&nbsp;<span class="ident" id="4226857">err</span><span class="op" id="4226860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4226863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4226866">return</span>&nbsp;<span class="ident" id="4226873">proxyURL</span><span class="op" id="4226881">,</span>&nbsp;<span class="builtintype" id="4226883">nil</span><br>
<span class="lineno"></span><span class="op" id="4226887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4226890">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="4226952">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4226989">func</span>&nbsp;<span class="ident" id="4226994">ProxyURL</span><span class="op" id="4227002">(</span><span class="ident" id="4227003">fixedURL</span>&nbsp;<span class="op" id="4227012">*</span><span class="ident" id="4227013">url</span><span class="op" id="4227016">.</span><span class="ident" id="4227017">URL</span><span class="op" id="4227020">)</span>&nbsp;<span class="keyword" id="4227022">func</span><span class="op" id="4227026">(</span><span class="op" id="4227027">*</span><span class="ident" id="4227028">Request</span><span class="op" id="4227035">)</span>&nbsp;<span class="op" id="4227037">(</span><span class="op" id="4227038">*</span><span class="ident" id="4227039">url</span><span class="op" id="4227042">.</span><span class="ident" id="4227043">URL</span><span class="op" id="4227046">,</span>&nbsp;<span class="builtintype" id="4227048">error</span><span class="op" id="4227053">)</span>&nbsp;<span class="op" id="4227055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227058">return</span>&nbsp;<span class="keyword" id="4227065">func</span><span class="op" id="4227069">(</span><span class="op" id="4227070">*</span><span class="ident" id="4227071">Request</span><span class="op" id="4227078">)</span>&nbsp;<span class="op" id="4227080">(</span><span class="op" id="4227081">*</span><span class="ident" id="4227082">url</span><span class="op" id="4227085">.</span><span class="ident" id="4227086">URL</span><span class="op" id="4227089">,</span>&nbsp;<span class="builtintype" id="4227091">error</span><span class="op" id="4227096">)</span>&nbsp;<span class="op" id="4227098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227102">return</span>&nbsp;<span class="ident" id="4227109">fixedURL</span><span class="op" id="4227117">,</span>&nbsp;<span class="builtintype" id="4227119">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227124">}</span><br>
<span class="lineno"></span><span class="op" id="4227126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4227129">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="4227190">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="4227226">type</span>&nbsp;<span class="ident" id="4227231">transportRequest</span>&nbsp;<span class="keyword" id="4227248">struct</span>&nbsp;<span class="op" id="4227255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227258">*</span><span class="ident" id="4227259">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4227274">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227314">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227323">Header</span>&nbsp;<span class="comment" id="4227330">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4227364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="4227367">func</span>&nbsp;<span class="op" id="4227372">(</span><span class="ident" id="4227373">tr</span>&nbsp;<span class="op" id="4227376">*</span><span class="ident" id="4227377">transportRequest</span><span class="op" id="4227393">)</span>&nbsp;<span class="ident" id="4227395">extraHeaders</span><span class="op" id="4227407">(</span><span class="op" id="4227408">)</span>&nbsp;<span class="ident" id="4227410">Header</span>&nbsp;<span class="op" id="4227417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227420">if</span>&nbsp;<span class="ident" id="4227423">tr</span><span class="op" id="4227425">.</span><span class="ident" id="4227426">extra</span>&nbsp;<span class="op" id="4227432">==</span>&nbsp;<span class="builtintype" id="4227435">nil</span>&nbsp;<span class="op" id="4227439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227443">tr</span><span class="op" id="4227445">.</span><span class="ident" id="4227446">extra</span>&nbsp;<span class="op" id="4227452">=</span>&nbsp;<span class="builtinfunc" id="4227454">make</span><span class="op" id="4227458">(</span><span class="ident" id="4227459">Header</span><span class="op" id="4227465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227471">return</span>&nbsp;<span class="ident" id="4227478">tr</span><span class="op" id="4227480">.</span><span class="ident" id="4227481">extra</span><br>
<span class="lineno">185</span><span class="op" id="4227487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4227490">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="4227542">//</span><br>
<span class="lineno"></span><span class="comment" id="4227545">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="4227614">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4227669">func</span>&nbsp;<span class="op" id="4227674">(</span><span class="ident" id="4227675">t</span>&nbsp;<span class="op" id="4227677">*</span><span class="ident" id="4227678">Transport</span><span class="op" id="4227687">)</span>&nbsp;<span class="ident" id="4227689">RoundTrip</span><span class="op" id="4227698">(</span><span class="ident" id="4227699">req</span>&nbsp;<span class="op" id="4227703">*</span><span class="ident" id="4227704">Request</span><span class="op" id="4227711">)</span>&nbsp;<span class="op" id="4227713">(</span><span class="ident" id="4227714">resp</span>&nbsp;<span class="op" id="4227719">*</span><span class="ident" id="4227720">Response</span><span class="op" id="4227728">,</span>&nbsp;<span class="ident" id="4227730">err</span>&nbsp;<span class="builtintype" id="4227734">error</span><span class="op" id="4227739">)</span>&nbsp;<span class="op" id="4227741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227744">if</span>&nbsp;<span class="ident" id="4227747">req</span><span class="op" id="4227750">.</span><span class="ident" id="4227751">URL</span>&nbsp;<span class="op" id="4227755">==</span>&nbsp;<span class="builtintype" id="4227758">nil</span>&nbsp;<span class="op" id="4227762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227766">req</span><span class="op" id="4227769">.</span><span class="ident" id="4227770">closeBody</span><span class="op" id="4227779">(</span><span class="op" id="4227780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227784">return</span>&nbsp;<span class="builtintype" id="4227791">nil</span><span class="op" id="4227794">,</span>&nbsp;<span class="ident" id="4227796">errors</span><span class="op" id="4227802">.</span><span class="ident" id="4227803">New</span><span class="op" id="4227806">(</span><span class="string" id="4227807">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="4227830">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227836">if</span>&nbsp;<span class="ident" id="4227839">req</span><span class="op" id="4227842">.</span><span class="ident" id="4227843">Header</span>&nbsp;<span class="op" id="4227850">==</span>&nbsp;<span class="builtintype" id="4227853">nil</span>&nbsp;<span class="op" id="4227857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227861">req</span><span class="op" id="4227864">.</span><span class="ident" id="4227865">closeBody</span><span class="op" id="4227874">(</span><span class="op" id="4227875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227879">return</span>&nbsp;<span class="builtintype" id="4227886">nil</span><span class="op" id="4227889">,</span>&nbsp;<span class="ident" id="4227891">errors</span><span class="op" id="4227897">.</span><span class="ident" id="4227898">New</span><span class="op" id="4227901">(</span><span class="string" id="4227902">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="4227928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4227931">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4227934">if</span>&nbsp;<span class="ident" id="4227937">req</span><span class="op" id="4227940">.</span><span class="ident" id="4227941">URL</span><span class="op" id="4227944">.</span><span class="ident" id="4227945">Scheme</span>&nbsp;<span class="op" id="4227952">!=</span>&nbsp;<span class="string" id="4227955">&#34;http&#34;</span>&nbsp;<span class="op" id="4227962">&amp;&amp;</span>&nbsp;<span class="ident" id="4227965">req</span><span class="op" id="4227968">.</span><span class="ident" id="4227969">URL</span><span class="op" id="4227972">.</span><span class="ident" id="4227973">Scheme</span>&nbsp;<span class="op" id="4227980">!=</span>&nbsp;<span class="string" id="4227983">&#34;https&#34;</span>&nbsp;<span class="op" id="4227991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4227995">t</span><span class="op" id="4227996">.</span><span class="ident" id="4227997">altMu</span><span class="op" id="4228002">.</span><span class="ident" id="4228003">RLock</span><span class="op" id="4228008">(</span><span class="op" id="4228009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228013">var</span>&nbsp;<span class="ident" id="4228017">rt</span>&nbsp;<span class="ident" id="4228020">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228035">if</span>&nbsp;<span class="ident" id="4228038">t</span><span class="op" id="4228039">.</span><span class="ident" id="4228040">altProto</span>&nbsp;<span class="op" id="4228049">!=</span>&nbsp;<span class="builtintype" id="4228052">nil</span>&nbsp;<span class="op" id="4228056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228061">rt</span>&nbsp;<span class="op" id="4228064">=</span>&nbsp;<span class="ident" id="4228066">t</span><span class="op" id="4228067">.</span><span class="ident" id="4228068">altProto</span><span class="op" id="4228076">[</span><span class="ident" id="4228077">req</span><span class="op" id="4228080">.</span><span class="ident" id="4228081">URL</span><span class="op" id="4228084">.</span><span class="ident" id="4228085">Scheme</span><span class="op" id="4228091">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228099">t</span><span class="op" id="4228100">.</span><span class="ident" id="4228101">altMu</span><span class="op" id="4228106">.</span><span class="ident" id="4228107">RUnlock</span><span class="op" id="4228114">(</span><span class="op" id="4228115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228119">if</span>&nbsp;<span class="ident" id="4228122">rt</span>&nbsp;<span class="op" id="4228125">==</span>&nbsp;<span class="builtintype" id="4228128">nil</span>&nbsp;<span class="op" id="4228132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228137">req</span><span class="op" id="4228140">.</span><span class="ident" id="4228141">closeBody</span><span class="op" id="4228150">(</span><span class="op" id="4228151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228156">return</span>&nbsp;<span class="builtintype" id="4228163">nil</span><span class="op" id="4228166">,</span>&nbsp;<span class="op" id="4228168">&amp;</span><span class="ident" id="4228169">badStringError</span><span class="op" id="4228183">{</span><span class="string" id="4228184">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="4228213">,</span>&nbsp;<span class="ident" id="4228215">req</span><span class="op" id="4228218">.</span><span class="ident" id="4228219">URL</span><span class="op" id="4228222">.</span><span class="ident" id="4228223">Scheme</span><span class="op" id="4228229">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228237">return</span>&nbsp;<span class="ident" id="4228244">rt</span><span class="op" id="4228246">.</span><span class="ident" id="4228247">RoundTrip</span><span class="op" id="4228256">(</span><span class="ident" id="4228257">req</span><span class="op" id="4228260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228266">if</span>&nbsp;<span class="ident" id="4228269">req</span><span class="op" id="4228272">.</span><span class="ident" id="4228273">URL</span><span class="op" id="4228276">.</span><span class="ident" id="4228277">Host</span>&nbsp;<span class="op" id="4228282">==</span>&nbsp;<span class="string" id="4228285">&#34;&#34;</span>&nbsp;<span class="op" id="4228288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228292">req</span><span class="op" id="4228295">.</span><span class="ident" id="4228296">closeBody</span><span class="op" id="4228305">(</span><span class="op" id="4228306">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228310">return</span>&nbsp;<span class="builtintype" id="4228317">nil</span><span class="op" id="4228320">,</span>&nbsp;<span class="ident" id="4228322">errors</span><span class="op" id="4228328">.</span><span class="ident" id="4228329">New</span><span class="op" id="4228332">(</span><span class="string" id="4228333">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="4228363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228369">treq</span>&nbsp;<span class="op" id="4228374">:=</span>&nbsp;<span class="op" id="4228377">&amp;</span><span class="ident" id="4228378">transportRequest</span><span class="op" id="4228394">{</span><span class="ident" id="4228395">Request</span><span class="op" id="4228402">:</span>&nbsp;<span class="ident" id="4228404">req</span><span class="op" id="4228407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228410">cm</span><span class="op" id="4228412">,</span>&nbsp;<span class="ident" id="4228414">err</span>&nbsp;<span class="op" id="4228418">:=</span>&nbsp;<span class="ident" id="4228421">t</span><span class="op" id="4228422">.</span><span class="ident" id="4228423">connectMethodForRequest</span><span class="op" id="4228446">(</span><span class="ident" id="4228447">treq</span><span class="op" id="4228451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228454">if</span>&nbsp;<span class="ident" id="4228457">err</span>&nbsp;<span class="op" id="4228461">!=</span>&nbsp;<span class="builtintype" id="4228464">nil</span>&nbsp;<span class="op" id="4228468">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228472">req</span><span class="op" id="4228475">.</span><span class="ident" id="4228476">closeBody</span><span class="op" id="4228485">(</span><span class="op" id="4228486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228490">return</span>&nbsp;<span class="builtintype" id="4228497">nil</span><span class="op" id="4228500">,</span>&nbsp;<span class="ident" id="4228502">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228511">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228572">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228636">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4228700">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228725">pconn</span><span class="op" id="4228730">,</span>&nbsp;<span class="ident" id="4228732">err</span>&nbsp;<span class="op" id="4228736">:=</span>&nbsp;<span class="ident" id="4228739">t</span><span class="op" id="4228740">.</span><span class="ident" id="4228741">getConn</span><span class="op" id="4228748">(</span><span class="ident" id="4228749">req</span><span class="op" id="4228752">,</span>&nbsp;<span class="ident" id="4228754">cm</span><span class="op" id="4228756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228759">if</span>&nbsp;<span class="ident" id="4228762">err</span>&nbsp;<span class="op" id="4228766">!=</span>&nbsp;<span class="builtintype" id="4228769">nil</span>&nbsp;<span class="op" id="4228773">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228777">t</span><span class="op" id="4228778">.</span><span class="ident" id="4228779">setReqCanceler</span><span class="op" id="4228793">(</span><span class="ident" id="4228794">req</span><span class="op" id="4228797">,</span>&nbsp;<span class="builtintype" id="4228799">nil</span><span class="op" id="4228802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4228806">req</span><span class="op" id="4228809">.</span><span class="ident" id="4228810">closeBody</span><span class="op" id="4228819">(</span><span class="op" id="4228820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228824">return</span>&nbsp;<span class="builtintype" id="4228831">nil</span><span class="op" id="4228834">,</span>&nbsp;<span class="ident" id="4228836">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4228841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4228845">return</span>&nbsp;<span class="ident" id="4228852">pconn</span><span class="op" id="4228857">.</span><span class="ident" id="4228858">roundTrip</span><span class="op" id="4228867">(</span><span class="ident" id="4228868">treq</span><span class="op" id="4228872">)</span><br>
<span class="lineno"></span><span class="op" id="4228874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4228877">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="4228935">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="4229001">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="4229066">//</span><br>
<span class="lineno"></span><span class="comment" id="4229069">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="4229130">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4229191">func</span>&nbsp;<span class="op" id="4229196">(</span><span class="ident" id="4229197">t</span>&nbsp;<span class="op" id="4229199">*</span><span class="ident" id="4229200">Transport</span><span class="op" id="4229209">)</span>&nbsp;<span class="ident" id="4229211">RegisterProtocol</span><span class="op" id="4229227">(</span><span class="ident" id="4229228">scheme</span>&nbsp;<span class="builtintype" id="4229235">string</span><span class="op" id="4229241">,</span>&nbsp;<span class="ident" id="4229243">rt</span>&nbsp;<span class="ident" id="4229246">RoundTripper</span><span class="op" id="4229258">)</span>&nbsp;<span class="op" id="4229260">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229263">if</span>&nbsp;<span class="ident" id="4229266">scheme</span>&nbsp;<span class="op" id="4229273">==</span>&nbsp;<span class="string" id="4229276">&#34;http&#34;</span>&nbsp;<span class="op" id="4229283">||</span>&nbsp;<span class="ident" id="4229286">scheme</span>&nbsp;<span class="op" id="4229293">==</span>&nbsp;<span class="string" id="4229296">&#34;https&#34;</span>&nbsp;<span class="op" id="4229304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4229308">panic</span><span class="op" id="4229313">(</span><span class="string" id="4229314">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="4229326">+</span>&nbsp;<span class="ident" id="4229328">scheme</span>&nbsp;<span class="op" id="4229335">+</span>&nbsp;<span class="string" id="4229337">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="4229358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229364">t</span><span class="op" id="4229365">.</span><span class="ident" id="4229366">altMu</span><span class="op" id="4229371">.</span><span class="ident" id="4229372">Lock</span><span class="op" id="4229376">(</span><span class="op" id="4229377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229380">defer</span>&nbsp;<span class="ident" id="4229386">t</span><span class="op" id="4229387">.</span><span class="ident" id="4229388">altMu</span><span class="op" id="4229393">.</span><span class="ident" id="4229394">Unlock</span><span class="op" id="4229400">(</span><span class="op" id="4229401">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229404">if</span>&nbsp;<span class="ident" id="4229407">t</span><span class="op" id="4229408">.</span><span class="ident" id="4229409">altProto</span>&nbsp;<span class="op" id="4229418">==</span>&nbsp;<span class="builtintype" id="4229421">nil</span>&nbsp;<span class="op" id="4229425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229429">t</span><span class="op" id="4229430">.</span><span class="ident" id="4229431">altProto</span>&nbsp;<span class="op" id="4229440">=</span>&nbsp;<span class="builtinfunc" id="4229442">make</span><span class="op" id="4229446">(</span><span class="keyword" id="4229447">map</span><span class="op" id="4229450">[</span><span class="builtintype" id="4229451">string</span><span class="op" id="4229457">]</span><span class="ident" id="4229458">RoundTripper</span><span class="op" id="4229470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229476">if</span>&nbsp;<span class="ident" id="4229479">_</span><span class="op" id="4229480">,</span>&nbsp;<span class="ident" id="4229482">exists</span>&nbsp;<span class="op" id="4229489">:=</span>&nbsp;<span class="ident" id="4229492">t</span><span class="op" id="4229493">.</span><span class="ident" id="4229494">altProto</span><span class="op" id="4229502">[</span><span class="ident" id="4229503">scheme</span><span class="op" id="4229509">]</span><span class="op" id="4229510">;</span>&nbsp;<span class="ident" id="4229512">exists</span>&nbsp;<span class="op" id="4229519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4229523">panic</span><span class="op" id="4229528">(</span><span class="string" id="4229529">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="4229541">+</span>&nbsp;<span class="ident" id="4229543">scheme</span>&nbsp;<span class="op" id="4229550">+</span>&nbsp;<span class="string" id="4229552">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="4229573">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229579">t</span><span class="op" id="4229580">.</span><span class="ident" id="4229581">altProto</span><span class="op" id="4229589">[</span><span class="ident" id="4229590">scheme</span><span class="op" id="4229596">]</span>&nbsp;<span class="op" id="4229598">=</span>&nbsp;<span class="ident" id="4229600">rt</span><br>
<span class="lineno"></span><span class="op" id="4229603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4229606">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="4229675">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4229739">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="4229812">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4229823">func</span>&nbsp;<span class="op" id="4229828">(</span><span class="ident" id="4229829">t</span>&nbsp;<span class="op" id="4229831">*</span><span class="ident" id="4229832">Transport</span><span class="op" id="4229841">)</span>&nbsp;<span class="ident" id="4229843">CloseIdleConnections</span><span class="op" id="4229863">(</span><span class="op" id="4229864">)</span>&nbsp;<span class="op" id="4229866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229869">t</span><span class="op" id="4229870">.</span><span class="ident" id="4229871">idleMu</span><span class="op" id="4229877">.</span><span class="ident" id="4229878">Lock</span><span class="op" id="4229882">(</span><span class="op" id="4229883">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229886">m</span>&nbsp;<span class="op" id="4229888">:=</span>&nbsp;<span class="ident" id="4229891">t</span><span class="op" id="4229892">.</span><span class="ident" id="4229893">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229903">t</span><span class="op" id="4229904">.</span><span class="ident" id="4229905">idleConn</span>&nbsp;<span class="op" id="4229914">=</span>&nbsp;<span class="builtintype" id="4229916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229921">t</span><span class="op" id="4229922">.</span><span class="ident" id="4229923">idleConnCh</span>&nbsp;<span class="op" id="4229934">=</span>&nbsp;<span class="builtintype" id="4229936">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229941">t</span><span class="op" id="4229942">.</span><span class="ident" id="4229943">wantIdle</span>&nbsp;<span class="op" id="4229952">=</span>&nbsp;<span class="builtintype" id="4229954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229960">t</span><span class="op" id="4229961">.</span><span class="ident" id="4229962">idleMu</span><span class="op" id="4229968">.</span><span class="ident" id="4229969">Unlock</span><span class="op" id="4229975">(</span><span class="op" id="4229976">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4229979">for</span>&nbsp;<span class="ident" id="4229983">_</span><span class="op" id="4229984">,</span>&nbsp;<span class="ident" id="4229986">conns</span>&nbsp;<span class="op" id="4229992">:=</span>&nbsp;<span class="keyword" id="4229995">range</span>&nbsp;<span class="ident" id="4230001">m</span>&nbsp;<span class="op" id="4230003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230007">for</span>&nbsp;<span class="ident" id="4230011">_</span><span class="op" id="4230012">,</span>&nbsp;<span class="ident" id="4230014">pconn</span>&nbsp;<span class="op" id="4230020">:=</span>&nbsp;<span class="keyword" id="4230023">range</span>&nbsp;<span class="ident" id="4230029">conns</span>&nbsp;<span class="op" id="4230035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230040">pconn</span><span class="op" id="4230045">.</span><span class="builtinfunc" id="4230046">close</span><span class="op" id="4230051">(</span><span class="op" id="4230052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230059">}</span><br>
<span class="lineno">275</span><span class="op" id="4230061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4230064">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="4230125">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4230140">func</span>&nbsp;<span class="op" id="4230145">(</span><span class="ident" id="4230146">t</span>&nbsp;<span class="op" id="4230148">*</span><span class="ident" id="4230149">Transport</span><span class="op" id="4230158">)</span>&nbsp;<span class="ident" id="4230160">CancelRequest</span><span class="op" id="4230173">(</span><span class="ident" id="4230174">req</span>&nbsp;<span class="op" id="4230178">*</span><span class="ident" id="4230179">Request</span><span class="op" id="4230186">)</span>&nbsp;<span class="op" id="4230188">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230191">t</span><span class="op" id="4230192">.</span><span class="ident" id="4230193">reqMu</span><span class="op" id="4230198">.</span><span class="ident" id="4230199">Lock</span><span class="op" id="4230203">(</span><span class="op" id="4230204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230207">cancel</span>&nbsp;<span class="op" id="4230214">:=</span>&nbsp;<span class="ident" id="4230217">t</span><span class="op" id="4230218">.</span><span class="ident" id="4230219">reqCanceler</span><span class="op" id="4230230">[</span><span class="ident" id="4230231">req</span><span class="op" id="4230234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230237">t</span><span class="op" id="4230238">.</span><span class="ident" id="4230239">reqMu</span><span class="op" id="4230244">.</span><span class="ident" id="4230245">Unlock</span><span class="op" id="4230251">(</span><span class="op" id="4230252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230255">if</span>&nbsp;<span class="ident" id="4230258">cancel</span>&nbsp;<span class="op" id="4230265">!=</span>&nbsp;<span class="builtintype" id="4230268">nil</span>&nbsp;<span class="op" id="4230272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230276">cancel</span><span class="op" id="4230282">(</span><span class="op" id="4230283">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230286">}</span><br>
<span class="lineno"></span><span class="op" id="4230288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4230291">//</span><br>
<span class="lineno"></span><span class="comment" id="4230294">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="4230337">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4230341">var</span>&nbsp;<span class="op" id="4230345">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230348">httpProxyEnv</span>&nbsp;<span class="op" id="4230361">=</span>&nbsp;<span class="op" id="4230363">&amp;</span><span class="ident" id="4230364">envOnce</span><span class="op" id="4230371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230375">names</span><span class="op" id="4230380">:</span>&nbsp;<span class="op" id="4230382">[</span><span class="op" id="4230383">]</span><span class="builtintype" id="4230384">string</span><span class="op" id="4230390">{</span><span class="string" id="4230391">&#34;HTTP_PROXY&#34;</span><span class="op" id="4230403">,</span>&nbsp;<span class="string" id="4230405">&#34;http_proxy&#34;</span><span class="op" id="4230417">}</span><span class="op" id="4230418">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230424">httpsProxyEnv</span>&nbsp;<span class="op" id="4230438">=</span>&nbsp;<span class="op" id="4230440">&amp;</span><span class="ident" id="4230441">envOnce</span><span class="op" id="4230448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230452">names</span><span class="op" id="4230457">:</span>&nbsp;<span class="op" id="4230459">[</span><span class="op" id="4230460">]</span><span class="builtintype" id="4230461">string</span><span class="op" id="4230467">{</span><span class="string" id="4230468">&#34;HTTPS_PROXY&#34;</span><span class="op" id="4230481">,</span>&nbsp;<span class="string" id="4230483">&#34;https_proxy&#34;</span><span class="op" id="4230496">}</span><span class="op" id="4230497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230503">noProxyEnv</span>&nbsp;<span class="op" id="4230514">=</span>&nbsp;<span class="op" id="4230516">&amp;</span><span class="ident" id="4230517">envOnce</span><span class="op" id="4230524">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230528">names</span><span class="op" id="4230533">:</span>&nbsp;<span class="op" id="4230535">[</span><span class="op" id="4230536">]</span><span class="builtintype" id="4230537">string</span><span class="op" id="4230543">{</span><span class="string" id="4230544">&#34;NO_PROXY&#34;</span><span class="op" id="4230554">,</span>&nbsp;<span class="string" id="4230556">&#34;no_proxy&#34;</span><span class="op" id="4230566">}</span><span class="op" id="4230567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230570">}</span><br>
<span class="lineno"></span><span class="op" id="4230572">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4230575">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="4230643">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="4230708">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="4230727">type</span>&nbsp;<span class="ident" id="4230732">envOnce</span>&nbsp;<span class="keyword" id="4230740">struct</span>&nbsp;<span class="op" id="4230747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230750">names</span>&nbsp;<span class="op" id="4230756">[</span><span class="op" id="4230757">]</span><span class="builtintype" id="4230758">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230766">once</span>&nbsp;&nbsp;<span class="ident" id="4230772">sync</span><span class="op" id="4230776">.</span><span class="ident" id="4230777">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230783">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4230789">string</span><br>
<span class="lineno"></span><span class="op" id="4230796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4230799">func</span>&nbsp;<span class="op" id="4230804">(</span><span class="ident" id="4230805">e</span>&nbsp;<span class="op" id="4230807">*</span><span class="ident" id="4230808">envOnce</span><span class="op" id="4230815">)</span>&nbsp;<span class="ident" id="4230817">Get</span><span class="op" id="4230820">(</span><span class="op" id="4230821">)</span>&nbsp;<span class="builtintype" id="4230823">string</span>&nbsp;<span class="op" id="4230830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230833">e</span><span class="op" id="4230834">.</span><span class="ident" id="4230835">once</span><span class="op" id="4230839">.</span><span class="ident" id="4230840">Do</span><span class="op" id="4230842">(</span><span class="ident" id="4230843">e</span><span class="op" id="4230844">.</span><span class="ident" id="4230845">init</span><span class="op" id="4230849">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230852">return</span>&nbsp;<span class="ident" id="4230859">e</span><span class="op" id="4230860">.</span><span class="ident" id="4230861">val</span><br>
<span class="lineno"></span><span class="op" id="4230865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4230868">func</span>&nbsp;<span class="op" id="4230873">(</span><span class="ident" id="4230874">e</span>&nbsp;<span class="op" id="4230876">*</span><span class="ident" id="4230877">envOnce</span><span class="op" id="4230884">)</span>&nbsp;<span class="ident" id="4230886">init</span><span class="op" id="4230890">(</span><span class="op" id="4230891">)</span>&nbsp;<span class="op" id="4230893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230896">for</span>&nbsp;<span class="ident" id="4230900">_</span><span class="op" id="4230901">,</span>&nbsp;<span class="ident" id="4230903">n</span>&nbsp;<span class="op" id="4230905">:=</span>&nbsp;<span class="keyword" id="4230908">range</span>&nbsp;<span class="ident" id="4230914">e</span><span class="op" id="4230915">.</span><span class="ident" id="4230916">names</span>&nbsp;<span class="op" id="4230922">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4230926">e</span><span class="op" id="4230927">.</span><span class="ident" id="4230928">val</span>&nbsp;<span class="op" id="4230932">=</span>&nbsp;<span class="ident" id="4230934">os</span><span class="op" id="4230936">.</span><span class="ident" id="4230937">Getenv</span><span class="op" id="4230943">(</span><span class="ident" id="4230944">n</span><span class="op" id="4230945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230949">if</span>&nbsp;<span class="ident" id="4230952">e</span><span class="op" id="4230953">.</span><span class="ident" id="4230954">val</span>&nbsp;<span class="op" id="4230958">!=</span>&nbsp;<span class="string" id="4230961">&#34;&#34;</span>&nbsp;<span class="op" id="4230964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4230969">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4230981">}</span><br>
<span class="lineno">325</span><span class="op" id="4230983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4230986">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="4231012">func</span>&nbsp;<span class="op" id="4231017">(</span><span class="ident" id="4231018">e</span>&nbsp;<span class="op" id="4231020">*</span><span class="ident" id="4231021">envOnce</span><span class="op" id="4231028">)</span>&nbsp;<span class="ident" id="4231030">reset</span><span class="op" id="4231035">(</span><span class="op" id="4231036">)</span>&nbsp;<span class="op" id="4231038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231041">e</span><span class="op" id="4231042">.</span><span class="ident" id="4231043">once</span>&nbsp;<span class="op" id="4231048">=</span>&nbsp;<span class="ident" id="4231050">sync</span><span class="op" id="4231054">.</span><span class="ident" id="4231055">Once</span><span class="op" id="4231059">{</span><span class="op" id="4231060">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231063">e</span><span class="op" id="4231064">.</span><span class="ident" id="4231065">val</span>&nbsp;<span class="op" id="4231069">=</span>&nbsp;<span class="string" id="4231071">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4231074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4231077">func</span>&nbsp;<span class="op" id="4231082">(</span><span class="ident" id="4231083">t</span>&nbsp;<span class="op" id="4231085">*</span><span class="ident" id="4231086">Transport</span><span class="op" id="4231095">)</span>&nbsp;<span class="ident" id="4231097">connectMethodForRequest</span><span class="op" id="4231120">(</span><span class="ident" id="4231121">treq</span>&nbsp;<span class="op" id="4231126">*</span><span class="ident" id="4231127">transportRequest</span><span class="op" id="4231143">)</span>&nbsp;<span class="op" id="4231145">(</span><span class="ident" id="4231146">cm</span>&nbsp;<span class="ident" id="4231149">connectMethod</span><span class="op" id="4231162">,</span>&nbsp;<span class="ident" id="4231164">err</span>&nbsp;<span class="builtintype" id="4231168">error</span><span class="op" id="4231173">)</span>&nbsp;<span class="op" id="4231175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231178">cm</span><span class="op" id="4231180">.</span><span class="ident" id="4231181">targetScheme</span>&nbsp;<span class="op" id="4231194">=</span>&nbsp;<span class="ident" id="4231196">treq</span><span class="op" id="4231200">.</span><span class="ident" id="4231201">URL</span><span class="op" id="4231204">.</span><span class="ident" id="4231205">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231213">cm</span><span class="op" id="4231215">.</span><span class="ident" id="4231216">targetAddr</span>&nbsp;<span class="op" id="4231227">=</span>&nbsp;<span class="ident" id="4231229">canonicalAddr</span><span class="op" id="4231242">(</span><span class="ident" id="4231243">treq</span><span class="op" id="4231247">.</span><span class="ident" id="4231248">URL</span><span class="op" id="4231251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231254">if</span>&nbsp;<span class="ident" id="4231257">t</span><span class="op" id="4231258">.</span><span class="ident" id="4231259">Proxy</span>&nbsp;<span class="op" id="4231265">!=</span>&nbsp;<span class="builtintype" id="4231268">nil</span>&nbsp;<span class="op" id="4231272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231276">cm</span><span class="op" id="4231278">.</span><span class="ident" id="4231279">proxyURL</span><span class="op" id="4231287">,</span>&nbsp;<span class="ident" id="4231289">err</span>&nbsp;<span class="op" id="4231293">=</span>&nbsp;<span class="ident" id="4231295">t</span><span class="op" id="4231296">.</span><span class="ident" id="4231297">Proxy</span><span class="op" id="4231302">(</span><span class="ident" id="4231303">treq</span><span class="op" id="4231307">.</span><span class="ident" id="4231308">Request</span><span class="op" id="4231315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231321">return</span>&nbsp;<span class="ident" id="4231328">cm</span><span class="op" id="4231330">,</span>&nbsp;<span class="ident" id="4231332">err</span><br>
<span class="lineno">340</span><span class="op" id="4231336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4231339">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="4231398">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="4231429">func</span>&nbsp;<span class="op" id="4231434">(</span><span class="ident" id="4231435">cm</span>&nbsp;<span class="op" id="4231438">*</span><span class="ident" id="4231439">connectMethod</span><span class="op" id="4231452">)</span>&nbsp;<span class="ident" id="4231454">proxyAuth</span><span class="op" id="4231463">(</span><span class="op" id="4231464">)</span>&nbsp;<span class="builtintype" id="4231466">string</span>&nbsp;<span class="op" id="4231473">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231476">if</span>&nbsp;<span class="ident" id="4231479">cm</span><span class="op" id="4231481">.</span><span class="ident" id="4231482">proxyURL</span>&nbsp;<span class="op" id="4231491">==</span>&nbsp;<span class="builtintype" id="4231494">nil</span>&nbsp;<span class="op" id="4231498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231502">return</span>&nbsp;<span class="string" id="4231509">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231516">if</span>&nbsp;<span class="ident" id="4231519">u</span>&nbsp;<span class="op" id="4231521">:=</span>&nbsp;<span class="ident" id="4231524">cm</span><span class="op" id="4231526">.</span><span class="ident" id="4231527">proxyURL</span><span class="op" id="4231535">.</span><span class="ident" id="4231536">User</span><span class="op" id="4231540">;</span>&nbsp;<span class="ident" id="4231542">u</span>&nbsp;<span class="op" id="4231544">!=</span>&nbsp;<span class="builtintype" id="4231547">nil</span>&nbsp;<span class="op" id="4231551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231555">username</span>&nbsp;<span class="op" id="4231564">:=</span>&nbsp;<span class="ident" id="4231567">u</span><span class="op" id="4231568">.</span><span class="ident" id="4231569">Username</span><span class="op" id="4231577">(</span><span class="op" id="4231578">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231582">password</span><span class="op" id="4231590">,</span>&nbsp;<span class="ident" id="4231592">_</span>&nbsp;<span class="op" id="4231594">:=</span>&nbsp;<span class="ident" id="4231597">u</span><span class="op" id="4231598">.</span><span class="ident" id="4231599">Password</span><span class="op" id="4231607">(</span><span class="op" id="4231608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231612">return</span>&nbsp;<span class="string" id="4231619">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="4231628">+</span>&nbsp;<span class="ident" id="4231630">basicAuth</span><span class="op" id="4231639">(</span><span class="ident" id="4231640">username</span><span class="op" id="4231648">,</span>&nbsp;<span class="ident" id="4231650">password</span><span class="op" id="4231658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4231661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231664">return</span>&nbsp;<span class="string" id="4231671">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4231674">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="4231677">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="4231755">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4231773">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="4231841">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="4231859">func</span>&nbsp;<span class="op" id="4231864">(</span><span class="ident" id="4231865">t</span>&nbsp;<span class="op" id="4231867">*</span><span class="ident" id="4231868">Transport</span><span class="op" id="4231877">)</span>&nbsp;<span class="ident" id="4231879">putIdleConn</span><span class="op" id="4231890">(</span><span class="ident" id="4231891">pconn</span>&nbsp;<span class="op" id="4231897">*</span><span class="ident" id="4231898">persistConn</span><span class="op" id="4231909">)</span>&nbsp;<span class="builtintype" id="4231911">bool</span>&nbsp;<span class="op" id="4231916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231919">if</span>&nbsp;<span class="ident" id="4231922">t</span><span class="op" id="4231923">.</span><span class="ident" id="4231924">DisableKeepAlives</span>&nbsp;<span class="op" id="4231942">||</span>&nbsp;<span class="ident" id="4231945">t</span><span class="op" id="4231946">.</span><span class="ident" id="4231947">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="4231967">&lt;</span>&nbsp;<span class="num" id="4231969">0</span>&nbsp;<span class="op" id="4231971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4231975">pconn</span><span class="op" id="4231980">.</span><span class="builtinfunc" id="4231981">close</span><span class="op" id="4231986">(</span><span class="op" id="4231987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4231991">return</span>&nbsp;<span class="builtintype" id="4231998">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232005">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232008">if</span>&nbsp;<span class="ident" id="4232011">pconn</span><span class="op" id="4232016">.</span><span class="ident" id="4232017">isBroken</span><span class="op" id="4232025">(</span><span class="op" id="4232026">)</span>&nbsp;<span class="op" id="4232028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232032">return</span>&nbsp;<span class="builtintype" id="4232039">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232049">key</span>&nbsp;<span class="op" id="4232053">:=</span>&nbsp;<span class="ident" id="4232056">pconn</span><span class="op" id="4232061">.</span><span class="ident" id="4232062">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232072">max</span>&nbsp;<span class="op" id="4232076">:=</span>&nbsp;<span class="ident" id="4232079">t</span><span class="op" id="4232080">.</span><span class="ident" id="4232081">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232102">if</span>&nbsp;<span class="ident" id="4232105">max</span>&nbsp;<span class="op" id="4232109">==</span>&nbsp;<span class="num" id="4232112">0</span>&nbsp;<span class="op" id="4232114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232118">max</span>&nbsp;<span class="op" id="4232122">=</span>&nbsp;<span class="ident" id="4232124">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232155">t</span><span class="op" id="4232156">.</span><span class="ident" id="4232157">idleMu</span><span class="op" id="4232163">.</span><span class="ident" id="4232164">Lock</span><span class="op" id="4232168">(</span><span class="op" id="4232169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232173">waitingDialer</span>&nbsp;<span class="op" id="4232187">:=</span>&nbsp;<span class="ident" id="4232190">t</span><span class="op" id="4232191">.</span><span class="ident" id="4232192">idleConnCh</span><span class="op" id="4232202">[</span><span class="ident" id="4232203">key</span><span class="op" id="4232206">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232209">select</span>&nbsp;<span class="op" id="4232216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232219">case</span>&nbsp;<span class="ident" id="4232224">waitingDialer</span>&nbsp;<span class="op" id="4232238">&lt;-</span>&nbsp;<span class="ident" id="4232241">pconn</span><span class="op" id="4232246">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232250">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232303">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232359">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232405">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232462">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232530">t</span><span class="op" id="4232531">.</span><span class="ident" id="4232532">idleMu</span><span class="op" id="4232538">.</span><span class="ident" id="4232539">Unlock</span><span class="op" id="4232545">(</span><span class="op" id="4232546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232550">return</span>&nbsp;<span class="builtintype" id="4232557">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232563">default</span><span class="op" id="4232570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232574">if</span>&nbsp;<span class="ident" id="4232577">waitingDialer</span>&nbsp;<span class="op" id="4232591">!=</span>&nbsp;<span class="builtintype" id="4232594">nil</span>&nbsp;<span class="op" id="4232598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232603">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4232653">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4232701">delete</span><span class="op" id="4232707">(</span><span class="ident" id="4232708">t</span><span class="op" id="4232709">.</span><span class="ident" id="4232710">idleConnCh</span><span class="op" id="4232720">,</span>&nbsp;<span class="ident" id="4232722">key</span><span class="op" id="4232725">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232735">if</span>&nbsp;<span class="ident" id="4232738">t</span><span class="op" id="4232739">.</span><span class="ident" id="4232740">wantIdle</span>&nbsp;<span class="op" id="4232749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232753">t</span><span class="op" id="4232754">.</span><span class="ident" id="4232755">idleMu</span><span class="op" id="4232761">.</span><span class="ident" id="4232762">Unlock</span><span class="op" id="4232768">(</span><span class="op" id="4232769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232773">pconn</span><span class="op" id="4232778">.</span><span class="builtinfunc" id="4232779">close</span><span class="op" id="4232784">(</span><span class="op" id="4232785">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232789">return</span>&nbsp;<span class="builtintype" id="4232796">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232806">if</span>&nbsp;<span class="ident" id="4232809">t</span><span class="op" id="4232810">.</span><span class="ident" id="4232811">idleConn</span>&nbsp;<span class="op" id="4232820">==</span>&nbsp;<span class="builtintype" id="4232823">nil</span>&nbsp;<span class="op" id="4232827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232831">t</span><span class="op" id="4232832">.</span><span class="ident" id="4232833">idleConn</span>&nbsp;<span class="op" id="4232842">=</span>&nbsp;<span class="builtinfunc" id="4232844">make</span><span class="op" id="4232848">(</span><span class="keyword" id="4232849">map</span><span class="op" id="4232852">[</span><span class="ident" id="4232853">connectMethodKey</span><span class="op" id="4232869">]</span><span class="op" id="4232870">[</span><span class="op" id="4232871">]</span><span class="op" id="4232872">*</span><span class="ident" id="4232873">persistConn</span><span class="op" id="4232884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232887">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232890">if</span>&nbsp;<span class="builtinfunc" id="4232893">len</span><span class="op" id="4232896">(</span><span class="ident" id="4232897">t</span><span class="op" id="4232898">.</span><span class="ident" id="4232899">idleConn</span><span class="op" id="4232907">[</span><span class="ident" id="4232908">key</span><span class="op" id="4232911">]</span><span class="op" id="4232912">)</span>&nbsp;<span class="op" id="4232914">&gt;=</span>&nbsp;<span class="ident" id="4232917">max</span>&nbsp;<span class="op" id="4232921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232925">t</span><span class="op" id="4232926">.</span><span class="ident" id="4232927">idleMu</span><span class="op" id="4232933">.</span><span class="ident" id="4232934">Unlock</span><span class="op" id="4232940">(</span><span class="op" id="4232941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4232945">pconn</span><span class="op" id="4232950">.</span><span class="builtinfunc" id="4232951">close</span><span class="op" id="4232956">(</span><span class="op" id="4232957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232961">return</span>&nbsp;<span class="builtintype" id="4232968">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4232975">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4232978">for</span>&nbsp;<span class="ident" id="4232982">_</span><span class="op" id="4232983">,</span>&nbsp;<span class="ident" id="4232985">exist</span>&nbsp;<span class="op" id="4232991">:=</span>&nbsp;<span class="keyword" id="4232994">range</span>&nbsp;<span class="ident" id="4233000">t</span><span class="op" id="4233001">.</span><span class="ident" id="4233002">idleConn</span><span class="op" id="4233010">[</span><span class="ident" id="4233011">key</span><span class="op" id="4233014">]</span>&nbsp;<span class="op" id="4233016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233020">if</span>&nbsp;<span class="ident" id="4233023">exist</span>&nbsp;<span class="op" id="4233029">==</span>&nbsp;<span class="ident" id="4233032">pconn</span>&nbsp;<span class="op" id="4233038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233043">log</span><span class="op" id="4233046">.</span><span class="ident" id="4233047">Fatalf</span><span class="op" id="4233053">(</span><span class="string" id="4233054">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="4233085">,</span>&nbsp;<span class="ident" id="4233087">pconn</span><span class="op" id="4233092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233099">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233102">t</span><span class="op" id="4233103">.</span><span class="ident" id="4233104">idleConn</span><span class="op" id="4233112">[</span><span class="ident" id="4233113">key</span><span class="op" id="4233116">]</span>&nbsp;<span class="op" id="4233118">=</span>&nbsp;<span class="builtinfunc" id="4233120">append</span><span class="op" id="4233126">(</span><span class="ident" id="4233127">t</span><span class="op" id="4233128">.</span><span class="ident" id="4233129">idleConn</span><span class="op" id="4233137">[</span><span class="ident" id="4233138">key</span><span class="op" id="4233141">]</span><span class="op" id="4233142">,</span>&nbsp;<span class="ident" id="4233144">pconn</span><span class="op" id="4233149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233152">t</span><span class="op" id="4233153">.</span><span class="ident" id="4233154">idleMu</span><span class="op" id="4233160">.</span><span class="ident" id="4233161">Unlock</span><span class="op" id="4233167">(</span><span class="op" id="4233168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233171">return</span>&nbsp;<span class="builtintype" id="4233178">true</span><br>
<span class="lineno"></span><span class="op" id="4233183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4233186">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="4233248">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="4233302">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4233370">func</span>&nbsp;<span class="op" id="4233375">(</span><span class="ident" id="4233376">t</span>&nbsp;<span class="op" id="4233378">*</span><span class="ident" id="4233379">Transport</span><span class="op" id="4233388">)</span>&nbsp;<span class="ident" id="4233390">getIdleConnCh</span><span class="op" id="4233403">(</span><span class="ident" id="4233404">cm</span>&nbsp;<span class="ident" id="4233407">connectMethod</span><span class="op" id="4233420">)</span>&nbsp;<span class="keyword" id="4233422">chan</span>&nbsp;<span class="op" id="4233427">*</span><span class="ident" id="4233428">persistConn</span>&nbsp;<span class="op" id="4233440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233443">if</span>&nbsp;<span class="ident" id="4233446">t</span><span class="op" id="4233447">.</span><span class="ident" id="4233448">DisableKeepAlives</span>&nbsp;<span class="op" id="4233466">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233470">return</span>&nbsp;<span class="builtintype" id="4233477">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233485">key</span>&nbsp;<span class="op" id="4233489">:=</span>&nbsp;<span class="ident" id="4233492">cm</span><span class="op" id="4233494">.</span><span class="ident" id="4233495">key</span><span class="op" id="4233498">(</span><span class="op" id="4233499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233502">t</span><span class="op" id="4233503">.</span><span class="ident" id="4233504">idleMu</span><span class="op" id="4233510">.</span><span class="ident" id="4233511">Lock</span><span class="op" id="4233515">(</span><span class="op" id="4233516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233519">defer</span>&nbsp;<span class="ident" id="4233525">t</span><span class="op" id="4233526">.</span><span class="ident" id="4233527">idleMu</span><span class="op" id="4233533">.</span><span class="ident" id="4233534">Unlock</span><span class="op" id="4233540">(</span><span class="op" id="4233541">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233544">t</span><span class="op" id="4233545">.</span><span class="ident" id="4233546">wantIdle</span>&nbsp;<span class="op" id="4233555">=</span>&nbsp;<span class="builtintype" id="4233557">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233564">if</span>&nbsp;<span class="ident" id="4233567">t</span><span class="op" id="4233568">.</span><span class="ident" id="4233569">idleConnCh</span>&nbsp;<span class="op" id="4233580">==</span>&nbsp;<span class="builtintype" id="4233583">nil</span>&nbsp;<span class="op" id="4233587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233591">t</span><span class="op" id="4233592">.</span><span class="ident" id="4233593">idleConnCh</span>&nbsp;<span class="op" id="4233604">=</span>&nbsp;<span class="builtinfunc" id="4233606">make</span><span class="op" id="4233610">(</span><span class="keyword" id="4233611">map</span><span class="op" id="4233614">[</span><span class="ident" id="4233615">connectMethodKey</span><span class="op" id="4233631">]</span><span class="keyword" id="4233632">chan</span>&nbsp;<span class="op" id="4233637">*</span><span class="ident" id="4233638">persistConn</span><span class="op" id="4233649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233655">ch</span><span class="op" id="4233657">,</span>&nbsp;<span class="ident" id="4233659">ok</span>&nbsp;<span class="op" id="4233662">:=</span>&nbsp;<span class="ident" id="4233665">t</span><span class="op" id="4233666">.</span><span class="ident" id="4233667">idleConnCh</span><span class="op" id="4233677">[</span><span class="ident" id="4233678">key</span><span class="op" id="4233681">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233684">if</span>&nbsp;<span class="op" id="4233687">!</span><span class="ident" id="4233688">ok</span>&nbsp;<span class="op" id="4233691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233695">ch</span>&nbsp;<span class="op" id="4233698">=</span>&nbsp;<span class="builtinfunc" id="4233700">make</span><span class="op" id="4233704">(</span><span class="keyword" id="4233705">chan</span>&nbsp;<span class="op" id="4233710">*</span><span class="ident" id="4233711">persistConn</span><span class="op" id="4233722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233726">t</span><span class="op" id="4233727">.</span><span class="ident" id="4233728">idleConnCh</span><span class="op" id="4233738">[</span><span class="ident" id="4233739">key</span><span class="op" id="4233742">]</span>&nbsp;<span class="op" id="4233744">=</span>&nbsp;<span class="ident" id="4233746">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233753">return</span>&nbsp;<span class="ident" id="4233760">ch</span><br>
<span class="lineno">435</span><span class="op" id="4233763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4233766">func</span>&nbsp;<span class="op" id="4233771">(</span><span class="ident" id="4233772">t</span>&nbsp;<span class="op" id="4233774">*</span><span class="ident" id="4233775">Transport</span><span class="op" id="4233784">)</span>&nbsp;<span class="ident" id="4233786">getIdleConn</span><span class="op" id="4233797">(</span><span class="ident" id="4233798">cm</span>&nbsp;<span class="ident" id="4233801">connectMethod</span><span class="op" id="4233814">)</span>&nbsp;<span class="op" id="4233816">(</span><span class="ident" id="4233817">pconn</span>&nbsp;<span class="op" id="4233823">*</span><span class="ident" id="4233824">persistConn</span><span class="op" id="4233835">)</span>&nbsp;<span class="op" id="4233837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233840">key</span>&nbsp;<span class="op" id="4233844">:=</span>&nbsp;<span class="ident" id="4233847">cm</span><span class="op" id="4233849">.</span><span class="ident" id="4233850">key</span><span class="op" id="4233853">(</span><span class="op" id="4233854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233857">t</span><span class="op" id="4233858">.</span><span class="ident" id="4233859">idleMu</span><span class="op" id="4233865">.</span><span class="ident" id="4233866">Lock</span><span class="op" id="4233870">(</span><span class="op" id="4233871">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233874">defer</span>&nbsp;<span class="ident" id="4233880">t</span><span class="op" id="4233881">.</span><span class="ident" id="4233882">idleMu</span><span class="op" id="4233888">.</span><span class="ident" id="4233889">Unlock</span><span class="op" id="4233895">(</span><span class="op" id="4233896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233899">if</span>&nbsp;<span class="ident" id="4233902">t</span><span class="op" id="4233903">.</span><span class="ident" id="4233904">idleConn</span>&nbsp;<span class="op" id="4233913">==</span>&nbsp;<span class="builtintype" id="4233916">nil</span>&nbsp;<span class="op" id="4233920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233924">return</span>&nbsp;<span class="builtintype" id="4233931">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4233936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233939">for</span>&nbsp;<span class="op" id="4233943">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4233947">pconns</span><span class="op" id="4233953">,</span>&nbsp;<span class="ident" id="4233955">ok</span>&nbsp;<span class="op" id="4233958">:=</span>&nbsp;<span class="ident" id="4233961">t</span><span class="op" id="4233962">.</span><span class="ident" id="4233963">idleConn</span><span class="op" id="4233971">[</span><span class="ident" id="4233972">key</span><span class="op" id="4233975">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233979">if</span>&nbsp;<span class="op" id="4233982">!</span><span class="ident" id="4233983">ok</span>&nbsp;<span class="op" id="4233986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4233991">return</span>&nbsp;<span class="builtintype" id="4233998">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234008">if</span>&nbsp;<span class="builtinfunc" id="4234011">len</span><span class="op" id="4234014">(</span><span class="ident" id="4234015">pconns</span><span class="op" id="4234021">)</span>&nbsp;<span class="op" id="4234023">==</span>&nbsp;<span class="num" id="4234026">1</span>&nbsp;<span class="op" id="4234028">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234033">pconn</span>&nbsp;<span class="op" id="4234039">=</span>&nbsp;<span class="ident" id="4234041">pconns</span><span class="op" id="4234047">[</span><span class="num" id="4234048">0</span><span class="op" id="4234049">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4234054">delete</span><span class="op" id="4234060">(</span><span class="ident" id="4234061">t</span><span class="op" id="4234062">.</span><span class="ident" id="4234063">idleConn</span><span class="op" id="4234071">,</span>&nbsp;<span class="ident" id="4234073">key</span><span class="op" id="4234076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234080">}</span>&nbsp;<span class="keyword" id="4234082">else</span>&nbsp;<span class="op" id="4234087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4234092">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4234137">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234156">pconn</span>&nbsp;<span class="op" id="4234162">=</span>&nbsp;<span class="ident" id="4234164">pconns</span><span class="op" id="4234170">[</span><span class="builtinfunc" id="4234171">len</span><span class="op" id="4234174">(</span><span class="ident" id="4234175">pconns</span><span class="op" id="4234181">)</span><span class="op" id="4234182">-</span><span class="num" id="4234183">1</span><span class="op" id="4234184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234189">t</span><span class="op" id="4234190">.</span><span class="ident" id="4234191">idleConn</span><span class="op" id="4234199">[</span><span class="ident" id="4234200">key</span><span class="op" id="4234203">]</span>&nbsp;<span class="op" id="4234205">=</span>&nbsp;<span class="ident" id="4234207">pconns</span><span class="op" id="4234213">[</span><span class="op" id="4234214">:</span><span class="builtinfunc" id="4234215">len</span><span class="op" id="4234218">(</span><span class="ident" id="4234219">pconns</span><span class="op" id="4234225">)</span><span class="op" id="4234226">-</span><span class="num" id="4234227">1</span><span class="op" id="4234228">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234236">if</span>&nbsp;<span class="op" id="4234239">!</span><span class="ident" id="4234240">pconn</span><span class="op" id="4234245">.</span><span class="ident" id="4234246">isBroken</span><span class="op" id="4234254">(</span><span class="op" id="4234255">)</span>&nbsp;<span class="op" id="4234257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234262">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234274">}</span><br>
<span class="lineno"></span><span class="op" id="4234276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4234279">func</span>&nbsp;<span class="op" id="4234284">(</span><span class="ident" id="4234285">t</span>&nbsp;<span class="op" id="4234287">*</span><span class="ident" id="4234288">Transport</span><span class="op" id="4234297">)</span>&nbsp;<span class="ident" id="4234299">setReqCanceler</span><span class="op" id="4234313">(</span><span class="ident" id="4234314">r</span>&nbsp;<span class="op" id="4234316">*</span><span class="ident" id="4234317">Request</span><span class="op" id="4234324">,</span>&nbsp;<span class="ident" id="4234326">fn</span>&nbsp;<span class="keyword" id="4234329">func</span><span class="op" id="4234333">(</span><span class="op" id="4234334">)</span><span class="op" id="4234335">)</span>&nbsp;<span class="op" id="4234337">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234340">t</span><span class="op" id="4234341">.</span><span class="ident" id="4234342">reqMu</span><span class="op" id="4234347">.</span><span class="ident" id="4234348">Lock</span><span class="op" id="4234352">(</span><span class="op" id="4234353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234356">defer</span>&nbsp;<span class="ident" id="4234362">t</span><span class="op" id="4234363">.</span><span class="ident" id="4234364">reqMu</span><span class="op" id="4234369">.</span><span class="ident" id="4234370">Unlock</span><span class="op" id="4234376">(</span><span class="op" id="4234377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234380">if</span>&nbsp;<span class="ident" id="4234383">t</span><span class="op" id="4234384">.</span><span class="ident" id="4234385">reqCanceler</span>&nbsp;<span class="op" id="4234397">==</span>&nbsp;<span class="builtintype" id="4234400">nil</span>&nbsp;<span class="op" id="4234404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234408">t</span><span class="op" id="4234409">.</span><span class="ident" id="4234410">reqCanceler</span>&nbsp;<span class="op" id="4234422">=</span>&nbsp;<span class="builtinfunc" id="4234424">make</span><span class="op" id="4234428">(</span><span class="keyword" id="4234429">map</span><span class="op" id="4234432">[</span><span class="op" id="4234433">*</span><span class="ident" id="4234434">Request</span><span class="op" id="4234441">]</span><span class="keyword" id="4234442">func</span><span class="op" id="4234446">(</span><span class="op" id="4234447">)</span><span class="op" id="4234448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234451">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234454">if</span>&nbsp;<span class="ident" id="4234457">fn</span>&nbsp;<span class="op" id="4234460">!=</span>&nbsp;<span class="builtintype" id="4234463">nil</span>&nbsp;<span class="op" id="4234467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234471">t</span><span class="op" id="4234472">.</span><span class="ident" id="4234473">reqCanceler</span><span class="op" id="4234484">[</span><span class="ident" id="4234485">r</span><span class="op" id="4234486">]</span>&nbsp;<span class="op" id="4234488">=</span>&nbsp;<span class="ident" id="4234490">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234494">}</span>&nbsp;<span class="keyword" id="4234496">else</span>&nbsp;<span class="op" id="4234501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4234505">delete</span><span class="op" id="4234511">(</span><span class="ident" id="4234512">t</span><span class="op" id="4234513">.</span><span class="ident" id="4234514">reqCanceler</span><span class="op" id="4234525">,</span>&nbsp;<span class="ident" id="4234527">r</span><span class="op" id="4234528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234531">}</span><br>
<span class="lineno">475</span><span class="op" id="4234533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4234536">func</span>&nbsp;<span class="op" id="4234541">(</span><span class="ident" id="4234542">t</span>&nbsp;<span class="op" id="4234544">*</span><span class="ident" id="4234545">Transport</span><span class="op" id="4234554">)</span>&nbsp;<span class="ident" id="4234556">dial</span><span class="op" id="4234560">(</span><span class="ident" id="4234561">network</span><span class="op" id="4234568">,</span>&nbsp;<span class="ident" id="4234570">addr</span>&nbsp;<span class="builtintype" id="4234575">string</span><span class="op" id="4234581">)</span>&nbsp;<span class="op" id="4234583">(</span><span class="ident" id="4234584">c</span>&nbsp;<span class="ident" id="4234586">net</span><span class="op" id="4234589">.</span><span class="ident" id="4234590">Conn</span><span class="op" id="4234594">,</span>&nbsp;<span class="ident" id="4234596">err</span>&nbsp;<span class="builtintype" id="4234600">error</span><span class="op" id="4234605">)</span>&nbsp;<span class="op" id="4234607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234610">if</span>&nbsp;<span class="ident" id="4234613">t</span><span class="op" id="4234614">.</span><span class="ident" id="4234615">Dial</span>&nbsp;<span class="op" id="4234620">!=</span>&nbsp;<span class="builtintype" id="4234623">nil</span>&nbsp;<span class="op" id="4234627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234631">return</span>&nbsp;<span class="ident" id="4234638">t</span><span class="op" id="4234639">.</span><span class="ident" id="4234640">Dial</span><span class="op" id="4234644">(</span><span class="ident" id="4234645">network</span><span class="op" id="4234652">,</span>&nbsp;<span class="ident" id="4234654">addr</span><span class="op" id="4234658">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4234661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4234664">return</span>&nbsp;<span class="ident" id="4234671">net</span><span class="op" id="4234674">.</span><span class="ident" id="4234675">Dial</span><span class="op" id="4234679">(</span><span class="ident" id="4234680">network</span><span class="op" id="4234687">,</span>&nbsp;<span class="ident" id="4234689">addr</span><span class="op" id="4234693">)</span><br>
<span class="lineno"></span><span class="op" id="4234695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4234698">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="4234716">var</span>&nbsp;<span class="ident" id="4234720">prePendingDial</span><span class="op" id="4234734">,</span>&nbsp;<span class="ident" id="4234736">postPendingDial</span>&nbsp;<span class="keyword" id="4234752">func</span><span class="op" id="4234756">(</span><span class="op" id="4234757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4234760">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4234824">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="4234896">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="4234972">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="4235006">func</span>&nbsp;<span class="op" id="4235011">(</span><span class="ident" id="4235012">t</span>&nbsp;<span class="op" id="4235014">*</span><span class="ident" id="4235015">Transport</span><span class="op" id="4235024">)</span>&nbsp;<span class="ident" id="4235026">getConn</span><span class="op" id="4235033">(</span><span class="ident" id="4235034">req</span>&nbsp;<span class="op" id="4235038">*</span><span class="ident" id="4235039">Request</span><span class="op" id="4235046">,</span>&nbsp;<span class="ident" id="4235048">cm</span>&nbsp;<span class="ident" id="4235051">connectMethod</span><span class="op" id="4235064">)</span>&nbsp;<span class="op" id="4235066">(</span><span class="op" id="4235067">*</span><span class="ident" id="4235068">persistConn</span><span class="op" id="4235079">,</span>&nbsp;<span class="builtintype" id="4235081">error</span><span class="op" id="4235086">)</span>&nbsp;<span class="op" id="4235088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235091">if</span>&nbsp;<span class="ident" id="4235094">pc</span>&nbsp;<span class="op" id="4235097">:=</span>&nbsp;<span class="ident" id="4235100">t</span><span class="op" id="4235101">.</span><span class="ident" id="4235102">getIdleConn</span><span class="op" id="4235113">(</span><span class="ident" id="4235114">cm</span><span class="op" id="4235116">)</span><span class="op" id="4235117">;</span>&nbsp;<span class="ident" id="4235119">pc</span>&nbsp;<span class="op" id="4235122">!=</span>&nbsp;<span class="builtintype" id="4235125">nil</span>&nbsp;<span class="op" id="4235129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235133">return</span>&nbsp;<span class="ident" id="4235140">pc</span><span class="op" id="4235142">,</span>&nbsp;<span class="builtintype" id="4235144">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235149">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235153">type</span>&nbsp;<span class="ident" id="4235158">dialRes</span>&nbsp;<span class="keyword" id="4235166">struct</span>&nbsp;<span class="op" id="4235173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235177">pc</span>&nbsp;&nbsp;<span class="op" id="4235181">*</span><span class="ident" id="4235182">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235196">err</span>&nbsp;<span class="builtintype" id="4235200">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235207">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235210">dialc</span>&nbsp;<span class="op" id="4235216">:=</span>&nbsp;<span class="builtinfunc" id="4235219">make</span><span class="op" id="4235223">(</span><span class="keyword" id="4235224">chan</span>&nbsp;<span class="ident" id="4235229">dialRes</span><span class="op" id="4235236">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235240">handlePendingDial</span>&nbsp;<span class="op" id="4235258">:=</span>&nbsp;<span class="keyword" id="4235261">func</span><span class="op" id="4235265">(</span><span class="op" id="4235266">)</span>&nbsp;<span class="op" id="4235268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235272">if</span>&nbsp;<span class="ident" id="4235275">prePendingDial</span>&nbsp;<span class="op" id="4235290">!=</span>&nbsp;<span class="builtintype" id="4235293">nil</span>&nbsp;<span class="op" id="4235297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235302">prePendingDial</span><span class="op" id="4235316">(</span><span class="op" id="4235317">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235325">go</span>&nbsp;<span class="keyword" id="4235328">func</span><span class="op" id="4235332">(</span><span class="op" id="4235333">)</span>&nbsp;<span class="op" id="4235335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235340">if</span>&nbsp;<span class="ident" id="4235343">v</span>&nbsp;<span class="op" id="4235345">:=</span>&nbsp;<span class="op" id="4235348">&lt;-</span><span class="ident" id="4235350">dialc</span><span class="op" id="4235355">;</span>&nbsp;<span class="ident" id="4235357">v</span><span class="op" id="4235358">.</span><span class="ident" id="4235359">err</span>&nbsp;<span class="op" id="4235363">==</span>&nbsp;<span class="builtintype" id="4235366">nil</span>&nbsp;<span class="op" id="4235370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235376">t</span><span class="op" id="4235377">.</span><span class="ident" id="4235378">putIdleConn</span><span class="op" id="4235389">(</span><span class="ident" id="4235390">v</span><span class="op" id="4235391">.</span><span class="ident" id="4235392">pc</span><span class="op" id="4235394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235399">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235404">if</span>&nbsp;<span class="ident" id="4235407">postPendingDial</span>&nbsp;<span class="op" id="4235423">!=</span>&nbsp;<span class="builtintype" id="4235426">nil</span>&nbsp;<span class="op" id="4235430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235436">postPendingDial</span><span class="op" id="4235451">(</span><span class="op" id="4235452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235461">}</span><span class="op" id="4235462">(</span><span class="op" id="4235463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235466">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235470">cancelc</span>&nbsp;<span class="op" id="4235478">:=</span>&nbsp;<span class="builtinfunc" id="4235481">make</span><span class="op" id="4235485">(</span><span class="keyword" id="4235486">chan</span>&nbsp;<span class="keyword" id="4235491">struct</span><span class="op" id="4235497">{</span><span class="op" id="4235498">}</span><span class="op" id="4235499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235502">t</span><span class="op" id="4235503">.</span><span class="ident" id="4235504">setReqCanceler</span><span class="op" id="4235518">(</span><span class="ident" id="4235519">req</span><span class="op" id="4235522">,</span>&nbsp;<span class="keyword" id="4235524">func</span><span class="op" id="4235528">(</span><span class="op" id="4235529">)</span>&nbsp;<span class="op" id="4235531">{</span>&nbsp;<span class="builtinfunc" id="4235533">close</span><span class="op" id="4235538">(</span><span class="ident" id="4235539">cancelc</span><span class="op" id="4235546">)</span>&nbsp;<span class="op" id="4235548">}</span><span class="op" id="4235549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235553">go</span>&nbsp;<span class="keyword" id="4235556">func</span><span class="op" id="4235560">(</span><span class="op" id="4235561">)</span>&nbsp;<span class="op" id="4235563">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235567">pc</span><span class="op" id="4235569">,</span>&nbsp;<span class="ident" id="4235571">err</span>&nbsp;<span class="op" id="4235575">:=</span>&nbsp;<span class="ident" id="4235578">t</span><span class="op" id="4235579">.</span><span class="ident" id="4235580">dialConn</span><span class="op" id="4235588">(</span><span class="ident" id="4235589">cm</span><span class="op" id="4235591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235595">dialc</span>&nbsp;<span class="op" id="4235601">&lt;-</span>&nbsp;<span class="ident" id="4235604">dialRes</span><span class="op" id="4235611">{</span><span class="ident" id="4235612">pc</span><span class="op" id="4235614">,</span>&nbsp;<span class="ident" id="4235616">err</span><span class="op" id="4235619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4235622">}</span><span class="op" id="4235623">(</span><span class="op" id="4235624">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235628">idleConnCh</span>&nbsp;<span class="op" id="4235639">:=</span>&nbsp;<span class="ident" id="4235642">t</span><span class="op" id="4235643">.</span><span class="ident" id="4235644">getIdleConnCh</span><span class="op" id="4235657">(</span><span class="ident" id="4235658">cm</span><span class="op" id="4235660">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235663">select</span>&nbsp;<span class="op" id="4235670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235673">case</span>&nbsp;<span class="ident" id="4235678">v</span>&nbsp;<span class="op" id="4235680">:=</span>&nbsp;<span class="op" id="4235683">&lt;-</span><span class="ident" id="4235685">dialc</span><span class="op" id="4235690">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235694">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235718">return</span>&nbsp;<span class="ident" id="4235725">v</span><span class="op" id="4235726">.</span><span class="ident" id="4235727">pc</span><span class="op" id="4235729">,</span>&nbsp;<span class="ident" id="4235731">v</span><span class="op" id="4235732">.</span><span class="ident" id="4235733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4235738">case</span>&nbsp;<span class="ident" id="4235743">pc</span>&nbsp;<span class="op" id="4235746">:=</span>&nbsp;<span class="op" id="4235749">&lt;-</span><span class="ident" id="4235751">idleConnCh</span><span class="op" id="4235761">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235765">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235818">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235869">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235908">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4235958">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4235981">handlePendingDial</span><span class="op" id="4235998">(</span><span class="op" id="4235999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236003">return</span>&nbsp;<span class="ident" id="4236010">pc</span><span class="op" id="4236012">,</span>&nbsp;<span class="builtintype" id="4236014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236019">case</span>&nbsp;<span class="op" id="4236024">&lt;-</span><span class="ident" id="4236026">cancelc</span><span class="op" id="4236033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236037">handlePendingDial</span><span class="op" id="4236054">(</span><span class="op" id="4236055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236059">return</span>&nbsp;<span class="builtintype" id="4236066">nil</span><span class="op" id="4236069">,</span>&nbsp;<span class="ident" id="4236071">errors</span><span class="op" id="4236077">.</span><span class="ident" id="4236078">New</span><span class="op" id="4236081">(</span><span class="string" id="4236082">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="4236139">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236142">}</span><br>
<span class="lineno"></span><span class="op" id="4236144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4236147">func</span>&nbsp;<span class="op" id="4236152">(</span><span class="ident" id="4236153">t</span>&nbsp;<span class="op" id="4236155">*</span><span class="ident" id="4236156">Transport</span><span class="op" id="4236165">)</span>&nbsp;<span class="ident" id="4236167">dialConn</span><span class="op" id="4236175">(</span><span class="ident" id="4236176">cm</span>&nbsp;<span class="ident" id="4236179">connectMethod</span><span class="op" id="4236192">)</span>&nbsp;<span class="op" id="4236194">(</span><span class="op" id="4236195">*</span><span class="ident" id="4236196">persistConn</span><span class="op" id="4236207">,</span>&nbsp;<span class="builtintype" id="4236209">error</span><span class="op" id="4236214">)</span>&nbsp;<span class="op" id="4236216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236219">pconn</span>&nbsp;<span class="op" id="4236225">:=</span>&nbsp;<span class="op" id="4236228">&amp;</span><span class="ident" id="4236229">persistConn</span><span class="op" id="4236240">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236244">t</span><span class="op" id="4236245">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236256">t</span><span class="op" id="4236257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236261">cacheKey</span><span class="op" id="4236269">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4236273">cm</span><span class="op" id="4236275">.</span><span class="ident" id="4236276">key</span><span class="op" id="4236279">(</span><span class="op" id="4236280">)</span><span class="op" id="4236281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236285">reqch</span><span class="op" id="4236290">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4236297">make</span><span class="op" id="4236301">(</span><span class="keyword" id="4236302">chan</span>&nbsp;<span class="ident" id="4236307">requestAndChan</span><span class="op" id="4236321">,</span>&nbsp;<span class="num" id="4236323">1</span><span class="op" id="4236324">)</span><span class="op" id="4236325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236329">writech</span><span class="op" id="4236336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4236341">make</span><span class="op" id="4236345">(</span><span class="keyword" id="4236346">chan</span>&nbsp;<span class="ident" id="4236351">writeRequest</span><span class="op" id="4236363">,</span>&nbsp;<span class="num" id="4236365">1</span><span class="op" id="4236366">)</span><span class="op" id="4236367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236371">closech</span><span class="op" id="4236378">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4236383">make</span><span class="op" id="4236387">(</span><span class="keyword" id="4236388">chan</span>&nbsp;<span class="keyword" id="4236393">struct</span><span class="op" id="4236399">{</span><span class="op" id="4236400">}</span><span class="op" id="4236401">)</span><span class="op" id="4236402">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236406">writeErrCh</span><span class="op" id="4236416">:</span>&nbsp;<span class="builtinfunc" id="4236418">make</span><span class="op" id="4236422">(</span><span class="keyword" id="4236423">chan</span>&nbsp;<span class="builtintype" id="4236428">error</span><span class="op" id="4236433">,</span>&nbsp;<span class="num" id="4236435">1</span><span class="op" id="4236436">)</span><span class="op" id="4236437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236443">tlsDial</span>&nbsp;<span class="op" id="4236451">:=</span>&nbsp;<span class="ident" id="4236454">t</span><span class="op" id="4236455">.</span><span class="ident" id="4236456">DialTLS</span>&nbsp;<span class="op" id="4236464">!=</span>&nbsp;<span class="builtintype" id="4236467">nil</span>&nbsp;<span class="op" id="4236471">&amp;&amp;</span>&nbsp;<span class="ident" id="4236474">cm</span><span class="op" id="4236476">.</span><span class="ident" id="4236477">targetScheme</span>&nbsp;<span class="op" id="4236490">==</span>&nbsp;<span class="string" id="4236493">&#34;https&#34;</span>&nbsp;<span class="op" id="4236501">&amp;&amp;</span>&nbsp;<span class="ident" id="4236504">cm</span><span class="op" id="4236506">.</span><span class="ident" id="4236507">proxyURL</span>&nbsp;<span class="op" id="4236516">==</span>&nbsp;<span class="builtintype" id="4236519">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236524">if</span>&nbsp;<span class="ident" id="4236527">tlsDial</span>&nbsp;<span class="op" id="4236535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236539">var</span>&nbsp;<span class="ident" id="4236543">err</span>&nbsp;<span class="builtintype" id="4236547">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236555">pconn</span><span class="op" id="4236560">.</span><span class="ident" id="4236561">conn</span><span class="op" id="4236565">,</span>&nbsp;<span class="ident" id="4236567">err</span>&nbsp;<span class="op" id="4236571">=</span>&nbsp;<span class="ident" id="4236573">t</span><span class="op" id="4236574">.</span><span class="ident" id="4236575">DialTLS</span><span class="op" id="4236582">(</span><span class="string" id="4236583">&#34;tcp&#34;</span><span class="op" id="4236588">,</span>&nbsp;<span class="ident" id="4236590">cm</span><span class="op" id="4236592">.</span><span class="ident" id="4236593">addr</span><span class="op" id="4236597">(</span><span class="op" id="4236598">)</span><span class="op" id="4236599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236603">if</span>&nbsp;<span class="ident" id="4236606">err</span>&nbsp;<span class="op" id="4236610">!=</span>&nbsp;<span class="builtintype" id="4236613">nil</span>&nbsp;<span class="op" id="4236617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236622">return</span>&nbsp;<span class="builtintype" id="4236629">nil</span><span class="op" id="4236632">,</span>&nbsp;<span class="ident" id="4236634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236644">if</span>&nbsp;<span class="ident" id="4236647">tc</span><span class="op" id="4236649">,</span>&nbsp;<span class="ident" id="4236651">ok</span>&nbsp;<span class="op" id="4236654">:=</span>&nbsp;<span class="ident" id="4236657">pconn</span><span class="op" id="4236662">.</span><span class="ident" id="4236663">conn</span><span class="op" id="4236667">.</span><span class="op" id="4236668">(</span><span class="op" id="4236669">*</span><span class="ident" id="4236670">tls</span><span class="op" id="4236673">.</span><span class="ident" id="4236674">Conn</span><span class="op" id="4236678">)</span><span class="op" id="4236679">;</span>&nbsp;<span class="ident" id="4236681">ok</span>&nbsp;<span class="op" id="4236684">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236689">cs</span>&nbsp;<span class="op" id="4236692">:=</span>&nbsp;<span class="ident" id="4236695">tc</span><span class="op" id="4236697">.</span><span class="ident" id="4236698">ConnectionState</span><span class="op" id="4236713">(</span><span class="op" id="4236714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236719">pconn</span><span class="op" id="4236724">.</span><span class="ident" id="4236725">tlsState</span>&nbsp;<span class="op" id="4236734">=</span>&nbsp;<span class="op" id="4236736">&amp;</span><span class="ident" id="4236737">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236745">}</span>&nbsp;<span class="keyword" id="4236747">else</span>&nbsp;<span class="op" id="4236752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236756">conn</span><span class="op" id="4236760">,</span>&nbsp;<span class="ident" id="4236762">err</span>&nbsp;<span class="op" id="4236766">:=</span>&nbsp;<span class="ident" id="4236769">t</span><span class="op" id="4236770">.</span><span class="ident" id="4236771">dial</span><span class="op" id="4236775">(</span><span class="string" id="4236776">&#34;tcp&#34;</span><span class="op" id="4236781">,</span>&nbsp;<span class="ident" id="4236783">cm</span><span class="op" id="4236785">.</span><span class="ident" id="4236786">addr</span><span class="op" id="4236790">(</span><span class="op" id="4236791">)</span><span class="op" id="4236792">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236796">if</span>&nbsp;<span class="ident" id="4236799">err</span>&nbsp;<span class="op" id="4236803">!=</span>&nbsp;<span class="builtintype" id="4236806">nil</span>&nbsp;<span class="op" id="4236810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236815">if</span>&nbsp;<span class="ident" id="4236818">cm</span><span class="op" id="4236820">.</span><span class="ident" id="4236821">proxyURL</span>&nbsp;<span class="op" id="4236830">!=</span>&nbsp;<span class="builtintype" id="4236833">nil</span>&nbsp;<span class="op" id="4236837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236843">err</span>&nbsp;<span class="op" id="4236847">=</span>&nbsp;<span class="ident" id="4236849">fmt</span><span class="op" id="4236852">.</span><span class="ident" id="4236853">Errorf</span><span class="op" id="4236859">(</span><span class="string" id="4236860">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4236900">,</span>&nbsp;<span class="ident" id="4236902">cm</span><span class="op" id="4236904">.</span><span class="ident" id="4236905">proxyURL</span><span class="op" id="4236913">,</span>&nbsp;<span class="ident" id="4236915">err</span><span class="op" id="4236918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236928">return</span>&nbsp;<span class="builtintype" id="4236935">nil</span><span class="op" id="4236938">,</span>&nbsp;<span class="ident" id="4236940">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4236950">pconn</span><span class="op" id="4236955">.</span><span class="ident" id="4236956">conn</span>&nbsp;<span class="op" id="4236961">=</span>&nbsp;<span class="ident" id="4236963">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4236969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4236973">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4236990">switch</span>&nbsp;<span class="op" id="4236997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237000">case</span>&nbsp;<span class="ident" id="4237005">cm</span><span class="op" id="4237007">.</span><span class="ident" id="4237008">proxyURL</span>&nbsp;<span class="op" id="4237017">==</span>&nbsp;<span class="builtintype" id="4237020">nil</span><span class="op" id="4237023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4237027">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237062">case</span>&nbsp;<span class="ident" id="4237067">cm</span><span class="op" id="4237069">.</span><span class="ident" id="4237070">targetScheme</span>&nbsp;<span class="op" id="4237083">==</span>&nbsp;<span class="string" id="4237086">&#34;http&#34;</span><span class="op" id="4237092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237096">pconn</span><span class="op" id="4237101">.</span><span class="ident" id="4237102">isProxy</span>&nbsp;<span class="op" id="4237110">=</span>&nbsp;<span class="builtintype" id="4237112">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237119">if</span>&nbsp;<span class="ident" id="4237122">pa</span>&nbsp;<span class="op" id="4237125">:=</span>&nbsp;<span class="ident" id="4237128">cm</span><span class="op" id="4237130">.</span><span class="ident" id="4237131">proxyAuth</span><span class="op" id="4237140">(</span><span class="op" id="4237141">)</span><span class="op" id="4237142">;</span>&nbsp;<span class="ident" id="4237144">pa</span>&nbsp;<span class="op" id="4237147">!=</span>&nbsp;<span class="string" id="4237150">&#34;&#34;</span>&nbsp;<span class="op" id="4237153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237158">pconn</span><span class="op" id="4237163">.</span><span class="ident" id="4237164">mutateHeaderFunc</span>&nbsp;<span class="op" id="4237181">=</span>&nbsp;<span class="keyword" id="4237183">func</span><span class="op" id="4237187">(</span><span class="ident" id="4237188">h</span>&nbsp;<span class="ident" id="4237190">Header</span><span class="op" id="4237196">)</span>&nbsp;<span class="op" id="4237198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237204">h</span><span class="op" id="4237205">.</span><span class="ident" id="4237206">Set</span><span class="op" id="4237209">(</span><span class="string" id="4237210">&#34;Proxy-Authorization&#34;</span><span class="op" id="4237231">,</span>&nbsp;<span class="ident" id="4237233">pa</span><span class="op" id="4237235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237244">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237247">case</span>&nbsp;<span class="ident" id="4237252">cm</span><span class="op" id="4237254">.</span><span class="ident" id="4237255">targetScheme</span>&nbsp;<span class="op" id="4237268">==</span>&nbsp;<span class="string" id="4237271">&#34;https&#34;</span><span class="op" id="4237278">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237282">conn</span>&nbsp;<span class="op" id="4237287">:=</span>&nbsp;<span class="ident" id="4237290">pconn</span><span class="op" id="4237295">.</span><span class="ident" id="4237296">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237303">connectReq</span>&nbsp;<span class="op" id="4237314">:=</span>&nbsp;<span class="op" id="4237317">&amp;</span><span class="ident" id="4237318">Request</span><span class="op" id="4237325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237330">Method</span><span class="op" id="4237336">:</span>&nbsp;<span class="string" id="4237338">&#34;CONNECT&#34;</span><span class="op" id="4237347">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237352">URL</span><span class="op" id="4237355">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237360">&amp;</span><span class="ident" id="4237361">url</span><span class="op" id="4237364">.</span><span class="ident" id="4237365">URL</span><span class="op" id="4237368">{</span><span class="ident" id="4237369">Opaque</span><span class="op" id="4237375">:</span>&nbsp;<span class="ident" id="4237377">cm</span><span class="op" id="4237379">.</span><span class="ident" id="4237380">targetAddr</span><span class="op" id="4237390">}</span><span class="op" id="4237391">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237396">Host</span><span class="op" id="4237400">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4237404">cm</span><span class="op" id="4237406">.</span><span class="ident" id="4237407">targetAddr</span><span class="op" id="4237417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237422">Header</span><span class="op" id="4237428">:</span>&nbsp;<span class="builtinfunc" id="4237430">make</span><span class="op" id="4237434">(</span><span class="ident" id="4237435">Header</span><span class="op" id="4237441">)</span><span class="op" id="4237442">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237450">if</span>&nbsp;<span class="ident" id="4237453">pa</span>&nbsp;<span class="op" id="4237456">:=</span>&nbsp;<span class="ident" id="4237459">cm</span><span class="op" id="4237461">.</span><span class="ident" id="4237462">proxyAuth</span><span class="op" id="4237471">(</span><span class="op" id="4237472">)</span><span class="op" id="4237473">;</span>&nbsp;<span class="ident" id="4237475">pa</span>&nbsp;<span class="op" id="4237478">!=</span>&nbsp;<span class="string" id="4237481">&#34;&#34;</span>&nbsp;<span class="op" id="4237484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237489">connectReq</span><span class="op" id="4237499">.</span><span class="ident" id="4237500">Header</span><span class="op" id="4237506">.</span><span class="ident" id="4237507">Set</span><span class="op" id="4237510">(</span><span class="string" id="4237511">&#34;Proxy-Authorization&#34;</span><span class="op" id="4237532">,</span>&nbsp;<span class="ident" id="4237534">pa</span><span class="op" id="4237536">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237544">connectReq</span><span class="op" id="4237554">.</span><span class="ident" id="4237555">Write</span><span class="op" id="4237560">(</span><span class="ident" id="4237561">conn</span><span class="op" id="4237565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4237570">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4237590">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4237649">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237697">br</span>&nbsp;<span class="op" id="4237700">:=</span>&nbsp;<span class="ident" id="4237703">bufio</span><span class="op" id="4237708">.</span><span class="ident" id="4237709">NewReader</span><span class="op" id="4237718">(</span><span class="ident" id="4237719">conn</span><span class="op" id="4237723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237727">resp</span><span class="op" id="4237731">,</span>&nbsp;<span class="ident" id="4237733">err</span>&nbsp;<span class="op" id="4237737">:=</span>&nbsp;<span class="ident" id="4237740">ReadResponse</span><span class="op" id="4237752">(</span><span class="ident" id="4237753">br</span><span class="op" id="4237755">,</span>&nbsp;<span class="ident" id="4237757">connectReq</span><span class="op" id="4237767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237771">if</span>&nbsp;<span class="ident" id="4237774">err</span>&nbsp;<span class="op" id="4237778">!=</span>&nbsp;<span class="builtintype" id="4237781">nil</span>&nbsp;<span class="op" id="4237785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237790">conn</span><span class="op" id="4237794">.</span><span class="ident" id="4237795">Close</span><span class="op" id="4237800">(</span><span class="op" id="4237801">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237806">return</span>&nbsp;<span class="builtintype" id="4237813">nil</span><span class="op" id="4237816">,</span>&nbsp;<span class="ident" id="4237818">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237828">if</span>&nbsp;<span class="ident" id="4237831">resp</span><span class="op" id="4237835">.</span><span class="ident" id="4237836">StatusCode</span>&nbsp;<span class="op" id="4237847">!=</span>&nbsp;<span class="num" id="4237850">200</span>&nbsp;<span class="op" id="4237854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237859">f</span>&nbsp;<span class="op" id="4237861">:=</span>&nbsp;<span class="ident" id="4237864">strings</span><span class="op" id="4237871">.</span><span class="ident" id="4237872">SplitN</span><span class="op" id="4237878">(</span><span class="ident" id="4237879">resp</span><span class="op" id="4237883">.</span><span class="ident" id="4237884">Status</span><span class="op" id="4237890">,</span>&nbsp;<span class="string" id="4237892">&#34;&nbsp;&#34;</span><span class="op" id="4237895">,</span>&nbsp;<span class="num" id="4237897">2</span><span class="op" id="4237898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4237903">conn</span><span class="op" id="4237907">.</span><span class="ident" id="4237908">Close</span><span class="op" id="4237913">(</span><span class="op" id="4237914">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237919">return</span>&nbsp;<span class="builtintype" id="4237926">nil</span><span class="op" id="4237929">,</span>&nbsp;<span class="ident" id="4237931">errors</span><span class="op" id="4237937">.</span><span class="ident" id="4237938">New</span><span class="op" id="4237941">(</span><span class="ident" id="4237942">f</span><span class="op" id="4237943">[</span><span class="num" id="4237944">1</span><span class="op" id="4237945">]</span><span class="op" id="4237946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4237953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4237957">if</span>&nbsp;<span class="ident" id="4237960">cm</span><span class="op" id="4237962">.</span><span class="ident" id="4237963">targetScheme</span>&nbsp;<span class="op" id="4237976">==</span>&nbsp;<span class="string" id="4237979">&#34;https&#34;</span>&nbsp;<span class="op" id="4237987">&amp;&amp;</span>&nbsp;<span class="op" id="4237990">!</span><span class="ident" id="4237991">tlsDial</span>&nbsp;<span class="op" id="4237999">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4238003">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238069">cfg</span>&nbsp;<span class="op" id="4238073">:=</span>&nbsp;<span class="ident" id="4238076">t</span><span class="op" id="4238077">.</span><span class="ident" id="4238078">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238096">if</span>&nbsp;<span class="ident" id="4238099">cfg</span>&nbsp;<span class="op" id="4238103">==</span>&nbsp;<span class="builtintype" id="4238106">nil</span>&nbsp;<span class="op" id="4238110">||</span>&nbsp;<span class="ident" id="4238113">cfg</span><span class="op" id="4238116">.</span><span class="ident" id="4238117">ServerName</span>&nbsp;<span class="op" id="4238128">==</span>&nbsp;<span class="string" id="4238131">&#34;&#34;</span>&nbsp;<span class="op" id="4238134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238139">host</span>&nbsp;<span class="op" id="4238144">:=</span>&nbsp;<span class="ident" id="4238147">cm</span><span class="op" id="4238149">.</span><span class="ident" id="4238150">tlsHost</span><span class="op" id="4238157">(</span><span class="op" id="4238158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238163">if</span>&nbsp;<span class="ident" id="4238166">cfg</span>&nbsp;<span class="op" id="4238170">==</span>&nbsp;<span class="builtintype" id="4238173">nil</span>&nbsp;<span class="op" id="4238177">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238183">cfg</span>&nbsp;<span class="op" id="4238187">=</span>&nbsp;<span class="op" id="4238189">&amp;</span><span class="ident" id="4238190">tls</span><span class="op" id="4238193">.</span><span class="ident" id="4238194">Config</span><span class="op" id="4238200">{</span><span class="ident" id="4238201">ServerName</span><span class="op" id="4238211">:</span>&nbsp;<span class="ident" id="4238213">host</span><span class="op" id="4238217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238222">}</span>&nbsp;<span class="keyword" id="4238224">else</span>&nbsp;<span class="op" id="4238229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238235">clone</span>&nbsp;<span class="op" id="4238241">:=</span>&nbsp;<span class="op" id="4238244">*</span><span class="ident" id="4238245">cfg</span>&nbsp;<span class="comment" id="4238249">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238270">clone</span><span class="op" id="4238275">.</span><span class="ident" id="4238276">ServerName</span>&nbsp;<span class="op" id="4238287">=</span>&nbsp;<span class="ident" id="4238289">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238298">cfg</span>&nbsp;<span class="op" id="4238302">=</span>&nbsp;<span class="op" id="4238304">&amp;</span><span class="ident" id="4238305">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238322">plainConn</span>&nbsp;<span class="op" id="4238332">:=</span>&nbsp;<span class="ident" id="4238335">pconn</span><span class="op" id="4238340">.</span><span class="ident" id="4238341">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238348">tlsConn</span>&nbsp;<span class="op" id="4238356">:=</span>&nbsp;<span class="ident" id="4238359">tls</span><span class="op" id="4238362">.</span><span class="ident" id="4238363">Client</span><span class="op" id="4238369">(</span><span class="ident" id="4238370">plainConn</span><span class="op" id="4238379">,</span>&nbsp;<span class="ident" id="4238381">cfg</span><span class="op" id="4238384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238388">errc</span>&nbsp;<span class="op" id="4238393">:=</span>&nbsp;<span class="builtinfunc" id="4238396">make</span><span class="op" id="4238400">(</span><span class="keyword" id="4238401">chan</span>&nbsp;<span class="builtintype" id="4238406">error</span><span class="op" id="4238411">,</span>&nbsp;<span class="num" id="4238413">2</span><span class="op" id="4238414">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238418">var</span>&nbsp;<span class="ident" id="4238422">timer</span>&nbsp;<span class="op" id="4238428">*</span><span class="ident" id="4238429">time</span><span class="op" id="4238433">.</span><span class="ident" id="4238434">Timer</span>&nbsp;<span class="comment" id="4238440">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238473">if</span>&nbsp;<span class="ident" id="4238476">d</span>&nbsp;<span class="op" id="4238478">:=</span>&nbsp;<span class="ident" id="4238481">t</span><span class="op" id="4238482">.</span><span class="ident" id="4238483">TLSHandshakeTimeout</span><span class="op" id="4238502">;</span>&nbsp;<span class="ident" id="4238504">d</span>&nbsp;<span class="op" id="4238506">!=</span>&nbsp;<span class="num" id="4238509">0</span>&nbsp;<span class="op" id="4238511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238516">timer</span>&nbsp;<span class="op" id="4238522">=</span>&nbsp;<span class="ident" id="4238524">time</span><span class="op" id="4238528">.</span><span class="ident" id="4238529">AfterFunc</span><span class="op" id="4238538">(</span><span class="ident" id="4238539">d</span><span class="op" id="4238540">,</span>&nbsp;<span class="keyword" id="4238542">func</span><span class="op" id="4238546">(</span><span class="op" id="4238547">)</span>&nbsp;<span class="op" id="4238549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238555">errc</span>&nbsp;<span class="op" id="4238560">&lt;-</span>&nbsp;<span class="ident" id="4238563">tlsHandshakeTimeoutError</span><span class="op" id="4238587">{</span><span class="op" id="4238588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238593">}</span><span class="op" id="4238594">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238602">go</span>&nbsp;<span class="keyword" id="4238605">func</span><span class="op" id="4238609">(</span><span class="op" id="4238610">)</span>&nbsp;<span class="op" id="4238612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238617">err</span>&nbsp;<span class="op" id="4238621">:=</span>&nbsp;<span class="ident" id="4238624">tlsConn</span><span class="op" id="4238631">.</span><span class="ident" id="4238632">Handshake</span><span class="op" id="4238641">(</span><span class="op" id="4238642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238647">if</span>&nbsp;<span class="ident" id="4238650">timer</span>&nbsp;<span class="op" id="4238656">!=</span>&nbsp;<span class="builtintype" id="4238659">nil</span>&nbsp;<span class="op" id="4238663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238669">timer</span><span class="op" id="4238674">.</span><span class="ident" id="4238675">Stop</span><span class="op" id="4238679">(</span><span class="op" id="4238680">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238690">errc</span>&nbsp;<span class="op" id="4238695">&lt;-</span>&nbsp;<span class="ident" id="4238698">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238704">}</span><span class="op" id="4238705">(</span><span class="op" id="4238706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238710">if</span>&nbsp;<span class="ident" id="4238713">err</span>&nbsp;<span class="op" id="4238717">:=</span>&nbsp;<span class="op" id="4238720">&lt;-</span><span class="ident" id="4238722">errc</span><span class="op" id="4238726">;</span>&nbsp;<span class="ident" id="4238728">err</span>&nbsp;<span class="op" id="4238732">!=</span>&nbsp;<span class="builtintype" id="4238735">nil</span>&nbsp;<span class="op" id="4238739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238744">plainConn</span><span class="op" id="4238753">.</span><span class="ident" id="4238754">Close</span><span class="op" id="4238759">(</span><span class="op" id="4238760">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238765">return</span>&nbsp;<span class="builtintype" id="4238772">nil</span><span class="op" id="4238775">,</span>&nbsp;<span class="ident" id="4238777">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238787">if</span>&nbsp;<span class="op" id="4238790">!</span><span class="ident" id="4238791">cfg</span><span class="op" id="4238794">.</span><span class="ident" id="4238795">InsecureSkipVerify</span>&nbsp;<span class="op" id="4238814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238819">if</span>&nbsp;<span class="ident" id="4238822">err</span>&nbsp;<span class="op" id="4238826">:=</span>&nbsp;<span class="ident" id="4238829">tlsConn</span><span class="op" id="4238836">.</span><span class="ident" id="4238837">VerifyHostname</span><span class="op" id="4238851">(</span><span class="ident" id="4238852">cfg</span><span class="op" id="4238855">.</span><span class="ident" id="4238856">ServerName</span><span class="op" id="4238866">)</span><span class="op" id="4238867">;</span>&nbsp;<span class="ident" id="4238869">err</span>&nbsp;<span class="op" id="4238873">!=</span>&nbsp;<span class="builtintype" id="4238876">nil</span>&nbsp;<span class="op" id="4238880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238886">plainConn</span><span class="op" id="4238895">.</span><span class="ident" id="4238896">Close</span><span class="op" id="4238901">(</span><span class="op" id="4238902">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4238908">return</span>&nbsp;<span class="builtintype" id="4238915">nil</span><span class="op" id="4238918">,</span>&nbsp;<span class="ident" id="4238920">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4238931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238935">cs</span>&nbsp;<span class="op" id="4238938">:=</span>&nbsp;<span class="ident" id="4238941">tlsConn</span><span class="op" id="4238948">.</span><span class="ident" id="4238949">ConnectionState</span><span class="op" id="4238964">(</span><span class="op" id="4238965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238969">pconn</span><span class="op" id="4238974">.</span><span class="ident" id="4238975">tlsState</span>&nbsp;<span class="op" id="4238984">=</span>&nbsp;<span class="op" id="4238986">&amp;</span><span class="ident" id="4238987">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4238992">pconn</span><span class="op" id="4238997">.</span><span class="ident" id="4238998">conn</span>&nbsp;<span class="op" id="4239003">=</span>&nbsp;<span class="ident" id="4239005">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239018">pconn</span><span class="op" id="4239023">.</span><span class="ident" id="4239024">br</span>&nbsp;<span class="op" id="4239027">=</span>&nbsp;<span class="ident" id="4239029">bufio</span><span class="op" id="4239034">.</span><span class="ident" id="4239035">NewReader</span><span class="op" id="4239044">(</span><span class="ident" id="4239045">noteEOFReader</span><span class="op" id="4239058">{</span><span class="ident" id="4239059">pconn</span><span class="op" id="4239064">.</span><span class="ident" id="4239065">conn</span><span class="op" id="4239069">,</span>&nbsp;<span class="op" id="4239071">&amp;</span><span class="ident" id="4239072">pconn</span><span class="op" id="4239077">.</span><span class="ident" id="4239078">sawEOF</span><span class="op" id="4239084">}</span><span class="op" id="4239085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239088">pconn</span><span class="op" id="4239093">.</span><span class="ident" id="4239094">bw</span>&nbsp;<span class="op" id="4239097">=</span>&nbsp;<span class="ident" id="4239099">bufio</span><span class="op" id="4239104">.</span><span class="ident" id="4239105">NewWriter</span><span class="op" id="4239114">(</span><span class="ident" id="4239115">pconn</span><span class="op" id="4239120">.</span><span class="ident" id="4239121">conn</span><span class="op" id="4239125">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239128">go</span>&nbsp;<span class="ident" id="4239131">pconn</span><span class="op" id="4239136">.</span><span class="ident" id="4239137">readLoop</span><span class="op" id="4239145">(</span><span class="op" id="4239146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239149">go</span>&nbsp;<span class="ident" id="4239152">pconn</span><span class="op" id="4239157">.</span><span class="ident" id="4239158">writeLoop</span><span class="op" id="4239167">(</span><span class="op" id="4239168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239171">return</span>&nbsp;<span class="ident" id="4239178">pconn</span><span class="op" id="4239183">,</span>&nbsp;<span class="builtintype" id="4239185">nil</span><br>
<span class="lineno"></span><span class="op" id="4239189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="4239192">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4239257">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="4239320">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="4239376">func</span>&nbsp;<span class="ident" id="4239381">useProxy</span><span class="op" id="4239389">(</span><span class="ident" id="4239390">addr</span>&nbsp;<span class="builtintype" id="4239395">string</span><span class="op" id="4239401">)</span>&nbsp;<span class="builtintype" id="4239403">bool</span>&nbsp;<span class="op" id="4239408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239411">if</span>&nbsp;<span class="builtinfunc" id="4239414">len</span><span class="op" id="4239417">(</span><span class="ident" id="4239418">addr</span><span class="op" id="4239422">)</span>&nbsp;<span class="op" id="4239424">==</span>&nbsp;<span class="num" id="4239427">0</span>&nbsp;<span class="op" id="4239429">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239433">return</span>&nbsp;<span class="builtintype" id="4239440">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239449">host</span><span class="op" id="4239453">,</span>&nbsp;<span class="ident" id="4239455">_</span><span class="op" id="4239456">,</span>&nbsp;<span class="ident" id="4239458">err</span>&nbsp;<span class="op" id="4239462">:=</span>&nbsp;<span class="ident" id="4239465">net</span><span class="op" id="4239468">.</span><span class="ident" id="4239469">SplitHostPort</span><span class="op" id="4239482">(</span><span class="ident" id="4239483">addr</span><span class="op" id="4239487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239490">if</span>&nbsp;<span class="ident" id="4239493">err</span>&nbsp;<span class="op" id="4239497">!=</span>&nbsp;<span class="builtintype" id="4239500">nil</span>&nbsp;<span class="op" id="4239504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239508">return</span>&nbsp;<span class="builtintype" id="4239515">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239525">if</span>&nbsp;<span class="ident" id="4239528">host</span>&nbsp;<span class="op" id="4239533">==</span>&nbsp;<span class="string" id="4239536">&#34;localhost&#34;</span>&nbsp;<span class="op" id="4239548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239552">return</span>&nbsp;<span class="builtintype" id="4239559">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239569">if</span>&nbsp;<span class="ident" id="4239572">ip</span>&nbsp;<span class="op" id="4239575">:=</span>&nbsp;<span class="ident" id="4239578">net</span><span class="op" id="4239581">.</span><span class="ident" id="4239582">ParseIP</span><span class="op" id="4239589">(</span><span class="ident" id="4239590">host</span><span class="op" id="4239594">)</span><span class="op" id="4239595">;</span>&nbsp;<span class="ident" id="4239597">ip</span>&nbsp;<span class="op" id="4239600">!=</span>&nbsp;<span class="builtintype" id="4239603">nil</span>&nbsp;<span class="op" id="4239607">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239611">if</span>&nbsp;<span class="ident" id="4239614">ip</span><span class="op" id="4239616">.</span><span class="ident" id="4239617">IsLoopback</span><span class="op" id="4239627">(</span><span class="op" id="4239628">)</span>&nbsp;<span class="op" id="4239630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239635">return</span>&nbsp;<span class="builtintype" id="4239642">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239657">no_proxy</span>&nbsp;<span class="op" id="4239666">:=</span>&nbsp;<span class="ident" id="4239669">noProxyEnv</span><span class="op" id="4239679">.</span><span class="ident" id="4239680">Get</span><span class="op" id="4239683">(</span><span class="op" id="4239684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239687">if</span>&nbsp;<span class="ident" id="4239690">no_proxy</span>&nbsp;<span class="op" id="4239699">==</span>&nbsp;<span class="string" id="4239702">&#34;*&#34;</span>&nbsp;<span class="op" id="4239706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239710">return</span>&nbsp;<span class="builtintype" id="4239717">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239728">addr</span>&nbsp;<span class="op" id="4239733">=</span>&nbsp;<span class="ident" id="4239735">strings</span><span class="op" id="4239742">.</span><span class="ident" id="4239743">ToLower</span><span class="op" id="4239750">(</span><span class="ident" id="4239751">strings</span><span class="op" id="4239758">.</span><span class="ident" id="4239759">TrimSpace</span><span class="op" id="4239768">(</span><span class="ident" id="4239769">addr</span><span class="op" id="4239773">)</span><span class="op" id="4239774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239777">if</span>&nbsp;<span class="ident" id="4239780">hasPort</span><span class="op" id="4239787">(</span><span class="ident" id="4239788">addr</span><span class="op" id="4239792">)</span>&nbsp;<span class="op" id="4239794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239798">addr</span>&nbsp;<span class="op" id="4239803">=</span>&nbsp;<span class="ident" id="4239805">addr</span><span class="op" id="4239809">[</span><span class="op" id="4239810">:</span><span class="ident" id="4239811">strings</span><span class="op" id="4239818">.</span><span class="ident" id="4239819">LastIndex</span><span class="op" id="4239828">(</span><span class="ident" id="4239829">addr</span><span class="op" id="4239833">,</span>&nbsp;<span class="string" id="4239835">&#34;:&#34;</span><span class="op" id="4239838">)</span><span class="op" id="4239839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239846">for</span>&nbsp;<span class="ident" id="4239850">_</span><span class="op" id="4239851">,</span>&nbsp;<span class="ident" id="4239853">p</span>&nbsp;<span class="op" id="4239855">:=</span>&nbsp;<span class="keyword" id="4239858">range</span>&nbsp;<span class="ident" id="4239864">strings</span><span class="op" id="4239871">.</span><span class="ident" id="4239872">Split</span><span class="op" id="4239877">(</span><span class="ident" id="4239878">no_proxy</span><span class="op" id="4239886">,</span>&nbsp;<span class="string" id="4239888">&#34;,&#34;</span><span class="op" id="4239891">)</span>&nbsp;<span class="op" id="4239893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239897">p</span>&nbsp;<span class="op" id="4239899">=</span>&nbsp;<span class="ident" id="4239901">strings</span><span class="op" id="4239908">.</span><span class="ident" id="4239909">ToLower</span><span class="op" id="4239916">(</span><span class="ident" id="4239917">strings</span><span class="op" id="4239924">.</span><span class="ident" id="4239925">TrimSpace</span><span class="op" id="4239934">(</span><span class="ident" id="4239935">p</span><span class="op" id="4239936">)</span><span class="op" id="4239937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239941">if</span>&nbsp;<span class="builtinfunc" id="4239944">len</span><span class="op" id="4239947">(</span><span class="ident" id="4239948">p</span><span class="op" id="4239949">)</span>&nbsp;<span class="op" id="4239951">==</span>&nbsp;<span class="num" id="4239954">0</span>&nbsp;<span class="op" id="4239956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239961">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4239972">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4239976">if</span>&nbsp;<span class="ident" id="4239979">hasPort</span><span class="op" id="4239986">(</span><span class="ident" id="4239987">p</span><span class="op" id="4239988">)</span>&nbsp;<span class="op" id="4239990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4239995">p</span>&nbsp;<span class="op" id="4239997">=</span>&nbsp;<span class="ident" id="4239999">p</span><span class="op" id="4240000">[</span><span class="op" id="4240001">:</span><span class="ident" id="4240002">strings</span><span class="op" id="4240009">.</span><span class="ident" id="4240010">LastIndex</span><span class="op" id="4240019">(</span><span class="ident" id="4240020">p</span><span class="op" id="4240021">,</span>&nbsp;<span class="string" id="4240023">&#34;:&#34;</span><span class="op" id="4240026">)</span><span class="op" id="4240027">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4240031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240035">if</span>&nbsp;<span class="ident" id="4240038">addr</span>&nbsp;<span class="op" id="4240043">==</span>&nbsp;<span class="ident" id="4240046">p</span>&nbsp;<span class="op" id="4240048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240053">return</span>&nbsp;<span class="builtintype" id="4240060">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4240068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240072">if</span>&nbsp;<span class="ident" id="4240075">p</span><span class="op" id="4240076">[</span><span class="num" id="4240077">0</span><span class="op" id="4240078">]</span>&nbsp;<span class="op" id="4240080">==</span>&nbsp;<span class="string" id="4240083">&#39;.&#39;</span>&nbsp;<span class="op" id="4240087">&amp;&amp;</span>&nbsp;<span class="op" id="4240090">(</span><span class="ident" id="4240091">strings</span><span class="op" id="4240098">.</span><span class="ident" id="4240099">HasSuffix</span><span class="op" id="4240108">(</span><span class="ident" id="4240109">addr</span><span class="op" id="4240113">,</span>&nbsp;<span class="ident" id="4240115">p</span><span class="op" id="4240116">)</span>&nbsp;<span class="op" id="4240118">||</span>&nbsp;<span class="ident" id="4240121">addr</span>&nbsp;<span class="op" id="4240126">==</span>&nbsp;<span class="ident" id="4240129">p</span><span class="op" id="4240130">[</span><span class="num" id="4240131">1</span><span class="op" id="4240132">:</span><span class="op" id="4240133">]</span><span class="op" id="4240134">)</span>&nbsp;<span class="op" id="4240136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4240141">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240202">return</span>&nbsp;<span class="builtintype" id="4240209">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4240217">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240221">if</span>&nbsp;<span class="ident" id="4240224">p</span><span class="op" id="4240225">[</span><span class="num" id="4240226">0</span><span class="op" id="4240227">]</span>&nbsp;<span class="op" id="4240229">!=</span>&nbsp;<span class="string" id="4240232">&#39;.&#39;</span>&nbsp;<span class="op" id="4240236">&amp;&amp;</span>&nbsp;<span class="ident" id="4240239">strings</span><span class="op" id="4240246">.</span><span class="ident" id="4240247">HasSuffix</span><span class="op" id="4240256">(</span><span class="ident" id="4240257">addr</span><span class="op" id="4240261">,</span>&nbsp;<span class="ident" id="4240263">p</span><span class="op" id="4240264">)</span>&nbsp;<span class="op" id="4240266">&amp;&amp;</span>&nbsp;<span class="ident" id="4240269">addr</span><span class="op" id="4240273">[</span><span class="builtinfunc" id="4240274">len</span><span class="op" id="4240277">(</span><span class="ident" id="4240278">addr</span><span class="op" id="4240282">)</span><span class="op" id="4240283">-</span><span class="builtinfunc" id="4240284">len</span><span class="op" id="4240287">(</span><span class="ident" id="4240288">p</span><span class="op" id="4240289">)</span><span class="op" id="4240290">-</span><span class="num" id="4240291">1</span><span class="op" id="4240292">]</span>&nbsp;<span class="op" id="4240294">==</span>&nbsp;<span class="string" id="4240297">&#39;.&#39;</span>&nbsp;<span class="op" id="4240301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4240306">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240353">return</span>&nbsp;<span class="builtintype" id="4240360">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4240368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4240371">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4240374">return</span>&nbsp;<span class="builtintype" id="4240381">true</span><br>
<span class="lineno"></span><span class="op" id="4240386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4240389">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="4240465">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="4240520">//</span><br>
<span class="lineno"></span><span class="comment" id="4240523">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="4240574">//</span><br>
<span class="lineno"></span><span class="comment" id="4240577">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="4240622">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="4240681">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="4240748">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="4240816">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="4240890">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4240968">//</span><br>
<span class="lineno">730</span><span class="comment" id="4240971">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="4241018">//</span><br>
<span class="lineno"></span><span class="keyword" id="4241021">type</span>&nbsp;<span class="ident" id="4241026">connectMethod</span>&nbsp;<span class="keyword" id="4241040">struct</span>&nbsp;<span class="op" id="4241047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241050">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241063">*</span><span class="ident" id="4241064">url</span><span class="op" id="4241067">.</span><span class="ident" id="4241068">URL</span>&nbsp;<span class="comment" id="4241072">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241114">targetScheme</span>&nbsp;<span class="builtintype" id="4241127">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4241136">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241158">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4241171">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4241180">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="4241244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4241247">func</span>&nbsp;<span class="op" id="4241252">(</span><span class="ident" id="4241253">cm</span>&nbsp;<span class="op" id="4241256">*</span><span class="ident" id="4241257">connectMethod</span><span class="op" id="4241270">)</span>&nbsp;<span class="ident" id="4241272">key</span><span class="op" id="4241275">(</span><span class="op" id="4241276">)</span>&nbsp;<span class="ident" id="4241278">connectMethodKey</span>&nbsp;<span class="op" id="4241295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241298">proxyStr</span>&nbsp;<span class="op" id="4241307">:=</span>&nbsp;<span class="string" id="4241310">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241314">targetAddr</span>&nbsp;<span class="op" id="4241325">:=</span>&nbsp;<span class="ident" id="4241328">cm</span><span class="op" id="4241330">.</span><span class="ident" id="4241331">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241343">if</span>&nbsp;<span class="ident" id="4241346">cm</span><span class="op" id="4241348">.</span><span class="ident" id="4241349">proxyURL</span>&nbsp;<span class="op" id="4241358">!=</span>&nbsp;<span class="builtintype" id="4241361">nil</span>&nbsp;<span class="op" id="4241365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241369">proxyStr</span>&nbsp;<span class="op" id="4241378">=</span>&nbsp;<span class="ident" id="4241380">cm</span><span class="op" id="4241382">.</span><span class="ident" id="4241383">proxyURL</span><span class="op" id="4241391">.</span><span class="ident" id="4241392">String</span><span class="op" id="4241398">(</span><span class="op" id="4241399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241403">if</span>&nbsp;<span class="ident" id="4241406">cm</span><span class="op" id="4241408">.</span><span class="ident" id="4241409">targetScheme</span>&nbsp;<span class="op" id="4241422">==</span>&nbsp;<span class="string" id="4241425">&#34;http&#34;</span>&nbsp;<span class="op" id="4241432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241437">targetAddr</span>&nbsp;<span class="op" id="4241448">=</span>&nbsp;<span class="string" id="4241450">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241461">return</span>&nbsp;<span class="ident" id="4241468">connectMethodKey</span><span class="op" id="4241484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241488">proxy</span><span class="op" id="4241493">:</span>&nbsp;&nbsp;<span class="ident" id="4241496">proxyStr</span><span class="op" id="4241504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241508">scheme</span><span class="op" id="4241514">:</span>&nbsp;<span class="ident" id="4241516">cm</span><span class="op" id="4241518">.</span><span class="ident" id="4241519">targetScheme</span><span class="op" id="4241531">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241535">addr</span><span class="op" id="4241539">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4241543">targetAddr</span><span class="op" id="4241553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241556">}</span><br>
<span class="lineno"></span><span class="op" id="4241558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4241561">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="4241636">func</span>&nbsp;<span class="op" id="4241641">(</span><span class="ident" id="4241642">cm</span>&nbsp;<span class="op" id="4241645">*</span><span class="ident" id="4241646">connectMethod</span><span class="op" id="4241659">)</span>&nbsp;<span class="ident" id="4241661">addr</span><span class="op" id="4241665">(</span><span class="op" id="4241666">)</span>&nbsp;<span class="builtintype" id="4241668">string</span>&nbsp;<span class="op" id="4241675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241678">if</span>&nbsp;<span class="ident" id="4241681">cm</span><span class="op" id="4241683">.</span><span class="ident" id="4241684">proxyURL</span>&nbsp;<span class="op" id="4241693">!=</span>&nbsp;<span class="builtintype" id="4241696">nil</span>&nbsp;<span class="op" id="4241700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241704">return</span>&nbsp;<span class="ident" id="4241711">canonicalAddr</span><span class="op" id="4241724">(</span><span class="ident" id="4241725">cm</span><span class="op" id="4241727">.</span><span class="ident" id="4241728">proxyURL</span><span class="op" id="4241736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241742">return</span>&nbsp;<span class="ident" id="4241749">cm</span><span class="op" id="4241751">.</span><span class="ident" id="4241752">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="4241763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4241766">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4241827">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4241847">func</span>&nbsp;<span class="op" id="4241852">(</span><span class="ident" id="4241853">cm</span>&nbsp;<span class="op" id="4241856">*</span><span class="ident" id="4241857">connectMethod</span><span class="op" id="4241870">)</span>&nbsp;<span class="ident" id="4241872">tlsHost</span><span class="op" id="4241879">(</span><span class="op" id="4241880">)</span>&nbsp;<span class="builtintype" id="4241882">string</span>&nbsp;<span class="op" id="4241889">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241892">h</span>&nbsp;<span class="op" id="4241894">:=</span>&nbsp;<span class="ident" id="4241897">cm</span><span class="op" id="4241899">.</span><span class="ident" id="4241900">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241912">if</span>&nbsp;<span class="ident" id="4241915">hasPort</span><span class="op" id="4241922">(</span><span class="ident" id="4241923">h</span><span class="op" id="4241924">)</span>&nbsp;<span class="op" id="4241926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4241930">h</span>&nbsp;<span class="op" id="4241932">=</span>&nbsp;<span class="ident" id="4241934">h</span><span class="op" id="4241935">[</span><span class="op" id="4241936">:</span><span class="ident" id="4241937">strings</span><span class="op" id="4241944">.</span><span class="ident" id="4241945">LastIndex</span><span class="op" id="4241954">(</span><span class="ident" id="4241955">h</span><span class="op" id="4241956">,</span>&nbsp;<span class="string" id="4241958">&#34;:&#34;</span><span class="op" id="4241961">)</span><span class="op" id="4241962">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4241965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4241968">return</span>&nbsp;<span class="ident" id="4241975">h</span><br>
<span class="lineno">770</span><span class="op" id="4241977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4241980">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4242048">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4242119">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="4242129">type</span>&nbsp;<span class="ident" id="4242134">connectMethodKey</span>&nbsp;<span class="keyword" id="4242151">struct</span>&nbsp;<span class="op" id="4242158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242161">proxy</span><span class="op" id="4242166">,</span>&nbsp;<span class="ident" id="4242168">scheme</span><span class="op" id="4242174">,</span>&nbsp;<span class="ident" id="4242176">addr</span>&nbsp;<span class="builtintype" id="4242181">string</span><br>
<span class="lineno"></span><span class="op" id="4242188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4242191">func</span>&nbsp;<span class="op" id="4242196">(</span><span class="ident" id="4242197">k</span>&nbsp;<span class="ident" id="4242199">connectMethodKey</span><span class="op" id="4242215">)</span>&nbsp;<span class="ident" id="4242217">String</span><span class="op" id="4242223">(</span><span class="op" id="4242224">)</span>&nbsp;<span class="builtintype" id="4242226">string</span>&nbsp;<span class="op" id="4242233">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242236">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4242260">return</span>&nbsp;<span class="ident" id="4242267">fmt</span><span class="op" id="4242270">.</span><span class="ident" id="4242271">Sprintf</span><span class="op" id="4242278">(</span><span class="string" id="4242279">&#34;%s|%s|%s&#34;</span><span class="op" id="4242289">,</span>&nbsp;<span class="ident" id="4242291">k</span><span class="op" id="4242292">.</span><span class="ident" id="4242293">proxy</span><span class="op" id="4242298">,</span>&nbsp;<span class="ident" id="4242300">k</span><span class="op" id="4242301">.</span><span class="ident" id="4242302">scheme</span><span class="op" id="4242308">,</span>&nbsp;<span class="ident" id="4242310">k</span><span class="op" id="4242311">.</span><span class="ident" id="4242312">addr</span><span class="op" id="4242316">)</span><br>
<span class="lineno"></span><span class="op" id="4242318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4242321">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="4242381">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="4242438">type</span>&nbsp;<span class="ident" id="4242443">persistConn</span>&nbsp;<span class="keyword" id="4242455">struct</span>&nbsp;<span class="op" id="4242462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242465">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4242474">*</span><span class="ident" id="4242475">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242486">cacheKey</span>&nbsp;<span class="ident" id="4242495">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242513">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242522">net</span><span class="op" id="4242525">.</span><span class="ident" id="4242526">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242532">tlsState</span>&nbsp;<span class="op" id="4242541">*</span><span class="ident" id="4242542">tls</span><span class="op" id="4242545">.</span><span class="ident" id="4242546">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242563">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4242572">*</span><span class="ident" id="4242573">bufio</span><span class="op" id="4242578">.</span><span class="ident" id="4242579">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242592">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242606">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4242615">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242635">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242691">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4242700">*</span><span class="ident" id="4242701">bufio</span><span class="op" id="4242706">.</span><span class="ident" id="4242707">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242720">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242732">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4242741">chan</span>&nbsp;<span class="ident" id="4242746">requestAndChan</span>&nbsp;<span class="comment" id="4242761">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242804">writech</span>&nbsp;&nbsp;<span class="keyword" id="4242813">chan</span>&nbsp;<span class="ident" id="4242818">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4242833">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242877">closech</span>&nbsp;&nbsp;<span class="keyword" id="4242886">chan</span>&nbsp;<span class="keyword" id="4242891">struct</span><span class="op" id="4242897">{</span><span class="op" id="4242898">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242906">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4242934">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="4242943">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4242949">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243009">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243071">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243135">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243194">writeErrCh</span>&nbsp;<span class="keyword" id="4243205">chan</span>&nbsp;<span class="builtintype" id="4243210">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243218">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243239">sync</span><span class="op" id="4243243">.</span><span class="ident" id="4243244">Mutex</span>&nbsp;<span class="comment" id="4243250">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243278">numExpectedResponses</span>&nbsp;<span class="builtintype" id="4243299">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243304">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4243325">bool</span>&nbsp;<span class="comment" id="4243330">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243363">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4243384">bool</span>&nbsp;<span class="comment" id="4243389">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243469">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243526">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4243589">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243646">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="4243663">func</span><span class="op" id="4243667">(</span><span class="ident" id="4243668">Header</span><span class="op" id="4243674">)</span><br>
<span class="lineno"></span><span class="op" id="4243676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4243679">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="4243751">func</span>&nbsp;<span class="op" id="4243756">(</span><span class="ident" id="4243757">pc</span>&nbsp;<span class="op" id="4243760">*</span><span class="ident" id="4243761">persistConn</span><span class="op" id="4243772">)</span>&nbsp;<span class="ident" id="4243774">isBroken</span><span class="op" id="4243782">(</span><span class="op" id="4243783">)</span>&nbsp;<span class="builtintype" id="4243785">bool</span>&nbsp;<span class="op" id="4243790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243793">pc</span><span class="op" id="4243795">.</span><span class="ident" id="4243796">lk</span><span class="op" id="4243798">.</span><span class="ident" id="4243799">Lock</span><span class="op" id="4243803">(</span><span class="op" id="4243804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243807">b</span>&nbsp;<span class="op" id="4243809">:=</span>&nbsp;<span class="ident" id="4243812">pc</span><span class="op" id="4243814">.</span><span class="ident" id="4243815">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243823">pc</span><span class="op" id="4243825">.</span><span class="ident" id="4243826">lk</span><span class="op" id="4243828">.</span><span class="ident" id="4243829">Unlock</span><span class="op" id="4243835">(</span><span class="op" id="4243836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4243839">return</span>&nbsp;<span class="ident" id="4243846">b</span><br>
<span class="lineno">820</span><span class="op" id="4243848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4243851">func</span>&nbsp;<span class="op" id="4243856">(</span><span class="ident" id="4243857">pc</span>&nbsp;<span class="op" id="4243860">*</span><span class="ident" id="4243861">persistConn</span><span class="op" id="4243872">)</span>&nbsp;<span class="ident" id="4243874">cancelRequest</span><span class="op" id="4243887">(</span><span class="op" id="4243888">)</span>&nbsp;<span class="op" id="4243890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4243893">pc</span><span class="op" id="4243895">.</span><span class="ident" id="4243896">conn</span><span class="op" id="4243900">.</span><span class="ident" id="4243901">Close</span><span class="op" id="4243906">(</span><span class="op" id="4243907">)</span><br>
<span class="lineno"></span><span class="op" id="4243909">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="4243912">var</span>&nbsp;<span class="ident" id="4243916">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="4243937">func</span><span class="op" id="4243941">(</span><span class="builtintype" id="4243942">error</span><span class="op" id="4243947">)</span>&nbsp;<span class="builtintype" id="4243949">bool</span>&nbsp;<span class="comment" id="4243954">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4243980">func</span>&nbsp;<span class="ident" id="4243985">remoteSideClosed</span><span class="op" id="4244001">(</span><span class="ident" id="4244002">err</span>&nbsp;<span class="builtintype" id="4244006">error</span><span class="op" id="4244011">)</span>&nbsp;<span class="builtintype" id="4244013">bool</span>&nbsp;<span class="op" id="4244018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244021">if</span>&nbsp;<span class="ident" id="4244024">err</span>&nbsp;<span class="op" id="4244028">==</span>&nbsp;<span class="ident" id="4244031">io</span><span class="op" id="4244033">.</span><span class="ident" id="4244034">EOF</span>&nbsp;<span class="op" id="4244038">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244042">return</span>&nbsp;<span class="builtintype" id="4244049">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244058">if</span>&nbsp;<span class="ident" id="4244061">remoteSideClosedFunc</span>&nbsp;<span class="op" id="4244082">!=</span>&nbsp;<span class="builtintype" id="4244085">nil</span>&nbsp;<span class="op" id="4244089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244093">return</span>&nbsp;<span class="ident" id="4244100">remoteSideClosedFunc</span><span class="op" id="4244120">(</span><span class="ident" id="4244121">err</span><span class="op" id="4244124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244127">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244130">return</span>&nbsp;<span class="builtintype" id="4244137">false</span><br>
<span class="lineno"></span><span class="op" id="4244143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4244146">func</span>&nbsp;<span class="op" id="4244151">(</span><span class="ident" id="4244152">pc</span>&nbsp;<span class="op" id="4244155">*</span><span class="ident" id="4244156">persistConn</span><span class="op" id="4244167">)</span>&nbsp;<span class="ident" id="4244169">readLoop</span><span class="op" id="4244177">(</span><span class="op" id="4244178">)</span>&nbsp;<span class="op" id="4244180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244183">alive</span>&nbsp;<span class="op" id="4244189">:=</span>&nbsp;<span class="builtintype" id="4244192">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244199">for</span>&nbsp;<span class="ident" id="4244203">alive</span>&nbsp;<span class="op" id="4244209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244213">pb</span><span class="op" id="4244215">,</span>&nbsp;<span class="ident" id="4244217">err</span>&nbsp;<span class="op" id="4244221">:=</span>&nbsp;<span class="ident" id="4244224">pc</span><span class="op" id="4244226">.</span><span class="ident" id="4244227">br</span><span class="op" id="4244229">.</span><span class="ident" id="4244230">Peek</span><span class="op" id="4244234">(</span><span class="num" id="4244235">1</span><span class="op" id="4244236">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244241">pc</span><span class="op" id="4244243">.</span><span class="ident" id="4244244">lk</span><span class="op" id="4244246">.</span><span class="ident" id="4244247">Lock</span><span class="op" id="4244251">(</span><span class="op" id="4244252">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244256">if</span>&nbsp;<span class="ident" id="4244259">pc</span><span class="op" id="4244261">.</span><span class="ident" id="4244262">numExpectedResponses</span>&nbsp;<span class="op" id="4244283">==</span>&nbsp;<span class="num" id="4244286">0</span>&nbsp;<span class="op" id="4244288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244293">if</span>&nbsp;<span class="op" id="4244296">!</span><span class="ident" id="4244297">pc</span><span class="op" id="4244299">.</span><span class="ident" id="4244300">closed</span>&nbsp;<span class="op" id="4244307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244313">pc</span><span class="op" id="4244315">.</span><span class="ident" id="4244316">closeLocked</span><span class="op" id="4244327">(</span><span class="op" id="4244328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244334">if</span>&nbsp;<span class="builtinfunc" id="4244337">len</span><span class="op" id="4244340">(</span><span class="ident" id="4244341">pb</span><span class="op" id="4244343">)</span>&nbsp;<span class="op" id="4244345">&gt;</span>&nbsp;<span class="num" id="4244347">0</span>&nbsp;<span class="op" id="4244349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244356">log</span><span class="op" id="4244359">.</span><span class="ident" id="4244360">Printf</span><span class="op" id="4244366">(</span><span class="string" id="4244367">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="4244444">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4244452">string</span><span class="op" id="4244458">(</span><span class="ident" id="4244459">pb</span><span class="op" id="4244461">)</span><span class="op" id="4244462">,</span>&nbsp;<span class="ident" id="4244464">err</span><span class="op" id="4244467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244483">pc</span><span class="op" id="4244485">.</span><span class="ident" id="4244486">lk</span><span class="op" id="4244488">.</span><span class="ident" id="4244489">Unlock</span><span class="op" id="4244495">(</span><span class="op" id="4244496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244501">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244514">pc</span><span class="op" id="4244516">.</span><span class="ident" id="4244517">lk</span><span class="op" id="4244519">.</span><span class="ident" id="4244520">Unlock</span><span class="op" id="4244526">(</span><span class="op" id="4244527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244532">rc</span>&nbsp;<span class="op" id="4244535">:=</span>&nbsp;<span class="op" id="4244538">&lt;-</span><span class="ident" id="4244540">pc</span><span class="op" id="4244542">.</span><span class="ident" id="4244543">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244552">var</span>&nbsp;<span class="ident" id="4244556">resp</span>&nbsp;<span class="op" id="4244561">*</span><span class="ident" id="4244562">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244573">if</span>&nbsp;<span class="ident" id="4244576">err</span>&nbsp;<span class="op" id="4244580">==</span>&nbsp;<span class="builtintype" id="4244583">nil</span>&nbsp;<span class="op" id="4244587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244592">resp</span><span class="op" id="4244596">,</span>&nbsp;<span class="ident" id="4244598">err</span>&nbsp;<span class="op" id="4244602">=</span>&nbsp;<span class="ident" id="4244604">ReadResponse</span><span class="op" id="4244616">(</span><span class="ident" id="4244617">pc</span><span class="op" id="4244619">.</span><span class="ident" id="4244620">br</span><span class="op" id="4244622">,</span>&nbsp;<span class="ident" id="4244624">rc</span><span class="op" id="4244626">.</span><span class="ident" id="4244627">req</span><span class="op" id="4244630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4244635">if</span>&nbsp;<span class="ident" id="4244638">err</span>&nbsp;<span class="op" id="4244642">==</span>&nbsp;<span class="builtintype" id="4244645">nil</span>&nbsp;<span class="op" id="4244649">&amp;&amp;</span>&nbsp;<span class="ident" id="4244652">resp</span><span class="op" id="4244656">.</span><span class="ident" id="4244657">StatusCode</span>&nbsp;<span class="op" id="4244668">==</span>&nbsp;<span class="num" id="4244671">100</span>&nbsp;<span class="op" id="4244675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4244681">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4244719">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4244780">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4244840">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4244906">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4244954">resp</span><span class="op" id="4244958">,</span>&nbsp;<span class="ident" id="4244960">err</span>&nbsp;<span class="op" id="4244964">=</span>&nbsp;<span class="ident" id="4244966">ReadResponse</span><span class="op" id="4244978">(</span><span class="ident" id="4244979">pc</span><span class="op" id="4244981">.</span><span class="ident" id="4244982">br</span><span class="op" id="4244984">,</span>&nbsp;<span class="ident" id="4244986">rc</span><span class="op" id="4244988">.</span><span class="ident" id="4244989">req</span><span class="op" id="4244992">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4244997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245006">if</span>&nbsp;<span class="ident" id="4245009">resp</span>&nbsp;<span class="op" id="4245014">!=</span>&nbsp;<span class="builtintype" id="4245017">nil</span>&nbsp;<span class="op" id="4245021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245026">resp</span><span class="op" id="4245030">.</span><span class="ident" id="4245031">TLS</span>&nbsp;<span class="op" id="4245035">=</span>&nbsp;<span class="ident" id="4245037">pc</span><span class="op" id="4245039">.</span><span class="ident" id="4245040">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245056">hasBody</span>&nbsp;<span class="op" id="4245064">:=</span>&nbsp;<span class="ident" id="4245067">resp</span>&nbsp;<span class="op" id="4245072">!=</span>&nbsp;<span class="builtintype" id="4245075">nil</span>&nbsp;<span class="op" id="4245079">&amp;&amp;</span>&nbsp;<span class="ident" id="4245082">rc</span><span class="op" id="4245084">.</span><span class="ident" id="4245085">req</span><span class="op" id="4245088">.</span><span class="ident" id="4245089">Method</span>&nbsp;<span class="op" id="4245096">!=</span>&nbsp;<span class="string" id="4245099">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4245106">&amp;&amp;</span>&nbsp;<span class="ident" id="4245109">resp</span><span class="op" id="4245113">.</span><span class="ident" id="4245114">ContentLength</span>&nbsp;<span class="op" id="4245128">!=</span>&nbsp;<span class="num" id="4245131">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245136">if</span>&nbsp;<span class="ident" id="4245139">err</span>&nbsp;<span class="op" id="4245143">!=</span>&nbsp;<span class="builtintype" id="4245146">nil</span>&nbsp;<span class="op" id="4245150">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245155">pc</span><span class="op" id="4245157">.</span><span class="builtinfunc" id="4245158">close</span><span class="op" id="4245163">(</span><span class="op" id="4245164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245168">}</span>&nbsp;<span class="keyword" id="4245170">else</span>&nbsp;<span class="op" id="4245175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245180">if</span>&nbsp;<span class="ident" id="4245183">rc</span><span class="op" id="4245185">.</span><span class="ident" id="4245186">addedGzip</span>&nbsp;<span class="op" id="4245196">&amp;&amp;</span>&nbsp;<span class="ident" id="4245199">hasBody</span>&nbsp;<span class="op" id="4245207">&amp;&amp;</span>&nbsp;<span class="ident" id="4245210">resp</span><span class="op" id="4245214">.</span><span class="ident" id="4245215">Header</span><span class="op" id="4245221">.</span><span class="ident" id="4245222">Get</span><span class="op" id="4245225">(</span><span class="string" id="4245226">&#34;Content-Encoding&#34;</span><span class="op" id="4245244">)</span>&nbsp;<span class="op" id="4245246">==</span>&nbsp;<span class="string" id="4245249">&#34;gzip&#34;</span>&nbsp;<span class="op" id="4245256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245262">resp</span><span class="op" id="4245266">.</span><span class="ident" id="4245267">Header</span><span class="op" id="4245273">.</span><span class="ident" id="4245274">Del</span><span class="op" id="4245277">(</span><span class="string" id="4245278">&#34;Content-Encoding&#34;</span><span class="op" id="4245296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245302">resp</span><span class="op" id="4245306">.</span><span class="ident" id="4245307">Header</span><span class="op" id="4245313">.</span><span class="ident" id="4245314">Del</span><span class="op" id="4245317">(</span><span class="string" id="4245318">&#34;Content-Length&#34;</span><span class="op" id="4245334">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245340">resp</span><span class="op" id="4245344">.</span><span class="ident" id="4245345">ContentLength</span>&nbsp;<span class="op" id="4245359">=</span>&nbsp;<span class="op" id="4245361">-</span><span class="num" id="4245362">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245368">resp</span><span class="op" id="4245372">.</span><span class="ident" id="4245373">Body</span>&nbsp;<span class="op" id="4245378">=</span>&nbsp;<span class="op" id="4245380">&amp;</span><span class="ident" id="4245381">gzipReader</span><span class="op" id="4245391">{</span><span class="ident" id="4245392">body</span><span class="op" id="4245396">:</span>&nbsp;<span class="ident" id="4245398">resp</span><span class="op" id="4245402">.</span><span class="ident" id="4245403">Body</span><span class="op" id="4245407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245417">resp</span><span class="op" id="4245421">.</span><span class="ident" id="4245422">Body</span>&nbsp;<span class="op" id="4245427">=</span>&nbsp;<span class="op" id="4245429">&amp;</span><span class="ident" id="4245430">bodyEOFSignal</span><span class="op" id="4245443">{</span><span class="ident" id="4245444">body</span><span class="op" id="4245448">:</span>&nbsp;<span class="ident" id="4245450">resp</span><span class="op" id="4245454">.</span><span class="ident" id="4245455">Body</span><span class="op" id="4245459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245463">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245468">if</span>&nbsp;<span class="ident" id="4245471">err</span>&nbsp;<span class="op" id="4245475">!=</span>&nbsp;<span class="builtintype" id="4245478">nil</span>&nbsp;<span class="op" id="4245482">||</span>&nbsp;<span class="ident" id="4245485">resp</span><span class="op" id="4245489">.</span><span class="ident" id="4245490">Close</span>&nbsp;<span class="op" id="4245496">||</span>&nbsp;<span class="ident" id="4245499">rc</span><span class="op" id="4245501">.</span><span class="ident" id="4245502">req</span><span class="op" id="4245505">.</span><span class="ident" id="4245506">Close</span>&nbsp;<span class="op" id="4245512">||</span>&nbsp;<span class="ident" id="4245515">resp</span><span class="op" id="4245519">.</span><span class="ident" id="4245520">StatusCode</span>&nbsp;<span class="op" id="4245531">&lt;=</span>&nbsp;<span class="num" id="4245534">199</span>&nbsp;<span class="op" id="4245538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245543">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245612">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245672">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245719">alive</span>&nbsp;<span class="op" id="4245725">=</span>&nbsp;<span class="builtintype" id="4245727">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4245735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245740">var</span>&nbsp;<span class="ident" id="4245744">waitForBodyRead</span>&nbsp;<span class="keyword" id="4245760">chan</span>&nbsp;<span class="builtintype" id="4245765">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4245772">if</span>&nbsp;<span class="ident" id="4245775">hasBody</span>&nbsp;<span class="op" id="4245783">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245788">waitForBodyRead</span>&nbsp;<span class="op" id="4245804">=</span>&nbsp;<span class="builtinfunc" id="4245806">make</span><span class="op" id="4245810">(</span><span class="keyword" id="4245811">chan</span>&nbsp;<span class="builtintype" id="4245816">bool</span><span class="op" id="4245820">,</span>&nbsp;<span class="num" id="4245822">2</span><span class="op" id="4245823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245828">resp</span><span class="op" id="4245832">.</span><span class="ident" id="4245833">Body</span><span class="op" id="4245837">.</span><span class="op" id="4245838">(</span><span class="op" id="4245839">*</span><span class="ident" id="4245840">bodyEOFSignal</span><span class="op" id="4245853">)</span><span class="op" id="4245854">.</span><span class="ident" id="4245855">earlyCloseFn</span>&nbsp;<span class="op" id="4245868">=</span>&nbsp;<span class="keyword" id="4245870">func</span><span class="op" id="4245874">(</span><span class="op" id="4245875">)</span>&nbsp;<span class="builtintype" id="4245877">error</span>&nbsp;<span class="op" id="4245883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245889">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245929">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4245968">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245982">waitForBodyRead</span>&nbsp;<span class="op" id="4245998">&lt;-</span>&nbsp;<span class="builtintype" id="4246001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246011">return</span>&nbsp;<span class="builtintype" id="4246018">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246030">resp</span><span class="op" id="4246034">.</span><span class="ident" id="4246035">Body</span><span class="op" id="4246039">.</span><span class="op" id="4246040">(</span><span class="op" id="4246041">*</span><span class="ident" id="4246042">bodyEOFSignal</span><span class="op" id="4246055">)</span><span class="op" id="4246056">.</span><span class="ident" id="4246057">fn</span>&nbsp;<span class="op" id="4246060">=</span>&nbsp;<span class="keyword" id="4246062">func</span><span class="op" id="4246066">(</span><span class="ident" id="4246067">err</span>&nbsp;<span class="builtintype" id="4246071">error</span><span class="op" id="4246076">)</span>&nbsp;<span class="op" id="4246078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246084">waitForBodyRead</span>&nbsp;<span class="op" id="4246100">&lt;-</span>&nbsp;<span class="ident" id="4246103">alive</span>&nbsp;<span class="op" id="4246109">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246117">err</span>&nbsp;<span class="op" id="4246121">==</span>&nbsp;<span class="builtintype" id="4246124">nil</span>&nbsp;<span class="op" id="4246128">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246136">!</span><span class="ident" id="4246137">pc</span><span class="op" id="4246139">.</span><span class="ident" id="4246140">sawEOF</span>&nbsp;<span class="op" id="4246147">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246155">pc</span><span class="op" id="4246157">.</span><span class="ident" id="4246158">wroteRequest</span><span class="op" id="4246170">(</span><span class="op" id="4246171">)</span>&nbsp;<span class="op" id="4246173">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246181">pc</span><span class="op" id="4246183">.</span><span class="ident" id="4246184">t</span><span class="op" id="4246185">.</span><span class="ident" id="4246186">putIdleConn</span><span class="op" id="4246197">(</span><span class="ident" id="4246198">pc</span><span class="op" id="4246200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246205">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246214">if</span>&nbsp;<span class="ident" id="4246217">alive</span>&nbsp;<span class="op" id="4246223">&amp;&amp;</span>&nbsp;<span class="op" id="4246226">!</span><span class="ident" id="4246227">hasBody</span>&nbsp;<span class="op" id="4246235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246240">alive</span>&nbsp;<span class="op" id="4246246">=</span>&nbsp;<span class="op" id="4246248">!</span><span class="ident" id="4246249">pc</span><span class="op" id="4246251">.</span><span class="ident" id="4246252">sawEOF</span>&nbsp;<span class="op" id="4246259">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246266">pc</span><span class="op" id="4246268">.</span><span class="ident" id="4246269">wroteRequest</span><span class="op" id="4246281">(</span><span class="op" id="4246282">)</span>&nbsp;<span class="op" id="4246284">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246291">pc</span><span class="op" id="4246293">.</span><span class="ident" id="4246294">t</span><span class="op" id="4246295">.</span><span class="ident" id="4246296">putIdleConn</span><span class="op" id="4246307">(</span><span class="ident" id="4246308">pc</span><span class="op" id="4246310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246319">rc</span><span class="op" id="4246321">.</span><span class="ident" id="4246322">ch</span>&nbsp;<span class="op" id="4246325">&lt;-</span>&nbsp;<span class="ident" id="4246328">responseAndError</span><span class="op" id="4246344">{</span><span class="ident" id="4246345">resp</span><span class="op" id="4246349">,</span>&nbsp;<span class="ident" id="4246351">err</span><span class="op" id="4246354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4246359">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4246426">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246487">if</span>&nbsp;<span class="ident" id="4246490">waitForBodyRead</span>&nbsp;<span class="op" id="4246506">!=</span>&nbsp;<span class="builtintype" id="4246509">nil</span>&nbsp;<span class="op" id="4246513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246518">select</span>&nbsp;<span class="op" id="4246525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246530">case</span>&nbsp;<span class="ident" id="4246535">alive</span>&nbsp;<span class="op" id="4246541">=</span>&nbsp;<span class="op" id="4246543">&lt;-</span><span class="ident" id="4246545">waitForBodyRead</span><span class="op" id="4246560">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246565">case</span>&nbsp;<span class="op" id="4246570">&lt;-</span><span class="ident" id="4246572">pc</span><span class="op" id="4246574">.</span><span class="ident" id="4246575">closech</span><span class="op" id="4246582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246588">alive</span>&nbsp;<span class="op" id="4246594">=</span>&nbsp;<span class="builtintype" id="4246596">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246614">pc</span><span class="op" id="4246616">.</span><span class="ident" id="4246617">t</span><span class="op" id="4246618">.</span><span class="ident" id="4246619">setReqCanceler</span><span class="op" id="4246633">(</span><span class="ident" id="4246634">rc</span><span class="op" id="4246636">.</span><span class="ident" id="4246637">req</span><span class="op" id="4246640">,</span>&nbsp;<span class="builtintype" id="4246642">nil</span><span class="op" id="4246645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246650">if</span>&nbsp;<span class="op" id="4246653">!</span><span class="ident" id="4246654">alive</span>&nbsp;<span class="op" id="4246660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246665">pc</span><span class="op" id="4246667">.</span><span class="builtinfunc" id="4246668">close</span><span class="op" id="4246673">(</span><span class="op" id="4246674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246678">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246681">}</span><br>
<span class="lineno"></span><span class="op" id="4246683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4246686">func</span>&nbsp;<span class="op" id="4246691">(</span><span class="ident" id="4246692">pc</span>&nbsp;<span class="op" id="4246695">*</span><span class="ident" id="4246696">persistConn</span><span class="op" id="4246707">)</span>&nbsp;<span class="ident" id="4246709">writeLoop</span><span class="op" id="4246718">(</span><span class="op" id="4246719">)</span>&nbsp;<span class="op" id="4246721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246724">for</span>&nbsp;<span class="op" id="4246728">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246732">select</span>&nbsp;<span class="op" id="4246739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246743">case</span>&nbsp;<span class="ident" id="4246748">wr</span>&nbsp;<span class="op" id="4246751">:=</span>&nbsp;<span class="op" id="4246754">&lt;-</span><span class="ident" id="4246756">pc</span><span class="op" id="4246758">.</span><span class="ident" id="4246759">writech</span><span class="op" id="4246766">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246771">if</span>&nbsp;<span class="ident" id="4246774">pc</span><span class="op" id="4246776">.</span><span class="ident" id="4246777">isBroken</span><span class="op" id="4246785">(</span><span class="op" id="4246786">)</span>&nbsp;<span class="op" id="4246788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246794">wr</span><span class="op" id="4246796">.</span><span class="ident" id="4246797">ch</span>&nbsp;<span class="op" id="4246800">&lt;-</span>&nbsp;<span class="ident" id="4246803">errors</span><span class="op" id="4246809">.</span><span class="ident" id="4246810">New</span><span class="op" id="4246813">(</span><span class="string" id="4246814">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="4246867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246873">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246890">err</span>&nbsp;<span class="op" id="4246894">:=</span>&nbsp;<span class="ident" id="4246897">wr</span><span class="op" id="4246899">.</span><span class="ident" id="4246900">req</span><span class="op" id="4246903">.</span><span class="ident" id="4246904">Request</span><span class="op" id="4246911">.</span><span class="ident" id="4246912">write</span><span class="op" id="4246917">(</span><span class="ident" id="4246918">pc</span><span class="op" id="4246920">.</span><span class="ident" id="4246921">bw</span><span class="op" id="4246923">,</span>&nbsp;<span class="ident" id="4246925">pc</span><span class="op" id="4246927">.</span><span class="ident" id="4246928">isProxy</span><span class="op" id="4246935">,</span>&nbsp;<span class="ident" id="4246937">wr</span><span class="op" id="4246939">.</span><span class="ident" id="4246940">req</span><span class="op" id="4246943">.</span><span class="ident" id="4246944">extra</span><span class="op" id="4246949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4246954">if</span>&nbsp;<span class="ident" id="4246957">err</span>&nbsp;<span class="op" id="4246961">==</span>&nbsp;<span class="builtintype" id="4246964">nil</span>&nbsp;<span class="op" id="4246968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246974">err</span>&nbsp;<span class="op" id="4246978">=</span>&nbsp;<span class="ident" id="4246980">pc</span><span class="op" id="4246982">.</span><span class="ident" id="4246983">bw</span><span class="op" id="4246985">.</span><span class="ident" id="4246986">Flush</span><span class="op" id="4246991">(</span><span class="op" id="4246992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246997">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247002">if</span>&nbsp;<span class="ident" id="4247005">err</span>&nbsp;<span class="op" id="4247009">!=</span>&nbsp;<span class="builtintype" id="4247012">nil</span>&nbsp;<span class="op" id="4247016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4247022">pc</span><span class="op" id="4247024">.</span><span class="ident" id="4247025">markBroken</span><span class="op" id="4247035">(</span><span class="op" id="4247036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4247042">wr</span><span class="op" id="4247044">.</span><span class="ident" id="4247045">req</span><span class="op" id="4247048">.</span><span class="ident" id="4247049">Request</span><span class="op" id="4247056">.</span><span class="ident" id="4247057">closeBody</span><span class="op" id="4247066">(</span><span class="op" id="4247067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4247072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4247077">pc</span><span class="op" id="4247079">.</span><span class="ident" id="4247080">writeErrCh</span>&nbsp;<span class="op" id="4247091">&lt;-</span>&nbsp;<span class="ident" id="4247094">err</span>&nbsp;<span class="comment" id="4247098">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4247147">wr</span><span class="op" id="4247149">.</span><span class="ident" id="4247150">ch</span>&nbsp;<span class="op" id="4247153">&lt;-</span>&nbsp;<span class="ident" id="4247156">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247168">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247199">case</span>&nbsp;<span class="op" id="4247204">&lt;-</span><span class="ident" id="4247206">pc</span><span class="op" id="4247208">.</span><span class="ident" id="4247209">closech</span><span class="op" id="4247216">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247221">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4247230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4247233">}</span><br>
<span class="lineno">965</span><span class="op" id="4247235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4247238">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="4247319">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="4247374">func</span>&nbsp;<span class="op" id="4247379">(</span><span class="ident" id="4247380">pc</span>&nbsp;<span class="op" id="4247383">*</span><span class="ident" id="4247384">persistConn</span><span class="op" id="4247395">)</span>&nbsp;<span class="ident" id="4247397">wroteRequest</span><span class="op" id="4247409">(</span><span class="op" id="4247410">)</span>&nbsp;<span class="builtintype" id="4247412">bool</span>&nbsp;<span class="op" id="4247417">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247420">select</span>&nbsp;<span class="op" id="4247427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247430">case</span>&nbsp;<span class="ident" id="4247435">err</span>&nbsp;<span class="op" id="4247439">:=</span>&nbsp;<span class="op" id="4247442">&lt;-</span><span class="ident" id="4247444">pc</span><span class="op" id="4247446">.</span><span class="ident" id="4247447">writeErrCh</span><span class="op" id="4247457">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247461">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247527">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247556">return</span>&nbsp;<span class="ident" id="4247563">err</span>&nbsp;<span class="op" id="4247567">==</span>&nbsp;<span class="builtintype" id="4247570">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4247575">default</span><span class="op" id="4247582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247586">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247649">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247712">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247779">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247834">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247839">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247903">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4247968">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4248032">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4248096">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4248127">select</span>&nbsp;<span class="op" id="4248134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4248138">case</span>&nbsp;<span class="ident" id="4248143">err</span>&nbsp;<span class="op" id="4248147">:=</span>&nbsp;<span class="op" id="4248150">&lt;-</span><span class="ident" id="4248152">pc</span><span class="op" id="4248154">.</span><span class="ident" id="4248155">writeErrCh</span><span class="op" id="4248165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4248170">return</span>&nbsp;<span class="ident" id="4248177">err</span>&nbsp;<span class="op" id="4248181">==</span>&nbsp;<span class="builtintype" id="4248184">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4248190">case</span>&nbsp;<span class="op" id="4248195">&lt;-</span><span class="ident" id="4248197">time</span><span class="op" id="4248201">.</span><span class="ident" id="4248202">After</span><span class="op" id="4248207">(</span><span class="num" id="4248208">50</span>&nbsp;<span class="op" id="4248211">*</span>&nbsp;<span class="ident" id="4248213">time</span><span class="op" id="4248217">.</span><span class="ident" id="4248218">Millisecond</span><span class="op" id="4248229">)</span><span class="op" id="4248230">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4248235">return</span>&nbsp;<span class="builtintype" id="4248242">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4248250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4248253">}</span><br>
<span class="lineno"></span><span class="op" id="4248255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="4248258">type</span>&nbsp;<span class="ident" id="4248263">responseAndError</span>&nbsp;<span class="keyword" id="4248280">struct</span>&nbsp;<span class="op" id="4248287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248290">res</span>&nbsp;<span class="op" id="4248294">*</span><span class="ident" id="4248295">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248305">err</span>&nbsp;<span class="builtintype" id="4248309">error</span><br>
<span class="lineno"></span><span class="op" id="4248315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="4248318">type</span>&nbsp;<span class="ident" id="4248323">requestAndChan</span>&nbsp;<span class="keyword" id="4248338">struct</span>&nbsp;<span class="op" id="4248345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248348">req</span>&nbsp;<span class="op" id="4248352">*</span><span class="ident" id="4248353">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248362">ch</span>&nbsp;&nbsp;<span class="keyword" id="4248366">chan</span>&nbsp;<span class="ident" id="4248371">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4248390">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4248451">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4248508">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248546">addedGzip</span>&nbsp;<span class="builtintype" id="4248556">bool</span><br>
<span class="lineno"></span><span class="op" id="4248561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="4248564">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4248625">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="4248689">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4248755">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4248765">type</span>&nbsp;<span class="ident" id="4248770">writeRequest</span>&nbsp;<span class="keyword" id="4248783">struct</span>&nbsp;<span class="op" id="4248790">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248793">req</span>&nbsp;<span class="op" id="4248797">*</span><span class="ident" id="4248798">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248816">ch</span>&nbsp;&nbsp;<span class="keyword" id="4248820">chan</span><span class="op" id="4248824">&lt;-</span>&nbsp;<span class="builtintype" id="4248827">error</span><br>
<span class="lineno"></span><span class="op" id="4248833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4248836">type</span>&nbsp;<span class="ident" id="4248841">httpError</span>&nbsp;<span class="keyword" id="4248851">struct</span>&nbsp;<span class="op" id="4248858">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248861">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4248869">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4248877">timeout</span>&nbsp;<span class="builtintype" id="4248885">bool</span><br>
<span class="lineno"></span><span class="op" id="4248890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4248893">func</span>&nbsp;<span class="op" id="4248898">(</span><span class="ident" id="4248899">e</span>&nbsp;<span class="op" id="4248901">*</span><span class="ident" id="4248902">httpError</span><span class="op" id="4248911">)</span>&nbsp;<span class="ident" id="4248913">Error</span><span class="op" id="4248918">(</span><span class="op" id="4248919">)</span>&nbsp;<span class="builtintype" id="4248921">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4248930">{</span>&nbsp;<span class="keyword" id="4248932">return</span>&nbsp;<span class="ident" id="4248939">e</span><span class="op" id="4248940">.</span><span class="ident" id="4248941">err</span>&nbsp;<span class="op" id="4248945">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="4248947">func</span>&nbsp;<span class="op" id="4248952">(</span><span class="ident" id="4248953">e</span>&nbsp;<span class="op" id="4248955">*</span><span class="ident" id="4248956">httpError</span><span class="op" id="4248965">)</span>&nbsp;<span class="ident" id="4248967">Timeout</span><span class="op" id="4248974">(</span><span class="op" id="4248975">)</span>&nbsp;<span class="builtintype" id="4248977">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4248984">{</span>&nbsp;<span class="keyword" id="4248986">return</span>&nbsp;<span class="ident" id="4248993">e</span><span class="op" id="4248994">.</span><span class="ident" id="4248995">timeout</span>&nbsp;<span class="op" id="4249003">}</span><br>
<span class="lineno"></span><span class="keyword" id="4249005">func</span>&nbsp;<span class="op" id="4249010">(</span><span class="ident" id="4249011">e</span>&nbsp;<span class="op" id="4249013">*</span><span class="ident" id="4249014">httpError</span><span class="op" id="4249023">)</span>&nbsp;<span class="ident" id="4249025">Temporary</span><span class="op" id="4249034">(</span><span class="op" id="4249035">)</span>&nbsp;<span class="builtintype" id="4249037">bool</span>&nbsp;<span class="op" id="4249042">{</span>&nbsp;<span class="keyword" id="4249044">return</span>&nbsp;<span class="builtintype" id="4249051">true</span>&nbsp;<span class="op" id="4249056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4249059">var</span>&nbsp;<span class="ident" id="4249063">errTimeout</span>&nbsp;<span class="builtintype" id="4249074">error</span>&nbsp;<span class="op" id="4249080">=</span>&nbsp;<span class="op" id="4249082">&amp;</span><span class="ident" id="4249083">httpError</span><span class="op" id="4249092">{</span><span class="ident" id="4249093">err</span><span class="op" id="4249096">:</span>&nbsp;<span class="string" id="4249098">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="4249143">,</span>&nbsp;<span class="ident" id="4249145">timeout</span><span class="op" id="4249152">:</span>&nbsp;<span class="builtintype" id="4249154">true</span><span class="op" id="4249158">}</span><br>
<span class="lineno"></span><span class="keyword" id="4249160">var</span>&nbsp;<span class="ident" id="4249164">errClosed</span>&nbsp;<span class="builtintype" id="4249174">error</span>&nbsp;<span class="op" id="4249180">=</span>&nbsp;<span class="op" id="4249182">&amp;</span><span class="ident" id="4249183">httpError</span><span class="op" id="4249192">{</span><span class="ident" id="4249193">err</span><span class="op" id="4249196">:</span>&nbsp;<span class="string" id="4249198">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="4249255">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="4249258">func</span>&nbsp;<span class="op" id="4249263">(</span><span class="ident" id="4249264">pc</span>&nbsp;<span class="op" id="4249267">*</span><span class="ident" id="4249268">persistConn</span><span class="op" id="4249279">)</span>&nbsp;<span class="ident" id="4249281">roundTrip</span><span class="op" id="4249290">(</span><span class="ident" id="4249291">req</span>&nbsp;<span class="op" id="4249295">*</span><span class="ident" id="4249296">transportRequest</span><span class="op" id="4249312">)</span>&nbsp;<span class="op" id="4249314">(</span><span class="ident" id="4249315">resp</span>&nbsp;<span class="op" id="4249320">*</span><span class="ident" id="4249321">Response</span><span class="op" id="4249329">,</span>&nbsp;<span class="ident" id="4249331">err</span>&nbsp;<span class="builtintype" id="4249335">error</span><span class="op" id="4249340">)</span>&nbsp;<span class="op" id="4249342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249345">pc</span><span class="op" id="4249347">.</span><span class="ident" id="4249348">t</span><span class="op" id="4249349">.</span><span class="ident" id="4249350">setReqCanceler</span><span class="op" id="4249364">(</span><span class="ident" id="4249365">req</span><span class="op" id="4249368">.</span><span class="ident" id="4249369">Request</span><span class="op" id="4249376">,</span>&nbsp;<span class="ident" id="4249378">pc</span><span class="op" id="4249380">.</span><span class="ident" id="4249381">cancelRequest</span><span class="op" id="4249394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249397">pc</span><span class="op" id="4249399">.</span><span class="ident" id="4249400">lk</span><span class="op" id="4249402">.</span><span class="ident" id="4249403">Lock</span><span class="op" id="4249407">(</span><span class="op" id="4249408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249411">pc</span><span class="op" id="4249413">.</span><span class="ident" id="4249414">numExpectedResponses</span><span class="op" id="4249434">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249438">headerFn</span>&nbsp;<span class="op" id="4249447">:=</span>&nbsp;<span class="ident" id="4249450">pc</span><span class="op" id="4249452">.</span><span class="ident" id="4249453">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249471">pc</span><span class="op" id="4249473">.</span><span class="ident" id="4249474">lk</span><span class="op" id="4249476">.</span><span class="ident" id="4249477">Unlock</span><span class="op" id="4249483">(</span><span class="op" id="4249484">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4249488">if</span>&nbsp;<span class="ident" id="4249491">headerFn</span>&nbsp;<span class="op" id="4249500">!=</span>&nbsp;<span class="builtintype" id="4249503">nil</span>&nbsp;<span class="op" id="4249507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249511">headerFn</span><span class="op" id="4249519">(</span><span class="ident" id="4249520">req</span><span class="op" id="4249523">.</span><span class="ident" id="4249524">extraHeaders</span><span class="op" id="4249536">(</span><span class="op" id="4249537">)</span><span class="op" id="4249538">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4249541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249545">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249609">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249663">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249720">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249738">requestedGzip</span>&nbsp;<span class="op" id="4249752">:=</span>&nbsp;<span class="builtintype" id="4249755">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4249762">if</span>&nbsp;<span class="op" id="4249765">!</span><span class="ident" id="4249766">pc</span><span class="op" id="4249768">.</span><span class="ident" id="4249769">t</span><span class="op" id="4249770">.</span><span class="ident" id="4249771">DisableCompression</span>&nbsp;<span class="op" id="4249790">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249795">req</span><span class="op" id="4249798">.</span><span class="ident" id="4249799">Header</span><span class="op" id="4249805">.</span><span class="ident" id="4249806">Get</span><span class="op" id="4249809">(</span><span class="string" id="4249810">&#34;Accept-Encoding&#34;</span><span class="op" id="4249827">)</span>&nbsp;<span class="op" id="4249829">==</span>&nbsp;<span class="string" id="4249832">&#34;&#34;</span>&nbsp;<span class="op" id="4249835">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249840">req</span><span class="op" id="4249843">.</span><span class="ident" id="4249844">Header</span><span class="op" id="4249850">.</span><span class="ident" id="4249851">Get</span><span class="op" id="4249854">(</span><span class="string" id="4249855">&#34;Range&#34;</span><span class="op" id="4249862">)</span>&nbsp;<span class="op" id="4249864">==</span>&nbsp;<span class="string" id="4249867">&#34;&#34;</span>&nbsp;<span class="op" id="4249870">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4249875">req</span><span class="op" id="4249878">.</span><span class="ident" id="4249879">Method</span>&nbsp;<span class="op" id="4249886">!=</span>&nbsp;<span class="string" id="4249889">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4249896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249900">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4249962">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250004">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250059">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250064">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250120">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250148">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250194">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250230">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250235">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250299">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250365">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250411">requestedGzip</span>&nbsp;<span class="op" id="4250425">=</span>&nbsp;<span class="builtintype" id="4250427">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250434">req</span><span class="op" id="4250437">.</span><span class="ident" id="4250438">extraHeaders</span><span class="op" id="4250450">(</span><span class="op" id="4250451">)</span><span class="op" id="4250452">.</span><span class="ident" id="4250453">Set</span><span class="op" id="4250456">(</span><span class="string" id="4250457">&#34;Accept-Encoding&#34;</span><span class="op" id="4250474">,</span>&nbsp;<span class="string" id="4250476">&#34;gzip&#34;</span><span class="op" id="4250482">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4250485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250489">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250553">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4250617">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250635">writeErrCh</span>&nbsp;<span class="op" id="4250646">:=</span>&nbsp;<span class="builtinfunc" id="4250649">make</span><span class="op" id="4250653">(</span><span class="keyword" id="4250654">chan</span>&nbsp;<span class="builtintype" id="4250659">error</span><span class="op" id="4250664">,</span>&nbsp;<span class="num" id="4250666">1</span><span class="op" id="4250667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250670">pc</span><span class="op" id="4250672">.</span><span class="ident" id="4250673">writech</span>&nbsp;<span class="op" id="4250681">&lt;-</span>&nbsp;<span class="ident" id="4250684">writeRequest</span><span class="op" id="4250696">{</span><span class="ident" id="4250697">req</span><span class="op" id="4250700">,</span>&nbsp;<span class="ident" id="4250702">writeErrCh</span><span class="op" id="4250712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250716">resc</span>&nbsp;<span class="op" id="4250721">:=</span>&nbsp;<span class="builtinfunc" id="4250724">make</span><span class="op" id="4250728">(</span><span class="keyword" id="4250729">chan</span>&nbsp;<span class="ident" id="4250734">responseAndError</span><span class="op" id="4250750">,</span>&nbsp;<span class="num" id="4250752">1</span><span class="op" id="4250753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4250756">pc</span><span class="op" id="4250758">.</span><span class="ident" id="4250759">reqch</span>&nbsp;<span class="op" id="4250765">&lt;-</span>&nbsp;<span class="ident" id="4250768">requestAndChan</span><span class="op" id="4250782">{</span><span class="ident" id="4250783">req</span><span class="op" id="4250786">.</span><span class="ident" id="4250787">Request</span><span class="op" id="4250794">,</span>&nbsp;<span class="ident" id="4250796">resc</span><span class="op" id="4250800">,</span>&nbsp;<span class="ident" id="4250802">requestedGzip</span><span class="op" id="4250815">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250819">var</span>&nbsp;<span class="ident" id="4250823">re</span>&nbsp;<span class="ident" id="4250826">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250844">var</span>&nbsp;<span class="ident" id="4250848">pconnDeadCh</span>&nbsp;<span class="op" id="4250860">=</span>&nbsp;<span class="ident" id="4250862">pc</span><span class="op" id="4250864">.</span><span class="ident" id="4250865">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250874">var</span>&nbsp;<span class="ident" id="4250878">failTicker</span>&nbsp;<span class="op" id="4250889">&lt;-</span><span class="keyword" id="4250891">chan</span>&nbsp;<span class="ident" id="4250896">time</span><span class="op" id="4250900">.</span><span class="ident" id="4250901">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250907">var</span>&nbsp;<span class="ident" id="4250911">respHeaderTimer</span>&nbsp;<span class="op" id="4250927">&lt;-</span><span class="keyword" id="4250929">chan</span>&nbsp;<span class="ident" id="4250934">time</span><span class="op" id="4250938">.</span><span class="ident" id="4250939">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="4250944">WaitResponse</span><span class="op" id="4250956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250959">for</span>&nbsp;<span class="op" id="4250963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250967">select</span>&nbsp;<span class="op" id="4250974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4250978">case</span>&nbsp;<span class="ident" id="4250983">err</span>&nbsp;<span class="op" id="4250987">:=</span>&nbsp;<span class="op" id="4250990">&lt;-</span><span class="ident" id="4250992">writeErrCh</span><span class="op" id="4251002">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4251007">if</span>&nbsp;<span class="ident" id="4251010">err</span>&nbsp;<span class="op" id="4251014">!=</span>&nbsp;<span class="builtintype" id="4251017">nil</span>&nbsp;<span class="op" id="4251021">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251027">re</span>&nbsp;<span class="op" id="4251030">=</span>&nbsp;<span class="ident" id="4251032">responseAndError</span><span class="op" id="4251048">{</span><span class="builtintype" id="4251049">nil</span><span class="op" id="4251052">,</span>&nbsp;<span class="ident" id="4251054">err</span><span class="op" id="4251057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251063">pc</span><span class="op" id="4251065">.</span><span class="builtinfunc" id="4251066">close</span><span class="op" id="4251071">(</span><span class="op" id="4251072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4251078">break</span>&nbsp;<span class="ident" id="4251084">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4251105">if</span>&nbsp;<span class="ident" id="4251108">d</span>&nbsp;<span class="op" id="4251110">:=</span>&nbsp;<span class="ident" id="4251113">pc</span><span class="op" id="4251115">.</span><span class="ident" id="4251116">t</span><span class="op" id="4251117">.</span><span class="ident" id="4251118">ResponseHeaderTimeout</span><span class="op" id="4251139">;</span>&nbsp;<span class="ident" id="4251141">d</span>&nbsp;<span class="op" id="4251143">&gt;</span>&nbsp;<span class="num" id="4251145">0</span>&nbsp;<span class="op" id="4251147">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251153">respHeaderTimer</span>&nbsp;<span class="op" id="4251169">=</span>&nbsp;<span class="ident" id="4251171">time</span><span class="op" id="4251175">.</span><span class="ident" id="4251176">After</span><span class="op" id="4251181">(</span><span class="ident" id="4251182">d</span><span class="op" id="4251183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4251188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4251192">case</span>&nbsp;<span class="op" id="4251197">&lt;-</span><span class="ident" id="4251199">pconnDeadCh</span><span class="op" id="4251210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251215">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251268">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251328">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251385">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251439">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251498">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251556">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251613">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251647">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251653">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251718">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251774">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251817">pconnDeadCh</span>&nbsp;<span class="op" id="4251829">=</span>&nbsp;<span class="builtintype" id="4251831">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4251865">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251886">failTicker</span>&nbsp;<span class="op" id="4251897">=</span>&nbsp;<span class="ident" id="4251899">time</span><span class="op" id="4251903">.</span><span class="ident" id="4251904">After</span><span class="op" id="4251909">(</span><span class="num" id="4251910">100</span>&nbsp;<span class="op" id="4251914">*</span>&nbsp;<span class="ident" id="4251916">time</span><span class="op" id="4251920">.</span><span class="ident" id="4251921">Millisecond</span><span class="op" id="4251932">)</span>&nbsp;<span class="comment" id="4251934">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4251971">case</span>&nbsp;<span class="op" id="4251976">&lt;-</span><span class="ident" id="4251978">failTicker</span><span class="op" id="4251988">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4251993">re</span>&nbsp;<span class="op" id="4251996">=</span>&nbsp;<span class="ident" id="4251998">responseAndError</span><span class="op" id="4252014">{</span><span class="ident" id="4252015">err</span><span class="op" id="4252018">:</span>&nbsp;<span class="ident" id="4252020">errClosed</span><span class="op" id="4252029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252034">break</span>&nbsp;<span class="ident" id="4252040">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252055">case</span>&nbsp;<span class="op" id="4252060">&lt;-</span><span class="ident" id="4252062">respHeaderTimer</span><span class="op" id="4252077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252082">pc</span><span class="op" id="4252084">.</span><span class="builtinfunc" id="4252085">close</span><span class="op" id="4252090">(</span><span class="op" id="4252091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252096">re</span>&nbsp;<span class="op" id="4252099">=</span>&nbsp;<span class="ident" id="4252101">responseAndError</span><span class="op" id="4252117">{</span><span class="ident" id="4252118">err</span><span class="op" id="4252121">:</span>&nbsp;<span class="ident" id="4252123">errTimeout</span><span class="op" id="4252133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252138">break</span>&nbsp;<span class="ident" id="4252144">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252159">case</span>&nbsp;<span class="ident" id="4252164">re</span>&nbsp;<span class="op" id="4252167">=</span>&nbsp;<span class="op" id="4252169">&lt;-</span><span class="ident" id="4252171">resc</span><span class="op" id="4252175">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252180">break</span>&nbsp;<span class="ident" id="4252186">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252208">pc</span><span class="op" id="4252210">.</span><span class="ident" id="4252211">lk</span><span class="op" id="4252213">.</span><span class="ident" id="4252214">Lock</span><span class="op" id="4252218">(</span><span class="op" id="4252219">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252222">pc</span><span class="op" id="4252224">.</span><span class="ident" id="4252225">numExpectedResponses</span><span class="op" id="4252245">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252249">pc</span><span class="op" id="4252251">.</span><span class="ident" id="4252252">lk</span><span class="op" id="4252254">.</span><span class="ident" id="4252255">Unlock</span><span class="op" id="4252261">(</span><span class="op" id="4252262">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252266">if</span>&nbsp;<span class="ident" id="4252269">re</span><span class="op" id="4252271">.</span><span class="ident" id="4252272">err</span>&nbsp;<span class="op" id="4252276">!=</span>&nbsp;<span class="builtintype" id="4252279">nil</span>&nbsp;<span class="op" id="4252283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252287">pc</span><span class="op" id="4252289">.</span><span class="ident" id="4252290">t</span><span class="op" id="4252291">.</span><span class="ident" id="4252292">setReqCanceler</span><span class="op" id="4252306">(</span><span class="ident" id="4252307">req</span><span class="op" id="4252310">.</span><span class="ident" id="4252311">Request</span><span class="op" id="4252318">,</span>&nbsp;<span class="builtintype" id="4252320">nil</span><span class="op" id="4252323">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252329">return</span>&nbsp;<span class="ident" id="4252336">re</span><span class="op" id="4252338">.</span><span class="ident" id="4252339">res</span><span class="op" id="4252342">,</span>&nbsp;<span class="ident" id="4252344">re</span><span class="op" id="4252346">.</span><span class="ident" id="4252347">err</span><br>
<span class="lineno"></span><span class="op" id="4252351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4252354">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="4252419">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4252484">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4252534">func</span>&nbsp;<span class="op" id="4252539">(</span><span class="ident" id="4252540">pc</span>&nbsp;<span class="op" id="4252543">*</span><span class="ident" id="4252544">persistConn</span><span class="op" id="4252555">)</span>&nbsp;<span class="ident" id="4252557">markBroken</span><span class="op" id="4252567">(</span><span class="op" id="4252568">)</span>&nbsp;<span class="op" id="4252570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252573">pc</span><span class="op" id="4252575">.</span><span class="ident" id="4252576">lk</span><span class="op" id="4252578">.</span><span class="ident" id="4252579">Lock</span><span class="op" id="4252583">(</span><span class="op" id="4252584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252587">defer</span>&nbsp;<span class="ident" id="4252593">pc</span><span class="op" id="4252595">.</span><span class="ident" id="4252596">lk</span><span class="op" id="4252598">.</span><span class="ident" id="4252599">Unlock</span><span class="op" id="4252605">(</span><span class="op" id="4252606">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252609">pc</span><span class="op" id="4252611">.</span><span class="ident" id="4252612">broken</span>&nbsp;<span class="op" id="4252619">=</span>&nbsp;<span class="builtintype" id="4252621">true</span><br>
<span class="lineno"></span><span class="op" id="4252626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4252629">func</span>&nbsp;<span class="op" id="4252634">(</span><span class="ident" id="4252635">pc</span>&nbsp;<span class="op" id="4252638">*</span><span class="ident" id="4252639">persistConn</span><span class="op" id="4252650">)</span>&nbsp;<span class="builtinfunc" id="4252652">close</span><span class="op" id="4252657">(</span><span class="op" id="4252658">)</span>&nbsp;<span class="op" id="4252660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252663">pc</span><span class="op" id="4252665">.</span><span class="ident" id="4252666">lk</span><span class="op" id="4252668">.</span><span class="ident" id="4252669">Lock</span><span class="op" id="4252673">(</span><span class="op" id="4252674">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252677">defer</span>&nbsp;<span class="ident" id="4252683">pc</span><span class="op" id="4252685">.</span><span class="ident" id="4252686">lk</span><span class="op" id="4252688">.</span><span class="ident" id="4252689">Unlock</span><span class="op" id="4252695">(</span><span class="op" id="4252696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252699">pc</span><span class="op" id="4252701">.</span><span class="ident" id="4252702">closeLocked</span><span class="op" id="4252713">(</span><span class="op" id="4252714">)</span><br>
<span class="lineno"></span><span class="op" id="4252716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4252719">func</span>&nbsp;<span class="op" id="4252724">(</span><span class="ident" id="4252725">pc</span>&nbsp;<span class="op" id="4252728">*</span><span class="ident" id="4252729">persistConn</span><span class="op" id="4252740">)</span>&nbsp;<span class="ident" id="4252742">closeLocked</span><span class="op" id="4252753">(</span><span class="op" id="4252754">)</span>&nbsp;<span class="op" id="4252756">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252759">pc</span><span class="op" id="4252761">.</span><span class="ident" id="4252762">broken</span>&nbsp;<span class="op" id="4252769">=</span>&nbsp;<span class="builtintype" id="4252771">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4252777">if</span>&nbsp;<span class="op" id="4252780">!</span><span class="ident" id="4252781">pc</span><span class="op" id="4252783">.</span><span class="ident" id="4252784">closed</span>&nbsp;<span class="op" id="4252791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252795">pc</span><span class="op" id="4252797">.</span><span class="ident" id="4252798">conn</span><span class="op" id="4252802">.</span><span class="ident" id="4252803">Close</span><span class="op" id="4252808">(</span><span class="op" id="4252809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252813">pc</span><span class="op" id="4252815">.</span><span class="ident" id="4252816">closed</span>&nbsp;<span class="op" id="4252823">=</span>&nbsp;<span class="builtintype" id="4252825">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4252832">close</span><span class="op" id="4252837">(</span><span class="ident" id="4252838">pc</span><span class="op" id="4252840">.</span><span class="ident" id="4252841">closech</span><span class="op" id="4252848">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4252851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4252854">pc</span><span class="op" id="4252856">.</span><span class="ident" id="4252857">mutateHeaderFunc</span>&nbsp;<span class="op" id="4252874">=</span>&nbsp;<span class="builtintype" id="4252876">nil</span><br>
<span class="lineno"></span><span class="op" id="4252880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4252883">var</span>&nbsp;<span class="ident" id="4252887">portMap</span>&nbsp;<span class="op" id="4252895">=</span>&nbsp;<span class="keyword" id="4252897">map</span><span class="op" id="4252900">[</span><span class="builtintype" id="4252901">string</span><span class="op" id="4252907">]</span><span class="builtintype" id="4252908">string</span><span class="op" id="4252914">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4252917">&#34;http&#34;</span><span class="op" id="4252923">:</span>&nbsp;&nbsp;<span class="string" id="4252926">&#34;80&#34;</span><span class="op" id="4252930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4252933">&#34;https&#34;</span><span class="op" id="4252940">:</span>&nbsp;<span class="string" id="4252942">&#34;443&#34;</span><span class="op" id="4252947">,</span><br>
<span class="lineno"></span><span class="op" id="4252949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4252952">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="4253019">func</span>&nbsp;<span class="ident" id="4253024">canonicalAddr</span><span class="op" id="4253037">(</span><span class="ident" id="4253038">url</span>&nbsp;<span class="op" id="4253042">*</span><span class="ident" id="4253043">url</span><span class="op" id="4253046">.</span><span class="ident" id="4253047">URL</span><span class="op" id="4253050">)</span>&nbsp;<span class="builtintype" id="4253052">string</span>&nbsp;<span class="op" id="4253059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253062">addr</span>&nbsp;<span class="op" id="4253067">:=</span>&nbsp;<span class="ident" id="4253070">url</span><span class="op" id="4253073">.</span><span class="ident" id="4253074">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253080">if</span>&nbsp;<span class="op" id="4253083">!</span><span class="ident" id="4253084">hasPort</span><span class="op" id="4253091">(</span><span class="ident" id="4253092">addr</span><span class="op" id="4253096">)</span>&nbsp;<span class="op" id="4253098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253102">return</span>&nbsp;<span class="ident" id="4253109">addr</span>&nbsp;<span class="op" id="4253114">+</span>&nbsp;<span class="string" id="4253116">&#34;:&#34;</span>&nbsp;<span class="op" id="4253120">+</span>&nbsp;<span class="ident" id="4253122">portMap</span><span class="op" id="4253129">[</span><span class="ident" id="4253130">url</span><span class="op" id="4253133">.</span><span class="ident" id="4253134">Scheme</span><span class="op" id="4253140">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4253143">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253146">return</span>&nbsp;<span class="ident" id="4253153">addr</span><br>
<span class="lineno"></span><span class="op" id="4253158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4253161">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="4253230">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="4253299">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="4253365">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="4253430">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="4253478">type</span>&nbsp;<span class="ident" id="4253483">bodyEOFSignal</span>&nbsp;<span class="keyword" id="4253497">struct</span>&nbsp;<span class="op" id="4253504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253507">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253520">io</span><span class="op" id="4253522">.</span><span class="ident" id="4253523">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253535">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253548">sync</span><span class="op" id="4253552">.</span><span class="ident" id="4253553">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4253561">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253591">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4253604">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4253617">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253651">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4253664">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4253677">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253699">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253712">func</span><span class="op" id="4253716">(</span><span class="builtintype" id="4253717">error</span><span class="op" id="4253722">)</span>&nbsp;&nbsp;<span class="comment" id="4253725">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253762">earlyCloseFn</span>&nbsp;<span class="keyword" id="4253775">func</span><span class="op" id="4253779">(</span><span class="op" id="4253780">)</span>&nbsp;<span class="builtintype" id="4253782">error</span>&nbsp;<span class="comment" id="4253788">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="4253839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4253842">func</span>&nbsp;<span class="op" id="4253847">(</span><span class="ident" id="4253848">es</span>&nbsp;<span class="op" id="4253851">*</span><span class="ident" id="4253852">bodyEOFSignal</span><span class="op" id="4253865">)</span>&nbsp;<span class="ident" id="4253867">Read</span><span class="op" id="4253871">(</span><span class="ident" id="4253872">p</span>&nbsp;<span class="op" id="4253874">[</span><span class="op" id="4253875">]</span><span class="builtintype" id="4253876">byte</span><span class="op" id="4253880">)</span>&nbsp;<span class="op" id="4253882">(</span><span class="ident" id="4253883">n</span>&nbsp;<span class="builtintype" id="4253885">int</span><span class="op" id="4253888">,</span>&nbsp;<span class="ident" id="4253890">err</span>&nbsp;<span class="builtintype" id="4253894">error</span><span class="op" id="4253899">)</span>&nbsp;<span class="op" id="4253901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253904">es</span><span class="op" id="4253906">.</span><span class="ident" id="4253907">mu</span><span class="op" id="4253909">.</span><span class="ident" id="4253910">Lock</span><span class="op" id="4253914">(</span><span class="op" id="4253915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253918">closed</span><span class="op" id="4253924">,</span>&nbsp;<span class="ident" id="4253926">rerr</span>&nbsp;<span class="op" id="4253931">:=</span>&nbsp;<span class="ident" id="4253934">es</span><span class="op" id="4253936">.</span><span class="ident" id="4253937">closed</span><span class="op" id="4253943">,</span>&nbsp;<span class="ident" id="4253945">es</span><span class="op" id="4253947">.</span><span class="ident" id="4253948">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4253954">es</span><span class="op" id="4253956">.</span><span class="ident" id="4253957">mu</span><span class="op" id="4253959">.</span><span class="ident" id="4253960">Unlock</span><span class="op" id="4253966">(</span><span class="op" id="4253967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253970">if</span>&nbsp;<span class="ident" id="4253973">closed</span>&nbsp;<span class="op" id="4253980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4253984">return</span>&nbsp;<span class="num" id="4253991">0</span><span class="op" id="4253992">,</span>&nbsp;<span class="ident" id="4253994">errors</span><span class="op" id="4254000">.</span><span class="ident" id="4254001">New</span><span class="op" id="4254004">(</span><span class="string" id="4254005">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="4254041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254047">if</span>&nbsp;<span class="ident" id="4254050">rerr</span>&nbsp;<span class="op" id="4254055">!=</span>&nbsp;<span class="builtintype" id="4254058">nil</span>&nbsp;<span class="op" id="4254062">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254066">return</span>&nbsp;<span class="num" id="4254073">0</span><span class="op" id="4254074">,</span>&nbsp;<span class="ident" id="4254076">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254086">n</span><span class="op" id="4254087">,</span>&nbsp;<span class="ident" id="4254089">err</span>&nbsp;<span class="op" id="4254093">=</span>&nbsp;<span class="ident" id="4254095">es</span><span class="op" id="4254097">.</span><span class="ident" id="4254098">body</span><span class="op" id="4254102">.</span><span class="ident" id="4254103">Read</span><span class="op" id="4254107">(</span><span class="ident" id="4254108">p</span><span class="op" id="4254109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254112">if</span>&nbsp;<span class="ident" id="4254115">err</span>&nbsp;<span class="op" id="4254119">!=</span>&nbsp;<span class="builtintype" id="4254122">nil</span>&nbsp;<span class="op" id="4254126">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254130">es</span><span class="op" id="4254132">.</span><span class="ident" id="4254133">mu</span><span class="op" id="4254135">.</span><span class="ident" id="4254136">Lock</span><span class="op" id="4254140">(</span><span class="op" id="4254141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254145">defer</span>&nbsp;<span class="ident" id="4254151">es</span><span class="op" id="4254153">.</span><span class="ident" id="4254154">mu</span><span class="op" id="4254156">.</span><span class="ident" id="4254157">Unlock</span><span class="op" id="4254163">(</span><span class="op" id="4254164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254168">if</span>&nbsp;<span class="ident" id="4254171">es</span><span class="op" id="4254173">.</span><span class="ident" id="4254174">rerr</span>&nbsp;<span class="op" id="4254179">==</span>&nbsp;<span class="builtintype" id="4254182">nil</span>&nbsp;<span class="op" id="4254186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254191">es</span><span class="op" id="4254193">.</span><span class="ident" id="4254194">rerr</span>&nbsp;<span class="op" id="4254199">=</span>&nbsp;<span class="ident" id="4254201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254207">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254211">es</span><span class="op" id="4254213">.</span><span class="ident" id="4254214">condfn</span><span class="op" id="4254220">(</span><span class="ident" id="4254221">err</span><span class="op" id="4254224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254230">return</span><br>
<span class="lineno"></span><span class="op" id="4254237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="4254240">func</span>&nbsp;<span class="op" id="4254245">(</span><span class="ident" id="4254246">es</span>&nbsp;<span class="op" id="4254249">*</span><span class="ident" id="4254250">bodyEOFSignal</span><span class="op" id="4254263">)</span>&nbsp;<span class="ident" id="4254265">Close</span><span class="op" id="4254270">(</span><span class="op" id="4254271">)</span>&nbsp;<span class="builtintype" id="4254273">error</span>&nbsp;<span class="op" id="4254279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254282">es</span><span class="op" id="4254284">.</span><span class="ident" id="4254285">mu</span><span class="op" id="4254287">.</span><span class="ident" id="4254288">Lock</span><span class="op" id="4254292">(</span><span class="op" id="4254293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254296">defer</span>&nbsp;<span class="ident" id="4254302">es</span><span class="op" id="4254304">.</span><span class="ident" id="4254305">mu</span><span class="op" id="4254307">.</span><span class="ident" id="4254308">Unlock</span><span class="op" id="4254314">(</span><span class="op" id="4254315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254318">if</span>&nbsp;<span class="ident" id="4254321">es</span><span class="op" id="4254323">.</span><span class="ident" id="4254324">closed</span>&nbsp;<span class="op" id="4254331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254335">return</span>&nbsp;<span class="builtintype" id="4254342">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254350">es</span><span class="op" id="4254352">.</span><span class="ident" id="4254353">closed</span>&nbsp;<span class="op" id="4254360">=</span>&nbsp;<span class="builtintype" id="4254362">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254368">if</span>&nbsp;<span class="ident" id="4254371">es</span><span class="op" id="4254373">.</span><span class="ident" id="4254374">earlyCloseFn</span>&nbsp;<span class="op" id="4254387">!=</span>&nbsp;<span class="builtintype" id="4254390">nil</span>&nbsp;<span class="op" id="4254394">&amp;&amp;</span>&nbsp;<span class="ident" id="4254397">es</span><span class="op" id="4254399">.</span><span class="ident" id="4254400">rerr</span>&nbsp;<span class="op" id="4254405">!=</span>&nbsp;<span class="ident" id="4254408">io</span><span class="op" id="4254410">.</span><span class="ident" id="4254411">EOF</span>&nbsp;<span class="op" id="4254415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254419">return</span>&nbsp;<span class="ident" id="4254426">es</span><span class="op" id="4254428">.</span><span class="ident" id="4254429">earlyCloseFn</span><span class="op" id="4254441">(</span><span class="op" id="4254442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254445">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254448">err</span>&nbsp;<span class="op" id="4254452">:=</span>&nbsp;<span class="ident" id="4254455">es</span><span class="op" id="4254457">.</span><span class="ident" id="4254458">body</span><span class="op" id="4254462">.</span><span class="ident" id="4254463">Close</span><span class="op" id="4254468">(</span><span class="op" id="4254469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254472">es</span><span class="op" id="4254474">.</span><span class="ident" id="4254475">condfn</span><span class="op" id="4254481">(</span><span class="ident" id="4254482">err</span><span class="op" id="4254485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254488">return</span>&nbsp;<span class="ident" id="4254495">err</span><br>
<span class="lineno"></span><span class="op" id="4254499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="4254502">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4254529">func</span>&nbsp;<span class="op" id="4254534">(</span><span class="ident" id="4254535">es</span>&nbsp;<span class="op" id="4254538">*</span><span class="ident" id="4254539">bodyEOFSignal</span><span class="op" id="4254552">)</span>&nbsp;<span class="ident" id="4254554">condfn</span><span class="op" id="4254560">(</span><span class="ident" id="4254561">err</span>&nbsp;<span class="builtintype" id="4254565">error</span><span class="op" id="4254570">)</span>&nbsp;<span class="op" id="4254572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254575">if</span>&nbsp;<span class="ident" id="4254578">es</span><span class="op" id="4254580">.</span><span class="ident" id="4254581">fn</span>&nbsp;<span class="op" id="4254584">==</span>&nbsp;<span class="builtintype" id="4254587">nil</span>&nbsp;<span class="op" id="4254591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254595">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254603">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254606">if</span>&nbsp;<span class="ident" id="4254609">err</span>&nbsp;<span class="op" id="4254613">==</span>&nbsp;<span class="ident" id="4254616">io</span><span class="op" id="4254618">.</span><span class="ident" id="4254619">EOF</span>&nbsp;<span class="op" id="4254623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254627">err</span>&nbsp;<span class="op" id="4254631">=</span>&nbsp;<span class="builtintype" id="4254633">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4254638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254641">es</span><span class="op" id="4254643">.</span><span class="ident" id="4254644">fn</span><span class="op" id="4254646">(</span><span class="ident" id="4254647">err</span><span class="op" id="4254650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254653">es</span><span class="op" id="4254655">.</span><span class="ident" id="4254656">fn</span>&nbsp;<span class="op" id="4254659">=</span>&nbsp;<span class="builtintype" id="4254661">nil</span><br>
<span class="lineno">1230</span><span class="op" id="4254665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4254668">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="4254721">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="4254770">type</span>&nbsp;<span class="ident" id="4254775">gzipReader</span>&nbsp;<span class="keyword" id="4254786">struct</span>&nbsp;<span class="op" id="4254793">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254796">body</span>&nbsp;<span class="ident" id="4254801">io</span><span class="op" id="4254803">.</span><span class="ident" id="4254804">ReadCloser</span>&nbsp;<span class="comment" id="4254815">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254844">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4254849">io</span><span class="op" id="4254851">.</span><span class="ident" id="4254852">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4254863">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="4254897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4254900">func</span>&nbsp;<span class="op" id="4254905">(</span><span class="ident" id="4254906">gz</span>&nbsp;<span class="op" id="4254909">*</span><span class="ident" id="4254910">gzipReader</span><span class="op" id="4254920">)</span>&nbsp;<span class="ident" id="4254922">Read</span><span class="op" id="4254926">(</span><span class="ident" id="4254927">p</span>&nbsp;<span class="op" id="4254929">[</span><span class="op" id="4254930">]</span><span class="builtintype" id="4254931">byte</span><span class="op" id="4254935">)</span>&nbsp;<span class="op" id="4254937">(</span><span class="ident" id="4254938">n</span>&nbsp;<span class="builtintype" id="4254940">int</span><span class="op" id="4254943">,</span>&nbsp;<span class="ident" id="4254945">err</span>&nbsp;<span class="builtintype" id="4254949">error</span><span class="op" id="4254954">)</span>&nbsp;<span class="op" id="4254956">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4254959">if</span>&nbsp;<span class="ident" id="4254962">gz</span><span class="op" id="4254964">.</span><span class="ident" id="4254965">zr</span>&nbsp;<span class="op" id="4254968">==</span>&nbsp;<span class="builtintype" id="4254971">nil</span>&nbsp;<span class="op" id="4254975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4254979">gz</span><span class="op" id="4254981">.</span><span class="ident" id="4254982">zr</span><span class="op" id="4254984">,</span>&nbsp;<span class="ident" id="4254986">err</span>&nbsp;<span class="op" id="4254990">=</span>&nbsp;<span class="ident" id="4254992">gzip</span><span class="op" id="4254996">.</span><span class="ident" id="4254997">NewReader</span><span class="op" id="4255006">(</span><span class="ident" id="4255007">gz</span><span class="op" id="4255009">.</span><span class="ident" id="4255010">body</span><span class="op" id="4255014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255018">if</span>&nbsp;<span class="ident" id="4255021">err</span>&nbsp;<span class="op" id="4255025">!=</span>&nbsp;<span class="builtintype" id="4255028">nil</span>&nbsp;<span class="op" id="4255032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255037">return</span>&nbsp;<span class="num" id="4255044">0</span><span class="op" id="4255045">,</span>&nbsp;<span class="ident" id="4255047">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4255053">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4255056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255059">return</span>&nbsp;<span class="ident" id="4255066">gz</span><span class="op" id="4255068">.</span><span class="ident" id="4255069">zr</span><span class="op" id="4255071">.</span><span class="ident" id="4255072">Read</span><span class="op" id="4255076">(</span><span class="ident" id="4255077">p</span><span class="op" id="4255078">)</span><br>
<span class="lineno"></span><span class="op" id="4255080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255083">func</span>&nbsp;<span class="op" id="4255088">(</span><span class="ident" id="4255089">gz</span>&nbsp;<span class="op" id="4255092">*</span><span class="ident" id="4255093">gzipReader</span><span class="op" id="4255103">)</span>&nbsp;<span class="ident" id="4255105">Close</span><span class="op" id="4255110">(</span><span class="op" id="4255111">)</span>&nbsp;<span class="builtintype" id="4255113">error</span>&nbsp;<span class="op" id="4255119">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255122">return</span>&nbsp;<span class="ident" id="4255129">gz</span><span class="op" id="4255131">.</span><span class="ident" id="4255132">body</span><span class="op" id="4255136">.</span><span class="ident" id="4255137">Close</span><span class="op" id="4255142">(</span><span class="op" id="4255143">)</span><br>
<span class="lineno"></span><span class="op" id="4255145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255148">type</span>&nbsp;<span class="ident" id="4255153">readerAndCloser</span>&nbsp;<span class="keyword" id="4255169">struct</span>&nbsp;<span class="op" id="4255176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255179">io</span><span class="op" id="4255181">.</span><span class="ident" id="4255182">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255190">io</span><span class="op" id="4255192">.</span><span class="ident" id="4255193">Closer</span><br>
<span class="lineno"></span><span class="op" id="4255200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255203">type</span>&nbsp;<span class="ident" id="4255208">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="4255233">struct</span><span class="op" id="4255239">{</span><span class="op" id="4255240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="4255243">func</span>&nbsp;<span class="op" id="4255248">(</span><span class="ident" id="4255249">tlsHandshakeTimeoutError</span><span class="op" id="4255273">)</span>&nbsp;<span class="ident" id="4255275">Timeout</span><span class="op" id="4255282">(</span><span class="op" id="4255283">)</span>&nbsp;<span class="builtintype" id="4255285">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4255292">{</span>&nbsp;<span class="keyword" id="4255294">return</span>&nbsp;<span class="builtintype" id="4255301">true</span>&nbsp;<span class="op" id="4255306">}</span><br>
<span class="lineno"></span><span class="keyword" id="4255308">func</span>&nbsp;<span class="op" id="4255313">(</span><span class="ident" id="4255314">tlsHandshakeTimeoutError</span><span class="op" id="4255338">)</span>&nbsp;<span class="ident" id="4255340">Temporary</span><span class="op" id="4255349">(</span><span class="op" id="4255350">)</span>&nbsp;<span class="builtintype" id="4255352">bool</span>&nbsp;<span class="op" id="4255357">{</span>&nbsp;<span class="keyword" id="4255359">return</span>&nbsp;<span class="builtintype" id="4255366">true</span>&nbsp;<span class="op" id="4255371">}</span><br>
<span class="lineno"></span><span class="keyword" id="4255373">func</span>&nbsp;<span class="op" id="4255378">(</span><span class="ident" id="4255379">tlsHandshakeTimeoutError</span><span class="op" id="4255403">)</span>&nbsp;<span class="ident" id="4255405">Error</span><span class="op" id="4255410">(</span><span class="op" id="4255411">)</span>&nbsp;<span class="builtintype" id="4255413">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4255422">{</span>&nbsp;<span class="keyword" id="4255424">return</span>&nbsp;<span class="string" id="4255431">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="4255465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255468">type</span>&nbsp;<span class="ident" id="4255473">noteEOFReader</span>&nbsp;<span class="keyword" id="4255487">struct</span>&nbsp;<span class="op" id="4255494">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255497">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255504">io</span><span class="op" id="4255506">.</span><span class="ident" id="4255507">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255515">sawEOF</span>&nbsp;<span class="op" id="4255522">*</span><span class="builtintype" id="4255523">bool</span><br>
<span class="lineno"></span><span class="op" id="4255528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4255531">func</span>&nbsp;<span class="op" id="4255536">(</span><span class="ident" id="4255537">nr</span>&nbsp;<span class="ident" id="4255540">noteEOFReader</span><span class="op" id="4255553">)</span>&nbsp;<span class="ident" id="4255555">Read</span><span class="op" id="4255559">(</span><span class="ident" id="4255560">p</span>&nbsp;<span class="op" id="4255562">[</span><span class="op" id="4255563">]</span><span class="builtintype" id="4255564">byte</span><span class="op" id="4255568">)</span>&nbsp;<span class="op" id="4255570">(</span><span class="ident" id="4255571">n</span>&nbsp;<span class="builtintype" id="4255573">int</span><span class="op" id="4255576">,</span>&nbsp;<span class="ident" id="4255578">err</span>&nbsp;<span class="builtintype" id="4255582">error</span><span class="op" id="4255587">)</span>&nbsp;<span class="op" id="4255589">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4255592">n</span><span class="op" id="4255593">,</span>&nbsp;<span class="ident" id="4255595">err</span>&nbsp;<span class="op" id="4255599">=</span>&nbsp;<span class="ident" id="4255601">nr</span><span class="op" id="4255603">.</span><span class="ident" id="4255604">r</span><span class="op" id="4255605">.</span><span class="ident" id="4255606">Read</span><span class="op" id="4255610">(</span><span class="ident" id="4255611">p</span><span class="op" id="4255612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255615">if</span>&nbsp;<span class="ident" id="4255618">err</span>&nbsp;<span class="op" id="4255622">==</span>&nbsp;<span class="ident" id="4255625">io</span><span class="op" id="4255627">.</span><span class="ident" id="4255628">EOF</span>&nbsp;<span class="op" id="4255632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4255636">*</span><span class="ident" id="4255637">nr</span><span class="op" id="4255639">.</span><span class="ident" id="4255640">sawEOF</span>&nbsp;<span class="op" id="4255647">=</span>&nbsp;<span class="builtintype" id="4255649">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4255655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4255658">return</span><br>
<span class="lineno">1275</span><span class="op" id="4255665">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
