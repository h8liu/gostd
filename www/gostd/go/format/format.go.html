<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html" class="current">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6355756">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6355811">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6355865">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6355916">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="6355979">package</span>&nbsp;<span class="ident" id="6355987">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355995">import</span>&nbsp;<span class="op" id="6356002">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356005">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356014">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356021">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356031">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356044">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356058">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356070">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6356076">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="6356086">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6356089">var</span>&nbsp;<span class="ident" id="6356093">config</span>&nbsp;<span class="op" id="6356100">=</span>&nbsp;<span class="ident" id="6356102">printer</span><span class="op" id="6356109">.</span><span class="ident" id="6356110">Config</span><span class="op" id="6356116">{</span><span class="ident" id="6356117">Mode</span><span class="op" id="6356121">:</span>&nbsp;<span class="ident" id="6356123">printer</span><span class="op" id="6356130">.</span><span class="ident" id="6356131">UseSpaces</span>&nbsp;<span class="op" id="6356141">|</span>&nbsp;<span class="ident" id="6356143">printer</span><span class="op" id="6356150">.</span><span class="ident" id="6356151">TabIndent</span><span class="op" id="6356160">,</span>&nbsp;<span class="ident" id="6356162">Tabwidth</span><span class="op" id="6356170">:</span>&nbsp;<span class="num" id="6356172">8</span><span class="op" id="6356173">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6356176">const</span>&nbsp;<span class="ident" id="6356182">parserMode</span>&nbsp;<span class="op" id="6356193">=</span>&nbsp;<span class="ident" id="6356195">parser</span><span class="op" id="6356201">.</span><span class="ident" id="6356202">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6356217">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="6356293">//</span><br>
<span class="lineno">25</span><span class="comment" id="6356296">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="6356368">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="6356441">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6356511">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="6356583">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="6356652">//</span><br>
<span class="lineno"></span><span class="comment" id="6356655">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="6356726">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="6356798">//</span><br>
<span class="lineno"></span><span class="keyword" id="6356801">func</span>&nbsp;<span class="ident" id="6356806">Node</span><span class="op" id="6356810">(</span><span class="ident" id="6356811">dst</span>&nbsp;<span class="ident" id="6356815">io</span><span class="op" id="6356817">.</span><span class="ident" id="6356818">Writer</span><span class="op" id="6356824">,</span>&nbsp;<span class="ident" id="6356826">fset</span>&nbsp;<span class="op" id="6356831">*</span><span class="ident" id="6356832">token</span><span class="op" id="6356837">.</span><span class="ident" id="6356838">FileSet</span><span class="op" id="6356845">,</span>&nbsp;<span class="ident" id="6356847">node</span>&nbsp;<span class="keyword" id="6356852">interface</span><span class="op" id="6356861">{</span><span class="op" id="6356862">}</span><span class="op" id="6356863">)</span>&nbsp;<span class="builtintype" id="6356865">error</span>&nbsp;<span class="op" id="6356871">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6356874">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356937">var</span>&nbsp;<span class="ident" id="6356941">file</span>&nbsp;<span class="op" id="6356946">*</span><span class="ident" id="6356947">ast</span><span class="op" id="6356950">.</span><span class="ident" id="6356951">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356957">var</span>&nbsp;<span class="ident" id="6356961">cnode</span>&nbsp;<span class="op" id="6356967">*</span><span class="ident" id="6356968">printer</span><span class="op" id="6356975">.</span><span class="ident" id="6356976">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356991">switch</span>&nbsp;<span class="ident" id="6356998">n</span>&nbsp;<span class="op" id="6357000">:=</span>&nbsp;<span class="ident" id="6357003">node</span><span class="op" id="6357007">.</span><span class="op" id="6357008">(</span><span class="keyword" id="6357009">type</span><span class="op" id="6357013">)</span>&nbsp;<span class="op" id="6357015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357018">case</span>&nbsp;<span class="op" id="6357023">*</span><span class="ident" id="6357024">ast</span><span class="op" id="6357027">.</span><span class="ident" id="6357028">File</span><span class="op" id="6357032">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357036">file</span>&nbsp;<span class="op" id="6357041">=</span>&nbsp;<span class="ident" id="6357043">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357046">case</span>&nbsp;<span class="op" id="6357051">*</span><span class="ident" id="6357052">printer</span><span class="op" id="6357059">.</span><span class="ident" id="6357060">CommentedNode</span><span class="op" id="6357073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357077">if</span>&nbsp;<span class="ident" id="6357080">f</span><span class="op" id="6357081">,</span>&nbsp;<span class="ident" id="6357083">ok</span>&nbsp;<span class="op" id="6357086">:=</span>&nbsp;<span class="ident" id="6357089">n</span><span class="op" id="6357090">.</span><span class="ident" id="6357091">Node</span><span class="op" id="6357095">.</span><span class="op" id="6357096">(</span><span class="op" id="6357097">*</span><span class="ident" id="6357098">ast</span><span class="op" id="6357101">.</span><span class="ident" id="6357102">File</span><span class="op" id="6357106">)</span><span class="op" id="6357107">;</span>&nbsp;<span class="ident" id="6357109">ok</span>&nbsp;<span class="op" id="6357112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357117">file</span>&nbsp;<span class="op" id="6357122">=</span>&nbsp;<span class="ident" id="6357124">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357129">cnode</span>&nbsp;<span class="op" id="6357135">=</span>&nbsp;<span class="ident" id="6357137">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357148">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357179">if</span>&nbsp;<span class="ident" id="6357182">file</span>&nbsp;<span class="op" id="6357187">!=</span>&nbsp;<span class="builtintype" id="6357190">nil</span>&nbsp;<span class="op" id="6357194">&amp;&amp;</span>&nbsp;<span class="ident" id="6357197">hasUnsortedImports</span><span class="op" id="6357215">(</span><span class="ident" id="6357216">file</span><span class="op" id="6357220">)</span>&nbsp;<span class="op" id="6357222">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357226">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357294">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357335">var</span>&nbsp;<span class="ident" id="6357339">buf</span>&nbsp;<span class="ident" id="6357343">bytes</span><span class="op" id="6357348">.</span><span class="ident" id="6357349">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357358">err</span>&nbsp;<span class="op" id="6357362">:=</span>&nbsp;<span class="ident" id="6357365">config</span><span class="op" id="6357371">.</span><span class="ident" id="6357372">Fprint</span><span class="op" id="6357378">(</span><span class="op" id="6357379">&amp;</span><span class="ident" id="6357380">buf</span><span class="op" id="6357383">,</span>&nbsp;<span class="ident" id="6357385">fset</span><span class="op" id="6357389">,</span>&nbsp;<span class="ident" id="6357391">file</span><span class="op" id="6357395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357399">if</span>&nbsp;<span class="ident" id="6357402">err</span>&nbsp;<span class="op" id="6357406">!=</span>&nbsp;<span class="builtintype" id="6357409">nil</span>&nbsp;<span class="op" id="6357413">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357418">return</span>&nbsp;<span class="ident" id="6357425">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357435">file</span><span class="op" id="6357439">,</span>&nbsp;<span class="ident" id="6357441">err</span>&nbsp;<span class="op" id="6357445">=</span>&nbsp;<span class="ident" id="6357447">parser</span><span class="op" id="6357453">.</span><span class="ident" id="6357454">ParseFile</span><span class="op" id="6357463">(</span><span class="ident" id="6357464">fset</span><span class="op" id="6357468">,</span>&nbsp;<span class="string" id="6357470">&#34;&#34;</span><span class="op" id="6357472">,</span>&nbsp;<span class="ident" id="6357474">buf</span><span class="op" id="6357477">.</span><span class="ident" id="6357478">Bytes</span><span class="op" id="6357483">(</span><span class="op" id="6357484">)</span><span class="op" id="6357485">,</span>&nbsp;<span class="ident" id="6357487">parserMode</span><span class="op" id="6357497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357501">if</span>&nbsp;<span class="ident" id="6357504">err</span>&nbsp;<span class="op" id="6357508">!=</span>&nbsp;<span class="builtintype" id="6357511">nil</span>&nbsp;<span class="op" id="6357515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357520">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357587">return</span>&nbsp;<span class="ident" id="6357594">fmt</span><span class="op" id="6357597">.</span><span class="ident" id="6357598">Errorf</span><span class="op" id="6357604">(</span><span class="string" id="6357605">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="6357638">,</span>&nbsp;<span class="ident" id="6357640">err</span><span class="op" id="6357643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357651">ast</span><span class="op" id="6357654">.</span><span class="ident" id="6357655">SortImports</span><span class="op" id="6357666">(</span><span class="ident" id="6357667">fset</span><span class="op" id="6357671">,</span>&nbsp;<span class="ident" id="6357673">file</span><span class="op" id="6357677">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357682">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357721">node</span>&nbsp;<span class="op" id="6357726">=</span>&nbsp;<span class="ident" id="6357728">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357735">if</span>&nbsp;<span class="ident" id="6357738">cnode</span>&nbsp;<span class="op" id="6357744">!=</span>&nbsp;<span class="builtintype" id="6357747">nil</span>&nbsp;<span class="op" id="6357751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357756">node</span>&nbsp;<span class="op" id="6357761">=</span>&nbsp;<span class="op" id="6357763">&amp;</span><span class="ident" id="6357764">printer</span><span class="op" id="6357771">.</span><span class="ident" id="6357772">CommentedNode</span><span class="op" id="6357785">{</span><span class="ident" id="6357786">Node</span><span class="op" id="6357790">:</span>&nbsp;<span class="ident" id="6357792">file</span><span class="op" id="6357796">,</span>&nbsp;<span class="ident" id="6357798">Comments</span><span class="op" id="6357806">:</span>&nbsp;<span class="ident" id="6357808">cnode</span><span class="op" id="6357813">.</span><span class="ident" id="6357814">Comments</span><span class="op" id="6357822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357829">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357833">return</span>&nbsp;<span class="ident" id="6357840">config</span><span class="op" id="6357846">.</span><span class="ident" id="6357847">Fprint</span><span class="op" id="6357853">(</span><span class="ident" id="6357854">dst</span><span class="op" id="6357857">,</span>&nbsp;<span class="ident" id="6357859">fset</span><span class="op" id="6357863">,</span>&nbsp;<span class="ident" id="6357865">node</span><span class="op" id="6357869">)</span><br>
<span class="lineno"></span><span class="op" id="6357871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6357874">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="6357944">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="6358014">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="6358085">//</span><br>
<span class="lineno"></span><span class="comment" id="6358088">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="6358162">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="6358238">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6358315">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="6358396">//</span><br>
<span class="lineno"></span><span class="keyword" id="6358399">func</span>&nbsp;<span class="ident" id="6358404">Source</span><span class="op" id="6358410">(</span><span class="ident" id="6358411">src</span>&nbsp;<span class="op" id="6358415">[</span><span class="op" id="6358416">]</span><span class="builtintype" id="6358417">byte</span><span class="op" id="6358421">)</span>&nbsp;<span class="op" id="6358423">(</span><span class="op" id="6358424">[</span><span class="op" id="6358425">]</span><span class="builtintype" id="6358426">byte</span><span class="op" id="6358430">,</span>&nbsp;<span class="builtintype" id="6358432">error</span><span class="op" id="6358437">)</span>&nbsp;<span class="op" id="6358439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358442">fset</span>&nbsp;<span class="op" id="6358447">:=</span>&nbsp;<span class="ident" id="6358450">token</span><span class="op" id="6358455">.</span><span class="ident" id="6358456">NewFileSet</span><span class="op" id="6358466">(</span><span class="op" id="6358467">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358470">file</span><span class="op" id="6358474">,</span>&nbsp;<span class="ident" id="6358476">sourceAdj</span><span class="op" id="6358485">,</span>&nbsp;<span class="ident" id="6358487">indentAdj</span><span class="op" id="6358496">,</span>&nbsp;<span class="ident" id="6358498">err</span>&nbsp;<span class="op" id="6358502">:=</span>&nbsp;<span class="ident" id="6358505">parse</span><span class="op" id="6358510">(</span><span class="ident" id="6358511">fset</span><span class="op" id="6358515">,</span>&nbsp;<span class="string" id="6358517">&#34;&#34;</span><span class="op" id="6358519">,</span>&nbsp;<span class="ident" id="6358521">src</span><span class="op" id="6358524">,</span>&nbsp;<span class="builtintype" id="6358526">true</span><span class="op" id="6358530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358533">if</span>&nbsp;<span class="ident" id="6358536">err</span>&nbsp;<span class="op" id="6358540">!=</span>&nbsp;<span class="builtintype" id="6358543">nil</span>&nbsp;<span class="op" id="6358547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358551">return</span>&nbsp;<span class="builtintype" id="6358558">nil</span><span class="op" id="6358561">,</span>&nbsp;<span class="ident" id="6358563">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358572">if</span>&nbsp;<span class="ident" id="6358575">sourceAdj</span>&nbsp;<span class="op" id="6358585">==</span>&nbsp;<span class="builtintype" id="6358588">nil</span>&nbsp;<span class="op" id="6358592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358596">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358623">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358666">ast</span><span class="op" id="6358669">.</span><span class="ident" id="6358670">SortImports</span><span class="op" id="6358681">(</span><span class="ident" id="6358682">fset</span><span class="op" id="6358686">,</span>&nbsp;<span class="ident" id="6358688">file</span><span class="op" id="6358692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358695">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358699">return</span>&nbsp;<span class="ident" id="6358706">format</span><span class="op" id="6358712">(</span><span class="ident" id="6358713">fset</span><span class="op" id="6358717">,</span>&nbsp;<span class="ident" id="6358719">file</span><span class="op" id="6358723">,</span>&nbsp;<span class="ident" id="6358725">sourceAdj</span><span class="op" id="6358734">,</span>&nbsp;<span class="ident" id="6358736">indentAdj</span><span class="op" id="6358745">,</span>&nbsp;<span class="ident" id="6358747">src</span><span class="op" id="6358750">,</span>&nbsp;<span class="ident" id="6358752">config</span><span class="op" id="6358758">)</span><br>
<span class="lineno"></span><span class="op" id="6358760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6358763">func</span>&nbsp;<span class="ident" id="6358768">hasUnsortedImports</span><span class="op" id="6358786">(</span><span class="ident" id="6358787">file</span>&nbsp;<span class="op" id="6358792">*</span><span class="ident" id="6358793">ast</span><span class="op" id="6358796">.</span><span class="ident" id="6358797">File</span><span class="op" id="6358801">)</span>&nbsp;<span class="builtintype" id="6358803">bool</span>&nbsp;<span class="op" id="6358808">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358811">for</span>&nbsp;<span class="ident" id="6358815">_</span><span class="op" id="6358816">,</span>&nbsp;<span class="ident" id="6358818">d</span>&nbsp;<span class="op" id="6358820">:=</span>&nbsp;<span class="keyword" id="6358823">range</span>&nbsp;<span class="ident" id="6358829">file</span><span class="op" id="6358833">.</span><span class="ident" id="6358834">Decls</span>&nbsp;<span class="op" id="6358840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358844">d</span><span class="op" id="6358845">,</span>&nbsp;<span class="ident" id="6358847">ok</span>&nbsp;<span class="op" id="6358850">:=</span>&nbsp;<span class="ident" id="6358853">d</span><span class="op" id="6358854">.</span><span class="op" id="6358855">(</span><span class="op" id="6358856">*</span><span class="ident" id="6358857">ast</span><span class="op" id="6358860">.</span><span class="ident" id="6358861">GenDecl</span><span class="op" id="6358868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358872">if</span>&nbsp;<span class="op" id="6358875">!</span><span class="ident" id="6358876">ok</span>&nbsp;<span class="op" id="6358879">||</span>&nbsp;<span class="ident" id="6358882">d</span><span class="op" id="6358883">.</span><span class="ident" id="6358884">Tok</span>&nbsp;<span class="op" id="6358888">!=</span>&nbsp;<span class="ident" id="6358891">token</span><span class="op" id="6358896">.</span><span class="ident" id="6358897">IMPORT</span>&nbsp;<span class="op" id="6358904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358909">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358957">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358989">return</span>&nbsp;<span class="builtintype" id="6358996">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359008">if</span>&nbsp;<span class="ident" id="6359011">d</span><span class="op" id="6359012">.</span><span class="ident" id="6359013">Lparen</span><span class="op" id="6359019">.</span><span class="ident" id="6359020">IsValid</span><span class="op" id="6359027">(</span><span class="op" id="6359028">)</span>&nbsp;<span class="op" id="6359030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6359035">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6359090">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359147">return</span>&nbsp;<span class="builtintype" id="6359154">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6359165">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359213">return</span>&nbsp;<span class="builtintype" id="6359220">false</span><br>
<span class="lineno">115</span><span class="op" id="6359226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6359229">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="6359309">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="6359330">//</span><br>
<span class="lineno">120</span><span class="comment" id="6359333">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6359404">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="6359471">//</span><br>
<span class="lineno"></span><span class="comment" id="6359474">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="6359531">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="6359588">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="6359644">func</span>&nbsp;<span class="ident" id="6359649">parse</span><span class="op" id="6359654">(</span><span class="ident" id="6359655">fset</span>&nbsp;<span class="op" id="6359660">*</span><span class="ident" id="6359661">token</span><span class="op" id="6359666">.</span><span class="ident" id="6359667">FileSet</span><span class="op" id="6359674">,</span>&nbsp;<span class="ident" id="6359676">filename</span>&nbsp;<span class="builtintype" id="6359685">string</span><span class="op" id="6359691">,</span>&nbsp;<span class="ident" id="6359693">src</span>&nbsp;<span class="op" id="6359697">[</span><span class="op" id="6359698">]</span><span class="builtintype" id="6359699">byte</span><span class="op" id="6359703">,</span>&nbsp;<span class="ident" id="6359705">fragmentOk</span>&nbsp;<span class="builtintype" id="6359716">bool</span><span class="op" id="6359720">)</span>&nbsp;<span class="op" id="6359722">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359725">file</span>&nbsp;<span class="op" id="6359730">*</span><span class="ident" id="6359731">ast</span><span class="op" id="6359734">.</span><span class="ident" id="6359735">File</span><span class="op" id="6359739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359742">sourceAdj</span>&nbsp;<span class="keyword" id="6359752">func</span><span class="op" id="6359756">(</span><span class="ident" id="6359757">src</span>&nbsp;<span class="op" id="6359761">[</span><span class="op" id="6359762">]</span><span class="builtintype" id="6359763">byte</span><span class="op" id="6359767">,</span>&nbsp;<span class="ident" id="6359769">indent</span>&nbsp;<span class="builtintype" id="6359776">int</span><span class="op" id="6359779">)</span>&nbsp;<span class="op" id="6359781">[</span><span class="op" id="6359782">]</span><span class="builtintype" id="6359783">byte</span><span class="op" id="6359787">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359790">indentAdj</span>&nbsp;<span class="builtintype" id="6359800">int</span><span class="op" id="6359803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359806">err</span>&nbsp;<span class="builtintype" id="6359810">error</span><span class="op" id="6359815">,</span><br>
<span class="lineno"></span><span class="op" id="6359817">)</span>&nbsp;<span class="op" id="6359819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6359822">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359852">file</span><span class="op" id="6359856">,</span>&nbsp;<span class="ident" id="6359858">err</span>&nbsp;<span class="op" id="6359862">=</span>&nbsp;<span class="ident" id="6359864">parser</span><span class="op" id="6359870">.</span><span class="ident" id="6359871">ParseFile</span><span class="op" id="6359880">(</span><span class="ident" id="6359881">fset</span><span class="op" id="6359885">,</span>&nbsp;<span class="ident" id="6359887">filename</span><span class="op" id="6359895">,</span>&nbsp;<span class="ident" id="6359897">src</span><span class="op" id="6359900">,</span>&nbsp;<span class="ident" id="6359902">parserMode</span><span class="op" id="6359912">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6359915">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360006">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360068">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360135">if</span>&nbsp;<span class="ident" id="6360138">err</span>&nbsp;<span class="op" id="6360142">==</span>&nbsp;<span class="builtintype" id="6360145">nil</span>&nbsp;<span class="op" id="6360149">||</span>&nbsp;<span class="op" id="6360152">!</span><span class="ident" id="6360153">fragmentOk</span>&nbsp;<span class="op" id="6360164">||</span>&nbsp;<span class="op" id="6360167">!</span><span class="ident" id="6360168">strings</span><span class="op" id="6360175">.</span><span class="ident" id="6360176">Contains</span><span class="op" id="6360184">(</span><span class="ident" id="6360185">err</span><span class="op" id="6360188">.</span><span class="ident" id="6360189">Error</span><span class="op" id="6360194">(</span><span class="op" id="6360195">)</span><span class="op" id="6360196">,</span>&nbsp;<span class="string" id="6360198">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="6360218">)</span>&nbsp;<span class="op" id="6360220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360224">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360236">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360293">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360328">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360390">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360425">psrc</span>&nbsp;<span class="op" id="6360430">:=</span>&nbsp;<span class="builtinfunc" id="6360433">append</span><span class="op" id="6360439">(</span><span class="op" id="6360440">[</span><span class="op" id="6360441">]</span><span class="builtintype" id="6360442">byte</span><span class="op" id="6360446">(</span><span class="string" id="6360447">&#34;package&nbsp;p;&#34;</span><span class="op" id="6360459">)</span><span class="op" id="6360460">,</span>&nbsp;<span class="ident" id="6360462">src</span><span class="op" id="6360465">...</span><span class="op" id="6360468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360471">file</span><span class="op" id="6360475">,</span>&nbsp;<span class="ident" id="6360477">err</span>&nbsp;<span class="op" id="6360481">=</span>&nbsp;<span class="ident" id="6360483">parser</span><span class="op" id="6360489">.</span><span class="ident" id="6360490">ParseFile</span><span class="op" id="6360499">(</span><span class="ident" id="6360500">fset</span><span class="op" id="6360504">,</span>&nbsp;<span class="ident" id="6360506">filename</span><span class="op" id="6360514">,</span>&nbsp;<span class="ident" id="6360516">psrc</span><span class="op" id="6360520">,</span>&nbsp;<span class="ident" id="6360522">parserMode</span><span class="op" id="6360532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360535">if</span>&nbsp;<span class="ident" id="6360538">err</span>&nbsp;<span class="op" id="6360542">==</span>&nbsp;<span class="builtintype" id="6360545">nil</span>&nbsp;<span class="op" id="6360549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360553">sourceAdj</span>&nbsp;<span class="op" id="6360563">=</span>&nbsp;<span class="keyword" id="6360565">func</span><span class="op" id="6360569">(</span><span class="ident" id="6360570">src</span>&nbsp;<span class="op" id="6360574">[</span><span class="op" id="6360575">]</span><span class="builtintype" id="6360576">byte</span><span class="op" id="6360580">,</span>&nbsp;<span class="ident" id="6360582">indent</span>&nbsp;<span class="builtintype" id="6360589">int</span><span class="op" id="6360592">)</span>&nbsp;<span class="op" id="6360594">[</span><span class="op" id="6360595">]</span><span class="builtintype" id="6360596">byte</span>&nbsp;<span class="op" id="6360601">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360606">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360639">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360679">src</span>&nbsp;<span class="op" id="6360683">=</span>&nbsp;<span class="ident" id="6360685">src</span><span class="op" id="6360688">[</span><span class="ident" id="6360689">indent</span><span class="op" id="6360695">+</span><span class="builtinfunc" id="6360696">len</span><span class="op" id="6360699">(</span><span class="string" id="6360700">&#34;package&nbsp;p\n&#34;</span><span class="op" id="6360713">)</span><span class="op" id="6360714">:</span><span class="op" id="6360715">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360720">return</span>&nbsp;<span class="ident" id="6360727">bytes</span><span class="op" id="6360732">.</span><span class="ident" id="6360733">TrimSpace</span><span class="op" id="6360742">(</span><span class="ident" id="6360743">src</span><span class="op" id="6360746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360750">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360754">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360765">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360826">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360884">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360924">if</span>&nbsp;<span class="op" id="6360927">!</span><span class="ident" id="6360928">strings</span><span class="op" id="6360935">.</span><span class="ident" id="6360936">Contains</span><span class="op" id="6360944">(</span><span class="ident" id="6360945">err</span><span class="op" id="6360948">.</span><span class="ident" id="6360949">Error</span><span class="op" id="6360954">(</span><span class="op" id="6360955">)</span><span class="op" id="6360956">,</span>&nbsp;<span class="string" id="6360958">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="6360980">)</span>&nbsp;<span class="op" id="6360982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360986">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6360998">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361053">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361108">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361165">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361227">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361262">fsrc</span>&nbsp;<span class="op" id="6361267">:=</span>&nbsp;<span class="builtinfunc" id="6361270">append</span><span class="op" id="6361276">(</span><span class="builtinfunc" id="6361277">append</span><span class="op" id="6361283">(</span><span class="op" id="6361284">[</span><span class="op" id="6361285">]</span><span class="builtintype" id="6361286">byte</span><span class="op" id="6361290">(</span><span class="string" id="6361291">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="6361314">)</span><span class="op" id="6361315">,</span>&nbsp;<span class="ident" id="6361317">src</span><span class="op" id="6361320">...</span><span class="op" id="6361323">)</span><span class="op" id="6361324">,</span>&nbsp;<span class="string" id="6361326">&#39;\n&#39;</span><span class="op" id="6361330">,</span>&nbsp;<span class="string" id="6361332">&#39;}&#39;</span><span class="op" id="6361335">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361338">file</span><span class="op" id="6361342">,</span>&nbsp;<span class="ident" id="6361344">err</span>&nbsp;<span class="op" id="6361348">=</span>&nbsp;<span class="ident" id="6361350">parser</span><span class="op" id="6361356">.</span><span class="ident" id="6361357">ParseFile</span><span class="op" id="6361366">(</span><span class="ident" id="6361367">fset</span><span class="op" id="6361371">,</span>&nbsp;<span class="ident" id="6361373">filename</span><span class="op" id="6361381">,</span>&nbsp;<span class="ident" id="6361383">fsrc</span><span class="op" id="6361387">,</span>&nbsp;<span class="ident" id="6361389">parserMode</span><span class="op" id="6361399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361402">if</span>&nbsp;<span class="ident" id="6361405">err</span>&nbsp;<span class="op" id="6361409">==</span>&nbsp;<span class="builtintype" id="6361412">nil</span>&nbsp;<span class="op" id="6361416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361420">sourceAdj</span>&nbsp;<span class="op" id="6361430">=</span>&nbsp;<span class="keyword" id="6361432">func</span><span class="op" id="6361436">(</span><span class="ident" id="6361437">src</span>&nbsp;<span class="op" id="6361441">[</span><span class="op" id="6361442">]</span><span class="builtintype" id="6361443">byte</span><span class="op" id="6361447">,</span>&nbsp;<span class="ident" id="6361449">indent</span>&nbsp;<span class="builtintype" id="6361456">int</span><span class="op" id="6361459">)</span>&nbsp;<span class="op" id="6361461">[</span><span class="op" id="6361462">]</span><span class="builtintype" id="6361463">byte</span>&nbsp;<span class="op" id="6361468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361473">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361508">if</span>&nbsp;<span class="ident" id="6361511">indent</span>&nbsp;<span class="op" id="6361518">&lt;</span>&nbsp;<span class="num" id="6361520">0</span>&nbsp;<span class="op" id="6361522">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361528">indent</span>&nbsp;<span class="op" id="6361535">=</span>&nbsp;<span class="num" id="6361537">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6361542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361547">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361574">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361616">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361685">src</span>&nbsp;<span class="op" id="6361689">=</span>&nbsp;<span class="ident" id="6361691">src</span><span class="op" id="6361694">[</span><span class="num" id="6361695">2</span><span class="op" id="6361696">*</span><span class="ident" id="6361697">indent</span><span class="op" id="6361703">+</span><span class="builtinfunc" id="6361704">len</span><span class="op" id="6361707">(</span><span class="string" id="6361708">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="6361733">)</span><span class="op" id="6361734">:</span><span class="op" id="6361735">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361740">src</span>&nbsp;<span class="op" id="6361744">=</span>&nbsp;<span class="ident" id="6361746">src</span><span class="op" id="6361749">[</span><span class="op" id="6361750">:</span><span class="builtinfunc" id="6361751">len</span><span class="op" id="6361754">(</span><span class="ident" id="6361755">src</span><span class="op" id="6361758">)</span><span class="op" id="6361759">-</span><span class="op" id="6361760">(</span><span class="ident" id="6361761">indent</span><span class="op" id="6361767">+</span><span class="builtinfunc" id="6361768">len</span><span class="op" id="6361771">(</span><span class="string" id="6361772">&#34;\n}\n&#34;</span><span class="op" id="6361779">)</span><span class="op" id="6361780">)</span><span class="op" id="6361781">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361786">return</span>&nbsp;<span class="ident" id="6361793">bytes</span><span class="op" id="6361798">.</span><span class="ident" id="6361799">TrimSpace</span><span class="op" id="6361808">(</span><span class="ident" id="6361809">src</span><span class="op" id="6361812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6361816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361820">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361878">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361911">indentAdj</span>&nbsp;<span class="op" id="6361921">=</span>&nbsp;<span class="op" id="6361923">-</span><span class="num" id="6361924">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6361927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361931">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361965">return</span><br>
<span class="lineno"></span><span class="op" id="6361972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6361975">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="6362045">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="6362114">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="6362132">func</span>&nbsp;<span class="ident" id="6362137">format</span><span class="op" id="6362143">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362146">fset</span>&nbsp;<span class="op" id="6362151">*</span><span class="ident" id="6362152">token</span><span class="op" id="6362157">.</span><span class="ident" id="6362158">FileSet</span><span class="op" id="6362165">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362168">file</span>&nbsp;<span class="op" id="6362173">*</span><span class="ident" id="6362174">ast</span><span class="op" id="6362177">.</span><span class="ident" id="6362178">File</span><span class="op" id="6362182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362185">sourceAdj</span>&nbsp;<span class="keyword" id="6362195">func</span><span class="op" id="6362199">(</span><span class="ident" id="6362200">src</span>&nbsp;<span class="op" id="6362204">[</span><span class="op" id="6362205">]</span><span class="builtintype" id="6362206">byte</span><span class="op" id="6362210">,</span>&nbsp;<span class="ident" id="6362212">indent</span>&nbsp;<span class="builtintype" id="6362219">int</span><span class="op" id="6362222">)</span>&nbsp;<span class="op" id="6362224">[</span><span class="op" id="6362225">]</span><span class="builtintype" id="6362226">byte</span><span class="op" id="6362230">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362233">indentAdj</span>&nbsp;<span class="builtintype" id="6362243">int</span><span class="op" id="6362246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362249">src</span>&nbsp;<span class="op" id="6362253">[</span><span class="op" id="6362254">]</span><span class="builtintype" id="6362255">byte</span><span class="op" id="6362259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362262">cfg</span>&nbsp;<span class="ident" id="6362266">printer</span><span class="op" id="6362273">.</span><span class="ident" id="6362274">Config</span><span class="op" id="6362280">,</span><br>
<span class="lineno"></span><span class="op" id="6362282">)</span>&nbsp;<span class="op" id="6362284">(</span><span class="op" id="6362285">[</span><span class="op" id="6362286">]</span><span class="builtintype" id="6362287">byte</span><span class="op" id="6362291">,</span>&nbsp;<span class="builtintype" id="6362293">error</span><span class="op" id="6362298">)</span>&nbsp;<span class="op" id="6362300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362303">if</span>&nbsp;<span class="ident" id="6362306">sourceAdj</span>&nbsp;<span class="op" id="6362316">==</span>&nbsp;<span class="builtintype" id="6362319">nil</span>&nbsp;<span class="op" id="6362323">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362327">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362354">var</span>&nbsp;<span class="ident" id="6362358">buf</span>&nbsp;<span class="ident" id="6362362">bytes</span><span class="op" id="6362367">.</span><span class="ident" id="6362368">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362377">err</span>&nbsp;<span class="op" id="6362381">:=</span>&nbsp;<span class="ident" id="6362384">cfg</span><span class="op" id="6362387">.</span><span class="ident" id="6362388">Fprint</span><span class="op" id="6362394">(</span><span class="op" id="6362395">&amp;</span><span class="ident" id="6362396">buf</span><span class="op" id="6362399">,</span>&nbsp;<span class="ident" id="6362401">fset</span><span class="op" id="6362405">,</span>&nbsp;<span class="ident" id="6362407">file</span><span class="op" id="6362411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362415">if</span>&nbsp;<span class="ident" id="6362418">err</span>&nbsp;<span class="op" id="6362422">!=</span>&nbsp;<span class="builtintype" id="6362425">nil</span>&nbsp;<span class="op" id="6362429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362434">return</span>&nbsp;<span class="builtintype" id="6362441">nil</span><span class="op" id="6362444">,</span>&nbsp;<span class="ident" id="6362446">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362456">return</span>&nbsp;<span class="ident" id="6362463">buf</span><span class="op" id="6362466">.</span><span class="ident" id="6362467">Bytes</span><span class="op" id="6362472">(</span><span class="op" id="6362473">)</span><span class="op" id="6362474">,</span>&nbsp;<span class="builtintype" id="6362476">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362485">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362510">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362551">i</span><span class="op" id="6362552">,</span>&nbsp;<span class="ident" id="6362554">j</span>&nbsp;<span class="op" id="6362556">:=</span>&nbsp;<span class="num" id="6362559">0</span><span class="op" id="6362560">,</span>&nbsp;<span class="num" id="6362562">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362565">for</span>&nbsp;<span class="ident" id="6362569">j</span>&nbsp;<span class="op" id="6362571">&lt;</span>&nbsp;<span class="builtinfunc" id="6362573">len</span><span class="op" id="6362576">(</span><span class="ident" id="6362577">src</span><span class="op" id="6362580">)</span>&nbsp;<span class="op" id="6362582">&amp;&amp;</span>&nbsp;<span class="ident" id="6362585">isSpace</span><span class="op" id="6362592">(</span><span class="ident" id="6362593">src</span><span class="op" id="6362596">[</span><span class="ident" id="6362597">j</span><span class="op" id="6362598">]</span><span class="op" id="6362599">)</span>&nbsp;<span class="op" id="6362601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362605">if</span>&nbsp;<span class="ident" id="6362608">src</span><span class="op" id="6362611">[</span><span class="ident" id="6362612">j</span><span class="op" id="6362613">]</span>&nbsp;<span class="op" id="6362615">==</span>&nbsp;<span class="string" id="6362618">&#39;\n&#39;</span>&nbsp;<span class="op" id="6362623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362628">i</span>&nbsp;<span class="op" id="6362630">=</span>&nbsp;<span class="ident" id="6362632">j</span>&nbsp;<span class="op" id="6362634">+</span>&nbsp;<span class="num" id="6362636">1</span>&nbsp;<span class="comment" id="6362638">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362689">j</span><span class="op" id="6362690">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362697">var</span>&nbsp;<span class="ident" id="6362701">res</span>&nbsp;<span class="op" id="6362705">[</span><span class="op" id="6362706">]</span><span class="builtintype" id="6362707">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362713">res</span>&nbsp;<span class="op" id="6362717">=</span>&nbsp;<span class="builtinfunc" id="6362719">append</span><span class="op" id="6362725">(</span><span class="ident" id="6362726">res</span><span class="op" id="6362729">,</span>&nbsp;<span class="ident" id="6362731">src</span><span class="op" id="6362734">[</span><span class="op" id="6362735">:</span><span class="ident" id="6362736">i</span><span class="op" id="6362737">]</span><span class="op" id="6362738">...</span><span class="op" id="6362741">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362745">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362803">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6362852">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362895">indent</span>&nbsp;<span class="op" id="6362902">:=</span>&nbsp;<span class="num" id="6362905">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362908">hasSpace</span>&nbsp;<span class="op" id="6362917">:=</span>&nbsp;<span class="builtintype" id="6362920">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362927">for</span>&nbsp;<span class="ident" id="6362931">_</span><span class="op" id="6362932">,</span>&nbsp;<span class="ident" id="6362934">b</span>&nbsp;<span class="op" id="6362936">:=</span>&nbsp;<span class="keyword" id="6362939">range</span>&nbsp;<span class="ident" id="6362945">src</span><span class="op" id="6362948">[</span><span class="ident" id="6362949">i</span><span class="op" id="6362950">:</span><span class="ident" id="6362951">j</span><span class="op" id="6362952">]</span>&nbsp;<span class="op" id="6362954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362958">switch</span>&nbsp;<span class="ident" id="6362965">b</span>&nbsp;<span class="op" id="6362967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362971">case</span>&nbsp;<span class="string" id="6362976">&#39;&nbsp;&#39;</span><span class="op" id="6362979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362984">hasSpace</span>&nbsp;<span class="op" id="6362993">=</span>&nbsp;<span class="builtintype" id="6362995">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363002">case</span>&nbsp;<span class="string" id="6363007">&#39;\t&#39;</span><span class="op" id="6363011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363016">indent</span><span class="op" id="6363022">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363033">if</span>&nbsp;<span class="ident" id="6363036">indent</span>&nbsp;<span class="op" id="6363043">==</span>&nbsp;<span class="num" id="6363046">0</span>&nbsp;<span class="op" id="6363048">&amp;&amp;</span>&nbsp;<span class="ident" id="6363051">hasSpace</span>&nbsp;<span class="op" id="6363060">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363064">indent</span>&nbsp;<span class="op" id="6363071">=</span>&nbsp;<span class="num" id="6363073">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363079">for</span>&nbsp;<span class="ident" id="6363083">i</span>&nbsp;<span class="op" id="6363085">:=</span>&nbsp;<span class="num" id="6363088">0</span><span class="op" id="6363089">;</span>&nbsp;<span class="ident" id="6363091">i</span>&nbsp;<span class="op" id="6363093">&lt;</span>&nbsp;<span class="ident" id="6363095">indent</span><span class="op" id="6363101">;</span>&nbsp;<span class="ident" id="6363103">i</span><span class="op" id="6363104">++</span>&nbsp;<span class="op" id="6363107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363111">res</span>&nbsp;<span class="op" id="6363115">=</span>&nbsp;<span class="builtinfunc" id="6363117">append</span><span class="op" id="6363123">(</span><span class="ident" id="6363124">res</span><span class="op" id="6363127">,</span>&nbsp;<span class="string" id="6363129">&#39;\t&#39;</span><span class="op" id="6363133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363136">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363140">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363163">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363216">cfg</span><span class="op" id="6363219">.</span><span class="ident" id="6363220">Indent</span>&nbsp;<span class="op" id="6363227">=</span>&nbsp;<span class="ident" id="6363229">indent</span>&nbsp;<span class="op" id="6363236">+</span>&nbsp;<span class="ident" id="6363238">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363249">var</span>&nbsp;<span class="ident" id="6363253">buf</span>&nbsp;<span class="ident" id="6363257">bytes</span><span class="op" id="6363262">.</span><span class="ident" id="6363263">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363271">err</span>&nbsp;<span class="op" id="6363275">:=</span>&nbsp;<span class="ident" id="6363278">cfg</span><span class="op" id="6363281">.</span><span class="ident" id="6363282">Fprint</span><span class="op" id="6363288">(</span><span class="op" id="6363289">&amp;</span><span class="ident" id="6363290">buf</span><span class="op" id="6363293">,</span>&nbsp;<span class="ident" id="6363295">fset</span><span class="op" id="6363299">,</span>&nbsp;<span class="ident" id="6363301">file</span><span class="op" id="6363305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363308">if</span>&nbsp;<span class="ident" id="6363311">err</span>&nbsp;<span class="op" id="6363315">!=</span>&nbsp;<span class="builtintype" id="6363318">nil</span>&nbsp;<span class="op" id="6363322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363326">return</span>&nbsp;<span class="builtintype" id="6363333">nil</span><span class="op" id="6363336">,</span>&nbsp;<span class="ident" id="6363338">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363346">res</span>&nbsp;<span class="op" id="6363350">=</span>&nbsp;<span class="builtinfunc" id="6363352">append</span><span class="op" id="6363358">(</span><span class="ident" id="6363359">res</span><span class="op" id="6363362">,</span>&nbsp;<span class="ident" id="6363364">sourceAdj</span><span class="op" id="6363373">(</span><span class="ident" id="6363374">buf</span><span class="op" id="6363377">.</span><span class="ident" id="6363378">Bytes</span><span class="op" id="6363383">(</span><span class="op" id="6363384">)</span><span class="op" id="6363385">,</span>&nbsp;<span class="ident" id="6363387">cfg</span><span class="op" id="6363390">.</span><span class="ident" id="6363391">Indent</span><span class="op" id="6363397">)</span><span class="op" id="6363398">...</span><span class="op" id="6363401">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363405">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363446">i</span>&nbsp;<span class="op" id="6363448">=</span>&nbsp;<span class="builtinfunc" id="6363450">len</span><span class="op" id="6363453">(</span><span class="ident" id="6363454">src</span><span class="op" id="6363457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363460">for</span>&nbsp;<span class="ident" id="6363464">i</span>&nbsp;<span class="op" id="6363466">&gt;</span>&nbsp;<span class="num" id="6363468">0</span>&nbsp;<span class="op" id="6363470">&amp;&amp;</span>&nbsp;<span class="ident" id="6363473">isSpace</span><span class="op" id="6363480">(</span><span class="ident" id="6363481">src</span><span class="op" id="6363484">[</span><span class="ident" id="6363485">i</span><span class="op" id="6363486">-</span><span class="num" id="6363487">1</span><span class="op" id="6363488">]</span><span class="op" id="6363489">)</span>&nbsp;<span class="op" id="6363491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363495">i</span><span class="op" id="6363496">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363503">return</span>&nbsp;<span class="builtinfunc" id="6363510">append</span><span class="op" id="6363516">(</span><span class="ident" id="6363517">res</span><span class="op" id="6363520">,</span>&nbsp;<span class="ident" id="6363522">src</span><span class="op" id="6363525">[</span><span class="ident" id="6363526">i</span><span class="op" id="6363527">:</span><span class="op" id="6363528">]</span><span class="op" id="6363529">...</span><span class="op" id="6363532">)</span><span class="op" id="6363533">,</span>&nbsp;<span class="builtintype" id="6363535">nil</span><br>
<span class="lineno"></span><span class="op" id="6363539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6363542">func</span>&nbsp;<span class="ident" id="6363547">isSpace</span><span class="op" id="6363554">(</span><span class="ident" id="6363555">b</span>&nbsp;<span class="builtintype" id="6363557">byte</span><span class="op" id="6363561">)</span>&nbsp;<span class="builtintype" id="6363563">bool</span>&nbsp;<span class="op" id="6363568">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363571">return</span>&nbsp;<span class="ident" id="6363578">b</span>&nbsp;<span class="op" id="6363580">==</span>&nbsp;<span class="string" id="6363583">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6363587">||</span>&nbsp;<span class="ident" id="6363590">b</span>&nbsp;<span class="op" id="6363592">==</span>&nbsp;<span class="string" id="6363595">&#39;\t&#39;</span>&nbsp;<span class="op" id="6363600">||</span>&nbsp;<span class="ident" id="6363603">b</span>&nbsp;<span class="op" id="6363605">==</span>&nbsp;<span class="string" id="6363608">&#39;\n&#39;</span>&nbsp;<span class="op" id="6363613">||</span>&nbsp;<span class="ident" id="6363616">b</span>&nbsp;<span class="op" id="6363618">==</span>&nbsp;<span class="string" id="6363621">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="6363626">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
